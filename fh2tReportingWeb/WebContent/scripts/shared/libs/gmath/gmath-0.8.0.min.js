/// Copyright Erik Weitnauer 2015.
(function(){if(typeof gmath==="undefined")gmath={};gmath.expressions={};gmath.version="0.8.0";gmath.options={};gmath.options.mark_rounded_numbers=false;gmath.options.actions={};gmath.options.actions.substitution_on=true;gmath.options.actions.only_integer_division=false;gmath.options.actions.simplify_sum_in_numerator_after_adding_fractions=false;gmath.options.actions.second_child_eq_inversion=false;(function(){var t=4294967296,e=15,i=[],n=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];function r(){var r=0;var o=Math.random()*t;i[r++]=n[o&e];i[r++]=n[o>>>4&e];i[r++]=n[o>>>8&e];i[r++]=n[o>>>12&e];i[r++]=n[o>>>16&e];i[r++]=n[o>>>20&e];i[r++]=n[o>>>24&e];i[r++]=n[o>>>28&e];o=Math.random()*t;i[r++]=n[o&e];i[r++]=n[o>>>4&e];i[r++]=n[o>>>8&e];i[r++]=n[o>>>12&e];i[r++]=n[o>>>16&e];i[r++]=n[o>>>20&e];i[r++]=n[o>>>24&e];i[r++]=n[o>>>28&e];return"_"+i.join("")}gmath.uid=r})();gmath.inherit=function(t,e){var i=e.prototype;e.prototype=Object.create(t.prototype);for(var n in i){e.prototype[n]=i[n]}e.prototype.constructor=e;Object.defineProperty(e.prototype,"constructor",{enumerable:false,value:e})};gmath.object={};gmath.object.extend=function(t,e){if(typeof e==="object")for(var i in e)t[i]=e[i];return t};gmath.object.extendExisting=function(t,e){for(var i in t)if(i in e)t[i]=e[i];return t};gmath.object.extendChanged=function(t,e,i){for(var n in e)if(n in i&&!gmath.deepEquals(i[n],e[n]))t[n]=e[n];return t};gmath.object.merged=function(t,e){return gmath.object.extend(gmath.object.extend({},t),e)};gmath.extend=gmath.object.extend;gmath.deepCopy=function(t){var e=t;if(Array.isArray(t)){e=[];for(var i=0;i<t.length;i++)e[i]=gmath.deepCopy(t[i])}else if(typeof t==="object"){e={};for(var n in t)if(t.hasOwnProperty(n))e[n]=gmath.deepCopy(t[n])}return e};gmath.deepEquals=function(t,e){if(t===e)return true;if(Array.isArray(t)){if(!Array.isArray(e))return false;if(t.length!==e.length)return false;for(var i=0;i<t.length;i++)if(!gmath.deepEquals(t[i],e[i]))return false;return true}else if(typeof t==="object"){if(!typeof e==="object")return false;for(var n in t)if(t.hasOwnProperty(n)){if(!e.hasOwnProperty(n))return false;if(!gmath.deepEquals(t[n],e[n]))return false}return true}return false};gmath.find=function(t,e){for(var i=0;i<t.length;i++){if(e(t[i],i,t))return t[i]}return undefined};gmath.findIndex=function(t,e){for(var i=0;i<t.length;i++){if(e(t[i],i,t))return i}return-1};gmath.array={};gmath.array.containsAll=function(t,e){if(e.length>t.length)return false;for(var i=0;i<e.length;i++)if(t.indexOf(e[i])===-1)return false;return true};gmath.array.equals=function(t,e){if(t.length!==e.length)return false;for(var i=0;i<t.length;i++)if(t[i]!==e[i])return false;return true};gmath.array.isPermutation=function(t,e){if(e.length!==t.length)return false;for(var i=0;i<e.length;i++){var n=t.indexOf(e[i]);if(n===-1)return false;else t[n]=undefined}return true};gmath.array.mergedNew=function(t,e){var i=t.slice();for(var n=0;n<e.length;n++)if(t.indexOf(e[n])===-1)i.push(e[n]);return i};gmath.array.xor=function(t,e){var i=[];for(var n=0;n<t.length;n++)if(e.indexOf(t[n])===-1)i.push(t[n]);for(var n=0;n<e.length;n++)if(t.indexOf(e[n])===-1)i.push(e[n]);return i};gmath.array.flatten=function(t){var e=[];for(var i=0;i<t.length;i++)e=e.concat(t[i]);return e};gmath.array.includes=function(t,e){return t.indexOf(e)!==-1};gmath.getURLParameter=function(t){var e=RegExp(t+"="+"(.+?)(&|$)").exec(location.search);return e?decodeURIComponent(e[1]):null};if(typeof Object.create!=="function"){Object.create=function(t){function e(){}e.prototype=t;return new e}}if(!Array.isArray){Array.isArray=function(t){return Object.prototype.toString.call(t)==="[object Array]"}}gmath.byteLength=function(t){var e=t.length;for(var i=t.length-1;i>=0;i--){var n=t.charCodeAt(i);if(n>127&&n<=2047)e++;else if(n>2047&&n<=65535)e+=2;if(n>=56320&&n<=57343)i--}return e};var t={version:"1.3.1x"};if(typeof exports!="undefined"){exports.Tree=t}t.parse=function(e){var i=new t.Node;var n=i.append(new t.Node);var r;n.value="";for(r=0;r<e.length;r++){var o=e[r];if(o=="["){n=n.append(new t.Node);n.value=""}else if(o=="]"){n=n.parent;if(n===i)throw"parse error"}else if(o==","){n=n.parent.append(new t.Node);n.value=""}else{n.value+=o}}for(r=0;r<i.children.length;r++)i.children[r].parent=null;if(i.children.length===1)return i.children[0];return i.children};t.stringify=function(t){var e=function(t){var i="";if("value"in t)i+=t.value;if(t.children&&t.children[0]){i+="["+t.children.map(e).join(",")+"]"}return i};if(!Array.isArray(t))t=[t];return t.map(e).join(",")};(function(){var e=4294967296,i=15,n=[],r=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];function o(){var t=0;var o=Math.random()*e;n[t++]=r[o&i];n[t++]=r[o>>>4&i];n[t++]=r[o>>>8&i];n[t++]=r[o>>>12&i];n[t++]=r[o>>>16&i];n[t++]=r[o>>>20&i];n[t++]=r[o>>>24&i];n[t++]=r[o>>>28&i];o=Math.random()*e;n[t++]=r[o&i];n[t++]=r[o>>>4&i];n[t++]=r[o>>>8&i];n[t++]=r[o>>>12&i];n[t++]=r[o>>>16&i];n[t++]=r[o>>>20&i];n[t++]=r[o>>>24&i];n[t++]=r[o>>>28&i];return"_"+n.join("")}t.uid=o})();t.clone=function(e,i,n){var r=function(e){var o;var s=new e.constructor;if(n){for(o=0;o<n.length;o++)s[n[o]]=e[n[o]]}else{for(var a in e){if(a[0]!=="_")s[a]=e[a]}}delete s.ls;delete s.rs;delete s.parent;if(e.id&&!i)s.id=t.uid();if(e.children){s.children=[];for(o=0;o<e.children.length;o++){s.children.push(r(e.children[o]));s.children[o].parent=s}for(o=0;o<e.children.length;o++){s.children[o].ls=s.children[o-1];s.children[o].rs=s.children[o+1]}}return s};if(!Array.isArray(e))return r(e);var o=e.map(r);if(e.length>1)for(var s=0;s<e.length;s++){if(s>0&&e[s].ls===e[s-1])o[s].ls=o[s-1];if(s<e.length-1&&e[s].rs===e[s+1])o[s].rs=o[s+1]}return o};t.get_mapping_between=function(t,e){var i={};function n(t,e){if(t.id in i)throw"duplicate id in source tree";i[t.id]=[e];if(t.children.length!==e.children.length){if(!t.has_children())i[t.id]=e.select_all();else if(!e.has_children())t.for_each(function(t){i[t.id]=[e]});else throw"tree structures don't match"}else{for(var r=0;r<t.children.length;r++)n(t.children[r],e.children[r])}}if(Array.isArray(t)){if(t.length!==e.length)throw"tree structures don't match";for(var r=0;r<t.length;r++)n(t[r],e[r])}else n(t,e);return i};t.get_1to1_mapping_between=function(t,e,i){var n={};if(arguments.length<3)i=true;function r(t,e){if(i&&t.id in n)throw"duplicate id in source tree";n[t.id]=[e];if(i&&t.children.length!==e.children.length)throw"tree structures don't match";var o=t.children.length,s=e.children.length;for(var a=0;a<o;a++){if(a<s)r(t.children[a],e.children[a]);else t.children[a].for_each(function(t){n[t.id]=[]})}}if(Array.isArray(t)){if(i&&t.length!==e.length)throw"tree structures don't match";var o=t.length,s=e.length;for(var a=0;a<o;a++){if(a<s)r(t[a],e[a]);else t[a].for_each(function(t){n[t.id]=[]})}}else r(t,e);return n};t.nodes_to_range=function(e){var i=e.length;if(i===0)return[];if(i===1)return[e[0]];var n=e[0];while(n.parent)n=n.parent;var r=e.map(function(e){return t.get_path(e)});var o=function(t){var e=r[0][t];for(var i=0;i<r.length;i++){if(r[i].length<=t+1)return false;if(r[i][t]!==e)return false}return true};var s=0;while(o(s))s++;var a=t.get_child(r[0].slice(0,s),n);var h=-1,l=a.children.length,d;for(d=0;d<i;d++){var u=t.get_child(r[d].slice(0,s+1),n);var c=a.children.indexOf(u);if(c>h)h=c;if(c<l)l=c}var p=[];for(d=l;d<=h;d++)p.push(a.children[d]);return p};t.insert=function(t,e,i){i.ls=t.children[e-1];if(t.children[e-1])t.children[e-1].rs=i;i.rs=t.children[e];if(t.children[e])t.children[e].ls=i;i.parent=t;t.children.splice(e,0,i);return i};t.insert_range=function(t,e,i){var n=i.length;if(n===0)return;i[0].ls=t.children[e-1];if(t.children[e-1])t.children[e-1].rs=i[0];i[n-1].rs=t.children[e];if(t.children[e])t.children[e].ls=i[n-1];for(var r=0;r<n;r++)i[r].parent=t;t.children=t.children.slice(0,e).concat(i,t.children.slice(e));return i};t.append_range=function(t,e){var i=e.length;if(i===0)return;var n=t.children[t.children.length-1];if(n)n.rs=e[0];e[0].ls=n;e[i-1].rs=null;for(var r=0;r<i;r++)e[r].parent=t;t.children=t.children.concat(e);return e};t.filterRange=function(t,e){var i=[];var n=Array.isArray(e)?e:[e];var r=function(e,n){var o=[];for(var s=n;s<e.length;s++){o.push(e[s]);if(t(o))i.push(o.slice())}if(e[n].children)for(var s=0;s<e[n].children.length;s++)r(e[n].children,s)};for(var o=0;o<n.length;o++)r(n,o);return i};t.append=function(t,e){var i=t.children[t.children.length-1];if(i)i.rs=e;e.ls=i;e.rs=null;e.parent=t;t.children.push(e);return e};t.remove=function(t){var e;var i=t.parent.children;e=i.indexOf(t);if(i[e-1])i[e-1].rs=t.rs;if(i[e+1])i[e+1].ls=t.ls;i.splice(e,1);return e};t.remove_range=function(t){var e=t.length;if(e===0)return;var i=t[0].parent.children;var n=i.indexOf(t[0]);if(i[n-1])i[n-1].rs=t[e-1].rs;if(i[n+e])i[n+e].ls=t[0].ls;i.splice(n,e);return n};t.replace=function(e,i){if(i.parent)t.remove(i);var n=t.remove(e);return t.insert(e.parent,n,i)};t.switch_siblings=function(t,e){if(t.parent!=e.parent)throw"Called switch_siblings on nodes that are no siblings!";var i=t.parent;var n=i.children.indexOf(t);var r=i.children.indexOf(e);i.children[n]=e;i.children[r]=t;var o;if(t.rs==e){if(t.ls)t.ls.rs=e;if(e.rs)e.rs.ls=t;t.rs=e.rs;e.ls=t.ls;t.ls=e;e.rs=t}else if(t.ls==e){if(t.rs)t.rs.ls=e;if(e.ls)e.ls.rs=t;t.ls=e.ls;e.rs=t.rs;t.rs=e;e.ls=t}else{if(t.ls)t.ls.rs=e;if(t.rs)t.rs.ls=e;if(e.ls)e.ls.rs=t;if(e.rs)e.rs.ls=t;o=t.ls;t.ls=e.ls;e.ls=o;o=t.rs;t.rs=e.rs;e.rs=o}};t.validate=function(t){var e=function(t,i){if(t.parent!=i)throw"wrong parent information";if(t.children){for(var n=0;n<t.children.length;n++){var r=t.children[n];if(r.ls!=t.children[n-1])throw"wrong ls information";if(r.rs!=t.children[n+1])throw"wrong rs information";e(r,t)}}};if(!Array.isArray(t))t=[t];for(var i=0;i<t.length;i++)e(t[i],null)};t.get_idx=function(t){if(t.parent)return t.parent.children.indexOf(t);else return-1};t.get_child=function(t,e){for(var i=0;i<t.length;i++){if(!e.children||e.children.length<=t[i])throw"invalid path";e=e.children[t[i]]}return e};t.get_parent=function(t,e){for(var i=0;i<t;i++){if(e.parent)e=e.parent;else throw"invalid path"}return e};t.get_path=function(t){var e=[];while(t.parent){e.unshift(t.parent.children.indexOf(t));t=t.parent}return e};t.for_each=function(t,e){var i=Array.isArray(e)?e:[e];var n=function(e){t(e);if(e.children)for(var i=0;i<e.children.length;i++)n(e.children[i])};for(var r=0;r<i.length;r++)n(i[r])};t.map=function(t,e){var i=Array.isArray(e)?e:[e];var n=[];var r=function(e){n.push(t(e));if(e.children)for(var i=0;i<e.children.length;i++)r(e.children[i])};for(var o=0;o<i.length;o++)r(i[o]);return n};t.filter=function(t,e){var i=[];var n=Array.isArray(e)?e:[e];var r=function(e){if(t(e))i.push(e);if(e.children)for(var n=0;n<e.children.length;n++)r(e.children[n])};for(var o=0;o<n.length;o++)r(n[o]);return i};t.select_all=function(e){return t.filter(function(){return true},e)};t.select_first=function(t,e){var i=function(e){var i=e;for(;;){if(t(i))return i;if(i.children&&i.children[0]){i=i.children[0];continue}if(i===e)return null;while(!i.rs){i=i.parent;if(i===e)return null}i=i.rs}};var n=Array.isArray(e)?e:[e];for(var r=0;r<n.length;r++){var o=i(n[r]);if(o)return o}return null};t.get_cca=function(e){var i=e.map(function(e){return t.get_path(e)});var n=function(t){var e=i[0][t];for(var n=0;n<i.length;n++){if(i[n].length<=t+1)return false;if(i[n][t]!==e)return false}return true};var r=0;while(n(r))r++;var o=i[0].length-r,s=e[0];for(var a=0;a<o;a++)s=s.parent;return s};t.get_leaf_nodes=function(e){return t.filter(function(t){return!(t.children&&t.children.length)},e)};t.is_root=function(t){return!t.parent};t.is_range=function(t){for(var e=1;e<t.length;e++){if(t[e-1].rs!==t[e])return false}return true};t.get_root=function(t){while(t.parent)t=t.parent;return t};t.get_by_value=function(e,i){return t.filter(function(t){return t.value===e},i)};t.get_by_id=function(e,i){return t.select_first(function(t){return t.id===e},i)};t.Node=function(){this.children=[];this.parent=null;this.ls=null;this.rs=null;this.id=t.uid()};t.Node.prototype.stringify=function(){return t.stringify(this)};t.Node.prototype.clone=function(e,i){return t.clone(this,e,i)};t.Node.prototype.get_mapping_to=function(e){return t.get_mapping_between(this,e)};t.Node.prototype.get_1to1_mapping_to=function(e,i){return t.get_1to1_mapping_between(this,e,i)};t.Node.prototype.insert=function(e,i){return t.insert(this,e,i)};t.Node.prototype.insert_range=function(e,i){return t.insert_range(this,e,i)};t.Node.prototype.append_range=function(e){return t.append_range(this,e)};t.Node.prototype.append=function(e){return t.append(this,e)};t.Node.prototype.remove=function(){return t.remove(this)};t.Node.prototype.remove_range=function(e){return t.remove_range(e)};t.Node.prototype.replace_with=function(e){return t.replace(this,e)};t.Node.prototype.switch_with_sibling=function(e){return t.switch_siblings(this,e)};t.Node.prototype.validate=function(){return t.validate(this)};t.Node.prototype.get_child=function(e){return t.get_child(e,this)};t.Node.prototype.get_parent=function(e){return t.get_parent(e,this)};t.Node.prototype.get_path=function(){return t.get_path(this)};t.Node.prototype.for_each=function(e){return t.for_each(e,this)};t.Node.prototype.map=function(e){return t.map(e,this)};t.Node.prototype.filter=function(e){return t.filter(e,this)};t.Node.prototype.filterRange=function(e){return t.filterRange(e,this)};t.Node.prototype.select_all=function(){return t.select_all(this)};t.Node.prototype.select_first=function(e){return t.select_first(e,this)};t.Node.prototype.get_leaf_nodes=function(){return t.get_leaf_nodes(this)};t.Node.prototype.is_root=function(){return t.is_root(this)};t.Node.prototype.get_root=function(){return t.get_root(this)};t.Node.prototype.get_by_value=function(e){return t.get_by_value(e,this)};t.Node.prototype.get_by_id=function(e){return t.get_by_id(e,this)};t.Node.prototype.has_children=function(){return this.children&&this.children.length>0};t.Node.prototype.get_idx=function(){return t.get_idx(this)};var e=function(t){var e=new RegExp("^\\s*([0-9]*\\.?[0-9]+([eE][-+]?[0-9]+)?)");var i=new RegExp("^\\s*\\{(\\??[A-Za-z0-9_]*)\\:");var n=new RegExp("^\\s*(sin|cos|tan)");var r=new RegExp("^\\s*([a-zA-Z_₀₁₂₃₄₅₆₇₈₉])");var o=new RegExp("^\\s*([α-ωΑ-Ω])");var s=new RegExp('^\\s*"([^"]+)"');var a=new RegExp("^\\s*(\\*\\*|[-\\–+*/=();,^\\{\\}\\[\\]\\|±⁰¹²³⁴⁵⁶⁷⁸⁹ⁿ:])");var h=new RegExp("^\\s*(\\\\[^A-Za-z0-9\\s]|\\\\[A-Za-z]+)");var l=new RegExp("^(\\s+)");var d=[];var u=0;if(t){u=t.length}for(var c=0;c<u;){var p=t.substr(c);var f;if(f=e.exec(p)){d.push({type:"number",value:parseFloat(f[1]),from:c+(f[0].length-f[1].length),to:c+f[0].length});c+=f[0].length}else if(f=i.exec(p)){d.push({type:"operator",value:"{",from:c,to:c+1});d.push({type:"name",value:f[1],from:c+1,to:c+f[1].length+1});d.push({type:"operator",value:":",from:c+f[0].length-1,to:c+f[0].length});c+=f[0].length}else if(f=n.exec(p)){d.push({type:"name",value:f[1],from:c+(f[0].length-f[1].length),to:c+f[0].length});c+=f[0].length}else if(f=r.exec(p)){d.push({type:"name",value:f[1],from:c+(f[0].length-f[1].length),to:c+f[0].length});c+=f[0].length}else if(f=o.exec(p)){d.push({type:"name",value:f[1],from:c+(f[0].length-f[1].length),to:c+f[0].length});c+=f[0].length}else if(f=s.exec(p)){d.push({type:"name",value:f[1],from:c+(f[0].length-f[1].length),to:c+f[0].length});c+=f[0].length}else if(f=a.exec(p)){d.push({type:"operator",value:f[1],from:c+(f[0].length-f[1].length),to:c+f[0].length});c+=f[0].length}else if(f=h.exec(p)){d.push({type:"latex",value:f[1],from:c+(f[0].length-f[1].length),to:c+f[0].length});c+=f[0].length}else if(f=l.exec(p)){c+=f[0].length}else{debugger;throw"can't tokenize '"+p+"'"}}return d};gmath.tokenize=e;var r=function(e,i){t.Node.call(this);this.type="AlgebraModel";this.id=gmath.uid();this.events=d3.dispatch("create","change","mistake","start-of-interaction","end-of-interaction","node-changed","scrubbability-changed","restraint");this.options=gmath.object.merged(r.defaultOptions,i);this.hide_rules=[];this.watchedAspects=[];this.parser=this.options.parser||r.getDefaultParser();this.init_hide_rules();this.parseAndSet(e,true);this.setLocked(this.options.locked)};gmath.inherit(t.Node,r);gmath.AlgebraModel=r;r.getDefaultParser=function(){if(!r.defaultParser)r.defaultParser=o(["num","var","sym","brackets","sign","add-sub","mul-div","exponent","equals","param","trig","abs-val"]);return r.defaultParser};r.defaultOptions={hide_mult_op:true,hide_leading_op:true,parser:null,no_history:true,auto_simplify_distributions:true,auto_simplify_vector_additions:true,auto_simplify_variables:true,locked:false,action_blacklist:[]};r.prototype.clone=function(e,i){var n=new r(null,this.options);n.hide_rules=this.hide_rules.slice();t.append(n,t.clone(this.children[0],e,i||["id","value","name","bp","associative","commutative","vertical_notation","selected","dragging","locked","fixed","hidden","simplify","deleted","precision","color","size","width","height","x","y","x0","y0","rel_x","rel_y","lmar","rmar"]));return n};r.prototype.move_actions=[];if(typeof exports!=="undefined")exports.AlgebraModel=r;r.is_top_most=function(t){return!t.parent||t.parent instanceof r};r.prototype.init_hide_rules=function(){for(var t=0;t<this.parser.symbols.length;t++){var e=gmath.expressions[this.parser.symbols[t]];if(e.hide_rule)this.hide_rules.push(e.hide_rule)}};r.prototype.parseAndSet=function(e,i,n){var o=this.children[0];this.children=[];var s=this.parser.parse(e);if(!s)return false;t.append(this,s);if(!i)this.remove_brackets();this.hide_nodes();this.setLocked(this.options.locked);var a=null;try{if(o)a=o.get_mapping_to(this.children[0])}catch(h){console.log("could not auto-map",o.to_ascii(),"to",this.to_ascii())}finally{this.events.change(new r.ChangeEvent({model:this,node_map:a,no_anim:true,sender:n}));return true}};r.prototype.replace_with=function(t,e){var i,n;if(t instanceof r){i=t;i.setLocked(this.options.locked)}else{i=new r(t,this.options)}try{n=this.children[0].get_1to1_mapping_to(i.children[0],false)}catch(o){console.log("could not auto-map",this.to_ascii(),"to",i.to_ascii())}finally{this.events.change(new r.ChangeEvent({model:this,new_model:i,node_map:n,no_anim:true,sender:e}));return i}};r.prototype.parse=function(t,e){var i=this.parser.parse(t);if(!i)return null;if(!e)this.remove_brackets([i]);return i};r.prototype.to_ascii=function(t){return r.to_ascii(t||this.children)};r.to_ascii=function(t){if(!Array.isArray(t))t=[t];return t.map(function(t){return t.to_ascii()}).join("")};r.prototype.to_latex=function(t){t=t||this.children;if(!Array.isArray(t))t=[t];return t.map(function(t){return t.to_latex()}).join("")};r.select_range_by_value=function(t,e){return function(i){if(!i[0].parent)return false;if(i[0].parent.parent&&r.range_contains_all_siblings(i))return false;return r.rangeToAscii(i)===t||r.rangeToAsciiNoLeadingOp(i,e)===t||i.length===1&&r.fractionToAscii(i[0])===t}};r.rangeToAscii=function(t){if(t.length===1&&t[0].hidden)return"";return t.map(function(t){return t.to_ascii()}).join("")};r.isLeadingCommutativeOp=function(t){return t.is_group()&&t.commutative&&t.associative};r.rangeToAsciiNoLeadingOp=function(t,e){if(t.length===0)return"";if(t.length===1&&t[0].hidden)return"";var i=t.map(function(t){return t.to_ascii()}).join("");if(t.length===1&&!e)return i;if(r.isLeadingCommutativeOp(t[0]))return i.substring(t[0].children[0].to_ascii().length);return i};r.fractionToAscii=function(t){if(!t.is_group("fraction"))return"";var e=t.to_ascii();if(e.slice(0,1)==="("&&e.slice(e.length-1,e.length)===")")e=e.substr(1,e.length-2);return e};r.range_contains_all_siblings=function(t){return t[0]&&t[0].parent&&!t[0].parent.is_group("exponent")&&t.length===t[0].parent.children.length};r.select_node_by_value=function(t){return function(e){return!e.is_root()&&!e.hidden&&e.to_ascii()===t}};r.getRanges=function(e,i,n){var o=t.filterRange(r.select_range_by_value(e),n);return typeof i==="number"?o[i]:o};r.prototype.getRanges=function(t,e,i){return r.getRanges(t,e,i||this.children)};r.getNodes=function(e,i,n){var o=t.filter(r.select_node_by_value(e,true),n);return typeof i==="number"?o[i]:o};r.prototype.getNodes=function(t,e,i){return r.getNodes(t,e,i||this.children)};r.prototype.setLocked=function(t){this.options.locked=t;this.for_each(function(e){e.locked=t});this.events["scrubbability-changed"]({type:"scrubbability-changed"})};r.ChangeEvent=function(t){this.type="change";this.old_model_ascii=t.old_model_ascii;this.old_model_string=t.old_model_string;this.old_model=t.model;this.new_model=t.new_model||t.model;this.node_map=t.node_map||t.action&&t.action.node_map||[];this.action=t.action;this.sel=t.sel;this.no_anim=t.no_anim;this.sender=t.sender};r.prototype.created=function(t,e){this.events.create({type:"create",term:t&&t.newTree&&t.newTree.to_ascii(),action:t,sender_id:e||this.id})};r.prototype.startInteraction=function(){this.events["start-of-interaction"]({type:"start-of-interaction",source:this,model:this,time:Date.now()})};r.prototype.finishInteraction=function(t){if(!t){var e=this.children[0].filter(function(t){return t.simplify}),i=gmath.actions.PostInteractionSimplificationAction.createBoundAction(this,{nodes:e,auto_simplify_distributions:this.options.auto_simplify_distributions,auto_simplify_vector_additions:this.options.auto_simplify_vector_additions,auto_simplify_variables:this.options.auto_simplify_variables}),n=this;if(this.options.no_history?i.doInPlace():i.run()){n=i.newTree;i.newTree.hide_nodes();if(i.newTree===i.oldTree){this.events.change(new r.ChangeEvent({model:this,action:i}))}else{this.created(i)}}e.forEach(function(t){t.simplify=false});this.events["end-of-interaction"]({type:"end-of-interaction",source:n,time:Date.now()})}else{this.events["end-of-interaction"]({type:"end-of-interaction",source:this,time:Date.now()})}};r.prototype.root=function(){return this.children[0]};r.prototype.is_group=function(){return false};r.prototype.is_leading_num_in_sub_product=function(t){var e=t.parent;if(t instanceof s&&e.is_group("mul")&&!e.ls&&e.parent.is_group("product")&&e.parent.parent.is_group("sub"))return e.parent.parent;else return false};r.prototype.numeric_value=function(e,i,n){var o=this.to_ascii(),a=this.stringify(),h=this.getSelectorOfNodes(e);var l=e;var d=e.parent,u;if(e instanceof s&&d&&(d.is_group("sign")||d.is_group("add")||d.is_group("sub")))e=d;u=s.get_value(e);if(isNaN(u))return NaN;var c=this.is_leading_num_in_sub_product(e);if(c)u=-u;if(arguments.length<2)return u;var f=u>0||u===0&&(e instanceof s||e.is_group("add"));var g=i>0||i===0&&(e instanceof s||e.is_group("add"));if(f&&!g){if(e.is_group("add")){e.invert();this.hide_nodes()}else{var v=t.remove(e);var _=new p(e);_.children[0].no_anim=true;t.insert(d,v,_);_.selected=e.selected;e=_}}else if(!f&&g){if(e.is_group("sign")){var m=e.children[1];t.replace(e,m);e.children[0].no_anim=true;m.selected=e.selected;e=m}else if(e.is_group("sub")){e.invert();this.hide_nodes()}else if(c){c.invert();this.hide_nodes()}}else if(this.f_eqls(u,i))return e;if(e.is_group())e.children[1].value=Math.abs(i);else e.value=Math.abs(i);var y=this.children[0].get_mapping_to(this.children[0]);y[l.id]=[e];this.events.change(new r.ChangeEvent({model:this,node_map:y,no_anim:true,old_model_ascii:o,old_model_string:a,sel:h,sender:n}));return e};r.prototype.f_eqls=function(t,e){return Math.abs(t-e)<1e-6};r.prototype.remove_brackets=function(e){t.for_each(function(t){if(t.is_group("fraction")&&t.parent.is_group("brackets"))u.handle(t.parent,true)},e||this.children)};r.prototype.process_operator=function(t,e,i){if(t.fixed){if(e)e(false);return false}while(!t.getBestMatchingAction&&t.parent)t=t.parent;if(t.getBestMatchingAction&&!t.getBestMatchingAction(i,this.options.action_blacklist)&&t.parent)t=t.parent;if(t.is_group("brackets")&&t.children[0].hidden)t=t.parent;if(!t.getBestMatchingAction){if(e)e(null);return null}var n=t.getBestMatchingAction(i);var r=n?n.createBoundAction(this,{actor:t},i):null;this.performAction(r,e);return r};r.prototype.performAction=function(t,e,i){var n=[t];if(t&&t.settings&&t.settings.makes_no_changes){t.doInPlace();return t}if(typeof i==="undefined")i=this.options.no_history;var o=this;var s=function(t){if(!t){o.events.mistake(o);if(e)e(t);return}if(i){o.hide_nodes();o.events.change(new r.ChangeEvent({model:o,action:t}))}else{t.newTree.hide_nodes();o.created(t)}if(t.settings.restraint){o.events.restraint(t.settings.restraint)}if(t.followup){var s=t.newTree.performAction(t.followup,e,i);n=n.concat(s)}else if(e){e(t.newTree)}};if(!t){s();return null}if(i)t.doInPlace(s);else t.run(s);if(n.length===1)return n[0];else return Action.createComposedAction(n,n[0].name,n[0].description)};r.prototype.hide_nodes=function(){return this.hideNodesAction.doInPlace(this)};r.prototype.performSplitAction=function(t){var e=new Q;e.split(this,t||this.children)};r.prototype.getMoveActions=function(t){if(t.length===0)return[];if(t.some(function(t){return t.fixed}))return[];var e=[];for(var i=0;i<this.move_actions.length;i++){var n=this.move_actions[i];if(n.name&&this.options.action_blacklist.indexOf(n.name)!==-1)continue;var r=this.move_actions[i].getAllAvailableActions(t);if(!r)debugger;e=e.concat(this.move_actions[i].getAllAvailableActions(t))}return e};r.groupNodeRanges=function(t){return r.groupNodes(t,function(t,e){return t[t.length-1].rs===e})};r.groupNodes=function(t,e){if(!t.length)return[];var i=[];var n=[t[0]];i.push(n);for(var r=1;r<t.length;r++){if(e(n,t[r])){n.push(t[r])}else{n=[t[r]];i.push(n)}}return i};r.__reg_exp_cache={};r.match=function(t,e){var i=r.__reg_exp_cache;for(var n=0;n<e.length;n++){var o=e[n];if(!i[o])i[o]=new AlgebraRegExp(o);var s=i[o].match(t);if(s)return s}return false};t.Node.prototype.match=function(){return r.match(this,arguments)};r.prototype.make_flat=function(){var e=t.get_leaf_nodes(this);var i=new l("flat",0);i.commutative=true;e.forEach(function(e){if(e.hidden)return;e.commutative=true;e.associative=true;t.append(i,e)});this.children=[];t.append(this,i);this.events.change(new r.ChangeEvent({model:this}))};r.prototype.getSelectorOfNodes=function(t){if(!Array.isArray(t))t=[t];var e=[];for(var i=0;i<t.length;i++){var n=t[i];var r=this.getNodes(n.to_ascii());var o=r.indexOf(n);if(o===-1)e.push("");else if(o===0)e.push(n.to_ascii());else e.push(n.to_ascii()+":"+o)}return e};AlgebraRegExp=function(){this.simple_models=[];for(var t=0;t<arguments.length;t++){var e=new gmath.AlgebraModel(arguments[t],{parser:AlgebraRegExp.getRegExpParser()});this.simple_models=this.simple_models.concat(this.getVariations(e))}};gmath.AlgebraRegExp=AlgebraRegExp;AlgebraRegExp.getRegExpParser=function(){if(!AlgebraRegExp.regexpParser){var t=gmath.AlgebraParser(["num","var","sym","brackets","sign","add-sub","mul-div","exponent","equals","param","trig"]);t.registerSymbol(":",1).led=function(e){var i=t.parseExpression(0);var n=e.value[0]==="?";i.match_name=n?e.value.slice(1):e.value;i.match_optional=n;return i};["NUM","VAR","ANY"].forEach(function(e){t.registerSymbol("\\"+e).nud=function(){return new gmath.expressions.placeholder(e.toLowerCase())}});AlgebraRegExp.regexpParser=t}return AlgebraRegExp.regexpParser};AlgebraRegExp.prototype.getVariations=function(t,e){e=e||0;var i=t.select_first(function(t){return t.match_optional});if(!i)return[t];i.match_optional=false;var n=t.clone(false,["id","value","name","bp","associative","commutative","vertical_notation","match_name","match_optional"]);var r=this.getVariations(n,e+1);var o=new Action;o.newTree=t;if(i.parent.commutative)i=i.parent;if(i.commutative){i.remove();o.cleanup_cascade(i.parent);r=r.concat(this.getVariations(t,e+1))}else if(e===0)throw"only nodes in commutative groups can be optional";return r};AlgebraRegExp.prototype.combineWith=function(t){this.simple_models=this.simple_models.concat(t.simple_models)};AlgebraRegExp.prototype.match_node=function(t,e){if(t.is_group("sym")&&e.is_group("sym")&&e.value==="±"&&(t.value==="-"||t.value==="+"))return true;if(t.is_group("add","sub")&&e.is_group("addsub"))return true;if(t.is_group("sign")&&e.is_group("plusminus"))return true;return t.name===e.name&&t.value===e.value&&t.children.length===e.children.length};AlgebraRegExp.checkAndSetMatch=function(t,e,i){if(!e)return true;if(t[e]&&t[e].to_ascii()!==i.to_ascii())return false;t[e]=i;return true};AlgebraRegExp.prototype.match_tree=function(t,e,i){if(e.is_group("plusminus")&&!t.is_group("sign","plusminus")){if(!AlgebraRegExp.checkAndSetMatch(i,e.match_name,t))return false;e=e.children[1]}if(e.is_group("brackets")&&e.children[1].is_group("plusminus")&&!t.is_group("brackets")){if(!AlgebraRegExp.checkAndSetMatch(i,e.match_name,t))return false;e=e.children[1].children[1]}if(e.is_group("placeholder")){var n=e.match(t);if(!n)return false;if(!AlgebraRegExp.checkAndSetMatch(i,e.match_name,n))return false;return true}else{if(!AlgebraRegExp.checkAndSetMatch(i,e.match_name,t))return false;if(!this.match_node(t,e))return false;for(var r=0;r<t.children.length;r++){var n=this.match_tree(t.children[r],e.children[r],i);if(!n)return false}return true}};AlgebraRegExp.prototype.match=function(t){var e={};var i=t.type==="AlgebraModel"?t.children[0]:t;for(var n=0;n<this.simple_models.length;n++){var r=this.match_tree(i,this.simple_models[n].children[0],e);if(r)return e}return false};var o=function(t){var i={};var n;var r;var o;var s;var a=function(){return this};var h=function(t,e){e=e||this;e.name="SyntaxError";e.message=t;throw e};var l=function(){this.def={}};l.prototype.find_or_define=function(t){var e=this.def[t.value];if(!e||typeof e=="function")e=i[t.value];if(e&&typeof e!=="function")return e;e=Object.create(i["(name)"]);e.lpb=0;this.def[t.value]=e;return e};var d=function(t,e){var a,l,d,u;if(t&&n.id!==t){if(e)return;else h("Expected '"+t+"'.",n)}if(o>=r.length){n=i["(end)"];return}d=r[o];o+=1;u=d.value;a=d.type;if(a==="name"){l=s.find_or_define(d)}else if(a==="operator"){l=i[u];if(!l){h("Unknown operator.",d)}}else if(a==="latex"){l=i[u];if(!l){h("Unknown latex command.",d)}}else if(a==="string"||a==="number"){l=i["(number)"];a="number"}else{h("Unexpected token.",d)}n=Object.create(l);n.from=d.from;n.to=d.to;n.value=u;n.type=a;return n};var u=function(t){o--;n=t};var c=function(t,e){var i;var r=e||n;if(!e)d();i=r.nud();while(t<n.lbp){r=n;d();i=r.led(i)}return i};var p={nud:function(){h("Undefined.",this)},led:function(t){h("Missing operator.",this)}};var f=function(t,e){var n=i[t];e=e||0;if(n){if(e>n.lbp){n.lbp=e}}else{n=Object.create(p);n.id=n.value=t;n.lbp=e;i[t]=n}return n};f("(end)");var g=function(t){r=e(t);if(r.length==0)return null;s=new l;o=0;d();var i=c(0);d("(end)");return i};var v={};v.parse=g;v.parseExpression=c;v.advance=d;v.regress=u;v.registerSymbol=f;v.symbols=t;for(var _=0;_<t.length;_++){var m=gmath.expressions[t[_]];if(m&&m.registerAtParser)m.registerAtParser(v)}return v};gmath.AlgebraParser=o;gmath.LinkCoordinator=function(){var t=function(){this.id=gmath.uid();this.links=[];this.groups=[];this.node_to_group={};this.unlinked_nodes=[];this.events=d3.dispatch("link_added","link_removed");this.auto_update_scrubbability=true};gmath.LinkCoordinatorClass=t;t.prototype.addLinks=function(t,e){var i=this;t.forEach(function(t){i.addLink(t,e)})};t.prototype.addLink=function(t,e){this.links.push(t);this.registerLink(t,e);this.events.link_added({link:t})};t.prototype.registerLink=function(t,e){var i=this.getGroup(t.source);var n=this.getGroup(t.target);if(t.bidirectional){if(i!==n){var r=this.mergeGroups(i,n);if(this.auto_update_scrubbability&&!e)this.setLocked(r)}}else{if(i===n)throw"unidirectional linking between bidirectionally linked nodes!";n.deps++;if(this.auto_update_scrubbability&&!e)this.setLocked(n)}};t.prototype.getGroup=function(t){var e=this.node_to_group[t.id];if(!e){e={deps:0,nodes:[t]};this.groups.push(e);this.node_to_group[t.id]=e}return e};t.prototype.replaceNode=function(t,e){if(!this.node_to_group[t.id])return;var i=this.node_to_group[t.id];delete this.node_to_group[t.id];
this.node_to_group[e.id]=i;var n=i.nodes.indexOf(t);i.nodes[n]=e};t.prototype.unlinkCanvasModel=function(t,e){var i=this;t.dls().forEach(function(t){i.unlinkDL(t,true)});t.graphs().forEach(function(t){i.unlinkGraph(t,true)});if(this.auto_update_scrubbability&&!e)this.updateAll()};t.prototype.unlinkDL=function(t,e){return this.unlinkContainer(t.rows,"model",e)};t.prototype.unlinkGraph=function(t,e){return this.unlinkContainer(t.geoms,null,e)};t.prototype.unlinkContainer=function(t,e,i){var n=this;var r=[];t.forEach(function(t){r=r.concat(n.unlinkElement(e?t[e]:t,true))});if(this.auto_update_scrubbability&&!i)this.updateAll();return r};t.prototype.unlinkElement=function(t,e){var i=[],n=this;this.links=this.links.filter(function(e){if(e.source===t||e.target===t){var r=e.source===t?e.target:e.source;if(n.unlinked_nodes.indexOf(r)===-1)n.unlinked_nodes.push(r);i.push(e);return false}return true});if(this.unlinked_nodes.indexOf(t)===-1)this.unlinked_nodes.push(t);if(this.auto_update_scrubbability&&!e)this.updateAll();return i};t.prototype.updateAll=function(){this.groups=[];this.node_to_group={};for(var t=0;t<this.unlinked_nodes.length;t++)this.getGroup(this.unlinked_nodes[t]);this.unlinked_nodes=[];for(var t=0;t<this.links.length;t++)this.registerLink(this.links[t],true);for(var t=0;t<this.groups.length;t++)this.setLocked(this.groups[t])};t.prototype.setLocked=function(t){t.nodes.forEach(function(e){e.setLocked(t.deps>0)})};t.prototype.mergeGroups=function(t,e){var i=this;var n=this.groups.indexOf(e);this.groups.splice(n,1);e.nodes.forEach(function(e){i.node_to_group[e.id]=t});t.nodes=t.nodes.concat(e.nodes);t.deps+=e.deps;return t};return new t}();AlgebraModelLink=function(t,e,i,n){this.id=n||gmath.uid();this.source=t;this.target=e;this.action=i;this.broken=false;this.model_before_broken=null;this.source.events.on("change."+this.id,this.onChange.bind(this));this.target.events.on("change."+this.id,this.onTargetChange.bind(this))};AlgebraModelLink.prototype.onChange=function(t){if(t.old_model!==this.source)throw"wrong old_model";if(t.new_model!==t.old_model){this.source.events.on("change."+this.id,null);this.source=t.new_model;gmath.LinkCoordinator.replaceNode(t.old_model,t.new_model);this.source.events.on("change."+this.id,this.onChange.bind(this))}var e=this.action.nodes;var i=this.action.target;var n=this.action.actor;if(!this.broken){this.action.rebind(t.new_model,t.node_map,t.old_model)}else{try{var r=this.model_before_broken.children[0].get_1to1_mapping_to(t.new_model.children[0],false);this.action.rebind(t.new_model,r,t.old_model)}catch(o){console.log("scrubbing broke, can't reapply",this.action.name,"to",t.new_model.to_ascii());return}}if(this.action.rematch()){this.broken=false;this.model_before_broken=null;this.action.run();this.action.newTree.hide_nodes();this.action.newTree.for_each(function(t){t.selected=false});this.target.replace_with(this.action.newTree)}else{this.action.nodes=e;this.action.target=i;this.action.actor=n;if(!this.broken){this.broken=true;this.model_before_broken=t.old_model}console.log("scrubbing broke, can't reapply",this.action.name,"to",this.source.to_ascii())}};AlgebraModelLink.prototype.onTargetChange=function(t){if(t.old_model!==this.target)throw"wrong old_model";if(t.new_model!==t.old_model){this.target.events.on("change."+this.id,null);this.target=t.new_model;gmath.LinkCoordinator.replaceNode(t.old_model,t.new_model);this.target.events.on("change."+this.id,this.onTargetChange.bind(this))}};var s=function(e){t.Node.call(this);this.precision=2;this.max_precision=12;if(!gmath.options.mark_rounded_numbers)this.max_precision=3;if(typeof e!=="number")e=0;if(e>=0)this.value=e;else return new p(new s(-e))};gmath.inherit(t.Node,s);s.prototype.name="num";s.is_num=function(t){return t.is_group("num")||t.is_group("sign","add","sub")&&(t.children[1]&&t.children[1].is_group("num"))};s.get_value=function(t){if(!t)return NaN;if(t instanceof s)return t.value;if(t.is_group("sign")&&t.children[1]instanceof s)return-t.children[1].value;if(t.is_group("add")&&t.children[1]instanceof s)return t.children[1].value;if(t.is_group("sub")&&t.children[1]instanceof s)return-t.children[1].value;return NaN};s.prototype.get_signed_value=function(){var t=this.parent,e;if(!t)return this.value();if(t&&t.is_group("sign","sub"))return-this.value;if(s.is_leading_num_in_sub_product(this))return-this.value;return this.value};s.is_leading_num_in_sub_product=function(t){var e=t.parent;if(t instanceof s&&e.is_group("mul")&&!e.ls&&e.parent.is_group("product")&&e.parent.parent.is_group("sub"))return e.parent.parent;else return false};s.prototype.to_string=function(){if(this.scrubbingThisNum)return this.value.toFixed(2);if(!gmath.options.mark_rounded_numbers)return this.get_value();if(this.precision===null||this.decimal_count()<=this.precision){return this.get_value()}else return this.value.toFixed(this.precision)+"..."};s.prototype.decimal_count=function(){var t=this.to_ascii(),e=t.indexOf(".");if(e===-1)return 0;return t.length-e-1};s.prototype.get_value=function(){var t=Math.pow(10,this.max_precision);return Math.round(this.value*t)/t};s.prototype.to_ascii=function(){return this.get_value().toString()};s.prototype.to_latex=s.prototype.to_ascii;s.prototype.is_group=function(){for(var t=0;t<arguments.length;t++){if(arguments[t]==="num")return true}return false};s.registerAtParser=function(t){var e=t.registerSymbol("(number)",30);e.nud=function(){return new s(this.value)};e.led=function(e){var i=t.parseExpression(_.prototype.bp,this);return _.createProduct(e,i)}};gmath.expressions[s.prototype.name]=s;var a=function(e){t.Node.call(this);this.value=e};gmath.inherit(t.Node,a);a.mappings={"-":"−","*":"·","/":"·","//":""};a.prototype.name="sym";a.prototype.to_string=function(){if(this.value==="-"&&this.parent&&this.parent.is_group("sign"))return"-";if(this.value in a.mappings)return a.mappings[this.value];return this.value};a.prototype.to_ascii=function(){return this.value};a.prototype.to_latex=function(){if(this.value==="/")return"\\cdot ";if(this.value==="*")return"\\cdot ";if(this.value==="(")return"\\left(";if(this.value===")")return"\\right)";if(this.value==="[")return"\\left[";if(this.value==="]")return"\\right]";return this.value};a.prototype.is_group=function(){for(var t=0;t<arguments.length;t++){if(arguments[t]==="sym")return true}return false};gmath.expressions[a.prototype.name]=a;var h=function(e,i){t.Node.call(this);this.bp=100;this.set_value(e,i)};gmath.inherit(t.Node,h);h.prototype.name="var";h.prototype.to_string=function(){return this.value};h.prototype.to_ascii=function(){var t=this.has_children()?this.children[0].value:this.value;if(t.length>1)t='"'+t+'"';if(!this.has_children())return t;var e=this.children[1].to_ascii();if(e.length>1)return t+"_{"+e+"}";else return t+"_"+e};h.prototype.to_latex=function(){var t=this.has_children()?this.children[0].value:this.value;if(t.length>1)t='"'+t+'"';if(!this.has_children())return t;var e=this.children[1].to_latex();if(e.length>1)return t+"_{"+e+"}";else return t+"_"+e};h.prototype.is_group=function(){for(var t=0;t<arguments.length;t++){if(arguments[t]==="var")return true}return false};h.prototype.appendSubscript=function(e){if(e instanceof h){this.append(e)}else if(e instanceof t.Node){var i=e.to_ascii();i=i.replace(/\*/g,"");this.append(new h(i))}else{this.append(new h(e))}};h.prototype.set_value=function(t,e){if(!e){this.value=t}else{this.children=[];if(t instanceof h)this.append(t);else this.append(new h(t));this.appendSubscript(e);this.children[0].fixed=true;this.children[1].fixed=true;this.value=this.to_ascii()}};h.prototype.get_value=function(t){return h.get_value(this,t)};h.is_var=function(t){return t instanceof h||t.is_group("power")&&t.children[0]instanceof h};h.get_value=function(t,e){var i=t.to_ascii();if(e){return i.split("_")[0]}return i};h.registerAtParser=function(t){var e=t.registerSymbol("_",100);e.led=function(e){if(!(e instanceof h))return false;var i=t.parseExpression(99);return new h(e,i)};var i=[{"char":"₀",val:0},{"char":"₁",val:1},{"char":"₂",val:2},{"char":"₃",val:3},{"char":"₄",val:4},{"char":"₅",val:5},{"char":"₆",val:6},{"char":"₇",val:7},{"char":"₈",val:8},{"char":"₉",val:9}];i.forEach(function(e){t.registerSymbol(e.char,100).led=function(t){if(!(t instanceof h))return false;return new h(t,new h(e.val))}});var n={"(name)":"","\\alpha":"α","\\Alpha":"Α","\\beta":"β","\\Beta":"Β","\\gamma":"γ","\\Gamma":"Γ","\\delta":"δ","\\Delta":"Δ","\\epsilon":"ε","\\Epsilon":"Ε","\\zeta":"ζ","\\Zeta":"Ζ","\\eta":"η","\\Eta":"Η","\\theta":"θ","\\Theta":"Θ","\\iota":"ι","\\Iota":"Ι","\\kappa":"κ","\\Kappa":"Κ","\\lambda":"λ","\\Lambda":"Λ","\\mu":"μ","\\Mu":"Μ","\\nu":"ν","\\Nu":"Ν","\\xi":"ξ","\\Xi":"Ξ","\\omicron":"ο","\\Omicron":"Ο","\\pi":"π","\\Pi":"Π","\\rho":"ρ","\\Rho":"Ρ","\\sigma":"σ","\\Sigma":"Σ","\\tau":"τ","\\Tau":"Τ","\\upsilon":"υ","\\Upsilon":"Υ","\\phi":"φ","\\Phi":"Φ","\\chi":"χ","\\Chi":"Χ","\\psi":"ψ","\\Psi":"Ψ","\\omega":"ω","\\Omega":"Ω"};var r=function(){if(this.type==="name")return new h(this.value);else return new h(n[this.value])};var o=function(e){var i=t.parseExpression(_.prototype.bp,this);return _.createProduct(e,i)};for(var s in n){var a=t.registerSymbol(s,30);a.nud=r;a.led=o}};gmath.expressions[h.prototype.name]=h;var l=function(e,i){t.Node.call(this);if(arguments.length>1)this.bp=i;if(arguments.length>0)this.value=e};gmath.inherit(t.Node,l);l.prototype.to_ascii=function(){return this.children.map(function(t){if(t.is_group()&&t.commutative&&!t.ls&&t.associative)return t.children[1].to_ascii();return t.to_ascii()}).join("")};l.prototype.to_latex=function(){return this.children.map(function(t){if(t.is_group()&&t.commutative&&!t.ls&&t.associative)return t.children[1].to_latex();return t.to_latex()}).join("")};l.prototype.is_group=function(t){if(arguments.length===0)return true;for(var e=0;e<arguments.length;e++){if(this.value===arguments[e])return true}return false};if(typeof module==="object"&&module.exports){module.exports=l}var d=function(e,i){gmath.inherit(l,this);this.prototype.bp=i.bp||0;this.prototype.associative=i.associative||false;this.prototype.commutative=i.commutative||false;this.prototype.has_inverse=i.has_inverse||false;this.prototype.inverse_group_name=i.inverse_group_name;this.prototype.group_name=i.group_name||i.group_class&&i.group_class.prototype.name;this.prototype.group_class=i.group_class;this.prototype.value=e;this.prototype.name=e;this.prototype.action_handlers=[];this.prototype.vertical_notation=i.vertical_notation||false;this.prototype.add_action_handler=function(t){if(this.action_handlers.indexOf(t)==-1)this.action_handlers.push(t)};this.prototype.getBestMatchingAction=function(t,e){if(!e)e=[];var i=null;for(var n=0;n<this.action_handlers.length;n++){var r=this.action_handlers[n];if(r.name&&e.indexOf(r.name)!==-1)continue;if(!r.match(this))continue;if((i===null||r.priority>i.priority)&&(!t||t.type==="tap"&&!r.triggerType||r.triggerType===t.type)){i=r}}return i};this.prototype.createGroup=function(){return new this.group_class};this.createGroup=this.prototype.createGroup;this.prototype.getInverse=function(){return this.inverse&&gmath.expressions[this.inverse]};this.prototype.clean_up_commutative=function(){if(!this.ls&&!this.rs){var e=this.children[1];t.replace(this.parent,e);u.handle(e);return true}if(this.merge_nested_group())return true};this.prototype.merge_nested_group=function(){if(this.associative&&this.children[1].is_group(this.group_name)){var e=this.parent;var i=this.children[1];if(t.get_child([1,0,0],this).value===t.get_child([0],this).value){t.replace(t.get_child([1,0,0],this),t.get_child([0],this))}var n=t.remove(this);for(var r=0;r<i.children.length;r++){t.insert(e,n+r,i.children[r])}return true}};gmath.expressions[e]=this};if(typeof module==="object"&&module.exports){module.exports=d}var u=function(e,i,n){l.call(this);if(e){t.append(this,new a(i||"("));t.append(this,e);t.append(this,new a(n||")"))}};d.call(u,"brackets",{bp:0});var c=function(e){l.call(this);if(e){t.append(this,new a("|"));t.append(this,e);t.append(this,new a("|"))}};d.call(c,"abs-val",{bp:0});u.registerAtParser=function(t){var e=t.registerSymbol("|");e.nud=function(){var e=t.parseExpression(0);t.advance("\\right",true);t.advance("|");return new c(e)};e.led=function(e){var i=t.parseExpression(_.prototype.bp,this);return _.createProduct(e,i);return e};var i=t.registerSymbol("[",30);i.nud=function(){var e=t.parseExpression(0);t.advance("\\right",true);t.advance("]");return new u(e,"[","]")};i.led=function(e){var i=t.parseExpression(_.prototype.bp,this);return _.createProduct(e,i)};t.registerSymbol("]");var n=t.registerSymbol("(",30);n.nud=function(){var e=t.parseExpression(0);t.advance("\\right",true);t.advance(")");return new u(e)};n.led=function(e){var i=t.parseExpression(_.prototype.bp,this);return _.createProduct(e,i)};t.registerSymbol(")");var r=t.registerSymbol("\\left",30);r.nud=function(){if(t.advance("[",true))return i.nud();else if(t.advance("(",true))return n.nud();else if(t.advance("|",true))return e.nud()};r.led=function(r){if(t.advance("[",true))return i.led(r);else if(t.advance("(",true))return n.led(r);else if(t.advance("|",true))return e.led(r)};t.registerSymbol("\\right");t.registerSymbol("{").nud=function(){var e=t.parseExpression(0);t.advance("}");return e};t.registerSymbol("}")};u.handle=function(e,i){if(e.is_group("brackets")){if(i&&u.is_optional(e)){t.replace(e,e.children[1]);return"removed"}return false}if(!u.is_optional(e)){var n=t.remove(e);t.insert(e.parent,n,new u(e));return"added"}return false};u.is_optional=function(t,e){if(t.is_group("brackets")&&t.children[1].is_group("brackets"))return true;var i=t instanceof u?t.children[1]:t;var e=e||t.parent;if(i.is_group("tuple"))return false;if(i.is_group("abs-val"))return true;if(!i.has_children())return true;if(e instanceof r)return true;if(e.is_group("sign")&&i.is_group("fraction"))return true;if(e.bp>i.bp)return false;if(i.is_group("sign"))return true;if(e.bp<i.bp)return true;if(e instanceof p&&i instanceof p)return true;if(e.associative&&i.is_group(e.group_name))return true;if(i.commutative&&e.is_group(i.group_name))return true;if(i.is_group("mul","div")&&e.is_group("fraction"))return true;if(i.is_group("product")&&e.is_group("div")&&e.parent&&e.parent.is_group("fraction"))return true;if(i.is_group("fraction")&&e.is_group("mul","div"))return true;return false};var p=function(e,i){l.call(this);if(e){t.append(this,new a(i?"±":"-"));t.append(this,e);u.handle(e)}if(i)this.value="plusminus"};d.call(p,"sign",{bp:40,associative:true,commutative:false,inverse:"sign"});p.registerAtParser=function(t){t.registerSymbol("+").nud=function(){return t.parseExpression(p.prototype.bp)};var e=t.registerSymbol("-");e.nud=function(){var e=t.parseExpression(p.prototype.bp);return new p(e)};var i=t.registerSymbol("±");i.nud=function(){var e=t.parseExpression(p.prototype.bp);return new p(e,true)};t.registerSymbol("–").nud=e.nud};p.prototype.deconstruct=function(){var t=[];t.push(this);return t};var f=function(){l.call(this)};d.call(f,"sum",{bp:20});var g=function(e,i){l.call(this);if(e){if(i==="add")this.value="add";else if(i==="sub")this.value="sub";else if(i==="addsub")this.value="addsub";else{if(e.is_group("sign","plusminus")){this.value=e.is_group("sign")?"sub":"addsub";this.match_name=e.match_name;this.match_optional=e.match_optional;e=e.children[1]}else this.value="add"}this.value=this.value;t.append(this,new a(g.value2sym[this.value]));t.append(this,e);u.handle(e)}this.associative=this.value=="add"};g.value2sym={add:"+",sub:"-",addsub:"±"};d.call(g,"add-sub",{group_class:f,group_name:"sum",bp:20,associative:true,commutative:true,has_inverse:true});g.prototype.invert=function(){if(this.value=="add"){this.value="sub";if(this.children[0])this.children[0].value="-";this.associative=false}else{this.value="add";if(this.children[0])this.children[0].value="+";this.associative=true}};g.registerAtParser=function(t){var e=t.registerSymbol("+",g.prototype.bp);e.led=function(e){var i=t.parseExpression(g.prototype.bp);if(e.is_group("sum")){e.append(new g(i,"add"));return e}else{var n=g.prototype.createGroup();n.append(new g(e));n.append(new g(i,"add"));return n}};var i=t.registerSymbol("-",g.prototype.bp);var n=t.registerSymbol("–",g.prototype.bp);i.led=function(e){var i=t.parseExpression(g.prototype.bp);if(e.is_group("sum")){e.append(new g(i,"sub"));return e}else{var n=g.prototype.createGroup();n.append(new g(e));n.append(new g(i,"sub"));return n}};n.led=i.led;var r=t.registerSymbol("±",g.prototype.bp);r.led=function(e){var i=t.parseExpression(g.prototype.bp);if(e.is_group("sum")){e.append(new g(i,"addsub"));return e}else{var n=g.prototype.createGroup();n.append(new g(e));n.append(new g(i,"addsub"));return n}}};g.split=function(e,i){var n=1,r;if(e.is_group("product")&&e.children.length>1){if((e.children[0].children[1]instanceof s||e.children[0].children[1]instanceof p)&&!i){n=s.get_value(e.children[0].children[1]);r=e.children.slice(1)}else{r=e.children.slice()}}else r=[new _(t.clone(e))];return{num:n,variables:r}};g.prototype.absorbNegative=function(){var t=this.is_group("sub");var e=this.children[1];if(e.is_group("sign")){var i=e.children[1];e.remove();i.remove();this.append(i);this.invert()}};gmath.expressions.addsub=g;var v=function(){l.call(this)};d.call(v,"product",{bp:30,vertical_notation:false});v.prototype.invert=function(){var e=this.children.length;if(this.value=="product"){this.value="fraction";this.vertical_notation=true;var i=this.children[e-1],n=e-1;while(i&&i.value=="div"){i=i.ls;n--}if(!i||i.value!=="//")t.insert(this,n+1,new a("//"))}else{this.value="product";this.vertical_notation=false;if(e>0){var r=this.children[0];while(r){if(r.value=="//")t.remove(r);r=r.rs}}}};v.prototype.append=function(e){if(this.value=="product"&&e.value=="div"){this.invert();t.append(this,e)}else if(this.value=="fraction"&&e.value=="mul"){var i=0;while(i<this.children.length&&this.children[i].value!=="//")i++;t.insert(this,i,e)}else{t.append(this,e)}return this};v.prototype.insert_into_demominator=function(e,i){if(!i.is_group("div"))throw'wrong type of term, expected "div", not "'+i.name+'"';if(this.value=="product"){this.invert();t.append(this,i)}else{var n=0;while(n<this.children.length&&this.children[n].value!=="//")n++;n=Math.max(this.children.length,n+1+e);t.insert(this,n,term)}return this};v.prototype.get_top=function(){var t=this.children[0],e=[];while(t){if(t.value=="mul")e.push(t);t=t.rs}return e};v.prototype.get_bottom=function(){var t=this.children[0],e=[];while(t){if(t.value=="div")e.push(t);t=t.rs}return e};v.prototype.get_fraction_bar=function(){var t=this.children[0];while(t){if(t.value=="//")return t;t=t.rs}return null};v.is_lone_fraction_part=function(t){if(!t.parent)return false;return t.parent.is_group("fraction")&&(t.is_group("mul")&&!t.ls&&t.rs.value==="//"||t.is_group("div")&&!t.rs&&t.ls.value==="//")};v.prototype.group_nodes=function(){var t=this.children[0],e=[],i=[],n;while(t){if(t.value=="div")i.push(t);else if(t.value=="mul")e.push(t);else n=t;t=t.rs}return{top:e,bottom:i,bar:n}};v.prototype.to_latex=function(){var t=this.get_top(),e=this.get_bottom();var i=e.length>0?"\\frac{":"";for(var n=0;n<t.length;n++){i+=n==0?t[n].children[1].to_latex():t[n].to_latex()}if(e.length>0){i+="}{";for(var n=0;n<e.length;n++){i+=n==0?e[n].children[1].to_latex():e[n].to_latex()}i+="}"}return i};v.prototype.to_ascii=function(){var t=this.get_top(),e=this.get_bottom();var i="",n="";for(var r=0;r<t.length;r++){i+=r==0?t[r].children[1].to_ascii():t[r].to_ascii()}if(e.length==0)return i;for(var r=0;r<e.length;r++){n+=(r==0?"":"*")+e[r].children[1].to_ascii()}if(t.length>1)i="("+i+")";if(e.length>1)n="("+n+")";var o=i+"/"+n;if(!u.is_optional(this)||this.parent.is_group("sign")||this.parent.commutative)return"("+o+")";else return o};var _=function(e,i){l.call(this);this.value=i=="div"?"div":"mul";if(e){t.append(this,new a(this.value=="mul"?"*":"/"));t.append(this,e);u.handle(e)}this.associative=this.value=="mul";this.bp=this.value=="mul"?30:30};d.call(_,"mul-div",{group_class:v,bp:30,associative:true,commutative:true,has_inverse:true});_.createProduct=function(t,e){if(t.is_group("product")){t.append(new _(e));return t}else{var i=_.prototype.createGroup();i.append(new _(t));i.append(new _(e));return i}};_.registerAtParser=function(t){var e=t.registerSymbol("*",_.prototype.bp);e.led=function(e){var i=t.parseExpression(_.prototype.bp);return _.createProduct(e,i)};var i=t.registerSymbol("\\cdot",_.prototype.bp);i.led=e.led;var n=t.registerSymbol("\\times",_.prototype.bp);n.led=e.led;var r=t.registerSymbol("/",_.prototype.bp+1);r.led=function(e){var i=t.parseExpression(_.prototype.bp+1);if(e.is_group("fraction")){e.append(new _(i,"div"));return e}else{var n;if(e.is_group("brackets")&&e.children[1].is_group("product")){e=e.children[1]}if(e.is_group("product")){n=e}else{n=_.prototype.createGroup();n.append(new _(e))}if(i.is_group("brackets")&&i.children[1].is_group("product")){i=i.children[1]}if(i.is_group("product")){var r=i.children;for(var o=0;o<r.length;o++){r[o].invert();n.append(r[o])}}else{n.append(new _(i,"div"))}return n}};var o=function(){var e=t.parseExpression(_.prototype.bp+1);var i=t.parseExpression(_.prototype.bp+1);var n;if(e.is_group("product"))n=e;else{n=_.prototype.createGroup();n.append(new _(e))}if(i.is_group("product")){i.children.forEach(function(t){t.invert();n.append(t)})}else n.append(new _(i,"div"));return n};t.registerSymbol("\\frac").nud=o;t.registerSymbol("\\dfrac").nud=o;t.registerSymbol("\\tfrac").nud=o};_.hide_rule={name:"hide multiplication sign between variables",disabled:false,apply:function(t){if(!(t instanceof a)||t.value!=="*"&&t.value!=="/")return false;var e=t.parent;if(!e||!(e.is_group("mul")||e.is_group("div")))return false;if(!e.ls||e.ls.value!==e.value||!t.rs)return false;var i=e.ls.children[1];if(t.rs instanceof h||t.rs.is_group("power")&&t.rs.children[0]instanceof h){if(s.is_num(i)||i instanceof h||i.is_group("sign")&&i.children[1]instanceof h){if(e.dragging)t.hide_after_drop=true;else t.hidden=true}}}};_.prototype.invert=function(){if(this.value=="mul"){this.value="div";if(this.children[0])this.children[0].value="/";this.associative=false;this.bp=30}else{this.value="mul";if(this.children[0])this.children[0].value="*";this.associative=true;this.bp=30}};var m=function(t,e){l.call(this);if(t&&e){this.append(t);if(e.is_group("exponent"))this.append(e);else this.append(new y(e));u.handle(t)}};d.call(m,"power",{bp:50,vertical_notation:false});var y=function(e){l.call(this);if(e){t.append(this,e);u.handle(e)}};d.call(y,"exponent",{group_class:m,group_name:"power",bp:50,vertical_notation:true});y.prototype.to_ascii=function(){if(this.children.length===0)return"";return"^"+this.children[0].to_ascii()};y.registerAtParser=function(t){t.registerSymbol("^",y.prototype.bp).led=function(e){var i=t.parseExpression(y.prototype.bp-1);return new m(e,i)};var e=[{"char":"⁰",val:0},{"char":"¹",val:1},{"char":"²",val:2},{"char":"³",val:3},{"char":"⁴",val:4},{"char":"⁵",val:5},{"char":"⁶",val:6},{"char":"⁷",val:7},{"char":"⁸",val:8},{"char":"⁹",val:9}];e.forEach(function(e){t.registerSymbol(e.char,y.prototype.bp).led=function(t){return new m(t,new s(e.val))}});t.registerSymbol("ⁿ",y.prototype.bp).led=function(t){return new m(t,new h("n"))};t.registerSymbol("\\sqrt").nud=function(){var e=t.parseExpression(Infinity);var i=_.prototype.createGroup();i.append(new _(new s(1)));i.append(new _(new s(2),"div"));var n=new m(e,i);return n};t.registerSymbol("\\scriptscriptstyle").nud=function(){var e=t.parseExpression(y.prototype.bp);return e}};var w=function(e){t.Node.call(this);if(e===1||e==="T"||e==="t"||e===true)this.value="T";else this.value="F";this.id=gmath.uid()};gmath.inherit(t.Node,w);w.prototype.name="bool";w.prototype.to_string=function(){return this.value};w.prototype.to_ascii=w.prototype.to_string;w.prototype.is_group=function(){return false};w.registerAtParser=function(t){var e=t.registerSymbol("(number)");e.nud=function(){return new w(this.value)}};gmath.expressions=gmath.expressions||{};gmath.expressions[w.prototype.name]=w;var b=function(){l.call(this)};d.call(b,"disjunction",{bp:30});var x=function(e){l.call(this);if(e){t.append(this,new a("∧"));t.append(this,e);u.handle(e)}};d.call(x,"and",{group_name:"disjunction",group_class:b,bp:30,associative:true,commutative:true});x.registerAtParser=function(t){var e=t.registerSymbol("*",x.prototype.bp);e.led=function(e){var i=t.parseExpression(x.prototype.bp);if(e.is_group("disjunction")){e.append(new x(i));return e}else{var n=x.prototype.createGroup();n.append(new x(e));n.append(new x(i));return n}}};var A=function(){l.call(this)};d.call(A,"conjunction",{bp:30});var N=function(e){l.call(this);if(e){t.append(this,new a("∨"));t.append(this,e);u.handle(e)}};d.call(N,"or",{group_name:"conjunction",group_class:A,bp:20,associative:true,commutative:true});N.registerAtParser=function(t){var e=t.registerSymbol("+",N.prototype.bp);e.led=function(e){var i=t.parseExpression(N.prototype.bp);if(e.is_group("conjunction")){e.append(new N(i));return e}else{var n=N.prototype.createGroup();n.append(new N(e));n.append(new N(i));return n}}};var T=function(e,i){l.call(this);if(e&&i){t.append(this,e);t.append(this,new a("="));t.append(this,i)}};d.call(T,"equals",{bp:10});T.registerAtParser=function(t){var e=t.registerSymbol("=",T.prototype.bp);e.led=function(e){var i=t.parseExpression(T.prototype.bp);if(e.is_group("equals")||i.is_group("equals")){throw"Parser will not allow multiple equals in an equation."}return new T(e,i)}};T.prototype.getSideOfNode=function(t){while(!(t.parent instanceof T))t=t.parent;return t};T.prototype.getOppositeSideOfNode=function(t){return this.isOnLeftSide(t)?this.getRightSide():this.getLeftSide()};T.prototype.getLeftSide=function(){return this.children[0]};T.prototype.getRightSide=function(){return this.children[2]};T.prototype.isOnLeftSide=function(t){return this.getSideOfNode(t)==this.getLeftSide()};T.prototype.isOnRightSide=function(t){return this.getSideOfNode(t)==this.getRightSide()};T.prototype.areOnSameSide=function(t,e){var i=this.isOnLeftSide(t),n=this.isOnLeftSide(e);return i&&n||!i&&!n};var S=function(){l.call(this);this.bp=100;this.value="tuple";for(var t=0;t<arguments.length;t++){var e=arguments[t];if(e instanceof k)this.append(e);else this.append(new k(e))}};gmath.inherit(l,S);S.prototype.name="tuple";S.is_tuple=function(t){return t instanceof S||t.is_group("brackets")&&t.children[1]instanceof S};S.prototype.to_ascii=function(){return this.children.map(function(t){if(!t.ls){return t.children[1].to_ascii()}else{return t.to_ascii()}}).join("")};S.prototype.to_latex=function(){return this.children.map(function(t){if(!t.ls){return t.children[1].to_latex()}else{return t.to_latex()}}).join("")};gmath.expressions[S.prototype.name]=S;var k=function(t){l.call(this);this.value="param";if(t){this.append(new a(","));this.children[0].fixed=true;this.append(t)}this.group_class=S;this.group_name="tuple";this.associative=false;this.commutative=false};gmath.inherit(l,k);k.prototype.name="param";k.prototype.bp=5;k.createTuple=function(t,e){if(t.is_group("tuple")){t.append(new k(e));return t}else{var i=new S;i.append(new k(t));i.append(new k(e));return i}};k.prototype.append=function(e){t.append(this,e);if(e instanceof a){e.fixed=true}};k.registerAtParser=function(t){var e=t.registerSymbol(",",k.prototype.bp);e.led=function(e){var i=t.parseExpression(k.prototype.bp);return k.createTuple(e,i)};var i=t.registerSymbol("\\,",k.prototype.bp);i.led=e.led};k.hide_rule={name:"Do not show the first comma in a tuple set.",disabled:false,apply:function(t){if(!(t instanceof a)||t.value!==",")return false;var e=t.parent;if(!e||!e.is_group("param"))return false;if(!e.ls||e.ls.value!==e.value){t.hidden=true}}};gmath.expressions[k.prototype.name]=k;var L=function(e){l.call(this);t.append(this,new a(e));this.value=e;this.units="rad"};gmath.inherit(l,L);d.call(L,"trig",{bp:60,commutative:false});L.registerAtParser=function(t){var e=function(){var e=t.parseExpression(L.prototype.bp);var i=new u(new S(e.children[1]));var n=new L(this.value[0]==="\\"?this.value.substr(1):this.value);n.append(i);return n};["sin","cos","tan","\\sin","\\cos","\\tan"].forEach(function(i){t.registerSymbol(i,L.prototype.bp).nud=e})};L.prototype.to_string=function(){return this.value};L.prototype.get_arg=function(){return this.get_child([1,1,0,1])};L.prototype.evaluate=function(t,e){if(arguments.length<1)t=s.get_value(this.get_arg());if(Number.isNaN(t))return NaN;if((e||this.units)==="deg")t*=Math.PI/180;return Math[this.value](t)};L.prototype.is_group=function(){for(var t=0;t<arguments.length;t++){if(arguments[t]==="trig")return true}return false};var M=function(e){t.Node.call(this);this.value=e};gmath.inherit(t.Node,M);M.prototype.name="placeholder";M.prototype.to_string=function(){return"[]"};M.prototype.match=function(t){if(this.value==="any")return true;return t.name===this.value&&t};M.prototype.to_ascii=function(){return"\\"+this.value.toUpperCase()};M.prototype.to_latex=function(){return"\\"+this.value.toUpperCase()};M.prototype.is_group=function(){for(var t=0;t<arguments.length;t++)if(arguments[t]==="placeholder")return true;return false};gmath.expressions[M.prototype.name]=M;gmath.actions={};Action=function(t,e){this.name=t;this.description=e;this.id=gmath.uid();this.priority=0;this.node_map={};this.initial_node_map={};this.touched_nodes={};this.new_selection=null;this.timeoutID=null;this.settings={}};Action.prototype.printMap=function(t){if(t)console.log(t);for(var e in this.node_map){var i=this.oldTree.get_by_id(e);console.log(i?i.to_ascii():"?","==>",this.node_map[e].map(function(t){return t.to_ascii()}).join(", "))}};Action.prototype.createBoundAction=function(t,e,i){var n=new this.constructor(e);n.oldTree=t;n.newTree=t;n.trigger=i;return n};Action.prototype.rebind=function(t,e,i){if(this.oldTree!==i)throw"wrong old tree during rebinding an action!";var n=new Action;n.node_map=e;this.oldTree=t;if(this.nodes)this.nodes=n.mapNodes(this.nodes);if(this.target)this.target=Array.isArray(this.target)?[n.mapNodes(this.target)[0]]:n.mapNodes(this.target)[0];if(this.actor)this.actor=n.mapNodes(this.actor)[0]};Action.prototype.createAndRun=function(t,e,i){var n=new this.constructor(e);n.oldTree=t;n.run(i);return n};Action.prototype.createAndDoInPlace=function(t,e,i){var n=new this.constructor(e);n.oldTree=t;n.newTree=t;n.doInPlace(i);return n};Action.prototype.initNodeMap=function(){this.initial_node_map=this.oldTree.children[0].get_mapping_to(this.newTree.children[0]);this.node_map=this.oldTree.children[0].get_mapping_to(this.newTree.children[0])};Action.prototype.removeDeletedNodesFromNodeMap=function(){var t=this.newTree.select_all();var e=function(e){return t.indexOf(e)!==-1};for(var i in this.node_map){this.node_map[i]=this.node_map[i].filter(e)}};Action.prototype.updateNodeMap=function(t,e){if(arguments.length===1)gmath.extend(this.node_map,t);else{var i=t;if(Array.isArray(i)){for(var n=0;n<i.length;n++){this.node_map[i[n].id]=Array.isArray(e)?e:[e]}}else this.node_map[i.id]=Array.isArray(e)?e:[e]}};Action.pushNew=function(t,e){for(var i=0;i<e.length;i++){if(t.indexOf(e[i])===-1)t.push(e[i]);else{t.splice(t.indexOf(e[i]),1);t.push(e[i])}}};Action.prototype.extendNodeMap=function(t,e){if(arguments.length===2){var i=t;var n=Array.isArray(e)?e:[e];if(i.id in this.node_map)Action.pushNew(this.node_map[i.id],n);else this.node_map[i.id]=n;return}else{var r=t;for(var o in r){if(!r.hasOwnProperty(o))continue;if(o in this.node_map)Action.pushNew(this.node_map[o],r[o]);else this.node_map[o]=r[o]}}};Action.prototype.getNewTreeNode=function(t){return this.getCorrespondingNodeFromTree(t,this.newTree)};Action.prototype.getOldTreeNode=function(t){return this.getCorrespondingNodeFromTree(t,this.oldTree)};Action.prototype.getCorrespondingNodeFromTree=function(t,e){var i=function(t){return e.get_child(t.get_path())};if(Array.isArray(t))return t.map(i);else return i(t);
};Action.prototype.addTouchedNodes=function(e){var i=this;t.for_each(function(t){i.touched_nodes[t.id]=true},e)};Action.prototype.getOrInferTriggerType=function(){if(this.triggerType)return this.triggerType;if(this.actor)return"tap";if(this.nodes)return"drag";return"unknown"};Action.prototype.setNodesToReselectAfterAction=function(t){if(Array.isArray(t))this.new_selection=t.slice();else this.new_selection=[t]};Action.prototype.cleanup=function(t){if(!t.cleanupAction)return false;if(!t.cleanupAction.match(t))return false;var e=t.cleanupAction.createAndDoInPlace(this.newTree,{actor:t});this.compose(e,false);return e};Action.prototype.cleanup_cascade=function(t){var e=false;for(;;){var i=this.cleanup(t);if(!i)return e;e=true;var n=i.mapNodes(t);if(n.length===0)return e;t=n[0].parent}};Action.prototype.compose=function(t,e){if(arguments.length<2)e=true;for(var i in this.node_map){var n=this.node_map[i];this.node_map[i]=t.mapNodes(n);var r=n.filter(function(e){return!t.node_map[e.id]});if(r.length>0&&e)throw"Second mapping does not mention all nodes from first mapping.";this.node_map[i]=this.node_map[i].concat(r);if(t.touched_nodes[i])this.touched_nodes[i]=true}if(this.new_selection){this.new_selection=t.mapNodes(this.new_selection)}this.newTree=t.newTree};Action.prototype.run=function(t){this.newTree=this.oldTree.clone();return this.doInPlace(t)};Action.prototype.match=function(){throw"called abstract method Action.match()"};Action.prototype.rematch=function(){if(!(this.actor||this.nodes&&this.nodes.length>0&&this.target&&(!Array.isArray(this.target)||this.target.length>0)))return false;if(this.actor)return this.match(this.actor);if(this.getAllAvailableActions){var t=this.getAllAvailableActions(this.nodes);return t.some(function(t){return gmath.array.equals(t.target,this.target)},this)}};Action.prototype.transform=function(t){throw"called abstract method Action.transform()"};Action.prototype.doInPlace=function(t){this.initNodeMap();var e=this.transform(t);this.removeDeletedNodesFromNodeMap();return e};Action.prototype.wasNodeTouched=function(t){return this.touched_nodes[t.id]};Action.prototype.mapNodes=function(t){var e=[],i=this;if(!Array.isArray(t))t=[t];t.forEach(function(t){var n=i.node_map[t.id]||[];n.forEach(function(t){if(e.indexOf(t)===-1)e.push(t)})});return e};Action.prototype.unmapNodes=function(t){var e=[];if(!Array.isArray(t))t=[t];for(var i in this.node_map){if(gmath.array.isPermutation(t,this.node_map[i]))e.push(this.oldTree.get_by_id(i))}return e};Action.createComposedAction=function(t,e,i){var n=new Action(e,i);function r(){function e(i,r,o){if(o>=t.length)return i;if(!n.touched_nodes[r]){n.touched_nodes[r]=i.some(t[o].wasNodeTouched.bind(t[o]))}return e(t[o].mapNodes(i),r,o+1)}n.node_map={};n.touched_nodes={};for(var i in t[0].node_map){n.touched_nodes[i]=t[0].touched_nodes[i];n.node_map[i]=e(t[0].node_map[i],i,1)}}r();n.oldTree=t[0].oldTree;n.newTree=t[t.length-1].newTree;return n};gmath.actions.CloneAction=function(){var t=function(){Action.call(this,"CloneAction","clone");this.triggerType="drag"};gmath.inherit(Action,t);t.prototype.rematch=function(){return true};t.prototype.transform=function(t){if(typeof t==="function")t(this);else return true};return new t}();gmath.actions.AbsValAction=function(){var e=function(t){Action.call(this,"AbsValAction","evaluate absolute value");this.priority=4;this.triggerType="tap";if(t)this.actor=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){if(t.match("|±\\NUM|"))return true;if(t.is_group("abs-val")&&this.prodFracContainingNumbers(t.get_child([1])))return true;return false};e.prototype.prodFracContainingNumbers=function(t){if(!t.is_group("product","fraction"))return false;return t.get_top().concat(t.get_bottom()).every(function(t){return s.is_num(t.get_child([1]))})};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.actor);this.addTouchedNodes(this.actor);var n=i.match("|±{n:\\NUM}|");if(n){var r=n.n;t.replace(i,r);this.cleanup(r.parent)}else{var o=i.get_child([1]);t.replace(i,o);o.get_top().concat(o.get_bottom()).forEach(function(e){var i=e.get_child([1]);if(i.is_group("sign"))t.replace(i,i.get_child([1]))});this.cleanup(o.parent)}if(typeof e==="function")e(this);else return true};var i=new e;c.prototype.add_action_handler(i);return i}();gmath.actions.AbsValDoubleAction=function(){var e=function(t){Action.call(this,"AbsValDoubleAction","nested absolute values");this.priority=4;this.triggerType="tap";if(t)this.actor=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){return t&&t.match("||±\\ANY||")};e.prototype.transform=function(e){this.addTouchedNodes(this.actor);var i=this.getNewTreeNode(this.actor),n=i.match("|{n:|±\\ANY|}|").n;t.replace(i,n);if(typeof e==="function")e(this);else return true};var i=new e;c.prototype.add_action_handler(i);return i}();gmath.actions.AbsValNegVarAction=function(){var e=function(t){Action.call(this,"AbsValNegVarAction","absolute value of a negative variable");this.priority=4;this.triggerType="tap";if(t)this.actor=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){if(t.match("|-\\VAR|"))return true;if(t.is_group("abs-val")&&this.prodFracContainingNegativeTerms(t.get_child([1])))return true;return false};e.prototype.prodFracContainingNegativeTerms=function(t){if(!t.is_group("product","fraction"))return false;return t.get_top().concat(t.get_bottom()).some(function(t){return t.get_child([1]).is_group("sign")})};e.prototype.transform=function(e){this.addTouchedNodes(this.actor);var i=this.getNewTreeNode(this.actor);var n=i.match("|{neg:-{var:\\VAR}}|");if(n){t.replace(n.neg,n.var)}else{var r=i.get_child([1]);r.get_top().concat(r.get_bottom()).forEach(function(e){var i=e.get_child([1]);if(i.is_group("sign"))t.replace(i,i.get_child([1]))})}if(typeof e==="function")e(this);else return true};var i=new e;c.prototype.add_action_handler(i);return i}();gmath.actions.AbsValExtractNumAction=function(){var e=function(t){Action.call(this,"AbsValExtractNumAction","pull a number out of an absolute value");this.priority=4;this.triggerType="drag";this.settings={};if(t){this.nodes=t.nodes;this.target=t.target;this.settings.side=t.side}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(e){if(!t.is_range(e))return[];if(!e[0].is_group("mul"))return[];if(!e[0].get_parent(2).is_group("abs-val"))return[];if(!e.every(function(t){return s.is_num(t.get_child([1]))}))return[];var i=e[0].get_root(),n=e[0].get_parent(2);return[this.createBoundAction(i,{nodes:e,target:n,side:"left-of"}),this.createBoundAction(i,{nodes:e,target:n,side:"right-of"})]};e.prototype.transform=function(e){this.addTouchedNodes(this.nodes);this.addTouchedNodes(this.target);var i=this.getNewTreeNode(this.target),n=this.getNewTreeNode(this.nodes),r=n[0].get_parent(1);var o=i.get_parent(1),s=i.remove(),a=new v;n.forEach(function(t){var e=t.get_child([1]);if(e.is_group("sign"))e.replace_with(e.get_child([1]))});t.remove_range(n);a.append(new _(i));if(this.settings.side==="left-of")a.insert_range(0,n);else a.append_range(n);o.insert(s,a);this.cleanup(r);this.cleanup_cascade(a.get_parent(1));if(typeof e==="function")e(this);else return true};return new e}();r.prototype.move_actions.push(gmath.actions.AbsValExtractNumAction);gmath.actions.AbsValInsertPosNumAction=function(){var e=function(t){Action.call(this,"AbsValInsertPosNumAction","move a range of positive numbers inside an absolute value group");this.priority=4;this.triggerType="drag";this.settings={};if(t){this.nodes=t.nodes;this.target=t.target;this.settings.side=t.side}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(e){if(!t.is_range(e))return[];if(!e[0].is_group("mul","div"))return[];if(!e.every(this.isPosNum))return[];var i=this.getOtherAbsValMulDivsInGroup(e[0]);return this.bindActionsForEachTarget(e,i)};e.prototype.isPosNum=function(t){var e=t.get_child([1]);return s.is_num(e)&&s.get_value(e)>=0};e.prototype.isAbsVal=function(t){return t.get_child([1]).is_group("abs-val")};e.prototype.getOtherAbsValMulDivsInGroup=function(t){var e=t.get_parent(1);var i=e.get_top().concat(e.get_bottom()).filter(function(e){return e.value===t.value&&this.isAbsVal(e)},this);return i};e.prototype.bindActionsForEachTarget=function(t,e){var i=[];var n=t[0].get_root();e.forEach(function(e){var r=e.get_child([1,1]);if(r.is_group("product"))r=r.children.slice();else r=[r];r.forEach(function(e,r){if(r===0)i.push(this.createBoundAction(n,{nodes:t,target:e,side:"left-of"}));i.push(this.createBoundAction(n,{nodes:t,target:e,side:"right-of"}))},this)},this);return i};e.prototype.transform=function(e){this.addTouchedNodes(this.nodes);this.addTouchedNodes(this.target);var i=this.getNewTreeNode(this.nodes),n=this.getNewTreeNode(this.target);var r=i[0].get_parent(1);t.remove_range(i);if(i[0].is_group("div"))i.forEach(function(t){t.invert()});if(n.is_group("mul")){var o=n.get_parent(1);o.insert_range(n.get_idx()+(this.settings.side==="left-of"?0:1),i)}else{var s=n.get_parent(1),a=n.remove(),h=new v;h.append(new _(n));h.insert_range(this.settings.side==="left-of"?0:1,i);s.insert(a,h)}this.cleanup_cascade(r);if(typeof e==="function")e(this);else return true};var i=new e;return i}();r.prototype.move_actions.push(gmath.actions.AbsValInsertPosNumAction);gmath.actions.AbsValExtractVarAction=function(){var e=function(t){Action.call(this,"AbsValExtractVarAction","pull a variable out of an absolute value");this.priority=4;this.triggerType="drag";this.settings={};if(t){this.nodes=t.nodes;this.target=t.target;this.settings.side=t.side}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(e){if(!t.is_range(e))return[];if(!e[0].is_group("mul"))return[];if(!e[0].get_parent(1).is_group("product"))return[];if(!e[0].get_parent(2).is_group("abs-val"))return[];if(!e.some(function(t){return!s.is_num(t.get_child([1]))}))return[];var i=e[0].get_root(),n=e[0].get_parent(2);return[this.createBoundAction(i,{nodes:e,target:n,side:"left-of"}),this.createBoundAction(i,{nodes:e,target:n,side:"right-of"})]};e.prototype.transform=function(e){this.addTouchedNodes(this.nodes);this.addTouchedNodes(this.target);var i=this.getNewTreeNode(this.target),n=this.getNewTreeNode(this.nodes),r=n[0].get_parent(1);var o=i.get_parent(1),s=i.remove(),a=new v;var h=new c(new v),l=h.get_child([1]);var d=new _(h);a.append(new _(i));if(this.settings.side==="left-of")a.insert(0,d);else a.append(d);t.remove_range(n);l.append_range(n);o.insert(s,a);this.cleanup(r);this.cleanup(l);this.cleanup_cascade(a.get_parent(1));this.setNodesToReselectAfterAction(d);if(typeof e==="function")e(this);else return true};return new e}();r.prototype.move_actions.push(gmath.actions.AbsValExtractVarAction);gmath.actions.AbsValCombineAction=function(){var t=function(t){Action.call(this,"AbsValCombineAction","combine two absolute value terms into one");this.priority=4;this.triggerType="tap";this.settings={delay:300,side:"inside"};if(t){if(t.actor){this.actor=t.actor}else{this.triggerType="drag";this.nodes=t.nodes;this.target=t.target}}};gmath.inherit(Action,t);t.prototype.getAllAvailableActions=function(t){if(t.length!==1)return[];if(!t[0].is_group("mul","div")||!t[0].get_child([1]).is_group("abs-val"))return[];var e=this.getOtherAbsValMulDivsInGroup(t[0]);return this.bindActionForEachTarget(t,e)};t.prototype.getOtherAbsValMulDivsInGroup=function(t){var e=t.get_parent(1);var i=e.get_top().concat(e.get_bottom()).filter(function(e){return e!==t&&e.value===t.value&&e.get_child([1]).is_group("abs-val")},this);return i};t.prototype.bindActionForEachTarget=function(t,e){var i=t[0].get_root();return e.map(function(e){return this.createBoundAction(i,{nodes:t,target:e})},this)};t.prototype.match=function(t){if(!t.ls||t.ls.value!==t.value)return false;return t.ls.get_child([1]).is_group("abs-val")&&t.get_child([1]).is_group("abs-val")};t.prototype.transform=function(t){this.addTouchedNodes(this.nodes||this.actor);if(this.target)this.addTouchedNodes(this.target);var e=this.getNewTreeNode(this.nodes||this.actor),i=this.getNewTreeNode(this.target||this.actor.ls);if(Array.isArray(e))e=e[0];var n=this.getOldTreeNode(e),r=this.getOldTreeNode(i);var o=e.get_idx()<i.get_idx();var s=e.get_parent(1);e.remove();var a=i.remove();var h=this.getTermForAbsVal(e),l=this.getTermForAbsVal(i);var d=new v;d.append(l);if(o)d.insert(0,h);else d.append(h);var u=new c(d),p=new _(u,n.value);this.mapOpAndSym(n,p);this.mapBars(n.get_child([1]),u);this.mapOpAndSym(r,p);this.mapBars(r.get_child([1]),u);s.insert(a,p);this.cleanup(h);this.cleanup(l);this.cleanup_cascade(s);if(typeof t==="function")t(this);else return true};t.prototype.getTermForAbsVal=function(t){var e=t.get_child([1,1]);e.remove();return new _(e)};t.prototype.mapOpAndSym=function(t,e){this.updateNodeMap(t,e);this.updateNodeMap(t.get_child([1]),e.get_child([1]))};t.prototype.mapBars=function(t,e){this.updateNodeMap(t.get_child([0]),e.get_child([0]));this.updateNodeMap(t.get_child([2]),e.get_child([2]))};var e=new t;_.prototype.add_action_handler(e);return e}();r.prototype.move_actions.push(gmath.actions.AbsValCombineAction);gmath.actions.AbsValFracSplitAction=function(){var e=function(t){Action.call(this,"AbsValFracSplitAction","isolating the absolute value to the numerator and denominator");this.priority=4;this.triggerType="drag";this.settings={};if(t){this.nodes=t.nodes;this.target=t.target;this.settings.side=t.side}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(e){if(!t.is_range(e))return[];var i=e[0].get_parent(1);if(!i.is_group("fraction"))return[];if(e[0].is_group("mul")&&e.length!==i.get_top().length)return[];if(e[0].is_group("div")&&e.length!==i.get_bottom().length)return[];var n=i.get_parent(1);if(!n.is_group("abs-val"))return[];var r=e[0].get_root(),o=e[0].is_group("mul")?"above":"below";return[this.createBoundAction(r,{nodes:e,target:n,side:o})]};e.prototype.transform=function(e){this.addTouchedNodes(this.nodes);this.addTouchedNodes(this.target);var i=this.getNewTreeNode(this.target),n=i.get_child([1]);var r=i.get_parent(1),o=i.remove();n.remove();var s=n.get_top();t.remove_range(s);var a=new v;a.append_range(s);var h=new c(a);var l=n.get_bottom();t.remove_range(l);var d=new v;l.forEach(function(t){t.invert()});d.append_range(l);var u=new c(d);n.append(new _(h));n.append(new _(u,"div"));r.insert(o,n);this.cleanup(a);this.cleanup(d);this.cleanup_cascade(r);if(typeof e==="function")e(this);else return true};return new e}();r.prototype.move_actions.push(gmath.actions.AbsValFracSplitAction);gmath.actions.AbsValFracSplitAction=function(){var t=function(t){Action.call(this,"AbsValFracSplitAction","isolating the absolute value to the numerator and denominator");this.priority=4;this.triggerType="tap";this.settings={};if(t)this.actor=t.actor};gmath.inherit(Action,t);t.prototype.match=function(t){if(!t.is_group("fraction"))return false;if(t.get_top().length!==1||!t.get_child([0,1]).is_group("abs-val"))return false;if(t.get_bottom().length!==1||!t.get_child([2,1]).is_group("abs-val"))return false;return true};t.prototype.transform=function(t){this.addTouchedNodes(this.actor);var e=this.getNewTreeNode(this.actor);var i=e.get_child([0]),n=i.get_child([1,1]),r=e.get_child([2]),o=r.get_child([1,1]);n.remove();o.remove();i.get_child([1]).remove();r.get_child([1]).remove();i.append(n);r.append(o);var s=e.get_parent(1),a=e.remove();var h=new c(e);s.insert(a,h);this.cleanup(i);this.cleanup(r);this.cleanup_cascade(e);if(typeof t==="function")t(this);else return true};var e=new t;v.prototype.add_action_handler(e);return e}();gmath.actions.AbsValVarPowerAction=function(){var e=function(t){Action.call(this,"AbsValVarPowerAction","real even powers are positive");this.priority=4;this.triggerType="tap";this.settings={restraint:"The power base must be real."};if(t)this.actor=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){return t.is_group("abs-val")&&t.get_child([1]).is_group("power")&&h.is_var(t.get_child([1,0]))&&this.exponentIsAnEvenNumber(t.get_child([1,1,0]))};e.prototype.exponentIsAnEvenNumber=function(t){return s.is_num(t)&&s.get_value(t)%2===0};e.prototype.transform=function(e){this.addTouchedNodes(this.actor);var i=this.getNewTreeNode(this.actor),n=i.get_child([1]);t.replace(i,n);if(typeof e==="function")e(this);else return true};var i=new e;c.prototype.add_action_handler(i);return i}();gmath.actions.AbsValReselectGroupAction=function(){var t=function(t){Action.call(this,"AbsValReselectGroupAction","drag the left absolute value bar to reselect the whole group");this.priority=2;this.triggerType="drag";this.settings={makes_no_changes:true,update_node_positions:true,side:"outside",margin:{y1:.4,y2:.4}};if(t){this.nodes=t.nodes;this.target=t.target}};gmath.inherit(Action,t);t.prototype.getAllAvailableActions=function(t){if(t.length!==1)return[];var e=t[0];if(!e.is_group("sym")||e.value!=="|")return[];var i=e.get_root();var n=this.createBoundAction(i,{nodes:[e],target:e});return[n]};t.prototype.transform=function(t){this.addTouchedNodes(this.target.parent);this.setNodesToReselectAfterAction(this.target.parent);if(typeof t==="function")t(this);return this};return new t}();r.prototype.move_actions.push(gmath.actions.AbsValReselectGroupAction);gmath.actions.AbsValCreateNegativeAction=function(){var t=function(t){Action.call(this,"AbsValCreateNegativeAction","drag the absolute value bar to the left to produce a negative sign");this.priority=1;this.triggerType="drag";this.settings={delay:1e3,side:"left-of"};if(t){this.nodes=t.nodes;this.target=t.target}};gmath.inherit(Action,t);t.prototype.getAllAvailableActions=function(t){if(t.length!==1)return[];if(!(t[0]instanceof a)||t[0].to_ascii()!=="|")return[];if(this.absValTermIsNegative(t[0].get_parent(1).get_child([1])))return[];return this.bindActions(t[0])};t.prototype.absValTermIsNegative=function(t){if(s.is_num(t)&&s.get_value(t)<0)return true;if(t.is_group("sign"))return true;if(t.is_group("product")&&t.get_child([0,1]).is_group("sign"))return true;else return false};t.prototype.bindActions=function(t){var e=t.get_root();return[this.createBoundAction(e,{nodes:[t],target:t})]};t.prototype.transform=function(t){this.addTouchedNodes(this.target.parent);var e=this.getNewTreeNode(this.target.parent),i=e.get_child([1]);if(i.is_group("product")){var n=i.get_child([0]),r=n.get_child([1]),o=r.remove();n.insert(o,new p(r))}else{i.remove();e.insert(1,new p(i))}this.setNodesToReselectAfterAction(e);if(typeof t==="function")t(this);return this};return new t}();r.prototype.move_actions.push(gmath.actions.AbsValCreateNegativeAction);gmath.actions.PostInteractionSimplificationAction=function(){var t=function(t){Action.call(this,"PostInteractionSimplificationAction","simplify terms after interaction");this.priority=0;this.triggerType="auto";this.settings={simplify_products:true,simplify_variables:true,simplify_sums:true};if(t){this.nodes=t.nodes;if("auto_simplify_distributions"in t)this.settings.simplify_products=t.auto_simplify_distributions;if("auto_simplify_variables"in t)this.settings.simplify_variables=t.auto_simplify_variables;if("auto_simplify_vector_additions"in t)this.settings.simplify_sums=t.auto_simplify_vector_additions}};gmath.inherit(Action,t);t.prototype.match=function(t){return true};t.prototype.rematch=function(){return true};t.prototype.transform=function(t){this.changed=false;var e=this.getNewTreeNode(this.nodes);for(var i=0;i<e.length;i++){var n=this.mapNodes(this.nodes[i])[0];if(!n)continue;var o=n.parent;if(n.is_group("brackets")){if(u.handle(n,true))this.changed=true;if(this.cleanup_cascade(o))this.changed=true}else if(this.prodFracContainingAMulZero(n)&&this.settings.simplify_variables){var a=gmath.find(n.get_top(),function(t){var e=t.get_child([1]);return s.is_num(e)&&s.get_value(e)===0});n.get_top().filter(function(t){return t!==a}).concat(n.get_bottom().filter(function(t){return s.get_value(t.get_child([1]))!==0})).forEach(function(t){t.remove()});if(o.is_group("add","sub")){var h=o.parent;o.remove();this.cleanup(h)}this.changed=true}else if(n.is_group("product")&&this.settings.simplify_products||n.is_group("sum")&&this.settings.simplify_sums){var l=this.getNumberOperatorsFromGroup(n);if(l.length>1){var d=n.is_group("product")?gmath.actions.MultiplyNumbersAction:gmath.actions.AddSubNumbersAction;this.applyOperators(l,d);if(n.is_group("product"))this.applyNegatives(o);this.changed=true}}else if(this.muldiv1(n)||this.addsub0(n)){var c=o.parent;this.updateNodeMap(this.nodes[i].select_all(),n.ls||n.rs);n.remove();this.cleanup(o);this.cleanup(c);if(!r.is_top_most(c))u.handle(c,true);this.changed=true}else if(this.muldivNeg1(n)){var c=o.parent;var p=n.children[1];p.remove();var f=p.children[1];this.updateNodeMap(this.nodes[i],n.ls||n.rs);this.updateNodeMap(this.nodes[i].children[1].children[1].get_mapping_to(n.ls||n.rs));var g=n.ls||n.rs;f.remove();var v=g.children[1];if(v.is_group("sign")){v.remove();v=v.children[1];v.remove();g.append(v)}else{v.remove();p.append(v);g.append(p)}n.remove();this.cleanup(o);this.cleanup(c);if(!r.is_top_most(c))u.handle(c,true);this.changed=true}else if(this.exp1(n)){var _=n.parent,m=_.children[0],o=_.parent,y=_.remove();m.remove();o.insert(y,m);this.changed=true}if(this.changed)this.removeDeletedNodesFromNodeMap()}if(typeof t==="function")t(this);else return this.changed};t.prototype.getNumberOperatorsFromGroup=function(t){var e=[];for(var i=0;i<t.children.length;i++){var n=t.children[i];if(s.is_num(n.children[1]))e.push(n)}return e};t.prototype.applyOperators=function(t,e){var i=t[0],n=t.slice(1);for(var r=0;r<n.length;r++){i=this.runAction(e,i,n[r])}};t.prototype.runAction=function(t,e,i){var n=t.createBoundAction(this.newTree,{target:e,nodes:[i],triggerType:"drag"});n.doInPlace();this.compose(n,false);return n.mapNodes([e])[0]};t.prototype.applyNegatives=function(t){var e=["PlusMinusProductToMinusProductAction","AddNegativeAction"];for(var i=0;i<e.length;i++){var n=gmath.actions[e[i]];if(n.match(t)){this.compose(n.createAndDoInPlace(this.newTree,{actor:t}),false);return}}};t.prototype.muldiv1=function(t){return t.is_group("mul","div")&&s.is_num(t.children[1])&&s.get_value(t.children[1])===1};t.prototype.muldivNeg1=function(t){return t.is_group("mul","div")&&s.is_num(t.children[1])&&s.get_value(t.children[1])===-1};t.prototype.addsub0=function(t){return t.is_group("add","sub")&&s.is_num(t.children[1])&&s.get_value(t.children[1])===0};t.prototype.prodFracContainingAMulZero=function(t){return t.is_group("product","fraction")&&t.get_top().some(function(t){var e=t.get_child([1]);return s.is_num(e)&&s.get_value(e)===0})};t.prototype.getSumAncestor=function(t){var e=t.parent;while(e&&!e.is_group("sum")){e=e.parent}return e};t.prototype.exp1=function(t){return t.is_group("exponent")&&s.is_num(t.children[0])&&s.get_value(t.children[0])===1};return new t}();gmath.actions.AddSubNumbersAction=function(){var t=function(t){Action.call(this,"AddSubNumbersAction","add or subtract numbers");this.priority=1;this.triggerType="tap";this.settings={is_join_action:true,delay:300,side:"inside",margin:{x:.1}};if(t){if(t.triggerType==="drag"){this.triggerType=t.triggerType;this.nodes=t.nodes;this.target=t.target}else{this.actor=t.actor}}};gmath.inherit(Action,t);t.prototype.getAllAvailableActions=function(t){if(t.length>1)return[];if(!t[0].is_group("add","sub"))return[];if(!s.is_num(t[0].children[1]))return[];var e=this.getOtherNumberAddendsInSum(t[0]);return this.bindActionForEachTarget(t,e)};t.prototype.getOtherNumberAddendsInSum=function(t){var e=t.parent;var i=e.filter(function(i){return i!==t&&i.is_group("add","sub")&&s.is_num(i.children[1])&&i.parent===e});return i};t.prototype.bindActionForEachTarget=function(t,e){var i=[];var n=t[0].get_root();for(var r=0;r<e.length;r++){i.push(this.createBoundAction(n,{nodes:t,target:e[r],triggerType:"drag"}))}return i};t.prototype.match=function(t){if(!t.parent.is_group("sum"))return false;if(!t.ls)return false;var e=t.ls.children[1],i=t.children[1];return s.is_num(e)&&!(e.is_group("sign")&&e.parent.is_group("sub"))&&s.is_num(i)&&!(i.is_group("sign")&&i.parent.is_group("sub"))};t.prototype.transform=function(t){if(this.triggerType==="drag"){this.sourceAddend=this.nodes[0];this.targetAddend=this.target}else{this.sourceAddend=this.actor;this.targetAddend=this.actor.ls}this.addTouchedNodes(this.sourceAddend);this.addTouchedNodes(this.targetAddend);var e=this.getNewTreeNode(this.sourceAddend),i=this.getNewTreeNode(this.targetAddend),n=e.parent;var r=e.children[1],o=i.children[1];var a=(e.is_group("sub")?-1:1)*s.get_value(r)+(i.is_group("sub")?-1:1)*s.get_value(o);var h=i.is_group("add")&&i.children[1].is_group("sign");var l=new g(new s(a),h?"add":"auto");this.updateNodeMap(this.sourceAddend,l);this.updateNodeMap(this.sourceAddend.children[0],l.children[0]);this.updateNodeMap(this.sourceAddend.children[1].get_mapping_to(l.children[1]));this.updateNodeMap(this.targetAddend,l);this.updateNodeMap(this.targetAddend.children[0],l.children[0]);this.updateNodeMap(this.targetAddend.children[1].get_mapping_to(l.children[1]));var d=i.remove();n.insert(d,l);e.remove();this.cleanup(n);if(typeof t==="function")t(this);return this};g.prototype.add_action_handler(new t);return new t}();r.prototype.move_actions.push(gmath.actions.AddSubNumbersAction);(function(){var e=function(t){Action.call(this,"SumCleanupAction","sum cleanup action");if(t)this.actor=t.actor};gmath.inherit(Action,e);gmath.actions.SumCleanupAction=e;e.prototype.match=function(t){return t.is_group("sum")&&t.children.length<=1};e.prototype.doInPlace=function(e){this.initNodeMap();var i=this.getNewTreeNode(this.actor);if(i.children.length===0){t.remove(i)}else if(i.children.length===1){var n=i.children[0],r=this.actor.children[0],o;if(n.is_group("add")){o=n.children[1];this.updateNodeMap(r.children[0],o)}else if(n.is_group("sub","addsub")){var s=n.is_group("addsub");if(n.children[1].is_group("product")){var a=n.children[1].children[0].children[1],h=a.parent;a.remove();var l=new p(a,s);h.append(l);o=n.children[1]}else{o=new p(n.children[1],s)}this.updateNodeMap(r.children[0],o.children[0])}this.updateNodeMap(r,o);this.updateNodeMap(r.parent,o);t.replace(n.parent,o);if(o.parent&&o.parent.is_group("brackets"))u.handle(o.parent,true);else u.handle(o)}if(typeof e==="function")e(this);else return this};f.prototype.cleanupAction=new e})();gmath.actions.AssociateIntoFractionAction=function(){var e=function(t){Action.call(this,"AssociateIntoFractionAction","associative property of multiplication--move into fraction");this.priority=0;this.triggerType="tap";this.settings={};if(t){if(t.actor)t=this.getSettingsFromActor(t.actor);this.triggerType="drag";this.nodes=t.nodes;this.target=t.target;this.settings.side=t.side;if(t.triggerType)this.triggerType=t.triggerType;if(t.margin)this.settings.margin=t.margin}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){if(!this.matchStructure(t))return[];var e=this.findTargets(t);var i=e.filter(this.matchTarget.bind(this));return this.bindActions(t,i)};e.prototype.matchStructure=function(e){if(e.length===0)return false;if(!t.is_range(e))return false;if(!e[0].is_group("mul","div"))return false;return true};e.prototype.findTargets=function(t){var e=t[0].get_parent(1),i=[];var n=e.children[0];while(n.value!==t[0].value)n=n.rs;while(n!==t[0]){i.push(n);n=n.rs}n=e.children[e.children.length-1];while(n.value!==t[0].value)n=n.ls;while(n!==t[t.length-1]){i.push(n);n=n.ls}return i};e.prototype.matchTarget=function(t,e){if(e)return t.value===e.value&&t.get_child([1]).is_group("fraction");return t.get_child([1]).is_group("fraction")};e.prototype.bindActions=function(t,e){var i=[];var n=t[0].get_root();e.forEach(function(e){var r=e.get_child([1]).get_top(),o=r.length-1;r.forEach(function(e,r){i.push(this.createBoundAction(n,{nodes:t,target:e,side:"left-of",triggerType:"drag"}));if(r===o){i.push(this.createBoundAction(n,{nodes:t,target:e,side:"right-of",triggerType:"drag"}))}},this)},this);return i};e.prototype.getSettingsFromActor=function(t){var e,i,n;if(t&&t.children[1]&&t.children[1].is_group("fraction")){e=t.children[1].children[0];i=[t.ls];n="left-of"}else if(t&&t.ls&&t.ls.children[1]&&t.ls.children[1].is_group("fraction")){var r=t.ls.children[1];var o=r.get_top();e=o[o.length-1];i=[t];n="right-of"}return{target:e,nodes:i,side:n}};e.prototype.match=function(e,i,n){if(arguments.length==1){var r=this.getSettingsFromActor(e);e=r.nodes;i=r.target;n=r.side}if(!e||e.length==0)return false;if(!n)return false;if(!i||!i.is_group("mul","div")||!i.parent.is_group("fraction"))return false;var o=i.parent.parent.value;if(!i.parent.parent||i.parent.parent.parent!==e[0].parent)return false;if(!e.every(function(t){return t.is_group(o)&&t.children[1]!==i.parent}))return false;if(!t.is_range(e))return false;return true};e.prototype.transform=function(e){this.addTouchedNodes(this.nodes);this.addTouchedNodes(this.target);var i=this.getNewTreeNode(this.nodes),n=this.getNewTreeNode(this.target);var r=n.parent,o=r.children.indexOf(n);if(this.settings.side==="right-of")o++;if(r.get_top().length===1&&s.get_value(r.get_child([0,1]))===1)r.get_child([0]).simplify=true;t.remove_range(i);if(i[0].is_group("div"))i.forEach(function(t){t.invert()});r.insert_range(o,i);this.cleanup_cascade(r.parent);if(typeof e==="function")e(this);else return true};_.prototype.add_action_handler(new e);return new e}();r.prototype.move_actions.push(gmath.actions.AssociateIntoFractionAction);gmath.actions.AssociateOutOfFractionAction=function(){var e=function(t){Action.call(this,"AssociateOutOfFractionAction","associative property of multiplication--move out of fraction");this.priority=0;this.triggerType="drag";this.settings={};if(t){this.nodes=t.nodes;this.target=t.target;this.settings.side=Array.isArray(this.target)?"around":t.side;this.settings.target_is_left=t.side==="left-of";this.settings.margin=t.side==="right-of"?{x1:.25,x2:-.25}:{x1:-.25,x2:.25}}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){if(t.length===0)return[];var e=t[0];if(!e.is_group("mul")||!e.parent.is_group("fraction"))return[];if(this.match(t,e.parent)){return[this.bindAction(t,"left-of"),this.bindAction(t,"right-of")]}return[]};e.prototype.bindAction=function(t,e){var i=t[0].get_root();var n=[];if(this.fractionIsPartOfProduct(t)){n=this.getSiblingsOfFraction(t,e)}return this.createBoundAction(i,{nodes:t,target:n.length>0?n:t[0].parent,side:e})};e.prototype.fractionIsPartOfProduct=function(t){var e=t[0].parent;return e.parent&&e.parent.is_group("mul")};e.prototype.getSiblingsOfFraction=function(t,e){var i=t[0].parent,n=i.parent,r=n.parent;if(e==="left-of")return r.children.slice(0,r.children.indexOf(n));else return r.children.slice(r.children.indexOf(n)+1)};e.prototype.match=function(e,i){if(e.length===0)return false;if(e.length===1&&e[0].children[1].value===1)return false;if(!this.allNodesAreMuls(e)||!t.is_range(e))return false;return e[0]&&e[0].parent===i&&i.is_group("fraction")};e.prototype.allNodesAreMuls=function(t){for(var e=0;e<t.length;e++){if(!t[e].is_group("mul"))return false}return true};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.nodes);var n=this.settings.target_is_left;t.remove_range(i);var r=i[0].parent;var o=new v;r.replace_with(o);o.append(new _(r));o.insert_range(n?0:1,i);this.cleanup(r);this.cleanup(o.parent);if(typeof e==="function")e(this);else return true};return new e}();r.prototype.move_actions.push(gmath.actions.AssociateOutOfFractionAction);gmath.actions.AssociateOutOfDenominatorAction=function(){var e=function(t){Action.call(this,"AssociateOutOfDenominatorAction","associative property of division--move out of fraction denominator");this.triggerType="drag";this.settings={};if(t){this.nodes=t.nodes;this.target=t.target;this.settings.side=t.side;this.settings.margin=t.side==="right-of"?{x1:.25,x2:-.25}:{x1:-.25,x2:.25};if(t.margin)this.settings.margin=t.margin}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(e){var i=this;if(e.length===0)return[];if(!t.is_range(e))return[];
var n=e[0].parent;if(!n.is_group("fraction"))return[];var r=n.get_top();var o=n.get_bottom();if(r.length===1&&s.get_value(r[0].children[1])===1&&e.length===o.length)return[];if(!e.every(function(t){return i.match(t,n)}))return[];return this.bindActions(e)};e.prototype.match=function(t,e){if(!t.is_group("div"))return false;if(s.get_value(t.children[1])===-1||s.get_value(t.children[1])===1)return false;if(e&&t.parent!==e)return false;return true};e.prototype.bindActions=function(t){var e=this;var i=t[0].get_root(),n=t[0].parent;return[this.createBoundAction(i,{nodes:t,side:"left-of",target:n}),this.createBoundAction(i,{nodes:t,side:"right-of",target:n})]};e.prototype.transform=function(e){this.addTouchedNodes(this.nodes[0].parent);var i=this.settings.side;if(i==="outside")this.target=this.nodes[0].parent;var n=this.getNewTreeNode(this.nodes),r=n[0].parent,o=this.getNewTreeNode(this.target);t.remove_range(n);var s=this.putDivsInNewFraction(n);var a=this.replaceTargetWithProductContainingTargetAndFraction(o,s,i);this.cleanupSourceFraction(r);this.cleanup(a.parent);if(typeof e==="function")e(this);else return this};e.prototype.putDivsInNewFraction=function(t){var e=new v;e.append(new _(new s(1)));t.forEach(function(t){e.append(t)});return e};e.prototype.replaceTargetWithProductContainingTargetAndFraction=function(t,e,i){var n=new v;var r=t.is_group("mul")?t.children[1]:t;r.replace_with(n);n.append(new _(r));n.insert(i==="left-of"||i==="outside"?0:1,new _(e));return n};e.prototype.cleanupSourceFraction=function(t){var e=t.parent;this.cleanup(t);this.cleanup(e)};return new e}();r.prototype.move_actions.push(gmath.actions.AssociateOutOfDenominatorAction);gmath.actions.AssociateIntoDenominatorAction=function(){var e=function(t){Action.call(this,"AssociateIntoDenominatorAction","associative property of denominator--move into denominator");this.priority=0;this.triggerType="drag";this.settings={};if(t){this.nodes=t.nodes;this.target=t.target;this.settings.side=t.side}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(e){var i=this;if(e.length===0)return[];if(!t.is_range(e))return[];var n=e[0].parent;if(!n.is_group("fraction"))return[];if(!n.parent.is_group("mul","div"))return[];if(!e.every(function(t){return i.match(t,n)}))return[];return this.bindActionsForAssociateIntoDenominatorAction(e)};e.prototype.match=function(t,e){if(!t.is_group("div"))return false;if(t.parent!==e)return false;return true};e.prototype.bindActionsForAssociateIntoDenominatorAction=function(t){var e=[];var i=t[0].get_root(),n=t[0].parent,r=n.parent,o=r.parent;var s=o.children.slice().filter(function(t){return t!==r&&t.is_group(r.value)});for(var a=0;a<s.length;a++){var h=s[a];if(h.children[1].is_group("fraction")){var l=h.children[1].get_bottom();for(var d=0;d<l.length;d++){e.push(this.createBoundAction(i,{nodes:t,target:l[d],side:"left-of"}))}e.push(this.createBoundAction(i,{nodes:t,target:l[l.length-1],side:"right-of"}))}else{e.push(this.createBoundAction(i,{nodes:t,target:h.children[1],side:"inside"}))}}return e};e.prototype.transform=function(e){var i=this;this.nodes.map(this.addTouchedNodes.bind(i));this.addTouchedNodes(this.target);var n=this.settings.side;var r=this.getNewTreeNode(this.nodes),o=r[0].parent,s=this.getNewTreeNode(this.target);t.remove_range(r);this.insertDivsInNewLocation(r,s,n);this.cleanupSourceFraction(o);if(typeof e==="function")e(this);else return this};e.prototype.insertDivsInNewLocation=function(t,e,i){if(e.is_group("div")){this.insertDivRangeIntoDenominator(t,e,i)}else{this.replaceTargetWithFractionContainingTargetAndDivs(t,e)}};e.prototype.insertDivRangeIntoDenominator=function(t,e,i){var n=e.parent;n.insert_range(n.children.indexOf(e)+(i==="left-of"?0:1),t)};e.prototype.replaceTargetWithFractionContainingTargetAndDivs=function(t,e){var i=e.parent,n=new v;e.replace_with(n);n.append(new _(e));t.forEach(function(t){n.append(t)})};e.prototype.cleanupSourceFraction=function(t){var e=t.parent,i=e.parent;this.cleanup(t);var n=this.cleanup(e);if(!n&&s.is_num(e.children[1])&&s.get_value(e.children[1])===1){e.remove();this.cleanup(i)}};return new e}();r.prototype.move_actions.push(gmath.actions.AssociateIntoDenominatorAction);(function(){var e=function(t){Action.call(this,"AddSubBracketsAction","add or subtract a bracketed sum");this.priority=4;this.triggerType="tap";if(t)this.actor=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){if(!t.is_group("add")&&!t.is_group("sub"))return false;if(!t.children[1].is_group("brackets"))return false;return t.children[1].children[1].is_group("sum")||u.is_optional(t.children[1])};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.actor);var n=this.actor.children[0];this.addTouchedNodes(this.actor);var r=i.children[1];var o=i.children[1].children[1];t.replace(r,o);if(i.is_group("sub")&&o.is_group("sum")){i.invert();var s=[];for(var a=0;a<o.children.length;a++){o.children[a].invert();s.push(o.children[a].children[0])}this.updateNodeMap(n,s)}this.cleanup(i);if(typeof e==="function")e(this);else return this};g.prototype.add_action_handler(new e)})();(function(){var e=function(t){Action.call(this,"AddSubCleanUp","addsub cleanup action");if(t)this.addsub=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){return t.is_group("add","sub")&&t.children[1].is_group("sum")};e.prototype.doInPlace=function(e){this.initNodeMap();var i=this.getNewTreeNode(this.addsub);if(i.is_group("add","sub")&&i.children[1].is_group("sum")){var n=i.is_group("sub");var r=i.parent;var o=i.children[1],s=this.addsub.children[1];this.updateNodeMap(this.addsub,r);this.updateNodeMap(s,o.children);var a=t.remove(i);if(n)for(var h=0;h<o.children.length;h++)o.children[h].invert();r.insert_range(a,o.children)}if(typeof e==="function")e(this);else return this};g.prototype.cleanupAction=new e})();gmath.actions.AddVariablesAction=function(){var e=function(t){Action.call(this,"AddVariablesAction","add variables");this.priority=1;this.triggerType="tap";this.settings={is_join_action:true,delay:300,side:"inside",margin:{x:.1}};if(t){if(t.triggerType==="drag"){this.triggerType=t.triggerType;this.nodes=t.nodes;this.target=t.target}else{this.actor=t.actor}}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(e){if(e.length>1)return[];var n=e[0];if(!n.is_group("add","sub"))return[];var r=n.parent;var s=this.analyzeAddendStructure(n);if(s.range.length<1)return[];var a=this.prepareRangeForSearch(s.range),h;if(a.length<1)return[];h=t.filterRange(u(i(a)),r);h=h.concat(t.filter(c(o(a)),r));h=h.filter(p(n));h=h.filter(f(a));return this.bindActionForEachTarget(e,h)};e.prototype.match=function(e){if(!e.ls)return false;var n=e;if(!n.is_group("add","sub"))return false;var r=this.analyzeAddendStructure(n);if(r.range.length<1)return false;var s=this.prepareRangeForSearch(r.range),a;if(s.length<1)return false;a=t.filterRange(u(i(s)),n.ls);a=a.concat(t.filter(c(o(s)),n.ls));if(a.length!==1)return false;a=a.filter(p(n));a=a.filter(f(s));if(a.length!==1)return false;return true};e.prototype.prepareRangeForSearch=function(e){if(!Array.isArray(e))return[new _(t.clone(e))];else return e};e.prototype.analyzeAddendStructure=function(t){var e=t.children[1];if(h.is_var(e)||e.is_group("brackets"))return{range:e,coefficientLocation:"none"};else if(e.is_group("product"))return this.analyzeProductStructure(e);else return{range:[]}};e.prototype.analyzeProductStructure=function(t){var e=[t.children[0].children[1],t.children[t.children.length-1].children[1]];var i;if(s.is_num(e[0])&&s.is_num(e[1]))return{range:[]};else if(!s.is_num(e[0])&&!s.is_num(e[1])){i="none"}else{i=s.is_num(e[0])?"front":"back"}var n,r;if(i==="none"){n=0;r=t.children.length}else if(i==="front"){n=1;r=t.children.length}else{n=0;r=t.children.length-1}var o=[];for(var a=n;a<r;a++){var l=t.children[a].children[1];if(h.is_var(l)||l.is_group("brackets")||l.is_group("sign")&&h.is_var(l.children[1]))o.push(l.parent);else return{range:[]}}return{range:o,coefficientLocation:i}};e.prototype.bindActionForEachTarget=function(t,e){var i=[];var n=t[0].get_root();for(var r=0;r<e.length;r++){var o={};o.triggerType="drag";o.nodes=t;var s=e[r];if(!Array.isArray(s)){o.target=s.parent}else{o.target=s[0].parent.parent;o.range=s}i.push(this.createBoundAction(n,o))}return i};e.prototype.transform=function(t){var e=this;if(this.triggerType==="drag"){this.sourceAddend=this.nodes[0];this.targetAddend=this.target}else{this.sourceAddend=this.actor;this.targetAddend=this.actor.ls}this.addTouchedNodes(this.sourceAddend);this.addTouchedNodes(this.targetAddend);var i=this.analyzeAddendStructure(this.sourceAddend),n=this.analyzeAddendStructure(this.targetAddend);i.addend=this.sourceAddend;n.addend=this.targetAddend;var r=this.getNewTreeNode(this.sourceAddend),o=this.getNewTreeNode(this.targetAddend),a=r.parent;var h=r.children[1],l=o.children[1];if(i.coefficientLocation==="none"){h=this.reinterpretTermAsProductWithCoefficientOfOne(h)}if(n.coefficientLocation==="none"){l=this.reinterpretTermAsProductWithCoefficientOfOne(l)}if(o.parent.children.indexOf(o)===0&&n.coefficientLocation==="none"&&l.children[1].children[1].is_group("sign")){this.absorbNegativeIntoAddend(o)}var d=this.splitProduct(h),u=this.splitProduct(l);var c=d.coefficient*(r.is_group("sub")?-1:1)+u.coefficient*(o.is_group("sub")?-1:1);var p=_.prototype.createGroup();p.append(new _(new s(Math.abs(c))));p.append_range(d.variables);var f=c<0?new g(p,"sub"):new g(p,"add");var v=o.remove();a.insert(v,f);r.remove();var m={parentOfSum:f.parent.parent,idxOfSum:f.parent.parent.children.indexOf(f.parent),resultingAddend:f,idxOfResultingAddend:f.parent.children.indexOf(f),resultingProduct:p};if(Math.abs(c)===1){p.children[0].simplify=true}p.simplify=true;this.mapOldStructureToNewStructure(i,m);this.mapOldStructureToNewStructure(n,m);this.cleanup_cascade(f.parent);if(typeof t==="function")t(this);return true};e.prototype.reinterpretTermAsProductWithCoefficientOfOne=function(t){if(!t.is_group("product")){var e=t.parent;t.remove();var i=_.prototype.createGroup();i.append(new _(new s(1)));i.append(new _(t));e.append(i);return i}else{t.insert(0,new _(new s(1)));return t}};e.prototype.splitProduct=function(e){var i=this.findIndexOfCoefficient(e);var n,r;if(i===0){n=s.get_value(e.children[i].children[1]);r=t.clone(e.children.slice(1))}else{n=s.get_value(e.children[i].children[1]);r=t.clone(e.children.slice(0,i))}return{coefficient:n,variables:r}};e.prototype.findIndexOfCoefficient=function(t){var e=t.children;for(var i=0;i<e.length;i++){if(s.is_num(e[i].children[1]))return i}};e.prototype.absorbNegativeIntoAddend=function(t){var e=t.children[1].children[1].children[1];var i=e.parent,n=e.remove();var r=e.children[1];r.remove();i.insert(n,r);t.invert()};e.prototype.mapOldStructureToNewStructure=function(t,e){var i=e.parentOfSum.children[e.idxOfSum],n;if(i.is_group("sum")){n=i.children[e.idxOfResultingAddend]}else{n=i}if(s.is_num(n)){this.updateNodeMap(t.addend.get_mapping_to(n))}else{this.mapAddendGroup(t.addend,n);var r=this.mapNegatives(t.addend,t.coefficientLocation,n);this.mapCoefficients(t.addend,t.coefficientLocation,n);this.mapVariables(t.range,n,r)}};e.prototype.mapAddendGroup=function(t,e){if(e.is_group("add","sub")){this.updateNodeMap(t,e);this.updateNodeMap(t.children[0],e.children[0])}};e.prototype.mapNegatives=function(t,e,i){if(!i.is_group("add","sub","sign","product")){return}var n,r;if(t.is_group("sub")){n=t.children[0]}var o;var s=e==="front"||e==="none"&&t.children[1].children[0]?t.children[1].children[0]:t.children[1].children[t.children[1].children.length-1];if(s&&s.children[1]&&s.children[1].is_group("sign")){r=s.children[1].children[0];o=e==="none"}if(n&&r||!n&&!r){return}if(i.is_group("sub")&&r){this.updateNodeMap(r,i.children[0]);return}if(i.is_group("sign")){if(n){this.updateNodeMap(n,i.children[0])}if(r){this.updateNodeMap(r,i.children[0])}return}if(i.is_group("add")){i=i.children[1]}if(i.is_group("product")&&i.children[0].children[1].is_group("sign")){var a=i.children[0].children[1].children[0];if(n){this.updateNodeMap(n,a)}if(r){this.updateNodeMap(r.parent,a.parent);this.updateNodeMap(r,a)}return o}};e.prototype.mapCoefficients=function(t,e,i){var n,r,o,a;if(e==="none"){return}if(e==="front"){n=t.children[1].children[0]}else if(e==="back"){n=t.children[1].children[t.children[1].children.length-1]}r=n.children[1];if(r.is_group("sign")){r=r.children[1]}if(i.is_group("add","sub")){i=i.children[1]}if(i.is_group("product")){if(s.is_num(i.children[0].children[1])){o=i.children[0];a=i.children[0].children[1]}else{return}if(a.is_group("sign")){a=a.children[1]}}else{return}this.updateNodeMap(n,o);this.updateNodeMap(r,a)};e.prototype.mapVariables=function(t,e,i){if(e.is_group("add","sub")){e=e.children[1]}if(e.is_group("product")){var n=s.is_num(e.children[0].children[1])?e.children.slice(1):e.children.slice();if(Array.isArray(t)){for(var r=0;r<t.length;r++){var o=r===0&&i?t[r].children[1].children[1]:t[r].children[1];var a=n[r].children[1].is_group("sign")?n[r].children[1].children[1]:n[r].children[1];this.updateNodeMap(t[r],n[r]);this.updateNodeMap(t[r].children[0],n[r].children[0]);this.updateNodeMap(o.get_mapping_to(a))}}else{var a=n[0].children[1].is_group("sign")?n[0].children[1].children[1]:n[0].children[1];this.updateNodeMap(t.get_mapping_to(a))}}else{var o=Array.isArray(t)?t[0]:t;this.updateNodeMap(o.get_mapping_to(e.is_group("sign")?e.children[1]:e))}};e.prototype.reselectNodes=function(t){if(!t.parentOfSum.children[t.idxOfSum].is_group("sum")){if(t.parentOfSum.children[t.idxOfSum].is_group("add","sub")){this.setNodesToReselectAfterAction(t.parentOfSum.children[t.idxOfSum])}else{var e=t.resultingProduct.children;if(e[0].parent===t.resultingProduct){this.setNodesToReselectAfterAction(t.resultingProduct)}else{this.setNodesToReselectAfterAction(e)}}}};function i(t){return t.map(function(t){return t.to_ascii()}).join("")}function n(t){return t.is_group()&&t.commutative&&t.associative}function r(t){if(t.length===0)return"";var e=t.map(function(t){return t.to_ascii()}).join("");if(t.length===1)return e;if(n(t[0]))return e.substring(t[0].children[0].to_ascii().length);return e}function o(t){if(t.length===0)return"";var e=t.map(function(t){return t.to_ascii()}).join("");if(n(t[0]))return e.substring(t[0].children[0].to_ascii().length);return e}function a(t){if(t.is_group("product")&&t.children[0].children[1].is_group("sign")){return t.children[0].children[1].children[1].to_ascii()+t.children.slice(1).map(function(t){return t.to_ascii()}).join("")}return""}function l(t){return t.length===t[0].parent.children.length}function d(t){return t.parent}function u(t){return function(e){if(e.length===0)return false;if(!e[0].parent)return false;if(d(e[0].parent)&&l(e))return false;return i(e)===t||r(e)===t}}function c(t){return function(e){if(!e.parent)return false;if(!e.parent.is_group("add")&&!e.parent.is_group("sub"))return false;return e.to_ascii()===t||a(e)===t}}function p(e){var i=e.parent;return function(n){var r,o;try{if(Array.isArray(n)){r=t.get_parent(3,n[0]);o=t.get_parent(2,n[0])}else{r=t.get_parent(2,n);o=t.get_parent(1,n)}if(!i.is_group("sum")||!r.is_group("sum")||i!==r||o===e)return false}catch(s){if(s==="invalid path")return false;throw s}return true}}function f(t){return function(t){if(!Array.isArray(t))return true;var e=t[0].parent;if(e.children.length!==t.length+1)return false;for(var i=0;i<e.children.length;i++){var n=e.children[i];if(t.indexOf(n)===-1&&!s.is_num(n.children[1]))return false}return true}}g.prototype.add_action_handler(new e);return new e}();r.prototype.move_actions.push(gmath.actions.AddVariablesAction);gmath.actions.AddSubTupleAction=function(){var e=function(t){Action.call(this,"AddSubTupleAction","add or subtract tuples");this.priority=1;this.triggerType="tap";this.settings={is_join_action:true,delay:300,side:"inside",margin:{x:.1}};if(t){if(t.triggerType==="drag"){this.triggerType=t.triggerType;this.nodes=t.nodes;this.target=t.target}else{this.actor=t.actor}}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){if(t.length!==1)return[];var e=t[0];if(!this.isTupleAddend(e))return[];var i=this.getOtherTupleAddendsInSum(e);return this.bindActionForEachTarget(t,i)};e.prototype.isTupleAddend=function(t,e){return t.is_group("add","sub")&&t.children[1].is_group("brackets")&&t.children[1].children[1].is_group("tuple")&&(!e||t.children[1].children[1].children.length===e)};e.prototype.getTupleAddendLen=function(t){return t.children[1].children[1].children.length};e.prototype.getOtherTupleAddendsInSum=function(t){var e=t.parent,i=t.children[1].children[1].children.length;var n=e.children.filter(function(e){return e!==t&&this.isTupleAddend(e,i)},this);return n};e.prototype.bindActionForEachTarget=function(t,e){var i=t[0].get_root();return e.map(function(e){return this.createBoundAction(i,{nodes:t,target:e,triggerType:"drag"})},this)};e.prototype.match=function(t){return this.isTupleAddend(t)&&t.ls&&this.isTupleAddend(t.ls,this.getTupleAddendLen(t))};e.prototype.transform=function(t){var e,i;if(this.triggerType==="drag"){e=this.nodes[0];i=this.target}else{e=this.actor.ls;i=this.actor}this.addTouchedNodes(e);this.addTouchedNodes(i);var n=e.get_idx()<i.get_idx(),r=this.getNewTreeNode(e),o=this.getNewTreeNode(i),s=r.parent,a=r.children[1].children[1].children.length;var h=new S;var l=new g(h);for(var d=0;d<a;d++){var u=new f;if(n){this.insertTermsFromParameter(u,e.get_child([1,1,d,1]),r.get_child([1,1,d,1]),r.value);this.insertTermsFromParameter(u,i.get_child([1,1,d,1]),o.get_child([1,1,d,1]),o.value)}else{this.insertTermsFromParameter(u,i.get_child([1,1,d,1]),o.get_child([1,1,d,1]),o.value);this.insertTermsFromParameter(u,e.get_child([1,1,d,1]),r.get_child([1,1,d,1]),r.value)}u.simplify=true;var c=new k(u);this.updateNodeMap(r.get_child([1,1,d]),c);this.updateNodeMap(o.get_child([1,1,d]),c);h.append(new k(u))}var p=o.remove();s.insert(p,l);r.remove();this.updateNodeMap(e,l);this.updateNodeMap(e.get_child([1]),l.get_child([1]));this.updateNodeMap(e.get_child([1,0]),l.get_child([1,0]));this.updateNodeMap(e.get_child([1,1]),l.get_child([1,1]));this.updateNodeMap(e.get_child([1,2]),l.get_child([1,2]));this.updateNodeMap(i,l);this.updateNodeMap(i.get_child([1]),l.get_child([1]));this.updateNodeMap(i.get_child([1,0]),l.get_child([1,0]));this.updateNodeMap(i.get_child([1,1]),l.get_child([1,1]));this.updateNodeMap(i.get_child([1,2]),l.get_child([1,2]));this.cleanup(s);if(typeof t==="function")t(this);return this};e.prototype.insertTermsFromParameter=function(e,i,n,r){var o;if(n.is_group("sum")){o=n.children.slice();t.remove_range(o);this.updateNodeMap(i,e)}else{n.remove();o=[new g(n)];this.updateNodeMap(i.get_mapping_to(o[0]))}if(r==="sub")o.forEach(function(t){t.invert()});e.append_range(o)};g.prototype.add_action_handler(new e);return new e}();r.prototype.move_actions.push(gmath.actions.AddSubTupleAction);gmath.actions.ScaleTupleAction=function(){var e=function(t){Action.call(this,"ScaleTupleAction","multiply a tuple by a number");this.priority=1;this.triggerType="tap";this.settings={delay:300,side:"inside",margin:{x:.1}};if(t){if(t.triggerType==="drag"){this.triggerType=t.triggerType;this.nodes=t.nodes;this.target=t.target}else{this.actor=t.actor}}};gmath.inherit(Action,e);e.prototype.isTupleMul=function(t){return t&&t.is_group("mul")&&t.children[1].is_group("brackets")&&t.children[1].children[1].is_group("tuple")};e.prototype.getAllAvailableActions=function(t){if(!t.every(this.isScalarMul.bind(this)))return[];var e=this,i=t[0].parent.children.filter(this.isTupleMul.bind(this)),n=t[0].get_root();return i.map(function(i){return e.createBoundAction(n,{nodes:t,target:i,triggerType:"drag"})})};e.prototype.getTupleFactorsInSum=function(t){var e=this;re;var i=sum.children.filter(function(t){return t!==n&&e.isTupleAddend(t,len)});return i};e.prototype.isScalarMul=function(t){return t&&t.is_group("mul","div")&&!t.select_first(function(t){return t.is_group("tuple")})};e.prototype.extract=function(t){if(!t)return false;if(this.isTupleMul(t)&&this.isScalarMul(t.ls))return{scalars:[t.ls],tuple:t};if(this.isTupleMul(t.ls)&&this.isScalarMul(t))return{scalars:[t],tuple:t.ls};return false};e.prototype.match=function(t){if(t.is_group("fraction")){var e=t.get_top(),i=t.get_bottom();if(e.length===1&&this.isTupleMul(e[0])&&i.every(this.isScalarMul)){return true}}else if(t.is_group("mul","div")){return!!this.extract(t)}return false};e.prototype.getTupleAndScalars=function(){var t={};if(this.triggerType==="tap"){this.addTouchedNodes(this.actor);var e=this.getNewTreeNode(this.actor);if(this.actor.is_group("fraction")){t.parent_product=e;t.tuple=e.get_child([0,1,1]);t.scalar_muldivs=e.get_bottom()}else{var i=this.extract(e);t.scalars_were_on_the_left=i.scalars[0].get_idx()<i.tuple.get_idx();t.parent_product=e.parent;t.tuple=i.tuple.get_child([1,1]);t.scalar_muldivs=i.scalars}}else{this.addTouchedNodes(this.nodes);this.addTouchedNodes(this.target);var n=this.getNewTreeNode(this.nodes),r=this.getNewTreeNode(this.target);t.scalars_were_on_the_left=n[0].get_idx()<r.get_idx();t.parent_product=n[0].parent;t.scalar_muldivs=n;t.tuple=r.get_child([1,1])}return t};e.prototype.transform=function(e){var i=this.getTupleAndScalars();var n=i.scalars_were_on_the_left,r=i.parent_product,o=i.scalar_muldivs,s=i.tuple;for(var a=0;a<s.children.length;a++){this.scale_parameter(n,s.children[a],o)}t.remove_range(o);this.cleanup(r);for(var a=0;a<s.children.length;a++){this.cleanup_nested_products(s.children[a].children[1])}if(typeof e==="function")e(this);return this};e.prototype.scale_parameter=function(e,i,n){var r=i.children[1];var o=r.is_group("fraction")?r:new v;var s=t.clone(n);this.extendNodeMap(t.get_mapping_between(this.nodes||this.getOldTreeNode(n),s));t.for_each(function(t){t.update_x_during_dragging=true;t.update_y_during_dragging=false},s);r.remove();if(o.is_group("product")){o.append(new _(r));o.insert_range(e?0:1,s)}else{if(e)s.forEach(function(t){if(t.is_group("div"))o.insert_into_denominator(0,t);else o.insert(0,t)});else s.forEach(function(t){o.append(t)})}o.simplify=true;i.append(o)};e.prototype.cleanup_nested_products=function(t){for(var e=0;e<t.children.length;e++){this.cleanup(t.children[e])}};_.prototype.add_action_handler(new e);v.prototype.add_action_handler(new e);return new e}();r.prototype.move_actions.push(gmath.actions.ScaleTupleAction);gmath.actions.AddNegativeAction=function(){var e=function(t){Action.call(this,"AddNegativeAction","rearrange signs");this.triggerType="tap";this.priority=4;if(t)this.actor=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){var e=t.children[1];if(e&&e.is_group("sign")&&t.is_group("add","sub"))return true;return false};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.actor);var n=this.actor.children[1].children[0];this.addTouchedNodes(this.actor.children[0]);this.addTouchedNodes(n);var r=i.children[1];i.invert();this.updateNodeMap(n,i.children[0]);t.replace(r,r.children[1]);if(typeof e==="function")e(this);else return true};g.prototype.add_action_handler(new e);return new e}();gmath.actions.PlusMinusProductToMinusProductAction=function(){var e=function(t){Action.call(this,"PlusMinusProductToMinusProductAction","x+-y*z=x-y*z");this.priority=0;this.triggerType="tap";if(t)this.actor=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){try{if(!t.is_group("add","sub"))return false;if(!t.children[1].is_group("product"))return false;var e=t.children[1].children[0].children[1];if(!e.is_group("sign"))return false}catch(i){return false}return true};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.actor);var n=i.children[1].children[0].children[1];var r=this.getOldTreeNode(n.children[0]);this.addTouchedNodes(this.actor.children[0]);this.addTouchedNodes(r);this.updateNodeMap(r,i.children[0]);t.replace(n,n.children[1]);i.invert();if(typeof e==="function")e(this);else return true};g.prototype.add_action_handler(new e);return new e}();gmath.actions.ConvertAddendToFractionAction=function(){var t=function(t){Action.call(this,"ConvertAddendToFractionAction","convert addend to a fraction to allow adding");this.priority=1;this.triggerType="dbltap";if(t){this.actor=t.actor}};gmath.inherit(Action,t);t.prototype.match=function(t){if(!t)return false;if(!t.is_group("add","sub"))return false;if(!t.ls)return false;var e=t.ls.children[1],i=t.children[1];return e.is_group("fraction")&&!i.is_group("fraction")||!e.is_group("fraction")&&i.is_group("fraction")};t.prototype.transform=function(t){this.addTouchedNodes(this.actor);this.addTouchedNodes(this.actor.ls);var e=this.getNewTreeNode(this.actor.ls),i=this.getNewTreeNode(this.actor);var n=(e.children[1].is_group("fraction")?e:i).children[1],r=(e.children[1].is_group("fraction")?i:e).children[1];var o=r.parent;r.remove();var a=_.prototype.createGroup();a.append(new _(r));a.append(new _(new s(1),"div"));o.append(a);a.get_bottom()[0].simplify=true;this.cleanup(a.get_top()[0]);this.followup=gmath.actions.CrossMultiplyFractionsAction.createBoundAction(this.newTree,{actor:i});if(typeof t==="function")t(this);else return true};g.prototype.add_action_handler(new t);return new t}();gmath.actions.RemoveBracketsAction=function(){var e=function(t){Action.call(this,"RemoveBracketsAction","remove optional brackets");this.priority=4;this.triggerType="tap";if(t)this.actor=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){return t.is_group("brackets")&&u.is_optional(t)};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.actor);this.addTouchedNodes(this.actor.children[0]);this.addTouchedNodes(this.actor.children[2]);var n=t.replace(i,i.children[1]);this.cleanup(n.parent);if(typeof e==="function")e(this);else return true};var i=new e;u.prototype.add_action_handler(i);return i}();gmath.actions.editLineAction=function(){var t=function(t){Action.call(this,"editLineAction","rewrite dl line");this.priority=0;if(t)this.actor=t.actor};gmath.inherit(Action,t);t.prototype.match=function(){return typeof Keyboard!=="undefined"&&Keyboard!==null};t.prototype.removeAllNodesFromNodeMap=function(){var t=this.newTree.select_all();for(var e in this.node_map){this.node_map[e]=[]}};t.prototype.transform=function(t){var e;var i=Keyboard();i.caption("What do you want to change in this line?").on("done",r).on("cancel",o)();var n=this;function r(e){var r=n.newTree;var o=r.parse(e,true);if(!o)return;r.children[0].remove();r.append(o);i.visible(false);i.on("done",null).on("cancel",null);n.removeAllNodesFromNodeMap();t(n)}function o(){console.log("cancelled");i.visible(false);i.on("done",null).on("cancel",null);t(false)}i.latex(n.newTree.to_latex()).visible(true)};return new t}();gmath.actions.DirectFactoringAction=function(){var e=function(t){Action.call(this,"DirectFactoringAction","direct factor");this.priority=0;this.triggerType="drag";this.settings={delay:300,side:"inside",margin:{x:.1}};if(t){this.nodes=t.nodes;this.target=Array.isArray(t.target)?t.target:[t.target]}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(e){var n=[];var r=e.filter(function(t){return t.is_group()});if(e.length===0||r.length===0)return n;var s=e[0].get_root();var a,h;var l;if(this.nodesAreAFractionResultingFromAPreviousFactoringAction(e)){a=e[0].children[1].get_bottom();l=true}else if(this.nodesArePartOfAProductWithinASum(e)){if(!t.is_range(e))return n;a=e}else if(this.nodesAreASingleAddend(e)){a=this.getEntireRangeFromAddend(e);if(a.length===1)a=this.temporarilyReinterpretRangeAsMulDiv(a)}else{return n}h=s.filterRange(d(i(a)));h=h.concat(s.filter(c(o(a))));h=h.filter(p(e));h=h.filter(f(e));h=h.filter(v);n=n.concat(this.bindActionsFromRanges(e,h));if(l){this.useFractionsInsteadOfDenominatorsAsTargets(n)}return n};e.prototype.nodesAreAFractionResultingFromAPreviousFactoringAction=function(t){if(!t[0].is_group("mul"))return false;var e=t[0].children[1];if(!e.is_group("fraction"))return false;var i=e.get_top();if(i.length!==1||!s.get_value(i[0].children[1])===1)return false;var n=t[0].parent;if(n.children.length!==2)return false;var r=n.children[n.children.indexOf(t[0])===0?1:0].children[1];if(!r.children[1]||!r.children[1].is_group("sum"))return false;return true};e.prototype.nodesArePartOfAProductWithinASum=function(t){var e=t[0];if(e.parent&&e.parent.is_group("fraction")&&e.parent.parent.is_group("mul"))e=e.parent.parent;var i=e;if(!i.parent)return false;var n=i.parent;if(!n.parent)return false;var r=n.parent;if(!r.parent)return false;var o=r.parent;return i.is_group("mul","div")&&n.is_group("product","fraction")&&(r.is_group("add")||r.is_group("sub"))&&o.is_group("sum")};e.prototype.bindActionsFromRanges=function(t,e){var i=t[0].get_root();var n=[];for(var r=0;r<e.length;r++){n.push(this.createBoundAction(i,{nodes:t,target:e[r]}))}return n};e.prototype.nodesAreASingleAddend=function(t){if(t.length!==1)return false;return t[0].is_group("add")||t[0].is_group("sub")};e.prototype.getEntireRangeFromAddend=function(t){var e=t[0],i=e.children[1];var n;if(i.is_group("product")){n=i.children}else{n=[i]}return n};e.prototype.useFractionsInsteadOfDenominatorsAsTargets=function(t){for(var e=0;e<t.length;e++){var i=t[e];if(i.target.length===i.target[0].parent.get_bottom().length){i.target=i.target[0].parent.parent;i.prevFracState=true}}};e.prototype.temporarilyReinterpretRangeAsMulDiv=function(e){return[new _(t.clone(e[0]))]};e.prototype.transform=function(e){var i=this;if(this.prevFracState){this.target=this.target.children[1].get_bottom().slice()}var n=Array.isArray(this.target)?this.target:[this.target],r=this.nodes;var o=this.getNewTreeNode(n),a=this.getNewTreeNode(r);if(c(a)){a=p(a)}if(c(o)){o=p(o)}var h=f(a),l=f(o);h.left_of_target=h.idxOfAddendInSum<l.idxOfAddendInSum;if(!v(h)){h=m(h)}else{h.addend.remove();h.sumOfCoefficients=h.left_of_target?h.product.children[0].children[1].children[1]:h.product.children[h.product.children.length-1].children[1].children[1]}A(l);N(l,h);l.sum.insert(h.left_of_target?l.idxOfAddendInSum-1:l.idxOfAddendInSum,h.addend);T(r,n,a);S(h);k(h);this.cleanup_cascade(l.sum);var d=L(h);M(d);if(typeof e==="function")e(this);else return true;function c(t){var e=t[0];return e.is_group("add")||e.is_group("sub")||e.parent.is_group("add")||e.parent.is_group("sub")}function p(t){var e=t[0].parent.is_group("add")||t[0].parent.is_group("sub");var n=e?t[0].parent:t[0],r=n.children[1];r.remove();var o=_.prototype.createGroup();o.append(new _(new s(1)));o.append(new _(r));n.append(o);i.cleanup(o);i.cleanup(o.children[1]);i.updateNodeMap(i.getOldTreeNode(n),o.children.slice(1));return o.children.slice(1)}function f(t){var e={};e.range=t;var i=t[0];if(i.parent.is_group("product")){e.product=i.parent;e.addend=e.product.parent}else if(i.parent.is_group("fraction")){e.fraction=i.parent;if(e.fraction.parent.is_group("mul")){e.product=e.fraction.parent.parent;e.addend=e.product.parent}else{e.addend=e.fraction.parent}}else{throw"Can't identify structure for direct factoring."}e.sum=e.addend.parent;e.idxOfAddendInSum=e.sum.children.indexOf(e.addend);return e}function v(t){if(t.fraction)return false;if(t.addend.is_group("sub"))return false;if(!t.product.children[0].children[1].is_group("brackets")&&t.left_of_target||!t.product.children[t.product.children.length-1].children[1].is_group("brackets")&&!t.left_of_target)return false;if(t.product.children.length-1!==t.range.length)return false;return true}function m(t){y(t);var e=w(t);return e}function y(t){var e=t.range;for(var i=0;i<e.length;i++){e[i].remove()}}function w(t){var e=_.prototype.createGroup();b(e,t.range);x(t);var i=g.prototype.createGroup();t.addend.remove();t.addend.dragging=false;t.addend.selected=false;i.append(t.addend);var n=new u(i);var r=_.prototype.createGroup();if(t.left_of_target){r.append(new _(n));r.append(new _(e))}else{r.append(new _(e));r.append(new _(n))}var o=new g(r);var s={};s.addend=o;s.product=r;s.sumOfCoefficients=i;s.left_of_target=t.left_of_target;return s}function b(t,e){for(var i=0;i<e.length;i++){
t.append(e[i])}return t}function x(t){var e,n;if(t.fraction){e=t.fraction.parent;i.cleanup(t.fraction);if(e.is_group("mul")&&s.get_value(e.children[1])===1){e.remove();n=true}}if(t.product){if(e&&!n)i.cleanup(e);i.cleanup(t.product)}}function A(t){t.addend.remove();y(t)}function N(t,e){if(e.left_of_target)e.sumOfCoefficients.append(t.addend);else e.sumOfCoefficients.insert(0,t.addend)}function T(t,e,n){if(e[0].is_group("div")){for(var r=0;r<t.length;r++){i.updateNodeMap(t[r].get_mapping_to(n[r]))}if(n[0].is_group("div")){for(var r=0;r<e.length;r++){i.updateNodeMap(e[r].get_mapping_to(n[r]))}}else{var o=n[0].children[1].get_bottom();for(var r=0;r<e.length;r++){i.updateNodeMap(e[r].get_mapping_to(o[r]))}}}else if(t[0].is_group("mul","add","sub")&&!e[0].is_group("mul","add","sub")){for(var r=0;r<t.length;r++){i.updateNodeMap(t[r].children[1].get_mapping_to(n[r].children[1]))}if(!e[0].is_group("product")){i.updateNodeMap(e[0].get_mapping_to(n[0].children[1]))}else{for(var r=0;r<e[0].children.length;r++){i.updateNodeMap(e[0].children[r].get_mapping_to(n[r]))}}}else{for(var r=0;r<t.length;r++){i.updateNodeMap(t[r].get_mapping_to(n[r]));i.updateNodeMap(e[r].get_mapping_to(n[r]))}}}function S(t){var e=t.sumOfCoefficients;for(var n=0;n<e.children.length;n++){var r=e.children[n].children[1];i.cleanup(r)}for(var n=0;n<e.children.length;n++){var r=e.children[n];u.handle(r,true);i.cleanup(r)}for(var n=0;n<e.children.length;n++){var r=e.children[n].children[1];if(r.is_group("brackets")&&r.children[1].is_group("sum")){r.replace_with(r.children[1])}i.cleanup(e.children[n])}}function k(t){var e=t.product;for(var n=0;n<e.children.length;n++){i.cleanup(e.children[n].children[1])}for(var n=0;n<e.children.length;n++){i.cleanup(e.children[n])}}function L(t){var e;var n=t.product.children.indexOf(t.sumOfCoefficients.parent.parent);if(n===0){e=t.product.children.slice(1)}else{e=t.product.children.slice(0,t.product.children.length-1)}i.setNodesToReselectAfterAction(e);return e}function M(e){t.for_each(function(t){t.update_y_during_dragging=true},e[0])}};function i(t){if(t.length===1&&t[0].hidden)return"";return t.map(function(t){return t.to_ascii()}).join("")}function n(t){return t.is_group()&&t.commutative&&t.associative}function r(t){if(t.length===0)return"";if(t.length===1&&t[0].hidden)return"";var e=t.map(function(t){return t.to_ascii()}).join("");if(t.length===1)return e;if(n(t[0]))return e.substring(t[0].children[0].to_ascii().length);return e}function o(t){if(t.length===0)return"";if(t.length===1&&t[0].hidden)return"";var e=t.map(function(t){return t.to_ascii()}).join("");if(n(t[0]))return e.substring(t[0].children[0].to_ascii().length);return e}function h(t){return t.length===t[0].parent.children.length}function l(t){return t.parent}function d(t){return function(e){if(e.length===0)return false;if(!e[0].parent)return false;if(l(e[0].parent)&&h(e))return false;return i(e)===t||r(e)===t}}function c(t){return function(e){if(!e.parent)return false;if(!e.parent.is_group("add")&&!e.parent.is_group("sub"))return false;return e.to_ascii()===t}}function p(t){return function(e){if(t[0].is_group("add")||t[0].is_group("sub"))return t[0].children[1]!==e;for(var i=0;i<e.length;i++){for(var n=0;n<t.length;n++){if(e[i]===t[n])return false}}return true}}function f(e){return function(i){try{var n,r;if(e[0].is_group("mul")||e[0].is_group("div")){var o=e[0];if(o.parent.is_group("fraction")&&o.parent.parent.is_group("mul"))o=o.parent.parent;n=t.get_parent(1,o);r=t.get_parent(2,n)}else if(e[0].is_group("add")||e[0].is_group("sub")){n=null;r=t.get_parent(1,e[0])}else{return false}var s,a;var h=Array.isArray(i)?i[0]:i;if(h.is_group("mul")||h.is_group("div")){if(h.parent.is_group("fraction")&&h.parent.parent.is_group("mul"))h=h.parent.parent;s=t.get_parent(1,h);a=t.get_parent(2,s)}else{s=null;a=t.get_parent(2,h)}if(n&&s&&n===s){return false}if(r!==a){return false}}catch(l){if(l==="invalid path")return false;throw l}return true}}function v(t){if(Array.isArray(t))return!t.every(function(t){return t instanceof a});else return!(t instanceof a)}return new e}();r.prototype.move_actions.push(gmath.actions.DirectFactoringAction);gmath.actions.CommuteAction=function(){var e=function(t){Action.call(this,"CommuteAction","commute terms");this.priority=1;this.triggerType="drag";this.settings={margin:{y:-1}};if(t){this.nodes=t.nodes;this.target=t.target;this.settings.side=t.side}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(e){if(e.length===0)return[];var i=e[0].get_root();var n=[];var r=e[0].parent.is_group("flat"),o;if(r)return[];if(!e[0].commutative||!t.is_range(e))return[];for(o=e[0].ls;o&&o.value!=="//";o=o.ls){if(this.match(e,o,"left-of"))n.push(this.createBoundAction(i,{nodes:e,target:o,side:"left-of"}))}for(o=e[e.length-1].rs;o&&o.value!=="//";o=o.rs){if(this.match(e,o,"right-of"))n.push(this.createBoundAction(i,{nodes:e,target:o,side:"right-of"}))}return n};e.prototype.match=function(t,e,i){if(e.parent!==t[0].parent)return false;if(!t[0].commutative)return false;if(i==="left-of"&&e.ls===t[t.length-1])return false;if(i==="right-of"&&e.rs===t[0])return false;return true};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.nodes);var n=this.getNewTreeNode(this.target);var r=this.settings.side;var o=n.parent,s=o.children.indexOf(n);if(i.length===1){i[0].remove();o.insert(s,i[0])}else{if(r==="right-of")s++;var a=t.remove_range(i);o.insert_range(a<s?s-i.length:s,i)}if(typeof e==="function")e(this);else return true};return new e}();r.prototype.move_actions.push(gmath.actions.CommuteAction);gmath.actions.EqInvertAction=function(){var e=function(t){Action.call(this,"EqInvertAction","invert terms across equation");this.priority=0;this.triggerType="drag";this.settings={};if(t){this.nodes=t.nodes;this.target=t.target;this.settings.side=this.nodes[0].is_group("mul")?"around":t.side}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(e){var i=this;var n=[];if(o())return n;var r={};a();h();return n;function o(){return e.length===0||!s()||!t.is_range(e)}function s(){var t=e[0];var i=t.get_root();var n=t.get_path();if(n[1]!==0&&n[1]!==2)return false;if(gmath.options.actions.second_child_eq_inversion&&!r())return false;else if(!gmath.options.actions.second_child_eq_inversion&&!o())return false;return i.children[0].is_group("equals");function r(){if(t.is_group("add","sub")){return t.parent.parent&&t.parent.parent.is_group("equals")}else if(t.is_group("mul","div")){var e=t.parent;if(e.is_group("product")){return e.parent&&e.parent.is_group("equals")||e.parent&&e.parent.is_group("add","sub")&&e.parent.parent.parent.is_group("equals")}else if(e.is_group("fraction")){if(e.parent.is_group("sign")){e=e.parent}return e.parent.is_group("equals")||e.parent&&e.parent.is_group("add","sub")||e.parent&&e.parent.is_group("mul")&&e.parent.parent.is_group("product")&&e.parent.parent.parent.is_group("equals")||e.parent&&e.parent.is_group("mul")&&e.parent.parent.parent&&e.parent.parent.parent.is_group("add","sub")}}else{return t.parent.is_group("equals")}}function o(){if(t.is_group("add","sub")){return t.parent.parent&&t.parent.parent.is_group("equals")}else if(t.is_group("mul","div")){var e=t.parent;if(e.is_group("product")){return e.parent&&e.parent.is_group("equals")}else if(e.is_group("fraction")){if(e.parent.is_group("sign"))e=e.parent;if(e.parent.is_group("mul")&&e.parent.parent.is_group("product"))e=e.parent.parent;return e.parent.is_group("equals")}}else{return t.parent.is_group("equals")}}}function a(){r.tree=e[0].get_root();r.targetSide=r.tree.children[0].getOppositeSideOfNode(e[0])}function h(){n.push(i.createBoundAction(r.tree,{nodes:e,target:r.targetSide,side:"inside"}))}};e.prototype.transform=function(t){var e=this;var i=this.getNewTreeNode(this.nodes);var n=this.analyzeStructureOfEquation(i);this.invertModifiers(n.modifiers);this.modifyAnyOtherTermsOnOriginSide(n.modifiers,n.originChanges);this.removeModifiersFromOriginSide(n.modifiers);this.modifyTargetSide(n.oldModifiers,n.modifiers,n.otherSideOfEquation,n.oldOtherSideOfEquation);if(typeof t==="function")t(this);return this};e.prototype.analyzeStructureOfEquation=function(t){var e=this;var i={};var n=t[0].get_root().children[0];var r=t[0].get_path(),o=r[1]?0:2;i.modifiers=t;i.oldModifiers=t.map(e.getOldTreeNode.bind(e));i.originChanges=this.getOtherTermsFromSide(n.children[r[1]],t,r);i.otherSideOfEquation=n.children[o];i.oldOtherSideOfEquation=this.getOldTreeNode(i.otherSideOfEquation);return i};e.prototype.getOtherTermsFromSide=function(t,e,i){if(t===e[0]||e[0].is_group("div")&&e[0].parent===t){return[]}else{return t.children.slice().filter(function(t){var e=t.get_path();return e[2]!==i[2]})}};e.prototype.invertModifiers=function(t){var e=[];for(var i=0;i<t.length;i++){var n=t[i];if(n.is_group("mul")&&n.children[1].is_group("fraction")){this.convertToReciprocal(n.children[1])}else{if(n.invert&&!n.is_group("product","fraction")&&!this.isIdentityMul(n))n.invert()}e.push(n)}return e};e.prototype.isIdentityMul=function(t){return t.is_group("mul")&&(s.get_value(t.children[1])===1||s.get_value(t.children[1])===-1)};e.prototype.convertToReciprocal=function(e){var i=e.parent,n=e.remove();var r;if(e.is_group("product")){var o=e.children.slice();t.remove_range(e.children);o.forEach(function(t){t.invert()});var a=_.prototype.createGroup();o.forEach(function(t){a.append(t)});r=a}else{var h=e.get_top(),l=e.get_bottom();if(h.length===1&&s.get_value(h[0].children[1])===1){var d=_.prototype.createGroup();t.remove_range(l);l.forEach(function(t){t.invert()});d.append_range(l);r=d}else{t.remove_range(h);t.remove_range(l);h.forEach(function(t){t.invert()});l.forEach(function(t){t.invert()});l.forEach(function(t){e.append(t)});h.forEach(function(t){e.append(t)});r=e}}i.insert(n,r);this.cleanup(r)};e.prototype.modifyAnyOtherTermsOnOriginSide=function(t,e){if(e.length===0)return;var i=e[0].parent;if(t[0].is_group("mul","div")&&i.is_group("sum")){for(var n=0;n<e.length;n++){var r=e[n].children[1];var o=this.removeRedundantTerms(r,t);r=e[n].children[1];this.insertModifiersIntoTerm(r,o)}}};e.prototype.removeRedundantTerms=function(e,i){var n=i.slice();if(e.is_group("product","fraction")){for(var r=0;r<e.children.length;){var o=e.children[r];for(var s=0;s<n.length;){if(this.invertModifiers([t.clone(n[s])])[0].to_ascii()===o.to_ascii()){this.extendNodeMap(this.getOldTreeNode(o).get_mapping_to(n[s]));o.remove();n.splice(s,1);break}else{r++;s++}}if(n.length===0)break}this.cleanup(e)}return n};e.prototype.insertModifiersIntoTerm=function(t,e){if(this.termIsAProductContainingAFraction(t)&&e[0].is_group("div")){this.insertModifierDivsAsNewFractionIntoProduct(t,e)}else if(t.is_group("product","fraction")){this.insertModifiersIntoProductFraction(t,e)}else{this.replaceTermWithProductContainingModifiedTerm(t,e)}};e.prototype.termIsAProductContainingAFraction=function(t){if(!t.is_group("product"))return false;return t.children.some(function(t){return t.children[1].is_group("fraction")})};e.prototype.insertModifierDivsAsNewFractionIntoProduct=function(e,i){var n=this;var r=_.prototype.createGroup();r.append(new _(new s(1)));i.forEach(function(e){var i=t.clone(e);i.dragging=false;i.selected=false;n.extendNodeMap(n.getOldTreeNode(e).get_mapping_to(i));r.append(i)});e.append(new _(r))};e.prototype.insertModifiersIntoProductFraction=function(e,i){var n=this;i.forEach(function(i){var r=t.clone(i);r.dragging=false;r.selected=false;n.extendNodeMap(n.getOldTreeNode(i).get_mapping_to(r));e.append(r)})};e.prototype.replaceTermWithProductContainingModifiedTerm=function(e,i){var n=this;var r=_.prototype.createGroup(),o=e.parent,s=e.remove();r.append(new _(e));i.forEach(function(e){var i=t.clone(e);i.dragging=false;i.selected=false;n.extendNodeMap(n.getOldTreeNode(e).get_mapping_to(i));r.append(i)});o.insert(s,r)};e.prototype.removeModifiersFromOriginSide=function(e){var i=e[0].get_root().get_child(e[0].get_path().slice(0,2));if(this.modifierIsTheOnlyTermOnOriginSide(e,i)){this.removeModifierAndReplaceWithZero(e)}else if(e[0].is_group("div")||e[0].is_group("mul")&&e[0].parent.is_group("fraction")){var n=e[0].parent,r=n.parent;t.remove_range(e);var o=n.get_top(),s=this.cleanup(n);if(s&&o.length===1)r.simplify=true;this.cleanup(r)}else{var r=e[0].parent;t.remove_range(e);this.cleanup(r)}};e.prototype.modifierIsTheOnlyTermOnOriginSide=function(t,e){return t[0]===e};e.prototype.removeModifierAndReplaceWithZero=function(t){var e=t[0].parent,i=t[0].remove();e.insert(i,new s(0))};e.prototype.modifyTargetSide=function(t,e,i,n){if(e.length===1&&!e[0].is_group("mul","div")&&!e[0].is_group("add","sub")){if(e[0].is_group("sign")){var r=e[0].children[1];r.remove();e[0]=new g(r);this.updateNodeMap(t[0],e[0]);this.updateNodeMap(t[0].children[0],e[0].children[0])}else if(e[0].is_group("sum")){var r=e[0];r.children.forEach(function(t){t.invert()});e[0]=new g(r)}else{var r=e[0];e[0]=new g(r,"sub")}}var o=i.parent,s=i.remove();var a;if(!i.is_group("product","fraction")&&e[0].is_group("mul","div")){var h=_.prototype.createGroup();var l=new _(i);h.append(l);for(var d=0;d<e.length;d++){h.append(e[d])}o.insert(s,h);this.cleanup(h.children[0]);h.children[0].simplify=true}else if(!i.is_group("sum")&&e[0].is_group("add","sub","sum")){var u=g.prototype.createGroup();var c;if(i.is_group("sign")){c=new g(i);this.extendNodeMap(n,c);this.extendNodeMap(n.children[0],c.children[0])}else{c=new g(i)}u.append(c);for(var d=0;d<e.length;d++){u.append(e[d])}o.insert(s,u);this.cleanup(u.children[0]);if(e[0].children[1].is_group("sum")){var p=e[0].children[1].children.slice();this.cleanup(e[0]);e=p}u.children[0].simplify=true}else{var f=i;for(var d=0;d<e.length;d++){f.append(e[d])}o.insert(s,f);if(e.length===1&&e[0].children[1].is_group("sum")){e=e[0].children[1].children.slice();this.cleanup(f.children[f.children.length-1])}}this.setNodesToReselectAfterAction(e)};return new e}();r.prototype.move_actions.push(gmath.actions.EqInvertAction);gmath.actions.EqInvertAndCommuteTermAction=function(){var t=function(t){Action.call(this,"EqInvertAndCommuteTermAction","composed action of inverting terms across an equation and commuting");this.priority=0;this.triggerType="drag";this.settings={margin:{y:-1}};if(t){this.nodes=t.nodes;this.target=t.target;this.settings.side=t.side}};gmath.inherit(Action,t);t.prototype.getAllAvailableActions=function(t){var e=t[0].get_root();var i=this.getAndPerformAvailableInversionActionOnClone(e,t);if(!i){return[]}var n=this.getAvailableCommuteActionsOnInversionResult(i);if(n.length===0){return[]}var r=this.unmapToGetTargets(e,i,n);return this.adjustTargets(this.bindActionForEachTarget(t,r))};t.prototype.getAndPerformAvailableInversionActionOnClone=function(t,e){var i=t.clone(),n=[];e.forEach(function(t){n.push(i.get_child(t.get_path()))});var r=gmath.actions.EqInvertAction.getAllAvailableActions(n);if(r.length===0){return false}var o=r[0];i.performAction(o,null,false);if(o.newTree===o.oldTree){return false}return o};t.prototype.getAvailableCommuteActionsOnInversionResult=function(t){var e=[];var i=t.nodes;if(i.length===1&&i[0].is_group("sum")){i=i[0].children.slice()}for(var n=0;n<i.length;n++){var r=i[n];var o=this.getTheNodesOnTheSameSideAsTheTarget(t.mapNodes(r),t.target);e.push(this.getCommutativeTermFromNode(o)[0])}return gmath.actions.CommuteAction.getAllAvailableActions(e)};t.prototype.getTheNodesOnTheSameSideAsTheTarget=function(t,e){var i=[];var n=e.get_path()[1];t.forEach(function(t){if(t.get_path()[1]===n)i.push(t)});return i};t.prototype.unmapToGetTargets=function(t,e,i){var n=[];i.forEach(function(t){n.push(t.target)});var r=this;var o=[];n.forEach(function(t){o.push(r.getCommuteTargetBeforeInversion(t,e))});var s=[];o.forEach(function(e){s.push(t.get_child(e.get_path()))});return s};t.prototype.getCommuteTargetBeforeInversion=function(t,e){var i=e.unmapNodes(t);if(i.length===1){return i[0]}else{if(t.is_group("mul")&&t.children[1].is_group("brackets")&&t.children[1].children[1].is_group("sum")){var n=t.children[1];i=e.unmapNodes(n);if(i.length!==0){return i[0]}else{var r=n.children[1];i=e.unmapNodes(r);return i[0]}}else if(t.is_group("add","sub","mul")){var o=t.children[1];return e.unmapNodes(o)[0]}}};t.prototype.getCommutativeTermFromNode=function(t){if(t.length!==1)throw"What's happening here?";if(t[0].parent.commutative){return[t[0].parent]}else if(t[0].is_group("sum")&&t[0].parent.is_group("brackets")&&t[0].parent.parent&&t[0].parent.parent.commutative){return[t[0].parent.parent]}else{return t}};t.prototype.bindActionForEachTarget=function(t,e){var i=[];for(var n=0;n<e.length;n++){var r=e[n];if(!r.ls||!r.commutative){i.push(this.createBoundAction(t[0].get_root(),{nodes:t,target:r,side:"left-of"}))}i.push(this.createBoundAction(t[0].get_root(),{nodes:t,target:r,side:"right-of"}))}return i};t.prototype.adjustTargets=function(t){for(var e=0;e<t.length;e++){var i=t[e];if((!i.target.ls&&i.side==="left-of"||(!i.target.rs||i.target.rs instanceof a)&&i.side==="right-of")&&i.target.parent.is_group("fraction")){i.target=i.target.parent}}return t};t.prototype.doInPlace=function(t){this.initNodeMap();var e=this.settings.side;if(this.target.is_group("fraction")&&this.nodes[0].is_group("div")){var i=this.target.get_top();this.target=e==="left-of"?i[0]:i[i.length-1]}var n=this;this.nodes.forEach(function(t){n.addTouchedNodes(t)});var r=this.getNewTreeNode(this.nodes),o=this.getNewTreeNode(this.target);var s=gmath.actions.EqInvertAction.getAllAvailableActions(r)[0];s.doInPlace();this.compose(s);var a=this.getTheNodesOnTheSameSideAsTheTarget(s.mapNodes(r.length===1&&r[0].is_group("sum")?r[0].children.slice():r),s.mapNodes(o)[0]),o=s.mapNodes(o);if(a.length===1){a=this.getCommutativeTermFromNode(a)}o=this.getCommutativeTermFromNode(o)[0];var h=gmath.actions.CommuteAction.getAllAvailableActions(a);var l;if(!(e==="right-of"&&!this.target.rs)){for(var d=0;d<h.length;d++){var u=h[d];if(e==="right-of"&&u.settings.side==="left-of"&&o.rs===u.target){l=u;u.doInPlace();this.compose(u);break}else if(e==="left-of"&&o===u.target){l=u;u.doInPlace();this.compose(u);break}}}this.setNodesToReselectAfterAction(l?this.getTheNodesOnTheSameSideAsTheTarget(l.mapNodes(a),o):this.getTheNodesOnTheSameSideAsTheTarget(a,o));this.removeDeletedNodesFromNodeMap();if(typeof t==="function")t(this);else return true};return new t}();r.prototype.move_actions.push(gmath.actions.EqInvertAndCommuteTermAction);gmath.actions.EqInvertPowerAction=function(){var e=function(t){Action.call(this,"EqInvertPowerAction","invert power across equation");this.triggerType="drag";this.settings={side:"around"};if(t){this.nodes=t.nodes;this.target=t.target}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){if(!this.nodesAreASingleExponent(t)&&!this.nodesAreARangeOfMulsInAnExponent(t))return[];if(!this.expressionIsAnEquation(t))return[];if(!this.powerIsTheTopLevelGroupOnThisSideOfTheEquation(t))return[];return[this.createBoundAction(t[0].get_root(),{nodes:t,target:this.getOtherSideOfEquation(t)})]};e.prototype.nodesAreASingleExponent=function(t){return t.length===1&&t[0].is_group("exponent")};e.prototype.nodesAreARangeOfMulsInAnExponent=function(e){try{return t.is_range(e)&&e.every(function(e){return e.is_group("mul")&&t.get_parent(2,e).is_group("exponent")})}catch(i){if(i!=="invalid path")throw i;return false}};e.prototype.expressionIsAnEquation=function(t){var e=t[0].get_root();return e.children[0].is_group("equals")};e.prototype.powerIsTheTopLevelGroupOnThisSideOfTheEquation=function(t){var e=t[0].get_root().children[0],i=t[0];while(!i.is_group("power"))i=i.parent;return e.children[0]===i||e.children[2]===i};e.prototype.getOtherSideOfEquation=function(t){var e=t[0].get_root().children[0];var i=t[0].get_path();return i[1]===0?e.children[2]:e.children[0]};e.prototype.transform=function(t){this.addTouchedNodes(this.nodes[0].get_root());var e=this.getNewTreeNode(this.nodes),i=this.getOtherSideOfEquation(e);this.extractRangeFromExponent(e);var n=this.convertNodesToReciprocalAndPrepareExponent(e);this.wrapTermInPower(i,n);n.update_y_during_dragging=true;this.setNodesToReselectAfterAction(n);if(typeof t==="function")t(this);else return true};e.prototype.extractRangeFromExponent=function(e){if(e[0].is_group("exponent")){var i=e[0].parent.parent,n=e[0].parent,r=n.children[0],o=e[0];var s=n.remove();r.remove();o.remove();i.insert(s,r);return r}else{var n=e[0].get_parent(4),o=n.children[1],a=o.children[0],h=a.children[1];t.remove_range(e);this.cleanup(h);u.handle(a,true);return n}};e.prototype.convertNodesToReciprocalAndPrepareExponent=function(t){var e;if(t[0].is_group("exponent")){this.invertContentsOfExponent(t[0]);e=t[0]}else{e=this.invertMulsAndPutInProductFractionExponentStructure(t)}return e};e.prototype.invertContentsOfExponent=function(t){var e=t.children[0];if(e.is_group("brackets")&&e.children[1].is_group("product","fraction")){this.convertToReciprocal(e.children[1]);u.handle(e,true)}else{var i=_.prototype.createGroup();e.remove();i.append(new _(new s(1)));i.append(new _(e,"div"));t.append(i);u.handle(i)}};e.prototype.convertToReciprocal=function(e){var i=e.parent,n=e.remove();var r;if(e.is_group("product")){var o=e.children.slice();t.remove_range(e.children);o.forEach(function(t){t.invert()});var a=_.prototype.createGroup();o.forEach(function(t){a.append(t)});r=a}else{var h=e.get_top(),l=e.get_bottom();if(h.length===1&&s.get_value(h[0].children[1])===1){var d=_.prototype.createGroup();t.remove_range(l);l.forEach(function(t){t.invert()});d.append_range(l);r=d}else{t.remove_range(h);t.remove_range(l);h.forEach(function(t){t.invert()});l.forEach(function(t){t.invert()});l.forEach(function(t){e.append(t)});h.forEach(function(t){e.append(t)});r=e}}i.insert(n,r)};e.prototype.invertMulsAndPutInProductFractionExponentStructure=function(t){var e=_.prototype.createGroup();t.forEach(function(t){t.invert()});t.forEach(function(t){e.append(t)});return new y(e)};e.prototype.wrapTermInPower=function(t,e){var i=t.parent,n=t.remove(),r=t;var o=new m(r,e);i.insert(n,o);u.handle(o);if(e.children[0].is_group("brackets")){this.cleanup(e.children[0].children[1]);u.handle(e.children[0],true)}return e};return new e}();r.prototype.move_actions.push(gmath.actions.EqInvertPowerAction);r.prototype.hideNodesAction=function(){var t=function(t){Action.call(this,"HideNodesAction","apply hide rules")};gmath.inherit(Action,t);t.prototype.doInPlace=function(e,i){var n=false;if(e.children.length>0){e.children[0].for_each(function(i){var r=i.hidden,o=i.hide_afer_drop;i.hidden=false;i.hide_after_drop=false;if(e.options.hide_leading_op&&i instanceof a&&i.parent&&i.parent.commutative){if(i.parent.associative&&!i.parent.ls||i.parent.value=="div"&&i.parent.ls&&i.parent.ls.value=="//"){if(i.parent.dragging)i.hide_after_drop=true;else i.hidden=true}}if(i instanceof a&&v.is_lone_fraction_part(i.parent)){i.hidden=true}if((i.value==="("||i.value===")")&&!t.bracketsAreEssentialElementsToExpressionType(i.parent)){var s=i.parent;if(s.parent.vertical_notation||s.parent.parent&&s.parent.parent.vertical_notation){var h=s;while(h.is_group("brackets"))h=h.children[1];if(!u.is_optional(h,s.parent)&&t.isLoneMulDivInNumeratorOrDenominator(s.parent)){if(i.parent.dragging)i.hide_after_drop=true;else i.hidden=true}}}for(var l=0;l<e.hide_rules.length&&!i.hidden;l++){var d=e.hide_rules[l];if(!d.disabled)d.apply(i)}n=n||i.hidden!=r||i.hide_after_drop!=o})}if(typeof i==="function")i(this);else return n};t.isLoneMulDivInNumeratorOrDenominator=function(t){return!(t.ls&&t.ls.is_group(t.value)||t.rs&&t.rs.is_group(t.value))};t.bracketsAreEssentialElementsToExpressionType=function(t){return t.is_group("brackets")&&t.children[1].is_group("tuple")};return new t}();gmath.actions.SwitchAction=function(){var e=function(t){Action.call(this,"SwitchAction","switch terms in a flat representation");this.priority=0;this.triggerType="drag";this.settings={side:"around"};if(t){this.node=t.node;this.target=t.target}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(e){if(e.length===0)return[];var i=e[0].get_root();var n=[];var r=e[0].parent.is_group("flat"),o;if(!r)return[];if(!e[0].commutative||!t.is_range(e))return[];for(o=e[0].ls;o&&o.value!=="//";o=o.ls){if(this.match(e[0],o))n.push(this.createBoundAction(i,{node:e[0],target:o}))}for(o=e[e.length-1].rs;o&&o.value!=="//";o=o.rs){if(this.match(e[0],o))n.push(this.createBoundAction(i,{node:e[0],target:o}))}};e.prototype.match=function(t,e){return t.parent===e.parent&&t!==e&&!(e instanceof a)&&!(t instanceof a)};e.prototype.transform=function(e){var i=tree===this.target.get_root();var n=i?this.node:tree.get_child(this.node.get_path());var r=i?this.target:tree.get_child(this.target.get_path());t.switch_siblings(n,r);if(typeof e==="function")e(this);else return true};return new e}();r.prototype.move_actions.push(gmath.actions.SwitchAction);gmath.actions.flipEquationAction=function(){var t=function(t){Action.call(this,"flipEquationAction","flip equation");this.priority=1;this.triggerType="tap";if(t)this.actor=t.actor};gmath.inherit(Action,t);t.prototype.match=function(t){return t.is_group("equals")};t.prototype.transform=function(t){var n=this.getNewTreeNode(this.actor);this.addTouchedNodes(e(this.actor));this.addTouchedNodes(i(this.actor));var r=e(n),o=i(n);r.remove();o.remove();var s=0,a=2;n.insert(s,o);n.insert(a,r);if(typeof t==="function")t(this);return this};T.prototype.add_action_handler(new t);var e=function(t){return t.children[0]};var i=function(t){return t.children[2]};return new t}();gmath.actions.RewriteNumberWithKeyboardAction=function(){var t=function(t){Action.call(this,"RewriteNumberWithKeyboardAction","split a number");this.priority=0;this.triggerType="hold";this.settings={asynchronous:true};if(t)this.actor=t.actor};gmath.inherit(Action,t);t.prototype.match=function(t){if(!gmath.ui||!gmath.ui.Keyboard)return false;if(!s.is_num(t)&&!(t.is_group("sign")&&s.is_num(t.children[1])))return false;return true};t.prototype.transform=function(e){var i=gmath.ui.Keyboard();i.caption("Enter an expression to replace the selected number.").latex(this.actor.to_latex()).on("done.rewrite-number",o).on("cancel.rewrite-number",a).visible(true);var n=this;function o(o){var a=n.newTree;var h;try{h=a.parse(o,true)}catch(l){console.log(l);i.warning("Could not parse expression.");return}var d=new r(o);var u=n.getNewTreeNode(n.actor);if(t.evalExpression(d.children[0])!==s.get_value(u)){i.warning("This does not match the number you are replacing!");return}n.replaceNumWithExpression(u,h);n.updateNodeMap(n.actor.get_mapping_to(h));n.endKeyboardInteraction(i);if(typeof e==="function")e(n);else return true}function a(){n.endKeyboardInteraction(i);e(false)}};t.evalExpression=function(e){if(!e)return NaN;if(s.is_num(e))return s.get_value(e);var i=t.evalExpression;if(e.is_group("mul","add","brackets"))return i(e.children[1]);if(e.is_group("sign","sub"))return-i(e.children[1]);if(e.is_group("div"))return 1/i(e.children[1]);if(e.is_group("exponent"))return i(e.children[0]);if(e.value==="//")return 1;var n=function(t,e){return t+e},r=function(t,e){return t*e};if(e.is_group("product","fraction"))return e.children.map(i).reduce(r,1);if(e.is_group("sum"))return e.children.map(i).reduce(n,0);if(e.is_group("power"))return Math.pow(i(e.children[0]),i(e.children[1]));return NaN};t.prototype.replaceNumWithExpression=function(t,e){var i=t.parent,n=t.remove();i.insert(n,e);u.handle(e);this.cleanup_cascade(i)};t.prototype.endKeyboardInteraction=function(t){t.visible(false);t.on("done.rewrite-number",null).on("cancel.rewrite-number",null);return false};return new t}();gmath.actions.EquationFountain=function(){var e=function(t){Action.call(this,"EquationFountain","rewrite equation");this.priority=1;this.triggerType="hold";this.settings={asynchronous:true};if(t)this.actor=t.actor||t.target};gmath.inherit(Action,e);e.prototype.match=function(t){return t.is_group("equals")&&gmath.ui&&gmath.ui.Keyboard};e.prototype.getAllAvailableActions=function(e){if(e.length===0)return[];var i=e[0].get_root(),n=this;return t.filter(this.match,e).map(function(t){return n.createBoundAction(i,{target:t})})};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.actor);var n=this;var o=gmath.ui.Keyboard();o.caption("Enter an operation to apply to both sides of the equation.").latex("E").on("done.eq-fountain",s).on("cancel.eq-fountain",a).visible(true);function s(s){var a;try{a=new r(s).children[0]}catch(h){console.log(h);o.warning("Could not parse expression.");return}var l=i.children[0],d=i.children[2];var c=r.getNodes("E",0,a);if(!c){o.warning('There needs to be an "E" in the expression.');return}var p=a.clone();var f=r.getNodes("E",0,p);t.replace(l,a);l.parent=null;t.replace(c,l);u.handle(l);n.cleanup(l.parent);t.replace(d,p);d.parent=null;t.replace(f,d);u.handle(d);n.cleanup(d.parent);o.visible(false);o.on("done.eq-fountain",null).on("cancel.eq-fountain",null);e(n)}function a(){console.log("cancelled");o.visible(false);o.on("done.eq-fountain",null).on("cancel.eq-fountain",null);e(false)}};T.prototype.add_action_handler(new e);return new e}();gmath.actions.FractionExtendAction=function(){var e=function(t){Action.call(this,"FractionExtendAction","extend fraction");this.priority=0;this.triggerType="hold";this.settings={asynchronous:true};if(t)this.actor=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){return t.is_group("fraction")};e.prototype.getAllAvailableActions=function(e){if(e.length===0)return[];var i=e[0].get_root(),n=this;return t.filter(this.match,e).map(function(t){return n.createBoundAction(i,{actor:t})})};e.prototype.transform=function(t){var e=this.getNewTreeNode(this.actor),i=e.get_root(),n=this;var r=gmath.ui.Keyboard();r.on("done",o).on("cancel",s)();function o(o){var s=i.parse(o,true);if(!s)return;n.extend_fraction(e,s);r.visible(false);r.on("done",null).on("cancel",null);t(n)}function s(){console.log("cancelled");r.visible(false);r.on("done",null).on("cancel",null);t(false)}r.latex("").visible(true)};e.prototype.extend_fraction=function(t,e){t.append(new _(e,"mul"));t.append(new _(e.clone(),"div"));this.cleanup(t)};return new e}();gmath.actions.SplitNumeratorAction=function(){var e=function(t){Action.call(this,"SplitNumeratorAction","split numerator into new fractions with same denominators");this.priority=0;this.triggerType="drag";this.settings={};if(t){this.nodes=t.nodes;this.target=t.target;this.settings.side=Array.isArray(this.target)?"around":t.side;this.settings.target_is_left=t.side==="left-of";this.settings.offset={x:this.settings.target_is_left?-10:10,y:0}}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){if(t.length===0)return[];var e=t[0];if(!e.parent||!e.parent.parent||!e.parent.parent.parent||!e.parent.parent.parent.parent)return[];if(!(e.is_group("add")||e.is_group("sub"))||!e.parent.parent.parent.is_group("mul")||!e.parent.parent.parent.parent.is_group("fraction"))return[];if(e.parent.parent.parent.parent.get_top().length>1)return[];if(this.match(t,e.parent.parent.parent.parent)){return[this.bindAction(t,"left-of"),this.bindAction(t,"right-of")]}return[]};e.prototype.bindAction=function(t,e){var i=t[0].get_root();var n=[];if(this.fractionIsPartOfProduct(t)){n=this.getSiblingsOfFraction(t,e)}return this.createBoundAction(i,{nodes:t,target:n.length>0?n:t[0].parent.parent.parent.parent,side:e})};e.prototype.fractionIsPartOfProduct=function(t){var e=t[0].parent;return e.parent&&e.parent.is_group("sum")};e.prototype.getSiblingsOfFraction=function(t,e){var i=t[0].parent,n=i.parent,r=n.parent;if(e==="left-of")return r.children.slice(0,r.children.indexOf(n));else return r.children.slice(r.children.indexOf(n)+1)};e.prototype.match=function(t,e){if(t.length===0)return false;return t[0]&&(t[0].is_group("add")||t[0].is_group("sub"))&&t[0].parent.parent.parent.parent===e&&e.is_group("fraction")};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.nodes);this.addTouchedNodes(this.nodes[0].parent.parent.parent.parent);var n=this.nodes[0].parent.parent.parent.parent.get_bottom(),r=this.nodes[0].parent.parent.parent.parent.children[1];
var o=i[0].parent.parent.parent.parent;t.remove_range(i);var s=g.prototype.createGroup();o.replace_with(s);s.append(new g(o));var a=o.get_bottom();var h=new v;h.invert();var l=g.prototype.createGroup();l.append_range(i);h.insert(0,new _(l));for(var d=0;d<a.length;d++){var c=t.clone(a[d]);h.append(c);this.extendNodeMap(n[d].get_mapping_to(c))}this.extendNodeMap(r,h.children[1]);var p=new g(h);var f=this.settings.target_is_left;s.insert(f?0:1,p);var m=this.rearrangeSumIfNumeratorIsASingleTerm(s,0),y=this.rearrangeSumIfNumeratorIsASingleTerm(s,1);if(f&&!m||!f&&!y){for(var d=0;d<i.length;d++){this.updateNodeMap(i[d],p)}}var w=o.get_top(),b=h.get_top();if(w.length===1)this.cleanup(w[0]);if(b.length===1)this.cleanup(b[0]);this.cleanup(s.parent);u.handle(s);if(typeof e==="function")e(this);else return true};e.prototype.rearrangeSumIfNumeratorIsASingleTerm=function(t,e){var i=t.children[e],n=i.children[1];if(n.children[0].children[1].children[1].children.length===1){var r=n.children[0].children[1].children[1],o=r.children[0],s=o.children[1],a=r.parent.parent;r.parent.remove();o.remove();s.remove();r.remove();n.remove();i.remove();t.insert(e,o);o.append(n);a.append(s);return true}return false};return new e}();r.prototype.move_actions.push(gmath.actions.SplitNumeratorAction);gmath.actions.DivideRationalNumbersAction=function(){var t=function(t){Action.call(this,"DivideRationalNumbersAction","division of numbers");this.triggerType="drag";this.priority=2;this.settings={delay:400,side:"inside"};if(t){this.nodes=t.nodes;this.target=t.target}};gmath.inherit(Action,t);t.prototype.getAllAvailableActions=function(t){if(t.length!==1)return[];var e=t[0].parent.match("{n: ±\\NUM} / {d: ±\\NUM}");if(!e||!this.isRational(e.n)&&!this.isRational(e.d))return[];if(t[0]!==e.d.parent)return[];return this.createBoundAction(t[0].get_root(),{nodes:t,target:e.n.parent})};t.prototype.isRational=function(t){return s.get_value(t)!==(s.get_value(t)|0)};t.prototype.transform=function(t){this.old_dragged_term=this.nodes[0];this.old_target_term=this.target;this.addTouchedNodes(this.old_dragged_term);this.addTouchedNodes(this.old_target_term);var i=this.getNewTreeNode(this.old_dragged_term),n=this.getNewTreeNode(this.old_target_term),r=i.children[1],o=n.children[1],a=i.parent;var h=s.get_value(o)/s.get_value(r);if(n.is_group("div"))h=1/h;var l=new _(new s(h),n.value);e(this.old_dragged_term,l,this);e(this.old_target_term,l,this);var d=n.remove();a.insert(d,l);i.remove();this.cleanup(a);if(typeof t==="function")t(this);return this};function e(t,e,i){i.updateNodeMap(t,e);i.updateNodeMap(t.children[0],e.children[0]);if(!t.children[1].is_group("sign")&&e.children[1].is_group("sign")){i.updateNodeMap(t.children[1].get_mapping_to(e.children[1].children[1]))}else{i.updateNodeMap(t.children[1].get_mapping_to(e.children[1]))}}return new t}();r.prototype.move_actions.push(gmath.actions.DivideRationalNumbersAction);(function(){var e=function(t){Action.call(this,"CommutativeGroupCleanup","group cleanup action");if(t)this.group=t.actor};gmath.inherit(Action,e);gmath.actions.CommutativeGroupCleanup=e;e.prototype.match=function(t){return t.is_group()&&(!t.has_children()||t.children.length===1)};e.prototype.doInPlace=function(e){this.initNodeMap();var i=this.getNewTreeNode(this.group);if(i.children.length===0){t.remove(i)}else if(i.children.length===1){var n=i.children[0],r=this.group.children[0],o=n.children[1];this.updateNodeMap(r.children[0],o);this.updateNodeMap(r,o);this.updateNodeMap(r.parent,o);t.replace(n.parent,o);if(o.parent.parent)u.handle(o.parent,true);u.handle(o,true)}if(typeof e==="function")e(this);else return this};A.prototype.cleanupAction=new e;b.prototype.cleanupAction=new e})();gmath.actions.SignDoubleNegAction=function(){var e=function(t){Action.call(this,"SignDoubleNegAction","--x=x");this.priority=0;this.triggerType="tap";if(t)this.actor=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){if(t.is_group("sign")&&t.children[1].is_group("sign"))return true;if(t.is_group("sign")&&t.parent.is_group("sign"))return true;return false};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.actor);if(i.children[1].is_group("sign")){this.addTouchedNodes(this.actor.children[0]);this.addTouchedNodes(this.actor.children[1].children[0]);t.replace(i,i.children[1].children[1])}else if(i.parent.is_group("sign")){this.addTouchedNodes(this.actor.parent.children[0]);this.addTouchedNodes(this.actor.children[0]);t.replace(i.parent,i.children[1])}if(typeof e==="function")e(this);else return true};p.prototype.add_action_handler(new e);return new e}();(function(){var e=function(t){Action.call(this,"SignZeroAction","-0=0");this.priority=0;this.triggerType="tap";if(t)this.actor=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){return t.children[1]instanceof s&&t.children[1].value===0};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.actor),n=i.children[1];this.addTouchedNodes(this.actor);this.updateNodeMap(this.actor.get_mapping_to(n));t.replace(i,n);if(typeof e==="function")e(this);else return this};p.prototype.add_action_handler(new e)})();gmath.actions.MoveSignIntoBracketsAction=function(){var t=function(t){Action.call(this,"MoveSignIntoBracketsAction","move sign into brackets");this.priority=0;this.triggerType="tap";if(t)this.actor=t.actor};gmath.inherit(Action,t);t.prototype.match=function(t){if(!t.is_group("sign"))return false;if(!t.children[1].is_group("brackets"))return false;var e=t.children[1].children[1];return e.is_group("product","sum")};t.prototype.transform=function(t){this.addTouchedNodes(this.actor);var e=this.getNewTreeNode(this.actor),i=e.children[1],n=i.children[1];var r=e.parent,o=e.remove();i.remove();n.remove();if(n.is_group("product")){this.applySignToProductFraction(n,e)}else{this.applySignToSum(n,e)}r.insert(o,n);this.cleanup(n);u.handle(n);this.cleanup(r);if(typeof t==="function")t(this);else return true};t.prototype.applySignToProductFraction=function(t,e){var i=t.children[0].children[1];i.remove();e.append(i);t.children[0].append(e);if(i.is_group("sign"))this.followup=gmath.actions.SignDoubleNegAction.createBoundAction(this.newTree,{actor:e})};t.prototype.applySignToSum=function(t,e){t.children.forEach(function(t){t.invert()})};p.prototype.add_action_handler(new t);return new t}();(function(){var e=function(t){Action.call(this,"IntegerExponentsAction","integer exponents");this.priority=0;this.triggerType="tap";if(t)this.actor=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){var e=t.parent;if(!e.is_group("power"))return false;var i=e.children[0],n=t.children[0];if(i.is_group("brackets"))i=i.children[1];if(!s.is_num(i))return false;if(n.is_group("brackets")&&n.children[0].hidden&&n.children[1].is_group("sign")&&s.is_num(n.children[1].children[1]))n=n.children[1].children[1];return s.is_num(n)&&Math.round(s.get_value(n))==s.get_value(n)&&s.get_value(n)!==0};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.actor);this.addTouchedNodes(this.actor.parent);var n=i.parent,r=n.children[0],o=i.children[0];if(r.is_group("brackets"))r=r.children[1];if(o.is_group("brackets"))o=o.children[1];var a=new s(Math.pow(s.get_value(r),s.get_value(o)));this.updateNodeMap(this.actor.parent.get_mapping_to(a));t.replace(n,a);if(typeof e==="function")e(this);else return true};y.prototype.add_action_handler(new e)})();(function(){function e(t,i,n,r){var o=n;r[t]=[i];if(o.has_children()){for(var s=0;s<o.children.length;s++){e(t.concat(s),i.concat(s),n.children[s],r)}}}var i=function(t){Action.call(this,"xToOneAction","x^1=x");this.priority=0;this.triggerType="tap";if(t)this.actor=t.actor};gmath.inherit(Action,i);i.prototype.match=function(t){return t.children[0]instanceof s&&t.children[0].value===1};i.prototype.transform=function(e){var i=this.getNewTreeNode(this.actor);this.addTouchedNodes(this.actor);var n=i.ls;t.remove(n);i.parent.replace_with(n);u.handle(n);this.updateNodeMap(this.actor.parent,n);this.updateNodeMap(this.actor,n);this.updateNodeMap(this.actor.children[0],n);if(typeof e==="function")e(this);else return true};y.prototype.add_action_handler(new i)})();(function(){var e=function(t){Action.call(this,"xToZeroAction","x^0=1");this.priority=0;this.triggerType="tap";if(t)this.actor=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){return t.children[0]instanceof s&&t.children[0].value===0&&t.ls.to_ascii()!=="0"};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.actor);this.addTouchedNodes(this.actor.parent);var n=new s(1);this.updateNodeMap(this.actor.parent.get_mapping_to(n));t.replace(i.parent,n);if(typeof e==="function")e(this);else return true};y.prototype.add_action_handler(new e)})();gmath.actions.CollectExponentsForFactoring=function(){var t=function(t){Action.call(this,"CollectExponentsForFactoring","collect exponents");this.settings={makes_no_changes:true,side:"inside"};if(t){this.nodes=t.nodes;this.target=t.target}};gmath.inherit(Action,t);t.prototype.getAllAvailableActions=function(t){var e=t[0].get_root(),i=this;try{var n=this.analyzeNodeStructure(t);if(n.length===0)return[];var r=n[0].prod,o=[];for(var s=0;s<r.children.length;s++){try{var a=r.get_child([s,1,1]);var h=this.getTargetRangesInExponent(a,n);h.forEach(function(n){o.push(i.createBoundAction(e,{nodes:t,target:n[0].is_group("product")?[n[0].parent.parent]:n}))})}catch(l){if(l!=="invalid path")throw l}}return o}catch(l){if(l!=="invalid path"&&l!=="wrong structure")throw l}return[]};t.prototype.transform=function(t){var e=this.getNewTreeNode(this.nodes[0]),i=this.getNewTreeNode(this.target);this.updateNodeMap(this.nodes[0],[e].concat(i));if(typeof t==="function")t(this);else return true};t.prototype.analyzeNodeStructure=function(t){var e=r.groupNodeRanges(t);if(e.length===0)return[];var i=e.map(function(t){if(t.length===1&&t[0].is_group("exponent")){var e=t[0].children[0];if(e.is_group("brackets")&&e.children[0].hidden){e=e.children[1]}return{range:t,exp:t[0],prod:t[0].get_parent(3),ascii:e.to_ascii()}}else{if(!t.every(function(t){return t.is_group("mul","div")}))throw"wrong structure";return{range:t,exp:t[0].get_parent(3),prod:t[0].get_parent(6),ascii:r.rangeToAsciiNoLeadingOp(t,true)}}});for(var n=0;n<i.length;n++){var o=i[n];if(o.ascii!==i[0].ascii)return[];if(!o.exp.is_group("exponent"))return[];if(!o.prod.is_group("fraction","product")||o.prod!==i[0].prod)return[];for(var s=n+1;s<i.length;s++){if(o.exp===i[s].exp)return[]}}return i};t.prototype.getTargetRangesInExponent=function(t,e){var i=t.get_root();if(!t.is_group("exponent"))return[];var n=e[0].ascii;for(var r=0;r<e.length;r++)if(e[r].exp===t)return[];var o=i.getRanges(n,null,t.children);if(o.length===0)return[];o=o.filter(function(e){var i=e[0];return i.parent===t||i.parent.is_group("brackets")&&i.ls.hidden&&i.get_parent(2)===t||i.is_group("mul","div")&&i.get_parent(3)===t||i.parent.is_group("mul")&&i.get_parent(4)===t});return o.map(function(t){if(t.length===1){if(t[0].parent.is_group("exponent","mul"))return[t[0].parent]}return t})};return new t}();r.prototype.move_actions.push(gmath.actions.CollectExponentsForFactoring);gmath.actions.FactorPowerAction=function(){var e=function(t){Action.call(this,"FactorPowerAction","factor power");this.interactionType="drag";this.settings={side:"outside"};if(t){this.nodes=t.nodes;this.target=t.target;if(t.margin)this.settings.margin=t.margin}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){var e,i=this.getEncompassingRange(t);if(this.thereIsALonePower(t)){if(this.transformationWouldLeaveExponentOfOne(t)){return[]}e=this.bindActionForLonePowerCases(t,i.length-1)}else if(i.length>0){e=this.bindActionForMultiplePowerCases(t,i)}else{return[]}return e};e.prototype.transform=function(t){if(Array.isArray(this.target)){for(var e=0;e<this.target.length;e++){this.addTouchedNodes(this.target[e])}}else{this.addTouchedNodes(this.target)}var i=r.groupNodeRanges(this.nodes);var n=this.getNewTreeNode(this.nodes),o=r.groupNodeRanges(n);var s;if(this.thereIsOneRange(o)){s=this.factorFromALonePower(n)}else{s=this.factorFromMultiplePowers(o)}this.mapOldRangesToNewRange(i,s);if(typeof t==="function")t(this);else return true};e.prototype.factorFromALonePower=function(t){var e=this.extractRangeFromExponent(t);return this.wrapTermInPower(e,t)};e.prototype.factorFromMultiplePowers=function(t){var e=this.getParentGroupOfPowers(t[0][0]);var i;if(!this.productFractionHasUnaffectedTerms(e,t)){i=this.performTransformationWithoutUnaffectedTerms(t,e)}else{i=this.performTransformationWithUnaffectedTerms(t,e)}return i};e.prototype.productFractionHasUnaffectedTerms=function(t,e){if(t.is_group("product")){return t.children.length>e.length}else{return t.children.length-1>e.length}};e.prototype.performTransformationWithoutUnaffectedTerms=function(t,e){for(var i=0;i<t.length;i++){this.extractRangeFromExponent(t[i])}return this.wrapTermInPower(e,t[0])};e.prototype.performTransformationWithUnaffectedTerms=function(t,e){var i=this.getAffectedTerms(t);var n=this.getIDXForFactoredStructure(i);var r=this.putAffectedTermsIntoASeparateProduct(i);var o;if(r.is_group("product")){e.insert(n,new _(r,e.is_group("fraction")&&n>e.get_top().length?"div":"mul"))}else{var s=e.parent,a=e.remove();var h=_.prototype.createGroup();h.append(new _(e));h.append(new _(r));s.insert(a,h);this.cleanup(e);this.cleanup(h.children[0])}for(var l=0;l<t.length;l++){this.extractRangeFromExponent(t[l])}o=this.wrapTermInPower(r,t[0]);return o};e.prototype.getIDXForFactoredStructure=function(t){var e;for(var i=0;i<t.length;i++){var n=t[i],r=n.parent.children.indexOf(n);if(!e&&e!==0)e=r;else if(r<e)e=r}return e};e.prototype.putAffectedTermsIntoASeparateProduct=function(t){var e=_.prototype.createGroup();t.forEach(function(t){t.remove()});if(t.every(function(t){return t.is_group("div")})){t.forEach(function(t){t.invert()})}for(var i=0;i<t.length;i++){e.append(t[i])}return e};e.prototype.mapOldRangesToNewRange=function(t,e){for(var i=0;i<t.length;i++){var n=t[i];for(var r=0;r<n.length;r++){if(n[r].is_group("exponent")){this.updateNodeMap(n[r].get_mapping_to(e))}else if(n[r].is_group("mul")){if(e.children[0].is_group("brackets")&&e.children[0].children[1].is_group("product")){this.updateNodeMap(n[r].get_mapping_to(e.children[0].children[1].children[r]))}else{this.updateNodeMap(n[r],e);if(this.newTree!==this.oldTree){this.updateNodeMap(n[r].children[1],e.children[0])}}}}}};e.prototype.extractRangeFromExponent=function(e){if(e[0].is_group("exponent")){var i=e[0].parent.parent,n=e[0].parent,r=n.children[0],o=e[0];var s=n.remove();r.remove();o.remove();i.insert(s,r);return r}else{var n=e[0].get_parent(4),o=n.children[1],a=o.children[0],h=a.children[1];t.remove_range(e);this.cleanup(h);return n}};e.prototype.wrapTermInPower=function(t,e){var i,n,r;if(t.parent.is_group("brackets")){i=t.parent;n=i.parent;r=i.remove()}else{n=t.parent;r=t.remove();i=new u(t)}var o;var s;if(e[0].is_group("exponent")){o=e[0]}else if(e[0].is_group("mul")&&e.length===1){o=e[0].children[1];o.remove();o=new y(o)}else{s=_.prototype.createGroup();for(var a=0;a<e.length;a++){s.append(e[a]);e[a].update_y_during_dragging=true}o=new y(s)}var h=new m(i,o);if(i.is_group("brackets"))i.simplify=true;n.insert(r,h);u.handle(h);if(s)this.cleanup(s);return o};e.prototype.getParentGroupOfPowers=function(t){if(t.is_group("exponent"))return t.parent.parent.parent;else return t.parent.parent.parent.parent.parent.parent};e.prototype.getAffectedTerms=function(t){var e=[];for(var i=0;i<t.length;i++){e.push(this.getParentMulFromExponentTerm(t[i][0]))}return e};e.prototype.getParentMulFromExponentTerm=function(t){if(t.is_group("exponent"))return t.parent.parent;else return t.parent.parent.parent.parent.parent};e.prototype.thereIsOneRange=function(t){return t.length===1};e.prototype.thereIsALonePower=function(t){return t.length===1&&t[0].is_group("exponent")||this.allNodesAreMulsWithinSameProduct(t)};e.prototype.transformationWouldLeaveExponentOfOne=function(t){if(!t[0].is_group("mul","div")){return false}var e=t[0].parent;if(e.is_group("product")&&t.length+1===e.children.length){var i;for(var n=0;n<e.children.length;n++){var r=e.children[n];if(t.indexOf(r)===-1){i=r;break}}if(s.get_value(r.children[1])===1){return true}}else if(e.is_group("fraction")&&t.every(function(t){return t.is_group("div")})){var o=e.get_top();if(o.length===1&&s.get_value(o[0].children[1])===1){return true}}return false};e.prototype.allNodesAreMulsWithinSameProduct=function(t){var e;for(var i=0;i<t.length;i++){var n=t[i];if(!n.is_group("mul","div"))return false;if(!e)e=n.parent;else if(n.parent!==e)return false}return true};e.prototype.bindActionForLonePowerCases=function(t,e){var i;var n={all:-.5};try{var r=t[0];if(r.is_group("exponent")){var o=r.get_parent(2);if(o.is_group("brackets")&&!o.parent.is_group("power")){i=this.createBoundAction(r.get_root(),{nodes:t,target:o})}else return[]}else if(r.is_group("mul","div")){var s=r.get_parent(2),a=s.get_parent(1),h=a.get_parent(1),l=h.get_parent(1);if(!s.is_group("brackets")||!a.is_group("exponent")||!h.is_group("power"))return[];var d;if(!l.is_group("brackets","mul","div"))d=h;else if(l.is_group("brackets")&&!l.parent.is_group("power"))d=l;else if(l.is_group("mul","div")&&e>0){n.all=-1.5;d=l.parent}else if(l.is_group("mul","div")&&e<=0)d=h;else return[];i=this.createBoundAction(r.get_root(),{nodes:t,target:d,margin:n?n:null})}else return[]}catch(u){if(u==="invalid path")return[];else throw u}return[i]};e.prototype.bindActionForMultiplePowerCases=function(t,e){var i;if(e.length===0)return[];var n=this.getBestTarget(e);i=[this.createBoundAction(t[0].get_root(),{nodes:t,target:n})];return i};e.prototype.getEncompassingRange=function(e){var i=e[0].get_root(),n=this;try{var r=this.analyzeNodeStructure(e);if(r.length===0)return[];var o=r[0].prod,s=[];for(var a=0;a<o.children.length;a++){try{var h=o.get_child([a,1,1]);var l=this.getTargetRangesInExponent(h,r);l.forEach(function(t){s=s.concat(t)})}catch(d){if(d!=="invalid path")throw d}}return t.nodes_to_range(s)}catch(d){if(d!=="invalid path"&&d!=="wrong structure")throw d}return[]};e.prototype.analyzeNodeStructure=function(t){var e=r.groupNodeRanges(t);if(e.length===0)return[];var i=e.map(function(t){if(t.length===1&&t[0].is_group("exponent")){var e=t[0].children[0];return{range:t,exp:t[0],prod:t[0].get_parent(3),ascii:e.to_ascii()}}else{if(!t.every(function(t){return t.is_group("mul","div")}))throw"wrong structure";return{range:t,exp:t[0].get_parent(3),prod:t[0].get_parent(6),ascii:r.rangeToAsciiNoLeadingOp(t,true)}}});for(var n=0;n<i.length;n++){var o=i[n];if(o.ascii!==i[0].ascii)return[];if(!o.exp.is_group("exponent"))return[];if(!o.prod.is_group("fraction","product")||o.prod!==i[0].prod)return[];for(var s=n+1;s<i.length;s++){if(o.exp===i[s].exp)return[]}}return i};e.prototype.getTargetRangesInExponent=function(t,e){var i=t.get_root();if(!t.is_group("exponent"))return[];var n=e[0].ascii;var r=i.getRanges(n,null,t.children);if(r.length===0)return[];r=r.filter(function(e){var i=e[0];return i.parent===t||i.parent.is_group("brackets")&&i.ls.hidden&&i.get_parent(2)===t||i.is_group("mul","div")&&i.get_parent(3)===t||i.parent.is_group("mul","div")&&i.get_parent(4)===t});return r.map(function(t){if(t.length===1){if(t[0].parent.is_group("exponent","mul"))return[t[0].parent]}return t})};e.prototype.getBestTarget=function(t){var e;var i=t[0].parent;if(i.is_group("product")&&i.children.length>t.length||i.is_group("fraction")&&i.children.length-1>t.length){e=t}else{var n=t[0].parent.parent;if(n.is_group("brackets")&&!n.children[0].hidden)e=n;else e=t[0].parent}return e};return new e}();r.prototype.move_actions.push(gmath.actions.FactorPowerAction);gmath.actions.DistributePowerAction=function(){var e=function(t){Action.call(this,"DistributePowerAction","distribute power");this.triggerType="drag";this.settings={side:"inside"};if(t){this.nodes=t.nodes;this.target=t.target}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){var e=t[0].get_root();var i,n,r;try{if(this.nodesAreASingleExponent(t)){r=t[0];n=r.parent;i=n.children[0]}else if(this.nodesAreAllMulDivs(t)&&this.nodesAreAConsecutiveRange(t)){r=t[0].get_parent(3);n=r.get_parent(1);i=n.children[0]}else{return[]}}catch(o){if(o!=="invalid path")throw o;return[]}if(!r.is_group("exponent")||!n.is_group("power")||!i.is_group("brackets")){return[]}var i=i.children[1];if(i.is_group()&&!i.is_group("power")&&!i.is_group("brackets")&&!i.is_group("product")&&!i.is_group("fraction"))return[];return[this.createBoundAction(e,{nodes:t,target:i})]};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.nodes[0].is_group("exponent")?this.nodes[0]:this.nodes[0].parent.parent.parent);var n=this.getNewTreeNode(this.nodes);var r=this.getNewTreeNode(this.target);var o=i.parent;var s=o.parent;this.addTouchedNodes(this.getOldTreeNode(o));t.remove_range(n);var a;if(r.is_group("product")||r.is_group("fraction")){a=r.get_top().concat(r.get_bottom());this.applyPowersToMulDivs(a,n)}else{a=[this.applyPowerToSingleTerm(r,n)];r=a[0]}if(o.children[1]){this.cleanup(o.children[1].children[0].children[1]);u.handle(o.children[1].children[0],true)}else{var h=o.remove();var l=new u(r);s.insert(h,l);l.simplify=true}if(typeof e==="function")e(this);else return true};e.prototype.nodesAreASingleExponent=function(t){return t.length===1&&t[0].is_group("exponent")};e.prototype.nodesAreAllMulDivs=function(t){for(var e=0;e<t.length;e++){if(!t[e].is_group("mul","div"))return false}return true};e.prototype.nodesAreAConsecutiveRange=function(t){if(t.length===1)return true;var e=t[0];for(var i=1;i<t.length;i++){if(e.rs!==t[i]||e!==t[i].ls)return false;e=t[i]}return true};e.prototype.applyPowersToMulDivs=function(t,e){for(var i=0;i<t.length;i++){var n=t[i].children[1];var r=this.applyPowerToSingleTerm(n,e)}};e.prototype.applyPowerToSingleTerm=function(t,e){var i;if(t.is_group("power")){i=this.applyPowerToPower(t,e)}else{i=this.applyPowerToNonPower(t,e)}return i};e.prototype.applyPowerToPower=function(e,i){var n=e;var r=t.clone(i);var o=this.extendPowerWithSelectedExponentTerms(n,r);this.extendNodeMap(this.nodes[0],o);this.updateXAndYDuringDragging(o);return n};e.prototype.applyPowerToNonPower=function(e,i){var n,r;n=e.parent;r=e.remove();var o;if(i[0].is_group("exponent"))o=t.clone(i[0]);else{var s=_.prototype.createGroup(),a=t.clone(i);this.appendAllContentsToProduct(s,a);o=new y(s)}var h=new m(e,o);n.insert(r,h);if(s){this.cleanup(s);u.handle(o.children[0],true)}this.mapDraggedExponentTermsToNewExponent(this.nodes,h.children[1]);this.updateXAndYDuringDragging(h);return h};e.prototype.mapDraggedExponentTermsToNewExponent=function(t,e){for(var i=0;i<t.length;i++){if(t[i].is_group("exponent")){this.extendNodeMap(t[i].get_mapping_to(e))}else{if(e.children[0].is_group("brackets")&&e.children[0].children[1].is_group("product")){this.extendNodeMap(t[i].get_mapping_to(e.children[0].children[1].children[i]))}else{this.extendNodeMap(t[i],e);this.extendNodeMap(t[i].children[1].get_mapping_to(e.children[0]))}}}};e.prototype.takeContentsOfBrackets=function(t){if(t.is_group("brackets")){t=t.children[1];t.remove()}return t};e.prototype.extendPowerWithSelectedExponentTerms=function(t,e){var i=t.children[1];var n=_.prototype.createGroup(),r=this.getContentMulsFromExponent(i);var o=e[0].is_group("exponent")?this.getContentMulsFromExponent(e[0]):e;this.appendAllContentsToProduct(n,r);this.appendAllContentsToProduct(n,o);i.append(n);this.cleanup(n);u.handle(n,true);this.mapDraggedExponentTermsToNewExponentTerms(this.nodes,i,o);return o};e.prototype.appendAllContentsToProduct=function(t,e){for(var i=0;i<e.length;i++){t.append(e[i])}};e.prototype.mapDraggedExponentTermsToNewExponentTerms=function(t,e,i){if(t[0].is_group("mul")){for(var n=0;n<t.length;n++){this.extendNodeMap(t[n].get_mapping_to(i[n]))}}else if(t[0].is_group("exponent")){var r=t[0].children[0];if(r.is_group("brackets")&&r.children[1].is_group("product")){for(var n=0;n<r.children[1].children.length;n++){var o=r.children[1].children[n];this.extendNodeMap(t[0],i[n]);this.extendNodeMap(o.get_mapping_to(i[n]))}}else{if(r.is_group("brackets")&&!i[0].children[1].is_group("brackets")){this.extendNodeMap(r.children[1].get_mapping_to(i[0].children[1]))}else{this.extendNodeMap(r.get_mapping_to(i[0].children[1]))}}}};e.prototype.getContentMulsFromExponent=function(e){var i=e.children[0];if(i.is_group("brackets")&&i.children[0].hidden&&i.children[1].is_group("product")){var n=i.children[1].children.slice();t.remove_range(i.children[1].children);i.remove();return n}else if(i.is_group("brackets")&&i.children[0].hidden){var r=i.children[1];r.remove();i.remove();return[new _(r)]}else{i.remove();return[new _(i)]}};e.prototype.updateXAndYDuringDragging=function(t){var e;if(!Array.isArray(t))e=[t];else e=t.slice();for(var i=0;i<e.length;i++){e[i].update_x_during_dragging=true;e[i].update_y_during_dragging=true}};return new e}();r.prototype.move_actions.push(gmath.actions.DistributePowerAction);gmath.actions.combineStackedExponentsUpAction=function(){var e=function(t){Action.call(this,"combineStackedExponentsUpAction","combine stacked exponents up");this.interactionType="drag";this.settings={side:"around"};if(t){this.nodes=t.nodes;this.target=t.target}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){if(t.length<1)return[];if(!this.validStructure(t))return[];var e=this.getBaseOfOuterPowerFromInnerExponentTerm(t);var i=e.parent.children[1];var n=[this.createBoundAction(t[0].get_root(),{nodes:t,target:i})];return n};e.prototype.transform=function(t){var e=this.getNewTreeNode(this.nodes),i=this.getNewTreeNode(this.target),n=i.parent.children[0];this.addTouchedNodes(this.target.parent);this.extractSelectedExponentTermsFromInnerPower(e);var r=this.extendOuterExponentWithSelectedExponentTerms(n,e);this.mapSelectedExponentsTermsToNewExponentTerms(this.nodes,r);n.simplify=true;if(typeof t==="function")t(this);else return true};e.prototype.validStructure=function(t){if(this.nodesAreASingleExponent(t)){return this.termsBelongToAPowerWithinAPower(t)}else if(this.nodesAreAllMulDivs(t)&&this.nodesAreAConsecutiveRange(t)){return this.termsBelongToAPowerWithinAPower(t)}else return false};e.prototype.nodesAreASingleExponent=function(t){return t.length===1&&t[0].is_group("exponent")};e.prototype.nodesAreAllMulDivs=function(t){for(var e=0;e<t.length;e++){if(!t[e].is_group("mul","div"))return false}return true};e.prototype.nodesAreAConsecutiveRange=function(t){if(t.length===1)return true;var e=t[0];for(var i=1;i<t.length;i++){if(e.rs!==t[i]||e!==t[i].ls)return false;e=t[i]}return true};e.prototype.termsBelongToAPowerWithinAPower=function(t){try{var e,i,n,r;if(t[0].is_group("exponent")){e=t[0];i=e.get_parent(1);n=i.get_parent(1);r=n.get_parent(1);if(!i.is_group("power")||!n.is_group("brackets")||!r.is_group("power"))return false}else{e=t[0].get_parent(3);i=e.get_parent(1);n=i.get_parent(1);r=n.get_parent(1);if(!e.is_group("exponent")||!i.is_group("power")||!n.is_group("brackets")||!r.is_group("power"))return false}}catch(o){if(o!=="invalid path")throw o;return false}return true};e.prototype.getBaseOfOuterPowerFromInnerExponentTerm=function(t){if(t[0].is_group("exponent"))return t[0].get_parent(2);else return t[0].get_parent(5)};e.prototype.extractSelectedExponentTermsFromInnerPower=function(e){if(e[0].is_group("exponent")){var i=e[0].parent,n=e[0],r=i.children[0],o=i.parent;var s=i.remove();r.remove();n.remove();o.insert(s,r)}else{var a=e[0].parent,h=a.parent;t.remove_range(e);this.cleanup(a)}};e.prototype.extendOuterExponentWithSelectedExponentTerms=function(t,e){var i=t.parent,n=i.children[1];var r=_.prototype.createGroup(),o=this.getContentMulsFromExponent(n);var s=e[0].is_group("exponent")?this.getContentMulsFromExponent(e[0]):e;this.appendAllContentsToProduct(r,o);this.appendAllContentsToProduct(r,s);n.append(r);this.cleanup(r);u.handle(r);return s};e.prototype.appendAllContentsToProduct=function(t,e){for(var i=0;i<e.length;i++){t.append(e[i]);e[i].update_y_during_dragging=true}};e.prototype.getContentMulsFromExponent=function(e){var i=e.children[0];if(i.is_group("brackets")&&i.children[0].hidden&&i.children[1].is_group("product","fraction")){var n=i.children[1].children.slice();t.remove_range(i.children[1].children);i.remove();return n}else if(i.is_group("brackets")&&i.children[0].hidden){var r=i.children[1];r.remove();i.remove();return[new _(r)]}else{i.remove();return[new _(i)]}};e.prototype.mapSelectedExponentsTermsToNewExponentTerms=function(t,e){for(var i=0;i<t.length;i++){for(var n=0;n<e.length;n++){if(n===0)this.updateNodeMap(t[i],e[n]);else this.extendNodeMap(t[i],e[n])}}};return new e}();r.prototype.move_actions.push(gmath.actions.combineStackedExponentsUpAction);gmath.actions.PowerFactorAndCombineStackedExponentsAction=function(){var t=function(t){Action.call(this,"PowerFactorAndCombineStackedExponentsAction","factor power and combine stacked exponent up");this.triggerType="drag";this.settings={side:"inside"};if(t){this.nodes=t.nodes;this.target=t.target}};gmath.inherit(Action,t);t.prototype.getAllAvailableActions=function(t){if(t.length<2)return[];var e=gmath.actions.FactorPowerAction.getAllAvailableActions(t);if(e.length===0)return[];var i=e[0];if(Array.isArray(i.target))return[];if(!i.target.is_group("brackets"))return[];if(!this.nodesAccountForEveryTermInProduct(i.target.children[1],t))return[];if(!i.target.parent.is_group("power"))return[];var n=i.target.parent.children[1];var r=this.createBoundAction(t[0].get_root(),{nodes:t,target:n});return[r]};t.prototype.nodesAccountForEveryTermInProduct=function(t,e){var i=[];for(var n=0;n<e.length;n++){var o=e[n].parent;while(!o.is_group("power")&&!r.is_top_most(o)){o=o.parent}if(i.every(function(t){return t!==o})){i.push(o)}}return i.length===t.children.length};t.prototype.doInPlace=function(t){this.initNodeMap();var e=this.target.parent;this.addTouchedNodes(e);var i=this.getNewTreeNode(this.nodes);var n=gmath.actions.FactorPowerAction.getAllAvailableActions(i)[0];n.doInPlace();this.compose(n);var r=n.mapNodes(i);var o=gmath.actions.combineStackedExponentsUpAction.getAllAvailableActions(r)[0];o.doInPlace();this.compose(o);e=this.mapNodes(e)[0];u.handle(e.children[0],true);this.removeDeletedNodesFromNodeMap();if(typeof t==="function")t(this);else return true};return new t}();r.prototype.move_actions.push(gmath.actions.PowerFactorAndCombineStackedExponentsAction);(function(){var e=function(t){Action.call(this,"polynomialExpansionAction","polynomial expansion");this.priority=0;this.triggerType="dbltap";if(t)this.actor=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){if(!t.is_group("exponent"))return false;if(!t.children[0]||!s.is_num(t.children[0]))return false;if(s.get_value(t.children[0])!==2&&s.get_value(t.children[0])!==3)return false;var e=t.parent,i=e.children[0];if(!i.is_group("brackets"))return false;if(!i.children[1].is_group("sum"))return false;return true};e.prototype.transform=function(t){var e=this.getNewTreeNode(this.actor);this.addTouchedNodes(this.actor);var i=e.parent;var n=this.analyzeStructure(e);var r=this.formAddendsForExpandedPolynomial(n);r.sort(function(t,e){if(t.firstOrder===e.firstOrder&&t.degreeOfFirstOrder>=e.degreeOfFirstOrder)return 0;if(t.firstOrder===e.firstOrder&&t.degreeOfFirstOrder<e.degreeOfFirstOrder)return 1;if(t.firstOrder<e.firstOrder)return-1;if(t.firstOrder>e.firstOrder)return 1});this.replacePowerWithExpandedPolynomialSum(i,r);if(typeof t==="function")t(this);else return true};e.prototype.analyzeStructure=function(t){var e={};var i=t.parent,n=i.children[0],r=n.children[1];e.degree=s.get_value(t.children[0]);e.terms=r.children.slice();return e};e.prototype.formAddendsForExpandedPolynomial=function(t){var e;if(t.degree===2){e=this.formAddendsForDegreeOfTwo(t.terms)}else if(t.degree===3){e=this.formAddendsForDegreeOfThree(t.terms)}return e};e.prototype.formAddendsForDegreeOfTwo=function(e){var i=[];for(var n=0;n<e.length;n++){var r=e[n].children[1],o=t.clone(r);
this.extendNodeMap(this.getOldTreeNode(r).get_mapping_to(o));var a={};a.addend=new g(new m(o,new s(2)));a.firstOrder=n;a.degreeOfFirstOrder=2;i.push(a)}for(var n=0;n<e.length-1;n++){for(var h=n+1;h<e.length;h++){var l=_.prototype.createGroup();l.append(new _(new s(2)));var d=0;var u=e[n].children[1],c=t.clone(u);this.extendNodeMap(this.getOldTreeNode(u).get_mapping_to(c));if(e[n].is_group("sub"))d=(d+1)%2;var p=e[h].children[1],f=t.clone(p);this.extendNodeMap(this.getOldTreeNode(p).get_mapping_to(f));if(e[h].is_group("sub"))d=(d+1)%2;if(s.get_value(c)!==1)l.append(new _(c));if(s.get_value(f)!==1)l.append(new _(f));var a={};a.addend=new g(l,d?"sub":"add");a.firstOrder=n;a.degreeOfFirstOrder=1;i.push(a)}}return i};e.prototype.formAddendsForDegreeOfThree=function(e){var i=[];for(var n=0;n<e.length;n++){var r=e[n].children[1],o=t.clone(r);this.extendNodeMap(this.getOldTreeNode(r).get_mapping_to(o));var a={};a.addend=new g(new m(o,new s(3)),e[n].value);a.firstOrder=n;a.degreeOfFirstOrder=3;i.push(a)}for(var n=0;n<e.length-1;n++){for(var h=n+1;h<e.length;h++){var l=e[n].children[1],d=e[h].children[1];var u=t.clone(l),c=t.clone(d);this.extendNodeMap(this.getOldTreeNode(l).get_mapping_to(u));this.extendNodeMap(this.getOldTreeNode(d).get_mapping_to(c));var p=_.prototype.createGroup();p.append(new _(new s(3)));p.append(new _(new m(u,new s(2))));if(s.get_value(c)!==1)p.append(new _(c));var f={};f.addend=new g(p,d.parent.value);f.firstOrder=n;f.degreeOfFirstOrder=2;i.push(f);var v=t.clone(l),y=t.clone(d);this.extendNodeMap(this.getOldTreeNode(l).get_mapping_to(v));this.extendNodeMap(this.getOldTreeNode(d).get_mapping_to(y));var w=_.prototype.createGroup();w.append(new _(new s(3)));if(s.get_value(v)!==1)w.append(new _(v));w.append(new _(new m(y,new s(2))));var b={};b.addend=new g(w,l.parent.value);b.firstOrder=n;b.degreeOfFirstOrder=1;i.push(b)}}for(var n=0;n<e.length-2;n++){for(var h=n+1;h<e.length-1;h++){for(var x=h+1;x<e.length;x++){var l=e[n].children[1],d=e[h].children[1],A=e[x].children[1];var N=t.clone(l),T=t.clone(d),S=t.clone(A);this.extendNodeMap(this.getOldTreeNode(l).get_mapping_to(N));this.extendNodeMap(this.getOldTreeNode(d).get_mapping_to(T));this.extendNodeMap(this.getOldTreeNode(A).get_mapping_to(S));var k=_.prototype.createGroup();k.append(new _(new s(6)));if(s.get_value(N)!==1)k.append(new _(N));if(s.get_value(T)!==1)k.append(new _(T));if(s.get_value(S)!==1)k.append(new _(S));var L=0;if(e[n].is_group("sub"))L=(L+1)%2;if(e[h].is_group("sub"))L=(L+1)%2;if(e[x].is_group("sub"))L=(L+1)%2;var a={};a.addend=new g(k,L?"sub":"add");a.firstOrder=n;a.degreeOfFirstOrder=1;i.push(a)}}}return i};e.prototype.replacePowerWithExpandedPolynomialSum=function(t,e){var i=t.parent,n=t.remove();var r=g.prototype.createGroup();for(var o=0;o<e.length;o++){r.append(e[o].addend)}i.insert(n,r);this.applyPowers(e);this.cleanupAddends(e);u.handle(r,true);this.cleanup_cascade(r.parent)};e.prototype.applyPowers=function(t){for(var e=0;e<t.length;e++){var i=t[e].addend?t[e].addend.children[1]:t[e].children[1];if(i.is_group("power")){this.applyPower(t[e].addend?t[e].addend:t[e])}else if(i.is_group("product")){this.applyPowers(i.children.slice())}}};e.prototype.applyPower=function(t){var e=t.children[1],i=e.children[0],n=e.children[1];var r=gmath.actions.DistributePowerAction.getAllAvailableActions([n]);if(r.length>0){r[0].doInPlace();this.compose(r[0],false);if(t.children[1].is_group("brackets")){var o=t.children[1].children[1];o.remove();t.children[1].remove();t.append(o)}}var s=r[0]?r[0].mapNodes(n):[n];for(var a=0;a<s.length;a++){var h=s[a].getBestMatchingAction();if(h&&h.name!=="polynomial expansion"){var l=h.createBoundAction(this.newTree,{actor:s[a]});l.doInPlace();this.compose(l,false)}}};e.prototype.cleanupAddends=function(t){for(var e=0;e<t.length;e++){if(t[e].addend.children[1].is_group("product")){var i=t[e].addend.children[1].children.slice();for(var n=0;n<i.length;n++){this.cleanup(i[n])}}}};y.prototype.add_action_handler(new e)})();(function(){var e=function(t){Action.call(this,"MulDivCleanup","muldiv cleanup action");if(t)this.actor=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){if(e.hasProductChild(t))return true;if(t.parent.cleanupAction&&t.parent.cleanupAction.match(t.parent))return true;return false};e.hasProductChild=function(t){return(t.is_group("mul")||t.is_group("div"))&&t.children[1]&&t.children[1].is_group("product")};e.prototype.doInPlace=function(i){this.initNodeMap();var n=this.getNewTreeNode(this.actor);var r=n.parent,o=this.actor.parent;if(e.hasProductChild(n)){var s=n.children[1],a=this.getOldTreeNode(s);var h=t.remove(n);this.updateNodeMap(this.actor,r);this.updateNodeMap(a,s.children);if(this.actor.is_group("div"))s.children.forEach(function(t){t.invert()});r.insert_range(h,s.children)}this.cleanup(r);if(typeof i==="function")i(this);else return this};_.prototype.cleanupAction=new e})();gmath.actions.MultiplyNumbersAction=function(){var t=function(t){Action.call(this,"MultiplyNumbersAction","Multiply numbers");this.triggerType="tap";this.settings={is_join_action:true,delay:250,side:"inside",margin:{x:.1}};if(t){if(t.triggerType==="drag"){this.triggerType=t.triggerType;this.nodes=t.nodes;this.target=t.target}else{this.actor=t.actor}}};gmath.inherit(Action,t);t.prototype.getAllAvailableActions=function(t){if(t.length>1)return[];if(!t[0].is_group("mul","div"))return[];if(!s.is_num(t[0].children[1]))return[];var e=this.getOtherNumberMulsInProduct(t[0]);return this.bindActionForEachTarget(t,e)};t.prototype.getOtherNumberMulsInProduct=function(t){var e=t.parent;var i=e.filter(function(i){return i!==t&&i.is_group(t.value)&&s.is_num(i.children[1])&&i.parent===e});return i};t.prototype.bindActionForEachTarget=function(t,e){var i=[];var n=t[0].get_root();for(var r=0;r<e.length;r++){i.push(this.createBoundAction(n,{nodes:t,target:e[r],triggerType:"drag"}))}return i};t.prototype.match=function(t){if(!t.ls)return false;if(t.ls.value!=t.value)return false;var e=t.ls.children[1],i=t.children[1];if(!(s.is_num(e)&&s.is_num(i)))return false;return true};t.prototype.transform=function(t){if(this.triggerType==="drag"){this.sourceMul=this.nodes[0];this.targetMul=this.target}else{this.sourceMul=this.actor;this.targetMul=this.actor.ls}this.addTouchedNodes(this.sourceMul);this.addTouchedNodes(this.targetMul);var e=this.getNewTreeNode(this.sourceMul),i=this.getNewTreeNode(this.targetMul),n=e.parent;var r=i.children[1],o=e.children[1];var a=s.get_value(r)*s.get_value(o);var h=new _(new s(a),e.value);this.updateNodeMap(this.sourceMul,h);this.updateNodeMap(this.sourceMul.children[0],h.children[0]);if(!this.sourceMul.children[1].is_group("sign")&&h.children[1].is_group("sign")){this.updateNodeMap(this.sourceMul.children[1].get_mapping_to(h.children[1].children[1]))}else{this.updateNodeMap(this.sourceMul.children[1].get_mapping_to(h.children[1]))}this.updateNodeMap(this.targetMul,h);this.updateNodeMap(this.targetMul.children[0],h.children[0]);if(!this.targetMul.children[1].is_group("sign")&&h.children[1].is_group("sign")){this.updateNodeMap(this.targetMul.children[1].get_mapping_to(h.children[1].children[1]))}else{this.updateNodeMap(this.targetMul.children[1].get_mapping_to(h.children[1]))}var l=i.remove();n.insert(l,h);e.remove();this.cleanup(n);if(typeof t==="function")t(this);return this};_.prototype.add_action_handler(new t);return new t}();r.prototype.move_actions.push(gmath.actions.MultiplyNumbersAction);gmath.actions.MultiplyPowersAction=function(){var t=function(t){Action.call(this,"MultiplyPowersAction","Multiply powers");this.triggerType="tap";this.settings={delay:250,side:"inside",margin:{x:.1}};if(t){if(t.triggerType==="drag"){this.triggerType=t.triggerType;this.nodes=t.nodes;this.target=t.target}else{this.actor=t.actor}}};gmath.inherit(Action,t);t.prototype.areLikeTerms=function(t,e){var i=t.is_group("power")?t.children[0].to_ascii():t.to_ascii(),n=e.is_group("power")?e.children[0].to_ascii():e.to_ascii();return i===n};t.prototype.match=function(t,e){if(arguments.length<2)e=t.ls;if(!e)return false;if(!t.is_group("mul","div")||!e.is_group("mul","div"))return false;return this.areLikeTerms(t.children[1],e.children[1])};t.prototype.getSiblings=function(t){return t.parent.children.filter(function(e){return e!==t&&e.value===t.value})};t.prototype.getAllAvailableActions=function(t){var e=[];if(t.length!==1)return e;var i=t[0];if(!i.is_group("mul","div"))return e;var n=this.getSiblings(i);var r=i.get_root();for(var o=0;o<n.length;o++){if(this.match(i,n[o])){e.push(this.createBoundAction(r,{nodes:t,target:n[o],triggerType:"drag"}))}}return e};t.prototype.transform=function(t){var e=this.nodes&&this.nodes[0]||this.actor,i=this.target||this.actor&&this.actor.ls;this.addTouchedNodes(e);this.addTouchedNodes(i);var n=this.analyzeStructure(e);e=this.getNewTreeNode(e);i=this.getNewTreeNode(i);var r=this.performProductOfPowersProperty(e,i);this.mapOldSourceStructureToTarget(n,i);i=i.children[1];this.cleanup(e.parent);if(this.simplify_exponent&&this.shouldSimplifyExponent(i)){var o=this.getExtendablesFromExponent(i).children[1];this.followup=gmath.actions.AddSubNumbersAction.createBoundAction(this.newTree,{actor:o.children[1]})}else{this.simplify_exponent=false;this.setNodesToReselectAfterAction(r)}if(typeof t==="function")t(this);else return true};t.prototype.analyzeStructure=function(t){var e={};e.muldiv=t;var i=t.children[1];if(i.is_group("power")){e.base=i.children[0];e.exponent=i.children[1]}else{e.base=i;e.exponent=null}return e};t.prototype.performProductOfPowersProperty=function(t,e){var i=t.children[1],n=e.children[1];if(!i.is_group("power")){i=this.reinterpretTermAsPowerWithExponentOfOne(i);this.simplify_exponent=true}if(!n.is_group("power")){n=this.reinterpretTermAsPowerWithExponentOfOne(n);this.simplify_exponent=true}var r=t.parent.children.indexOf(t)<e.parent.children.indexOf(e);var o=this.extendTargetPowerWithSourcePower(n,i,r);t.remove();return o};t.prototype.reinterpretTermAsPowerWithExponentOfOne=function(t){var e=t.parent,i=t.remove();var n=new m(t,new s(1));e.insert(i,n);return n};t.prototype.extendTargetPowerWithSourcePower=function(t,e,i){var n=this.getExtendablesFromExponent(e,true),r=this.getExtendablesFromExponent(t,false);var o=this.combineTermsIntoSum(r,n,i);return o};t.prototype.getExtendablesFromExponent=function(t,e){var i=t.children[1],n=i.children[0];if(n.is_group("brackets")&&n.children[0].hidden){n=n.children[1]}if(e)n.remove();return n};t.prototype.combineTermsIntoSum=function(t,e,i){var n=[];var r=t.parent,o=t.remove();var s=g.prototype.createGroup();var a=new g(e),h=new g(t);if(e.is_group("sum")){n=e.children.slice()}else{n.push(a)}s.append(h);s.insert(i?0:1,a);r.insert(o,s);u.handle(s);this.cleanup(h);this.cleanup(a);return n};t.prototype.mapOldSourceStructureToTarget=function(t,e){this.updateNodeMap(t.muldiv,e);this.updateNodeMap(t.muldiv.children[0],e.children[0]);var i=e.children[1].children[0];this.updateNodeMap(t.base.get_mapping_to(i));if(t.exponent){var n=e.children[1].children[1];this.updateNodeMap(t.exponent,n)}};t.prototype.shouldSimplifyExponent=function(t){var e=this.getExtendablesFromExponent(t);if(e.is_group("brackets")){e=e.children[1]}return e.children.length===2&&e.children.every(function(t){return s.is_num(t.children[1])})};_.prototype.add_action_handler(new t);return new t}();r.prototype.move_actions.push(gmath.actions.MultiplyPowersAction);gmath.actions.NegationAction=function(){var e=function(t){Action.call(this,"NegationAction","negation");this.priority=0;this.triggerType="tap";this.settings={side:"inside",delay:300};if(t){if(t.actor){this.actor=t.actor}else{this.triggerType="drag";this.nodes=t.nodes;this.target=t.target}}};gmath.inherit(Action,e);e.prototype.isNegativeElement=function(t){return t&&t.is_group("mul","div")&&s.is_num(t.children[1])&&s.get_value(t.children[1])===-1};e.prototype.getAllAvailableActions=function(t){if(t.length!==1)return[];var e=t[0];var i=[];if(this.isNegativeElement(e)){var n=e.parent.children.indexOf(e);i=e.parent.children.filter(function(t){return t!==e&&t.is_group("mul","div")})}else{i=e.parent.children.filter(this.isNegativeElement.bind(this))}var r=e.get_root();return i.map(function(e){return this.createBoundAction(r,{nodes:t,target:e})},this)};e.prototype.match=function(t){return this.isNegativeElement(t.ls)||this.isNegativeElement(t)};e.prototype.transform=function(e){var i=this.actor?this.actor:this.nodes[0],n=this.target;if(!this.target){if(this.actor.ls)n=this.actor.ls.value==="//"?this.actor.ls.ls:this.actor.ls;else if(this.actor.rs)n=this.actor.rs.value==="//"?this.actor.rs.rs:this.actor.rs}this.addTouchedNodes(i);this.addTouchedNodes(n);var r=this.getNewTreeNode(i),o=this.getNewTreeNode(n);var h,l;if(s.get_value(r.children[1])===-1){h=r;l=o}else{h=o;l=r}var d=l.children[1],u=this.getOldTreeNode(h),c=u.children[1],f=this.getOldTreeNode(l);t.remove(h);if(d.is_group("sign")&&d.children[1]&&!d.children[1].is_group("sign")){var g=d.children[1];this.updateNodeMap(f.children[1].children[0],g);this.updateNodeMap(c,g);this.updateNodeMap(c.children[0],g);this.updateNodeMap(c.children[1],g);d.replace_with(g)}else{var v=new p;v.append(new a("-"));this.updateNodeMap(c,v);this.updateNodeMap(c.children[0],v.children[0]);this.updateNodeMap(c.children[1],d);d.remove();v.append(d);l.append(v)}this.updateNodeMap(u,l);this.updateNodeMap(u.children[0],l.children[0]);this.cleanup(l);if(typeof e==="function")e(this);return this};_.prototype.add_action_handler(new e);return new e}();r.prototype.move_actions.push(gmath.actions.NegationAction);gmath.actions.MultiplyFractionsAction=function(){var e=function(t){Action.call(this,"MultiplyFractionsAction","multiply fractions");this.priority=1;this.triggerType="tap";this.settings={delay:250,side:"inside",margin:{x:.1}};if(t){if(t.triggerType==="drag"){this.triggerType=t.triggerType;this.nodes=t.nodes;this.target=t.target}else{this.actor=t.actor}}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){if(t.length!==1)return[];var e=t[0];if(!e.parent.is_group("product","fraction"))return[];if(!e.children[1].is_group("fraction"))return[];var i=e.parent.children.filter(this.match2.bind(this,e));var n=e.get_root(),r=this;return i.map(function(e){return r.createBoundAction(n,{nodes:t,target:e,triggerType:"drag"})})};e.prototype.match=function(t){return this.match2(t.ls,t)};e.prototype.match2=function(t,e){if(!t||!e||t===e)return false;if(t.value!==e.value)return false;var i=t.parent;if(e.parent!==i)return false;var n=t.children[1],r=e.children[1];if(!(n.is_group("fraction")&&r.is_group("fraction")))return false;if(!i.is_group("fraction","product"))return false;return true};e.prototype.transform=function(e){if(this.triggerType==="drag"){this.sourceMul=this.nodes[0];this.targetMul=this.target}else{this.sourceMul=this.actor;this.targetMul=this.actor.ls}this.addTouchedNodes(this.sourceMul);this.addTouchedNodes(this.targetMul);var i=this.getNewTreeNode(this.sourceMul),n=this.getNewTreeNode(this.targetMul),r=i.parent,o,s,a;if(i.parent.children.indexOf(i)<n.parent.children.indexOf(n)){o=i,s=n,a=0}else{o=n,s=i,a=1}var h=r;var l=o.children[1],d=s.children[1];var c=this.sourceMul.children[1];this.updateNodeMap(c.get_fraction_bar(),l.get_fraction_bar());this.updateNodeMap(this.sourceMul,o);this.updateNodeMap(this.sourceMul.children[0],o.children[0]);t.remove(s);var p=d.get_top(),f=d.get_bottom();for(var g=0;g<p.length;g++)l.append(p[g]);for(var g=0;g<f.length;g++)l.append(f[g]);for(var g=0;g<l.children.length;g++){var v=l.children[g];if(v.has_children())u.handle(v.children[1])}this.cleanup(h);if(typeof e==="function")e(this);return this};_.prototype.add_action_handler(new e);return new e}();r.prototype.move_actions.push(gmath.actions.MultiplyFractionsAction);gmath.actions.AddFractionsAction=function(){var e=function(t){Action.call(this,"AddFractionsAction","add fractions");this.priority=1;this.triggerType="tap";this.settings={delay:250,side:"inside",margin:{x:.1}};if(t){if(t.triggerType==="drag"){this.triggerType=t.triggerType;this.nodes=t.nodes;this.target=t.target}else this.actor=t.actor}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){if(t.length!==1)return[];var e=t[0];if(!e.parent.is_group("sum"))return[];if(!e.children[1].is_group("fraction"))return[];var i=e.parent.children.filter(this.match2.bind(this,e));var n=e.get_root(),r=this;return i.map(function(e){return r.createBoundAction(n,{nodes:t,target:e,triggerType:"drag"})})};e.prototype.match=function(t){return this.match2(t.ls,t)};e.prototype.match2=function(t,e){if(!t||!e||t===e)return false;if(!t.parent.is_group("sum"))return false;if(t.parent!==e.parent)return false;var i=t.children[1],n=e.children[1];if(!(i.is_group("fraction")&&n.is_group("fraction")))return false;var r=function(t){return t.to_ascii()};var o=i.get_bottom(),s=n.get_bottom();if(o.map(r).join("")!==s.map(r).join(""))return false;return true};e.prototype.transform=function(e){if(this.triggerType==="drag"){this.sourceAddend=this.nodes[0];this.targetAddend=this.target}else{this.sourceAddend=this.actor;this.targetAddend=this.actor.ls}this.addTouchedNodes(this.sourceAddend);this.addTouchedNodes(this.targetAddend);var i=this.getNewTreeNode(this.sourceAddend),n=this.getNewTreeNode(this.targetAddend),r=i.parent;if(i.parent.children.indexOf(i)<n.parent.children.indexOf(n)){var o=n;n=i;i=o}var s=this.getOldTreeNode(n),a=this.getOldTreeNode(i);var h=n.children[1],l=i.children[1];this.mapOldFractionPartsToFraction(a.children[1],h);var d=t.remove(n);t.remove(i);t.remove(h);t.remove(l);n=this.putNumeratorTermsIntoAddSubAndMapFromOldAddSub(h.get_top(),s);i=this.putNumeratorTermsIntoAddSubAndMapFromOldAddSub(l.get_top(),a);var u=this.putAddendsIntoNewSumAndMakeNumeratorTerm(n,i);h.append(u);var c=new g(h);t.insert(r,d,c);this.updateNodeMap(this.sourceAddend,c);this.updateNodeMap(this.targetAddend,c);this.cleanup(n);this.cleanup(i);this.cleanup(r);if(gmath.options.actions.simplify_sum_in_numerator_after_adding_fractions&&this.numeratorSumContainsTwoNumbers(h.get_top()[0].children[1].children[1])){this.simplifyNumeratorAsFollowup(h)}if(typeof e==="function")e(this);else return true};e.prototype.mapOldFractionPartsToFraction=function(t,e){this.updateNodeMap(t.get_fraction_bar(),e.get_fraction_bar());var i=t.get_bottom(),n=e.get_bottom();for(var r=0;r<i.length;r++){this.updateNodeMap(i[r].get_mapping_to(n[r]))}};e.prototype.putNumeratorTermsIntoAddSubAndMapFromOldAddSub=function(e,i){t.remove_range(e);var n;if(e.length==1){n=new g(e[0].children[1],i.value)}else{var r=new v;t.insert_range(r,0,e);n=new g(r,i.value)}u.handle(n.children[1],true);this.updateNodeMap(i,n);this.updateNodeMap(i.children[0],n.children[0]);return n};e.prototype.putAddendsIntoNewSumAndMakeNumeratorTerm=function(e,i){var n=g.prototype.createGroup();n.append(e);n.append(i);var r=new _;t.append(r,new a("*"));t.append(r,n);u.handle(n);return r};e.prototype.numeratorSumContainsTwoNumbers=function(t){return t.children.length===2&&t.children.every(function(t){return s.is_num(t.children[1])})};e.prototype.simplifyNumeratorAsFollowup=function(t){var e=t.get_top()[0].children[1].children[1];this.followup=gmath.actions.AddSubNumbersAction.createBoundAction(this.newTree,{actor:e.children[1]})};g.prototype.add_action_handler(new e);return new e}();r.prototype.move_actions.push(gmath.actions.AddFractionsAction);gmath.actions.FractionCancelTermsAction=function(){var e=function(t){Action.call(this,"FractionCancelTermsAction","cancel numbers in a fraction");this.triggerType="drag";this.priority=0;this.settings={delay:400,side:"inside"};if(t){this.nodes=t.nodes;this.target=t.target}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){return e.getAllAvailableActions.call(this,t)};e.getAllAvailableActions=function(t){if(t.length!==1)return[];if(!t.every(function(t){return t.is_group("mul","div")}))return[];var i=e.findTopLevelGroupForCanceling(t);if(!i)return[];var n=e.findOtherContendersInStructure(t,i);if(n.length===0)return[];var r=this;n=n.filter(function(i){return e.match.call(r,t[0],i)});var o=t[0].get_root();return n.map(function(e){return r.createBoundAction(o,{nodes:t,target:e})})};e.findTopLevelGroupForCanceling=function(t){var i;if((i=e.nodesAreInAFractionWithinAProduct(t))||(i=e.nodesAreInAProductThatContainsAFraction(t))||(i=e.nodesAreInAFraction(t))){return i}else{return false}};e.findOtherContendersInStructure=function(t,i){var n;var r=t[0].is_group("mul")?"div":"mul";n=i.filter(function(n){return n.is_group(r)&&e.nodeIsCorrectLevelRelativeToTopLevelGroup(n,i)&&!e.nodeIsAncestorOfNodes(n,t)});return n};e.nodesAreInAFractionWithinAProduct=function(t){var e=t[0].parent;if(e.is_group("fraction")&&e.parent&&e.parent.is_group("mul")&&e.parent.parent.is_group("product")){return e.parent.parent}else{return false}};e.nodesAreInAProductThatContainsAFraction=function(t){var e=t[0].parent;if(e.is_group("product")&&e.children.some(function(t){return t.children[1].is_group("fraction")})){return e}else{return false}};e.nodesAreInAFraction=function(t){var e=t[0].parent;if(e.is_group("fraction")){return e}else{return false}};e.nodeIsCorrectLevelRelativeToTopLevelGroup=function(t,e){return t.parent===e||t.parent.parent.parent===e};e.nodeIsAncestorOfNodes=function(t,e){return e.some(function(e){var i=e;while(!r.is_top_most(i)){if(i===t){return true}i=i.parent}return false})};e.match=function(t,e){var i=this.getBoundTransformation(t,e);if(i){return true}else{return false}};e.prototype.transform=function(t){e.transform.call(this,t)};e.transform=function(t){var i=this.getNewTreeNode(this.nodes)[0],n=this.getNewTreeNode(this.target);this.addTouchedNodes(this.nodes[0]);this.addTouchedNodes(this.target);var r=e.findTopLevelGroupForCanceling([i]);e.performCancel.call(this,i,n);e.cleanStructure.call(this,r);if(typeof t==="function")t(this);else return true};e.performCancel=function(t,e){var i=this.getBoundTransformation(t,e);if(i){i()}else{throw"Failed to find canceling transformation in transform function."}};e.cleanStructure=function(t){var e=false;if(t.is_group("product")){t.children.forEach(function(t){if(t.children[1].is_group("fraction")){e=this.cleanup_cascade(t.children[1])}},this)}if(!e){this.cleanup_cascade(t)}};e.prototype.getBoundTransformation=function(t,e){var i=this;var n=t.is_group("mul")?t:e,r=e.is_group("div")?e:t;var o=s.is_num(n.children[1]),a=s.is_num(r.children[1]),h=o&&!this.numberContainsDecimalTerm(n.children[1]),l=a&&!this.numberContainsDecimalTerm(r.children[1]);if(a&&(s.get_value(r.children[1])===0||s.get_value(r.children[1])===-0)){return false}if(n.children[1].to_ascii()===r.children[1].to_ascii()){return function(){i.cancelTerms(n,r)}}if(l&&s.get_value(r.children[1])===1){return function(){i.removeDivOne(n,r)}}if(l&&s.get_value(r.children[1])===-1){return function(){i.applyNegativeToMulNum(n,r)}}if(this.termIsNegativeXOfX(n.children[1],r.children[1])){return function(){i.cancelTermsAndReplaceMulDiv1NumWithNegativeOne(n,r)}}if(this.termIsNegativeXOfX(r.children[1],n.children[1])){return function(){i.cancelTermsAndReplaceMulDiv1NumWithNegativeOne(r,n)}}if(h&&l&&this.termsAreMultiples(n,r)){return function(){i.factorizeTerms(n,r)}}if(this.bothTermsAreNegative(n,r)){return function(){i.extractSigns(n,r)}}return false};e.prototype.cancelTerms=function(t,e){var i=this;this.getOldTreeNode(t).for_each(function(e){i.updateNodeMap(e,t.parent)});this.getOldTreeNode(e).for_each(function(t){i.updateNodeMap(t,e.parent)});t.remove();e.remove()};e.prototype.removeDivOne=function(t,e){var i=this.getOldTreeNode(e);e.remove();this.updateNodeMap(i,t);this.updateNodeMap(i.children[0],t.children[0]);this.updateNodeMap(i.children[1].get_mapping_to(t.children[1]))};e.prototype.applyNegativeToMulNum=function(t,e){this.updateNodeMap(this.getOldTreeNode(e),t);if(t.children[1].is_group("sign")){t.children[1].replace_with(t.children[1].children[1])}else{var i=e.children[1];i.remove();i.children[1].remove();var n=t.children[1];n.remove();t.append(i);i.append(n)}e.remove()};e.prototype.termIsNegativeXOfX=function(t,e){return t.is_group("sign")&&t.children[1].to_ascii()===e.to_ascii()};e.prototype.cancelTermsAndReplaceMulDiv1NumWithNegativeOne=function(t,e){var i=t.children[1].children[1],n=e.children[1],r=new s(1);this.updateNodeMap(this.getOldTreeNode(e),t);this.updateNodeMap(this.getOldTreeNode(n).get_mapping_to(r));this.updateNodeMap(this.getOldTreeNode(i).get_mapping_to(r));i.replace_with(r);e.remove()};e.prototype.termsAreMultiples=function(t,e){var i=t.get_root();var n=i.numeric_value(t.children[1]),r=i.numeric_value(e.children[1]);if(!n||!r)return false;if(this.val1IsAMultipleOfVal2(n,r))return true;if(this.val1IsAMultipleOfVal2(r,n))return true;if(this.getGCD(n,r)!==1)return true;return false};e.prototype.factorizeTerms=function(t,e){var i=t.get_root();var n=i.numeric_value(t.children[1]),r=i.numeric_value(e.children[1]);if(!n||!r)return false;var o=this.getOldTreeNode(t),s=this.getOldTreeNode(e);var a=this.relativePositionOfMulWithRespectToDiv(t,e);if(this.val1IsAMultipleOfVal2(n,r)){var h=a==="left"?this.splitIntoFactors(t,o,Math.floor(n/r),r)[1]:this.splitIntoFactors(t,o,r,Math.floor(n/r))[0];e.update_x_during_dragging=true;e.update_y_during_dragging=true;if(this.nodes[0].is_group("mul")){this.setNodesToReselectAfterAction(h)}}else if(this.val1IsAMultipleOfVal2(r,n)){var h=a==="left"?this.splitIntoFactors(e,s,n,Math.floor(r/n))[0]:this.splitIntoFactors(e,s,Math.floor(r/n),n)[1];t.update_y_during_dragging=true;t.update_x_during_dragging=true;if(this.nodes[0].is_group("div")){this.setNodesToReselectAfterAction(h)}}else{var l=this.getGCD(n,r);var d,u;switch(a){case"left":d=this.splitIntoFactors(t,o,Math.floor(n/l),l)[1];u=this.splitIntoFactors(e,s,l,Math.floor(r/l))[0];break;case"same":d=this.splitIntoFactors(t,o,Math.floor(n/l),l)[1];u=this.splitIntoFactors(e,s,Math.floor(r/l),l)[1];break;case"right":d=this.splitIntoFactors(t,o,l,Math.floor(n/l))[0];u=this.splitIntoFactors(e,s,Math.floor(r/l),l)[1];break}var c;if(this.target.is_group("mul"))c=u;else c=d;this.setNodesToReselectAfterAction(c)}};e.prototype.relativePositionOfMulWithRespectToDiv=function(t,e){if(t.parent===e.parent){var i=t.parent.get_top(),n=t.parent.get_bottom();return this.positionComparison(i.indexOf(t),n.indexOf(e))}var r,o;if(t.parent.is_group("product")){r=t}else{r=t.parent.parent}o=e.parent.parent;var s=r.parent;return this.positionComparison(s.children.indexOf(r),s.children.indexOf(o))};e.prototype.positionComparison=function(t,e){var i=t-e;if(i<0)return"left";else if(i===0)return"same";else return"right"};e.prototype.splitIntoFactors=function(e,i,n,r){var o=new _(isNaN(n)?t.clone(e.children[1].children[1]):new s(n),e.value),a=new _(isNaN(r)?t.clone(e.children[1].children[1]):new s(r),e.value);this.updateNodeMap(i.get_mapping_to(o));this.extendNodeMap(i.get_mapping_to(a));var h=e.remove();e.parent.insert(h,a);e.parent.insert(h,o);o.update_x_during_dragging=true;o.update_y_during_dragging=true;a.update_x_during_dragging=true;a.update_y_during_dragging=true;return[o,a]};e.prototype.bothTermsAreNegative=function(t,e){return t.children[1].is_group("sign")&&e.children[1].is_group("sign")};e.prototype.extractSigns=function(t,e){var i=t.get_root();var n=this.getOldTreeNode(t),r=this.getOldTreeNode(e);var o=this.splitIntoFactors(t,n,i.numeric_value(t.children[1])/-1,-1)[1],s=this.splitIntoFactors(e,r,i.numeric_value(e.children[1])/-1,-1)[1];if(this.nodes[0].is_group("mul")){this.setNodesToReselectAfterAction(o)}else{this.setNodesToReselectAfterAction(s)}};e.prototype.val1IsAMultipleOfVal2=function(t,e){return Math.abs(t)>=Math.abs(e)&&Math.abs(e)!==1&&t%e===0};e.prototype.getGCD=function(t,e){if(t<0)t=-t;if(e<0)e=-e;if(e>t){var i=t;t=e;e=i}while(true){t%=e;if(t==0)return e;e%=t;if(e==0)return t}};e.prototype.numberContainsDecimalTerm=function(t){return s.get_value(t)!==Math.floor(s.get_value(t))};return new e}();r.prototype.move_actions.push(gmath.actions.FractionCancelTermsAction);gmath.actions.FractionCancelPowersAction=function(){var e=function(t){Action.call(this,"FractionCancelPowersAction","cancel powers in a fraction");this.triggerType="drag";this.settings={delay:400,side:"inside"};if(t){this.nodes=t.nodes;this.target=t.target}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){return gmath.actions.FractionCancelTermsAction.getAllAvailableActions.call(this,t)};e.prototype.transform=function(t){gmath.actions.FractionCancelTermsAction.transform.call(this,t)};e.prototype.getBoundTransformation=function(t,e){var i=this;var n=t.is_group("mul")?t:e,r=e.is_group("div")?e:t;if(!n.children[1].is_group("power")&&!r.children[1].is_group("power"))return false;if(this.termsHaveTheSameBase(n.children[1],r.children[1])){return function(){i.factorizePowers(n,r)}}};e.prototype.termsHaveTheSameBase=function(t,e){var i=t.is_group("power")?t.children[0]:t,n=e.is_group("power")?e.children[0]:e;return i.to_ascii()===n.to_ascii()};e.prototype.factorizePowers=function(t,e){var i=this.nodes[0].is_group("mul")?t:e,n=this.target.is_group("mul")?t:e;i.update_x_during_dragging=true;i.update_y_during_dragging=true;var r=i.children[1],o=n.children[1];var a=this.getOldExponentTermFromPower(o),h=this.getOldExponentTermFromPower(r);var l=r.is_group("power");var d=this.sourceIsLeftOfTarget(i,n);if(!r.is_group("power")){r=this.reinterpretTermAsPower(r)}if(!o.is_group("power")){o=this.reinterpretTermAsPower(o)}var u=r.children[1].children[0],c=o.children[1].children[0];if(u.is_group("brackets"))u=u.children[1];if(c.is_group("brackets"))c=c.children[1];this.modifyTargetExponentByExponent(a,c,h,u);var p=this.insertNewPowerNextToTarget(n,r,h,u,d);if(!l){r.replace_with(r.children[0]);p.replace_with(p.children[0])}if(s.is_num(o.children[1].children[0])&&s.get_value(o.children[1].children[0])===1){o.replace_with(o.children[0])}};e.prototype.sourceIsLeftOfTarget=function(t,e){if(t.parent===e.parent)return true;var i,n;i=t.parent.is_group("product")?t:t.parent.parent;n=e.parent.is_group("product")?e:e.parent.parent;var r=i.parent;return r.children.indexOf(i)<=r.children.indexOf(n)};e.prototype.getOldExponentTermFromPower=function(t){if(!t.is_group("power")){return null}var e=this.getOldTreeNode(t);var i=e.children[1].children[0];if(i.is_group("brackets")){i=i.children[1]}return i};e.prototype.reinterpretTermAsPower=function(t){var e=t.parent,i=t.remove();var n=y.prototype.createGroup();n.append(t);n.append(new y(new s(1)));this.updateNodeMap(t,n);e.insert(i,n);return n};e.prototype.modifyTargetExponentByExponent=function(t,e,i,n){if(!s.is_num(e)||!s.is_num(n)){this.convertTargetExponentIntoSum(e,i,n)}else{this.subtractExponentValues(t,e,i,n)}};e.prototype.convertTargetExponentIntoSum=function(t,e,i){var n=t.parent,r=t.remove();var o=g.prototype.createGroup();o.append(new g(t));o.append(new g(i.clone(),"sub"));n.insert(r,o);this.cleanup(o.children[1]);this.cleanup(o.children[0]);u.handle(o);if(e&&e.is_group("sum")){for(var s=0;s<e.children.length;s++){this.extendNodeMap(e.children[e.children.length-s-1].get_mapping_to(o.children[o.children.length-s-1]))}}else if(e){this.extendNodeMap(e.get_mapping_to(o.children[o.children.length-1].children[1]))}};e.prototype.subtractExponentValues=function(t,e,i,n){var r=e.replace_with(new s(s.get_value(e)-s.get_value(n)));if(t){this.extendNodeMap(t.get_mapping_to(r))}if(i){this.extendNodeMap(i.get_mapping_to(r))}};e.prototype.insertNewPowerNextToTarget=function(e,i,n,r,o){var s=new m(t.clone(i.children[0]),t.clone(r));u.handle(s.children[1].children[0]);this.extendNodeMap(this.getOldTreeNode(e.children[1]),s);this.extendNodeMap((this.target.children[1].is_group("power")?this.target.children[1].children[0]:this.target.children[1]).get_mapping_to(s.children[0]));if(n){this.extendNodeMap(n.get_mapping_to(s.children[1].children[0].is_group("brackets")?s.children[1].children[0].children[1]:s.children[1].children[0]))}var a=o?e.parent.children.indexOf(e):e.parent.children.indexOf(e)+1;e.parent.insert(a,new _(s,e.value));
return s};e.prototype.removeExponentOfOne=function(t){t.replace_with(t.children[0])};return new e}();r.prototype.move_actions.push(gmath.actions.FractionCancelPowersAction);gmath.actions.FractionMagSimplificationAction=function(){var t=function(t){Action.call(this,"FractionMagSimplificationAction","cancel numerator and denominator");this.priority=0;this.triggerType="tap";if(t)this.actor=t.actor};gmath.inherit(Action,t);t.prototype.match=function(t){if(!t.is_group("fraction"))return false;var e=t.get_top();var i=t.get_bottom();if(e.length!==1||i.length!==1)return false;e=e[0],i=i[0];var n=s.get_value(e.children[1]),r=s.get_value(i.children[1]);return s.is_num(e.children[1])&&s.is_num(i.children[1])&&r!==0&&(!gmath.options.actions.only_integer_division||(n===r||r<n&&n%r===0||n===0))};t.prototype.transform=function(t){var e=this.getNewTreeNode(this.actor);var i=e.parent;this.addTouchedNodes(this.actor);var n=e.get_top();var r=e.get_bottom();n=n[0],r=r[0];var o=s.get_value(n.children[1])/s.get_value(r.children[1]);var a=new s(o);if(n.children[1]instanceof p||r.children[1]instanceof p){this.updateNodeMap(this.actor.children[0].children[1].get_mapping_to(a));this.updateNodeMap(this.actor.children[2].children[1].get_mapping_to(a))}else{this.updateNodeMap(this.actor.get_mapping_to(a))}var h=e.remove();i.insert(h,a);if(typeof t==="function")t(this);else return true};v.prototype.add_action_handler(new t);return new t}();gmath.actions.ReorderSumInFractionDenominatorAction=function(){var t=function(t){Action.call(this,"ReorderSumInFractionDenominatorAction","reorder sum in a fraction's denominator");this.priority=2;this.triggerType="dbltap";if(t)this.actor=t.actor};gmath.inherit(Action,t);t.prototype.match=function(t){if(!t)return false;if(!t.is_group("add","sub"))return false;if(!t.ls)return false;var e=t.ls;if(!e.children[1].is_group("fraction")||!t.children[1].is_group("fraction"))return false;return this.denominatorsHaveMatchingSums(e.children[1],t.children[1])};t.prototype.denominatorsHaveMatchingSums=function(t,e){var i=t.get_bottom(),n=e.get_bottom();if(i.length!==1||n.length!==1)return false;if(!i[0].children[1].is_group("brackets")||!i[0].children[1].children[0].hidden||!i[0].children[1].children[1].is_group("sum"))return false;if(!n[0].children[1].is_group("brackets")||!n[0].children[1].children[0].hidden||!n[0].children[1].children[1].is_group("sum"))return false;var r=i[0].children[1].children[1],o=n[0].children[1].children[1];if(r.to_ascii()===o.to_ascii())return false;var s=function(t){return t.to_ascii()};return gmath.array.isPermutation(r.children.map(s),o.children.map(s))};t.prototype.transform=function(t){this.addTouchedNodes(this.actor);this.addTouchedNodes(this.actor.ls);var e=this.getNewTreeNode(this.actor.ls).children[1],i=this.getNewTreeNode(this.actor).children[1];this.sortDenominatorsToMatch(e,i);if(typeof t==="function")t(this);else return true};t.prototype.sortDenominatorsToMatch=function(t,e){var i=t.get_bottom()[0].children[1].children[1],n=e.get_bottom()[0].children[1].children[1],r=i.children.slice(),o=n.children.slice();for(var s=0;s<r.length;s++){if(r[s].to_ascii()!==o[s].to_ascii()){for(var a=s;a<o.length;a++){if(r[s].to_ascii()===o[a].to_ascii()){var h=o[a];h.remove();n.insert(s,h);o=n.children.slice()}}}}};g.prototype.add_action_handler(new t);return new t}();gmath.actions.CrossMultiplyFractionsAction=function(){var e=function(t){Action.call(this,"CrossMultiplyFractionsAction","cross multiply fractions");this.priority=1;this.triggerType="dbltap";if(t)this.actor=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){if(!t)return false;if(!t.is_group("add","sub"))return false;if(!t.ls)return false;var e=t.ls;return e.children[1].is_group("fraction")&&t.children[1].is_group("fraction")};e.prototype.transform=function(e){this.addTouchedNodes(this.actor);this.addTouchedNodes(this.actor.ls);var i=this.getNewTreeNode(this.actor.ls).children[1],n=this.getNewTreeNode(this.actor).children[1];var r=this.getUncommonDenominatorFactors(i,n),o=this.getUncommonDenominatorFactors(this.actor.ls.children[1],this.actor.children[1]);r.leftUncommonFactors.forEach(t.remove);r.rightUncommonFactors.forEach(t.remove);this.sortDenominatorsToMatch(i,n);if(r.leftUncommonFactors.length>0){var s=this.extendFractionWithFactors(i,r.leftUncommonFactors);var a=this.extendFractionWithFactors(n,r.leftUncommonFactors,true,true);this.mapOldFactorsToNewFactors(o.leftUncommonFactors,s,a)}if(r.rightUncommonFactors.length>0){var h=this.extendFractionWithFactors(i,r.rightUncommonFactors,true);var l=this.extendFractionWithFactors(n,r.rightUncommonFactors);this.mapOldFactorsToNewFactors(o.rightUncommonFactors,h,l)}if(typeof e==="function")e(this);else return true};e.prototype.getUncommonDenominatorFactors=function(t,e){var i=t.get_bottom().slice(),n=e.get_bottom().slice();for(var r=0;r<i.length;){var o=i[r];var s=false;for(var a=0;a<n.length;a++){var h=n[a];if(o.to_ascii()===h.to_ascii()){n.splice(a,1);s=true;break}}if(s){i.splice(r,1)}else{r++}}return{leftUncommonFactors:i,rightUncommonFactors:n}};e.prototype.sortDenominatorsToMatch=function(t,e){var i=t.get_bottom().slice(),n=e.get_bottom().slice();for(var r=0;r<i.length;r++){if(i[r].to_ascii()!==n[r].to_ascii()){for(var o=r;o<n.length;o++){if(i[r].to_ascii()===n[o].to_ascii()){var s=n[o];s.remove();e.insert(e.get_top().length+r+1,s);n=e.get_bottom().slice();break}}}}};e.prototype.extendFractionWithFactors=function(t,e,i,n){var r=[];if(i&&t.get_top().length===1&&s.is_num(t.children[0].children[1])&&s.get_value(t.children[0].children[1])===1){t.children[0].remove()}e.forEach(function(o){var s=[];var a=o.clone();s.push(a);t.append(a);if(i){a=o.clone();a.invert();s.push(a);n?t.insert(e.indexOf(o),a):t.append(a)}r.push(s)});return r};e.prototype.mapOldFactorsToNewFactors=function(t,e,i){for(var n=0;n<t.length;n++){var r=t[n];var o=e[n].concat(i[n]);for(var s=0;s<o.length;s++){this.extendNodeMap(r.get_mapping_to(o[s]))}}};g.prototype.add_action_handler(new e);return new e}();(function(){var e=function(t){Action.call(this,"ProductFractionCleanup","product-fraction cleanup action");if(t)this.actor=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){var e=t.get_top().length,i=t.get_bottom().length;if(e===0&&i===0)return true;if(t.value==="product"&&i>0)return true;if(t.value==="fraction"&&i===0)return true;if(t.value==="fraction"&&e===0)return true;if(e===1&&i===0)return true;return false};e.prototype.doInPlace=function(e){this.initNodeMap();var i=this.getNewTreeNode(this.actor);var n=this.actor;var r=i.get_top().length,o=i.get_bottom().length,h;var l;if(r===0&&o===0){var d=new s(1);h=t.get_mapping_between(this.actor,d);this.updateNodeMap(h);t.replace(i,d);if(d.parent.is_group("brackets"))u.handle(d.parent,true);l=true}if(!l&&n.value==="product"&&o>0){i.invert()}if(!l&&n.value==="fraction"&&o===0){i.invert()}if(n.value==="fraction"&&r===0){if(!(n.children[0]instanceof a))t.insert(i,0,new a("//"));t.insert(i,0,new _(new s(1)))}if(r===1&&o===0){var c=i.get_top()[0].children[1];this.updateNodeMap(n,c);this.updateNodeMap(n.children[0],c);this.updateNodeMap(n.children[0].children[0],c);t.replace(i,c);if(c.parent.is_group("brackets"))u.handle(c.parent,true);else{if(c.is_group("brackets"))var p=c.children[1];var f=u.handle(c,true);if(p&&f==="removed"){this.updateNodeMap(n,p);this.updateNodeMap(n.children[0],p);this.updateNodeMap(n.children[0].children[0],p)}}}if(typeof e==="function")e(this);else return this};v.prototype.cleanupAction=new e})();gmath.actions.SplitExponentsAction=function(){var e=function(t){Action.call(this,"SplitExponentsAction","split exponents");this.triggerType="drag";this.settings={};if(t){this.nodes=t.nodes;this.target=t.target;this.settings.side=t.side}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){if(!this.match(t[0]))return[];if(t.length===t[0].parent.children.length)return[];var e=t[0].get_root(),i=t[0].parent.parent.parent.parent;return[this.createBoundAction(e,{nodes:t,target:i,side:"left-of"}),this.createBoundAction(e,{nodes:t,target:i,side:"right-of"})]};e.prototype.match=function(t){try{var e=(t.is_group("add")||t.is_group("sub"))&&t.parent.parent.parent.is_group("exponent");return e}catch(i){return false}};e.prototype.transform=function(t){this.addTouchedNodes(this.target);var e=this.getNewTreeNode(this.nodes),i=this.getNewTreeNode(this.target);var n;if(e[0].parent.children.indexOf(this.nodes[0])===0){n=e[0].parent.children[e.length].children[0]}else{n=e[0].parent.children[0].children[0]}var r=i,o=r.parent;var s=r.remove();this.extractNodesFromPowerExponentSum(e);var a=this.createSplittedOffPower(e);var h=this.placePowersIntoProduct(r,a);var l=this.nodes[0].children[0];this.extendNodeMap(l,a.parent.children[0]);this.extendNodeMap(n,r.parent.children[0]);for(var d=0;d<this.nodes.length;d++){this.updateNodeMap(this.nodes[d],a.parent)}if(o.is_group("mul")||o.is_group("div")){this.extendNodeMap(this.getOldTreeNode(o.children[0]),a.parent.children[0])}o.insert(s,h);this.cleanup(h.children[0].children[1].children[1].children[0].children[1]);this.cleanup(h.children[1].children[1].children[1].children[0].children[1]);u.handle(h.children[0].children[1].children[1].children[0],true);u.handle(h.children[1].children[1].children[1].children[0],true);this.cleanup(o);a.children[1].simplify=true;if(typeof t==="function")t(this);else return true};e.prototype.extractNodesFromPowerExponentSum=function(e){t.remove_range(e)};e.prototype.createSplittedOffPower=function(e){var i=this.target.children[0];var n=y.prototype.createGroup(),r=t.clone(i);this.extendNodeMap(i,r);n.append(r);var o=g.prototype.createGroup();o.append_range(e);var s=new y(o);n.append(s);return n};e.prototype.placePowersIntoProduct=function(t,e){var i=_.prototype.createGroup();var n=this.settings.side;i.append(new _(t));var r=new _(e);if(n==="left-of")i.insert(0,r);else i.append(r);return i};return new e}();r.prototype.move_actions.push(gmath.actions.SplitExponentsAction);SplitNumberAction=function(){var t=function(t){Action.call(this,"SplitNumberAction","n => (n-1) + 1");this.priority=0;this.triggerType="split";if(t)this.actor=t.actor};gmath.inherit(Action,t);t.prototype.match=function(t){return t instanceof s&&t.value>1};t.prototype.transform=function(t){var e=this.getNewTreeNode(this.actor);this.addTouchedNodes(this.actor);var i=e.parent;var n=e.remove();e.value--;var r=g.prototype.createGroup();r.append(new g(e));r.append(new g(new s(1)));this.resultNodes=r.children.slice();this.updateNodeMap(this.actor.get_mapping_to(r));i.insert(n,r);u.handle(r);this.cleanup(i);if(typeof t==="function")t(this);return true};return new t}();SplitProductAction=function(){var e=function(t){Action.call(this,"SplitProductAction","n*x => (n-1)*x + x");this.priority=1;this.triggerType="split";if(t){this.actor=t.actor;if("priority"in t)this.priority=t.priority}};gmath.inherit(Action,e);e.prototype.match=function(t){return t.is_group("mul")&&t.children[1]instanceof s&&t.children[1].value>1&&t.rs};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.actor),n=i.parent,r=i.children[1];this.addTouchedNodes(this.actor);r.value--;var o=n.children.slice(n.children.indexOf(i));var s=this.getOldTreeNode(o);var a=t.remove_range(o);var h=g.prototype.createGroup();var l=_.prototype.createGroup();var d=_.prototype.createGroup();var u;if(r.value===1){i.remove();o=o.slice(1);l.insert_range(0,o);u=t.clone(o);d.insert_range(0,u);this.extendNodeMap(t.get_mapping_between(s.slice(1),u))}else{l.insert_range(0,o);u=t.clone(o);d.insert_range(0,u);d.children[0].remove();this.extendNodeMap(t.get_mapping_between(s,u))}h.append(new g(l));h.append(new g(d));var c=new _(h);n.insert(a,c);this.cleanup(l);this.cleanup(d);var p=n.parent;if(this.cleanup(n))this.cleanup(p);if(typeof e==="function")e(this);return true};e.prototype.mapIndex=function(){map={};return function(t){return map[t]}};return new e}();SplitPowerAction=function(){var e=function(t){Action.call(this,"SplitPowerAction","x^n => x^(n-1) * x");this.priority=2;this.triggerType="split";if(t){this.actor=t.actor;if("priority"in t)this.priority=t.priority}};gmath.inherit(Action,e);e.prototype.match=function(t){return t.is_group("exponent")&&t.children[0]instanceof s&&t.children[0].value>=1};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.actor),n=i.parent,r=n.parent;this.addTouchedNodes(this.actor);var o=n.remove();var s=_.prototype.createGroup();s.append(new _(n));var a=t.clone(n.children[0]);this.extendNodeMap(this.actor.parent.children[0].get_mapping_to(a));s.append(new _(a));var h=i.children[0];h.value--;this.extendNodeMap(this.actor.children[0],a.parent);if(h.value===1){var l=n.children[0];n.remove();s.children[0].append(l);this.extendNodeMap(this.actor.children[0],l.parent)}else if(h.value===0){s.children[0].remove()}this.resultNodes=s.children.slice();r.insert(o,s);this.cleanup(r);if(typeof e==="function")e(this);return true};return new e}();SplitPowerSumAction=function(){var e=function(t){Action.call(this,"SplitPowerSumAction","x^(n1+n2+...+nm) => x^(n1+n2+...) * x^(nm)");this.priority=3;this.triggerType="split";if(t)this.actor=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){return t.is_group("exponent")&&(t.children[0].is_group("brackets")&&t.children[0].children[1].is_group("sum")||t.children[0].is_group("sum"))};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.actor),n=i.parent,r=n.parent,o=i.children[0];if(o.is_group("brackets"))o=o.children[1];var s=o.children[o.children.length-1],a=this.getOldTreeNode(s.children[0]);this.addTouchedNodes(this.actor.parent);var h=n.remove();var l=_.prototype.createGroup();l.append(new _(n));var d=t.clone(n);l.append(new _(d));d.children[1].children[0].remove();s.remove();var u=s.createGroup();u.append(s);d.children[1].append(u);r.insert(h,l);if(a.parent.is_group("add"))this.updateNodeMap(a,l.children[1].children[0]);else this.extendNodeMap(a,l.children[1].children[0]);this.cleanup(s.parent);this.cleanup(o);this.cleanup(r);if(typeof e==="function")e(this);return true};return new e}();gmath.actions.DistributeIntoBracketsAction=function(){var e=function(t){Action.call(this,"DistributeIntoBracketsAction","distribute");this.triggerType="drag";this.settings={side:"around"};this.priority=2;if(t){this.nodes=t.nodes;this.target=t.target}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){var e=[];if(t.length===0)return e;var i=t[0].get_root();if(!t[0].is_group("mul")&&!t[0].is_group("div"))return[];var n=this;function r(r){if(r.children[1]&&r.children[1].is_group("brackets")){o=r.children[1].children[1];if(n.match(t,o,"around"))e.push(n.createBoundAction(i,{nodes:t,target:o}))}}var o=t[0];while(o=o.ls)r(o);o=t[t.length-1];while(o=o.rs)r(o);return e};e.prototype.match=function(t,e,i){if(t.length===0)return false;if(e.value==="("||e.value===")")return false;var n=e.parent;if(!n.parent)return false;var r=n.parent.value;if(r!=="mul"&&r!=="div")return false;for(var o=0;o<t.length;o++)if(t[o].value!==r)return false;if(n.parent.parent!==t[0].parent)return false;if(!n.is_group("brackets"))return false;if(!n.children[1].is_group("sum"))return false;if(!t[0].commutative)return false;if(i==="left-of"&&n.ls===t[t.length-1])return false;if(i==="right-of"&&n.rs===t[0])return false;return true};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.nodes);var n=this.getNewTreeNode(this.target);var r=this.target.parent.children[0],o=this.target.parent.children[2];var s=n.parent;var a;if(i[i.length-1].rs&&i[i.length-1].rs.children[1]&&i[i.length-1].rs.children[1]===s){a="left"}if(i[0].ls&&i[0].ls.children[1]===s){a="right"}var h=s.parent.parent,l=s.children[1];t.remove_range(i);this.distributeIntoSum(l,i,a);if(h.cleanupAction)this.cleanup(h);var d=l.parent;if(!d.is_group("brackets")||d.is_group("brackets")&&d.parent.is_group("mul","div")&&d.parent.parent.is_group("fraction")&&(d.parent.is_group("mul")?d.parent.parent.get_top().length===1:d.parent.parent.get_bottom().length===1)){var c=l.remove();var p=new u(l);t.insert(d,c,p);this.updateNodeMap(r.parent,p);this.updateNodeMap(r,p.children[0]);this.updateNodeMap(o,p.children[2]);p.simplify=true}if(typeof e==="function")e(this);else return true};e.prototype.distributeIntoSum=function(e,i,n){var r=e.children.length;var o=function(t){if(t.is_group("div"))t.invert()};for(var a=0;a<r;a++){var h=e.children[a].children[1],l,d;h.remove();if(h.is_group("product"))l=h;else{l=new v;l.append(new _(h))}if(n==="left"&&a===0||n==="right"&&a===r-1){d=i}else d=t.clone(i);d.forEach(o);this.extendNodeMap(t.get_mapping_between(this.nodes,d));{var u=n==="left"?1:l.children.length-1;if(l.children[u])l.children[u].simplify=true}var c=n==="left"?0:l.children.length;l.insert_range(c,d);e.children[a].append(l);if(m(i)&&(f(i)||g(l))){l.children.forEach(function(t){t.simplify=false});l.simplify=true}for(var p=0;p<d.length;p++){t.for_each(function(t){t.update_x_during_dragging=true;t.update_y_during_dragging=false},d[p])}}function f(t){return t.some(function(t){return t.is_group("mul")&&s.is_num(t.children[1])})}function g(t){return t.children.some(function(t){return t.is_group("mul")&&s.is_num(t.children[1])&&s.get_value(t.children[1])===0})}function m(t){return!t.some(function(t){return t.is_group("mul")&&s.get_value(t.children[1])===0})}};return new e}();r.prototype.move_actions.push(gmath.actions.DistributeIntoBracketsAction);gmath.actions.FactorOutOfBracketsAction=function(){var e=function(t){Action.call(this,"FactorOutOfBracketsAction","factor out");this.priority=0;this.triggerType="drag";this.settings={};if(t){this.nodes=t.nodes;this.target=t.target;this.settings.side=t.side}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){if(t.length===0)return[];var e=[],i=t[0];while(i.parent&&!i.is_group("brackets"))i=i.parent;if(this.match(t)){e.push(this.bindLeftSideAction(i,t));e.push(this.bindRightSideAction(i,t))}return e};e.prototype.nodesAreAllAddends=function(t,e){if(!t.is_group("sum"))return false;return t.children.length===e.length};e.prototype.bindLeftSideAction=function(t,e){var i=e[0].get_root();return this.createBoundAction(i,{nodes:e,target:t.children[0],side:"left-of"})};e.prototype.bindRightSideAction=function(t,e){var i=e[0].get_root();return this.createBoundAction(i,{nodes:e,target:t.children[2],side:"right-of"})};e.prototype.getContainingBrackets=function(t){try{var e=null;for(var i=0;i<t.length;i++){var n=t[i][0];var r=n.is_group("mul")?n.get_parent(4):n.get_parent(3);if(!r||!r.is_group("brackets")||r.children[0].hidden)return null;if(!e)e=r;else if(e!==r)return null}return e}catch(o){return null}};e.prototype.match=function(e,i){var n=r.groupNodeRanges(e);var o=this.getContainingBrackets(n);if(!o)return false;if(i&&!(o.children[0]===i||o.children[2]===i))return false;if(!this.nodesAreAllAddends(o.children[1],n))return false;var s=n[0].length;n.forEach(function(t){if(t.length!==s)return false});for(var a=0;a<s;a++){var h;if(n[0][a].value==="mul")h=n[0][a].children[1].to_ascii();else h=n[0][a].to_ascii();for(var l=0;l<n.length;l++){var d;if(n[l][a].value==="mul")d=n[l][a].children[1].to_ascii();else d=n[l][a].to_ascii();if(d!==h)return false}}var u=t.get_cca(e);return u.is_group("sum")&&u.parent===o};e.prototype.transform=function(t){var e=this.getNewTreeNode(this.nodes);var i=this.findBracketGroup(e);var n=r.groupNodeRanges(e);var o=n.map(this.getOldTreeNode.bind(this));this.removeRangesFromSum(n);var s=this.factor(i,n,o);if(s.is_group("brackets")&&u.is_optional(s)){var a=s.parent;u.handle(s,true);s=a}if(s.cleanupAction)this.cleanup(s);if(typeof t==="function")t(this);else return true};e.prototype.findBracketGroup=function(t){var e=t[0];if(e&&e.parent&&e.parent.parent&&e.parent.parent.is_group("sum")&&e.parent.parent.parent&&e.parent.parent.parent.is_group("brackets"))return e.parent.parent.parent;if(e&&e.parent&&e.parent.is_group("product")&&e.parent.parent&&e.parent.parent.parent&&e.parent.parent.parent.is_group("sum")&&e.parent.parent.parent.parent&&e.parent.parent.parent.parent.is_group("brackets"))return e.parent.parent.parent.parent;throw"Attempting to factor from invalid structure."};e.prototype.removeRangesFromSum=function(e){for(var i=0;i<e.length;i++){var n=e[i];var r=e[i][0].parent;if(n.length===r.children.length){var o=r.parent;r.remove();t.remove_range(n);o.append(new s(1));this.cleanup(o)}else if(r.value==="add"||r.value==="sub"&&n.length===1){n[0].remove();r.append(new s(1))}else{t.remove_range(e[i]);this.cleanup(r)}}};e.prototype.factor=function(t,e,i){return this.replaceBracketGroupWithFactoredProduct(t,e,i)};e.prototype.replaceBracketGroupWithFactoredProduct=function(e,i,n){var r=_.prototype.createGroup();var o=e.parent;var s=e.remove();var a;var h=this.settings.side;if(h==="left-of"){a=i[0];if(a.length===1&&a[0].value!=="mul"){a=[new _(a[0])]}r.append_range(a);r.append(new _(e));for(var l=0;l<n.length;l++){if(n[l].length===1&&!n[l][0].is_group("mul")){this.updateNodeMap(n[l][0],a[0])}else{this.updateNodeMap(t.get_mapping_between(n[l],a))}}}else{a=i[i.length-1];if(a.length===1&&a[0].value!=="mul"){a=[new _(a[0])]}r.append(new _(e));r.append_range(a);for(var l=0;l<n.length;l++){if(n[l].length===1&&!n[l][0].is_group("mul")){this.updateNodeMap(n[l][0],a[0])}else{this.updateNodeMap(t.get_mapping_between(n[l],a))}}}t.insert(o,s,r);return o};e.prototype.mapIndex=function(){return function(){}};return new e}();r.prototype.move_actions.push(gmath.actions.FactorOutOfBracketsAction);gmath.actions.SubstitutionAction=function(){var e=function(t){Action.call(this,"SubstitutionAction","substitution");this.auto_collapse=true;this.settings={};if(t){this.nodes=t.nodes;this.target=t.target}};gmath.inherit(Action,e);e.prototype.rebind=function(t,e,i){if(this.nodes[0]===i){this.nodes[0]=t}else if(this.oldTree===i){var n=new Action;n.node_map=e;this.oldTree=t;this.target=n.mapNodes(this.target)}else throw"wrong old tree during rebinding an action!"};e.prototype.getAllAvailableActions=function(t,e){var i=this.findAllMatches(t,e);var n=[];for(var r=0;r<i.length;r++){var o=gmath.actions.SubstitutionAction.createBoundAction(e,{nodes:[t],target:i[r]});n.push(o)}return n};e.prototype.match=function(t,e){if(e.length===0||e[0].fixed)return false;if(!t.parent)t=t.children[0];if(!t.is_group("equals"))return false;var i=t.children[0].to_ascii();var n=d(i);return n(e)};e.prototype.rematch=function(){if(!(this.nodes&&this.nodes.length>0&&this.target&&this.target.length>0))return false;var t=[];this.target.forEach(function(e){var i=this.getAllAvailableActions(this.nodes[0],e.get_root());i.forEach(function(e){t=t.concat(e.target)})},this);return this.target.every(function(e){return t.indexOf(e)!==-1})};function i(t){if(t.length===1&&(t[0].hidden||t[0].is_group("tuple")))return"";return t.map(function(t){return t.to_ascii()}).join("")}function n(t){return t.is_group()&&t.commutative&&t.associative}function o(t){if(t.length===0)return"";if(t.length===1&&(t[0].hidden||t[0].is_group("tuple")))return"";var e=t.map(function(t){return t.to_ascii()}).join("");if(t.length===1)return e;if(n(t[0]))return e.substring(t[0].children[0].to_ascii().length);return e}function s(t){if(t.length!==1)return"";if(!t[0].is_group("fraction"))return"";var e=t[0].to_ascii();if(e.slice(0,1)==="("&&e.slice(e.length-1,e.length)===")")e=e.substr(1,e.length-2);return e}function a(t){if(t.length<2)return"";if(!t[0].is_group("div"))return"";var e=t.map(function(t){return t.to_ascii()}).join("").replace(/\//g,"*").substr(1);return e}e.prototype.findAllMatches=function(t,e){if(!t.parent)t=t.children[0];if(!t.is_group("equals"))return[];if(!e.parent)e=e.children[0];var i=t.children[0].to_ascii();var n=e.filterRange(d(i));n=n.filter(function(t){return t.length>0&&!t[0].fixed});return n};e.prototype.transform=function(e){var i=this;var n=this.nodes[0].children[0].children[0].to_ascii();var o=this.nodes[0].children[0].children[2];var s=r.groupNodes(this.target,function _(t){return!d(n)(t)});var a=s.map(function(t){return t.map(i.getNewTreeNode.bind(i))});for(var h=0;h<s.length;h++){var l=a[h];var c=l[0].parent;var p=t.remove_range(l);var f=t.clone(o);if(l.length>1){f=new l[0].constructor(f);if(f.is_group("mul")&&l[0].is_group("div"))f.invert()}if(this.sourceIsASignGroupOrHasALeadingNegativeCoefficient(this.nodes[0])&&l[0].is_group("sub")){f=new g(f)}c.insert(p,f);s[h].forEach(function(e){this.updateNodeMap(e,f);this.updateNodeMap(o,f);this.updateNodeMap(t.get_leaf_nodes(e),t.get_leaf_nodes(f));this.updateNodeMap(t.get_leaf_nodes(o),t.get_leaf_nodes(f))},this);if(gmath.actions.AddNegativeAction.match(c)){this.compose(gmath.actions.AddNegativeAction.createAndDoInPlace(this.newTree,{actor:c}),false)}else if(c.parent&&c.parent.parent&&gmath.actions.PlusMinusProductToMinusProductAction.match(c.parent.parent)){this.compose(gmath.actions.PlusMinusProductToMinusProductAction.createAndDoInPlace(this.newTree,{actor:c.parent.parent}),false)}else if(gmath.actions.SignDoubleNegAction.match(c)){this.compose(gmath.actions.SignDoubleNegAction.createAndDoInPlace(this.newTree,{actor:c}),false)}var v=this.cleanup(f);if(!v)u.handle(f);this.cleanup(c)}if(typeof e==="function")e(this);return true};e.prototype.sourceIsASignGroupOrHasALeadingNegativeCoefficient=function(t){var e=t.children[0].children[0];if(e.is_group("sign"))return true;else if(e.is_group("product")&&e.children[0].children[1].is_group("sign"))return true;return false};function h(t){return t[0]&&t[0].parent&&!t[0].parent.is_group("exponent")&&t.length===t[0].parent.children.length}function l(t){return t.parent}function d(t){return function(e){if(e.length===0)return false;if(!e[0].parent)return false;if(l(e[0].parent)&&h(e))return false;return i(e)===t||o(e)===t||s(e)===t||a(e)===t}}return new e}();TriggerFactoringAction=function(){var t=function(t){Action.call(this,"TriggerFactoringAction","general factoring");this.priority=0;this.triggerType="drag";this.settings={side:"around"};if(t){this.DLOfSum=t.dl;this.viewOfSum=t.view;this.target=t.sum;this.callback=t.callback}};gmath.inherit(Action,t);t.prototype.match=function(t,i){return e(t,i)};t.prototype.transform=function(){this.callback(this.viewOfSum,this.target,this.DLOfSum)};var e=function(t,e){var i;i=n(t,e);i=o(i,t);var r=[];for(var s=0;s<i.length;s++){if(i[s].length===0)return false}for(var s=0;s<i.length;s++){if(i[s])r.push(i[s][i[s].length-1])}for(var s=0;s<r.length;s++){if(!Array.isArray(r[s])&&r[s].parent.value!=="add"&&r[s].parent.value!=="sub")r[s]=r[s].parent}return r.length===t.children.length?r:false};var i=function(t,e){var i=[];t.for_each(function(t){var n=t.to_ascii();if(n.slice(0,1)==="*")n=n.substr(1);if(!t.hidden&&n===e)i.push(t);else{var r=[t];while(n.length<e.length&&t.commutative&&t.rs){t=t.rs;n+=t.to_ascii();r.push(t)}if(n===e)i.push(r)}});return i};var n=function(t,e){var n=[];for(var r=0;r<t.children.length;r++){var o=t.children[r],s=o.children[1];n.push(i(s,e.to_ascii()))}return n};function r(t){return function(e){return!e.hidden&&e.to_ascii()===t}}var o=function(t,e){var i=function(t){return t.parent&&(t.parent.value==="add"||t.parent.value==="sub")&&t.parent.parent&&t.parent.parent==e};var n=function(t){return t.parent&&t.parent.value==="mul"&&t.parent.parent&&t.parent.parent.is_group("product")&&t.parent.parent.parent&&t.parent.parent.parent.parent&&t.parent.parent.parent.parent==e};var r=function(t){return t.value==="mul"&&t.parent&&t.parent.is_group("product")&&t.parent.parent&&t.parent.parent.parent&&t.parent.parent.parent==e};var o=function(t){var e=true;if(Array.isArray(t)){for(var o=0;o<t.length;o++)if(!r(t[o]))e=false}else{return i(t)||n(t)}return e};for(var s=0;s<t.length;s++){t[s]=t[s].filter(o)}return t};var a=function(t,e){var i=l(t),n=p(h(i));var r=e.deconstruct();return v(n,r)};var h=function(t){var e=[];for(var i=0;i<t.length;i++){e.push(t[i].slice())}return e};var l=function(t){var e=[];for(var i=0;i<t.children.length;i++){e.push(d(t.children[i]))}return e};var d=function(t){var e=t.children[1];if(t.value==="add")return e.deconstruct();else return c(e.deconstruct())};var u=function(t){t.push(new s(1));return t};var c=function(t){t.push(new s(-1));return t};var p=function(t){var e=t[0].slice();for(var i=0;i<t.length;i++){f(e,t[i])}return e};var f=function(t,e){for(var i=0;i<t.length;){if(g(t[i],e))t.splice(i,1);else i++}};var g=function(t,e){var i=t.to_ascii();var n=true;for(var r=0;r<e.length;){if(i===e[r].to_ascii()){n=false;e.splice(r,1);return n}else{r++}}return n};var v=function(t,e){var i=true;for(var n=0;n<e.length;n++){if(g(e[n],t)){i=false}}return i};return new t}();gmath.actions.showRoundedAction=function(){var t=function(t){Action.call(this,"showRoundedAction","show rounded");this.priority=1;this.triggerType="hold";if(t)this.actor=t.actor};gmath.inherit(Action,t);t.prototype.match=function(t){if(!t.is_group("num"))return false;return t.precision===null||t.decimal_count()>t.precision};t.prototype.transform=function(t){var e=this.getNewTreeNode(this.actor);if(e.precision===null)e.precision=2;else e.precision=null;if(typeof t==="function")t(this);return this};return new t}();gmath.actions.EvalTrigAction=function(){var e=function(t){Action.call(this,"EvalTrigAction","evaluate trig functions");this.priority=0;this.triggerType="tap";this.settings={};if(t){this.actor=t.actor;this.settings.angleType=t.angleType||"rad"}};gmath.inherit(Action,e);e.prototype.match=function(t){if(t.value!=="sin"&&t.value!=="cos"&&t.value!=="tan")return false;return t.children[1]&&t.children[1].is_group("brackets")&&t.children[1].children[1].is_group("tuple")&&s.is_num(t.children[1].children[1].children[0].children[1])};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.actor);this.addTouchedNodes(this.actor);var n=i.evaluate();if(!Number.isNaN(n)&&n!==Infinity&&n!==-Infinity){var r=new s(n);t.replace(i,r);this.updateNodeMap(this.actor,r)}if(typeof e==="function")e(this);return this};L.prototype.add_action_handler(new e);return new e}();gmath.actions.ShakeSplitNegatives=function(){var t=function(t){Action.call(this,"ShakeSplitNegatives","shake a negative term to extract a negative 1");this.priority=1;this.triggerType="drag";this.settings={multi_target:true,current_margin:0,side:"inside",margin:[{y1:-1.2,y2:1.2},{y1:1.2,y2:-1.2},{y1:-1.2,y2:1.2}]};if(t){this.nodes=t.nodes;this.target=t.target}};gmath.inherit(Action,t);t.prototype.getAllAvailableActions=function(t){if(t.length!==1)return[];var e=t[0];if(e.is_group("mul","div"))e=e.children[1];if((e.is_group("sign")||e.is_group("sub"))&&s.get_value(e)!==-1)return this.bindActions(t[0]);else return[]};t.prototype.bindActions=function(t){var e=t.get_root();return[this.createBoundAction(e,{nodes:[t],target:t})]};t.prototype.getMargin=function(){return this.settings.margin[this.settings.current_margin++]};t.prototype.transform=function(t){this.addTouchedNodes(this.target);if(this.target.is_group("mul","div"))this.target=this.target.children[1];var e=this.getNewTreeNode(this.target),i=e.parent,n=e.remove();var r=_.prototype.createGroup();var o=e.children[1];o.remove();var a=new s(-1);this.extendNodeMap(this.target,a);this.updateNodeMap(this.target.children[0],a.children[0]);var h=new _(a);r.append(h);r.append(new _(o));var l=e.is_group("sub")?new g(r):r;i.insert(n,l);this.cleanup_cascade(i);this.setNodesToReselectAfterAction(h);if(typeof t==="function")t(this);return this};return new t}();r.prototype.move_actions.push(gmath.actions.ShakeSplitNegatives);gmath.actions.DragSplitNegatives=function(){var t=function(t){Action.call(this,"DragSplitNegatives","drag a negative sign to the left to extract a negative 1");this.priority=1;this.triggerType="drag";this.settings={delay:1e3,side:"left-of"};if(t){this.nodes=t.nodes;this.target=t.target}};gmath.inherit(Action,t);t.prototype.getAllAvailableActions=function(t){if(t.length!==1)return[];if(!(t[0]instanceof a)||t[0].to_ascii()!=="-")return[];if(s.get_value(t[0].parent.children[1])===1)return[];return this.bindActions(t[0]);
};t.prototype.bindActions=function(t){var e=t.get_root();return[this.createBoundAction(e,{nodes:[t],target:t})]};t.prototype.transform=function(t){this.addTouchedNodes(this.target.parent);var e=this.getNewTreeNode(this.target.parent),i=e.parent,n=e.remove();var r=_.prototype.createGroup();var o=e.children[1];o.remove();var a=new s(-1);this.extendNodeMap(this.target.parent,a);this.updateNodeMap(this.target,a.children[0]);var h=new _(a);r.append(h);r.append(new _(o));var l=e.is_group("sub")?new g(r):r;i.insert(n,l);this.cleanup_cascade(i);this.setNodesToReselectAfterAction(h);if(typeof t==="function")t(this);return this};return new t}();r.prototype.move_actions.push(gmath.actions.DragSplitNegatives);gmath.actions.DragSplitNegatives=function(){var t=function(t){Action.call(this,"DragSplitNegatives","drag a negative sign to the left to extract a negative 1");this.priority=2;this.triggerType="drag";this.settings={makes_no_changes:true,update_node_positions:true,side:"outside",margin:{y1:.4,y2:.4}};if(t){this.nodes=t.nodes;this.target=t.target}};gmath.inherit(Action,t);t.prototype.getAllAvailableActions=function(t){if(t.length!==1)return[];var e=t[0];if(!e.is_group("sym")||e.value!=="-")return[];var i=e.get_root();var n=this.createBoundAction(i,{nodes:[e],target:e});if(e.rs&&e.rs.value===1)n.settings.side="inside";return[n]};t.prototype.transform=function(t){this.addTouchedNodes(this.target.parent);this.setNodesToReselectAfterAction(this.target.parent);if(typeof t==="function")t(this);return this};return new t}();r.prototype.move_actions.push(gmath.actions.DragSplitNegatives);gmath.actions.AssociateIdentityIntoDenominatorAction=function(){var e=function(t){Action.call(this,"AssociateIdentityIntoDenominatorAction","associative property of multiplication--move into fraction");this.priority=0;this.triggerType="drag";this.settings={};if(t){this.nodes=t.nodes;this.target=t.target;this.settings.side=t.side;if(t.margin)this.settings.margin=t.margin}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(e){if(!e.length)return[];var i=[];if(!t.is_range(e))return[];var n=e[0].value;if(n!=="mul"&&n!=="div")return[];if(!e.every(function(t){return t.is_group(n)&&(s.get_value(t.children[1])===-1||s.get_value(t.children[1])===1)}))return[];var r=e[0].parent;var o=e[0].parent.children.indexOf(e[0]),a=e[0].parent.children.indexOf(e[e.length-1]);r.children.forEach(function(t,r){if((r<o||r>a)&&t.value===n&&t.children[1].is_group("fraction"))i=i.concat(this.bindActions(e,t))},this);return i};e.prototype.bindActions=function(t,e){var i=[];var n=e.get_root(),r=e.children[1];var o=r.get_bottom();o.forEach(function(e,r){if(r===0){i.push(this.createBoundAction(n,{nodes:t,target:e,side:"left-of"}))}i.push(this.createBoundAction(n,{nodes:t,target:e,side:"right-of"}))},this);return i};e.prototype.transform=function(e){this.nodes.forEach(function(t){this.addTouchedNodes(t)},this);this.addTouchedNodes(this.target.parent);var i=this.getNewTreeNode(this.nodes),n=this.getNewTreeNode(this.target);var r=n.parent;var o=r.children.indexOf(n);if(this.settings.side==="right-of")o++;t.remove_range(i);i.forEach(function(t){if(t.is_group("mul"))t.invert()});r.insert_range(o,i);this.cleanup(r);this.cleanup(r.parent);if(typeof e==="function")e(this);else return true};return new e}();r.prototype.move_actions.push(gmath.actions.AssociateIdentityIntoDenominatorAction);gmath.actions.AssociateIdentityOutOfDenominatorAction=function(){var e=function(t){Action.call(this,"AssociateIdentityOutOfDenominatorAction","associative property of multiplication--move into fraction");this.priority=0;this.triggerType="drag";this.settings={};if(t){this.nodes=t.nodes;this.target=t.target;this.settings.side=t.side;if(t.margin)this.settings.margin=t.margin}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(e){if(!e.length)return[];if(!t.is_range(e))return[];if(!e.every(function(t){return t.is_group("div")&&(s.get_value(t.children[1])===-1||s.get_value(t.children[1])===1)}))return[];var i=e[0].parent,n=i.get_top(),r=i.get_bottom();if(n.length===1&&r.length===1&&s.get_value(n[0].children[1])===1)return[];return this.bindActions(e)};e.prototype.bindActions=function(t){var e=t[0].get_root(),i=t[0].parent;return[this.createBoundAction(e,{nodes:t,target:i,side:"left-of",margin:{x1:-.25,x2:.25}}),this.createBoundAction(e,{nodes:t,target:i,side:"right-of",margin:{x1:.25,x2:-.25}})]};e.prototype.transform=function(e){this.nodes.forEach(function(t){this.addTouchedNodes(t)},this);var i=this.getNewTreeNode(this.nodes),n=this.getNewTreeNode(this.target);t.remove_range(i);i.forEach(function(t){t.invert()});var r=n.parent,o=n.remove();var s=_.prototype.createGroup();s.append(new _(n));s.insert_range(this.settings.side==="left-of"?0:1,i);r.insert(o,s);this.cleanup(r);if(typeof e==="function")e(this);else return true};return new e}();r.prototype.move_actions.push(gmath.actions.AssociateIdentityOutOfDenominatorAction);gmath.rules=gmath.rules||{};gmath.rules.distributes=function(e,i,n){n=n||"both";var r=e.prototype.value+" "+(n=="both"?"":n+"-")+"distributes over "+i.prototype.value;var o=function(n){var r,s;if(n=="both"){if(!this.is_group(e.prototype.name))return false;return o.call(this,"left")||o.call(this,"right")}else if(n=="left"){r=this;s=this.ls}else if(n=="right"){r=this.ls;s=this}else throw"direction must be left, right or both, not '"+n+"'";if(!(s instanceof e))return;if(!r)return false;var a=r.children[1];if(a.is_group("brackets"))a=a.children[1];if(!a.is_group(i.prototype.group_name))return false;t.remove(s);t.for_each(function(t){t.no_anim=true},s);for(var h=0;h<a.children.length;h++){var d=a.children[h];var c=d.children[1];var p=t.clone(s);if(c instanceof l&&c.children[0]instanceof e){if(n=="left")t.insert(c,0,p);else t.append(c,p)}else{var f=e.prototype.createGroup();t.remove(c);var g=new e(c);t.replace(g.children[0],t.clone(this.children[0]));t.append(f,n=="left"?p:g);t.append(f,n=="left"?g:p);t.append(d,f);u.handle(f)}}r.clean_up();return true};e.prototype.add_action_handler({name:r,run:function(){return o.call(this,n)}})};gmath.rules=gmath.rules||{};gmath.rules.inverse_operation=function(e,i){e.prototype.inverse=i.prototype.value;i.prototype.inverse=e.prototype.value;var n=function(){if(!this.ls)return false;if(this.ls instanceof this.getInverse()&&this.children[1].to_ascii()==this.ls.children[1].to_ascii()){t.remove(this.ls);var i=t.remove(this);t.insert(this.parent,i,new e(t.clone(this.identity_element)));this.parent.clean_up();return true}return false};e.prototype.add_action_handler({name:"inverse elements cancel out each other",run:n});i.prototype.add_action_handler({name:"inverse elements cancel out each other",run:n})};gmath.rules=gmath.rules||{};gmath.rules.identity_element=function(t,e){t.prototype.identity_element=e;var i=e.to_ascii()+" is the identity element of "+t.prototype.value;var n=e.to_ascii();var o=function(t){Action.call(this,"IdAction",i);this.triggerType="tap";this.priority=3;this.settings={delay:250,margin:{x:.1},side:"inside"};if(t){if(t.triggerType==="drag"){this.triggerType=t.triggerType;this.nodes=t.nodes;this.target=t.target}else{this.actor=t.actor}}};gmath.inherit(Action,o);o.prototype.isIdentityElement=function(e){return e instanceof t&&e.children[1].to_ascii()==n};o.prototype.match=function(t,e){if(arguments.length<2)e=t.ls||t.rs;if(t.parent instanceof v&&t.parent.children[1].value==="//"&&t===t.parent.children[0])return false;if(t.parent instanceof v&&t.parent.children[1].value==="//"&&this.isIdentityElement(e)&&!this.isIdentityElement(t)&&t===t.parent.children[2])return false;return this.isIdentityElement(t)||this.isIdentityElement(e)};o.prototype.getSiblings=function(e){return e.parent.children.filter(function(i){return i!==e&&i instanceof t})};o.prototype.getAllAvailableActions=function(e){var i=[];if(e.length!==1)return i;var n=e[0];if(!(n instanceof t))return i;var r=this.getSiblings(n);var o=n.get_root();for(var s=0;s<r.length;s++){if(this.match(n,r[s])){i.push(this.createBoundAction(o,{nodes:e,target:r[s],triggerType:"drag"}))}}return i};o.prototype.transform=function(t){var e=this;var i=this.nodes&&this.nodes[0]||this.actor,n=this.target||this.actor&&(this.actor.ls||this.actor.rs);this.addTouchedNodes(i);this.addTouchedNodes(n);var r,o;if(this.isIdentityElement(i)){r=i;o=n}else{r=n;o=i}o=this.getNewTreeNode(o);this.setNodesToReselectAfterAction(o);r=this.getNewTreeNode(r);r.remove();var s=o.parent.get_path();var a=this.cleanup_cascade(o.parent);if(typeof t==="function")t(this);else return true};gmath.actions.IdAction=new o;t.prototype.add_action_handler(new o);r.prototype.move_actions.push(gmath.actions.IdAction)};gmath.rules=gmath.rules||{};gmath.rules.zero_element=function(t,e){t.prototype.zero_element=e;var i=e.to_ascii();var n=i+" is the zero element of "+t.prototype.value;var o=function(t){Action.call(this,"ZeroAction",n);this.triggerType="tap";this.priority=5;this.settings={delay:250,margin:{x:.1},side:"inside"};if(t){if(t.triggerType==="drag"){this.triggerType=t.triggerType;this.nodes=t.nodes;this.target=t.target;this.priority=1}else{this.actor=t.actor}}};gmath.inherit(Action,o);o.prototype.isZeroElement=function(e){return e instanceof t&&e.children[1].to_ascii()==i};o.prototype.match=function(t,e){if(arguments.length<2)e=t.ls;if(!(t.value==="mul"||t.value===e.value))return false;return this.isZeroElement(t)||this.isZeroElement(e)};o.prototype.getSiblings=function(e){return e.parent.children.filter(function(i){return i!==e&&i instanceof t})};o.prototype.getAllAvailableActions=function(e){var i=[];if(e.length!==1)return i;var n=e[0];if(!(n instanceof t))return i;var r=this.getSiblings(n),o=n.get_root();for(var s=0;s<r.length;s++){if(this.match(n,r[s])){i.push(this.createBoundAction(o,{nodes:e,target:r[s],triggerType:"drag"}))}}return i};o.prototype.transform=function(t){var e=this.nodes&&this.nodes[0]||this.actor,i=this.target||this.actor&&(this.actor.ls||this.actor.rs);this.addTouchedNodes(e);this.addTouchedNodes(i);var n,r;if(this.isZeroElement(e)){n=e;r=i}else{n=i;r=e}var o=n.get_parent(1);n=this.getNewTreeNode(n);if(this.triggerType==="tap"){var s=o.get_top().concat(o.get_bottom()).map(this.getNewTreeNode.bind(this));s.forEach(function(t){if(t!==n)t.remove()})}else{this.getNewTreeNode(r).remove()}if(this.actor&&!this.isZeroElement(this.actor)||this.nodes&&!this.isZeroElement(this.nodes[0])){this.setNodesToReselectAfterAction(n.children[1])}this.cleanup_cascade(n.parent);if(typeof t==="function")t(this);else return true};gmath.actions.ZeroAction=new o;t.prototype.add_action_handler(new o);r.prototype.move_actions.push(gmath.actions.ZeroAction)};gmath.rules=gmath.rules||{};gmath.rules.init_all=function(){gmath.rules.identity_element(g,new s(0));gmath.rules.identity_element(_,new s(1));gmath.rules.zero_element(_,new s(0));gmath.rules.identity_element(x,new w("T"));gmath.rules.zero_element(x,new w("F"));gmath.rules.identity_element(N,new w("F"));gmath.rules.zero_element(N,new w("T"))};gmath.rules.init_all();mtouch_events=function(){var t=E(_,"tap","dbltap","hold","drag","mdrag","touch","release"),e=null,i=[],n={},r=[],o="mouse",s="client",a=null,h=false,l=250,d=10*10,u=500,c=10,p=c*c,f=400,g=20,v=gmath.uid();function _(){e=this;_.connected(true)}_.connected=function(t){if(arguments.length==0)return h;if(!e)return this;e.on("touchstart."+v,t?y:null).on("mousedown."+v,t?m:null).on("touchmove."+v,t?w:null).on("touchend."+v,t?b:null).on("touchcancel."+v,t?b:null);h=t;return this};_.call=function(t){t.apply(_,arguments);return this};_.frame=function(t){if(arguments.length===0)return s;s=t;return this};_.origin=function(t){if(arguments.length===0)return a;a=t;return this};_.hold_time=function(t){if(arguments.length===0)return u;u=t;return this};_.hold_max_dist=function(t){if(arguments.length===0)return c;c=t;p=c*c;return this};_.dbltap_max_dist=function(t){if(arguments.length===0)return g;g=t;return this};function m(){if(!N(d3.event))return;var t=d3.select(window);var e=this,i=arguments;t.on("mousemove.mtouch",function(){w.apply(e,i)});t.on("mouseup.mtouch",function(){t.on("mousemove.mtouch",null);t.on("mouseup.mtouch",null);b.apply(e,i)});y.apply(this,arguments)}function y(){d3.event.preventDefault();var e=this,r=t.of(e,arguments),o=A();var s=a?a.apply(this,arguments):null;for(var h=0,l=o.length;h<l;h++){var d=new x(o[h].identifier,r,e,s);i.push(d);n[o[h].identifier]=d;r({type:"touch",finger:d,fingers:i,idx:_.idx})}}function w(){d3.event.preventDefault();var e=this,r=t.of(e,arguments),o=A();for(var s=0,a=i.length;s<a;s++)i[s].changed=false;var h=[];for(var s=0,a=o.length;s<a;s++){var l=n[o[s].identifier];if(!l)continue;l.move(r);h.push(l)}r({type:"mdrag",dragged_fingers:h,fingers:i})}function b(){d3.event.preventDefault();var e=this,r=t.of(e,arguments),o=A();for(var s=0,a=o.length;s<a;s++){var h=n[o[s].identifier];if(!h)continue;delete n[o[s].identifier];i=d3.values(n);r({type:"release",finger:h,fingers:i});h.end(r)}}function x(t,e,i,n){this.id=t;this.target=i;this.event=e;this.parent=i.parentNode;this.timeStamp0=d3.event.timeStamp;this.timeStamp=this.timeStamp0;this.hold_timer=setTimeout(this.held.bind(this),u);this.pos=n?n.slice():k(this.id,s);this.pos0=[this.pos[0],this.pos[1]];this.pos_client=k(this.id,"client");this.dist_x=0;this.dist_y=0;this.dx=0;this.dy=0;this.dt=0;this.changed=true;this.gesture=null}x.prototype.cancel_hold=function(){if(this.hold_timer)clearTimeout(this.hold_timer);this.hold_timer=null};x.prototype.held=function(){this.event({type:"hold",finger:this,fingers:i});this.hold_timer=null};x.prototype.move=function(t){this.changed=true;this.event=t;var e=k(this.id,"client"),n=d3.event.timeStamp;this.dx=e[0]-this.pos_client[0];this.dy=e[1]-this.pos_client[1];this.pos[0]+=this.dx;this.pos[1]+=this.dy;this.dist_x=this.pos[0]-this.pos0[0];this.dist_y=this.pos[1]-this.pos0[1];this.pos_client=e;this.dt=n-this.timeStamp;this.timeStamp=n;if(this.dist_x*this.dist_x+this.dist_y*this.dist_y>p){this.cancel_hold()}if(this.gesture)return;t({type:"drag",finger:this,x:this.pos[0],y:this.pos[1],dx:this.dx,dy:this.dy,fingers:i})};x.prototype.end=function(t){var e=d3.event.timeStamp-this.timeStamp0;if(e<=l&&this.dist_x*this.dist_x+this.dist_y*this.dist_y<=d){if(T(d3.event.timeStamp,this.pos[0],this.pos[1])){t({type:"dbltap",finger:this,fingers:i})}else{t({type:"tap",finger:this,fingers:i})}}this.cancel_hold()};function A(){return d3.event.changedTouches||[{identifier:o}]}function N(t){if("buttons"in t)return t.buttons===1;else if("which"in t)return t.which===1;else return t.button===1}function T(t,e,i){var n=-1,o=[e,i];r=r.filter(function(e,i){if(t-e.timeStamp<=f&&L(e.pos,o)<=g)n=i;return e.timeStamp-t<=f&&n!==i});if(n===-1)r.push({timeStamp:t,pos:o});return n!==-1}function S(t){if(a)return a();else return k(t,s)}function k(t,e){if(e==="client"){if(t===o)return[d3.event.clientX,d3.event.clientY];for(var i=0;i<d3.event.touches.length;i++){var n=d3.event.touches[i];if(n.identifier===t)return[n.clientX,n.clientY]}}else{if(t===o)return C(e,d3.event);for(var i=0;i<d3.event.touches.length;i++){var n=d3.event.touches[i];if(n.identifier===t)return C(e,n)}}}function L(t,e){return Math.sqrt((t[0]-e[0])*(t[0]-e[0])+(t[1]-e[1])*(t[1]-e[1]))}return d3.rebind(_,t,"on")};function E(t){var e=d3.dispatch.apply(this,Array.apply(null,arguments).slice(1));e.of=function(i,n){return function(r){try{var o=r.sourceEvent=d3.event;r.target=t;d3.event=r;e[r.type].apply(i,n)}finally{d3.event=o}}};return e}gmath.d3_eventDispatch=E;var D=0;if(typeof window!=="undefined")D=/WebKit/.test(window.navigator.userAgent)?-1:0;function C(t,e){var i=t.ownerSVGElement||t;if(i.createSVGPoint){var n=i.createSVGPoint();if(D<0&&(window.scrollX||window.scrollY)){i=d3.select("body").append("svg").style({position:"absolute",top:0,left:0,margin:0,padding:0,border:"none"},"important");var r=i[0][0].getScreenCTM();D=!(r.f||r.e);i.remove()}if(D)n.x=e.pageX,n.y=e.pageY;else n.x=e.clientX,n.y=e.clientY;n=n.matrixTransform(t.getScreenCTM().inverse());return[n.x,n.y]}var o=t.getBoundingClientRect();return[e.clientX-o.left-t.clientLeft,e.clientY-o.top-t.clientTop]}drag_behavior=function(){var t=E(d,"drag","drag-start","drag-end"),e=[],i=false,n,r,o,s,a=10,h=5,l=true;var d=function(){this.on("touch.drag",u).on("mdrag.drag",c).on("release.drag",p)};d.min_single_dist=function(t){if(arguments.length===0)return a;a=t;return this};d.min_double_dist=function(t){if(arguments.length===0)return h;h=t;return this};d.allow_double_drag=function(t){if(arguments.length===0)return l;l=t;return this};var u=function(){if(e.length===2||l&&e.length===1)return;e.push(d3.event.finger);if(e.length===2){n=[(e[0].pos[0]+e[1].pos[0])/2,(e[0].pos[1]+e[1].pos[1])/2];r=[n[0],n[1]];s=o=f(e[0].pos,e[1].pos)}else{n=[e[0].pos[0],e[0].pos[1]];r=[n[0],n[1]];o=s=0}};var c=function(){if(e.length===0)return;var l,d=t.of(this,arguments);if(e.length===1){if(!e[0].changed)return;l=[e[0].pos[0],e[0].pos[1]];if(!i&&f(n,r)>=a){i=true;d({type:"drag-start",fingers:e,pos0:n,pos:r,dist0:o,dist:s})}}else{if(!e[0].changed&&!e[1].changed)return;l=[(e[0].pos[0]+e[1].pos[0])/2,(e[0].pos[1]+e[1].pos[1])/2];s=f(e[0].pos,e[1].pos);if(!i&&f(n,r)>=h){i=true;d({type:"drag-start",fingers:e,pos0:n,pos:r,dist0:o,dist:s})}}if(i)d({type:"drag",fingers:e,pos0:n,pos:l,dist0:o,dist:s,dx:l[0]-r[0],dy:l[1]-r[1]});r=l};var p=function(){if(e.length===0)return;var o=d3.event.finger;var s=e.indexOf(o);if(s===-1)return;e.splice(s,1);if(!i)return;if(e.length===1){n=[e[0].pos[0],e[0].pos[1]];r=[n[0],n[1]]}if(e.length===0){i=false;t.of(this,arguments)({type:"drag-end"})}};function f(t,e){return Math.sqrt((t[0]-e[0])*(t[0]-e[0])+(t[1]-e[1])*(t[1]-e[1]))}return d3.rebind(d,t,"on")};var O=function(t,e){if(typeof e==="undefined")e=1e3;var i={},n=[],r;i.fonts=[];i.map={};i.finished=false;i.success=false;i.svg=d3.select("body").append("svg").style({position:"absolute",visibility:"hidden",width:"1px",height:"1px"});i.on_fonts_loaded=function(t){if(this.finished)t(this.success);else{n.push(t)}};var o=function(){i.loadSizes();for(var t=0;t<n.length;t++){n[t](this.success)}n=[]};i.add_fonts=function(t){var e=false;t.forEach(function(t){var n=s(t);if(n)t.id=n.id;else{t.id=gmath.uid();i.fonts.push(t);e=true}});if(!e)return;i.wait_for_fonts()};var s=function(t){for(var e=0;e<i.fonts.length;e++){var n=i.fonts[e];if(n.style===t.style&&n.family===t.family&&n.weight===t.weight)return n}return null};i.wait_for_fonts=function(){if(r)clearInterval(r);this.finished=false;this.success=false;this.fonts.unshift({family:"serif"});var t=this.svg.selectAll("text.temp").data(this.fonts);t.enter().append("text").classed("temp",true).style("font-size","100px").style("font-family",function(t){if(t.family.indexOf(" ")===-1)return t.family+", serif";else return"'"+t.family+"', serif"}).style("font-style",function(t){return t.style}).style("font-weight",function(t){return t.weight}).text("012abc");t.exit().remove();this.fonts.shift();var i=Date.now();var n=this;r=setInterval(function(){var s=[],a=true;t.each(function(t,e){s[e]=this.getBBox().width});for(var h=1;h<s.length;h++){if(s[h]===s[0])a=false}var l=Date.now()-i;if(!a&&l<=e)return;n.success=a;n.finished=true;t.remove();clearInterval(r);o()},20)};i.loadSizes=function(t,e){t=t||"xyz0123456789()=+-*^∗·•−,.";e=e||this.fonts;var i=[];for(var n=0;n<e.length;n++){if(!this.map[e[n].id]){this.map[e[n].id]={}}for(var r=0;r<t.length;r++){var o={font:e[n],"char":t[r],width:0,height:0};this.map[e[n].id][t[r]]=o;i.push(o)}}this.svg.selectAll(".hiddenChars").data(i).enter().append("text").style("font-size","100px").style("font-family",function(t){return t.font.family}).style("font-style",function(t){return t.font.style}).style("font-weight",function(t){return t.font.weight}).text(function(t){return t.char}).each(function(t){var e=this.getBBox();t.width=e.width;t.height=e.height}).remove()};i.width=function(t,e,i){var n=0,r=t.toString();for(var o=0;o<r.length;o++){if(!this.map[i.id]||!this.map[i.id][r[o]]){this.loadSizes(r[o],[i])}n+=this.map[i.id][r[o]].width}return n*e/100};i.height=function(t,e,i){var n=0,r=t.toString();for(var o=0;o<r.length;o++){if(!this.map[i.id]||!this.map[i.id][r[o]])this.loadSizes(r[o],[i]);n=Math.max(this.map[i.id][r[o]].height,n)}return n*e/100};i.add_fonts(t);return i};gmath.FontLoader=O;transform_behavior=function(){var t=E(_,"transform","transformend","transformstart"),e=[],i=0,n=0,r=0,o=1,s={scale:true,translate:true,rotate:true},a=true,h,l,d,u,c,p,f,g,v;var _=function(){this.on("touch.transform",m).on("mdrag.transform",y).on("release.transform",w)};_.transform=function(t){if(!arguments.length)return{scale:o,rotate:r,translate:[i,n]};if("scale"in t)o=t.scale;if("rotate"in t)r=t.rotate;if("translate"in t){i=t.translate[0];n=t.translate[1]}return _};_.one_finger_drag=function(t){if(!arguments.length)return a;a=t;return _};_.allow_translate=function(t){if(!arguments.length)return s.translate;s.translate=t;return _};_.allow_scale=function(t){if(!arguments.length)return s.scale;s.scale=t;return _};_.allow_rotate=function(t){if(!arguments.length)return s.rotate;s.rotate=t;return _};var m=function(){if(e.length===2)return;e.push(d3.event.finger);if(e.length===1&&a){h=l=[e[0].pos[0],e[0].pos[1]];d=A(l);t.of(this,arguments)({type:"transformstart"})}if(e.length===2){h=l=S(e[0].pos,e[1].pos);u=c=T(e[0].pos,e[1].pos);p=f=k(e[0].pos,e[1].pos);d=A(l);g=o;v=r}};var y=function(){if(e.length===0)return;if(!d3.event.dragged_fingers.some(function(t){return t.changed}))return;if(e.length===1){if(!a)return;if(s.translate)h=[e[0].pos[0],e[0].pos[1]];N(h,d)}if(e.length===2){if(s.scale)u=T(e[0].pos,e[1].pos);if(s.translate)h=S(e[0].pos,e[1].pos);if(s.rotate)p=k(e[0].pos,e[1].pos);b()}t.of(this,arguments)({type:"transform",fingers:e,transform:{scale:o,rotate:r,translate:[i,n]}})};var w=function(){if(e.length===0)return;var i=d3.event.finger;var n=e.indexOf(i);if(n===-1)return;e.splice(n,1);if(e.length===0){t.of(this,arguments)({type:"transformend"})}if(e.length===1){h=l=[e[0].pos[0],e[0].pos[1]];d=A(l)}};var b=function(){if(s.rotate)r=v+(p-f);if(s.scale)o=g*u/c;if(s.translate||s.rotate||s.scale)N(h,d)};var x=function(t){var e=Math.cos(r),s=Math.sin(r);var a=t[0]*e-t[1]*s,h=t[1]*e+t[0]*s;return[a*o+i,h*o+n]};var A=function(t){var e=(t[0]-i)/o,s=(t[1]-n)/o;var a=Math.cos(-r),h=Math.sin(-r);return[e*a-s*h,s*a+e*h]};var N=function(t,e){e=x(e);i+=t[0]-e[0];n+=t[1]-e[1]};function T(t,e){return Math.sqrt((t[0]-e[0])*(t[0]-e[0])+(t[1]-e[1])*(t[1]-e[1]))}function S(t,e){return[(t[0]+e[0])/2,(t[1]+e[1])/2]}function k(t,e){return Math.atan2(t[1]-e[1],t[0]-e[0])}return d3.rebind(_,t,"on")};gmath.transform_behavior=transform_behavior;var z={};gmath.HitTester=z;z.draw=function(t,e,i){var n=t.selectAll(".target_area").data(e?e:[]);n.enter().append("rect").classed("target_area",true).style({fill:"none",stroke:"lightpink","stroke-width":2,"stroke-style":"dashed"});n.attr("x",function(t){return t.x}).attr("y",function(t){return t.y}).attr("width",function(t){return t.width}).attr("height",function(t){return t.height});n.exit().remove();var r=t.selectAll(".source_area").data(i?[i]:[]);r.enter().append("rect").classed("source_area",true).style({fill:"none",stroke:"steelblue","stroke-width":2});r.attr("x",function(t){return t.x}).attr("y",function(t){return t.y}).attr("width",function(t){return t.width}).attr("height",function(t){return t.height});r.exit().remove()};z.getBoundingBox=function(t,e,i){if(arguments.length<2)e=1;var n=Infinity,r=-Infinity,o=Infinity,s=-Infinity;for(var a=0;a<t.length;a++){var h=t[a];if(h.hidden&&!h.smooshing)continue;var l=i?h.x0||0:h.x,d=i?h.y0||0:h.y;n=Math.min(n,h.sel_box.x+l);r=Math.max(r,h.sel_box.x+l+h.sel_box.width);o=Math.min(o,h.sel_box.y+d);s=Math.max(s,h.sel_box.y+d+h.sel_box.height)}var u=r-n,c=s-o;return{x:n+u*(1-e)/2,y:o+c*(1-e)/2,width:u*e,height:c*e}};z.setTargetRegions=function(t,e){t.forEach(function(t){var i=t.target;switch(t.settings.side){case"left-of":t.x=i.sel_box.x+i.x0-.5;t.width=1;t.y=i.sel_box.y+i.y0;t.height=i.sel_box.height;break;case"right-of":t.x=i.sel_box.x+i.x0+i.sel_box.width-.5;t.width=1;t.y=i.sel_box.y+i.y0;t.height=i.sel_box.height;break;case"below":t.x=i.sel_box.x+i.x0;t.width=i.sel_box.width;t.y=i.sel_box.y+i.y0+i.sel_box.height-.5;t.height=1;break;case"above":t.x=i.sel_box.x+i.x0;t.width=i.sel_box.width;t.y=i.sel_box.y+i.y0-.5;t.height=1;break;default:if(Array.isArray(i)){var n=z.getBoundingBox(t.target);t.x=n.x;t.width=n.width;t.y=n.y;t.height=n.height}else{t.x=i.sel_box.x+i.x0;t.width=i.sel_box.width;t.y=i.sel_box.y+i.y0;t.height=i.sel_box.height}break}z.adjustTargetBoxByMargin(t,e);if(t.settings.offset){t.x+=t.settings.offset.x;t.y+=t.settings.offset.y}});z.extendExtremeTargetBoxes(t)};z.adjustTargetBoxByMargin=function(t,e){if(!t.settings.margin)return;var i=Array.isArray(t.settings.margin)?t.getMargin():t.settings.margin;var n=0,r=0,o=0,s=0;if(i.all){n=r=o=s=i.all}if(i.x){n=r=i.x}if(i.y){o=s=i.y}if(i.x1)n=i.x1;if(i.y1)o=i.y1;if(i.x2)r=i.x2;if(i.y2)s=i.y2;n*=e;o*=e;r*=e;s*=e;t.x+=n;t.width-=r+n;t.y+=o;t.height-=s+o;if(t.width<=0){t.x+=-n>-r?-t.width/2:t.width/2;t.width=1}if(t.height<=0){t.y+=-o>-s?-t.height/2:t.height/2;t.height=1}};z.extendExtremeTargetBoxes=function(t){var e,i;var n;for(var o=0;o<t.length;o++){var s=t[o];if(!s.nodes)continue;if(s.nodes.length===1&&s.nodes[0]instanceof r)continue;if(!n)n=z.getBoundingBox(s.nodes,1,true);if(!e&&s.x+s.width<n.x||e&&s.x<e.x&&s.x+s.width<n.x)e=s;if(!i&&n.x+n.width<s.x||i&&i.x<s.x&&n.x+n.width<s.x)i=s}if(e&&e.settings.side!=="inside"){e.x-=1e3;e.width+=1e3;e.y-=500;e.height+=1e3}if(i&&i.settings.side!=="inside"){i.width+=1e3;i.y-=500;i.height+=1e3}};z.getHits=function(t,e){return t.filter(function(t){return t.settings.side!=="outside"&&z.overlaps(t,e)}).concat(t.filter(function(t){return t.settings.side==="outside"&&!z.overlaps(t,e)}))};z.getBestHit=function(t,e){var i=z.getHits(t,e);return z.getHighestPriorityHit(i,e)};z.getEnclosingRectForSourceLineEndpoint=function(t){return{xmin:t.B.x-2,ymin:t.B.y-2,xmax:t.B.x+2,ymax:t.B.y+2}};z.overlaps=function(t,e){return(t.x>=e.x&&t.x<=e.x+e.width||t.x+t.width>=e.x&&t.x+t.width<=e.x+e.width||t.x<=e.x&&t.x+t.width>=e.x+e.width)&&(t.y>=e.y&&t.y<=e.y+e.height||t.y+t.height>=e.y&&t.y+t.height<=e.y+e.height||t.y<=e.y&&t.y+t.height>=e.y+e.height)};z.getHighestPriorityHit=function(t,e){var i=null;for(var n=0;n<t.length;n++){var r=t[n];if(!i)i=r;else if(i.settings.side==="outside")i=r;else if(r.priority>i.priority)i=r;else if(r.priority===i.priority){if(z.getCenterDist(r,e)<z.getCenterDist(i,e))i=r}}return i};z.getCenterDist=function(t,e){var i=t.x+t.width/2-e.x-e.width/2,n=t.y+t.height/2-e.y-e.height/2;return Math.sqrt(i*i+n*n)};z.getOverlapArea=function(t,e){var i=Math.max(t.x,e.x)-Math.min(t.x+t.width,e.x+e.width),n=Math.max(t.y,e.y)-Math.min(t.y+t.height,e.y+e.height);return Math.max(0,i)*Math.max(0,n)};var P={};gmath.Reselector=P;P.rules=[];P.getNewSelection=function(t){var e=this.getBestRule(t);if(!e)return false;return e.apply(t)};P.getBestRule=function(t){var e=null;for(var i=0;i<this.rules.length;i++){var n=this.rules[i];if(n.match(t)&&(!e||e.priority<n.priority))e=n}return e};P.hasMatchingRule=function(t){for(var e=0;e<this.rules.length;e++)if(rules[e].match(t))return true;return false};P.Rule=function(t,e){this.name=t;this.priority=e||0};P.Rule.prototype.match=function(t){throw"override match function!"};P.Rule.prototype.apply=function(t){throw"override apply function!"};PowerRule=function(){P.Rule.call(this,"reselect whole power",1)};gmath.inherit(PowerRule,P.Rule);PowerRule.prototype.match=function(t){if(t.length!==1)return false;var e=t[0],i=e.parent;if(!e.is_group("exponent"))return false;if(!i.parent.is_group("mul","div"))return false;var n=i.parent.parent;return n.children.some(function(t){if(t.to_ascii()==="//")return false;var e=t.children[1];return e!==i&&gmath.actions.MultiplyPowersAction.areLikeTerms(i,e)})};PowerRule.prototype.apply=function(t){return[t[0].parent.parent]};P.rules.push(new PowerRule);var I=function(t,e){this.view=t;this.alm=t.model;this.nodes=[];this.line={A:{},B:{}};this.line_el=null;this.interaction_handler=e;this.action=gmath.actions.FractionCancelAction};I.prototype.check=function(t,e){return t.fingers.length==1&&e.length==0};I.prototype.start=function(t,e){this.line_el=this.view.main.append("line").classed("cancel-fraction",true).style("stroke",this.view.options.selection_color).style("stroke-width",6).style("stroke-linecap","round");this.nodes=[];this.line.A.x=this.line.B.x=t[0];this.line.A.y=this.line.B.y=t[1];return[]};I.prototype.update=function(t){this.line.B.x+=t.dx;this.line.B.y+=t.dy;var e=this.process_selection(this.get_crossed_nodes());var i=true;if(this.nodes.length!=e.length)i=false;else for(var n=0;n<this.nodes.length;n++)i=i&&this.nodes[n]==e[n];if(!i)this.interaction_handler.highlight_nodes(e);this.nodes=e;this.line_el.attr("x1",this.line.A.x).attr("y1",this.line.A.y).attr("x2",this.line.B.x).attr("y2",this.line.B.y)};I.prototype.end=function(){this.line_el.remove();var t=this.nodes[0],e;if(this.nodes.length===3&&this.nodes[1].value==="//")e=this.nodes[2];else if(this.nodes.length===2)e=this.nodes[1];if(e&&this.action.match(t,e)){var i=this.actions.createBoundAction(this.alm,{nodes:[e],target:t});this.alm.performAction(i,null,"cancel fraction")}this.nodes=[]};I.prototype.process_selection=function(e){var i=e.length;if(i===0)return[];if(i===1)return[e[0].parent];var n=t.get_cca(e);if(n.is_group("fraction")){var r=[];for(var o=0;o<e.length;o++){var s=e[o];while(s.parent!=n)s=s.parent;if(s.value=="//"&&n.get_bottom().length!=1)continue;if(r.indexOf(s)==-1)r.push(s)}return r}else return[n]};I.prototype.get_crossed_nodes=function(){var e=[];var i=t.get_leaf_nodes(this.alm);for(var n=0;n<i.length;n++){var r=i[n];if(!r.hidden&&this.intersects(r))e.push(r)}return e};I.prototype.intersects=function(t){var e=this.line.A,i=this.line.B;var n=t.sel_box.x+t.x,r=t.sel_box.x+t.sel_box.width+t.x;var o=t.sel_box.y+t.y,s=t.sel_box.y+t.sel_box.height+t.y;if(e.x<n&&i.x<n)return false;if(e.x>r&&i.x>r)return false;if(e.y<o&&i.y<o)return false;if(e.y>s&&i.y>s)return false;var a=function(t,n){return(e.x-i.x)*(e.y-n)-(e.y-i.y)*(e.x-t)<0};if(a(n,o)!=a(r,o))return true;if(a(r,o)!=a(n,s))return true;if(a(n,s)!=a(r,s))return true;return false};var R=function(t,e){this.default_precision=1;this.interaction_handler=e;this.precision=null;this.view=t;this.dy=0;this.pixels_per_unit=50;this.node=null;this.value=null;this.value0=null};R.prototype.check=function(t){if(this.view.model.options.locked)return false;var e=t.pos0[1]-t.pos[1];return Math.abs(e)>=10};R.prototype.start=function(t,e){this.old_anim_dur=this.view.options.dur;this.view.options.dur=0;this.node=this.process_selection(e);if(!this.node)return[];if(this.node&&this.node.precision)this.precision=this.node.precision;else this.precision=this.default_precision;this.dy=0;this.value=this.value0=this.view.model.numeric_value(this.node);return[this.node]};R.prototype.update=function(t){if(!this.node||!t.dy)return;this.dy+=t.dy;var e=-this.dy/this.pixels_per_unit;this.set_value(this.value0+e)};R.prototype.set_value=function(t){t=+t.toFixed(this.precision);if(t===this.value)return;this.value=t;var e=this.view.model.numeric_value(this.node,t);if(e instanceof s){e.scrubbingThisNum=true;e.precision=this.precision}else if(e.is_group("add","sub","sign")){e.children[1].scrubbingThisNum=true;e.children[1].precision=this.precision}if(e!==this.node){this.interaction_handler.highlight_nodes(this.start(null,[e]))}};R.prototype.end=function(){if(this.node){if(this.node instanceof s)delete this.node.scrubbingThisNum;if(this.node.is_group("add","sub","sign"))delete this.node.children[1].scrubbingThisNum;this.view.update_all()}this.view.options.dur=this.old_anim_dur;this.node=null};R.prototype.process_selection=function(t){var e=function(t){return t.is_group("sign")||t.is_group("add")||t.is_group("sub")};if(t.length===0||t.length>2)return null;if(t.length===2){var i=t[1];if(i instanceof s&&e(i))return i.parent;
return null}var n=t[0];if(n instanceof s){if(e(n.parent))return n.parent;else return n}else if(e(n))return n;return null};gmath.ChangeNumberHandler=R;var F=function(t,e,i){this.id=gmath.uid();this.send_events=true;this.events=d3.dispatch("tap","dbltap","drag_start","drag","drag_end","touch","release","hold","inspect_node","keyup","keydown","node_selection");this.view=t;this.recorder=i;this.mode="edit";this.modes=["edit","inspect","arrange"];this.interactive=e;this.init();if(!e)this.set_interactive(false);this.selected_nodes=[];this.handlers={edit:[new Y(this.view,this),new tt(this.view,this),new $(this.view,this),new X(this.view,this),new Q(this.view,this)],inspect:[new R(this.view,this)]};this.active_handler=null;this.active_action=null;this.pending_eoi=null;this.finger_vis=null};F.prototype.getHandlerByClass=function(t){var e=function(e){return e instanceof t};for(var i in this.handlers){var n=this.handlers[i].filter(e);if(n.length>0)return n[0]}};F.prototype.start_of_interaction=function(){this.view.model.startInteraction()};F.prototype.end_of_interaction=function(t){if(this.pending_eoi){clearTimeout(this.pending_eoi);this.pending_eoi=null}this.view.model.finishInteraction()};F.prototype.init=function(){var t=this.view.main.node();this.mtouch=mtouch_events().frame(t).hold_time(this.view.options.hold_time);this.view.event_receiver.call(this.mtouch);this.mtouch.on("touch",this.on_touch.bind(this,null)).on("release",this.on_release.bind(this,null)).on("tap",this.on_tap.bind(this,null)).on("dbltap",this.on_dbltap.bind(this,null)).on("hold",this.on_hold.bind(this,null));var e=drag_behavior().on("drag-start",this.on_drag_start.bind(this,null)).on("drag",this.on_drag.bind(this,null)).on("drag-end",this.on_drag_end.bind(this,null));this.mtouch.call(e);d3.select(document).on("keydown."+this.id,this.on_keydown.bind(this,null));d3.select(document).on("keyup."+this.id,this.on_keyup.bind(this,null))};F.prototype.abort_interaction=function(){if(this.active_handler)this.active_handler.end();this.active_handler=null;this.highlight_nodes([])};F.prototype.setMode=function(t){if(this.modes.every(function(e){return e!==t}))return;this.view.setMode(t);if(t!==this.mode)this.view.update_existing("normal");this.mode=t;if(!this.interactive)this.mtouch.connected(this.mode==="inspect")};F.prototype.set_interactive=function(t){this.interactive=!!t;if(this.mode==="inspect")this.mtouch.connected(true);else this.mtouch.connected(this.interactive)};F.prototype.select_new_handler=function(t){var e=this.handlers[this.mode]||[];for(var i=0;i<e.length;i++){var n=e[i];if(n.check(t,this.selected_nodes)){this.active_handler=n;this.highlight_nodes(n.start(t.pos,this.selected_nodes));return}}};F.prototype.on_keydown=function(t){var e=t||d3.event;if(e.keyCode===16){}else if(e.keyCode===32){this.spaceBarDown=true}else return;if(this.active_handler&&e.preventDefault)e.preventDefault();if(this.send_events)this.events.keydown(new V("down",e,this.id))};F.prototype.on_keyup=function(t){var e=t||d3.event;if(e.keyCode===16){}else if(e.keyCode===32){this.spaceBarDown=false}else return;if(this.active_handler&&e.preventDefault)e.preventDefault();if(this.send_events)this.events.keyup(new V("up",e,this.id))};F.prototype.on_tap=function(t){if(this.active_action)return;var e=this.selectInputEvent(t,d3.event);if(this.active_handler){console.error("should not happen");this.highlight_nodes(this.active_handler.end()||[]);this.active_handler=null}if(e.shiftKey)return;var i=this.get_closest_node_at(e.finger.pos);var n;if(i)n=this.getFirstUnfixedParent(i);if(this.send_events)this.events.tap(new q(e,this.id,i,n));if(!n)return;var r=this;if(this.mode==="inspect"){this.highlight_nodes([]);this.events.inspect_node({node:n});this.end_of_interaction(true)}if(this.mode==="edit"){this.view.model.process_operator(n,function(){r.end_of_interaction();r.highlight_nodes([])},new q(e,this.id))}};F.prototype.on_dbltap=function(t){if(this.active_action)return;var e=this.selectInputEvent(t,d3.event);if(this.active_handler){console.error("should not happen");this.highlight_nodes(this.active_handler.end()||[]);this.active_handler=null}if(e.shiftKey)return;var i=this.get_closest_node_at(e.finger.pos);var n;if(i)n=this.getFirstUnfixedParent(i);if(this.send_events)this.events.tap(new j(e,this.id,i,n));if(!n)return;var r=this;if(this.mode==="edit"){this.view.model.process_operator(n,function(){r.end_of_interaction();r.highlight_nodes([])},new j(e,this.id))}};F.prototype.on_hold=function(t){if(this.active_action)return;var e=this.selectInputEvent(t,d3.event);if(this.active_handler||this.mode!=="edit"){return}if(this.send_events)this.events.hold(new H(e,this.id));var i=this.get_closest_node_at(e.finger.pos);if(!i){return}if(this.mode==="edit"){var n=this;if(this.view.options.replace_value_on&&gmath.actions.RewriteNumberWithKeyboardAction.match(i)){var r=gmath.actions.RewriteNumberWithKeyboardAction.createBoundAction(this.view.model,{actor:i});this.performAction(r)}else if(gmath.actions.showRoundedAction.match(i)){var r=gmath.actions.showRoundedAction.createBoundAction(this.view.model,{actor:i});this.performAction(r,true)}else{this.active_action=this.view.model.process_operator(i,function(t){if(!t)return;n.end_of_interaction();n.highlight_nodes([]);n.active_action=null},new H(e,this.id))}}};F.prototype.performAction=function(t,e){var i=this;this.active_action=t;this.view.model.performAction(t,function(){i.active_action=null;i.end_of_interaction();i.highlight_nodes([])},e)};F.prototype.getFirstUnfixedParent=function(t){while(t.fixed&&t.parent&&!r.is_top_most(t.parent))t=t.parent;return t};F.prototype.selectInputEvent=function(t,e){if(t)return t;var i=e;while(i.sourceEvent)i=i.sourceEvent;e.shiftKey=i.shiftKey;e.altKey=i.altKey;return e};F.prototype.on_drag_start=function(e){if(this.active_action)return;if(!this.interactive&&this.mode!=="inspect")return;var i=this.selectInputEvent(e,d3.event);var n=this.selected_nodes.slice();if(this.active_handler){if(this.send_events)this.events.drag_start(new G(i,this.id,n));return}if(this.selected_nodes.length>1){this.selected_nodes=t.nodes_to_range(this.selected_nodes)}this.select_new_handler(i);if(this.send_events)this.events.drag_start(new G(i,this.id,n,this.selected_nodes))};F.prototype.update_fingers=function(t,e){if(!this.finger_sel){var i=this.view.main.node();this.finger_sel=d3.select(i).selectAll(".finger");var n=d3.touches(i,[{pageX:0,pageY:0,clientX:0,clientY:0}])[0];var r=d3.touches(this.view.svg.node(),[{pageX:0,pageY:0,clientX:0,clientY:0}])[0];this.dpos_finger_vis=[r[0]-n[0],r[1]-n[1]];this.finger_vis_start=Date.now()}var o=this.finger_sel.data(t);if(!e){o.enter().append("circle").classed("finger",true).attr("r",20).style({stroke:"#4D4D4D","stroke-opacity":.5,fill:"#B2CAED","fill-opacity":.5}).transition().ease("bounce").attr("r",17)}var s=this.dpos_finger_vis;o.attr("cx",function(t){return t.pos[0]-s[0]}).attr("cy",function(t){return t.pos[1]-s[1]});var a=this.finger_vis_start;o.exit().transition().delay(Math.max(0,250-(Date.now()-a))).style("opacity",1e-4).remove();this.finger_sel=o.size()===0?null:o};F.prototype.on_drag=function(t){if(this.active_action)return;if(!this.interactive&&this.mode!=="inspect")return;var e=this.selectInputEvent(t,d3.event);if(this.send_events)this.events.drag(new W(e,this.id,this.selected_nodes));if(t)this.update_fingers(t.fingers,true);if(!this.active_handler)this.select_new_handler(e);if(this.active_handler)this.active_handler.update(e)};F.prototype.on_drag_end=function(t){if(this.send_events)this.events.drag_end(new K(this.uid))};F.prototype.on_touch=function(t){if(this.active_action)return;if(!this.interactive&&this.mode!=="inspect")return;var e=this.selectInputEvent(t,d3.event);if(!e.shiftKey)this.start_of_interaction();if(t)this.update_fingers(t.fingers);if(this.active_handler){if(this.send_events)this.events.touch(new U(e,this.id));return}var i;if(e.fingers.length===1){var n=this.get_user_selection(e.fingers[0],null,e);if(e.shiftKey){i=gmath.array.xor(this.selected_nodes,n)}else{if(!gmath.array.containsAll(this.selected_nodes,n)){i=n}}if(this.send_events)this.events.touch(new U(e,this.id,n,i))}else if(e.fingers.length===2){i=this.get_user_selection(e.fingers[0],e.fingers[1],e)}if(i)this.highlight_nodes(i)};F.prototype.on_release=function(t){if(!this.interactive&&this.mode!=="inspect")return;var e=this.selectInputEvent(t,d3.event);if(this.send_events)this.events.release(new J(e,this.id));if(t)this.update_fingers(t.fingers);if(e.fingers.length===0){var i=e.shiftKey;if(this.active_handler){if(this.active_handler instanceof Y)i=true;this.active_handler.end();this.active_handler=null}if(!this.active_action&&!i){this.pending_eoi=setTimeout(function(){this.pending_eoi=null;this.end_of_interaction();this.highlight_nodes([])}.bind(this),1)}}};F.prototype.get_user_selection=function(e,i,n){var o;if(i)o=this.get_nodes_between(e.pos,i.pos);else{var s=this.get_closest_node_at(e.pos);if(!s)return[];s=this.getFirstUnfixedParent(s);if(n.altKey||this.spaceBarDown){while(s.parent.parent&&!s.parent.commutative)s=s.parent;var a=s.parent.parent;if(a&&a.is_group("fraction")){o=s.parent.is_group("mul")?a.get_top():a.get_bottom()}else if(s.parent.commutative)o=[s.parent.parent];else o=r.is_top_most(s.parent)?[s]:[s.parent]}else o=[s]}return t.nodes_to_range(o)};F.prototype.highlight_nodes=function(e,i){if(gmath.array.equals(this.selected_nodes,e))return;this.selected_nodes=e;var n=this.view;t.for_each(function(t){t.selected=false},n.model.children);for(var r=0;r<e.length;r++)e[r].selected=true;n.renderer.set_style(n.model.children);n.update_style(i);if(this.send_events)this.events.node_selection(new Z(this.id,e))};F.prototype.get_hits=function(e){var i=e[0],n=e[1];return t.get_leaf_nodes(this.view.model).filter(function(t){return!t.hidden&&t.sel_box&&i<=t.x+t.sel_box.x+t.sel_box.width&&i>=t.x+t.sel_box.x&&n<=t.y+t.sel_box.y+t.sel_box.height&&n>=t.y+t.sel_box.y})};F.prototype.get_closest_node_at=function(t){var e=null,i=Infinity;var n=t[0],r=t[1];var o=this.get_hits(t);for(var s=0;s<o.length;s++){if(o[s].hidden)continue;var a=o[s].x-n;var h=o[s].y-o[s].baseline_shift-r;var l=a*a+h*h;if(l<i){i=l;e=o[s]}}return e};F.prototype.get_nodes_between=function(e,i){var n=0;return t.get_leaf_nodes(this.view.model).filter(function(t){if(t.hidden||!t.sel_box||t.value=="//")return false;var r=[t.x+t.sel_box.x+t.sel_box.width/2,t.y+t.sel_box.y+t.sel_box.height/2];var o=B(e,i,r);var s=t.sel_box.width/4+t.sel_box.height/4;if(o.len==0)return o.dist<=s+n;return o.k>=0&&o.k<=1&&o.dist<=s+n})};var B=function(t,e,i){var n,r,o=.5;var s=[e[0]-t[0],e[1]-t[1]];var a=Math.sqrt(s[0]*s[0]+s[1]*s[1]);if(a<1e-6){n=t[0]-i[0];r=t[1]-i[1];a=0}else{var h=[i[0]-t[0],i[1]-t[1]];var o=(s[0]*h[0]+s[1]*h[1])/a;var n,r;if(o<0){n=t[0]-i[0];r=t[1]-i[1]}else if(o>a){n=e[0]-i[0];r=e[1]-i[1]}else{n=t[0]+o*s[0]/a-i[0];r=t[1]+o*s[1]/a-i[1]}}return{dist:Math.sqrt(n*n+r*r),k:o/a,len:a}};var G=function(t,e,i,n){this.type="drag_start";this.performee=e;this.performee_type="interaction-handler";this.time=Date.now();this.pos=[t.pos[0],t.pos[1]];this.pos0=[t.pos0[0],t.pos0[1]];this.dist=t.dist;this.dist0=t.dist0;if(t.altKey)this.altKey=t.altKey;if(t.shiftKey)this.shiftKey=t.shiftKey;this.fingers={length:t.fingers.length};this.target=i;this.selection=n};var q=function(t,e,i,n){this.type="tap";this.performee=e;this.performee_type="interaction-handler";this.time=Date.now();if(t.altKey)this.altKey=t.altKey;if(t.shiftKey)this.shiftKey=t.shiftKey;this.finger={pos:[t.finger.pos[0],t.finger.pos[1]]};this.target=i;this.selection=n};var j=function(t,e,i,n){this.type="dbltap";this.performee=e;this.performee_type="interaction-handler";this.time=Date.now();if(t.altKey)this.altKey=t.altKey;if(t.shiftKey)this.shiftKey=t.shiftKey;this.finger={pos:[t.finger.pos[0],t.finger.pos[1]]};this.target=i;this.selection=n};var V=function(t,e,i){this.type="key"+t;this.performee=i;this.performee_type="interaction-handler";this.time=Date.now();this.keyCode=e.keyCode};var H=function(t,e){this.type="hold";this.performee=e;this.performee_type="interaction-handler";this.time=Date.now();this.finger={pos:[t.finger.pos[0],t.finger.pos[1]]}};var W=function(t,e,i){this.type="drag";this.performee=e;this.performee_type="interaction-handler";this.time=Date.now();this.dx=t.dx;this.dy=t.dy;this.dist=t.dist;this.dist0=t.dist0;this.pos=[t.pos[0],t.pos[1]];this.pos0=[t.pos0[0],t.pos0[1]];this.fingers=t.fingers.map(function(t){return{pos:[t.pos[0],t.pos[1]]}});this.selection=i};var K=function(t){this.type="drag_end";this.performee=t;this.performee_type="interaction-handler";this.time=Date.now()};var U=function(t,e,i,n){this.type="touch";this.performee=e;this.performee_type="interaction-handler";this.time=Date.now();if(t.altKey)this.altKey=t.altKey;if(t.shiftKey)this.shiftKey=t.shiftKey;this.fingers=t.fingers.map(function(t){return{pos:[t.pos[0],t.pos[1]]}});this.target=i;this.selection=n};var J=function(t,e){this.type="release";this.performee=e;this.performee_type="interaction-handler";this.time=Date.now();if(t.altKey)this.altKey=t.altKey;if(t.shiftKey)this.shiftKey=t.shiftKey;this.fingers=t.fingers.map(function(t){return{pos:[t.pos[0],t.pos[1]]}});if(t.finger)this.finger={pos:[t.finger.pos[0],t.finger.pos[1]]}};var Z=function(t,e){this.type="node_selection";this.performee=t;this.performee_type="interaction-handler";this.time=Date.now();this.selection=e};var X=function(t){this.view=t;this.alm=this.view.model;this.nodes=[];this.node_ids=[];this.joined=false;this.unjoined_state=null};X.prototype.check=function(t){return t.dist-t.dist0<-15};X.prototype.start=function(t,e){this.nodes=this.proccess_selection(e);this.node_ids=this.nodes.map(function(t){return t.id});return this.nodes};X.prototype.update=function(e){if(this.joined){if(e.dist>3*e.dist0/4+10)this.unjoin();return}if(this.nodes.length<1||e.dist>3*e.dist0/4)return;var i=this.nodes[0].commutative?1:0;this.unjoined_state=t.clone(this.alm.children[0],true);this.unjoined_state.parent=this.alm;this.joined=true;var n=this;var r=function(t){n.alm.process_operator(n.nodes[t],function(){if(t+1<n.nodes.length)r(t+1);else n.nodes=[]})};r(i)};X.prototype.unjoin=function(){var e=this.alm;this.joined=false;e.children[0]=this.unjoined_state;e.changed();this.nodes=this.node_ids.map(function(i){return t.get_by_id(i,e.children)})};X.prototype.end=function(){this.nodes=[];this.node_ids=[];this.unjoined_state=null;this.joined=false};X.prototype.proccess_selection=function(t){if(t.length!==2)return t;if(!t[0].parent.commutative||!t[1].is_group())return t;return t[1].children.slice()};var Y=function(t,e){this.view=t;this.alm=this.view.model;this.interaction_handler=e;this.initial_nodes=[];this.nodes=[];this.pos0=null;this.pos=null;this.box_el=null};Y.prototype.check=function(t){return t.shiftKey};Y.prototype.start=function(t,e){this.pos0=t.slice();this.pos=t.slice();this.initBox();this.initial_nodes=e;return e};Y.prototype.update=function(t){this.pos[0]+=t.dx;this.pos[1]+=t.dy;this.updateBox();var e=this.getNodesInRect(this.pos0[0],this.pos0[1],this.pos[0],this.pos[1]);if(gmath.array.isPermutation(e,this.nodes))return;this.nodes=e;this.highlight()};Y.prototype.initBox=function(){this.box_el=this.view.main.append("rect").attr("transform","translate("+this.pos0+")").style("stroke",this.view.options.selection_color).style("stroke-width",2).style("fill",this.view.options.selection_color).style("fill-opacity",.33)};Y.prototype.updateBox=function(){this.box_el.attr("width",Math.abs(this.pos[0]-this.pos0[0])).attr("height",Math.abs(this.pos[1]-this.pos0[1])).attr("transform","translate("+Math.min(this.pos0[0],this.pos[0])+","+Math.min(this.pos0[1],this.pos[1])+")")};Y.prototype.getNodesInRect=function(e,i,n,r){var o=Math.min(e,n),s=Math.max(e,n);var a=Math.min(i,r),h=Math.max(i,r);var l=t.get_leaf_nodes(this.view.model).filter(function(t){return!t.hidden&&t.sel_box&&o<=t.x+t.sel_box.x+t.sel_box.width&&s>=t.x+t.sel_box.x&&a<=t.y+t.sel_box.y+t.sel_box.height&&h>=t.y+t.sel_box.y});return l};Y.nodeIsNotFractionBar=function(t){return t.value!=="//"};Y.prototype.highlight=function(){this.interaction_handler.highlight_nodes(gmath.array.mergedNew(this.initial_nodes,this.nodes))};Y.prototype.end=function(){this.box_el.remove();return gmath.array.mergedNew(this.initial_nodes,this.nodes).filter(Y.nodeIsNotFractionBar)};var Q=function(t,e){this.view=t;this.nodes=null;this.splitted=false;this.new_state=null;this.prevDist=null;this.interaction_handler=e;this.actions=[SplitNumberAction,SplitProductAction,SplitPowerAction,SplitPowerSumAction,gmath.actions.RemoveBracketsAction]};Q.prototype.check=function(t){return t.dist-t.dist0>15};Q.prototype.start=function(t,e){this.prevDist=null;this.nodes=e;return this.nodes||[]};Q.prototype.end=function(){this.node=null;this.splitted=false};Q.prototype.getBestAction=function(t,e,i){var n=i;this.actions.forEach(function(i){if(n&&i.priority<=n.priority)return;if(i.match(e))n=i.createBoundAction(t,{actor:e})});for(var r=e.children.length-1;r>=0;r--){var o=e.children[r];var s=this.getBestAction(t,o,n);if(s)n=s}return n};Q.prototype.split=function(e,i){var n;for(var r=i.length-1;r>=0;r--){n=this.getBestAction(e,i[r],n)}if(!n)return false;e.performAction(n);var o=t.nodes_to_range(n.mapNodes(n.actor));return o};Q.prototype.update=function(t){if(!this.nodes)return;if(this.prevDist!==null&&t.dist-this.prevDist<=30)return;var e=this.split(this.view.model,this.nodes);if(!e)return;this.prevDist=t.dist;this.nodes=e;this.interaction_handler.highlight_nodes(this.nodes)};if(typeof module==="object"&&module.exports){module.exports=Q}var $=function(t,e){this.id=gmath.uid();this.view=t;this.interaction_handler=e;this.dl=t.options.derivation_list;this.dy0=0;this.dx=0;this.dy=0;this.dx_queue=[];this.dy_queue=[];this.nodes=[];this.leaf_nodes=[];this.smooshedNodes=[];this.smooshing=false;this.rubberband_dir=0;this.bbox=null;this.actions=[];this.target_areas=null;this.active=false};$.show_target_areas=false;$.prototype.check=function(t,e){var i=t.pos0[0]-t.pos[0],n=t.pos0[1]-t.pos[1];if(t.fingers.length===1&&e.length===0)return false;return i*i+n*n>=8*8};$.prototype.isActive=function(){return this.active};$.prototype.start=function(t,e,i){if(this.view.options.hide_mouse_cursor===true)d3.select("html").style("cursor","none");if(this.dl)this.dl.setLastHandleVisibility(false);var n=gmath.extend({reselect_nodes:true,move_nodes:true},i);this.active=true;this.center=t.slice();this.setNodes(n.reselect_nodes?$.process_selection(e):e);this.rubberband_dir=0;this.interaction_handler.events.on("keydown."+this.id,this.selectNodesOneLevelUp.bind(this));this.do_not_move_nodes=!n.move_nodes;for(var r=0;r<this.nodes.length;r++){var o=this.nodes[r];o.dragging=true;o.x0=o.x;o.y0=o.y}if(this.view.model.hide_nodes()){this.view.renderer.set_style(this.nodes);this.view.update_style()}this.view.enter_and_exit("shadow");this.view.update_existing("shadow");this.setupActions(n.actions);return this.nodes};$.prototype.setNodes=function(e){this.nodes=e;this.leaf_nodes=t.filter(function(t){return!t.has_children()},e)};$.prototype.selectNodesOneLevelUp=function(){if(this.nodes.length===0||!t.is_range(this.nodes))return;if(this.nodes[0].parent.is_root())return;if(this.smooshing){this.cancelSmooshing()}var e=[];for(var i=0;i<this.nodes.length;i++){if(e.indexOf(this.nodes[i].parent!==-1)){e.push(this.nodes[i].parent)}}e=$.process_selection(e);if(e.length>0&&e[0].is_group("equals"))return;if(this.nodes.some(function(t){return e.indexOf(t)!==-1})){return}this.nodes.forEach(function(t){t.dragging=false});var n={x:this.nodes[0].x-this.nodes[0].x0,y:this.nodes[0].y-this.nodes[0].y0};for(var i=0;i<e.length;i++){var r=e[i];r.dragging=true;r.x+=n.x;r.y+=n.y;r.x0=r.x;r.y0=r.y}this.setNodes(e);if(this.view.model.hide_nodes()){this.view.renderer.set_style(this.nodes);this.view.update_style()}this.interaction_handler.highlight_nodes(this.nodes);this.view.update_positions(this.leaf_nodes);this.view.renderer.set_position(this.nodes);this.view.enter_and_exit("shadow");this.view.update_existing("shadow");this.setupActions();this.view.update_positions(this.leaf_nodes);return this.nodes};$.prototype.update=function(e){var i=e.dx,n=e.dy,r=this;this.dy+=n;this.pushToDXQueue(i);this.pushToDYQueue(n);if(this.fingerMoved())this.stopAllTimeouts();var o=3.5*this.interaction_handler.view.options.font_size;if(!this.smooshing&&Math.abs(this.dy-this.dy0)>o&&this.dy!==0){var s=this.dy>this.dy0?1:-1;if(s!==-1*this.rubberband_dir){this.dy0=this.dy;this.rubberband_dir=s;if(this.view.options.rubber_band_selection)this.selectNodesOneLevelUp()}}if(!this.do_not_move_nodes){t.for_each(function(t){t.x+=i;t.y+=n},this.nodes);this.smooshedNodes.forEach(function(e){t.for_each(function(t){t.x+=i;t.y+=n},e)})}this.bbox.x+=i;this.bbox.y+=n;this.center[0]+=i;this.center[1]+=n;if(this.smooshing){this.view.updateSmooshIndicator(this.center)}if($.show_target_areas)z.draw(this.view.main,this.actions,this.bbox);var a=z.getBestHit(this.actions,this.bbox);if(a&&a.settings.delay&&!a.timeoutID)this.applyTimeout(a);else if(a&&this.actionIsIncompleteMultiTargetAction(a))this.setNextTargetRegion(a);else if(a&&!a.settings.delay&&!a.timeoutID)this.performAction(a);else if(!a)this.stopAllTimeouts();this.view.update_positions(this.leaf_nodes);if(this.smooshing){this.view.updateSmooshed(this.smooshedNodes)}};$.prototype.pushToDXQueue=function(t){this.dx_queue.push(t);if(this.dx_queue.length>4)this.dx_queue.shift()};$.prototype.pushToDYQueue=function(t){this.dy_queue.push(t);if(this.dy_queue.length>4)this.dy_queue.shift()};$.prototype.fingerMoved=function(){var t=this.dx_queue.reduce(function(t,e){return t+e},0),e=this.dy_queue.reduce(function(t,e){return t+e},0);return t*t+e*e>=2.25};$.reorderInRanges=function(t){if(t.length<2)return t;var e=t[0].get_root();var i=0;e.for_each(function(t){t.order_num=i++});return t.sort(function(t,e){return t.order_num-e.order_num})};$.getNewSelectionAfterAction=function(t,e){var i=t.new_selection?t.new_selection:t.mapNodes(e);this.reorderInRanges(i);return $.process_each_selection(i)};$.prototype.performAction=function(e){this.stopAllTimeouts();var n=this.view.model.getNodes("=",0),r;if(n)r={x:n.x,y:n.y};var e=this.view.model.performAction(e);if(this.dl)this.dl.setLastHandleVisibility(false);var o=$.getNewSelectionAfterAction(e,this.nodes);if(o.length===0){this.interaction_handler.abort_interaction();this.interaction_handler.end_of_interaction();throw"(DragHandler) Non-existant new node selection after move action.";return}var s=P.getNewSelection(o);o=s||o;if(!e.settings.is_join_action||s){e.settings.is_join_action=false;if(this.smooshing)this.cancelSmooshing()}var a=gmath.array.equals(this.nodes,o);if(!a){if(e.settings.is_join_action){this.addSmooshedNodes(e);this.view.enterSmooshed(this.smooshedNodes);this.shrinkNewSmooshedNodes();this.positionSmooshedNodesInWheel();this.view.updateSmooshed(this.smooshedNodes)}this.interaction_handler.highlight_nodes(o);for(i=0;i<this.nodes.length;i++)this.nodes[i].dragging=false;e.newTree.for_each(function(t){t.dragging=false});for(i=0;i<o.length;i++)o[i].dragging=true;this.correctNodePositions(o,e);this.view.model.hide_nodes();if(e.settings.is_join_action){t.for_each(function(t){t.smooshing=false},this.nodes);t.for_each(function(t){t.smooshing=true},o)}}this.setNodes(o);this.updateNodePositionsAroundTarget(o,e);this.view.update_style();this.setupActions();this.view.enter_and_exit("shadow");this.view.update_existing("shadow");this.view.update_existing("normal");this.dy=0};$.prototype.addSmooshedNodes=function(e){var i=e.nodes[0],n=e.target;var r=function(e){var i=t.clone(e,false,["id","value","name","bp","associative","commutative","vertical_notation","selected","dragging","locked","fixed","hidden","simplify","deleted","precision","color","size","width","height","x","y","x0","y0","rel_x","rel_y","lmar","rmar"]);if(i.children[0]&&i.children[0].hidden)i.children[0].hidden=false;return i};this.smooshing=true;if(this.smooshedNodes.length===0){this.smooshedNodes.push(r(i))}this.smooshedNodes.push(r(n))};$.prototype.shrinkNewSmooshedNodes=function(){if(this.smooshedNodes.length===2){this.smooshedNodes.forEach(this.shrinkSmooshedNodesGroup.bind(this))}else{this.shrinkSmooshedNodesGroup(this.smooshedNodes[this.smooshedNodes.length-1])}};$.prototype.shrinkSmooshedNodesGroup=function(e){e.size=e.size*this.view.options.smooshed_nodes_shrink_factor;t.for_each(function(t){t.size=e.size},e);this.view.renderer.set_position([e],true)};$.prototype.positionSmooshedNodesInWheel=function(){var t=this.smooshedNodes.length,e=this.calculatePositionOnCircleForEachGroup(t);for(var i=0;i<this.smooshedNodes.length;i++){var n=this.smooshedNodes[i];var r=this.center[0]+n.width/2+e[i][0],o=this.center[1]+n.height/2+e[i][1];var s=r-n.x,a=o-n.y;n.for_each(function(t){t.x+=s;t.y+=a})}};$.prototype.calculatePositionOnCircleForEachGroup=function(t){var e=this.view.options.font_size;var i=360/t,n=270,r=n;var o=[n];for(var s=0;s<t-1;s++){r+=i;r=(r+360)%360;o.push(r)}var a=function(t){return t*Math.PI/180};return o.map(function(t){return[e*Math.cos(a(t)),e*Math.sin(a(t))]})};$.prototype.cancelSmooshing=function(){this.nodes.forEach(function(t){t.for_each(function(t){t.smooshing=false})});this.smooshing=false;this.smooshedNodes=[];this.view.exitSmooshed();this.view.exitSmooshIndicator()};$.prototype.setupActions=function(t){var e=this.view.options.font_size*.1;if(this.smooshing){this.bbox={x:this.center[0]-e,y:this.center[1]-e,width:2*e,height:2*e};this.view.enterSmooshIndicator(this.center)}else{this.bbox=z.getBoundingBox(this.nodes,0);this.bbox.x-=e;this.bbox.width=e*2;this.bbox.y-=e*1.5;this.bbox.height=e*3}this.actions=t||this.view.model.getMoveActions(this.nodes);if(!this.view.options.enable_drag_to_join)this.actions=this.actions.filter(function(t){return!t.settings.is_join_action});z.setTargetRegions(this.actions,this.view.options.font_size);if($.show_target_areas)z.draw(this.view.main,this.actions,this.bbox)};$.prototype.actionIsIncompleteMultiTargetAction=function(t){return t.settings.multi_target&&t.settings.current_margin<t.settings.margin.length};$.prototype.setNextTargetRegion=function(t){z.setTargetRegions([t],this.view.options.font_size);if($.show_target_areas)z.draw(this.view.main,[t],this.bbox)};$.prototype.correctNodePositions=function(e,i){if(i.settings.makes_no_changes&&!i.settings.update_node_positions)return;var n=null;for(var r=0;r<this.nodes.length;r++){var o=i.mapNodes(this.nodes[r]);if(o.length!==1&&i.name!=="composed action of inverting terms across an equation and commuting"&&i.name!=="invert terms across equation")continue;n=t.select_first(function(t){return t===o[0]},e);if(n)break}if(n){var s={x:n.x-n.x0,y:n.y-n.y0};t.for_each(function(t){if(t.x===t.x0&&t.y===t.y0){t.x+=s.x;t.y+=s.y}},e)}};$.prototype.updateNodePositionsAroundTarget=function(e,i){if(i.settings.makes_no_changes)return;var n;if(i.settings.is_join_action){var o=0;for(var s=0;s<e[0].children.length;s++){o+=e[0].children[s].sel_box.width}n=this.center[0]+o/2-e[0].x0}else{n=e[0].x-e[0].x0}var a=i.newTree.filter(function(t){return!t.dragging});a=a.filter(function(t){var e=t.parent;if(e){while(!r.is_top_most(e)){if(e.dragging)return false;e=e.parent}}return true});a.forEach(function(t){t.x+=n;t.x0+=n});var h=i.newTree.filter(function(t){return t.dragging});if(!i.settings.is_join_action){t.for_each(function(t){t.x0+=n},h)}else if(!r.is_top_most(h[0])){t.for_each(function(t){t.x+=n;t.x0+=n},h)}};$.prototype.end=function(){d3.select("html").style("cursor",null);this.interaction_handler.events.on("keydown",null);if(this.dl)this.dl.setLastHandleVisibility(true);this.stopAllTimeouts();t.for_each(function(t){t.selected=false;t.dragging=false},this.view.model.children);this.view.enter_and_exit("shadow");this.view.update_existing("shadow");this.cancelSmooshing();this.view.model.hide_nodes();this.setNodes([]);this.actions=[];this.bbox=null;this.view.update_all();if($.show_target_areas)z.draw(this.view.main);this.active=false;this.dy=0;this.dy0=0};$.prototype.applyTimeout=function(t){var e=this;t.timeoutID=setTimeout(function(){e.performAction(t)},t.settings.delay)};$.prototype.stopAllTimeouts=function(){for(var t=0;t<this.actions.length;t++){var e=this.actions[t];if(e.timeoutID)this.clearActionTimeout(e)}};$.prototype.clearActionTimeout=function(t){clearTimeout(t.timeoutID);delete t.timeoutID;delete t.dx;delete t.dy};$.process_each_selection=function(t){if(t.length===0)return[];var e=r.groupNodeRanges(t);var i=[];e.map(function(t){return $.process_selection(t)}).forEach(function(t){i=gmath.array.mergedNew(i,t)});return i};$.process_selection=function(t){var e=t.slice();if(e.length===0)return[];if(e.length===1&&e[0].to_ascii()==="-"){return e}if(e.length===1&&e[0].to_ascii()==="|"&&e[0].get_idx()===0){return e}if(e[0].commutative){var i=e[0].parent;if(e.length<i.children.length)return e;else e=[i]}var n=e[0];while(!r.is_top_most(n)&&!n.parent.is_group("equals")&&!n.commutative&&!n.is_group("exponent")&&!n.parent.is_group("param"))n=n.parent;if(n.parent&&n.parent.is_group("equals")&&n.value=="=")n=n.parent;return[n]};gmath.DragHandler=$;var tt=function(t,e){this.type="SubstitutionHandler";this.interaction_handler=e;this.dl=t.options.derivation_list;this.view=t;this.line={A:{},B:{}};this.line_el=null;this.bbox=null;this.otherLines=[];this.otherLine_els=[];this.targets=[];this.processed_color="rgb(200,200,200)"};tt.prototype.check=function(t,e){if(!gmath.options.actions.substitution_on)return false;if(t.fingers.length===1&&e.children&&e.children[0].is_group("equals")){return true}return false};tt.prototype.start=function(t){this.collectSurroundingsInfo();this.highlightAllPotentialActions();this.initializeLine(t);return[]};tt.prototype.update=function(t){var e=[];this.targets.forEach(function(t){e=e.concat(t.potentialActions)});this.updateLineObject(t);this.collectPassedOverNodes();this.updateLineElement(this.line_el,this.line);var i=false;this.targets.forEach(function(t){if(t.results.length>0)i=true});return i};tt.prototype.end=function(){for(var t=0;t<this.targets.length;t++){var e=this.targets[t];if(e.results.length>0)this.performSubstitution(e)}this.eraseInfoAndCleanBoard()};tt.prototype.collectSurroundingsInfo=function(){this.derivationLists=this.dl.getAllDLs().slice();this.ignoreSourceDerivationList();this.activeRows=this.derivationLists.map(function(t){return t.getLastRow()});this.algebraModels=this.derivationLists.map(function(t){return t.getLastModel()});this.targets=this.organizeDataIntoTargets()};tt.prototype.ignoreSourceDerivationList=function(){this.derivationLists.splice(this.derivationLists.indexOf(this.dl),1)};tt.prototype.organizeDataIntoTargets=function(){var t=[];for(var e=0;e<this.derivationLists.length;e++){var i=this.getAllAvailableActions(this.algebraModels[e],this.derivationLists[e]);var n={dl:this.derivationLists[e],row:this.activeRows[e],model:this.algebraModels[e],potentialActions:i,results:[]};t.push(n)}return t};tt.prototype.getAllAvailableActions=function(t,e){var i=gmath.actions.SubstitutionAction.getAllAvailableActions(this.view.model,t);var n=this.dl.getRowByView(this.view),r=this.dl.pos.x-this.dl.dims.x+n.pos[0],o=this.dl.pos.y-this.dl.dims.y+n.pos[1];for(var s=0;s<i.length;s++){var a=e.getLastRow();if(this.dl.coordinator&&e.coordinator){var h=this.dl.coordinator.getOffset(this.dl,e);i[s].settings.offset={x:e.pos.x-e.dims.x+a.pos[0]-r+h[0],y:e.pos.y-e.dims.y+a.pos[1]-o+h[1]}}else{i[s].settings.offset={x:e.pos.x-e.dims.x+a.pos[0]-r,y:e.pos.y-e.dims.y+a.pos[1]-o}}}z.setTargetRegions(i);return i};tt.prototype.highlightAllPotentialActions=function(){for(var t=0;t<this.targets.length;t++){var e=this.targets[t].potentialActions;var i=[];for(var n=0;n<e.length;n++)i=i.concat(e[n].target);this.targets[t].row.view.interaction_handler.highlight_nodes(i)}};tt.prototype.initializeLine=function(t){this.line_el=this.makeLineElement();var e=this.dl.getRowByView(this.view).getHandlePos();this.line.A.x=e[0];this.line.A.y=e[1];this.line.B.x=t[0];this.line.B.y=t[1];
this.bbox={x:this.line.B.x-2,y:this.line.B.y-2,width:4,height:4}};tt.prototype.makeLineElement=function(t){var e=this.view.main.append("line").classed("substitution",true).style("stroke","#ddd").style("stroke-width",2).style("stroke-linecap","round");return e};tt.prototype.updateLineObject=function(t){this.line.B.x+=t.dx;this.line.B.y+=t.dy;this.bbox={x:this.line.B.x-2,y:this.line.B.y-2,width:4,height:4}};tt.prototype.updateLineElement=function(t,e){t.attr("x1",e.A.x).attr("y1",e.A.y).attr("x2",e.B.x).attr("y2",e.B.y)};tt.prototype.collectPassedOverNodes=function(){for(var t=0;t<this.targets.length;t++){this.findMatchingEndpointNodes(this.targets[t])}};tt.prototype.findMatchingEndpointNodes=function(t){var e=z.getBestHit(t.potentialActions,this.bbox);if(!e)return;this.removeNodesFromPotentialActionsList(e,t);t.results.push(e);this.drawLine(e,t);this.highlightAllPotentialActions()};tt.prototype.removeNodesFromPotentialActionsList=function(t,e){e.potentialActions.splice(e.potentialActions.indexOf(t),1)};tt.prototype.drawLine=function(t,e){var i={x:t.x+t.width/2,y:t.y+t.height/2};var n={A:{x:this.line.A.x,y:this.line.A.y},B:i};var r=this.makeLineElement(e);this.updateLineElement(r,n);this.otherLines.push(n);this.otherLine_els.push(r)};tt.prototype.performSubstitution=function(t){var e=this.concatenateActionTargetsIntoOneAction(t.results);t.dl.getLastModel().startInteraction();t.model.performAction(e);t.dl.getLastModel().finishInteraction()};tt.prototype.concatenateActionTargetsIntoOneAction=function(t){t[0].target=t.reduce(function(t,e){return t.concat(e.target)},[]);return t[0]};tt.prototype.eraseInfoAndCleanBoard=function(){this.removeAllLineElements();this.unhighlightAllNodes();this.otherLines=[];this.otherLine_els=[];this.targets=[]};tt.prototype.removeAllLineElements=function(){this.line_el.remove();for(var t=0;t<this.otherLine_els.length;t++){this.otherLine_els[t].remove()}};tt.prototype.unhighlightAllNodes=function(){for(var t=0;t<this.targets.length;t++){for(var e=0;e<this.targets[t].dl.rows.length;e++){this.targets[t].dl.rows[e].view.interaction_handler.highlight_nodes([])}}};var et=function(t,e){this.interaction_handler=e;this.view=t;this.model=t.model;this.node=null;this.line=null;this.value=null;this.hitbox={};this.dl=t.options.derivation_list;this.dls=null;this.target=null};et.prototype.check=function(t){var e=t.pos0[1]-t.pos[1];return Math.abs(e)>=10};et.prototype.start=function(t,e){this.node=this.process_selection(e);this.line=d3.select("svg").append("line").attr("stroke","blue");if(!this.node)return[];this.node.dragging=true;this.value=this.view.model.numeric_value(this.node);this.hitbox={x:this.node.x0+this.node.get_root().options.pos[0]-5,y:this.node.y0+this.node.get_root().options.pos[1]-5,width:10,height:10};this.dls=this.dl.getAllDLs().slice();this.target=null;return[this.node]};et.prototype.update=function(t){this.hitbox.x+=t.dx;this.hitbox.y+=t.dy;var e=[],i=this;this.dls.forEach(function(t){if(t.id===this.dl.id){var i=t.getLastModel(),n=i.filter(function(t){return!t.has_children()});n.forEach(function(i){var n=z.getBoundingBox([i]);if(n.x&&n.y){n.x+=t.pos[0];n.y+=t.pos[1];n.target=i;e.push(n)}})}});z.draw(d3.select("svg"),e,this.hitbox);this.target=z.getBestHit(e,this.hitbox);this.line.attr({x1:this.node.x0+this.node.get_root().options.pos[0]-this.node.width/4,y1:this.node.y0+this.node.get_root().options.pos[1]-this.node.height/4,x2:this.hitbox.x+5,y2:this.hitbox.y+5})};et.prototype.end=function(){if(this.target){this.target.target.get_root().numeric_value(this.target.target,this.node.get_root().numeric_value(this.node));this.interaction_handler.events.link(this.node,this.target.target)}this.line.remove();z.draw(d3.select("svg"));this.node=null};et.prototype.process_selection=function(t){var e=function(t){return t.is_group("sign")||t.is_group("add")||t.is_group("sub")};if(t.length===0||t.length>2)return null;if(t.length===2){var i=t[1];if(i instanceof s&&e(i))return i.parent;return null}var n=t[0];if(n instanceof s){if(e(n.parent))return n.parent;else return n}else if(e(n))return n;return null};DLCoordinator=function(){this.dls=[]};DLCoordinator.prototype.addDL=function(t){this.dls.push(t);if(t.coordinator)coordinator.removeElement(t);t.coordinator=this};DLCoordinator.prototype.removeDL=function(t){var e=this.dls.indexOf(t);if(e===-1)throw"I don't know about this DL, so I can't remove it.";this.dls.splice(e,1)};DLCoordinator.prototype.subscribeToCanvasModel=function(t){var e=this;var i=t.dls();var n=null;for(var r=0;r<i.length;r++){e.addDL(i[r])}t.on("create",function(t){if(t.target_type==="derivation")e.addDL(t.target)});t.on("remove",function(t){if(t.target_type==="derivation")e.removeElement(t.target)})};DLCoordinator.prototype.getPositionOnPage=function(t){var e,i;if(t.options.standalone==true){e=t.container().getBoundingClientRect().left;i=t.container().getBoundingClientRect().top}else{e=t.svg.node().viewportElement.getBoundingClientRect().left;i=t.svg.node().viewportElement.getBoundingClientRect().top}return[e,i]};DLCoordinator.prototype.getOffset=function(t,e){var i=this;var n=i.getPositionOnPage(t);var r=i.getPositionOnPage(e);return[r[0]-n[0],r[1]-n[1]]};var it=function(t,e,i){this.id=gmath.uid();this.model=t;this.events=d3.dispatch("updated");this.model.events.on("change."+this.id,this.onChange.bind(this));this.model.events.on("end-of-interaction."+this.id,this.onEOI.bind(this));var n=this;this.model.events.on("scrubbability-changed."+this.id,function(){n.update_existing("normal",true)});this.svg=e;this.main=null;this.initializeOptions(i);this.mode=this.options.mode;this.is_animating=0;this.afterAnimationCallbacks=[]};gmath.AlgebraView=it;gmath.preloadFonts=function(t){if(!gmath.AlgebraView.fontloader)gmath.AlgebraView.fontloader=new O(t);else gmath.AlgebraView.fontloader.add_fonts(t)};it.prototype.bindToModel=function(t,e){if(this.model){this.model.events.on("change."+this.id,null);this.model.events.on("scrubbability-changed."+this.id,null);this.model.events.on("end-of-interaction."+this.id,null)}this.model=t;this.model.events.on("change."+this.id,this.onChange.bind(this));this.model.events.on("end-of-interaction."+this.id,this.onEOI.bind(this));if(e&&this.main){var i=[];this.main.selectAll("g.math").each(function(t){var n=e[t.id];if(!t.deleted&&n&&n.length===1&&!n[0].has_children()&&i.indexOf(n[0])===-1){d3.select(this).datum(n[0]);i.push(n[0])}});i=[];this.main.selectAll("g.math_shadow").each(function(t){var n=e[t.id];if(!t.deleted&&n&&n.length===1&&!n[0].has_children()&&i.indexOf(n[0])===-1){d3.select(this).datum(n[0]);i.push(n[0])}})}var n=this;this.model.events.on("scrubbability-changed."+this.id,function(){n.update_existing("normal",true)})};it.fontPresets={Kalam:{normal_font:{family:"Kalam"},italic_font:{family:"Kalam"},font_baseline_shift:.4,font_ascent:.9,font_descent:.2,slanted_div_bar:true,div_bar_height:1/16},"Crimson Text":{normal_font:{family:"Crimson Text"},italic_font:{family:"Crimson Text Italics"},font_baseline_shift:.24,font_ascent:.73,font_descent:.18,slanted_div_bar:false,div_bar_height:1/16}};it.defaultOptions={font_size:80,auto_update:true,color:"#333",scrubbing_color:"Blue",selection_color:"#DE2F2F",inactive_color:"#676965",fraction_size_factor:.7,exp_size_factor:.7,subscript_size_factor:.7,smooshed_nodes_shrink_factor:.5,debug_lines:false,debug_draw:false,dur:300,dur_dragging:300,easing_fn:"cubic-in-out",pos:[0,0],mode:"transform",modes:["edit","inspect"],v_align:"alphabetic",h_align:"center",background_color:"none",bg_visible:false,shadow_filter:null,border_color:"none",shadow_color:"none",border_radius:0,padding:{left:0,right:0,top:0,bottom:0},interactive:true,event_receiver:null,font_preset:"Kalam",wiggle_dur:200,wiggle_deg:10,wiggle_random_delay:100,show_node_targets:true,shadow_node_stroke:"#888",shadow_node_stroke_width:.75,shadow_node_fill:"white",enable_drag_to_join:true,visualize_scrubbable_nodes:true,rubber_band_selection:true,hide_mouse_cursor:true,hold_time:1500,replace_value_on:true};it.prototype.setMode=function(t){if(!t)return this.mode;if(this.options.modes.every(function(e){return e!==t}))return false;this.mode=t;return true};it.prototype.onChange=function(t){if(t.old_model!==t.new_model){this.bindToModel(t.new_model,t.node_map);if(this.options.auto_update)this.update_all(true)}else{if(this.options.auto_update)this.update_all(t.no_anim)}if(t.no_anim)this.onEOI()};it.prototype.onEOI=function(t){this.main.selectAll("g.math").filter(function(t){return t.deleted}).remove();this.main.selectAll("g.math_shadow").filter(function(t){return t.shadow_deleted}).remove()};it.prototype.callAfterAnimation=function(t){if(!this.is_animating)t();else this.afterAnimationCallbacks.push(t)};it.prototype.animationFinished=function(){this.is_animating=Math.max(0,this.is_animating-1);if(this.is_animating>0)return;this.afterAnimationCallbacks.forEach(function(t){t()});this.afterAnimationCallbacks=[]};it.prototype.initializeOptions=function(t){t=t||{};var e=t.font_preset||it.defaultOptions.font_preset,i=e?it.fontPresets[e]:{};var n=gmath.object.merged(i,it.defaultOptions);n.pos=n.pos.slice();n.padding=gmath.extend({},n.padding);n.normal_font=gmath.extend({},n.normal_font);n.italic_font=gmath.extend({},n.italic_font);this.options=gmath.extend(n,t);if(t.padding){var r=t.padding;if(typeof r==="number"){this.options.padding={left:r,right:r,top:r,bottom:r}}else gmath.extend(this.options.padding,r)}};it.prototype.init=function(t){this.main=this.svg.append("g").attr("id",this.options.id).attr("class","main").attr("transform","translate("+this.options.pos+")");this.shadow_rect=this.main.append("rect").attr({rx:this.options.border_radius,ry:this.options.border_radius}).style("fill","none").attr("filter",this.options.shadow_filter).style("stroke",this.options.shadow_color).style("visibility",this.options.shadow_filter?"visible":"hidden");this.border_rect=this.main.append("rect").attr({rx:this.options.border_radius,ry:this.options.border_radius}).style("fill",this.options.background_color).style("stroke",this.options.border_color).style("visibility",this.options.bg_visible?"visible":"hidden");if(this.options.event_receiver){this.event_receiver=d3.select(this.options.event_receiver)}else{this.event_receiver=this.main}if(this.options.debug_lines){this.main.append("line").attr("x1",-1e3).attr("x2",1e3).attr("stroke-width","0.5").attr("stroke","lightblue");this.main.append("line").attr("y1",-1e3).attr("y2",1e3).attr("stroke-width","0.5").attr("stroke","lightblue")}this.renderer=new rt(this,this.options.h_align,this.options.v_align);this.interaction_handler=new F(this,this.options.interactive);this.main.classed("interactive",this.options.interactive);this.interaction_handler.setMode(this.mode);var e=[this.options.normal_font,this.options.italic_font];if(!it.fontloader){it.fontloader=O(e,2e3);this.fontloader=it.fontloader}else{this.fontloader=it.fontloader;this.fontloader.add_fonts(e)}var i=this;this.fontloader.on_fonts_loaded(function(){i.update_all(true);if(t)t()})};it.prototype.interactive=function(t){if(arguments.length===0)return this.options.interactive;this.options.interactive=t;this.interaction_handler.set_interactive(t);this.main.classed("interactive",this.options.interactive);return this};it.prototype.wiggle=function(t,e){if(!Array.isArray(t))t=[t];var i=[];for(var n=0;n<t.length;n++){var r=t[n].split(":");var o=r.length===1?this.model.getRanges(r[0]):this.model.getRanges(r[0],Number(r[1])-1);if(o)i=i.concat(o)}var s=gmath.array.flatten(i);if(s.length===0)return;this.wiggleNodes(s,e);this.interaction_handler.events.on("touch."+this.id,this.wiggleNodes.bind(this,null,false))};it.prototype.wiggleNodes=function(t,e){if(arguments.length<2)e=true;if(!t)t=this.model.children;if(!Array.isArray(t))t=[t];var i=[];t.forEach(function(t){if(t.has_children())i=i.concat(t.get_leaf_nodes());else i.push(t)});var n=this.node_sel.filter(function(t){return i.indexOf(t)!==-1}).select("g.offset");var r=this.options;var o=function(t,e,i){var n=d3.interpolate(t,e);return function(t){var e=it.getCenter(t);return function(t){return"rotate("+n(t)+" "+e+")"}}};function s(t){d3.select(this).transition().duration(r.wiggle_dur).attrTween("transform",o(r.wiggle_deg,-r.wiggle_deg)).transition().duration(r.wiggle_dur).attrTween("transform",o(-r.wiggle_deg,r.wiggle_deg)).each("end",s)}if(e){n.transition().delay(function(){return Math.random()*r.wiggle_random_delay}).duration(r.wiggle_dur/2).attrTween("transform",o(0,r.wiggle_deg)).each("end",s)}else{n.interrupt().transition().attr("transform",null)}};it.getCenter=function(t){var e=t.sel_box;return[e.x+e.width/2,-t.size*.24]};it.prototype.reposition=function(t){var e=this;e.renderer.set_position(e.model.children,true);e.update_existing()};it.prototype.getSmooshedNodesSelection=function(e){var i=this.main.selectAll("g.math_smooshed").data(t.get_leaf_nodes(e),function(t){return t.id});return i};it.prototype.enterSmooshed=function(t){var e=this;var i=this.getSmooshedNodesSelection(t);var n=i.enter().insert("g","g").classed("math_smooshed",true).attr("transform",function(t){return"translate("+t.x+","+t.y+")"}).style("opacity",.6);n.append("g").classed("offset",true);n.select("g.offset").append("rect").style("visibility",this.options.debug_draw?"visible":"hidden").style("stroke","black").style("fill","none").classed("selector",true);var r=n.filter(function(t){return t.value==="//"}).select("g.offset");var o=r.append("line").style("stroke-linecap","round").call(nt,this.options.slanted_div_bar,"normal").attr("x2",function(t){return t.width*e.options.smooshed_nodes_shrink_factor+"px"}).style("stroke",function(t){return e.options.selection_color}).style("opacity",function(t){return 1});n.select("g.offset").append("text").style("font-family",function(t){return e.get_font(t).family}).style("font-weight",function(t){return e.get_font(t).weight}).style("font-style",function(t){return e.get_font(t).style}).style("font-size",function(t){return t.size+"px"}).style("fill",function(t){return e.options.selection_color}).style("opacity",function(t){return t.hidden?1e-5:1}).text(function(t){return t.to_string()});n.select("text").transition().duration(this.options.dur).ease(this.options.easing_fn).style("font-size",function(t){return t.size*e.options.smooshed_nodes_shrink_factor+"px"})};it.prototype.updateSmooshed=function(t){var e=this;var i=this.getSmooshedNodesSelection(t);i.transition().duration(this.options.dur_dragging).ease("circle-out").attr("transform",function(t){return"translate("+t.x+","+t.y+")"})};it.prototype.exitSmooshed=function(){this.main.selectAll("g.math_smooshed").remove()};it.prototype.enterSmooshIndicator=function(t){var e=this.main.selectAll(".smooshIndicator").data([t]);var i=e.enter();i.insert("circle").classed("smooshIndicator",true).attr("transform",function(t){return"translate("+t[0]+","+t[1]+")"}).attr("r",5).style({fill:this.options.selection_color,opacity:.5})};it.prototype.updateSmooshIndicator=function(t){var e=this.main.selectAll(".smooshIndicator").data([t]);e.attr("transform",function(t){return"translate("+t[0]+","+t[1]+")"})};it.prototype.exitSmooshIndicator=function(){var t=this.main.select(".smooshIndicator").remove()};it.prototype.update_all=function(t){var e=this.options.dur;if(t)this.options.dur=0;this.renderer.set_style(this.model.children);this.renderer.set_position(this.model.children,true);this.enter_and_exit("normal");this.update_existing("normal");this.events.updated({type:"updated",source:this,sender_id:this.id});this.is_animating++;setTimeout(this.animationFinished.bind(this),this.options.dur);this.options.dur=e};it.prototype.enter_and_exit=function(t){var e;if(t==="normal"){e=this.getNormalNodesSelection()}else if(t==="shadow"){e=this.getShadowNodesSelection()}else{throw"No node type specified for node visualization -- AlgebraView.js/enter_and_exit"}if(e.length>0){this._enter(e,t);e.selectAll("g.math text").on("hold",function(t){var e=t.datum();if(!gmath.actions.splitNumberWithKeyboardAction.match(e))return;var i=gmath.actions.splitNumberWithKeyboardAction.createBoundAction(e.get_root(),{actor:e});e.get_root().performAction(i,null,true)});this._exit(e,t)}};it.prototype.getNormalNodesSelection=function(){var e=this.main.selectAll("g.math").data(t.get_leaf_nodes(this.model.children),function(t){return t.id});return e};it.prototype.getShadowNodesSelection=function(){if(!this.options.show_node_targets){return[]}var e=this.model.filter(function(t){return t.dragging});var i=t.filter(function(t){return!t.has_children()},e);var n=this.main.selectAll("g.math_shadow").data(i,function(t){return t.id});return n};it.prototype._enter=function(t,e){var i=this;var n;if(e==="normal"){n=t.enter().append("g").classed("math",true).attr("id",function(t){return t.id}).attr("transform",function(t){return"translate("+t.x+","+t.y+")"})}else{n=t.enter().insert("g","g.math").classed("math_shadow",true).attr("transform",function(t){return"translate("+t.x0+","+t.y0+")"}).each(function(t){t.shadow_deleted=false})}n.append("g").classed("offset",true);n.select("g.offset").append("rect").attr("visibility",this.options.debug_draw?"visible":"hidden").style("stroke","black").style("fill","none").classed("selector",true);var r=n.filter(function(t){return t.value==="//"}).select("g.offset");var o=r.append("line").style("stroke-linecap","round").call(nt,this.options.slanted_div_bar,e).style("opacity",function(t){return e==="normal"?t.smooshing||!t.no_anim||t.hidden?1e-5:1:t.hidden||t.hide_after_drop?0:1});var s=n.select("g.offset").append("text").style("font-family",function(t){return i.get_font(t).family}).style("font-weight",function(t){return i.get_font(t).weight}).style("font-style",function(t){return i.get_font(t).style}).style("font-size",function(t){return t.size+"px"}).style("pointer-events","none");if(e==="normal"){s.style("stroke","none").style("fill",function(t){return t.color}).style("opacity",function(t){return t.smooshing||!t.no_anim||t.hidden?1e-5:1}).text(function(t){return t.to_string()});if(this.options.debug_draw)this.debugDraw(n);t.each(function(t){return t.no_anim=false})}else{s.style("stroke",i.options.shadow_node_stroke).style("stroke-width",i.options.shadow_node_stroke_width).style("fill",i.options.shadow_node_fill).style("opacity",function(t){return t.hidden||t.hide_after_drop?0:1})}return n};it.prototype._exit=function(t,e){var i=this;var n=t.exit().each(function(t){if(e==="normal")t.deleted=true;else t.shadow_deleted=true}).transition().ease("linear").duration(function(t){return t.no_anim?0:i.options.dur}).attr("transform",function(t){return"translate("+(t.x0||0)+","+(t.y0||0)+")"});n.select("*").style("opacity",1e-5);n.each("end",function(){this.style.display="none"});if(e==="normal"){this.node_sel=t}};it.prototype.update_existing=function(t,e){var i=this;var n=this.svg.selectAll(t==="normal"?"g.math":"g.math_shadow").filter(function(e){if(t==="normal")return!e.deleted;else return!e.shadow_deleted});var r=n.transition().duration(e?0:this.options.dur).ease(this.options.easing_fn);if(t==="normal"){r.attr("transform",function(t){return"translate("+(t.x||0)+","+(t.y||0)+")"})}else{r.attr("transform",function(t){return"translate("+(t.x0||0)+","+(t.y0||0)+")"})}var o=n.select("text").transition().duration(0).text(function(t){return t.to_string()}).transition().duration(e?0:this.options.dur).ease("linear").style("font-size",function(t){return t.size+"px"});if(t==="normal"){o.style("fill",function(t){return t.color}).style("opacity",function(t){if(t.smooshing||t.hidden)return 1e-5;return 1})}else{o.style("opacity",function(t){return t.hidden||t.hide_after_drop?0:1})}var a=t==="normal"?n.select("line"):n.filter(function(t){return t.value==="//"}).select("line");a.transition().duration(e?0:this.options.dur).ease("linear").call(nt,this.options.slanted_div_bar,t).style("opacity",function(e){return t==="normal"?e.smooshing||e.hidden?1e-5:1:e.hidden||e.hide_after_drop?0:1});if(t==="normal"){if(this.options.visualize_scrubbable_nodes&&this.mode==="inspect"){var h=n.each(function(t){var e=d3.select(this);var i=e.selectAll(".scrub");if(i.size()===0&&s.is_num(t)&&!t.fixed&&!t.locked){e.append("path").attr({"class":"scrub",d:"M-.5,0 L.5,0 L0,-.7 Z"});e.append("path").attr({"class":"scrub",d:"M-.5,0 L.5,0 L0,.7 Z"});i=e.selectAll(".scrub");i.style({fill:t.color,"stroke-linejoin":"round",stroke:t.color,"stroke-width":"0.3px",opacity:.5})}i.style("visibility",!t.locked?"visible":"hidden");i.attr("transform",function(t,e){return e===0?"translate("+[t.sel_box.x+t.sel_box.width/2,-t.ascent]+")scale("+t.size/5+")":"translate("+[t.sel_box.x+t.sel_box.width/2,t.descent]+")scale("+t.size/5+")"})})}else{n.selectAll(".scrub").remove()}n.select("rect").attr("x",function(t){return t.sel_box?t.sel_box.x:0}).attr("y",function(t){return t.sel_box?t.sel_box.y:0}).attr("width",function(t){return t.hidden||!t.sel_box?0:t.sel_box.width}).attr("height",function(t){return t.hidden||!t.sel_box?0:t.sel_box.height});this.update_background()}return true};it.prototype.update_background=function(t){var e=this.model.children[0];var i=this.getBBox();if(e&&!e.dragging){this.border_rect.attr({rx:this.options.border_radius,ry:this.options.border_radius}).style("fill",this.options.background_color).style("stroke",this.options.border_color).attr(i);this.shadow_rect.transition().duration(t?0:this.options.dur).attr(i)}};it.prototype.set_background_visible=function(t){this.options.bg_visible=!!t;this.border_rect.style("visibility",t?"visible":"hidden")};it.prototype.getBBox=function(t){t=t||{};var e=this.model.children[0];if(!e||!e.sel_box)return{x:0,y:0,width:0,height:0};var i={};var n=this.options.padding;i.x=e.sel_box.x+(e.dragging?e.x0:e.x)-(t.no_padding?0:n.left);i.y=e.sel_box.y+(e.dragging?e.y0:e.y)-(t.no_padding?0:n.top);i.width=e.sel_box.width+(t.no_padding?0:n.left+n.right);i.height=e.sel_box.height+(t.no_padding?0:n.top+n.bottom);return i};it.prototype.update_positions=function(t){this.node_sel.filter(function(e){return t.indexOf(e)!==-1}).transition().duration(this.options.dur_dragging).ease("circle-out").attr("transform",function(t){return"translate("+(t.x||0)+","+(t.y||0)+")"})};it.prototype.update_style=function(t){this.node_sel.select("text").transition().duration(t?0:this.options.dur).ease("linear").style("font-size",function(t){return t.size+"px"}).style("fill",function(t){return t.color}).style("opacity",function(t){if(t.hidden)return 1e-5;if(t.hide_after_drop)return.4;return 1});this.node_sel.select("line").transition().duration(t?0:this.options.dur).ease("linear").call(nt,this.options.slanted_div_bar).style("opacity",function(t){if(t.hidden)return 1e-5;if(t.hide_after_drop)return.4;return 1})};function nt(t,e,i){t.attr("x1",0).attr("x2",function(t){return t.width}).style("stroke-width",function(t){return i==="normal"||!i?t.height:t.height/2}).style("stroke",function(t){return i==="normal"||!i?t.color:"#ddd"});if(e){t.attr("y1",function(t){return.2*t.height}).attr("y2",function(t){return-.2*t.height})}}it.prototype.force_refresh=function(){var t=this.svg.node();t.style.display="none";t.style.display="block"};it.prototype.get_utf8=function(t){var e={"-":"−","*":"·","/":""};if(t.value in e)return e[t.value];if(typeof t.value=="number"&&t.value<0)return e["-"]+Math.abs(t.value);return t.value};it.prototype.get_font=function(t){return t instanceof h?this.options.italic_font:this.options.normal_font};it.prototype.get_width=function(t){return this.fontloader.width(t.to_string(),t.size,get_font(t))};it.prototype.debugDraw=function(t){var e=this;t.select("g.offset").append("rect").style("stroke","orange").style("opacity",function(t){return t.hidden?.3:1}).style("fill","none").attr({x:function(t){return t.sel_box.x},width:function(t){return t.sel_box.width},y:function(t){return t.size*e.options.font_descent-.5},height:1});t.select("g.offset").append("rect").style("stroke","green").style("opacity",function(t){return t.hidden?.3:1}).style("fill","none").attr({x:function(t){return t.sel_box.x},width:function(t){return t.sel_box.width},y:function(t){return-t.size*e.options.font_ascent-.5},height:1});t.select("g.offset").append("rect").style("stroke","blue").style("opacity",function(t){return t.hidden?.3:1}).style("fill","none").attr({x:function(t){return t.sel_box.x},width:function(t){return t.sel_box.width},y:function(t){return-t.size*e.options.font_baseline_shift-.5},height:1})};CanvasElement=function(t,e,i){i=i||{};this.id=i.id||gmath.uid();this.type="canvas-element";this.canvas_model=t;this.events=d3.dispatch("start-of-interaction","end-of-interaction","active","move","resize");this.mouse_events=d3.dispatch("touch","drag","release");this.initCanvasElementOptions(i);this.initElement(e);this.initCanvasElementProperties()};gmath.CanvasElementClass=CanvasElement;CanvasElement.defaultOptions={visualized:true,pos:{x:"center",y:"center"},min_size:{width:30,height:50},size:{width:10,height:10},active:false,mode:"edit",modes:["edit","arrange"],resizable:{x:true,y:true},draggable:true,send_events:true,dont_log_events:false,delete_btn_size:20,delete_btn_color:"silver",resize_tab_size:25,resize_tab_color:"#c6c6c6",dur:300,easing_fn:"cubic-in-out",edit_mode_drag_box_width:"20px",show_bg:true,bg_edit_style:{"background-color":"transparent","box-shadow":"none","border-radius":"2px"},bg_edit_active_style:{"background-color":"rgba(255,255,255,0.9)","box-shadow":"none"},bg_arrange_style:{"background-color":"rgba(255,255,255,0.9)","box-shadow":"0 3px 6px rgba(0,0,0,0.23)"},bg_arrange_active_style:{"background-color":"rgba(255,255,255,0.9)","box-shadow":"0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23)"}};CanvasElement.prototype.emitEvent=function(t,e){var i={type:t,source:this,time:Date.now()};if(e)i=gmath.extend(i,e);this.events[t](i)};CanvasElement.prototype.initCanvasElementOptions=function(t){t=t||{};var e=gmath.deepCopy(CanvasElement.defaultOptions);this.options=gmath.object.extendExisting(e,t);delete this.options.id};CanvasElement.prototype.initElement=function(t){if(!this.options.visualized)return;if(arguments.length===0)return this.containing_group.node();this.containing_group=d3.select(t);this.container_size=this.getContainerSize();if(this.element_div)this.containing_group.node().appendChild(this.element_div.node());else{this.element_div=this.containing_group.append("div").classed("canvas-element",true).attr("id",this.id).datum(this).on("mouseenter."+this.id,this.mouseHovering.bind(this,true)).on("mouseleave."+this.id,this.mouseHovering.bind(this,false)).style("pointer-events","all").style("position","absolute");div=this.element_div}if(this.delete_grp)this.delete_grp.selectAll("rect").style("fill",this.options.delete_btn_color);return this};CanvasElement.prototype.initCanvasElementProperties=function(){this.mode=this.options.mode;this.active=this.options.active;if(!this.options.visualized)return;this.size=gmath.extend({},this.options.size);this.pos=this.alignmentToPosition(this.options.pos);this.translateElement(this.pos);this.element_div.style("height",this.size.height+"px").style("width",this.size.width+"px");this.updateBGStyle()};CanvasElement.prototype.setMode=function(t,e){if(!this.options.visualized)return;if(!t)return this.mode;if(t===this.mode)return false;if(this.options.modes.every(function(e){return e!==t}))this.setMode("edit");this.destroyMode();this.mode=t;this.initMode();this.updateBGStyle();return!e};CanvasElement.prototype.destroyMode=function(){this.destroySubTypeMode();this.removeModeComponents();this.stopModeBehavior()};CanvasElement.prototype.destroySubTypeMode=function(){return};CanvasElement.prototype.removeModeComponents=function(){if(this.mode==="arrange")this.removeArrangeComponents()};CanvasElement.prototype.stopModeBehavior=function(){if(this.mode==="arrange")this.stopArrangeBehavior()};CanvasElement.prototype.initMode=function(){if(!this.options.visualized)return;this.initModeComponents();this.initModeBehavior();this.initSubTypeMode()};CanvasElement.prototype.initModeComponents=function(){if(this.mode==="arrange")this.initArrangeComponents()};CanvasElement.prototype.initModeBehavior=function(){if(this.mode==="edit")this.initEditBehavior();if(this.mode==="arrange")this.initArrangeBehavior()};CanvasElement.prototype.initSubTypeMode=function(){return};CanvasElement.prototype.initEditBehavior=function(){if(!this.edit_mtouch)this.edit_mtouch=mtouch_events();else this.edit_mtouch.connected(true);var t=this;this.edit_mtouch.origin(function(t){return[t.pos.x,t.pos.y]}).on("touch."+this.id,this.touch.bind(this,null)).on("drag."+this.id,this.drag.bind(this,null)).on("release."+this.id,this.release.bind(this,null));this.element_div.append("div").style({position:"absolute",left:0,top:0,bottom:0,width:this.options.edit_mode_drag_box_width}).style("cursor",this.options.draggable?"move":null).call(this.edit_mtouch)};CanvasElement.prototype.stopEditBehavior=function(){if(!this.edit_mtouch)return;this.edit_mtouch.on("touch."+this.id,null).on("drag."+this.id,null).on("release."+this.id,null);this.edit_mtouch.connected(false)};CanvasElement.prototype.initArrangeComponents=function(){var t=this;this.arrange_mode_div=this.element_div.append("div").classed("canvas-element-arrange-pane",true).datum(this).style({position:"absolute",left:0,right:0,top:0,bottom:0}).style("pointer-events","all").style("cursor",this.options.draggable?"move":null);var e=this.options.delete_btn_size;var i=5;this.delete_grp=this.element_div.append("svg").style({position:"absolute",width:e+2*i+"px",height:e+2*i+"px",right:-i+2+"px",top:-i+2+"px"});this.delete_icon=this.delete_grp.append("g").style("mouse-events","all").on("mouseenter",function(){d3.select(this).selectAll("rect").style("fill","red")}).on("mouseleave",function(){d3.select(this).selectAll("rect").style("fill",t.options.delete_btn_color)}).attr("transform","translate("+[e/2+i,e/2+i]+")rotate(45)");this.delete_icon.append("circle").attr({r:e/2+i}).style("opacity",0);this.delete_icon.append("rect").attr({width:e,height:e/3.5,x:-e/2,y:-e/7}).style("fill",this.options.delete_btn_color).style("stroke","none");this.delete_icon.append("rect").attr({width:e/3.5,height:e,x:-e/7,y:-e/2}).style("fill",this.options.delete_btn_color).style("stroke","none");if(this.options.resizable.x||this.options.resizable.y){var n;if(this.options.resizable.x&&this.options.resizable.y)n="nwse-resize";else if(this.options.resizable.x)n="ew-resize";else n="ns-resize";var r=this.options.resize_tab_size;this.resize_grp=this.element_div.append("svg").style({position:"absolute",width:r+2*i+"px",height:r+2*i+"px",right:-i+"px",bottom:-i+"px"});this.resize_icon=this.resize_grp.append("g").style("mouse-events","all").attr("transform","translate("+[r+i,r+i]+")").style("cursor",n);this.resize_icon.append("circle").attr({r:r/2+5,cx:-r/3,cy:-r/3}).style("opacity",0);this.resize_icon.append("path").attr("d","M"+[-r,0]+"L"+[0,0]+"L"+[0,-r]+"Z").style("fill",this.options.resize_tab_color).style("stroke","none")}};CanvasElement.prototype.updateArrangeComponents=function(){};CanvasElement.prototype.initArrangeBehavior=function(){var t=this;if(!this.arrange_mtouch)this.arrange_mtouch=mtouch_events();else this.arrange_mtouch.connected(true);this.arrange_mtouch.origin(function(t){return[t.pos.x,t.pos.y]}).on("touch."+this.id,this.touch.bind(this,null)).on("drag."+this.id,this.drag.bind(this,null)).on("release."+this.id,this.release.bind(this,null));this.arrange_mode_div.call(this.arrange_mtouch);this.delete_grp.call(mtouch_events().on("touch",function(){}).on("release",function(){if(!this.contains(d3.event.sourceEvent.target))return;t.emitEvent("start-of-interaction");t.canvas_model.removeElement(t);t.emitEvent("end-of-interaction")}));if(this.resize_grp){this.resize_grp.call(mtouch_events().origin(function(){return[t.size.width,t.size.height]}).on("touch."+this.id+"_resize",function(){t.emitEvent("start-of-interaction",{size:gmath.deepCopy(t.size)})}).on("drag."+this.id+"_resize",this.resize.bind(this,null)).on("release."+this.id+"_resize",function(){t.emitEvent("end-of-interaction",{
size:gmath.deepCopy(t.size)})}))}};CanvasElement.prototype.removeArrangeComponents=function(){this.arrange_mode_div.remove();this.delete_grp.remove();if(this.resize_grp)this.resize_grp.remove()};CanvasElement.prototype.stopArrangeBehavior=function(){if(!this.arrange_mtouch)return;this.arrange_mtouch.on("touch."+this.id,null).on("drag."+this.id,null).on("release."+this.id,null);this.arrange_mtouch.connected(false)};CanvasElement.prototype.getContainerSize=function(){if(this.canvas_model)return this.canvas_model.size();else return this.containing_group.node().getBoundingClientRect()};CanvasElement.prototype.touch=function(t){this.emitEvent("start-of-interaction",{pos:gmath.deepCopy(this.pos)});var e=t||d3.event;this.container_size=this.getContainerSize();if(this.mode!=="arrange")this.setActive(true)};CanvasElement.prototype.drag=function(t){var e=t||d3.event;if(!this.options.draggable)return;if(!this.hovering){e.x=Math.max(0,Math.min(this.container_size.width-this.size.width,e.x));e.y=Math.max(0,Math.min(this.container_size.height-this.size.height,e.y))}this.translateElement(e)};CanvasElement.prototype.release=function(t){var e=t||d3.event;this.emitEvent("end-of-interaction",{pos:gmath.deepCopy(this.pos)})};CanvasElement.prototype.resize=function(t){var e=t||d3.event;if(!this.options.resizable.x)e.x=this.size.width;if(!this.options.resizable.y)e.y=this.size.height;this.resizeElement({width:e.x,height:e.y})};CanvasElement.prototype.resizeElement=function(t){var e=Math.max(this.options.min_size.width,t.width),i=Math.max(this.options.min_size.height,t.height);e=Math.min(e,e-(t.width+this.pos.x-this.container_size.width));i=Math.min(i,i-(t.height+this.pos.y-this.container_size.height));if(this.size.width===e&&this.size.height===i)return;this.size.width=e;this.size.height=i;this.element_div.style("width",this.size.width+"px").style("height",this.size.height+"px");if(this.mode==="arrange"){this.updateArrangeComponents();this.updateSubTypeArrangeComponents()}this.subTypeResize();this.events.resize({type:"resize",size:{width:this.size.width,height:this.size.height}})};CanvasElement.prototype.updateSubTypeArrangeComponents=function(){return};CanvasElement.prototype.subTypeResize=function(){return};CanvasElement.prototype.initPosition=function(t){this.pos=this.alignmentToPosition(this.options.pos);this.translateElement(this.pos,t)};CanvasElement.prototype.alignmentToPosition=function(t){var e=t.x,i=t.y;if(e==="center")e=this.container_size.width/2-this.size.width/2;else if(e==="left")e=0;else if(e==="right")e=this.container_size.width-this.size.width;if(i==="center")i=this.container_size.height/2-this.size.height/2;else if(i==="top")i=0;else if(i==="bottom")i=this.container_size.height-this.size.height;return{x:e,y:i}};CanvasElement.prototype.translateElement=function(t,e){if(!this.options.visualized)return;this.pos.x=t.x;this.pos.y=t.y;var i=[Math.round(this.pos.x)+"px",Math.round(this.pos.y)+"px",0];if(e){this.element_div.transition().duration(this.options.dur).ease(this.options.easing_fn).style("transform","translate3d("+i+")").style("-webkit-transform","translate3d("+i+")")}else{this.element_div.style("transform","translate3d("+i+")").style("-webkit-transform","translate3d("+i+")")}this.events.move({type:"move",animated:e,pos:{x:this.pos.x,y:this.pos.y}})};CanvasElement.prototype.mouseHovering=function(t){if(this.canvas_model)this.canvas_model.setActive(this,t);else this.setActive(t)};CanvasElement.prototype.setActive=function(t){if(this.active!==t){this.active=t;this.updateBGStyle();if(this.mode!=="arrange")this.setSubTypeActive();this.emitEvent("active",{active:t})}};CanvasElement.prototype.setSubTypeActive=function(){return};CanvasElement.prototype.updateBGStyle=function(){if(!this.options.show_bg)return;var t=this.mode!=="arrange"?"edit":"arrange";var e="bg_"+t+"_"+(this.active?"active_":"")+"style";this.element_div.style("visibility",null).style(this.options[e])};CanvasElement.prototype.removeElement=function(){this.element_div.remove()};CanvasElement.prototype.getBBox=function(){return{x:this.pos.x,y:this.pos.y,width:this.size.width,height:this.size.height}};CanvasElement.prototype.overlapsWithRegion=function(t){gmath.HitTester.overlaps({x:this.pos.x,y:this.pos.y,width:this.size.width,height:this.size.height},t)};CanvasElement.prototype.hitTest=function(t){return t.x>=this.pos.x&&t.x<=this.pos.x+this.size.width&&t.y>=this.pos.y&&t.y<=this.pos.y+this.size.height};DerivationList=function(t,e,i,n){CanvasElement.call(this,t,e,i);this.type="derivation";this.events=gmath.extend(this.events,d3.dispatch("added_line","change","inspect_node","clone","pack_state","hover","mistake"));this.row_events=d3.dispatch("drag","touch","tap","release");this.update_sequence=0;this.initDerivationListOptions(i);this.initDerivationListProperties();this.initDerivationList(n);this.initMode()};gmath.inherit(CanvasElement,DerivationList);gmath.DerivationList=DerivationList;DerivationList.defaultOptions={eq:"",pos:{x:"center",y:"center"},debug_lines:false,visualize_derivations:"none",visualize_derivations_method:"all",embedded:true,border_radius:0,v_align:"center",h_align:"equals",row_padding:{left:10,right:45,top:7,bottom:3},padding:{left:20,right:5,top:5,bottom:5},handle_pos:"right",handle_stroke_color:"#ddd",row_border_color:"#ddd",row_background_color:"white",font_size:50,collapsed_mode:false,draggable:true,no_history:false,no_handles:false,hide_handles:false,break_off_dist:50,wiggle:[],auto_resize_container:false,keep_in_container:true,cloning_on:true,replace_value_on:true,hoverable:false,auto_collapse_repeated_actions:true,auto_simplify_distributions:true,auto_simplify_vector_additions:true,auto_simplify_variables:true,modes:["edit","inspect","arrange"],send_events:true,mappings_color:"#E6F3DE",mappings_active_node_color:"rgb(194, 219, 179)",mappings_rect_radius:6,mappings_joint_width:16,mappings_joint_length:8,mappings_line_thickness:6,row_transition_dur:250,resizable:{x:false,y:false},action_blacklist:[]};DerivationList.prototype.toJSON=function(){return gmath.extend(gmath.deepCopy(this.options),{id:this.id,type:"DerivationList",pos:this.pos})};DerivationList.createFixedSingleLineDL=function(t,e,i){e=e||{};e.keep_in_container=false;e.draggable=false;e.no_handles=true;e.collapsed_mode=true;e.show_bg=false;e.h_align="h_align"in e?e.h_align:"center";return new DerivationList(null,t,e,i)};DerivationList.prototype.startUpdateSequence=function(){if(!this.options.visualized)return;this.update_sequence++};DerivationList.prototype.isInUpdateSequence=function(){if(!this.options.visualized)return;return this.update_sequence>0};DerivationList.prototype.finishUpdateSequence=function(){if(!this.options.visualized)return;this.update_sequence--;if(this.update_sequence===0)this.updateDims();if(this.update_sequence<0)throw"called finishUpdateSequence before startUpdateSequence"};DerivationList.prototype.initDerivationListOptions=function(t){t=t||{};var e=gmath.deepCopy(DerivationList.defaultOptions);if(t.standalone)e.show_bg=false;var i=gmath.object.extendExisting(e,t);if(!("hide_handles"in t)&&t.no_history)i.hide_handles=!i.draggable;gmath.extend(this.options,i);var n=gmath.object.merged(DerivationList.defaultOptions,t);this.aview_options=gmath.object.extendChanged({},n,gmath.AlgebraView.defaultOptions);this.amodel_options=gmath.object.extendChanged({},n,gmath.AlgebraModel.defaultOptions)};DerivationList.prototype.initDerivationListProperties=function(){this.rows=[];this.hovering=false;this.active_dl_component="none";this.curr_row_operation="none";this.clone=null;this.dims={}};DerivationList.prototype.initDerivationList=function(t){var e=this;if(this.options.visualized){this.svg=this.element_div.append("svg").style({position:"absolute",left:0,right:0,top:0,bottom:0,width:"100%",height:"100%"}).style("overflow","visible");this.alignment_correction=this.svg.append("g")}if(this.options.eq.length>0){this.addLineFromExpressions(this.options.eq.split("\\\\"),function(){e.initPosition();if(e.options.visualized){e.startWiggle(e.options.wiggle)}if(t)t(e)})}else if(t)t(this)};DerivationList.prototype.addLineFromExpressions=function(t,e){if(t.length<1){if(e)e(this);return}for(var i=0;i<t.length;i++)this.addLineFromExpression(t[i],i===t.length-1?e:null)};DerivationList.prototype.addLineFromExpression=function(t,e){if(this.rows.length>0)this.rows[this.rows.length-1].deactivate();this.addRowFromAscii(t,e)};DerivationList.prototype.startWiggle=function(t){var e=this.getLastView();e.wiggle(t,true)};DerivationList.prototype.setExpression=function(t,e,i){this.getLastModel().parseAndSet(t,e,i)};DerivationList.prototype.destroySubTypeMode=function(){if(this.mode==="inspect")this.draw_mappings_for_nodes([])};DerivationList.prototype.initSubTypeMode=function(){this.rows.forEach(function(t,e){if(t.view){t.view.interaction_handler.setMode(this.mode);t.view.update_existing("normal")}},this)};DerivationList.prototype.singleLineMode=function(t){if(arguments.length===0)return this.options.collapsed_mode;if(t&&!this.options.collapsed_mode){var e=false;for(var i=0;i<this.rows.length-1;i++){if(!this.rows[i].hidden){e=true;this.rows[i].hide()}}if(e)this.layoutRows()}this.options.collapsed_mode=t;return this};DerivationList.prototype.getLastRow=function(){return this.rows[this.rows.length-1]};DerivationList.prototype.getRowByModel=function(t){for(var e=0;e<this.rows.length;e++){if(this.rows[e].model===t)return this.rows[e]}return null};DerivationList.prototype.getLastModel=function(){return this.getLastRow().model};DerivationList.prototype.getLastView=function(){return this.getLastRow().view};DerivationList.prototype.onChange=function(t){var e=this.getRowByModel(t.old_model);if(!e)return;if(t.new_model!==t.old_model){this.removeModelEventListeners(t.old_model);this.addModelEventListeners(t.new_model);e.model=t.new_model}this.events.change(gmath.extend(new DerivationList.ChangeEvent(this.id,e.model,e.idx),t))};DerivationList.prototype.onCreate=function(t){this.startUpdateSequence();try{var e=this.getLastView();var i=this.getLastRow();var n=i.el,r=i.handle;var o=t.action.oldTree;o.for_each(function(t){t.dragging=false;t.selected=false});o.hide_nodes();var s=this.addRowFromAction(t.action);this.events.added_line(gmath.extend({senderDL_id:this.id,row:i.idx},t));if(this.options.visualized)i.hide();gmath.LinkCoordinator.addLink(new AlgebraModelLink(t.action.oldTree,t.action.newTree,t.action));if(t.action.name==="SubstitutionAction"){gmath.LinkCoordinator.addLink(new AlgebraModelLink(t.action.nodes[0],t.action.newTree,t.action))}this.events.change(new DerivationList.ChangeEvent(this.id,s.model))}finally{this.finishUpdateSequence()}};DerivationList.prototype.onRestraint=function(t){var e=this.pos.x+this.size.width,i=this.pos.y+this.getLastRow().pos[1];this.canvas_model.createElement("textbox",{text:t,pos:{x:e,y:i},undeditable:true,resizable:{x:false,y:false},use_toolbar:false,select_text_on_create:false});console.log(t)};DerivationList.prototype.shouldCutRow=function(t){if(this.rowIsPartOfAContinuousCommutingSequence(t))return true;return false};DerivationList.prototype.rowIsPartOfAContinuousCommutingSequence=function(t){var e=this.rows[t.idx+1];if(!e)return false;var i=t.action,n=e.action;if(!i||!n)return false;if(i.name!=="commute terms"||n.name!=="commute terms")return false;for(var r=0;r<i.nodes.length;r++){var o=i.nodes[r],s=n.nodes[r];if(!s)return false;var a=i.mapNodes(o);if(a.length>1)return false;if(a[0]!==s)return false}return true};DerivationList.prototype.addRowFromAction=function(t){var e=t.newTree;if(this.options.visualized){var i=this.getLastView();i.bindToModel(e,t.initial_node_map)}var n=this.getLastRow();n.removeInteractionListeners();var r=this.createRow(e,t,n.el);r.setView(n.view);if(this.options.visualized){r.takeHandle(n.handle);n.handle=null;i.update_all();if(!(this.shouldCutRow(n)&&this.firstRowInSequence)){n.createView(gmath.object.merged(i.options,{interactive:false,pos:n.pos.slice()}))}else{n.setView(null);n.hidden=true;n.el=null;n.cut=true}}if(!this.rowBeforeCurrActionSeq)this.rowBeforeCurrActionSeq=n;if(!this.firstRowInSequence)this.firstRowInSequence=r;return r};DerivationList.prototype.createRow=function(t,e,i){var n=this.getLastRow();var r={model:t,action:e,view:null,el:i,handle:null,dims:n?gmath.extend({},n.dims):null,row_idx:this.rows.length,pos:n?n.pos.slice():[0,0],padding:this.options.row_padding};var o=new DerivationRow(this,r);if(i){i.datum(o);i.attr("id",t.id)}this.addModelEventListeners(t);this.rows.push(o);return o};DerivationList.prototype.addModelEventListeners=function(t){var e=this;t.events.on("start-of-interaction."+this.id,this.atStartOfInteraction.bind(this));t.events.on("end-of-interaction."+this.id,this.afterEndOfInteraction.bind(this));t.events.on("change."+this.id,this.onChange.bind(this));t.events.on("mistake."+this.id,this.events.mistake);t.events.on("create."+this.id,this.onCreate.bind(this));t.events.on("restraint."+this.id,this.onRestraint.bind(this))};DerivationList.prototype.removeModelEventListeners=function(t){t.events.on("start-of-interaction."+this.id,null);t.events.on("end-of-interaction."+this.id,null);t.events.on("node-changed."+this.id,null);t.events.on("create."+this.id,null);t.events.on("mistake."+this.id,null);t.events.on("change."+this.id,null);t.events.on("restraint."+this.id,null)};DerivationList.prototype.atStartOfInteraction=function(t){if(!t||!t.source)return;if(t.source.type==="AlgebraModel")this.startUpdateSequence();this.events["start-of-interaction"](t)};DerivationList.prototype.afterEndOfInteraction=function(t){if(!t||!t.source)return;if(t.source.type==="DerivationRow"){this.events["end-of-interaction"](t)}else if(t.source.type==="AlgebraModel"){if(this.isInUpdateSequence())this.finishUpdateSequence();var e=t.source;var i=this.getRowByModel(e);var n=i.view.interaction_handler.mode;if(this.canvas_model)this.canvas_model.setActive(this,true);else this.setActive(true);if(n==="inspect"){i.updateDimensionAfterInteraction();this.events["end-of-interaction"](gmath.extend(t,{row:i.idx}))}else if(n==="edit"){if(e!==this.getLastModel())return;this.events["end-of-interaction"](t);if(this.rowBeforeCurrActionSeq){var i=this.rowBeforeCurrActionSeq;this.joinRows(this.rows[i.idx+1],this.getLastRow());var r=this;var o=this.shouldHideRow(i)||this.rows[i.idx+1]&&this.rows[i.idx+1].action&&this.rows[i.idx+1].action.auto_collapse;this.getLastView().callAfterAnimation(function(){r.startUpdateSequence();if(!o)i.unhide();r.layoutRows();r.finishUpdateSequence()})}this.rowBeforeCurrActionSeq=null;this.firstRowInSequence=null}}};DerivationList.prototype.joinRows=function(t,e){return;var i=[];for(var n=t.idx;n<=e.idx;n++)i.push(this.rows[n].action);if(i.length<2)return;var r=Action.createComposedAction(i,"move action");r.oldTree=t.oldTree;r.newTree=e.newTree;var o=t.idx,s=e.idx-t.idx;for(var n=0;n<s;n++)this.rows[o].remove();e.action=r};DerivationList.prototype.addRowFromModel=function(t,e,i){var n=this.getLastRow();if(n)n.deactivate();var r=this.createRow(t,e);var o=n?n.pos.slice():[0,0];var s=this;if(this.options.visualized){r.createView(gmath.object.merged(this.aview_options,{pos:o}),function(){s.events.added_line({type:"create",senderDL_id:s.id,action:e&&typeof e!=="string"?e:{name:"row added from model",newTree:t},row:r.idx});s.layoutRows();if(i)i()})}return r};DerivationList.prototype.addRowFromAscii=function(t,e){return this.addRowFromModel(new r(t,this.amodel_options),null,e)};DerivationList.prototype.getRowByView=function(t){return this.rows.filter(function(e){return e.view===t})[0]};DerivationList.prototype.updateAllRowBackgroundsAndHandles=function(t){for(var e=0;e<this.rows.length;e++){var i=this.rows[e];i.updateBackground(t);i.updateHandlePos(t)}};DerivationList.prototype.shouldHideRow=function(t){if(this.options.collapsed_mode)return true;var e=this.rows[t.idx+1];if(this.options.auto_collapse_repeated_actions&&e&&t.action&&e.action&&t.action.name===e.action.name)return true;if(this.canvas_model){var i=this.rows[this.rows.length-1];var n={x:this.pos.x,y:this.pos.y+t.pos[1]+t.dims.height+this.options.padding.top,width:this.dims.width,height:i.dims.height};return!this.canvas_model.isInFreeVisibleSpace(n,this)}return false};DerivationList.prototype.getFinalVerticalPos=function(t,e,i){i=i||0;var n=this.rows[i].pos[1];for(var r=i+1;r<=t.idx;r++){if(this.rows[r-1].hidden&&!e)continue;n+=this.getVerticalAdvance(this.rows[r])}return n};DerivationList.prototype.isAboveFinalVerticalPos=function(t){return t.pos[1]<this.getFinalVerticalPos(t)};DerivationList.prototype.getUpmostPullableRow=function(t){var e;if(this.rows.length<2)return this.rows[0];if(this.isAboveFinalVerticalPos(this.rows[1])){e=0}else{for(e=t.idx;e>=0;e--){if(this.rows[e].hidden&&this.rows[e].el)break;if(!this.isAboveFinalVerticalPos(this.rows[e]))break}}if(e===t.idx)return null;return this.rows[e+1]};DerivationList.prototype.getHiddenAbove=function(t){var e=t.idx-1;if(this.rows[0].hidden)return this.rows[0];while(e>=0&&(!(this.rows[e].hidden&&this.rows[e].el)||!this.rows[e].el))e--;return e===-1?null:this.rows[e]};DerivationList.prototype.getVisibleAbove=function(t){var e=t.idx-1;while(e>=0&&this.rows[e].hidden)e--;return e===-1?null:this.rows[e]};DerivationList.prototype.getVisibleRowOn=function(t){var e=t.idx,i=this.rows.length;while(e<i&&this.rows[e].hidden)e++;return e===i?null:this.rows[e]};DerivationList.prototype.getDistanceFromHome=function(t){var e=t.pos[0]-t.drag_pos[0],i=t.pos[1]-t.drag_pos[1];return Math.sqrt(e*e+i*i)};DerivationList.prototype.toggleHover=function(t){if(arguments.length===0)t=true;if(this.hovering){this.hovering=false;this.updateBGStyle();this.remove();var e=this.svgg.node();var i=this.original_container;delete this.original_container;var n=i.node().appendChild(e);this.unhoverRemove.remove();this.svg=i;if(t){var r=-1*d3.select("#wikiMainSvg").node().getBoundingClientRect().top;var o=-1*d3.select("#wikiMainSvg").node().getBoundingClientRect().left;this.pos[1]+=r;this.pos[0]+=o}var s=[this.pos[0],this.pos[1]];this.svgg.attr("transform","translate("+s+")");this.svgDims=this.getContainerDimensions();this.moveIntoContainer()}else{if(this.options.hoverable==false)return;this.hovering=true;this.updateBGStyle();this.remove();var e=this.svgg.node();var a=d3.select("#hovering");var h=a.select("g");var l=h.append("g");this.unhoverRemove=l;this.original_container=this.svg;this.svg=h;var n=l.node().appendChild(e);if(t){var r=d3.select("#wikiMainSvg").node().getBoundingClientRect().top;var o=d3.select("#wikiMainSvg").node().getBoundingClientRect().left;this.pos[1]+=r;this.pos[0]+=o}var s=[this.pos[0],this.pos[1]];this.svgg.attr("transform","translate("+s+")")}this.layoutRows()};DerivationList.prototype.setLastHandleVisibility=function(t){this.getLastRow().setHandleVisibility(t)};DerivationList.prototype.updateHandleVisibilities=function(){for(var t=0;t<this.rows.length;t++){this.rows[t].setHandleVisibility()}};DerivationList.prototype.countVisibleRows=function(){var t=0;for(var e=0;e<this.rows.length;e++)if(!this.rows[e].hidden)t++;return t};DerivationList.prototype.updateDims=function(){if(this.isInUpdateSequence())return;var t=Infinity,e=Infinity,i=-Infinity,n=-Infinity;this.rows.forEach(function(r){if(!r.hidden){t=Math.min(t,r.dims.x+r.pos[0]);e=Math.min(e,r.dims.y+r.pos[1]);i=Math.max(i,r.dims.x+r.dims.width+r.pos[0]);n=Math.max(n,r.dims.y+r.dims.height+r.pos[1])}},this);t-=this.options.padding.left;i+=this.options.padding.right;e-=this.options.padding.top;n+=this.options.padding.bottom;var r=t-this.dims.x;var o=e-this.dims.y;var s=this.dims.x!==t||this.dims.width!==i-t,a=this.dims.y!==e||this.dims.height!==n-e;if(s||a){this.dims={x:t,y:e,width:i-t,height:n-e};this.dimsHaveChanged(r,o,s)}return s||a};DerivationList.prototype.dimsHaveChanged=function(t,e,i){this.alignment_correction.attr("transform","translate("+[-this.dims.x,-this.dims.y]+")");if(Math.abs(t)>.5||Math.abs(e)>.5){this.translateElement({x:this.pos.x+t,y:this.pos.y+e})}this.resizeElement(this.dims);if(i)this.rows.forEach(function(t){t.updateBackground()})};DerivationList.prototype.handlePackArranging=function(t,e,i){var n=this.rows[this.rows.length-1];var r;if(i>0){if(!this.isAboveFinalVerticalPos(t)){r=this.getHiddenAbove(t);if(!r)return;r.unhide();this.events.pack_state(new DerivationRow.stateEvent(this));r=this.rows[r.idx+1]}else{r=this.getUpmostPullableRow(t)}}else{r=this.getVisibleAbove(t);if(!r)return;if(t.pos[1]<=r.pos[1]){r.hide();this.events.pack_state(new DerivationRow.stateEvent(this));if(this.countVisibleRows()===1)this.singleLineMode(true)}else r=this.rows[r.idx+1]}for(var o=r.idx;o<=n.idx;o++){var s=this.rows[o];s.pos[1]=Math.min(this.getFinalVerticalPos(s),s.pos[1]+i);s.pos[1]=Math.max(o>t.idx?this.getFinalVerticalPos(s,false,t.idx):0,s.pos[1]);if(s.el){s.el.attr("transform","translate("+s.pos+")");this.events.pack_state(new DerivationRow.stateEvent(this))}}this.updateDims()};DerivationList.prototype.setActiveDLComponent=function(t){if(this.active_dl_component!==t){this.active_dl_component=t;if(this.active_dl_component!=="none"){if(this.canvas_model)this.canvas_model.setActive(this);else this.setActive(true)}if(this.options.visualized){this.updateBGStyle();this.updateHandleVisibilities()}}};DerivationList.prototype.setSubTypeActive=function(){if(this.options.visualized){this.updateHandleVisibilities()}};DerivationList.prototype.updateBGStyle=function(){if(!this.options.show_bg)return;this.element_div.attr("visibility",null);var t=this.mode!=="arrange"?"edit":"arrange",e=this.active&&this.active_dl_component!=="AV"?"active_":"";var i="bg_"+t+"_"+e+"style";this.element_div.attr("visibility",null).style(this.options[i])};DerivationList.prototype.getVerticalAdvance=function(t){if(t.idx===0)return 0;var e=this.options.v_align;if(e==="center"){return this.rows[t.idx-1].dims.height/2+t.dims.height/2}else if(e==="top"){return this.rows[t.idx-1].dims.height}else if(e==="bottom"||e==="alphabetic"){return t.dims.height}};DerivationList.prototype.layoutRows=function(){var t=this.rows[0].pos,e=t[0],i=t[1],n=this;this.rows[0].idx=0;for(var r=1;r<this.rows.length;r++){var o=this.rows[r];o.idx=r;if(!this.rows[r-1].hidden)i+=this.getVerticalAdvance(o);if(o.dragging)continue;var s=o.pos;if(s[0]!==e||s[1]!==i){s[0]=e;s[1]=i;s=s;o.showBackground();if(o.el)o.el.transition().duration(this.options.row_transition_dur).attr("transform","translate("+s+")").each("end",function(t){t.hideBackground()})}}this.element_div.selectAll(".dl-line").sort(function(t,e){return t.idx-e.idx});this.updateDims()};DerivationList.prototype.updateContainerDimensions=function(){this.svgDims=this.getContainerDimensions()};DerivationList.prototype.getContainerDimensions=function(){return this.canvas_model.size()};DerivationList.prototype.undo=function(){if(this.rows.length<1)return;var t=this.getLastRow();t.remove();var e=[];var i=this.getLastRow();while(i.cut){e.push(i);i.remove();i=this.getLastRow()}var n=gmath.LinkCoordinator.unlinkElement(t.model);dead_micro_links=[];e.forEach(function(t){dead_micro_links.push(gmath.LinkCoordinator.unlinkElement(t.model))});var r=this.getLastRow();var o=this.options.collapsed_mode;if(r){r.unhide();r.view.interactive(true);r.view.update_all()}this.updateDims();this.singleLineMode(o);this.updateBGStyle();this.updateHandleVisibilities();return{undone_row:e.length===0?t:[t].concat(e),removed_links:dead_micro_links.length===0?n:[n].concat(dead_micro_links)}};DerivationList.prototype.redo=function(t){var e=t.undone_row,i=t.removed_links;if(Array.isArray(e)){while(e.length>1){this.rows.push(e.pop())}e=e[0]}var n=this.addRowFromModel(e.model,e.action);if(this.rows.length>1&&this.options.collapsed_mode){this.rows[this.rows.length-2].hide()}if(i.length>0&&Array.isArray(i[0])){while(i.length>1){gmath.LinkCoordinator.addLinks(i.pop())}i=i[0]}gmath.LinkCoordinator.addLinks(i);this.updateBGStyle();this.updateHandleVisibilities();this.layoutRows()};DerivationList.prototype.removeElement=function(){CanvasElement.prototype.removeElement.call(this);return gmath.LinkCoordinator.unlinkDL(this)};DerivationList.prototype.forceIntoContainer=function(t){if(arguments.length===0)t=true;var e={x:Math.max(0,Math.min(this.container_size.width-this.size.width,this.pos.x)),y:Math.max(0,Math.min(this.container_size.height-this.size.height,this.pos.y))};if(e.x===this.pos[0]&&e.x===this.pos[1])return;this.translateElement(e)};DerivationList.prototype.getAllDLs=function(){if(this.coordinator)return this.coordinator.dls;if(this.canvas_model)return this.canvas_model.dls();return[this]};DerivationRow=function(t,e){this.type="derivation-row";this.dl=t;this.id=gmath.uid();this.action=e.action;this.model=e.model;this.handle=null;this.view=null;this.el=e.el;this.padding=e.padding;this.dims=e.dims||{};this.idx=e.row_idx;this.pos=e.pos;this.link=null;this.lpos=null;this.preview=null;this.subable=true;this.sub=false;this.error=null};DerivationRow.prototype.createHandle=function(){if(!this.view||this.dl.options.no_handles)return;this.mtouch=this.setupInteractionListeners();var t=this.getHandlePos();var e=this.el.selectAll(".handle").data([this,this]);e.enter().append("circle").classed("handle",true).style({cursor:"pointer"}).call(this.mtouch).attr("transform","translate("+t+")").attr({fill:"white",stroke:this.handle_color?this.handle_color:this.dl.options.handle_stroke_color,"stroke-width":2,r:10}).attr({"pointer-events":"all"});this.handle=e;this.setHandleVisibility()};DerivationRow.prototype.takeHandle=function(t){if(this.dl.options.no_handles)return;this.handle=t;this.handle.data([this,this]);this.handle_color=this.dl.options.handle_stroke_color;this.handle.style({stroke:this.handle_color});this.handle.call(this.setupInteractionListeners());this.bindViewToInteractionHandlerListeners()};DerivationRow.prototype.setHandleColor=function(t){this.handle_color=t;if(this.handle)this.handle.style("stroke",t)};DerivationRow.prototype.removeHandle=function(){if(!this.view)return;if(this.mtouch){this.mtouch.connected(false);delete this.mtouch}if(this.handle){this.handle.remove();delete this.handle}};DerivationRow.prototype.getHandlePos=function(){if(!this.view)return[0,0];var t=this.view.getBBox({no_padding:true});var e=this.dl.options.handle_pos==="left"?t.x-20:t.x+t.width+25;return[e,t.y+t.height/2]};DerivationRow.prototype.updateHandlePos=function(t){if(!this.view||this.dl.options.no_handles)return;var e=this.getHandlePos();if(this.handle)this.handle.transition().ease(this.view.options.easing_fn).duration(t?0:this.view.options.dur).attr("transform","translate("+e+")")};DerivationRow.prototype.createView=function(t,e){var i=this;var n=i?this.dl.alignment_correction.insert("g","g.dl-line#"+i.model.id):this.dl.alignment_correction.append("g");n.classed("dl-line",true).attr("id",this.model.id).attr("transform","translate("+(t.pos||[0,0])+")").datum(this);this.el=n;t.pos=[0,0];t.border_color="none";t.background_color=this.dl.options.row_background_color;if(this.dl.options.standalone)t.event_receiver=this.dl.svg.node();t.derivation_list=this.dl;this.setView(new it(this.model,n,t));var r=this;this.view.init(function(){r.bindViewToInteractionHandlerListeners();r.createHandle();if(e)e(r.dl)})};DerivationRow.prototype.setView=function(t){if(this.view)this.view.events.on("updated."+this.id,null);this.view=t;if(this.view)this.view.events.on("updated."+this.id,this.updateDimensionAfterInteraction.bind(this))};DerivationRow.prototype.listenToInteractionHandlerEvents=function(){var t=this;t.view.interaction_handler.events.on("inspect_node."+t.id,function(e){t.dl.events.inspect_node({type:"inspect",node:e.node,dl:t.dl,row:t.idx})});t.view.interaction_handler.events.on("drag_start."+t.dl.id,t.dl.setActiveDLComponent.bind(t.dl,"AV"));t.view.interaction_handler.events.on("drag_end."+t.dl.id,t.dl.setActiveDLComponent.bind(t.dl,"none"));t.view.interaction_handler.events.on("touch."+t.dl.id,function(){if(t.dl.delete_mode)t.dl.canvas_model.removeElement(t.dl);else{t.dl.updateBGStyle();t.dl.updateHandleVisibilities()}})};DerivationRow.prototype.bindViewToInteractionHandlerListeners=function(){var t=this;this.view.interaction_handler.events.on("inspect_node."+this.id,function(e){t.dl.events.inspect_node({type:"inspect",node:e.node,dl:t.dl,row:t.idx})});this.view.interaction_handler.events.on("drag_start."+this.dl.id,this.dl.setActiveDLComponent.bind(this.dl,"AV"));this.view.interaction_handler.events.on("drag_end."+this.dl.id,this.dl.setActiveDLComponent.bind(this.dl,"none"));this.view.interaction_handler.events.on("touch."+this.dl.id,function(){if(t.dl.delete_mode){t.dl.canvas_model.removeElement(t.dl)}else{t.dl.updateBGStyle();t.dl.updateHandleVisibilities()}})};DerivationRow.prototype.updateDims=function(){if(!this.view)return;var t=this.view.getBBox({no_padding:true});t.y-=this.padding.top;t.height+=this.padding.top+this.padding.bottom;t.x-=this.padding.left;t.width+=this.padding.left+this.padding.right;var e=this.dims.x!==t.x||this.dims.y!==t.y||this.dims.width!==t.width||this.dims.height!==t.height;if(e)this.dims=t;return e};DerivationRow.prototype.updateDimensionAfterInteraction=function(t){if(this.updateDims()){if(this.dl.updateDims()){this.updateHandlePos(t)}else{this.updateBackground(t);this.updateHandlePos(t)}}};DerivationRow.prototype.updateBackground=function(t){if(!this.view)return;if(!this.dims)return;var e=this.dims.x-this.dl.dims.x+this.padding.left-this.dl.options.padding.left,i=this.dl.dims.x+this.dl.dims.width-this.dims.x-this.dims.width+this.padding.right-this.dl.options.padding.right;this.view.options.padding={left:e,right:i,top:this.padding.top,bottom:this.padding.bottom};this.view.update_background(t)};DerivationRow.prototype.showBackground=function(t){if(!this.view)return;this.view.options.border_color=t?this.dl.options.row_border_color:"none";this.updateBackground();this.view.set_background_visible(true)};DerivationRow.prototype.hideBackground=function(){if(!this.view)return;this.view.set_background_visible(false)};DerivationRow.prototype.setHandleVisibility=function(t){if(!this.view||this.dl.options.no_handles||!this||!this.handle)return;if(arguments.length<1)t=true;var e=this.dl.rows,i=this.dl.options.hide_handles;var n=this;this.handle.each(function(e,r){if(i||!t||n.dl.active_dl_component==="AV"||!n.dl.active){d3.select(this).attr("visibility","hidden");return}if(n.atLeastOneNotCutHiddenRowAbove()){d3.select(this).attr({visibility:"visible",cx:3-6*r});n.representHiddenHandleColor()}else{d3.select(this).attr({visibility:r===0?"visible":"hidden",cx:0});n.revertHandleColor()}})};DerivationRow.prototype.atLeastOneNotCutHiddenRowAbove=function(){var t=this.dl.rows;for(var e=this.idx-1;e>=0;e--){if(t[e].hidden&&t[e].cut)continue;else if(t[e].hidden)return true;else return false}return false};DerivationRow.prototype.representHiddenHandleColor=function(){var t;if(this.handle_color===this.dl.options.handle_stroke_color&&(t=this.coloredHandleHiddenBeneath())&&this.dl.curr_row_operation==="pack"){this.setHandleColor(t);this.is_displaying_hidden_handle_color=true}};DerivationRow.prototype.revertHandleColor=function(){if(this.is_displaying_hidden_handle_color){this.setHandleColor(this.dl.options.handle_stroke_color);delete this.is_displaying_hidden_handle_color}};DerivationRow.prototype.coloredHandleHiddenBeneath=function(){var t=this.dl.rows;for(var e=this.idx-1;e>=0;e--){if(t[e].hidden&&t[e].cut)continue;else if(t[e].hidden&&t[e].handle_color!==this.dl.options.handle_stroke_color)return t[e].handle_color;else if(!t[e].hidden)return false}return false};DerivationRow.prototype.hide=function(){if(!this.view||this.hidden)return;this.hidden=true;if(this.view)this.view.options.auto_update=false;if(!this.dl.options.collapsed_mode){this.dl.updateDims()}this.el.attr("display","none");if(this.dl.rows[this.idx+1]){this.dl.rows[this.idx+1].setHandleVisibility()}};DerivationRow.prototype.unhide=function(){if(!this.view||!this.hidden)return;this.dl.singleLineMode(false);this.hidden=false;if(this.view){this.view.options.auto_update=true;
this.view.update_all(true)}this.dl.updateDims();this.el.attr("display",null);if(this.dl.rows[this.idx+1]){this.dl.updateHandleVisibilities()}this.dl.rows[this.idx].updateHandlePos(true)};DerivationRow.prototype.deactivate=function(){if(!this.view)return;this.view.interactive(false);this.model.for_each(function(t){t.dragging=false;t.selected=false});this.view.update_all()};DerivationRow.prototype.remove=function(){for(var t=this.idx+1;t<this.dl.rows.length;t++)this.dl.rows[t].idx--;this.dl.rows.splice(this.idx,1);this.removeHandle();if(this.view)this.el.remove();this.model.events.on("end-of-interaction."+this.dl.id,null);this.model.events.on("change."+this.dl.id,null);this.model.events.on("create."+this.dl.id,null)};DerivationRow.prototype.removeInteractionListeners=function(){if(this.mtouch)this.mtouch.on("drag",null).on("touch",null).on("tap",null).on("release",null)};DerivationRow.prototype.setupInteractionListeners=function(){var t=this;if(!this.mtouch){this.mtouch=mtouch_events()}else{this.removeInteractionListeners();this.mtouch.connected(false)}this.mtouch.origin(function(e){return[t.dl.pos.x+e.pos[0],t.dl.pos.y+e.pos[1]]}).on("drag",this.drag.bind(this)).on("touch",this.touch.bind(this)).on("tap",this.tap.bind(this)).on("release",this.dragend.bind(this));return this.mtouch};DerivationRow.prototype.touch=function(t){this.dl.atStartOfInteraction({type:"start-of-interaction",source:{type:"DerivationRow",id:this.dl.id,row:this.idx,model:this.model,packState:this.dl.rows.map(function(t){return t.hidden?true:false})},time:Date.now()});var e=t.row||t.row===0?this.dl.rows[t.row]:t;if(this.dl.options.send_events&&isNaN(t.row))this.dl.row_events.touch(new DerivationRow.touchEvent(d3.event,e.idx,this.dl.id));this.dl.setActiveDLComponent("row");this.dl.curr_row_operation="undecided";this.dl.canvas_svg_dims=this.dl.getContainerDimensions();for(var i=0;i<this.dl.rows.length;i++)this.dl.rows[i].showBackground(i===e.idx);e.handle.attr({fill:"whitesmoke"})};DerivationRow.prototype.tap=function(t){var e=t.row||t.row===0?this.dl.rows[t.row]:t;if(this.dl.options.send_events&&isNaN(t.row))this.dl.row_events.tap(new DerivationRow.tapEvent(d3.event,e.idx,this.dl.id));var i=this;if(!gmath.actions.editLineAction.match(e.model))return;var n=gmath.actions.editLineAction.createBoundAction(e.model,{actor:e.model});e.model.performAction(n,function(){i.updateDimensionAfterInteraction()},true);this.dl.afterEndOfInteraction({type:"end-of-interaction",source:{type:"DerivationRow",id:this.dl.id},time:Date.now()})};DerivationRow.prototype.drag=function(t){var e;var i;var n,r,o,s;var a=50,h,l;if(t.row||t.row===0){e=t;i=this.dl.rows[e.row]}else{e=d3.event;i=t}n=e.x;r=e.dx;o=e.y;s=e.dy;h=Math.abs(e.finger.dist_x);l=Math.abs(e.finger.dist_y);if(this.dl.options.send_events&&isNaN(e.row))this.dl.row_events.drag(new DerivationRow.dragEvent(e,i.idx,this.dl.id));var d=Math.sqrt(h*h+l*l);if(d>=10&&!this.link&&this.dl.curr_row_operation!=="pack"){if(l/d>=.85&&i.idx!==0){this.dl.curr_row_operation="pack"}else{this.link=this.el.append("g");var u=this.getHandlePos();this.lpos=[u[0],u[1]];this.link.append("line").attr({x1:this.lpos[0],y1:this.lpos[1],x2:this.lpos[0],y2:this.lpos[1]}).style("stroke",this.handle_color?this.handle_color:this.dl.options.handle_stroke_color).style("stroke-width",2).style("stroke-linecap","round");this.link.append("circle").attr({cx:this.lpos[0],cy:this.lpos[1],r:10}).style("fill","white").style("stroke",this.handle_color?this.handle_color:this.dl.options.handle_stroke_color).style("stroke-width",2);this.link.append("circle").attr("id","cursor").attr({cx:this.lpos[0],cy:this.lpos[1],r:10}).style("fill","white").style("stroke",this.handle_color?this.handle_color:this.dl.options.handle_stroke_color).style("stroke-width",2);this.subable=this.view.interaction_handler.handlers.edit[1].check(e,this.model);if(this.subable){this.view.interaction_handler.handlers.edit[1].start(this.getHandlePos())}}}if(this.dl.curr_row_operation==="pack"){this.dl.handlePackArranging(i,o,s)}if(this.link){this.dl.curr_row_operation="link";var r=e.finger.dx,s=e.finger.dy;this.lpos[0]=this.lpos[0]+r;this.lpos[1]=this.lpos[1]+s;this.link.select("line").attr({x2:this.lpos[0],y2:this.lpos[1]});this.link.select("#cursor").attr({cx:this.lpos[0],cy:this.lpos[1]});var c=null,p=null,f=this.lpos[0],g=this.lpos[1];this.dl.canvas_model.graphs().forEach(function(t){if(t.inBounds(f,g)){c=t;p="graph"}});if(p==="graph"&&!this.preview){this.preview=gmath.ui.SILine.createGeomPreviewFromDL(this,c);if(!this.preview){this.preview=gmath.ui.PSLine.createGeomPreviewFromDL(this,c)}if(!this.preview){this.preview=gmath.ui.Point.createGeomPreviewFromDL(this,c)}if(!this.preview){this.preview=gmath.ui.ARLine.createGeomPreviewFromDL(this,c)}if(!this.preview){if(this.error)this.error.cancelFade();else{var v={pos:c.pos,text:"This expression can't be linked to a graph.",uneditable:true,static_bg:true,locked:true,dont_log_events:true};this.error=this.dl.canvas_model.createTextBox(v)}}}if(p!=="graph"){if(this.preview){this.preview(true);this.preview=null}if(this.error){var _=this;this.error.fade(function(){_.error=null})}}if(this.subable){this.sub=this.view.interaction_handler.handlers.edit[1].update(e)}}};DerivationRow.prototype.dragend=function(t){var e=t.row||t.row===0?this.dl.rows[t.row]:t;if(this.dl.options.send_events&&isNaN(t.row))this.dl.row_events.release(new DerivationRow.releaseEvent(d3.event,e.idx,this.dl.id));this.releaseRow(e);if(this.link){if(this.preview){this.preview();this.preview=null}var i=null,n=null,r={x:this.dl.pos.x-this.dl.dims.x+this.pos[0]+this.lpos[0],y:this.dl.pos.y-this.dl.dims.y+this.pos[1]+this.lpos[1]};var o=gmath.find(this.dl.canvas_model.elements(),function(t){return t.type==="ggb-panel"});if(o&&o.hitTest(r)){i=o;n="ggb-panel"}var s=gmath.find(this.dl.canvas_model.elements(),function(t){return t.type==="ggb-element"});if(s&&s.ggbPanel&&s.hitTest(r)){i=s.ggbPanel;n="ggb-panel"}this.dl.canvas_model.graphs().forEach(function(t){if(t.inBounds(r.x,r.y)){i=t;n="graph"}});var a=gmath.find(this.dl.canvas_model.dls(),function(t){return t.hitTest(r)});if(a){i=a;n="derivation"}if(n==="ggb-panel"){i.dropDLRow(this)}else if(n==="graph"){var h=gmath.ui.SILine.createGeomFromDL(this,i);if(!h){h=gmath.ui.PSLine.createGeomFromDL(this,i)}if(!h){h=gmath.ui.Point.createGeomFromDL(this,i)}if(!h){h=gmath.ui.ARLine.createGeomFromDL(this,i)}if(!h){if(this.error)this.error.cancelFade();else{var l={pos:i.pos,text:"This expression can't be linked to a graph.",uneditable:true,static_bg:true,locked:true,dont_log_events:true};this.error=this.dl.canvas_model.createTextBox(l)}}if(this.error){var d=this;this.error.fade(function(){d.error=null})}}else if(n!=="derivation"&&!this.sub&&this.dl.options.cloning_on){this.cloneLine(e,r.x,r.y);var u={},c=this.clone.getLastRow().pos,p=this.clone.getLastRow().view.getBBox({no_padding:true});u.x=this.dl.options.handle_pos==="left"?r.x-20:r.x-p.width-60;u.y=r.y-p.height/2-10;this.clone.translateElement(u);this.clone.setActiveDLComponent("none");this.clone=null}if(this.subable){this.view.interaction_handler.handlers.edit[1].end()}this.link.remove();this.link=null;this.lpos=null;this.subable=false;this.sub=false}this.dl.curr_row_operation="none";this.dl.afterEndOfInteraction({type:"end-of-interaction",source:{type:"DerivationRow",id:this.dl.id,row:this.idx,model:this.model,packState:this.dl.rows.map(function(t){return t.hidden?true:false})},time:Date.now()})};DerivationRow.prototype.releaseRow=function(t){this.dl.setActiveDLComponent("none");for(var e=0;e<this.dl.rows.length;e++)this.dl.rows[e].hideBackground();if(!this.dl.options.no_handles)t.handle.attr({fill:"white"});this.dl.draginfo=null;if(t.idx>0){var i=this.dl.getFinalVerticalPos(t)-t.pos[1];var n=this.dl.getVisibleAbove(t);if(n&&i>0&&i>.5*n.dims.height)n.hide();this.dl.layoutRows()}this.dl.updateBGStyle();this.dl.updateHandleVisibilities()};DerivationRow.prototype.cloneLine=function(t,e,i){var n=gmath.extend({},this.dl.options);gmath.extend(n,this.dl.av_options);gmath.extend(n,this.dl.am_options);n.pos={x:e,y:i};n.eq=t.model.to_ascii();n.id=gmath.uid();if(this.dl.options.send_events){this.dl.events.clone(new DerivationRow.cloneEvent(this.dl.id,n))}this.clone=this.dl.canvas_model.createDL(n);if(this.dl.hovering){this.clone.pos={x:e,y:i};this.clone.element_group.transition().duration(0).attr("transform","translate("+[this.clone.pos.x,this.clone.pos.y]+")");this.clone.toggleHover(false)}this.clone.setActiveDLComponent("DL");this.dl.curr_row_operation="clone";var r=new AlgebraModelLink(t.model,this.clone.rows[0].model,gmath.actions.CloneAction.createBoundAction(t.model,{}),true);gmath.LinkCoordinator.addLink(r)};DerivationRow.prototype.handleCloneDrag=function(t,e,i){this.clone.drag(d3.event);var n=this.dl.pos.x+t.pos[0]-this.clone.pos.x,r=this.dl.pos.y+t.pos[1]-this.clone.pos.y;this.clone_dist=Math.sqrt(n*n+r*r)};DerivationList.ChangeEvent=function(t,e,i){this.type="Change";this.performee=t;this.performee_type="DL";this.time=Date.now();this.row=i;this.model=e};DerivationList.dragEvent=function(t,e){this.type="Drag";this.performee=t;this.performee_type="DL";this.time=Date.now();this.x=e.x;this.y=e.y};DerivationList.touchEvent=function(t,e){this.type="Touch";this.performee=t;this.performee_type="DL";this.time=Date.now();this.fingers=e.fingers.map(function(t){return{pos:[t.pos[0],t.pos[1]]}})};DerivationList.releaseEvent=function(t,e){this.type="Release";this.performee=t;this.performee_type="DL";this.time=Date.now();if(e.altKey)this.altKey=e.altKey;if(e.shiftKey)this.shiftKey=e.shiftKey;this.fingers=e.fingers.map(function(t){return{pos:[t.pos[0],t.pos[1]]}})};DerivationList.holdEvent=function(t,e){this.type="Hold";this.performee=t;this.performee_type="DL";this.time=Date.now();this.finger={pos:[e.finger.pos[0],e.finger.pos[1]]}};DerivationRow.touchEvent=function(t,e,i){this.type="Touch";this.performee=i;this.performee_type="row";this.row=e;this.time=Date.now();this.fingers=t.fingers.map(function(t){return{pos:[t.pos[0],t.pos[1]]}})};DerivationRow.tapEvent=function(t,e,i){this.type="Tap";this.performee=i;this.performee_type="row";this.row=e;this.time=Date.now();this.fingers=t.fingers.map(function(t){return{pos:[t.pos[0],t.pos[1]]}})};DerivationRow.dragEvent=function(t,e,i){this.type="Drag";this.performee=i;this.performee_type="row";this.row=e;this.time=Date.now();this.x=t.x;this.dx=t.dx;this.y=t.y;this.dy=t.dy;this.finger={dx:t.finger.dx,dy:t.finger.dy,dist_x:t.finger.dist_x,dist_y:t.finger.dist_y};this.x_offset=Math.abs(t.finger.dist_x);this.y_offset=Math.abs(t.finger.dist_y);this.fingers=t.fingers.map(function(t){return{pos:[t.pos[0],t.pos[1]]}})};DerivationRow.releaseEvent=function(t,e,i){this.type="Dragend";this.performee=i;this.performee_type="row";this.row=e;this.time=Date.now();this.fingers=t.fingers.map(function(t){return{pos:[t.pos[0],t.pos[1]]}})};DerivationRow.cloneEvent=function(t,e){this.type="Clone";this.performee=t;this.performee_type="row";this.eq=e.eq;this.pos=e.pos;this.dl_id=e.id};DerivationRow.stateEvent=function(t){this.type="packState";this.performee=t.id;this.performee_type="row";this.time=Date.now();this.packState=t.rows.map(function(t){return t.hidden?true:false})};DerivationList.prototype.draw_mappings_for_nodes=function(t){this.hideAllNodeMappings();if(t.length===0)return;var e=!t.some(function(t){return t.is_group("sym")});this.draw_forward_mappings(t,e);this.draw_backward_mappings(t,e);var i=this.getRowByModel(t[0].get_root());this.draw_node_backgrounds(t,i,true)};DerivationList.prototype.get_combined_action=function(t,e){if(t.idx+1===e.idx)return e.action;var i=[];for(var n=t.idx+1;n<=e.idx;n++)i.push(this.rows[n].action);return Action.createComposedAction(i)};DerivationList.prototype.get_next_visible_row=function(t){for(var e=t.idx+1;e<this.rows.length;e++){if(this.rows[e].hidden)continue;return this.rows[e]}return null};DerivationList.prototype.get_prev_visible_row=function(t){for(var e=t.idx-1;e>=0;e--){if(this.rows[e].hidden)continue;return this.rows[e]}return null};DerivationList.prototype.draw_forward_mappings=function(t,e){if(t.length===0)return;var i=this.getRowByModel(t[0].get_root()),n=this.get_next_visible_row(i);if(!n)return;var r=this.get_combined_action(i,n);var o=[];t.forEach(function(t){var i=r.mapNodes([t]);if(i.length===0)o.push({source_node:t});else i.forEach(function(i){if(e&&i.is_group("sym"))return;if(i.has_children())return;o.push({source_node:t,target_node:i})});t.was_removed=i.length===0});this.draw_mapping_lines(o,i,n);var s=r.mapNodes(t);if(e)s=s.filter(function(t){return!t.is_group("sym")});this.draw_forward_mappings(s,e);this.draw_node_backgrounds(s,n)};DerivationList.prototype.draw_backward_mappings=function(t,e){if(t.length===0)return;var i=this.getRowByModel(t[0].get_root()),n=this.get_prev_visible_row(i);if(!n)return;var r=this.get_combined_action(n,i);t.forEach(function(t){t.was_created=true});var o=[];var s=[];n.model.children[0].for_each(function(i){if(i.has_children())return;if(e&&i.is_group("sym"))return;var n=r.mapNodes([i]);var a=false;n.forEach(function(e){if(t.indexOf(e)!==-1){o.push({source_node:i,target_node:e});a=true;e.was_created=false}});if(a)s.push(i)});this.draw_mapping_lines(o,n,i);this.draw_backward_mappings(s,e);this.draw_node_backgrounds(s,n)};DerivationList.prototype.draw_node_backgrounds=function(t,e,i){var n=i?this.options.mappings_active_node_color:this.options.mappings_color;var r=function(){return n};e.view.main.selectAll(".selector").attr({rx:this.options.mappings_rect_radius,ry:this.options.mappings_rect_radius}).style("fill",r).style("stroke","none").attr("visibility",function(e){return t.indexOf(e)===-1?"hidden":null})};DerivationList.prototype.hideAllNodeMappings=function(){this.rows.forEach(function(t){if(!t.view)return;t.view.main.selectAll(".selector").attr("visibility","hidden");t.view.main.selectAll(".mapping_line").attr("visibility","hidden")})};DerivationList.prototype.draw_mapping_lines=function(t,e,i){var n=i.pos[0]-e.pos[0];var r=i.pos[1]-e.pos[1];e.view.main.selectAll(".mapping_line");var o=this.options.mappings_color;var s=e.view.main.selectAll(".mapping_line").data(t);s.enter().insert("path",".math");s.attr("class","mapping_line").call(this.update_organic_path.bind(this),n,r).style("fill",o).style("stroke",o).attr("visibility",function(t){if(!t.source_node||!t.target_node)return"hidden";return t.source_node.hidden||t.target_node.hidden?"hidden":null});s.exit().remove()};DerivationList.prototype.update_organic_path=function(t,e,i){function n(t){return t.x.toFixed(4)+" "+t.y.toFixed(4)+" "}var r=this.options.mappings_rect_radius;var o=this;t.attr("d",function(t){if(!t.target_node||!t.source_node)return"M 0,0";var s=t.source_node.sel_box,a=t.source_node,h=t.target_node.sel_box,l=t.target_node;var d={x:s.x+a.x,y:s.y+a.y,width:s.width,height:s.height,r:r};var u={x:h.x+l.x+e,y:h.y+l.y+i,width:h.width,height:h.height,r:r};var c=o.createConnectorPath(d,u);var p=o.createConnectorPath(u,d);if(!c||!p)return"M 0 0";return"M "+n(c.base1)+"C "+n(c.base1_control)+n(c.joint1_control1)+n(c.joint1)+"L"+n(p.joint2)+"C "+n(p.joint2_control1)+n(p.base2_control)+n(p.base2)+"L "+n(p.base1)+"C "+n(p.base1_control)+n(p.joint1_control1)+n(p.joint1)+"L "+n(c.joint2)+"C "+n(c.joint2_control1)+n(c.base2_control)+n(c.base2)+"Z"})};DerivationList.prototype.createConnectorPath=function(t,e){var i=Math.min(this.options.mappings_joint_width,t.width*.9,e.width*.9,t.height*.9,e.height*.9);var n=Math.min(i/2,this.options.mappings_line_thickness);var r=this.options.mappings_joint_length;var o=new Point(t.x+t.width/2,t.y+t.height/2),s=new Point(e.x+e.width/2,e.y+e.height/2),a=s.Sub(o),h=[],l=[];if(z.overlaps(t,e))return null;var d=a.get_perpendicular();d.Normalize().Scale(i/2);var u=Point.intersect_inner_ray_with_rect(o.add(d),a,t);if(!u)return null;h.push(u.point);var c=u.point.add(u.tangent.scale(i/3));l.push({from:u.point,to:c});var p=Point.intersect_inner_ray_with_rect(o.sub(d),a,t);if(!p)return null;h.push(p.point);var f=p.point.add(p.tangent.scale(-i/3));l.push({from:p.point,to:f});d.Normalize().Scale(n/2);var g=Point.intersect_inner_ray_with_rect(o.add(d),a,t);if(!g)return null;var v=g.point.add(a.normalize().Scale(r));var _=Point.intersect_inner_ray_with_rect(o.sub(d),a,t);if(!_)return null;var m=_.point.add(a.normalize().Scale(r));h.push(v,m);var y=v.sub(a.normalize().Scale(r/2));var w=v.sub(a.normalize().Scale(-r/2));var b=m.sub(a.normalize().Scale(r/2));var x=m.sub(a.normalize().Scale(-r/2));l.push({from:v,to:y},{from:v,to:w},{from:m,to:b},{from:m,to:x});return{pts:h,lines:l,base1:u.point,base2:p.point,joint1:v,joint2:m,joint1_control1:y,joint1_control2:w,joint2_control1:b,joint2_control2:x,base1_control:c,base2_control:f}};var rt=function(t,e,i){this.view=t;this.h_align=e||"center";this.v_align=i||"alphabetic"};rt.prototype.set_style=function(t){var e=function(t,i,n){t.size=i;if(t.bigger)t.size*=1.5;if(t.smaller)t.size*=.67;t.color=t.selected?this.view.options.selection_color:n;if(t.has_children())for(var r=0;r<t.children.length;r++){if(t.is_group("fraction"))e.call(this,t.children[r],t.size*this.view.options.fraction_size_factor,t.color);else if(t.is_group("power")&&r===1)e.call(this,t.children[r],t.size*this.view.options.exp_size_factor,t.color);else if(t instanceof h&&t.has_children()&&r===1)e.call(this,t.children[r],t.size*this.view.options.subscript_size_factor,t.color);else e.call(this,t.children[r],t.size,t.color)}};for(var i=0;i<t.length;i++){var n=t[i];var o=r.is_top_most(n)||!n.size?this.view.options.font_size:n.size;var s=n.parent.color||(this.view.interactive()?this.view.options.color:this.view.options.inactive_color);e.call(this,n,o,s)}};rt.prototype.set_position=function(t,e){var i=this.view.options.font_baseline_shift,n=this.view.options.font_ascent,o=this.view.options.font_descent;var s=function(t){var e=t[0].parent;var i=0,n=0,o=0,s=0,a=0,h=t.length,l=t[0].hidden?0:t[0].lmar||0,d=t[h-1].hidden?0:t[h-1].rmar||0;for(var u=0;u<t.length;u++){var c=t[u];i+=c.hidden||c.hide_after_drop?0:c.width;s+=c.hidden?0:c.width;n=Math.max(n,c.hidden?0:c.ascent-c.rel_y);o=Math.max(o,c.hidden?0:c.descent+c.rel_y)}a=n+o;if(r.is_top_most(e)&&l){i-=l}var p=-i;for(var u=0;u<t.length;u++){var c=t[u];var f=u===0?0:c.lmar||0;var g=u===0?c.width-(c.lmar||0):c.width;var v=u===0?0:Math.min(t[u-1].rmar||0,f);i-=v;c.rel_x+=p+c.width+f-v;if(c.hidden||c.hide_after_drop)c.rel_x-=g-v;p+=c.hidden||c.hide_after_drop?0:g-v}if(r.is_top_most(e)&&p!==0){t.forEach(function(t){t.rel_x-=p})}return{width:i,height:a,ascent:n,descent:o,sel_box:{x:-i-l,width:i,y:-n,height:a},lmar:l,rmar:d}};var a=function(l){if(!l.has_children()){l.baseline_shift=i*l.size;if(l.value==="="){l.lmar=l.size/3;l.rmar=l.size/3}else if(l.value==="+"){l.lmar=l.size/6;l.rmar=l.size/6}else if(l.value==="±"&&!l.parent.is_group("plusminus")){l.lmar=l.size/6;l.rmar=l.size/6}else if(l.value==="-"&&!l.parent.is_group("sign")){l.lmar=l.parent.ls?l.size/6:0;l.rmar=l.size/6}else if(l.value===","){l.lmar=0;l.rmar=l.size/3}else{l.lmar=0;l.rmar=0}if(e){l.width=this.view.fontloader.width(l.to_string(),l.size,this.view.get_font(l));l.width+=l.lmar+l.rmar;l.ascent=n*l.size;l.descent=o*l.size;l.height=l.ascent+l.descent;l.sel_box={x:-l.lmar,width:l.width,y:-l.ascent,height:l.height}}if(t.indexOf(l)!==-1){if(!l.rel_x&&l.rel_x!==0)l.rel_x=-l.width;if(!l.rel_y&&l.rel_y!==0)l.rel_y=0}else{l.rel_x=-l.width;l.rel_y=0}return}if(t.indexOf(l)!=-1&&!r.is_top_most(l)){l.rel_x=l.rel_x||0;l.rel_y=l.rel_y||0}else{l.rel_x=0;l.rel_y=0}for(var d=0;d<l.children.length;d++)a.call(this,l.children[d]);if(l.is_group("fraction")){var u=[],c=[],p=null;var f=l.children[0];while(f){if(f.value=="mul")u.push(f);else if(f.value=="div")c.push(f);else p=f;f=f.rs}var g=s(u);var v=s(c);var _=-i*l.size;p.height=l.size*this.view.options.div_bar_height;p.width=Math.max(g.width,v.width)+l.size/8;p.ascent=p.height/2;p.descent=p.height/2;p.rel_y=_;p.rel_x=.1*l.size;p.sel_box={x:-.1*l.size,width:p.width+.2*l.size,y:-(n+o)*l.size/4,height:(n+o)*l.size/2};l.width=p.width+.2*l.size;l.ascent=g.height+p.height/2-_;l.descent=v.height+p.height/2+_;l.height=l.ascent+l.descent;l.rel_y=0;l.rel_x=-l.width;l.sel_box={x:0,width:l.width,y:-l.ascent,height:l.height};for(var d=0;d<u.length;d++){u[d].rel_y+=-g.descent-p.height/2+_;u[d].rel_x+=.5*(l.width+g.width)}for(var d=0;d<c.length;d++){c[d].rel_y+=v.ascent+p.height/2+_;c[d].rel_x+=.5*(l.width+v.width)}}else{if(l.is_group("power")){var m=l.children[0],y=l.children[1];y.rel_y-=m.ascent*.7}if(l instanceof h&&l.has_children()){var m=l.children[0],w=l.children[1];w.rel_y+=m.descent*.7}gmath.extend(l,s(l.children))}};for(var l=0;l<t.length;l++)a.call(this,t[l]);var d=function(t,e,i,n,r){if(t.dragging){t.x0=t.rel_x+e;t.y0=t.rel_y+i;if(t.update_x_during_dragging){t.x=t.x0;t.update_x_during_dragging=false}if(t.update_y_during_dragging){t.y=t.y0;t.update_y_during_dragging=false}}else{t.x=t.rel_x+e;t.y=t.rel_y+i;t.x0=t.rel_x+n;t.y0=t.rel_y+r}if(t.has_children())for(var o=0;o<t.children.length;o++){d.call(this,t.children[o],t.x,t.y,t.x0,t.y0)}};for(var l=0;l<t.length;l++){var u=t[l];if(r.is_top_most(u)){var c,p;switch(this.v_align){case"alphabetic":p=0;break;case"top":p=u.ascent-u.rel_y;break;case"center":p=-u.descent+u.height/2;break;case"bottom":p=-u.descent-u.rel_y;break}switch(this.h_align){case"left":c=u.width;break;case"center":c=u.width/2;break;case"equals":c=u.width/2;if(u.is_group("equals")){var f=u.children[1];var g=f.rel_x+f.sel_box.x+f.sel_box.width;c=-g}break;case"right":c=0;break}d.call(this,u,c,p,c,p)}else{d.call(this,u,u.parent.x||0,u.parent.y||0,u.parent.x0||0,u.parent.y0||0)}}};CreationBox=function(t,e,i){this.container=d3.select(t);this.pos0=e.slice();this.bbox={x:e[0],y:e[1],width:20,height:30};this.main_el=this.createVisualElement();this.setupListeners(this.main_el);this.shadow_el=this.createVisualElement().style("visibility","hidden");this.dl_getter=i;this.actions=[]};CreationBox.prototype.setCanvasController=function(t){this.canvas_controller=t};CreateDLAction=function(t,e){this.cc=e;this.size=this.cc.model().size();this.pos_fn=t;this.priority=-1;this.target={x:0,y:0,sel_box:{x:20,y:30,width:this.size.width-40,height:this.size.height-60}}};CreateDLAction.prototype.match=function(){return typeof Keyboard!=="undefined"&&Keyboard!==null};CreateDLAction.prototype.doInPlace=function(t){this.cc.inputDL(this.pos_fn());if(typeof t==="function")t(this);else return true};CreationBox.prototype.getTargetPos=function(){return[this.bbox.x+this.bbox.width/2,this.bbox.y+this.bbox.height/2]};CreationBox.prototype.getAvailableActions=function(){var t=[];if(this.canvas_controller)t.push(new CreateDLAction(this.getTargetPos.bind(this),this.canvas_controller));var e=this.dl_getter();for(var i=0;i<e.length;i++){var n=e[i],r=n.getLastRow();var o=r.model.children;var s=gmath.actions.FractionExtendAction.getAllAvailableActions(o).concat(gmath.actions.EquationFountain.getAllAvailableActions(o));for(var a=0;a<s.length;a++)s[a].settings.offset={x:n.pos[0]+r.pos[0],y:n.pos[1]+r.pos[1]};t=t.concat(s)}z.setTargetRegions(t);return t};CreationBox.prototype.onDragStart=function(){this.actions=this.getAvailableActions();z.draw(this.container,this.actions,this.bbox);this.shadow_el.style("visibility",null)};CreationBox.prototype.onDrag=function(){this.shadow_el.attr({x:d3.event.pos[0],y:d3.event.pos[1]});this.bbox.x=d3.event.pos[0];this.bbox.y=d3.event.pos[1];z.draw(this.container,this.actions,this.bbox);this.current_hit=z.getBestHit(this.actions,this.bbox)};CreationBox.prototype.onDragEnd=function(){this.shadow_el.attr({x:this.pos0[0],y:this.pos0[1]});this.shadow_el.style("visibility","hidden");z.draw(this.container);if(this.current_hit){if(this.current_hit instanceof CreateDLAction)this.current_hit.doInPlace();else{var t=this.current_hit.target.get_root();t.performAction(this.current_hit,function(t){t.finishInteraction()})}}this.bbox.x=this.pos0[0];this.bbox.y=this.pos0[1]};CreationBox.prototype.createVisualElement=function(){var t=this.container.append("rect").datum(this).attr(this.bbox).style({fill:"white","fill-opacity":.67,stroke:"green","stroke-dasharray":"4,2",cursor:"pointer"});return t};CreationBox.prototype.setupListeners=function(t){var e=drag_behavior().on("drag-start",this.onDragStart.bind(this)).on("drag",this.onDrag.bind(this)).on("drag-end",this.onDragEnd.bind(this));var i=mtouch_events().origin(function(t){return[t.bbox.x,t.bbox.y]}).on("tap",ot).call(e);t.call(i)};function ot(){console.log(d3.event)}gmath.ui=gmath.ui||{};gmath.ui.TextBox=function(){var t=function(t,e,i,n){CanvasElement.call(this,t,e,i);this.type="textbox";this.events=gmath.extend(this.events,d3.dispatch("font_size","text"));this.initTextBoxOptions(i);this.initTextBoxProperties();this.initTextBox();this.initPosition();this.initMode();if(n)n(this)};gmath.inherit(CanvasElement,t);gmath.ui.TextBoxClass=t;t.defaultOptions={default_text:"Edit this text.",min_size:{width:150,height:50},size:{width:200,height:200},padding:20,text_align:"left",resizable:{x:true,y:false},uneditable:false,closable:false,font_size:20,min_font_size:10,max_font_size:60,use_toolbar:true,static_bg:false,select_text_on_create:true};t.prototype.initTextBoxOptions=function(e){var e=e||{};var i=gmath.deepCopy(t.defaultOptions);var n=gmath.object.extendExisting(i,e);if(e.text)n.text=e.text;this.options=gmath.extend(this.options,n);if(this.options.static_bg){this.options.bg_edit_style=this.options.bg_arrange_style;this.options.bg_edit_active_style=this.options.bg_arrange_style}};t.prototype.initTextBoxProperties=function(){this.uneditable=this.options.uneditable;this.closable=this.options.closable;this.font_size=this.options.font_size;if(this.options.text)this.text=this.options.text;this.size=this.options.size;this.element_div.style({height:this.size.height+"px",width:this.size.width+"px"})};t.prototype.initTextBox=function(){if(!this.uneditable)this.initToolbar();this.initTextElement();if(this.closable)this.initCloseButton();this.update();this.canvas_model.setActive(this,true);if(!this.uneditable){if(this.mode==="edit"&&this.options.select_text_on_create)this.selectAllText();this.switchToolbarState(this.mode==="edit"&&this.active)}};t.prototype.initToolbar=function(){this.toolbar_on_style={display:"inline-block",position:"fixed","margin-top":"-20px",width:"100%"};this.toolbar_off_style={display:"none"};this.toolFadeoutDelay=500;this.font_btns=[{type:"push",label:"-",icon:"glyphicon glyphicon-text-size",flip:"y"},{type:"push",label:"+",icon:"glyphicon glyphicon-text-size"}];this.tools=this.element_div.append("div").attr({"class":"btn-toolbar",role:"toolbar"}).style(this.options.use_toolbar?this.toolbar_on_style:this.toolbar_off_style);var t=this.tools.append("div").attr({"class":"btn-group"}).classed("pull-right",true).selectAll("button").data(this.font_btns);var e=this;function i(t,i){var n=t.append("button").attr("id",function(t){return t.label}).attr({type:"button","class":"btn btn-default"}).classed("input-xs",true);n.on("click",i.bind(e));n.append("span").text(function(t){return t.label}).style("color","#555")}t.enter().call(i,this.onButton)};t.prototype.initTextElement=function(){this.text_element=this.element_div.append("div").classed("gm-no-focus-outline",true).style({padding:this.options.padding+"px","font-size":this.font_size+"px","text-align":this.options.text_align}).property("innerHTML",this.text||this.options.default_text).attr("contenteditable",!this.uneditable?"":"contenteditable").on("input",function(){var t=this.text.slice();this.update();this.emitEvent("text",{element:{type:"textbox",id:this.id,old_state:t,new_state:this.text}})}.bind(this))};t.prototype.initCloseButton=function(){var t=2.5*this.options.font_size,e=(this.size.width-t)/2;this.button=this.element_div.append("svg").style({position:"absolute",left:e,width:t+2+"px",height:t+2+"px"});this.button_grp=this.button.append("g");this.button_grp.append("circle").attr({r:t/2,cx:t/2+1,cy:t/2+1}).style({stroke:"#ddd","stroke-width":1,fill:"white"});this.button_grp.append("text").text("OK").attr({x:"50%",y:"50%","text-anchor":"middle","alignment-baseline":"central"}).style({fill:"#ddd","font-size":this.options.font_size,"pointer-events":"none"});this.button.on("click",this.fade.bind(this,null))};t.prototype.selectAllText=function(){if(window.getSelection){var t=window.getSelection();t.removeAllRanges();var e=document.createRange();e.selectNodeContents(this.text_element.node());t.addRange(e)}else if(document.selection){var i=document.body.createTextRange();i.moveToElementText(this.text_element.node());i.select()}};t.prototype.setSubTypeActive=function(){this.switchToolbarState(this.active)};t.prototype.switchToolbarState=function(t,e){if(!this.tools||!this.options.use_toolbar)return;e=true;if(t&&this.toolFadeoutTimer){clearTimeout(this.toolFadeoutTimer);this.toolFadeoutTimer=null}else if(t)this.turnOnToolbar();else if(this.dragging)return;else if(e)this.turnOffToolbar();else{this.toolFadeoutTimer=setTimeout(function(){this.turnOffToolbar()}.bind(this),this.toolFadeoutDelay)}};t.prototype.turnOnToolbar=function(){this.tools.style(this.toolbar_on_style)};t.prototype.turnOffToolbar=function(){this.tools.style(this.toolbar_off_style);this.toolFadeoutTimer=null};t.prototype.onButton=function(t){if(t.label==="+")this.increaseTextSize();else if(t.label==="-")this.decreaseTextSize()};t.prototype.changeFontSize=function(t){var e=this.font_size;this.font_size=Math.max(this.options.min_font_size,Math.min(t,this.options.max_font_size));if(this.font_size!==e){this.text_element.style("font-size",this.font_size+"px");this.emitEvent("font_size",{element:{type:"textbox",id:this.id,old_state:e,new_state:this.font_size}});this.update()}};t.prototype.increaseTextSize=function(){var t;if(this.font_size<12)t=1;else if(this.font_size<28)t=2;else if(this.font_size<36)t=8;else t=12;this.changeFontSize(this.font_size+t)};t.prototype.decreaseTextSize=function(){var t;if(this.font_size<=12)t=1;else if(this.font_size<=28)t=2;else if(this.font_size<=36)t=8;else t=12;this.changeFontSize(this.font_size-t)};t.prototype.setText=function(t){this.text_element.node().innerHTML=t;this.update()};t.prototype.update=function(){this.text=this.text_element.node().innerHTML;this.size.height=this.text_element.node().offsetHeight;if(this.closable)this.size.height+=3*this.options.font_size;this.element_div.style({height:this.size.height+"px",width:this.size.width+"px"});if(this.closable){this.button.attr("transform","translate("+[this.size.width/2,this.size.height-3*this.options.font_size]+")")}};t.prototype.subTypeResize=function(){this.update()};t.prototype.unselect=function(){window.getSelection().removeAllRanges()};t.prototype.fade=function(t){var e=750;this.element_div.transition().duration(e).style("opacity",0).each("end",function(){this.canvas_model.removeElement(this);if(t)t()}.bind(this))};t.prototype.cancelFade=function(){this.element_group.transition().duration(0).style("opacity",1)};t.prototype.toJSON=function(){var t={id:this.id,type:"TextBox",pos:this.pos,size:this.size,uneditable:this.uneditable,closable:this.closable,font_size:this.font_size};if(this.text!==this.options.default_text)t.text=this.text;return t};return t}();gmath.ui=gmath.ui||{};gmath.ui.Graph=function(){var t=function(t,e){this.id=e.id?e.id:gmath.uid();this.type="graph";this.options=e||{};this.send_events=true;this.events=d3.dispatch("start-of-interaction","end-of-interaction","move","move_touch","touch","drag","hold","release","zoom","resize","remove_geom","create_geom","geom_attr","mouse_location","link_start","link_drag","link_end");this.interactive=this.options.interactive?this.options.interactive:true;this.container=d3.select(t);this.svg_dims=this.getContainerDimensions();this.view=e.view;this.main_g=null;this.geom_g=null;this.legs_g=null;this.size_g=null;this.move_el=null;this.fill_el=null;this.clip_el=null;this.evts_el=null;this.geoms=this.options.geoms||[];this.pos=this.options.pos||{x:0,y:0};this.size=this.options.size||{width:360,height:360
};this.lims={min:100,max:600};this.domain=this.options.domain||[-5,5];this.x_domain=this.domain;this.y_domain=this.domain;this.x_range=d3.scale.linear().domain(this.x_domain);this.y_range=d3.scale.linear().domain(this.y_domain);this.x_axis=null;this.y_axis=null;this.x_axis_g=null;this.y_axis_g=null;this.x_axis_G=null;this.y_axis_G=null;this.x_lims=false;this.y_lims=false;this.tick_size=36;this.x_ticks=this.options.x_ticks||10;this.y_ticks=this.options.y_ticks||10;this.x_label=this.options.x_label||"x";this.y_label=this.options.y_label||"y";this.x_label_el=null;this.y_label_el=null;this.legs_sel=null;this.legs_ops=this.options.legs_ops||{width:160,height:90,fill:"whitesmoke"};this.legs_offset={width:0,height:0};this.move_offset=0;this.max_dist=this.options.max_dist||30;this.selection=null;this.dragging=false;this.drag_action=null;this.colors=d3.scale.category10();this.delete_mode=false;this.zoom=null;this.initial_pan=e.initial_pan||[0,0];this.initial_zoom=e.initial_zoom||1;this.margin=35;this.defaultMargin=this.margin;this.touch0=null;this.size0=null;this.pos0=null;this.mouse_in_move=true;this.mouse_in_evts=true;this.init()};t.prototype.toJSON=function(){return{id:this.id,type:"Graph",geoms:this.geoms.filter(function(t){return!(t.type==="point"&&t.line)}),pos:this.pos,size:this.size,x_domain:this.x_domain,y_domain:this.y_domain,x_ticks:this.x_ticks,y_ticks:this.y_ticks,legs_ops:this.legs_ops,max_dist:this.max_dist,initial_pan:this.zoom.translate(),initial_zoom:this.zoom.scale()}};t.prototype.setMode=function(t){this.delete_mode=t==="arrange"};t.prototype.setLocked=function(t){this.geoms.forEach(function(e){e.setLocked(t)})};t.prototype.setGeoms=function(t){this.geoms=t;return this.update()};t.prototype.getGeomByID=function(t){var e=this.geoms.filter(function(e){return e.id===t});return e[0]?e[0]:null};t.prototype.setPos=function(t,e){this.pos=t;this.main_g.attr("transform","translate("+this.pos.x+", "+this.pos.y+")");if(e)this.keepInContainer();return this};t.prototype.setSize=function(t){var e=this.zoom.translate(),i=this.zoom.scale();this.zoom.translate([0,0]);this.zoom.scale(1);this.size=t;var n=this.size.width/2/Math.abs(this.x_range.range()[0]),r=this.size.height/2/Math.abs(this.y_range.range()[0]);this.x_range.range([-this.size.width/2,this.size.width/2]);this.y_range.range([this.size.height/2,-this.size.height/2]);this.x_range.domain([this.x_range.domain()[0]*n,this.x_range.domain()[1]*n]);this.y_range.domain([this.y_range.domain()[0]*r,this.y_range.domain()[1]*r]);this.x_axis=d3.svg.axis().scale(this.x_range).tickSize(0,0);this.y_axis=d3.svg.axis().scale(this.y_range).tickSize(0,0).orient("left");this.zoom=d3.behavior.zoom().x(this.x_range).y(this.y_range).translate(e).scale(i).scaleExtent([1/Math.pow(2,8),Math.pow(2,8)]).on("zoom",this.zoomBehavior.bind(this,null));this.update();this.zoomBehavior({translate:e})};t.prototype.setXDomain=function(t){this.x_range.domain(t);return this.update()};t.prototype.setYDomain=function(t){this.y_range.domain(t);return this.update()};t.prototype.inBounds=function(t,e){var i=this.pos.x-this.size.width/2,n=this.pos.x+this.size.width/2,r=this.pos.y-this.size.height/2,o=this.pos.y+this.size.height/2;if(t>i&&t<n&&e>r&&e<o)return true;return false};t.prototype.remove=function(){this.main_g.remove()};t.prototype.enableZoom=function(t){if(t)this.main_g.call(this.zoom);else{this.main_g.on(".zoom",null);d3.select(window).on("mousemove.zoom",null)}};t.prototype.replayZoom=function(t){this.zoom.scale(t.scale);this.zoom.translate(t.translate);this.zoom.event(this.main_g)};t.prototype.zoomBehavior=function(t){var t=t||d3.event,e=this.size.width/2,i=this.size.height/2,n=this.zoom.translate();if(this.send_events)this.events.zoom(new a(this.id,t));if(t.translate[0]<-(e-5)){var n=this.zoom.translate(),r=Math.round(this.x_range.invert(n[0]*-1)),o=Math.round(this.y_range.invert(n[1]*-1)),s=Math.max(Math.abs(r),Math.abs(o)).toString().length;this.margin=Math.max(this.defaultMargin,15+s*5);this.y_axis_G.attr("transform","translate("+[-(e+5),0]+")");this.y_axis_g.attr("transform","translate("+[-(e+5),0]+")");this.y_label_el.attr({x:-(e+15),y:n[1]>=0?-(i+10):i+15});this.y_lims=true}else if(t.translate[0]>e-5){var n=this.zoom.translate(),r=Math.round(this.x_range.invert(n[0]*-1)),o=Math.round(this.y_range.invert(n[1]*-1)),s=Math.max(Math.abs(r),Math.abs(o)).toString().length;var h=10+s*5;this.margin=Math.max(this.defaultMargin,15+s*5);this.y_axis_G.attr("transform","translate("+[e+h,0]+")");this.y_axis_g.attr("transform","translate("+[e+h,0]+")");this.y_label_el.attr({x:e+10,y:n[1]>=0?-(i+10):i+15});this.y_lims=true}else{this.margin=this.defaultMargin;this.y_axis_g.attr("transform","translate("+[t.translate[0],0]+")");this.y_label_el.attr({x:t.translate[0]-4,y:n[1]>=0?-(i+10):i+15});this.y_lims=false}if(t.translate[1]<-(i-5)){this.x_axis_G.attr("transform","translate("+[0,-(i+20)]+")");this.x_axis_g.attr("transform","translate("+[0,-(i+20)]+")");this.x_label_el.attr({x:n[0]>0?-(e+15):e+10,y:-(i+10)});this.x_lims=true}else if(t.translate[1]>i-5){this.x_axis_G.attr("transform","translate("+[0,i+5]+")");this.x_axis_g.attr("transform","translate("+[0,i+5]+")");this.x_label_el.attr({x:n[0]>0?-(e+15):e+10,y:i+15});this.x_lims=true}else{this.x_axis_g.attr("transform","translate("+[0,t.translate[1]]+")");this.x_label_el.attr({x:n[0]>0?-(e+15):e+10,y:t.translate[1]+4});this.x_lims=false}this.x_axis.ticks(this.size.width/this.tick_size);this.y_axis.ticks(this.size.height/this.tick_size);this.update()};t.prototype.init=function(){var t=this;this.main_g=this.container.append("g").classed("graph",true).attr("transform","translate("+this.pos.x+", "+this.pos.y+")").on("mouseenter",this.showMove.bind(this,null)).on("mouseleave",this.hideMove.bind(this,null));this.move_el=this.main_g.append("rect").classed("drag",true).style("opacity",0).style("fill","white");var e=this.main_g.append("defs"),i=e.append("filter").attr("id","dropShadow"+this.id);i.append("feGaussianBlur").attr("in","SourceAlpha").attr("stdDeviation",3);i.append("feOffset").attr("dx",0).attr("dy",2).attr("result","offsetblur");i.append("feComponentTransfer").append("feFuncA").attr("type","linear").attr("slope",.2);var n=i.append("feMerge");n.append("feMergeNode");n.append("feMergeNode").attr("in","SourceGraphic");this.move_el.attr("filter","url(#dropShadow"+this.id+")");var r=mtouch_events().frame(this.main_g.node()).on("touch",this.deleteMove.bind(this,null)).on("drag",this.move.bind(this,null)).on("release",function(){t.enableZoom(true);t.hideMove.bind(t);t.release()});this.move_el.call(r);this.fill_el=this.main_g.append("rect").classed("fill",true).style("fill","white");this.geom_g=this.main_g.append("g");var o=this.main_g.append("defs").append("clipPath").attr("id","clipPath");this.clip_el=o.append("rect");this.geom_g.attr("clip-path","url(#clipPath)");this.legs_g=this.main_g.append("g");this.evts_el=this.main_g.append("rect").classed("evts",true).style("stroke","silver").style("stroke-rendering","crispEdges").style("stroke-width",1).style("pointer-events","all").style("fill","none").on("mousemove",this.hover.bind(this,null)).on("mouseenter",this.withinGrid.bind(this,null)).on("mouseleave",this.withinGrid.bind(this,null));var s=mtouch_events().frame(this.main_g.node()).on("touch",this.touch.bind(this,null)).on("drag",this.drag.bind(this,null)).on("release",this.release.bind(this,null)).on("hold",this.hold.bind(this,null)).hold_time(1e3).hold_max_dist(2);this.evts_el.call(s);this.x_axis_g=this.geom_g.append("g").classed("axis",true).style("stroke","silver").style("stroke-rendering","crispEdges").style("stroke-width",1).style("vector-effect","non-scaling-stroke");this.x_axis_G=this.main_g.append("g").classed("axis",true).style("stroke","silver").style("stroke-rendering","crispEdges").style("stroke-width",1).style("vector-effect","non-scaling-stroke");this.y_axis_g=this.geom_g.append("g").classed("axis",true).style("stroke","silver").style("stroke-rendering","crispEdges").style("stroke-width",1).style("vector-effect","non-scaling-stroke");this.y_axis_G=this.main_g.append("g").classed("axis",true).style("stroke","silver").style("stroke-rendering","crispEdges").style("stroke-width",1).style("vector-effect","non-scaling-stroke");this.x_label_el=this.main_g.append("text").classed("axis",true).attr("font-weight","lighter").attr("font-family","Lato");this.y_label_el=this.main_g.append("text").classed("axis",true).attr("font-weight","lighter").attr("font-family","Lato");this.x_range.range([-this.size.width/2,this.size.width/2]);this.y_range.range([this.size.height/2,-this.size.height/2]);this.x_axis=d3.svg.axis().scale(this.x_range).tickSize(0,0);this.y_axis=d3.svg.axis().scale(this.y_range).tickSize(0,0).orient("left");if(Math.abs(this.x_range.range()[0])<=Math.abs(this.y_range.range()[0])){var a=Math.abs(this.x_range.range()[0])/Math.abs(this.domain[0]),h=Math.abs(this.y_range.range()[0])/a;this.y_range.domain([-h,h]);this.y_axis.ticks(h*2)}else{var a=Math.abs(this.y_range.range()[0])/Math.abs(this.domain[0]),h=Math.abs(this.x_range.range()[0])/a;this.x_range.domain([-h,h]);this.x_axis.ticks(h*2)}this.zoom=d3.behavior.zoom().x(this.x_range).y(this.y_range).translate(this.initial_pan).scale(this.initial_zoom).scaleExtent([1/Math.pow(2,8),Math.pow(2,8)]).on("zoom",this.zoomBehavior.bind(this,null));this.enableZoom(true);this.update();this.zoomBehavior({translate:this.initial_pan})};t.prototype.update=function(){this.x_axis_G.call(this.x_axis).style("display",this.x_lims?"block":"none").select("path").style("display","none");this.x_axis_g.call(this.x_axis).selectAll(".tick").each(function(t){var e=d3.select(this).select("text");e.style("display",e.text()*1===0?"none":"block")});this.y_axis_G.call(this.y_axis).style("display",this.y_lims?"block":"none").select("path").style("display","none");this.y_axis_g.call(this.y_axis).selectAll(".tick").each(function(t){var e=d3.select(this).select("text");e.style("display",e.text()*1===0?"none":"block")});this.x_axis_g.selectAll(".tick").select("line").attr("x1",0).attr("x2",0).attr("y1",-(this.size.height+20)).attr("y2",this.size.height+20).style("stroke","gainsboro").style("opacity",.8);var t=this.zoom.translate(),e=Math.round(this.x_range.invert(t[0]*-1)),i=Math.round(this.y_range.invert(t[1]*-1)),n=Math.max(Math.abs(e),Math.abs(i)).toString().length;this.y_axis_g.selectAll(".tick").select("line").attr("x1",-(this.size.width+(10+n*5))).attr("x2",this.size.width+20).attr("y1",0).attr("y2",0).style("stroke","gainsboro").style("opacity",.8);this.x_label_el.text(this.x_label);this.y_label_el.text(this.y_label);this.geoms.forEach(function(t){t.update()});var r=this.x_range.range()[0],o=this.y_range.range()[0],s=this.x_range.range()[1],a=this.y_range.range()[1],h=Math.abs(s-r),l=Math.abs(a-o);this.move_el.attr({x:r-this.margin,y:Math.min(o,a)-this.margin}).attr("width",h+this.margin*2+this.legs_offset.width).attr("height",l+this.margin*2+this.legs_offset.height);this.fill_el.attr({x:r,y:Math.min(o,a)}).attr("width",h).attr("height",l);this.clip_el.attr({x:r,y:Math.min(o,a)}).attr("width",h).attr("height",l);this.evts_el.attr({x:r,y:Math.min(o,a)}).attr("width",h).attr("height",l);var d=this;this.keepInContainer()};t.prototype.updateLegends=function(){this.legs_sel=this.legs_g.selectAll(".graph.legend").data(this.geoms);var t=this.legs_sel.enter().append("g").classed("graph.legend",true);t.append("rect").attr("rx",5).attr("ry",5).attr("width",this.legs_ops.width).attr("height",this.legs_ops.height).style("fill",this.legs_ops.fill);var e=t.append("g").attr("transform","translate(-20, 0)");var i={interaction_mode:"change",no_history:true,no_handles:true,draggable:false,bg_rect_style:{fill:"none",stroke:"none",opacity:0},bg_rect_activity_style:{fill:"none",stroke:"none",opacity:0},h_align:"left",v_align:"top"};t.each(function(t){var e=this.select("g").node();t.linkRepresentations(e,i)});var n=t.append("g");n.append("circle").attr("cx",this.legs_ops.width-15).attr("cy",15).attr("r",10).style("fill",function(t){return t.color});var r=mtouch_events().frame(this.main_g.node()).on("touch",function(t){this.legs_sel.filter(function(e){return t.id===e.id}).style("display","none");this.orderLegends()});n.call(r);var o=6*Math.sqrt(2)/2;n.append("line").attr({x1:this.legs_ops.width-15+o,y:15-o,x2:this.legs_ops.width-15-o,y:15+o}).style("stroke",this.legs_ops.fill).style("stroke-width",2).style("stroke-linecap","round");n.append("line").attr({x1:this.legs_ops.width-15-o,y:15-o,x2:this.legs_ops.width-15+o,y:15+o}).style("stoke",this.legs_ops.fill).style("stroke-width",2).style("stroke-linecap","round");this.legs_sel.exit().remove()};t.prototype.orderLegends=function(){var t=this.size.width/2+5,e=-this.size.height/2,i=0;this.legs_offset.width=0;this.legs_offset.height=0;this.legs_sel.attr("transform",function(n){var r=this.style("display"),o="translate("+t+", "+e+")";if(r==="block"){e+=this.legs_ops.height+5;i++}return o});if(i>0){this.legs_offset.width=this.legs_ops.width+5;if(e>this.size.height){this.legs_offset.height=this.size.height-e}}this.update()};t.prototype.move=function(t){var e=t||d3.event;if(!this.interactive)return;if(this.send_events)this.events.move(new i(this.id,e));if(!this.selection){if(!this.pos0){this.pos0={x:this.pos.x,y:this.pos.y}}this.delta={x:this.pos.x-this.pos0.x,y:this.pos.y-this.pos0.y};var n=e.finger.dx,r=e.finger.dy;this.setPos({x:this.pos.x+n,y:this.pos.y+r},true);this.showMove();if(t&&t.finger){this.updateFingers([e.finger])}}};t.prototype.hover=function(){if(this.delete_mode){var t=d3.event.x-this.pos.x-this.margin,e=d3.event.y-this.pos.y-this.margin,i=this.getClosest(t,e);this.geoms.forEach(function(t){t.select(t===i?true:false,true)})}};t.prototype.showMove=function(){if(this.dragging)return;if(this.send_events)this.events.mouse_location(new u(this.id,"in-main"));if(this.delete_mode)this.move_el.style("stroke","red");this.move_el.style("opacity",1);this.move_offset=this.margin;this.mouse_in_move=true;this.geoms.forEach(function(t){setTimeout(function(){t.updateLinkHandle()},50)})};t.prototype.hideMove=function(){if(this.send_events)this.events.mouse_location(new u(this.id,"out-main"));if(this.delete_mode)this.move_el.style("stroke","none");this.move_el.style("opacity",0);this.move_offset=0;this.mouse_in_move=false;this.geoms.forEach(function(t){setTimeout(function(){t.updateLinkHandle()},50)})};t.prototype.withinGrid=function(t){var e=t||d3.event;if(this.send_events)this.events.mouse_location(new u(this.id,e.type==="mouseenter"?"in-grid":"out-grid"));this.mouse_in_evts=e.type==="mouseenter"?true:false;this.geoms.forEach(function(t){setTimeout(function(){t.updateLinkHandle()},50)})};t.prototype.deleteMove=function(t){var i=t||d3.event;if(this.send_events){this.events["start-of-interaction"]({type:"start-of-interaction",source:{type:"Graph",id:this.id},pos:gmath.deepCopy(this.pos),time:Date.now(),subSource:"deleteMove"});this.events.move_touch(new e(this.id))}this.svg_dims=this.getContainerDimensions();this.enableZoom(false);if(this.delete_mode){this.view.removeGraph(this);gmath.LinkCoordinator.unlinkGraph(this)}};t.prototype.touch=function(t){var e=t||d3.event;if(!this.interactive)return;if(t&&t.finger){this.updateFingers([e.finger])}var i=e.finger.pos[0],r=e.finger.pos[1];this.selection=this.getClosest(i,r);if(this.selection)this.enableZoom(false);if(this.selection&&this.selection.locked){this.selection=null}if(this.delete_mode){if(this.selection){var o=this.selection.removeGroup();for(var s=0;s<o.length;s++){for(var a=0;a<this.geoms.length;a++){if(this.geoms[a].id===o[s]){this.geoms.splice(a,1)}}}}}else{if(this.selection&&this.selection.type==="point-slope"){var h=this;this.drag_action=function(){h.geoms.forEach(function(t){if(t.type==="point"&&t.id!==h.selection.id&&!t.line&&!t.intercept)t.showSnap(true)});h.drag_action=null}}}if(this.send_events){var l=this.selection;if(l&&l.line)l=l.line;this.events["start-of-interaction"]({type:"start-of-interaction",source:{type:"Graph",id:this.id,selection:l?l.summarize():null,selection_id:l?l.id:null},time:Date.now(),subSource:"touch"});this.events.touch(new n(this.id,e))}};t.prototype.drag=function(t){this.dragging=true;var e=t||d3.event;if(!this.interactive)return;if(this.send_events)this.events.drag(new r(this.id,e));if(t&&t.finger){this.updateFingers([e.finger],true)}var i=e.finger.pos[0],n=e.finger.pos[1];if(this.drag_action)this.drag_action();if(this.selection){if(this.selection.type==="point")this.selection.drag(e.finger.dx,e.finger.dy);else this.selection.drag(i,n)}};t.prototype.addGeom=function(t,e){var i;if(t==="Point"){i=new gmath.ui.Point(this.geom_g.node(),e)}else if(t==="SILine"){i=new gmath.ui.SILine(this.geom_g.node(),e)}else if(t==="PSLine"){i=new gmath.ui.PSLine(this.geom_g.node(),e)}else if(t==="PPLine"){i=new gmath.ui.PPLine(this.geom_g.node(),e)}else if(t==="ARLine"){i=new gmath.ui.ARLine(this.geom_g.node(),e)}this.geoms.push(i);return i};t.prototype.hold=function(t){var e=t||d3.event;if(!this.interactive||this.delete_mode)return;if(this.send_events)this.events.hold(new o(this.id,e));var i=e.finger.pos[0],n=e.finger.pos[1];this.selection=this.getClosest(i,n);if(!this.selection||this.selection.type!=="point"||this.selection.line){var r=Math.abs(this.zoom.translate()[0]-i)<20?true:false,s={graph:this,pos:r?{x:0,y:this.y_range.invert(n)}:{x:this.x_range.invert(i),y:this.y_range.invert(n)},color:this.colors(this.geoms.length),intercept:r},a=new gmath.ui.Point(this.geom_g.node(),s);this.geoms.push(a);this.listenToGeom(a);this.selection=a}if(this.selection.type==="point"&&!this.selection.line){this.enableZoom(false);this.selection.showSnap();var h=this;this.drag_action=function(){h.selection.showSnap(false);var t={graph:h,point:h.selection,color:h.selection.color},e=null;if(h.selection.intercept){e=new gmath.ui.SILine(h.geom_g.node(),t)}else{e=new gmath.ui.PSLine(h.geom_g.node(),t);h.geoms.forEach(function(t){if(t.type==="point"&&t.id!==h.selection.id&&!t.line&&!t.intercept)t.showSnap(true)})}h.geoms.push(e);h.listenToGeom(e);h.selection=e;h.drag_action=null}}else{this.selection=null;this.enableZoom(true)}};t.prototype.listenToGeom=function(t){var e=this;if(this.send_events){this.events.create_geom(gmath.extend(new l(t),{graph_id:e.id}))}if(t.is_linkable){t.link_events.on("link_start."+this.id,this.events.link_start.bind(this)).on("link_drag."+this.id,this.events.link_drag.bind(this)).on("link_end."+this.id,this.events.link_end.bind(this))}t.events.on("remove",function(t){if(e.send_events){e.events.remove_geom(gmath.extend(t,{graph_id:e.id}))}})};t.prototype.release=function(t){this.dragging=false;var e=t||d3.event;if(!this.interactive)return;this.updateFingers([]);var i=e.finger.pos[0],n=e.finger.pos[1],r=this;this.geoms.forEach(function(t){if(t.type==="point")t.showSnap(false);if(r.selection&&r.selection.type==="point-slope"&&!t.line&&!t.intercept){if(t.distanceTo(i,n)<t.radius*2){t.setColor(r.selection.color);var e={graph:r,point_a:r.selection.point,point_b:t,color:r.selection.color},o=new gmath.ui.PPLine(r.geom_g.node(),e);r.selection.remove();for(var s=0;s<r.geoms.length;s++){if(r.geoms[s].id===r.selection.id)r.geoms.splice(s,1,o)}r.selected=o}}});if(this.selection){if(this.send_events){this.events.geom_attr(gmath.extend(new d(this.selection),{graph_id:this.id}))}this.selection.release();this.selection=null;this.enableZoom(true)}this.drag_action=null;if(this.pos0){this.pos0=null}if(this.send_events){var o=this.selection;if(o&&o.line)o=o.line;this.events.release(new s(this.id,e));this.events["end-of-interaction"]({type:"end-of-interaction",source:{type:"Graph",id:this.id,selection:o?o.summarize():null,selection_id:o?o.id:null},pos:gmath.deepCopy(this.pos),time:Date.now()})}};t.prototype.resize_touch=function(t){var e=t||d3.event;if(this.send_events)this.events.resize(new h(this.id,e,"touch"));this.touch0={x:e.finger.pos[0],y:e.finger.pos[1]};this.size0={width:this.size.width,height:this.size.height};this.pos0={x:this.pos.x,y:this.pos.y};this.svg_dims=this.getContainerDimensions();this.enableZoom(false)};t.prototype.resize=function(t){var e=t||d3.event;if(this.send_events)this.events.resize(new h(this.id,e,"drag"));if(!this.pos0){this.pos0={x:this.pos.x,y:this.pos.y}}this.hideMove();var i={x:e.finger.pos[0],y:e.finger.pos[1]},n={width:this.size0.width+(i.x-this.touch0.x),height:this.size0.height+(i.y-this.touch0.y)},r={x:this.pos0.x+(i.x-this.touch0.x)/2,y:this.pos0.y+(i.y-this.touch0.y)/2};if(n.width>=this.lims.min&&n.height>=this.lims.min&&n.width<=this.lims.max&&n.height<=this.lims.max&&n.width+this.margin*2<=this.svg_dims.width&&n.height+this.margin*2<=this.svg_dims.height){this.setSize(n);this.setPos(r)}};t.prototype.resize_release=function(t){var e=t||d3.event;if(this.send_events)this.events.resize(new h(this.id,e,"release"));this.enableZoom(true)};t.prototype.getClosest=function(t,e){var i=this.max_dist,n=null;this.geoms.forEach(function(r){var o=r.distanceTo(t,e);if(o<=i){if(n&&n.type==="point"&&n.line&&n.line===r&&o<20){i=o}else{i=o;n=r}}});return n};t.prototype.getContainerDimensions=function(){var t=this.container.node();while(t.tagName.toLowerCase()!=="svg"&&t.parentNode)t=t.parentNode;return t.getBoundingClientRect()};t.prototype.keepInContainer=function(){var t=this.pos.x,e=this.pos.y,i=this.size.width/2,n=this.size.height/2,r=this.legs_offset.width,o=this.legs_offset.height,s=this.move_offset,a=this.svg_dims.width,h=this.svg_dims.height,l=t<i+s+2?i+s+2:t+i+s+r+4>a?a-(i+r+s+4):t,d=e<n+s+2?n+s+2:e+n+s+o+4>h?h-(n+o+s+4):e;if(t!==l||e!==d)this.setPos({x:l,y:d},false)};var e=function(t){this.performee=t;this.performee_type="graph";this.type="moveTouch";this.time=Date.now()};var i=function(t,e){this.performee=t;this.performee_type="graph";this.type="move";this.time=Date.now();this.finger={pos:[e.finger.pos[0],e.finger.pos[1]],dx:e.finger.dx,dy:e.finger.dy}};var n=function(t,e){this.performee=t;this.performee_type="graph";this.type="touch";this.time=Date.now();this.finger={pos:[e.finger.pos[0],e.finger.pos[1]]}};var r=function(t,e){this.performee=t;this.performee_type="graph";this.type="drag";this.time=Date.now();this.finger={pos:[e.finger.pos[0],e.finger.pos[1]],dx:e.finger.dx,dy:e.finger.dy}};var o=function(t,e){this.performee=t;this.performee_type="graph";this.type="hold";this.time=Date.now();this.finger={pos:[e.finger.pos[0],e.finger.pos[1]]}};var s=function(t,e){this.performee=t;this.performee_type="graph";this.type="release";this.time=Date.now();this.finger={pos:[e.finger.pos[0],e.finger.pos[1]]}};var a=function(t,e){this.performee=t;this.performee_type="graph";this.type="zoom";this.time=Date.now();this.translate=[e.translate[0],e.translate[1]];this.scale=e.scale};var h=function(t,e,i){this.performee=t;this.performee_type="graph";this.type="resize";this.resize_type=i;this.time=Date.now();this.finger={pos:[e.finger.pos[0],e.finger.pos[1]],dx:e.finger.dx,dy:e.finger.dy}};var l=function(t){this.performee=t.id;this.performee_type=t.type;this.performee_object=t;this.type="graphElementCreate";this.time=Date.now()};t.GraphElementRemoveEvent=function(t){this.performee=t.id;this.performee_type=t.type;this.performee_object=t.summarize();this.type="graphElementRemove";this.time=Date.now()};var d=function(t){this.performee=t.line?t.line.id:t.id;this.performee_object=t.line?t.line:t;this.type="graphElementChange";this.time=Date.now()};t.GraphGeomEvent=d;var u=function(t,e){this.performee=t;this.performee_type="graph";this.type="mouseLocation";this.location=e;this.time=Date.now()};t.prototype.updateFingers=function(t,e){if(!this.finger_sel){this.finger_vis_start=Date.now();this.finger_sel=this.main_g.selectAll(".finger")}var i=this.finger_sel.data(t);if(!e){i.enter().append("circle").classed("finger",true).attr("r",25).style({stroke:"#4D4D4D","stroke-opacity":.5,fill:"#B2CAED","fill-opacity":.5})}if(this.pos0){var n=this.pos.x-this.pos0.x,r=this.pos.y-this.pos0.y}var o=this;i.attr("cx",function(t){return o.pos0?t.pos[0]-n:t.pos[0]}).attr("cy",function(t){return o.pos0?t.pos[1]-r:t.pos[1]});i.transition().ease("bounce").attr("r",17);var s=this.finger_vis_start;i.exit().transition().delay(Math.max(0,250-(Date.now()-s))).style("opacity",1e-4).remove();this.finger_sel=i.size()===0?null:i};t.prototype.summarizeElements=function(){var t=[];this.geoms.filter(function(t){return!t.line}).forEach(function(e){t.push(e.summarize())});return t};return t}();var st=function(t){this.prototype.is_linkable=true;this.prototype.link_events=d3.dispatch("link_start","link_drag","link_end");this.prototype.startLinking=function(t){var i=t||d3.event;if(this.graph.send_events){this.graph.events["start-of-interaction"]({type:"start-of-interaction",source:{type:"Graph",id:this.graph.id,selection:this.summarize()},time:Date.now()});this.link_events.link_start(new e(this.graph.id,this,i))}var n=i.finger.pos[0],r=i.finger.pos[1],o=this.id;this.graph.enableZoom(false);this.graph.geoms.forEach(function(t){if(t.id!==o){t.dragging=true;t.updateLinkHandle()}});this.link=d3.select(this.container.node().parentNode).insert("g","#"+this.id+"_handle");this.link.append("line").style("stroke",this.color).style("stroke-width",this.width||2).style("stroke-linecap","round").attr({x1:this.link_handle.attr("cx"),y1:this.link_handle.attr("cy"),x2:n,y2:r});this.link.append("circle").attr({cx:n,cy:r,r:10}).style("fill","white").style("stroke",this.color).style("stroke-width",this.width||2)};this.prototype.linking=function(t){var e=t||d3.event;if(this.graph.send_events)this.link_events.link_drag(new i(this.graph.id,this,e));var n=e.finger.pos[0],r=e.finger.pos[1];this.graph.showMove();this.link.select("line").attr({x2:n,y2:r});this.link.select("circle").attr({cx:n,cy:r})};this.prototype.endLinking=function(t){var e=t||d3.event;if(this.graph.send_events)this.link_events.link_end(new n(this.graph.id,this,e));var i=e.finger.pos[0],r=e.finger.pos[1],o=i+this.graph.pos.x,s=r+this.graph.pos.y,a=null,h="canvas",l=this.id;this.graph.view.graphs().forEach(function(t){if(t.inBounds(o,s)){a=t;h="graph"}});this.graph.view.dls().forEach(function(t){var e=t.pos.x,i=e+t.size.width,n=t.pos.y,r=n+t.size.height;if(o>e&&o<i&&s>n&&s<r){a=t;h="derivation"}});if(h==="canvas"){this.createDLFromGeom([o,s])}this.graph.enableZoom(true);this.graph.geoms.forEach(function(t){if(t.id!==l){t.updateLinkHandle();t.dragging=false}});this.graph.hideMove();this.link.remove();this.link=null;if(this.graph.send_events){this.graph.events["start-of-interaction"]({type:"end-of-interaction",source:{type:"Graph",id:this.graph.id,selection:this.summarize()},time:Date.now()})}};var e=function(t,e,i){this.performee=e.id;this.performee_type=e.type;this.graph_id=t;this.type="linkStart";this.time=Date.now();this.finger={pos:[i.finger.pos[0],i.finger.pos[1]]}};var i=function(t,e,i){this.performee=e.id;this.performee_type=e.type;this.graph_id=t;this.type="linkDrag";this.time=Date.now();this.finger={pos:[i.finger.pos[0],i.finger.pos[1]]}};var n=function(t,e,i){this.performee=e.id;this.performee_type=e.type;this.graph_id=t;this.type="linkEnd";this.time=Date.now();this.finger={pos:[i.finger.pos[0],i.finger.pos[1]]}}};if(typeof module==="object"&&module.exports){module.exports=st}gmath.ui=gmath.ui||{};gmath.ui.SILine=function(){var t=function(t,e){var e=e||{};this.events=d3.dispatch("slope","intercept","release","remove");this.container=d3.select(t);this.graph=e.graph;this.element=null;this.lock_element=null;this.id=e.id||gmath.uid();this.intercept=e.point;this.slope=e.slope||0;this.slope0=this.slope;this.color=e.color||"steelblue";this.width=e.width||2;this.type="slope-intercept";this.x_str=e.x_str||"x";this.y_str=e.y_str||"y";this.link_handle=null;this.link=null;this.dragging=false;this.init()};t.prototype.summarize=function(){return{type:"slope-intercept",id:this.id,point:gmath.deepCopy(this.intercept.pos),slope:this.slope}};t.prototype.toJSON=function(){return{id:this.id,type:"SILine",graph:this.graph.id,intercept:this.intercept,slope:this.slope,color:this.color,width:this.width}};t.prototype.setLocked=function(t){this.intercept.setLocked(t);if(this.locked!==t){this.locked=t;this.lock_element.style("opacity",t?.3:0)}};t.analyzeStructure=function(t,e){var i={val_b:null,node_b:null,val_m:null,node_m:null,y_node:null,x_node:null};if(!t.children[0].is_group("equals"))return false;var n=t.children[0].children[0],r=t.children[0].children[2];if(!(n.is_group("var")&&h.get_value(n,true)==="y"))return false;i.y_node=n;var o,a,l;if(r.is_group("sum")&&r.children.length>2)return false;if(r.is_group("sum")){l=true;o=r.children[0].children[1];a=r.children[1]}else{o=r;a=r}var d,u;if(o.is_group("product")){if(o.children.length>2)return false;d=o.children[0].children[1];u=o.children[1].children[1]}else if(h.is_var(o)||o.is_group("sign")&&h.is_var(o.children[1])){d=null;u=o}else if(o.is_group("sign")&&o.children[1].is_group("sign")){return false}else if(s.is_num(o)&&s.get_value(o)===0){if(!e)return false;d=o;u=null}else if(l){return false}else{o=null;d=null;u=null}if(u)i.x_node=u;if(d&&!s.is_num(d))return false;if(u){var c;if(u.is_group("sign")){c=u.children[1]}else{c=u}if(u.is_group("power")||h.get_value(c,true)!=="x")return false}if(!l&&u){a=null}if(!s.get_value(a)&&s.get_value(a)!==0&&l)return false;if(u||d){if(d){if(u&&u.is_group("sign"))return false;i.val_m=l&&r.children[0].is_group("sub")?-s.get_value(d):s.get_value(d);i.node_m=d}else{i.val_m=u.is_group("sign")||u.parent.is_group("sub")?-1:1;i.node_m=null}}else{i.val_m=0;i.node_m=null}if(a){i.val_b=s.get_value(a);i.node_b=a}else{i.val_b=0;i.node_b=null}return i};t.prototype.linkToDL=function(e,i,n){var o=this,s=e.model,a=i,h=n,l=e.view;e.setHandleColor(this.color);var d=function(t,e){if(!t)return;if(t.selected!==e){t.selected=e;l.renderer.set_style([t]);l.update_existing("normal",true)}};var u=function(t,e){return function(){return d(t,e)}};var c=gmath.uid();var p=function(e){if(e.old_model!==s)throw"wrong old_model";if(e.new_model!==e.old_model){s.events.on("change."+c,null);s.events.on("end-of-interaction."+c,null);s=e.new_model;s.events.on("change."+c,p);s.events.on("end-of-interaction."+c,f)}var i=t.analyzeStructure(s,true);if(!i)return;if(a!==i.node_m){d(a,false);a=i.node_m}if(h!==i.node_b){d(h,false);h=i.node_b}var n=i.val_m;var r=i.val_b;if(n!==o.slope)o.setSlope(n);if(r!==o.intercept.pos.y)o.setIntercept({x:0,y:r})};var f=function(){o.release();o.intercept.release()};var g=e.dl;s.events.on("change."+c,p);s.events.on("end-of-interaction."+c,f);o.events.on("slope."+c,function(t){if(!a){var e=new r(o.toAsciiEq());s.replace_with(e);return}if(t!==s.numeric_value(a)){g.setActiveDLComponent("AV");s.numeric_value(a,t);d(a,true)}}).on("release."+c,function(){d(a,false);g.setActiveDLComponent("none");e.view.update_all();e.updateDimensionAfterInteraction(true)});o.intercept.events.on("y."+c,function(t){if(!h){var e=new r(o.toAsciiEq());s.replace_with(e);return}if(t!==s.numeric_value(h)){g.setActiveDLComponent("AV");s.numeric_value(h,t);d(h,true)}}).on("release."+c,function(){d(h,false);g.setActiveDLComponent("none");e.view.update_all();e.updateDimensionAfterInteraction(true)})};t.createGeomFromDL=function(e,i){var n=t.analyzeStructure(e.model);if(!n)return false;var r=n.node_m,o=n.node_b,s=n.val_m,a=n.val_b,h=n.y_node?n.y_node.to_ascii():"y",l=n.x_node?n.x_node.to_ascii():"x",d={graph:i,pos:{x:0,y:a},color:i.colors(i.geoms.length),intercept:true},u=new gmath.ui.Point(i.geom_g.node(),d);i.geoms.push(u);d={graph:i,point:u,slope:s,color:u.color,y_str:h,x_str:l};var c=new gmath.ui.SILine(i.geom_g.node(),d);c.graph.listenToGeom(c);i.geoms.push(c);c.linkToDL(e,r,o);gmath.LinkCoordinator.addLink({source:e.model,target:c,bidirectional:true});return true};t.createGeomPreviewFromDL=function(e,i){var n=t.analyzeStructure(e.model);if(!n)return false;var r=n.node_m,o=n.node_b,s=n.val_m,a=n.val_b,h=n.y_node?n.y_node.to_ascii():"y",l=n.x_node?n.x_node.to_ascii():"x",d=function(t){var e={graph:i,point:t,slope:s,color:"silver",y_str:h,x_str:l};return new gmath.ui.SILine(i.geom_g.node(),e)};return dt(0,a,true,d,i);
};t.prototype.toAsciiEq=function(){var t=this.intercept.pos.y;return this.y_str+"="+this.slope+this.x_str+(t<0?"":"+")+t};t.prototype.createDLFromGeom=function(t){var e={eq:this.toAsciiEq(),pos:{x:t[0],y:t[1]},interaction_mode:"inspect"},i=this.graph.view.createDL(e,function(t){var e=t.options.pos,i=t.getLastRow().getHandlePos(),n={x:e.x-i[0],y:e.y-i[1]};t.translateElement(n)}),n=i.getLastRow().model,r=[0,2,0,1,0,1],o=[0,2,1],s=n.get_child(r),a=n.get_child(o);this.linkToDL(i.rows[0],s,a);gmath.LinkCoordinator.addLink({source:this,target:i.getLastModel(),bidirectional:true})};t.prototype.init=function(){this.element=this.container.insert("line","#"+this.intercept.id).attr("id",this.id).classed("SILine",true).style("fill","none").style("stroke",this.color).style("stroke-width",this.width).style("stroke-linecap","round");this.lock_element=this.container.insert("line","#"+this.id).style("fill","none").style("stroke","black").style("opacity",this.locked?.3:0).style("stroke-width",3*this.width).style("stroke-linecap","round");this.intercept.line=this;this.link_handle=d3.select(this.container.node().parentNode).append("circle").attr("id",this.id+"_handle").attr("r",10).attr("fill","white").style("stroke",this.color).style("stroke-width",this.width).style("visibility","hidden");var t=mtouch_events().frame(this.container.node().parentNode).on("touch",this.startLinking.bind(this,null)).on("drag",this.linking.bind(this,null)).on("release",this.endLinking.bind(this,null));this.link_handle.call(t);this.update()};t.prototype.setIntercept=function(t,e){this.intercept.setPos(t);this.update(e);this.events.intercept(t);return this};t.prototype.setSlope=function(t,e){this.slope=t;this.update(e);this.events.slope(t);return this};t.prototype.select=function(t,e){if(e)this.intercept.select(t);this.element.style("stroke",t?d3.rgb(this.color).brighter():this.color)};t.prototype.drag=function(t,e){if(!this.dragging){this.dragging=true;this.updateLinkHandle()}var i=t-this.graph.x_range(this.intercept.pos.x),n=-e- -this.graph.y_range(this.intercept.pos.y);if(i!==0)this.setSlope(n/i)};t.prototype.release=function(){this.dragging=false;this.updateLinkHandle();this.events.release()};t.prototype.distanceTo=function(t,e){var i=this.graph.x_range(this.intercept.pos.x),n=-this.graph.y_range(this.intercept.pos.y),r=this.graph.x_range(this.intercept.pos.x)+1,o=-this.graph.y_range(this.intercept.pos.y)+this.slope;return ht(i,n,r,o,t,-e)};t.prototype.remove=function(){this.element.remove();this.lock_element.remove();gmath.LinkCoordinator.unlinkElement(this);if(this.intercept.line.id===this.id)this.intercept.line=null;return this.id};t.prototype.removeGroup=function(){if(d3.event)this.events.remove(new gmath.ui.Graph.GraphElementRemoveEvent(this,this.graph.id));this.intercept.remove();this.element.remove();this.lock_element.remove();this.link_handle.remove();return[this.intercept.id,this.id]};t.prototype.update=function(t){if(t)this.element.transition().tween("line",this.tween.bind(this,null));else this.element.transition().duration(0).tween("line",this.tween.bind(this,null));return this};t.prototype.updateLinkHandle=function(){var t=this.graph.x_range,e=this.graph.y_range,i=this.element.attr("x2")*1,n=this.element.attr("y2")*1,r=i>=t.range()[0]&&i<=t.range()[1]&&n<=e.range()[0]&&n>=e.range()[1],o=r&&(this.graph.mouse_in_move&&!this.graph.mouse_in_evts&&!this.dragging||this.link);if(i===t.range()[1]){this.link_handle.attr({cx:i+17.5,cy:n})}else if(n>0){this.link_handle.attr({cx:i,cy:n+17.5})}else{this.link_handle.attr({cx:i,cy:n-17.5})}this.link_handle.style("visibility",o?"visible":"hidden")};t.prototype.tween=function(t){var e=t||this.element,i=this.lock_element,n=this.slope0,r=this.slope,o=this.graph.x_range,s=this.graph.y_range,a=this.intercept.pos.y,h=o.domain()[0],l=o.domain()[1],d=s.domain()[0],u=s.domain()[1],c=this;return function(t){var p=n+t*(r-n),f=at(0,a,1,a+p,h,l,d,u);e.attr({x1:o(f[0].x),y1:s(f[0].y),x2:o(f[1].x),y2:s(f[1].y)});i.attr({x1:o(f[0].x),y1:s(f[0].y),x2:o(f[1].x),y2:s(f[1].y)});c.slope0=p}};return t}();st.call(gmath.ui.SILine);function at(t,e,i,n,r,o,s,a){var h={x:t,y:e},l={x:i,y:n},d=[h,l],u=h.y<l.y?[s,a]:[a,s],c=h.x<l.x?[r,o]:[o,r];if(h.x-l.x===0){return[{x:h.x,y:u[0]},{x:l.x,y:u[1]}]}else{var p=[],f=(h.y-l.y)/(h.x-l.x);d.forEach(function(t,e){var i=u[e],n=t.x-(t.y-i)/f;if(n<r||n>o){n=c[e];i=t.y-f*(t.x-n)}p.push({x:n,y:i})});return p}}function ht(t,e,i,n,r,o){var s=i-t,a=n-e;return Math.abs(a*r-s*o+i*e-n*t)/Math.sqrt(a*a+s*s)}gmath.ui=gmath.ui||{};gmath.ui.PPLine=function(){var t=function(t,e){var e=e||{};this.events=d3.dispatch("point_a","point_b","remove");this.container=d3.select(t);this.graph=e.graph;this.element=null;this.id=gmath.uid();this.point_a=e.point_a;this.point_b=e.point_b;this.color=e.color||"steelblue";this.width=e.width||2;this.type="point-point";this.link_handle=null;this.link=null;this.dragging=false;this.init()};t.prototype.toJSON=function(){return{id:this.id,type:"PPLine",graph:this.graph.id,point_a:this.point_a,point_b:this.point_b,color:this.color,width:this.width}};t.prototype.init=function(){this.element=this.container.insert("line","#"+this.point_a.id).attr("id",this.id).classed("PPLine",true).style("fill","none").style("stroke",this.color).style("stroke-width",this.width).style("stroke-linecap","round");this.point_a.line=this;this.point_b.line=this;this.update()};t.prototype.setPointA=function(t,e){this.point_a=t;this.update(e);this.events.point_a(t);return this};t.prototype.setPointB=function(t,e){this.point_b=t;this.update(e);this.events.point_b(t);return this};t.prototype.select=function(t,e){if(e){this.point_a.select(t);this.point_b.select(t)}this.element.style("stroke",t?d3.rgb(this.color).brighter():this.color)};t.prototype.drag=function(){};t.prototype.release=function(){};t.prototype.distanceTo=function(t,e){var i=this.graph.x_range(this.point_a.pos.x),n=-this.graph.y_range(this.point_a.pos.y),r=this.graph.x_range(this.point_b.pos.x),o=-this.graph.y_range(this.point_b.pos.y);return ht(i,n,r,o,t,-e)};t.prototype.remove=function(){this.element.remove();if(this.point_a.line.id===this.id)this.point_a.line=null;if(this.point_b.line.id===this.id)this.point_b.line=null;return this.id};t.prototype.removeGroup=function(){if(d3.event)this.events.remove(new gmath.ui.Graph.GraphElementRemoveEvent(this,this.graph.id));this.point_a.remove();this.point_b.remove();this.element.remove();return[this.point_a.id,this.point_b.id,this.id]};t.prototype.update=function(t){if(t)this.element.transition().tween("line",this.tween.bind(this,null));else this.element.transition().duration(0).tween("line",this.tween.bind(this,null));return this};t.prototype.updateLinkHandle=function(){};t.prototype.tween=function(){var t=this.element,e=this.graph.x_range,i=this.graph.y_range,n=this.point_a.pos.x,r=this.point_a.pos.y,o=this.point_b.pos.x,s=this.point_b.pos.y,a=e.domain()[0],h=e.domain()[1],l=i.domain()[0],d=i.domain()[1],u=this;return function(u){var c=at(n,r,o,s,a,h,l,d);t.attr({x1:e(c[0].x),y1:i(c[0].y),x2:e(c[1].x),y2:i(c[1].y)})}};return t}();function at(t,e,i,n,r,o,s,a){var h={x:t,y:e},l={x:i,y:n},d=[h,l],u=h.y<l.y?[s,a]:[a,s],c=h.x<l.x?[r,o]:[o,r];if(h.x-l.x===0){return[{x:h.x,y:u[0]},{x:l.x,y:u[1]}]}else{var p=[],f=(h.y-l.y)/(h.x-l.x);d.forEach(function(t,e){var i=u[e],n=t.x-(t.y-i)/f;if(n<r||n>o){n=c[e];i=t.y-f*(t.x-n)}p.push({x:n,y:i})});return p}}function ht(t,e,i,n,r,o){var s=i-t,a=n-e;return Math.abs(a*r-s*o+i*e-n*t)/Math.sqrt(a*a+s*s)}gmath.ui=gmath.ui||{};gmath.ui.PSLine=function(){var t=function(t,e){var e=e||{};this.events=d3.dispatch("slope","point","release","remove");this.container=d3.select(t);this.graph=e.graph;this.element=null;this.lock_element=null;this.id=gmath.uid();this.point=e.point;this.slope=e.slope||0;this.slope0=this.slope;this.color=e.color||"steelblue";this.width=e.width||2;this.type="point-slope";this.link_handle=null;this.link=null;this.dragging=false;this.init()};t.prototype.toJSON=function(){return{id:this.id,type:"PSLine",graph:this.graph.id,point:this.point,slope:this.slope,color:this.color,width:this.width}};t.prototype.summarize=function(){return{type:"point-slope",id:this.id,point:gmath.deepCopy(this.point.pos),slope:this.slope}};t.prototype.setLocked=function(t){this.point.setLocked(t);if(this.locked!==t){this.locked=t;this.lock_element.style("opacity",t?.3:0)}};t.analyzeStructure=function(t){var e={val_px:null,node_px:null,val_py:null,node_py:null,val_m:null,node_m:null,node_x:null,node_y:null};if(!t.children[0].is_group("equals"))return false;var i=t.children[0].children[0],n=t.children[0].children[2];if(!i.is_group("sum")||i.children.length>2)return false;var r=i.children[0],o=i.children[1];if(!(h.is_var(r.children[1])&&h.get_value(r.children[1],true)==="y"&&s.is_num(o.children[1])))return false;e.node_y=r;e.node_py=o;e.val_py=s.get_value(o);if(!n.is_group("product","fraction")||n.children.length>2)return false;r=n.children[0];o=n.children[1];if(!(s.is_num(r.children[1])&&o.children[1].is_group("brackets")))return false;e.node_m=r.children[1];e.val_m=s.get_value(r.children[1]);o=o.children[1];if(!o.children[1].is_group("sum")||o.children[1].children.length>2)return false;r=o.children[1].children[0];o=o.children[1].children[1];if(!(h.is_var(r.children[1])&&h.get_value(r.children[1],true)==="x"&&s.is_num(o.children[1])))return false;e.node_x=r;e.node_px=o;e.val_px=s.get_value(o);return e};t.prototype.linkToDL=function(e,i,n,r){var o=this,s=e.model,a=i,h=n,l=r,d=e.view;e.setHandleColor(this.color);var u=function(t,e){if(!t)return;if(t.selected!==e){t.selected=e;d.renderer.set_style([t]);d.update_existing("normal",true)}};var c=function(t,e){return function(){return u(t,e)}};var p=gmath.uid();var f=function(e){if(e.old_model!==s)throw"wrong old_model";if(e.new_model!==e.old_model){s.events.on("change."+p,null);s.events.on("end-of-interaction."+p,null);s=e.new_model;s.events.on("change."+p,f);s.events.on("end-of-interaction."+p,g)}var i=t.analyzeStructure(s);if(!i)return;if(a!==i.node_m){u(a,false);a=i.node_m}if(h!==i.node_px){u(h,false);h=i.node_px}if(l!==i.node_py){u(l,false);l=i.node_py}var n=i.val_m,r=i.val_px*-1,d=i.val_py*-1;if(n!==o.slope)o.setSlope(n);if(r!==o.point.pos.x)o.setPoint({x:r,y:o.point.pos.y});if(d!==o.point.pos.y)o.setPoint({x:o.point.pos.x,y:d})};var g=function(){o.release();o.point.release()};var v=e.dl;s.events.on("change."+p,f);s.events.on("end-of-interaction."+p,g);o.events.on("slope."+p,function(t){if(t!==s.numeric_value(a)){v.setActiveDLComponent("AV");s.numeric_value(a,t);u(a,true)}}).on("release."+p,function(){u(a,false);v.setActiveDLComponent("none");e.view.update_all();e.updateDimensionAfterInteraction(true)});o.point.events.on("x."+p,function(t){if(t!==s.numeric_value(h)){v.setActiveDLComponent("AV");s.numeric_value(h,t*-1);u(h,true)}}).on("release."+p,function(){u(h,false);u(l,false);v.setActiveDLComponent("none");e.view.update_all();e.updateDimensionAfterInteraction(true)});o.point.events.on("y."+p,function(t){if(t!==s.numeric_value(l)){v.setActiveDLComponent("AV");s.numeric_value(l,t*-1);u(l,true)}}).on("release."+p,function(){u(l,false);u(h,false);v.setActiveDLComponent("none");e.view.update_all();e.updateDimensionAfterInteraction(true)})};t.createGeomFromDL=function(e,i){var n=t.analyzeStructure(e.model);if(!n)return false;var r=n.node_m,o=n.node_px,s=n.node_py,a=n.val_m,h=n.val_px*-1,l=n.val_py*-1,d={graph:i,pos:{x:h,y:l},color:i.colors(i.geoms.length)},u=new gmath.ui.Point(i.geom_g.node(),d);i.geoms.push(u);d={graph:i,point:u,slope:a,color:u.color};var c=new gmath.ui.PSLine(i.geom_g.node(),d);i.geoms.push(c);c.linkToDL(e,r,o,s);gmath.LinkCoordinator.addLink({source:e.model,target:c,bidirectional:true});c.graph.listenToGeom(c);return true};t.createGeomPreviewFromDL=function(e,i){var n=t.analyzeStructure(e.model);if(!n)return false;var r=n.node_m,o=n.node_px,s=n.node_py,a=n.val_m,h=n.val_px*-1,l=n.val_py*-1,d=function(t){var e={graph:i,point:t,slope:a,color:"silver"};return new gmath.ui.PSLine(i.geom_g.node(),e)};return dt(h,l,false,d,i)};t.prototype.createDLFromGeom=function(t){var e=this.slope,i=this.point.pos.x,n=this.point.pos.y,r=i<=0?"+"+i*-1+"":"-"+i+"",o=n<=0?"+"+n*-1+"":"-"+n+"",s={eq:"y"+o+"="+e+"*(x"+r+")",pos:{x:t[0],y:t[1]},interaction_mode:"inspect"},a=this.graph.view.createDL(s,function(t){var e=t.options.pos,i=t.getLastRow().getHandlePos(),n={x:e.x-i[0],y:e.y-i[1]};t.translateElement(n)}),h=a.getLastModel(),l=[0,2,0,1],d=[0,2,1,1,1,1,1],u=[0,0,1,1],c=h.get_child(l),p=h.get_child(d),f=h.get_child(u);this.linkToDL(a.rows[0],c,p,f);gmath.LinkCoordinator.addLink({source:this,target:a.getLastModel(),bidirectional:true})};t.prototype.init=function(){this.element=this.container.insert("line","#"+this.point.id).attr("id",this.id).classed("PSLine",true).style("fill","none").style("stroke",this.color).style("stroke-width",this.width).style("stroke-linecap","round");this.lock_element=this.container.insert("line","#"+this.id).style("fill","none").style("stroke","black").style("opacity",this.locked?.3:0).style("stroke-width",3*this.width).style("stroke-linecap","round");this.link_handle=d3.select(this.container.node().parentNode).append("circle").attr("id",this.id+"_handle").attr("r",10).attr("fill","white").style("stroke",this.color).style("stroke-width",this.width).style("visibility","hidden");var t=mtouch_events().frame(this.container.node().parentNode).on("touch",this.startLinking.bind(this,null)).on("drag",this.linking.bind(this,null)).on("release",this.endLinking.bind(this,null));this.link_handle.call(t);this.point.line=this;this.update()};t.prototype.setPoint=function(t,e){this.point.setPos(t);this.update(e);this.events.point(t);return this};t.prototype.setSlope=function(t,e){this.slope=t;this.update(e);this.events.slope(t);return this};t.prototype.select=function(t,e){if(e)this.point.select(t);this.element.style("stroke",t?d3.rgb(this.color).brighter():this.color)};t.prototype.drag=function(t,e){if(!this.dragging){this.dragging=true;this.updateLinkHandle()}var i=t-this.graph.x_range(this.point.pos.x),n=-e- -this.graph.y_range(this.point.pos.y);if(i!==0)this.setSlope(n/i)};t.prototype.release=function(){this.dragging=false;this.updateLinkHandle();this.events.release()};t.prototype.distanceTo=function(t,e){var i=this.graph.x_range(this.point.pos.x),n=-this.graph.y_range(this.point.pos.y),r=this.graph.x_range(this.point.pos.x)+1,o=-this.graph.y_range(this.point.pos.y)+this.slope;return ht(i,n,r,o,t,-e)};t.prototype.remove=function(){this.element.remove();this.lock_element.remove();gmath.LinkCoordinator.unlinkElement(this);if(this.point.line.id===this.id)this.point.line=null;return this.id};t.prototype.removeGroup=function(){if(d3.event)this.events.remove(new gmath.ui.Graph.GraphElementRemoveEvent(this,this.graph.id));this.point.remove();this.element.remove();this.lock_element.remove();this.link_handle.remove();return[this.point.id,this.id]};t.prototype.update=function(t){if(t)this.element.transition().tween("line",this.tween.bind(this,null));else this.element.transition().duration(0).tween("line",this.tween.bind(this,null));return this};t.prototype.updateLinkHandle=function(){var t=this.graph.x_range,e=this.graph.y_range,i=this.element.attr("x2")*1,n=this.element.attr("y2")*1,r=i>=t.range()[0]&&i<=t.range()[1]&&n<=e.range()[0]&&n>=e.range()[1],o=r&&(this.graph.mouse_in_move&&!this.graph.mouse_in_evts&&!this.dragging||this.link);if(i===t.range()[1]){this.link_handle.attr({cx:i+17.5,cy:n})}else if(n>0){this.link_handle.attr({cx:i,cy:n+17.5})}else{this.link_handle.attr({cx:i,cy:n-17.5})}this.link_handle.style("visibility",o?"visible":"hidden")};t.prototype.tween=function(t){var e=t||this.element,i=this.lock_element,n=this.slope0,r=this.slope,o=this.graph.x_range,s=this.graph.y_range,a=this.point.pos.x,h=this.point.pos.y,l=o.domain()[0],d=o.domain()[1],u=s.domain()[0],c=s.domain()[1],p=this;return function(t){var f=n+t*(r-n),g=at(a,h,a+1,h+f,l,d,u,c);e.attr({x1:o(g[0].x),y1:s(g[0].y),x2:o(g[1].x),y2:s(g[1].y)});i.attr({x1:o(g[0].x),y1:s(g[0].y),x2:o(g[1].x),y2:s(g[1].y)});p.slope0=f}};return t}();st.call(gmath.ui.PSLine);function at(t,e,i,n,r,o,s,a){var h={x:t,y:e},l={x:i,y:n},d=[h,l],u=h.y<l.y?[s,a]:[a,s],c=h.x<l.x?[r,o]:[o,r];if(h.x-l.x===0){return[{x:h.x,y:u[0]},{x:l.x,y:u[1]}]}else{var p=[],f=(h.y-l.y)/(h.x-l.x);d.forEach(function(t,e){var i=u[e],n=t.x-(t.y-i)/f;if(n<r||n>o){n=c[e];i=t.y-f*(t.x-n)}p.push({x:n,y:i})});return p}}function ht(t,e,i,n,r,o){var s=i-t,a=n-e;return Math.abs(a*r-s*o+i*e-n*t)/Math.sqrt(a*a+s*s)}gmath.ui=gmath.ui||{};gmath.ui.ARLine=function(){var t=function(t,e){var e=e||{};this.container=d3.select(t);this.graph=e.graph;this.element=null;this.id=gmath.uid();this.color=e.color||this.graph.colors(this.graph.geoms.length);this.width=e.width||2;this.type="arbitrary";this.expression=e.expression;this.init()};t.validSourceDL=function(t){var e=t.model.children[0];if(!e.is_group("equals"))return false;var i=e.children[0],n=e.children[2];if(!i.is_group("var"))return false;var r=i.value,o=null;return n.filter(function(t){return t.is_group("var")}).every(function(t){if(!o)o=t.value;return t.value===o&&t.value!==r})};t.prototype.linkToDL=function(t){var e=this,i=t.model,n=gmath.uid();i.events.on("change."+n,function(){e.expression=i.children[0].children[2];e.update()})};t.createGeomFromDL=function(e,i){if(!t.validSourceDL(e))return false;var n={graph:i,expression:e.model.children[0].children[2]},r=new gmath.ui.ARLine(i.geom_g.node(),n);i.geoms.push(r);r.linkToDL(e);return true};t.createGeomPreviewFromDL=function(e,i){if(!t.validSourceDL(e))return false;var n={graph:i,expression:e.model.children[0].children[2],color:"silver"},r=new gmath.ui.ARLine(i.geom_g.node(),n);return function(){if(r)r.remove()}};t.prototype.init=function(){this.element=this.container.append("g","#"+this.id).attr("id",this.id).classed("ARLine",true);this.update()};t.prototype.update=function(){var t=this;function e(e,i,n){var r=(Math.abs(e)+Math.abs(i))/n;for(var o=e;o<i;o+=r){var s=o,a=o+r,h=lt(t.expression,null,s),l=lt(t.expression,null,a);t.element.append("line").attr({x1:t.graph.x_range(s),x2:t.graph.x_range(a),y1:t.graph.y_range(h),y2:t.graph.y_range(l)}).style("stroke",t.color).style("stroke-width",t.width).style("stroke-linecap","round")}}this.element.selectAll("line").remove();var i=this.graph.x_range.domain(),n=this.graph.x_range.range();e(i[0],i[1],n[1]-n[0]+1)};t.prototype.updateLinkHandle=function(){};t.prototype.distanceTo=function(){};t.prototype.remove=function(){this.element.remove()};return t}();function lt(t,e,i){fn=function(t){if(!t)return NaN;if(s.is_num(t))return s.get_value(t);if(t.is_group("var")&&(!e||t.value===e))return i;if(t.is_group("mul","add","brackets"))return fn(t.children[1]);if(t.is_group("sign","sub"))return-fn(t.children[1]);if(t.is_group("div"))return 1/fn(t.children[1]);if(t.is_group("exponent"))return fn(t.children[0]);if(t.value==="//")return 1;var n=function(t,e){return t+e},r=function(t,e){return t*e};if(t.is_group("product","fraction"))return t.children.map(fn).reduce(r,1);if(t.is_group("trig"))return t.evaluate(fn(t.get_arg()));if(t.is_group("sum"))return t.children.map(fn).reduce(n,0);if(t.is_group("power"))return Math.pow(fn(t.children[0]),fn(t.children[1]));return NaN};return fn(t)}gmath.ui=gmath.ui||{};gmath.ui.Link=function(){var t=function(){var t=d3.dispatch(),e=null,i=null,n=null,r=null,o=null,s=null,a=null;var h=function(t,n){e=d3.select(t);i=n;l();return this};h.container=function(t){if(arguments.length===0)return e;e=t;return this};h.model=function(t){if(arguments.length===0)return i;i=t;return this};h.a=function(t){if(arguments.length===0)return n;n=t;return this};h.b=function(t){if(arguments.length===0)return o;o=t;return this};h.update_el=function(){if(!n||!o)return;var t=d(n),e=d(o);t[0]+=n.width/2;t[1]-=n.y;e[0]+=o.width/2;e[1]-=o.y;a.attr("d",function(){var i=Math.random()>.5?1:-1;return"M "+t[0]+" "+t[1]+" "+"Q "+(t[0]+e[0])/2+" "+((t[1]+e[1])/2+Math.random()*300*i)+" "+e[0]+" "+e[1]})};h.show=function(t){a.style("visibility",t?"visible":"hidden")};h.link=function(){var t=n.get_root(),e=o.get_root(),i=gmath.uid(),r=gmath.uid();t.events.on("node-changed."+i,function(i){if(h.a().id===i.node.id){n=i.new_node;e.numeric_value(h.b(),t.numeric_value(h.a()))}});e.events.on("node-changed."+r,function(i){if(h.b().id===i.node.id){o=i.new_node;t.numeric_value(h.a(),e.numeric_value(h.b()))}})};h.unlink=function(){n.get_root().events.on("node-changed."+r,function(){return});o.get_root().events.on("node-changed."+s,function(){return})};var l=function(){a=e.append("path").attr("stroke","orange").attr("stroke-width","4px").attr("stroke-linecap","round").attr("fill","none").style("opacity",.5)};var d=function(t){var e=[0,0];if(t.children.length>0){t.children.forEach(function(t){var i=d(t);e[0]+=i[0];e[1]+=i[1]});e[0]=e[0]/t.children.length;e[1]=e[1]/t.children.length}else{var i=d3.select("#"+t.id);while(i.node().tagName!=="svg"){var n=d3.transform(i.attr("transform"));e[0]+=n.translate[0];e[1]+=n.translate[1];i=d3.select(i.node().parentNode)}}return e};return d3.rebind(h,t,"on")};return t}();gmath.ui=gmath.ui||{};gmath.ui.Point=function(){var t=function(t,e){this.events=d3.dispatch("x","y","release","remove");this.container=d3.select(t);this.graph=e.graph;this.id=e.id||gmath.uid();this.element=null;this.pos=e.pos||{x:0,y:0};this.radius=e.radius||4;this.color=e.color||"black";this.type="point";this.intercept=e.intercept||false;this.line=null;this.snap_el=null;this.show_snap=false;this.locked=false;this.link_handle=null;this.link=null;this.dragging=false;this.init()};t.prototype.summarize=function(){return{type:"point",id:this.id,point:gmath.deepCopy(this.pos)}};t.prototype.toJSON=function(){return{id:this.id,type:"Point",graph:this.graph.id,pos:this.pos,radius:this.radius,color:this.color,intercept:this.intercept}};t.prototype.setLocked=function(t){if(this.locked!==t){this.locked=t;this.update()}};t.validSourceDL=function(t){var e=t.model.children[0];if(e.is_group("brackets")){e=e.children[1];if(e.is_group("tuple")){var i=e.children[0],n=e.children[1];if(i.is_group("param")&&n.is_group("param")){i=i.children[1];n=n.children[1];if(s.is_num(i)&&s.is_num(n)){return true}}}}return false};t.prototype.linkToDL=function(t,e,i){var n=this,r=t.model,o=e,s=i,a=t.view;t.setHandleColor(this.color);var h=function(t,e){if(t.selected!==e){t.selected=e;a.renderer.set_style([t]);a.update_existing("normal",true)}};var l=function(t,e){return function(){return h(t,e)}};var d=gmath.uid();var u=function(t){if(t.old_model!==r)throw"wrong old_model";if(t.new_model!==t.old_model){r.events.on("change."+d,null);r.events.on("end-of-interaction."+d,null);r=t.new_model;r.events.on("change."+d,u);r.events.on("end-of-interaction."+d,c)}var e=o,i=s;o=t.node_map[o.id][0];s=t.node_map[s.id][0];if(e!==o)h(e,false);if(i!==s)h(i,false);var a=0;if(n.intercept){r.numeric_value(o,0)}else{a=r.numeric_value(o)}var l=r.numeric_value(s);if(a!==n.pos.x)n.setPos({x:a,y:n.pos.y});if(l!==n.pos.y)n.setPos({x:n.pos.x,y:l})};var c=function(){n.release()};r.events.on("change."+d,u);r.events.on("end-of-interaction."+d,c);var p=t.dl;n.events.on("x."+d,function(t){if(t!==r.numeric_value(o)){r.numeric_value(o,t);h(o,true);p.setActiveDLComponent("AV")}}).on("y."+d,function(t){if(t!==r.numeric_value(s)){r.numeric_value(s,t);h(s,true);p.setActiveDLComponent("AV")}}).on("release."+d,function(){h(o,false);h(s,false);p.setActiveDLComponent("none");t.updateDimensionAfterInteraction(true)})};t.createGeomFromDL=function(e,i){if(!t.validSourceDL(e))return false;var n=e.model,r=[0,1,0,1],o=[0,1,1,1],s=n.get_child(r),a=n.get_child(o),h=n.numeric_value(s),l=n.numeric_value(a),d={graph:i,pos:{x:h,y:l},color:i.colors(i.geoms.length),intercept:h===0?true:false},u=new gmath.ui.Point(i.geom_g.node(),d);u.graph.listenToGeom(u);i.geoms.push(u);u.linkToDL(e,s,a);gmath.LinkCoordinator.addLink({source:e.model,target:u,bidirectional:true});return true};t.createGeomPreviewFromDL=function(e,i){if(!t.validSourceDL(e))return false;var n=e.model,r=[0,1,0,1],o=[0,1,1,1],s=n.get_child(r),a=n.get_child(o),h=n.numeric_value(s),l=n.numeric_value(a);return dt(h,l,l===0,null,i)};t.prototype.createDLFromGeom=function(t){if(this.line){this.line.createDLFromGeom(t)}else{var e=this.pos.x,i=this.pos.y,n={eq:"("+e+","+i+")",pos:{x:t[0],y:t[1]},interaction_mode:"inspect"},r=this.graph.view.createDL(n,function(t){var e=t.options.pos,i=t.getLastRow().getHandlePos(),n={x:e.x-i[0],y:e.y-i[1]};t.translateElement(n)}),o=r.getLastModel(),s=[0,1,0,1],a=[0,1,1,1],h=o.get_child(s),l=o.get_child(a);this.linkToDL(r.rows[0],h,l);gmath.LinkCoordinator.addLink({target:r.getLastModel(),source:this,bidirectional:true})}};t.prototype.init=function(){this.snap_el=this.container.append("circle").style("opacity",0);this.element=this.container.append("circle").attr("id",this.id);this.link_handle=d3.select(this.container.node().parentNode).append("circle").attr("id",this.id+"_handle").attr("r",10).attr("fill","white").style("stroke",this.color).style("stroke-width",2).style("visibility","hidden");var t=mtouch_events().frame(this.container.node().parentNode).on("touch",this.startLinking.bind(this,null)).on("drag",this.linking.bind(this,null)).on("release",this.endLinking.bind(this,null));this.link_handle.call(t);this.update()};t.prototype.setPos=function(t){if(t.x!==this.pos.x&&!this.intercept)this.events.x(t.x);if(t.y!==this.pos.y)this.events.y(t.y);this.pos=t;this.update();return this};t.prototype.setRadius=function(t){this.radius=t;this.update();return this};t.prototype.setColor=function(t){this.color=t;this.update();return this};t.prototype.select=function(t,e){if(this.intercept){this.element.style("stroke",t?d3.rgb(this.color).brighter():this.color)}else this.element.style("fill",t?d3.rgb(this.color).brighter():this.color);if(this.line&&e)this.line.select(t)};t.prototype.showSnap=function(t){if(t!==this.show_snap){this.show_snap=t;this.update()}};t.prototype.drag=function(t,e){if(!this.dragging){this.dragging=true;this.updateLinkHandle()}var i=this.intercept?0:this.graph.x_range.invert(this.graph.x_range(this.pos.x)+t),n=this.graph.y_range.invert(this.graph.y_range(this.pos.y)+e);this.setPos({x:i,y:n})};t.prototype.release=function(){this.dragging=false;this.updateLinkHandle();this.events.release()};t.prototype.distanceTo=function(t,e){var i=t-this.graph.x_range(this.pos.x),n=e-this.graph.y_range(this.pos.y),r=Math.sqrt(i*i+n*n);return Math.max(0,r-this.radius)};t.prototype.remove=function(){gmath.LinkCoordinator.unlinkElement(this);this.element.remove();return this.id};t.prototype.removeGroup=function(){if(this.line)return this.line.removeGroup();if(d3.event)this.events.remove(new gmath.ui.Graph.GraphElementRemoveEvent(this,this.graph.id));this.element.remove();return[this.id]};t.prototype.update=function(){this.snap_el.attr("cx",this.graph.x_range(this.pos.x)).attr("cy",this.graph.y_range(this.pos.y)).attr("r",this.radius*2).style("fill",this.color).style("opacity",this.show_snap?.3:0);this.element.attr("cx",this.graph.x_range(this.pos.x)).attr("cy",this.graph.y_range(this.pos.y)).attr("r",this.radius).style("fill",this.locked?"#bbb":this.intercept?"white":this.color).style("stroke",this.intercept||this.locked?this.color:"none");if(this.line)this.line.update();return this};t.prototype.updateLinkHandle=function(){var t=this.graph.x_range,e=this.graph.y_range,i=this.element.attr("cx")*1,n=this.element.attr("cy")*1,r=i>=t.range()[0]&&i<=t.range()[1]&&n<=e.range()[0]&&n>=e.range()[1],o=!this.line&&r&&(this.graph.mouse_in_move&&!this.graph.mouse_in_evts&&!this.dragging||this.link);this.link_handle.attr({cx:t.range()[1]+17.5,cy:n});this.link_handle.style("visibility",o?"visible":"hidden")};return t}();st.call(gmath.ui.Point);function dt(t,e,i,n,r){var o=r.x_range.domain(),s=r.y_range.domain(),a={graph:r,pos:{x:t,y:e},color:"silver",intercept:i};if(t<=o[0]||t>=o[1]||e<=s[0]||e>=s[1]){var h=r.zoom.translate();r.zoom.translate([0,0]);r.zoomBehavior({translate:[0,0]});var l=r.x_range(t),d=r.y_range(e),u=-h[0],c=-h[1],p=40,f=(l-u)/p,g=(d-c)/p,v=0,_=null,m=null;r.zoom.translate(h);r.zoomBehavior({translate:h});interval=setInterval(function(){u+=f;c+=g;r.zoom.translate([-u,-c]);r.zoomBehavior({translate:[-u,-c]});v+=1;if(v===p){clearInterval(interval);interval=null;_=new gmath.ui.Point(r.geom_g.node(),a);if(n){m=n(_)}}},1);return function(t){if(interval){clearInterval(interval);interval=null;r.zoom.translate([0,0]);r.zoomBehavior({translate:[0,0]});r.zoom.translate([-l,-d]);r.zoomBehavior({translate:[-l,-d]})}if(_)_.remove();if(m)m.remove();if(t){r.zoom.translate([0,0]);r.zoomBehavior({translate:[0,0]});r.zoom.translate(h);r.zoomBehavior({translate:h})}}}else{_=new gmath.ui.Point(r.geom_g.node(),a);if(n){m=n(_)}return function(){if(_)_.remove();if(m)m.remove()}}}gmath.ui=gmath.ui||{};gmath.ui.CanvasParser=function(){CanvasParser={};CanvasParser.parse=function(t,e){return JSON.parse(e,function(e,i){if(i&&i.type==="Graph")return CanvasParser.parseGraph(t,i);if(i&&i.type==="DerivationList")return CanvasParser.parseDL(t,i);else return i})};CanvasParser.parseDL=function(t,e){return t.model.createDL(e)};CanvasParser.parseGraph=function(t,e){var i=e.geoms;e.geoms=null;var n=t.model.createGraph(e);i.forEach(function(t){if(t.type==="Point")CanvasParser.parsePoint(n,t);else if(t.type==="SILine")CanvasParser.parseSILine(n,t)})};CanvasParser.parsePoint=function(t,e){e.graph=t;return t.addGeom(e.type,e)};CanvasParser.parseSILine=function(t,e){var i=CanvasParser.parsePoint(t,e.intercept);e.point=i;e.graph=t;var n=t.addGeom(e.type,e);i.line=n;return n};return CanvasParser}();TrialLogger=function(){this.trial=null;this.events=d3.dispatch("start_trial","end_trial");this.experiment_id=null};gmath.TrialLogger=new TrialLogger;TrialLogger.prototype.startTrial=function(t,e){if(this.trial)this.endTrial();var i={id:gmath.uid(),idx:t||0,gm_version:gmath.version,gm_ui_version:gmath.ui.version,gm_ui_gm_version:gmath.ui.gm_version,experiment_id:this.experiment_id,time:Date.now()};gmath.extend(i,e);this.trial=i;this.events.start_trial(i)};TrialLogger.prototype.setCustomFields=function(t){gmath.extend(this.trial,t)};TrialLogger.prototype.endTrial=function(){this.events.end_trial(trial);this.postTrial(this.trial);this.trial=null};TrialLogger.prototype.postTrial=function(){if(gmath.ServerComm)gmath.ServerComm.postTrial(this.trial)};ServerComm=function(){this.posting=false;this.trial_collection=null;this.data_collection=null;this.server_url="https://dlandy.psych.indiana.edu:7010"};gmath.ServerComm=new ServerComm;gmath.setupLogging=function(t){if(!t)t={};gmath.ServerComm.setExperimentID(t.experiment_id);gmath.ServerComm.setEnabled("enabled"in t?t.enabled:"auto");if(t.server)gmath.ServerComm.setServerUrl(t.server)};ServerComm.prototype.setExperimentID=function(t){if(typeof t!=="string")throw"Invalid experiment ID.";if(!t.match(/^\w+$/))throw"Invalid experiment ID.";this.trial_collection=t+"_trials";this.data_collection=t+"_data";gmath.TrialLogger.experiment_id=t};ServerComm.prototype.setServerUrl=function(t){this.server_url=t};ServerComm.prototype.setEnabled=function(t){if(!t)this.posting=false;else if(t==="auto")this.posting=gmath.log_ga?gmath.log_ga.enabled():true;else this.posting=true;console.info("interaction logging is",this.posting?"on":"off")};ServerComm.prototype.postTrial=function(t){if(!this.posting)return;this.postToServer(this.trial_collection,t)};ServerComm.prototype.postInteractions=function(t){if(!this.posting)return;this.postToServer(this.data_collection,t)};ServerComm.prototype.postToServer=function(t,e){if(!this.posting)return;var i=JSON.stringify(e);if(this.dataIsTooBig(i)){console.warn("Data chunk size is too big: not saved.");return}var n=new XMLHttpRequest;n.open("POST",this.server_url+"/log/"+t);n.setRequestHeader("Content-Type","application/json");n.send(i)};ServerComm.prototype.dataIsTooBig=function(t){var e=gmath.byteLength(t);return e>5e4};DataLogger=function(t,e){this.id=gmath.uid();this.events=d3.dispatch("interaction");
this.listening=true;this.log_mouse_trajectories=e;this.trial_id=null;this.canvas_logger=new CanvasLogger(this,t);gmath.TrialLogger.events.on("start_trial."+this.id,this.setTrialInfo.bind(this));if(gmath.TrialLogger.trial)this.setTrialInfo(gmath.TrialLogger.trial)};gmath.DataLogger=DataLogger;DataLogger.console_logs=false;DataLogger.interaction_id=1;DataLogger.prototype.setTrialInfo=function(t){if(t.id!==this.trial_id)DataLogger.interaction_id=1;this.trial_id=t.id};DataLogger.prototype.listen=function(t){this.listening=!!t};DataLogger.prototype.logInteractionWithEvents=function(t,e,i){t.trial_id=this.trial_id;t.interaction_id=DataLogger.interaction_id;e.forEach(function(t,e){t.trial_id=this.trial_id;t.interaction_id=DataLogger.interaction_id;t.within_interaction_id=e+1},this);if(i)e=i(e);if(DataLogger.console_logs)console.log(t,e);if(this.listening){this.emitReleventSummaryEvents([t]);gmath.ServerComm.postInteractions([t].concat(e))}DataLogger.interaction_id++};DataLogger.prototype.logInteraction=function(t){t.trial_id=this.trial_id;t.interaction_id=DataLogger.interaction_id++;if(DataLogger.console_logs)console.log(t);if(this.listening){this.emitReleventSummaryEvents([t]);gmath.ServerComm.postInteractions([t])}};DataLogger.prototype.logCustomInteraction=function(t,e){var i={trial_id:this.trial_id,interaction_id:DataLogger.interaction_id++,type:"custom",subtype:t,time:Date.now()};gmath.extend(i,e);gmath.ServerComm.postInteractions([i])};DataLogger.prototype.emitReleventSummaryEvents=function(t){var e=t.filter(function(t){return t.type==="interaction"});if(e.length>0){this.events.interaction(e)}};DataLogger.prototype.simulateStartOfInteraction=function(t,e){var i={type:"start-of-interaction",source:t,time:Date.now()};if(e)i=gmath.extend(i,e);this.canvas_logger.startOfInteractionDetected(i)};DataLogger.prototype.simulateEndOfInteraction=function(t,e){var i={type:"end-of-interaction",source:t,time:Date.now()};if(e)i=gmath.extend(i,e);this.canvas_logger.endOfInteractionDetected(i)};CanvasLogger=function(t,e){this.data_logger=t;this.interactionSequence=[];this.dlLoggers=[];this.setupListeners(e)};CanvasLogger.prototype.startOfInteractionDetected=function(t){if(!this.data_logger.listening)return;if(t.source&&t.source.options&&t.source.options.dont_log_events)return;if(this.containsPendingEvents(this.interactionSequence)){this.submitCurrentSequence()}this.addEvent(t)};CanvasLogger.prototype.endOfInteractionDetected=function(t){if(!this.data_logger.listening)return;if(t.source&&t.source.options&&t.source.options.dont_log_events)return;this.addEvent(t);if(this.interactionSequence[0].source&&this.interactionSequence[0].source.type!==this.interactionSequence[this.interactionSequence.length-1].source.type)return;this.submitCurrentSequence()};CanvasLogger.prototype.addEvent=function(t){if(!this.data_logger.listening)return;if(t.source&&t.source.options&&t.source.options.dont_log_events)return;t.time=Date.now();t.date=(new Date).toString();if(t.source&&t.source.model&&t.source.model.to_ascii)t.source.model=t.source.model.to_ascii();this.interactionSequence.push(t)};CanvasLogger.prototype.submitCurrentSequence=function(){var t=this.summarizeInteractionSequence(this.interactionSequence);t.forEach(function(t){this.data_logger.logInteraction(t)},this);this.interactionSequence=[]};CanvasLogger.prototype.summarizeInteractionSequence=function(t){try{if(this.isNullSequence(t))return[];if(this.isMoveSequence(t))return this.summarizeMoveSequence(t);if(this.isResizeSequence(t))return this.summarizeResizeSequence(t);if(this.isCreateSequence(t))return this.summarizeCreateSequence(t);if(this.isGeometryCreateSequence(t))return this.summarizeGeometryCreateSequence(t);if(this.isDeleteSequence(t))return this.summarizeDeleteSequence(t);if(this.isGeometryDeleteSequence(t))return this.summarizeGeometryDeleteSequence(t);if(this.isDrawSequence(t))return this.summarizeDrawSequence(t);if(this.isEraseSequence(t))return this.summarizeEraseSequence(t);if(this.isNodeInspectSequence(t))return this.summarizeNodeInspectSequence(t);if(this.isGraphScrubSequence(t))return this.summarizeGraphScrubSequence(t);if(this.isPackSequence(t))return this.summarizePackSequence(t);if(this.isLinkSequence(t))return this.summarizeLinkSequence(t);if(this.isCloneSequence(t))return this.summarizeCloneSequence(t);if(this.isGraphPanSequence(t))return this.summarizeGraphPanSequence(t);if(this.isButtonSequence(t))return this.summarizeButtonSequence(t);if(this.isGraphZoomSequence(t))return this.summarizeGraphZoomSequence(t);if(this.isFontSizeSequence(t))return this.summarizeFontSizeSequence(t);if(this.isTextEditSequence(t))return this.summarizeTextEditSequence(t);console.warn("(CanvasLogger) Interaction did not match any defined interaction types.");this.interactionSequence=[];return[]}catch(e){console.warn("(CanvasLogger) Error when summarizing interaction sequence:",e);this.interactionSequence=[];return[]}};CanvasLogger.prototype.containsPendingEvents=function(t){return t.length?true:false};CanvasLogger.prototype.isDifferentInteraction=function(t,e){if(!t.length)return false;var i=false;if(e.element.id){i=i||t.some(function(t){if(!t.element||!t.element.id)return true;return t.element.id!==e.element.id})}if(e.type){i=i||t.some(function(t){if(!t.type)return true;return t.type!==e.type})}return i};CanvasLogger.prototype.setupListeners=function(t){this.registerToolbarListeners(t,this.canvasToolbarListener.bind(this));this.registerCanvasModelViewListeners(t.model,this.canvasModelViewListener.bind(this));this.registerCanvasControllerListeners(t.controller,this.canvasControllerListener.bind(this))};CanvasLogger.prototype.registerToolbarListeners=function(t,e){t.events.on("button."+this.session_id,e)};CanvasLogger.prototype.canvasToolbarListener=function(t){if(this.containsPendingEvents(this.interactionSequence)){this.submitCurrentSequence()}t.type="toolbar_button_press";this.addEvent(t);this.submitCurrentSequence()};CanvasLogger.prototype.registerCanvasModelViewListeners=function(t,e){var i=this;t.on("create."+this.session_id,e).on("remove."+this.session_id,e);var n=t.dls();n.forEach(function(t){i.setupListenersOnDL(t)});var r=t.graphs();r.forEach(function(t){i.setupListenersOnGraph(t)})};CanvasLogger.prototype.canvasModelViewListener=function(t){if(t.type==="create")this.objectCreationDetected(t);if(t.type==="remove")this.objectDeletionDetected(t)};CanvasLogger.prototype.registerCanvasControllerListeners=function(t,e){t.on("start-of-interaction."+this.session_id,e).on("end-of-interaction."+this.session_id,e)};CanvasLogger.prototype.canvasControllerListener=function(t){if(t.length)t=t[0];if(t.type==="start-of-interaction")this.startOfInteractionDetected(t);if(t.type==="end-of-interaction")this.endOfInteractionDetected(t)};CanvasLogger.prototype.objectCreationDetected=function(t){if(t.target&&t.target.options&&t.target.options.dont_log_events)return;if(t.target_type==="link")return;if(t.target_type==="derivation")this.setupListenersOnDL(t.target);if(t.target_type==="graph")this.setupListenersOnGraph(t.target);if(t.target_type==="textbox")this.setupListenersOnTextBox(t.target);var e={};e.type="GM_object_created_or_added";e.method=t.method;e.element={type:t.target_type,id:t.target.id};if(t.target_type==="derivation")e.element.new_state=t.target.options.eq;if(t.target_type==="textbox"&&t.target.text!==t.target.options.default_text)e.element.new_state=t.target.text;if(t.target_type==="image"&&t.target.options.url)e.element.new_state=t.target.options.url;this.addEvent(e);if(this.interactionSequence.length===1){this.submitCurrentSequence()}};CanvasLogger.prototype.objectDeletionDetected=function(t){if(t.target&&t.target.options&&t.target.options.dont_log_events)return;var e={};e.type="GM_object_removed";e.element={type:t.target_type,id:t.target.id,options:t.target.options?gmath.deepCopy(t.target.options):null};this.addEvent(e);if(this.interactionSequence.length===1){this.interactionSequence=[]}};CanvasLogger.prototype.setupListenersOnDL=function(t){this.registerListenersOnEvents(t.events,this.DLListener.bind(this));this.dlLoggers.push(new DLLogger(this.data_logger,t))};CanvasLogger.prototype.registerListenersOnEvents=function(t,e){t.on("inspect_node."+this.session_id,e).on("pack_state."+this.session_id,e)};CanvasLogger.prototype.DLListener=function(t){if(t.length)t=t[0];if(t.type==="inspect")this.nodeInspectionDetected(t);if(t.type==="packState")this.packStateDetected(t)};CanvasLogger.prototype.nodeInspectionDetected=function(t){var e={};e.type="node_inspected";e.element={type:"derivation",id:t.dl.id};e.inspection={row:t.row,model:t.dl.rows[t.row].model.to_ascii(),sel:t.node.get_root().getSelectorOfNodes([t.node]).join(";")};this.addEvent(e)};CanvasLogger.prototype.packStateDetected=function(t){var e={};e.type="derivation_list_pack_state_changed";e.element={type:"derivation",id:t.performee};e.state=t.packState;this.addEvent(e)};CanvasLogger.prototype.setupListenersOnGraph=function(t){this.registerListenersOnGraph(t,this.graphListener.bind(this))};CanvasLogger.prototype.registerListenersOnGraph=function(t,e){t.events.on("create_geom."+this.session_id,e).on("remove_geom."+this.session_id,e).on("geom_attr."+this.session_id,e).on("zoom."+this.session_id,e)};CanvasLogger.prototype.graphListener=function(t){if(t.type==="graphElementCreate"||t.type==="graphElementChange")this.graphElementDetected(t);if(t.type==="graphElementRemove")this.graphElementDeletionDetected(t);if(t.type==="zoom")this.graphPanZoomDetected(t)};CanvasLogger.prototype.graphElementDetected=function(t){var e={};e.type=t.type==="graphElementCreate"?"graph_element_created":"graph_element_changed";e.element={type:"graph",id:t.graph_id};var i=t.performee_object.summarize();delete i.id;delete i.type;e.graph_element={type:t.performee_type||t.performee_object.type,id:t.performee,attr:i};this.addEvent(e)};CanvasLogger.prototype.graphElementDeletionDetected=function(t){var e={};e.type="graph_element_removed";e.element={type:"graph",id:t.graph_id};e.graph_element={type:t.performee_type,id:t.performee,attr:t.performee_object};this.addEvent(e)};CanvasLogger.prototype.graphPanZoomDetected=function(t){var e={};e.type="graph_pan_zoom";e.element={type:"graph",id:t.performee,new_state:{pan:t.translate,zoom:t.scale}};if(this.isDifferentInteraction(this.interactionSequence,e)){this.submitCurrentSequence()}this.addEvent(e)};CanvasLogger.prototype.setupListenersOnTextBox=function(t){this.registerListenersOnTextBox(t,this.textboxListener.bind(this))};CanvasLogger.prototype.registerListenersOnTextBox=function(t,e){t.events.on("text."+this.session_id,e).on("font_size."+this.session_id,e)};CanvasLogger.prototype.textboxListener=function(t){if(t.type==="text"&&this.isDifferentInteraction(this.interactionSequence,t)||t.type==="font_size"&&this.containsPendingEvents(this.interactionSequence))this.submitCurrentSequence();this.addEvent(t);if(t.type==="font_size")this.submitCurrentSequence()};CanvasLogger.prototype.isNullSequence=function(t){if(t.every(function(t){return t.type==="start-of-interaction"&&t.source.type==="CanvasController"||t.type==="end-of-interaction"}))return true;if(t.every(function(t){return t.type==="start-of-interaction"&&t.source.type==="AlgebraModel"||t.type==="end-of-interaction"}))return true;if(t.every(function(t){return t.type==="start-of-interaction"&&t.source.type==="DerivationRow"||t.type==="end-of-interaction"}))return true;if(t.every(function(t){return t.type==="start-of-interaction"&&(t.source.type==="derivation"||t.source.type==="Graph"||t.source.type==="textbox")||t.type==="end-of-interaction"})&&(this.startAndEndPositionsAreTheSame(t)||this.startAndEndSizesAreTheSame(t)))return true;if(t.every(function(t){return t.type==="start-of-interaction"&&t.source.type==="Graph"&&t.subSource==="touch"||t.type==="end-of-interaction"}))return true;if(t.every(function(t){return t.type==="start-of-interaction"&&t.source.type==="DerivationRow"||t.type==="GM_object_created_or_added"&&t.element.type==="textbox"||t.type==="end-of-interaction"})&&t.some(function(t){return t.type==="start-of-interaction"}))return true;return false};CanvasLogger.prototype.startAndEndPositionsAreTheSame=function(t){var e=t[0],i=t[t.length-1];if(!e.pos||!i.pos)return false;var n=Array.isArray(e.pos)?e.pos:[e.pos.x,e.pos.y],r=Array.isArray(i.pos)?i.pos:[i.pos.x,i.pos.y];return n[0]===r[0]&&n[1]===r[1]};CanvasLogger.prototype.startAndEndSizesAreTheSame=function(t){var e=t[0],i=t[t.length-1];if(!e.size||!i.size)return false;return e.size.width===i.size.width&&i.size.height===i.size.height};CanvasLogger.prototype.isCreateSequence=function(t){return t.every(function(t){return t.type==="start-of-interaction"&&t.source.type==="CanvasController"||t.type==="GM_object_created_or_added"&&t.element.type!=="path"||t.type==="end-of-interaction"})};CanvasLogger.prototype.isGeometryCreateSequence=function(t){return t.every(function(t){return t.type==="start-of-interaction"&&t.source.type==="Graph"||t.type==="graph_element_created"||t.type==="graph_element_changed"||t.type==="end-of-interaction"})&&t.some(function(t){return t.type==="graph_element_created"})};CanvasLogger.prototype.isDeleteSequence=function(t){return t.every(function(t){return t.type==="start-of-interaction"||t.type==="GM_object_removed"&&t.element.type!=="path"||t.type==="node_inspected"||t.type==="end-of-interaction"})&&t.some(function(t){return t.type==="GM_object_removed"})};CanvasLogger.prototype.isGeometryDeleteSequence=function(t){return t.every(function(t){return t.type==="start-of-interaction"&&t.source.type==="Graph"||t.type==="graph_element_removed"||t.type==="graph_element_changed"||t.type==="end-of-interaction"})&&t.some(function(t){return t.type==="graph_element_removed"})};CanvasLogger.prototype.isDrawSequence=function(t){return t.every(function(t){return t.type==="start-of-interaction"&&t.source.type==="CanvasController"||t.type==="GM_object_created_or_added"&&t.element.type==="path"||t.type==="end-of-interaction"})};CanvasLogger.prototype.isEraseSequence=function(t){return t.every(function(t){return t.type==="start-of-interaction"&&t.source.type==="CanvasController"||t.type==="GM_object_created_or_added"||t.type==="GM_object_removed"&&t.element.type==="path"||t.type==="end-of-interaction"})};CanvasLogger.prototype.isNodeInspectSequence=function(t){return t.every(function(t){return t.type==="start-of-interaction"&&t.source.type==="AlgebraModel"||t.type==="node_inspected"||t.type==="end-of-interaction"})};CanvasLogger.prototype.isGraphScrubSequence=function(t){return t.every(function(t){return t.type==="start-of-interaction"&&t.source.type==="Graph"||t.type==="model_changed"&&t.change.type==="number_scrub"||t.type==="graph_element_changed"||t.type==="end-of-interaction"})};CanvasLogger.prototype.isMoveSequence=function(t){return t.every(function(t){return t.type==="start-of-interaction"&&(t.source.type==="derivation"||t.source.type==="Graph"||t.source.type==="textbox"||t.source.type==="image")&&t.pos||t.type==="end-of-interaction"})};CanvasLogger.prototype.isResizeSequence=function(t){return t.every(function(t){return t.type==="start-of-interaction"&&(t.source.type==="textbox"||t.source.type==="image")&&t.size||t.type==="end-of-interaction"})};CanvasLogger.prototype.isPackSequence=function(t){return t.every(function(t){return t.type==="start-of-interaction"||t.type==="derivation_list_pack_state_changed"||t.type==="end-of-interaction"})};CanvasLogger.prototype.isLinkSequence=function(t){return t.every(function(t){return t.type==="start-of-interaction"&&t.source.type==="Graph"||t.type==="GM_object_created_or_added"&&t.element.type==="derivation"||t.type==="end-of-interaction"})||t.every(function(t){return t.type==="start-of-interaction"&&t.source.type==="DerivationRow"||t.type==="graph_element_created"||t.type==="end-of-interaction"})};CanvasLogger.prototype.isCloneSequence=function(t){return t.every(function(t){return t.type==="start-of-interaction"&&t.source.type==="DerivationRow"||t.type==="GM_object_created_or_added"||t.type==="end-of-interaction"})};CanvasLogger.prototype.isGraphPanSequence=function(t){return t.every(function(t){return t.type==="start-of-interaction"||t.type==="graph_pan_zoom"||t.type==="end-of-interaction"})&&t.some(function(t){return t.type==="start-of-interaction"})};CanvasLogger.prototype.isButtonSequence=function(t){return t.every(function(t){return t.type==="toolbar_button_press"})||t.some(function(t){return t.type==="toolbar_button_press"&&(t.button.label==="undo"||t.button.label==="redo")})};CanvasLogger.prototype.isGraphZoomSequence=function(t){return t.every(function(t){return t.type==="graph_pan_zoom"})};CanvasLogger.prototype.isFontSizeSequence=function(t){return t.every(function(t){return t.type==="font_size"})};CanvasLogger.prototype.isTextEditSequence=function(t){return t.every(function(t){return t.type==="text"})};CanvasLogger.prototype.fillSummaryWithTime=function(t,e,i){t.time=e.time;t.dur=i.time-e.time};CanvasLogger.prototype.summarizeCreateSequence=function(t){var e=t[0],i=t[t.length-1],n=[];for(var r=1;r<t.length-1;r++){var o=t[r];var s={type:"interaction",subtype:"create",el_id:o.element.id,el_type:o.element.type,method:o.method||"holdUI"};if(o.element.new_state)s.new_state=o.element.new_state;this.fillSummaryWithTime(s,e,i);n.push(s)}return n};CanvasLogger.prototype.summarizeGeometryCreateSequence=function(t){var e={type:"interaction",subtype:"create"};var i=t[0],n=t[t.length-1];this.fillSummaryWithTime(e,i,n);var r=t.filter(function(t){return t.type==="graph_element_created"});r=r[r.length-1];var o=t.filter(function(t){return t.type==="graph_element_changed"});if(o.length)r=o[0];e.targets=[{type:"graph",id:r.element.id,subtype:r.graph_element.type,subid:r.graph_element.id,new_state:r.graph_element.attr}];if(e.targets[0].subtype==="point")e.method="hold";else e.method="hold-drag";return[e]};CanvasLogger.prototype.summarizeDeleteSequence=function(t){var e=t[0],i=t[t.length-1],n=gmath.find(t,function(t){return t.type==="GM_object_removed"});var r={type:"interaction",subtype:"delete",method:"tap",el_id:n.element.id,el_type:n.element.type};this.fillSummaryWithTime(r,e,i);return[r]};CanvasLogger.prototype.summarizeGeometryDeleteSequence=function(t){var e={type:"graph",subtype:"delete",method:"tap"};var i=t[1],n=t[t.length-1];var r=t[0];this.fillSummaryWithTime(e,r,i);delete r.graph_element.attr.id;delete r.graph_element.attr.type;e.element={type:r.element.type,id:r.element.id,subtype:r.graph_element.type,subid:r.graph_element.id,old_state:r.graph_element.attr};return[e]};CanvasLogger.prototype.summarizeDrawSequence=function(t){var e={type:"interaction",subtype:"draw",method:"drag"};var i=t[0],n=t[t.length-1];this.fillSummaryWithTime(e,i,n);e.el_id=t[1].element.id;e.el_type=t[1].element.type;return[e]};CanvasLogger.prototype.summarizeEraseSequence=function(t){var e={type:"interaction",subtype:"erase",method:"drag"};var i=t[0],n=t[t.length-1];this.fillSummaryWithTime(e,i,n);return[e]};CanvasLogger.prototype.summarizeNodeInspectSequence=function(t){var e=t[0],i=t[t.length-1],n=t[1];var r={type:"interaction",subtype:"inspect",method:"tap",el_id:n.element.id,el_type:"derivation",el_subid:n.inspection.row,el_subtype:"row",sel_ascii:n.inspection.sel};this.fillSummaryWithTime(r,e,i);return[r]};CanvasLogger.prototype.summarizeGraphScrubSequence=function(t){var e={type:"graph",subtype:"scrub",method:"drag"};var i=t[0],n=t[t.length-1];this.fillSummaryWithTime(e,i,n);var r=t.filter(function(t){return t.type==="graph_element_changed"})[0];var o=i.source.selection;delete o.id;delete o.type;e.element={type:"graph",id:r.element.id,subtype:r.graph_element.type,subid:r.graph_element.id,old_state:i.source.selection,new_state:r.graph_element.attr};return[e]};CanvasLogger.prototype.summarizeMoveSequence=function(t){var e=t[0],i=t[t.length-1];var n={type:"interaction",subtype:"move",method:"drag",el_id:e.source.id,el_type:e.source.type,old_state:JSON.stringify(e.pos),new_state:JSON.stringify(i.pos)};this.fillSummaryWithTime(n,e,i);return[n]};CanvasLogger.prototype.summarizeResizeSequence=function(t){var e=t[0],i=t[t.length-1];var n={type:"interaction",subtype:"resize",method:"drag",el_id:e.source.id,el_type:e.source.type,old_state:JSON.stringify(e.size),new_state:JSON.stringify(i.size)};this.fillSummaryWithTime(n,e,i);return[n]};CanvasLogger.prototype.summarizePackSequence=function(t){var e={type:"interaction",subtype:"pack-dl",method:"drag"};var i=t[0],n=t[t.length-1];this.fillSummaryWithTime(e,i,n);var r=t[t.length-2];e.element={type:"derivation",id:r.element.id,subtype:"dl-row",subid:i.source.row,old_state:i.source.packState,new_state:n.source.packState};return[e]};CanvasLogger.prototype.summarizeLinkSequence=function(t){var e={type:"interaction",subtype:"link",method:"drag"};var i=t[0],n=t[t.length-1];this.fillSummaryWithTime(e,i,n);var r=t[1];if(i.source.type==="DerivationRow"){e.element={type:"derivation",id:i.source.id,subtype:"dl-row",subid:i.source.row,sel:i.source.model};e.targets=[{type:"graph",id:r.element.id,subtype:r.graph_element.type,subid:r.graph_element.id,new_state:r.graph_element.attr}]}else{e.element={type:"graph",id:i.source.id,subtype:i.source.selection.type,subid:i.source.selection.id};e.targets=[{type:"derivation",id:r.element.id,new_state:r.element.new_state}]}return[e]};CanvasLogger.prototype.summarizeCloneSequence=function(t){var e=t[0],i=t[t.length-1],n=t[1];var r={type:"interaction",subtype:"clone",method:"drag",el_id:e.source.id,el_type:"derivation",el_subid:e.source.row,el_subtype:"row",target_id:n.element.id,target_type:n.element.type,new_state:n.element.new_state};this.fillSummaryWithTime(r,e,i);return[r]};CanvasLogger.prototype.summarizeGraphPanSequence=function(t){var e={type:"graph",subtype:"pan",method:"drag"};var i=t[0],n=t[t.length-1];this.fillSummaryWithTime(e,i,n);var r=t[1],o=t[t.length-2];e.element={type:"graph",id:i.source.id,old_state:{pan:r.element.new_state.pan,zoom:r.element.new_state.zoom},new_state:{pan:o.element.new_state.pan,zoom:o.element.new_state.zoom}};return[e]};CanvasLogger.prototype.summarizeGraphZoomSequence=function(t){var e={type:"graph",subtype:"zoom",method:"scroll"};var i=t[0],n=t[t.length-1];this.fillSummaryWithTime(e,i,n);e.element={type:"graph",id:i.element.id,old_state:{pan:i.element.new_state.pan,zoom:i.element.new_state.zoom},new_state:{pan:n.element.new_state.pan,zoom:n.element.new_state.zoom}};return[e]};CanvasLogger.prototype.summarizeButtonSequence=function(t){var e={type:"interaction",method:"toolbar"};var i=t.filter(function(t){return t.type==="toolbar_button_press"})[0];e.time=i.time;e.dur=0;switch(i.button.label){case"undo":e.subtype="undo";break;case"redo":e.subtype="redo";break;case"larger":case"smaller":e.subtype="font_size";e.old_state=i.old_state.font_size;e.new_state=i.button.font_size;break;case"save":e.subtype="save";break;case"load":e.subtype="load";break;default:e.subtype="mode_change";e.old_state=i.old_state.mode;e.new_state=i.button.label;break}return[e]};CanvasLogger.prototype.summarizeFontSizeSequence=function(t){return[{type:"interaction",subtype:"font_size",method:"toolbar",time:t[0].time,dur:0,el_type:t[0].element.type,el_id:t[0].element.id,old_state:JSON.stringify(t[0].element.old_state),new_state:JSON.stringify(t[0].element.new_state)}]};CanvasLogger.prototype.summarizeTextEditSequence=function(t){var e=t[0],i=t[t.length-1];var n={type:"interaction",subtype:"edit",method:"keyboard",el_type:"textbox",el_id:e.element.id,old_state:e.element.old_state,new_state:i.element.new_state};this.fillSummaryWithTime(n,e,i);return[n]};DLLogger=function(t,e){this.id=gmath.uid();this.interaction_logger=t;this.log_mouse_trajectories=this.interaction_logger.log_mouse_trajectories;this.dl=e;this.registerDLListeners(e);this.registerInteractionHandlerListeners(e.getLastView().interaction_handler);this.registerAMListeners(e.getLastModel());this.events=[];this.interaction=null;this.scrubbed_in_this_interaction=false};DLLogger.prototype.registerDLListeners=function(t){t.events.on("added_line."+this.id,function(){if(t.rows.length===2)this.registerInteractionHandlerListeners(t.rows[0].view.interaction_handler);this.registerAMListeners(t.getLastModel())}.bind(this))};DLLogger.prototype.registerAMListeners=function(t){t.events.on("create."+this.id,this.on_change.bind(this)).on("change."+this.id,this.on_change.bind(this)).on("end-of-interaction."+this.id,this.on_end_of_interaction.bind(this)).on("start-of-interaction."+this.id,this.on_start_of_interaction.bind(this))};DLLogger.prototype.registerInteractionHandlerListeners=function(t){t.events.on("touch."+this.id,this.on_touch.bind(this,t)).on("release."+this.id,this.on_release.bind(this,t)).on("tap."+this.id,this.on_tap.bind(this,t)).on("dbltap."+this.id,this.on_tap.bind(this,t)).on("hold."+this.id,this.on_tap.bind(this,t)).on("keydown."+this.id,this.on_keydown.bind(this,t)).on("keyup."+this.id,this.on_keyup.bind(this,t)).on("node_selection."+this.id,this.on_node_selection.bind(this,t));if(this.log_mouse_trajectories){t.events.on("drag_start."+this.id,this.on_drag_start.bind(this,t)).on("drag."+this.id,this.on_drag.bind(this,t)).on("drag_end."+this.id,this.on_drag_end.bind(this,t))}};DLLogger.prototype.log=function(t){this.events.push(t)};DLLogger.prototype.extendWithNodeData=function(t,e,i,n){if(!Array.isArray(i))i=[i];this.extendWithSelectorData(t,e,i);if(i.length===0)return;var r=z.getBoundingBox(i);t[e+"x"]=r.x;t[e+"y"]=r.y;t[e+"width"]=r.width;t[e+"height"]=r.height};DLLogger.prototype.extendWithSelectorData=function(t,e,i){if(!Array.isArray(i))i=[i];if(i.length>0)t[e+"ascii"]=i[0].get_root().getSelectorOfNodes(i).join(";");else t[e+"ascii"]=""};DLLogger.prototype.extendWithFirstLogData=function(t,e,i){this.extendWithLogData(t,this.events[0],e,i)};DLLogger.prototype.extendWithPreviousLogData=function(t,e,i){this.extendWithLogData(t,this.events[this.events.length-1],e,i)};DLLogger.prototype.extendWithLogData=function(t,e,i,n){if(!e||!(i+"x"in e))throw"(DLLogger) Source log argument does not exist or does not contain expected data.";if(n===undefined)n=i;t[n+"x"]=e[i+"x"];t[n+"y"]=e[i+"y"];t[n+"width"]=e[i+"width"];t[n+"height"]=e[i+"height"];t[n+"ascii"]=e[i+"ascii"];if(e[n+"idx"])t[n+"idx"]=e[i+"idx"]};DLLogger.prototype.extendWithDuration=function(t){for(var e=this.events.length-1;e>=0;e--){var i=this.events[e];if(i.type==="math"||e===0){t.dur=t.time-i.time;return}}};DLLogger.prototype.on_change=function(t){if(!this.interaction)return;if(t.action)this.on_action(t);else if(this.dl.rows[0].model===t.new_model)this.on_scrub(t)};DLLogger.prototype.on_action=function(t){var e={time:Date.now(),type:"event",subtype:"math",action:t.action.name,row_id:this.dl.getRowByModel(t.action.newTree).idx,method:t.action.getOrInferTriggerType()};if(t.action.name==="SubstitutionAction"){e.source_ascii=t.action.nodes[0].to_ascii()}this.extendWithNodeData(e,"expr_",t.action.newTree.children[0]);if(t.action.target){this.extendWithSelectorData(e,"target_",t.action.target);e.target_side=t.action.settings.side}if(this.events.length)this.extendWithDuration(e);if(!this.interaction.method)this.interaction.method=e.method;this.interaction.new_state=e.expr_ascii;this.log(e)};DLLogger.prototype.on_scrub=function(t){this.scrubbed_in_this_interaction=true;this.interaction.subtype="scrub"};DLLogger.prototype.on_start_of_interaction=function(t){if(this.interaction){console.warn("Start of interaction received before prior interaction ended.");return}this.interaction={time:Date.now(),type:"interaction",subtype:"rewrite",el_type:"derivation",el_id:this.dl.id,el_subtype:"row",el_subid:this.dl.getRowByModel(t.model).idx,old_state:t.model.to_ascii()};this.logStartOfInterationEvent(t.time,this.dl.getRowByModel(t.model))};DLLogger.prototype.on_end_of_interaction=function(t){if(!this.interaction){console.warn("End of interaction received without prior start of interaction.");return}if(this.scrubbed_in_this_interaction)this.logScrubEvent();if(this.dl.mode==="edit"&&!this.isEmptySelectionInteraction()){this.interaction.dur=this.events[this.events.length-1].time-this.interaction.time;this.interaction_logger.logInteractionWithEvents(this.interaction,this.events,this.compressDragEvents)}this.clearData()};DLLogger.prototype.isEmptySelectionInteraction=function(){return!this.events.some(function(t){return t.subtype==="node_selection"||t.subtype==="math"})};DLLogger.prototype.compressDragEvents=function(t){var e=t.filter(function(t){return t.subtype==="drag"});if(e.length===0)return t;var i={type:"event",subtype:"trajectory"};var n=t[0].time;i.dts=e.map(function(t){var e=t.time-n;n=t.time;return e});i.xs=e.map(function(t){return t.x});i.ys=e.map(function(t){return t.y});i.wi_int_ids=e.map(function(t){return t.within_interaction_id});i.interaction_id=t[0].interaction_id;i.trial_id=t[0].trial_id;t=t.filter(function(t){return t.subtype!=="drag"});t.push(i);return t};DLLogger.prototype.decompressDragEvents=function(t){if(t.length===0||t[t.length-1].subtype!=="trajectory")return t;var e=t.pop();var i=t[0].time;for(var n=0;n<e.dts.length;n++){t.push({time:e.dts[n]+i,x:e.xs[n],y:e.ys[n],trial_id:e.trial_id,interaction_id:e.interaction_id,within_interaction_id:e.wi_int_ids[n],type:"event",subtype:"drag"});i+=e.dts[n]}t.sort(function(t,e){return t.within_interaction_id-e.within_interaction_id});return t};DLLogger.prototype.clearData=function(){this.scrubbed_in_this_interaction=false;this.interaction=null;this.events=[]};DLLogger.prototype.logScrubEvent=function(){var t={time:Date.now(),type:"event",subtype:"scrub",method:"drag",dur:this.events[this.events.length-1].time-this.events[0].time};this.extendWithNodeData(t,"expr_",this.dl.rows[0].model.children[0]);this.interaction.new_state=t.expr_ascii;this.log(t)};DLLogger.prototype.logStartOfInterationEvent=function(t,e){var i={time:t,type:"event",subtype:"start-interaction",row_id:e.idx};this.extendWithNodeData(i,"expr_",e.model.children[0]);this.extendWithNodeData(i,"sel_",e.view.interaction_handler.selected_nodes);this.log(i)};DLLogger.prototype.on_touch=function(t,e){if(!this.interaction)return;var i={time:e.time,type:"event",subtype:"touch",x:e.fingers[0].pos[0],y:e.fingers[0].pos[1]};this.extendWithNodeData(i,"sym_",e.target,true);this.log(i)};DLLogger.prototype.on_release=function(t,e){if(!this.interaction)return;this.log({time:e.time,type:"event",subtype:"release",x:e.finger.pos[0],y:e.finger.pos[1]})};DLLogger.prototype.on_drag_start=function(t,e){if(!this.interaction)return;this.log({time:e.time,type:"event",subtype:"drag",x:Math.round(e.pos0[0]),y:Math.round(e.pos0[1])})};DLLogger.prototype.on_drag=function(t,e){if(!this.interaction)return;this.log({time:e.time,type:"event",subtype:"drag",x:Math.round(e.pos[0]),y:Math.round(e.pos[1])})};DLLogger.prototype.on_drag_end=function(t,e){};DLLogger.prototype.on_node_selection=function(t,e){if(!this.interaction)return;var i={time:e.time,type:"event",subtype:"node_selection"};this.extendWithNodeData(i,"sel_",e.selection,true);this.log(i)};DLLogger.prototype.on_tap=function(t,e){if(!this.interaction)return;this.log({time:e.time,type:"event",subtype:e.type,x:e.finger.pos[0],y:e.finger.pos[1]})};DLLogger.prototype.on_keydown=function(t,e){if(!this.interaction)return;this.log({time:e.time,type:"event",subtype:"keydown",key_code:e.keyCode})};DLLogger.prototype.on_keyup=function(t,e){if(!this.interaction)return;this.log({time:e.time,type:"event",subtype:"keyup",key_code:e.keyCode})};gmath.DLLogger=DLLogger;GMEventRecorder=function(t,e){this.event_log=t;this.dl=null;this.other_dl=null;this.div=d3.select(e);this.stop_timer=false};GMEventRecorder.prototype.showPreview=function(){var t=gmath.extend({},this.event_log.options);t.interactive=false;if(this.dl){this.dl.removeElement()}this.dl=new DerivationList(null,this.div.node(),t)};GMEventRecorder.prototype.replay=function(t,e,i){var n=this;if(!this.event_log){console.warn("set the event log before replaying!");return}var r=this.event_log.events;if(r.length>0){
var o=i?i:r[0].time;var s=0}this.stop_timer=false;if(this.dl)this.dl.removeElement();this.dl=new DerivationList(null,this.div.node(),this.event_log.options,a);function a(){if(n.event_log.events.length>0){d3.timer(h,t||0)}}function h(t){if(n.stop_timer)return true;var i=n.dl.getLastView();while(r[s].time-o<t){var a=r[s];if(a.action&&a.followup&&r[s+1]&&a.followup===r[s+1].action){s++;a=r[s]}if(a.action){if(i.model.to_ascii()!==a.newTree){console.warn(a,"Replay out of synch, forcing correct state. Expected: "+a.newTree+"; Actual: "+i.model.to_ascii());n.abortCurrentStateAndResetInteraction(i,a.newTree)}}else{i.interaction_handler["on_"+a.type](a);if(a.type==="keyup")n.updateKey(a.keyCode,false);if(a.type==="keydown")n.updateKey(a.keyCode,true)}s++;if(s===r.length){e();return true}}}};GMEventRecorder.prototype.abortCurrentStateAndResetInteraction=function(t,e){t.model.parseAndSet(e);t.interaction_handler.abort_interaction();t.bindToModel(t.model);t.enter_and_exit("normal");t.enter_and_exit("shadow")};GMEventRecorder.prototype.updateKey=function(t,e){console.log(t);var i=this.div.select("#key"+t);if(i.size()===0){i=this.div.append("span").attr("id","key"+t).classed("key-vis",true).style("opacity",1e-5).style({position:"absolute",bottom:"5px",right:"10px",padding:"1px 7px",border:"2px solid steelblue","border-radius":"10px",color:"steelblue",background:"white"}).text({32:"space",16:"shift"}[t]||"")}if(e)i.style("opacity",1);else i.transition().duration(750).style("opacity",1e-5)};GMEventRecorder.prototype.stop_animation=function(){this.stop_timer=true};GMEventRecorder.prototype.createAndRecordDL=function(t,e){var i=new DerivationList(null,t,e);this.recordDL(i)};GMEventRecorder.prototype.recordDL=function(t){this.event_log={options:t.options,events:[]};this.dl=t;var e=this.dl.getLastView();var i=this.log.bind(this);this.registerListeners(e,i);var n=this;if(t.options.no_history){t.getLastModel().events.on("change",n.logAction.bind(this))}else{t.events.on("added_line",function(r){n.logAction(r);if(t.getLastView()===e)return;e=t.getLastView();n.registerListeners(e,i)})}return this.event_log};GMEventRecorder.prototype.liveReplay=function(t,e){this.other_dl=new DerivationList(null,t,e)};GMEventRecorder.prototype.log=function(t){this.event_log.events.push(t);if(this.other_dl){this.other_dl.getLastView().interaction_handler["on_"+t.type](t)}};GMEventRecorder.prototype.logAction=function(t){if(t){this.event_log.events.push({type:"action",action:t.action.name,followup:t.action.followup?t.action.followup.name:false,newTree:t.action.newTree.to_ascii(),time:Date.now()})}};GMEventRecorder.prototype.registerListeners=function(t,e){t.interaction_handler.events.on("touch",e).on("release",e).on("drag_start",e).on("drag",e).on("drag_end",e).on("tap",e).on("dbltap",e).on("keydown",e).on("keyup",e)};gmath.EventRecorder=GMEventRecorder;GraphEventRecorder=function(t,e){this.event_log=t;this.graph;this.container=d3.select(e)};GraphEventRecorder.prototype.replay=function(t,e,i){var n=this;if(!this.event_log){console.warn("(GraphEventRecorder) Set the event log before replaying.");return}if(this.graph&&this.graph.main_g){this.graph.main_g.remove();this.graph=null}this.graph=new gmath.ui.Graph(this.container.node(),this.event_log.options);var r=this.event_log.events;if(r.length>0){var o=i||r[0].time;var s=0}function a(){if(n.event_log.events.length>0){d3.timer(h,t||0)}}function h(t){while(r[s].time-o<t){var i=r[s];n.graph[""+i.type](i);s++;if(s===r.length){e();return true}}}setTimeout(a,10)};GraphEventRecorder.prototype.recordGraph=function(t){this.event_log={options:t.options,events:[]};this.graph=t;this.container=t.container;var e=this.log.bind(this);this.registerListeners(t,e);return this.event_log};GraphEventRecorder.prototype.log=function(t){this.event_log.events.push(t)};GraphEventRecorder.prototype.registerListeners=function(t,e){t.events.on("move",e).on("touch",e).on("drag",e).on("hold",e).on("release",e)};gmath.CanvasSaver=function(){var t={};t.createSaveFile=function(t){var e={};e.save_id=gmath.uid();e.gmath=JSON.stringify({version:gmath.version,ui:{version:gmath.ui.version,gm_version:gmath.ui.gm_version}});e.defaultOptions={AlgebraModel:gmath.AlgebraModel.defaultOptions,AlgebraView:gmath.AlgebraView.defaultOptions,CanvasElement:gmath.CanvasElementClass.defaultOptions,DerivationList:gmath.DerivationList.defaultOptions,TextBox:gmath.ui.TextBox.defaultOptions,CanvasImage:gmath.ui.CanvasImage.defaultOptions,CanvasFactory:gmath.ui.CanvasFactoryClass.defaultOptions};e.defaultOptions=JSON.stringify(e.defaultOptions);e.options=gmath.object.extendChanged({},t.options,gmath.ui.CanvasFactoryClass.defaultOptions);if(e.options.mode_btns){e.options.mode_btns=e.options.mode_btns.filter(function(t){return t.group==="mode"});e.options.mode_btns.forEach(function(t,e){if(e===0)t.state=true;else t.state=false})}e.options=JSON.stringify(e.options);e.linkCoordinator=JSON.stringify(gmath.LinkCoordinator);var i=t.model.dls().concat(t.model.paths().concat(t.model.images().concat(t.model.textboxes())));e.objects=JSON.stringify(i);return e};t.save=function(e){var i=t.createSaveFile(e);localStorage.setItem("GM_save_1_version",i.gmath);localStorage.setItem("GM_save_1_default_options",i.defaultOptions);localStorage.setItem("GM_save_1_options",i.options);localStorage.setItem("GM_save_1_link_coordinator",i.linkCoordinator);localStorage.setItem("GM_save_1_objects",i.objects)};t.share=function(e,i,n){var r=t.createSaveFile(i);var o=[];var s=JSON.parse(r.objects);s.forEach(function(t){if(t.imageData!==undefined){t.save_id=gmath.uid();o.push(JSON.stringify(t));t.imageData=t.save_id}});var a=e+"_images_folder";o.forEach(function(t){var e=new XMLHttpRequest;e.open("POST",a);e.setRequestHeader("Content-Type","application/json");e.send(t)});r.objects=JSON.stringify(s);var h=JSON.stringify(r);console.log("File size:",(h.length/1e3).toFixed(1),"KB");if(h.length>2e6){console.warn("(CanvasSaver) The data attempting to save is too large.");if(n)n({reason:"File size too big ("+(h.length/1e6).toFixed(1)+" MB)."});return}var l=new XMLHttpRequest;if(n)l.onreadystatechange=function(){if(this.readyState===4){if(this.status===200||this.status===301||this.status===302){n(null,r.save_id)}else n({reason:"Network or server error ("+l.status+").",status:l.status,statusText:l.statusText})}};l.open("POST",e+"_saves_folder");l.setRequestHeader("Content-Type","application/json");l.send(h)};t.loadSaveFile=function(e,i,n){var r=new XMLHttpRequest;var o=i+"_saves_folder/"+n;var s=i+"_images_folder/";r.onreadystatechange=function(){if(r.readyState===4&&r.status===200){var i=JSON.parse(r.responseText);var n=[];var o=JSON.parse(i[0].objects);for(var a=o.length-1;a>=0;a--){if(o[a].imageData!==undefined){n.push(o[a]);o.splice(a,1)}}i[0].objects=JSON.stringify(o);t.load(e,i[0]);if(n.length>0){t.loadAllImages(e,n,s)}}};r.open("get",o,true);r.setRequestHeader("Content-Type","application/json");r.send()};t.loadImage=function(t,e,i){var n=new XMLHttpRequest;n.onerror=function(){console.log("failed to load image.  Request:");console.log(n)};n.onreadystatechange=function(){if(n.readyState===4&&n.status===200){var t=n.responseURL.lastIndexOf("/");var i=n.responseURL.substring(t+1,n.responseURL.length);var r=JSON.parse(n.responseText);if(typeof r[0]!=="undefined"){e.imageData=r[0].imageData;var o={};gmath.loadFromJSON(JSON.stringify(e),o,components.model)}}};var r=e.save_id;var o=i+r;n.open("get",o,true);n.setRequestHeader("Content-Type","application/json");n.send()};t.loadAllImages=function(e,i,n){for(var r in i){t.loadImage(e,i[r],n)}};t.load=function(e,i){if(!i)i=t.loadLocalSaveFile();if(!i){console.warn("(CanvasSaver) Attempted to load non-existant save.");return}this.loadDefaultOptions(i.defaultOptions);var n=gmath.DerivationList.defaultOptions.row_transition_dur;gmath.DerivationList.defaultOptions.row_transition_dur=0;var r=new gmath.ui.CanvasFactory(e,JSON.parse(i.options));r.logger.listen(false);var o={};gmath.loadFromJSON(i.objects,o,r.model);gmath.LinkCoordinator=gmath.loadFromJSON(i.linkCoordinator,o);this.resolveActionIDsToObjects(r,o);r.logger.listen(true);gmath.DerivationList.defaultOptions.row_transition_dur=n;r.model.dls().forEach(function(t){t.options.row_transition_dur=n});components=r;return r};t.loadLocalSaveFile=function(){var t={defaultOptions:localStorage.getItem("GM_save_1_default_options"),options:localStorage.getItem("GM_save_1_options"),id2obj:localStorage.getItem("GM_save_1_id2obj"),linkCoordinator:localStorage.getItem("GM_save_1_link_coordinator"),objects:localStorage.getItem("GM_save_1_objects")};return t};t.makeID2ObjMap=function(t){var e={};var i=t.model.dls();for(var n=0;n<i.length;n++){var r=i[n].rows;for(var o=0;o<r.length;o++){var s=r[o];if(s.action)e[s.action.id]=s.action;s.model.for_each(function(t){e[t.id]=t})}}return JSON.stringify(e)};t.loadDefaultOptions=function(t){var e=JSON.parse(t);for(var i in e){if(i==="CanvasFactory"){gmath.ui.CanvasFactoryClass.defaultOptions=e[i]}else if(i==="CanvasElement"){gmath.CanvasElementClass.defaultOptions=e[i]}else if(i==="TextBox"){gmath.ui.TextBoxClass.defaultOptions=e[i]}else if(i==="CanvasImage"){gmath.ui.CanvasImageClass.defaultOptions=e[i]}else{gmath[i].defaultOptions=e[i]}}};t.resolveActionIDsToObjects=function(t,e){t.model.dls().forEach(function(t){t.rows.forEach(function(t){if(t.action)t.action=e[t.action]})})};t.saveFileSizeIsTooBig=function(t){var e=JSON.stringify(t),i=gmath.byteLength(e);return i>5e5};return t}();t.Node.prototype.toJSON=function(){return{id:this.id,value:this.value,type:"Expression",name:this.name,bp:this.bp,associative:this.associative,commutative:this.commutative,vertical_notation:this.vertical_notation,selected:this.selected,dragging:this.dragging,fixed:this.fixed,locked:this.locked,hidden:this.hidden,simplify:this.simplify,precision:this.precision,deleted:this.deleted,ls:this.ls&&this.ls.id,rs:this.rs&&this.rs.id,parent:this.parent&&this.parent.id,children:this.children}};r.prototype.toJSON=function(){var t=gmath.object.extendChanged({},this.options,r.defaultOptions);if(t.parser===r.getDefaultParser())t.parser=undefined;return{id:this.id,type:"AlgebraModel",options:t,children:this.children}};Action.prototype.toJSON=function(){var t={id:this.id,name:this.name,type:"Action",priority:this.priority,node_map:jsonifyNodeMap(this.node_map),touched_nodes:this.touched_nodes,oldTree:this.oldTree.id,newTree:this.newTree.id,triggerType:this.triggerType,settings:this.settings};if(this.nodes)t.nodes=this.nodes.map(node_to_id_fn);if(this.target)t.target=Array.isArray(this.target)?this.target.map(node_to_id_fn):this.target.id;if(this.actor)t.actor=this.actor.id;return t};gmath.LinkCoordinatorClass.prototype.toJSON=function(){return{id:this.id,type:"LinkCoordinator",links:this.links,auto_update_scrubbability:this.auto_update_scrubbability}};AlgebraModelLink.prototype.toJSON=function(){return{id:this.id,type:"AlgebraModelLink",source:this.source.id,target:this.target.id,action:this.action}};DerivationRow.prototype.toJSON=function(){return{id:this.id,type:"DerivationRow",dl:this.dl.id,action:this.action&&this.action.id,model:this.model,row_idx:this.idx}};DerivationList.prototype.toJSON=function(){var t=gmath.object.extendChanged({},this.options,DerivationList.defaultOptions);gmath.extend(t,this.aview_options);gmath.extend(t,this.amodel_options);if(t.canvas_model)t.canvas_model=this.canvas_model.id;t.id=this.id;return{type:"DerivationList",rows:this.rows,options:t,pos:this.pos,pack_state:this.rows.map(function(t){return t.hidden?true:false})}};gmath.loadFromJSON=function(t,e,i){if(!e)e={};return JSON.parse(t,function(t,n){if(n&&n.type in gmath.JSONParsers)return gmath.JSONParsers[n.type](n,e,i);return n})};gmath.JSONParsers={};gmath.JSONParsers.Expression=function(t,e){var i=new gmath.expressions[t.name];for(var n in t)i[n]=t[n];e[i.id]=i;return i};gmath.JSONParsers.Action=function(t,e){var i=new gmath.actions[t.name].constructor;for(var n in t)i[n]=t[n];i.ids_to_references_after_parsing(e);e[i.id]=i;return i};gmath.JSONParsers.AlgebraModel=function(t,e){if(t.options.parser)t.options.parser=o(t.options.parser);var i=new r("",t.options);i.children=t.children;i.id=t.id;e[i.id]=i;i.for_each(function(t){if(t.ls)t.ls=e[t.ls];if(t.rs)t.rs=e[t.rs];if(t.parent)t.parent=e[t.parent]});return i};gmath.JSONParsers.AlgebraModelLink=function(t,e){var i=new AlgebraModelLink(e[t.source],e[t.target],t.action,t.id);i.id=t.id;return i};gmath.JSONParsers.LinkCoordinator=function(t,e){var i=new gmath.LinkCoordinatorClass;i.id=t.id;i.links=t.links;i.auto_update_scrubbability=t.auto_update_scrubbability;i.updateAll();return i};gmath.JSONParsers.DerivationRow=function(t,e){var i=new DerivationRow(t.dl,t);return i};gmath.JSONParsers.DerivationList=function(t,e,i){var n=t.options.eq;delete t.options.eq;var r=i.createDL(t.options,null,"load");r.translateElement(t.pos);t.options.eq=n;t.rows.forEach(function(e,i){r.addRowFromModel(e.model,e.action,function(){if(i===t.rows.length-1){o();r.layoutRows()}})});function o(){r.rows.forEach(function(e,i){if(t.pack_state[i])e.hide()})}};gmath.JSONParsers.Path=function(t,e,i){return i.createPath(t,"load")};gmath.JSONParsers.TextBox=function(t,e,i){var n=i.createTextBox(t,null,"load");n.unselect();return n};gmath.JSONParsers.CanvasImage=function(t,e,i){return i.createImage(t)};node_to_id_fn=function(t){return t.id};jsonifyNodeMap=function(t){var e={};for(var i in t)e[i]=t[i].map(node_to_id_fn);return e};Action.prototype.ids_to_references_after_parsing=function(t){if(this.oldTree)this.oldTree=t[this.oldTree];if(this.newTree)this.newTree=t[this.newTree];for(var e in this.node_map){this.node_map[e]=this.node_map[e].map(function(e){return t[e]})}if(this.nodes)this.nodes=this.nodes.map(function(e){return t[e]});if(this.target)this.target=Array.isArray(this.target)?this.target.map(function(e){return t[e]}):t[this.target];if(this.actor)this.actor=t[this.actor]};SVGPlayButton=function(){var t=d3.dispatch("click");var e,i,n,r,o,s=false;var a=function(t){e=t;a.init();return a};a.hidden=function(t){if(arguments.length===0)return s;s=t;if(r)r.style("display",s?"none":null);if(o)o.attr("opacity",0);return this};a.remove=function(){if(n)n.remove()};a.init=function(){i=e.node().getBoundingClientRect();n=e.append("svg").attr("id","button").attr("width","100%").attr("height","100%").attr("cursor","pointer");r=n.append("g").style("display",s?"none":null).attr("transform","translate("+[i.width/2,i.height/2]+")");r.append("rect").attr({x:-i.width/2,y:-i.height/2,width:i.width,height:i.height}).attr({fill:"black",opacity:.1});r.append("circle").attr({r:"35px"}).attr({fill:"#666",stroke:"white","stroke-width":"4px","fill-opacity":.6});r.append("circle").attr({r:"37px"}).attr({fill:"none",stroke:"silver","stroke-width":1.5});r.append("path").attr("d","M0,0 L0,1 L0.8,0.5 Z").attr("transform","scale(40)translate(-0.3,-0.5)").attr("fill","white");o=n.append("rect").classed("overlay",true).attr({width:i.width,height:i.height}).attr({fill:"black",opacity:0}).attr("pointer-events","all").on("mouseover",function(){o.attr("opacity",s?0:.1)}).on("mouseout",function(){o.attr("opacity",0)}).on("click",function(){if(!s)t.click()})};return d3.rebind(a,t,"on")};gmath.svg_play_button=SVGPlayButton;gmath.Tree=t;gmath.session_id=gmath.uid();if(typeof module==="object"&&module.exports){module.exports=gmath}else{this.gmath=gmath}})();
