/// Copyright Erik Weitnauer 2015.
gmath.ui.version="0.0.5";gmath.ui.gm_version="0.5.2";gmath.ui=gmath.ui||{};gmath.ui.Path=function(){var t=function(t,e){this.container=d3.select(t);this.element=null;e=e||{};this.id=e.id||gmath.uid();this.oid=e.oid;this.points=e.points||[];this.color=e.color||"black";this.width=e.width||1;this.type=e.type;this.init()};t.prototype.toJSON=function(){return{id:this.id,type:"Path",points:this.points,color:this.color,width:this.width}};t.line=typeof d3==="undefined"||typeof d3.svg==="undefined"?null:d3.svg.line();t.prototype.init=function(){var t=null;if(this.oid)t="#"+this.oid;this.element=this.container.insert("path",t).attr("id",this.id).style("fill","none").style("stroke-linecap","round").style("stroke-linejoin","round");return this.update()};t.prototype.update=function(){this.element.attr("d",t.line(this.points)+(this.points.length===1?"Z":"")).style("stroke",this.color).style("stroke-width",this.width);return this};t.prototype.remove=function(){this.element.remove();return this};t.prototype.setContainer=function(t){if(arguments.length===0)return this.container;this.container=t;return this};t.prototype.renderOnto=function(t){var e=this.element,n=this.container;this.container=t;this.element=t.select("#"+this.id);if(this.element.empty())this.init();else this.update();this.container=n;this.element=e};return t}();gm_erase_paths=function(){function t(t,e,n){n=n||20;var r=[];var o=function(t){var o=e[0][0];var i=e[0][1];var a=0;var l=0;if(t.length===1){if(!s(t[0][0],t[0][1],o,i,n)){r.push(t);return}}var p;while(a<t.length-1){var u=t[a];var d=t[a+1];var f=s(u[0],u[1],o,i,n);var y=s(d[0],d[1],o,i,n);if(f&&y){a++;l=a}else if(f&&!y){var m=h(u[0],u[1],d[0],d[1],o,i,n);if(m){t[a]=m;l=a}else{a++}}else if(!f&&y){var m=h(d[0],d[1],u[0],u[1],o,i,n);if(m){p=t.slice(l,a+1);p.push(m);r.push(p)}a++;l=a}else{var g=c(u[0],u[1],d[0],d[1],o,i,n);if(g){p=t.slice(l,a+1);if(p[p.length-1][0]!==g[0][0]||p[p.length-1][1]!==g[0][1]){p.push(g[0])}if(p.length>1)r.push(p);t[a]=g[1];if(t[a+1]&&t[a+1][0]==g[1][0]&&t[a+1][1]==g[1][1])a++;l=a}else{a++}}}if(l!==a){p=t.slice(l,t.length);if(p){r.push(p)}}};var a=function(t,o){if(t.path){n=n+t.width/2;var t=t.path}var i=e[o];var a=e[o+1];var o=0;var s=0;if(t.length===1){var l=p(t[0][0],t[0][1],i[0],i[1],a[0],a[1],n);if(l.indexOf(1)===-1){r.push(t);return}}var u;while(o<t.length-1){var h=t[o];var c=t[o+1];var l=p(h[0],h[1],i[0],i[1],a[0],a[1],n);var d=p(c[0],c[1],i[0],i[1],a[0],a[1],n);if(l.indexOf(1)!==-1&&d.indexOf(1)!==-1){o++;s=o}else if(l.indexOf(1)!==-1&&d.indexOf(1)===-1){var m=f(h[0],h[1],l,c[0],c[1],i[0],i[1],a[0],a[1],n);if(m){t[o]=m;s=o}else{o++}}else if(l.indexOf(1)===-1&&d.indexOf(1)!==-1){var m=f(c[0],c[1],d,h[0],h[1],i[0],i[1],a[0],a[1],n);if(m){u=t.slice(s,o+1);u.push(m);r.push(u);o++;s=o}else{o++}}else{var g=y(h[0],h[1],c[0],c[1],i[0],i[1],a[0],a[1],n);if(g){u=t.slice(s,o+1);if(u[u.length-1][0]!==g[0][0]||u[u.length-1][1]!==g[0][1]){u.push(g[0])}if(u.length>1)r.push(u);t[o]=g[1];if(t[o+1]&&t[o+1][0]==g[1][0]&&t[o+1][1]==g[1][1])o++;s=o}else{o++}}}if(s!==o){u=t.slice(s,t.length);if(u){r.push(u)}}};e=i({path:e});if(e.length===1){for(var l=0;l<t.length;l++){o(t[l])}t=r}else{for(var u=0;u<e.length-1;u++){for(var l=0;l<t.length;l++){a(t[l],u)}t=r;r=[]}}for(var d=0;d<t.length;d++){for(var m=0;m<t[d].length;m++){t[d][m][0]=Math.round(t[d][m][0]);t[d][m][1]=Math.round(t[d][m][1])}}return t}function e(t){if(t.path){var t=t.path}document.write("[");for(var e=0;e<t.length-1;e++){document.write("["+t[e][0]+","+t[e][1]+"],")}document.write("["+t[e][0]+","+t[e][1]+"]");document.write("]")}function n(t){document.write("[");for(var n=0;n<t.length-1;n++){e(t[n]);document.write(",<br />")}e(t[n]);document.write("]")}function r(t,e){if(t.path){var t=t.path}var n="";n+="[";for(var r=0;r<t.length-1;r++){n+="["+t[r][0]+","+t[r][1]+"],"}n+="["+t[r][0]+","+t[r][1]+"]";n+="]";if(e){console.log(n)}else{return n}}function o(t){log="";log+="[";for(var e=0;e<t.length-1;e++){log+=r(t[e],0);log+=","}log+=r(t[e],0);log+="]";console.log(log)}function i(t){if(t.path){var t=t.path}var e=[];if(t.length===1){e=t}else{pClean=0;while(pClean<t.length-1){if(t[pClean][0]!==t[pClean+1][0]||t[pClean][1]!==t[pClean+1][1]){e.push(t[pClean])}pClean++}if(t.length!==0&&e.length===0){e.push(t[0])}if(t[t.length-1][0]!==t[e.length-1][0]||t[t.length-1][1]!==t[e.length-1][1]){e.push(t[pClean])}}return e}function a(t,e,n,r){return Math.sqrt(Math.pow(n-t,2)+Math.pow(r-e,2))}function s(t,e,n,r,o){var i=a(t,e,n,r);if(i<o)return 1;else return 0}function l(t,e,n,r,o,i,a){var s=[o-n,i-r];var l=[t-n,e-r];var p=[-s[1],s[0]];var u=Math.sqrt(Math.pow(p[0],2)+Math.pow(p[1],2));var h=[p[0]/u,p[1]/u];var c=Math.sqrt(Math.pow(s[0],2)+Math.pow(s[1],2));var d=[s[0]/c,s[1]/c];var f=l[0]*d[0]+l[1]*d[1];if(f<=0||f>=c)return 0;var y=l[0]*h[0]+l[1]*h[1];if(y>=a||y<=-a)return 0;return 1}function p(t,e,n,r,o,i,a){var p=[];p.push(s(t,e,n,r,a));p.push(s(t,e,o,i,a));p.push(l(t,e,n,r,o,i,a));return p}function u(t,e,n,r,o){var i=[n-t,r-e];var a=[-i[1],i[0]];var s=Math.sqrt(Math.pow(a[0],2)+Math.pow(a[1],2));var l=[a[0]/s,a[1]/s];var p=[t+o*l[0],e+o*l[1]];var u=[t-o*l[0],e-o*l[1]];var h=[n-o*l[0],r-o*l[1]];var c=[n+o*l[0],r+o*l[1]];return[p,u,h,c]}function h(t,e,n,r,o,i,a){var s=[o-t,i-e];var l=[n-t,r-e];var p=Math.sqrt(Math.pow(l[0],2)+Math.pow(l[1],2));var u=[l[0]/p,l[1]/p];var h=s[0]*u[0]+s[1]*u[1];var c=[t+h*u[0],e+h*u[1]];var d=Math.sqrt(Math.pow(o-c[0],2)+Math.pow(i-c[1],2));var f;if(d===0){f=a}else{var f=Math.sqrt(Math.pow(a,2)-Math.pow(d,2))}var y=[t+h*u[0]+f*u[0],e+h*u[1]+f*u[1]];if(y[0]===t&&y[1]===e)return null;return y}function c(t,e,n,r,o,i,a){var s=[o-t,i-e];var l=[n-t,r-e];var p=[-l[1],l[0]];var u=Math.sqrt(Math.pow(p[0],2)+Math.pow(p[1],2));var h=[p[0]/u,p[1]/u];var c=s[0]*h[0]+s[1]*h[1];var d=v([t,e],[n,r],[o,i]);var f=m([d[0]-o,d[1]-i]);if(f>=a)return null;var y=Math.sqrt(Math.pow(a,2)-Math.pow(c,2));var g=[o-c*h[0],i-c*h[1]];var b=Math.sqrt(Math.pow(l[0],2)+Math.pow(l[1],2));var w=[l[0]/b,l[1]/b];var _=[[g[0]-w[0]*y,g[1]-w[1]*y],[g[0]+w[0]*y,g[1]+w[1]*y]];if(_[0][0]===t&&_[0][1]===e)return null;return _}function d(t,e,n,r,o,i,a,s){var l,p,u,h;l=n-t;p=r-e;u=a-o;h=s-i;var c,d;if(-u*p+l*h===0)return null;c=(-p*(t-o)+l*(e-i))/(-u*p+l*h);d=(u*(e-i)-h*(t-o))/(-u*p+l*h);if(c>=0&&c<=1&&d>=0&&d<=1){var f=t+d*l;var y=e+d*p;return[f,y]}return null}function f(t,e,n,r,o,i,s,l,p,f){var y=u(i,s,l,p,f);var m=[];if(n[0]&&!n[1]){m.push(h(t,e,r,o,i,s,f));m.push(d(t,e,r,o,y[0][0],y[0][1],y[3][0],y[3][1]));m.push(d(t,e,r,o,y[1][0],y[1][1],y[2][0],y[2][1]));var g=c(t,e,r,o,l,p,f);if(g)m.push(g[0],g[1])}else if(!n[0]&&n[1]){m.push(h(t,e,r,o,l,p,f));m.push(d(t,e,r,o,y[0][0],y[0][1],y[3][0],y[3][1]));m.push(d(t,e,r,o,y[1][0],y[1][1],y[2][0],y[2][1]));var g=c(t,e,r,o,i,s,f);if(g)m.push(g[0],g[1])}else if(n[0]&&n[1]){m.push(h(t,e,r,o,i,s,f));m.push(d(t,e,r,o,y[0][0],y[0][1],y[3][0],y[3][1]));m.push(d(t,e,r,o,y[1][0],y[1][1],y[2][0],y[2][1]));m.push(h(t,e,r,o,l,p,f))}else{var g=c(t,e,r,o,l,p,f);var v=c(t,e,r,o,i,s,f);if(g)m.push(g[0],g[1]);if(v)m.push(v[0],v[1]);m.push(d(t,e,r,o,y[0][0],y[0][1],y[3][0],y[3][1]));m.push(d(t,e,r,o,y[1][0],y[1][1],y[2][0],y[2][1]))}var b=[t,e];for(var w=0;w<m.length;w++){if(m[w]){if(a(m[w][0],m[w][1],r,o)<a(b[0],b[1],r,o)){b=m[w]}}}if(b[0]===t&&b[1]===e)return null;return b}function y(t,e,n,r,o,i,s,l,p){var h=u(o,i,s,l,p);var f=[];var y=c(t,e,n,r,o,i,p);if(y)f.push(y[0],y[1]);y=c(t,e,n,r,s,l,p);if(y)f.push(y[0],y[1]);f.push(d(t,e,n,r,h[0][0],h[0][1],h[3][0],h[3][1]));f.push(d(t,e,n,r,h[1][0],h[1][1],h[2][0],h[2][1]));var m=[n,r];var g=[t,e];for(var v=0;v<f.length;v++){if(f[v]){if(a(f[v][0],f[v][1],t,e)<a(m[0],m[1],t,e)){m=f[v]}}}for(var b=0;b<f.length;b++){if(f[b]){if(a(f[b][0],f[b][1],n,r)<a(g[0],g[1],n,r)){g=f[b]}}}if(m[0]===n&&m[1]===r||g[0]===t&&g[1]===e)return null;else return[m,g]}var m=function(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1])};var g=1e-6;var v=function(t,e,n){var r=[e[0]-t[0],e[1]-t[1]],o=m(r);if(o<g)return t;var i=[n[0]-t[0],n[1]-t[1]];var a=(r[0]*i[0]+r[1]*i[1])/o;if(a<0)return t;if(a>o)return e;return[t[0]+r[0]*a/o,t[1]+r[1]*a/o]};if(typeof exports!="undefined"){exports.erase=t}return t}();gm_hwr_request=function(){var t=function(t){var e={type:"stroke",x:[],y:[]};t.points.forEach(function(t){e.x.push(t[0]);e.y.push(t[1])});return e};var e=function(e,n){url="http://dlandy.psych.indiana.edu:7031/server.js";var r={components:e.map(t),resultTypes:["LATEX"]};var o={apiKey:"c26d2755-1fda-4033-b136-4af042f3f9db",equationInput:JSON.stringify(r)};var i=$.post(url,o.equationInput);i.done(function(t){var e=t.replace(/\\/g,"\\\\");e=JSON.parse(e);n(null,e.JSON)})};return e}();gmath.ui=gmath.ui||{};gmath.ui.holdUI=function(){var t=function(t,e,n){this.container=t;this.controller=e;this.view=n;this.element=null;this.pos=[0,0];this.visible=false;this.buttons=[];this.button_els=null;this.colors=d3.scale.category10();this.button_rads=null;this.inner_radius=20;this.outer_radius=80;this.init()};t.prototype.setPos=function(t){this.pos=t;this.element.attr("transform","translate("+t[0]+","+t[1]+")")};t.prototype.setVisible=function(t){this.visible=t;this.element.style("display",t?null:"none")};t.prototype.init=function(){var t=this,e={stroke:"black","stroke-width":1,"stroke-linecap":"round",fill:"none"};this.buttons.push({action:function(e){t.controller.inputDL(e)},icon:function(t){var e=t.append("g").attr("transform","translate(0,10)").append("g");var n=new gmath.AlgebraModel("f_x",{});var r=new gmath.AlgebraView(n,e,{font_size:"35",inactive_color:"black",interactive:false});r.init();return e},color:t.colors(0)});this.buttons.push({action:function(e){var n={pos:{x:e[0],y:e[1]}};t.view.createGraph(n)},icon:function(t){var n=t.append("g").attr("transform","translate(2,0)").style("cursor","pointer");var r=n.append("g").style("opacity",.5).style("shape-rendering","crispedges");r.append("line").attr({x1:-15,y1:0,x2:15,y2:0}).style(e);r.append("line").attr({x1:0,y1:-15,x2:0,y2:15}).style(e);r.append("rect").attr({x:-15,y:-15,width:30,height:30}).style(e);n.append("line").attr({x1:-15,y1:8,x2:15,y2:-8}).style(e).style("stroke-width",1.5);return n},color:t.colors(1)});this.buttons.push({action:function(e){var n={pos:{x:e[0],y:e[1]}};t.view.createTextBox(n)},icon:function(t){var n=t.append("g");var r=n.append("g").style("opacity",.5);r.append("text").text("Aa").attr({x:0,y:10}).style("text-anchor","middle").style("font-size","30px").style(e).style("fill","black").style("pointer-events","none");return n},color:t.colors(2)});this.button_rads=Math.PI*2/this.buttons.length;var n=this.button_rads,r=this.inner_radius,o=this.outer_radius;this.element=this.container.append("g").style("display","none");var i=this.element.append("defs"),a=i.append("filter").attr("id","dropShadow_holdUI");a.append("feGaussianBlur").attr("in","SourceAlpha").attr("stdDeviation",3);a.append("feOffset").attr("dx",0).attr("dy",4).attr("result","offsetblur");a.append("feComponentTransfer").append("feFuncA").attr("type","linear").attr("slope",.25);var s=a.append("feMerge");s.append("feMergeNode");s.append("feMergeNode").attr("in","SourceGraphic");this.element.attr("filter","url(#dropShadow_holdUI)");this.button_els=this.element.selectAll(".holdUI").data(this.buttons);this.button_els.enter().append("g").classed("holdUI",true).append("path").attr("d",function(t,e){var i=Math.cos(n*e)*r,a=-Math.sin(n*e)*r,s=Math.cos(n*e)*o,l=-Math.sin(n*e)*o,p=Math.cos(n*(e+1))*o,u=-Math.sin(n*(e+1))*o,h=Math.cos(n*(e+1))*r,c=-Math.sin(n*(e+1))*r;return"M"+i+","+a+"L"+s+","+l+"A"+o+","+o+" 0 0,0 "+p+","+u+"L"+h+","+c+"A"+r+","+r+" 0 0,1 "+i+","+a+"Z"}).style("fill",function(t){return t.color}).style("opacity",.8).style("cursor","pointer");this.button_els.each(function(t,e){var i=d3.select(this),a=t.icon(i);a.attr("transform",function(){var t=Math.cos(n*(e+.5))*(r+(o-r)/2),i=-Math.sin(n*(e+.5))*(r+(o-r)/2);return"translate("+t+", "+i+")"})})};t.prototype.detectHit=function(t){var e=this,n=this.button_rads,r=this.inner_radius,o=this.outer_radius,i=-1;this.button_els.each(function(a,s){var l=Math.sqrt(Math.pow(t[0]-e.pos[0],2)+Math.pow(t[1]-e.pos[1],2)),p=Math.atan2(-t[1]+e.pos[1],t[0]-e.pos[0]);if(p<0)p+=Math.PI*2;if(l>r&&l<o&&p>n*s&&p<n*(s+1))i=s});return i};t.prototype.highlight=function(t){var e=this.detectHit(t);this.button_els.each(function(t,n){var r=d3.select(this).select("path");if(e===n)r.transition().duration(30).style("fill",d3.rgb(t.color).brighter(.6));else r.transition().duration(30).style("fill",t.color)})};t.prototype.performAction=function(t){var e=this.detectHit(t);this.button_els.each(function(n,r){if(r===e)n.action(t)})};return t}();gmath.ui=gmath.ui||{};gmath.ui.CanvasController=function(){var t=function(t){var e=d3.dispatch("scroll","start_hwr","stop_hwr","undone","redone","hold","touch","drag","release","font_size","keyboard","entered_term","start-of-interaction","end-of-interaction");var n=gmath.uid(),r=t,o=null,i=[],a=-1,s=null,l=false,p=null,u=false,h="math",c=true,d,f=1500,y=null,m=r.paths().length,g=2,v=50,b=null,w="black",_=null,k=null,x=0,E=null,T=null,D=false,C=null,M=false,A=true,S=true;var L=function(){t.on("create."+n,function(t){if(t.target_type==="dl"||t.target_type==="graph"||t.target_type==="textbox"){t.target.events.on("start-of-interaction."+n,function(t){z();e["start-of-interaction"](t)});t.target.events.on("end-of-interaction."+n,function(t){e["end-of-interaction"](t)})}});if(S&&!C&&r.container()){C=new gmath.ui.holdUI(r.container(),L,r)}H(t.container().select("#background_event_layer"),V());H(t.container().select("#foreground_event_layer"),G());t.on("mode."+n,function(t){z();if(t.mode==="draw"||t.mode==="erase"){r.display_foreground_event_layer(true);r.setActive(null)}else{r.display_foreground_event_layer(false)}});if(A&&typeof gmath.ui.Keyboard!=="undefined"&&typeof $!=="undefined"){p=gmath.ui.Keyboard();p.width(800).position("center").on("done",et).on("cancel",nt)()}r.container().on("dragover",function(){d3.event.preventDefault()}).on("drop",rt);r.on("mode",function(t){j(t.mode)});return this};function z(){window.getSelection().removeAllRanges()}var j=function(t){if(t==="transform"||t==="inspect"||t==="delete")L.mode("math");else if(t==="draw")L.mode("draw");else if(t==="erase")L.mode("erase");else throw"Unkown CanvasModel mode: '"+t+"'"};L.id=n;L.reporter=function(t){o=t;o.events.on("summary",this.addInteractionSummaryToTimeline.bind(this))};L.model=function(){if(arguments.length===0)return r};L.mode=function(t){if(arguments.length===0)return h;h=t;return this};L.use_keyboard=function(t){if(arguments.length===0)return A;A=t;return this};L.use_hold_menu=function(t){if(arguments.length===0)return S;S=t;if(S&&!C&&r.container()){C=new gmath.ui.holdUI(r.container(),L,r)}return this};L.color=function(t){if(arguments.length===0)return w;w=t;return this};L.markerRadius=function(t){if(arguments.length===0)return g;g=t;return this};L.eraserRadius=function(t){if(arguments.length===0)return v;v=t;return this};L.hwr_delay=function(t){if(arguments.length===0)return f;f=t;return this};L.tx_behavior=function(){return k};L.hwr=function(t){if(!arguments.length)return c;if(c===t)return L;c=t;m=r.paths.length;if(!c)L.cancelHWR();return L};L.drawing=function(t){if(!arguments.length)return d;d=t;return this};L.scheduleHWR=function(){if(!y){y=setTimeout(L.performHWR,f);e.start_hwr()}};L.cancelHWR=function(t){if(!t)m=r.paths.length;if(y){clearTimeout(y);y=null;e.stop_hwr()}};L.performHWR=function(){y=null;e.stop_hwr();if(m>r.paths().length-1)return;var t=r.paths().slice(m),n=false,o=[];gm_hwr_request(t,function(e,i){if(e)console.log(e);var a=t[0].points[0];try{n=r.createDL({pos:a,eq:i})}catch(s){return}var l=function(t){try{r.removePath(t);o.push(t)}catch(e){return}};for(var p=0;p<t.length;p++){l(t[p])}m=r.paths().length});m=r.paths().length};L.scroll=function(t){if(arguments.length===0)return x;x=Math.min(0,t);k.transform({translate:[0,x]});r.paths_container().attr("transform","translate(0,"+x+")");r.dls_container().attr("transform","translate(0,"+x+")");e.scroll(x);return this};L.clear_undo_queue=function(){lastActionIdx=-1;actionList=[]};L.font_smaller=function(){var t=parseInt(DerivationList.defaultOptions.font_size);if(t/1.2>12)this.set_font_size(t/1.2)};L.font_larger=function(){var t=parseInt(DerivationList.defaultOptions.font_size);if(t*1.2<160)this.set_font_size(t*1.2)};L.set_font_size=function(t){DerivationList.defaultOptions.font_size=t;r.dls().forEach(function(e){e.options.font_size=t;e.rows.forEach(function(e){e.view.options.font_size=t;e.view.update_all(true);e.updateHandlePos(true)});e.hideAllNodeMappings();e.layoutRows()});e.font_size(new I(t))};var q=function(t){return r.createPath({points:[[t[0],t[1]-x]],color:h==="draw"?w:"white",width:h==="draw"?2*g:2*v})};var P=function(t){this.type="hold";this.subType=t.subType;this.performee=n;this.performee_type="CanvasController";this.time=Date.now();this.finger={pos:[t.finger.pos[0],t.finger.pos[1]]};this.fingers=t.fingers.map(function(t){return{pos:[t.pos[0],t.pos[1]]}})};var O=function(t){this.type="touch";this.subType=t.subType;this.performee=n;this.performee_type="CanvasController";this.time=Date.now();this.finger={pos:[t.finger.pos[0],t.finger.pos[1]],pos0:[t.finger.pos0[0],t.finger.pos0[1]]};this.fingers=t.fingers.map(function(t){return{pos:[t.pos[0],t.pos[1]]}})};var B=function(t){this.type="drag";this.subType=t.subType;this.performee=n;this.performee_type="CanvasController";this.time=Date.now();this.finger={pos:[t.finger.pos[0],t.finger.pos[1]]};this.fingers=t.fingers.map(function(t){return{pos:[t.pos[0],t.pos[1]]}})};var F=function(t){this.type="release";this.subType=t.subType;this.performee=n;this.performee_type="CanvasController";this.time=Date.now();this.finger={pos:[t.finger.pos[0],t.finger.pos[1]]};this.fingers=t.fingers.map(function(t){return{pos:[t.pos[0],t.pos[1]]}})};var I=function(t){this.type="fontSize";this.performee=n;this.performee_type="CanvasController";this.time=Date.now();this.font_size=t};var R=function(t){this.type="enteredTerm";this.performee=n;this.performee_type="CanvasController";this.time=Date.now();this.eq=t.eq;this.dl_id=t.id;this.options=gmath.deepCopy(t)};var W=function(t){this.type="enteredGraph";this.performee=n;this.performee_type="CanvasController";this.time=Date.now();this.graph_id=t};var N=function(){this.type="keyboard";this.performee=n;this.performee_type="CanvasController";this.time=Date.now()};function H(t,e){t.call(e);e.frame(t.node())}function V(){var t=transform_behavior().allow_rotate(false).allow_scale(false).one_finger_drag(false).on("transform",function(){scroll(d3.event.transform.translate[1])});var e=mtouch_events().on("touch",U.bind(this,null)).on("hold",K.bind(this,null)).on("drag",J.bind(this,null)).on("tap",function(){r.setActive(null)}).on("release",Z.bind(this,null)).hold_max_dist(5).hold_time(500).call(t);return e}function G(){var t=transform_behavior().allow_rotate(false).allow_scale(false).one_finger_drag(false).on("transform",function(){scroll(d3.event.transform.translate[1])});var e=mtouch_events().on("touch",X.bind(this,null)).on("drag",Y.bind(this,null)).on("release",Q.bind(this,null)).hold_max_dist(5).hold_time(500).call(t);return e}var U=function(t){if(!S||D)return;var r=t||d3.event;if(!t&&d3.event){z();e["start-of-interaction"]({type:"start-of-interaction",source:"CanvasController",id:n,time:Date.now()});e.touch(new O(gmath.extend(d3.event,{subType:"menu"})))}if(r.fingers.length>1){D=true}};L.menu_touch=U;var K=function(t){if(!S||D)return;var n=t||d3.event;if(!t&&d3.event){e.hold(new P(gmath.extend(d3.event,{subType:"menu"})))}C.setPos(n.finger.pos.slice());C.setVisible(true)};L.menu_hold=K;var J=function(t){if(!S||D)return;var n=t||d3.event;if(!t&&d3.event){e.drag(new B(gmath.extend(d3.event,{subType:"menu"})))}if(C.visible){C.highlight(n.finger.pos.slice())}};L.menu_drag=J;var Z=function(t){var r=t||d3.event;if(!t&&d3.event){e.release(new F(gmath.extend(d3.event,{subType:"menu"})))}if(D){if(r.fingers.length===0)D=false;return}if(C&&C.visible){C.performAction(r.finger.pos.slice());C.setVisible(false)}if(!t&&d3.event&&!p.visible()){e["end-of-interaction"]({type:"end-of-interaction",source:"CanvasController",id:n,time:Date.now()})}};L.menu_release=Z;var X=function(t){var o=t||d3.event;if(!t&&d3.event){e["start-of-interaction"]({type:"start-of-interaction",source:"CanvasController",id:n,time:Date.now()});e.touch(new O(gmath.extend(d3.event,{subType:"draw"})))}if(o.fingers.length>1){D=true}if(!d||D)return;var i=o.finger.pos0.slice();i[1]-=x;L.cancelHWR(true);E=q(o.finger.pos0);if(h==="erase"){b=r.paths_container().append("circle").attr({cx:i[0],cy:i[1],r:v}).style({stroke:"silver",fill:"white"})}};L.draw_touch=X;var Y=function(t){var n=t||d3.event;if(!t&&d3.event){e.drag(new B(gmath.extend(d3.event,{subType:"draw"})))}if(!E||D||!d)return;var o=n.finger.pos.slice();o[1]-=x;E.points.push(o);r.updatePath(E);if(h==="erase")b.attr({cx:o[0],cy:o[1]})};L.draw_drag=Y;var Q=function(t){var r=t||d3.event;if(!t&&d3.event){e.release(new F(gmath.extend(d3.event,{subType:"draw"})))}if(D){if(r.fingers.length===0)D=false;return}if(!E)return;if(h==="draw"){if(c&&(!p||!p.visible()))L.scheduleHWR()}else if(h==="erase"){b.remove();tt()}E=null;if(!t&&d3.event){e["end-of-interaction"]({type:"end-of-interaction",source:"CanvasController",id:n,time:Date.now()})}};L.draw_release=Q;var tt=function(){var t=r.paths().slice(),e=t[t.length-1],n=[],o=[],i=[];t.forEach(function(t,a){if(t===e)return;var s=v+t.width/2;var l=gm_erase_paths([t.points],e.points,s);if(l.length===0){o.push(t);r.removePath(t)}else{i.push({path:t,points_before:t.points.slice(),points_after:l[0].slice()});t.points=l[0];r.updatePath(t);for(var p=1;p<l.length;p++){var u=r.createPath({points:l[p],color:t.color,width:t.width,oid:t.id});n.push(u)}}});r.removePath(e);eraseModification={removed:o,modified:i,added:n}};L.addInteractionSummaryToTimeline=function(t){var e=Timeline.entry(t,r);if(e){if(e.type==="erase"){e.modification=eraseModification;eraseModification=null}a++;i[a]=e;i.length=a+1}};L.undo=function(){if(a===-1)return false;o.setListening(false);var t=i[a];a--;t.undo(r,this);o.setListening(true);return true};L.redo=function(){if(i.length<=a+1)return false;o.setListening(false);a++;var t=i[a];t.redo(r,this);o.setListening(true);return true};L.inputDL=function(t){if(u)return;e.keyboard(new N);L.cancelHWR(true);T={pos:[t[0],t[1]-x]};p.caption(null).latex("").visible(true)};var et=function(t){if(!T)return;p.visible(false);if(t==="")return;T.eq=t;T.id=gmath.uid();e.entered_term(new R(T));var o;try{o=r.createDL(T)}catch(i){console.log(i)}finally{T=null}e["end-of-interaction"]({type:"end-of-interaction",source:"CanvasController",id:n,time:Date.now()})};var nt=function(){p.visible(false);e["end-of-interaction"]({type:"end-of-interaction",source:"CanvasController",id:n,time:Date.now()})};L.disableKeyboard=function(t){u=t};L.simulateStartOfInteraction=function(){e["start-of-interaction"]({type:"start-of-interaction",source:"CanvasController",id:n,time:Date.now()})};L.simulateEndOfInteraction=function(){e["end-of-interaction"]({type:"end-of-interaction",source:"CanvasController",id:n,time:Date.now()})};function rt(){var t=d3.event;t.preventDefault();var o=d3.mouse(svg.node());var i=ot(t.dataTransfer)||it(t.dataTransfer);if(!i){console.log("could not parse drop data",data);return}i=i.replace(/\\end{alignat}/g,"");i=i.replace(/\&\\\,/g,"");i=i.replace(/\\\,/g,"");i=i.replace(/\&/g,"");i=i.replace(/\\begin{alignat}{[0-9]*}/g,"");i=i.replace(/\\\;/g,"");i=i.replace(/[.,\s\\]+$/,"");var a=i.split("\\\\");if(i.length===0)return;try{e["start-of-interaction"]({type:"start-of-interaction",source:"CanvasController",id:n,time:Date.now()});r.createDLs(a,{pos:o,collapsed_mode:a.length>1},null,"drag-n-drop");e["end-of-interaction"]({type:"end-of-interaction",source:"CanvasController",id:n,time:Date.now()})}catch(s){console.log("Could not parse equation!",s)}}function ot(t){var e=t.getData("text/html");var n=document.createElement("div");var r=d3.select(n).html(e).select("img");return r.size()===1?r.attr("alt"):null}function it(t){return t.getData("text/plain")}return d3.rebind(L,e,"on")};return t}();gmath.ui=gmath.ui||{};gmath.ui.CanvasModelView=function(){var t=function(){var t=d3.dispatch("create","update","remove","reset","mode"),e=[],n=[],r,o=[],i=[],a=[],s=null,l=[],p=null,u,h,c,d,f,y,m,g,v=["transform","inspect","link","draw","erase","delete"],b=0;function w(t){t.dl.draw_mappings_for_nodes([t.node])}function _(t){return;var e=n.indexOf(t);if(e===-1||e===n.length-1)return;n.splice(n.indexOf(t),1);n.push(t);r=u.selectAll(".derivation-list").data(n,function(t){return t.id});r.order()}var k=function(t){p=t;h=p.append("g").attr("id","g_paths");f=p.append("rect").attr("id","background_event_layer").style({fill:"none","pointer-events":"all"}).attr("width","100%").attr("height","100%");c=p.append("g").attr("id","g_graphs");m=p.append("g").attr("id","g_textboxes");u=p.append("g").attr("id","g_dls");d=p.append("g").attr("id","g_links");y=p.append("rect").attr("id","foreground_event_layer").style({fill:"none","pointer-events":"all",display:"none"}).attr("width","100%").attr("height","100%");return this};k.setActive=function(t,e){if(arguments.length<2)e=true;if(t)t.setActive(e);n.forEach(function(e){if(e!==t)e.setActive(false)});a.forEach(function(e){if(e!==t)e.setActive(false)})};k.addDL=function(e){if(n.indexOf(e)!==-1)throw"dl is already in this model";e.canvas_model=k;e.container(u.node());e.setInteractionMode(v[b]);e.events.on("inspect_node",w);k.setActive(e);n.push(e);r=d3.selectAll(".derivation-list").data(n);e.events.on("hover",_);t.create({type:"create",target_type:"dl",target:e});return e};k.createDL=function(e,o,i){e.canvas_model=k;var a=new DerivationList(u.node(),e,o);a.setInteractionMode(v[b]);a.events.on("inspect_node",w);k.setActive(a);n.push(a);r=d3.selectAll(".derivation-list").data(n);a.events.on("hover",_);var s={type:"create",target_type:"dl",target:a};if(i)s.method=i;t.create(s);return a};k.createDLs=function(t,e,n,r){var o=0;i();function i(a){if(o===t.length){if(n)n()}else{if(a)e.pos[1]+=a.dims.height;var s=gmath.deepCopy(e);s.eq=t[o++];k.createDL(s,i,r)}}};k.removeDL=function(e){x(n,e);var r=gmath.LinkCoordinator.unlinkDL(e);l.push(e);e.remove();t.remove({type:"remove",target_type:"dl",target:e});return r};k.addPath=function(n){if(e.indexOf(n)!==-1)throw"path is already in this model";n.setContainer(h);n.init();e.push(n);t.create({type:"create",target_type:"path",target:n});return n};k.createPath=function(n,r){var o=new gmath.ui.Path(h.node(),n);e.push(o);var i={type:"create",target_type:"path",target:o};if(r)i.method=r;t.create(i);return o};k.updatePath=function(e){e.update();t.update({target_type:"path",target:e})};k.removePath=function(n){x(e,n);n.remove();t.remove({type:"remove",target_type:"path",target:n})};k.createGraph=function(e){e.view=k;var n=new gmath.ui.Graph(c.node(),e);o.push(n);t.create({type:"create",target_type:"graph",target:n});return n};k.removeGraph=function(e){x(o,e);e.remove();t.remove({type:"remove",target_type:"graph",target:e})};k.createLink=function(e,n){var r=(new gmath.ui.Link).a(e).b(n);r(d.node(),k);r.link();i.push(r);t.create({type:"create",target_type:"link",target:r});return r};k.createTextBox=function(e,n){e.view=k;var r=new gmath.ui.TextBox(m.node(),e);a.push(r);t.create({type:"create",target_type:"textbox",target:r,method:n});return r};k.addTextBox=function(e){e.view=k;e.init();a.push(e);t.create({type:"create",target_type:"textbox",target:e});return e};k.removeTextBox=function(e){if(a.length>0)x(a,e);e.remove();t.remove({type:"remove",target_type:"textbox",target:e})};var x=function(t,e){var n=t.indexOf(e);if(n===-1)throw"no element "+e;t.splice(n,1)};k.dls=function(e){if(!arguments.length)return n;for(var r=0;r<n.length;r++)n[r].remove();n=e.slice();for(var r=0;r<n.length;r++){n[r].container(u);n[r].init()}t.reset({target_type:"dl",target:n.slice()})};k.graphs=function(){return o};k.graphs=function(t){if(!arguments.length)return o};k.links=function(){return i};k.textboxes=function(){return a};k.getElementsOfType=function(t){if(t==="graph")return o;if(t==="dl")return n;if(t==="link")return i;if(t==="textboxes")return a};k.getElementByID=function(t){for(var r=0;r<n.length;r++){if(n[r].id===t)return n[r]}for(var r=0;r<e.length;r++){if(e[r].id===t)return e[r]}for(var r=0;r<a.length;r++){if(a[r].id===t)return a[r]}return null};k.getDeletedElementByID=function(t){for(var e=0;e<l.length;e++){if(l[e].id===t)return l[e]}return null};k.paths=function(n){if(!arguments.length)return e;for(var r=0;r<e.length;r++)e[r].remove();e=n.slice();for(var r=0;r<e.length;r++){e[r].setContainer(h);e[r].init()}t.reset({target_type:"path",target:e.slice()})};k.container=function(){return p};k.background_event_layer=function(t){if(!arguments.length)return f;f=t;return this};k.foreground_event_layer=function(t){if(!arguments.length)return y;y=t;return this};k.display_foreground_event_layer=function(t){if(!arguments.length||t)y.style({display:"inline"});else y.style({display:"none"})};k.dls_container=function(t){if(!arguments.length)return u;u=t;return this};k.paths_container=function(t){if(!arguments.length)return h;h=t;return this};k.graphs_container=function(t){if(!arguments.length)return c;c=t;return this};k.links_container=function(t){if(!arguments.length)return d;d=t;return this};k.textboxes_container=function(t){if(!arguments.length)return m;m=t;return this};k.size=function(){var t=p.node();while(t.tagName.toLowerCase()!=="svg"&&t.parentNode)t=t.parentNode;var e=t.getBoundingClientRect();return{width:e.width,height:e.height}};k.interactionMode=function(e){if(arguments.length===0)return v[b];if(e==="inspect"&&v[b]!=="inspect"||e!=="inspect"&&v[b]==="inspect"){k.updateStyleOfNodes(e)}b=v.indexOf(e);p.select("rect").style("fill",e==="delete"?"whitesmoke":"none");n.forEach(function(t){t.setInteractionMode(e)});o.forEach(function(t){t.setInteractionMode(e)});a.forEach(function(t){t.setInteractionMode(e)});t.mode({type:"mode",mode:e});return this};k.switchMode=function(){k.interactionMode(v[++b%v.length]);t.mode({type:"mode",mode:v[b]})};k.updateStyleOfNodes=function(t){var e=k.dls();e.forEach(function(e){e.rows.forEach(function(e){if(!e.view)return;if(t==="inspect"){e.view.options.visualize_scrubbable_nodes=true}else{e.view.options.visualize_scrubbable_nodes=false}e.view.update_existing("normal")})})};return d3.rebind(k,t,"on")};return t}();gmath.ui=gmath.ui||{};gmath.ui.CanvasFactory=function(){var t=function(e,n,r){this.container=d3.select(e);this.options=gmath.object.merged(gmath.deepCopy(!n.minimal?t.defaultOptions:t.minimalOptions),n);this.options.toolbar_container=this.options.toolbar_container?d3.select(this.options.toolbar_container):this.container;this.events=d3.dispatch("button");this.model=gmath.ui.CanvasModelView();this.controller=gmath.ui.CanvasController(this.model).drawing(this.options.drawing).hwr(this.options.hwr).use_keyboard(this.options.use_keyboard).use_hold_menu(this.options.use_hold_menu);this.init();if(!this.options.reporter_options)this.options.reporter_options={context:{context:"unknown",url:"unknown",user_id:"unknown"}};if(r&&this.options.loads_url){this.remove();gmath.CanvasSaver.loadSaveFile(this.container.node(),this.options.loads_url+"/"+r)}this.reporter=new CanvasEventReporter(this,this.options.reporter_options);this.controller.reporter(this.reporter)};gmath.ui.CanvasFactoryClass=t;t.prototype.serialize=function(){return JSON.stringify(this.model.dls().concat(this.model.graphs()))};t.prototype.trackEvent=function(t,e,n){if(this.options.analytics_tracking===true){ga("send",{hitType:"event",eventCategory:this.options.gm_app_name,eventAction:t,eventLabel:e,eventValue:n})}};t.prototype.setupAnalytics=function(t,e){if(this.options.analytics_tracking===true){ga("create","UA-68087505-1","auto");ga("set","checkProtocolTask",null);if("localStorage"in window&&localStorage["analytics"]==="no"){window["ga-disable-UA-68087505-1"]=true}else{window["ga-disable-UA-68087505-1"]=false;
}ga("send","event","load_canvas",document.location.href,{hitCallback:function(){}})}};t.prototype.init=function(){this.id=gmath.uid();var t=this;this.tools=this.options.toolbar_container.append("div").attr({"class":"btn-toolbar",role:"toolbar"}).style(this.options.toolbar_on_style).on("mouseenter",function(){if(t.toolFadeoutTimer)clearTimeout(t.toolFadeoutTimer)}).on("mouseleave",this.switchToolbarState.bind(this));if(this.options.drawing){this.options.mode_btns.splice(2,0,{type:"radio",group:"draw",state:false,label:"draw",icon:"glyphicon glyphicon-pencil"},{type:"radio",group:"draw",state:false,label:"erase",icon:"glyphicon glyphicon-erase"})}if(this.options.mode_btns)this.appendButtonGroup(this.options.mode_btns,this.onButton);if(this.options.reset_btn)this.appendButtonGroup([this.options.reset_btn],this.onButton);if(this.options.undo_btn||this.options.redo_btn){var e=[];if(this.options.undo_btn)e.push(this.options.undo_btn);if(this.options.redo_btn)e.push(this.options.redo_btn);this.appendButtonGroup(e,this.onButton)}if(this.options.font_smaller_btn&&this.options.font_larger_btn){var n=[];n.push(this.options.font_smaller_btn);n.push(this.options.font_larger_btn);this.appendButtonGroup(n,this.onButton)}if(this.options.help_btn){if(this.options.minimal)this.options.help_btn.pull_right=false;var r=[];r.push(this.options.help_btn);this.appendButtonGroup(r,this.onButton)}if(this.options.saving_and_loading){if(this.options.save_btn&&this.options.load_btn&&this.options.share_btn)this.appendButtonGroup([this.options.save_btn,this.options.load_btn,this.options.share_btn],this.onButton);else if(this.options.save_btn&&this.options.load_btn)this.appendButtonGroup([this.options.save_btn,this.options.load_btn],this.onButton)}if(this.options.feedback&&this.options.feedback_btn){this.appendButtonGroup([this.options.feedback_btn],this.onButton)}if(this.options.minimal){this.tools.classed("btn-toolbar-minimal",true);var o=this.tools.append("div").attr("class","btn-group pull-right").style({"line-height":"26px","margin-left":"40px"});o.append("span").text("powered by").style({"font-style":"italic","font-family":"sans-serif",color:"#909090","font-weight":300,"font-size":"13px"});var i=o.append("a").style({"text-decoration":"none"}).attr({href:"http://graspablemath.com",target:"_blank"});i.append("img").attr({alt:"GM",src:this.options.logo_src}).style({"vertical-align":"-0.3em",height:"1.7em","margin-left":"0.8em","margin-right":"0.2em","font-size":"13px"})}var a=this.tools.node().getBoundingClientRect().height;if(a===0)a={xs:46,sm:64}[this.options.btn_size]||72;this.svg=this.options.toolbar_pos==="top"?this.container.append("svg"):this.container.insert("svg","div.btn-toolbar");this.svg.style("width",this.options.width).style("height","calc("+this.options.height+" - "+(a+10)+"px)");this.svgg=this.svg.append("g");this.svgg.call(this.model).call(this.controller)};t.prototype.focusOnDL=function(t){if(!this.options.minimal)return;var e=this;this.svg.style("overflow","visible");if(t.dims.width)this.resize(t.dims);this.switchToolbarState(false,true);t.events.on("hover",function(n){if(!t.coordinator.dls.some(function(t){return t.interactionMode==="link"}))e.switchToolbarState(n)});var n=this;t.events.on("resize",function(e){n.resize(e);t.forceIntoContainer(false)});t.dl_events.on("touch",function(t){if(t.type==="Touch")e.switchToolbarState(!e.toolbarOn,true)});t.row_events.on("touch",function(){e.switchToolbarState(!e.toolbarOn,true)});t.row_events.on("drag",function(){if(t.interactionMode!=="pack"&&t.interactionMode!=="undecided"){e.switchToolbarState(false,true)}})};t.prototype.switchToolbarState=function(t,e){var n=this;if(n.toolFadeoutTimer)clearTimeout(n.toolFadeoutTimer);if(t)n.turnOnToolbar();else{if(e)n.turnOffToolbar();else{n.toolFadeoutTimer=setTimeout(function(){n.turnOffToolbar()},n.options.toolFadeoutDelay)}}};t.prototype.turnOnToolbar=function(){this.tools.style(this.options.toolbar_on_style);this.toolbarOn=true};t.prototype.turnOffToolbar=function(){this.tools.style(this.options.toolbar_off_style);this.toolbarOn=false};t.prototype.resize=function(t){this.options.width=t.width;this.options.height=t.height;this.svg.style({width:this.options.width,height:this.options.height})};t.prototype.onButton=function(t){var e={mode:this.model.interactionMode()==="inspect"?"scrub":this.model.interactionMode(),font_size:DerivationList.defaultOptions.font_size};this.updateButton(t);if(t.label==="reset"){this.trackEvent("button press","reset",1);while(this.controller.undo()){}}if(t.label==="undo"){this.controller.undo();this.trackEvent("button press","undo",1)}if(t.label==="redo"){this.trackEvent("button press","redo",1);this.controller.redo()}if(t.label==="HWR"){this.trackEvent("button press","HWR",1);this.controller.hwr(t.state)}if(t.label==="transform"){this.trackEvent("button press","transform",1);this.model.interactionMode("transform")}if(t.label==="scrub"){this.trackEvent("button press","scrub",1);this.model.interactionMode("inspect")}if(t.label==="delete"){this.trackEvent("button press","delete",1);this.model.interactionMode("delete")}if(t.label==="draw"){this.trackEvent("button press","draw",1);this.model.interactionMode("draw")}if(t.label==="erase"){this.trackEvent("button press","erase",1);this.model.interactionMode("erase")}if(t.label==="help"){this.trackEvent("button press","help",1);this.help()}if(t.label==="feedback"){this.trackEvent("button press","feedback",1);this.sendFeedback()}if(t.label==="fullscreen"&&t.state===true){this.trackEvent("button press","start fullscreen",1);this.launchFullScreen()}if(t.label==="fullscreen"&&t.state===false){this.trackEvent("button press","stop fullscreen",1);this.cancelFullScreen()}if(!(t.label==="HWR"&&t.state===true)&&this.options.hwr===true){this.trackEvent("button press","cancel HWR",1);this.controller.cancelHWR()}if(t.label==="larger"){this.trackEvent("button press","font larger",1);this.controller.font_larger()}if(t.label==="smaller"){this.trackEvent("button press","font smaller",1);this.controller.font_smaller()}if(t.label==="save"){gmath.CanvasSaver.save(this)}if(t.label==="load"){this.remove();gmath.CanvasSaver.load(this.container.node())}if(t.label==="share"&&!this.publishing){this.publishConfirmation()}var n={button:{label:t.label,state:t.state,type:t.type},old_state:e,time:Date.now()};if(n.button.label==="larger"||n.button.label==="smaller")n.button.font_size=DerivationList.defaultOptions.font_size;this.events.button(n)};t.prototype.publishConfirmation=function(){this.publishing=true;var t=this;var e=this.options.toolbar_container.append("div").classed("panel panel-default",true).style({width:"500px",display:"inline-block",position:"absolute","margin-left":"-520px","margin-top":"20px"});var n=e.append("div").classed("panel-body",true);n.append("h3").text("Share your math!");n.append("p").text('Click the "Publish" button to save your work on the Graspable Math server.'+"  We'll give you a key so you or anyone else can get a copy.");n.append("button").property("type","button").classed("btn btn-default",true).classed("pull-right",true).text("Cancel").on("click",function(){e.remove();t.publishing=false});n.append("button").property("type","button").classed("btn btn-primary",true).text("Publish").on("click",function(){n.remove();var r=gmath.CanvasSaver.share(t.options.saves_url,t);n=e.append("div").classed("panel-body",true);n.append("h3").text("Here is your link:");n.append("div").classed("share_link",true).append("input").attr({type:"text",readonly:"readonly"}).on("click",function(){this.select();this.setSelectionRange(0,this.value.length)}).node().value=location.origin+location.pathname+"?load="+r;n.append("p").text("Keep this link for yourself or share it with others. It will always "+"point to the canvas as it is right now. Click the share button again if you "+"want to create a new link to an updated version.");n.append("button").property("type","button").classed("btn btn-primary",true).text("Done").on("click",function(){e.remove();t.publishing=false})})};t.prototype.launchFullScreen=function(t){t=t||document.body;if(t.requestFullscreen)t.requestFullscreen();else if(t.mozRequestFullScreen)t.mozRequestFullScreen();else if(t.webkitRequestFullscreen)t.webkitRequestFullscreen();else if(t.msRequestFullscreen)t.msRequestFullscreen()};t.prototype.help=function(){var t=window.open("http://graspablemath.com/unstable/tutorial/index.html","_blank");t.focus()};t.prototype.sendFeedback=function(){var t=window.open("mailto:graspablemath@gmail.com","_blank");t.focus()};t.prototype.cancelFullScreen=function(){if(document.exitFullscreen)document.exitFullscreen();else if(document.mozCancelFullScreen)document.mozCancelFullScreen();else if(document.webkitExitFullscreen)document.webkitExitFullscreen();else if(document.msExitFullscreen)document.msExitFullscreen()};t.prototype.updateButton=function(t){this.tools.select("button#"+t.label).datum(t).each(function(t){if(t.type==="toggle"){t.state=!t.state;d3.select(this).classed("active",t.state)}else if(t.type==="radio"){var e=this;d3.select(this.parentNode).selectAll("button").each(function(t){t.state=e===this}).classed("active",function(t){return t.state})}})};t.prototype.appendButtonElement=function(t,e){var n=this;var r=t.append("button").attr("id",function(t){return t.label}).attr({type:"button","class":"btn btn-default"}).classed("btn-xs",n.options.btn_size==="xs").classed("btn-sm",n.options.btn_size==="sm").classed("active",function(t){return t.state}).style("min-width","4em");if(e)r.on("click",e.bind(this));if(this.options.display_icons){var o=r.filter(function(t){return t.icon});o.append("i").attr("class",function(t){return t.icon}).style({color:"#555","font-size":"1.2em","line-height":"1.7em"}).style("transform",function(t){return t.flip==="x"?"rotateX(180deg)":t.flip==="y"?"rotateY(180deg)":t.flip==="xy"?"rotateZ(180deg)":null});o.append("br")}if(this.options.display_labels){r.append("span").text(function(t){return t.label}).style("color","#555")}};t.prototype.appendButtonGroup=function(t,e){var n=this.tools.append("div").attr({"class":"btn-group",role:t[0].group}).classed("pull-right",t[0].pull_right).selectAll("button").data(t);n.enter().call(this.appendButtonElement.bind(this),e);return n};t.prototype.remove=function(){this.tools.remove();this.svg.remove()};t.minimalOptions={width:"100%",height:"100%",toolbar_pos:"top",reset_btn:{type:"push",label:"reset",icon:"glyphicon glyphicon-refresh"},undo_btn:{type:"push",label:"undo",icon:"glyphicon glyphicon-chevron-left"},redo_btn:{type:"push",label:"redo",icon:"glyphicon glyphicon-chevron-right"},help_btn:{type:"push",label:"help",pull_right:true,icon:"glyphicon glyphicon-question-sign"},use_keyboard:false,use_hold_menu:false,drawing:false,display_icons:true,display_labels:false,btn_size:"xs",toolbar_on_style:{display:"inline-block",position:"absolute","margin-top":"-30px",padding:"5px","padding-right":"10px",background:"rgba(255, 255, 255, 0.901961)","border-radius":"3px"},toolbar_off_style:{display:"none"},toolFadeoutDelay:500,logo_src:"../shared/imgs/gm-logo.png"};t.defaultOptions={width:"100%",height:"100%",toolbar_pos:"top",undo_btn:{type:"push",label:"undo",icon:"glyphicon glyphicon-chevron-left"},redo_btn:{type:"push",label:"redo",icon:"glyphicon glyphicon-chevron-right"},font_smaller_btn:{type:"push",label:"smaller",icon:"glyphicon glyphicon-text-size",flip:"y"},font_larger_btn:{type:"push",label:"larger",icon:"glyphicon glyphicon-text-size"},help_btn:{type:"push",label:"help",pull_right:true,icon:"glyphicon glyphicon-question-sign"},hwr_btn:{type:"toggle",label:"HWR",pull_right:true,state:true,icon:"glyphicon glyphicon-font"},fullscreen_btn:{type:"toggle",label:"fullscreen",pull_right:true,state:false,icon:"glyphicon glyphicon-resize-full"},hwr:false,feedback_btn:{type:"push",label:"feedback",pull_right:true,icon:"glyphicon glyphicon-envelope"},feedback:false,analytics_tracking:true,gm_app_name:"not defined",use_keyboard:true,use_hold_menu:true,drawing:true,display_icons:true,display_labels:true,btn_size:"sm",mode_btns:[{type:"radio",group:"mode",state:true,label:"transform",icon:"glyphicon glyphicon-random"},{type:"radio",group:"mode",state:false,label:"scrub",icon:"glyphicon glyphicon-resize-vertical"},{type:"radio",group:"mode",state:false,label:"delete",icon:"glyphicon glyphicon-trash"}],toolbar_on_style:{"margin-bottom":"10px"},toolbar_off_style:{"margin-bottom":"10px"},toolFadeoutDelay:0,reporter_options:{context:{context:"unknown",url:"unknown",user_id:"unknown"}},save_btn:{type:"push",label:"save",pull_right:true,icon:"glyphicon glyphicon-save"},load_btn:{type:"push",label:"load",pull_right:true,icon:"glyphicon glyphicon-open"},saves_url:"http://127.0.0.1:7010/saves/test_saves_folder",loads_url:"http://127.0.0.1:7010/api/saves/test_saves_folder",share_btn:{type:"push",label:"share",pull_right:true,icon:"glyphicon glyphicon-send"},saving_and_loading:true};return t}();gmath.ui=gmath.ui||{};gmath.ui.Keyboard=function(){var t=null;var e=function(){var t=function(){var t="m -5.708,-15.7 20.344,0 c 3.669696,0 6.624,2.954304 6.624,6.624 l 0,17.752 c 0,3.669696 -2.954304,6.624 -6.624,6.624 l -20.488,0 -15.408,-15.48 zM -2.18,-6.948 11.716,6.948M -2.18,6.948 11.716,-6.948";var e="M 13.7,16.5 -13.7,16.5 0,-16.5 z";var n=d3.dispatch("done","cancel","change"),r="",o=false,i,a,s=null,l=null,p=null,u=900,h,c,d,f,y,m,g,v=false,b,w="center",_=null;var k=function(){T();b=mtouch_events().on("touch",j).on("release",O).on("hold",B).hold_time(750);A();L();if(r!="")i.mathquill("write",r);return this};function x(t){n[t](i.mathquill("latex"))}k.width=function(t){if(arguments.length==0)return u;u=t;if(s)L();return this};k.latex=function(t){if(arguments.length==0){if(i)r=i.mathquill("latex");return r}else{r=t;if(i)i.mathquill("latex",t);return this}};k.visible=function(t){if(arguments.length==0)return o;if(o==t)return this;o=t;if(!s)return this;if(o){s.style("display","block");a.focus()}else s.style("display","none");return this};k.position=function(t){if(arguments.length==0)return w;if(w==t)return this;w=t;if(!s)return this;s.call(W,w);return this};k.caption=function(t){if(arguments.length===0)return _;_=t;if(!p)return this;if(!_)p.style("display","none");else{p.text(t);p.style("display",null)}return this};var E=function(){var t=[],e=[];y.forEach(function(n){e.push(n.row);t.push(n.col)});m=Math.max.apply(null,t);g=Math.max.apply(null,e);var n=(m+1)*130+m*10+2*10+2*10,r=(g+1)*110+10+10*(g-1)+2*10+2*10,o=u/n;c=130*o;f=10*o;d=110*o;h=r*o};var T=function(){y=[];y.keyboard="num";y.formula={type:"formula",col:2,row:0,cols:6};y.push({name:"Cancel",type:"event",event:"cancel",col:0,row:0,cols:2});y.push({type:"backspace",col:8,row:0});y.push({name:"Done",type:"event",event:"done",col:9,row:0,cols:2});y.push({name:"7",type:"key",col:0,row:1});y.push({name:"8",type:"key",col:1,row:1});y.push({name:"9",type:"key",col:2,row:1});y.push({name:"4",type:"key",col:0,row:2});y.push({name:"5",type:"key",col:1,row:2});y.push({name:"6",type:"key",col:2,row:2});y.push({name:"1",type:"key",col:0,row:3});y.push({name:"2",type:"key",col:1,row:3});y.push({name:"3",type:"key",col:2,row:3});y.push({name:"0",type:"key",col:3,row:3});y.push({name:"1aα",type:"next_kbd",col:11,row:0});y.push({type:"arrow",dir:"left",col:9,row:3,cols:1,rows:.5});y.push({type:"arrow",dir:"up",col:10,row:2.5,cols:1,rows:.5});y.push({type:"arrow",dir:"down",col:10,row:3,cols:1,rows:.5});y.push({type:"arrow",dir:"right",col:11,row:3,cols:1,rows:.5});y.push({name:"+",type:"key",col:4.5,row:1});y.push({name:"−",type:"key",val:"-",col:5.5,row:1});y.push({name:"*",type:"key",val:"*",col:4.5,row:2,dy:"0.3em"});y.push({name:"÷",type:"key",val:"/",col:5.5,row:2});y.push({name:"(",type:"key",col:4.5,row:3});y.push({name:")",type:"key",col:5.5,row:3});y.push({name:"^",type:"key",col:8,row:1});y.push({name:"=",type:"key",col:8,row:3});y.push({name:",",type:"key",col:7,row:1});y.push({name:".",type:"key",col:3,row:2});y.push({name:"x",type:"key",col:7,row:2});y.push({name:"y",type:"key",col:8,row:2});y.push({name:"_",type:"key",col:7,row:3})};var D=function(){y=[];y.keyboard="alpha";y.formula={type:"formula",col:2,row:0,cols:6};y.push({name:"Cancel",type:"event",event:"cancel",col:0,row:0,cols:2});y.push({type:"backspace",col:8,row:0});y.push({name:"Done",type:"event",event:"done",col:9,row:0,cols:2});y.push({name:"q",type:"key",col:0,row:1});y.push({name:"w",type:"key",col:1,row:1});y.push({name:"e",type:"key",col:2,row:1});y.push({name:"r",type:"key",col:3,row:1});y.push({name:"t",type:"key",col:4,row:1});y.push({name:"y",type:"key",col:5,row:1});y.push({name:"u",type:"key",col:6,row:1});y.push({name:"i",type:"key",col:7,row:1});y.push({name:"o",type:"key",col:8,row:1});y.push({name:"p",type:"key",col:9,row:1});y.push({name:"a",type:"key",col:.3,row:2});y.push({name:"s",type:"key",col:1.3,row:2});y.push({name:"d",type:"key",col:2.3,row:2});y.push({name:"f",type:"key",col:3.3,row:2});y.push({name:"g",type:"key",col:4.3,row:2});y.push({name:"h",type:"key",col:5.3,row:2});y.push({name:"j",type:"key",col:6.3,row:2});y.push({name:"k",type:"key",col:7.3,row:2});y.push({name:"l",type:"key",col:8.3,row:2});y.push({name:"z",type:"key",col:.6,row:3});y.push({name:"x",type:"key",col:1.6,row:3});y.push({name:"c",type:"key",col:2.6,row:3});y.push({name:"v",type:"key",col:3.6,row:3});y.push({name:"b",type:"key",col:4.6,row:3});y.push({name:"n",type:"key",col:5.6,row:3});y.push({name:"m",type:"key",col:6.6,row:3});y.push({name:"^",type:"key",col:9.3,row:2,cols:.6});y.push({name:"1aα",type:"next_kbd",col:11,row:0});y.push({name:"+",type:"key",col:10,row:1});y.push({name:"-",type:"key",col:11,row:1});y.push({name:"*",type:"key",col:10,row:2,val:"*",dy:"0.3em"});y.push({name:"/",type:"key",col:11,row:2});y.push({name:"=",type:"key",col:11,row:3});y.push({name:"(",type:"key",col:9,row:3});y.push({name:")",type:"key",col:10,row:3});y.push({name:"_",type:"key",col:0,row:3,cols:.6});y.push({name:"shift",type:"shift",col:7.6,row:3,cols:1.25})};var C=function(){y=[];y.keyboard="function";y.formula={type:"formula",col:2,row:0,cols:6};y.push({name:"Cancel",type:"event",event:"cancel",col:0,row:0,cols:2});y.push({type:"backspace",col:8,row:0});y.push({name:"Done",type:"event",event:"done",col:9,row:0,cols:2});y.push({name:"",type:"key",col:0,row:1});y.push({name:"",type:"key",col:1,row:1});y.push({name:"",type:"key",col:2,row:1});y.push({name:"",type:"key",col:3,row:1});y.push({name:"",type:"key",col:4,row:1});y.push({name:"",type:"key",col:5,row:1});y.push({name:"",type:"key",col:6,row:1});y.push({name:"",type:"key",col:7,row:1});y.push({name:"",type:"key",col:8,row:1});y.push({name:"",type:"key",col:0,row:2});y.push({name:"",type:"key",col:1,row:2});y.push({name:"",type:"key",col:2,row:2});y.push({name:"",type:"key",col:3,row:2});y.push({name:"shift",type:"shift",col:9,row:1,cols:1.5});y.push({name:"",type:"key",val:"-",col:5,row:2});y.push({name:"",type:"key",val:"/",col:6,row:2});y.push({name:"",type:"key",col:7,row:2});y.push({type:"arrow",dir:"left",col:8,row:2,cols:1,rows:.5});y.push({type:"arrow",dir:"up",col:9,row:1.5,cols:1,rows:.5});y.push({type:"arrow",dir:"down",col:9,row:2,cols:1,rows:.5});y.push({type:"arrow",dir:"right",col:10,row:2,cols:1,rows:.5});y.push({name:"1aα",type:"next_kbd",col:11,row:0})};var M=function(){y=[];y.keyboard="greek";y.formula={type:"formula",col:2,row:0,cols:6};y.push({name:"Cancel",type:"event",event:"cancel",col:0,row:0,cols:2});y.push({type:"backspace",col:8,row:0});y.push({name:"Done",type:"event",event:"done",col:9,row:0,cols:2});y.push({name:"α",type:"key",col:0,row:1});y.push({name:"β",type:"key",col:1,row:1});y.push({name:"γ",type:"key",col:2,row:1});y.push({name:"δ",type:"key",col:3,row:1});y.push({name:"ε",type:"key",col:4,row:1});y.push({name:"ζ",type:"key",col:5,row:1});y.push({name:"η",type:"key",col:6,row:1});y.push({name:"θ",type:"key",col:7,row:1});y.push({name:"ι",type:"key",col:8,row:1});y.push({name:"κ",type:"key",col:0,row:2});y.push({name:"λ",type:"key",col:1,row:2});y.push({name:"μ",type:"key",col:2,row:2});y.push({name:"ν",type:"key",col:3,row:2});y.push({name:"ξ",type:"key",col:4,row:2});y.push({name:"ο",type:"key",col:5,row:2});y.push({name:"π",type:"key",col:6,row:2});y.push({name:"ρ",type:"key",col:7,row:2});y.push({name:"σ",type:"key",col:0,row:3});y.push({name:"τ",type:"key",col:1,row:3});y.push({name:"υ",type:"key",col:2,row:3});y.push({name:"φ",type:"key",col:3,row:3});y.push({name:"χ",type:"key",col:4,row:3});y.push({name:"ψ",type:"key",col:5,row:3});y.push({name:"ω",type:"key",col:6,row:3});y.push({name:"shift",type:"shift",col:7,row:3,cols:1.5});y.push({name:"+",type:"key",col:9,row:1});y.push({name:"-",type:"key",col:10,row:1});y.push({name:"*",type:"key",col:9,row:2,val:"*",dy:"0.3em"});y.push({name:"/",type:"key",col:10,row:2});y.push({name:"=",type:"key",col:11,row:3});y.push({name:"^",type:"key",col:8,row:2});y.push({name:"(",type:"key",col:9,row:3});y.push({name:")",type:"key",col:10,row:3});y.push({name:"1aα",type:"next_kbd",col:11,row:0})};var A=function(){s=d3.select("body").append("div").style({position:"fixed",bottom:0,"z-index":1e4}).style("display",o?"block":"none");p=s.append("div").attr("id","caption").style({position:"relative",background:"rgb(244, 244, 244)",padding:"12px",border:"1px solid silver","border-radius":"7.6px 7.6px 0 0","border-bottom":"none",width:"80%",margin:"auto","font-family":"HelveticaNeue-Light",color:"#666","font-size":"17px","text-align":"center",display:_?null:"none"}).text(_);l=s.append("div").classed("keyboard",true);i=l.append("div").attr("id","formula").datum(y.formula).append("div").attr("id","mq_div").append("span").attr("id","mq_span");i=$(i.node()).mathquill("editable");a=i.find("textarea");if(o)a.focus();d3.select(a[0]).on("keyup",function(){if(d3.event.keyCode===13)x("done")});z();var t=l.selectAll(".key").data(y).enter().append("div").classed("key",true).call(b);t.filter(function(t){return t.type=="backspace"}).classed("backspace-key",true).append("svg").append("path");t.filter(function(t){return t.type=="arrow"}).classed("arrow-key",true).append("svg").append("path");t.filter(function(t){return t.name}).classed("normal-key",true).append("span")};var S=function(){l.selectAll(".key").remove();l.select("#formula").datum(y.formula);var t=l.selectAll(".key").data(y).enter().append("div").classed("key",true).call(b);t.filter(function(t){return t.type=="backspace"}).classed("backspace-key",true).append("svg").append("path");t.filter(function(t){return t.type=="arrow"}).classed("arrow-key",true).append("svg").append("path");t.filter(function(t){return t.name}).classed("normal-key",true).append("span")};var L=function(){E();s.call(W,w);l.style("height",h+"px").style("width",u+"px").style({bottom:0,background:"#DDD",padding:0,"text-align":"center",border:"1px solid silver","border-radius":f*1.5+"px "+f*1.5+"px 0 0","border-bottom":"none"}).select("#formula").style("border",f+"px solid #DDD").style("border-radius",f+"px").call(F,f).select("#mq_div").style("border-radius",f+"px").style("width",function(t){return(t.cols||1)*c+((t.cols||1)-1)*f+"px"}).call(R).select("#mq_span").style("box-shadow","none").style("-webkit-box-shadow","none").style("-moz-box-shadow","none").style("margin-top",f).style("font-size",d/2+d/10+"px").style("padding-top",3*f-2+"px").style("padding-bottom",2*f+"px").style("border","none").style("min-height",function(t){return(t.rows||1)*d+((t.rows||1)-1)*f-5*f+"px"}).style("width","100%");l.selectAll(".key").call(F).call(I).call(R);l.selectAll(".backspace-key path").attr("d",t).style("stroke","black").style("stroke-width","1.2").style("fill","none").attr("transform","translate("+c/2+","+d/2+")scale("+.12*f+")");l.selectAll(".arrow-key path").attr("d",e).style("stroke","black").style("stroke-linejoin","round").style("stroke-width",3).style("fill","none").attr("transform",function(t){var e={left:-90,up:0,right:90,down:180}[t.dir];return"translate("+c/2+","+d/4+")scale("+.05*f+")rotate("+e+")"});l.selectAll(".normal-key span").text(function(t){return t.name}).style("line-height",d+"px").filter(function(t){return t.dy}).style("display","inline-block").style("margin-top",function(t){return t.dy})};var z=function(){if(/iPhone|iPod|iPad|Android|BlackBerry/.test(navigator.userAgent))l.select(".textarea textarea").attr("readonly","readonly")};var j=function(t){d3.select(this).style("background","gray");if(t.type==="formula")return;a.focus();if(t.type==="next_kbd"){q()}else if(t.type==="shift"){P(t)}else if(t.type==="key"){var e=t.val||t.name;if(v)e=e.toUpperCase();var n=e.charCodeAt(0);a.val(e);a.trigger($.Event("keydown",{which:n}));a.trigger($.Event("keypress",{which:n}));x("change")}else if(t.type==="backspace"){a.trigger($.Event("keydown",{which:8}));x("change")}else if(t.type==="event"){x(t.event)}else if(t.type==="arrow"){var n={left:37,up:38,right:39,down:40}[t.dir];a.trigger($.Event("keydown",{which:n}));x("change")}};var q=function(){v=false;if(y.keyboard==="num"){D()}else if(y.keyboard==="alpha"){M()}else if(y.keyboard==="greek"){T()}S();L()};var P=function(t){v=!v;l.selectAll(".key span").text(function(t){if(t.type==="key"){if(v)return t.name.toUpperCase();else return t.name.toLowerCase()}else{return t.name}})};var O=function(t){if(t.type!=="shift"||!v)d3.select(this).style("background",t.type=="key"||t.type=="formula"?"white":"silver")};var B=function(t){if(t.type!=="backspace")return;i.mathquill("latex","");a.focus()};var F=function(t,e){e=e||0;t.style("position","absolute").style("left",function(t){return t.col*(c+f)+2*f-e+"px"}).style("bottom",function(t){return(g-t.row)*(d+f)+(t.row==0?0:0)+2*f-e+"px"})};var I=function(t,e,n){e=e||0;n=n||0;t.style("width",function(t){return(t.cols||1)*c+((t.cols||1)-1)*f-2*e+"px"}).style("height",function(t){return(t.rows||1)*d+((t.rows||1)-1)*f-2*n+"px"})};var R=function(t){t.style("border-radius",f+"px").style("font-size",d/2+"px").style("background",function(t){return t.type=="key"||t.type=="formula"?"white":"silver"}).style("box-shadow","#888 0px 1px 0px").style("font-family","'HelveticaNeue-UltraLight', 'Helvetica Neue UltraLight', 'Helvetica Neue', Arial, Helvetica, sans-serif").style("font-weight",100).style("border","none").style("padding",0).style("-webkit-user-select","none").style("-khtml-user-select","none").style("-moz-user-select","none").style("-ms-user-select","none").style("user-select","none").style("cursor","pointer")};var W=function(t,e){if(e==="center"){t.style("margin-left",-u/2+"px");t.style("left","50%");t.style("right",null)}else if(e==="left"){t.style("margin-left",0);t.style("left",0);t.style("right",null)}else if(e==="right"){t.style("margin-left",0);t.style("left",null);t.style("right",0)}else{t.style("margin-left",-u/2+"px");t.style("left",e);t.style("right",null)}};return d3.rebind(k,n,"on")};return t};return function(){return t||(t=e()())}}();gmath.ui=gmath.ui||{};gmath.ui.TutorialPair=function(){var t=function(t,e){this.events=d3.dispatch("done","retry","next");this.gestureData=e.gestureData;if(this.gestureData)this.gestureData.options.show_bg=false;this.eq=e.eq;this.correctAnswers=e.correctAnswers;this.extraExamples=e.extraExamples;this.currentExtra=0;this.title=e.title;this.text=e.text;this.startWiggle=e.startWiggle;this.doNotWiggle=false;this.container=d3.select(t);this.dl_div=null;this.dl=null;this.play_btn=gmath.svg_play_button();this.player=null;this.allow_restart_after_done=true;this.answered=false;if("allow_restart_after_done"in e)this.allow_restart_after_done=e.allow_restart_after_done;this.init()};t.prototype.replay=function(){this.play_btn.hidden(true);var t=this;t.player.replay(500,function(){setTimeout(function(){t.play_btn.hidden(false);if(!t.answered){t.dl_div.append("span").text("Try it!").classed("tryit",true);if(t.startWiggle&&!t.doNotWiggle)t.dl.startWiggle(t.startWiggle);t.dl_div.on("mousedown",function(){var e=new Date;t.startTime=e.getTime();t.dl_div.select("span.tryit").remove();t.dl_div.on("mousedown",null)})}},1e3)})};t.prototype.deactivateFutureWiggling=function(){this.doNotWiggle=true};t.prototype.init=function(){this.container.append("h2").text(this.title);this.container.append("p").attr("class","tutorial-instructions").text(this.text);var t=this.container.append("div").classed("tutorial",true);var e=t.append("div").attr("id","ex").classed("choice",true).append("svg").classed("animation",true);this.gestureData.options.pos=["auto","auto"];this.gestureData.options.draggable=false;this.player=new gmath.EventRecorder(this.gestureData,e.append("g").node());this.player.showPreview();e.call(this.play_btn.on("click",this.replay.bind(this)));if(this.eq){this.dl_div=t.append("div").classed("choice",true);var n=gmath.deepCopy(this.gestureData.options);n.inactive_color=gmath.AlgebraView.defaultOptions.inactive_color;n.color=gmath.AlgebraView.defaultOptions.color;this.dl=new gmath.DerivationList(this.dl_div.append("svg").attr({width:"100%",height:"100%"}).node(),n);this.dl.getLastRow().view.interaction_handler.events.on("touch",this.deactivateFutureWiggling.bind(this));this.dl.events.on("end-of-interaction",this.checkAnswer.bind(this));this.startTime=-1;var r=this}};t.prototype.chainTransition=function(t,e){if(t.node().__transition__&&t.id&&t.node().__transition__[t.id]){var n=t.node().__transition__[t.id];console.log("extra delay",n.delay+n.duration);e+=n.delay+n.duration}return t.transition().delay(e)};t.prototype.neutralTransition=function(t,e,n,r){t.selectAll("button").remove();t.select("span").remove();var o=this.chainTransition(t,e).duration(n||500);if(r)o.styleTween("background",function(){return d3.interpolate(r,"#EEEEEE")});else o.style("background","#eee");return o};t.prototype.wrongTransition=function(t,e,n,r){var o=d3.select(t.node());o.append("span").attr("class","feedback").style({opacity:1e-5}).text("✗");var i=this.chainTransition(t,e).duration(n||500);if(r)i.styleTween("background",function(){return d3.interpolate(r,"#E0A8A8")});else i.style("background","#E0A8A8");i.select(".feedback").style("opacity",1);return i};t.prototype.correctTransition=function(t,e,n,r){var o=this;var i=d3.select(t.node());i.append("span").attr("class","feedback").style({opacity:1e-5}).text("✓");i.append("button").text("do it again").style({top:"10px",opacity:1e-5}).on("click",function(){if(o.allow_restart_after_done)o.retry()});i.append("button").text("try another").style({top:"62px",opacity:1e-5}).on("click",function(){if(o.extraExamples.length>0)o.loadNextExample();else o.retry()});var a=this.chainTransition(t,e).duration(n||500);if(r)a.styleTween("background",function(){return d3.interpolate(r,"#A8E0B3")});else a.style("background","#A8E0B3");a.select(".feedback").style("opacity",1);a.selectAll("button").style("opacity",1);return a};t.prototype.checkAnswer=function(){var t=this,e=400;setTimeout(function(){t.dl.getLastView().interactive(false);var e=t.dl.getLastModel().to_ascii();console.log(e);var n=new Date;var r=-1;var o=-1;if(t.startTime!==-1)r=n.getTime()-t.startTime;if(t.eq===t.dl.getLastModel().to_ascii()){t.dl.getLastView().interactive(true);o="initial state"}else if(t.answerIsCorrect(e)){t.answered=true;o="correct";if(t.dl_div.selectAll("div").size()===2)return;t.correctTransition(t.dl_div,200,null,"#EEEEEE").each("end",t.events.done)}else{o="wrong";t.wrongTransition(t.dl_div,200,null,"#EEEEEE").transition().duration(500).each("end",t.retry.bind(t));t.doNotWiggle=false}ga("send",{hitType:"event",eventCategory:"tutorial",eventAction:o,eventLabel:t.eq,eventValue:r})},e)};t.prototype.answerIsCorrect=function(t){if(this.currentExtra===0){return this.correctAnswers.indexOf(t)!==-1}else{return this.extraExamples[this.currentExtra-1].correctAnswers.indexOf(t)!==-1}};t.prototype.loadNextExample=function(){var t=this;this.neutralTransition(this.dl_div,0,1).each("end",function(){t.dl.getLastView().interactive(true);if(t.currentExtra<t.extraExamples.length){t.dl.setExpression(t.extraExamples[++t.currentExtra-1].expression);t.doNotWiggle=true}else{
t.currentExtra=0;t.dl.setExpression(t.eq);t.doNotWiggle=false}t.events.next()})};t.prototype.retry=function(){var t=this;this.neutralTransition(this.dl_div,0,1).each("end",function(){t.dl.getLastView().interactive(true);t.dl.setExpression(t.currentExtra===0?t.eq:t.extraExamples[t.currentExtra-1].expression);t.events.retry()});this.answered=false;this.doNotWiggle=false};t.prototype.stop=function(){this.player.stop_animation()};return t}();gmath.ui=gmath.ui||{};gmath.ui.ProblemPair=function(){var t=function(t,e){this.events=d3.dispatch("done","reset");this.title=e.title;this.text=e.text;this.gestureData=e.gestureData;if(this.gestureData)this.gestureData.options.show_bg=false;this.eq=e.eq;this.correctAnswers=e.correctAnswers;this.startWiggle=e.startWiggle;this.doNotWiggle=false;this.container=d3.select(t);this.dl_div=null;this.dl=null;this.play_btn=gmath.svg_play_button();this.player=null;this.answered=false;this.allow_restart_after_done=true;if("allow_restart_after_done"in e)this.allow_restart_after_done=e.allow_restart_after_done;this.init()};t.prototype.replay=function(){this.play_btn.hidden(true);var t=this;t.player.replay(500,function(){setTimeout(function(){t.play_btn.hidden(false);if(!t.answered){t.dl_div.append("span").text("Try it!").classed("tryit",true);if(t.startWiggle&&!t.doNotWiggle)t.dl.startWiggle(t.startWiggle);t.dl_div.on("mousedown",function(){t.dl_div.select("span").remove();t.dl_div.on("mousedown",null)})}},1e3)})};t.prototype.deactivateFutureWiggling=function(){this.doNotWiggle=true};t.prototype.init=function(){this.container.append("h2").text(this.title);this.container.append("p").attr("class","tutorial-instructions").text(this.text);var t=this.container.append("div").classed("tutorial",true);var e=t.append("div").attr("id","ex").classed("largeChoice",true).append("svg").classed("animation",true);this.gestureData.options.pos=["auto","auto"];this.gestureData.options.draggable=false;this.player=new gmath.EventRecorder(this.gestureData,e.append("g").node());this.player.showPreview();e.call(this.play_btn.on("click",this.replay.bind(this)));if(this.eq){this.dl_div=t.append("div").classed("largeChoice",true);var n=gmath.deepCopy(this.gestureData.options);n.inactive_color=gmath.AlgebraView.defaultOptions.inactive_color;n.color=gmath.AlgebraView.defaultOptions.color;this.dl=new DerivationList(this.dl_div.append("svg").attr({width:"100%",height:"100%"}).node(),n);this.dl.getLastRow().view.interaction_handler.events.on("touch",this.deactivateFutureWiggling.bind(this));this.dl.events.on("end-of-interaction",this.checkAnswer.bind(this))}};t.prototype.chainTransition=function(t,e){if(t.node().__transition__&&t.id&&t.node().__transition__[t.id]){var n=t.node().__transition__[t.id];console.log("extra delay",n.delay+n.duration);e+=n.delay+n.duration}return t.transition().delay(e)};t.prototype.neutralTransition=function(t,e){var n=this.chainTransition(t,e).duration(500);n.style("background","#eee");n.select("span").remove();n.selectAll("div").remove();this.reset_btn=null;return n};t.prototype.wrongTransition=function(t,e){var n=this;if(!this.reset_btn){this.reset_btn=t.append("div").classed("smallLabel",true).classed("light",true).style("opacity",1e-5).append("button").text("reset").on("click",function(){n.reset()})}var r=this.chainTransition(t,e).duration(500);r.select("div").style("opacity",1);return r};t.prototype.correctTransition=function(t,e){var n=this;if(this.reset_btn){this.reset_btn.remove()}t.append("span").classed("smallLabel",true).text("good").style({opacity:1e-4,height:"50%","line-height":"110px"});t.append("div").classed("smallLabel",true).style({opacity:1e-4,height:"50%",top:"120px"}).append("button").text("reset").style({"margin-top":"40px"}).on("click",function(){n.reset()});var r=this.chainTransition(t,e).duration(500);r.style("background","#A8E0B3");r.select("span").style("opacity",1);r.selectAll("div").style("opacity",1);return r};t.prototype.checkAnswer=function(){this.dl.getLastView().interactive(false);var t=this.dl.getLastModel().to_ascii();if(this.eq===this.dl.getLastModel().to_ascii()){this.dl.getLastView().interactive(true)}else if(this.correctAnswers.indexOf(t)!==-1){this.answered=true;this.dl_div.select("span").text("good");this.correctTransition(this.dl_div,200).each("end",this.events.done)}else{this.wrongTransition(this.dl_div,200);this.dl.getLastView().interactive(true)}};t.prototype.reset=function(){var t=this;this.neutralTransition(this.dl_div,0).each("end",function(){t.dl.getLastView().interactive(true);t.dl.setExpression(t.eq);t.events.reset()});this.answered=false;this.doNotWiggle=false};t.prototype.stop=function(){this.player.stop_animation()};return t}();var Timeline={};Timeline.entryTypes={};Timeline.entry=function(t,e){t=t[0];for(var n in Timeline.entryTypes){var r=Timeline.entryTypes[n];if(r.prototype.match(t))return new r(t,e)}return null};var EntryType=function(t){this.type=t};EntryType.prototype.match=function(t){return this.type===t.type};var AlgebraEntry=function(t,e){EntryType.call(this,t.type);this.summary=t;this.object=e.getElementByID(this.summary.element.id)};gmath.inherit(EntryType,AlgebraEntry);AlgebraEntry.prototype.type="algebra";Timeline.entryTypes.AlgebraEntry=AlgebraEntry;AlgebraEntry.prototype.match=function(t){return this.type===t.type&&!t.targets};AlgebraEntry.prototype.undo=function(t){this.rows=[];this.packState=this.object.rows.map(function(t){return t.hidden?true:false});while(this.object.getLastRow().idx!==this.summary.element.subid){this.rows.push(this.object.undo())}};AlgebraEntry.prototype.redo=function(t){for(var e=this.rows.length-1;e>=0;e--){this.object.redo(this.rows[e])}for(var e=0;e<this.object.rows.length;e++){var n=this.object.rows[e];if(this.packState[e]&&!n.hidden)n.hide();else if(!this.packState[e]&&n.hidden)n.unhide()}this.object.layoutRows()};var SubstituteEntry=function(t,e){EntryType.call(this,t.type);this.summary=t;this.objects=[];for(var n=0;n<this.summary.targets.length;n++){this.objects.push({dl:e.getElementByID(this.summary.targets[n].id)})}};gmath.inherit(EntryType,SubstituteEntry);SubstituteEntry.prototype.type="algebra";Timeline.entryTypes.SubstituteEntry=SubstituteEntry;SubstituteEntry.prototype.match=function(t){return this.type===t.type&&t.targets};SubstituteEntry.prototype.undo=function(t){for(var e=0;e<this.objects.length;e++){var n=this.objects[e];n.rows=[];n.packState=n.dl.rows.map(function(t){return t.hidden?true:false});while(n.dl.getLastRow().idx!==this.summary.targets[e].subid){n.rows.push(n.dl.undo())}}};SubstituteEntry.prototype.redo=function(t){for(var e=0;e<this.objects.length;e++){var n=this.objects[e];for(var r=n.rows.length-1;r>=0;r--){n.dl.redo(n.rows[r])}for(var r=0;r<n.dl.rows.length;r++){var o=n.dl.rows[r];if(n.packState[r]&&!o.hidden)o.hide();else if(!n.packState[r]&&o.hidden)o.unhide()}n.dl.layoutRows()}};var CreateEntry=function(t,e){EntryType.call(this,t.type);this.summary=t;this.objects=[];for(var n=0;n<this.summary.targets.length;n++){this.objects.push(e.getElementByID(this.summary.targets[n].id))}};gmath.inherit(EntryType,CreateEntry);CreateEntry.prototype.type="create";Timeline.entryTypes.CreateEntry=CreateEntry;CreateEntry.prototype.match=function(t){return this.type===t.type&&t.targets.every(function(t){return t.type==="dl"||t.type==="textbox"})};CreateEntry.prototype.undo=function(t){for(var e=0;e<this.objects.length;e++){var n=this.summary.targets[e],r=this.objects[e];if(n.type==="dl")t.removeDL(r);if(n.type==="textbox")t.removeTextBox(r)}};CreateEntry.prototype.redo=function(t){for(var e=0;e<this.objects.length;e++){var n=this.summary.targets[e].type;if(n==="dl")t.addDL(this.objects[e]);if(n==="textbox")t.addTextBox(this.objects[e])}};var DeleteEntry=function(t,e){EntryType.call(this,t.type);this.summary=t;this.object=e.getDeletedElementByID(this.summary.element.id)};gmath.inherit(EntryType,DeleteEntry);DeleteEntry.prototype.type="delete";Timeline.entryTypes.Entry=DeleteEntry;DeleteEntry.prototype.match=function(t){return this.type===t.type&&(t.element.type==="dl"||t.element.type==="textbox")};DeleteEntry.prototype.undo=function(t){var e=this.summary.element.type;if(e==="dl")t.addDL(this.object);if(e==="textbox")t.addTextBox(this.object)};DeleteEntry.prototype.redo=function(t){var e=this.summary.element.type;if(e==="dl")t.removeDL(this.object);if(e==="textbox")t.removeTextBox(this.object)};var DrawEntry=function(t,e){EntryType.call(this,t.type);this.summary=t;this.object=e.getElementByID(this.summary.targets[0].id)};gmath.inherit(EntryType,DrawEntry);DrawEntry.prototype.type="draw";Timeline.entryTypes.DrawEntry=DrawEntry;DrawEntry.prototype.undo=function(t){t.removePath(this.object)};DrawEntry.prototype.redo=function(t){t.addPath(this.object)};var EraseEntry=function(t){EntryType.call(this,t.type);this.summary=t};gmath.inherit(EntryType,EraseEntry);EraseEntry.prototype.type="erase";Timeline.entryTypes.EraseEntry=EraseEntry;EraseEntry.prototype.match=function(t){return this.type===t.type};EraseEntry.prototype.undo=function(t){if(!this.modification){console.warn("erase modification was not set");return}this.modification.removed.forEach(function(e){t.addPath(e)});this.modification.added.forEach(function(e){t.removePath(e)});this.modification.modified.forEach(function(e){e.path.points=e.points_before;t.updatePath(e.path)})};EraseEntry.prototype.redo=function(t){this.modification.removed.forEach(function(e){t.removePath(e)});this.modification.modified.forEach(function(e){e.path.points=e.points_after;t.updatePath(e.path)});this.modification.added.forEach(function(e){t.addPath(e)})};var MoveEntry=function(t,e){EntryType.call(this,t.type);this.summary=t;this.object=e.getElementByID(this.summary.element.id)};gmath.inherit(EntryType,MoveEntry);MoveEntry.prototype.type="move";Timeline.entryTypes.MoveEntry=MoveEntry;MoveEntry.prototype.match=function(t){return this.type===t.type&&(t.element.type==="dl"||t.element.type==="textbox")};MoveEntry.prototype.undo=function(t){if(this.summary.element.type==="dl"){this.object.pos=[this.summary.element.old_state.x,this.summary.element.old_state.y];this.object.svgg.attr("transform","translate("+this.object.pos+")")}else{this.object.pos=this.summary.element.old_state;this.object.update()}};MoveEntry.prototype.redo=function(t){if(this.summary.element.type==="dl"){this.object.pos=[this.summary.element.new_state.x,this.summary.element.new_state.y];this.object.svgg.attr("transform","translate("+this.object.pos+")")}else{this.object.pos=this.summary.element.new_state;this.object.update()}};var FontSizeEntry=function(t){EntryType.call(this,t.type);this.summary=t};gmath.inherit(EntryType,FontSizeEntry);FontSizeEntry.prototype.type="font_size";Timeline.entryTypes.FontSizeEntry=FontSizeEntry;FontSizeEntry.prototype.undo=function(t,e){var n=this.summary.element.new_state,r=this.summary.element.old_state;if(n>r)e.font_smaller();else e.font_larger()};FontSizeEntry.prototype.redo=function(t,e){var n=this.summary.element.new_state,r=this.summary.element.old_state;if(n>r)e.font_larger();else e.font_smaller()};var PackEntry=function(t,e){EntryType.call(this,t.type);this.summary=t;this.object=e.getElementByID(this.summary.element.id)};gmath.inherit(EntryType,PackEntry);PackEntry.prototype.type="pack";Timeline.entryTypes.PackEntry=PackEntry;PackEntry.prototype.match=function(t){return this.type===t.type&&!this.startingAndEndingPackStateAreTheSame(t)};PackEntry.prototype.startingAndEndingPackStateAreTheSame=function(t){var e=t.element.old_state,n=t.element.new_state;for(var r=0;r<e.length;r++){if(e[r]!==n[r])return false}return true};PackEntry.prototype.undo=function(t){var e=this.object.rows,n=this.summary.element.old_state;for(var r=0;r<e.length;r++){if(e[r].hidden&&!n[r])e[r].unhide();else if(!e[r].hidden&&n[r])e[r].hide()}this.object.layoutRows()};PackEntry.prototype.redo=function(t){var e=this.object.rows,n=this.summary.element.new_state;for(var r=0;r<e.length;r++){if(e[r].hidden&&!n[r])e[r].unhide();else if(!e[r].hidden&&n[r])e[r].hide()}this.object.layoutRows()};var CloneEntry=function(t,e){EntryType.call(this,t.type);this.summary=t;this.object=e.getElementByID(this.summary.targets[0].id)};gmath.inherit(EntryType,CloneEntry);CloneEntry.prototype.type="clone";Timeline.entryTypes.CloneEntry=CloneEntry;CloneEntry.prototype.match=function(t){return this.type===t.type};CloneEntry.prototype.undo=function(t){this.links=t.removeDL(this.object)};CloneEntry.prototype.redo=function(t){t.addDL(this.object);gmath.LinkCoordinator.addLinks(this.links)};var ScrubEntry=function(t,e){EntryType.call(this,t.type);this.summary=t;this.object=e.getElementByID(this.summary.element.id)};gmath.inherit(EntryType,ScrubEntry);ScrubEntry.prototype.type="scrub";Timeline.entryTypes.ScrubEntry=ScrubEntry;ScrubEntry.prototype.match=function(t){return this.type===t.type};ScrubEntry.prototype.undo=function(t){var e=this.object.rows[0].model;var n=e.replace_with(new AlgebraModel(this.summary.element.old_state,e.options));this.object.rows[0].updateDimensionAfterInteraction();this.object.updateRowDimensions();this.object.rows[0].view.update_existing()};ScrubEntry.prototype.redo=function(t){var e=this.object.rows[0].model;var n=e.replace_with(new AlgebraModel(this.summary.element.new_state,e.options));this.object.rows[0].updateDimensionAfterInteraction();this.object.updateRowDimensions();this.object.rows[0].view.update_existing()};gmath.gmifyPage=function(t,e){e=e||{};coordinator=new DLCoordinator;var n=t?d3.select(t):d3.select("body");var r=n.size()>0&&n.classed("gmify-canvas")?n:n.selectAll(".gmify-canvas");r.each(function(){var t=d3.select(this);var e=t.text().split(";");try{e.forEach(gmath.AlgebraModel.getDefaultParser().parse);t.classed("gmify-canvas",false).classed("gmified-canvas",true);t.classed("bootstrap-styles",true);t.select("*").remove();var n=new gmath.ui.CanvasFactory(this,{height:"500px"});fixAggressiveAssistmentsStyles(t);var r={pos:["auto",20],v_align:"top"};n.model.createDLs(e,r)}catch(o){console.log('could not parse "'+e+'". Error:',o)}});r=n.size()>0&&n.classed("gmify-minimal")?n:n.selectAll(".gmify-minimal");r.each(function(){var t=d3.select(this);var e=t.text();try{gmath.AlgebraModel.getDefaultParser().parse(e);t.classed("gmify-minimal",false).classed("gmified-minimal",true);t.classed("bootstrap-styles",true);t.select("*").remove();t.text("");var n=t.insert("svg").style({overflow:"visible",display:"block",width:"100%"});gmath.DerivationList.createFixedSingleLineDL(n.node(),{eq:e})}catch(r){console.log('could not parse "'+e+'". Error:',r)}});r=n.size()>0&&n.classed("gmify")?n:n.selectAll(".gmify");r.each(function(t,n){var r=d3.select(this),o=r.text();try{gmath.AlgebraModel.getDefaultParser().parse(o);r.classed("gmify",false).classed("gmified",true);r.classed("bootstrap-styles",true);r.select("*").remove();r.text("");var i=r.insert("div").style({overflow:"visible",display:"block","margin-top":"30px"});var a=new gmath.ui.CanvasFactory(i.node(),{minimal:true,logo_src:e.logo_src}),s=a.model.createDL({eq:o,pos:[0,0],cloning_on:false,normal_font:{family:"Kalam"},italic_font:{family:"Kalam"},font_baseline_shift:.4,font_ascent:.9,font_descent:.2,slanted_div_bar:true,div_bar_height:1/14,font_size:"45",row_border_color:"#ddd",handle_stroke_color:"#d8d8d8",keep_in_container:true});fixAggressiveAssistmentsStyles(r);coordinator.subscribeToCanvasModel(a.model);coordinator.addDL(s);a.focusOnDL(s);a.controller.clear_undo_queue()}catch(l){console.log('could not parse "'+o+'". Error:',l)}})};fixAggressiveAssistmentsStyles=function(t){t.selectAll(".btn-toolbar button span").style("font-size","12px");t.selectAll(".btn-toolbar button br").style("font-size","12px")};
