/// Copyright Erik Weitnauer 2015.
gmath.ui.version="0.0.3";gmath.ui.gm_version="0.5.0";gmath.ui=gmath.ui||{};gmath.ui.Path=function(){var t=function(t,e){this.container=d3.select(t);this.element=null;e=e||{};this.id=e.id||gmath.uid();this.oid=e.oid;this.points=e.points||[];this.color=e.color||"black";this.width=e.width||1;this.type=e.type;this.init()};t.prototype.toJSON=function(){return{id:this.id,type:"Path",points:this.points,color:this.color,width:this.width}};t.line=typeof d3==="undefined"||typeof d3.svg==="undefined"?null:d3.svg.line();t.prototype.init=function(){var t=null;if(this.oid)t="#"+this.oid;this.element=this.container.insert("path",t).attr("id",this.id).style("fill","none").style("stroke-linecap","round").style("stroke-linejoin","round");return this.update()};t.prototype.update=function(){this.element.attr("d",t.line(this.points)+(this.points.length===1?"Z":"")).style("stroke",this.color).style("stroke-width",this.width);return this};t.prototype.remove=function(){this.element.remove();return this};t.prototype.setContainer=function(t){if(arguments.length===0)return this.container;this.container=t;return this};t.prototype.renderOnto=function(t){var e=this.element,n=this.container;this.container=t;this.element=t.select("#"+this.id);if(this.element.empty())this.init();else this.update();this.container=n;this.element=e};return t}();gm_erase_paths=function(){function t(t,e,n){n=n||20;var i=[];var r=function(t){var r=e[0][0];var o=e[0][1];var a=0;var l=0;if(t.length===1){if(!s(t[0][0],t[0][1],r,o,n)){i.push(t);return}}var u;while(a<t.length-1){var c=t[a];var d=t[a+1];var f=s(c[0],c[1],r,o,n);var g=s(d[0],d[1],r,o,n);if(f&&g){a++;l=a}else if(f&&!g){var v=h(c[0],c[1],d[0],d[1],r,o,n);if(v){t[a]=v;l=a}else{a++}}else if(!f&&g){var v=h(d[0],d[1],c[0],c[1],r,o,n);if(v){u=t.slice(l,a+1);u.push(v);i.push(u)}a++;l=a}else{var y=p(c[0],c[1],d[0],d[1],r,o,n);if(y){u=t.slice(l,a+1);if(u[u.length-1][0]!==y[0][0]||u[u.length-1][1]!==y[0][1]){u.push(y[0])}if(u.length>1)i.push(u);t[a]=y[1];if(t[a+1]&&t[a+1][0]==y[1][0]&&t[a+1][1]==y[1][1])a++;l=a}else{a++}}}if(l!==a){u=t.slice(l,t.length);if(u){i.push(u)}}};var a=function(t,r){if(t.path){n=n+t.width/2;var t=t.path}var o=e[r];var a=e[r+1];var r=0;var s=0;if(t.length===1){var l=u(t[0][0],t[0][1],o[0],o[1],a[0],a[1],n);if(l.indexOf(1)===-1){i.push(t);return}}var c;while(r<t.length-1){var h=t[r];var p=t[r+1];var l=u(h[0],h[1],o[0],o[1],a[0],a[1],n);var d=u(p[0],p[1],o[0],o[1],a[0],a[1],n);if(l.indexOf(1)!==-1&&d.indexOf(1)!==-1){r++;s=r}else if(l.indexOf(1)!==-1&&d.indexOf(1)===-1){var v=f(h[0],h[1],l,p[0],p[1],o[0],o[1],a[0],a[1],n);if(v){t[r]=v;s=r}else{r++}}else if(l.indexOf(1)===-1&&d.indexOf(1)!==-1){var v=f(p[0],p[1],d,h[0],h[1],o[0],o[1],a[0],a[1],n);if(v){c=t.slice(s,r+1);c.push(v);i.push(c);r++;s=r}else{r++}}else{var y=g(h[0],h[1],p[0],p[1],o[0],o[1],a[0],a[1],n);if(y){c=t.slice(s,r+1);if(c[c.length-1][0]!==y[0][0]||c[c.length-1][1]!==y[0][1]){c.push(y[0])}if(c.length>1)i.push(c);t[r]=y[1];if(t[r+1]&&t[r+1][0]==y[1][0]&&t[r+1][1]==y[1][1])r++;s=r}else{r++}}}if(s!==r){c=t.slice(s,t.length);if(c){i.push(c)}}};e=o({path:e});if(e.length===1){for(var l=0;l<t.length;l++){r(t[l])}t=i}else{for(var c=0;c<e.length-1;c++){for(var l=0;l<t.length;l++){a(t[l],c)}t=i;i=[]}}for(var d=0;d<t.length;d++){for(var v=0;v<t[d].length;v++){t[d][v][0]=Math.round(t[d][v][0]);t[d][v][1]=Math.round(t[d][v][1])}}return t}function e(t){if(t.path){var t=t.path}document.write("[");for(var e=0;e<t.length-1;e++){document.write("["+t[e][0]+","+t[e][1]+"],")}document.write("["+t[e][0]+","+t[e][1]+"]");document.write("]")}function n(t){document.write("[");for(var n=0;n<t.length-1;n++){e(t[n]);document.write(",<br />")}e(t[n]);document.write("]")}function i(t,e){if(t.path){var t=t.path}var n="";n+="[";for(var i=0;i<t.length-1;i++){n+="["+t[i][0]+","+t[i][1]+"],"}n+="["+t[i][0]+","+t[i][1]+"]";n+="]";if(e){console.log(n)}else{return n}}function r(t){log="";log+="[";for(var e=0;e<t.length-1;e++){log+=i(t[e],0);log+=","}log+=i(t[e],0);log+="]";console.log(log)}function o(t){if(t.path){var t=t.path}var e=[];if(t.length===1){e=t}else{pClean=0;while(pClean<t.length-1){if(t[pClean][0]!==t[pClean+1][0]||t[pClean][1]!==t[pClean+1][1]){e.push(t[pClean])}pClean++}if(t.length!==0&&e.length===0){e.push(t[0])}if(t[t.length-1][0]!==t[e.length-1][0]||t[t.length-1][1]!==t[e.length-1][1]){e.push(t[pClean])}}return e}function a(t,e,n,i){return Math.sqrt(Math.pow(n-t,2)+Math.pow(i-e,2))}function s(t,e,n,i,r){var o=a(t,e,n,i);if(o<r)return 1;else return 0}function l(t,e,n,i,r,o,a){var s=[r-n,o-i];var l=[t-n,e-i];var u=[-s[1],s[0]];var c=Math.sqrt(Math.pow(u[0],2)+Math.pow(u[1],2));var h=[u[0]/c,u[1]/c];var p=Math.sqrt(Math.pow(s[0],2)+Math.pow(s[1],2));var d=[s[0]/p,s[1]/p];var f=l[0]*d[0]+l[1]*d[1];if(f<=0||f>=p)return 0;var g=l[0]*h[0]+l[1]*h[1];if(g>=a||g<=-a)return 0;return 1}function u(t,e,n,i,r,o,a){var u=[];u.push(s(t,e,n,i,a));u.push(s(t,e,r,o,a));u.push(l(t,e,n,i,r,o,a));return u}function c(t,e,n,i,r){var o=[n-t,i-e];var a=[-o[1],o[0]];var s=Math.sqrt(Math.pow(a[0],2)+Math.pow(a[1],2));var l=[a[0]/s,a[1]/s];var u=[t+r*l[0],e+r*l[1]];var c=[t-r*l[0],e-r*l[1]];var h=[n-r*l[0],i-r*l[1]];var p=[n+r*l[0],i+r*l[1]];return[u,c,h,p]}function h(t,e,n,i,r,o,a){var s=[r-t,o-e];var l=[n-t,i-e];var u=Math.sqrt(Math.pow(l[0],2)+Math.pow(l[1],2));var c=[l[0]/u,l[1]/u];var h=s[0]*c[0]+s[1]*c[1];var p=[t+h*c[0],e+h*c[1]];var d=Math.sqrt(Math.pow(r-p[0],2)+Math.pow(o-p[1],2));var f;if(d===0){f=a}else{var f=Math.sqrt(Math.pow(a,2)-Math.pow(d,2))}var g=[t+h*c[0]+f*c[0],e+h*c[1]+f*c[1]];if(g[0]===t&&g[1]===e)return null;return g}function p(t,e,n,i,r,o,a){var s=[r-t,o-e];var l=[n-t,i-e];var u=[-l[1],l[0]];var c=Math.sqrt(Math.pow(u[0],2)+Math.pow(u[1],2));var h=[u[0]/c,u[1]/c];var p=s[0]*h[0]+s[1]*h[1];var d=m([t,e],[n,i],[r,o]);var f=v([d[0]-r,d[1]-o]);if(f>=a)return null;var g=Math.sqrt(Math.pow(a,2)-Math.pow(p,2));var y=[r-p*h[0],o-p*h[1]];var _=Math.sqrt(Math.pow(l[0],2)+Math.pow(l[1],2));var b=[l[0]/_,l[1]/_];var w=[[y[0]-b[0]*g,y[1]-b[1]*g],[y[0]+b[0]*g,y[1]+b[1]*g]];if(w[0][0]===t&&w[0][1]===e)return null;return w}function d(t,e,n,i,r,o,a,s){var l,u,c,h;l=n-t;u=i-e;c=a-r;h=s-o;var p,d;if(-c*u+l*h===0)return null;p=(-u*(t-r)+l*(e-o))/(-c*u+l*h);d=(c*(e-o)-h*(t-r))/(-c*u+l*h);if(p>=0&&p<=1&&d>=0&&d<=1){var f=t+d*l;var g=e+d*u;return[f,g]}return null}function f(t,e,n,i,r,o,s,l,u,f){var g=c(o,s,l,u,f);var v=[];if(n[0]&&!n[1]){v.push(h(t,e,i,r,o,s,f));v.push(d(t,e,i,r,g[0][0],g[0][1],g[3][0],g[3][1]));v.push(d(t,e,i,r,g[1][0],g[1][1],g[2][0],g[2][1]));var y=p(t,e,i,r,l,u,f);if(y)v.push(y[0],y[1])}else if(!n[0]&&n[1]){v.push(h(t,e,i,r,l,u,f));v.push(d(t,e,i,r,g[0][0],g[0][1],g[3][0],g[3][1]));v.push(d(t,e,i,r,g[1][0],g[1][1],g[2][0],g[2][1]));var y=p(t,e,i,r,o,s,f);if(y)v.push(y[0],y[1])}else if(n[0]&&n[1]){v.push(h(t,e,i,r,o,s,f));v.push(d(t,e,i,r,g[0][0],g[0][1],g[3][0],g[3][1]));v.push(d(t,e,i,r,g[1][0],g[1][1],g[2][0],g[2][1]));v.push(h(t,e,i,r,l,u,f))}else{var y=p(t,e,i,r,l,u,f);var m=p(t,e,i,r,o,s,f);if(y)v.push(y[0],y[1]);if(m)v.push(m[0],m[1]);v.push(d(t,e,i,r,g[0][0],g[0][1],g[3][0],g[3][1]));v.push(d(t,e,i,r,g[1][0],g[1][1],g[2][0],g[2][1]))}var _=[t,e];for(var b=0;b<v.length;b++){if(v[b]){if(a(v[b][0],v[b][1],i,r)<a(_[0],_[1],i,r)){_=v[b]}}}if(_[0]===t&&_[1]===e)return null;return _}function g(t,e,n,i,r,o,s,l,u){var h=c(r,o,s,l,u);var f=[];var g=p(t,e,n,i,r,o,u);if(g)f.push(g[0],g[1]);g=p(t,e,n,i,s,l,u);if(g)f.push(g[0],g[1]);f.push(d(t,e,n,i,h[0][0],h[0][1],h[3][0],h[3][1]));f.push(d(t,e,n,i,h[1][0],h[1][1],h[2][0],h[2][1]));var v=[n,i];var y=[t,e];for(var m=0;m<f.length;m++){if(f[m]){if(a(f[m][0],f[m][1],t,e)<a(v[0],v[1],t,e)){v=f[m]}}}for(var _=0;_<f.length;_++){if(f[_]){if(a(f[_][0],f[_][1],n,i)<a(y[0],y[1],n,i)){y=f[_]}}}if(v[0]===n&&v[1]===i||y[0]===t&&y[1]===e)return null;else return[v,y]}var v=function(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1])};var y=1e-6;var m=function(t,e,n){var i=[e[0]-t[0],e[1]-t[1]],r=v(i);if(r<y)return t;var o=[n[0]-t[0],n[1]-t[1]];var a=(i[0]*o[0]+i[1]*o[1])/r;if(a<0)return t;if(a>r)return e;return[t[0]+i[0]*a/r,t[1]+i[1]*a/r]};if(typeof exports!="undefined"){exports.erase=t}return t}();gm_hwr_request=function(){var t=function(t){var e={type:"stroke",x:[],y:[]};t.points.forEach(function(t){e.x.push(t[0]);e.y.push(t[1])});return e};var e=function(e,n){url="http://dlandy.psych.indiana.edu:7031/server.js";var i={components:e.map(t),resultTypes:["LATEX"]};var r={apiKey:"c26d2755-1fda-4033-b136-4af042f3f9db",equationInput:JSON.stringify(i)};var o=$.post(url,r.equationInput);o.done(function(t){var e=t.replace(/\\/g,"\\\\");e=JSON.parse(e);n(null,e.JSON)})};return e}();gmath.ui=gmath.ui||{};gmath.ui.holdUI=function(){var t=function(t,e,n){this.container=t;this.controller=e;this.view=n;this.element=null;this.pos=[0,0];this.visible=false;this.buttons=[];this.button_els=null;this.colors=d3.scale.category10();this.button_rads=null;this.inner_radius=20;this.outer_radius=80;this.init()};t.prototype.setPos=function(t){this.pos=t;this.element.attr("transform","translate("+t[0]+","+t[1]+")")};t.prototype.setVisible=function(t){this.visible=t;this.element.style("display",t?null:"none")};t.prototype.init=function(){var t=this,e={stroke:"black","stroke-width":1,"stroke-linecap":"round",fill:"none"};this.buttons.push({action:function(e){t.controller.inputDL(e)},icon:function(t){var e=t.append("g").attr("transform","translate(0,10)").append("g");var n=new gmath.AlgebraModel("f_x",{});var i=new gmath.AlgebraView(n,e,{font_size:"35",inactive_color:"black",interactive:false});i.init();return e},color:t.colors(0)});this.buttons.push({action:function(e){var n={pos:{x:e[0],y:e[1]}};t.view.createGraph(n)},icon:function(t){var n=t.append("g").attr("transform","translate(2,0)").style("cursor","pointer");var i=n.append("g").style("opacity",.5).style("shape-rendering","crispedges");i.append("line").attr({x1:-15,y1:0,x2:15,y2:0}).style(e);i.append("line").attr({x1:0,y1:-15,x2:0,y2:15}).style(e);i.append("rect").attr({x:-15,y:-15,width:30,height:30}).style(e);n.append("line").attr({x1:-15,y1:8,x2:15,y2:-8}).style(e).style("stroke-width",1.5);return n},color:t.colors(1)});this.buttons.push({action:function(e){var n={pos:{x:e[0],y:e[1]}};t.view.createMessage(n)},icon:function(t){var n=t.append("g");var i=n.append("g").style("opacity",.5);i.append("text").text("Aa").attr({x:0,y:10}).style("text-anchor","middle").style("font-size",30).style(e).style("fill","black").style("pointer-events","none");return n},color:t.colors(2)});this.button_rads=Math.PI*2/this.buttons.length;var n=this.button_rads,i=this.inner_radius,r=this.outer_radius;this.element=this.container.append("g").style("display","none");var o=this.element.append("defs"),a=o.append("filter").attr("id","dropShadow_holdUI");a.append("feGaussianBlur").attr("in","SourceAlpha").attr("stdDeviation",3);a.append("feOffset").attr("dx",0).attr("dy",4).attr("result","offsetblur");a.append("feComponentTransfer").append("feFuncA").attr("type","linear").attr("slope",.25);var s=a.append("feMerge");s.append("feMergeNode");s.append("feMergeNode").attr("in","SourceGraphic");this.element.attr("filter","url(#dropShadow_holdUI)");this.button_els=this.element.selectAll(".holdUI").data(this.buttons);this.button_els.enter().append("g").classed("holdUI",true).append("path").attr("d",function(t,e){var o=Math.cos(n*e)*i,a=-Math.sin(n*e)*i,s=Math.cos(n*e)*r,l=-Math.sin(n*e)*r,u=Math.cos(n*(e+1))*r,c=-Math.sin(n*(e+1))*r,h=Math.cos(n*(e+1))*i,p=-Math.sin(n*(e+1))*i;return"M"+o+","+a+"L"+s+","+l+"A"+r+","+r+" 0 0,0 "+u+","+c+"L"+h+","+p+"A"+i+","+i+" 0 0,1 "+o+","+a+"Z"}).style("fill",function(t){return t.color}).style("opacity",.8).style("cursor","pointer");this.button_els.each(function(t,e){var o=d3.select(this),a=t.icon(o);a.attr("transform",function(){var t=Math.cos(n*(e+.5))*(i+(r-i)/2),o=-Math.sin(n*(e+.5))*(i+(r-i)/2);return"translate("+t+", "+o+")"})})};t.prototype.detectHit=function(t){var e=this,n=this.button_rads,i=this.inner_radius,r=this.outer_radius,o=-1;this.button_els.each(function(a,s){var l=Math.sqrt(Math.pow(t[0]-e.pos[0],2)+Math.pow(t[1]-e.pos[1],2)),u=Math.atan2(-t[1]+e.pos[1],t[0]-e.pos[0]);if(u<0)u+=Math.PI*2;if(l>i&&l<r&&u>n*s&&u<n*(s+1))o=s});return o};t.prototype.highlight=function(t){var e=this.detectHit(t);this.button_els.each(function(t,n){var i=d3.select(this).select("path");if(e===n)i.transition().duration(30).style("fill",d3.rgb(t.color).brighter(.6));else i.transition().duration(30).style("fill",t.color)})};t.prototype.performAction=function(t){var e=this.detectHit(t);this.button_els.each(function(n,i){if(i===e)n.action(t)})};return t}();gmath.ui=gmath.ui||{};gmath.ui.CanvasController=function(){var t=function(t){var e=d3.dispatch("scroll","start_hwr","stop_hwr","undone","redone","hold","touch","drag","release","font_size","keyboard","entered_term","start-of-interaction","end-of-interaction");var n=gmath.uid(),i=t,r=null,o=false,a="math",s=true,l,u=1500,c=null,h=i.paths().length,p=2,d=50,f=null,g="black",v=null,y=null,m=0,_=null,b=null,w=false,x=[],k=-1,M=false,C=null,D=false,A=true,T=true;function E(t){if(M){M=false;return}k+=1;x[k]=t;x.length=k+1}var L=function(){t.on("create."+n,function(t){if(t.target_type==="dl"){var i=t.target;E({type:"create_dl",dl:i});i.events.on("added_line."+n,function(){if(i.rows.length>1){E({type:"math",dl:i})}})}if(t.target_type==="dl"||t.target_type==="graph"||t.target_type==="message"){t.target.events.on("start-of-interaction."+n,function(t){e["start-of-interaction"](t)});t.target.events.on("end-of-interaction."+n,function(t){e["end-of-interaction"](t)})}});if(T&&!C&&i.container()){C=new gmath.ui.holdUI(i.container(),L,i)}H(t.container().select("#background_event_layer"),I());H(t.container().select("#foreground_event_layer"),V());t.on("mode."+n,function(t){if(t.mode==="draw"||t.mode==="erase"){i.display_foreground_event_layer(true);i.setActive(null)}else{i.display_foreground_event_layer(false)}});if(A&&typeof gmath.ui.Keyboard!=="undefined"&&typeof $!=="undefined"){r=gmath.ui.Keyboard();r.width(800).position("center").on("done",Q).on("cancel",tt)()}i.container().on("dragover",function(){d3.event.preventDefault()}).on("drop",et);i.on("mode",function(t){q(t.mode)});return this};var q=function(t){if(t==="transform"||t==="inspect"||t==="delete")L.mode("math");else if(t==="draw")L.mode("draw");else if(t==="erase")L.mode("erase");else throw"Unkown CanvasModel mode: '"+t+"'"};L.id=n;L.model=function(){if(arguments.length===0)return i};L.mode=function(t){if(arguments.length===0)return a;a=t;return this};L.use_keyboard=function(t){if(arguments.length===0)return A;A=t;return this};L.use_hold_menu=function(t){if(arguments.length===0)return T;T=t;if(T&&!C&&i.container()){C=new gmath.ui.holdUI(i.container(),L,i)}return this};L.color=function(t){if(arguments.length===0)return g;g=t;return this};L.markerRadius=function(t){if(arguments.length===0)return p;p=t;return this};L.eraserRadius=function(t){if(arguments.length===0)return d;d=t;return this};L.hwr_delay=function(t){if(arguments.length===0)return u;u=t;return this};L.tx_behavior=function(){return y};L.hwr=function(t){if(!arguments.length)return s;if(s===t)return L;s=t;h=i.paths.length;if(!s)L.cancelHWR();return L};L.drawing=function(t){if(!arguments.length)return l;l=t;return this};L.scheduleHWR=function(){if(!c){c=setTimeout(L.performHWR,u);e.start_hwr()}};L.cancelHWR=function(t){if(!t)h=i.paths.length;if(c){clearTimeout(c);c=null;e.stop_hwr()}};L.performHWR=function(){c=null;e.stop_hwr();if(h>i.paths().length-1)return;var t=i.paths().slice(h),n=false,r=[];gm_hwr_request(t,function(e,o){if(e)console.log(e);var a=t[0].points[0];try{n=i.createDL({pos:a,eq:o})}catch(s){return}var l=function(t){try{i.removePath(t);r.push(t)}catch(e){return}};for(var u=0;u<t.length;u++){l(t[u])}h=i.paths().length;if(n&&r.length>0){E({type:"convert",removed_paths:r,added_dl:n})}});h=i.paths().length};L.scroll=function(t){if(arguments.length===0)return m;m=Math.min(0,t);y.transform({translate:[0,m]});i.paths_container().attr("transform","translate(0,"+m+")");i.dls_container().attr("transform","translate(0,"+m+")");e.scroll(m);return this};L.clear_undo_queue=function(){k=-1;x=[]};L.undo=function(){if(k===-1)return false;var t=x[k];console.log("undo",t.type);k--;if(t.type==="draw"){i.removePath(t.path)}else if(t.type==="erase"){t.removed.forEach(function(t){i.addPath(t)});t.added.forEach(function(t){i.removePath(t)});t.modified.forEach(function(t){t.path.points=t.points_before;i.updatePath(t.path)})}else if(t.type==="convert"){t.removed_paths.forEach(function(t){i.addPath(t)});this.undo()}else if(t.type==="math"){var n=t.dl.undo();i.setActive(t.dl);t.undone_row=n.last_row;t.removed_links=n.dead_links}else if(t.type==="create_dl"){i.removeDL(t.dl);t.removed_links=gmath.LinkCoordinator.unlinkDL(t.dl)}e.undone({type:"undone",action:t});return true};L.redo=function(){if(x.length<=k+1)return;k+=1;var t=x[k];console.log("redo",t.type);if(t.type==="draw"){i.addPath(t.path)}else if(t.type==="erase"){t.removed.forEach(function(t){i.removePath(t)});t.modified.forEach(function(t){t.path.points=t.points_after;i.updatePath(t.path)});t.added.forEach(function(t){i.addPath(t)})}else if(t.type==="convert"){t.removed_paths.forEach(function(t){i.removePath(t)})}else if(t.type=="math"){M=true;t.dl.redo(t);i.setActive(t.dl)}else if(t.type=="create_dl"){M=true;i.addDL(t.dl);gmath.LinkCoordinator.addLinks(t.removed_links)}e.redone({type:"redone",action:t})};L.font_smaller=function(){var t=parseInt(DerivationList.defaultOptions.font_size);if(t/1.2>12)this.set_font_size(t/1.2)};L.font_larger=function(){var t=parseInt(DerivationList.defaultOptions.font_size);if(t*1.2<160)this.set_font_size(t*1.2)};L.set_font_size=function(t){DerivationList.defaultOptions.font_size=t;i.dls().forEach(function(e){e.options.font_size=t;e.rows.forEach(function(e){e.view.options.font_size=t;e.view.update_all(true);e.updateHandlePos(true)});e.hideAllNodeMappings();e.layoutRows()});e.font_size(new S(t))};var z=function(t){return i.createPath({points:[[t[0],t[1]-m]],color:a==="draw"?g:"white",width:a==="draw"?2*p:2*d})};var O=function(t){this.type="hold";this.subType=t.subType;this.performee=n;this.performee_type="CanvasController";this.time=Date.now();this.finger={pos:[t.finger.pos[0],t.finger.pos[1]]};this.fingers=t.fingers.map(function(t){return{pos:[t.pos[0],t.pos[1]]}})};var P=function(t){this.type="touch";this.subType=t.subType;this.performee=n;this.performee_type="CanvasController";this.time=Date.now();this.finger={pos:[t.finger.pos[0],t.finger.pos[1]],pos0:[t.finger.pos0[0],t.finger.pos0[1]]};this.fingers=t.fingers.map(function(t){return{pos:[t.pos[0],t.pos[1]]}})};var F=function(t){this.type="drag";this.subType=t.subType;this.performee=n;this.performee_type="CanvasController";this.time=Date.now();this.finger={pos:[t.finger.pos[0],t.finger.pos[1]]};this.fingers=t.fingers.map(function(t){return{pos:[t.pos[0],t.pos[1]]}})};var W=function(t){this.type="release";this.subType=t.subType;this.performee=n;this.performee_type="CanvasController";this.time=Date.now();this.finger={pos:[t.finger.pos[0],t.finger.pos[1]]};this.fingers=t.fingers.map(function(t){return{pos:[t.pos[0],t.pos[1]]}})};var S=function(t){this.type="fontSize";this.performee=n;this.performee_type="CanvasController";this.time=Date.now();this.font_size=t};var N=function(t){this.type="enteredTerm";this.performee=n;this.performee_type="CanvasController";this.time=Date.now();this.eq=t.eq;this.dl_id=t.id;this.options=gmath.deepCopy(t)};var R=function(t){this.type="enteredGraph";this.performee=n;this.performee_type="CanvasController";this.time=Date.now();this.graph_id=t};var B=function(){this.type="keyboard";this.performee=n;this.performee_type="CanvasController";this.time=Date.now()};function H(t,e){t.call(e);e.frame(t.node())}function I(){var t=transform_behavior().allow_rotate(false).allow_scale(false).one_finger_drag(false).on("transform",function(){scroll(d3.event.transform.translate[1])});var e=mtouch_events().on("touch",G.bind(this,null)).on("hold",U.bind(this,null)).on("drag",K.bind(this,null)).on("tap",function(){i.setActive(null)}).on("release",J.bind(this,null)).hold_max_dist(5).hold_time(500).call(t);return e}function V(){var t=transform_behavior().allow_rotate(false).allow_scale(false).one_finger_drag(false).on("transform",function(){scroll(d3.event.transform.translate[1])});var e=mtouch_events().on("touch",j.bind(this,null)).on("drag",Z.bind(this,null)).on("release",X.bind(this,null)).hold_max_dist(5).hold_time(500).call(t);return e}var G=function(t){if(!T||w)return;var i=t||d3.event;if(!t&&d3.event){e["start-of-interaction"]({type:"start-of-interaction",source:"CanvasController",id:n,time:Date.now()});e.touch(new P(gmath.extend(d3.event,{subType:"menu"})))}if(i.fingers.length>1){w=true}};L.menu_touch=G;var U=function(t){if(!T||w)return;var n=t||d3.event;if(!t&&d3.event){e.hold(new O(gmath.extend(d3.event,{subType:"menu"})))}C.setPos(n.finger.pos.slice());C.setVisible(true)};L.menu_hold=U;var K=function(t){if(!T||w)return;var n=t||d3.event;if(!t&&d3.event){e.drag(new F(gmath.extend(d3.event,{subType:"menu"})))}if(C.visible){C.highlight(n.finger.pos.slice())}};L.menu_drag=K;var J=function(t){var i=t||d3.event;if(!t&&d3.event){e.release(new W(gmath.extend(d3.event,{subType:"menu"})))}if(w){if(i.fingers.length===0)w=false;return}if(C&&C.visible){C.performAction(i.finger.pos.slice());C.setVisible(false)}if(!t&&d3.event&&!r.visible()){e["end-of-interaction"]({type:"end-of-interaction",source:"CanvasController",id:n,time:Date.now()})}};L.menu_release=J;var j=function(t){var r=t||d3.event;if(!t&&d3.event){e["start-of-interaction"]({type:"start-of-interaction",source:"CanvasController",id:n,time:Date.now()});e.touch(new P(gmath.extend(d3.event,{subType:"draw"})))}if(r.fingers.length>1){w=true}if(!l||w)return;var o=r.finger.pos0.slice();o[1]-=m;L.cancelHWR(true);_=z(r.finger.pos0);if(a==="draw")E({type:"draw",path:_});if(a==="erase"){f=i.paths_container().append("circle").attr({cx:o[0],cy:o[1],r:d}).style({stroke:"silver",fill:"white"})}};L.draw_touch=j;var Z=function(t){var n=t||d3.event;if(!t&&d3.event){e.drag(new F(gmath.extend(d3.event,{subType:"draw"})))}if(!_||w||!l)return;var r=n.finger.pos.slice();r[1]-=m;_.points.push(r);i.updatePath(_);if(a==="erase")f.attr({cx:r[0],cy:r[1]})};L.draw_drag=Z;var X=function(t){var i=t||d3.event;if(!t&&d3.event){e.release(new W(gmath.extend(d3.event,{subType:"draw"})))}if(w){if(i.fingers.length===0)w=false;return}if(!_)return;if(a==="draw"){if(s&&(!r||!r.visible()))L.scheduleHWR()}else if(a==="erase"){f.remove();Y()}_=null;if(!t&&d3.event){e["end-of-interaction"]({type:"end-of-interaction",source:"CanvasController",id:n,time:Date.now()})}};L.draw_release=X;var Y=function(){var t=i.paths().slice(),e=t[t.length-1],n=[],r=[],o=[];t.forEach(function(t,a){if(t===e)return;var s=d+t.width/2;var l=gm_erase_paths([t.points],e.points,s);if(l.length===0){r.push(t);i.removePath(t)}else{o.push({path:t,points_before:t.points.slice(),points_after:l[0].slice()});t.points=l[0];i.updatePath(t);for(var u=1;u<l.length;u++){var c=i.createPath({points:l[u],color:t.color,width:t.width,oid:t.id});n.push(c)}}});i.removePath(e);E({type:"erase",removed:r,modified:o,added:n})};L.inputDL=function(t){if(o)return;e.keyboard(new B);L.cancelHWR(true);b={pos:[t[0],t[1]-m]};r.caption("Please enter a number, equation, or expression.").latex("").visible(true)};var Q=function(t){if(!b)return;r.visible(false);if(t==="")return;b.eq=t;b.id=gmath.uid();e.entered_term(new N(b));var o;try{o=i.createDL(b)}catch(a){console.log(a)}finally{b=null}e["end-of-interaction"]({type:"end-of-interaction",source:"CanvasController",id:n,time:Date.now()})};var tt=function(){r.visible(false);e["end-of-interaction"]({type:"end-of-interaction",source:"CanvasController",id:n,time:Date.now()})};L.disableKeyboard=function(t){o=t};L.simulateStartOfInteraction=function(){e["start-of-interaction"]({type:"start-of-interaction",source:"CanvasController",id:n,time:Date.now()})};L.simulateEndOfInteraction=function(){e["end-of-interaction"]({type:"end-of-interaction",source:"CanvasController",id:n,time:Date.now()})};function et(){var t=d3.event;t.preventDefault();var r=d3.mouse(svg.node());var o=nt(t.dataTransfer)||it(t.dataTransfer);if(!o){console.log("could not parse drop data",data);return}o=o.replace(/\\end{alignat}/g,"");o=o.replace(/\&\\\,/g,"");o=o.replace(/\\\,/g,"");o=o.replace(/\&/g,"");o=o.replace(/\\begin{alignat}{[0-9]*}/g,"");o=o.replace(/\\\;/g,"");o=o.replace(/[.,\s\\]+$/,"");var a=o.split("\\\\");if(o.length===0)return;try{e["start-of-interaction"]({type:"start-of-interaction",source:"CanvasController",id:n,time:Date.now()});i.createDLs(a,{pos:r,collapsed_mode:a.length>1},null,"drag-n-drop");e["end-of-interaction"]({type:"end-of-interaction",source:"CanvasController",id:n,time:Date.now()})}catch(s){console.log("Could not parse equation!",s)}}function nt(t){var e=t.getData("text/html");var n=document.createElement("div");var i=d3.select(n).html(e).select("img");return i.size()===1?i.attr("alt"):null}function it(t){return t.getData("text/plain")}return d3.rebind(L,e,"on")};return t}();gmath.ui=gmath.ui||{};gmath.ui.CanvasModelView=function(){var t=function(){var t=d3.dispatch("create","update","remove","reset","mode"),e=[],n=[],i,r=[],o=[],a=[],s=null,l,u,c,h,p,d,f,g,v=["transform","inspect","link","draw","erase","delete"],y=0;function m(t){t.dl.draw_mappings_for_nodes([t.node])}function _(t){return;var e=n.indexOf(t);if(e===-1||e===n.length-1)return;n.splice(n.indexOf(t),1);n.push(t);i=l.selectAll(".derivation-list").data(n,function(t){return t.id});i.order()}var b=function(t){s=t;u=s.append("g").attr("id","g_paths");p=s.append("rect").attr("id","background_event_layer").style({fill:"none","pointer-events":"all"}).attr("width","100%").attr("height","100%");c=s.append("g").attr("id","g_graphs");l=s.append("g").attr("id","g_dls");h=s.append("g").attr("id","g_links");d=s.append("rect").attr("id","foreground_event_layer").style({fill:"none","pointer-events":"all",display:"none"}).attr("width","100%").attr("height","100%");f=s.append("g").attr("id","g_messages");return this};b.setActive=function(t,e){if(arguments.length<2)e=true;if(t)t.setActive(e);n.forEach(function(e){if(e!==t)e.setActive(false)})};b.addDL=function(e){if(n.indexOf(e)!==-1)throw"dl is already in this model";e.canvas_model=b;e.container(l.node());n.push(e);t.create({type:"create",target_type:"dl",target:e});e.events.on("inspect_node",m);i=d3.selectAll(".derivation-list").data(n);e.events.on("hover",_);e.setInteractionMode(v[y]);b.setActive(e);return e};b.createDL=function(e,r,o){e.canvas_model=b;var a=new DerivationList(l.node(),e,r);n.push(a);var s={type:"create",target_type:"dl",target:a};if(o)s.source=o;t.create(s);a.events.on("inspect_node",m);i=d3.selectAll(".derivation-list").data(n);a.events.on("hover",_);a.setInteractionMode(v[y]);b.setActive(a);return a};b.createDLs=function(t,e,n,i){var r=0;o();function o(a){if(r===t.length){if(n)n()}else{if(a)e.pos[1]+=a.dims.height;var s=gmath.deepCopy(e);s.eq=t[r++];b.createDL(s,o,i)}}};b.removeDL=function(e){w(n,e);gmath.LinkCoordinator.unlinkDL(e);e.remove();t.remove({type:"remove",target_type:"dl",target:e})};b.addPath=function(n){if(e.indexOf(n)!==-1)throw"path is already in this model";n.setContainer(u);n.init();e.push(n);t.create({type:"create",target_type:"path",target:n});return n};b.createPath=function(n){var i=new gmath.ui.Path(u.node(),n);e.push(i);t.create({type:"create",target_type:"path",target:i});return i};b.updatePath=function(e){e.update();t.update({target_type:"path",target:e})};b.removePath=function(n){w(e,n);n.remove();t.remove({type:"remove",target_type:"path",target:n})};b.createGraph=function(e){e.view=b;var n=new gmath.ui.Graph(c.node(),e);r.push(n);t.create({type:"create",target_type:"graph",target:n});return n};b.removeGraph=function(e){w(r,e);e.remove();t.remove({type:"remove",target_type:"graph",target:e})};b.createLink=function(e,n){var i=(new gmath.ui.Link).a(e).b(n);i(h.node(),b);i.link();o.push(i);t.create({type:"create",target_type:"link",target:i});return i};b.createMessage=function(e){e.view=b;var n=new gmath.ui.Message(f.node(),e);a.push(n);t.create({type:"create",target_type:"message",target:n});return n};b.removeMessage=function(e){if(a.length>0)w(a,e);e.remove();t.remove({type:"remove",target_type:"message",target:e})};var w=function(t,e){var n=t.indexOf(e);if(n===-1)throw"no element "+e;t.splice(n,1)};b.dls=function(e){if(!arguments.length)return n;for(var i=0;i<n.length;i++)n[i].remove();n=e.slice();for(var i=0;i<n.length;i++){n[i].container(l);n[i].init()}t.reset({target_type:"dl",target:n.slice()})};b.graphs=function(){return r};b.graphs=function(t){if(!arguments.length)return r};b.links=function(){return o};b.messages=function(){return a};b.getElementsOfType=function(t){if(t==="graph")return r;if(t==="dl")return n;if(t==="link")return o;if(t==="messages")return a};b.paths=function(n){if(!arguments.length)return e;for(var i=0;i<e.length;i++)e[i].remove();e=n.slice();for(var i=0;i<e.length;i++){e[i].setContainer(u);e[i].init()}t.reset({target_type:"path",target:e.slice()})};b.container=function(){return s};b.background_event_layer=function(t){if(!arguments.length)return p;p=t;return this};b.foreground_event_layer=function(t){if(!arguments.length)return d;d=t;return this};b.display_foreground_event_layer=function(t){if(!arguments.length||t)d.style({display:"inline"});else d.style({display:"none"})};b.dls_container=function(t){if(!arguments.length)return l;l=t;return this};b.paths_container=function(t){if(!arguments.length)return u;u=t;return this};b.graphs_container=function(t){if(!arguments.length)return c;c=t;return this};b.links_container=function(t){if(!arguments.length)return h;h=t;return this};b.messages_container=function(t){if(!arguments.length)return f;f=t;return this};b.size=function(){var t=s.node();while(t.tagName.toLowerCase()!=="svg"&&t.parentNode)t=t.parentNode;var e=t.getBoundingClientRect();return{width:e.width,height:e.height}};b.interactionMode=function(e){if(arguments.length===0)return v[y];if(e==="inspect"&&v[y]!=="inspect"||e!=="inspect"&&v[y]==="inspect"){b.updateStyleOfNodes(e)}y=v.indexOf(e);s.select("rect").style("fill",e==="delete"?"whitesmoke":"none");n.forEach(function(t){t.setInteractionMode(e)});r.forEach(function(t){t.setInteractionMode(e)});a.forEach(function(t){t.setInteractionMode(e)});t.mode({type:"mode",mode:e});return this};b.switchMode=function(){b.interactionMode(v[++y%v.length]);t.mode({type:"mode",mode:v[y]})};b.updateStyleOfNodes=function(t){var e=b.dls();e.forEach(function(e){e.rows.forEach(function(e){if(!e.view)return;if(t==="inspect"){e.view.options.visualize_scrubbable_nodes=true}else{e.view.options.visualize_scrubbable_nodes=false}e.view.update_existing("normal")})})};return d3.rebind(b,t,"on")};return t}();gmath.ui=gmath.ui||{};gmath.ui.CanvasFactory=function(){var t=function(e,n){this.container=d3.select(e);this.options=gmath.object.merged(gmath.deepCopy(!n.minimal?t.defaultOptions:t.minimalOptions),n);this.options.toolbar_container=this.options.toolbar_container?d3.select(this.options.toolbar_container):this.container;this.events=d3.dispatch("button");this.model=gmath.ui.CanvasModelView();this.controller=gmath.ui.CanvasController(this.model).drawing(this.options.drawing).hwr(this.options.hwr).use_keyboard(this.options.use_keyboard).use_hold_menu(this.options.use_hold_menu);this.init()};gmath.ui.CanvasFactoryClass=t;t.prototype.serialize=function(){return JSON.stringify(this.model.dls().concat(this.model.graphs()))};t.prototype.trackEvent=function(t,e,n){if(this.options.analytics_tracking===true){ga("send",{hitType:"event",eventCategory:this.options.gm_app_name,eventAction:t,eventLabel:e,eventValue:n})}};t.prototype.setupAnalytics=function(t,e){if(this.options.analytics_tracking===true){ga("create","UA-68087505-1","auto");ga("set","checkProtocolTask",null);if("localStorage"in window&&localStorage["analytics"]==="no"){window["ga-disable-UA-68087505-1"]=true;
}else{window["ga-disable-UA-68087505-1"]=false}ga("send","event","load_canvas",document.location.href,{hitCallback:function(){}})}};t.prototype.init=function(){this.id=gmath.uid();var t=this;this.tools=this.options.toolbar_container.append("div").attr({"class":"btn-toolbar",role:"toolbar"}).style(this.options.toolbar_on_style).on("mouseenter",function(){if(t.toolFadeoutTimer)clearTimeout(t.toolFadeoutTimer)}).on("mouseleave",this.switchToolbarState.bind(this));if(this.options.drawing){this.options.mode_btns.splice(2,0,{type:"radio",group:"draw",state:false,label:"draw",icon:"glyphicon glyphicon-pencil"},{type:"radio",group:"draw",state:false,label:"erase",icon:"glyphicon glyphicon-erase"})}if(this.options.mode_btns)this.appendButtonGroup(this.options.mode_btns,this.onButton);if(this.options.reset_btn)this.appendButtonGroup([this.options.reset_btn],this.onButton);if(this.options.undo_btn||this.options.redo_btn){var e=[];if(this.options.undo_btn)e.push(this.options.undo_btn);if(this.options.redo_btn)e.push(this.options.redo_btn);this.appendButtonGroup(e,this.onButton)}if(this.options.font_smaller_btn&&this.options.font_larger_btn){var n=[];n.push(this.options.font_smaller_btn);n.push(this.options.font_larger_btn);this.appendButtonGroup(n,this.onButton)}if(this.options.help_btn){if(this.options.minimal)this.options.help_btn.pull_right=false;var i=[];i.push(this.options.help_btn);this.appendButtonGroup(i,this.onButton)}if(this.options.saving_and_loading&&this.options.save_btn&&this.options.load_btn){this.appendButtonGroup([this.options.save_btn,this.options.load_btn],this.onButton)}if(this.options.feedback&&this.options.feedback_btn){this.appendButtonGroup([this.options.feedback_btn],this.onButton)}if(this.options.minimal){this.tools.classed("btn-toolbar-minimal",true);var r=this.tools.append("div").attr("class","btn-group pull-right").style({"line-height":"26px","margin-left":"40px"});r.append("span").text("powered by").style({"font-style":"italic","font-family":"sans-serif",color:"#909090","font-weight":300,"font-size":"13px"});var o=r.append("a").style({"text-decoration":"none"}).attr({href:"http://graspablemath.com",target:"_blank"});o.append("img").attr({alt:"GM",src:this.options.logo_src}).style({"vertical-align":"-0.3em",height:"1.7em","margin-left":"0.8em","margin-right":"0.2em","font-size":"13px"})}var a=this.tools.node().getBoundingClientRect().height;if(a===0)a={xs:46,sm:64}[this.options.btn_size]||72;this.svg=this.options.toolbar_pos==="top"?this.container.append("svg"):this.container.insert("svg","div.btn-toolbar");this.svg.style("width",this.options.width).style("height","calc("+this.options.height+" - "+(a+10)+"px)");this.svgg=this.svg.append("g");this.svgg.call(this.model).call(this.controller)};t.prototype.focusOnDL=function(t){if(!this.options.minimal)return;var e=this;this.svg.style("overflow","visible");if(t.dims.width)this.resize(t.dims);this.switchToolbarState(false,true);t.events.on("hover",function(n){if(!t.coordinator.dls.some(function(t){return t.interactionMode==="link"}))e.switchToolbarState(n)});var n=this;t.events.on("resize",function(e){n.resize(e);t.forceIntoContainer(false)});t.dl_events.on("touch",function(t){if(t.type==="Touch")e.switchToolbarState(!e.toolbarOn,true)});t.row_events.on("touch",function(){e.switchToolbarState(!e.toolbarOn,true)});t.row_events.on("drag",function(){if(t.interactionMode!=="pack"&&t.interactionMode!=="undecided"){e.switchToolbarState(false,true)}})};t.prototype.switchToolbarState=function(t,e){var n=this;if(n.toolFadeoutTimer)clearTimeout(n.toolFadeoutTimer);if(t)n.turnOnToolbar();else{if(e)n.turnOffToolbar();else{n.toolFadeoutTimer=setTimeout(function(){n.turnOffToolbar()},n.options.toolFadeoutDelay)}}};t.prototype.turnOnToolbar=function(){this.tools.style(this.options.toolbar_on_style);this.toolbarOn=true};t.prototype.turnOffToolbar=function(){this.tools.style(this.options.toolbar_off_style);this.toolbarOn=false};t.prototype.resize=function(t){this.options.width=t.width;this.options.height=t.height;this.svg.style({width:this.options.width,height:this.options.height})};t.prototype.onButton=function(t){var e={mode:this.model.interactionMode()==="inspect"?"scrub":this.model.interactionMode(),font_size:DerivationList.defaultOptions.font_size};this.updateButton(t);if(t.label==="reset"){this.trackEvent("button press","reset",1);while(this.controller.undo()){}}if(t.label==="undo"){this.controller.undo();this.trackEvent("button press","undo",1)}if(t.label==="redo"){this.trackEvent("button press","redo",1);this.controller.redo()}if(t.label==="HWR"){this.trackEvent("button press","HWR",1);this.controller.hwr(t.state)}if(t.label==="transform"){this.trackEvent("button press","transform",1);this.model.interactionMode("transform")}if(t.label==="scrub"){this.trackEvent("button press","scrub",1);this.model.interactionMode("inspect")}if(t.label==="delete"){this.trackEvent("button press","delete",1);this.model.interactionMode("delete")}if(t.label==="draw"){this.trackEvent("button press","draw",1);this.model.interactionMode("draw")}if(t.label==="erase"){this.trackEvent("button press","erase",1);this.model.interactionMode("erase")}if(t.label==="help"){this.trackEvent("button press","help",1);this.help()}if(t.label==="feedback"){this.trackEvent("button press","feedback",1);this.sendFeedback()}if(t.label==="fullscreen"&&t.state===true){this.trackEvent("button press","start fullscreen",1);this.launchFullScreen()}if(t.label==="fullscreen"&&t.state===false){this.trackEvent("button press","stop fullscreen",1);this.cancelFullScreen()}if(!(t.label==="HWR"&&t.state===true)){this.trackEvent("button press","cancel HWR",1);this.controller.cancelHWR()}if(t.label==="larger"){this.trackEvent("button press","font larger",1);this.controller.font_larger()}if(t.label==="smaller"){this.trackEvent("button press","font smaller",1);this.controller.font_smaller()}if(t.label==="save"){gmath.CanvasSaver.save(this)}if(t.label==="load"){this.remove();gmath.CanvasSaver.load(this.container.node())}var n={button:{label:t.label,state:t.state,type:t.type},old_state:e,time:Date.now()};if(n.button.label==="larger"||n.button.label==="smaller")n.button.font_size=DerivationList.defaultOptions.font_size;this.events.button(n)};t.prototype.launchFullScreen=function(t){t=t||document.body;if(t.requestFullscreen)t.requestFullscreen();else if(t.mozRequestFullScreen)t.mozRequestFullScreen();else if(t.webkitRequestFullscreen)t.webkitRequestFullscreen();else if(t.msRequestFullscreen)t.msRequestFullscreen()};t.prototype.help=function(){var t=window.open("http://graspablemath.com/unstable/tutorial/index.html","_blank");t.focus()};t.prototype.sendFeedback=function(){var t=window.open("mailto:graspablemath@gmail.com","_blank");t.focus()};t.prototype.cancelFullScreen=function(){if(document.exitFullscreen)document.exitFullscreen();else if(document.mozCancelFullScreen)document.mozCancelFullScreen();else if(document.webkitExitFullscreen)document.webkitExitFullscreen();else if(document.msExitFullscreen)document.msExitFullscreen()};t.prototype.updateButton=function(t){this.tools.select("button#"+t.label).datum(t).each(function(t){if(t.type==="toggle"){t.state=!t.state;d3.select(this).classed("active",t.state)}else if(t.type==="radio"){var e=this;d3.select(this.parentNode).selectAll("button").each(function(t){t.state=e===this}).classed("active",function(t){return t.state})}})};t.prototype.appendButtonElement=function(t,e){var n=this;var i=t.append("button").attr("id",function(t){return t.label}).attr({type:"button","class":"btn btn-default"}).classed("btn-xs",n.options.btn_size==="xs").classed("btn-sm",n.options.btn_size==="sm").classed("active",function(t){return t.state}).style("min-width","4em");if(e)i.on("click",e.bind(this));if(this.options.display_icons){var r=i.filter(function(t){return t.icon});r.append("i").attr("class",function(t){return t.icon}).style({color:"#555","font-size":"1.2em","line-height":"1.7em"}).style("transform",function(t){return t.flip==="x"?"rotateX(180deg)":t.flip==="y"?"rotateY(180deg)":t.flip==="xy"?"rotateZ(180deg)":null});r.append("br")}if(this.options.display_labels){i.append("span").text(function(t){return t.label}).style("color","#555")}};t.prototype.appendButtonGroup=function(t,e){var n=this.tools.append("div").attr({"class":"btn-group",role:t[0].group}).classed("pull-right",t[0].pull_right).selectAll("button").data(t);n.enter().call(this.appendButtonElement.bind(this),e);return n};t.prototype.remove=function(){this.tools.remove();this.svg.remove()};t.minimalOptions={width:"100%",height:"100%",toolbar_pos:"top",reset_btn:{type:"push",label:"reset",icon:"glyphicon glyphicon-refresh"},undo_btn:{type:"push",label:"undo",icon:"glyphicon glyphicon-chevron-left"},redo_btn:{type:"push",label:"redo",icon:"glyphicon glyphicon-chevron-right"},help_btn:{type:"push",label:"help",pull_right:true,icon:"glyphicon glyphicon-question-sign"},use_keyboard:false,use_hold_menu:false,drawing:false,display_icons:true,display_labels:false,btn_size:"xs",toolbar_on_style:{display:"inline-block",position:"absolute","margin-top":"-30px",padding:"5px","padding-right":"10px",background:"rgba(255, 255, 255, 0.901961)","border-radius":"3px"},toolbar_off_style:{display:"none"},toolFadeoutDelay:500,logo_src:"../shared/imgs/gm-logo.png"};t.defaultOptions={width:"100%",height:"100%",toolbar_pos:"top",undo_btn:{type:"push",label:"undo",icon:"glyphicon glyphicon-chevron-left"},redo_btn:{type:"push",label:"redo",icon:"glyphicon glyphicon-chevron-right"},font_smaller_btn:{type:"push",label:"smaller",icon:"glyphicon glyphicon-text-size",flip:"y"},font_larger_btn:{type:"push",label:"larger",icon:"glyphicon glyphicon-text-size"},help_btn:{type:"push",label:"help",pull_right:true,icon:"glyphicon glyphicon-question-sign"},hwr_btn:{type:"toggle",label:"HWR",pull_right:true,state:true,icon:"glyphicon glyphicon-font"},fullscreen_btn:{type:"toggle",label:"fullscreen",pull_right:true,state:false,icon:"glyphicon glyphicon-resize-full"},hwr:false,feedback_btn:{type:"push",label:"feedback",pull_right:true,icon:"glyphicon glyphicon-envelope"},feedback:false,analytics_tracking:true,gm_app_name:"not defined",use_keyboard:true,use_hold_menu:true,drawing:true,display_icons:true,display_labels:true,btn_size:"sm",mode_btns:[{type:"radio",group:"mode",state:true,label:"transform",icon:"glyphicon glyphicon-random"},{type:"radio",group:"mode",state:false,label:"scrub",icon:"glyphicon glyphicon-resize-vertical"},{type:"radio",group:"mode",state:false,label:"delete",icon:"glyphicon glyphicon-trash"}],toolbar_on_style:{"margin-bottom":"10px"},toolbar_off_style:{"margin-bottom":"10px"},toolFadeoutDelay:0,save_btn:{type:"push",label:"save",pull_right:true,icon:"glyphicon glyphicon-save"},load_btn:{type:"push",label:"load",pull_right:true,icon:"glyphicon glyphicon-open"},saving_and_loading:true};return t}();gmath.ui=gmath.ui||{};gmath.ui.Keyboard=function(){var t=null;var e=function(){var t=function(){var t="m -5.708,-15.7 20.344,0 c 3.669696,0 6.624,2.954304 6.624,6.624 l 0,17.752 c 0,3.669696 -2.954304,6.624 -6.624,6.624 l -20.488,0 -15.408,-15.48 zM -2.18,-6.948 11.716,6.948M -2.18,6.948 11.716,-6.948";var e="M 13.7,16.5 -13.7,16.5 0,-16.5 z";var n=d3.dispatch("done","cancel","change"),i="",r=false,o,a,s=null,l=null,u=null,c=900,h,p,d,f,g,v,y="center",m=null;var _=function(){x();v=mtouch_events().on("touch",D).on("release",A).on("hold",T).hold_time(750);k();M();if(i!="")o.mathquill("write",i);return this};function b(t){n[t](o.mathquill("latex"))}_.width=function(t){if(arguments.length==0)return c;c=t;if(s)M();return this};_.latex=function(t){if(arguments.length==0){if(o)i=o.mathquill("latex");return i}else{i=t;if(o)o.mathquill("latex",t);return this}};_.visible=function(t){if(arguments.length==0)return r;if(r==t)return this;r=t;if(!s)return this;if(r){s.style("display","block");a.focus()}else s.style("display","none");return this};_.position=function(t){if(arguments.length==0)return y;if(y==t)return this;y=t;if(!s)return this;s.call(z,y);return this};_.caption=function(t){if(arguments.length===0)return m;m=t;if(!u)return this;if(!m)u.style("display","none");else{u.text(t);u.style("display",null)}return this};var w=function(){var t=11*130+10*10+2*10+2*10,e=3*110+20+10+2*10+2*10,n=c/t;p=130*n;f=10*n;d=110*n;h=e*n};var x=function(){g=[];g.push({name:"Cancel",type:"event",event:"cancel",col:0,row:0,cols:2});g.formula={type:"formula",col:2,row:0,cols:6};g.push({type:"backspace",col:8,row:0});g.push({name:"Done",type:"event",event:"done",col:9,row:0,cols:2});g.push({name:"0",type:"key",col:0,row:1});g.push({name:"1",type:"key",col:1,row:1});g.push({name:"2",type:"key",col:2,row:1});g.push({name:"3",type:"key",col:3,row:1});g.push({name:"4",type:"key",col:4,row:1});g.push({name:"+",type:"key",col:5,row:1});g.push({name:"*",type:"key",val:"*",col:6,row:1,dy:"0.3em"});g.push({name:"(",type:"key",col:7,row:1});g.push({name:")",type:"key",col:8,row:1});g.push({name:"n",type:"key",col:9,row:1});g.push({name:"^",type:"key",col:10,row:1});g.push({name:"5",type:"key",col:0,row:2});g.push({name:"6",type:"key",col:1,row:2});g.push({name:"7",type:"key",col:2,row:2});g.push({name:"8",type:"key",col:3,row:2});g.push({name:"9",type:"key",col:4,row:2});g.push({name:"−",type:"key",val:"-",col:5,row:2});g.push({name:"÷",type:"key",val:"/",col:6,row:2});g.push({name:"=",type:"key",col:7,row:2});g.push({type:"arrow",dir:"left",col:8,row:2,cols:1,rows:.5});g.push({type:"arrow",dir:"up",col:9,row:1.5,cols:1,rows:.5});g.push({type:"arrow",dir:"down",col:9,row:2,cols:1,rows:.5});g.push({type:"arrow",dir:"right",col:10,row:2,cols:1,rows:.5})};var k=function(){s=d3.select("body").append("div").style({position:"fixed",bottom:0,"z-index":1e4}).style("display",r?"block":"none");u=s.append("div").attr("id","caption").style({position:"relative",background:"rgb(244, 244, 244)",padding:"12px",border:"1px solid silver","border-radius":"7.6px 7.6px 0 0","border-bottom":"none",width:"80%",margin:"auto","font-family":"HelveticaNeue-Light",color:"#666","font-size":"17px","text-align":"center",display:m?null:"none"}).text(m);l=s.append("div").classed("keyboard",true);o=l.append("div").attr("id","formula").datum(g.formula).append("div").attr("id","mq_div").append("span").attr("id","mq_span");o=$(o.node()).mathquill("editable");a=o.find("textarea");if(r)a.focus();d3.select(a[0]).on("keyup",function(){if(d3.event.keyCode===13)b("done")});C();var t=l.selectAll(".key").data(g).enter().append("div").classed("key",true).call(v);t.filter(function(t){return t.type=="backspace"}).classed("backspace-key",true).append("svg").append("path");t.filter(function(t){return t.type=="arrow"}).classed("arrow-key",true).append("svg").append("path");t.filter(function(t){return t.name}).classed("normal-key",true).append("span")};var M=function(){w();s.call(z,y);l.style("height",h+"px").style("width",c+"px").style({bottom:0,background:"#DDD",padding:0,"text-align":"center",border:"1px solid silver","border-radius":f*1.5+"px "+f*1.5+"px 0 0","border-bottom":"none"}).select("#formula").style("border",f+"px solid #DDD").style("border-radius",f+"px").call(E,f).select("#mq_div").style("border-radius",f+"px").style("width",function(t){return(t.cols||1)*p+((t.cols||1)-1)*f+"px"}).call(q).select("#mq_span").style("box-shadow","none").style("-webkit-box-shadow","none").style("-moz-box-shadow","none").style("margin-top",f).style("font-size",d/2+d/10+"px").style("padding-top",3*f-2+"px").style("padding-bottom",2*f+"px").style("border","none").style("min-height",function(t){return(t.rows||1)*d+((t.rows||1)-1)*f-5*f+"px"}).style("width","100%");l.selectAll(".key").call(E).call(L).call(q);l.selectAll(".backspace-key path").attr("d",t).style("stroke","black").style("stroke-width","1.2").style("fill","none").attr("transform","translate("+p/2+","+d/2+")scale("+.12*f+")");l.selectAll(".arrow-key path").attr("d",e).style("stroke","black").style("stroke-linejoin","round").style("stroke-width",3).style("fill","none").attr("transform",function(t){var e={left:-90,up:0,right:90,down:180}[t.dir];return"translate("+p/2+","+d/4+")scale("+.05*f+")rotate("+e+")"});l.selectAll(".normal-key span").text(function(t){return t.name}).style("line-height",d+"px").filter(function(t){return t.dy}).style("display","inline-block").style("margin-top",function(t){return t.dy})};var C=function(){if(/iPhone|iPod|iPad|Android|BlackBerry/.test(navigator.userAgent))l.select(".textarea textarea").attr("readonly","readonly")};var D=function(t){d3.select(this).style("background","gray");if(t.type==="formula")return;a.focus();if(t.type==="key"){var e=t.val||t.name;var n=e.charCodeAt(0);a.val(e);a.trigger($.Event("keydown",{which:n}));a.trigger($.Event("keypress",{which:n}));b("change")}else if(t.type==="backspace"){a.trigger($.Event("keydown",{which:8}));b("change")}else if(t.type==="event"){b(t.event)}else if(t.type==="arrow"){var n={left:37,up:38,right:39,down:40}[t.dir];a.trigger($.Event("keydown",{which:n}));b("change")}};var A=function(t){d3.select(this).style("background",t.type=="key"||t.type=="formula"?"white":"silver")};var T=function(t){if(t.type!=="backspace")return;o.mathquill("latex","");a.focus()};var E=function(t,e){e=e||0;t.style("position","absolute").style("left",function(t){return t.col*(p+f)+2*f-e+"px"}).style("bottom",function(t){return(2-t.row)*(d+f)+(t.row==0?f:0)+2*f-e+"px"})};var L=function(t,e,n){e=e||0;n=n||0;t.style("width",function(t){return(t.cols||1)*p+((t.cols||1)-1)*f-2*e+"px"}).style("height",function(t){return(t.rows||1)*d+((t.rows||1)-1)*f-2*n+"px"})};var q=function(t){t.style("border-radius",f+"px").style("font-size",d/2+"px").style("background",function(t){return t.type=="key"||t.type=="formula"?"white":"silver"}).style("box-shadow","#888 0px 1px 0px").style("font-family","'HelveticaNeue-UltraLight', 'Helvetica Neue UltraLight', 'Helvetica Neue', Arial, Helvetica, sans-serif").style("font-weight",100).style("border","none").style("padding",0).style("-webkit-user-select","none").style("-khtml-user-select","none").style("-moz-user-select","none").style("-ms-user-select","none").style("user-select","none").style("cursor","pointer")};var z=function(t,e){if(e==="center"){t.style("margin-left",-c/2+"px");t.style("left","50%");t.style("right",null)}else if(e==="left"){t.style("margin-left",0);t.style("left",0);t.style("right",null)}else if(e==="right"){t.style("margin-left",0);t.style("left",null);t.style("right",0)}else{t.style("margin-left",-c/2+"px");t.style("left",e);t.style("right",null)}};return d3.rebind(_,n,"on")};return t};return function(){return t||(t=e()())}}();gmath.ui=gmath.ui||{};gmath.ui.TutorialPair=function(){var t=function(t,e){this.events=d3.dispatch("done","retry","next");this.gestureData=e.gestureData;if(this.gestureData)this.gestureData.options.show_bg=false;this.eq=e.eq;this.correctAnswers=e.correctAnswers;this.extraExamples=e.extraExamples;this.currentExtra=0;this.title=e.title;this.text=e.text;this.startWiggle=e.startWiggle;this.doNotWiggle=false;this.container=d3.select(t);this.dl_div=null;this.dl=null;this.play_btn=gmath.svg_play_button();this.player=null;this.allow_restart_after_done=true;this.answered=false;if("allow_restart_after_done"in e)this.allow_restart_after_done=e.allow_restart_after_done;this.init()};t.prototype.replay=function(){this.play_btn.hidden(true);var t=this;t.player.replay(500,function(){setTimeout(function(){t.play_btn.hidden(false);if(!t.answered){t.dl_div.append("span").text("Try it!").classed("tryit",true);if(t.startWiggle&&!t.doNotWiggle)t.dl.startWiggle(t.startWiggle);t.dl_div.on("mousedown",function(){var e=new Date;t.startTime=e.getTime();t.dl_div.select("span.tryit").remove();t.dl_div.on("mousedown",null)})}},1e3)})};t.prototype.deactivateFutureWiggling=function(){this.doNotWiggle=true};t.prototype.init=function(){this.container.append("h2").text(this.title);this.container.append("p").attr("class","tutorial-instructions").text(this.text);var t=this.container.append("div").classed("tutorial",true);var e=t.append("div").attr("id","ex").classed("choice",true).append("svg").classed("animation",true);this.gestureData.options.pos=["auto","auto"];this.gestureData.options.draggable=false;this.player=new gmath.EventRecorder(this.gestureData,e.append("g").node());this.player.showPreview();e.call(this.play_btn.on("click",this.replay.bind(this)));if(this.eq){this.dl_div=t.append("div").classed("choice",true);var n=gmath.deepCopy(this.gestureData.options);n.inactive_color=gmath.AlgebraView.defaultOptions.inactive_color;n.color=gmath.AlgebraView.defaultOptions.color;this.dl=new gmath.DerivationList(this.dl_div.append("svg").attr({width:"100%",height:"100%"}).node(),n);this.dl.getLastRow().view.interaction_handler.events.on("touch",this.deactivateFutureWiggling.bind(this));this.dl.events.on("end-of-interaction",this.checkAnswer.bind(this));this.startTime=-1;var i=this}};t.prototype.chainTransition=function(t,e){if(t.node().__transition__&&t.id&&t.node().__transition__[t.id]){var n=t.node().__transition__[t.id];console.log("extra delay",n.delay+n.duration);e+=n.delay+n.duration}return t.transition().delay(e)};t.prototype.neutralTransition=function(t,e,n){t.selectAll("button").remove();t.select("span").remove();var i=this.chainTransition(t,e).duration(n||500);i.style("background","#eee");return i};t.prototype.wrongTransition=function(t,e){var n=d3.select(t.node());n.append("span").attr("class","feedback").style({opacity:1e-5}).text("✗");var i=this.chainTransition(t,e).duration(500);i.style("background","#E0A8A8");i.style("color","#E0A8A8");i.select(".feedback").style("opacity",1);return i};t.prototype.correctTransition=function(t,e){var n=this;var i=d3.select(t.node());i.append("span").attr("class","feedback").style({opacity:1e-5}).text("✓");i.append("button").text("do it again").style({top:"10px",opacity:1e-5}).on("click",function(){if(n.allow_restart_after_done)n.retry()});i.append("button").text("try another").style({top:"62px",opacity:1e-5}).on("click",function(){if(n.extraExamples.length>0)n.loadNextExample();else n.retry()});var r=this.chainTransition(t,e).duration(500);r.style("background","#A8E0B3");r.style("color","#A8E0B3");r.select(".feedback").style("opacity",1);r.selectAll("button").style("opacity",1);return r};t.prototype.checkAnswer=function(){var t=this,e=400;setTimeout(function(){t.dl.getLastView().interactive(false);var e=t.dl.getLastModel().to_ascii();console.log(e);var n=new Date;var i=-1;var r=-1;if(t.startTime!==-1)i=n.getTime()-t.startTime;if(t.eq===t.dl.getLastModel().to_ascii()){t.dl.getLastView().interactive(true);r="initial state"}else if(t.answerIsCorrect(e)){t.answered=true;r="correct";if(t.dl_div.selectAll("div").size()===2)return;t.correctTransition(t.dl_div,200).each("end",t.events.done)}else{r="wrong";t.wrongTransition(t.dl_div,200).transition().duration(500).each("end",t.retry.bind(t));t.doNotWiggle=false}ga("send",{hitType:"event",eventCategory:"tutorial",eventAction:r,eventLabel:t.eq,eventValue:i})},e)};t.prototype.answerIsCorrect=function(t){if(this.currentExtra===0){return this.correctAnswers.indexOf(t)!==-1}else{return this.extraExamples[this.currentExtra-1].correctAnswers.indexOf(t)!==-1}};t.prototype.loadNextExample=function(){var t=this;this.neutralTransition(this.dl_div,0,1).each("end",function(){t.dl.getLastView().interactive(true);if(t.currentExtra<t.extraExamples.length){t.dl.setExpression(t.extraExamples[++t.currentExtra-1].expression);t.doNotWiggle=true}else{t.currentExtra=0;t.dl.setExpression(t.eq);t.doNotWiggle=false}t.events.next()})};t.prototype.retry=function(){var t=this;this.neutralTransition(this.dl_div,0,1).each("end",function(){t.dl.getLastView().interactive(true);t.dl.setExpression(t.currentExtra===0?t.eq:t.extraExamples[t.currentExtra-1].expression);t.events.retry()});this.answered=false;this.doNotWiggle=false};t.prototype.stop=function(){this.player.stop_animation()};return t}();gmath.ui=gmath.ui||{};gmath.ui.ProblemPair=function(){var t=function(t,e){this.events=d3.dispatch("done","reset");this.title=e.title;this.text=e.text;this.gestureData=e.gestureData;if(this.gestureData)this.gestureData.options.show_bg=false;this.eq=e.eq;this.correctAnswers=e.correctAnswers;this.startWiggle=e.startWiggle;this.doNotWiggle=false;this.container=d3.select(t);this.dl_div=null;this.dl=null;this.play_btn=gmath.svg_play_button();this.player=null;this.answered=false;this.allow_restart_after_done=true;if("allow_restart_after_done"in e)this.allow_restart_after_done=e.allow_restart_after_done;this.init()};t.prototype.replay=function(){this.play_btn.hidden(true);var t=this;t.player.replay(500,function(){setTimeout(function(){t.play_btn.hidden(false);if(!t.answered){t.dl_div.append("span").text("Try it!").classed("tryit",true);if(t.startWiggle&&!t.doNotWiggle)t.dl.startWiggle(t.startWiggle);t.dl_div.on("mousedown",function(){t.dl_div.select("span").remove();t.dl_div.on("mousedown",null)})}},1e3)})};t.prototype.deactivateFutureWiggling=function(){this.doNotWiggle=true};t.prototype.init=function(){this.container.append("h2").text(this.title);this.container.append("p").attr("class","tutorial-instructions").text(this.text);var t=this.container.append("div").classed("tutorial",true);var e=t.append("div").attr("id","ex").classed("largeChoice",true).append("svg").classed("animation",true);this.gestureData.options.pos=["auto","auto"];this.gestureData.options.draggable=false;this.player=new gmath.EventRecorder(this.gestureData,e.append("g").node());this.player.showPreview();e.call(this.play_btn.on("click",this.replay.bind(this)));if(this.eq){this.dl_div=t.append("div").classed("largeChoice",true);var n=gmath.deepCopy(this.gestureData.options);n.inactive_color=gmath.AlgebraView.defaultOptions.inactive_color;n.color=gmath.AlgebraView.defaultOptions.color;this.dl=new DerivationList(this.dl_div.append("svg").attr({width:"100%",height:"100%"}).node(),n);this.dl.getLastRow().view.interaction_handler.events.on("touch",this.deactivateFutureWiggling.bind(this));this.dl.events.on("end-of-interaction",this.checkAnswer.bind(this))}};t.prototype.chainTransition=function(t,e){if(t.node().__transition__&&t.id&&t.node().__transition__[t.id]){var n=t.node().__transition__[t.id];console.log("extra delay",n.delay+n.duration);e+=n.delay+n.duration}return t.transition().delay(e)};t.prototype.neutralTransition=function(t,e){var n=this.chainTransition(t,e).duration(500);n.style("background","#eee");n.select("span").remove();n.selectAll("div").remove();this.reset_btn=null;return n};t.prototype.wrongTransition=function(t,e){var n=this;if(!this.reset_btn){this.reset_btn=t.append("div").classed("smallLabel",true).classed("light",true).style("opacity",1e-5).append("button").text("reset").on("click",function(){n.reset()})}var i=this.chainTransition(t,e).duration(500);i.select("div").style("opacity",1);return i};t.prototype.correctTransition=function(t,e){var n=this;if(this.reset_btn){this.reset_btn.remove()}t.append("span").classed("smallLabel",true).text("good").style({opacity:1e-4,height:"50%","line-height":"110px"});t.append("div").classed("smallLabel",true).style({opacity:1e-4,height:"50%",top:"120px"}).append("button").text("reset").style({"margin-top":"40px"}).on("click",function(){n.reset()});var i=this.chainTransition(t,e).duration(500);i.style("background","#A8E0B3");i.select("span").style("opacity",1);i.selectAll("div").style("opacity",1);return i};t.prototype.checkAnswer=function(){this.dl.getLastView().interactive(false);var t=this.dl.getLastModel().to_ascii();if(this.eq===this.dl.getLastModel().to_ascii()){this.dl.getLastView().interactive(true)}else if(this.correctAnswers.indexOf(t)!==-1){this.answered=true;this.dl_div.select("span").text("good");this.correctTransition(this.dl_div,200).each("end",this.events.done)}else{this.wrongTransition(this.dl_div,200);this.dl.getLastView().interactive(true)}};t.prototype.reset=function(){var t=this;this.neutralTransition(this.dl_div,0).each("end",function(){t.dl.getLastView().interactive(true);t.dl.setExpression(t.eq);t.events.reset()});this.answered=false;this.doNotWiggle=false};t.prototype.stop=function(){this.player.stop_animation()};return t}();gmath.gmifyPage=function(t,e){e=e||{};coordinator=new DLCoordinator;var n=t?d3.select(t):d3.select("body");var i=n.size()>0&&n.classed("gmify-canvas")?n:n.selectAll(".gmify-canvas");i.each(function(){var t=d3.select(this);var e=t.text().split(";");try{e.forEach(gmath.AlgebraModel.getDefaultParser().parse);t.classed("gmify-canvas",false).classed("gmified-canvas",true);t.classed("bootstrap-styles",true);t.select("*").remove();var n=new gmath.ui.CanvasFactory(this,{height:"500px"});fixAggressiveAssistmentsStyles(t);var i={pos:["auto",20],v_align:"top"};n.model.createDLs(e,i)}catch(r){console.log('could not parse "'+e+'". Error:',r)}});i=n.size()>0&&n.classed("gmify-minimal")?n:n.selectAll(".gmify-minimal");i.each(function(){var t=d3.select(this);var e=t.text();try{gmath.AlgebraModel.getDefaultParser().parse(e);t.classed("gmify-minimal",false).classed("gmified-minimal",true);t.classed("bootstrap-styles",true);t.select("*").remove();t.text("");var n=t.insert("svg").style({overflow:"visible",display:"block",width:"100%"});gmath.DerivationList.createFixedSingleLineDL(n.node(),{eq:e})}catch(i){console.log('could not parse "'+e+'". Error:',i)}});i=n.size()>0&&n.classed("gmify")?n:n.selectAll(".gmify");i.each(function(t,n){var i=d3.select(this),r=i.text();try{gmath.AlgebraModel.getDefaultParser().parse(r);i.classed("gmify",false).classed("gmified",true);i.classed("bootstrap-styles",true);i.select("*").remove();i.text("");var o=i.insert("div").style({overflow:"visible",display:"block","margin-top":"30px"});var a=new gmath.ui.CanvasFactory(o.node(),{minimal:true,logo_src:e.logo_src}),s=a.model.createDL({eq:r,pos:[0,0],cloning_on:false,normal_font:{family:"Kalam"},italic_font:{family:"Kalam"},font_baseline_shift:.4,font_ascent:.9,font_descent:.2,slanted_div_bar:true,div_bar_height:1/14,font_size:"45",row_border_color:"#ddd",handle_stroke_color:"#d8d8d8",keep_in_container:true});fixAggressiveAssistmentsStyles(i);coordinator.subscribeToCanvasModel(a.model);coordinator.addDL(s);a.focusOnDL(s);a.controller.clear_undo_queue()}catch(l){console.log('could not parse "'+r+'". Error:',l)}})};fixAggressiveAssistmentsStyles=function(t){t.selectAll(".btn-toolbar button span").style("font-size","12px");t.selectAll(".btn-toolbar button br").style("font-size","12px")};
