// Copyright Erik Weitnauer 2014.
(function(){gmath={expressions:{}};gmath.version="0.0.2";(function(){var t=4294967296,e=15,r=[];str=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];function n(){var n=0;var i=Math.random()*t;r[n++]=str[i&e];r[n++]=str[i>>>4&e];r[n++]=str[i>>>8&e];r[n++]=str[i>>>12&e];r[n++]=str[i>>>16&e];r[n++]=str[i>>>20&e];r[n++]=str[i>>>24&e];r[n++]=str[i>>>28&e];i=Math.random()*t;r[n++]=str[i&e];r[n++]=str[i>>>4&e];r[n++]=str[i>>>8&e];r[n++]=str[i>>>12&e];r[n++]=str[i>>>16&e];r[n++]=str[i>>>20&e];r[n++]=str[i>>>24&e];r[n++]=str[i>>>28&e];return"_"+r.join("")}gmath.uid=n})();gmath.inherit=function(t,e){var r=e.prototype;e.prototype=Object.create(t.prototype);for(var n in r){e.prototype[n]=r[n]}e.prototype.constructor=e;Object.defineProperty(e.prototype,"constructor",{enumerable:false,value:e})};gmath.object={};gmath.object.extend=function(t,e){if(typeof e==="object")for(var r in e)t[r]=e[r];return t};gmath.object.merged=function(t,e){return gmath.object.extend(gmath.object.extend({},t),e)};gmath.extend=gmath.object.extend;gmath.array={};gmath.array.containsAll=function(t,e){if(e.length>t.length)return false;for(var r=0;r<e.length;r++)if(t.indexOf(e[r])===-1)return false;return true};gmath.array.equals=function(t,e){if(t.length!==e.length)return false;for(var r=0;r<t.length;r++)if(t[r]!==e[r])return false;return true};gmath.array.isPermutation=function(t,e){if(e.length!==t.length)return false;for(var r=0;r<e.length;r++)if(t.indexOf(e[r])===-1)return false;return true};gmath.array.mergedNew=function(t,e){var r=t.slice();for(var n=0;n<e.length;n++)if(t.indexOf(e[n])===-1)r.push(e[n]);return r};gmath.array.xor=function(t,e){var r=[];for(var n=0;n<t.length;n++)if(e.indexOf(t[n])===-1)r.push(t[n]);for(var n=0;n<e.length;n++)if(t.indexOf(e[n])===-1)r.push(e[n]);return r};gmath.array.flatten=function(t){var e=[];for(var r=0;r<t.length;r++)e=e.concat(t[r]);return e};gmath.getURLParameter=function(t){var e=RegExp(t+"="+"(.+?)(&|$)").exec(location.search);return e?decodeURIComponent(e[1]):null};if(typeof Object.create!=="function"){Object.create=function(t){function e(){}e.prototype=t;return new e}}if(!Array.isArray){Array.isArray=function(t){return Object.prototype.toString.call(t)==="[object Array]"}}var t={version:"1.2.5"};if(typeof exports!="undefined"){exports.Tree=t}t.parse=function(e){var r=new t.Node;var n=r.append(new t.Node);var i;n.value="";for(i=0;i<e.length;i++){var o=e[i];if(o=="["){n=n.append(new t.Node);n.value=""}else if(o=="]"){n=n.parent;if(n===r)throw"parse error"}else if(o==","){n=n.parent.append(new t.Node);n.value=""}else{n.value+=o}}for(i=0;i<r.children.length;i++)r.children[i].parent=null;if(r.children.length===1)return r.children[0];return r.children};t.stringify=function(t){var e=function(t){var r="";if("value"in t)r+=t.value;if(t.children&&t.children[0]){r+="["+t.children.map(e).join(",")+"]"}return r};if(!Array.isArray(t))t=[t];return t.map(e).join(",")};(function(){var e=4294967296,r=15,n=[],i=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];function o(){var t=0;var o=Math.random()*e;n[t++]=i[o&r];n[t++]=i[o>>>4&r];n[t++]=i[o>>>8&r];n[t++]=i[o>>>12&r];n[t++]=i[o>>>16&r];n[t++]=i[o>>>20&r];n[t++]=i[o>>>24&r];n[t++]=i[o>>>28&r];o=Math.random()*e;n[t++]=i[o&r];n[t++]=i[o>>>4&r];n[t++]=i[o>>>8&r];n[t++]=i[o>>>12&r];n[t++]=i[o>>>16&r];n[t++]=i[o>>>20&r];n[t++]=i[o>>>24&r];n[t++]=i[o>>>28&r];return n.join("")}t.uid=o})();t.clone=function(e,r){var n=function(e){var i;var o=new e.constructor;for(var a in e){if(a[0]!=="_")o[a]=e[a]}delete o.ls;delete o.rs;delete o.parent;if(e.id&&!r)o.id=t.uid();if(e.children){o.children=[];for(i=0;i<e.children.length;i++){o.children.push(n(e.children[i]));o.children[i].parent=o}for(i=0;i<e.children.length;i++){o.children[i].ls=o.children[i-1];o.children[i].rs=o.children[i+1]}}return o};if(!Array.isArray(e))return n(e);var i=e.map(n);if(e.length>1)for(var o=0;o<e.length;o++){if(o>0&&e[o].ls===e[o-1])i[o].ls=i[o-1];if(o<e.length-1&&e[o].rs===e[o+1])i[o].rs=i[o+1]}return i};t.get_mapping_between=function(t,e){var r={};function n(t,e){if(t.id in r)throw"duplicate id in source tree";r[t.id]=[e];if(t.children.length!==e.children.length){if(!t.has_children())r[t.id]=e.select_all();else if(!e.has_children())t.for_each(function(t){r[t.id]=[e]});else throw"tree structures don't match"}else{for(var i=0;i<t.children.length;i++)n(t.children[i],e.children[i])}}if(Array.isArray(t)){if(t.length!==e.length)throw"tree structures don't match";for(var i=0;i<t.length;i++)n(t[i],e[i])}else n(t,e);return r};t.get_1to1_mapping_between=function(t,e){var r={};function n(t,e){if(t.id in r)throw"duplicate id in source tree";r[t.id]=e;if(t.children.length!==e.children.length)throw"tree structures don't match";for(var i=0;i<t.children.length;i++)n(t.children[i],e.children[i])}if(Array.isArray(t)){if(t.length!==e.length)throw"tree structures don't match";for(var i=0;i<t.length;i++)n(t[i],e[i])}else n(t,e);return r};t.nodes_to_range=function(e){var r=e.length;if(r===0)return[];if(r===1)return[e[0]];var n=e[0];while(n.parent)n=n.parent;var i=e.map(function(e){return t.get_path(e)});var o=function(t){var e=i[0][t];for(var r=0;r<i.length;r++){if(i[r].length<=t+1)return false;if(i[r][t]!==e)return false}return true};var a=0;while(o(a))a++;var s=t.get_child(i[0].slice(0,a),n);var l=-1,h=s.children.length,u;for(u=0;u<r;u++){var c=t.get_child(i[u].slice(0,a+1),n);var d=s.children.indexOf(c);if(d>l)l=d;if(d<h)h=d}var p=[];for(u=h;u<=l;u++)p.push(s.children[u]);return p};t.insert=function(t,e,r){r.ls=t.children[e-1];if(t.children[e-1])t.children[e-1].rs=r;r.rs=t.children[e];if(t.children[e])t.children[e].ls=r;r.parent=t;t.children.splice(e,0,r);return r};t.insert_range=function(t,e,r){var n=r.length;if(n===0)return;r[0].ls=t.children[e-1];if(t.children[e-1])t.children[e-1].rs=r[0];r[n-1].rs=t.children[e];if(t.children[e])t.children[e].ls=r[n-1];for(var i=0;i<n;i++)r[i].parent=t;t.children=t.children.slice(0,e).concat(r,t.children.slice(e));return r};t.append_range=function(t,e){var r=e.length;if(r===0)return;var n=t.children[t.children.length-1];if(n)n.rs=e[0];e[0].ls=n;e[r-1].rs=null;for(var i=0;i<r;i++)e[i].parent=t;t.children=t.children.concat(e);return e};t.filterRange=function(t,e){var r=[];var n=Array.isArray(e)?e:[e];var i=function(e,n){var o=[];for(var a=n;a<e.length;a++){o.push(e[a]);if(t(o))r.push(o.slice())}if(e[n].children)for(var a=0;a<e[n].children.length;a++)i(e[n].children,a)};for(var o=0;o<n.length;o++)i(n,o);return r};t.append=function(t,e){var r=t.children[t.children.length-1];if(r)r.rs=e;e.ls=r;e.rs=null;e.parent=t;t.children.push(e);return e};t.remove=function(t){var e;var r=t.parent.children;e=r.indexOf(t);if(r[e-1])r[e-1].rs=t.rs;if(r[e+1])r[e+1].ls=t.ls;r.splice(e,1);return e};t.remove_range=function(t){var e=t.length;if(e===0)return;var r=t[0].parent.children;var n=r.indexOf(t[0]);if(r[n-1])r[n-1].rs=t[e-1].rs;if(r[n+e])r[n+e].ls=t[0].ls;r.splice(n,e);return n};t.replace=function(e,r){if(r.parent)t.remove(r);var n=t.remove(e);return t.insert(e.parent,n,r)};t.switch_siblings=function(t,e){if(t.parent!=e.parent)throw"Called switch_siblings on nodes that are no siblings!";var r=t.parent;var n=r.children.indexOf(t);var i=r.children.indexOf(e);r.children[n]=e;r.children[i]=t;var o;if(t.rs==e){if(t.ls)t.ls.rs=e;if(e.rs)e.rs.ls=t;t.rs=e.rs;e.ls=t.ls;t.ls=e;e.rs=t}else if(t.ls==e){if(t.rs)t.rs.ls=e;if(e.ls)e.ls.rs=t;t.ls=e.ls;e.rs=t.rs;t.rs=e;e.ls=t}else{if(t.ls)t.ls.rs=e;if(t.rs)t.rs.ls=e;if(e.ls)e.ls.rs=t;if(e.rs)e.rs.ls=t;o=t.ls;t.ls=e.ls;e.ls=o;o=t.rs;t.rs=e.rs;e.rs=o}};t.validate=function(t){var e=function(t,r){if(t.parent!=r)throw"wrong parent information";if(t.children){for(var n=0;n<t.children.length;n++){var i=t.children[n];if(i.ls!=t.children[n-1])throw"wrong ls information";if(i.rs!=t.children[n+1])throw"wrong rs information";e(i,t)}}};if(!Array.isArray(t))t=[t];for(var r=0;r<t.length;r++)e(t[r],null)};t.get_child=function(t,e){for(var r=0;r<t.length;r++){if(!e.children||e.children.length<=t[r])throw"invalid path";e=e.children[t[r]]}return e};t.get_parent=function(t,e){for(var r=0;r<t;r++){if(e.parent)e=e.parent;else throw"invalid path"}return e};t.get_path=function(t){var e=[];while(t.parent){e.unshift(t.parent.children.indexOf(t));t=t.parent}return e};t.for_each=function(t,e){var r=Array.isArray(e)?e:[e];var n=function(e){t(e);if(e.children)for(var r=0;r<e.children.length;r++)n(e.children[r])};for(var i=0;i<r.length;i++)n(r[i])};t.map=function(t,e){var r=Array.isArray(e)?e:[e];var n=[];var i=function(e){n.push(t(e));if(e.children)for(var r=0;r<e.children.length;r++)i(e.children[r])};for(var o=0;o<r.length;o++)i(r[o]);return n};t.filter=function(t,e){var r=[];var n=Array.isArray(e)?e:[e];var i=function(e){if(t(e))r.push(e);if(e.children)for(var n=0;n<e.children.length;n++)i(e.children[n])};for(var o=0;o<n.length;o++)i(n[o]);return r};t.select_all=function(e){return t.filter(function(){return true},e)};t.select_first=function(t,e){var r=function(e){var r=e;for(;;){if(t(r))return r;if(r.children&&r.children[0]){r=r.children[0];continue}if(r===e)return null;while(!r.rs){r=r.parent;if(r===e)return null}r=r.rs}};var n=Array.isArray(e)?e:[e];for(var i=0;i<n.length;i++){var o=r(n[i]);if(o)return o}return null};t.get_cca=function(e){var r=e.map(function(e){return t.get_path(e)});var n=function(t){var e=r[0][t];for(var n=0;n<r.length;n++){if(r[n].length<=t+1)return false;if(r[n][t]!==e)return false}return true};var i=0;while(n(i))i++;var o=r[0].length-i,a=e[0];for(var s=0;s<o;s++)a=a.parent;return a};t.get_leaf_nodes=function(e){return t.filter(function(t){return!(t.children&&t.children.length)},e)};t.is_root=function(t){return!t.parent};t.is_range=function(t){for(var e=1;e<t.length;e++){if(t[e-1].rs!==t[e])return false}return true};t.get_root=function(t){while(t.parent)t=t.parent;return t};t.get_by_value=function(e,r){return t.filter(function(t){return t.value===e},r)};t.get_by_id=function(e,r){return t.select_first(function(t){return t.id===e},r)};t.Node=function(){this.children=[];this.parent=null;this.ls=null;this.rs=null;this.id=t.uid()};t.Node.prototype.stringify=function(){return t.stringify(this)};t.Node.prototype.clone=function(e){return t.clone(this,e)};t.Node.prototype.get_mapping_to=function(e){return t.get_mapping_between(this,e)};t.Node.prototype.get_1to1_mapping_to=function(e){return t.get_1to1_mapping_between(this,e)};t.Node.prototype.insert=function(e,r){return t.insert(this,e,r)};t.Node.prototype.insert_range=function(e,r){return t.insert_range(this,e,r)};t.Node.prototype.append_range=function(e){return t.append_range(this,e)};t.Node.prototype.append=function(e){return t.append(this,e)};t.Node.prototype.remove=function(){return t.remove(this)};t.Node.prototype.remove_range=function(e){return t.remove_range(e)};t.Node.prototype.replace_with=function(e){return t.replace(this,e)};t.Node.prototype.switch_with_sibling=function(e){return t.switch_siblings(this,e)};t.Node.prototype.validate=function(){return t.validate(this)};t.Node.prototype.get_child=function(e){return t.get_child(e,this)};t.Node.prototype.get_parent=function(e){return t.get_parent(e,this)};t.Node.prototype.get_path=function(){return t.get_path(this)};t.Node.prototype.for_each=function(e){return t.for_each(e,this)};t.Node.prototype.map=function(e){return t.map(e,this)};t.Node.prototype.filter=function(e){return t.filter(e,this)};t.Node.prototype.filterRange=function(e){return t.filterRange(e,this)};t.Node.prototype.select_all=function(){return t.select_all(this)};t.Node.prototype.select_first=function(e){return t.select_first(e,this)};t.Node.prototype.get_leaf_nodes=function(){return t.get_leaf_nodes(this)};t.Node.prototype.is_root=function(){return t.is_root(this)};t.Node.prototype.get_root=function(){return t.get_root(this)};t.Node.prototype.get_by_value=function(e){return t.get_by_value(e,this)};t.Node.prototype.get_by_id=function(e){return t.get_by_id(e,this)};t.Node.prototype.has_children=function(){return this.children&&this.children.length>0};var e=function(t){var e=new RegExp("^\\s*([0-9]*\\.?[0-9]+([eE][-+]?[0-9]+)?)");var r=new RegExp("^\\s*([a-zA-Z])");var n=new RegExp('^\\s*"([^"]+)"');var i=new RegExp("^\\s*(\\*\\*|[-+*/=();,^{}_])");var o=new RegExp("^\\s*(\\\\[^A-Za-z0-9\\s]|\\\\[A-Za-z]+)");var a=new RegExp("^(\\s+)");var s=[];var l=0;if(t){l=t.length}for(var h=0;h<l;){var u=t.substr(h);var c;if(c=e.exec(u)){s.push({type:"number",value:parseFloat(c[1]),from:h+(c[0].length-c[1].length),to:h+c[0].length});h+=c[0].length}else if(c=r.exec(u)){s.push({type:"name",value:c[1],from:h+(c[0].length-c[1].length),to:h+c[0].length});h+=c[0].length}else if(c=n.exec(u)){s.push({type:"name",value:c[1],from:h+(c[0].length-c[1].length),to:h+c[0].length});h+=c[0].length}else if(c=i.exec(u)){s.push({type:"operator",value:c[1],from:h+(c[0].length-c[1].length),to:h+c[0].length});h+=c[0].length}else if(c=o.exec(u)){s.push({type:"latex",value:c[1],from:h+(c[0].length-c[1].length),to:h+c[0].length});h+=c[0].length}else if(c=a.exec(u)){h+=c[0].length}else{throw"can't tokenize '"+u+"'"}}return s};var r=function(e){t.Node.call(this);this.events=d3.dispatch("aspect","intervention","change");this.append(new n(e,this));this.scale=1;this.watchedAspectInfos=[]};gmath.TimeTree=r;gmath.inherit(t.Node,r);r.prototype.root=function(){return this.children[0]};r.prototype.init=function(){var t=this.root().mathObject;t.events.on("change."+this.id,this.catch_changed_event.bind(this));t.events.on("end-of-interaction."+this.id,this.finishPreviewActionSequence.bind(this));return this};r.prototype.catch_changed_event=function(t){this.update(t.sender_id,t.action,t.preview)};r.prototype.update=function(e,r,i){if(!r)return;var o=r.oldTree,a=r.newTree;if(!o||!a)throw"action must link to oldTree and newTree";if(i){var s=r.oldTree.timeState;if(!s._prePreviewMathObject)console.warn("should set prePreviewMathObject before any in-place preview actions");s.previewActionQueue.push(r);this.changed(e,r,true);return}if(r.oldTree===r.newTree){this.changed(e,r,false);var s=r.oldTree.timeState,l=s.previewActionQueue.length;if(l>0)s.previewActionQueue[l-1].compose(r);else s.generatingAction.compose(r);return}if(o.timeState){o.events.on("change."+this.id,null);a.events.on("change."+this.id,this.catch_changed_event.bind(this));o.events.on("end-of-interaction."+this.id,null);a.events.on("end-of-interaction."+this.id,this.finishPreviewActionSequence.bind(this));var h=new n(a,this),u=o.timeState;t.append(u,h);h.generatingAction=r;r.updateNodesFromFutureAndPast();this.changed(e,r,false)}else{var h=a.timeState,u=new n(o,this);h.replace_with(u);u.append(h);u.generatingAction=h.generatingAction;h.generatingAction=r;if(u.generatingAction){this.correctNodeMap(u.generatingAction,o);u.generatingAction.updateNodesFromFutureAndPast()}h.generatingAction.updateNodesFromFutureAndPast();this.changed(e,r,false)}};r.prototype.correctNodeMap=function(t,e){t.newTree=e;for(var r in t.node_map){t.node_map[r]=t.node_map[r].map(function(t){return e.filter(function(e){return e.id===t.id})[0]})}};r.getComposedActionName=function(t){if(t.length==1)return t[0].name;if(t.filter(function(t){return t.name=="invert terms across equation"}).length%2==1){return"invert terms across equation"}else if(t.filter(function(t){return t.name=="commute terms"}).length==t.length){return"commute terms"}else{return"multiple operations"}};r.prototype.finishPreviewActionSequence=function(t){var e=t.mathObject,n=e.timeState;if(n.previewActionQueue.length>0){var i=r.getComposedActionName(n.previewActionQueue);var o=Action.createComposedAction(n.previewActionQueue,i);o.oldTree=n._prePreviewMathObject;o.newTree=e;this.update(t.sender_id,o,false)}n._prePreviewMathObject=null;n.previewActionQueue=[]};r.prototype.changed=function(t,e,r){this.events.change({type:"change",term:e&&e.newTree&&e.newTree.to_ascii(),action:e,preview:r,sender_id:t})};r.prototype.catch_intervention_event=function(t){var e=function(r){if(r.children.length>0){r.children.map(function(t){e(t)})}return r.mathObject.updateFromFuture(t)};if(t.type=="changeNumber")e(this.root());this.reportWatchedAspects();this.events.intervention(t)};r.prototype.catchPastEvent=function(t){var e=function(r){var n=r.mathObject.updateFromPast(t);if(r.children.length>0){r.children.map(function(t){e(t)})}return n};e(this.root());this.events.intervention(t)};r.prototype.watch=function(t,e,r){var n=r.mathObject;if(t&&n.get_child(t)){this.watchedAspectInfos.push({name:e,aspect:t,timestate:r});return true}else{console.log("An AlgebraModel was asked to watch this ",t,"but it only watches values of nodes at legal paths");return false}};r.prototype.present=function(){var t=this.root();while(t.children&&t.children.length>0)t=t.children[0];return t};r.prototype.reportWatchedAspects=function(){for(i=0;i<this.watchedAspectInfos.length;i++){var t=this.watchedAspectInfos[i];var e=t.timestate.mathObject;this.events.aspect({observedVariable:t.name,watchedValue:e.reportAspect(t.aspect)})}};r.prototype.immediatePast=function(t){var e=t?t:this.present();return e.prePreviewMathObject?e.prePreviewMathObject:e.parent};var n=function(e,r){t.Node.call(this);this.mathObject=e;this.timeTree=r;this.mathObject.timeState=this;this.generatingAction=null;this.previewActionQueue=[];this._prePreviewMathObject=null};gmath.inherit(t.Node,n);n.prototype.prePreviewMathObject=function(t){if(arguments.length==0)return this._prePreviewMathObject;this._prePreviewMathObject=t;return this};if(typeof exports!="undefined"){exports.Tree=t}var o=function(e,r){t.Node.call(this);this.events=d3.dispatch("change","mistake","end-of-interaction");this.options=gmath.extend({hide_mult_op:true,hide_leading_op:true,capabilities:["num","var","sym","brackets","sign","add-sub","mul-div","exponent","equals"]},r);this.hide_rules=[];this.init_hide_rules();this.watchedAspects=[];this.parser=r&&r.parser||a.apply(this,this.options.capabilities);this.parseAndSet(e)};gmath.inherit(t.Node,o);gmath.AlgebraModel=o;o.prototype.clone=function(e){var r=new o(null,this.options);r.options.capabilities=r.options.capabilities.slice();r.hide_rules=this.hide_rules.slice();t.append(r,t.clone(this.children[0],e));return r};o.prototype.move_actions=[];if(typeof exports!=="undefined")exports.AlgebraModel=o;o.is_top_most=function(t){return!t.parent||t.parent instanceof o};o.prototype.init_hide_rules=function(){for(var t=0;t<this.options.capabilities.length;t++){var e=gmath.expressions[this.options.capabilities[t]];if(e.hide_rule)this.hide_rules.push(e.hide_rule)}};o.prototype.parseAndSet=function(e,r){this.children=[];var n=this.parser.parse(e);if(!n)return false;t.append(this,n);if(!r)this.remove_brackets();this.hide_nodes();this.changed(null,{newTree:this},false);return true};o.prototype.parse=function(t,e){var r=this.parser.parse(t);if(!r)return null;if(!e)this.remove_brackets([r]);return r};o.prototype.to_ascii=function(t){t=t||this.children;if(!Array.isArray(t))t=[t];return t.map(function(t){return t.to_ascii()}).join("")};o.prototype.to_latex=function(t){t=t||this.children;if(!Array.isArray(t))t=[t];return t.map(function(t){return t.to_latex()}).join("")};o.select_range_by_value=function(t,e){return function(r){if(!r[0].parent)return false;if(r[0].parent.parent&&o.range_contains_all_siblings(r))return false;return o.rangeToAscii(r)===t||o.rangeToAsciiNoLeadingOp(r,e)===t||r.length===1&&o.fractionToAscii(r[0])===t}};o.rangeToAscii=function(t){if(t.length===1&&t[0].hidden)return"";return t.map(function(t){return t.to_ascii()}).join("")};o.isLeadingCommutativeOp=function(t){return t.is_group()&&t.commutative&&t.associative};o.rangeToAsciiNoLeadingOp=function(t,e){if(t.length===0)return"";if(t.length===1&&t[0].hidden)return"";var r=t.map(function(t){return t.to_ascii()}).join("");if(t.length===1&&!e)return r;if(o.isLeadingCommutativeOp(t[0]))return r.substring(t[0].children[0].to_ascii().length);return r};o.fractionToAscii=function(t){if(!t.is_group("fraction"))return"";var e=t.to_ascii();if(e.slice(0,1)==="("&&e.slice(e.length-1,e.length)===")")e=e.substr(1,e.length-2);return e};o.range_contains_all_siblings=function(t){return t[0]&&t[0].parent&&!t[0].parent.is_group("exponent")&&t.length===t[0].parent.children.length};o.select_node_by_value=function(t){return function(e){return!e.is_root()&&!e.hidden&&e.to_ascii()===t}};o.getRanges=function(e,r,n){var i=t.filterRange(o.select_range_by_value(e),n);return typeof r==="number"?i[r]:i};o.prototype.getRanges=function(t,e,r){return o.getRanges(t,e,r||this.children)};o.getNodes=function(e,r,n){var i=t.filter(o.select_node_by_value(e,true),n);return typeof r==="number"?i[r]:i};o.prototype.getNodes=function(t,e,r){return o.getNodes(t,e,r||this.children)};o.prototype.changed=function(t,e,r){this.events.change({type:"change",term:e&&e.newTree&&e.newTree.to_ascii(),action:e,preview:r,sender_id:t||this.id})};o.prototype.finishInteraction=function(){var t=this.children[0].filter(function(t){return t.simplify}),e=gmath.actions.PostInteractionSimplificationAction.createAndDoInPlace(this,{nodes:t});t.forEach(function(t){t.simplify=false});if(e.changed){this.hide_nodes();this.changed(null,e,false)}this.events["end-of-interaction"]({type:"end-of-interaction",mathObject:this})};o.prototype.watch=function(t,e){this.timeState.timeTree.watch(t,e,this.timeState)};o.prototype.reportIntervention=function(t){if(!this.timeState)return;this.timeState.timeTree.catch_intervention_event(t)};o.prototype.reportAspect=function(e){return t.get_child(e,this)};o.prototype.updateFromFuture=function(e){t.select_all(this.root()).map(function(t){return t.nodeFromFuture?t.nodeFromFuture(e):t})};o.prototype.updateFromPast=function(e){t.select_all(this.root()).map(function(t){return t.nodeFromPast?t.nodeFromPast(e):t})};o.prototype.observeEvent=function(e){var r=t.select_all(this);r.map(function(t){if(t.nodeFromPast){t.value=t.nodeFromPast(e).value}return t});return this};o.prototype.root=function(){return this.children[0]};o.prototype.is_group=function(){return false};o.prototype.clean_up=function(){};o.prototype.numeric_value=function(e,r,n){var i=e.parent,o;if(e instanceof s&&i&&(i.is_group("sign")||i.is_group("add")||i.is_group("sub")))e=i;var o=s.get_value(e);if(isNaN(o))return NaN;if(arguments.length<2)return o;var a=o>0||o==0&&(e instanceof s||e.is_group("add"));var l=r>0||r==0&&(e instanceof s||e.is_group("add"));if(a&&!l){if(e.is_group("add")){e.invert()}else{var h=t.remove(e);var u=new p(e);u.children[0].no_anim=true;t.insert(i,h,u);u.selected=e.selected;e=u}}else if(!a&&l){if(e.is_group("sign")){var c=e.children[1];t.replace(e,c);e.children[0].no_anim=true;c.selected=e.selected;e=c}else if(e.is_group("sub")){e.invert();this.hide_nodes()}}if(e.is_group())e.children[1].value=Math.abs(r);else e.value=Math.abs(r);this.changed(n);return e};o.prototype.remove_brackets=function(e){t.for_each(function(t){if(t.is_group("fraction")&&t.parent.is_group("brackets"))d.handle(t.parent,true)},e||this.children)};o.prototype.process_operator=function(t,e){if(t.fixed){if(e)e(false);return false}if(!t.getBestMatchingAction&&t.parent)t=t.parent;if(!t.getBestMatchingAction){if(e)e(false);return false}var r=t.getBestMatchingAction();var n=r?r.createBoundAction(this,{actor:t}):null;this.performAction(n,e,"process operator");return n};o.prototype.performAction=function(t,e,r){var n=this;var i=function(t){if(!t){n.events.mistake({type:"mistake"});if(e)e(false);return}var i=t.newTree||n;i.hide_nodes();n.changed(null,t,false);n.reportIntervention({type:r});if(e)e(true)};if(!t)i(false);else if(this.timeState&&!t.always_do_in_place)t.run(i);else t.doInPlace(i)};o.prototype.hide_nodes=function(){return this.hideNodesAction.doInPlace(this)};o.prototype.performSplitAction=function(t){var e=new j;e.split(this,t||this.children)};o.prototype.performPreviewAction=function(t){if(t.makes_no_changes){t.doInPlace();return}if(this.timeState&&!this.timeState.prePreviewMathObject()){var e=this.clone(true);e.children[0].for_each(function(t){t.dragging=false;t.selected=false});e.hide_nodes();this.timeState.prePreviewMathObject(e)}t.doInPlace();this.hide_nodes();this.changed(null,t,true);this.reportIntervention({type:t.name})};o.prototype.getMoveActions=function(t){if(t.length===0)return[];if(t.some(function(t){return t.fixed}))return[];var e=[];for(var r=0;r<this.move_actions.length;r++){e=e.concat(this.move_actions[r].getAllAvailableActions(t))}return e};o.prototype.make_flat=function(){var e=t.get_leaf_nodes(this);var r=new u("flat",0);r.commutative=true;e.forEach(function(e){if(e.hidden)return;e.commutative=true;e.associative=true;t.append(r,e)});this.children=[];t.append(this,r);this.changed()};var a=function(){var t={};var r;var n;var i;var o;var a=function(){return this};var s=function(t,e){e=e||this;e.name="SyntaxError";e.message=t;throw e};var l=function(){this.def={}};l.prototype.find_or_define=function(e){var r=this.def[e.value];if(!r||typeof r=="function")r=t[e.value];if(r&&typeof r!=="function")return r;r=Object.create(t["(name)"]);r.lpb=0;this.def[e.value]=r;return r};var h=function(e,a){var l,h,u,c;if(e&&r.id!==e){if(a)return;else s("Expected '"+e+"'.",r)}if(i>=n.length){r=t["(end)"];return}u=n[i];i+=1;c=u.value;l=u.type;if(l==="name"){h=o.find_or_define(u)}else if(l==="operator"){h=t[c];if(!h){s("Unknown operator.",u)}}else if(l==="latex"){h=t[c];if(!h){s("Unknown latex command.",u)}}else if(l==="string"||l==="number"){h=t["(number)"];l="number"}else{s("Unexpected token.",u)}r=Object.create(h);r.from=u.from;r.to=u.to;r.value=c;r.type=l;return r};var u=function(t){i--;r=t};var c=function(t,e){var n;var i=e||r;if(!e)h();n=i.nud();while(t<r.lbp){i=r;h();n=i.led(n)}return n};var d={nud:function(){s("Undefined.",this)},led:function(t){s("Missing operator.",this)}};var p=function(e,r){var n=t[e];r=r||0;if(n){if(r>n.lbp){n.lbp=r}}else{n=Object.create(d);n.id=n.value=e;n.lbp=r;t[e]=n}return n};p("(end)");var f=function(t){n=e(t);if(n.length==0)return null;o=new l;i=0;h();var r=c(0);h("(end)");return r};var g={};g.parse=f;g.parseExpression=c;g.advance=h;g.regress=u;g.registerSymbol=p;for(var v=0;v<arguments.length;v++){var m=gmath.expressions[arguments[v]];if(m&&m.registerAtParser)m.registerAtParser(g)}return g};gmath.AlgebraParser=a;var s=function(e){t.Node.call(this);if(typeof e!=="number")e=0;if(e>=0)this.value=e;else return new p(new s(-e))};gmath.inherit(t.Node,s);s.prototype.nodeFromPast=function(t){return this};s.prototype.nodeFromFuture=function(e){var r=t.get_root(this).timeState;if(r.children.length==0){return this}else{if(r.children[0].generatingAction.length){console.log("Because action composition is not working, previewed actions that compose naturally cannot be tracked through interventions.")}else{var n=r.children[0].generatingAction.mapNodes([this]);if(n.length==1){this.matchFutureNode(n[0]);return this}else{console.warn("not implemented yet");return this}}}};s.prototype.matchFutureNode=function(e){var r=t.get_root(this);var n=t.get_root(e);r.numeric_value(this,n.numeric_value(e))};s.is_num=function(t){return t instanceof s||t.is_group("sign")&&t.children[1]instanceof s};s.get_value=function(t){if(!t)return NaN;if(t instanceof s)return t.value;if(t.is_group("sign")&&t.children[1]instanceof s)return-t.children[1].value;if(t.is_group("add")&&t.children[1]instanceof s)return t.children[1].value;if(t.is_group("sub")&&t.children[1]instanceof s)return-t.children[1].value;return NaN};s.prototype.to_string=function(){var t=this.value.toFixed(2);var e=0;for(var r=t.length-1;r>0;r--){if(t[r]=="0")e++;else if(t[r]=="."){e++;break}else break}return t.substring(0,t.length-e)};s.prototype.to_ascii=s.prototype.to_string;s.prototype.to_latex=s.prototype.to_string;s.prototype.is_group=function(){for(var t=0;t<arguments.length;t++){if(arguments[t]==="num")return true}return false};s.registerAtParser=function(t){var e=t.registerSymbol("(number)");e.nud=function(){return new s(this.value)}};gmath.expressions=gmath.expressions||{};gmath.expressions.num=s;var l=function(e){t.Node.call(this);this.value=e};gmath.inherit(t.Node,l);l.mappings={"-":"−","*":"·","/":"·","//":""};l.prototype.to_string=function(){if(this.parent&&this.parent.is_group("sign"))return"-";if(this.value in l.mappings)return l.mappings[this.value];return this.value};l.prototype.to_ascii=function(){return this.value};l.prototype.to_latex=function(){if(this.value==="/")return"\\cdot ";if(this.value==="*")return"\\cdot ";if(this.value==="(")return"\\left(";if(this.value===")")return"\\right)";return this.value};l.prototype.is_group=function(){for(var t=0;t<arguments.length;t++){if(arguments[t]==="sym")return true}return false};gmath.expressions=gmath.expressions||{};gmath.expressions.sym=l;var h=function(e,r){t.Node.call(this);this.bp=100;if(arguments.length<2){this.value=e;return this}else if(arguments.length===2){if(e instanceof h)this.append(e);else this.append(new h(e));this.append(r);r.for_each(function(t){t.fixed=true});this.children[0].fixed=true;this.value=this.to_ascii()}else throw"wrong number of arguments"};gmath.inherit(t.Node,h);h.prototype.to_string=function(){return this.value};h.prototype.to_ascii=function(){if(!this.has_children())return this.value;var t=this.children[0].value;var e=this.children[1].to_ascii();if(e.length>1)return t+"_{"+e+"}";else return t+"_"+e};h.prototype.to_latex=function(){if(!this.has_children())return this.value;var t=this.children[0].value;var e=this.children[1].to_latex();if(e.length>1)return t+"_{"+e+"}";else return t+"_"+e};h.prototype.is_group=function(){for(var t=0;t<arguments.length;t++){if(arguments[t]==="var")return true}return false};h.is_var=function(t){return t instanceof h||t.is_group("power")&&t.children[0]instanceof h};h.registerAtParser=function(t){var e=t.registerSymbol("_",100);e.led=function(e){var r=t.parseExpression(99);return new h(e,r)};var r={"(name)":"","\\alpha":"α","\\Alpha":"Α","\\beta":"β","\\Beta":"Β","\\gamma":"γ","\\Gamma":"Γ","\\delta":"δ","\\Delta":"Δ","\\epsilon":"ε","\\Epsilon":"Ε","\\zeta":"ζ","\\Zeta":"Ζ","\\eta":"η","\\Eta":"Η","\\theta":"θ","\\Theta":"Θ","\\iota":"ι","\\Iota":"Ι","\\kappa":"κ","\\Kappa":"Κ","\\lambda":"λ","\\Lambda":"Λ","\\mu":"μ","\\Mu":"Μ","\\nu":"ν","\\Nu":"Ν","\\xi":"ξ","\\Xi":"Ξ","\\omicron":"ο","\\Omicron":"Ο","\\pi":"π","\\Pi":"Π","\\rho":"ρ","\\Rho":"Ρ","\\sigma":"σ","\\Sigma":"Σ","\\tau":"τ","\\Tau":"Τ","\\upsilon":"υ","\\Upsilon":"Υ","\\phi":"φ","\\Phi":"Φ","\\chi":"χ","\\Chi":"Χ","\\psi":"ψ","\\Psi":"Ψ","\\omega":"ω","\\Omega":"Ω"};var n=function(){if(this.type==="name")return new h(this.value);else return new h(r[this.value])};var i=function(e){var r=t.parseExpression(v.prototype.bp,this);return v.createProduct(e,r)};for(var o in r){var a=t.registerSymbol(o,30);a.nud=n;a.led=i}};gmath.expressions=gmath.expressions||{};gmath.expressions.var=h;var u=function(e,r){t.Node.call(this);if(arguments.length>1)this.bp=r;if(arguments.length>0)this.value=e};gmath.inherit(t.Node,u);u.prototype.to_ascii=function(){return this.children.map(function(t){if(t.is_group()&&t.commutative&&!t.ls&&t.associative)return t.children[1].to_ascii();return t.to_ascii()}).join("")};u.prototype.to_latex=function(){return this.children.map(function(t){if(t.is_group()&&t.commutative&&!t.ls&&t.associative)return t.children[1].to_latex();return t.to_latex()}).join("")};u.prototype.is_group=function(t){if(arguments.length===0)return true;for(var e=0;e<arguments.length;e++){if(this.value===arguments[e])return true}return false};u.prototype.clean_up=function(){if(this.children.length==0){t.remove(this);return true}else{var e=false;t.for_each(function(t){if(t.clean_up)e=t.clean_up()||e},this.children);return e}};var c=function(e,r){gmath.inherit(u,this);this.prototype.bp=r.bp||0;this.prototype.associative=r.associative||false;this.prototype.commutative=r.commutative||false;this.prototype.has_inverse=r.has_inverse||false;this.prototype.inverse_group_name=r.inverse_group_name;this.prototype.group_name=r.group_name;this.prototype.group_class=r.group_class||null;this.prototype.value=e;this.prototype.action_handlers=[];
this.prototype.vertical_notation=r.vertical_notation||false;this.prototype.group_cleanup_name=r.group_cleanup_name;this.prototype.add_action_handler=function(t){if(this.action_handlers.indexOf(t)==-1)this.action_handlers.push(t)};this.prototype.getBestMatchingAction=function(){var t=null;for(var e=0;e<this.action_handlers.length;e++){var r=this.action_handlers[e];if(r instanceof Action){if(r.match(this)&&(t==null||r.priority>t.priority)){t=r}}else{console.warn("old action style not supported anymore",r)}}return t};this.prototype.getGroupCleanupAction=function(){if(!this.group_cleanup_action){if(!this.group_cleanup_name)return null;this.group_cleanup_action=new gmath.actions[this.group_cleanup_name]}return this.group_cleanup_action};this.prototype.createGroup=function(){if(this.group_class)return new this.group_class;var t=new u(this.group_name,this.bp);t.cleanupAction=this.getGroupCleanupAction();return t};this.createGroup=this.prototype.createGroup;this.prototype.getInverse=function(){return this.inverse&&gmath.expressions[this.inverse]};this.prototype.clean_up_commutative=function(){if(!this.ls&&!this.rs){var e=this.children[1];t.replace(this.parent,e);d.handle(e);return true}if(this.merge_nested_group())return true};this.prototype.merge_nested_group=function(){if(this.associative&&this.children[1].is_group(this.group_name)){var e=this.parent;var r=this.children[1];if(t.get_child([1,0,0],this).value===t.get_child([0],this).value){t.replace(t.get_child([1,0,0],this),t.get_child([0],this))}var n=t.remove(this);for(var i=0;i<r.children.length;i++){t.insert(e,n+i,r.children[i])}return true}};gmath.expressions[e]=this};var d=function(e){u.call(this);if(e){t.append(this,new l("("));t.append(this,e);t.append(this,new l(")"))}};c.call(d,"brackets",{bp:0});d.registerAtParser=function(t){var e=t.registerSymbol("(",30);e.nud=function(){var e=t.parseExpression(0);t.advance("\\right",true);t.advance(")");return new d(e)};t.registerSymbol("\\left").nud=function(){t.advance("(");return e.nud()};t.registerSymbol("\\right");t.registerSymbol(")");t.registerSymbol("{").nud=function(){var e=t.parseExpression(0);t.advance("}");return e};e.led=function(e){var r=t.parseExpression(v.prototype.bp,this);return v.createProduct(e,r)};t.registerSymbol("\\left",30).led=function(r){t.advance("(");return e.led(r)};t.registerSymbol("{");t.registerSymbol("}")};d.handle=function(e,r){if(e.is_group("brackets")){if(r&&d.is_optional(e)){t.replace(e,e.children[1]);return true}return false}if(!d.is_optional(e)){var n=t.remove(e);t.insert(e.parent,n,new d(e));return true}return false};d.is_optional=function(t,e){if(t.is_group("brackets")&&t.children[1].is_group("brackets"))return true;var r=t instanceof d?t.children[1]:t;var e=e||t.parent;if(!r.has_children())return true;if(e instanceof o)return true;if(e.is_group("sign")&&r.is_group("fraction"))return true;if(e.bp>r.bp)return false;if(e.bp<r.bp)return true;if(e instanceof p&&r instanceof p)return true;if(e.associative&&r.is_group(e.group_name))return true;if(r.commutative&&e.is_group(r.group_name))return true;if(r.is_group("product")&&e.is_group("div")&&e.parent&&e.parent.is_group("fraction"))return true;if(r.is_group("fraction")&&e.is_group("mul","div"))return true;return false};var p=function(e){u.call(this);if(e){t.append(this,new l("-"));t.append(this,e);d.handle(e)}};c.call(p,"sign",{bp:40,associative:true,commutative:false,inverse:"sign"});p.registerAtParser=function(t){t.registerSymbol("+").nud=function(){return t.parseExpression(p.prototype.bp)};t.registerSymbol("-").nud=function(){var e=t.parseExpression(p.prototype.bp);return new p(e)}};p.prototype.deconstruct=function(){var t=[];t.push(this);return t};var f=function(e,r){u.call(this);if(e){if(r=="add")this.value="add";else if(r=="sub")this.value="sub";else{if(e.is_group("sign")){this.value="sub";e=e.children[1]}else this.value="add"}this.value=this.value;t.append(this,new l(this.value=="add"?"+":"-"));t.append(this,e);d.handle(e)}else{this.value=r=="sub"?"sub":"add"}this.associative=this.value=="add";this.nodeFromPast=function(t){return this};this.nodeFromFuture=function(t){return this}};c.call(f,"add-sub",{group_name:"sum",group_cleanup_name:"SumCleanupAction",bp:20,associative:true,commutative:true,has_inverse:true});f.prototype.invert=function(){if(this.value=="add"){this.value="sub";if(this.children[0])this.children[0].value="-";this.associative=false}else{this.value="add";if(this.children[0])this.children[0].value="+";this.associative=true}};f.registerAtParser=function(t){var e=t.registerSymbol("+",f.prototype.bp);e.led=function(e){var r=t.parseExpression(f.prototype.bp);if(e.is_group("sum")){e.append(new f(r,"add"));return e}else{var n=f.prototype.createGroup();n.append(new f(e));n.append(new f(r,"add"));return n}};var r=t.registerSymbol("-",f.prototype.bp);r.led=function(e){var r=t.parseExpression(f.prototype.bp);if(e.is_group("sum")){e.append(new f(r,"sub"));return e}else{var n=f.prototype.createGroup();n.append(new f(e));n.append(new f(r,"sub"));return n}}};f.split=function(e,r){var n=1,i;if(e.is_group("product")&&e.children.length>1){if((e.children[0].children[1]instanceof s||e.children[0].children[1]instanceof p)&&!r){n=s.get_value(e.children[0].children[1]);i=e.children.slice(1)}else{i=e.children.slice()}}else i=[new v(t.clone(e))];return{num:n,variables:i}};f.prototype.absorbNegative=function(){var t=this.is_group("sub");var e=this.children[1];if(e.is_group("sign")){var r=e.children[1];e.remove();r.remove();this.append(r);this.invert()}};var g=function(){u.call(this)};c.call(g,"product",{bp:30,vertical_notation:false});g.prototype.invert=function(){var e=this.children.length;if(this.value=="product"){this.value="fraction";this.vertical_notation=true;var r=this.children[e-1],n=e-1;while(r&&r.value=="div"){r=r.ls;n--}if(!r||r.value!=="//")t.insert(this,n+1,new l("//"))}else{this.value="product";this.vertical_notation=false;if(e>0){var i=this.children[0];while(i){if(i.value=="//")t.remove(i);i=i.rs}}}};g.prototype.append=function(e){if(this.value=="product"&&e.value=="div"){this.invert();t.append(this,e)}else if(this.value=="fraction"&&e.value=="mul"){var r=0;while(r<this.children.length&&this.children[r].value!=="//")r++;t.insert(this,r,e)}else{t.append(this,e)}return this};g.prototype.clean_up=function(){var e=this.get_top().length,r=this.get_bottom().length;var n=false;if(e==0&&r==0){t.replace(this,new s(1));return true}if(this.value=="product"&&r>0){this.invert();n=true}if(this.value=="fraction"&&r==0){this.invert();n=true}if(this.value=="fraction"&&e==0){t.insert(this,0,new v(new s(1)));n=true}if(e==1&&r==0){var i=this.get_top()[0].children[1];t.replace(this,i);d.handle(i,true);n=true}return n};g.prototype.get_top=function(){var t=this.children[0],e=[];while(t){if(t.value=="mul")e.push(t);t=t.rs}return e};g.prototype.get_bottom=function(){var t=this.children[0],e=[];while(t){if(t.value=="div")e.push(t);t=t.rs}return e};g.prototype.get_fraction_bar=function(){var t=this.children[0];while(t){if(t.value=="//")return t;t=t.rs}return null};g.prototype.group_nodes=function(){var t=this.children[0],e=[],r=[],n;while(t){if(t.value=="div")r.push(t);else if(t.value=="mul")e.push(t);else n=t;t=t.rs}return{top:e,bottom:r,bar:n}};g.prototype.to_latex=function(){var t=this.get_top(),e=this.get_bottom();var r=e.length>0?"\\frac{":"";for(var n=0;n<t.length;n++){r+=n==0?t[n].children[1].to_latex():t[n].to_latex()}if(e.length>0){r+="}{";for(var n=0;n<e.length;n++){r+=n==0?e[n].children[1].to_latex():e[n].to_latex()}r+="}"}return r};g.prototype.to_ascii=function(){var t=this.get_top(),e=this.get_bottom();var r="",n="";for(var i=0;i<t.length;i++){r+=i==0?t[i].children[1].to_ascii():t[i].to_ascii()}if(e.length==0)return r;for(var i=0;i<e.length;i++){n+=(i==0?"":"*")+e[i].children[1].to_ascii()}if(t.length>1)r="("+r+")";if(e.length>1)n="("+n+")";var o=r+"/"+n;if(!d.is_optional(this)||this.parent.is_group("sign")||this.parent.commutative)return"("+o+")";else return o};var v=function(e,r){u.call(this);this.value=r=="div"?"div":"mul";if(e){t.append(this,new l(this.value=="mul"?"*":"/"));t.append(this,e);d.handle(e)}this.associative=this.value=="mul";this.bp=this.value=="mul"?30:30};c.call(v,"mul-div",{group_class:g,group_name:"product",inverse_group_name:"fraction",bp:30,associative:true,commutative:true,has_inverse:true});v.createProduct=function(t,e){if(t.is_group("product")){t.append(new v(e));return t}else{var r=v.prototype.createGroup();r.append(new v(t));r.append(new v(e));return r}};v.registerAtParser=function(t){var e=t.registerSymbol("*",v.prototype.bp);e.led=function(e){var r=t.parseExpression(v.prototype.bp);return v.createProduct(e,r)};var r=t.registerSymbol("\\cdot",v.prototype.bp);r.led=e.led;var n=t.registerSymbol("\\times",v.prototype.bp);n.led=e.led;var i=t.registerSymbol("/",v.prototype.bp+1);i.led=function(e){var r=t.parseExpression(v.prototype.bp+1);if(e.is_group("fraction")){e.append(new v(r,"div"));return e}else{var n;if(e.is_group("brackets")&&e.children[1].is_group("product")){e=e.children[1]}if(e.is_group("product")){n=e}else{n=v.prototype.createGroup();n.append(new v(e))}if(r.is_group("brackets")&&r.children[1].is_group("product")){r=r.children[1]}if(r.is_group("product")){var i=r.children;for(var o=0;o<i.length;o++){i[o].invert();n.append(i[o])}}else{n.append(new v(r,"div"))}return n}};var o=function(){var e=t.parseExpression(v.prototype.bp+1);var r=t.parseExpression(v.prototype.bp+1);var n;if(e.is_group("product"))n=e;else{n=v.prototype.createGroup();n.append(new v(e))}if(r.is_group("product")){r.children.forEach(function(t){t.invert();n.append(t)})}else n.append(new v(r,"div"));return n};t.registerSymbol("\\frac").nud=o;t.registerSymbol("\\dfrac").nud=o};v.hide_rule={name:"hide multiplication sign between variables",disabled:false,apply:function(t){if(!(t instanceof l)||t.value!=="*"&&t.value!=="/")return false;var e=t.parent;if(!e||!(e.is_group("mul")||e.is_group("div")))return false;if(!e.ls||e.ls.value!==e.value||!t.rs)return false;var r=e.ls.children[1];if(t.rs instanceof h||t.rs.is_group("power")&&t.rs.children[0]instanceof h){if(s.is_num(r)||r instanceof h||r.is_group("sign")&&r.children[1]instanceof h){if(e.dragging)t.hide_after_drop=true;else t.hidden=true}}}};v.prototype.invert=function(){if(this.value=="mul"){this.value="div";if(this.children[0])this.children[0].value="/";this.associative=false;this.bp=30}else{this.value="mul";if(this.children[0])this.children[0].value="*";this.associative=true;this.bp=30}};v.prototype.clean_up=function(){if(this.children[1].is_group("product")){var e=this.parent;var r=this.children[1];var n=r.children[0];if(n.value=="mul"&&n.children[0].hidden)t.replace(n.children[0],this.children[0]);var i=t.remove(this);for(var o=0;o<r.children.length;o++){if(this.value=="div")r.children[o].invert();t.insert(e,i+o,r.children[o])}return true}this.parent.clean_up()};var m=function(t,e){u.call(this);if(t&&e){this.append(t);if(e.is_group("exponent"))this.append(e);else this.append(new _(e));d.handle(t)}};c.call(m,"power",{bp:50,vertical_notation:false});var _=function(e){u.call(this);if(e){t.append(this,e);d.handle(e)}};c.call(_,"exponent",{group_class:m,group_name:"power",bp:50,vertical_notation:true});_.prototype.to_ascii=function(){if(this.children.length===0)return"";return"^"+this.children[0].to_ascii()};_.registerAtParser=function(t){t.registerSymbol("^",_.prototype.bp).led=function(e){var r=t.parseExpression(_.prototype.bp-1);return new m(e,r)};t.registerSymbol("\\sqrt").nud=function(){var e=t.parseExpression(Infinity);var r=v.prototype.createGroup();r.append(new v(new s(1)));r.append(new v(new s(2),"div"));var n=new m(e,r);return n};t.registerSymbol("\\scriptscriptstyle").nud=function(){var e=t.parseExpression(_.prototype.bp);return e}};var y=function(e){t.Node.call(this);if(e===1||e==="T"||e==="t"||e===true)this.value="T";else this.value="F";this.id=gmath.uid()};gmath.inherit(t.Node,y);y.prototype.to_string=function(){return this.value};y.prototype.to_ascii=y.prototype.to_string;y.prototype.is_group=function(){return false};y.registerAtParser=function(t){var e=t.registerSymbol("(number)");e.nud=function(){return new y(this.value)}};gmath.expressions=gmath.expressions||{};gmath.expressions.bool=y;var w=function(e){u.call(this);if(e){t.append(this,new l("∧"));t.append(this,e);d.handle(e)}};c.call(w,"and",{group_name:"disjunction",group_cleanup_name:"CommutativeGroupCleanup",bp:30,associative:true,commutative:true});w.registerAtParser=function(t){var e=t.registerSymbol("*",w.prototype.bp);e.led=function(e){var r=t.parseExpression(w.prototype.bp);if(e.is_group("disjunction")){e.append(new w(r));return e}else{var n=w.prototype.createGroup();n.append(new w(e));n.append(new w(r));return n}}};var b=function(e){u.call(this);if(e){t.append(this,new l("∨"));t.append(this,e);d.handle(e)}};c.call(b,"or",{group_name:"conjunction",group_cleanup_name:"CommutativeGroupCleanup",bp:20,associative:true,commutative:true});b.registerAtParser=function(t){var e=t.registerSymbol("+",b.prototype.bp);e.led=function(e){var r=t.parseExpression(b.prototype.bp);if(e.is_group("conjunction")){e.append(new b(r));return e}else{var n=b.prototype.createGroup();n.append(new b(e));n.append(new b(r));return n}}};var A=function(e,r){u.call(this);if(e&&r){t.append(this,e);t.append(this,new l("="));t.append(this,r)}};c.call(A,"equals",{bp:10});A.registerAtParser=function(t){var e=t.registerSymbol("=",A.prototype.bp);e.led=function(e){var r=t.parseExpression(A.prototype.bp);return new A(e,r)}};A.prototype.getSideOfNode=function(t){while(!(t.parent instanceof A))t=t.parent;return t};A.prototype.getOppositeSideOfNode=function(t){return this.isOnLeftSide(t)?this.getRightSide():this.getLeftSide()};A.prototype.getLeftSide=function(){return this.children[0]};A.prototype.getRightSide=function(){return this.children[2]};A.prototype.isOnLeftSide=function(t){return this.getSideOfNode(t)==this.getLeftSide()};A.prototype.isOnRightSide=function(t){return this.getSideOfNode(t)==this.getRightSide()};A.prototype.areOnSameSide=function(t,e){var r=this.isOnLeftSide(t),n=this.isOnLeftSide(e);return r&&n||!r&&!n};gmath.actions={};Action=function(t){this.name=t;this.priority=0;this.node_map={};this.touched_nodes={};this.new_selection=null;this.timeoutID=null};Action.prototype.createBoundAction=function(t,e){var r=new this.constructor(e);r.oldTree=t;r.newTree=t;return r};Action.prototype.createAndRun=function(t,e,r){var n=new this.constructor(e);n.oldTree=t;n.run(r);return n};Action.prototype.createAndDoInPlace=function(t,e,r){var n=new this.constructor(e);n.oldTree=t;n.newTree=t;n.doInPlace(r);return n};Action.prototype.initNodeMap=function(){this.node_map=this.oldTree.children[0].get_mapping_to(this.newTree.children[0])};Action.prototype.removeDeletedNodesFromNodeMap=function(){var t=this.newTree.select_all();var e=function(e){return t.indexOf(e)!==-1};for(var r in this.node_map){this.node_map[r]=this.node_map[r].filter(e)}};Action.prototype.updateNodeMap=function(t,e){if(arguments.length===1)gmath.extend(this.node_map,t);else{var r=t;if(Array.isArray(r)){for(var n=0;n<r.length;n++){this.node_map[r[n].id]=Array.isArray(e)?e:[e]}}else this.node_map[r.id]=Array.isArray(e)?e:[e]}};Action.pushNew=function(t,e){for(var r=0;r<e.length;r++){if(t.indexOf(e[r])===-1)t.push(e[r]);else{t.splice(t.indexOf(e[r]),1);t.push(e[r])}}};Action.prototype.extendNodeMap=function(t,e){if(arguments.length===2){var r=t;var n=Array.isArray(e)?e:[e];if(r.id in this.node_map)Action.pushNew(this.node_map[r.id],n);else this.node_map[r.id]=n;return}else{var i=t;for(var o in i){if(!i.hasOwnProperty(o))continue;if(o in this.node_map)Action.pushNew(this.node_map[o],i[o]);else this.node_map[o]=i[o]}}};Action.prototype.getNewTreeNode=function(t){return this.getCorrespondingNodeFromTree(t,this.newTree)};Action.prototype.getOldTreeNode=function(t){return this.getCorrespondingNodeFromTree(t,this.oldTree)};Action.prototype.getCorrespondingNodeFromTree=function(t,e){var r=function(t){return e.get_child(t.get_path())};if(Array.isArray(t))return t.map(r);else return r(t)};Action.prototype.addTouchedNodes=function(t){var e=this;t.for_each(function(t){e.touched_nodes[t.id]=true})};Action.prototype.reselectNodeAfterAction=function(t){if(!this.new_selection)this.new_selection=[];if(Array.isArray(t))this.new_selection=this.new_selection.concat(t);else this.new_selection.push(t)};Action.prototype.cleanup=function(t){if(!t.cleanupAction)return false;if(!t.cleanupAction.match(t))return false;var e=t.cleanupAction.createAndDoInPlace(this.newTree,{actor:t});this.compose(e);return e};Action.prototype.cleanup_cascade=function(t){var e=false;for(;;){var r=this.cleanup(t);if(!r)return e;e=true;var n=r.mapNodes(t);if(n.length===0)return e;t=n[0].parent}};Action.prototype.compose=function(t){for(var e in this.node_map){this.node_map[e]=t.mapNodes(this.node_map[e]);if(t.touched_nodes[e])this.touched_nodes[e]=true}this.newTree=t.newTree};Action.prototype.run=function(t){this.newTree=this.oldTree.clone();return this.doInPlace(t)};Action.prototype.match=function(){throw"called abstract method Action.match()"};Action.prototype.transform=function(t){throw"called abstract method Action.transform()"};Action.prototype.doInPlace=function(t){this.initNodeMap();this.transform(t);this.removeDeletedNodesFromNodeMap()};Action.prototype.updateNodesFromFutureAndPast=function(){console.warn("called abstract method Action.updateNodesFromFutureAndPast()")};Action.prototype.wasNodeTouched=function(t){return this.touched_nodes[t.id]};Action.prototype.mapNodes=function(t){var e=[],r=this;if(!Array.isArray(t))t=[t];t.forEach(function(t){var n=r.node_map[t.id]||[];n.forEach(function(t){if(e.indexOf(t)===-1)e.push(t)})});return e};Action.createComposedAction=function(t,e){var r=new Action(e);function n(){function e(n,i,o){if(o>=t.length)return n;if(!r.touched_nodes[i]){r.touched_nodes[i]=n.some(t[o].wasNodeTouched.bind(t[o]))}return e(t[o].mapNodes(n),i,o+1)}r.node_map={};r.touched_nodes={};for(var n in t[0].node_map){r.touched_nodes[n]=t[0].touched_nodes[n];r.node_map[n]=e(t[0].node_map[n],n,1)}}n();r.updateNodesFromFutureAndPast=function(){t.forEach(function(t){t.updateNodesFromFutureAndPast()})};return r};gmath.actions.CloneAction=function(){var t=function(){Action.call(this,"clone")};gmath.inherit(Action,t);t.prototype.transform=function(t){if(typeof t==="function")t(this);else return true};return new t}();gmath.actions.PostInteractionSimplificationAction=function(){var t=function(t){Action.call(this,"simplify terms after interaction");this.priority=0;if(t)this.nodes=t.nodes};gmath.inherit(Action,t);t.prototype.match=function(t){return true};t.prototype.transform=function(t){this.changed=false;var e=this.getNewTreeNode(this.nodes);for(var r=0;r<e.length;r++){var n=e[r],i=n.parent;if(n.is_group("brackets")){if(d.handle(n,true))this.changed=true;if(this.cleanup_cascade(i))this.changed=true}else if(this.muldiv1(n)||this.addsub0(n)){var o=i.parent;n.remove();this.cleanup(i);d.handle(o,true);this.changed=true}}if(typeof t==="function")t(this);else return this.changed};t.prototype.muldiv1=function(t){return t.is_group("mul","div")&&s.is_num(t.children[1])&&s.get_value(t.children[1])===1};t.prototype.addsub0=function(t){return t.is_group("add","sub")&&s.is_num(t.children[1])&&s.get_value(t.children[1])===0};return new t}();(function(){var e=function(t){Action.call(this,"add or subtract numbers");this.priority=1;if(t)this.actor=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){if(!t.parent.is_group("sum"))return false;if(!t.ls)return false;var e=t.ls.children[1],r=t.children[1];return s.is_num(e)&&!(e.is_group("sign")&&e.parent.is_group("sub"))&&s.is_num(r)&&!(r.is_group("sign")&&r.parent.is_group("sub"))};e.prototype.transform=function(e){var r=this.getNewTreeNode(this.actor),n=r.ls,i=r.parent;this.addTouchedNodes(this.actor);this.addTouchedNodes(this.actor.ls);var o=n.children[1],a=r.children[1];var l=(n.is_group("sub")?-1:1)*s.get_value(o)+(r.is_group("sub")?-1:1)*s.get_value(a);var h=n.is_group("add")&&n.children[1].is_group("sign");var u=new f(new s(l),h?"add":"auto");this.updateNodeMap(this.actor.get_mapping_to(u));this.updateNodeMap(this.actor.ls.get_mapping_to(u));var c=t.remove(n);t.remove(r);t.insert(i,c,u);this.cleanup(i);if(typeof e==="function")e(this);return this};e.prototype.updateNodesFromFutureAndPast=function(){var e=this.actor.ls;var r=this.actor;var n=t.get_root(e);var i=n.numeric_value(e);var o=n.numeric_value(r);var a=this;function s(t){return a.mapNodes([t])[0]}function l(t,e,r){return[r-e,e]}e.nodeFromFuture=function(t){var e=s(this);var r=n.numeric_value(e);if(t.type=="changeNumber"){n.numeric_value(this,l(i,o,r)[0])}return this};e.children[0].nodeFromFuture=function(){return this};e.children[1].nodeFromFuture=function(){return this};r.nodeFromFuture=function(t){var e=s(this);var r=n.numeric_value(e);if(t.type=="changeNumber"){n.numeric_value(this,l(i,o,r)[1])}return this};r.children[0].nodeFromFuture=function(){return this};r.children[1].nodeFromFuture=function(){return this};if(t.get_root(e).timeState.children[0]){var h=a.mapNodes(e)[0];var u=n.timeState.children[0].mathObject;h.nodeFromPast=function(t){console.log("Tell me what you want");u.numeric_value(this,n.numeric_value(e)+n.numeric_value(r))};if(h.children&&h.children.length==2){h.children[0].nodeFromPast=function(t){return this};h.children[1].nodeFromPast=function(t){return this}}}return true};f.prototype.add_action_handler(new e)})();(function(){var e=function(t){Action.call(this,"sum cleanup action");if(t)this.sum=t.actor};gmath.inherit(Action,e);gmath.actions.SumCleanupAction=e;e.prototype.match=function(t){return t.is_group("sum")&&t.children.length<=1};e.prototype.doInPlace=function(e){this.initNodeMap();var r=this.getNewTreeNode(this.sum);if(r.children.length===0){t.remove(r)}else if(r.children.length===1){var n=r.children[0],i=this.sum.children[0],o;if(n.is_group("add")){o=n.children[1];this.updateNodeMap(i.children[0],o)}else if(n.is_group("sub")){if(n.children[1].is_group("product")){var a=n.children[1].children[0].children[1],s=a.parent;a.remove();var l=new p(a);s.append(l);o=n.children[1]}else{o=new p(n.children[1])}this.updateNodeMap(i.children[0],o.children[0])}this.updateNodeMap(i,o);this.updateNodeMap(i.parent,o);t.replace(n.parent,o);if(o.parent&&o.parent.is_group("brackets"))d.handle(o.parent,true);else d.handle(o)}if(typeof e==="function")e(this);else return this}})();gmath.actions.AssociateIntoFractionAction=function(){var e=function(t){Action.call(this,"associative property of multiplication--move into fraction");this.priority=0;if(t){if(t.actor)t=this.getSettingsFromActor(t.actor);this.nodes=t.nodes;this.target=t.target;this.side=t.side}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){if(t.length===0)return[];var e=[],r=t[0],n=t[t.length-1],i=t[0].parent,o=this,a=r.get_root(),o=this;function s(r){if(r.is_group("mul"))r=r.children[1];if(!r.is_group("fraction"))return;for(var n=0;n<r.children.length;n++){var i=r.children[n];if(!i.is_group("mul"))return;if(o.match(t,i,"left"))e.push(o.createBoundAction(a,{nodes:t,target:i,side:"left-of"}));if(o.match(t,i,"right"))e.push(o.createBoundAction(a,{nodes:t,target:i,side:"right-of"}))}}if(r.parent!==n.parent)return[];var l=i.children[0];while(l!==r){s(l);l=l.rs}l=i.children[i.children.length-1];while(l!==n&&l){s(l);l=l.ls}return e};e.prototype.getSettingsFromActor=function(t){var e,r,n;if(t&&t.children[1]&&t.children[1].is_group("fraction")){e=t.children[1].children[0];r=[t.ls];n="left-of"}else if(t&&t.ls&&t.ls.children[1]&&t.ls.children[1].is_group("fraction")){var i=t.ls.children[1];var o=i.get_top();e=o[o.length-1];r=[t];n="right-of"}return{target:e,nodes:r,side:n}};e.prototype.match=function(e,r,n){if(arguments.length==1){var i=this.getSettingsFromActor(e);e=i.nodes;r=i.target;n=i.side}if(!e||e.length==0)return false;if(!n)return false;if(!r||!r.is_group("mul")||!r.parent.is_group("fraction"))return false;if(!r.parent.parent||r.parent.parent.parent!==e[0].parent)return false;if(!e.every(function(t){return t.is_group("mul")&&t.children[1]!==r.parent}))return false;if(!t.is_range(e))return false;return true};e.prototype.transform=function(e){var r=this.oldTree===this.newTree;var n=r?this.nodes:this.getNewTreeNode(this.nodes);var i=r?this.target:this.getNewTreeNode(this.target);var o=i.parent;var a=o.children.indexOf(i);if(this.side==="right-of")a++;var l=o.get_top();if(l.length===1&&s.get_value(l[0].children[1])===1){l[0].remove();if(this.side==="right-of")a--}t.remove_range(n);o.insert_range(a,n);for(var h=0;h<n.length;h++){n[h].update_x_during_dragging=true}this.cleanup(o);this.cleanup(o.parent);if(typeof e==="function")e(this);else return true};v.prototype.add_action_handler(new e);return new e}();o.prototype.move_actions.push(gmath.actions.AssociateIntoFractionAction);gmath.actions.AssociateOutOfFractionAction=function(){var e=function(t){Action.call(this,"associative property of multiplication--move out of fraction");if(t){this.nodes=t.nodes;this.target=t.target;this.side=Array.isArray(this.target)?"around":t.side;this.target_is_left=t.side==="left-of";this.priority=t.priority||0}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){if(t.length===0)return[];var e=t[0];if(!e.is_group("mul")||!e.parent.is_group("fraction"))return[];if(this.match(t,e.parent)){return[this.bindAction(t,"left-of"),this.bindAction(t,"right-of")]}return[]};e.prototype.bindAction=function(t,e){var r=t[0].get_root();var n=[];if(this.fractionIsPartOfProduct(t)){n=this.getSiblingsOfFraction(t,e)}return this.createBoundAction(r,{nodes:t,target:n.length>0?n:t[0].parent,side:e})};e.prototype.fractionIsPartOfProduct=function(t){var e=t[0].parent;return e.parent&&e.parent.is_group("mul")};e.prototype.getSiblingsOfFraction=function(t,e){var r=t[0].parent,n=r.parent,i=n.parent;if(e==="left-of")return i.children.slice(0,i.children.indexOf(n));else return i.children.slice(i.children.indexOf(n)+1)};e.prototype.match=function(e,r){if(e.length===0)return false;if(!this.allNodesAreMuls(e)||!t.is_range(e))return false;return e[0]&&e[0].parent===r&&r.is_group("fraction")};e.prototype.allNodesAreMuls=function(t){for(var e=0;e<t.length;e++){if(!t[e].is_group("mul"))return false}return true};e.prototype.transform=function(e){var r=this.getNewTreeNode(this.nodes);t.remove_range(r);var n=r[0].parent;var i=new g;n.replace_with(i);i.append(new v(n));i.insert_range(this.target_is_left?0:1,r);this.cleanup(n);this.cleanup(i.parent);for(var o=0;o<r.length;o++){r[o].update_x_during_dragging=true}if(typeof e==="function")e(this);else return true};return new e}();o.prototype.move_actions.push(gmath.actions.AssociateOutOfFractionAction);(function(){var e=function(t){Action.call(this,"add or subtract a bracketed sum");if(t)this.actor=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){if(!t.is_group("add")&&!t.is_group("sub"))return false;if(!t.children[1].is_group("brackets")||!t.children[1].children[1].is_group(t.group_name))return false;return true};e.prototype.transform=function(e){var r=this.getNewTreeNode(this.actor);var n=this.actor.children[0];this.addTouchedNodes(this.actor);var i=r.children[1];var o=r.children[1].children[1];t.replace(i,o);if(r.is_group("sub")){r.invert();var a=[];for(var s=0;s<o.children.length;s++){o.children[s].invert();a.push(o.children[s].children[0])}this.updateNodeMap(n,a)}this.cleanup(r);if(typeof e==="function")e(this);else return this};f.prototype.add_action_handler(new e)})();(function(){var e=function(t){Action.call(this,"addsub cleanup action");if(t)this.addsub=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){return t.is_group("add","sub")&&t.children[1].is_group("sum")};e.prototype.doInPlace=function(e){this.initNodeMap();var r=this.getNewTreeNode(this.addsub);if(r.is_group("add","sub")&&r.children[1].is_group("sum")){var n=r.is_group("sub");var i=r.parent;var o=r.children[1];var a=t.remove(r);if(n)for(var s=0;s<o.children.length;s++)o.children[s].invert();i.insert_range(a,o.children)}if(typeof e==="function")e(this);else return this};f.prototype.cleanupAction=new e})();(function(){var e=function(t){Action.call(this,"add variables");this.priority=0;if(t)this.actor=t.actor};gmath.inherit(Action,e);e.prototype.match=function(e){if(!e.ls)return false;var n=this.getVariableRangeFromAddend(e),i;if(n.length<1)return false;i=t.filterRange(u(r(n)),e.ls);i=i.concat(t.filter(c(o(n)),e.ls));if(i.length!==1)return false;var a=e.parent,s;try{if(Array.isArray(i[0]))s=t.get_parent(3,i[0][0]);else s=t.get_parent(2,i[0]);if(!a.is_group("sum")||!s.is_group("sum")||a!==s)return false}catch(l){if(l==="invalid path")return false;throw l}if(!this.coefficientsAreOnlyNumbers(i[0]))return false;return true};e.prototype.getVariableRangeFromAddend=function(e){var r=e.children[1];if(h.is_var(r)||r.is_group("brackets"))return[new v(t.clone(r))];else if(r.is_group("product"))return this.getVariableRangeFromProduct(r);else return[]};e.prototype.getVariableRangeFromProduct=function(t){var e=[t.children[0].children[1],t.children[t.children.length-1].children[1]];var r;if(s.is_num(e[0])&&s.is_num(e[1]))return[];else if(!s.is_num(e[0])&&!s.is_num(e[1])){r="none"}else{r=s.is_num(e[0])?"front":"back"}var n,i;if(r==="none"){n=0;i=t.children.length}else if(r==="front"){n=1;i=t.children.length}else{n=0;i=t.children.length-1}var o=[];for(var a=n;a<i;a++){var l=t.children[a].children[1];if(h.is_var(l)||l.is_group("brackets"))o.push(l.parent);else return[]}return o};e.prototype.coefficientsAreOnlyNumbers=function(t){if(!Array.isArray(t))return true;var e=t[0].parent;for(var r=0;r<e.children.length;r++){var n=e.children[r];if(t.indexOf(n)===-1&&!s.is_num(n.children[1]))return false}return true};e.prototype.transform=function(e){var r=this;this.addTouchedNodes(this.actor);this.addTouchedNodes(this.actor.ls);var n=this.getNewTreeNode(this.actor);var i=n.ls.children[1],o=n.children[1];if(!i.is_group("product"))i=x(i);if(!o.is_group("product"))o=x(o);var a,l;a=b(i);l=b(o);var h=a.coefficient*(n.ls.is_group("sub")?-1:1)+l.coefficient*(n.is_group("sub")?-1:1);var u=v.prototype.createGroup();u.append(new v(new s(Math.abs(h))));u.append_range(a.variables);var c=h<0?new f(u,"sub"):new f(u,"add");var d=i.children.length===a.variables.length||!this.actor.ls.children[1].is_group("product"),p=o.children.length===l.variables.length||!this.actor.children[1].is_group("product");if(!this.actor.ls.children[1].is_group("product")){this.updateNodeMap(this.actor.ls,c);this.updateNodeMap(this.actor.ls.children[0],c.children[0]);this.updateNodeMap(this.actor.ls.children[1],c.children[1].children[1].children[1])}else{this.updateNodeMap(this.actor.ls,c);this.updateNodeMap(this.actor.ls.children[0],c.children[0]);this.updateNodeMap(this.actor.ls.children[1],c.children[1]);var g=this.actor.ls.children[1];var m=d?1:0;for(var _=0;_<g.children.length;_++){this.updateNodeMap(g.children[_].get_mapping_to(c.children[1].children[_+m]))}}if(!this.actor.children[1].is_group("product")){this.updateNodeMap(this.actor,c);this.updateNodeMap(this.actor.children[0],c.children[0]);this.updateNodeMap(this.actor.children[1],c.children[1].children[1].children[1])}else{this.updateNodeMap(this.actor,c);this.updateNodeMap(this.actor.children[0],c.children[0]);this.updateNodeMap(this.actor.children[1],c.children[1]);var y=this.actor.children[1];var m=p?1:0;for(var _=0;_<y.children.length;_++){this.updateNodeMap(y.children[_].get_mapping_to(c.children[1].children[_+m]))}}t.remove(n.ls);var w=t.remove(n);t.insert(n.parent,w,c);if(Math.abs(h)===1){u.children[0].remove();this.cleanup(u)}else if(Math.abs(h)===0){t.replace(u,u.children[0].children[1])}this.cleanup(c);if(!(Math.abs(h)===1||Math.abs(h)===0)&&u&&u.parent)this.cleanup(u.parent);if(typeof e==="function")e(this);return true;function x(t){var e=t.parent;t.remove();var r=v.prototype.createGroup();r.append(new v(new s(1)));r.append(new v(t));
e.append(r);return r}function b(t){var e=A(t);var r,n;if(e===-1){r=1;n=t.children.slice()}else if(e===0){r=s.get_value(t.children[e].children[1]);n=t.children.slice(1)}else{r=s.get_value(t.children[e].children[1]);n=t.children.slice(0,e)}return{coefficient:r,variables:n,coefficientIDX:e}}function A(t){var e=t.children;for(var r=0;r<e.length;r++){if(s.is_num(e[r].children[1]))return r}return-1}};function r(t){if(t.length===1&&t[0].hidden)return"";return t.map(function(t){return t.to_ascii()}).join("")}function n(t){return t.is_group()&&t.commutative&&t.associative}function i(t){if(t.length===0)return"";if(t.length===1&&t[0].hidden)return"";var e=t.map(function(t){return t.to_ascii()}).join("");if(t.length===1)return e;if(n(t[0]))return e.substring(t[0].children[0].to_ascii().length);return e}function o(t){if(t.length===0)return"";if(t.length===1&&t[0].hidden)return"";var e=t.map(function(t){return t.to_ascii()}).join("");if(n(t[0]))return e.substring(t[0].children[0].to_ascii().length);return e}function a(t){return t.length===t[0].parent.children.length}function l(t){return t.parent}function u(t){return function(e){if(e.length===0)return false;if(!e[0].parent)return false;if(l(e[0].parent)&&a(e))return false;return r(e)===t||i(e)===t}}function c(t){return function(e){if(!e.parent)return false;if(!e.parent.is_group("add")&&!e.parent.is_group("sub"))return false;return e.to_ascii()===t}}function d(t){return function(e){if(t[0].is_group("add")||t[0].is_group("sub"))return t[0].children[1]!==e;return t[0]!==e[0]}}f.prototype.add_action_handler(new e)})();(function(){var e=function(t){Action.call(this,"rearrange signs");if(t)this.actor=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){var e=t.children[1];if(e.is_group("sign"))return true;return false};e.prototype.transform=function(e){var r=this.getNewTreeNode(this.actor);var n=this.actor.children[1].children[0];this.addTouchedNodes(this.actor.children[0]);this.addTouchedNodes(n);var i=r.children[1];r.invert();this.updateNodeMap(n,r.children[0]);t.replace(i,i.children[1]);if(typeof e==="function")e(this);else return true};f.prototype.add_action_handler(new e)})();(function(){var e=function(t){Action.call(this,"x+-y*z=x-y*z");if(t){this.actor=t.actor;this.priority=t.priority||0}};gmath.inherit(Action,e);e.prototype.match=function(t){if(!t.children[1].is_group("product"))return false;var e=t.children[1].children[0].children[1];if(!e.is_group("sign"))return false;return true};e.prototype.transform=function(e){var r=this.getNewTreeNode(this.actor);var n=r.children[1].children[0].children[1];var i=this.getOldTreeNode(n.children[0]);this.addTouchedNodes(this.actor.children[0]);this.addTouchedNodes(i);this.updateNodeMap(i,r.children[0]);t.replace(n,n.children[1]);r.invert();if(typeof e==="function")e(this);else{console.warn("no callback function was passed to this async method.");return true}};f.prototype.add_action_handler(new e)})();RemoveBracketsAction=function(){var e=function(t){Action.call(this,"remove optional brackets");this.priority=4;if(t){this.actor=t.actor}};gmath.inherit(Action,e);e.prototype.match=function(t){return t.is_group("brackets")&&d.is_optional(t)};e.prototype.transform=function(e){var r=this.getNewTreeNode(this.actor);this.addTouchedNodes(this.actor.children[0]);this.addTouchedNodes(this.actor.children[2]);var n=t.replace(r,r.children[1]);this.cleanup(n.parent);if(typeof e==="function")e(this);else return true};var r=new e;d.prototype.add_action_handler(r);return r}();gmath.actions.editLineAction=function(){var t=function(t){Action.call(this,"rewrite dl line");if(t){this.actor=t.actor;this.priority=t.priority||0}};gmath.inherit(Action,t);t.prototype.match=function(){return typeof Keyboard!=="undefined"&&Keyboard!==null};t.prototype.removeAllNodesFromNodeMap=function(){var t=this.newTree.select_all();for(var e in this.node_map){this.node_map[e]=[]}};t.prototype.transform=function(t){var e;var r=Keyboard();r.caption("What do you want to change in this line?").on("done",i).on("cancel",o)();var n=this;function i(e){var i=n.newTree;var o=i.parse(e,true);if(!o)return;i.children[0].remove();i.append(o);r.visible(false);r.on("done",null).on("cancel",null);n.removeAllNodesFromNodeMap();t(n)}function o(){console.log("cancelled");r.visible(false);r.on("done",null).on("cancel",null);t(false)}r.latex(n.newTree.to_latex()).visible(true)};return new t}();gmath.actions.DirectFactoringAction=function(){var e=function(t){Action.call(this,"direct factor");if(t){this.nodes=t.nodes;this.target=t.target;this.side="inside";this.placement=t.placement;this.priority=t.priority||0;this.delay=500}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(e){var n=[];var i=e.filter(function(t){return t.is_group()});if(e.length===0||i.length===0)return n;var a=e[0].get_root();var s,l;var d;if(this.nodesAreAFractionResultingFromAPreviousFactoringAction(e)){s=e[0].children[1].get_bottom();d=true}else if(this.nodesArePartOfAProductWithinASum(e)){if(!t.is_range(e))return n;s=e}else if(this.nodesAreASingleAddend(e)){s=this.getEntireRangeFromAddend(e);if(s.length===1)s=this.temporarilyReinterpretRangeAsMulDiv(s)}else{return n}l=a.filterRange(h(r(s)));l=l.concat(a.filter(u(o(s))));l=l.filter(c(e));l=l.filter(p(e));n=n.concat(this.bindActionsFromRanges(e,l));if(d){this.useFractionsInsteadOfDenominatorsAsTargets(n)}return n};e.prototype.nodesAreAFractionResultingFromAPreviousFactoringAction=function(t){if(!t[0].is_group("mul"))return false;var e=t[0].children[1];if(!e.is_group("fraction"))return false;var r=e.get_top();if(r.length!==1||!s.get_value(r[0].children[1])===1)return false;var n=t[0].parent;if(n.children.length!==2)return false;var i=n.children[n.children.indexOf(t[0])===0?1:0].children[1];if(!i.children[1]||!i.children[1].is_group("sum"))return false;return true};e.prototype.nodesArePartOfAProductWithinASum=function(t){var e=t[0];if(e.parent&&e.parent.is_group("fraction")&&e.parent.parent.is_group("mul"))e=e.parent.parent;var r=e;if(!r.parent)return false;var n=r.parent;if(!n.parent)return false;var i=n.parent;if(!i.parent)return false;var o=i.parent;return r.is_group("mul","div")&&n.is_group("product","fraction")&&(i.is_group("add")||i.is_group("sub"))&&o.is_group("sum")};e.prototype.bindActionsFromRanges=function(t,e){var r=t[0].get_root();var n=[];for(var i=0;i<e.length;i++){n.push(this.createBoundAction(r,{nodes:t,target:e[i]}))}return n};e.prototype.nodesAreASingleAddend=function(t){if(t.length!==1)return false;return t[0].is_group("add")||t[0].is_group("sub")};e.prototype.getEntireRangeFromAddend=function(t){var e=t[0],r=e.children[1];var n;if(r.is_group("product")){n=r.children}else{n=[r]}return n};e.prototype.useFractionsInsteadOfDenominatorsAsTargets=function(t){for(var e=0;e<t.length;e++){var r=t[e];if(r.target.length===r.target[0].parent.get_bottom().length){r.target=r.target[0].parent.parent;r.prevFracState=true}}};e.prototype.temporarilyReinterpretRangeAsMulDiv=function(e){return[new v(t.clone(e[0]))]};e.prototype.transform=function(t){var e=this;if(this.prevFracState){this.target=this.target.children[1].get_bottom().slice()}var r=Array.isArray(this.target)?this.target:[this.target],n=this.nodes;var i=this.getNewTreeNode(r),o=this.getNewTreeNode(n);if(this.prevFracState){for(var a=0;a<i;a++){}}if(c(o)){o=p(o)}if(c(i)){i=p(i)}var l=g(o),h=g(i);l.left_of_target=l.idxOfAddendInSum<h.idxOfAddendInSum;if(!m(l)){l=_(l)}else{l.addend.remove();l.sumOfCoefficients=l.left_of_target?l.product.children[0].children[1].children[1]:l.product.children[l.product.children.length-1].children[1].children[1]}A(h);N(h,l);h.sum.insert(l.left_of_target?h.idxOfAddendInSum-1:h.idxOfAddendInSum,l.addend);M(r,o);k(l);L(l);this.cleanup_cascade(h.sum);var u=T(l);P(u);if(typeof t==="function")t(this);else return true;function c(t){var e=t[0];return e.is_group("add")||e.is_group("sub")||e.parent.is_group("add")||e.parent.is_group("sub")}function p(t){var r=t[0].parent.is_group("add")||t[0].parent.is_group("sub");var n=r?t[0].parent:t[0],i=n.children[1];i.remove();var o=v.prototype.createGroup();o.append(new v(new s(1)));o.append(new v(i));n.append(o);e.cleanup(o);e.cleanup(o.children[1]);e.updateNodeMap(e.getOldTreeNode(n),o.children.slice(1));return o.children.slice(1)}function g(t){var e={};e.range=t;var r=t[0];if(r.parent.is_group("product")){e.product=r.parent;e.addend=e.product.parent}else if(r.parent.is_group("fraction")){e.fraction=r.parent;if(e.fraction.parent.is_group("mul")){e.product=e.fraction.parent.parent;e.addend=e.product.parent}else{e.addend=e.fraction.parent}}else{throw"Can't identify structure for direct factoring."}e.sum=e.addend.parent;e.idxOfAddendInSum=e.sum.children.indexOf(e.addend);return e}function m(t){if(t.fraction)return false;if(!t.product.children[0].children[1].is_group("brackets")&&!t.product.children[t.product.children.length-1].children[1].is_group("brackets"))return false;if(t.product.children.length-1!==t.range.length)return false;return true}function _(t){y(t);var e=w(t);return e}function y(t){var e=t.range;for(var r=0;r<e.length;r++){e[r].remove()}}function w(t){var e=v.prototype.createGroup();x(e,t.range);b(t);var r=f.prototype.createGroup();t.addend.remove();r.append(t.addend);var n=new d(r);var i=v.prototype.createGroup();if(t.left_of_target){i.append(new v(n));i.append(new v(e))}else{i.append(new v(e));i.append(new v(n))}var o=new f(i);var a={};a.addend=o;a.product=i;a.sumOfCoefficients=r;a.left_of_target=t.left_of_target;return a}function x(t,e){for(var r=0;r<e.length;r++){t.append(e[r]);e[r].update_x_during_dragging=true;e[r].update_y_during_dragging=true}return t}function b(t){var r,n;if(t.fraction){r=t.fraction.parent;e.cleanup(t.fraction);if(r.is_group("mul")&&s.get_value(r.children[1])===1){r.remove();n=true}}if(t.product){if(r&&!n)e.cleanup(r);e.cleanup(t.product)}}function A(t){t.addend.remove();y(t)}function N(t,e){if(e.left_of_target)e.sumOfCoefficients.append(t.addend);else e.sumOfCoefficients.insert(0,t.addend)}function M(t,r){if(t.length>1&&r.length===1||t[0].is_group("div")){for(var n=0;n<t.length;n++){e.updateNodeMap(t[n],r[0]);e.updateNodeMap(t[n].children[0],r[0].children[0])}}else{for(var n=0;n<t.length;n++){if(!t[n].is_group("mul")&&r[n].is_group("mul"))e.updateNodeMap(t[n].get_mapping_to(r[n].children[1]));else e.updateNodeMap(t[n].get_mapping_to(r[n]))}}}function k(t){var r=t.sumOfCoefficients;for(var n=0;n<r.children.length;n++){var i=r.children[n].children[1];e.cleanup(i)}for(var n=0;n<r.children.length;n++){var i=r.children[n];d.handle(i);e.cleanup(i)}}function L(t){var r=t.product;for(var n=0;n<r.children.length;n++){e.cleanup(r.children[n].children[1])}for(var n=0;n<r.children.length;n++){e.cleanup(r.children[n])}}function T(t){var r;var n=t.product.children.indexOf(t.sumOfCoefficients.parent.parent);if(n===0){r=t.product.children.slice(1)}else{r=t.product.children.slice(0,t.product.children.length-1)}e.reselectNodeAfterAction(r);return r}function P(t){for(var e=0;e<t.length;e++){t[e].update_x_during_dragging=true}}};function r(t){if(t.length===1&&t[0].hidden)return"";return t.map(function(t){return t.to_ascii()}).join("")}function n(t){return t.is_group()&&t.commutative&&t.associative}function i(t){if(t.length===0)return"";if(t.length===1&&t[0].hidden)return"";var e=t.map(function(t){return t.to_ascii()}).join("");if(t.length===1)return e;if(n(t[0]))return e.substring(t[0].children[0].to_ascii().length);return e}function o(t){if(t.length===0)return"";if(t.length===1&&t[0].hidden)return"";var e=t.map(function(t){return t.to_ascii()}).join("");if(n(t[0]))return e.substring(t[0].children[0].to_ascii().length);return e}function a(t){return t.length===t[0].parent.children.length}function l(t){return t.parent}function h(t){return function(e){if(e.length===0)return false;if(!e[0].parent)return false;if(l(e[0].parent)&&a(e))return false;return r(e)===t||i(e)===t}}function u(t){return function(e){if(!e.parent)return false;if(!e.parent.is_group("add")&&!e.parent.is_group("sub"))return false;return e.to_ascii()===t}}function c(t){return function(e){if(t[0].is_group("add")||t[0].is_group("sub"))return t[0].children[1]!==e;for(var r=0;r<e.length;r++){for(var n=0;n<t.length;n++){if(e[r]===t[n])return false}}return true}}function p(e){return function(r){try{var n,i;if(e[0].is_group("mul")||e[0].is_group("div")){var o=e[0];if(o.parent.is_group("fraction")&&o.parent.parent.is_group("mul"))o=o.parent.parent;n=t.get_parent(1,o);i=t.get_parent(2,n)}else if(e[0].is_group("add")||e[0].is_group("sub")){n=null;i=t.get_parent(1,e[0])}else{return false}var a,s;var l=Array.isArray(r)?r[0]:r;if(l.is_group("mul")||l.is_group("div")){if(l.parent.is_group("fraction")&&l.parent.parent.is_group("mul"))l=l.parent.parent;a=t.get_parent(1,l);s=t.get_parent(2,a)}else{a=null;s=t.get_parent(2,l)}if(n&&a&&n===a){return false}if(i!==s){return false}}catch(h){if(h==="invalid path")return false;throw h}return true}}return new e}();o.prototype.move_actions.push(gmath.actions.DirectFactoringAction);gmath.actions.CommuteAction=function(){var e=function(t){Action.call(this,"commute terms");if(t){this.nodes=t.nodes;this.target=t.target;this.side=t.side}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(e){if(e.length===0)return[];var r=e[0].get_root();var n=[];var i=e[0].parent.is_group("flat"),o;if(i)return[];if(!e[0].commutative||!t.is_range(e))return[];for(o=e[0].ls;o&&o.value!=="//";o=o.ls){if(this.match(e,o,"left-of"))n.push(this.createBoundAction(r,{nodes:e,target:o,side:"left-of"}))}for(o=e[e.length-1].rs;o&&o.value!=="//";o=o.rs){if(this.match(e,o,"right-of"))n.push(this.createBoundAction(r,{nodes:e,target:o,side:"right-of"}))}return n};e.prototype.match=function(t,e,r){if(e.parent!==t[0].parent)return false;if(!t[0].commutative)return false;if(r==="left-of"&&e.ls===t[t.length-1])return false;if(r==="right-of"&&e.rs===t[0])return false;return true};e.prototype.transform=function(e){var r=this.getNewTreeNode(this.nodes);var n=this.getNewTreeNode(this.target);var i=n.parent,o=i.children.indexOf(n);if(r.length===1){r[0].remove();i.insert(o,r[0])}else{if(this.side==="right-of")o++;var a=t.remove_range(r);i.insert_range(a<o?o-r.length:o,r)}if(typeof e==="function")e(this);else return true};return new e}();o.prototype.move_actions.push(gmath.actions.CommuteAction);gmath.actions.EqInvertAction=function(){var e=function(t){Action.call(this,"invert terms across equation");if(t){this.nodes=t.nodes;this.target=t.target;this.side=t.side;this.priority=t.priority||0}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(e){var r=this;var n=[];if(o())return n;var i={};s();if(l()){h()}else{p()}return n;function o(){return e.length===0||!a()||!t.is_range(e)}function a(){var t=e[0];var r=t.get_root();var n=t.get_path();if(n[1]!==0&&n[1]!==2)return false;return r.children[0].is_group("equals")&&(t.has_inverse&&t.parent&&t.parent.parent&&t.parent.parent.is_group("equals")||t.parent.is_group("equals"))}function s(){i.tree=e[0].get_root();i.targetSide=i.tree.children[0].getOppositeSideOfNode(e[0])}function l(){return e[0].value!=="mul"&&e[0].value!=="div"}function h(){u();c();d()}function u(){i.target=i.targetSide.is_group("sum")?i.targetSide.children:[i.targetSide]}function c(){for(var t=i.target.length-1;t>=0;t--){var o=i.target[t];n.push(r.createBoundAction(i.tree,{nodes:e,target:o,side:"left-of"}))}}function d(){var t=i.target[i.target.length-1];n.push(r.createBoundAction(i.tree,{nodes:e,target:t,side:"right-of"}))}function p(){n.push(r.createBoundAction(i.tree,{nodes:e,target:i.targetSide,side:"around"}))}};e.prototype.transform=function(e){var r=this;var n={};i();o();a();l();y();x();E();if(typeof e==="function")e(this);else return true;function i(){n.nodes=r.nodes.map(r.getNewTreeNode.bind(r))}function o(){n.target=r.getNewTreeNode(r.target)}function a(){r.nodes.forEach(r.addTouchedNodes.bind(r))}function l(){if(h()){u()}if(c()){d();t.remove_range(n.nodes)}else{p()}}function h(){if(n.nodes[0].parent)return n.nodes[0].parent.children.length===n.nodes.length;return false}function u(){n.nodes=[n.nodes[0].parent]}function c(){return n.nodes[0].has_inverse}function d(){n.nodesParent=n.nodes[0].parent}function p(){n.nodes[0].replace_with(new s(0));g()}function g(){if(!m())_()}function m(){return n.nodes[0].is_group("sum")}function _(){n.nodes[0]=new f(n.nodes[0]);r.updateNodeMap(r.nodes[0],n.nodes[0]);n.nodes=[n.nodes[0]]}function y(){if(m())w();else n.nodes.forEach(function(t){t.invert()})}function w(){for(var t=0;t<n.nodes[0].children.length;t++)n.nodes[0].children[t].invert()}function x(){if(m())b();if(!A())N();P();D();k();r.cleanup(n.group)}function b(){var t=n.nodes[0];n.nodes=n.nodes[0].children;r.updateNodeMap(t,n.nodes)}function A(){if(n.target.children&&n.target.children.length>0&&n.target.children[0].value==="mul"&&(n.target.children[0].group_name===n.nodes[0].group_name||n.target.children[0].inverse_group_name===n.nodes[0].group_name))return true;return n.target.group_name===n.nodes[0].group_name||n.nodes[0].inverse_group_name&&n.target.is_group(n.nodes[0].inverse_group_name)}function N(){M();L()}function M(){n.group=n.nodes[0].createGroup();var e=n.target.parent;var r=t.remove(n.target);t.insert(e,r,n.group)}function k(){if(n.nodes[0].value==="div"&&n.group.value==="product")n.group.invert();else if(n.nodes[0].value==="mul"&&n.group.is_group("fraction")){var e=n.group.parent;var r=n.group.remove();t.remove_range(n.nodes);var i=v.prototype.createGroup();i.append(new v(n.group));i.append_range(n.nodes);e.insert(r,i)}}function L(){var t=new n.nodes[0].constructor(n.target);n.group.append(t);if(t.is_group("mul")&&s.get_value(t.children[1])===1||t.is_group("add","sub")&&s.get_value(t.children[1])===0){t.simplify=true}n.target=t}function T(){return n.nodes[0].is_group("add","sub")&&s.get_value(n.target)===0||n.nodes[0].is_group("mul")&&s.get_value(n.target)===1}function P(){if(r.side==="right-of"||r.side==="left-of"){if(!n.group)n.group=n.target.parent;n.insertionPoint=n.group.children.indexOf(n.target);if(n.insertionPoint===-1)n.insertionPoint=0;if(r.side==="right-of")n.insertionPoint++}else{if(n.target.value==="product"||n.target.value==="fraction")n.group=n.target;if(n.group.is_group("product")||n.group.is_group("fraction")&&n.nodes[0].is_group("div"))n.insertionPoint=n.group.children.length;else if(n.group.is_group("fraction")&&n.nodes[0].is_group("mul"))n.insertionPoint=n.group.get_top().length}}function D(){n.group.insert_range(n.insertionPoint,n.nodes)}function E(){if(n.nodesParent)r.cleanup(n.nodesParent)}};return new e}();o.prototype.move_actions.push(gmath.actions.EqInvertAction);o.prototype.hideNodesAction=function(){var t=function(t){Action.call(this,"apply hide rules")};gmath.inherit(Action,t);t.prototype.doInPlace=function(e,r){var n=false;if(e.children.length>0){e.children[0].for_each(function(r){var i=r.hidden,o=r.hide_afer_drop;r.hidden=false;r.hide_after_drop=false;if(e.options.hide_leading_op&&r instanceof l&&r.parent&&r.parent.commutative){if(r.parent.associative&&!r.parent.ls||r.parent.value=="div"&&r.parent.ls&&r.parent.ls.value=="//"){if(r.parent.dragging)r.hide_after_drop=true;else r.hidden=true}}if(r instanceof l&&r.parent.parent&&r.parent.parent.is_group("fraction")&&(r.parent.is_group("mul")&&!r.parent.ls&&r.parent.rs.value==="//"||r.parent.is_group("div")&&!r.parent.rs&&r.parent.ls.value==="//")){r.hidden=true}if(r.value==="("||r.value===")"){var a=r.parent;if(a.parent.vertical_notation||a.parent.parent&&a.parent.parent.vertical_notation){var s=a;while(s.is_group("brackets"))s=s.children[1];if(!d.is_optional(s,a.parent)&&t.isLoneMulDivInNumeratorOrDenominator(a.parent)){if(r.parent.dragging)r.hide_after_drop=true;else r.hidden=true}}}for(var h=0;h<e.hide_rules.length&&!r.hidden;h++){var u=e.hide_rules[h];if(!u.disabled)u.apply(r)}n=n||r.hidden!=i||r.hide_after_drop!=o})}if(typeof r==="function")r(this);else return n};t.isLoneMulDivInNumeratorOrDenominator=function(t){return!(t.ls&&t.ls.is_group(t.value)||t.rs&&t.rs.is_group(t.value))};return new t}();gmath.actions.SwitchAction=function(){var e=function(t){Action.call(this,"switch terms in a flat representation");if(t){this.node=t.node;this.target=t.target;this.side=t.side;this.priority=t.priority||0}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(e){if(e.length===0)return[];var r=e[0].get_root();var n=[];var i=e[0].parent.is_group("flat"),o;if(!i)return[];if(!e[0].commutative||!t.is_range(e))return[];for(o=e[0].ls;o&&o.value!=="//";o=o.ls){if(this.match(e[0],o))n.push(this.createBoundAction(r,{node:e[0],side:"around",target:o}))}for(o=e[e.length-1].rs;o&&o.value!=="//";o=o.rs){if(this.match(e[0],o))n.push(this.createBoundAction(r,{node:e[0],side:"around",target:o}))}};e.prototype.match=function(t,e){return t.parent===e.parent&&t!==e&&!(e instanceof l)&&!(t instanceof l)};e.prototype.transform=function(e){var r=tree===this.target.get_root();var n=r?this.node:tree.get_child(this.node.get_path());var i=r?this.target:tree.get_child(this.target.get_path());t.switch_siblings(n,i);if(typeof e==="function")e(this);else return true};return new e}();o.prototype.move_actions.push(gmath.actions.SwitchAction);(function(){var t=function(t){Action.call(this,"flip equation");if(t)this.actor=t.actor;this.priority=1};gmath.inherit(Action,t);t.prototype.match=function(t){return t.is_group("equals")};t.prototype.transform=function(t){var n=this.getNewTreeNode(this.actor);this.addTouchedNodes(e(this.actor));this.addTouchedNodes(r(this.actor));var i=e(n),o=r(n);i.remove();o.remove();var a=0,s=2;n.insert(a,o);n.insert(s,i);if(typeof t==="function")t(this);return this};A.prototype.add_action_handler(new t);var e=function(t){return t.children[0]};var r=function(t){return t.children[2]}})();gmath.actions.EquationFountain=function(){var e=function(t){Action.call(this,"rewrite equation");if(t)this.target=t.target;this.priority=0;this.asynchronous=true};gmath.inherit(Action,e);e.prototype.match=function(t){return t.is_group("equals")};e.prototype.getAllAvailableActions=function(e){if(e.length===0)return[];var r=e[0].get_root(),n=this;return t.filter(this.match,e).map(function(t){return n.createBoundAction(r,{target:t})})};e.prototype.transform=function(e){var r=this.getNewTreeNode(this.target);var n=this;var i=Keyboard();i.on("done",a).on("cancel",s)();function a(a){var s=new o(a).children[0];var l=r.children[0],h=r.children[2];var u=o.getNodes("E",0,s);if(!u)return;var c=s.clone();var p=o.getNodes("E",0,c);if(!p)return;t.replace(l,s);l.parent=null;t.replace(u,l);d.handle(l);t.replace(h,c);h.parent=null;t.replace(p,h);d.handle(h);i.visible(false);i.on("done",null).on("cancel",null);e(n)}function s(){console.log("cancelled");i.visible(false);i.on("done",null).on("cancel",null);e(false)}i.caption("Enter an operation to apply to both sides of the equation.");i.latex("E").visible(true)};return new e}();gmath.actions.FractionExtendAction=function(){var e=function(t){Action.call(this,"extend fraction");if(t)this.target=t.target;this.priority=0;this.asynchronous=true};gmath.inherit(Action,e);e.prototype.match=function(t){return t.is_group("fraction")};e.prototype.getAllAvailableActions=function(e){if(e.length===0)return[];var r=e[0].get_root(),n=this;return t.filter(this.match,e).map(function(t){return n.createBoundAction(r,{target:t})})};e.prototype.transform=function(t){var e=this.getNewTreeNode(this.target),r=e.get_root(),n=this;var i=Keyboard();i.on("done",o).on("cancel",a)();function o(o){var a=r.parse(o,true);if(!a)return;n.extend_fraction(e,a);i.visible(false);i.on("done",null).on("cancel",null);t(n)}function a(){console.log("cancelled");i.visible(false);i.on("done",null).on("cancel",null);t(false)}i.latex("").visible(true)};e.prototype.extend_fraction=function(t,e){t.append(new v(e,"mul"));t.append(new v(e.clone(),"div"));this.cleanup(t)};return new e}();gmath.actions.SplitNumeratorAction=function(){var e=function(t){Action.call(this,"split numerator into new fractions with same denominators");if(t){this.nodes=t.nodes;this.target=t.target;this.side=Array.isArray(this.target)?"around":t.side;this.target_is_left=t.side==="left-of";this.offset={x:this.target_is_left?-10:10,y:0};this.priority=t.priority||0}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){if(t.length===0)return[];var e=t[0];if(!e.parent||!e.parent.parent||!e.parent.parent.parent||!e.parent.parent.parent.parent)return[];if(!(e.is_group("add")||e.is_group("sub"))||!e.parent.parent.parent.is_group("mul")||!e.parent.parent.parent.parent.is_group("fraction"))return[];if(this.match(t,e.parent.parent.parent.parent)){return[this.bindAction(t,"left-of"),this.bindAction(t,"right-of")]}return[]};e.prototype.bindAction=function(t,e){var r=t[0].get_root();var n=[];if(this.fractionIsPartOfProduct(t)){n=this.getSiblingsOfFraction(t,e)}return this.createBoundAction(r,{nodes:t,target:n.length>0?n:t[0].parent.parent.parent.parent,side:e})};e.prototype.fractionIsPartOfProduct=function(t){var e=t[0].parent;return e.parent&&e.parent.is_group("sum")};e.prototype.getSiblingsOfFraction=function(t,e){var r=t[0].parent,n=r.parent,i=n.parent;if(e==="left-of")return i.children.slice(0,i.children.indexOf(n));else return i.children.slice(i.children.indexOf(n)+1)};e.prototype.match=function(t,e){if(t.length===0)return false;return t[0]&&(t[0].is_group("add")||t[0].is_group("sub"))&&t[0].parent.parent.parent.parent===e&&e.is_group("fraction")};e.prototype.transform=function(e){var r=this.getNewTreeNode(this.nodes);this.addTouchedNodes(this.nodes[0].parent.parent.parent.parent);var n=this.nodes[0].parent.parent.parent.parent.get_bottom();var i=r[0].parent.parent.parent.parent;t.remove_range(r);var o=f.prototype.createGroup();i.replace_with(o);o.append(new f(i));var a=i.get_bottom();var s=new g;s.invert();var l=f.prototype.createGroup();l.append_range(r);s.insert(0,new v(l));for(var h=0;h<a.length;h++){var u=t.clone(a[h]);s.append(u);this.extendNodeMap(n[h].get_mapping_to(u))}this.extendNodeMap(i.children[1],s.children[1]);var c=new f(s);o.insert(this.target_is_left?0:1,c);var d=this.rearrangeSumIfNumeratorIsASingleTerm(o,0),p=this.rearrangeSumIfNumeratorIsASingleTerm(o,1);if(this.target_is_left&&!d||!this.target_is_left&&!p){for(var h=0;h<r.length;h++){this.updateNodeMap(r[h],c)}}this.cleanup(o.parent);if(typeof e==="function")e(this);else return true};e.prototype.rearrangeSumIfNumeratorIsASingleTerm=function(t,e){var r=t.children[e],n=r.children[1];if(n.children[0].children[1].children[1].children.length===1){var i=n.children[0].children[1].children[1],o=i.children[0],a=o.children[1],s=i.parent.parent;i.parent.remove();o.remove();a.remove();i.remove();n.remove();r.remove();t.insert(e,o);o.append(n);s.append(a);return true}return false};return new e}();o.prototype.move_actions.push(gmath.actions.SplitNumeratorAction);(function(){var e=function(t){Action.call(this,"group cleanup action");if(t)this.group=t.actor};gmath.inherit(Action,e);gmath.actions.CommutativeGroupCleanup=e;e.prototype.match=function(t){return t.is_group()&&(!t.has_children()||t.children.length===1)};e.prototype.doInPlace=function(e){this.initNodeMap();var r=this.getNewTreeNode(this.group);if(r.children.length===0){t.remove(r)}else if(r.children.length===1){var n=r.children[0],i=this.group.children[0],o=n.children[1];this.updateNodeMap(i.children[0],o);this.updateNodeMap(i,o);this.updateNodeMap(i.parent,o);t.replace(n.parent,o);if(o.parent.parent)d.handle(o.parent,true);d.handle(o,true)}if(typeof e==="function")e(this);else return this}})();(function(){var e=function(t){Action.call(this,"--x=x");if(t){this.actor=t.actor;this.priority=t.priority||0}};gmath.inherit(Action,e);e.prototype.match=function(t){return t.children.length==2&&(t.children[1].is_group("sign")||t.parent.is_group("sign"))};e.prototype.transform=function(e){var r=this.getNewTreeNode(this.actor);if(r.children[1].is_group("sign")){this.addTouchedNodes(this.actor.children[0]);this.addTouchedNodes(this.actor.children[1].children[0]);t.replace(r,r.children[1].children[1])}else if(r.parent.is_group("sign")){this.addTouchedNodes(this.actor.parent.children[0]);this.addTouchedNodes(this.actor.children[0]);t.replace(r.parent,r.children[1])}if(typeof e==="function")e(this);else{console.warn("no callback function was passed to this async method.");return true}};e.prototype.updateNodesFromFutureAndPast=function(){};p.prototype.add_action_handler(new e)})();(function(){var e=function(t){Action.call(this,"-0=0");if(t){this.actor=t.actor;this.priority=t.priority||0}};gmath.inherit(Action,e);e.prototype.match=function(t){return t.children[1]instanceof s&&t.children[1].value===0};e.prototype.transform=function(e){var r=this.getNewTreeNode(this.actor),n=r.children[1];this.addTouchedNodes(this.actor);this.updateNodeMap(this.actor.get_mapping_to(n));t.replace(r,n);if(typeof e==="function")e(this);else{console.warn("no callback function was passed to this async method.");return true}};p.prototype.add_action_handler(new e)})();(function(){var e=function(t){Action.call(this,"integer exponents");if(t){this.actor=t.actor;this.priority=t.priority||0}};gmath.inherit(Action,e);e.prototype.match=function(t){var e=t.parent;if(!e.is_group("power"))return false;var r=e.children[0],n=t.children[0];if(r.is_group("brackets"))r=r.children[1];if(!s.is_num(r))return false;return s.is_num(r)&&n instanceof s&&Math.round(n.value)==n.value&&n.value!==0};e.prototype.transform=function(e){var r=this.getNewTreeNode(this.actor);this.addTouchedNodes(this.actor.parent);var n=r.parent,i=n.children[0],o=r.children[0];if(i.is_group("brackets"))i=i.children[1];var a=new s(Math.pow(s.get_value(i),o.value));this.updateNodeMap(this.actor.parent.get_mapping_to(a));t.replace(n,a);if(typeof e==="function")e(this);else{console.warn("no callback function was passed to this async method.");return true}};_.prototype.add_action_handler(new e)})();(function(){function e(t,r,n,i){var o=n;i[t]=[r];if(o.has_children()){for(var a=0;a<o.children.length;a++){e(t.concat(a),r.concat(a),n.children[a],i)}}}var r=function(t){Action.call(this,"x^1=x");if(t){this.actor=t.actor;this.priority=t.priority||0}};gmath.inherit(Action,r);r.prototype.match=function(t){return t.children[0]instanceof s&&t.children[0].value===1};r.prototype.transform=function(e){var r=this.getNewTreeNode(this.actor);this.addTouchedNodes(this.actor);var n=r.ls;t.remove(n);r.parent.replace_with(n);d.handle(n);this.updateNodeMap(this.actor.parent,n);this.updateNodeMap(this.actor,n);this.updateNodeMap(this.actor.children[0],n);if(typeof e==="function")e(this);else{console.warn("no callback function was passed to this async method.");return true}};_.prototype.add_action_handler(new r)})();(function(){var e=function(t){Action.call(this,"x^0=1");if(t){this.actor=t.actor;this.priority=t.priority||0}};gmath.inherit(Action,e);e.prototype.match=function(t){return t.children[0]instanceof s&&t.children[0].value===0&&t.ls.to_ascii()!=="0"};e.prototype.transform=function(e){var r=this.getNewTreeNode(this.actor);this.addTouchedNodes(this.actor.parent);var n=new s(1);this.updateNodeMap(this.actor.parent.get_mapping_to(n));t.replace(r.parent,n);if(typeof e==="function")e(this);else{console.warn("no callback function was passed to this async method.");return true}};_.prototype.add_action_handler(new e)})();gmath.actions.CollectExponentsForFactoring=function(){var t=function(t){Action.call(this,"collect exponents");if(t){this.nodes=t.nodes;this.target=t.target;this.side="inside"}this.makes_no_changes=true};gmath.inherit(Action,t);t.prototype.getAllAvailableActions=function(t){var e=t[0].get_root(),r=this;try{var n=this.analyzeNodeStructure(t);if(n.length===0)return[];var i=n[0].prod,o=[];for(var a=0;a<i.children.length;a++){try{var s=i.get_child([a,1,1]);var l=this.getTargetRangesInExponent(s,n);l.forEach(function(n){o.push(r.createBoundAction(e,{nodes:t,target:n[0].is_group("product")?[n[0].parent.parent]:n}))})}catch(h){if(h!=="invalid path")throw h}}return o
}catch(h){if(h!=="invalid path"&&h!=="wrong structure")throw h}return[]};t.prototype.transform=function(t){var e=this.getNewTreeNode(this.nodes[0]),r=this.getNewTreeNode(this.target);this.updateNodeMap(this.nodes[0],[e].concat(r));if(typeof t==="function")t(this);else return true};t.prototype.analyzeNodeStructure=function(t){var e=this.groupNodeRanges(t);if(e.length===0)return[];var r=e.map(function(t){if(t.length===1&&t[0].is_group("exponent")){var e=t[0].children[0];if(e.is_group("brackets")&&e.children[0].hidden){e=e.children[1]}return{range:t,exp:t[0],prod:t[0].get_parent(3),ascii:e.to_ascii()}}else{if(!t.every(function(t){return t.is_group("mul","div")}))throw"wrong structure";return{range:t,exp:t[0].get_parent(3),prod:t[0].get_parent(6),ascii:o.rangeToAsciiNoLeadingOp(t,true)}}});for(var n=0;n<r.length;n++){var i=r[n];if(i.ascii!==r[0].ascii)return[];if(!i.exp.is_group("exponent"))return[];if(!i.prod.is_group("fraction","product")||i.prod!==r[0].prod)return[];for(var a=n+1;a<r.length;a++){if(i.exp===r[a].exp)return[]}}return r};t.prototype.getTargetRangesInExponent=function(t,e){var r=t.get_root();if(!t.is_group("exponent"))return[];var n=e[0].ascii;for(var i=0;i<e.length;i++)if(e[i].exp===t)return[];var o=r.getRanges(n,null,t.children);if(o.length===0)return[];o=o.filter(function(e){var r=e[0];return r.parent===t||r.parent.is_group("brackets")&&r.ls.hidden&&r.get_parent(2)===t||r.is_group("mul","div")&&r.get_parent(3)===t||r.parent.is_group("mul")&&r.get_parent(4)===t});return o.map(function(t){if(t.length===1){if(t[0].parent.is_group("exponent","mul"))return[t[0].parent]}return t})};t.prototype.groupNodeRanges=function(t){var e=[];var r=[t[0]];e.push(r);for(var n=1;n<t.length;n++){if(t[n-1].rs===t[n]){r.push(t[n])}else{r=[t[n]];e.push(r)}}return e};return new t}();o.prototype.move_actions.push(gmath.actions.CollectExponentsForFactoring);gmath.actions.FactorPowerAction=function(){var e=function(t){Action.call(this,"factor power");if(t){this.nodes=t.nodes;this.target=t.target;this.side="outside";this.margin="margin"in t?t.margin:10}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){var e,r=this.getEncompassingRange(t);if(this.thereIsALonePower(t)){e=this.bindActionForLonePowerCases(t,r.length-1)}else if(r.length>0){e=this.bindActionForMultiplePowerCases(t,r)}else{return[]}return e};e.prototype.transform=function(t){if(Array.isArray(this.target)){for(var e=0;e<this.target.length;e++){this.addTouchedNodes(this.target[e])}}else{this.addTouchedNodes(this.target)}var r=this.groupNodeRanges(this.nodes);var n=this.getNewTreeNode(this.nodes),i=this.groupNodeRanges(n);var o;if(this.thereIsOneRange(i)){o=this.factorFromALonePower(n)}else{o=this.factorFromMultiplePowers(i)}this.mapOldRangesToNewRange(r,o);if(typeof t==="function")t(this);else return true};e.prototype.factorFromALonePower=function(t){var e=this.extractRangeFromExponent(t);return this.wrapTermInPower(e,t)};e.prototype.factorFromMultiplePowers=function(t){var e=this.getParentGroupOfPowers(t[0][0]);var r;if(!this.productFractionHasUnaffectedTerms(e,t)){r=this.performTransformationWithoutUnaffectedTerms(t,e)}else{r=this.performTransformationWithUnaffectedTerms(t,e)}return r};e.prototype.productFractionHasUnaffectedTerms=function(t,e){if(t.is_group("product")){return t.children.length>e.length}else{return t.children.length-1>e.length}};e.prototype.performTransformationWithoutUnaffectedTerms=function(t,e){for(var r=0;r<t.length;r++){this.extractRangeFromExponent(t[r])}return this.wrapTermInPower(e,t[0])};e.prototype.performTransformationWithUnaffectedTerms=function(t,e){var r=this.getAffectedTerms(t);var n=this.getIDXForFactoredStructure(r);var i=this.putAffectedTermsIntoASeparateProduct(r);var o;if(i.is_group("product")){e.insert(n,new v(i,e.is_group("fraction")&&n>e.get_top().length?"div":"mul"))}else{var a=e.parent,s=e.remove();var l=v.prototype.createGroup();l.append(new v(e));l.append(new v(i));a.insert(s,l);this.cleanup(e);this.cleanup(l.children[0])}for(var h=0;h<t.length;h++){this.extractRangeFromExponent(t[h])}o=this.wrapTermInPower(i,t[0]);return o};e.prototype.getIDXForFactoredStructure=function(t){var e;for(var r=0;r<t.length;r++){var n=t[r],i=n.parent.children.indexOf(n);if(!e&&e!==0)e=i;else if(i<e)e=i}return e};e.prototype.putAffectedTermsIntoASeparateProduct=function(t){var e=v.prototype.createGroup();t.forEach(function(t){t.remove()});if(t.every(function(t){return t.is_group("div")})){t.forEach(function(t){t.invert()})}for(var r=0;r<t.length;r++){e.append(t[r])}return e};e.prototype.mapOldRangesToNewRange=function(t,e){for(var r=0;r<t.length;r++){var n=t[r];for(var i=0;i<n.length;i++){this.updateNodeMap(n[i],e)}}};e.prototype.extractRangeFromExponent=function(e){if(e[0].is_group("exponent")){var r=e[0].parent.parent,n=e[0].parent,i=n.children[0],o=e[0];var a=n.remove();i.remove();o.remove();r.insert(a,i);return i}else{var n=e[0].get_parent(4),o=n.children[1],s=o.children[0],l=s.children[1];t.remove_range(e);this.cleanup(l);d.handle(s,true);return n}};e.prototype.wrapTermInPower=function(t,e){var r,n,i;if(t.parent.is_group("brackets")){r=t.parent;n=r.parent;i=r.remove()}else{n=t.parent;i=t.remove();r=new d(t)}var o;var a;if(e[0].is_group("exponent")){o=e[0]}else if(e[0].is_group("mul")&&e.length===1){o=e[0].children[1];o.remove();o=new _(o)}else{a=v.prototype.createGroup();for(var s=0;s<e.length;s++){a.append(e[s])}o=new _(a)}var l=new m(r,o);n.insert(i,l);d.handle(l);if(a)this.cleanup(a);return o};e.prototype.getParentGroupOfPowers=function(t){if(t.is_group("exponent"))return t.parent.parent.parent;else return t.parent.parent.parent.parent.parent.parent};e.prototype.getAffectedTerms=function(t){var e=[];for(var r=0;r<t.length;r++){e.push(this.getParentMulFromExponentTerm(t[r][0]))}return e};e.prototype.getParentMulFromExponentTerm=function(t){if(t.is_group("exponent"))return t.parent.parent;else return t.parent.parent.parent.parent.parent};e.prototype.thereIsOneRange=function(t){return t.length===1};e.prototype.thereIsALonePower=function(t){return t.length===1&&t[0].is_group("exponent")||this.allNodesAreMulsWithinSameProduct(t)};e.prototype.allNodesAreMulsWithinSameProduct=function(t){var e;for(var r=0;r<t.length;r++){var n=t[r];if(!n.is_group("mul","div"))return false;if(!e)e=n.parent;else if(n.parent!==e)return false}return true};e.prototype.bindActionForLonePowerCases=function(t,e){var r;var n=10;try{var i=t[0];if(i.is_group("exponent")){var o=i.get_parent(2);if(o.is_group("brackets")&&!o.parent.is_group("power")){r=this.createBoundAction(i.get_root(),{nodes:t,target:o})}else return[]}else if(i.is_group("mul","div")){var a=i.get_parent(2),s=a.get_parent(1),l=s.get_parent(1),h=l.get_parent(1);if(!a.is_group("brackets")||!s.is_group("exponent")||!l.is_group("power"))return[];var u;if(!h.is_group("brackets","mul","div"))u=l;else if(h.is_group("brackets")&&!h.parent.is_group("power"))u=h;else if(h.is_group("mul","div")&&e>0){n=15;u=h.parent}else if(h.is_group("mul","div")&&e<=0)u=l;else return[];r=this.createBoundAction(i.get_root(),{nodes:t,target:u,margin:n?n:0})}else return[]}catch(c){if(c==="invalid path")return[];else throw c}return[r]};e.prototype.bindActionForMultiplePowerCases=function(t,e){var r;if(e.length===0)return[];var n=this.getBestTarget(e);r=[this.createBoundAction(t[0].get_root(),{nodes:t,target:n})];return r};e.prototype.getEncompassingRange=function(e){var r=e[0].get_root(),n=this;try{var i=this.analyzeNodeStructure(e);if(i.length===0)return[];var o=i[0].prod,a=[];for(var s=0;s<o.children.length;s++){try{var l=o.get_child([s,1,1]);var h=this.getTargetRangesInExponent(l,i);h.forEach(function(t){a=a.concat(t)})}catch(u){if(u!=="invalid path")throw u}}return t.nodes_to_range(a)}catch(u){if(u!=="invalid path"&&u!=="wrong structure")throw u}return[]};e.prototype.analyzeNodeStructure=function(t){var e=this.groupNodeRanges(t);if(e.length===0)return[];var r=e.map(function(t){if(t.length===1&&t[0].is_group("exponent")){var e=t[0].children[0];if(e.is_group("brackets")&&e.children[0].hidden){e=e.children[1]}return{range:t,exp:t[0],prod:t[0].get_parent(3),ascii:e.to_ascii()}}else{if(!t.every(function(t){return t.is_group("mul","div")}))throw"wrong structure";return{range:t,exp:t[0].get_parent(3),prod:t[0].get_parent(6),ascii:o.rangeToAsciiNoLeadingOp(t,true)}}});for(var n=0;n<r.length;n++){var i=r[n];if(i.ascii!==r[0].ascii)return[];if(!i.exp.is_group("exponent"))return[];if(!i.prod.is_group("fraction","product")||i.prod!==r[0].prod)return[];for(var a=n+1;a<r.length;a++){if(i.exp===r[a].exp)return[]}}return r};e.prototype.getTargetRangesInExponent=function(t,e){var r=t.get_root();if(!t.is_group("exponent"))return[];var n=e[0].ascii;var i=r.getRanges(n,null,t.children);if(i.length===0)return[];i=i.filter(function(e){var r=e[0];return r.parent===t||r.parent.is_group("brackets")&&r.ls.hidden&&r.get_parent(2)===t||r.is_group("mul","div")&&r.get_parent(3)===t||r.parent.is_group("mul","div")&&r.get_parent(4)===t});return i.map(function(t){if(t.length===1){if(t[0].parent.is_group("exponent","mul"))return[t[0].parent]}return t})};e.prototype.groupNodeRanges=function(t){var e=[];var r=[t[0]];e.push(r);for(var n=1;n<t.length;n++){if(t[n-1].rs===t[n]){r.push(t[n])}else{r=[t[n]];e.push(r)}}return e};e.prototype.getBestTarget=function(t){var e;var r=t[0].parent;if(r.is_group("product")&&r.children.length>t.length||r.is_group("fraction")&&r.children.length-1>t.length){e=t}else{var n=t[0].parent.parent;if(n.is_group("brackets")&&!n.children[0].hidden)e=n;else e=t[0].parent}return e};return new e}();o.prototype.move_actions.push(gmath.actions.FactorPowerAction);gmath.actions.DistributePowerAction=function(){var e=function(t){Action.call(this,"distribute power");if(t){this.nodes=t.nodes;this.target=t.target;this.side=t.side}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){var e=t[0].get_root();var r,n,i;try{if(this.nodesAreASingleExponent(t)){i=t[0];n=i.parent;r=n.children[0]}else if(this.nodesAreAllMulDivs(t)&&this.nodesAreAConsecutiveRange(t)){i=t[0].get_parent(3);n=i.get_parent(1);r=n.children[0]}else{return[]}}catch(o){if(o!=="invalid path")throw o;return[]}if(!i.is_group("exponent")||!n.is_group("power")||!r.is_group("brackets")){return[]}var r=r.children[1];if(r.is_group()&&!r.is_group("power")&&!r.is_group("brackets")&&!r.is_group("product")&&!r.is_group("fraction"))return[];return[this.createBoundAction(e,{nodes:t,target:r,side:"inside"})]};e.prototype.transform=function(e){var r=this.getNewTreeNode(this.nodes[0].is_group("exponent")?this.nodes[0]:this.nodes[0].parent.parent.parent);var n=this.getNewTreeNode(this.nodes);var i=this.getNewTreeNode(this.target);var o=r.parent;var a=o.parent;this.addTouchedNodes(this.getOldTreeNode(o));t.remove_range(n);var s;if(i.is_group("product")||i.is_group("fraction")){s=i.get_top().concat(i.get_bottom());this.applyPowersToMulDivs(s,n)}else{s=[this.applyPowerToSingleTerm(i,n)];i=s[0]}if(o.children[1]){this.cleanup(o.children[1].children[0].children[1]);d.handle(o.children[1].children[0],true)}else{var l=o.remove();var h=new d(i);a.insert(l,h);h.simplify=true}if(typeof e==="function")e(this);else return true};e.prototype.nodesAreASingleExponent=function(t){return t.length===1&&t[0].is_group("exponent")};e.prototype.nodesAreAllMulDivs=function(t){for(var e=0;e<t.length;e++){if(!t[e].is_group("mul","div"))return false}return true};e.prototype.nodesAreAConsecutiveRange=function(t){if(t.length===1)return true;var e=t[0];for(var r=1;r<t.length;r++){if(e.rs!==t[r]||e!==t[r].ls)return false;e=t[r]}return true};e.prototype.applyPowersToMulDivs=function(t,e){for(var r=0;r<t.length;r++){var n=t[r].children[1];var i=this.applyPowerToSingleTerm(n,e)}};e.prototype.applyPowerToSingleTerm=function(t,e){var r;if(t.is_group("power")){r=this.applyPowerToPower(t,e)}else{r=this.applyPowerToNonPower(t,e)}return r};e.prototype.applyPowerToPower=function(e,r){var n=e;var i=t.clone(r);var o=this.extendPowerWithSelectedExponentTerms(n,i);this.extendNodeMap(this.nodes[0],o);this.updateXAndYDuringDragging(o);return n};e.prototype.applyPowerToNonPower=function(e,r){var n,i;n=e.parent;i=e.remove();var o;if(r[0].is_group("exponent"))o=t.clone(r[0]);else{var a=v.prototype.createGroup(),s=t.clone(r);this.appendAllContentsToProduct(a,s);o=new _(a)}var l=new m(e,o);n.insert(i,l);if(a){this.cleanup(a);d.handle(o.children[0],true)}this.extendNodeMap(this.nodes[0],l.children[1]);this.updateXAndYDuringDragging(l);return l};e.prototype.takeContentsOfBrackets=function(t){if(t.is_group("brackets")){t=t.children[1];t.remove()}return t};e.prototype.extendPowerWithSelectedExponentTerms=function(t,e){var r=t.children[1];var n=v.prototype.createGroup(),i=this.getContentMulsFromExponent(r);var o=e[0].is_group("exponent")?this.getContentMulsFromExponent(e[0]):e;this.appendAllContentsToProduct(n,i);this.appendAllContentsToProduct(n,o);r.append(n);this.cleanup(n);d.handle(n,true);return o};e.prototype.appendAllContentsToProduct=function(t,e){for(var r=0;r<e.length;r++){t.append(e[r])}};e.prototype.getContentMulsFromExponent=function(e){var r=e.children[0];if(r.is_group("brackets")&&r.children[0].hidden&&r.children[1].is_group("product","fraction")){var n=r.children[1].get_top().concat(r.children[1].get_bottom());t.remove_range(r.children[1].children);r.remove();return n}else if(r.is_group("brackets")&&r.children[0].hidden){var i=r.children[1];i.remove();r.remove();return[new v(i)]}else{r.remove();return[new v(r)]}};e.prototype.updateXAndYDuringDragging=function(t){var e;if(!Array.isArray(t))e=[t];else e=t.slice();for(var r=0;r<e.length;r++){e[r].update_x_during_dragging=true;e[r].update_y_during_dragging=true}};return new e}();o.prototype.move_actions.push(gmath.actions.DistributePowerAction);gmath.actions.combineStackedExponentsUpAction=function(){var e=function(t){Action.call(this,"combine stacked exponents up");if(t){this.nodes=t.nodes;this.target=t.target;this.side="around";this.margin=10}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){if(t.length<1)return[];if(!this.validStructure(t))return[];var e=this.getBaseOfOuterPowerFromInnerExponentTerm(t);var r=e.parent.children[1];var n=[this.createBoundAction(t[0].get_root(),{nodes:t,target:r})];return n};e.prototype.transform=function(t){var e=this.getNewTreeNode(this.nodes),r=this.getNewTreeNode(this.target),n=r.parent.children[0];this.addTouchedNodes(this.target.parent);this.extractSelectedExponentTermsFromInnerPower(e);var i=this.extendOuterExponentWithSelectedExponentTerms(n,e);this.mapSelectedExponentsTermsToNewExponentTerms(this.nodes,i);n.simplify=true;if(typeof t==="function")t(this);else return true};e.prototype.validStructure=function(t){if(this.nodesAreASingleExponent(t)){return this.termsBelongToAPowerWithinAPower(t)}else if(this.nodesAreAllMulDivs(t)&&this.nodesAreAConsecutiveRange(t)){return this.termsBelongToAPowerWithinAPower(t)}else return false};e.prototype.nodesAreASingleExponent=function(t){return t.length===1&&t[0].is_group("exponent")};e.prototype.nodesAreAllMulDivs=function(t){for(var e=0;e<t.length;e++){if(!t[e].is_group("mul","div"))return false}return true};e.prototype.nodesAreAConsecutiveRange=function(t){if(t.length===1)return true;var e=t[0];for(var r=1;r<t.length;r++){if(e.rs!==t[r]||e!==t[r].ls)return false;e=t[r]}return true};e.prototype.termsBelongToAPowerWithinAPower=function(t){try{var e,r,n,i;if(t[0].is_group("exponent")){e=t[0];r=e.get_parent(1);n=r.get_parent(1);i=n.get_parent(1);if(!r.is_group("power")||!n.is_group("brackets")||!i.is_group("power"))return false}else{e=t[0].get_parent(3);r=e.get_parent(1);n=r.get_parent(1);i=n.get_parent(1);if(!e.is_group("exponent")||!r.is_group("power")||!n.is_group("brackets")||!i.is_group("power"))return false}}catch(o){if(o!=="invalid path")throw o;return false}return true};e.prototype.getBaseOfOuterPowerFromInnerExponentTerm=function(t){if(t[0].is_group("exponent"))return t[0].get_parent(2);else return t[0].get_parent(5)};e.prototype.extractSelectedExponentTermsFromInnerPower=function(e){if(e[0].is_group("exponent")){var r=e[0].parent,n=e[0],i=r.children[0],o=r.parent;var a=r.remove();i.remove();n.remove();o.insert(a,i)}else{var s=e[0].parent,l=s.parent;t.remove_range(e);this.cleanup(s);d.handle(l,true)}};e.prototype.extendOuterExponentWithSelectedExponentTerms=function(t,e){var r=t.parent,n=r.children[1];var i=v.prototype.createGroup(),o=this.getContentMulsFromExponent(n);var a=e[0].is_group("exponent")?this.getContentMulsFromExponent(e[0]):e;this.appendAllContentsToProduct(i,o);this.appendAllContentsToProduct(i,a);n.append(i);this.cleanup(i);d.handle(i);return a};e.prototype.appendAllContentsToProduct=function(t,e){for(var r=0;r<e.length;r++){t.append(e[r])}};e.prototype.getContentMulsFromExponent=function(e){var r=e.children[0];if(r.is_group("brackets")&&r.children[0].hidden&&r.children[1].is_group("product","fraction")){var n=r.children[1].children.slice();t.remove_range(r.children[1].children);r.remove();return n}else if(r.is_group("brackets")&&r.children[0].hidden){var i=r.children[1];i.remove();r.remove();return[new v(i)]}else{r.remove();return[new v(r)]}};e.prototype.mapSelectedExponentsTermsToNewExponentTerms=function(t,e){for(var r=0;r<t.length;r++){for(var n=0;n<e.length;n++){if(n===0)this.updateNodeMap(t[r],e[n]);else this.extendNodeMap(t[r],e[n])}}};return new e}();o.prototype.move_actions.push(gmath.actions.combineStackedExponentsUpAction);gmath.actions.PowerFactorAndCombineStackedExponentsAction=function(){var t=function(t){Action.call(this,"factor power and combine stacked exponent up");if(t){this.nodes=t.nodes;this.target=t.target;this.side=t.side}};gmath.inherit(Action,t);t.prototype.getAllAvailableActions=function(t){if(t.length<2)return[];var e=gmath.actions.FactorPowerAction.getAllAvailableActions(t);if(e.length===0)return[];var r=e[0];if(Array.isArray(r.target))return[];if(!r.target.is_group("brackets"))return[];if(!r.target.parent.is_group("power"))return[];var n=r.target.parent.children[1];var i=this.createBoundAction(t[0].get_root(),{nodes:t,target:n,side:"inside"});return[i]};t.prototype.doInPlace=function(t){this.initNodeMap();var e=this.target.parent;this.addTouchedNodes(e);var r=this.getNewTreeNode(this.nodes);var n=gmath.actions.FactorPowerAction.getAllAvailableActions(r)[0];n.doInPlace();this.compose(n);var i=n.mapNodes(r);var o=gmath.actions.combineStackedExponentsUpAction.getAllAvailableActions(i)[0];o.doInPlace();this.compose(o);e=this.mapNodes(e)[0];d.handle(e.children[0],true);this.removeDeletedNodesFromNodeMap();if(typeof t==="function")t(this);else return true};return new t}();o.prototype.move_actions.push(gmath.actions.PowerFactorAndCombineStackedExponentsAction);(function(){var e=function(t){Action.call(this,"muldiv cleanup action");if(t)this.muldiv=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){if(e.hasProductChild(t))return true;if(t.parent.cleanupAction&&t.parent.cleanupAction.match(t.parent))return true;return false};e.hasProductChild=function(t){return(t.is_group("mul")||t.is_group("div"))&&t.children[1]&&t.children[1].is_group("product")};e.prototype.doInPlace=function(r){this.initNodeMap();var n=this.getNewTreeNode(this.muldiv);var i=n.parent;if(e.hasProductChild(n)){var o=n.children[1];var a=t.remove(n);this.updateNodeMap(this.muldiv,i);if(this.muldiv.is_group("div"))o.children.forEach(function(t){t.invert()});i.insert_range(a,o.children)}this.cleanup(i);if(typeof r==="function")r(this);else return this};v.prototype.cleanupAction=new e})();(function(){var e=function(t){Action.call(this,"Multiply numbers");if(t)this.actor=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){if(!t.ls)return false;if(t.ls.value!=t.value)return false;var e=t.ls.children[1],r=t.children[1];if(!(s.is_num(e)&&s.is_num(r)))return false;return true};e.prototype.transform=function(e){var r=this.getNewTreeNode(this.actor);this.addTouchedNodes(this.actor);this.addTouchedNodes(this.actor.ls);var n=r.ls,i=r;var o=n.children[1],a=i.children[1];var l=s.get_value(o)*s.get_value(a);var h=new v(new s(l),i.value);this.updateNodeMap(this.actor.ls.get_mapping_to(h));this.updateNodeMap(this.actor.get_mapping_to(h));t.remove(n);var u=t.remove(i);t.insert(r.parent,u,h);this.cleanup(h);if(typeof e==="function")e(this);return this};v.prototype.add_action_handler(new e)})();(function(){var e=function(t){Action.call(this,"Multiply powers");if(t){this.actor=t.actor;this.priority=t.priority||0}};gmath.inherit(Action,e);e.prototype.split=function(t){if(t.is_group("power"))return{base:t.children[0],exp:t.children[1]};else return{base:t,exp:new _(new s(1))}};e.prototype.match=function(t){if(t.is_group("power"))t=t.parent;if(!t.ls||!t.is_group("mul"))return false;var e=this.split(t.ls.children[1]),r=this.split(t.children[1]);if(!e||!r)return false;if(e.base.to_ascii()!=r.base.to_ascii()&&!(s.is_num(e.base)&&(s.get_value(e.base)===1||s.get_value(e.base)===-1)&&t.children[1].is_group("power")))return false;return true};e.prototype.transform=function(e){var r=this;if(this.actor.is_group("power"))this.actor=this.actor.parent;var n=this.getNewTreeNode(this.actor);var i=this.actor.ls;this.addTouchedNodes(this.actor);this.addTouchedNodes(this.actor.ls);var o=n.ls.children[1],a=n.children[1];if(l()){u()}else if(h()){u();c()}else{g()}function l(){return s.is_num(o)&&s.get_value(o)===1}function h(){return s.is_num(o)&&s.get_value(o)===-1}function u(){n.ls.remove()}function c(){a.remove();var t=new p(a);n.append(t);r.updateNodeMap(i.children[1].get_mapping_to(t.children[0]))}function g(){var e=r.actor.children[0];r.updateNodeMap(r.actor,o.parent);r.updateNodeMap(r.actor.children[0],o.parent.children[0]);if(o.is_group("power")&&a.is_group("power")){r.updateNodeMap(r.actor.children[1].children[0].get_mapping_to(o.children[0]))}else if(o.is_group("power")){r.updateNodeMap(r.actor.children[1].get_mapping_to(o.children[0]))}else if(a.is_group("power")){r.updateNodeMap(r.actor.children[1].children[0].get_mapping_to(o))}else{r.updateNodeMap(r.actor.children[1].get_mapping_to(o))}if(!o.is_group("power")){var n=_.prototype.createGroup();var i=o.parent;var l=t.remove(o);n.append(o);n.append(new _(new s(1)));t.insert(i,l,n);o=n}var h=r.split(o),u=r.split(a);t.remove(a.parent);var c=h.exp.children[0],p;if(c.is_group("brackets")&&c.children[0].hidden&&c.children[1].is_group("sum")){p=c.children[1]}else{var i=c.parent;t.remove(c);if(c.is_group("brackets")&&c.children[0].hidden){c=c.children[1];c.remove()}p=f.prototype.createGroup();p.append(new f(c));i.append(p)}var g=1;if(u.exp.children[0].is_group("brackets")&&u.exp.children[0].children[0].hidden&&u.exp.children[0].children[1].is_group("sum")){p.append_range(u.exp.children[0].children[1].children);g=u.exp.children[0].children[1].children.length}else p.append(new f(u.exp.children[0]));d.handle(p);r.updateNodeMap(e,p.children[p.children.length-g].children[0])}this.cleanup(n.parent);if(typeof e==="function")e(this);else{console.warn("no callback function was passed to this async method.");return true}};var r=new e;v.prototype.add_action_handler(r);m.prototype.add_action_handler(r)})();(function(){var e=function(t){Action.call(this,"negation");if(t){this.actor=t.actor;this.priority=t.priority||0}};gmath.inherit(Action,e);e.prototype.match=function(t){if(s.get_value(t.children[1])===-1&&t.ls)return true;if(t.ls&&t.ls.children&&s.get_value(t.ls.children[1])===-1)return true;return false};e.prototype.transform=function(e){var r=this.getNewTreeNode(this.actor);var n=this;this.addTouchedNodes(this.actor);this.addTouchedNodes(this.actor.ls);var i=function(e,r){var i=r.children[1],o=n.getOldTreeNode(e),a=o.children[1],s=n.getOldTreeNode(r);t.remove(e);if(i.is_group("sign")&&i.children[1]&&!i.children[1].is_group("sign")){var h=i.children[1];n.updateNodeMap(s.children[1].children[0],h);n.updateNodeMap(a,h);n.updateNodeMap(a.children[0],h);n.updateNodeMap(a.children[1],h);i.replace_with(h)}else{var u=new p;u.append(new l("-"));n.updateNodeMap(a,u);n.updateNodeMap(a.children[0],u.children[0]);n.updateNodeMap(a.children[1],i);i.remove();u.append(i);r.append(u)}n.updateNodeMap(o,r);n.updateNodeMap(o.children[0],r.children[0])};if(s.get_value(r.children[1])===-1&&r.ls){i(r,r.ls);this.cleanup(r.ls)}else{i(r.ls,r);this.cleanup(r)}if(typeof e==="function")e(this);return this};v.prototype.add_action_handler(new e)})();(function(){var e=function(t){Action.call(this,"multiply fractions");this.priority=1;if(t)this.actor=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){if(!t.is_group("mul")||!t.ls)return false;var e=t.ls,r=t,n=t.parent;var i=e.children[1],o=r.children[1];if(!(i.is_group("fraction")&&o.is_group("fraction")))return false;return true};e.prototype.transform=function(e){var r=this.getNewTreeNode(this.actor);this.addTouchedNodes(this.actor);this.addTouchedNodes(this.actor.ls);var n=r.ls,i=r,o=r.parent;var a=n.children[1],s=i.children[1];var l=this.actor.children[1];this.updateNodeMap(l.get_fraction_bar(),a.get_fraction_bar());this.updateNodeMap(this.actor,n);this.updateNodeMap(this.actor.children[0],n.children[0]);t.remove(i);var h=s.get_top(),u=s.get_bottom();for(var c=0;c<h.length;c++)a.append(h[c]);for(var c=0;c<u.length;c++)a.append(u[c]);for(var c=0;c<a.children.length;c++){var p=a.children[c];if(p.has_children())d.handle(p.children[1])}this.cleanup(o);if(typeof e==="function")e(this);return this};v.prototype.add_action_handler(new e)})();(function(){function e(t,r,n,i){var o=n;i[t]=[r];if(o.has_children()){for(var a=0;a<o.children.length;a++){e(t.concat(a),r.concat(a),n.children[a],i)}}}var r=function(t){Action.call(this,"add fractions");this.priority=1;if(t){this.actor=t.actor}};gmath.inherit(Action,r);r.prototype.match=function(t){if(!t.ls)return false;var e=t.ls,r=t;var n=e.children[1],i=r.children[1];if(!(n.is_group("fraction")&&i.is_group("fraction")))return false;var o=function(t){return t.to_ascii()};var a=n.get_bottom(),s=i.get_bottom();if(a.map(o).join("")!==s.map(o).join(""))return false;return true};r.prototype.transform=function(e){var r=this.getNewTreeNode(this.actor);var n=this.actor.children[1];var i=this.actor.children[1].get_bottom();this.addTouchedNodes(this.actor);this.addTouchedNodes(this.actor.ls);var o=r.ls,a=r,s=r.parent;var h=o.children[1],u=a.children[1];var c=t.remove(o);t.remove(a);t.remove(h);t.remove(u);var p=h.get_bottom();this.updateNodeMap(n.get_fraction_bar(),h.get_fraction_bar());for(var m=0;m<i.length;m++){this.updateNodeMap(i[m].get_mapping_to(p[m]))}var _=function(e,r){t.remove_range(e);if(e.length==1){t.append(r,e[0].children[1]);d.handle(r.children[1],true)}else{var n=new g;t.insert_range(n,0,e);t.append(r,n);d.handle(r.children[1],true)}};_(h.get_top(),o);_(u.get_top(),a);var y=o.createGroup();y.append(o);y.append(a);var w=new v(w);var x=new l("*");t.append(w,x);t.append(w,y);h.append(w);var b=new f(h,"add");t.insert(s,c,b);d.handle(y);this.cleanup(o);this.cleanup(a);this.cleanup(s);if(typeof e==="function")e(this);else{console.warn("no callback function was passed to this async method.");return true}};f.prototype.add_action_handler(new r)})();gmath.actions.FractionCancelAction=function(){var e=function(t){Action.call(this,"cancel numerator and denominator");this.delay=400;if(t){this.nodes=t.nodes;this.target=t.target;this.targetType=t.targetType||(t.nodes[0].is_group("mul")?"denominator":"numerator");this.side=t.side||"around"}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){if(r(t))return[];var e={};e.tree=n(t);e.fraction=i(t);e.targets=this.getCancelableTargetsFromFraction(e.fraction,t);return this.collectBoundActions(e,t)};function r(t){if(t.length!==1)return true;var e=i;return!e(t)||t[0].value!=="div"&&t[0].value!=="mul"}function n(t){return Array.isArray(t)?t[0].get_root():t.get_root()}function i(t){var e=t[0];while(e&&!e.is_group("fraction"))e=e.parent;if(!e)return false;return e}e.prototype.getCancelableTargetsFromFraction=function(t,e){var r=e[0];var n;if(r.value==="div"){n=this.getCancelableTargetsFromFractionNumerator(t,e)}else{n=this.getCancelableTargetsFromFractionDenominator(t,e)}return n};e.prototype.getCancelableTargetsFromFractionNumerator=function(t,e){var r=e[0];var n=[];var i=t.get_top();for(var o=0;o<i.length;o++){if(this.match(i[o],r))n.push({node:i[o],type:"numerator"})}return n};e.prototype.getCancelableTargetsFromFractionDenominator=function(t,e){var r=e[0];var n=[];var i=t.get_bottom();for(var o=0;o<i.length;o++){if(this.match(r,i[o]))n.push({node:i[o],type:"denominator"})}return n};e.prototype.match=function(t,e){var r=this;var n=t.is_group("mul")?t:e,i=t.is_group("mul")?e:t;if(!o())return false;if(!a())return false;l();if(h())return true;if(u())return true;if(c())return true;if(d())return true;if(p())return true;if(f())return true;if(g())return true;return false;function o(){var t=n.parent;return t.is_group("fraction")&&i.parent===t}function a(){return n.is_group("mul")&&i.is_group("div")}function l(){n=n.children[1],i=i.children[1]}function h(){return n.to_ascii()===i.to_ascii()}function u(){return n.is_group("sign")&&n.children[1].to_ascii()===i.to_ascii()}function c(){return i.is_group("sign")&&i.children[1].to_ascii()===n.to_ascii()}function d(){return i instanceof s&&s.get_value(i)===1}function p(){return s.is_num(i)&&s.get_value(i)===-1}function f(){var t=n.get_root();var e=t.numeric_value(n);var o=t.numeric_value(i);if(s()){var a=r.getGCD(e,o);if(l())return true;if(h())return true;if(a!==1)return true}else if(u()){if(d())return true}return false;function s(){return e!==null&&o!==null&&!isNaN(e)&&!isNaN(o)}function l(){return Math.abs(e)>=Math.abs(o)&&Math.abs(o)!==1&&e%o===0}function h(){return Math.abs(o)>=Math.abs(e)&&Math.abs(e)!==1&&o%e===0}function u(){return n instanceof m||i instanceof m}function c(){return n instanceof m&&i instanceof m}function d(){if(c()){return n.children[0].to_ascii()===i.children[0].to_ascii()}else if(p()){return n.children[0].to_ascii()===i.to_ascii()}else{return n.to_ascii()===i.children[0].to_ascii()}}function p(){return n instanceof m}}function g(){return n.is_group("sign")&&i.is_group("sign")}};e.prototype.collectBoundActions=function(t,e){var r=[];for(var n=0;n<t.targets.length;n++){var i=t.targets[n].node,o=t.targets[n].type;r.push(this.createBoundAction(t.tree,{nodes:e,target:i,targetType:o,side:"around"}))}return r};e.prototype.getGCD=function(t,e){if(t<0)t=-t;if(e<0)e=-e;if(e>t){var r=t;t=e;e=r}while(true){t%=e;if(t==0)return e;e%=t;if(e==0)return t}};e.prototype.transform=function(e){var r=this;i();var n={};o();a();l();if(typeof e==="function")e(this);else return true;function i(){r.addTouchedNodes(r.nodes[0]);r.addTouchedNodes(r.target)}function o(){h();u();c();g()}function a(){if(y())w();else if(x())b();else if(A())N();else if(L())T();else if(P()){if(D()){T()}else{E()}}else S()}function l(){while(n.fraction&&r.cleanup(n.fraction))n.fraction=n.fraction.parent;if(n.fraction&&n.fraction.parent)d.handle(n.fraction,true)}function h(){var t=r.nodes[0];while(!t.is_group("fraction"))t=t.parent;n.fraction=r.getNewTreeNode(t)}function u(){n.numMul=r.targetType==="numerator"?r.getNewTreeNode(r.target):r.getNewTreeNode(r.nodes[0]);n.denDiv=r.targetType==="denominator"?r.getNewTreeNode(r.target):r.getNewTreeNode(r.nodes[0])}function c(){n.numVal=n.numMul.children[1];n.denVal=n.denDiv.children[1]}function g(){n.numeratorParent=n.numMul.parent}function y(){return n.numVal.to_ascii()===n.denVal.to_ascii()}function w(){t.remove(n.numMul);t.remove(n.denDiv)}function x(){return n.denVal instanceof s&&s.get_value(n.denVal)===1}function b(){t.remove(n.denDiv)}function A(){return s.is_num(n.denVal)&&s.get_value(n.denVal)===-1}function N(){if(n.numVal.is_group("sign")){M()}else{k()}t.remove(n.denDiv)}function M(){r.updateNodeMap(r.getOldTreeNode(n.numVal),n.numVal.children[1]);n.numVal.replace_with(n.numVal.children[1])}function k(){var t=n.numVal.remove();var e=new p(n.numVal);n.numMul.insert(t,e);r.updateNodeMap(r.getOldTreeNode(n.numVal),e)}function L(){return n.numVal.is_group("sign")&&n.numVal.children[1].to_ascii()===n.denVal.to_ascii()
}function T(){var e=new s(-1);r.updateNodeMap(r.getOldTreeNode(n.numVal),e);t.replace(n.numVal,e);t.remove(n.denDiv)}function P(){return n.denVal.is_group("sign")&&n.denVal.children[1].to_ascii()===n.numVal.to_ascii()}function D(){return n.fraction.get_bottom().length===1}function T(){var e=new s(-1);r.updateNodeMap(r.getOldTreeNode(n.numVal),e);t.replace(n.numVal,new s(-1));t.remove(n.denDiv)}function E(){r.updateNodeMap(r.getOldTreeNode(n.denVal),e);t.remove(n.numMul);var e=new s(-1);t.replace(n.denVal,e)}function S(){var e=n.fraction.get_root();var i=e.numeric_value(n.numVal);var o=e.numeric_value(n.denVal);if(a()){p()}else if(l()&&h()){A()}else if(w()){b()}function a(){return i!==null&&o!==null&&!isNaN(i)&&!isNaN(o)}function l(){return n.numVal instanceof m||n.denVal instanceof m}function h(){if(u()){return n.numVal.children[0].to_ascii()===n.denVal.children[0].to_ascii()}else if(c()){return n.numVal.children[0].to_ascii()===n.denVal.to_ascii()}else{return n.numVal.to_ascii()===n.denVal.children[0].to_ascii()}}function u(){return n.numVal instanceof m&&n.denVal instanceof m}function c(){return n.numVal instanceof m}function p(){var t=r.getGCD(i,o);if(g()){n.numMul=x(n.numMul,o,Math.floor(i/o))[0];n.denDiv.update_y_during_dragging=true;if(r.targetType!=="numerator")r.reselectNodeAfterAction(n.numMul)}else if(y()){n.denDiv=x(n.denDiv,i,Math.floor(o/i))[0];n.numMul.update_y_during_dragging=true;if(r.targetType==="numerator")r.reselectNodeAfterAction(n.denDiv)}else if(t!==1){if(r.targetType==="numerator"){x(n.numMul,t,Math.floor(i/t));n.denDiv=x(n.denDiv,t,Math.floor(o/t))[0]}else{n.numMul=x(n.numMul,t,Math.floor(i/t))[0];x(n.denDiv,t,Math.floor(o/t))}if(r.targetType==="numerator")r.reselectNodeAfterAction(n.denDiv);else r.reselectNodeAfterAction(n.numMul)}else if(w()){b()}}function g(){return Math.abs(i)>=Math.abs(o)&&Math.abs(o)!==1&&i%o===0}function y(){return Math.abs(o)>=Math.abs(i)&&Math.abs(i)!==1&&o%i===0}function w(){return n.numVal.is_group("sign")&&n.denVal.is_group("sign")}function x(e,n,i){var o=new v(new s(n),e.value),a=new v(new s(i),e.value);r.updateNodeMap(r.getOldTreeNode(e).get_mapping_to(o));r.extendNodeMap(r.getOldTreeNode(e).get_mapping_to(a));var l=t.remove(e);t.insert(e.parent,l,o);t.insert(e.parent,l,a);o.update_y_during_dragging=true;a.update_y_during_dragging=true;return[o,a]}function b(){var e=n.numVal,i=n.denVal,o=e.children[1],a=i.children[1];var l=n.fraction.children.indexOf(n.numMul),h=n.fraction.children.indexOf(n.denDiv);var u=r.getOldTreeNode(e.children[0]),c=r.getOldTreeNode(i.children[0]);e.remove();o.remove();n.numMul.append(o);i.remove();a.remove();n.denDiv.append(a);var d=new v(new s(-1)),p=new v(new s(-1),"div");t.insert(n.fraction,l,d);t.insert(n.fraction,h+1,p);r.updateNodeMap(u.get_mapping_to(d.children[1]));r.updateNodeMap(c.get_mapping_to(p.children[1]));r.extendNodeMap(n.numMul,d);r.extendNodeMap(n.denDiv,p);if(r.targetType==="numerator"){r.reselectNodeAfterAction(p)}else{r.reselectNodeAfterAction(d)}}function A(){e();if(!i()){return}h();y();x();M();k();function e(){o();l();a();n.sourceWasPower=true}function i(){var t=n.sourceVal.is_group("power")?n.sourceVal.children[0]:n.sourceVal,e=n.targetVal.is_group("power")?n.targetVal.children[0]:n.targetVal;return t.to_ascii()===e.to_ascii()}function o(){n.source=r.targetType==="numerator"?n.denDiv:n.numMul;n.target=r.targetType==="numerator"?n.numMul:n.denDiv}function a(){delete n.numMul;delete n.denDiv;delete n.numVal;delete n.denVal}function l(){n.sourceVal=n.source.children[1];n.targetVal=n.target.children[1]}function h(){if(u()){c()}if(p()){g()}}function u(){return!(n.sourceVal instanceof m)}function c(){n.sourceVal.remove();var t=_.prototype.createGroup();t.append(n.sourceVal);t.append(new _(new s(1)));r.updateNodeMap(n.sourceVal,t);n.source.append(t);n.sourceVal=t;n.sourceWasPower=false}function p(){return!(n.targetVal instanceof m)}function g(){var t=n.targetVal.remove();var e=_.prototype.createGroup();e.append(n.targetVal);e.append(new _(new s(1)));r.updateNodeMap(n.targetVal,e);n.target.append(e);n.targetVal=e}function y(){n.sourceExpVal=n.sourceVal.children[1].children[0];n.targetExpVal=n.targetVal.children[1].children[0];w()}function w(){if(n.sourceExpVal.is_group("brackets"))n.sourceExpVal=n.sourceExpVal.children[1];if(n.targetExpVal.is_group("brackets"))n.targetExpVal=n.targetExpVal.children[1]}function x(){if(b()){A()}else{N()}}function b(){return!s.is_num(n.sourceExpVal)||!s.is_num(n.targetExpVal)}function A(){var t=n.targetExpVal.parent;var e=n.targetExpVal.remove();var i=f.prototype.createGroup();i.append(new f(n.targetExpVal));i.append(new f(n.sourceExpVal.clone(),"sub"));n.targetExpVal=t.insert(e,i);r.cleanup(i.children[1]);r.cleanup(i.children[0]);d.handle(i)}function N(){n.targetExpVal=n.targetExpVal.replace_with(new s(s.get_value(n.targetExpVal)-s.get_value(n.sourceExpVal)))}function M(){var e=_.prototype.createGroup();e.append(t.clone(n.sourceVal.children[0]));e.append(new _(t.clone(n.sourceExpVal)));d.handle(e.children[1].children[0]);n.newPow=e;n.fraction.insert(n.fraction.children.indexOf(n.target)+1,new v(e,n.target.value))}function k(){if(!n.sourceWasPower){L()}if(T()){P()}}function L(){r.updateNodeMap(n.newPow,n.newPow.children[0]);n.newPow=n.newPow.replace_with(n.newPow.children[0]);r.updateNodeMap(n.sourceVal,n.sourceVal.children[0]);n.sourceVal.replace_with(n.sourceVal.children[0])}function T(){return n.targetExpVal.value===1}function P(){r.updateNodeMap(n.targetVal,n.targetVal.children[0]);n.targetVal=n.targetVal.replace_with(n.targetVal.children[0])}}}};return new e}();o.prototype.move_actions.push(gmath.actions.FractionCancelAction);(function(){var t=function(t){Action.call(this,"cancel numerator and denominator");if(t){this.actor=t.actor;this.priority=t.priority||0}};gmath.inherit(Action,t);t.prototype.match=function(t){if(!t.is_group("fraction"))return false;var e=t.get_top();var r=t.get_bottom();if(e.length!==1||r.length!==1)return false;e=e[0],r=r[0];return s.is_num(e.children[1])&&s.is_num(r.children[1])};t.prototype.transform=function(t){var e=this.getNewTreeNode(this.actor);var r=e.parent;this.addTouchedNodes(this.actor);var n=e.get_top();var i=e.get_bottom();n=n[0],i=i[0];var o=s.get_value(n.children[1])/s.get_value(i.children[1]);o=Math.round(100*o)/100;var a=new s(o);if(n.children[1]instanceof p||i.children[1]instanceof p){this.updateNodeMap(this.actor.children[0].children[1].get_mapping_to(a));this.updateNodeMap(this.actor.children[2].children[1].get_mapping_to(a))}else{this.updateNodeMap(this.actor.get_mapping_to(a))}var l=e.remove();r.insert(l,a);if(typeof t==="function")t(this);else return true};g.prototype.add_action_handler(new t);return new t})();(function(){var e=function(t){Action.call(this,"product-fraction cleanup action");if(t)this.productFraction=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){var e=t.get_top().length,r=t.get_bottom().length;if(e===0&&r===0)return true;if(t.value==="product"&&r>0)return true;if(t.value==="fraction"&&r===0)return true;if(t.value==="fraction"&&e===0)return true;if(e===1&&r===0)return true;return false};e.prototype.doInPlace=function(e){this.initNodeMap();var r=this.getNewTreeNode(this.productFraction);var n=r.get_top().length,i=r.get_bottom().length,o;if(n===0&&i===0){var a=new s(1);o=t.get_mapping_between(this.productFraction,a);this.updateNodeMap(o);t.replace(r,a)}if(this.productFraction.value==="product"&&i>0){r.invert()}if(this.productFraction.value==="fraction"&&i===0){r.invert()}if(this.productFraction.value==="fraction"&&n===0){if(!(this.productFraction.children[0]instanceof l))t.insert(r,0,new l("//"));t.insert(r,0,new v(new s(1)))}if(n===1&&i===0){var h=r.get_top()[0].children[1];this.updateNodeMap(this.productFraction,h);this.updateNodeMap(this.productFraction.children[0],h);this.updateNodeMap(this.productFraction.children[0].children[0],h);t.replace(r,h);d.handle(h,true)}if(typeof e==="function")e(this);else return this};g.prototype.cleanupAction=new e})();gmath.actions.SplitExponentsAction=function(){var e=function(t){Action.call(this,"split exponents");if(t){this.nodes=t.nodes;this.target=t.target;this.side=t.side}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){if(!this.match(t[0]))return[];if(t.length===t[0].parent.children.length)return[];var e=t[0].get_root(),r=t[0].parent.parent.parent.parent;return[this.createBoundAction(e,{nodes:t,target:r,side:"left-of"}),this.createBoundAction(e,{nodes:t,target:r,side:"right-of"})]};e.prototype.match=function(t){try{var e=(t.is_group("add")||t.is_group("sub"))&&t.parent.parent.parent.is_group("exponent");return e}catch(r){return false}};e.prototype.transform=function(t){this.addTouchedNodes(this.target);var e=this.getNewTreeNode(this.nodes),r=this.getNewTreeNode(this.target);var n;if(e[0].parent.children.indexOf(this.nodes[0])===0){n=e[0].parent.children[e.length].children[0]}else{n=e[0].parent.children[0].children[0]}var i=r,o=i.parent;var a=i.remove();this.extractNodesFromPowerExponentSum(e);var s=this.createSplittedOffPower(e);var l=this.placePowersIntoProduct(i,s);var h=this.nodes[0].children[0];this.extendNodeMap(h,s.parent.children[0]);this.extendNodeMap(n,i.parent.children[0]);for(var u=0;u<this.nodes.length;u++){this.updateNodeMap(this.nodes[u],s.parent)}if(o.is_group("mul")||o.is_group("div")){this.extendNodeMap(this.getOldTreeNode(o.children[0]),s.parent.children[0])}o.insert(a,l);this.cleanup(l.children[0].children[1].children[1].children[0].children[1]);this.cleanup(l.children[1].children[1].children[1].children[0].children[1]);d.handle(l.children[0].children[1].children[1].children[0],true);d.handle(l.children[1].children[1].children[1].children[0],true);this.cleanup(o);if(typeof t==="function")t(this);else return true};e.prototype.extractNodesFromPowerExponentSum=function(e){t.remove_range(e)};e.prototype.createSplittedOffPower=function(e){var r=this.target.children[0];var n=_.prototype.createGroup(),i=t.clone(r);this.extendNodeMap(r,i);n.append(i);var o=f.prototype.createGroup();o.append_range(e);var a=new _(o);n.append(a);return n};e.prototype.placePowersIntoProduct=function(t,e){var r=v.prototype.createGroup();r.append(new v(t));var n=new v(e);if(this.side==="left-of")r.insert(0,n);else r.append(n);return r};return new e}();o.prototype.move_actions.push(gmath.actions.SplitExponentsAction);gmath.actions.UniteExponentsAction=function(){var e=function(t){Action.call(this,"unite exponents");if(t){this.nodes=t.nodes;this.target=t.target;this.side=t.side}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){var e=[];if(t.length!==1)return e;if(!(t[0].is_group("mul")||t[0].is_group("div")))return e;var r=t[0].get_root(),n=t[0].parent.children.slice();n.splice(n.indexOf(t[0]),1);var i=this.getBaseStringFromNode(t[0].children[1]);for(var o=0;o<n.length;o++){if(t[0].value===n[o].value&&this.match(n[o].children[1],i))e.push(this.createBoundAction(r,{nodes:t,target:n[o].children[1].children[1],side:"around"}))}return e};e.prototype.getBaseStringFromNode=function(t){if(t.is_group("power"))return t.children[0].to_ascii();return t.to_ascii()};e.prototype.match=function(t,e){if(!t.is_group("power"))return false;return t.children[0].to_ascii()===e};e.prototype.transform=function(t){var e=this;this.addTouchedNodes(this.nodes[0]);this.addTouchedNodes(this.target.parent.parent);var r=this.getNewTreeNode(this.nodes)[0],n=this.getNewTreeNode(this.target);var i=r.parent,o=this.getDirectionOfDrag(r,n);r.remove();var a=this.extractAddendsFromDraggedNode(r);this.updateNodeMap(this.nodes[0],a);this.extendNodeMap(this.nodes[0].children[0],a[0].children[0]);this.updateNodeMap(this.nodes[0].children[1].children[0],this.target.parent.children[0]);this.insertAddendsIntoTargetExponent(a,n,o);this.cleanup(i);if(typeof t==="function")t(this);else return true};e.prototype.getDirectionOfDrag=function(t,e){var r=t.parent.children.indexOf(t),n=t.parent.children.indexOf(e.parent.parent);return n>r};e.prototype.extractAddendsFromDraggedNode=function(e){var r=[];var n=e.children[1];if(!n.is_group("power")){r.push(new f(new s(1)))}else{var i=n.children[1].children[0];if(i.is_group("brackets")&&i.children[1].is_group("sum")){r=i.children[1].children.slice();t.remove_range(r)}else{i.remove();r.push(new f(i))}}return r};e.prototype.insertAddendsIntoTargetExponent=function(t,e,r){var n=e.children[0];if(!(n.is_group("brackets")&&n.children[1].is_group("sum"))){this.reinterpretExponentToBeASum(e);n=e.children[0]}this.extendNodeMap(this.getOldTreeNode(e.parent.parent.children[0]),n.children[1].children[0].children[0]);if(r)n.children[1].insert_range(0,t);else n.children[1].append_range(t)};e.prototype.reinterpretExponentToBeASum=function(t){var e=t.children[0];e.remove();var r=f.prototype.createGroup();r.append(new f(e));var n=new d(r);t.append(n)};return new e}();o.prototype.move_actions.push(gmath.actions.UniteExponentsAction);SplitNumberAction=function(){var t=function(t){Action.call(this,"n => (n-1) + 1");this.priority=0;if(t)this.actor=t.actor};gmath.inherit(Action,t);t.prototype.match=function(t){return t instanceof s&&t.value>1};t.prototype.transform=function(t){var e=this.getNewTreeNode(this.actor);this.addTouchedNodes(this.actor);var r=e.parent;var n=e.remove();e.value--;var i=f.prototype.createGroup();i.append(new f(e));i.append(new f(new s(1)));this.resultNodes=i.children.slice();this.updateNodeMap(this.actor.get_mapping_to(i));r.insert(n,i);d.handle(i);this.cleanup(r);if(typeof t==="function")t(this);return true};return new t}();SplitProductAction=function(){var e=function(t){Action.call(this,"n*x => (n-1)*x + x");this.priority=1;if(t){this.actor=t.actor;if("priority"in t)this.priority=t.priority}};gmath.inherit(Action,e);e.prototype.match=function(t){return t.is_group("mul")&&t.children[1]instanceof s&&t.children[1].value>1&&t.rs};e.prototype.transform=function(e){var r=this.getNewTreeNode(this.actor),n=r.parent,i=r.children[1];this.addTouchedNodes(this.actor);i.value--;var o=n.children.slice(n.children.indexOf(r));var a=this.getOldTreeNode(o);var s=t.remove_range(o);var l=f.prototype.createGroup();var h=v.prototype.createGroup();var u=v.prototype.createGroup();var c;if(i.value===1){r.remove();o=o.slice(1);h.insert_range(0,o);c=t.clone(o);u.insert_range(0,c);this.extendNodeMap(t.get_mapping_between(a.slice(1),c))}else{h.insert_range(0,o);c=t.clone(o);u.insert_range(0,c);u.children[0].remove();this.extendNodeMap(t.get_mapping_between(a,c))}l.append(new f(h));l.append(new f(u));var d=new v(l);n.insert(s,d);this.cleanup(h);this.cleanup(u);var p=n.parent;if(this.cleanup(n))this.cleanup(p);if(typeof e==="function")e(this);return true};e.prototype.mapIndex=function(){map={};return function(t){return map[t]}};return new e}();SplitPowerAction=function(){var e=function(t){Action.call(this,"x^n => x^(n-1) * x");this.priority=2;if(t){this.actor=t.actor;if("priority"in t)this.priority=t.priority}};gmath.inherit(Action,e);e.prototype.match=function(t){return t.is_group("exponent")&&t.children[0]instanceof s&&t.children[0].value>=1};e.prototype.transform=function(e){var r=this.getNewTreeNode(this.actor),n=r.parent,i=n.parent;this.addTouchedNodes(this.actor);var o=n.remove();var a=v.prototype.createGroup();a.append(new v(n));var s=t.clone(n.children[0]);this.extendNodeMap(this.actor.parent.children[0].get_mapping_to(s));a.append(new v(s));var l=r.children[0];l.value--;this.extendNodeMap(this.actor.children[0],s.parent);if(l.value===1){var h=n.children[0];n.remove();a.children[0].append(h);this.extendNodeMap(this.actor.children[0],h.parent)}else if(l.value===0){a.children[0].remove()}this.resultNodes=a.children.slice();i.insert(o,a);this.cleanup(i);if(typeof e==="function")e(this);return true};return new e}();SplitPowerSumAction=function(){var e=function(t){Action.call(this,"x^(n1+n2+...+nm) => x^(n1+n2+...) * x^(nm)");this.priority=3;if(t)this.actor=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){return t.is_group("exponent")&&(t.children[0].is_group("brackets")&&t.children[0].children[1].is_group("sum")||t.children[0].is_group("sum"))};e.prototype.transform=function(e){var r=this.getNewTreeNode(this.actor),n=r.parent,i=n.parent,o=r.children[0];if(o.is_group("brackets"))o=o.children[1];var a=o.children[o.children.length-1],s=this.getOldTreeNode(a.children[0]);this.addTouchedNodes(this.actor.parent);var l=n.remove();var h=v.prototype.createGroup();h.append(new v(n));var u=t.clone(n);h.append(new v(u));u.children[1].children[0].remove();a.remove();var c=a.createGroup();c.append(a);u.children[1].append(c);i.insert(l,h);if(s.parent.is_group("add"))this.updateNodeMap(s,h.children[1].children[0]);else this.extendNodeMap(s,h.children[1].children[0]);this.cleanup(a.parent);this.cleanup(o);this.cleanup(i);if(typeof e==="function")e(this);return true};return new e}();gmath.actions.DistributeIntoBracketsAction=function(){var e=function(t){Action.call(this,"distribute");if(t){this.nodes=t.nodes;this.target=t.target;this.side=t.side}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){var e=[];if(t.length===0)return e;var r=t[0].get_root();if(!t[0].is_group("mul")&&!t[0].is_group("div"))return[];var n=this;function i(i){if(i.children[1]&&i.children[1].is_group("brackets")){o=i.children[1].children[1];if(n.match(t,o,"around"))e.push(n.createBoundAction(r,{nodes:t,target:o,side:"around"}))}}var o=t[0];while(o=o.ls)i(o);o=t[t.length-1];while(o=o.rs)i(o);return e};e.prototype.match=function(t,e,r){if(t.length===0)return false;if(e.value==="("||e.value===")")return false;var n=e.parent;if(!n.parent)return false;var i=n.parent.value;if(i!=="mul"&&i!=="div")return false;for(var o=0;o<t.length;o++)if(t[o].value!==i)return false;if(n.parent.parent!==t[0].parent)return false;if(!n.is_group("brackets"))return false;if(!n.children[1].is_group("sum"))return false;if(!t[0].commutative)return false;if(r==="left-of"&&n.ls===t[t.length-1])return false;if(r==="right-of"&&n.rs===t[0])return false;return true};e.prototype.transform=function(e){var r=this.getNewTreeNode(this.nodes);var n=this.getNewTreeNode(this.target);var i=this.target.parent.children[0],o=this.target.parent.children[2];var a=n.parent;var s;if(r[r.length-1].rs&&r[r.length-1].rs.children[1]&&r[r.length-1].rs.children[1]===a){s="left"}if(r[0].ls&&r[0].ls.children[1]===a){s="right"}var l=a.parent.parent,h=a.children[1];t.remove_range(r);this.distributeIntoSum(h,r,s);if(l.cleanupAction)this.cleanup(l);var u=h.parent;if(!u.is_group("brackets")){var c=h.remove();var p=new d(h);t.insert(u,c,p);this.updateNodeMap(i.parent,p);this.updateNodeMap(i,p.children[0]);this.updateNodeMap(o,p.children[2]);p.simplify=true}if(typeof e==="function")e(this);else return true};e.prototype.distributeIntoSum=function(e,r,n){var i=e.children.length;var o=function(t){if(t.is_group("div"))t.invert()};for(var a=0;a<i;a++){var s=e.children[a].children[1],l,h;s.remove();if(s.is_group("product"))l=s;else{l=new g;l.append(new v(s))}if(n==="left"&&a===0||n==="right"&&a===i-1){h=r}else h=t.clone(r);h.forEach(o);this.extendNodeMap(t.get_mapping_between(this.nodes,h));{var u=n==="left"?1:l.children.length-1;if(l.children[u])l.children[u].simplify=true}var c=n==="left"?0:l.children.length;l.insert_range(c,h);e.children[a].append(l);for(var d=0;d<h.length;d++){h[d].update_x_during_dragging=true}}};return new e}();o.prototype.move_actions.push(gmath.actions.DistributeIntoBracketsAction);gmath.actions.FactorOutOfBracketsAction=function(){var e=function(t){Action.call(this,"factor out");if(t){this.nodes=t.nodes;this.target=t.target;this.side=t.side;this.priority=t.priority||0}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){if(t.length===0)return[];var e=[],r=t[0];while(r.parent&&!r.is_group("brackets"))r=r.parent;if(this.match(t)){e.push(this.bindLeftSideAction(r,t));e.push(this.bindRightSideAction(r,t))}return e};e.prototype.nodesAreAllAddends=function(t,e){if(!t.is_group("sum"))return false;return t.children.length===e.length};e.prototype.bindLeftSideAction=function(t,e){var r=e[0].get_root();return this.createBoundAction(r,{nodes:e,target:t.children[0],side:"left-of"})};e.prototype.bindRightSideAction=function(t,e){var r=e[0].get_root();return this.createBoundAction(r,{nodes:e,target:t.children[2],side:"right-of"})};e.prototype.getContainingBrackets=function(t){try{var e=null;for(var r=0;r<t.length;r++){var n=t[r][0];var i=n.is_group("mul")?n.get_parent(4):n.get_parent(3);if(!i||!i.is_group("brackets")||i.children[0].hidden)return null;if(!e)e=i;else if(e!==i)return null}return e}catch(o){return null}};e.prototype.match=function(r,n){var i=e.prototype.groupNodeRanges(r);var o=this.getContainingBrackets(i);if(!o)return false;if(n&&!(o.children[0]===n||o.children[2]===n))return false;if(!this.nodesAreAllAddends(o.children[1],i))return false;var a=i[0].length;i.forEach(function(t){if(t.length!==a)return false});for(var s=0;s<a;s++){var l;if(i[0][s].value==="mul")l=i[0][s].children[1].to_ascii();else l=i[0][s].to_ascii();for(var h=0;h<i.length;h++){var u;if(i[h][s].value==="mul")u=i[h][s].children[1].to_ascii();else u=i[h][s].to_ascii();if(u!==l)return false}}var c=t.get_cca(r);return c.is_group("sum")&&c.parent===o};e.prototype.groupNodeRanges=function(t){var e=[];var r=[t[0]];e.push(r);for(var n=1;n<t.length;n++){if(t[n-1].rs===t[n]){r.push(t[n])}else{r=[t[n]];e.push(r)}}return e};e.prototype.transform=function(t){var e=this.getNewTreeNode(this.nodes);var r=this.findBracketGroup(e);var n=this.groupNodeRanges(e);var i=n.map(this.getOldTreeNode.bind(this));this.removeRangesFromSum(n);var o=this.factor(r,n,i);if(o.cleanupAction)this.cleanup(o);if(typeof t==="function")t(this);else return true};e.prototype.findBracketGroup=function(t){var e=t[0];if(e&&e.parent&&e.parent.parent&&e.parent.parent.is_group("sum")&&e.parent.parent.parent&&e.parent.parent.parent.is_group("brackets"))return e.parent.parent.parent;if(e&&e.parent&&e.parent.is_group("product")&&e.parent.parent&&e.parent.parent.parent&&e.parent.parent.parent.is_group("sum")&&e.parent.parent.parent.parent&&e.parent.parent.parent.parent.is_group("brackets"))return e.parent.parent.parent.parent;throw"Attempting to factor from invalid structure."};e.prototype.removeRangesFromSum=function(e){for(var r=0;r<e.length;r++){var n=e[r];var i=e[r][0].parent;if(n.length===i.children.length){var o=i.parent;i.remove();t.remove_range(n);o.append(new s(1));this.cleanup(o)}else if(i.value==="add"||i.value==="sub"&&n.length===1){n[0].remove();i.append(new s(1))}else{t.remove_range(e[r]);this.cleanup(i)}}};e.prototype.factor=function(t,e,r){return this.replaceBracketGroupWithFactoredProduct(t,e,r)};e.prototype.replaceBracketGroupWithFactoredProduct=function(e,r,n){var i=v.prototype.createGroup();var o=e.parent;var a=e.remove();var s;if(this.side==="left-of"){s=r[0];if(s.length===1&&s[0].value!=="mul"){s=[new v(s[0])]}i.append_range(s);i.append(new v(e));for(var l=0;l<n.length;l++){if(n[l].length===1&&!n[l][0].is_group("mul")){this.updateNodeMap(n[l][0],s[0])}else{this.updateNodeMap(t.get_mapping_between(n[l],s))}}}else{s=r[r.length-1];if(s.length===1&&s[0].value!=="mul"){s=[new v(s[0])]}i.append(new v(e));i.append_range(s);for(var l=0;l<n.length;l++){if(n[l].length===1&&!n[l][0].is_group("mul")){this.updateNodeMap(n[l][0],s[0])}else{this.updateNodeMap(t.get_mapping_between(n[l],s))}}}for(var h=0;h<s.length;h++){s[h].update_x_during_dragging=true}t.insert(o,a,i);return o};e.prototype.mapIndex=function(){return function(){}};return new e}();o.prototype.move_actions.push(gmath.actions.FactorOutOfBracketsAction);o.prototype.SubstitutionAction=function(){var e=function(t){Action.call(this,"substitution");if(t){this.sourceEq=t.source;this.target=t.target}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t,e){var r=this.findAllMatches(t,e);var n=[];for(var i=0;i<r.length;i++){var o=e.SubstitutionAction.createBoundAction(e,{source:t,target:r[i]});n.push(o)}return n};e.prototype.match=function(t,e){if(e.length===0||e[0].fixed)return false;if(!t.parent)t=t.children[0];if(!t.is_group("equals"))return false;var r=t.children[0].to_ascii();var n=l(r);return n(e)};function r(t){if(t.length===1&&t[0].hidden)return"";return t.map(function(t){return t.to_ascii()}).join("")}function n(t){return t.is_group()&&t.commutative&&t.associative}function i(t){if(t.length===0)return"";if(t.length===1&&t[0].hidden)return"";var e=t.map(function(t){return t.to_ascii()}).join("");if(t.length===1)return e;if(n(t[0]))return e.substring(t[0].children[0].to_ascii().length);return e}function o(t){if(t.length!==1)return"";var e=t[0].to_ascii();if(e.slice(0,1)==="("&&e.slice(e.length-1,e.length)===")")e=e.substr(1,e.length-2);return e}e.prototype.findAllMatches=function(t,e){if(!t.parent)t=t.children[0];if(!t.is_group("equals"))return[];if(!e.parent)e=e.children[0];var r=t.children[0].to_ascii();var n=e.filterRange(l(r));n=n.filter(function(t){return t.length>0&&!t[0].fixed});return n};e.prototype.transform=function(e){var r=this.target,n=r.map(this.getNewTreeNode.bind(this));var i=n[0].parent;var o=t.remove_range(n);var a=t.clone(this.sourceEq.children[0].children[2]);if(n.length>1){a=new n[0].constructor(a)}i.insert(o,a);d.handle(a);this.cleanup(i);if(typeof e==="function")e(this);return true};function a(t){return t[0]&&t[0].parent&&!t[0].parent.is_group("exponent")&&t.length===t[0].parent.children.length}function s(t){return t.parent}function l(t){return function(e){if(e.length===0)return false;if(!e[0].parent)return false;if(s(e[0].parent)&&a(e))return false;return r(e)===t||i(e)===t||o(e)===t}}return new e}();TriggerFactoringAction=function(){var t=function(t){Action.call(this,"general factoring");this.priority=0;this.side="around";if(t){this.DLOfSum=t.dl;this.viewOfSum=t.view;this.target=t.sum;this.callback=t.callback}};gmath.inherit(Action,t);t.prototype.match=function(t,r){return e(t,r)};t.prototype.transform=function(){this.callback(this.viewOfSum,this.target,this.DLOfSum)};var e=function(t,e){var r;r=n(t,e);r=o(r,t);var i=[];for(var a=0;a<r.length;a++){if(r[a].length===0)return false}for(var a=0;a<r.length;a++){if(r[a])i.push(r[a][r[a].length-1])}for(var a=0;a<i.length;a++){if(!Array.isArray(i[a])&&i[a].parent.value!=="add"&&i[a].parent.value!=="sub")i[a]=i[a].parent}return i.length===t.children.length?i:false};var r=function(t,e){var r=[];t.for_each(function(t){var n=t.to_ascii();if(n.slice(0,1)==="*")n=n.substr(1);if(!t.hidden&&n===e)r.push(t);else{var i=[t];while(n.length<e.length&&t.commutative&&t.rs){t=t.rs;n+=t.to_ascii();i.push(t)}if(n===e)r.push(i)}});return r};var n=function(t,e){var n=[];for(var i=0;i<t.children.length;i++){var o=t.children[i],a=o.children[1];n.push(r(a,e.to_ascii()))}return n};function i(t){return function(e){return!e.hidden&&e.to_ascii()===t}}var o=function(t,e){var r=function(t){return t.parent&&(t.parent.value==="add"||t.parent.value==="sub")&&t.parent.parent&&t.parent.parent==e};var n=function(t){return t.parent&&t.parent.value==="mul"&&t.parent.parent&&t.parent.parent.is_group("product")&&t.parent.parent.parent&&t.parent.parent.parent.parent&&t.parent.parent.parent.parent==e};var i=function(t){return t.value==="mul"&&t.parent&&t.parent.is_group("product")&&t.parent.parent&&t.parent.parent.parent&&t.parent.parent.parent==e};var o=function(t){var e=true;if(Array.isArray(t)){for(var o=0;o<t.length;o++)if(!i(t[o]))e=false}else{return r(t)||n(t)}return e};for(var a=0;a<t.length;a++){t[a]=t[a].filter(o)}return t};var a=function(t,e){var r=h(t),n=p(l(r));var i=e.deconstruct();return v(n,i)};var l=function(t){var e=[];for(var r=0;r<t.length;r++){e.push(t[r].slice())}return e};var h=function(t){var e=[];for(var r=0;r<t.children.length;r++){e.push(u(t.children[r]))}return e};var u=function(t){var e=t.children[1];if(t.value==="add")return e.deconstruct();else return d(e.deconstruct())};var c=function(t){t.push(new s(1));return t};var d=function(t){t.push(new s(-1));return t};var p=function(t){var e=t[0].slice();for(var r=0;r<t.length;r++){f(e,t[r])}return e};var f=function(t,e){for(var r=0;r<t.length;){if(g(t[r],e))t.splice(r,1);else r++}};var g=function(t,e){var r=t.to_ascii();var n=true;for(var i=0;i<e.length;){if(r===e[i].to_ascii()){n=false;e.splice(i,1);return n}else{i++}}return n};var v=function(t,e){var r=true;for(var n=0;n<e.length;n++){if(g(e[n],t)){r=false}}return r};return new t}();gmath.rules=gmath.rules||{};gmath.rules.distributes=function(e,r,n){n=n||"both";var i=e.prototype.value+" "+(n=="both"?"":n+"-")+"distributes over "+r.prototype.value;var o=function(n){var i,a;if(n=="both"){if(!this.is_group(e.prototype.name))return false;return o.call(this,"left")||o.call(this,"right")}else if(n=="left"){i=this;a=this.ls}else if(n=="right"){i=this.ls;a=this}else throw"direction must be left, right or both, not '"+n+"'";if(!(a instanceof e))return;if(!i)return false;var s=i.children[1];if(s.is_group("brackets"))s=s.children[1];if(!s.is_group(r.prototype.group_name))return false;t.remove(a);t.for_each(function(t){t.no_anim=true},a);for(var l=0;l<s.children.length;l++){var h=s.children[l];var c=h.children[1];var p=t.clone(a);if(c instanceof u&&c.children[0]instanceof e){if(n=="left")t.insert(c,0,p);else t.append(c,p)}else{var f=e.prototype.createGroup();t.remove(c);var g=new e(c);t.replace(g.children[0],t.clone(this.children[0]));t.append(f,n=="left"?p:g);t.append(f,n=="left"?g:p);t.append(h,f);d.handle(f)}}i.clean_up();return true};e.prototype.add_action_handler({name:i,run:function(){return o.call(this,n)}})};gmath.rules=gmath.rules||{};gmath.rules.inverse_operation=function(e,r){e.prototype.inverse=r.prototype.value;r.prototype.inverse=e.prototype.value;var n=function(){if(!this.ls)return false;if(this.ls instanceof this.getInverse()&&this.children[1].to_ascii()==this.ls.children[1].to_ascii()){t.remove(this.ls);var r=t.remove(this);t.insert(this.parent,r,new e(t.clone(this.identity_element)));this.parent.clean_up();return true}return false};e.prototype.add_action_handler({name:"inverse elements cancel out each other",run:n});r.prototype.add_action_handler({name:"inverse elements cancel out each other",run:n})};gmath.rules=gmath.rules||{};gmath.rules.identity_element=function(t,e){t.prototype.identity_element=e;var r=e.to_ascii()+" is the identity element of "+t.prototype.value;var n=e.to_ascii();var i=function(t){Action.call(this,r);if(t)this.actor=t.actor};gmath.inherit(Action,i);function o(e){return e&&e instanceof t&&e.children.length==2&&e.children[1].to_ascii()==n}i.prototype.match=function(t){return o(t)||o(t.ls)};i.prototype.transform=function(t){var e=this.getNewTreeNode(this.actor);if(o(e)){this.addTouchedNodes(this.actor);this.updateNodeMap(this.actor.select_all(),e.ls||e.rs);e.remove()}else{this.addTouchedNodes(this.actor.ls);this.updateNodeMap(this.actor.ls.select_all(),e);e.ls.remove()}this.cleanup(e.parent);if(typeof t==="function")t(this);else return true};t.prototype.add_action_handler(new i)};gmath.rules=gmath.rules||{};gmath.rules.zero_element=function(t,e){t.prototype.zero_element=e;var r=e.to_ascii();var n=r+" is the zero element of "+t.prototype.value;var i=function(t){Action.call(this,n);if(t)this.actor=t.actor};gmath.inherit(Action,i);function o(e){return e&&e instanceof t&&e.children.length==2&&e.children[1].to_ascii()==r}i.prototype.match=function(t){if(!t.ls)return false;return o(t)||o(t.ls)};i.prototype.transform=function(t){var e=this.getNewTreeNode(this.actor);if(o(e)){this.addTouchedNodes(this.actor.ls);e.ls.remove()}else{this.addTouchedNodes(this.actor);e.remove()}this.cleanup(e.parent);if(typeof t==="function")t(this);else return true};t.prototype.add_action_handler(new i)};gmath.rules=gmath.rules||{};gmath.rules.init_all=function(){gmath.rules.identity_element(f,new s(0));gmath.rules.identity_element(v,new s(1));gmath.rules.zero_element(v,new s(0));gmath.rules.identity_element(w,new y("T"));gmath.rules.zero_element(w,new y("F"));gmath.rules.identity_element(b,new y("F"));gmath.rules.zero_element(b,new y("T"))
};gmath.rules.init_all();mtouch_events=function(){var t=N(m,"tap","dbltap","hold","drag","mdrag","touch","release"),e=null,r=[],n={},i=[],o="mouse",a="client",s=null,l=false,h=250,u=10*10,c=500,d=10,p=d*d,f=400,g=20,v=gmath.uid();function m(){e=this;l(true)}var l=m.connected=function(t){if(arguments.length==0)return l;e.on("touchstart."+v,t?y:null).on("mousedown."+v,t?_:null).on("touchmove."+v,t?w:null).on("touchend."+v,t?x:null).on("touchcancel."+v,t?x:null);l=t;return this};m.call=function(t){t.apply(m,arguments);return this};m.frame=function(t){if(arguments.length===0)return a;a=t;return this};m.origin=function(t){if(arguments.length===0)return s;s=t;return this};m.hold_time=function(t){if(arguments.length===0)return c;c=t;return this};m.hold_max_dist=function(t){if(arguments.length===0)return d;d=t;p=d*d;return this};m.dbltap_max_dist=function(t){if(arguments.length===0)return g;g=t;return this};function _(){if(!M(d3.event))return;var t=d3.select(window);var e=this,r=arguments;t.on("mousemove.mtouch",function(){w.apply(e,r)});t.on("mouseup.mtouch",function(){t.on("mousemove.mtouch",null);t.on("mouseup.mtouch",null);x.apply(e,r)});y.apply(this,arguments)}function y(){d3.event.preventDefault();var e=this,i=t.of(e,arguments),o=A();var a=s?s.apply(this,arguments):null;for(var l=0,h=o.length;l<h;l++){var u=new b(o[l].identifier,i,e,a);r.push(u);n[o[l].identifier]=u;i({type:"touch",finger:u,fingers:r})}}function w(){d3.event.preventDefault();var e=this,i=t.of(e,arguments),o=A();for(var a=0,s=r.length;a<s;a++)r[a].changed=false;var l=[];for(var a=0,s=o.length;a<s;a++){var h=n[o[a].identifier];if(!h)continue;h.move(i);l.push(h)}i({type:"mdrag",dragged_fingers:l,fingers:r})}function x(){d3.event.preventDefault();var e=this,i=t.of(e,arguments),o=A();for(var a=0,s=o.length;a<s;a++){var l=n[o[a].identifier];if(!l)continue;l.end(i);delete n[o[a].identifier];r=d3.values(n);i({type:"release",finger:l,fingers:r})}}function b(t,e,r,n){this.id=t;this.target=r;this.event=e;this.parent=r.parentNode;this.timeStamp0=d3.event.timeStamp;this.timeStamp=this.timeStamp0;this.hold_timer=setTimeout(this.held.bind(this),c);this.pos=n?n.slice():P(this.id,a);this.pos0=[this.pos[0],this.pos[1]];this.pos_client=P(this.id,"client");this.dist_x=0;this.dist_y=0;this.dx=0;this.dy=0;this.dt=0;this.changed=true;this.gesture=null}b.prototype.cancel_hold=function(){if(this.hold_timer)clearTimeout(this.hold_timer);this.hold_timer=null};b.prototype.held=function(){this.event({type:"hold",finger:this,fingers:r});this.hold_timer=null};b.prototype.move=function(t){this.changed=true;this.event=t;var e=P(this.id,"client"),n=d3.event.timeStamp;this.dx=e[0]-this.pos_client[0];this.dy=e[1]-this.pos_client[1];this.pos[0]+=this.dx;this.pos[1]+=this.dy;this.dist_x=this.pos[0]-this.pos0[0];this.dist_y=this.pos[1]-this.pos0[1];this.pos_client=e;this.dt=n-this.timeStamp;this.timeStamp=n;if(this.dist_x*this.dist_x+this.dist_y*this.dist_y>p){this.cancel_hold()}if(this.gesture)return;t({type:"drag",finger:this,x:this.pos[0],y:this.pos[1],dx:this.dx,dy:this.dy,fingers:r})};b.prototype.end=function(t){var e=d3.event.timeStamp-this.timeStamp0;if(e<=h&&this.dist_x*this.dist_x+this.dist_y*this.dist_y<=u){if(L(d3.event.timeStamp,this.pos[0],this.pos[1])){t({type:"dbltap",finger:this,fingers:r})}else{t({type:"tap",finger:this,fingers:r})}}this.cancel_hold()};function A(){return d3.event.changedTouches||[{identifier:o}]}function M(t){if("buttons"in t)return t.buttons===1;else if("which"in t)return t.which===1;else return t.button===1}function L(t,e,r){var n=-1,o=[e,r];i=i.filter(function(e,r){if(t-e.timeStamp<=f&&D(e.pos,o)<=g)n=r;return e.timeStamp-t<=f&&n!==r});if(n===-1)i.push({timeStamp:t,pos:o});return n!==-1}function T(t){if(s)return s();else return P(t,a)}function P(t,e){if(e==="client"){if(t===o)return[d3.event.clientX,d3.event.clientY];for(var r=0;r<d3.event.touches.length;r++){var n=d3.event.touches[r];if(n.identifier===t)return[n.clientX,n.clientY]}}else{if(t===o)return k(e,d3.event);for(var r=0;r<d3.event.touches.length;r++){var n=d3.event.touches[r];if(n.identifier===t)return k(e,n)}}}function D(t,e){return Math.sqrt((t[0]-e[0])*(t[0]-e[0])+(t[1]-e[1])*(t[1]-e[1]))}return d3.rebind(m,t,"on")};function N(t){var e=d3.dispatch.apply(this,Array.apply(null,arguments).slice(1));e.of=function(r,n){return function(i){try{var o=i.sourceEvent=d3.event;i.target=t;d3.event=i;e[i.type].apply(r,n)}finally{d3.event=o}}};return e}gmath.d3_eventDispatch=N;var M=0;if(typeof window!=="undefined")M=/WebKit/.test(window.navigator.userAgent)?-1:0;function k(t,e){var r=t.ownerSVGElement||t;if(r.createSVGPoint){var n=r.createSVGPoint();if(M<0&&(window.scrollX||window.scrollY)){r=d3.select("body").append("svg").style({position:"absolute",top:0,left:0,margin:0,padding:0,border:"none"},"important");var i=r[0][0].getScreenCTM();M=!(i.f||i.e);r.remove()}if(M)n.x=e.pageX,n.y=e.pageY;else n.x=e.clientX,n.y=e.clientY;n=n.matrixTransform(t.getScreenCTM().inverse());return[n.x,n.y]}var o=t.getBoundingClientRect();return[e.clientX-o.left-t.clientLeft,e.clientY-o.top-t.clientTop]}drag_behavior=function(){var t=N(u,"drag","drag-start","drag-end"),e=[],r=false,n,i,o,a,s=10,l=5,h=true;var u=function(){this.on("touch.drag",c).on("mdrag.drag",d).on("release.drag",p)};u.min_single_dist=function(t){if(arguments.length===0)return s;s=t;return this};u.min_double_dist=function(t){if(arguments.length===0)return l;l=t;return this};u.allow_double_drag=function(t){if(arguments.length===0)return h;h=t;return this};var c=function(){if(e.length===2||h&&e.length===1)return;e.push(d3.event.finger);if(e.length===2){n=[(e[0].pos[0]+e[1].pos[0])/2,(e[0].pos[1]+e[1].pos[1])/2];i=[n[0],n[1]];a=o=f(e[0].pos,e[1].pos)}else{n=[e[0].pos[0],e[0].pos[1]];i=[n[0],n[1]];o=a=0}};var d=function(){if(e.length===0)return;var h,u=t.of(this,arguments);if(e.length===1){if(!e[0].changed)return;h=[e[0].pos[0],e[0].pos[1]];if(!r&&f(n,i)>=s){r=true;u({type:"drag-start",fingers:e,pos0:n,pos:i,dist0:o,dist:a})}}else{if(!e[0].changed&&!e[1].changed)return;h=[(e[0].pos[0]+e[1].pos[0])/2,(e[0].pos[1]+e[1].pos[1])/2];a=f(e[0].pos,e[1].pos);if(!r&&f(n,i)>=l){r=true;u({type:"drag-start",fingers:e,pos0:n,pos:i,dist0:o,dist:a})}}if(r)u({type:"drag",fingers:e,pos0:n,pos:h,dist0:o,dist:a,dx:h[0]-i[0],dy:h[1]-i[1]});i=h};var p=function(){if(e.length===0)return;var o=d3.event.finger;var a=e.indexOf(o);if(a===-1)return;e.splice(a,1);if(!r)return;if(e.length===1){n=[e[0].pos[0],e[0].pos[1]];i=[n[0],n[1]]}if(e.length===0){r=false;t.of(this,arguments)({type:"drag-end"})}};function f(t,e){return Math.sqrt((t[0]-e[0])*(t[0]-e[0])+(t[1]-e[1])*(t[1]-e[1]))}return d3.rebind(u,t,"on")};var L=function(t,e){if(arguments.length<3)e=1e3;var r={},n=[];r.fonts=[];r.map={};r.finished=false;r.success=false;r.svg=d3.select("body").append("svg").style({position:"absolute",visibility:"hidden",width:"1px",height:"1px"});r.on_fonts_loaded=function(t){if(this.finished)t(this.success);else{n.push(t)}};var i=function(){r.loadSizes();for(var t=0;t<n.length;t++){n[t](this.success)}n=[]};r.add_fonts=function(t){var e=false;t.forEach(function(t){var n=o(t);if(n)t.id=n.id;else{t.id=gmath.uid();r.fonts.push(t);e=true}});if(!e)return;r.finished=false;r.success=false};var o=function(t){for(var e=0;e<r.fonts.length;e++){var n=r.fonts[e];if(n.style===t.style&&n.family===t.family&&n.weight===t.weight)return n}return null};r.wait_for_fonts=function(){this.finished=false;this.success=false;this.fonts.unshift({family:"serif"});var t=this.svg.selectAll("text.temp").data(this.fonts).enter().append("text").classed("temp",true).attr("font-size","100px").attr("font-family",function(t){return"'"+t.family+"', serif"}).attr("font-style",function(t){return t.style}).attr("font-weight",function(t){return t.weight}).text("012abc");this.fonts.shift();var r=Date.now();var n=this;var o=setInterval(function(){var a=[],s=true;t.each(function(t,e){a[e]=this.getBBox().width});for(var l=1;l<a.length;l++){if(a[l]===a[0])s=false}var h=Date.now()-r;if(!s&&h<=e)return;n.success=s;n.finished=true;t.remove();clearInterval(o);i()},20)};r.loadSizes=function(t,e){t=t||"xyz0123456789()=+-*^∗·•−,.";e=e||this.fonts;var r=[];for(var n=0;n<e.length;n++){if(!this.map[e[n].id]){this.map[e[n].id]={}}for(var i=0;i<t.length;i++){var o={font:e[n],"char":t[i],width:0,height:0};this.map[e[n].id][t[i]]=o;r.push(o)}}this.svg.selectAll(".hiddenChars").data(r).enter().append("text").attr("font-size","100px").attr("font-family",function(t){return t.font.family}).attr("font-style",function(t){return t.font.style}).attr("font-weight",function(t){return t.font.weight}).text(function(t){return t.char}).each(function(t){var e=this.getBBox();t.width=e.width;t.height=e.height}).remove()};r.width=function(t,e,r){var n=0,i=t.toString();for(var o=0;o<i.length;o++){if(!this.map[r.id]||!this.map[r.id][i[o]])this.loadSizes(i[o],[r]);n+=this.map[r.id][i[o]].width}return n*e/100};r.height=function(t,e,r){var n=0,i=t.toString();for(var o=0;o<i.length;o++){if(!this.map[r.id]||!this.map[r.id][i[o]])this.loadSizes(i[o],[r]);n=Math.max(this.map[r.id][i[o]].height,n)}return n*e/100};r.add_fonts(t);if(!r.finished)r.wait_for_fonts();return r};transform_behavior=function(){var t=N(m,"transform","transformend","transformstart"),e=[],r=0,n=0,i=0,o=1,a={scale:true,translate:true,rotate:true},s=true,l,h,u,c,d,p,f,g,v;var m=function(){this.on("touch.transform",_).on("mdrag.transform",y).on("release.transform",w)};m.transform=function(t){if(!arguments.length)return{scale:o,rotate:i,translate:[r,n]};if("scale"in t)o=t.scale;if("rotate"in t)i=t.rotate;if("translate"in t){r=t.translate[0];n=t.translate[1]}return m};m.one_finger_drag=function(t){if(!arguments.length)return s;s=t;return m};m.allow_translate=function(t){if(!arguments.length)return a.translate;a.translate=t;return m};m.allow_scale=function(t){if(!arguments.length)return a.scale;a.scale=t;return m};m.allow_rotate=function(t){if(!arguments.length)return a.rotate;a.rotate=t;return m};var _=function(){if(e.length===2)return;e.push(d3.event.finger);if(e.length===1&&s){l=h=[e[0].pos[0],e[0].pos[1]];u=A(h);t.of(this,arguments)({type:"transformstart"})}if(e.length===2){l=h=L(e[0].pos,e[1].pos);c=d=k(e[0].pos,e[1].pos);p=f=T(e[0].pos,e[1].pos);u=A(h);g=o;v=i}};var y=function(){if(e.length===0)return;if(!d3.event.dragged_fingers.some(function(t){return t.changed}))return;if(e.length===1){if(!s)return;if(a.translate)l=[e[0].pos[0],e[0].pos[1]];M(l,u)}if(e.length===2){if(a.scale)c=k(e[0].pos,e[1].pos);if(a.translate)l=L(e[0].pos,e[1].pos);if(a.rotate)p=T(e[0].pos,e[1].pos);x()}t.of(this,arguments)({type:"transform",fingers:e,transform:{scale:o,rotate:i,translate:[r,n]}})};var w=function(){if(e.length===0)return;var r=d3.event.finger;var n=e.indexOf(r);if(n===-1)return;e.splice(n,1);if(e.length===0){t.of(this,arguments)({type:"transformend"})}if(e.length===1){l=h=[e[0].pos[0],e[0].pos[1]];u=A(h)}};var x=function(){if(a.rotate)i=v+(p-f);if(a.scale)o=g*c/d;if(a.translate||a.rotate||a.scale)M(l,u)};var b=function(t){var e=Math.cos(i),a=Math.sin(i);var s=t[0]*e-t[1]*a,l=t[1]*e+t[0]*a;return[s*o+r,l*o+n]};var A=function(t){var e=(t[0]-r)/o,a=(t[1]-n)/o;var s=Math.cos(-i),l=Math.sin(-i);return[e*s-a*l,a*s+e*l]};var M=function(t,e){e=b(e);r+=t[0]-e[0];n+=t[1]-e[1]};function k(t,e){return Math.sqrt((t[0]-e[0])*(t[0]-e[0])+(t[1]-e[1])*(t[1]-e[1]))}function L(t,e){return[(t[0]+e[0])/2,(t[1]+e[1])/2]}function T(t,e){return Math.atan2(t[1]-e[1],t[0]-e[0])}return d3.rebind(m,t,"on")};gmath.transform_behavior=transform_behavior;var T={};T.draw=function(t,e,r){var n=t.selectAll(".target_area").data(e?e:[]);n.enter().append("rect").classed("target_area",true).style({fill:"none",stroke:"lightpink","stroke-width":2,"stroke-style":"dashed"});n.attr("x",function(t){return t.x}).attr("y",function(t){return t.y}).attr("width",function(t){return t.width}).attr("height",function(t){return t.height});n.exit().remove();var i=t.selectAll(".source_area").data(r?[r]:[]);i.enter().append("rect").classed("source_area",true).style({fill:"none",stroke:"steelblue","stroke-width":2});i.attr("x",function(t){return t.x}).attr("y",function(t){return t.y}).attr("width",function(t){return t.width}).attr("height",function(t){return t.height});i.exit().remove()};T.getBoundingBox=function(t,e){if(arguments.length<2)e=1;var r=Infinity,n=-Infinity,i=Infinity,o=-Infinity;for(var a=0;a<t.length;a++){var s=t[a];if(s.hidden)continue;r=Math.min(r,s.sel_box.x+s.x);n=Math.max(n,s.sel_box.x+s.x+s.sel_box.width);i=Math.min(i,s.sel_box.y+s.y);o=Math.max(o,s.sel_box.y+s.y+s.sel_box.height)}var l=n-r,h=o-i;return{x:r+l*(1-e)/2,y:i+h*(1-e)/2,width:l*e,height:h*e}};T.setTargetRegions=function(t){t.forEach(function(t){var e=t.target;switch(t.side){case"left-of":t.x=e.sel_box.x+e.x-.5;t.width=1;t.y=e.sel_box.y+e.y;t.height=e.sel_box.height;break;case"right-of":t.x=e.sel_box.x+e.x+e.sel_box.width-.5;t.width=1;t.y=e.sel_box.y+e.y;t.height=e.sel_box.height;break;case"below":t.x=e.sel_box.x+e.x;t.width=e.sel_box.width;t.y=e.sel_box.y+e.y+e.sel_box.height-.5;t.height=1;break;case"above":t.x=e.sel_box.x+e.x;t.width=e.sel_box.width;t.y=e.sel_box.y+e.y-.5;t.height=1;break;default:if(Array.isArray(e)){var r=T.getBoundingBox(t.target);t.x=r.x-(t.margin?t.margin:0);t.width=r.width+(t.margin?t.margin*2:0);t.y=r.y-(t.margin?t.margin:0);t.height=r.height+(t.margin?t.margin*2:0)}else{t.x=e.sel_box.x+e.x-(t.margin?t.margin:0);t.width=e.sel_box.width+(t.margin?t.margin*2:0);t.y=e.sel_box.y+e.y-(t.margin?t.margin:0);t.height=e.sel_box.height+(t.margin?t.margin*2:0)}break}if(t.offset){t.x+=t.offset.x;t.y+=t.offset.y}});T.extendExtremeTargetBoxes(t)};T.extendExtremeTargetBoxes=function(t){var e,r;var n;for(var i=0;i<t.length;i++){var o=t[i];if(!o.nodes)continue;if(!n)n=T.getBoundingBox(o.nodes);if(!e&&o.x+o.width<n.x||e&&o.x<e.x&&o.x+o.width<n.x)e=o;if(!r&&n.x+n.width<o.x||r&&r.x<o.x&&n.x+n.width<o.x)r=o}if(e&&e.side!=="inside"){e.x-=1e3;e.width+=1e3;e.y-=500;e.height+=1e3}if(r&&r.side!=="inside"){r.width+=1e3;r.y-=500;r.height+=1e3}};T.getHits=function(t,e){return t.filter(function(t){return t.side!=="outside"&&T.overlaps(t,e)}).concat(t.filter(function(t){return t.side==="outside"&&!T.overlaps(t,e)}))};T.getBestHit=function(t,e){var r=T.getHits(t,e);return T.getHighestPriorityHit(r,e)};T.getEnclosingRectForSourceLineEndpoint=function(t){return{xmin:t.B.x-2,ymin:t.B.y-2,xmax:t.B.x+2,ymax:t.B.y+2}};T.overlaps=function(t,e){return(t.x>=e.x&&t.x<=e.x+e.width||t.x+t.width>=e.x&&t.x+t.width<=e.x+e.width||t.x<=e.x&&t.x+t.width>=e.x+e.width)&&(t.y>=e.y&&t.y<=e.y+e.height||t.y+t.height>=e.y&&t.y+t.height<=e.y+e.height||t.y<=e.y&&t.y+t.height>=e.y+e.height)};T.getHighestPriorityHit=function(t,e){var r=null;for(var n=0;n<t.length;n++){var i=t[n];if(!r)r=i;else if(r.side==="outside")r=i;else if(i.priority>r.priority)r=i;else if(i.priority===r.priority){if(T.getCenterDist(i,e)<T.getCenterDist(r,e))r=i}}return r};T.getCenterDist=function(t,e){var r=t.x+t.width/2-e.x-e.width/2,n=t.y+t.height/2-e.y-e.height/2;return Math.sqrt(r*r+n*n)};T.getOverlapArea=function(t,e){var r=Math.max(t.x,e.x)-Math.min(t.x+t.width,e.x+e.width),n=Math.max(t.y,e.y)-Math.min(t.y+t.height,e.y+e.height);return Math.max(0,r)*Math.max(0,n)};var P=function(t,e){this.view=t;this.alm=t.model;this.nodes=[];this.line={A:{},B:{}};this.line_el=null;this.interaction_handler=e;this.action=gmath.actions.FractionCancelAction};P.prototype.check=function(t,e){return t.fingers.length==1&&e.length==0};P.prototype.start=function(t,e){this.line_el=this.view.main.append("line").classed("cancel-fraction",true).style("stroke",this.view.options.selection_color).style("stroke-width",6).style("stroke-linecap","round");this.nodes=[];this.line.A.x=this.line.B.x=t[0];this.line.A.y=this.line.B.y=t[1];return[]};P.prototype.update=function(t){this.line.B.x+=t.dx;this.line.B.y+=t.dy;var e=this.process_selection(this.get_crossed_nodes());var r=true;if(this.nodes.length!=e.length)r=false;else for(var n=0;n<this.nodes.length;n++)r=r&&this.nodes[n]==e[n];if(!r)this.interaction_handler.highlight_nodes(e);this.nodes=e;this.line_el.attr("x1",this.line.A.x).attr("y1",this.line.A.y).attr("x2",this.line.B.x).attr("y2",this.line.B.y)};P.prototype.end=function(){this.line_el.remove();var t=this.nodes[0],e;if(this.nodes.length===3&&this.nodes[1].value==="//")e=this.nodes[2];else if(this.nodes.length===2)e=this.nodes[1];if(e&&this.action.match(t,e)){var r=this.actions.createBoundAction(this.alm,{nodes:[e],target:t});this.alm.performAction(r,null,"cancel fraction")}this.nodes=[]};P.prototype.process_selection=function(e){var r=e.length;if(r===0)return[];if(r===1)return[e[0].parent];var n=t.get_cca(e);if(n.is_group("fraction")){var i=[];for(var o=0;o<e.length;o++){var a=e[o];while(a.parent!=n)a=a.parent;if(a.value=="//"&&n.get_bottom().length!=1)continue;if(i.indexOf(a)==-1)i.push(a)}return i}else return[n]};P.prototype.get_crossed_nodes=function(){var e=[];var r=t.get_leaf_nodes(this.alm);for(var n=0;n<r.length;n++){var i=r[n];if(!i.hidden&&this.intersects(i))e.push(i)}return e};P.prototype.intersects=function(t){var e=this.line.A,r=this.line.B;var n=t.sel_box.x+t.x,i=t.sel_box.x+t.sel_box.width+t.x;var o=t.sel_box.y+t.y,a=t.sel_box.y+t.sel_box.height+t.y;if(e.x<n&&r.x<n)return false;if(e.x>i&&r.x>i)return false;if(e.y<o&&r.y<o)return false;if(e.y>a&&r.y>a)return false;var s=function(t,n){return(e.x-r.x)*(e.y-n)-(e.y-r.y)*(e.x-t)<0};if(s(n,o)!=s(i,o))return true;if(s(i,o)!=s(n,a))return true;if(s(n,a)!=s(i,a))return true;return false};var D=function(t,e){this.default_precision=0;this.interaction_handler=e;this.precision=null;this.view=t;this.dy=0;this.pixels_per_unit=50;this.node=null;this.value=null;this.value0=null};D.prototype.check=function(t){var e=t.pos0[1]-t.pos[1];return Math.abs(e)>=10};D.prototype.start=function(t,e){this.node=this.process_selection(e);if(!this.node)return[];if(this.node&&this.node.precision)this.precision=this.node.precision;else this.precision=this.default_precision;this.dy=0;this.value=this.value0=this.view.model.numeric_value(this.node);return[this.node]};D.prototype.update=function(t){if(!this.node||!t.dy)return;this.dy+=t.dy;var e=-this.dy/this.pixels_per_unit;this.set_value(this.value0+e)};D.prototype.set_value=function(e){e=+e.toFixed(this.precision);if(e===this.value)return;this.value=e;this.node=this.view.model.numeric_value(this.node,e);t.get_root(this.node).reportIntervention({type:"changeNumber",object:this.node,value:e,id:gmath.uid()});this.interaction_handler.highlight_nodes(this.start(null,[this.node]))};D.prototype.end=function(){this.node=null};D.prototype.process_selection=function(t){var e=function(t){return t.is_group("sign")||t.is_group("add")||t.is_group("sub")};if(t.length===0||t.length>2)return null;if(t.length===2){var r=t[1];if(r instanceof s&&e(r))return r.parent;return null}var n=t[0];if(n instanceof s){if(e(n.parent))return n.parent;else return n}else if(e(n))return n;return null};var E=function(t,e,r){this.send_events=true;this.events=d3.dispatch("tap","drag_start","drag","drag_end","touch","release","inspect_node");this.view=t;this.recorder=r;this.mode="transform";this.interactive=e;this.init();if(!e)this.set_interactive(false);this.selected_nodes=[];this.handlers={transform:[new z(this.view,this),new H(this.view,this),new q(this.view,this),new V(this.view,this),new j(this.view,this)],change:[new D(this.view,this)]};this.active_handler=null;this.finger_vis=null};E.prototype.getHandlerByClass=function(t){var e=function(e){return e instanceof t};for(var r in this.handlers){var n=this.handlers[r].filter(e);if(n.length>0)return n[0]}};E.prototype.end_of_interaction=function(){this.view.model.finishInteraction()};E.prototype.init=function(){var t=this.view.main.node();this.mtouch=mtouch_events().frame(t);this.view.event_receiver.call(this.mtouch);this.mtouch.on("touch",this.on_touch.bind(this,null)).on("release",this.on_release.bind(this,null)).on("tap",this.on_tap.bind(this,null));var e=drag_behavior().on("drag-start",this.on_drag_start.bind(this,null)).on("drag",this.on_drag.bind(this,null)).on("drag-end",this.on_drag_end.bind(this,null));this.mtouch.call(e)};E.prototype.set_mode=function(t){if(t!=="transform"&&t!=="change"&&t!=="inspect")throw"unknown interaction mode!";this.mode=t;if(!this.interactive)this.mtouch.connected(this.mode==="inspect")};E.prototype.set_interactive=function(t){this.interactive=!!t;if(this.mode==="inspect")this.mtouch.connected(true);else this.mtouch.connected(this.interactive)};E.prototype.select_new_handler=function(t){var e=this.handlers[this.mode]||[];for(var r=0;r<e.length;r++){var n=e[r];if(n.check(t,this.selected_nodes)){this.active_handler=n;this.selected_nodes=n.start(t.pos,this.selected_nodes);this.highlight_nodes();return}}};E.prototype.on_tap=function(t){var e=this.selectInputEvent(t,d3.event);if(this.send_events)this.events.tap(new B(e));if(this.active_handler){console.error("should not happen");this.selected_nodes=this.active_handler.end()||[];this.highlight_nodes();this.active_handler=null}if(e.shiftKey)return;var r=this.get_closest_node_at(e.finger.pos);if(r)r=this.getFirstUnfixedParent(r);if(!r)return;var n=this;if(this.mode==="inspect")this.events.inspect_node({node:r});if(this.mode==="transform"){this.view.model.process_operator(r,function(){n.selected_nodes=[];n.highlight_nodes();n.end_of_interaction()})}};E.prototype.getFirstUnfixedParent=function(t){while(t.fixed&&t.parent&&!o.is_top_most(t.parent))t=t.parent;return t};E.prototype.selectInputEvent=function(t,e){if(t)return t;var r=e;while(r.sourceEvent)r=r.sourceEvent;e.shiftKey=r.shiftKey;e.altKey=r.altKey;return e};E.prototype.on_drag_start=function(e){if(!this.interactive)return;var r=this.selectInputEvent(e,d3.event);if(this.send_events)this.events.drag_start(new F(r));if(this.active_handler)return;if(this.selected_nodes.length>1){this.selected_nodes=t.nodes_to_range(this.selected_nodes)}this.select_new_handler(r)};E.prototype.update_fingers=function(t,e){if(!this.finger_sel){var r=this.view.svg.node();while(r.tagName.toLowerCase()!=="svg")r=r.parentNode;this.finger_sel=d3.select(r).selectAll(".finger");var n=d3.touches(r,[{pageX:0,pageY:0,clientX:0,clientY:0}])[0];var i=d3.touches(this.view.svg.node(),[{pageX:0,pageY:0,clientX:0,clientY:0}])[0];this.dpos_finger_vis=[i[0]-n[0],i[1]-n[1]];this.finger_vis_start=Date.now()}var o=this.finger_sel.data(t);if(!e){o.enter().append("circle").classed("finger",true).attr("r",25).style({stroke:"#4D4D4D","stroke-opacity":.5,fill:"#B2CAED","fill-opacity":.5})}var a=this.dpos_finger_vis;o.attr("cx",function(t){return t.pos[0]-a[0]}).attr("cy",function(t){return t.pos[1]-a[1]});o.transition().ease("bounce").attr("r",17);var s=this.finger_vis_start;o.exit().transition().delay(Math.max(0,250-(Date.now()-s))).style("opacity",1e-4).remove();this.finger_sel=o.size()===0?null:o};E.prototype.on_drag=function(t){if(!this.interactive)return;var e=this.selectInputEvent(t,d3.event);if(this.send_events)this.events.drag(new O(e));if(t)this.update_fingers(t.fingers,true);if(!this.active_handler)this.select_new_handler(e);if(this.active_handler)this.active_handler.update(e)};E.prototype.on_drag_end=function(){if(!this.interactive)return;if(this.send_events)this.events.drag_end(new R);if(!this.active_handler)return;this.selected_nodes=this.active_handler.end()||[];this.highlight_nodes();this.active_handler=null;this.end_of_interaction()};E.prototype.on_touch=function(t){if(!this.interactive)return;var e=this.selectInputEvent(t,d3.event);if(this.send_events)this.events.touch(new C(e));if(t)this.update_fingers(t.fingers);if(this.active_handler)return;if(e.fingers.length===1){var r=this.get_user_selection(e.fingers[0],null,e);if(e.shiftKey){this.selected_nodes=gmath.array.xor(this.selected_nodes,r)}else{if(!gmath.array.containsAll(this.selected_nodes,r)){this.selected_nodes=r}}}else if(e.fingers.length===2){this.selected_nodes=this.get_user_selection(e.fingers[0],e.fingers[1],e)}this.highlight_nodes()};E.prototype.on_release=function(t){if(!this.interactive)return;var e=this.selectInputEvent(t,d3.event);if(this.send_events)this.events.release(new I(e));if(t)this.update_fingers(t.fingers);if(e.fingers.length===0&&!e.shiftKey){this.selected_nodes=[];if(this.interactive)this.highlight_nodes()}};E.prototype.get_user_selection=function(e,r,n){var i;if(r)i=this.get_nodes_between(e.pos,r.pos);else{var a=this.get_closest_node_at(e.pos);if(!a)return[];a=this.getFirstUnfixedParent(a);if(n.altKey){while(a.parent.parent&&!a.parent.commutative&&a.fixed)a=a.parent;if(a.parent.commutative)i=[a.parent.parent];else i=o.is_top_most(a.parent)?[a]:[a.parent]}else i=[a]}return t.nodes_to_range(i)};E.prototype.highlight_nodes=function(e){if(!e)e=this.selected_nodes;var r=this.view;t.for_each(function(t){t.selected=false},r.model.children);for(var n=0;n<e.length;n++)e[n].selected=true;r.renderer.set_style(r.model.children,true);r.update_style()};E.prototype.get_hits=function(e){var r=e[0],n=e[1];return t.get_leaf_nodes(this.view.model).filter(function(t){return!t.hidden&&t.sel_box&&r<=t.x+t.sel_box.x+t.sel_box.width&&r>=t.x+t.sel_box.x&&n<=t.y+t.sel_box.y+t.sel_box.height&&n>=t.y+t.sel_box.y})};E.prototype.get_closest_node_at=function(t){var e=null,r=Infinity;var n=t[0],i=t[1];var o=this.get_hits(t);for(var a=0;a<o.length;a++){if(o[a].hidden)continue;var s=o[a].x-n;var l=o[a].y-o[a].baseline_shift-i;var h=s*s+l*l;if(h<r){r=h;e=o[a]}}return e};E.prototype.get_nodes_between=function(e,r){var n=0;return t.get_leaf_nodes(this.view.model).filter(function(t){if(t.hidden||!t.sel_box||t.value=="//")return false;var i=[t.x+t.sel_box.x+t.sel_box.width/2,t.y+t.sel_box.y+t.sel_box.height/2];var o=S(e,r,i);var a=t.sel_box.width/4+t.sel_box.height/4;if(o.len==0)return o.dist<=a+n;return o.k>=0&&o.k<=1&&o.dist<=a+n})};var S=function(t,e,r){var n,i,o=.5;var a=[e[0]-t[0],e[1]-t[1]];var s=Math.sqrt(a[0]*a[0]+a[1]*a[1]);if(s<1e-6){n=t[0]-r[0];i=t[1]-r[1];s=0}else{var l=[r[0]-t[0],r[1]-t[1]];var o=(a[0]*l[0]+a[1]*l[1])/s;var n,i;if(o<0){n=t[0]-r[0];i=t[1]-r[1]}else if(o>s){n=e[0]-r[0];i=e[1]-r[1]}else{n=t[0]+o*a[0]/s-r[0];i=t[1]+o*a[1]/s-r[1]}}return{dist:Math.sqrt(n*n+i*i),k:o/s,len:s}};var F=function(t){this.type="drag_start";this.time=Date.now();this.pos=[t.pos[0],t.pos[1]];this.pos0=[t.pos0[0],t.pos0[1]];this.dist=t.dist;this.dist0=t.dist0;this.altKey=t.altKey;this.shiftKey=t.shiftKey;this.fingers={length:t.fingers.length}};var B=function(t){this.type="tap";this.time=Date.now();this.altKey=t.altKey;this.shiftKey=t.shiftKey;this.finger={pos:[t.finger.pos[0],t.finger.pos[1]]}};var O=function(t){this.type="drag";this.time=Date.now();this.dx=t.dx;this.dy=t.dy;this.dist=t.dist;this.dist0=t.dist0;this.pos=[t.pos[0],t.pos[1]];this.pos0=[t.pos0[0],t.pos0[1]];this.fingers=t.fingers.map(function(t){return{pos:[t.pos[0],t.pos[1]]}})};var R=function(){this.type="drag_end";this.time=Date.now()};var C=function(t){this.type="touch";this.time=Date.now();this.altKey=t.altKey;this.shiftKey=t.shiftKey;this.fingers=t.fingers.map(function(t){return{pos:[t.pos[0],t.pos[1]]}})};var I=function(t){this.type="release";this.time=Date.now();this.altKey=t.altKey;this.shiftKey=t.shiftKey;this.fingers=t.fingers.map(function(t){return{pos:[t.pos[0],t.pos[1]]}})};var V=function(t){this.view=t;this.alm=this.view.model;this.nodes=[];this.node_ids=[];this.joined=false;this.unjoined_state=null};V.prototype.check=function(t){return t.dist-t.dist0<-15};V.prototype.start=function(t,e){this.nodes=this.proccess_selection(e);this.node_ids=this.nodes.map(function(t){return t.id});return this.nodes};V.prototype.update=function(e){if(this.joined){if(e.dist>3*e.dist0/4+10)this.unjoin();return}if(this.nodes.length<1||e.dist>3*e.dist0/4)return;var r=this.nodes[0].commutative?1:0;this.unjoined_state=t.clone(this.alm.children[0],true);this.unjoined_state.parent=this.alm;this.joined=true;var n=this;var i=function(t){n.alm.process_operator(n.nodes[t],function(){if(t+1<n.nodes.length)i(t+1);else n.nodes=[]})};i(r)};V.prototype.unjoin=function(){var e=this.alm;this.joined=false;e.children[0]=this.unjoined_state;e.changed();this.nodes=this.node_ids.map(function(r){return t.get_by_id(r,e.children)})};V.prototype.end=function(){this.nodes=[];this.node_ids=[];this.unjoined_state=null;this.joined=false};V.prototype.proccess_selection=function(t){if(t.length!==2)return t;if(!t[0].parent.commutative||!t[1].is_group())return t;return t[1].children.slice()};var z=function(t,e){this.view=t;this.alm=this.view.model;this.interaction_handler=e;this.initial_nodes=[];this.nodes=[];this.pos0=null;this.pos=null;this.box_el=null};z.prototype.check=function(t){return t.shiftKey};z.prototype.start=function(t,e){this.pos0=t.slice();this.pos=t.slice();this.initBox();this.initial_nodes=e;return e};z.prototype.update=function(t){this.pos[0]+=t.dx;this.pos[1]+=t.dy;this.updateBox();var e=this.getNodesInRect(this.pos0[0],this.pos0[1],this.pos[0],this.pos[1]);if(gmath.array.isPermutation(e,this.nodes))return;this.nodes=e;this.highlight()};z.prototype.initBox=function(){this.box_el=this.view.main.append("rect").attr("transform","translate("+this.pos0+")").style("stroke",this.view.options.selection_color).style("stroke-width",2).style("fill",this.view.options.selection_color).style("fill-opacity",.33)};z.prototype.updateBox=function(){this.box_el.attr("width",Math.abs(this.pos[0]-this.pos0[0])).attr("height",Math.abs(this.pos[1]-this.pos0[1])).attr("transform","translate("+Math.min(this.pos0[0],this.pos[0])+","+Math.min(this.pos0[1],this.pos[1])+")")};z.prototype.getNodesInRect=function(e,r,n,i){var o=Math.min(e,n),a=Math.max(e,n);var s=Math.min(r,i),l=Math.max(r,i);var h=t.get_leaf_nodes(this.view.model).filter(function(t){return!t.hidden&&t.sel_box&&o<=t.x+t.sel_box.x+t.sel_box.width&&a>=t.x+t.sel_box.x&&s<=t.y+t.sel_box.y+t.sel_box.height&&l>=t.y+t.sel_box.y});return h};z.nodeIsNotFractionBar=function(t){return t.value!=="//"};z.prototype.highlight=function(){this.interaction_handler.highlight_nodes(gmath.array.mergedNew(this.initial_nodes,this.nodes))};z.prototype.end=function(){this.box_el.remove();return gmath.array.mergedNew(this.initial_nodes,this.nodes).filter(z.nodeIsNotFractionBar)};var j=function(t,e){this.view=t;this.nodes=null;this.splitted=false;this.new_state=null;this.prevDist=null;this.interaction_handler=e;this.actions=[SplitNumberAction,SplitProductAction,SplitPowerAction,SplitPowerSumAction,RemoveBracketsAction]};j.prototype.check=function(t){return t.dist-t.dist0>15};j.prototype.start=function(t,e){this.prevDist=null;this.nodes=e;return this.nodes||[]};j.prototype.end=function(){this.node=null;this.splitted=false};j.prototype.getBestAction=function(t,e,r){var n=r;this.actions.forEach(function(r){if(n&&r.priority<=n.priority)return;if(r.match(e))n=r.createBoundAction(t,{actor:e})});for(var i=e.children.length-1;i>=0;i--){var o=e.children[i];var a=this.getBestAction(t,o,n);if(a)n=a}return n};j.prototype.split=function(e,r){var n;for(var i=r.length-1;i>=0;i--){n=this.getBestAction(e,r[i],n)}if(!n)return false;e.performPreviewAction(n);e.hide_nodes();e.changed();var o=t.nodes_to_range(n.mapNodes(n.actor));return o};j.prototype.update=function(t){if(!this.nodes)return;if(this.prevDist!==null&&t.dist-this.prevDist<=30)return;var e=this.split(this.view.model,this.nodes);if(!e)return;this.prevDist=t.dist;this.nodes=e;this.interaction_handler.highlight_nodes(this.nodes)};var q=function(t,e){this.view=t;this.alm=this.view.model;this.interaction_handler=e;this.show_target_areas=false;this.dx=0;this.dy=0;this.nodes=[];this.bbox=null;this.actions=[];this.target_areas=null;this.active=false};q.prototype.check=function(t,e){var r=t.pos0[0]-t.pos[0],n=t.pos0[1]-t.pos[1];if(t.fingers.length===1&&e.length===0)return false;return r*r+n*n>=8*8};q.prototype.isActive=function(){return this.active};q.prototype.start=function(t,e,r){var n=gmath.extend({reselect_nodes:true,move_nodes:true},r);this.active=true;this.nodes=n.reselect_nodes?this.process_selection(e):e;this.do_not_move_nodes=!n.move_nodes;for(var i=0;i<this.nodes.length;i++){var o=this.nodes[i];
o.dragging=true;o.x0=o.x;o.y0=o.y}if(this.alm.hide_nodes()){this.view.renderer.set_style(this.nodes);this.view.update_style()}this.setupActions(n.actions);return this.nodes};q.prototype.update=function(e){var r=e.dx,n=e.dy;if(!this.do_not_move_nodes){t.for_each(function(t){t.x+=r;t.y+=n},this.nodes)}this.bbox.x+=r;this.bbox.y+=n;if(this.show_target_areas)T.draw(this.view.main,this.actions,this.bbox);var i=T.getBestHit(this.actions,this.bbox);if(i&&i.delay&&!i.timeoutID)this.applyTimeout(i);else if(i&&!i.delay&&!i.timeoutID)this.performAction(i);else if(!i)this.stopAllTimeouts();this.view.update_positions()};q.prototype.reorderInRanges=function(t){if(t.length<2)return t;var e=t[0].get_root();var r=0;e.for_each(function(t){t.order_num=r++});return t.sort(function(t,e){return t.order_num-e.order_num})};q.prototype.performAction=function(t){this.stopAllTimeouts();var e=this.alm.getNodes("=",0),r;if(e)r={x:e.x,y:e.y};this.alm.performPreviewAction(t);var n=t.new_selection?t.new_selection:t.mapNodes(this.nodes);this.reorderInRanges(n);var i=true,o;if(this.nodes.length!==n.length)i=false;else for(o=0;o<this.nodes.length;o++)i=i&&this.nodes[o]===n[o];if(!i){this.interaction_handler.highlight_nodes(n);for(o=0;o<this.nodes.length;o++)this.nodes[o].dragging=false;for(o=0;o<n.length;o++)n[o].dragging=true;this.alm.hide_nodes()}this.nodes=n;if(e)this.updateNodePositionsAroundEquals(r);this.view.update_style();this.setupActions()};q.prototype.setupActions=function(t){this.bbox=T.getBoundingBox(this.nodes,0);this.bbox.x-=5;this.bbox.width=10;this.bbox.y-=8;this.bbox.height=16;this.actions=t||this.alm.getMoveActions(this.nodes);T.setTargetRegions(this.actions);if(this.show_target_areas)T.draw(this.view.main,this.actions,this.bbox)};q.prototype.updateNodePositionsAroundEquals=function(e){var r=this.alm.getNodes("=",0);if(r){var n=e.x-r.x,i=e.y-r.y;var o=t.select_all(this.nodes);this.alm.children[0].for_each(function(t){if(o.indexOf(t)!==-1)return;t.x+=n;t.y+=i})}this.view.update_positions()};q.prototype.correctNodePositions=function(e){var r=null,n;for(i=0;i<this.nodes.length;i++){n=this.nodes[i];if(r=t.select_first(function(t){return t===n},e))break}if(r){var o={x:r.x,y:r.y};this.view.renderer.set_position(e,true);var a=r.x-o.x,s=r.y-o.y;t.for_each(function(t){t.x-=a;t.y-=s},e)}for(i=0;i<e.length;i++)e[i].dragging=true};q.prototype.end=function(){this.stopAllTimeouts();t.for_each(function(t){t.selected=false;t.dragging=false},this.alm.children);this.alm.hide_nodes();this.nodes=[];this.actions=[];this.bbox=null;this.view.update_all();if(this.show_target_areas)T.draw(this.view.main);this.active=false};q.prototype.applyTimeout=function(t){var e=this;t.timeoutID=setTimeout(function(){e.performAction(t)},t.delay)};q.prototype.stopAllTimeouts=function(){for(var t=0;t<this.actions.length;t++){var e=this.actions[t];if(e.timeoutID){clearTimeout(e.timeoutID);e.timeoutID=null}}};q.prototype.process_selection=function(t){var e=t.slice();if(e.length===0)return[];if(e[0].commutative){var r=e[0].parent;if(e.length<r.children.length)return e;else e=[r]}var n=e[0];while(!o.is_top_most(n)&&!n.parent.is_group("equals")&&!n.commutative&&!n.is_group("exponent"))n=n.parent;if(n.parent&&n.parent.is_group("equals")&&n.value=="=")n=n.parent;return[n]};var H=function(t,e){this.interaction_handler=e;this.dl=t.options.derivation_list;this.view=t;this.alm=t.model;this.line={A:{},B:{}};this.line_el=null;this.bbox=null;this.otherLines=[];this.otherLine_els=[];this.targets=[];this.processed_color="rgb(200,200,200)"};H.prototype.check=function(t,e){if(!this.view.options.substitution_on)return false;if(t.fingers.length===1&&e.length===1&&e[0].value==="="){return true}return false};H.prototype.start=function(t){this.collectSurroundingsInfo();this.highlightAllPotentialActions();this.initializeLine({x:t[0],y:t[1]});return[]};H.prototype.update=function(t){var e=[];this.targets.forEach(function(t){e=e.concat(t.potentialActions)});T.draw(this.view.main,e,this.bbox);this.updateLineObject(t);this.collectPassedOverNodes();this.highlightAllPotentialActions();this.updateLineElement(this.line_el,this.line)};H.prototype.end=function(){for(var t=0;t<this.targets.length;t++){var e=this.targets[t];if(e.results.length>0)this.performSubstitution(e)}this.eraseInfoAndCleanBoard()};H.prototype.collectSurroundingsInfo=function(){this.derivationLists=this.dl.getAllDLs().slice();this.ignoreSourceDerivationList();this.activeRows=this.derivationLists.map(function(t){return t.getLastRow()});this.algebraModels=this.derivationLists.map(function(t){return t.getLastModel()});this.targets=this.organizeDataIntoTargets()};H.prototype.ignoreSourceDerivationList=function(){this.derivationLists.splice(this.derivationLists.indexOf(this.dl),1)};H.prototype.organizeDataIntoTargets=function(){var t=[];for(var e=0;e<this.derivationLists.length;e++){var r=this.getAllAvailableActions(this.algebraModels[e],this.derivationLists[e]);var n={dl:this.derivationLists[e],row:this.activeRows[e],model:this.algebraModels[e],potentialActions:r,results:[]};t.push(n)}return t};H.prototype.getAllAvailableActions=function(t,e){var r=this.alm.SubstitutionAction.getAllAvailableActions(this.alm,t);var n=this.dl.getLastRow(),i=this.dl.pos[0]+n.pos[0],o=this.dl.pos[1]+n.pos[1];for(var a=0;a<r.length;a++){var s=e.getLastRow();if(this.dl.coordinator&&e.coordinator){var l=this.dl.coordinator.getOffset(this.dl,e);r[a].offset={x:e.pos[0]+s.pos[0]-i+l[0],y:e.pos[1]+s.pos[1]-o+l[1]}}else{r[a].offset={x:e.pos[0]+s.pos[0]-i,y:e.pos[1]+s.pos[1]-o}}}T.setTargetRegions(r);return r};H.prototype.highlightAllPotentialActions=function(){for(var t=0;t<this.targets.length;t++){var e=this.targets[t].potentialActions;var r=[];for(var n=0;n<e.length;n++)r=r.concat(e[n].target);this.targets[t].row.view.interaction_handler.highlight_nodes(r)}};H.prototype.initializeLine=function(t){this.line_el=this.makeLineElement();var e=this.calculateCenterOfEqualsSymbol();this.line.A.x=e.x;this.line.A.y=e.y;this.line.B.x=t.x;this.line.B.y=t.y;this.bbox={x:this.line.B.x-2,y:this.line.B.y-2,width:4,height:4}};H.prototype.makeLineElement=function(t){var e=this.view.main.append("line").classed("substitution",true).style("stroke",t?this.processed_color:this.view.options.selection_color).style("stroke-width",6).style("stroke-linecap","round");return e};H.prototype.calculateCenterOfEqualsSymbol=function(){var t=this.dl,e=t.getLastModel(),r=e.get_child([0,1]);var n=r.x+r.sel_box.x+r.sel_box.width/2,i=r.y+r.sel_box.y+r.sel_box.height/2;return{x:n,y:i}};H.prototype.updateLineObject=function(t){this.line.B.x+=t.dx;this.line.B.y+=t.dy;this.bbox={x:this.line.B.x-2,y:this.line.B.y-2,width:4,height:4}};H.prototype.updateLineElement=function(t,e){t.attr("x1",e.A.x).attr("y1",e.A.y).attr("x2",e.B.x).attr("y2",e.B.y)};H.prototype.collectPassedOverNodes=function(){for(var t=0;t<this.targets.length;t++){this.findMatchingEndpointNodes(this.targets[t])}};H.prototype.findMatchingEndpointNodes=function(t){var e=T.getBestHit(t.potentialActions,this.bbox);if(!e)return;this.removeNodesFromPotentialActionsList(e,t);t.results.push(e);this.drawLine(e,t)};H.prototype.removeNodesFromPotentialActionsList=function(t,e){e.potentialActions.splice(e.potentialActions.indexOf(t),1)};H.prototype.drawLine=function(t,e){var r={x:t.x+t.width/2,y:t.y+t.height/2};var n={A:{x:this.line.A.x,y:this.line.A.y},B:r};var i=this.makeLineElement(e);this.updateLineElement(i,n);this.otherLines.push(n);this.otherLine_els.push(i)};H.prototype.performSubstitution=function(t){var e=t.results;for(var r=0;r<e.length;r++){t.model.performPreviewAction(e[r])}t.model.finishInteraction()};H.prototype.eraseInfoAndCleanBoard=function(){this.removeAllLineElements();this.unhighlightAllNodes();this.otherLines=[];this.otherLine_els=[];this.targets=[]};H.prototype.removeAllLineElements=function(){this.line_el.remove();for(var t=0;t<this.otherLine_els.length;t++){this.otherLine_els[t].remove()}T.draw(this.view.main)};H.prototype.unhighlightAllNodes=function(){for(var t=0;t<this.targets.length;t++){this.targets[t].row.view.interaction_handler.highlight_nodes([])}};DLCoordinator=function(){this.dls=[]};DLCoordinator.prototype.addDL=function(t){this.dls.push(t);if(t.coordinator)coordinator.removeDL(t);t.coordinator=this};DLCoordinator.prototype.removeDL=function(t){var e=this.dls.indexOf(t);if(e===-1)throw"I don't know about this DL, so I can't remove it.";this.dls.splice(e,1)};DLCoordinator.prototype.subscribeToCanvasModel=function(t){var e=this;var r=t.dls();var n=null;for(var i=0;i<r.length;i++){e.addDL(r[i])}t.on("create",function(t){if(t.target_type==="dl")e.addDL(t.target)});t.on("remove",function(t){if(t.target_type==="dl")e.removeDL(t.target)})};DLCoordinator.prototype.getPositionOnPage=function(t){var e,r;if(t.options.standalone==true){e=t.container().getBoundingClientRect().left;r=t.container().getBoundingClientRect().top}else{e=t.svg.node().viewportElement.getBoundingClientRect().left;r=t.svg.node().viewportElement.getBoundingClientRect().top}return[e,r]};DLCoordinator.prototype.getOffset=function(t,e){var r=this;var n=r.getPositionOnPage(t);var i=r.getPositionOnPage(e);return[i[0]-n[0],i[1]-n[1]]};var G=function(t,e,r){this.id=gmath.uid();this.model=t;this.events=d3.dispatch("updated");this.model.events.on("change."+this.id,this.update_all.bind(this));this.svg=e;this.initializeOptions(r);av=this};gmath.AlgebraView=G;G.prototype.emitUpdatedEvent=function(){this.events.updated({type:"updated",source:this,sender_id:this.id})};G.defaultOptions={font_size:80,color:"#333",selection_color:"lightblue",inactive_color:"gray",fraction_size_factor:.7,exp_size_factor:.7,subscript_size_factor:.5,debug_lines:false,debug_draw:false,dur:250,easing_fn:"circle-out",pos:[0,0],interaction_mode:"transform",v_align:"alphabetic",h_align:"center",background_color:"none",shadow_filter:null,border_color:"none",shadow_color:"none",border_radius:0,padding:{left:0,right:0,top:0,bottom:0},interactive:true,event_receiver:null,normal_font:{family:"Crimson Text"},italic_font:{family:"Crimson Text Italics"},font_baseline_shift:.24,font_ascent:.73,font_descent:.18,slanted_div_bar:false,div_bar_height:.056,wiggle_dur:300,wiggle_deg:12,wiggle_random_delay:100};G.prototype.initializeOptions=function(t){t=t||{};var e=gmath.extend({},G.defaultOptions);e.pos=e.pos.slice();e.padding=gmath.extend({},e.padding);e.normal_font=gmath.extend({},e.normal_font);e.italic_font=gmath.extend({},e.italic_font);this.options=gmath.extend(e,t);if(t.padding){var r=t.padding;if(typeof r==="number"){this.options.padding={left:r,right:r,top:r,bottom:r}}else gmath.extend(this.options.padding,r)}};G.prototype.init=function(t){this.main=this.svg.append("g").attr("id",this.options.id).attr("class","main").attr("transform","translate("+this.options.pos+")");this.shadow_rect=this.main.append("rect").attr({rx:this.options.border_radius,ry:this.options.border_radius}).style("fill","none").attr("filter",this.options.shadow_filter).style("stroke",this.options.shadow_color).style("visibility",this.options.shadow_filter?"visible":"hidden");this.border_rect=this.main.append("rect").attr({rx:this.options.border_radius,ry:this.options.border_radius}).style("fill",this.options.background_color).style("stroke",this.options.border_color);if(this.options.event_receiver){this.event_receiver=d3.select(this.options.event_receiver)}else{this.event_receiver=this.main}this.event_receiver.style("pointer-events","visible");if(this.options.debug_lines){this.main.append("line").attr("x1",-1e3).attr("x2",1e3).attr("stroke-width","0.5").attr("stroke","lightblue");this.main.append("line").attr("y1",-1e3).attr("y2",1e3).attr("stroke-width","0.5").attr("stroke","lightblue")}this.renderer=new he(this,this.options.h_align,this.options.v_align);this.interaction_handler=new E(this,this.options.interactive);this.main.classed("interactive",this.options.interactive);this.interaction_handler.set_mode(this.options.interaction_mode);var e=[this.options.normal_font,this.options.italic_font];if(!G.fontloader){G.fontloader=L(e,2e3);this.fontloader=G.fontloader}else{this.fontloader=G.fontloader;this.fontloader.add_fonts(e)}var r=this;this.fontloader.on_fonts_loaded(function(){r.update_all();if(t)t()})};G.prototype.interactive=function(t){if(arguments.length===0)return this.options.interactive;this.options.interactive=t;this.interaction_handler.set_interactive(t);this.main.classed("interactive",this.options.interactive);return this};G.prototype.wiggle=function(t,e){if(!Array.isArray(t))t=[t];var r=[];for(var n=0;n<t.length;n++){var i=t[n].split(":");var o=i.length===1?this.model.getRanges(i[0]):this.model.getRanges(i[0],Number(i[1])-1);if(o)r=r.concat(o)}var a=gmath.array.flatten(r);if(a.length===0)return;this.wiggleNodes(a,e);this.interaction_handler.events.on("touch."+this.id,this.wiggleNodes.bind(this,null,false))};G.prototype.wiggleNodes=function(t,e){if(arguments.length<2)e=true;if(!t)t=this.model.children;if(!Array.isArray(t))t=[t];var r=[];t.forEach(function(t){if(t.has_children())r=r.concat(t.get_leaf_nodes());else r.push(t)});var n=this.node_sel.filter(function(t){return r.indexOf(t)!==-1}).select("g.offset");var i=this.options;var o=function(t,e,r){var n=d3.interpolate(t,e);return function(t){var e=G.getCenter(t);return function(t){return"rotate("+n(t)+" "+e+")"}}};function a(t){d3.select(this).transition().duration(i.wiggle_dur).attrTween("transform",o(i.wiggle_deg,-i.wiggle_deg)).transition().duration(i.wiggle_dur).attrTween("transform",o(-i.wiggle_deg,i.wiggle_deg)).each("end",a)}if(e){n.transition().delay(function(){return Math.random()*i.wiggle_random_delay}).duration(i.wiggle_dur/2).attrTween("transform",o(0,i.wiggle_deg)).each("end",a)}else{n.interrupt().transition().attr("transform",null)}};G.getCenter=function(t){var e=t.sel_box;return[e.x+e.width/2,-t.size*.24]};G.prototype.update_all=function(t){this.enter_as_is();this.renderer.set_style(this.model.children);this.renderer.set_position(this.model.children,true);this.enter_and_exit();this.update_existing();this.emitUpdatedEvent()};G.prototype.reposition=function(t){var e=this;e.renderer.set_position(e.model.children,true);e.update_existing()};G.prototype._enter=function(t){var e=this;var r=t.enter().append("g").classed("math",true).attr("transform",function(t){return"translate("+t.x+","+t.y+")"});r.append("g").classed("offset",true);r.select("g.offset").append("rect").attr("visibility",this.options.debug_draw?"visible":"hidden").style("stroke","black").style("fill","none").classed("selector",true);r.filter(function(t){return t.value==="//"}).select("g.offset").append("line").style("stroke-linecap","round").attr("opacity",function(t){return t.no_anim&&!t.hidden?1:1e-5}).call(W,this.options.slanted_div_bar);r.select("g.offset").append("text").attr("stroke","none").attr("font-family",function(t){return e.get_font(t).family}).attr("font-weight",function(t){return e.get_font(t).weight}).attr("font-style",function(t){return e.get_font(t).style}).attr("font-size",function(t){return t.size+"px"}).attr("fill",function(t){return t.color}).attr("opacity",function(t){return t.no_anim&&!t.hidden?1:1e-5}).attr("pointer-events","none").text(function(t){return t.to_string()});if(this.options.debug_draw)this.debugDraw(r);t.each(function(t){return t.no_anim=false})};G.prototype.enter_as_is=function(){var e=this;var r=e.main.selectAll("g.math").data(t.get_leaf_nodes(this.model.children).filter(function(t){return t.enter_as_is}),function(t){return t.id}).each(function(t){t.enter_as_is=false});this._enter(r);this.node_sel=r};G.prototype.enter_and_exit=function(){var e=this;var r=e.main.selectAll("g.math").data(t.get_leaf_nodes(this.model.children),function(t){return t.id});this._enter(r);var n=r.exit().each(function(t){t.deleted=true}).transition().ease("linear").duration(function(t){return t.no_anim?0:e.options.dur}).attr("transform",function(t){return"translate("+(t.x||0)+","+(t.y||0)+")"}).remove();n.select("*").attr("opacity",1e-5);this.node_sel=r};G.prototype.update_existing=function(){var t=this;var e=this.svg.selectAll("g.math").filter(function(t){return!t.deleted});e.transition().duration(this.options.dur).ease(this.options.easing_fn).attr("transform",function(t){return"translate("+(t.x||0)+","+(t.y||0)+")"});e.select("text").transition().duration(0).text(function(t){return t.to_string()}).transition().duration(this.options.dur).ease("linear").attr("font-size",function(t){return t.size+"px"}).attr("fill",function(t){return t.color}).attr("opacity",function(t){return t.hidden?1e-5:1});e.select("line").transition().duration(this.options.dur).ease("linear").call(W,this.options.slanted_div_bar).attr("opacity",function(t){return t.hidden?1e-5:1});e.select("rect").attr("x",function(t){return t.sel_box?t.sel_box.x:0}).attr("y",function(t){return t.sel_box?t.sel_box.y:0}).attr("width",function(t){return t.hidden||!t.sel_box?0:t.sel_box.width}).attr("height",function(t){return t.hidden||!t.sel_box?0:t.sel_box.height});this.update_background();return true};G.prototype.update_background=function(){var t=this.model.children[0];var e=this.getBBox();if(t&&!t.dragging){this.border_rect.attr({rx:this.options.border_radius,ry:this.options.border_radius}).style("fill",this.options.background_color).style("stroke",this.options.border_color).transition().duration(this.options.dur).ease(this.options.easing_fn).attr(e);this.shadow_rect.transition().duration(this.options.dur).ease(this.options.easing_fn).attr(e)}};G.prototype.getBBox=function(t){t=t||{};var e=this.model.children[0];if(!e||!e.sel_box)return{x:0,y:0,width:0,height:0};var r={};var n=this.options.padding;r.x=e.sel_box.x+(e.dragging?e.x0:e.x)-(t.no_padding?0:n.left);r.y=e.sel_box.y+(e.dragging?e.y0:e.y)-(t.no_padding?0:n.top);r.width=e.sel_box.width+(t.no_padding?0:n.left+n.right);r.height=e.sel_box.height+(t.no_padding?0:n.top+n.bottom);return r};G.prototype.update_positions=function(){this.node_sel.transition().duration(this.options.dur).ease(this.options.easing_fn).attr("transform",function(t){return"translate("+(t.x||0)+","+(t.y||0)+")"})};G.prototype.update_style=function(){this.node_sel.select("text").transition().duration(this.options.dur).ease("linear").attr("font-size",function(t){return t.size+"px"}).attr("fill",function(t){return t.color}).attr("opacity",function(t){if(t.hidden)return 1e-5;if(t.hide_after_drop)return.4;return 1});this.node_sel.select("line").transition().duration(this.options.dur).ease("linear").call(W,this.options.slanted_div_bar).attr("opacity",function(t){if(t.hidden)return 1e-5;if(t.hide_after_drop)return.4;return 1})};function W(t,e){t.attr("x1",0).attr("x2",function(t){return t.width}).style("stroke-width",function(t){return t.height}).style("stroke",function(t){return t.color});if(e){t.attr("y1",function(t){return.2*t.height}).attr("y2",function(t){return-.2*t.height})}}G.prototype.force_refresh=function(){var t=this.svg.node();t.style.display="none";t.style.display="block"};G.prototype.get_utf8=function(t){var e={"-":"−","*":"·","/":""};if(t.value in e)return e[t.value];if(typeof t.value=="number"&&t.value<0)return e["-"]+Math.abs(t.value);return t.value};G.prototype.get_font=function(t){return t instanceof h?this.options.italic_font:this.options.normal_font};G.prototype.get_width=function(t){return this.fontloader.width(t.to_string(),t.size,get_font(t))};G.prototype.debugDraw=function(t){var e=this;t.select("g.offset").append("rect").style("stroke","orange").style("fill","none").attr({x:0,width:function(t){return t.sel_box.width},y:function(t){return t.size*e.options.font_descent-.5},height:1});t.select("g.offset").append("rect").style("stroke","green").style("fill","none").attr({x:0,width:function(t){return t.sel_box.width},y:function(t){return-t.size*e.options.font_ascent-.5},height:1});t.select("g.offset").append("rect").style("stroke","blue").style("fill","none").attr({x:0,width:function(t){return t.sel_box.width},y:function(t){return-t.size*e.options.font_baseline_shift-.5},height:1})};DerivationList=function(t,e,r){this.id=gmath.uid();this.events=d3.dispatch("added_line","change","end-of-interaction","inspect_node");this.dims={};this.initializeOptions(e);this.canvas_model=e.canvas_model;this.container(t);this.adjustPosition(e.pos);this.rows=[];this.collapsed_mode=false;this.handle_stroke_color="#eee";this.curr_drag_handler=null;this.curr_target_model=null;this.hovering=false;var n=this;this.addLineFromExpressions(this.options.eq.split("\\\\"),function(){n.startWiggle(n.options.wiggle);if(r)r(n)});this.setupListeners()};gmath.DerivationList=DerivationList;DerivationList.defaultOptions={eq:"",pos:[300,200],debug_lines:false,visualize_derivations:"none",visualize_derivations_method:"all",embedded:true,border_radius:4,v_align:"center",h_align:"equals",padding:{left:40,right:5,top:5,bottom:5},font_size:50,draggable:true,no_history:false,hide_handles:false,break_off_dist:50,wiggle:[],auto_resize_container:false,substitution_on:true,hoverable:false,auto_collapse_repeated_actions:true,interaction_mode:"transform"};DerivationList.prototype.initializeOptions=function(t){t=t||{};var e=gmath.extend({},DerivationList.defaultOptions);e.pos=e.pos.slice();e.padding=gmath.extend({},e.padding);this.options=gmath.extend(e,t);if(!("hide_handles"in t)&&t.no_history){this.options.hide_handles=!t.draggable}};DerivationList.prototype.container=function(t){if(arguments.length===0)return this.svg.node();this.svg=d3.select(t);this.svgDims=this.getContainerDimensions();if(this.svgg)this.svg.node().appendChild(this.svgg.node());else{this.svgg=this.svg.append("g").classed("derivation-list",true).attr("id",this.id)}return this};DerivationList.createStandalone=function(t,e){if(t instanceof String)t=d3.select(t).node();var r=d3.select(t);if(r.empty())return;var n=r.text();if(r.selectAll("*").empty())r.text("");var i=r.append("svg").style("width","100%").style("height","100%").style("overflow","visible");var o=gmath.extend({pos:["auto","auto"],v_align:"center",h_align:"center",no_history:true,no_handles:true,standalone:true,draggable:false},e);o.eq=o.eq||n;return new DerivationList(i.node(),o)};DerivationList.prototype.adjustPosition=function(t){if(this.options.pos[0]==="auto"){if(this.options.h_align==="center"||this.options.h_align==="equals")this.options.pos[0]=this.svg.node().clientWidth/2;else if(this.options.v_align==="left")this.options.pos[0]=this.options.padding.left;else if(this.options.v_align==="right")this.options.pos[0]=this.svg.node().clientWidth-this.options.padding.right}if(this.options.pos[1]==="auto"){if(this.options.v_align==="center")this.options.pos[1]=this.svg.node().clientHeight/2;else if(this.options.v_align==="top")this.options.pos[1]=this.options.padding.top;else if(this.options.v_align==="bottom")this.options.pos[1]=this.options.padding.bottom;else if(this.options.v_align==="alphabetic")this.options.pos[1]=0}};DerivationList.prototype.remove=function(){this.svgg.remove()};DerivationList.prototype.addLineFromExpressions=function(t,e){for(var r=0;r<t.length;r++)this.addLineFromExpression(t[r],r===t.length-1?e:null)};DerivationList.prototype.addLineFromExpression=function(t,e){var r=new o(t,this.options);if(this.rows.length>0)this.deactivateRow(this.rows[this.rows.length-1]);this.rows.push(this.createRow(r,null,this.options,e));this.events.added_line()};DerivationList.prototype.setupListeners=function(){if(this.options.no_history){this.getLastModel().events.on("change."+this.id,this.onChange.bind(this))}else{this.timeTree=new r(this.getLastModel());this.timeTree.init();this.timeTree.events.on("change."+this.id,this.onChange.bind(this))}};DerivationList.prototype.startWiggle=function(t){var e=this.getLastView();e.wiggle(t,true)};DerivationList.prototype.setExpression=function(t,e){this.getLastModel().parseAndSet(t,e)};DerivationList.prototype.setInteractionMode=function(t){this.rows.forEach(function(e){e.view.interaction_handler.set_mode(t)})};DerivationList.prototype.singleLineMode=function(t){if(arguments.length===0)return this.collapsed_mode;if(t&&!this.collapsed_mode){for(var e=0;e<this.rows.length-1;e++){if(!this.rows[e].hidden)this.hideRow(this.rows[e])}this.layoutRows()}this.collapsed_mode=t;return this};DerivationList.prototype.getLastRow=function(){return this.rows[this.rows.length-1]};DerivationList.prototype.getRowByModel=function(t){for(var e=0;e<this.rows.length;e++){if(this.rows[e].model===t)return this.rows[e]}return null};DerivationList.prototype.getLastModel=function(){return this.getLastRow().model};DerivationList.prototype.getLastView=function(){return this.getLastRow().view};DerivationList.prototype.onChange=function(t){this.events.change(t);if(this.options.no_history||!t.action||t.preview||t.action.oldTree===t.action.newTree)return;this.addRowFromAction(t.action)};DerivationList.prototype.updateHandlePos=function(t){if(this.options.no_handles)return;var e=this.getHandlePos(t.view);if(t.handle)t.handle.transition().attr("transform","translate("+e+")")};DerivationList.prototype.getRowByView=function(t){return this.rows.filter(function(e){return e.view===t})[0]};DerivationList.prototype.updateRowDimensionAfterInteraction=function(t){if(!t)return;var e=this.updateRowDimensions();if(e){for(var r=0;r<this.rows.length;r++){this.updateRowBackground(this.rows[r]);this.updateHandlePos(this.rows[r])}this.moveIntoContainer()}else{this.updateRowBackground(t);this.updateHandlePos(t)}};DerivationList.prototype.addRowFromAction=function(t){var e=t.newTree;var r=t.oldTree;if(!e||!r)throw"each action must define newTree and oldTree";var n=this;var i=this.rows.length;var o=this.rows[i-1];var a=o.view;if(o.model===r){var s=gmath.extend(gmath.extend({},a.options),{pos:o.pos.slice()});var l=this.createRow(e,t,s,function(){n.old_draw_mapping_lines(t,o,l)});this.rows.push(l);l.idx=i;this.deactivateRow(o);this.collapsePreviousRow(o,l);this.updateRowDimensionAfterInteraction(l)}else if(o.model===e){var s=gmath.extend(gmath.extend({},a.options),{interactive:false,pos:o.pos.slice()});var l=this.createRow(r,o.action,s,function(){n.old_draw_mapping_lines(t,l,o)});this.rows.splice(i-1,0,l);l.idx=i-1;o.action=t;this.deactivateRow(l);this.updateHandlePos(o);this.collapsePreviousRow(l,o);this.updateRowDimensionAfterInteraction(l)}else throw"oldTree is not part of this derivation list, but should be";this.events.added_line()};DerivationList.prototype.collapsePreviousRow=function(t,e){if(this.collapsed_mode||this.options.auto_collapse_repeated_actions&&t.action&&e.action&&t.action.name===e.action.name)this.hideRow(t)};DerivationList.prototype.moveIntoContainer=function(){if(this.hovering)return;var t=this;setTimeout(function(){var e=t.keepInContainer([t.pos[0],t.pos[1]],t.rows[0].view.getBBox());if(e[0]===t.pos[0]&&e[1]===t.pos[1])return;t.pos=e;t.svgg.transition().attr("transform","translate("+e+")")},1)};DerivationList.prototype.createRow=function(t,e,r,n){t.for_each(function(t){t.dragging=false;t.selected=false});var i=r.pos;if(this.rows.length===0){this.pos=i.slice();this.svgg.attr("transform","translate("+i+")");i=[0,0]}r.pos=[0,0];var o=this.svgg.append("g").classed("dl-line",true).attr("transform","translate("+i+")");if(this.options.standalone)r.event_receiver=this.svg.node();r.derivation_list=this;var a=new G(t,o,r);var s=this;var l={model:t,view:a,el:o,action:e,dims:null,pos:i};t.events.on("end-of-interaction."+this.id,function(){s.events["end-of-interaction"](arguments);s.updateRowDimensionAfterInteraction(l)});o.datum(l);if(r.row_hidden)l.hidden=true;a.init(function(){a.interaction_handler.events.on("inspect_node."+s.id,function(t){s.events.inspect_node({node:t.node,dl:s})});setTimeout(function(){s.createRowHandle(l);s.updateRowDimensionAfterInteraction(l);s.layoutRows();if(n)n(s)},1)});this.model=t;return l};DerivationList.prototype.getFinalVerticalPos=function(t,e,r){r=r||0;var n=this.rows[r].pos[1];for(var i=r+1;i<=t.idx;i++){if(this.rows[i-1].hidden&&!e)continue;n+=this.getVerticalAdvance(this.rows[i])}return n};DerivationList.prototype.isAboveFinalVerticalPos=function(t){return t.pos[1]<this.getFinalVerticalPos(t)};DerivationList.prototype.getUpmostPullableRow=function(t){var e;for(e=t.idx;e>=0;e--){if(this.rows[e].hidden)break;if(!this.isAboveFinalVerticalPos(this.rows[e]))break}if(e===t.idx)return null;return this.rows[e+1]};DerivationList.prototype.getHiddenAbove=function(t){var e=t.idx-1;while(e>=0&&!this.rows[e].hidden)e--;return e===-1?null:this.rows[e]};DerivationList.prototype.getVisibleAbove=function(t){var e=t.idx-1;while(e>=0&&this.rows[e].hidden)e--;return e===-1?null:this.rows[e]};DerivationList.prototype.getDistanceFromHome=function(t){var e=t.pos[0]-t.drag_pos[0],r=t.pos[1]-t.drag_pos[1];return Math.sqrt(e*e+r*r)};DerivationList.prototype.dragRow=function(t){var e=d3.event.dx,r=d3.event.dy;if(this.rows.length===1&&t.idx===this.rows.length-1&&this.canvas_model){this.handleFactoringGesture(t,e,r);return}if(t.idx===0){if(this.options.draggable){this.pos[0]+=e;this.pos[1]+=r;if(!this.hovering)this.pos=this.keepInContainer(this.pos,this.rows[0].view.getBBox());this.resizeContainer();this.svgg.attr("transform","translate("+this.pos+")")}return}if(r===0)return;var n=this.rows[this.rows.length-1];var i;if(r>0){if(!this.isAboveFinalVerticalPos(t)){i=this.getHiddenAbove(t);if(!i)return;this.unhideRow(i);i=this.rows[i.idx+1]}else{i=this.getUpmostPullableRow(t)}}else{i=this.getVisibleAbove(t);if(!i)return;if(t.pos[1]<=i.pos[1]){this.hideRow(i)}else i=this.rows[i.idx+1]}for(var o=i.idx;o<=n.idx;o++){var a=this.rows[o];a.pos[1]=Math.min(this.getFinalVerticalPos(a),a.pos[1]+r);a.pos[1]=Math.max(o>t.idx?this.getFinalVerticalPos(a,false,t.idx):0,a.pos[1]);a.el.attr("transform","translate("+a.pos+")")}this.resizeContainer()};DerivationList.prototype.releaseRow=function(t){if(this.curr_drag_handler){this.curr_drag_handler.end();this.curr_drag_handler=null}if(this.curr_target_model){this.curr_target_model.finishInteraction();this.current_target_model=null;this.canvas_model.removeDL(this)}else{for(var e=0;e<this.rows.length;e++)this.hideBackground(this.rows[e]);if(!this.options.no_handles)t.handle.selectAll("circle").attr({fill:"white"});this.draginfo=null;if(t.idx>0){var r=this.getFinalVerticalPos(t)-t.pos[1];var n=this.getVisibleAbove(t);if(n&&r>0&&r>.5*n.dims.height)this.hideRow(n);this.layoutRows()}}};DerivationList.prototype.createRowHandle=function(t){if(this.options.no_handles)return;t.mtouch=mtouch_events().frame(t.view.main.node());var e=this;t.mtouch.on("drag",this.dragRow.bind(this));t.mtouch.on("touch",function(t){for(var r=0;r<e.rows.length;r++)e.showBackground(e.rows[r],r===t.idx);t.handle.selectAll("circle").attr({fill:"whitesmoke"})});t.mtouch.on("hold",this.toggleHover.bind(this));t.mtouch.on("tap",function(t){if(!gmath.actions.editLineAction.match(t.model))return;var r=gmath.actions.editLineAction.createBoundAction(t.model,{actor:t.model});r.always_do_in_place=true;t.model.performAction(r,function(){e.updateRowDimensionAfterInteraction(t)})});t.mtouch.on("release",this.releaseRow.bind(this));var r=this.getHandlePos(t.view);var n=t.el.append("g").classed("handle",true).attr("transform","translate("+r+")").style({cursor:"pointer"}).call(t.mtouch);n.selectAll("circle").data([t,t]).enter().append("circle").attr({fill:"white",stroke:this.handle_stroke_color,"stroke-width":2,r:10}).attr({"pointer-events":"all"}).attr("cx",function(t,e){return 4*e});if(t===this.rows[0]&&this.options.draggable){n.append("path").attr("stroke",this.handle_stroke_color).attr("stroke-width",1).attr("fill","none").attr("transform","scale(2),translate(-4, -4)").attr("d","M 3 2 L 4 1 L 5 2 M 2 3 L 1 4 L 2 5 M 6 3 L 7 4 L 6 5 M 5 6 L 4 7 L 3 6 M 4 7 L 4 1 M 1 4 L 7 4");if(this.rows.length>1){this.rows[1].handle.select("path").remove()}}t.handle=n;this.updateHandleType(t)};DerivationList.prototype.toggleHover=function(t){if(this.hovering){this.hovering=false;this.remove();var e=this.svgg.node();var r=this.original_container;delete this.original_container;var n=r.node().appendChild(e);this.moveIntoContainer();
this.unhoverRemove.remove();this.svg=r;var i=-1*d3.select("#wikiMainSvg").node().getBoundingClientRect().top;var o=-1*d3.select("#wikiMainSvg").node().getBoundingClientRect().left;this.pos[1]+=i;this.pos[0]+=o;var a=[this.pos[0],this.pos[1]];this.svgg.attr("transform","translate("+a+")")}else{if(this.options.hoverable==false)return;this.hovering=true;this.remove();var e=this.svgg.node();var s=d3.select("#hovering");var l=s.select("g");var h=l.append("g");this.unhoverRemove=h;this.original_container=this.svg;this.svg=l;var n=h.node().appendChild(e);var i=d3.select("#wikiMainSvg").node().getBoundingClientRect().top;var o=d3.select("#wikiMainSvg").node().getBoundingClientRect().left;this.pos[1]+=i;this.pos[0]+=o;var a=[this.pos[0],this.pos[1]];this.svgg.attr("transform","translate("+a+")")}this.layoutRows()};DerivationList.prototype.updateRowBackground=function(t){var e=40+t.dims.x-this.dims.x,r=5+this.dims.x+this.dims.width-t.dims.x-t.dims.width;t.view.options.padding={left:e,right:r,top:5,bottom:5}};DerivationList.prototype.showBackground=function(t,e){this.updateRowBackground(t);t.view.options.border_color=e?"silver":"none";t.view.options.background_color="white";t.view.update_background()};DerivationList.prototype.hideBackground=function(t){t.view.options.border_color="none";t.view.options.background_color=this.hovering?"#eee":"none";t.view.update_background()};DerivationList.prototype.getHandlePos=function(t){var e=t.getBBox({no_padding:true});return[e.x-20,e.y+e.height/2]};DerivationList.prototype.updateHandleType=function(t){if(this.options.no_handles)return;var e=this.options.hide_handles;if(!t.handle)return;if(t.idx>0&&this.rows[t.idx-1].hidden){t.handle.selectAll("*").attr("visibility",e?"hidden":"visible")}else{t.handle.selectAll("*").attr("visibility",function(t,r){return r===1||e?"hidden":"visible"})}};DerivationList.prototype.hideRow=function(t){t.hidden=true;t.el.attr("display","none");if(this.rows.filter(function(t){return!t.hidden}).length===1)this.singleLineMode(true);this.updateHandleType(this.rows[t.idx+1])};DerivationList.prototype.unhideRow=function(t){if(t.hidden)this.singleLineMode(false);t.hidden=false;t.el.attr("display",null);this.updateHandleType(this.rows[t.idx+1])};DerivationList.prototype.deactivateRow=function(t){t.view.interactive(false);t.model.for_each(function(t){t.dragging=false;t.selected=false})};DerivationList.prototype.updateRowDimensions=function(){var t=Infinity,e=Infinity,r=-Infinity,n=-Infinity;this.rows.forEach(function(i){i.dims=i.view.getBBox({no_padding:true});i.dims.y-=i.view.options.padding.top;i.dims.height+=i.view.options.padding.top+i.view.options.padding.bottom;t=Math.min(t,i.dims.x+i.pos[0]);e=Math.min(e,i.dims.y+i.pos[1]);r=Math.max(r,i.dims.x+i.dims.width+i.pos[0]);n=Math.max(n,i.dims.y+i.dims.height+i.pos[1])});var i=this.dims.x!==t||this.dims.y!==e||this.dims.width!==r-t||this.dims.height!==n-e;this.dims={x:t,y:e,width:r-t,height:n-e};return i};DerivationList.prototype.getVerticalAdvance=function(t){if(t.idx===0)return 0;var e=this.options.v_align;if(e==="center"){return this.rows[t.idx-1].dims.height/2+t.dims.height/2}else if(e==="top"){return this.rows[t.idx-1].dims.height}else if(e==="bottom"||e==="alphabetic"){return t.dims.height}};DerivationList.prototype.resizeContainer=function(){if(!this.options.auto_resize_container)return;this.updateRowDimensions();this.svg.style("height",this.dims.height+this.dims.y+this.pos[1]+"px")};DerivationList.prototype.layoutRows=function(){this.updateRowDimensions();var t=this.rows[0].pos,e=t[0],r=t[1];this.rows[0].idx=0;if(!this.options.no_handles&&!this.rows[0].handle)this.createRowHandle(this.rows[0]);for(var n=1;n<this.rows.length;n++){var i=this.rows[n];i.idx=n;if(!this.options.no_handles&&!i.handle)this.createRowHandle(i);this.updateHandleType(i);if(!this.rows[n-1].hidden)r+=this.getVerticalAdvance(i);if(i.dragging)continue;var o=i.pos;if(o[0]!==e||o[1]!==r){o[0]=e;o[1]=r;o=o;i.el.transition().attr("transform","translate("+o+")")}}this.svgg.selectAll(".dl-line").sort(function(t,e){return t.idx-e.idx});this.resizeContainer()};DerivationList.prototype.getContainerDimensions=function(){var t=this.svg.node();while(t.tagName.toLowerCase()!=="svg"&&t.parentNode)t=t.parentNode;return t.getBoundingClientRect()};DerivationList.prototype.keepInContainer=function(t,e){var r=function(t,e,r){if(t>e)return t;return r<t?t:r>e?e:r};var n=r(-e.x,this.svgDims.width-(e.width+e.x),t[0]),i=r(-e.y,this.svgDims.height-(e.height+e.y),t[1]);return[n,i]};DerivationList.prototype.undo=function(){var t=this.rows[this.rows.length-2];if(t&&t.hidden){this.unhideRow(t)}var e=this;if(this.rows.length===0)return;var r=this.rows.pop();r.el.remove();if(this.getLastRow()){var n=this.getLastRow();n.view.interactive(true);this.getLastModel().events.on("end-of-interaction."+this.id,function(){e.updateRowDimensionAfterInteraction(n)});this.getLastView().interaction_handler.highlight_nodes([]);n.model.events.on("change."+this.timeTree.id,this.timeTree.catch_changed_event.bind(this.timeTree));n.model.events.on("end-of-interaction."+this.timeTree.id,this.timeTree.finishPreviewActionSequence.bind(this.timeTree));if(n.model.timeState.children.length>0)n.model.timeState.children[0].remove();return r}};DerivationList.prototype.redo=function(t,e){t.newTree=e.model;t.oldTree=this.getLastRow().model;this.addRowFromAction(t);return false};DerivationList.prototype.getAllDLs=function(){var t=this;if(this.coordinator){return t.coordinator.dls}if(this.model.options.standalone){return t}return t.canvas_model.dls()};var K="#E6F3DE";var U="#F3DEDE";var Q="#DEE5F3";var Z=6,X=16,Y=8,J=6;DerivationList.prototype.draw_mappings_for_nodes=function(t){this.hideAllNodeMappings();if(t.length===0)return;var e=!t.some(function(t){return t.is_group("sym")});this.draw_forward_mappings(t,e);this.draw_backward_mappings(t,e);var r=this.getRowByModel(t[0].get_root());this.draw_node_backgrounds(t,r)};DerivationList.prototype.draw_forward_mappings=function(t,e){if(t.length===0)return;var r=this.getRowByModel(t[0].get_root());if(r.idx>=this.rows.length-1)return;var n=this.rows[r.idx+1],i=n.action;var o=[];t.forEach(function(t){var r=i.mapNodes([t]);if(r.length===0)o.push({source_node:t});else r.forEach(function(r){if(e&&r.is_group("sym"))return;if(r.has_children())return;o.push({source_node:t,target_node:r})});t.was_removed=r.length===0});this.draw_mapping_lines(o,r,n);var a=i.mapNodes(t);if(e)a=a.filter(function(t){return!t.is_group("sym")});this.draw_forward_mappings(a,e);this.draw_node_backgrounds(a,n)};DerivationList.prototype.draw_backward_mappings=function(t,e){if(t.length===0)return;var r=this.getRowByModel(t[0].get_root()),n=r.action;t.forEach(function(t){t.was_created=true});if(r.idx===0)return;var i=this.rows[r.idx-1];var o=[];var a=[];i.model.children[0].for_each(function(r){if(r.has_children())return;if(e&&r.is_group("sym"))return;var i=n.mapNodes([r]);var s=false;i.forEach(function(e){if(t.indexOf(e)!==-1){o.push({source_node:r,target_node:e});s=true;e.was_created=false}});if(s)a.push(r)});this.draw_mapping_lines(o,i,r);this.draw_backward_mappings(a,e);this.draw_node_backgrounds(a,i)};DerivationList.prototype.draw_node_backgrounds=function(t,e){var r=function(t){return K};e.view.main.selectAll(".selector").attr({rx:Z,ry:Z}).style("fill",r).style("stroke","none").attr("visibility",function(e){return t.indexOf(e)===-1?"hidden":null})};DerivationList.prototype.hideAllNodeMappings=function(){this.rows.forEach(function(t){t.view.main.selectAll(".selector").attr("visibility","hidden");t.view.main.selectAll(".mapping_line").attr("visibility","hidden")})};DerivationList.prototype.draw_mapping_lines=function(t,e,r){var n=r.pos[0]-e.pos[0];var i=r.pos[1]-e.pos[1];e.view.main.selectAll(".mapping_line");var o=e.view.main.selectAll(".mapping_line").data(t);o.enter().insert("path",".math");o.attr("class","mapping_line").call(te,n,i).style("fill",K).style("stroke",K).attr("visibility",function(t){if(!t.source_node||!t.target_node)return"hidden";return t.source_node.hidden||t.target_node.hidden?"hidden":null});o.exit().remove()};function te(t,e,r){function n(t){return t.x.toFixed(4)+" "+t.y.toFixed(4)+" "}t.attr("d",function(t){if(!t.target_node||!t.source_node)return"M 0,0";var i=t.source_node.sel_box,o=t.source_node,a=t.target_node.sel_box,s=t.target_node;var l={x:i.x+o.x+i.width/2,y:i.y+o.y+i.height/2,width:i.width,height:i.height,r:Z};var h={x:a.x+s.x+a.width/2+e,y:a.y+s.y+i.height/2+r,width:a.width,height:a.height,r:Z};var u=re(l,h);var c=re(h,l);return"M "+n(u.base1)+"C "+n(u.base1_control)+n(u.joint1_control1)+n(u.joint1)+"L"+n(c.joint2)+"C "+n(c.joint2_control1)+n(c.base2_control)+n(c.base2)+"L "+n(c.base1)+"C "+n(c.base1_control)+n(c.joint1_control1)+n(c.joint1)+"L "+n(u.joint2)+"C "+n(u.joint2_control1)+n(u.base2_control)+n(u.base2)+"Z"})}DerivationList.prototype.old_draw_mapping_lines=function(e,r,n){if(this.options.visualize_derivations==="none")return;var i=r.view;var o=this.options.visualize_derivations;var a=this.options.visualize_derivations_method;if(!e.wasNodeTouched)return;t.get_leaf_nodes(e.oldTree.children[0]).forEach(function(t){t.selected=e.wasNodeTouched(t)});var s=[];t.get_leaf_nodes(e.oldTree.children[0]).forEach(function(t){if(o==="all"||t.selected&&o==="active"){var r=e.mapNodes([t]);if(r.length===0)s.push({source_node:t});else r.forEach(function(e){s.push({source_node:t,target_node:e})})}});var l=n.pos[0]-r.pos[0];var h=n.pos[1]-r.pos[1];i.main.selectAll(".bar");var u=i.main.selectAll(".bar").data(s).enter().insert("path",".math");u.attr("class","bar").call(this.mapLinesPaths.bind(this),l,h).call(this.mapLinesMouseEvents.bind(this),s,u).attr("stroke",function(t){if(a==="mouseover")return"clear";var e=t.source_node.hidden||t.target_node&&t.target_node.hidden;var r=!t.target_node;if(e)return r?"#F4E0E0":"#E0F4E1";else return r?"#DF9393":"#93DF93"}).style("stroke-width",5).style("stroke-linecap","round")};DerivationList.prototype.mapLinesPaths=function(t,e,r){t.attr("d",function(t){var n=t.source_node.x+t.source_node.sel_box.x+t.source_node.sel_box.width/2,i=-5+t.source_node.y+t.source_node.sel_box.y+t.source_node.sel_box.height;var o,a;if(t.target_node){o=t.target_node.x+t.target_node.sel_box.x+t.target_node.sel_box.width/2+e;a=t.target_node.y+t.target_node.sel_box.y+t.target_node.sel_box.height/2+r}else{o=n;a=i+5}return"M"+n+","+i+"L"+o+","+a})};DerivationList.prototype.mapLinesMouseEvents=function(t,e,r){if(this.options.visualize_derivations_method!=="mouseover")return;e.forEach(function(t){var e=t.source_node;var r=t.target_node;if(r&&!r.inLines)r.inLines=[];if(e&&!e.outLines)e.outLines=[];if(e){e.outLines.push(t)}if(r){r.inLines.push(t)}});t.on("mouseover",function(t){var e=t.target_node?t.target_node.inLines:t.source_node.outLines;r.attr("stroke",function(t){var r="clear";e.forEach(function(e){if(t.target_node){if(e.source_node.id===t.source_node.id&&e.target_node.id===t.target_node.id){r="#BFDFBF"}}else if(t.source_node){if(e.source_node.id===t.source_node.id){r="#DFBFBF"}}});return r})}).on("mouseout",function(){r.attr("stroke","clear")})};function ee(t,e,r){var n=new Point(r.x-r.width/2,r.y-r.height/2),i=new Point(r.x+r.width/2,r.y-r.height/2),o=new Point(r.x-r.width/2,r.y+r.height/2),a=new Point(r.x+r.width/2,r.y+r.height/2),s=r.r;var l=new Point,h,u;if(Point.intersect_ray_with_segment(t,e,n,o,l)){u=new Point(0,1)}else if(Point.intersect_ray_with_segment(t,e,i,a,l)){u=new Point(0,-1)}else if(Point.intersect_ray_with_segment(t,e,n,i,l)){u=new Point(-1,0)}else if(Point.intersect_ray_with_segment(t,e,o,a,l)){u=new Point(1,0)}var c;if(l.x<n.x+s&&l.y<n.y+s){c=new Circle(n.x+s,n.y+s,s).intersect_with_ray(t,e);l=c[1]||c[0]||l;u=l.sub(new Point(n.x+s,n.y+s)).get_perpendicular().scale(-1).Normalize()}else if(l.x>i.x-s&&l.y<i.y+s){c=new Circle(i.x-s,i.y+s,s).intersect_with_ray(t,e);l=c[1]||c[0]||l;u=l.sub(new Point(i.x-s,i.y+s)).get_perpendicular().scale(-1).Normalize()}else if(l.x<o.x+s&&l.y>o.y-s){c=new Circle(o.x+s,o.y-s,s).intersect_with_ray(t,e);l=c[1]||c[0]||l;u=l.sub(new Point(o.x+s,o.y-s)).get_perpendicular().scale(-1).Normalize()}else if(l.x>a.x-s&&l.y>a.y-s){c=new Circle(a.x-s,a.y-s,s).intersect_with_ray(t,e);l=c[1]||c[0]||l;u=l.sub(new Point(a.x-s,a.y-s)).get_perpendicular().scale(-1).Normalize()}return{point:l,tangent:u}}if(typeof Circle!=="undefined"){Circle.prototype.intersect_with_ray=function(t,e){var r=t.sub(this),n=e.x*e.x+e.y*e.y,i=2*r.x*e.x+2*r.y*e.y,o=r.x*r.x+r.y*r.y-this.r*this.r,a=i*i-4*n*o;if(a<0)return[];if(a<Point.EPS){var s=-i/(2*n);if(s<0)return[];return[new Point(t).add(e.scale(s))]}var l=[],h=(-i-Math.sqrt(a))/(2*n),u=(-i+Math.sqrt(a))/(2*n);if(h>u){var c=h;h=u;u=c}if(h>=0)l.push(new Point(t).add(e.scale(h)));if(u>=0)l.push(new Point(t).add(e.scale(u)));return l};Point.prototype.get_perpendicular=function(){return new Point(-this.y,this.x)}}function re(t,e){var r=Math.min(X,t.width*.9,e.width*.9,t.height*.9,e.height*.9);var n=Math.min(r/2,J);var i=new Point(t),o=new Point(e),a=o.Sub(i),s=[],l=[];var h=a.get_perpendicular();h.Normalize().Scale(r/2);var u=ee(i.add(h),a,t);s.push(u.point);var c=u.point.add(u.tangent.scale(r/3));l.push({from:u.point,to:c});var d=ee(i.sub(h),a,t);s.push(d.point);var p=d.point.add(d.tangent.scale(-r/3));l.push({from:d.point,to:p});h.Normalize().Scale(n/2);var f=ee(i.add(h),a,t);var g=f.point.add(a.normalize().Scale(Y));var v=ee(i.sub(h),a,t);var m=v.point.add(a.normalize().Scale(Y));s.push(g,m);var _=g.sub(a.normalize().Scale(Y/2));var y=g.sub(a.normalize().Scale(-Y/2));var w=m.sub(a.normalize().Scale(Y/2));var x=m.sub(a.normalize().Scale(-Y/2));l.push({from:g,to:_},{from:g,to:y},{from:m,to:w},{from:m,to:x});return{pts:s,lines:l,base1:u.point,base2:d.point,joint1:g,joint2:m,joint1_control1:_,joint1_control2:y,joint2_control1:w,joint2_control2:x,base1_control:c,base2_control:p}}DerivationList.prototype.getDragHandler=function(t){return t.interaction_handler.getHandlerByClass(q)};DerivationList.prototype.handleFactoringGesture=function(t,e,r){if(t.idx!==this.rows.length-1)return;if(!this.curr_drag_handler)this.curr_drag_handler=this.getDragHandler(t.view);var n=this.curr_drag_handler;if(!t.abs_pos){t.abs_pos={x:t.pos[0]+this.pos[0],y:t.pos[1]+this.pos[1]};var i=this.getFactoringActions(t.model.children[0]);if(i.length>0){n.start(t.abs_pos,t.model.children,{reselect_nodes:false,actions:i,move_nodes:false})}}t.abs_pos.x+=e;t.abs_pos.y+=r;if(n.isActive())n.update({dx:e,dy:r});this.pos[0]+=e;this.pos[1]+=r;if(!this.hovering)this.pos=this.keepInContainer(this.pos,t.view.getBBox());this.svgg.attr("transform","translate("+this.pos+")")};DerivationList.prototype.getFactoringActions=function(t){var e=function(t){return t.is_group("sum")&&t.parent.is_group("brackets")&&!t.fixed};var r=[],n=this;this.getAllDLs().forEach(function(t){if(t===n)return;var i=t.getLastRow();r.push({sums:i.model.filter(e),row:i,dl:t})});var i=[];for(var o=0;o<r.length;o++){var a=r[o];for(var s=0;s<a.sums.length;s++){var l=a.sums[s];if(TriggerFactoringAction.match(l,t)){var h=TriggerFactoringAction.createBoundAction(a.row.model,{dl:a.dl,view:a.row.view,sum:l,callback:this.factoringWasTriggered.bind(this)});var u;if(a.dl.coordinator&&this.coordinator){u=this.coordinator.getOffset(this,a.dl)}else{u=[0,0]}h.offset={x:a.dl.pos[0]+a.row.pos[0]-this.pos[0]-this.getLastRow().pos[0]+u[0],y:a.dl.pos[1]+a.row.pos[1]-this.pos[1]-this.getLastRow().pos[1]+u[1]};i.push(h)}}}return i};DerivationList.prototype.factoringWasTriggered=function(t,e,r){var n=this.getDragHandler(t);var i=ne(e,this.getLastModel().children[0]);n.start(le(r),i,{reselect_nodes:false});this.curr_drag_handler=n;this.curr_target_model=r.getLastModel();this.svgg.attr("display","none")};var ne=function(t,e){var r;r=oe(t,e);r=se(r,t);var n=[];for(var i=0;i<r.length;i++){if(r[i].length===0)return false}for(var i=0;i<r.length;i++){if(r[i])n.push(r[i][r[i].length-1])}for(var i=0;i<n.length;i++){if(!Array.isArray(n[i])&&n[i].parent.value!=="add"&&n[i].parent.value!=="sub")n[i]=n[i].parent}if(n.length!==t.children.length)return false;var o=[];for(var i=0;i<n.length;i++){if(Array.isArray(n[i])){for(var a=0;a<n[i].length;a++){o.push(n[i][a])}}else{o.push(n[i])}}return o};var ie=function(t,e){var r=[];t.for_each(function(t){var n=t.to_ascii();if(n.slice(0,1)==="*")n=n.substr(1);if(!t.hidden&&n===e)r.push(t);else{var i=[t];while(n.length<e.length&&t.commutative&&t.rs){t=t.rs;n+=t.to_ascii();i.push(t)}if(n===e)r.push(i)}});return r};var oe=function(t,e){var r=[];for(var n=0;n<t.children.length;n++){var i=t.children[n],o=i.children[1];r.push(ie(o,e.to_ascii()))}return r};function ae(t){return function(e){return!e.hidden&&e.to_ascii()===t}}var se=function(t,e){var r=function(t){return t.parent&&(t.parent.value==="add"||t.parent.value==="sub")&&t.parent.parent&&t.parent.parent==e};var n=function(t){return t.parent&&t.parent.value==="mul"&&t.parent.parent&&t.parent.parent.is_group("product")&&t.parent.parent.parent&&t.parent.parent.parent.parent&&t.parent.parent.parent.parent==e};var i=function(t){return t.value==="mul"&&t.parent&&t.parent.is_group("product")&&t.parent.parent&&t.parent.parent.parent&&t.parent.parent.parent==e};var o=function(t){var e=true;if(Array.isArray(t)){for(var o=0;o<t.length;o++)if(!i(t[o]))e=false}else{return r(t)||n(t)}return e};for(var a=0;a<t.length;a++){t[a]=t[a].filter(o)}return t};var le=function(t){var e=t.getLastRow(),r=t.getLastView(),n=r.getBBox();var i=t.pos,o=e.pos,a=[n.x,n.y];var s=[i[0]+o[0]+a[0],i[1]+o[1]+a[1]];return s};var he=function(t,e,r){this.view=t;this.h_align=e||"center";this.v_align=r||"alphabetic"};he.prototype.set_style=function(t){var e=function(t,r,n){t.size=r;if(t.bigger)t.size*=1.5;if(t.smaller)t.size*=.67;t.color=t.selected?this.view.options.selection_color:n;if(t.has_children())for(var i=0;i<t.children.length;i++){if(t.is_group("fraction"))e.call(this,t.children[i],t.size*this.view.options.fraction_size_factor,t.color);else if(t.is_group("power")&&i===1)e.call(this,t.children[i],t.size*this.view.options.exp_size_factor,t.color);else if(t instanceof h&&t.has_children()&&i===1)e.call(this,t.children[i],t.size*this.view.options.subscript_size_factor,t.color);else e.call(this,t.children[i],t.size,t.color)}};for(var r=0;r<t.length;r++){var n=t[r];var i=o.is_top_most(n)||!n.size?this.view.options.font_size:n.size;var a=n.parent.color||(this.view.interactive()?this.view.options.color:this.view.options.inactive_color);e.call(this,n,i,a)}};he.prototype.set_position=function(t,e){var r=this.view.options.font_baseline_shift,n=this.view.options.font_ascent,i=this.view.options.font_descent;var a=function(t){var e=0,r=0,n=0,i=0,o=0;for(var a=0;a<t.length;a++){var s=t[a];e+=s.hidden||s.hide_after_drop?0:s.width;i+=s.hidden?0:s.width;r=Math.max(r,s.hidden?0:s.ascent-s.rel_y);n=Math.max(n,s.hidden?0:s.descent+s.rel_y)}o=r+n;var l=-e;for(var a=0;a<t.length;a++){var s=t[a];s.rel_x+=l+s.width;if(s.hidden||s.hide_after_drop)s.rel_x-=s.width;l+=s.hidden||s.hide_after_drop?0:s.width}return{width:e,height:o,ascent:r,descent:n,sel_box:{x:-e,width:e,y:-r,height:o}}};var s=function(l){if(!l.has_children()){l.baseline_shift=r*l.size;if(e){l.width=this.view.fontloader.width(l.to_string(),l.size,this.view.get_font(l));l.ascent=n*l.size;l.descent=i*l.size;l.height=l.ascent+l.descent;l.sel_box={x:0,width:l.width,y:-l.ascent,height:l.height}}l.rel_x=-l.width;l.rel_y=0;return}if(t.indexOf(l)!=-1&&!o.is_top_most(l)){l.rel_x=l.rel_x||0;l.rel_y=l.rel_y||0}else{l.rel_x=0;l.rel_y=0}for(var u=0;u<l.children.length;u++)s.call(this,l.children[u]);if(l.is_group("fraction")){var c=[],d=[],p=null;var f=l.children[0];while(f){if(f.value=="mul")c.push(f);else if(f.value=="div")d.push(f);else p=f;f=f.rs}var g=a(c);var v=a(d);var m=-r*l.size;p.height=l.size*this.view.options.div_bar_height;p.width=Math.max(g.width,v.width);p.ascent=p.height/2;p.descent=p.height/2;p.rel_y=m;p.rel_x=.1*l.size;p.sel_box={x:-.1*l.size,width:p.width+.2*l.size,y:-(n+i)*l.size/4,height:(n+i)*l.size/2};l.width=p.width+.2*l.size;l.ascent=g.height+p.height/2-m;l.descent=v.height+p.height/2+m;l.height=l.ascent+l.descent;l.rel_y=0;l.rel_x=-l.width;l.sel_box={x:0,width:l.width,y:-l.ascent,height:l.height};for(var u=0;u<c.length;u++){c[u].rel_y+=-g.descent-p.height/2+m;c[u].rel_x+=.5*(l.width+g.width)}for(var u=0;u<d.length;u++){d[u].rel_y+=v.ascent+p.height/2+m;d[u].rel_x+=.5*(l.width+v.width)}}else{if(l.is_group("power")){var _=l.children[0],y=l.children[1];y.rel_y-=_.ascent*.7}if(l instanceof h&&l.has_children()){var _=l.children[0],w=l.children[1];w.rel_y+=_.descent*.7}gmath.extend(l,a(l.children))}};for(var l=0;l<t.length;l++)s.call(this,t[l]);var u=function(t,e,r){if(t.dragging){t.x0=t.rel_x+e;t.y0=t.rel_y+r;if(t.update_x_during_dragging){t.x=t.x0;t.update_x_during_dragging=false}if(t.update_y_during_dragging){t.y=t.y0;t.update_y_during_dragging=false}}else{t.x=t.rel_x+e;t.y=t.rel_y+r}if(t.has_children())for(var n=0;n<t.children.length;n++)u.call(this,t.children[n],t.x,t.y)};for(var l=0;l<t.length;l++){var c=t[l];if(o.is_top_most(c)){var d,p;switch(this.v_align){case"alphabetic":p=0;break;case"top":p=c.ascent-c.rel_y;break;case"center":p=-c.descent+c.height/2;break;case"bottom":p=-c.descent-c.rel_y;break}switch(this.h_align){case"left":d=c.width;break;case"center":d=c.width/2;break;case"equals":d=c.width/2;if(c.is_group("equals")){var f=c.children[1];var g=f.rel_x+f.sel_box.x+f.sel_box.width;d=-g}break;case"right":d=0;break}u.call(this,c,d,p)}else{u.call(this,c,c.parent.x||0,c.parent.y||0)}}};CreationBox=function(t,e,r){this.container=d3.select(t);this.pos0=e.slice();this.bbox={x:e[0],y:e[1],width:20,height:30};this.main_el=this.createVisualElement();this.setupListeners(this.main_el);this.shadow_el=this.createVisualElement().style("visibility","hidden");this.canvas_controller=r;this.canvas_model=r.model();this.actions=[]};CreateDLAction=function(t,e){this.cc=e;this.size=this.cc.model().size();this.pos_fn=t;this.priority=-1;this.target={x:0,y:0,sel_box:{x:20,y:30,width:this.size.width-40,height:this.size.height-60}}};CreateDLAction.prototype.match=function(){return typeof Keyboard!=="undefined"&&Keyboard!==null};CreateDLAction.prototype.doInPlace=function(t){this.cc.inputDL(this.pos_fn());if(typeof t==="function")t(this);else return true};CreationBox.prototype.getTargetPos=function(){return[this.bbox.x+this.bbox.width/2,this.bbox.y+this.bbox.height/2]};CreationBox.prototype.getAvailableActions=function(){var t=[];t.push(new CreateDLAction(this.getTargetPos.bind(this),this.canvas_controller));var e=this.canvas_model.dls();for(var r=0;r<e.length;r++){var n=e[r],i=n.getLastRow();var o=i.model.children;var a=gmath.actions.FractionExtendAction.getAllAvailableActions(o).concat(gmath.actions.EquationFountain.getAllAvailableActions(o));for(var s=0;s<a.length;s++)a[s].offset={x:n.pos[0]+i.pos[0],y:n.pos[1]+i.pos[1]};t=t.concat(a)}T.setTargetRegions(t);return t};CreationBox.prototype.onDragStart=function(){this.actions=this.getAvailableActions();T.draw(this.container,this.actions,this.bbox);this.shadow_el.style("visibility",null)};CreationBox.prototype.onDrag=function(){this.shadow_el.attr({x:d3.event.pos[0],y:d3.event.pos[1]});this.bbox.x=d3.event.pos[0];this.bbox.y=d3.event.pos[1];T.draw(this.container,this.actions,this.bbox);this.current_hit=T.getBestHit(this.actions,this.bbox)};CreationBox.prototype.onDragEnd=function(){this.shadow_el.attr({x:this.pos0[0],y:this.pos0[1]});this.shadow_el.style("visibility","hidden");T.draw(this.container);if(this.current_hit){if(this.current_hit instanceof CreateDLAction)this.current_hit.doInPlace();else{var t=this.current_hit.target.get_root();t.performAction(this.current_hit)}}this.bbox.x=this.pos0[0];this.bbox.y=this.pos0[1]};CreationBox.prototype.createVisualElement=function(){var t=this.container.append("rect").datum(this).attr(this.bbox).style({fill:"white","fill-opacity":.67,stroke:"green","stroke-dasharray":"4,2",cursor:"pointer"});return t};CreationBox.prototype.setupListeners=function(t){var e=drag_behavior().on("drag-start",this.onDragStart.bind(this)).on("drag",this.onDrag.bind(this)).on("drag-end",this.onDragEnd.bind(this));var r=mtouch_events().origin(function(t){return[t.bbox.x,t.bbox.y]}).on("tap",ue).call(e);t.call(r)};function ue(){console.log(d3.event)}gmath.ui=gmath.ui||{};gmath.ui.Path=function(){var t=function(t,e){this.container=d3.select(t);this.element=null;e=e||{};this.id=gmath.uid();this.points=e.points||[];this.color=e.color||"black";this.width=e.width||1;this.type=e.type;this.init()};t.line=typeof d3==="undefined"?null:d3.svg.line();t.prototype.init=function(){this.element=this.container.append("path").attr("id",this.id).style("fill","none").style("stroke-linecap","round").style("stroke-linejoin","round");return this.update()};t.prototype.update=function(){this.element.attr("d",t.line(this.points)+(this.points.length===1?"Z":"")).style("stroke",this.color).style("stroke-width",this.width);return this};t.prototype.remove=function(){this.element.remove();return this};t.prototype.setContainer=function(t){if(arguments.length===0)return this.container;this.container=t;return this};t.prototype.renderOnto=function(t){var e=this.element,r=this.container;this.container=t;this.element=t.select("#"+this.id);if(this.element.empty())this.init();else this.update();this.container=r;this.element=e};return t}();gm_erase_paths=function(){function t(t,e,r){r=r||20;var n=[];var i=function(t){var i=e[0][0];var o=e[0][1];var a=0;var l=0;if(t.length===1){if(!s(t[0][0],t[0][1],i,o,r)){n.push(t);return}}var h;while(a<t.length-1){var u=t[a];var p=t[a+1];var f=s(u[0],u[1],i,o,r);var g=s(p[0],p[1],i,o,r);if(f&&g){a++;l=a}else if(f&&!g){var v=c(u[0],u[1],p[0],p[1],i,o,r);if(v){t[a]=v;l=a}else{a++}}else if(!f&&g){var v=c(p[0],p[1],u[0],u[1],i,o,r);if(v){h=t.slice(l,a+1);h.push(v);n.push(h)}a++;l=a}else{var m=d(u[0],u[1],p[0],p[1],i,o,r);if(m){h=t.slice(l,a+1);if(h[h.length-1][0]!==m[0][0]||h[h.length-1][1]!==m[0][1]){h.push(m[0])}if(h.length>1)n.push(h);t[a]=m[1];if(t[a+1]&&t[a+1][0]==m[1][0]&&t[a+1][1]==m[1][1])a++;l=a}else{a++}}}if(l!==a){h=t.slice(l,t.length);if(h){n.push(h)}}};var a=function(t,i){if(t.path){r=r+t.width/2;var t=t.path}var o=e[i];var a=e[i+1];var i=0;var s=0;if(t.length===1){var l=h(t[0][0],t[0][1],o[0],o[1],a[0],a[1],r);if(l.indexOf(1)===-1){n.push(t);return}}var u;while(i<t.length-1){var c=t[i];var d=t[i+1];var l=h(c[0],c[1],o[0],o[1],a[0],a[1],r);var p=h(d[0],d[1],o[0],o[1],a[0],a[1],r);if(l.indexOf(1)!==-1&&p.indexOf(1)!==-1){i++;s=i}else if(l.indexOf(1)!==-1&&p.indexOf(1)===-1){var v=f(c[0],c[1],l,d[0],d[1],o[0],o[1],a[0],a[1],r);if(v){t[i]=v;s=i}else{i++}}else if(l.indexOf(1)===-1&&p.indexOf(1)!==-1){var v=f(d[0],d[1],p,c[0],c[1],o[0],o[1],a[0],a[1],r);if(v){u=t.slice(s,i+1);u.push(v);n.push(u);i++;s=i}else{i++}}else{var m=g(c[0],c[1],d[0],d[1],o[0],o[1],a[0],a[1],r);if(m){u=t.slice(s,i+1);if(u[u.length-1][0]!==m[0][0]||u[u.length-1][1]!==m[0][1]){u.push(m[0])}if(u.length>1)n.push(u);t[i]=m[1];if(t[i+1]&&t[i+1][0]==m[1][0]&&t[i+1][1]==m[1][1])i++;s=i}else{i++}}}if(s!==i){u=t.slice(s,t.length);if(u){n.push(u)}}};e=o({path:e});if(e.length===1){for(var l=0;l<t.length;l++){i(t[l])}t=n}else{for(var u=0;u<e.length-1;u++){for(var l=0;l<t.length;l++){a(t[l],u)}t=n;n=[]}}for(var p=0;p<t.length;p++){for(var v=0;v<t[p].length;v++){t[p][v][0]=Math.round(t[p][v][0]);t[p][v][1]=Math.round(t[p][v][1])}}return t}function e(t){if(t.path){var t=t.path}document.write("[");for(var e=0;e<t.length-1;e++){document.write("["+t[e][0]+","+t[e][1]+"],")}document.write("["+t[e][0]+","+t[e][1]+"]");document.write("]")}function r(t){document.write("[");for(var r=0;r<t.length-1;r++){e(t[r]);document.write(",<br />")}e(t[r]);document.write("]")}function n(t,e){if(t.path){var t=t.path}var r="";r+="[";for(var n=0;n<t.length-1;n++){r+="["+t[n][0]+","+t[n][1]+"],"}r+="["+t[n][0]+","+t[n][1]+"]";r+="]";if(e){console.log(r)}else{return r}}function i(t){ue="";ue+="[";for(var e=0;e<t.length-1;e++){ue+=n(t[e],0);ue+=","}ue+=n(t[e],0);ue+="]";console.log(ue)}function o(t){if(t.path){var t=t.path}var e=[];if(t.length===1){e=t}else{pClean=0;while(pClean<t.length-1){if(t[pClean][0]!==t[pClean+1][0]||t[pClean][1]!==t[pClean+1][1]){e.push(t[pClean])}pClean++}if(t.length!==0&&e.length===0){e.push(t[0])}if(t[t.length-1][0]!==t[e.length-1][0]||t[t.length-1][1]!==t[e.length-1][1]){e.push(t[pClean])}}return e}function a(t,e,r,n){return Math.sqrt(Math.pow(r-t,2)+Math.pow(n-e,2))}function s(t,e,r,n,i){var o=a(t,e,r,n);if(o<i)return 1;else return 0}function l(t,e,r,n,i,o,a){var s=[i-r,o-n];var l=[t-r,e-n];var h=[-s[1],s[0]];var u=Math.sqrt(Math.pow(h[0],2)+Math.pow(h[1],2));var c=[h[0]/u,h[1]/u];var d=Math.sqrt(Math.pow(s[0],2)+Math.pow(s[1],2));var p=[s[0]/d,s[1]/d];var f=l[0]*p[0]+l[1]*p[1];if(f<=0||f>=d)return 0;var g=l[0]*c[0]+l[1]*c[1];if(g>=a||g<=-a)return 0;return 1}function h(t,e,r,n,i,o,a){var h=[];h.push(s(t,e,r,n,a));h.push(s(t,e,i,o,a));h.push(l(t,e,r,n,i,o,a));return h}function u(t,e,r,n,i){var o=[r-t,n-e];var a=[-o[1],o[0]];var s=Math.sqrt(Math.pow(a[0],2)+Math.pow(a[1],2));var l=[a[0]/s,a[1]/s];var h=[t+i*l[0],e+i*l[1]];var u=[t-i*l[0],e-i*l[1]];var c=[r-i*l[0],n-i*l[1]];var d=[r+i*l[0],n+i*l[1]];return[h,u,c,d]}function c(t,e,r,n,i,o,a){var s=[i-t,o-e];var l=[r-t,n-e];var h=Math.sqrt(Math.pow(l[0],2)+Math.pow(l[1],2));var u=[l[0]/h,l[1]/h];var c=s[0]*u[0]+s[1]*u[1];var d=[t+c*u[0],e+c*u[1]];var p=Math.sqrt(Math.pow(i-d[0],2)+Math.pow(o-d[1],2));var f;if(p===0){f=a}else{var f=Math.sqrt(Math.pow(a,2)-Math.pow(p,2))}var g=[t+c*u[0]+f*u[0],e+c*u[1]+f*u[1]];if(g[0]===t&&g[1]===e)return null;return g}function d(t,e,r,n,i,o,a){var s=[i-t,o-e];var l=[r-t,n-e];var h=[-l[1],l[0]];var u=Math.sqrt(Math.pow(h[0],2)+Math.pow(h[1],2));var c=[h[0]/u,h[1]/u];var d=s[0]*c[0]+s[1]*c[1];var p=_([t,e],[r,n],[i,o]);var f=v([p[0]-i,p[1]-o]);if(f>=a)return null;var g=Math.sqrt(Math.pow(a,2)-Math.pow(d,2));var m=[i-d*c[0],o-d*c[1]];var y=Math.sqrt(Math.pow(l[0],2)+Math.pow(l[1],2));var w=[l[0]/y,l[1]/y];var x=[[m[0]-w[0]*g,m[1]-w[1]*g],[m[0]+w[0]*g,m[1]+w[1]*g]];if(x[0][0]===t&&x[0][1]===e)return null;return x}function p(t,e,r,n,i,o,a,s){var l,h,u,c;l=r-t;h=n-e;u=a-i;c=s-o;var d,p;if(-u*h+l*c===0)return null;d=(-h*(t-i)+l*(e-o))/(-u*h+l*c);p=(u*(e-o)-c*(t-i))/(-u*h+l*c);if(d>=0&&d<=1&&p>=0&&p<=1){var f=t+p*l;var g=e+p*h;return[f,g]}return null}function f(t,e,r,n,i,o,s,l,h,f){var g=u(o,s,l,h,f);var v=[];if(r[0]&&!r[1]){v.push(c(t,e,n,i,o,s,f));v.push(p(t,e,n,i,g[0][0],g[0][1],g[3][0],g[3][1]));v.push(p(t,e,n,i,g[1][0],g[1][1],g[2][0],g[2][1]));var m=d(t,e,n,i,l,h,f);if(m)v.push(m[0],m[1])}else if(!r[0]&&r[1]){v.push(c(t,e,n,i,l,h,f));v.push(p(t,e,n,i,g[0][0],g[0][1],g[3][0],g[3][1]));v.push(p(t,e,n,i,g[1][0],g[1][1],g[2][0],g[2][1]));var m=d(t,e,n,i,o,s,f);if(m)v.push(m[0],m[1])}else if(r[0]&&r[1]){v.push(c(t,e,n,i,o,s,f));v.push(p(t,e,n,i,g[0][0],g[0][1],g[3][0],g[3][1]));v.push(p(t,e,n,i,g[1][0],g[1][1],g[2][0],g[2][1]));v.push(c(t,e,n,i,l,h,f))}else{var m=d(t,e,n,i,l,h,f);var _=d(t,e,n,i,o,s,f);if(m)v.push(m[0],m[1]);if(_)v.push(_[0],_[1]);v.push(p(t,e,n,i,g[0][0],g[0][1],g[3][0],g[3][1]));v.push(p(t,e,n,i,g[1][0],g[1][1],g[2][0],g[2][1]))}var y=[t,e];for(var w=0;w<v.length;w++){if(v[w]){if(a(v[w][0],v[w][1],n,i)<a(y[0],y[1],n,i)){y=v[w]}}}if(y[0]===t&&y[1]===e)return null;return y}function g(t,e,r,n,i,o,s,l,h){var c=u(i,o,s,l,h);var f=[];var g=d(t,e,r,n,i,o,h);if(g)f.push(g[0],g[1]);g=d(t,e,r,n,s,l,h);if(g)f.push(g[0],g[1]);f.push(p(t,e,r,n,c[0][0],c[0][1],c[3][0],c[3][1]));f.push(p(t,e,r,n,c[1][0],c[1][1],c[2][0],c[2][1]));var v=[r,n];var m=[t,e];for(var _=0;_<f.length;_++){if(f[_]){if(a(f[_][0],f[_][1],t,e)<a(v[0],v[1],t,e)){v=f[_]}}}for(var y=0;y<f.length;y++){if(f[y]){if(a(f[y][0],f[y][1],r,n)<a(m[0],m[1],r,n)){m=f[y]}}}if(v[0]===r&&v[1]===n||m[0]===t&&m[1]===e)return null;else return[v,m]}var v=function(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1])};var m=1e-6;var _=function(t,e,r){var n=[e[0]-t[0],e[1]-t[1]],i=v(n);if(i<m)return t;var o=[r[0]-t[0],r[1]-t[1]];var a=(n[0]*o[0]+n[1]*o[1])/i;if(a<0)return t;
if(a>i)return e;return[t[0]+n[0]*a/i,t[1]+n[1]*a/i]};if(typeof exports!="undefined"){exports.erase=t}return t}();gm_hwr_request=function(){var t=function(t){var e={type:"stroke",x:[],y:[]};t.points.forEach(function(t){e.x.push(t[0]);e.y.push(t[1])});return e};var e=function(e,r){url="http://dlandy.psych.indiana.edu:7031/server.js";var n={components:e.map(t),resultTypes:["LATEX"]};var i={apiKey:"c26d2755-1fda-4033-b136-4af042f3f9db",equationInput:JSON.stringify(n)};var o=$.post(url,i.equationInput);o.done(function(t){var e=t.replace(/\\/g,"\\\\");e=JSON.parse(e);r(null,e.JSON)})};return e}();gmath.ui=gmath.ui||{};gmath.ui.CanvasController=function(){CanvasController=function(t){var e=d3.dispatch("scroll","start_hwr","stop_hwr");var r=t,n=null,i="draw",o=true,a,s=1500,l=null,h=r.paths().length,u=1.5,c=50,d=null,p="black",f=null,g=0,v=null,m=null,_=false,y=[],w=-1,x=false;function b(t){if(x){x=false;return}w+=1;y[w]=t;y.length=w+1}var A=function(){t.on("create",function(t){if(t.target_type==="dl"){var e=t.target;b({type:"create_dl",dl:e});e.events.on("added_line",function(){b({type:"math",dl:e})})}});f=transform_behavior().allow_rotate(false).allow_scale(false).one_finger_drag(false).on("transform",function(){scroll(d3.event.transform.translate[1])});mtouch=mtouch_events().on("touch",M).on("drag",k).on("release",L).on("hold",function(){if(_)return;if(i!=="draw"&&a)return;if(v){A.undo();v=null}A.inputDL(d3.event.finger.pos)}).hold_max_dist(5).hold_time(750).call(f);if(typeof Keyboard!=="undefined"){n=Keyboard();n.width(800).position("center").on("done",P).on("cancel",D)()}var e=r.dls_container().append("rect","*").style({fill:"none","pointer-events":"all"}).attr("width","100%").attr("height","100%").call(mtouch);var o=r.dls_container().node();o.parentNode.insertBefore(e.node(),o);mtouch.frame(e.node());return this};A.model=function(t){if(arguments.length===0)return r;r=t;return this};A.mode=function(t){if(arguments.length===0)return i;if(t==="draw"&&!a)return this;i=t;return this};A.color=function(t){if(arguments.length===0)return p;p=t;return this};A.markerRadius=function(t){if(arguments.length===0)return u;u=t;return this};A.eraserRadius=function(t){if(arguments.length===0)return c;c=t;return this};A.hwr_delay=function(t){if(arguments.length===0)return s;s=t;return this};A.tx_behavior=function(){return f};A.hwr=function(t){if(!arguments.length)return o;if(o===t)return;o=t;h=r.paths.length;if(!o)A.cancelHWR();return A};A.drawing=function(t){if(!arguments.length)return a;a=t;return this};A.scheduleHWR=function(){if(!l){l=setTimeout(A.performHWR,s);e.start_hwr()}};A.cancelHWR=function(t){if(!t)h=r.paths.length;if(l){clearTimeout(l);l=null;e.stop_hwr()}};A.performHWR=function(){l=null;e.stop_hwr();if(h>r.paths().length-1)return;var t=r.paths().slice(h),n=false,i=[];gm_hwr_request(t,function(e,o){if(e)console.log(e);var a=t[0].points[0];try{n=r.createDL({pos:a,eq:o})}catch(s){return}var l=function(t){try{r.removePath(t);i.push(t)}catch(e){return}};for(var u=0;u<t.length;u++){l(t[u])}h=r.paths().length;if(n&&i.length>0){b({type:"convert",removed_paths:i,added_dl:n})}});h=r.paths().length};A.scroll=function(t){if(arguments.length===0)return g;g=Math.min(0,t);f.transform({translate:[0,g]});r.paths_container().attr("transform","translate(0,"+g+")");r.dls_container().attr("transform","translate(0,"+g+")");e.scroll(g);return this};A.undo=function(){if(w===-1)return;var t=y[w];w--;if(t.type==="draw"){r.removePath(t.path)}else if(t.type==="erase"){t.removed.forEach(function(t){r.addPath(t)});t.added.forEach(function(t){r.removePath(t)});t.modified.forEach(function(t){t.path.points=t.points_before;r.updatePath(t.path)})}else if(t.type==="convert"){t.removed_paths.forEach(function(t){r.addPath(t)});this.undo()}else if(t.type==="math"){t.undone_row=t.dl.undo()}else if(t.type==="create_dl"){r.removeDL(t.dl)}};A.redo=function(){if(y.length<=w+1)return;w+=1;var t=y[w];if(t.type==="draw"){r.addPath(t.path)}else if(t.type==="erase"){t.removed.forEach(function(t){r.removePath(t)});t.modified.forEach(function(t){t.path.points=t.points_after;r.updatePath(t.path)});t.added.forEach(function(t){r.addPath(t)})}else if(t.type==="convert"){t.removed_paths.forEach(function(t){r.removePath(t)})}else if(t.type=="math"){x=true;t.dl.redo(t,t.undone_row)}else if(t.type=="create_dl"){x=true;r.addDL(t.dl);if(y[w+1]&&y[w+1].type==="convert")this.redo()}};var N=function(t){return r.createPath({points:[[t[0],t[1]-g]],color:i==="draw"?p:"white",width:i==="draw"?2*u:2*c})};var M=function(){if(!a)return;var t=d3.event;if(t.fingers.length>1){_=true;if(v){A.undo();v=null}return}var e=t.finger.pos0.slice();e[1]-=g;A.cancelHWR(true);v=N(t.finger.pos0);if(i==="draw")b({type:"draw",path:v});if(i==="erase"){d=r.paths_container().append("circle").attr({cx:e[0],cy:e[1],r:c}).style({stroke:"silver",fill:"white"})}};var k=function(){if(!a)return;if(!v||_)return;var t=d3.event,e=t.finger.pos.slice();e[1]-=g;v.points.push(e);r.updatePath(v);if(i==="erase")d.attr({cx:e[0],cy:e[1]})};var L=function(){if(_){if(d3.event.fingers.length===0)_=false;return}if(!v)return;if(i==="draw"){if(o&&(!n||!n.visible()))A.scheduleHWR()}else if(i==="erase"){d.remove();T()}v=null};var T=function(){var t=r.paths().slice(),e=t[t.length-1],n=[],i=[],o=[];t.forEach(function(t){if(t===e)return;var a=c+t.width/2;var s=gm_erase_paths([t.points],e.points,a);if(s.length===0){i.push(t);r.removePath(t)}else{o.push({path:t,points_before:t.points.slice(),points_after:s[0].slice()});t.points=s[0];r.updatePath(t);for(var l=1;l<s.length;l++){var h=r.createPath({points:s[l],color:t.color,width:t.width});n.push(h)}}});r.removePath(e);b({type:"erase",removed:i,modified:o,added:n})};A.inputDL=function(t){if(!n)return;A.cancelHWR(true);m={pos:[t[0],t[1]-g]};n.caption("Please enter a number, equation, or expression.").latex("").visible(true)};var P=function(t){n.visible(false);if(t==="")return;m.eq=t;var e;try{e=r.createDL(m)}catch(i){console.log(i)}finally{m=null}};var D=function(){n.visible(false)};return d3.rebind(A,e,"on")};return CanvasController}();gmath.ui=gmath.ui||{};gmath.ui.CanvasModelView=function(){CanvasModelView=function(){var t=d3.dispatch("create","update","remove","reset"),e=[],r=[],n=null,i,o;var a=function(t){n=t;o=n.append("g");i=n.append("g");return this};a.addDL=function(e){if(r.indexOf(e)!==-1)throw"dl is already in this model";e.options.canvas_model=a;e.container(i.node());r.push(e);t.create({target_type:"dl",target:e});return e};a.createDL=function(e,n){e.canvas_model=a;var o=new DerivationList(i.node(),e,n);r.push(o);t.create({target_type:"dl",target:o});return o};a.removeDL=function(e){s(r,e);e.remove();t.remove({target_type:"dl",target:e})};a.addPath=function(r){if(e.indexOf(r)!==-1)throw"path is already in this model";r.setContainer(o);r.init();e.push(r);t.create({target_type:"path",target:r});return r};a.createPath=function(r){var n=new gmath.ui.Path(o.node(),r);e.push(n);t.create({target_type:"path",target:n});return n};a.updatePath=function(e){e.update();t.update({target_type:"path",target:e})};a.removePath=function(r){s(e,r);r.remove();t.remove({target_type:"path",target:r})};var s=function(t,e){var r=t.indexOf(e);if(r===-1)throw"no element "+e;t.splice(r,1)};a.dls=function(e){if(!arguments.length)return r;for(var n=0;n<r.length;n++)r[n].remove();r=e.slice();for(var n=0;n<r.length;n++){r[n].container(i);r[n].init()}t.reset({target_type:"dl",target:r.slice()})};a.paths=function(r){if(!arguments.length)return e;for(var n=0;n<e.length;n++)e[n].remove();e=r.slice();for(var n=0;n<e.length;n++){e[n].setContainer(o);e[n].init()}t.reset({target_type:"path",target:e.slice()})};a.container=function(){return n};a.dls_container=function(t){if(!arguments.length)return i;i=t;return this};a.paths_container=function(t){if(!arguments.length)return o;o=t;return this};a.size=function(){var t=n.node();while(t.tagName.toLowerCase()!=="svg"&&t.parentNode)t=t.parentNode;var e=t.getBoundingClientRect();return{width:e.width,height:e.height}};return d3.rebind(a,t,"on")};return CanvasModelView}();Main=function(t,e,r){var n=gmath.uid(),i=t||{exclude:[]},o=[{p:"#84BF41",s:"#D0E4B9",t:"silver",q:"white"},{p:"#84BF41",s:"gainsboro",t:"silver",q:"white"},{p:"#D0E4B9",s:"#84BF41",t:"silver",q:"white"}],a=0,s=347,l=20,h,u,c,d,p,f,g,v,m,_,y,w,x;var b,A;var N;if(typeof e==="undefined"){var M=document.body,k=document.documentElement;A=Math.max(M.scrollHeight,M.offsetHeight,k.clientHeight,k.scrollHeight,k.offsetHeight);A+="px";b=document.body.clientWidth+"px";N=d3.select("body")}else{N=d3.select(e);if(typeof r==="undefined"){b=N[0][0].clientWidth+"px";A=N[0][0].clientHeight+"px"}else{b=r[0];A=r[1]}}var L=function(t){if(i.exclude)return!(i.exclude.indexOf(t)>-1);if(i.include)return i.include.indexOf(t)>-1};x=N.append("svg").attr("width",b).attr("height",A).style("margin-left","auto").style("margin-right","auto").style("display","block").style("overflow","visible");var T=x.node().clientWidth;var P=x.node().clientHeight;N[0][0].parentNode.onresize=function(){};var D=function(){return h.selectTiny()};var E=function(t){var e=t.dls_container().node().getBBox(),r=t.paths_container().node().getBBox(),n=e.height+e.y,i=r.height+r.y;h.selectPage().height=Math.max(n,i);h.sizeTinys()};var S=function(t,e){var r=function(){var r=e.selectAll("#"+t.id);setTimeout(function(){var n=t.svgg.selectAll("#"+t.id);n[0].forEach(function(t){var r=t.cloneNode(true);e.node().appendChild(r)});r.remove()},1e3)};r();t.timeTree.events.on("change."+this.id,r)};w=gmath.ui.CanvasModelView().on("create",function(t){if(!h)return;if(t.target_type=="dl"){S(t.target,D())}else if(t.target_type=="path"){t.target.renderOnto(D())}E(w)}).on("update",function(t){if(!h)return;t.target.renderOnto(D());E(w)}).on("remove",function(t){if(!h)return;D().selectAll("#"+t.target.id).remove()}).on("reset",function(t){if(!h)return;var e=D();if(t.target_type=="dl"){e.selectAll(".derivation-list").remove();t.target.forEach(function(t){S(t,e)})}else if(t.target_type=="path"){e.selectAll("path").remove();t.target.forEach(function(t){t.renderOnto(e)})}});y=gmath.ui.CanvasController(w).on("scroll",function(t){if(!h)return;h.selectPage().transform.translate[1]=t;h.sizeTinys()}).on("start_hwr",function(){if(!m)return;m.animating(true)}).on("stop_hwr",function(){if(!m)return;m.animating(false)});if("drawing"in t)y.drawing(t.drawing);if(L("pages")){h=gmath.ui.Pages(w,o[a]).on("transform",function(t){y.scroll(t.translate[1])}).on("focus",function(){y.cancelHWR()});s+=51}if(L("markers")&&y.drawing()){u=gmath.ui.Markers(o[a]).pos([s,P-75]).on("eraser",function(t){y.mode("erase");y.eraserRadius(t)}).on("marker",function(t,e){y.mode("draw");y.markerRadius(e);y.color(t)}).on("focus",function(){y.cancelHWR()})}if(L("markerssidebar")&&!u){c=gmath.ui.Markerssidebar(o[a]).pos([s,P-75]).on("eraser",function(t){y.mode("erase");y.eraserRadius(t)}).on("marker",function(t,e){y.mode("draw");y.markerRadius(e);y.color(t)}).on("focus",function(){y.cancelHWR()})}if(L("download")&&h){d=gmath.ui.Download(o[a]).pos([T-75,l]).on("download",function(){y.cancelHWR();h.download()});l+=55}if(L("upload")&&h){p=gmath.ui.Upload(o[a]).pos([T-75,l]).on("upload",function(t){h.upload(t)}).on("focus",function(){y.cancelHWR()});l+=55}if(L("undo")){f=gmath.ui.Undo(o[a]).pos([T-75,l]).on("undo",function(t){y.undo()});l+=55}if(L("redo")){g=gmath.ui.Redo(o[a]).pos([T-75,l]).on("redo",function(t){y.redo()});l+=55}if(L("scroll")){v=gmath.ui.Scroll(o[a],y).pos([T-75,l]).on("scroll",function(t){if(h){h.selectPage().transform={translate:[0,t]};h.sizeTinys()}else{y.scroll(t)}}).on("focus",function(){y.cancelHWR()});l+=90}if(L("hwr")){m=gmath.ui.HWRUI(o[a]).pos([T-75,P-75]).on("hwr",function(t){y.hwr(t)})}if(L("drawerasetoggle")&&!u){_=gmath.ui.DrawEraseToggle(o[a]).pos([s,603]).on("mode",function(t){y.mode(t)}).on("focus",function(){y.cancelHWR()})}var F=x.append("g");if(w)F.call(w);if(y)F.call(y);if(h)F.call(h);if(u)F.call(u);if(c)F.call(c);if(d)F.call(d);if(p)F.call(p);if(f)F.call(f);if(g)F.call(g);if(v)F.call(v);if(m)F.call(m);if(_)F.call(_);var B=new CreationBox(F.node(),[20,20],y);return{svg:x,cmodel:w,ccontroller:y,pages:h,markers:u,markerssidebar:c,download:d,upload:p,undo:f,scroll:v,hwr:m,drawerasetoggle:_,creationbox:B}};Pages=function(t,e){var r=d3.dispatch("transform","focus"),n=null,i=null,o=[1280,720],a=[],s=[],l=95,h=function(t){var e=l/(o[0]-l);if(arguments.length===0){return e}return t*e},u=null,c=null,d=false,p=null,f=null,g=null,v=null;var m=function(t){_(t);return this};m.res=function(t){if(arguments.length===0)return o;o[0]=t[0];o[1]=t[1];return this};m.tWidth=function(t){if(arguments.length===0)return l;l=t;return this};m.download=function(){var t=[],e=u.id;a.forEach(function(e){var r={};r.height=e.height;r.id=e.id;r.paths=e.paths;r.dls=[];e.dls.forEach(function(t){r.dls.push(t.options)});r.transform=e.transform;t.push(r)});var r=new Blob([JSON.stringify({pages:t,tinys:s,cid:u.id})],{type:"application/json"});saveAs(r,"gmath-session.json");a.forEach(function(t){if(t.id===e){A(t)}})};m.upload=function(n){a=n.pages;s=n.tinys;g=f.selectAll(".t_el").data(s);g.exit().remove();g.enter().append("svg").classed("t_el",true).call(x());g.append("rect").attr("fill",e.q);g.append("g").attr("transform"," translate ("+h(-l)+", 0) scale("+h()+")");g.append("rect").classed("focus",true).attr("x",1).attr("y",1).attr("width",l-2).attr("stroke",e.p).attr("stroke-width",2).attr("fill","none").attr("display","none");v=f.selectAll(".t_progress").data(s);v.enter().append("svg").classed("t_progress",true).attr("x",l+1);v.append("rect").classed("bg",true).attr("width",4).attr("fill",e.t);v.append("rect").classed("bar",true).attr("width",4).attr("height",h(o[1])+4).attr("fill",e.p);for(var i=a.length-1;i>-1;i--){u=a[i];c=s[i];t.paths(u.paths);t.dls(u.dls);r.transform(u.transform)}a.forEach(function(t){if(t.id===n.cid){A(t)}});P()};m.selectTiny=function(t){if(arguments.length===0){t=c}return g.filter(function(e){return e.id===t.id}).select("g")};m.selectPage=function(t){if(arguments.length===0){return u}a.forEach(function(e){if(e.id===t.id){return e}})};m.sizeTinys=function(){P()};m.t_sel=function(){return g};function _(t){n=t;n.append("rect").attr("x",0).attr("y",0).attr("width",l+7).attr("height",o[1]).attr("fill",e.s);n.append("rect").attr("x",l+7).attr("y",0).attr("width",1).attr("height",o[1]).attr("fill",e.t);f=n.append("g").attr("transform","translate(1, 0)");var a=mtouch_events().frame(n.node()).on("tap",function(){r.focus();N()});i=n.append("g").attr("transform","translate(1, "+(o[1]-51)+")").call(a);i.append("rect").attr("rx",5).attr("ry",5).attr("width",l+5).attr("height",50).attr("fill",e.q);var s=(l+5)/2;i.append("path").attr("d","M "+s+" 13 L "+s+" 37 M "+(s-12)+" 25 L "+(s+12)+" 25").style("stroke-width",6).style("stroke-linecap","round").style("stroke",e.s);b()}function y(t){return{id:t?t:gmath.uid(),transform:{scale:1,rotate:0,translate:[0,0]},height:o[1],paths:[],dls:[]}}function w(t,e){return{id:t,index:e,y:0,height:h(o[1])}}function x(){return mtouch_events().frame(n.node()).on("tap",function(t){r.focus();M(t)}).on("drag",function(t){r.focus();k(t)}).on("release",function(t){r.focus();L(t)})}function b(){u=y();c=w(u.id,a.length);a.push(u);s.push(c);g=f.selectAll(".t_el").data(s);g.enter().append("svg").classed("t_el",true).call(x());g.append("rect").attr("fill",e.q);g.append("g").attr("transform"," translate ("+h(-l)+", 0) scale("+h()+")");g.append("rect").classed("focus",true).attr("x",1).attr("y",1).attr("width",l-2).attr("stroke",e.p).attr("stroke-width",2).attr("fill","none").attr("display","none");v=f.selectAll(".t_progress").data(s);v.enter().append("svg").classed("t_progress",true).attr("x",l+1);v.append("rect").classed("bg",true).attr("width",4).attr("fill",e.t);v.append("rect").classed("bar",true).attr("width",4).attr("height",h(o[1])+4).attr("fill",e.p);t.paths(u.paths);t.dls(u.dls);r.transform(u.transform);P()}function A(e){u.paths=t.paths();u.dls=t.dls();u=e;t.paths(u.paths);t.dls(u.dls);r.transform(u.transform);s.forEach(function(t){if(t.id===e.id){c=t}})}function N(){b()}function M(t){var e=d3.event.finger.pos;a.forEach(function(r){if(r.id===t.id){e[1]=(e[1]-t.y)/h()-o[1]/2;var n=r.height-o[1];if(e[1]>n)e[1]=n;if(e[1]<0)e[1]=0;r.transform.translate=[0,e[1]*-1];A(r);P()}})}function k(t){if(!d){d=true;T(t);g.sort(function(e,r){return e.id===t.id?1:-1});v.sort(function(e,r){return e.id===t.id?1:-1});a.forEach(function(e){if(e.id===t.id){A(e)}})}t.y+=d3.event.finger.dy;t.y=t.y<-10?-10:t.y;g.filter(function(e){return e.id===t.id}).attr("y",t.y);v.filter(function(e){return e.id===t.id}).attr("y",t.y)}function L(t){if(d){var e=t.index;s.forEach(function(r){var n=r.index;if(t.id!==r.id){var i=r.y+r.height/2;if(n>e&&t.y>=i){r.index=n-1;t.index=n}if(n<e&&t.y<=i){r.index=n+1;t.index=t.index===e?n:t.index}}});s.sort(function(t,e){return t.index-e.index});P();d=false}}function T(t){g.selectAll(".focus").attr("display","none");g.filter(function(e){return e.id===t.id}).select(".focus").attr("height",function(t){return t.height-2}).attr("display","block");v.selectAll(".bar").attr("display","none");v.filter(function(e){return e.id===t.id}).select(".bar").attr("display","block")}function P(){var t=null,e=u.height,r=o[1]-u.transform.translate[1];c.height=h(Math.max(r,e))+h(50);s.forEach(function(e){e.y=t?t.y+t.height+1:1;t=e});g.attr("y",function(t){return t.y}).attr("width",l).attr("height",function(t){return t.height}).select("rect").attr("x",0).attr("y",0).attr("width",l).attr("height",function(t){return t.height}).attr("stroke","none").attr("stroke-width",0);v.attr("y",function(t){return t.y}).attr("height",function(t){return t.height}).select(".bg").attr("height",function(t){return t.height});v.filter(function(t){return t.id===u.id}).select(".bar").attr("y",function(t){return-1*h(u.transform.translate[1])});T(c)}return d3.rebind(m,r,"on")};gmath.ui=gmath.ui||{};gmath.ui.Pages=Pages;Markers=function(t){var e=d3.dispatch("marker","eraser","focus");var r=null,n=0,i=0,o=.75,a=null,s=null,l=["black","red","green","blue",t.s,t.s,t.s],h=0,u=["red","chocolate","orange","gold","yellow","lime","yellowgreen","green","turquoise","blue","navy","purple","fuchsia"],c=200*o,d=c/2,p=70*o,f=15*o,g=6,v=50,m=50,_="M 10 30 L 30 30 L 30 10 L 70 10 L 70 30 L 90 30 L 80 90 L 20 90 L 10 30 Z",y="M 30 90 Q 10 90 10 110 L 10 180 L 90 180 L 90 110 Q 90 90 70 90 L 30 90 Z",w="M 35 33 L 35 55 L 65 55 L 65 17 L 35 33 Z",x="M 30 90 Q 10 90 10 110 L 10 180 L 90 180 L 90 110 Q 90 90 70 90 L 67 90 L 67 55 L 33 55 L 33 90 L 30 90 Z",b=["M 16 40 Q 14 42 15 45 L 52 78 Q 54 80 58 78 L 88 65 Q 89 62 86 59 L 86 57 Z","M 13 19 L 43 11 L 88 37 L 54 48 L 13 19 Z","M 13 19 L 16 41 L 55 74 L 87 61 L 88 37 L 54 48 L 13 19 Z"],A=-1,N=null,M=null,k=null,L=null,T=null,P=null,D=1,E=1;var S=function(t){r=t;F();return this};S.pos=function(t){if(arguments.length==0)return[n,i];n=t[0];i=t[1];if(r)B();return this};S.marker=function(t){if(arguments.length==0)return h;R(t);return this};S.color=function(){return l[h]};S.scale=function(t){if(arguments.length==0)return o;o=t;return this};function F(){var n=mtouch_events().frame(r.node()).on("tap",function(t,r){e.focus();R(r)}).on("hold",function(t,r){e.focus();C(t,r)});var i=mtouch_events().frame(r.node()).on("tap",function(t){e.focus();I(t)});var a=mtouch_events().frame(r.node()).on("drag",function(t){e.focus();V(t)});var s=mtouch_events().frame(r.node()).on("tap",function(t){e.focus();z(t)});N=r.selectAll(".marker_els").data(l);N.enter().append("svg").classed("marker_els",true).call(n);N.append("path").classed("pathhead",true).attr("d",_).attr("transform","scale("+o*.5+")").style("fill",function(e){return e===t.s?t.q:e}).style("stroke",function(e){return e===t.s?e:"none"}).style("stroke-width","6").style("stroke-linejoin","round");N.append("path").classed("pathBody",true).attr("d",y).attr("transform","scale("+o*.5+")").style("fill",t.q).style("stroke",function(t){return t}).style("stroke-width","6").style("stroke-linejoin","round");L=r.append("svg").classed("pallete",true).style("display","none");var h=L.append("g");h.append("path").attr("d","M 0 "+d+" L "+c+" "+d+" L "+d+" "+(c+10)+" L 0 "+d+" Z").style("fill",t.s);h.append("circle").attr("cx",d).attr("cy",d).attr("r",d).style("fill",t.s);var v=L.selectAll(".pallete_els").data(u);v.enter().append("circle").classed("pallete_els",true).attr("cx",function(t,e){return d+Math.cos(2*(e+1)*Math.PI/u.length)*p}).attr("cy",function(t,e){return d+Math.sin(2*(e+1)*Math.PI/u.length)*p}).attr("r",f).style("fill",function(t){return t}).call(i);M=r.append("svg").call(a);scale_bg=M.append("circle").attr("cx",m+3.75+1.25).attr("cy",m+3.75+1.25).attr("r",m+1.875+1.25).attr("transform","scale("+o*.8+")").attr("stroke",t.s).attr("stroke-width",3.75).attr("fill",t.q);scaler=M.append("circle").attr("cx",m+3.75+1.25).attr("cy",m+3.75+1.25).attr("r",g).attr("transform","scale("+o*.8+")").attr("fill",t.s);k=r.append("svg").call(s);k.append("path").attr("transform","scale("+o+")").attr("d",b[0]).attr("fill",t.t);k.append("path").attr("transform","scale("+o+")").attr("d",b[1]).attr("fill",t.s);k.append("path").attr("transform","scale("+o+")").attr("d",b[2]).attr("fill",t.p);B();P=m*o*.8;T=[M.attr("x")*1+P+4,M.attr("y")*1+P+4];R(0)}function B(){N.attr("x",function(t,e){return n+e*o*60}).attr("y",i);M.attr("x",n+l.length*o*60).attr("y",i+o*8-4);k.attr("x",n+l.length*o*60+90).attr("y",i+o*5);L.attr("y",i-c-15)}function O(e){N.select(".pathhead").attr("d",function(t,r){return r===e?w:_}).style("fill",function(e){return e===t.s?t.q:e}).style("stroke",function(e){return e===t.s?e:"none"});N.select(".pathBody").attr("d",function(t,r){return r===e?x:y}).style("stroke",function(t){return t});if(e!==-1)k.select("#eraser").style("fill",l[h]);L.style("display","none");A=-1}var R=function(r){if(r<-1||r>=l.length||l[r]==t.s)return;h=r;O(r);if(r!==-1){scaler.attr("r",g).attr("fill",t.s);scale_bg.attr("fill",t.q);e.marker(l[r],g*.8*D)}};function C(t,e){if(e!==0){var r=N.filter(function(t,r){return r===e}),n=r.attr("x")*1,i=r.node().getBBox().width/2;L.attr("x",n+i-d+o*5).style("display","block");A=e}}function I(t){l[A]=t;N=r.selectAll(".marker_els").data(l);R(A)}function V(t){var r=d3.event.finger.pos,n=Math.sqrt(Math.pow(T[0]-r[0],2)+Math.pow(T[1]-r[1],2)),i=n/P;if(i>1)i=1;if(i<.12)i=.12;if(h>-1){g=P*i/o/.8;e.marker(l[h],g*.8*D)}else{v=P*i/o/.8;e.eraser(v*.8*E)}scaler.attr("r",m*i)}function z(r){R(-1);scaler.attr("r",v).attr("fill",t.q);scale_bg.attr("fill",t.s);e.eraser(v*.8*E)}return d3.rebind(S,e,"on")};gmath.ui=gmath.ui||{};gmath.ui.Markers=Markers;Markerssidebar=function(t){var e=d3.dispatch("marker","eraser","focus");var r=null,n=0,i=0,o=1,a=null,s=null,l=["black"],h=0,u=["red","chocolate","orange","gold","yellow","lime","yellowgreen","green","turquoise","blue","navy","purple","fuchsia"],c=200*o,d=c/2,p=70*o,f=15*o,g=6,v=50,m=50,_="M 10 30 L 30 30 L 30 10 L 70 10 L 70 30 L 90 30 L 80 90 L 20 90 L 10 30 Z",y="M 30 90 Q 10 90 10 110 L 10 180 L 90 180 L 90 110 Q 90 90 70 90 L 30 90 Z",w="M 35 33 L 35 55 L 65 55 L 65 17 L 35 33 Z",x="M 30 90 Q 10 90 10 110 L 10 180 L 90 180 L 90 110 Q 90 90 70 90 L 67 90 L 67 55 L 33 55 L 33 90 L 30 90 Z",b=["M 16 40 Q 14 42 15 45 L 52 78 Q 54 80 58 78 L 88 65 Q 89 62 86 59 L 86 57 Z","M 13 19 L 43 11 L 88 37 L 54 48 L 13 19 Z","M 13 19 L 16 41 L 55 74 L 87 61 L 88 37 L 54 48 L 13 19 Z"],A=-1,N=null,M=null,k=null,L=null,T=null,P=null,D=1,E=1;var S=function(t){r=t;F();return this};S.pos=function(t){if(arguments.length==0)return[n,i];n=t[0];i=t[1];if(r)B();return this};S.marker=function(t){if(arguments.length==0)return h;R(t);return this};S.color=function(){return l[h]};S.scale=function(t){if(arguments.length==0)return o;o=t;return this};function F(){var n=mtouch_events().frame(r.node()).on("tap",function(t,r){e.focus();R(r)}).on("hold",function(t,r){e.focus();C(t,r)});var i=mtouch_events().frame(r.node()).on("tap",function(t){e.focus();I(t)});var a=mtouch_events().frame(r.node()).on("drag",function(t){e.focus();V(t)});var s=mtouch_events().frame(r.node()).on("tap",function(t){e.focus();z(t)});N=r.selectAll(".marker_els").data(l);N.enter().append("svg").classed("marker_els",true).call(n);N.append("path").classed("pathhead",true).attr("d",_).attr("transform","scale("+o*.5+")").style("fill",function(e){return e===t.s?t.q:e}).style("stroke",function(e){return e===t.s?e:"none"}).style("stroke-width","6").style("stroke-linejoin","round");N.append("path").classed("pathBody",true).attr("d",y).attr("transform","scale("+o*.5+")").style("fill",t.q).style("stroke",function(t){return t}).style("stroke-width","6").style("stroke-linejoin","round");L=r.append("svg").classed("pallete",true).style("display","none");var h=L.append("g");h.append("path").attr("d","M 0 "+d+" L "+c+" "+d+" L "+d+" "+(c+10)+" L 0 "+d+" Z").style("fill",t.s);h.append("circle").attr("cx",d).attr("cy",d).attr("r",d).style("fill",t.s);var g=L.selectAll(".pallete_els").data(u);g.enter().append("circle").classed("pallete_els",true).attr("cx",function(t,e){return d+Math.cos(2*(e+1)*Math.PI/u.length)*p}).attr("cy",function(t,e){return d+Math.sin(2*(e+1)*Math.PI/u.length)*p}).attr("r",f).style("fill",function(t){return t}).call(i);k=r.append("svg").call(s);k.append("path").attr("d",b[0]).attr("fill",t.t);k.append("path").attr("d",b[1]).attr("fill",t.s);k.append("path").attr("d",b[2]).attr("fill",t.p);B();P=m*o*.8;R(0)}function B(){N.attr("x",function(t,e){return n+e*o*60}).attr("y",i);k.attr("x",n+l.length*o*60).attr("y",i+o*5);L.attr("y",i-c-15)}function O(e){N.select(".pathhead").attr("d",function(t,r){return r===e?w:_}).style("fill",function(e){return e===t.s?t.q:e}).style("stroke",function(e){return e===t.s?e:"none"});N.select(".pathBody").attr("d",function(t,r){return r===e?x:y}).style("stroke",function(t){return t});if(e!==-1)k.select("#eraser").style("fill",l[h]);L.style("display","none");A=-1}var R=function(r){if(r<-1||r>=l.length||l[r]==t.s)return;h=r;O(r);if(r!==-1){e.marker(l[r],g*.3*D)}};function C(t,e){if(e!==0){var r=N.filter(function(t,r){return r===e}),n=r.attr("x")*1,i=r.node().getBBox().width/2;L.attr("x",n+i-d+o*5).style("display","block");A=e}}function I(t){l[A]=t;N=r.selectAll(".marker_els").data(l);R(A)}function V(t){var r=d3.event.finger.pos,n=Math.sqrt(Math.pow(T[0]-r[0],2)+Math.pow(T[1]-r[1],2)),i=n/P;if(i>1)i=1;if(i<.12)i=.12;if(h>-1){g=P*i/o/.8;e.marker(l[h],g*.8*D)}else{v=P*i/o/.8;e.eraser(v*.8*E)}scaler.attr("r",m*i)}function z(t){R(-1);e.eraser(v*.8*E)}return d3.rebind(S,e,"on")};gmath.ui=gmath.ui||{};gmath.ui.Markerssidebar=Markerssidebar;Undo=function(t){var e=d3.dispatch("undo");var r=null,n=null,i=[0,0];var o=function(t){r=t;a();return this};o.pos=function(t){i=t;if(n){n.attr("x",i[0]).attr("y",i[1])}return this};var a=function(){n=r.append("svg").attr("x",i[0]).attr("y",i[1]).on("click",function(){e.undo()});n.append("rect").attr("width",50).attr("height",50).attr("rx",5).attr("ry",5).attr("fill",t.s);n.append("path").attr("d","M 15 50 Q 15 85 50 85 Q 85 85 85 50 Q 85 15 50 15").attr("transform","scale(0.5)").style("stroke",t.q).style("stroke-width","6").style("stroke-linejoin","round").style("stroke-linecap","round").style("fill","none");n.append("path").attr("d","M 50 10 L 50 20 L 40 15 L 50 10 Z").attr("transform","scale(0.5)").style("stroke",t.q).style("stroke-width","6").style("stroke-linejoin","round").style("stroke-linecap","round").style("fill",t.q)};return d3.rebind(o,e,"on")};gmath.ui=gmath.ui||{};gmath.ui.Undo=Undo;Redo=function(t){var e=d3.dispatch("redo");var r=null,n=null,i=[0,0];var o=function(t){r=t;a();return this};o.pos=function(t){i=t;if(n){n.attr("x",i[0]).attr("y",i[1])}return this};var a=function(){n=r.append("svg").attr("x",i[0]).attr("y",i[1]).on("click",function(){e.redo()});n.append("rect").attr("width",50).attr("height",50).attr("rx",5).attr("ry",5).attr("fill",t.s);n.append("path").attr("d","M 15 50 Q 15 85 50 85 Q 85 85 85 50 Q 85 15 50 15").attr("transform","translate(50,0)scale(-0.5,0.5)").style("stroke",t.q).style("stroke-width","6").style("stroke-linejoin","round").style("stroke-linecap","round").style("fill","none");n.append("path").attr("d","M 50 10 L 50 20 L 40 15 L 50 10 Z").attr("transform","translate(50,0)scale(-0.5,0.5)").style("stroke",t.q).style("stroke-width","6").style("stroke-linejoin","round").style("stroke-linecap","round").style("fill",t.q)};return d3.rebind(o,e,"on")};gmath.ui=gmath.ui||{};gmath.ui.Redo=Redo;Scroll=function(t,e){var r=d3.dispatch("focus","scroll");var n=null,i=null,o=null,a=[0,0],s=false,l=42,h=null,u=false;var c=function(t){n=t;d();return this};c.pos=function(t){a=t;if(i){i.attr("x",a[0]).attr("y",a[1])}return this};var d=function(){var s=mtouch_events().frame(n.node()).on("drag",function(){r.focus();f()}).on("release",g).call(e.tx_behavior());i=n.append("svg").attr("x",a[0]).attr("y",a[1]);i.append("rect").attr("width",50).attr("height",84).attr("fill","none");i.append("rect").attr("x",20).attr("y",2).attr("width",10).attr("height",80).attr("rx",5).attr("ry",5).attr("fill",t.s);o=i.append("circle").attr("cx",25).attr("cy",42).attr("r",15).attr("fill",t.q).attr("stroke",t.s).attr("stroke-width",3).call(s)};var p=function(t,e){return Math.pow(Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2),.5)};var f=function(){var t=d3.event.finger.pos.slice();if(p(t,a)>200&&u){g()}else{l=t[1]-a[1];if(l<17)l=17;if(l>67)l=67;o.attr("cy",l)}if(!s){s=true;h=setInterval(function(){var t=42-l,n=e.scroll()+t;if(n>0)n=0;e.scroll(n);r.scroll(n)},20)}};var g=function(){o.attr("cy",42);s=false;clearInterval(h)};return d3.rebind(c,r,"on")};gmath.ui=gmath.ui||{};gmath.ui.Scroll=Scroll;Download=function(t){var e=d3.dispatch("download");var r=null,n=null,i=[0,0];var o=function(t){r=t;a();return this};o.pos=function(t){i=t;if(n){n.attr("x",i[0]).attr("y",i[1])}return this};var a=function(){n=r.append("svg").attr("x",i[0]).attr("y",i[1]).on("click",function(){e.download()});n.append("rect").attr("width",50).attr("height",50).attr("rx",5).attr("ry",5).attr("fill",t.s);n.append("path").attr("d","M 35 10 L 35 50 L 15 50 L 50 90 L 85 50 L 65 50 L 65 10 L 35 10 Z").attr("transform","scale(0.5)").style("stroke",t.q).style("stroke-width","6").style("stroke-linejoin","round").style("stroke-linecap","round").style("fill","none")};return d3.rebind(o,e,"on")};gmath.ui=gmath.ui||{};gmath.ui.Download=Download;Upload=function(t){var e=d3.dispatch("upload","focus");var r=null,n=null,i=[0,0];var o=function(t){r=t;a();return this};o.pos=function(t){i=t;if(n){n.attr("x",i[0]).attr("y",i[1])}return this};var a=function(){d3.select("html").append("input").attr("id","upload").attr("type","file").style("display","none");d3.select("#upload").node().addEventListener("change",s);n=r.append("svg").attr("x",i[0]).attr("y",i[1]).on("click",function(){e.focus();l()});n.append("rect").attr("width",50).attr("height",50).attr("rx",5).attr("ry",5).attr("fill",t.s);n.append("path").attr("d","M 35 10 L 35 50 L 15 50 L 50 90 L 85 50 L 65 50 L 65 10 L 35 10 Z").attr("transform","scale(0.5) rotate(180 50 50)").style("stroke",t.q).style("stroke-width","6").style("stroke-linejoin","round").style("stroke-linecap","round").style("fill","none")};var s=function(t){var r=t.target.files[0];if(!r.name.match(/\.json$/)){console.log("Uploading requires a .JSON file.");return}else{var n=new FileReader;n.onload=function(t){return function(t){e.upload(JSON.parse(t.target.result))}}(r);n.readAsText(r)}};var l=function(){d3.select("#upload").node().click()};return d3.rebind(o,e,"on")};gmath.ui=gmath.ui||{};gmath.ui.Upload=Upload;HWRUI=function(t){var e=d3.dispatch("hwr");var r=null,n=null,i=[0,0],o=true,a=false;var s=function(t){r=t;h();return this};s.pos=function(t){if(!arguments.length)return i;i=t.slice();if(n)n.attr("transform","translate("+i+")");return s};s.animating=function(t){if(!arguments.length)return a;if(a===t)return s;a=t;if(a)n.call(l);else n.interrupt().attr("transform","translate("+i+")").transition();return s};var l=function(t){var e=t.node().getBBox();var r=" "+e.width/2+" "+e.height/2;
t.transition().duration(100).attr("transform","translate("+i+")rotate(-5"+r+")").each("end",n);function n(){t.transition().duration(200).attr("transform","translate("+i+")rotate(5"+r+")").transition().duration(200).attr("transform","translate("+i+")rotate(-5"+r+")").each("end",n)}};s.state=function(r){if(!arguments.length)return o;o=r;if(n){n.select("rect").attr("fill",o?t.s:t.t)}e.hwr(o);return s};s.toggle=function(){s.state(!o)};var h=function(){n=r.append("g").attr("transform","translate("+i+")").on("click",s.toggle).style("cursor","pointer");n.append("rect").attr("width",50).attr("height",50).attr("rx",5).attr("ry",5).attr("fill",o?t.s:"silver");n.append("text").text("HWR").attr("x",25).attr("y",30).attr("font-family","arial").attr("text-anchor","middle").attr("fill",t.q)};return d3.rebind(s,e,"on")};gmath.ui=gmath.ui||{};gmath.ui.HWRUI=HWRUI;DrawEraseToggle=function(t){var e=d3.dispatch("mode","focus");var r=null,n=0,i=0,o="M 10 30 L 30 30 L 30 10 L 70 10 L 70 30 L 90 30 L 80 90 L 20 90 L 10 30 Z",a="M 30 90 Q 10 90 10 110 L 10 180 L 90 180 L 90 110 Q 90 90 70 90 L 30 90 Z",s="M 35 33 L 35 55 L 65 55 L 65 17 L 35 33 Z",l="M 30 90 Q 10 90 10 110 L 10 180 L 90 180 L 90 110 Q 90 90 70 90 L 67 90 L 67 55 L 33 55 L 33 90 L 30 90 Z",h=["M 16 40 Q 14 42 15 45 L 52 78 Q 54 80 58 78 L 88 65 Q 89 62 86 59 L 86 57 Z","M 13 19 L 43 11 L 88 37 L 54 48 L 13 19 Z","M 13 19 L 16 41 L 55 74 L 87 61 L 88 37 L 54 48 L 13 19 Z"],u=null,c=null,d=null,p=true;var f=function(t){r=t;g();return this};f.pos=function(t){if(arguments.length==0)return[n,i];n=t[0];i=t[1];if(r)v(p);return this};function g(){var n=mtouch_events().frame(r.node()).on("tap",function(){e.focus();p=!p;_(p)});u=r.append("svg").call(n);u.append("circle").attr("cx",50).attr("cy",50).attr("r",48).style("fill","whitesmoke").style("stroke","silver").style("stroke-width",1);c=u.append("svg");c.append("path").classed("pathhead",true).attr("d",o).style("fill","black").style("stroke","black").style("stroke-width","6").style("stroke-linejoin","round");c.append("path").classed("pathBody",true).attr("d",a).style("fill",t.q).style("stroke","black").style("stroke-width","6").style("stroke-linejoin","round");d=u.append("svg");d.append("path").attr("d",h[0]).attr("fill",t.t);d.append("path").attr("d",h[1]).attr("fill",t.s);d.append("path").attr("d",h[2]).attr("fill",t.p);_(p)}var v=function(t){u.attr("x",n).attr("y",i);c.attr("x",t?18:22).attr("y",t?21:30);c.selectAll("path").attr("transform",t?"scale(0.3)":"scale(0.2)");d.attr("x",t?47:42).attr("y",t?33:28);d.selectAll("path").attr("transform",t?"scale(0.4)":"scale(0.5)")};var m=function(t){c.select(".pathhead").attr("d",t?s:o);c.select(".pathBody").attr("d",t?l:a)};var _=function(t){m(t);v(t);if(t){e.mode("draw")}else{e.mode("erase")}};return d3.rebind(f,e,"on")};gmath.ui=gmath.ui||{};gmath.ui.DrawEraseToggle=DrawEraseToggle;tryGMCreate=function(t,e,r,n){var i=e.indexOf("tfrac")!==-1;var o=t.insert("svg",".mwe-math-fallback-png-inline").style("overflow","visible").style({width:r,height:n});components=Main({include:[]},o,["100%","100%"]);var a=components.svg;a.options={font_size:20,h_align:"left",v_align:"top",background_color:"none",border_color:"none",history:false,padding:{left:0,right:0,top:0,bottom:0},color:"green",pos:[0,0],id:gmath.uid(),eq:e,standalone:true,no_handles:true,no_history:true,fraction_size_factor:i?.7:1};var s=gmath.uid();var l=new DerivationList(a.node(),options);var h=function(t){console.log(t);var e=t.target;if(typeof e=="undefined"){e=t.action.newTree;console.log("Is this the one where it crashes?")}var r=e.getLastView().getBBox();e.svg2.style({width:r.width+"px",height:r.height+"px"})};l.events.on("change."+s,h);h({target:l})};GMify=function(t){if(t){var e=d3.select("html").append("div").attr("id","gmbanner").style("width","100%").style("height","99px").style("background-color","rgba(245, 245, 245, 1.0)").style("border-bottom","1px green solid").style("position","absolute").style("top",-100).style("left",0).style("z-index",9999);var r=e.append("center");r.append("img").attr("src","http://graspablemath.com/demos/wiki/minilogo.png").style("margin-top","15px");r.append("p").text("Graspable Math").style("color","green").style("font-family","cambria").style("font-size","36px").style("vertical-align","-16px").style("text-shadow","1px 1px silver").style("display","inline");var n=0;var i=setInterval(function(){n+=2;e.style("top",n-100+"px");if(n===100){clearInterval(i)}},1);var o=setTimeout(function(){n=0;var t=setInterval(function(){n+=1;e.style("top",-n+"px");if(n===100){clearInterval(t)}},2);clearTimeout(o)},4e3)}var a=d3.selectAll("code");a.each(function(){var t=d3.select(this);var e=t.html();console.log(e);try{t.html("");tryGMCreate(t,e,"200px","100px")}catch(r){console.log("caught error:",r);console.log("Could not convert code snippet. Tried:",e);console.log(t.node());console.log("")}});var s=d3.selectAll("img.tex");var l=0;coordinator=new DLCoordinator;s.each(function(){var t=d3.select(this),e=t.attr("alt");var r=e.search(/\\begin|\\det|\\overrightarrow|\\cdots|\\cup|\\mid|\\in|_/);if(r!==-1){console.log("cant parse",e);return}e=e.replace(/\s/g,"");e=e.replace(/\\,|\\$|[,.]|/g,"");var n=e.indexOf("tfrac")!==-1;e=e.replace(/\\tfrac/g,"\\frac");try{var i=d3.select(this.parentNode).attr("id","div"+l).style({width:t.style("width"+100),height:t.style("height")+100}).style("overflow","visible").insert("div","img.tex");console.log("width:"+t.style("width")+"height: "+t.style("height"));var o={font_size:20,background_color:"none",border_color:"none",history:false,padding:{left:0,right:0,top:0,bottom:0},pos:["auto","auto"],color:"green",id:gmath.uid(),eq:e,no_handles:true,no_history:true,fraction_size_factor:n?.7:1};var a=function(t){var e=t.callingDl;var r=e.getLastView().getBBox()};var s=gmath.uid();var h=DerivationList.createStandalone("#div"+l,o,function(t){a({callingDl:t})});coordinator.addDL(h);h.events.on("change."+s,a({callingDl:h}));a({callingDl:h});console.log("remove...");t.remove()}catch(u){console.log("caught error:",u);console.log("Could not convert img with alt text:",t.attr("alt"),", tried:",e);console.log(t.node());console.log("");i.remove()}l++});return true};wikiSidebar=function(t){if(d3.select("#wikiBar")[0][0]==null){console.log("ran sidebar");DerivationList.defaultOptions.hoverable=true;var e=document.body,r=document.documentElement;var n=Math.max(e.scrollHeight,e.offsetHeight,r.clientHeight,r.scrollHeight,r.offsetHeight);d3.select("body").append("span").style({postition:"absolute",visibility:"hidden","font-family":"Crimson Text"}).text("gm");d3.select("body").append("span").style({postition:"absolute",visibility:"hidden","font-family":"Crimson Text Italics"}).text("gm");sidebarDiv=d3.select("body").append("div").attr("id","wikiBar").style("width","20%").style("height",n+"px").style("background","white").style("position","absolute").style("top",0).style("right",0).style("z-index",100).style("display","block");var i=sidebarDiv.append("div").style({position:"fixed",top:0,width:"inherit",background:"whitesmoke","text-align":"center"});i.append("img").attr("src","http://graspablemath.com/demos/gm-logo@2.png").style({height:"30px",padding:"8px 8px 8px 16px","vertical-align":"middle"});i.append("span").text("Graspable Math").style({"font-family":"Lato","font-size":"20px","font-weight":"400",color:"#676965",margin:"0",padding:"0","padding-top":"5px","vertical-align":"middle"});var o=sidebarDiv.append("div").style({position:"fixed",top:"45px",width:"inherit",background:"whitesmoke","padding-bottom":"8px","border-bottom":"1px solid #ccc","text-align":"center"});o.append("input").attr("type","text").on("keypress",function(){var t=d3.event.which||d3.event.keyCode;if(t!==13)return;de(this.value);this.value=""}).style({width:"calc(100% - 100px)","font-size":"16px","line-height":"1.5em",color:"gray","max-width":"300px"});o.append("button").text("OK").on("click",function(){var t=o.select("input").node();de(t.value);t.value=""}).style({"margin-left":"5px",width:"50px",display:"inline-block","font-size":"16px","line-height":"1.5em","border-radius":"3px",border:"1px solid silver",height:"30px",cursor:"pointer"});var a=sidebarDiv.append("div").attr("id","resizeDiv").style({position:"absolute",left:"0px",width:"10px",height:n+"px",background:"silver",cursor:"ew-resize"});var s=d3.behavior.drag().on("drag",function(){x=d3.mouse(this.parentNode)[0];var t=d3.select("#wikiBar")[0][0].clientWidth;x=Math.max(250,x*-1+t);ce();sidebarDiv.style("width",x+"px")});a.call(s);var l=d3.select("#wikiBar").insert("svg").style("overflow","visible").style({width:"100px",height:"100px"}).style("position","fixed").style("left",0).style("top",0).attr("id","hovering");l.append("g");d3.select("head").append("style").attr("type","text/css").html("#wikiBar button:hover { background-color: #bbb; }"+"#wikiBar button { background-color: #ddd; }");components=Main({include:["markerssidebar","erase"],drawing:true},"#wikiBar",["100%","100%"]);components.ccontroller.markerRadius(2);markers=components.markerssidebar;erase=components.erase;svg=components.svg;svg.attr("id","wikiMainSvg");svg.style({border:"none","margin-top":"85px"}).style("overflow","visible");wm=components.cmodel;coordinator=new DLCoordinator;coordinator.subscribeToCanvasModel(wm);d3.select("#wikiBar").on("drop",fe);d3.select("#wikiBar").on("dragover",pe);window.onscroll=function(){if(typeof markers!="undefined")markers.pos([d3.select("#wikiBar").node().clientWidth/2-60,$(window).height()-180+document.body.scrollTop])};ce()}else if(d3.select("#wikiBar")[0][0].clientWidth==0){d3.select("#wikiBar").style("width","20%");console.log("shrink");ce()}else if(d3.select("#wikiBar")[0][0].clientWidth>0){d3.select("#wikiBar").style("width","0px");ce()}};function ce(){if(d3.select("#mw-head-base")[0][0]!=null){var t=document.getElementById("mw-head-base").clientWidth;var e=document.getElementById("wikiBar").clientWidth;var r=t-e-40;d3.select("#content").style("width",r+"px")}else{}markers.pos([d3.select("#wikiBar").node().clientWidth/2-60,$(window).height()-180+document.body.scrollTop]);var n=document.body,i=document.documentElement;var o=Math.max(n.scrollHeight,n.offsetHeight,i.clientHeight,i.scrollHeight,i.offsetHeight);d3.select("#wikiBar").style("height",o+"px");d3.select("#resizeDiv").style("height",o+"px")}function de(t){if(!t){console.log("could not get data",data);return}math_str=t.replace(/[.,\s\\]+$/,"");if(math_str.length===0)return;try{verticalPos=document.body.scrollTop+120;wm.createDL({eq:math_str,pos:[100,verticalPos],font_size:24,fraction_size_factor:.9})}catch(e){console.log("could not parse expression because",e)}}function pe(){d3.event.preventDefault()}function fe(){var t=d3.event;t.preventDefault();var e=d3.mouse(svg.node());var r=ge(t.dataTransfer)||ve(t.dataTransfer);if(!r){console.log("could not parse drop data",data);return}r=r.replace(/[.,\s\\]+$/,"");r=r.replace(/\\end{alignat}/g,"");r=r.replace(/\&\\\,/g,"");r=r.replace(/\\\,/g,"");r=r.replace(/\&/g,"");r=r.replace(/\\tfrac/g,"\\frac");r=r.replace(/\\begin{alignat}{[0-9]*}/g,"");r=r.replace(/\\\;/g,"");var n=r.split("\\\\");if(r.length===0)return;var i=0;try{wm.createDL({eq:n[i],pos:e,font_size:24,fraction_size_factor:.9},function(t){a(t)})}catch(o){console.log("could not parse expression",n[i],o)}function a(t){i++;e[1]+=t.dims.height;if(i<n.length){try{wm.createDL({eq:n[i],pos:e,font_size:24,fraction_size_factor:.9},function(t){a(t)})}catch(r){console.log("could not parse expression",n[i],r)}}}}function ge(t){var e=t.getData("text/html");var r=document.createElement("div");var n=d3.select(r).html(e).select("img");return n.size()===1?n.attr("alt"):null}function ve(t){return t.getData("text/plain")}gmath.Tree=t;if(typeof module==="object"&&module.exports){module.exports=gmath}else{this.gmath=gmath}})();