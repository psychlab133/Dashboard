/// Copyright Erik Weitnauer 2015.
gmath.ui.version="0.2.4";gmath.ui.gm_version="0.8.4";gmath.ui=gmath.ui||{};gmath.ui.Path=function(){var e=function(e,t){this.container=d3.select(e);this.element=null;t=t||{};this.id=t.id||gmath.uid();this.oid=t.oid;this.points=t.points||[];this.color=t.color||"black";this.width=t.width||1;this.type=t.type;this.init()};e.prototype.toJSON=function(){return{id:this.id,type:"Path",points:this.points,color:this.color,width:this.width}};e.line=typeof d3==="undefined"||typeof d3.svg==="undefined"?null:d3.svg.line();e.prototype.init=function(){var e=null;if(this.oid)e="#"+this.oid;this.element=this.container.insert("path",e).attr("id",this.id).style("fill","none").style("stroke-linecap","round").style("stroke-linejoin","round");return this.update()};e.prototype.update=function(){this.element.attr("d",e.line(this.points)+(this.points.length===1?"Z":"")).style("stroke",this.color).style("stroke-width",this.width);return this};e.prototype.remove=function(){this.element.remove();return this};e.prototype.setContainer=function(e){if(arguments.length===0)return this.container;this.container=e;return this};e.prototype.renderOnto=function(e){var t=this.element,n=this.container;this.container=e;this.element=e.select("#"+this.id);if(this.element.empty())this.init();else this.update();this.container=n;this.element=t};return e}();gm_erase_paths=function(){function e(e,t,n){n=n||20;var a=[];var i=function(e){var i=t[0][0];var r=t[0][1];var o=0;var l=0;if(e.length===1){if(!s(e[0][0],e[0][1],i,r,n)){a.push(e);return}}var c;while(o<e.length-1){var d=e[o];var h=e[o+1];var f=s(d[0],d[1],i,r,n);var m=s(h[0],h[1],i,r,n);if(f&&m){o++;l=o}else if(f&&!m){var y=p(d[0],d[1],h[0],h[1],i,r,n);if(y){e[o]=y;l=o}else{o++}}else if(!f&&m){var y=p(h[0],h[1],d[0],d[1],i,r,n);if(y){c=e.slice(l,o+1);c.push(y);a.push(c)}o++;l=o}else{var g=u(d[0],d[1],h[0],h[1],i,r,n);if(g){c=e.slice(l,o+1);if(c[c.length-1][0]!==g[0][0]||c[c.length-1][1]!==g[0][1]){c.push(g[0])}if(c.length>1)a.push(c);e[o]=g[1];if(e[o+1]&&e[o+1][0]==g[1][0]&&e[o+1][1]==g[1][1])o++;l=o}else{o++}}}if(l!==o){c=e.slice(l,e.length);if(c){a.push(c)}}};var o=function(e,i){if(e.path){n=n+e.width/2;var e=e.path}var r=t[i];var o=t[i+1];var i=0;var s=0;if(e.length===1){var l=c(e[0][0],e[0][1],r[0],r[1],o[0],o[1],n);if(l.indexOf(1)===-1){a.push(e);return}}var d;while(i<e.length-1){var p=e[i];var u=e[i+1];var l=c(p[0],p[1],r[0],r[1],o[0],o[1],n);var h=c(u[0],u[1],r[0],r[1],o[0],o[1],n);if(l.indexOf(1)!==-1&&h.indexOf(1)!==-1){i++;s=i}else if(l.indexOf(1)!==-1&&h.indexOf(1)===-1){var y=f(p[0],p[1],l,u[0],u[1],r[0],r[1],o[0],o[1],n);if(y){e[i]=y;s=i}else{i++}}else if(l.indexOf(1)===-1&&h.indexOf(1)!==-1){var y=f(u[0],u[1],h,p[0],p[1],r[0],r[1],o[0],o[1],n);if(y){d=e.slice(s,i+1);d.push(y);a.push(d);i++;s=i}else{i++}}else{var g=m(p[0],p[1],u[0],u[1],r[0],r[1],o[0],o[1],n);if(g){d=e.slice(s,i+1);if(d[d.length-1][0]!==g[0][0]||d[d.length-1][1]!==g[0][1]){d.push(g[0])}if(d.length>1)a.push(d);e[i]=g[1];if(e[i+1]&&e[i+1][0]==g[1][0]&&e[i+1][1]==g[1][1])i++;s=i}else{i++}}}if(s!==i){d=e.slice(s,e.length);if(d){a.push(d)}}};t=r({path:t});if(t.length===1){for(var l=0;l<e.length;l++){i(e[l])}e=a}else{for(var d=0;d<t.length-1;d++){for(var l=0;l<e.length;l++){o(e[l],d)}e=a;a=[]}}for(var h=0;h<e.length;h++){for(var y=0;y<e[h].length;y++){e[h][y][0]=Math.round(e[h][y][0]);e[h][y][1]=Math.round(e[h][y][1])}}return e}function t(e){if(e.path){var e=e.path}document.write("[");for(var t=0;t<e.length-1;t++){document.write("["+e[t][0]+","+e[t][1]+"],")}document.write("["+e[t][0]+","+e[t][1]+"]");document.write("]")}function n(e){document.write("[");for(var n=0;n<e.length-1;n++){t(e[n]);document.write(",<br />")}t(e[n]);document.write("]")}function a(e,t){if(e.path){var e=e.path}var n="";n+="[";for(var a=0;a<e.length-1;a++){n+="["+e[a][0]+","+e[a][1]+"],"}n+="["+e[a][0]+","+e[a][1]+"]";n+="]";if(t){console.log(n)}else{return n}}function i(e){log="";log+="[";for(var t=0;t<e.length-1;t++){log+=a(e[t],0);log+=","}log+=a(e[t],0);log+="]";console.log(log)}function r(e){if(e.path){var e=e.path}var t=[];if(e.length===1){t=e}else{pClean=0;while(pClean<e.length-1){if(e[pClean][0]!==e[pClean+1][0]||e[pClean][1]!==e[pClean+1][1]){t.push(e[pClean])}pClean++}if(e.length!==0&&t.length===0){t.push(e[0])}if(e[e.length-1][0]!==e[t.length-1][0]||e[e.length-1][1]!==e[t.length-1][1]){t.push(e[pClean])}}return t}function o(e,t,n,a){return Math.sqrt(Math.pow(n-e,2)+Math.pow(a-t,2))}function s(e,t,n,a,i){var r=o(e,t,n,a);if(r<i)return 1;else return 0}function l(e,t,n,a,i,r,o){var s=[i-n,r-a];var l=[e-n,t-a];var c=[-s[1],s[0]];var d=Math.sqrt(Math.pow(c[0],2)+Math.pow(c[1],2));var p=[c[0]/d,c[1]/d];var u=Math.sqrt(Math.pow(s[0],2)+Math.pow(s[1],2));var h=[s[0]/u,s[1]/u];var f=l[0]*h[0]+l[1]*h[1];if(f<=0||f>=u)return 0;var m=l[0]*p[0]+l[1]*p[1];if(m>=o||m<=-o)return 0;return 1}function c(e,t,n,a,i,r,o){var c=[];c.push(s(e,t,n,a,o));c.push(s(e,t,i,r,o));c.push(l(e,t,n,a,i,r,o));return c}function d(e,t,n,a,i){var r=[n-e,a-t];var o=[-r[1],r[0]];var s=Math.sqrt(Math.pow(o[0],2)+Math.pow(o[1],2));var l=[o[0]/s,o[1]/s];var c=[e+i*l[0],t+i*l[1]];var d=[e-i*l[0],t-i*l[1]];var p=[n-i*l[0],a-i*l[1]];var u=[n+i*l[0],a+i*l[1]];return[c,d,p,u]}function p(e,t,n,a,i,r,o){var s=[i-e,r-t];var l=[n-e,a-t];var c=Math.sqrt(Math.pow(l[0],2)+Math.pow(l[1],2));var d=[l[0]/c,l[1]/c];var p=s[0]*d[0]+s[1]*d[1];var u=[e+p*d[0],t+p*d[1]];var h=Math.sqrt(Math.pow(i-u[0],2)+Math.pow(r-u[1],2));var f;if(h===0){f=o}else{var f=Math.sqrt(Math.pow(o,2)-Math.pow(h,2))}var m=[e+p*d[0]+f*d[0],t+p*d[1]+f*d[1]];if(m[0]===e&&m[1]===t)return null;return m}function u(e,t,n,a,i,r,o){var s=[i-e,r-t];var l=[n-e,a-t];var c=[-l[1],l[0]];var d=Math.sqrt(Math.pow(c[0],2)+Math.pow(c[1],2));var p=[c[0]/d,c[1]/d];var u=s[0]*p[0]+s[1]*p[1];var h=v([e,t],[n,a],[i,r]);var f=y([h[0]-i,h[1]-r]);if(f>=o)return null;var m=Math.sqrt(Math.pow(o,2)-Math.pow(u,2));var g=[i-u*p[0],r-u*p[1]];var _=Math.sqrt(Math.pow(l[0],2)+Math.pow(l[1],2));var b=[l[0]/_,l[1]/_];var w=[[g[0]-b[0]*m,g[1]-b[1]*m],[g[0]+b[0]*m,g[1]+b[1]*m]];if(w[0][0]===e&&w[0][1]===t)return null;return w}function h(e,t,n,a,i,r,o,s){var l,c,d,p;l=n-e;c=a-t;d=o-i;p=s-r;var u,h;if(-d*c+l*p===0)return null;u=(-c*(e-i)+l*(t-r))/(-d*c+l*p);h=(d*(t-r)-p*(e-i))/(-d*c+l*p);if(u>=0&&u<=1&&h>=0&&h<=1){var f=e+h*l;var m=t+h*c;return[f,m]}return null}function f(e,t,n,a,i,r,s,l,c,f){var m=d(r,s,l,c,f);var y=[];if(n[0]&&!n[1]){y.push(p(e,t,a,i,r,s,f));y.push(h(e,t,a,i,m[0][0],m[0][1],m[3][0],m[3][1]));y.push(h(e,t,a,i,m[1][0],m[1][1],m[2][0],m[2][1]));var g=u(e,t,a,i,l,c,f);if(g)y.push(g[0],g[1])}else if(!n[0]&&n[1]){y.push(p(e,t,a,i,l,c,f));y.push(h(e,t,a,i,m[0][0],m[0][1],m[3][0],m[3][1]));y.push(h(e,t,a,i,m[1][0],m[1][1],m[2][0],m[2][1]));var g=u(e,t,a,i,r,s,f);if(g)y.push(g[0],g[1])}else if(n[0]&&n[1]){y.push(p(e,t,a,i,r,s,f));y.push(h(e,t,a,i,m[0][0],m[0][1],m[3][0],m[3][1]));y.push(h(e,t,a,i,m[1][0],m[1][1],m[2][0],m[2][1]));y.push(p(e,t,a,i,l,c,f))}else{var g=u(e,t,a,i,l,c,f);var v=u(e,t,a,i,r,s,f);if(g)y.push(g[0],g[1]);if(v)y.push(v[0],v[1]);y.push(h(e,t,a,i,m[0][0],m[0][1],m[3][0],m[3][1]));y.push(h(e,t,a,i,m[1][0],m[1][1],m[2][0],m[2][1]))}var _=[e,t];for(var b=0;b<y.length;b++){if(y[b]){if(o(y[b][0],y[b][1],a,i)<o(_[0],_[1],a,i)){_=y[b]}}}if(_[0]===e&&_[1]===t)return null;return _}function m(e,t,n,a,i,r,s,l,c){var p=d(i,r,s,l,c);var f=[];var m=u(e,t,n,a,i,r,c);if(m)f.push(m[0],m[1]);m=u(e,t,n,a,s,l,c);if(m)f.push(m[0],m[1]);f.push(h(e,t,n,a,p[0][0],p[0][1],p[3][0],p[3][1]));f.push(h(e,t,n,a,p[1][0],p[1][1],p[2][0],p[2][1]));var y=[n,a];var g=[e,t];for(var v=0;v<f.length;v++){if(f[v]){if(o(f[v][0],f[v][1],e,t)<o(y[0],y[1],e,t)){y=f[v]}}}for(var _=0;_<f.length;_++){if(f[_]){if(o(f[_][0],f[_][1],n,a)<o(g[0],g[1],n,a)){g=f[_]}}}if(y[0]===n&&y[1]===a||g[0]===e&&g[1]===t)return null;else return[y,g]}var y=function(e){return Math.sqrt(e[0]*e[0]+e[1]*e[1])};var g=1e-6;var v=function(e,t,n){var a=[t[0]-e[0],t[1]-e[1]],i=y(a);if(i<g)return e;var r=[n[0]-e[0],n[1]-e[1]];var o=(a[0]*r[0]+a[1]*r[1])/i;if(o<0)return e;if(o>i)return t;return[e[0]+a[0]*o/i,e[1]+a[1]*o/i]};if(typeof exports!="undefined"){exports.erase=e}return e}();gm_hwr_request=function(){var e=function(e){var t={type:"stroke",x:[],y:[]};e.points.forEach(function(e){t.x.push(e[0]);t.y.push(e[1])});return t};var t=function(t,n){url="http://dlandy.psych.indiana.edu:7031/server.js";var a={components:t.map(e),resultTypes:["LATEX"]};var i={apiKey:"c26d2755-1fda-4033-b136-4af042f3f9db",equationInput:JSON.stringify(a)};var r=$.post(url,i.equationInput);r.done(function(e){var t=e.replace(/\\/g,"\\\\");t=JSON.parse(t);n(null,t.JSON)})};return t}();gmath.ui=gmath.ui||{};gmath.ui.holdUI=function(){var e=function(e,t){this.container=d3.select("body");this.controller=e;this.view=t;this.element=null;this.pos=[0,0];this.visible=false;this.buttons=[];this.button_els=null;this.colors=d3.scale.category10();this.button_rads=null;this.inner_radius=20;this.outer_radius=80;this.init()};e.prototype.setPos=function(e){this.pos=e;this.element.style({left:e[0]+"px",top:e[1]+"px"})};e.prototype.setVisible=function(e){this.visible=e;this.element.style("display",e?null:"none")};e.prototype.init=function(){var e=this,t={stroke:"black","stroke-width":1,"stroke-linecap":"round",fill:"none"};if(gmath.array.includes(this.controller.hold_menu_options(),"derivation")){this.buttons.push({action:function(t){e.controller.inputDL(t,"holdUI")},icon:function(e){var t=e.append("g").attr("transform","translate(0,10)").append("g");var n=new gmath.AlgebraModel("f_x",{});var a=new gmath.AlgebraView(n,t,{font_size:"35",inactive_color:"black",interactive:false});a.init();return t},color:e.colors(0)})}if(gmath.array.includes(this.controller.hold_menu_options(),"graph")){this.buttons.push({action:function(t){var n={pos:{x:t[0],y:t[1]}};e.view.createGraph(n)},icon:function(e){var n=e.append("g").attr("transform","translate(2,0)").style("cursor","pointer");var a=n.append("g").style("opacity",.5).style("shape-rendering","crispedges");a.append("line").attr({x1:-15,y1:0,x2:15,y2:0}).style(t);a.append("line").attr({x1:0,y1:-15,x2:0,y2:15}).style(t);a.append("rect").attr({x:-15,y:-15,width:30,height:30}).style(t);n.append("line").attr({x1:-15,y1:8,x2:15,y2:-8}).style(t).style("stroke-width",1.5);return n},color:e.colors(1)})}if(gmath.array.includes(this.controller.hold_menu_options(),"textbox")){this.buttons.push({action:function(t){var n={pos:{x:t[0],y:t[1]}};e.view.createTextBox(n)},icon:function(e){var n=e.append("g");var a=n.append("g").style("opacity",.5);a.append("text").text("Aa").attr({x:0,y:10}).style("text-anchor","middle").style("font-size","30px").style(t).style("fill","black").style("pointer-events","none");return n},color:e.colors(2)})}this.button_rads=Math.PI*2/this.buttons.length;var n=this.button_rads,a=this.inner_radius,i=this.outer_radius;this.element=this.container.append("svg").style("overflow","visible").style("display","none").style("position","absolute");this.g=this.element.append("g");var r=this.element.append("defs"),o=r.append("filter").attr("id","dropShadow_holdUI");o.append("feGaussianBlur").attr("in","SourceAlpha").attr("stdDeviation",3);o.append("feOffset").attr("dx",0).attr("dy",4).attr("result","offsetblur");o.append("feComponentTransfer").append("feFuncA").attr("type","linear").attr("slope",.25);var s=o.append("feMerge");s.append("feMergeNode");s.append("feMergeNode").attr("in","SourceGraphic");this.element.attr("filter","url(#dropShadow_holdUI)");this.button_els=this.g.selectAll(".holdUI").data(this.buttons);this.button_els.enter().append("g").classed("holdUI",true).append("path").attr("d",function(e,t){var r=Math.cos(n*t)*a,o=-Math.sin(n*t)*a,s=Math.cos(n*t)*i,l=-Math.sin(n*t)*i,c=Math.cos(n*(t+1))*i,d=-Math.sin(n*(t+1))*i,p=Math.cos(n*(t+1))*a,u=-Math.sin(n*(t+1))*a;return"M"+r+","+o+"L"+s+","+l+"A"+i+","+i+" 0 0,0 "+c+","+d+"L"+p+","+u+"A"+a+","+a+" 0 0,1 "+r+","+o+"Z"}).style("fill",function(e){return e.color}).style("opacity",.8).style("cursor","pointer");this.button_els.each(function(e,t){var r=d3.select(this),o=e.icon(r);o.attr("transform",function(){var e=Math.cos(n*(t+.5))*(a+(i-a)/2),r=-Math.sin(n*(t+.5))*(a+(i-a)/2);return"translate("+e+", "+r+")"})})};e.prototype.detectHit=function(e){var t=this,n=this.button_rads,a=this.inner_radius,i=this.outer_radius,r=-1;this.button_els.each(function(o,s){var l=Math.sqrt(Math.pow(e[0]-t.pos[0],2)+Math.pow(e[1]-t.pos[1],2)),c=Math.atan2(-e[1]+t.pos[1],e[0]-t.pos[0]);if(c<0)c+=Math.PI*2;if(l>a&&l<i&&c>n*s&&c<n*(s+1))r=s});return r};e.prototype.highlight=function(e){var t=this.detectHit(e);this.button_els.each(function(e,n){var a=d3.select(this).select("path");if(t===n)a.transition().duration(30).style("fill",d3.rgb(e.color).brighter(.6));else a.transition().duration(30).style("fill",e.color)})};e.prototype.performAction=function(e,t){var n=this.detectHit(e);this.button_els.each(function(e,a){if(a===n)e.action(t)})};return e}();gmath.ui=gmath.ui||{};gmath.ui.CanvasController=function(){var e=function(e){var t=d3.dispatch("scroll","start_hwr","stop_hwr","undone","redone","hold","touch","drag","release","font_size","keyboard","entered_term","start-of-interaction","end-of-interaction");var n=gmath.uid(),a=e,i=null,r=[],o=-1,s=null,l=false,c=null,d=false,p=true,u,h=1500,f=null,m=a.paths().length,y=2,g=50,v=null,_="black",b=null,w=null,x=0,k=null,E=null,T=false,C=null,M=false,D=true,A=true,z="hold",q=["derivation","textbox","graph"],I=null,L=800;var S=function(){e.on("create."+n,function(e){if(e.target_type==="derivation"||e.target_type==="graph"||e.target_type==="textbox"||e.target_type==="image"){e.target.events.on("start-of-interaction."+n,function(e){P();t["start-of-interaction"](e)});e.target.events.on("end-of-interaction."+n,function(e){t["end-of-interaction"](e)});if(e.target_type==="derivation"){e.target.events.on("auto_undo."+n,function(e){setTimeout(function(){oe(e)},1)})}}});if(A&&!C&&a.container()){C=new gmath.ui.holdUI(S,a)}K(e.background_event_layer(),X());K(e.foreground_event_layer(),Y());e.on("mode."+n,F);d3.select(document).on("keydown."+n,O.bind(this,null));if(D&&typeof gmath.ui.Keyboard!=="undefined"&&typeof $!=="undefined"){c=gmath.ui.Keyboard();c.width(L).position("center")()}a.container().on("dragover",function(){d3.event.preventDefault()}).on("drop",ce);return this};function O(e){var t=e||d3.event;if(t.keyCode===27){if(I){S.cancelInsertElementOnNextClick()}else{P();a.setActive(null,false)}}}S.insertElementOnNextClick=function(e){S.simulateStartOfInteraction();a.foreground_event_layer_visible(true);I=e;a.foreground_event_layer().style("cursor","copy")};S.cancelInsertElementOnNextClick=function(e){if(!I)return;I=null;if(a.getMode()!=="draw"&&a.getMode()!=="erase"){a.foreground_event_layer_visible(false)}a.foreground_event_layer().style("cursor","auto");if(e)S.simulateEndOfInteraction()};var B=function(e){var t=false;switch(I){case"derivation":S.inputDL([e.x,e.y],"toolbar");break;case"textbox":a.createTextBox({pos:e});t=true;break;case"graph":a.createGraph({pos:e});t=true;break;case"table":a.createElement("table",{pos:e});t=true;break;default:console.warn("unknown element type",I)}S.cancelInsertElementOnNextClick(t)};function F(e){P();if(e.mode==="draw"||e.mode==="erase"){a.foreground_event_layer_visible(true);a.setActive(null)}else{a.foreground_event_layer_visible(false)}}function P(){window.getSelection().removeAllRanges()}S.id=n;S.logger=function(e){i=e;i.events.on("interaction."+n,this.addInteractionSummaryToTimeline.bind(this))};S.model=function(){if(arguments.length===0)return a};S.use_keyboard=function(e){if(arguments.length===0)return D;D=e;return this};S.keyboard_max_width=function(e){if(arguments.length===0)return L;L=e;return this};S.use_hold_menu=function(e){if(arguments.length===0)return A;if(Array.isArray(e)){S.hold_menu_options(e.filter(function(e){return q.indexOf(e)!==-1}))}A=Array.isArray(e)?true:e;if(A&&!C&&a.container()){C=new gmath.ui.holdUI(S,a)}return this};S.hold_menu_options=function(e){if(arguments.length===0)return q;q=e};S.color=function(e){if(arguments.length===0)return _;_=e;return this};S.markerRadius=function(e){if(arguments.length===0)return y;y=e;return this};S.eraserRadius=function(e){if(arguments.length===0)return g;g=e;return this};S.hwr_delay=function(e){if(arguments.length===0)return h;h=e;return this};S.tx_behavior=function(){return w};S.hwr=function(e){if(!arguments.length)return p;if(p===e)return S;p=e;m=a.paths.length;if(!p)S.cancelHWR();return S};S.drawing=function(e){if(!arguments.length)return u;u=e;return this};S.scheduleHWR=function(){if(!f){f=setTimeout(S.performHWR,h);t.start_hwr()}};S.cancelHWR=function(e){if(!e)m=a.paths.length;if(f){clearTimeout(f);f=null;t.stop_hwr()}};S.performHWR=function(){f=null;t.stop_hwr();if(m>a.paths().length-1)return;var e=a.paths().slice(m),n=false,i=[];gm_hwr_request(e,function(t,r){if(t)console.log(t);var o=e[0].points[0];try{n=a.createDL({pos:{x:o[0],y:o[1]},eq:r})}catch(s){return}var l=function(e){try{a.removePath(e);i.push(e)}catch(t){return}};for(var c=0;c<e.length;c++){l(e[c])}m=a.paths().length});m=a.paths().length};S.scroll=function(e){if(arguments.length===0)return x;x=Math.min(0,e);w.transform({translate:[0,x]});a.paths_container().attr("transform","translate(0,"+x+")");a.dls_container().attr("transform","translate(0,"+x+")");t.scroll(x);return this};S.font_smaller=function(){var e=parseInt(DerivationList.defaultOptions.font_size);if(e/1.2>12)this.set_font_size(e/1.2)};S.font_larger=function(){var e=parseInt(DerivationList.defaultOptions.font_size);if(e*1.2<160)this.set_font_size(e*1.2)};S.set_font_size=function(e){DerivationList.defaultOptions.font_size=e;a.dls().forEach(function(t){t.options.font_size=e;t.rows.forEach(function(t){t.view.options.font_size=e;t.view.update_all(true);t.updateHandlePos(true)});t.hideAllNodeMappings();t.layoutRows()});t.font_size(new W(e))};var j=function(e){return a.createPath({points:[[e[0],e[1]-x]],color:a.setMode()==="draw"?_:"white",width:a.setMode()==="draw"?2*y:2*g})};var R=function(e){this.type="hold";this.subType=e.subType;this.performee=n;this.performee_type="CanvasController";this.time=Date.now();this.finger={pos:[e.finger.pos[0],e.finger.pos[1]]};this.fingers=e.fingers.map(function(e){return{pos:[e.pos[0],e.pos[1]]}})};var N=function(e){this.type="touch";this.subType=e.subType;this.performee=n;this.performee_type="CanvasController";this.time=Date.now();this.finger={pos:[e.finger.pos[0],e.finger.pos[1]],pos0:[e.finger.pos0[0],e.finger.pos0[1]]};this.fingers=e.fingers.map(function(e){return{pos:[e.pos[0],e.pos[1]]}})};var G=function(e){this.type="drag";this.subType=e.subType;this.performee=n;this.performee_type="CanvasController";this.time=Date.now();this.finger={pos:[e.finger.pos[0],e.finger.pos[1]]};this.fingers=e.fingers.map(function(e){return{pos:[e.pos[0],e.pos[1]]}})};var H=function(e){this.type="release";this.subType=e.subType;this.performee=n;this.performee_type="CanvasController";this.time=Date.now();this.finger={pos:[e.finger.pos[0],e.finger.pos[1]]};this.fingers=e.fingers.map(function(e){return{pos:[e.pos[0],e.pos[1]]}})};var W=function(e){this.type="fontSize";this.performee=n;this.performee_type="CanvasController";this.time=Date.now();this.font_size=e};var U=function(e){this.type="enteredTerm";this.performee=n;this.performee_type="CanvasController";this.time=Date.now();this.eq=e.eq;this.dl_id=e.id;this.options=gmath.deepCopy(e)};var V=function(e){this.type="enteredGraph";this.performee=n;this.performee_type="CanvasController";this.time=Date.now();this.graph_id=e};var J=function(){this.type="keyboard";this.performee=n;this.performee_type="CanvasController";this.time=Date.now()};function K(e,t){e.call(t);t.frame(e.node())}function X(){var e=transform_behavior().allow_rotate(false).allow_scale(false).one_finger_drag(false).on("transform",function(){scroll(d3.event.transform.translate[1])});if(z==="hold"){var t=mtouch_events().on("touch",Q.bind(this,null)).on("hold",Z.bind(this,null)).on("drag",ee.bind(this,null)).on("tap",function(){a.setActive(null)}).on("release",te.bind(this,null)).hold_max_dist(5).hold_time(500).call(e)}else if(z==="tap"){var t=mtouch_events().on("tap",function(){if(!A)return;if(C.visible)te();else{Z();C.element.attr("pointer-events","none")}}).hold_max_dist(5).hold_time(500).call(e)}return t}function Y(){var e=transform_behavior().allow_rotate(false).allow_scale(false).one_finger_drag(false).on("transform",function(){scroll(d3.event.transform.translate[1])});var t=mtouch_events().on("touch",ne.bind(this,null)).on("drag",ae.bind(this,null)).on("release",ie.bind(this,null)).hold_max_dist(5).hold_time(500).call(e);return t}var Q=function(e){if(!A||T)return;var a=e||d3.event;if(!e&&d3.event){P();t["start-of-interaction"]({type:"start-of-interaction",source:{type:"CanvasController",id:n},time:Date.now()});t.touch(new N(gmath.extend(d3.event,{subType:"menu"})))}if(a.fingers.length>1){T=true}};S.menu_touch=Q;var Z=function(e){if(!A||T||D&&c.visible())return;var n=e||d3.event;if(!e&&d3.event){t.hold(new R(gmath.extend(d3.event,{subType:"menu"})))}menu_pos=n.finger.pos.slice();C.setPos(n.finger.pos_client.slice());C.setVisible(true)};S.menu_hold=Z;var ee=function(e){if(!A||T)return;var n=e||d3.event;if(!e&&d3.event){t.drag(new G(gmath.extend(d3.event,{subType:"menu"})))}if(C.visible){C.highlight(n.finger.pos_client.slice())}};S.menu_drag=ee;var te=function(e){var a=e||d3.event;if(!e&&d3.event){t.release(new H(gmath.extend(d3.event,{subType:"menu"})))}if(T){if(a.fingers.length===0)T=false;return}if(C&&C.visible){C.performAction(a.finger.pos_client.slice(),menu_pos);C.setVisible(false)}if(!e&&d3.event&&(!c||!c.visible())){t["end-of-interaction"]({type:"end-of-interaction",source:{type:"CanvasController",id:n},time:Date.now()})}};S.menu_release=te;var ne=function(e){if(I)return;var i=e||d3.event;if(!e&&d3.event){t["start-of-interaction"]({type:"start-of-interaction",source:{type:"CanvasController",id:n},time:Date.now()});t.touch(new N(gmath.extend(d3.event,{subType:"draw"})))}if(i.fingers.length>1){T=true}if(!u||T)return;var r=i.finger.pos0.slice();r[1]-=x;S.cancelHWR(true);k=j(i.finger.pos0);if(a.setMode()==="erase"){v=a.paths_container().append("circle").attr({cx:r[0],cy:r[1],r:g}).style({stroke:"silver",fill:"white"})}};S.draw_touch=ne;var ae=function(e){if(I)return;var n=e||d3.event;if(!e&&d3.event){t.drag(new G(gmath.extend(d3.event,{subType:"draw"})))}if(!k||T||!u)return;var i=n.finger.pos.slice();i[1]-=x;k.points.push(i);a.updatePath(k);if(a.setMode()==="erase")v.attr({cx:i[0],cy:i[1]})};S.draw_drag=ae;var ie=function(e){var i=e||d3.event;if(I){B({x:i.finger.pos[0],y:i.finger.pos[1]});return}if(!e&&d3.event){t.release(new H(gmath.extend(d3.event,{subType:"draw"})))}if(T){if(i.fingers.length===0)T=false;return}if(!k)return;if(a.setMode()==="draw"){if(p&&(!c||!c.visible()))S.scheduleHWR()}else if(a.setMode()==="erase"){v.remove();re()}k=null;if(!e&&d3.event){t["end-of-interaction"]({type:"end-of-interaction",source:{type:"CanvasController",id:n},time:Date.now()})}};S.draw_release=ie;var re=function(){var e=a.paths().slice(),t=e[e.length-1],n=[],i=[],r=[];e.forEach(function(e,o){if(e===t)return;var s=g+e.width/2;var l=gm_erase_paths([e.points],t.points,s);if(l.length===0){i.push(e);a.removePath(e)}else{r.push({path:e,points_before:e.points.slice(),points_after:l[0].slice()});e.points=l[0];a.updatePath(e);for(var c=1;c<l.length;c++){var d=a.createPath({points:l[c],color:e.color,width:e.width,oid:e.id});n.push(d)}}});a.removePath(t);eraseModification={removed:i,modified:r,added:n}};S.addInteractionSummaryToTimeline=function(e){var t=Timeline.entry(e,a);if(t){if(t.type==="erase"){t.modification=eraseModification;eraseModification=null}o++;r[o]=t;r.length=o+1}};S.undo=function(){if(o===-1)return false;i.listen(false);var e=r[o];o--;e.undo(a,this);i.listen(true);return true};S.redo=function(){if(r.length<=o+1)return false;i.listen(false);o++;var e=r[o];e.redo(a,this);i.listen(true);return true};function oe(e){r.pop();o--}S.clearInteractionTimeline=function(){o=-1;r=[]};S.clear_undo_queue=function(){throw"(CanvasController) Deprecated method `clear_undo_queue` called."};S.inputDL=function(e,n){if(d)return;t.keyboard(new J);S.cancelHWR(true);E={pos:{x:e[0],y:e[1]-x},v_align:"center",h_align:"equals"};c.caption(null).latex("").on("done",function(e){se(e,n)}).on("cancel",le).visible(true)};var se=function(e,i){if(!E)return;if(e===""){c.visible(false);return}E.eq=e;E.id=gmath.uid();t.entered_term(new U(E));var r;var o=false;try{r=a.createDL(E,null,i);E=null}catch(s){console.log(s);c.warning("Could not parse expression.");return}c.visible(false);t["end-of-interaction"]({type:"end-of-interaction",source:{type:"CanvasController",id:n},time:Date.now()})};var le=function(){c.visible(false);t["end-of-interaction"]({type:"end-of-interaction",source:{type:"CanvasController",id:n},time:Date.now()})};S.disableKeyboard=function(e){d=e};S.simulateStartOfInteraction=function(){t["start-of-interaction"]({type:"start-of-interaction",source:{type:"CanvasController",id:n},time:Date.now()})};S.simulateEndOfInteraction=function(){t["end-of-interaction"]({type:"end-of-interaction",source:{type:"CanvasController",id:n},time:Date.now()})};function ce(){var e=d3.event;e.preventDefault();var i=d3.mouse(this);var r=de(e.dataTransfer)||pe(e.dataTransfer);if(!r){console.log("could not parse drop data",e);var o={drop_evt:e,pos:{x:i[0],y:i[1]}};var s=a.createImage(o,"drag-n-drop");return}if(r.slice(0,4)==="http"){var o={drop_evt:e,pos:{x:i[0],y:i[1]}};var s=a.createImage(o,"drag-n-drop")}else{r=r.replace(/\\end{alignat}/g,"");r=r.replace(/\&\\\,/g,"");r=r.replace(/\\\,/g,"");r=r.replace(/\&/g,"");r=r.replace(/\\begin{alignat}{[0-9]*}/g,"");r=r.replace(/\\\;/g,"");r=r.replace(/[.,\s\\]+$/,"");var l=r.split("\\\\");if(r.length===0)return;try{t["start-of-interaction"]({type:"start-of-interaction",source:{type:"CanvasController",id:n},time:Date.now()});a.createDLs(l,{pos:{x:i[0],y:i[1]}},null,"drag-n-drop");t["end-of-interaction"]({type:"end-of-interaction",source:{type:"CanvasController",id:n},time:Date.now()})}catch(c){console.log("Could not parse equation!",c);var o={drop_evt:e,pos:{x:i[0],y:i[1]}};var s=a.createImage(o,"drag-n-drop")}}}function de(e){var t=e.getData("text/html");var n=document.createElement("div");var a=d3.select(n).html(t).select("img");return a.size()===1?a.attr("alt"):null}function pe(e){return e.getData("text/plain")}return d3.rebind(S,t,"on")};return e}();gmath.ui=gmath.ui||{};gmath.ui.CanvasModelView=function(){var e=function(){var e=d3.dispatch("create","update","remove","reset","mode"),t=null,n,a,i,r,o,s,l,c,d,p=[],u=[],h=[],f=[],m=["edit","inspect","arrange","draw","erase"],y=0;function g(e){e.dl.draw_mappings_for_nodes([e.node])}var v=function(e){t=e;a=t.append("div").style({position:"absolute",left:0,right:0,top:0,bottom:0}).style({overflow:"hidden"});c=a.append("div").style({position:"absolute",left:0,right:0,top:0,bottom:0});n=a.append("svg").style({position:"absolute",width:"100%",height:"100%"}).style("pointer-events","none");o=n.append("g").attr("id","g_graphs");r=n.append("g").attr("id","g_paths");g_imgs=n.append("g").attr("id","g_imgs");s=n.append("g").attr("id","g_textboxes");i=n.append("g").attr("id","g_dls");d=t.append("div").style({position:"absolute",left:0,right:0,top:0,bottom:0}).style({display:"none","pointer-events":"all"});return this};v.setActive=function(e,t){if(arguments.length<2)t=true;if(e)e.setActive(t);p.forEach(function(t){if(t!==e){t.setActive(false);if(t.type==="textbox")t.text_element.node().blur()}})};v.focusOnDL=function(e){e.events.on("end-of-interaction."+this.id,e.initPosition.bind(e,true))};v.createDL=function(t,n,a){var i=new DerivationList(v,this.getContainer("derivation").node(),t,function(e){if(n)setTimeout(n.bind(null,e),1)});i.setMode(m[y]);i.events.on("inspect_node",g);p.push(i);d3.selectAll(".derivation-list").data(v.dls());var r={type:"create",target_type:"derivation",target:i};if(a)r.method=a;e.create(r);return i};function _(e){if(e==="canvas-element")return gmath.CanvasElementClass;if(e==="image")return gmath.ui.CanvasImage;if(e==="textbox")return gmath.ui.TextBox;if(e==="graph")return gmath.ui.Graph;if(e==="derivation")return gmath.DerivationList;if(e==="ggb-panel")return gmath.ui.GeoGebraPanel;if(e==="ggb-element")return gmath.ui.GeoGebraCanvasElement;if(e==="table")return gmath.ui.Table;throw'unkown element type "'+e+'"'}v.getContainer=function(e){if(e==="canvas-element")return a;if(e==="image")return a;if(e==="textbox")return a;if(e==="graph")return o;if(e==="derivation")return a;if(e==="ggb-panel")return a;if(e==="ggb-element")return a;if(e==="table")return a;throw'unkown element type "'+e+'"'};v.createElement=function(t,n,a,i){var r=v.getContainer(t);var o=_(t);var s=new o(v,r.node(),n,function(){if(i)setTimeout(i.bind(null,s),1)});p.push(s);e.create({type:"create",target_type:t,target:s,method:a});return s};v.createImage=function(t,n){var a=new gmath.ui.CanvasImage(v,this.getContainer("image").node(),t);p.push(a);e.create({type:"create",target_type:"image",target:a,method:n});return a};v.createTextBox=function(t,n,a){var i=new gmath.ui.TextBox(v,this.getContainer("textbox").node(),t,n);p.push(i);e.create({type:"create",target_type:"textbox",target:i,method:a});return i};v.addElement=function(t){if(t in p)throw"element is already part of this canvas";b(f,t);t.canvas_model=v;t.initElement(v.getContainer(t.type).node());t.setMode(m[y]);p.push(t);e.create({type:"create",target_type:t.type,target:t});return v};v.addDL=function(t){b(f,t);if(p.indexOf(t)!==-1)throw"dl is already in this model";t.canvas_model=v;t.initElement(this.getContainer("derivation").node());t.setMode(m[y]);t.events.on("inspect_node",g);v.setActive(t);p.push(t);d3.selectAll(".derivation-list").data(v.dls());e.create({type:"create",target_type:"derivation",target:t});return t};v.addImage=function(t){b(f,t);t.canvas_model=v;t.initElement(g_imgs.node());t.setMode(m[y]);p.push(t);e.create({type:"create",target_type:"image",target:t})};v.addTextBox=function(t){b(f,image);t.canvas_model=v;t.initElement(s.node());t.setMode(m[y]);p.push(t);e.create({type:"create",target_type:"textbox",target:t});return t};v.createDLs=function(e,t,n,a){var i=0;r();function r(o){if(i===e.length){if(n)n()}else{if(o)t.pos[1]+=o.dims.height;var s=gmath.deepCopy(t);s.eq=e[i++];v.createDL(s,r,a)}}};v.isInFreeVisibleSpace=function(e,t){var n=this.viewport();if(e.y<n.y||e.y+e.height>n.y+n.height)return false;return this.getIntersectingElements(e,t).length===0};v.getIntersectingElements=function(e,t){return p.filter(function(n){if(t===n)return false;return gmath.HitTester.overlaps(e,n.getBBox())})};v.moveToFreeSpace=function(e,t){var n=e.getBBox(),a=this.viewport(),i={x:a.x,y:a.y,width:n.width,height:n.height},r;while(i.y+i.height<a.y+a.height){while(i.x+i.width<a.x+a.width){r=this.getIntersectingElements(i,e);if(r.length===0){e.translateElement(i,t);return true}else{var o=d3.max(r,function(e){return e.pos.x+e.size.width});i.x=o+1}}i.x=a.x;i.y=i.y+a.height/20}return false};v.createPath=function(t,n){var a=new gmath.ui.Path(r.node(),t);u.push(a);var i={type:"create",target_type:"path",target:a};if(n)i.method=n;e.create(i);return a};v.removePath=function(t){b(u,t);t.remove();e.remove({type:"remove",target_type:"path",target:t})};v.addPath=function(t){if(u.indexOf(t)!==-1)throw"path is already in this model";t.setContainer(r);t.init();u.push(t);e.create({type:"create",target_type:"path",target:t});return t};v.updatePath=function(t){t.update();e.update({target_type:"path",target:t})};v.createGraph=function(t){t.view=v;var n=new gmath.ui.Graph(o.node(),t);h.push(n);e.create({type:"create",target_type:"graph",target:n});return n};v.removeGraph=function(t){b(h,t);t.remove();e.remove({type:"remove",target_type:"graph",target:t})};v.removeElement=function(t){b(p,t);f.push(t);var n=t.removeElement();e.remove({type:"remove",target_type:t.type,target:t});return n};var b=function(e,t){if(e.length===0)return false;var n=e.indexOf(t);
if(n===-1)return false;e.splice(n,1);return true};v.elements=function(){return p};v.dls=function(){return v.getElementsOfType("derivation")};v.graphs=function(){return h};v.textboxes=function(){return v.getElementsOfType("textbox")};v.images=function(){return v.getElementsOfType("image")};v.getElementsOfType=function(e){return p.filter(function(t){return t.type===e})};v.getElementByID=function(e){for(var t=0;t<p.length;t++)if(p[t].id===e)return p[t];for(var t=0;t<u.length;t++)if(u[t].id===e)return u[t]};v.getDeletedElementByID=function(e){for(var t=0;t<f.length;t++)if(f[t].id===e)return f[t]};v.paths=function(t){if(!arguments.length)return u;for(var n=0;n<u.length;n++)u[n].remove();u=t.slice();for(var n=0;n<u.length;n++){u[n].setContainer(r);u[n].init()}e.reset({target_type:"path",target:u.slice()})};v.container=function(){return t};v.background_event_layer=function(e){return c};v.foreground_event_layer=function(e){return d};v.foreground_event_layer_visible=function(e){if(!arguments.length)return d.style("display");d.style("display",e?null:"none")};v.dls_container=function(e){if(!arguments.length)return i;i=e;return this};v.paths_container=function(e){if(!arguments.length)return r;r=e;return this};v.graphs_container=function(e){if(!arguments.length)return o;o=e;return this};v.textboxes_container=function(e){if(!arguments.length)return s;s=e;return this};v.size=function(){var e=t.node();return{width:e.clientWidth,height:e.clientHeight}};v.viewport=function(){var e=t.node().parentNode;return{x:0,width:e.clientWidth,y:e.scrollTop,height:e.clientHeight}};v.getMode=function(){return m[y]};v.setMode=function(t){if(arguments.length===0)return m[y];y=m.indexOf(t);p.forEach(function(e){e.setMode(t)});e.mode({type:"mode",mode:t});return this};return d3.rebind(v,e,"on")};return e}();gmath.ui=gmath.ui||{};gmath.ui.resource_path="../shared/";gmath.ui.CanvasFactory=function(){var e=function(t,n,a){this.id=gmath.uid();this.container=d3.select(t);n=n||{};this.options=gmath.object.merged(gmath.deepCopy(!n.minimal?e.defaultOptions:e.minimalOptions),n);if(gmath.log_ga&&this.options.disable_ga_tracking)gmath.log_ga.enabled(false);this.events=d3.dispatch("button");this.model=gmath.ui.CanvasModelView();this.controller=gmath.ui.CanvasController(this.model).drawing(this.options.drawing).hwr(this.options.hwr).use_keyboard(this.options.use_keyboard).use_hold_menu(this.options.use_hold_menu).keyboard_max_width(this.options.keyboard_max_width);this.init();if(this.options.overflow_visible){this.scroll_div.style("overflow","visible");this.content_div.style("overflow","visible")}if(a&&this.options.savefile_server){this.remove();gmath.CanvasSaver.loadSaveFile(this.container.node(),this.options.savefile_server+"/api/saves/canvas_save_files",a,this.getOptionsForFileLoading())}this.logger=new DataLogger(this,this.options.log_mouse_trajectories);this.controller.logger(this.logger);if(this.options.parse_url_query_params&&!(a&&this.options.savefile_server)){this.parseURLQueryParams()}};gmath.ui.CanvasFactoryClass=e;e.prototype.serialize=function(){return JSON.stringify(this.model.dls().concat(this.model.graphs()))};e.prototype.init=function(){this.outer_div=this.container.append("div").classed("flex-container-columns",true).style({width:this.options.width,height:this.options.height});this.options.toolbar_container=this.options.toolbar_container?d3.select(this.options.toolbar_container):this.outer_div;var e=this;this.tools=this.options.toolbar_container.append("div").attr({"class":"btn-toolbar",role:"toolbar"}).style(this.options.use_toolbar?this.options.toolbar_on_style:this.options.toolbar_off_style);if(this.options.minimal)this.tools.on("mouseenter",function(){if(e.toolFadeoutTimer)clearTimeout(e.toolFadeoutTimer)}).on("mouseleave",this.switchToolbarState.bind(this));if(this.options.drawing){this.options.mode_btns.splice(3,0,{type:"radio",group:"draw",state:false,label:"draw",icon:"glyphicon glyphicon-pencil"},{type:"radio",group:"draw",state:false,label:"erase",icon:"glyphicon glyphicon-erase"})}if(this.options.mode_btns)this.appendButtonGroup(this.options.mode_btns,this.onButton);if(this.options.reset_btn)this.appendButtonGroup([this.options.reset_btn],this.onButton);if(this.options.undo_btn||this.options.redo_btn){var t=[];if(this.options.undo_btn)t.push(this.options.undo_btn);if(this.options.redo_btn)t.push(this.options.redo_btn);this.appendButtonGroup(t,this.onButton)}if(this.options.font_smaller_btn&&this.options.font_larger_btn){var n=[];n.push(this.options.font_smaller_btn);n.push(this.options.font_larger_btn);this.appendButtonGroup(n,this.onButton)}if(this.options.help_btn){if(this.options.minimal)this.options.help_btn.pull_right=false;var a=[];a.push(this.options.help_btn);this.appendButtonGroup(a,this.onButton)}if(this.options.saving_and_loading){if(this.options.save_btn&&this.options.load_btn&&this.options.share_btn)this.appendButtonGroup([this.options.save_btn,this.options.load_btn,this.options.share_btn],this.onButton);else if(this.options.save_btn&&this.options.load_btn)this.appendButtonGroup([this.options.save_btn,this.options.load_btn],this.onButton)}if(this.options.feedback&&this.options.feedback_btn){this.appendButtonGroup([this.options.feedback_btn],this.onButton)}gmath.ui.addInsertButton(this);gmath.ui.addMacroButton(this);if(this.options.minimal){this.tools.classed("btn-toolbar-minimal",true);var i=this.tools.append("div").attr("class","btn-group pull-right").style({"line-height":"26px","margin-left":"40px"});i.append("span").text("powered by").style({"font-style":"italic","font-family":"sans-serif",color:"#909090","font-weight":300,"font-size":"13px"});var r=i.append("a").style({"text-decoration":"none"}).attr({href:"http://graspablemath.com",target:"_blank"});r.append("img").attr({alt:"GM",src:this.options.logo_src}).style({"vertical-align":"-0.3em",height:"1.7em","margin-left":"0.8em","margin-right":"0.2em","font-size":"13px"})}var o=this.tools.node().getBoundingClientRect().height;if(o===0&&this.options.use_toolbar)o={xs:46,sm:64}[this.options.btn_size]||72;this.scroll_div=this.options.toolbar_pos==="top"?this.outer_div.append("div"):this.outer_div.insert("div","div.btn-toolbar");this.scroll_div.classed("gm-canvas",true).style("width",this.options.width).style("flex",1).style("-webkit-flex",1).style("position","relative").style("overflow-y",this.options.vertical_scroll?"scroll":"hidden");this.content_div=this.scroll_div.append("div").style("width","100%").style("min-height",this.options.vertical_scroll?"200%":"100%").style("position","absolute").call(this.model);this.controller();if(this.options.vertical_scroll){this.scroll_div.on("scroll",this.adjustCanvasSize.bind(this));this.adjustCanvasSize(true)}if(this.options.minimal&&this.options.static_toolbar)this.switchToolbarState(true)};e.prototype.showHint=function(e,t){var n=this.model;if(n.dls().length>0&&!this.options.always_show_initial_hint)return;var a={pos:{x:-1e3,y:-1e3},size:{width:220,height:0},text:e,closable:true,uneditable:true,static_bg:true,text_align:"center",dont_log_events:true,font_size:16,resizable:false};var i=n.createTextBox(a,function(e){var t=n.viewport();e.translateElement({x:t.x+t.width/2-e.size.width/2,y:t.y+t.height/2-e.size.height/2})});if(t){n.on("create.gm-inital-hint",function(){if(n.textboxes().indexOf(i)>=0)i.fade();n.on("create.gm-initial-hint",null)})}};e.prototype.parseURLQueryParams=function(){var e=gmath.getURLParameter("eq");if(e){e=e.split(";");this.controller.simulateStartOfInteraction();for(var t=0;t<e.length;t++){this.model.createDL({eq:e[t],pos:{x:200+350*t,y:100}},null,"URL")}this.controller.simulateEndOfInteraction()}};e.prototype.adjustCanvasSize=function(e){var t=this.scroll_div.node().getBoundingClientRect().height;var n=this.content_div.node().getBoundingClientRect().height;var a=this.scroll_div.property("scrollTop");if(!this.scroll_top)this.scroll_top=a;if(e){var i=Math.round(n/t);this.content_div.style("height",t*i+"px")}if(a>this.scroll_top){if(n-a<t){var i=Math.round(n/t)+1;this.content_div.style("height",t*i+"px")}}else if(a<this.scroll_top){if(n-a>=2*t&&this.noObjectsHiddenBelowView(a)){var i=Math.round(n/t)-1;this.content_div.style("height",t*i+"px")}}this.scroll_top=a};e.prototype.noObjectsHiddenBelowView=function(e){var t=[];t=this.model.dls().concat(this.model.graphs()).concat(this.model.textboxes()).concat(this.model.paths());if(t.length===0)return true;for(var n=0;n<t.length;n++){var a=t[n];if(a.pos){if(Array.isArray(a.pos)&&a.pos[1]>e)return false;else if(a.pos.y>e)return false}else if(a.points&&a.points[0][1]>e)return false}return true};e.prototype.switchToolbarState=function(e,t){if(!this.options.use_toolbar)return;var n=this;if(e){n.turnOnToolbar()}else{if(t)n.turnOffToolbar();else{n.toolFadeoutTimer=setTimeout(function(){n.turnOffToolbar()},n.options.toolFadeoutDelay)}}};e.prototype.turnOnToolbar=function(){if(this.toolFadeoutTimer){clearTimeout(this.toolFadeoutTimer);this.toolFadeoutTimer=null}this.tools.style(this.options.toolbar_on_style);this.toolbarOn=true};e.prototype.turnOffToolbar=function(){if(this.toolFadeoutTimer){clearTimeout(this.toolFadeoutTimer);this.toolFadeoutTimer=null}this.tools.style(this.options.toolbar_off_style);this.toolbarOn=false};e.prototype.resize=function(e){this.options.width=e.width;this.options.height=e.height;this.scroll_div.style({width:this.options.width,height:this.options.height});this.tools.style({width:this.options.width})};e.prototype.onButton=function(e){var t={mode:this.model.setMode()==="inspect"?"scrub":this.model.setMode(),font_size:DerivationList.defaultOptions.font_size};this.updateButton(e);if(e.label==="reset"){if(this.logger.canvas_logger.containsPendingEvents(this.logger.canvas_logger.interactionSequence)){this.logger.canvas_logger.submitCurrentSequence()}if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","reset",1);while(this.controller.undo()){}}if(e.label==="undo"){if(this.logger.canvas_logger.containsPendingEvents(this.logger.canvas_logger.interactionSequence)){this.logger.canvas_logger.submitCurrentSequence()}this.controller.undo();if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","undo",1)}if(e.label==="redo"){if(this.logger.canvas_logger.containsPendingEvents(this.logger.canvas_logger.interactionSequence)){this.logger.canvas_logger.submitCurrentSequence()}if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","redo",1);this.controller.redo()}if(e.label==="HWR"){if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","hwr",1);this.controller.hwr(e.state)}if(e.label==="transform"){if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","transform",1);this.model.setMode("edit")}if(e.label==="scrub"){if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","scrub",1);this.model.setMode("inspect")}if(e.label==="arrange"){if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","arrange",1);this.model.setMode("arrange")}if(e.label==="draw"){if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","draw",1);this.model.setMode("draw")}if(e.label==="erase"){if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","erase",1);this.model.setMode("erase")}if(e.label==="help"){if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","help",1);this.help()}if(e.label==="feedback"){if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","feedback",1);this.sendFeedback()}if(e.label==="fullscreen"&&e.state===true){if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","start fullscreen",1);this.launchFullScreen()}if(e.label==="fullscreen"&&e.state===false){if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","stop fullscreen",1);this.cancelFullScreen()}if(!(e.label==="HWR"&&e.state===true)&&this.options.hwr===true){if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","cancel HWR",1);this.controller.cancelHWR()}if(e.label==="larger"){if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","font larger",1);this.controller.font_larger()}if(e.label==="smaller"){if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","font smaller",1);this.controller.font_smaller()}if(e.label==="save"){gmath.CanvasSaver.save(this);if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","save",1)}if(e.label==="load"){this.remove();gmath.CanvasSaver.load(this.container.node(),null,this.getOptionsForFileLoading());if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","load",1)}if(e.label==="share"&&!this.publishing){this.publishConfirmation();if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","publish",1)}var n={button:{label:e.label,state:e.state,type:e.type},old_state:t,time:Date.now()};if(n.button.label==="larger"||n.button.label==="smaller")n.button.font_size=DerivationList.defaultOptions.font_size;this.events.button(n)};e.prototype.getOptionsForFileLoading=function(){return{parse_url_query_params:false,disable_ga_tracking:this.options.disable_ga_tracking,gm_app_name:this.options.gm_app_name,savefile_server:this.options.savefile_server,log_mouse_trajectories:this.options.log_mouse_trajectories}};e.prototype.showSaveError=function(e){var t=d3.select("#publish-share-panel"),n=t.select("div");n.classed("alert-danger",true);t.classed("panel-default",false).classed("panel-danger",true);var a=this;n.selectAll("p").remove();n.append("p").html("Sorry, we could not share the canvas.</br>Reason: "+e);if(e.indexOf("too big")===-1){n.append("p").text("Please save your work locally and try again later. Make sure you are connected to the internet!")}else{n.append("p").text("We currently don't support uploading this much data. Please save your work locally instead.")}n.append("button").property("type","button").classed("btn btn-default",true).text("Ok").on("click",function(){t.remove();a.publishing=false})};e.prototype.publishConfirmation=function(){this.publishing=true;var e=this;var t=this.scroll_div.append("div").classed("panel panel-default",true).attr("id","publish-share-panel").style({width:"500px",position:"absolute",right:"20px",top:"20px"});var n=t.append("div").classed("panel-body",true);n.append("h3").text("Share your math!");n.append("p").text('Click the "Publish" button to save your work on the Graspable Math server.'+"  We'll give you a key so you or anyone else can get a copy.");n.append("button").property("type","button").classed("btn btn-default",true).classed("pull-right",true).text("Cancel").on("click",function(){t.remove();e.publishing=false});n.append("button").property("type","button").classed("btn btn-primary",true).text("Publish").on("click",function(){n.remove();n=t.append("div").classed("panel-body",true);n.append("p").text("Working...");gmath.CanvasSaver.share(e.options.savefile_server+"/saves/canvas_save_files",e,function(t,n){if(t)e.showSaveError(t.reason);else e.noSaveError(n)})})};e.prototype.noSaveError=function(e){var t=d3.select("#publish-share-panel"),n=t.select("div");var a=this;n.selectAll("p").remove();n.append("h3").text("Here is your link:");n.append("div").classed("share_link",true).append("input").attr({type:"text"}).on("click",function(){this.select();this.setSelectionRange(0,this.value.length)}).on("input",function(){this.value=location.origin+location.pathname+"?load="+e;this.select();this.setSelectionRange(0,this.value.length)}).node().value=location.origin+location.pathname+"?load="+e;n.append("p").text("Keep this link for yourself or share it with others. It will always "+"point to the canvas as it is right now. Click the share button again if you "+"want to create a new link to an updated version.");n.append("button").property("type","button").classed("btn btn-primary",true).text("Done").on("click",function(){t.remove();a.publishing=false})};e.prototype.launchFullScreen=function(e){e=e||document.body;if(e.requestFullscreen)e.requestFullscreen();else if(e.mozRequestFullScreen)e.mozRequestFullScreen();else if(e.webkitRequestFullscreen)e.webkitRequestFullscreen();else if(e.msRequestFullscreen)e.msRequestFullscreen()};e.prototype.help=function(){var e=window.open("http://graspablemath.com/unstable/tutorial/index.html","_blank");e.focus()};e.prototype.sendFeedback=function(){var e=window.open("mailto:contact@graspablemath.com","_blank");e.focus()};e.prototype.cancelFullScreen=function(){if(document.exitFullscreen)document.exitFullscreen();else if(document.mozCancelFullScreen)document.mozCancelFullScreen();else if(document.webkitExitFullscreen)document.webkitExitFullscreen();else if(document.msExitFullscreen)document.msExitFullscreen()};e.prototype.updateButton=function(e){this.tools.select("button#"+e.label).datum(e).each(function(e){if(e.type==="toggle"){e.state=!e.state;d3.select(this).classed("active",e.state)}else if(e.type==="radio"){var t=this;d3.select(this.parentNode).selectAll("button").each(function(e){e.state=t===this}).classed("active",function(e){return e.state})}})};e.prototype.appendButtonElement=function(e,t){var n=this;var a=e.append("button").attr("id",function(e){return e.label}).attr({type:"button","class":"btn btn-default"}).classed("btn-xs",n.options.btn_size==="xs").classed("btn-sm",n.options.btn_size==="sm").classed("active",function(e){return e.state}).style("min-width","4em");a.filter(function(e){return e.type==="dropdown"}).classed("toggle-dropdown",true).attr("data-toggle","dropdown").attr("aria-haspopup","true").attr("aria-expanded","false");if(t)a.call(mtouch_events().on("touch",t.bind(this)));if(this.options.display_icons){var i=a.filter(function(e){return e.icon});i.append("i").attr("class",function(e){return e.icon}).style({color:"#555","font-size":"1.2em","line-height":"1.7em"}).style("padding-left",function(e){return e.type==="dropdown"?"0.25em":null}).style("transform",function(e){return e.flip==="x"?"rotateX(180deg)":e.flip==="y"?"rotateY(180deg)":e.flip==="xy"?"rotateZ(180deg)":null});var r=i.filter(function(e){return e.type==="dropdown"});r.append("span").html("&nbsp;");r.append("span").classed("caret",true);i.append("br")}if(this.options.display_labels){a.append("span").text(function(e){return e.label}).style("color","#555");if(!this.options.display_icons){var r=a.filter(function(e){return e.type==="dropdown"});r.append("span").html("&nbsp;");r.append("span").classed("caret",true)}}};e.prototype.appendButtonGroup=function(e,t,n){var a=n?this.tools.insert("div","*"):this.tools.append("div");a.attr({"class":"btn-group",role:e[0].group}).classed("pull-right",e[0].pull_right);var i=a.selectAll("button").data(e);i.enter().call(this.appendButtonElement.bind(this),t);if(e.length===1&&e[0].type==="dropdown"){var r=e[0].html_fn(a.node(),e[0]);d3.select(r).attr("aria-labelledby",e[0].label).classed("dropdown-menu",true)}return i};e.prototype.remove=function(){this.tools.remove();this.outer_div.remove()};e.minimalOptions={width:"100%",height:"100%",vertical_scroll:false,toolbar_pos:"top",static_toolbar:true,undo_btn:{type:"push",label:"undo",icon:"glyphicon glyphicon-chevron-left"},redo_btn:{type:"push",label:"redo",icon:"glyphicon glyphicon-chevron-right"},use_keyboard:false,use_hold_menu:false,drawing:false,display_icons:true,display_labels:false,btn_size:"xs",toolbar_on_style:{display:"inline-block",position:"absolute","margin-top":"-35px",padding:"5px","padding-right":"10px",background:"rgba(255, 255, 255, 0.901961)","border-radius":"3px"},toolbar_off_style:{display:"none"},toolFadeoutDelay:500,logo_src:"../shared/imgs/gm-logo.png",overflow_visible:true};e.defaultOptions={width:"100%",height:"100%",vertical_scroll:true,parse_url_query_params:false,toolbar_pos:"top",undo_btn:{type:"push",label:"undo",icon:"glyphicon glyphicon-chevron-left"},redo_btn:{type:"push",label:"redo",icon:"glyphicon glyphicon-chevron-right"},font_smaller_btn:{type:"push",label:"smaller",icon:"glyphicon glyphicon-text-size",flip:"y"},font_larger_btn:{type:"push",label:"larger",icon:"glyphicon glyphicon-text-size"},help_btn:{type:"push",label:"help",pull_right:true,icon:"glyphicon glyphicon-question-sign"},hwr_btn:{type:"toggle",label:"HWR",pull_right:true,state:true,icon:"glyphicon glyphicon-font"},fullscreen_btn:{type:"toggle",label:"fullscreen",pull_right:true,state:false,icon:"glyphicon glyphicon-resize-full"},hwr:false,feedback_btn:{type:"push",label:"feedback",pull_right:true,icon:"glyphicon glyphicon-envelope"},feedback:false,disable_ga_tracking:false,gm_app_name:"canvas factory",use_keyboard:true,use_hold_menu:true,drawing:true,display_icons:true,display_labels:true,btn_size:"sm",mode_btns:[{type:"radio",group:"mode",state:true,label:"transform",icon:"glyphicon glyphicon-random"},{type:"radio",group:"mode",state:false,label:"scrub",icon:"glyphicon glyphicon-wrench"},{type:"radio",group:"mode",state:false,label:"arrange",icon:"glyphicon glyphicon-move"}],use_toolbar:true,toolbar_on_style:{"margin-bottom":"10px"},toolbar_off_style:{display:"none"},toolFadeoutDelay:0,save_btn:{type:"push",label:"save",pull_right:true,icon:"glyphicon glyphicon-save"},load_btn:{type:"push",label:"load",pull_right:true,icon:"glyphicon glyphicon-open"},savefile_server:"http://127.0.0.1:7010",share_btn:{type:"push",label:"share",pull_right:true,icon:"glyphicon glyphicon-send"},saving_and_loading:true,log_mouse_trajectories:false,keyboard_max_width:800};return e}();gmath.ui.addInsertButton=function(){var e=[{label:"select one and click on the canvas",header:true},{label:"Math Expression",value:"derivation",icon:"imgs/menu-icons/sqrt-x.png"},{label:"Text",value:"textbox",icon:"imgs/menu-icons/text.png"},{label:"Graph",value:"graph",icon:"imgs/menu-icons/graph.png"},{label:"Table",value:"table",icon:null}];var t;function n(e){t=e;t.appendButtonGroup([{type:"dropdown",label:"insert",icon:"glyphicon glyphicon-plus-sign",html_fn:i}],a,true)}function a(){t.controller.cancelInsertElementOnNextClick()}function i(t,n){var a=d3.select(t).append("ul");var i=a.selectAll("li").data(e).enter();var o=i.append("li");var s=o.filter(function(e){return e.header});var l=o.filter(function(e){return!e.header});s.classed("dropdown-header",true).text(function(e){return e.label});var c=l.append("a").attr("href","#").on("click",function(e){d3.event.preventDefault();r(e)});c.filter(function(e){return e.icon}).append("img").style({"vertical-align":"bottom",position:"relative",height:"1.8em",left:"-0.5em",top:"0.15em",opacity:.5}).attr("src",function(e){return gmath.ui.resource_path+e.icon});c.filter(function(e){return!e.icon}).append("span").style({display:"inline-block","vertical-align":"bottom",position:"relative",height:"1.8em",left:"-0.5em",top:"0.15em",width:"1.8em"});c.append("span").text(function(e){return e.label});return a.node()}function r(e){t.controller.insertElementOnNextClick(e.value)}return n}();gmath.ui.addMacroButton=function(){var e=[{title:"Test Macro",math:"a+a ==> 2a",json:'{"type":"DerivationList","rows":[{"id":"_b2f641e270829106","type":"DerivationRow","dl":"_60b0b7180d55e27a","action":null,"model":{"id":"_aa989a23f65ed688","type":"AlgebraModel","options":{"no_history":false},"children":[{"id":"_bf4559cfeee8e040","value":"sum","type":"Expression","name":"sum","bp":20,"associative":false,"commutative":false,"vertical_notation":false,"selected":false,"dragging":false,"locked":false,"hidden":false,"rs":null,"parent":"_aa989a23f65ed688","children":[{"id":"_ad7f50521ffa6cce","value":"add","type":"Expression","name":"add-sub","bp":20,"associative":true,"commutative":true,"vertical_notation":false,"selected":false,"dragging":false,"locked":false,"hidden":false,"rs":"_56b962ed7087dc3a","parent":"_bf4559cfeee8e040","children":[{"id":"_8443e3fa213c88a3","value":"+","type":"Expression","name":"sym","selected":false,"dragging":false,"locked":false,"hidden":true,"rs":"_fce69f8b30b6381b","parent":"_ad7f50521ffa6cce","children":[]},{"id":"_fce69f8b30b6381b","value":"a","type":"Expression","name":"var","bp":100,"selected":false,"dragging":false,"locked":false,"hidden":false,"ls":"_8443e3fa213c88a3","rs":null,"parent":"_ad7f50521ffa6cce","children":[]}]},{"id":"_56b962ed7087dc3a","value":"add","type":"Expression","name":"add-sub","bp":20,"associative":true,"commutative":true,"vertical_notation":false,"selected":false,"dragging":false,"locked":false,"hidden":false,"ls":"_ad7f50521ffa6cce","rs":null,"parent":"_bf4559cfeee8e040","children":[{"id":"_eeeb1b357e07e13c","value":"+","type":"Expression","name":"sym","selected":false,"dragging":false,"locked":false,"hidden":false,"rs":"_347f0671dcd1d609","parent":"_56b962ed7087dc3a","children":[]},{"id":"_347f0671dcd1d609","value":"a","type":"Expression","name":"var","bp":100,"selected":false,"dragging":false,"locked":false,"hidden":false,"ls":"_eeeb1b357e07e13c","rs":null,"parent":"_56b962ed7087dc3a","children":[]}]}]}]},"row_idx":0},{"id":"_ff8b07e7445ccd18","type":"DerivationRow","dl":"_60b0b7180d55e27a","action":"_089f451a7eebe432","model":{"id":"_29cd9ed0999680fd","type":"AlgebraModel","options":{"no_history":false,"locked":true},"children":[{"id":"_ce9d47619435a043","value":"product","type":"Expression","name":"product","bp":30,"associative":false,"commutative":false,"vertical_notation":false,"selected":false,"locked":true,"hidden":false,"simplify":false,"parent":"_29cd9ed0999680fd","children":[{"id":"_7144dcbabf4e69e8","value":"mul","type":"Expression","name":"mul-div","bp":30,"associative":true,"commutative":true,"vertical_notation":false,"selected":false,"locked":true,"hidden":false,"rs":"_df7f8cde81cd8023","parent":"_ce9d47619435a043","children":[{"id":"_a966b33b6a5b96b0","value":"*","type":"Expression","name":"sym","selected":false,"locked":true,"hidden":true,"rs":"_ce5f4722b1fbf3e9","parent":"_7144dcbabf4e69e8","children":[]},{"id":"_ce5f4722b1fbf3e9","value":2,"type":"Expression","name":"num","selected":false,"locked":true,"hidden":false,"precision":2,"ls":"_a966b33b6a5b96b0","rs":null,"parent":"_7144dcbabf4e69e8","children":[]}]},{"id":"_df7f8cde81cd8023","value":"mul","type":"Expression","name":"mul-div","bp":30,"associative":true,"commutative":true,"vertical_notation":false,"selected":false,"locked":true,"hidden":false,"ls":"_7144dcbabf4e69e8","rs":null,"parent":"_ce9d47619435a043","children":[{"id":"_1d30d7174062785a","value":"*","type":"Expression","name":"sym","selected":false,"locked":true,"hidden":true,"rs":"_9f47e8efdee09d45","parent":"_df7f8cde81cd8023","children":[]},{"id":"_9f47e8efdee09d45","value":"a","type":"Expression","name":"var","bp":100,"selected":false,"locked":true,"hidden":false,"ls":"_1d30d7174062785a","parent":"_df7f8cde81cd8023","children":[]}]}]}]},"row_idx":1}],"options":{"pos":{"x":550,"y":100},"eq":"a+a","v_align":"center","h_align":"equals","padding":{"left":20,"right":5,"top":5,"bottom":5},"font_size":50,"modes":["edit","inspect","arrange"],"no_history":false,"id":"_60b0b7180d55e27a"},"pos":{"x":550,"y":100},"pack_state":[false,false]}'},{title:"Quadratic Formula",math:"ax^2+bx+c=0  =>  x=(-b(b^2-4ac)^(1/2)/(2a)",json:'{"type":"DerivationList","rows":[{"id":"_4410a24c7fe2592d","type":"DerivationRow","dl":"_b3dc98fd9c9b598c","action":null,"model":{"id":"_38db82fe796acf1c","type":"AlgebraModel","options":{"no_history":false},"children":[{"id":"_0b5b8aeef939d4b0","value":"equals","type":"Expression","name":"equals","bp":10,"associative":false,"commutative":false,"vertical_notation":false,"selected":false,"dragging":false,"locked":false,"hidden":false,"rs":null,"parent":"_38db82fe796acf1c","children":[{"id":"_de6045dd6468a7ce","value":"sum","type":"Expression","name":"sum","bp":20,"associative":false,"commutative":false,"vertical_notation":false,"selected":false,"dragging":false,"locked":false,"hidden":false,"rs":"_d32ec2415d2eb477","parent":"_0b5b8aeef939d4b0","children":[{"id":"_1c8fe7270c868d72","value":"add","type":"Expression","name":"add-sub","bp":20,"associative":true,"commutative":true,"vertical_notation":false,"selected":false,"dragging":false,"locked":false,"hidden":false,"rs":"_994dc133491bbb55","parent":"_de6045dd6468a7ce","children":[{"id":"_2b0417051bf2ff3f","value":"+","type":"Expression","name":"sym","selected":false,"dragging":false,"locked":false,"hidden":true,"rs":"_1d1b5dc9a68fbed3","parent":"_1c8fe7270c868d72","children":[]},{"id":"_1d1b5dc9a68fbed3","value":"product","type":"Expression","name":"product","bp":30,"associative":false,"commutative":false,"vertical_notation":false,"selected":false,"dragging":false,"locked":false,"hidden":false,"ls":"_2b0417051bf2ff3f","rs":null,"parent":"_1c8fe7270c868d72","children":[{"id":"_ffa72012f92bfa25","value":"mul","type":"Expression","name":"mul-div","bp":30,"associative":true,"commutative":true,"vertical_notation":false,"selected":false,"dragging":false,"locked":false,"hidden":false,"rs":"_1280480a09011d26","parent":"_1d1b5dc9a68fbed3","children":[{"id":"_bd6ccd0a6df8216b","value":"*","type":"Expression","name":"sym","selected":false,"dragging":false,"locked":false,"hidden":true,"rs":"_fa6c57a7f8141767","parent":"_ffa72012f92bfa25","children":[]},{"id":"_fa6c57a7f8141767","value":"a","type":"Expression","name":"var","bp":100,"selected":false,"dragging":false,"locked":false,"hidden":false,"ls":"_bd6ccd0a6df8216b","rs":null,"parent":"_ffa72012f92bfa25","children":[]}]},{"id":"_1280480a09011d26","value":"mul","type":"Expression","name":"mul-div","bp":30,"associative":true,"commutative":true,"vertical_notation":false,"selected":false,"dragging":false,"locked":false,"hidden":false,"ls":"_ffa72012f92bfa25","rs":null,"parent":"_1d1b5dc9a68fbed3","children":[{"id":"_9376e5be8876c95c","value":"*","type":"Expression","name":"sym","selected":false,"dragging":false,"locked":false,"hidden":true,"rs":"_72e3410a2eadcee7","parent":"_1280480a09011d26","children":[]},{"id":"_72e3410a2eadcee7","value":"power","type":"Expression","name":"power","bp":50,"associative":false,"commutative":false,"vertical_notation":false,"selected":false,"dragging":false,"locked":false,"hidden":false,"ls":"_9376e5be8876c95c","rs":null,"parent":"_1280480a09011d26","children":[{"id":"_2d32620ee7c869aa","value":"x","type":"Expression","name":"var","bp":100,"selected":false,"dragging":false,"locked":false,"hidden":false,"rs":"_7d0ce7c62125bb4e","parent":"_72e3410a2eadcee7","children":[]},{"id":"_7d0ce7c62125bb4e","value":"exponent","type":"Expression","name":"exponent","bp":50,"associative":false,"commutative":false,"vertical_notation":true,"selected":false,"dragging":false,"locked":false,"hidden":false,"ls":"_2d32620ee7c869aa","rs":null,"parent":"_72e3410a2eadcee7","children":[{"id":"_990b7702498d2c9a","value":2,"type":"Expression","name":"num","selected":false,"dragging":false,"locked":false,"hidden":false,"precision":2,"rs":null,"parent":"_7d0ce7c62125bb4e","children":[]}]}]}]}]}]},{"id":"_994dc133491bbb55","value":"add","type":"Expression","name":"add-sub","bp":20,"associative":true,"commutative":true,"vertical_notation":false,"selected":false,"dragging":false,"locked":false,"hidden":false,"ls":"_1c8fe7270c868d72","rs":"_81918c41d1cf2e18","parent":"_de6045dd6468a7ce","children":[{"id":"_78dc0e8e0235deff","value":"+","type":"Expression","name":"sym","selected":false,"dragging":false,"locked":false,"hidden":false,"rs":"_8879e5d8e04d1a39","parent":"_994dc133491bbb55","children":[]},{"id":"_8879e5d8e04d1a39","value":"product","type":"Expression","name":"product","bp":30,"associative":false,"commutative":false,"vertical_notation":false,"selected":false,"dragging":false,"locked":false,"hidden":false,"ls":"_78dc0e8e0235deff","rs":null,"parent":"_994dc133491bbb55","children":[{"id":"_3c8521c6f4e6aa7b","value":"mul","type":"Expression","name":"mul-div","bp":30,"associative":true,"commutative":true,"vertical_notation":false,"selected":false,"dragging":false,"locked":false,"hidden":false,"rs":"_f4ab953edaff69cb","parent":"_8879e5d8e04d1a39","children":[{"id":"_1ceae2e69aae87f7","value":"*","type":"Expression","name":"sym","selected":false,"dragging":false,"locked":false,"hidden":true,"rs":"_4cbbb118ff3c5ceb","parent":"_3c8521c6f4e6aa7b","children":[]},{"id":"_4cbbb118ff3c5ceb","value":"b","type":"Expression","name":"var","bp":100,"selected":false,"dragging":false,"locked":false,"hidden":false,"ls":"_1ceae2e69aae87f7","rs":null,"parent":"_3c8521c6f4e6aa7b","children":[]}]},{"id":"_f4ab953edaff69cb","value":"mul","type":"Expression","name":"mul-div","bp":30,"associative":true,"commutative":true,"vertical_notation":false,"selected":false,"dragging":false,"locked":false,"hidden":false,"ls":"_3c8521c6f4e6aa7b","rs":null,"parent":"_8879e5d8e04d1a39","children":[{"id":"_d32959633cd61f95","value":"*","type":"Expression","name":"sym","selected":false,"dragging":false,"locked":false,"hidden":true,"rs":"_a33f15d1cf0ad15e","parent":"_f4ab953edaff69cb","children":[]},{"id":"_a33f15d1cf0ad15e","value":"x","type":"Expression","name":"var","bp":100,"selected":false,"dragging":false,"locked":false,"hidden":false,"ls":"_d32959633cd61f95","rs":null,"parent":"_f4ab953edaff69cb","children":[]}]}]}]},{"id":"_81918c41d1cf2e18","value":"add","type":"Expression","name":"add-sub","bp":20,"associative":true,"commutative":true,"vertical_notation":false,"selected":false,"dragging":false,"locked":false,"hidden":false,"ls":"_994dc133491bbb55","rs":null,"parent":"_de6045dd6468a7ce","children":[{"id":"_1195d93eaa2051f3","value":"+","type":"Expression","name":"sym","selected":false,"dragging":false,"locked":false,"hidden":false,"rs":"_0308c4dfcbecb41a","parent":"_81918c41d1cf2e18","children":[]},{"id":"_0308c4dfcbecb41a","value":"c","type":"Expression","name":"var","bp":100,"selected":false,"dragging":false,"locked":false,"hidden":false,"ls":"_1195d93eaa2051f3","rs":null,"parent":"_81918c41d1cf2e18","children":[]}]}]},{"id":"_d32ec2415d2eb477","value":"=","type":"Expression","name":"sym","selected":false,"dragging":false,"locked":false,"hidden":false,"ls":"_de6045dd6468a7ce","rs":"_a8565f319889c659","parent":"_0b5b8aeef939d4b0","children":[]},{"id":"_a8565f319889c659","value":0,"type":"Expression","name":"num","selected":false,"dragging":false,"locked":false,"hidden":false,"precision":2,"ls":"_d32ec2415d2eb477","rs":null,"parent":"_0b5b8aeef939d4b0","children":[]}]}]},"row_idx":0},{"id":"_09d8c1016885c748","type":"DerivationRow","dl":"_b3dc98fd9c9b598c","action":"_43261e2669cc4e06","model":{"id":"_a2c98ed02d88047e","type":"AlgebraModel","options":{"no_history":false,"locked":true},"children":[{"id":"_48c1a7c79e2cb6e0","value":"equals","type":"Expression","name":"equals","bp":10,"associative":false,"commutative":false,"vertical_notation":false,"selected":false,"locked":true,"hidden":false,"parent":"_a2c98ed02d88047e","children":[{"id":"_8acf789c86df8369","value":"x","type":"Expression","name":"var","bp":100,"selected":false,"locked":true,"hidden":false,"rs":"_5ec6dedf25dcdb64","parent":"_48c1a7c79e2cb6e0","children":[]},{"id":"_5ec6dedf25dcdb64","value":"=","type":"Expression","name":"sym","selected":false,"locked":true,"hidden":false,"ls":"_8acf789c86df8369","rs":"_e3ab65fea7091adc","parent":"_48c1a7c79e2cb6e0","children":[]},{"id":"_e3ab65fea7091adc","value":"fraction","type":"Expression","name":"product","bp":30,"associative":false,"commutative":false,"vertical_notation":true,"selected":false,"locked":true,"hidden":false,"ls":"_5ec6dedf25dcdb64","rs":null,"parent":"_48c1a7c79e2cb6e0","children":[{"id":"_921124965eabc3c0","value":"mul","type":"Expression","name":"mul-div","bp":30,"associative":true,"commutative":true,"vertical_notation":false,"selected":false,"locked":true,"hidden":false,"rs":"_a77091d36e58b4bf","parent":"_e3ab65fea7091adc","children":[{"id":"_5a63574f4c923940","value":"*","type":"Expression","name":"sym","selected":false,"locked":true,"hidden":true,"rs":"_a073bc395d177c4b","parent":"_921124965eabc3c0","children":[]},{"id":"_a073bc395d177c4b","value":"brackets","type":"Expression","name":"brackets","bp":0,"associative":false,"commutative":false,"vertical_notation":false,"selected":false,"locked":true,"hidden":false,"ls":"_5a63574f4c923940","parent":"_921124965eabc3c0","children":[{"id":"_b4e1f06435859404","value":"(","type":"Expression","name":"sym","selected":false,"locked":true,"hidden":true,"rs":"_0f516c4b247555d6","parent":"_a073bc395d177c4b","children":[]},{"id":"_0f516c4b247555d6","value":"sum","type":"Expression","name":"sum","bp":20,"associative":false,"commutative":false,"vertical_notation":false,"selected":false,"locked":true,"hidden":false,"ls":"_b4e1f06435859404","rs":"_f04adcacb7d83c94","parent":"_a073bc395d177c4b","children":[{"id":"_52ece24c7bba69e6","value":"sub","type":"Expression","name":"add-sub","bp":20,"associative":false,"commutative":true,"vertical_notation":false,"selected":false,"locked":true,"hidden":false,"rs":"_60f86d4ab85167e3","parent":"_0f516c4b247555d6","children":[{"id":"_f0b55d72c3d488d4","value":"-","type":"Expression","name":"sym","selected":false,"locked":true,"hidden":false,"rs":"_cbe59152717d8051","parent":"_52ece24c7bba69e6","children":[]},{"id":"_cbe59152717d8051","value":"b","type":"Expression","name":"var","bp":100,"selected":false,"locked":true,"hidden":false,"ls":"_f0b55d72c3d488d4","rs":null,"parent":"_52ece24c7bba69e6","children":[]}]},{"id":"_60f86d4ab85167e3","value":"add","type":"Expression","name":"add-sub","bp":20,"associative":true,"commutative":true,"vertical_notation":false,"selected":false,"locked":true,"hidden":false,"ls":"_52ece24c7bba69e6","rs":null,"parent":"_0f516c4b247555d6","children":[{"id":"_38c8c91de4f952d4","value":"+","type":"Expression","name":"sym","selected":false,"locked":true,"hidden":false,"rs":"_f9e9834fbbd82a72","parent":"_60f86d4ab85167e3","children":[]},{"id":"_f9e9834fbbd82a72","value":"power","type":"Expression","name":"power","bp":50,"associative":false,"commutative":false,"vertical_notation":false,"selected":false,"locked":true,"hidden":false,"ls":"_38c8c91de4f952d4","rs":null,"parent":"_60f86d4ab85167e3","children":[{"id":"_3df81c17a37050b5","value":"brackets","type":"Expression","name":"brackets","bp":0,"associative":false,"commutative":false,"vertical_notation":false,"selected":false,"locked":true,"hidden":false,"rs":"_423aaa1e67970638","parent":"_f9e9834fbbd82a72","children":[{"id":"_06c8d17ff49a27da","value":"(","type":"Expression","name":"sym","selected":false,"locked":true,"hidden":false,"rs":"_06a0d783598c2967","parent":"_3df81c17a37050b5","children":[]},{"id":"_06a0d783598c2967","value":"sum","type":"Expression","name":"sum","bp":20,"associative":false,"commutative":false,"vertical_notation":false,"selected":false,"locked":true,"hidden":false,"ls":"_06c8d17ff49a27da","rs":"_406fb8d4e6d38888","parent":"_3df81c17a37050b5","children":[{"id":"_09a5a26ec889338b","value":"add","type":"Expression","name":"add-sub","bp":20,"associative":true,"commutative":true,"vertical_notation":false,"selected":false,"locked":true,"hidden":false,"rs":"_24f94e99df42a4b4","parent":"_06a0d783598c2967","children":[{"id":"_0f23a7251810c5fc","value":"+","type":"Expression","name":"sym","selected":false,"locked":true,"hidden":true,"rs":"_518df0630e59d3c6","parent":"_09a5a26ec889338b","children":[]},{"id":"_518df0630e59d3c6","value":"power","type":"Expression","name":"power","bp":50,"associative":false,"commutative":false,"vertical_notation":false,"selected":false,"locked":true,"hidden":false,"ls":"_0f23a7251810c5fc","rs":null,"parent":"_09a5a26ec889338b","children":[{"id":"_af496d9167e51c42","value":"b","type":"Expression","name":"var","bp":100,"selected":false,"locked":true,"hidden":false,"rs":"_0451b3853fe1cf48","parent":"_518df0630e59d3c6","children":[]},{"id":"_0451b3853fe1cf48","value":"exponent","type":"Expression","name":"exponent","bp":50,"associative":false,"commutative":false,"vertical_notation":true,"selected":false,"locked":true,"hidden":false,"ls":"_af496d9167e51c42","rs":null,"parent":"_518df0630e59d3c6","children":[{"id":"_21188fb764b7ae0c","value":2,"type":"Expression","name":"num","selected":false,"locked":true,"hidden":false,"precision":2,"rs":null,"parent":"_0451b3853fe1cf48","children":[]}]}]}]},{"id":"_24f94e99df42a4b4","value":"sub","type":"Expression","name":"add-sub","bp":20,"associative":false,"commutative":true,"vertical_notation":false,"selected":false,"locked":true,"hidden":false,"ls":"_09a5a26ec889338b","rs":null,"parent":"_06a0d783598c2967","children":[{"id":"_f23c2160734904d9","value":"-","type":"Expression","name":"sym","selected":false,"locked":true,"hidden":false,"rs":"_6c74f6ead9c2faf9","parent":"_24f94e99df42a4b4","children":[]},{"id":"_6c74f6ead9c2faf9","value":"product","type":"Expression","name":"product","bp":30,"associative":false,"commutative":false,"vertical_notation":false,"selected":false,"locked":true,"hidden":false,"ls":"_f23c2160734904d9","rs":null,"parent":"_24f94e99df42a4b4","children":[{"id":"_2b171965a4150b75","value":"mul","type":"Expression","name":"mul-div","bp":30,"associative":true,"commutative":true,"vertical_notation":false,"selected":false,"locked":true,"hidden":false,"rs":"_aee15d255fc4dc09","parent":"_6c74f6ead9c2faf9","children":[{"id":"_519f7f78be9fa034","value":"*","type":"Expression","name":"sym","selected":false,"locked":true,"hidden":true,"rs":"_d824c0fd9369dd44","parent":"_2b171965a4150b75","children":[]},{"id":"_d824c0fd9369dd44","value":4,"type":"Expression","name":"num","selected":false,"locked":true,"hidden":false,"precision":2,"ls":"_519f7f78be9fa034","rs":null,"parent":"_2b171965a4150b75","children":[]}]},{"id":"_aee15d255fc4dc09","value":"mul","type":"Expression","name":"mul-div","bp":30,"associative":true,"commutative":true,"vertical_notation":false,"selected":false,"locked":true,"hidden":false,"ls":"_2b171965a4150b75","rs":"_431562af0d391aa2","parent":"_6c74f6ead9c2faf9","children":[{"id":"_87961ea719702e13","value":"*","type":"Expression","name":"sym","selected":false,"locked":true,"hidden":true,"rs":"_b43b5c90c3a2ba0e","parent":"_aee15d255fc4dc09","children":[]},{"id":"_b43b5c90c3a2ba0e","value":"a","type":"Expression","name":"var","bp":100,"selected":false,"locked":true,"hidden":false,"ls":"_87961ea719702e13","rs":null,"parent":"_aee15d255fc4dc09","children":[]}]},{"id":"_431562af0d391aa2","value":"mul","type":"Expression","name":"mul-div","bp":30,"associative":true,"commutative":true,"vertical_notation":false,"selected":false,"locked":true,"hidden":false,"ls":"_aee15d255fc4dc09","rs":null,"parent":"_6c74f6ead9c2faf9","children":[{"id":"_8dd7f87697265757","value":"*","type":"Expression","name":"sym","selected":false,"locked":true,"hidden":true,"rs":"_a99965882d05403e","parent":"_431562af0d391aa2","children":[]},{"id":"_a99965882d05403e","value":"c","type":"Expression","name":"var","bp":100,"selected":false,"locked":true,"hidden":false,"ls":"_8dd7f87697265757","rs":null,"parent":"_431562af0d391aa2","children":[]}]}]}]}]},{"id":"_406fb8d4e6d38888","value":")","type":"Expression","name":"sym","selected":false,"locked":true,"hidden":false,"ls":"_06a0d783598c2967","rs":null,"parent":"_3df81c17a37050b5","children":[]}]},{"id":"_423aaa1e67970638","value":"exponent","type":"Expression","name":"exponent","bp":50,"associative":false,"commutative":false,"vertical_notation":true,"selected":false,"locked":true,"hidden":false,"ls":"_3df81c17a37050b5","rs":null,"parent":"_f9e9834fbbd82a72","children":[{"id":"_234a54a8c4f34fc4","value":"brackets","type":"Expression","name":"brackets","bp":0,"associative":false,"commutative":false,"vertical_notation":false,"selected":false,"locked":true,"hidden":false,"parent":"_423aaa1e67970638","children":[{"id":"_1cc0a82e7aad1296","value":"(","type":"Expression","name":"sym","selected":false,"locked":true,"hidden":true,"rs":"_5c4bd2c55d15cdba","parent":"_234a54a8c4f34fc4","children":[]},{"id":"_5c4bd2c55d15cdba","value":"fraction","type":"Expression","name":"product","bp":30,"associative":false,"commutative":false,"vertical_notation":true,"selected":false,"locked":true,"hidden":false,"ls":"_1cc0a82e7aad1296","rs":"_1de20ece35deef7a","parent":"_234a54a8c4f34fc4","children":[{"id":"_96776e111e95fea5","value":"mul","type":"Expression","name":"mul-div","bp":30,"associative":true,"commutative":true,"vertical_notation":false,"selected":false,"locked":true,"hidden":false,"rs":"_ae7c0f18bc19ce8a","parent":"_5c4bd2c55d15cdba","children":[{"id":"_84cb91c97195922f","value":"*","type":"Expression","name":"sym","selected":false,"locked":true,"hidden":true,"rs":"_a4833d029bea756f","parent":"_96776e111e95fea5","children":[]},{"id":"_a4833d029bea756f","value":1,"type":"Expression","name":"num","selected":false,"locked":true,"hidden":false,"precision":2,"ls":"_84cb91c97195922f","rs":null,"parent":"_96776e111e95fea5","children":[]}]},{"id":"_ae7c0f18bc19ce8a","value":"//","type":"Expression","name":"sym","selected":false,"locked":true,"hidden":false,"ls":"_96776e111e95fea5","rs":"_96892dc79e0e0232","parent":"_5c4bd2c55d15cdba","children":[]},{"id":"_96892dc79e0e0232","value":"div","type":"Expression","name":"mul-div","bp":30,"associative":false,"commutative":true,"vertical_notation":false,"selected":false,"locked":true,"hidden":false,"ls":"_ae7c0f18bc19ce8a","rs":null,"parent":"_5c4bd2c55d15cdba","children":[{"id":"_4c9acbf70de4be2f","value":"/","type":"Expression","name":"sym","selected":false,"locked":true,"hidden":true,"rs":"_ad44c7a8fa57307c","parent":"_96892dc79e0e0232","children":[]},{"id":"_ad44c7a8fa57307c","value":2,"type":"Expression","name":"num","selected":false,"locked":true,"hidden":false,"precision":2,"ls":"_4c9acbf70de4be2f","rs":null,"parent":"_96892dc79e0e0232","children":[]}]}]},{"id":"_1de20ece35deef7a","value":")","type":"Expression","name":"sym","selected":false,"locked":true,"hidden":true,"ls":"_5c4bd2c55d15cdba","rs":null,"parent":"_234a54a8c4f34fc4","children":[]}]}]}]}]}]},{"id":"_f04adcacb7d83c94","value":")","type":"Expression","name":"sym","selected":false,"locked":true,"hidden":true,"ls":"_0f516c4b247555d6","rs":null,"parent":"_a073bc395d177c4b","children":[]}]}]},{"id":"_a77091d36e58b4bf","value":"//","type":"Expression","name":"sym","selected":false,"locked":true,"hidden":false,"ls":"_921124965eabc3c0","rs":"_63133cf5071275ac","parent":"_e3ab65fea7091adc","children":[]},{"id":"_63133cf5071275ac","value":"div","type":"Expression","name":"mul-div","bp":30,"associative":false,"commutative":true,"vertical_notation":false,"selected":false,"locked":true,"hidden":false,"ls":"_a77091d36e58b4bf","rs":"_ff8e82ceaa2acc71","parent":"_e3ab65fea7091adc","children":[{"id":"_5573a263753c97d9","value":"/","type":"Expression","name":"sym","selected":false,"locked":true,"hidden":true,"rs":"_abe0fd61225f74e5","parent":"_63133cf5071275ac","children":[]},{"id":"_abe0fd61225f74e5","value":2,"type":"Expression","name":"num","selected":false,"locked":true,"hidden":false,"precision":2,"ls":"_5573a263753c97d9","rs":null,"parent":"_63133cf5071275ac","children":[]}]},{"id":"_ff8e82ceaa2acc71","value":"div","type":"Expression","name":"mul-div","bp":30,"associative":false,"commutative":true,"vertical_notation":false,"selected":false,"locked":true,"hidden":false,"ls":"_63133cf5071275ac","rs":null,"parent":"_e3ab65fea7091adc","children":[{"id":"_ec7cc6a04f93db0e","value":"/","type":"Expression","name":"sym","selected":false,"locked":true,"hidden":true,"rs":"_ccdd99f2ffffb23d","parent":"_ff8e82ceaa2acc71","children":[]},{"id":"_ccdd99f2ffffb23d","value":"a","type":"Expression","name":"var","bp":100,"selected":false,"locked":true,"hidden":false,"ls":"_ec7cc6a04f93db0e","rs":null,"parent":"_ff8e82ceaa2acc71","children":[]}]}]}]}]},"row_idx":1}],"options":{"pos":{"x":922,"y":300},"eq":"ax^2+bx+c=0","v_align":"center","h_align":"equals","padding":{"left":20,"right":5,"top":5,"bottom":5},"font_size":50,"modes":["edit","inspect","arrange"],"no_history":false,"id":"_b3dc98fd9c9b598c"},"pos":{"x":864.9999999999999,"y":88},"pack_state":[false,false]}'
}];var t;function n(e){t=e;t.appendButtonGroup([{type:"dropdown",label:"formulas",data_toggle:"dropdown",pull_right:true,icon:"glyphicon glyphicon-book",html_fn:a}])}function a(t,n){i(e);var a={cols:2,mar:5,w:200,h:180};var s=r(t,a),l=o(s,a);$(t).on("shown.bs.dropdown",function(){y()});$(t).on("hide.bs.dropdown",function(){m(null,l)});return s.node()}function i(e){e.forEach(function(e){e.dl=gmath.loadFromJSON(e.json)})}function r(e,t){dropdown=d3.select(e).append("div");dropdown.on("click",function(){d3.event.stopPropagation()});dropdown.style("width",t.cols*t.w+2*t.cols*t.mar+2*t.mar+2+"px");dropdown.style("padding",t.mar+"px");dropdown.append("p").text("click to apply or drag to copy a formula").style({color:"gray","font-style":"italic","text-align":"center"});return dropdown}function o(t,n){var a=t.selectAll(".formulas").data(e);var i=a.enter().append("div").style({width:n.w+"px",height:n.h+"px",margin:n.mar+"px",display:"inline-block","vertical-align":"top",border:"1px solid silver","border-radius":"2px",padding:"5px","text-align":"center",position:"relative",cursor:"pointer"}).on("mousedown",function(e){s(e,a);c(e)}).on("click",function(e){l(e,a);c(e)});i.append("h2").text(function(e){return e.title}).style({"font-size":"1em",margin:"5px 0 10px 0"});i.append("p").style("margin-bottom","0px").append(function(e){var t=document.createElement("div");e.expression1_container=d3.select(t);return t});i.append("div").style("clear","both");i.append("p").style("margin-bottom","0px").append(function(e){var t=document.createElement("div");e.expression2_container=d3.select(t);return t});i.append("div").style({position:"absolute",top:0,bottom:0,left:0,right:0});return a}function s(e,t){d(e,t);e.allow_copy=true;u(e,t)}function l(e,t){e.allow_copy=false}function c(e){if(e.selected)h(e);else p()}function d(t,n){e.forEach(function(e){e.selected=t&&e===t?!t.selected:false;e.allow_copy=e===t});n.style("background",function(e){return e.selected?"#FFDF00":null})}function p(e){if(!e)e=[];t.model.dls().forEach(function(e){e.getLastRow().view.interaction_handler.highlight_nodes([])});e.forEach(function(e){e.getLastView().interaction_handler.highlight_nodes(e.getLastModel().children)})}function u(e,n){if(t.model.foreground_event_layer_visible()==="none"){t.model.foreground_event_layer_visible(true);t.model.foreground_event_layer().on("mouseup.macro-menu",function(){if(e.allow_copy){e.allow_copy=false;var a={x:d3.event.layerX,y:d3.event.layerY};var i=0;function r(t){i++;if(i>e.dl.rows.length-1)m(e,n);else t.addRowFromAscii(e.dl.rows[i].model.to_ascii(),r)}t.model.createDL({eq:e.dl.rows[0].model.to_ascii(),pos:a},r)}});t.model.foreground_event_layer().on("click.macro-menu",function(){var t={x:d3.event.layerX,y:d3.event.layerY};e.actions.forEach(function(e){if(e.target_dl.hitTest(t))e.target_row.model.performAction(e.action)});m(e,n)})}}function h(e){e.actions=[];var n=[e.dl.rows[0].model,e.dl.getLastModel()];t.model.dls().forEach(function(t){var a=t.getLastRow(),i=gmath.actions.ApplyMacroAction.getAllAvailableActions(n,a.model);e.actions=e.actions.concat(i.map(function(e){return{action:e,target_dl:t,target_row:a}}))});p(e.actions.map(function(e){return e.target_dl}))}function f(e,n){t.model.createDL({eq:e.dl.rows[0].model.to_ascii(),pos:{x:n.layerX,y:n.layerY}})}function m(e,n){if(t.model.foreground_event_layer_visible()){t.model.foreground_event_layer().on("click.macro-menu",null);t.model.foreground_event_layer_visible(false)}d(e,n);p()}function y(){e.forEach(function(e){if(!e.initialized){g(e.expression1_container,e.dl.rows[0].model.to_ascii());g(e.expression2_container,e.dl.getLastModel().to_ascii())}e.initialized=true})}function g(e,t,n){var a=32;var i=e.append("svg").style("width","100%").style("overflow","visible").style("margin-left","0.5em").style("display","inline-block").style("visibility","hidden");var r=new gmath.AlgebraModel(t);var o=new gmath.AlgebraView(r,i,{interactive:false,inactive_color:"#000000",font_size:a,v_align:"alphabetic",h_align:"left"});var s=function(){var t=o.getBBox();i.style("height",t.height).style("width",t.width);o.main.attr("transform","translate("+[0,t.height]+")");if(n)e.style("margin-bottom",t.height-r.children[0].ascent+"px");else i.style("margin-bottom",t.height-r.children[0].ascent+"px")};o.init(function(){s();var e=o.getBBox();setTimeout(function(){var t=i.node().parentNode.clientWidth,n=e.width;if(n>.9*t){o.options.font_size*=.9*t/n;o.update_all(true);s()}i.style("visibility",null)},1)})}return n}();gmath.ui=gmath.ui||{};gmath.ui.CanvasImage=function(){var e=function(e,t,n,a){CanvasElement.call(this,e,t,n);this.type="image";this.initCanvasImageOptions(n);this.initCanvasImageProperties(n);this.initCanvasImage();this.initPosition();this.initMode();if(a)this.callback()};gmath.inherit(CanvasElement,e);gmath.ui.CanvasImageClass=e;e.defaultOptions={min_size:{width:50},size:{width:200}};e.prototype.initCanvasImageOptions=function(t){var t=t||{};var n=gmath.deepCopy(e.defaultOptions);var a=gmath.object.extendExisting(n,t);if(t.image_data)a.image_data=t.image_data;if(t.drop_evt){a.drop_evt=t.drop_evt;a.url=this.tryGetUrl(t.drop_evt)}if(t.url)a.url=t.url;this.options=gmath.extend(this.options,a)};e.prototype.initCanvasImageProperties=function(e){this.size=this.options.size};e.prototype.initCanvasImage=function(){if(this.options.image_data||this.options.url)this.loadImage();else this.getDataFromFile(this.options.drop_evt)};e.prototype.tryGetUrl=function(e){if(!e)return;if(typeof e==="string")return e;if(e.dataTransfer!==undefined){var t=e.dataTransfer.getData("text/plain");if(t.slice(0,4)==="http"){return t}else{var n=e.dataTransfer.getData("text/html");var a=$("<div>").append(n);var i=$(a).find("img").attr("src");if(typeof i!=="undefined")return i}}return null};e.prototype.getDataFromFile=function(e){if(typeof this.options.image_data!=="undefined")return;if(e===null)return;if(typeof e.dataTransfer==="undefined")return;var t=new FileReader;t.onload=function(e){this.canvas_image.options.image_data=e.target.result;this.canvas_image.loadImage()};t.onerror=function(e){console.error("error: "+e.target.error)};t.canvas_image=this;t.readAsDataURL(e.dataTransfer.files[0])};e.prototype.loadImage=function(){this.image_for_aspect_ratio=new Image;this.image_for_aspect_ratio.src=this.options.url||this.options.image_data;this.image=document.createElementNS("http://www.w3.org/2000/svg","image");this.image.addEventListener("load",this.waitForAspectRatio())};e.prototype.waitForAspectRatio=function(){if(this.image_for_aspect_ratio.complete){this.imageLoaded()}else{var e=setTimeout(n,100);var t=this;function n(){if(t.image_for_aspect_ratio.complete){t.imageLoaded()}else{var e=setTimeout(n,100)}}}};e.prototype.imageLoaded=function(){this.aspect_ratio=this.image_for_aspect_ratio.height/this.image_for_aspect_ratio.width;var e=this.size.width*this.aspect_ratio;this.options.min_size.height=this.options.min_size.width*this.aspect_ratio;if(isNaN(this.aspect_ratio))return;var t=this.options.url===null?this.options.image_data:this.options.url;this.image=this.element_div.append("img").property("src",t).attr({width:this.size.width-4,height:e-4}).style({"pointer-events":"none"});this.resizeElement({width:this.size.width,height:e})};e.prototype.resize=function(e){var t=e||d3.event;t.x=Math.max(t.x,this.options.min_size.width);t.y=this.size.width*this.aspect_ratio;this.resizeElement({width:t.x,height:t.y})};e.prototype.subTypeResize=function(e){this.image.attr({width:this.size.width-4,height:this.size.height-4})};e.prototype.toJSON=function(){var e={type:"CanvasImage",id:this.id,pos:gmath.deepCopy(this.pos),size:gmath.deepCopy(this.size),url:this.options.url||this.options.image_data};return e};return e}();gmath.ui=gmath.ui||{};gmath.ui.Keyboard=function(){var e=null;var t=function(){var e=function(){var e="m -5.708,-15.7 20.344,0 c 3.669696,0 6.624,2.954304 6.624,6.624 l 0,17.752 c 0,3.669696 -2.954304,6.624 -6.624,6.624 l -20.488,0 -15.408,-15.48 zM -2.18,-6.948 11.716,6.948M -2.18,6.948 11.716,-6.948";var t="M 13.7,16.5 -13.7,16.5 0,-16.5 z";var n=d3.dispatch("done","cancel","change"),a="",i=false,r,o,s=null,l=null,c=null,d=null,p="darkorange",u=900,h,f,m,y,g,v,_,b=false,w,x="center",k=null,E=true;var T=function(){D();w=mtouch_events().on("touch",B).on("release",j).on("hold",R).hold_time(750);I();S();if(a!="")r.mathquill("write",a);return this};function C(e){n[e](r.mathquill("latex"))}T.width=function(e){if(arguments.length==0)return u;u=e;if(s)S();return this};T.latex=function(e){if(arguments.length==0){if(r)a=r.mathquill("latex");return a}else{a=e;if(r)r.mathquill("latex",e);return this}};T.visible=function(e){if(arguments.length==0)return i;if(i==e)return this;i=e;if(!s)return this;if(i){s.style("display","block");o.focus();if(E)T.scale_to_fit()}else s.style("display","none");return this};T.scale_to_fit=function(){if(!s)return;var e=document.body.getBoundingClientRect().width;if(e<u){var t=e/u;s.style("transform","scale("+t+")").style("-webkit-transform","scale("+t+")").style("transform-origin",x+" bottom").style("-webkit-transform-origin",x+" bottom")}else{s.style("transform",null).style("-webkit-transform",null)}};T.position=function(e){if(arguments.length==0)return x;if(x==e)return this;x=e;if(!s)return this;s.call(W,x);return this};T.caption=function(e,t){if(arguments.length===0)return k;k=e;if(!c)return this;if(!k)c.style("display","none");else{d.text(e);c.style("display",null)}d.style("color",t?t:null);return this};T.warning=function(e){return T.caption(e,p)};var M=function(){var e=[],t=[];g.forEach(function(n){t.push(n.row);e.push(n.col)});v=Math.max.apply(null,e);_=Math.max.apply(null,t);var n=(v+1)*130+v*10+2*10+2*10,a=(_+1)*110+10+10*(_-1)+2*10+2*10,i=u/n;f=130*i;y=10*i;m=110*i;h=a*i};var D=function(){g=[];g.keyboard="num";g.formula={type:"formula",col:2,row:0,cols:6};g.push({name:"Cancel",type:"event",event:"cancel",col:0,row:0,cols:2});g.push({type:"backspace",col:8,row:0});g.push({name:"Done",type:"event",event:"done",col:9,row:0,cols:2});g.push({name:"7",type:"key",col:0,row:1});g.push({name:"8",type:"key",col:1,row:1});g.push({name:"9",type:"key",col:2,row:1});g.push({name:"4",type:"key",col:0,row:2});g.push({name:"5",type:"key",col:1,row:2});g.push({name:"6",type:"key",col:2,row:2});g.push({name:"1",type:"key",col:0,row:3});g.push({name:"2",type:"key",col:1,row:3});g.push({name:"3",type:"key",col:2,row:3});g.push({name:"0",type:"key",col:3,row:3});g.push({name:"1a",type:"next_kbd",col:11,row:0});g.push({type:"arrow",dir:"left",col:9,row:3,cols:1,rows:.5});g.push({type:"arrow",dir:"up",col:10,row:2.5,cols:1,rows:.5});g.push({type:"arrow",dir:"down",col:10,row:3,cols:1,rows:.5});g.push({type:"arrow",dir:"right",col:11,row:3,cols:1,rows:.5});g.push({name:"+",type:"key",col:4.5,row:1});g.push({name:"",type:"key",val:"-",col:5.5,row:1});g.push({name:"*",type:"key",val:"*",col:4.5,row:2,dy:"0.3em"});g.push({name:"",type:"key",val:"/",col:5.5,row:2});g.push({name:"(",type:"key",col:4.5,row:3});g.push({name:")",type:"key",col:5.5,row:3});g.push({name:"^",type:"key",col:8,row:1});g.push({name:"=",type:"key",col:8,row:3});g.push({name:",",type:"key",col:7,row:1});g.push({name:".",type:"key",col:3,row:2});g.push({name:"x",type:"key",col:7,row:2});g.push({name:"y",type:"key",col:8,row:2});g.push({name:"_",type:"key",col:7,row:3})};var A=function(){g=[];g.keyboard="alpha";g.formula={type:"formula",col:2,row:0,cols:6};g.push({name:"Cancel",type:"event",event:"cancel",col:0,row:0,cols:2});g.push({type:"backspace",col:8,row:0});g.push({name:"Done",type:"event",event:"done",col:9,row:0,cols:2});g.push({name:"q",type:"key",col:0,row:1});g.push({name:"w",type:"key",col:1,row:1});g.push({name:"e",type:"key",col:2,row:1});g.push({name:"r",type:"key",col:3,row:1});g.push({name:"t",type:"key",col:4,row:1});g.push({name:"y",type:"key",col:5,row:1});g.push({name:"u",type:"key",col:6,row:1});g.push({name:"i",type:"key",col:7,row:1});g.push({name:"o",type:"key",col:8,row:1});g.push({name:"p",type:"key",col:9,row:1});g.push({name:"a",type:"key",col:.3,row:2});g.push({name:"s",type:"key",col:1.3,row:2});g.push({name:"d",type:"key",col:2.3,row:2});g.push({name:"f",type:"key",col:3.3,row:2});g.push({name:"g",type:"key",col:4.3,row:2});g.push({name:"h",type:"key",col:5.3,row:2});g.push({name:"j",type:"key",col:6.3,row:2});g.push({name:"k",type:"key",col:7.3,row:2});g.push({name:"l",type:"key",col:8.3,row:2});g.push({name:"z",type:"key",col:.6,row:3});g.push({name:"x",type:"key",col:1.6,row:3});g.push({name:"c",type:"key",col:2.6,row:3});g.push({name:"v",type:"key",col:3.6,row:3});g.push({name:"b",type:"key",col:4.6,row:3});g.push({name:"n",type:"key",col:5.6,row:3});g.push({name:"m",type:"key",col:6.6,row:3});g.push({name:"^",type:"key",col:9.3,row:2,cols:.6});g.push({name:"1a",type:"next_kbd",col:11,row:0});g.push({name:"+",type:"key",col:10,row:1});g.push({name:"-",type:"key",col:11,row:1});g.push({name:"*",type:"key",col:10,row:2,val:"*",dy:"0.3em"});g.push({name:"/",type:"key",col:11,row:2});g.push({name:"=",type:"key",col:11,row:3});g.push({name:"(",type:"key",col:9,row:3});g.push({name:")",type:"key",col:10,row:3});g.push({name:"_",type:"key",col:0,row:3,cols:.6});g.push({name:"shift",type:"shift",col:7.6,row:3,cols:1.25})};var z=function(){g=[];g.keyboard="function";g.formula={type:"formula",col:2,row:0,cols:6};g.push({name:"Cancel",type:"event",event:"cancel",col:0,row:0,cols:2});g.push({type:"backspace",col:8,row:0});g.push({name:"Done",type:"event",event:"done",col:9,row:0,cols:2});g.push({name:"",type:"key",col:0,row:1});g.push({name:"",type:"key",col:1,row:1});g.push({name:"",type:"key",col:2,row:1});g.push({name:"",type:"key",col:3,row:1});g.push({name:"",type:"key",col:4,row:1});g.push({name:"",type:"key",col:5,row:1});g.push({name:"",type:"key",col:6,row:1});g.push({name:"",type:"key",col:7,row:1});g.push({name:"",type:"key",col:8,row:1});g.push({name:"",type:"key",col:0,row:2});g.push({name:"",type:"key",col:1,row:2});g.push({name:"",type:"key",col:2,row:2});g.push({name:"",type:"key",col:3,row:2});g.push({name:"shift",type:"shift",col:9,row:1,cols:1.5});g.push({name:"",type:"key",val:"-",col:5,row:2});g.push({name:"",type:"key",val:"/",col:6,row:2});g.push({name:"",type:"key",col:7,row:2});g.push({type:"arrow",dir:"left",col:8,row:2,cols:1,rows:.5});g.push({type:"arrow",dir:"up",col:9,row:1.5,cols:1,rows:.5});g.push({type:"arrow",dir:"down",col:9,row:2,cols:1,rows:.5});g.push({type:"arrow",dir:"right",col:10,row:2,cols:1,rows:.5});g.push({name:"1a",type:"next_kbd",col:11,row:0})};var q=function(){g=[];g.keyboard="greek";g.formula={type:"formula",col:2,row:0,cols:6};g.push({name:"Cancel",type:"event",event:"cancel",col:0,row:0,cols:2});g.push({type:"backspace",col:8,row:0});g.push({name:"Done",type:"event",event:"done",col:9,row:0,cols:2});g.push({name:"",type:"key",col:0,row:1});g.push({name:"",type:"key",col:1,row:1});g.push({name:"",type:"key",col:2,row:1});g.push({name:"",type:"key",col:3,row:1});g.push({name:"",type:"key",col:4,row:1});g.push({name:"",type:"key",col:5,row:1});g.push({name:"",type:"key",col:6,row:1});g.push({name:"",type:"key",col:7,row:1});g.push({name:"",type:"key",col:8,row:1});g.push({name:"",type:"key",col:0,row:2});g.push({name:"",type:"key",col:1,row:2});g.push({name:"",type:"key",col:2,row:2});g.push({name:"",type:"key",col:3,row:2});g.push({name:"",type:"key",col:4,row:2});g.push({name:"",type:"key",col:5,row:2});g.push({name:"",type:"key",col:6,row:2});g.push({name:"",type:"key",col:7,row:2});g.push({name:"",type:"key",col:0,row:3});g.push({name:"",type:"key",col:1,row:3});g.push({name:"",type:"key",col:2,row:3});g.push({name:"",type:"key",col:3,row:3});g.push({name:"",type:"key",col:4,row:3});g.push({name:"",type:"key",col:5,row:3});g.push({name:"",type:"key",col:6,row:3});g.push({name:"shift",type:"shift",col:7,row:3,cols:1.5});g.push({name:"+",type:"key",col:9,row:1});g.push({name:"-",type:"key",col:10,row:1});g.push({name:"*",type:"key",col:9,row:2,val:"*",dy:"0.3em"});g.push({name:"/",type:"key",col:10,row:2});g.push({name:"=",type:"key",col:11,row:3});g.push({name:"^",type:"key",col:8,row:2});g.push({name:"(",type:"key",col:9,row:3});g.push({name:")",type:"key",col:10,row:3});g.push({name:"1a",type:"next_kbd",col:11,row:0})};var I=function(){s=d3.select("body").append("div").style({position:"fixed",bottom:0,"z-index":1e4}).style("display",i?"block":"none");c=s.append("div").attr("id","caption");d=c.append("span").text(k);c.append("span").text("x").style({position:"absolute",right:"5px",top:"-3px",color:"silver",cursor:"pointer"}).on("click",function(){T.caption(false)});l=s.append("div").classed("keyboard",true);r=l.append("div").attr("id","formula").datum(g.formula).append("div").attr("id","mq_div").append("span").attr("id","mq_span");r=$(r.node()).mathquill("editable");o=r.find("textarea");if(i)o.focus();d3.select(o[0]).on("keyup",function(){if(d3.event.keyCode===13)C("done");else if(d3.event.keyCode===27)C("cancel");else setTimeout(function(){C("change")},1)});O();var e=l.selectAll(".key").data(g).enter().append("div").classed("key",true).call(w);e.filter(function(e){return e.type=="backspace"}).classed("backspace-key",true).append("svg").append("path");e.filter(function(e){return e.type=="arrow"}).classed("arrow-key",true).append("svg").append("path");e.filter(function(e){return e.name}).classed("normal-key",true).append("span")};var L=function(){l.selectAll(".key").remove();l.select("#formula").datum(g.formula);var e=l.selectAll(".key").data(g).enter().append("div").classed("key",true).call(w);e.filter(function(e){return e.type=="backspace"}).classed("backspace-key",true).append("svg").append("path");e.filter(function(e){return e.type=="arrow"}).classed("arrow-key",true).append("svg").append("path");e.filter(function(e){return e.name}).classed("normal-key",true).append("span")};var S=function(){M();s.call(W,x);l.style("height",h+"px").style("width",u+"px").style({bottom:0,background:"#DDD",padding:0,"text-align":"center",border:"1px solid silver","border-radius":y*1.5+"px "+y*1.5+"px 0 0","border-bottom":"none"}).select("#formula").style("border",y+"px solid #DDD").style("border-radius",y+"px").call(N,y).select("#mq_div").style("border-radius",y+"px").style("width",function(e){return(e.cols||1)*f+((e.cols||1)-1)*y+"px"}).call(H).select("#mq_span").style("box-shadow","none").style("-webkit-box-shadow","none").style("-moz-box-shadow","none").style("margin-top",y).style("font-size",m/2+m/10+"px").style("padding-top",3*y-2+"px").style("padding-bottom",2*y+"px").style("border","none").style("min-height",function(e){return(e.rows||1)*m+((e.rows||1)-1)*y-5*y+"px"}).style("width","100%");l.selectAll(".key").call(N).call(G).call(H);l.selectAll(".backspace-key path").attr("d",e).style("stroke","black").style("stroke-width","1.2").style("fill","none").attr("transform","translate("+f/2+","+m/2+")scale("+.12*y+")");l.selectAll(".arrow-key path").attr("d",t).style("stroke","black").style("stroke-linejoin","round").style("stroke-width",3).style("fill","none").attr("transform",function(e){var t={left:-90,up:0,right:90,down:180}[e.dir];return"translate("+f/2+","+m/4+")scale("+.05*y+")rotate("+t+")"});l.selectAll(".normal-key span").text(function(e){return e.name}).style("line-height",m+"px").filter(function(e){return e.dy}).style("display","inline-block").style("margin-top",function(e){return e.dy});c.style({position:"relative",background:"rgb(244, 244, 244)",padding:"12px","padding-bottom":"8px",border:"1px solid silver","border-radius":"7.6px 7.6px 0 0","border-bottom":"none",width:4*f+3*y+"px","margin-left":8*f+10*y+"px","font-family":"HelveticaNeue-Light",color:"#666","font-size":"17px","text-align":"center",display:k?null:"none"})};var O=function(){if(/iPhone|iPod|iPad|Android|BlackBerry/.test(navigator.userAgent))l.select(".textarea textarea").attr("readonly","readonly")};var B=function(e){d3.select(this).style("background","gray");if(e.type==="formula")return;o.focus();if(e.type==="next_kbd"){F()}else if(e.type==="shift"){P(e)}else if(e.type==="key"){var t=e.val||e.name;if(b)t=t.toUpperCase();var n=t.charCodeAt(0);o.val(t);if(n!==46)o.trigger($.Event("keydown",{which:n}));o.trigger($.Event("keypress",{which:n}));C("change")}else if(e.type==="backspace"){o.trigger($.Event("keydown",{which:8}));C("change")}else if(e.type==="event"){C(e.event)}else if(e.type==="arrow"){var n={left:37,up:38,right:39,down:40}[e.dir];o.trigger($.Event("keydown",{which:n}));C("change")}};var F=function(){b=false;if(g.keyboard==="num"){A()}else if(g.keyboard==="alpha"){q()}else if(g.keyboard==="greek"){D()}L();S()};var P=function(e){b=!b;l.selectAll(".key span").text(function(e){if(e.type==="key"){if(b)return e.name.toUpperCase();else return e.name.toLowerCase()}else{return e.name}})};var j=function(e){if(e.type!=="shift"||!b)d3.select(this).style("background",e.type=="key"||e.type=="formula"?"white":"silver")};var R=function(e){if(e.type!=="backspace")return;r.mathquill("latex","");o.focus()};var N=function(e,t){t=t||0;e.style("position","absolute").style("left",function(e){return e.col*(f+y)+2*y-t+"px"}).style("bottom",function(e){return(_-e.row)*(m+y)+(e.row==0?0:0)+2*y-t+"px"})};var G=function(e,t,n){t=t||0;n=n||0;e.style("width",function(e){return(e.cols||1)*f+((e.cols||1)-1)*y-2*t+"px"}).style("height",function(e){return(e.rows||1)*m+((e.rows||1)-1)*y-2*n+"px"})};var H=function(e){e.style("border-radius",y+"px").style("font-size",m/2+"px").style("background",function(e){return e.type=="key"||e.type=="formula"?"white":"silver"}).style("box-shadow","#888 0px 1px 0px").style("font-family","'HelveticaNeue-UltraLight', 'Helvetica Neue UltraLight', 'Helvetica Neue', Arial, Helvetica, sans-serif").style("font-weight",100).style("border","none").style("padding",0).style("-webkit-user-select","none").style("-khtml-user-select","none").style("-moz-user-select","none").style("-ms-user-select","none").style("user-select","none").style("cursor","pointer")};var W=function(e,t){if(t==="center"){e.style("margin-left",-u/2+"px");e.style("left","50%");e.style("right",null)}else if(t==="left"){e.style("margin-left",0);e.style("left",0);e.style("right",null)}else if(t==="right"){e.style("margin-left",0);e.style("left",null);e.style("right",0)}else{e.style("margin-left",-u/2+"px");e.style("left",t);e.style("right",null)}};return d3.rebind(T,n,"on")};return e};return function(){return e||(e=t()())}}();gmath.ui=gmath.ui||{};gmath.ui.TutorialPair=function(){var e=function(e,t){this.events=d3.dispatch("done","retry","next");this.id=gmath.uid();this.title=t.title;this.text=t.text;if("gestureData"in t){this.gesture_data=t.gestureData;this.gesture_data.options.show_bg=false}this.initial_expressions=function n(e,t){if(!e)return[];if(!t)return[e];return[e].concat(t.map(function(e){return e.expression}))}.call(this,t.eq,t.extraExamples);this.correct_answers=function a(e,t){if(!e)return[];if(!t)return[e.map(this.parsedAscii)];return[e.map(this.parsedAscii)].concat(t.map(function(e){return e.correctAnswers.map(this.parsedAscii)},this))}.call(this,t.correctAnswers,t.extraExamples);this.current_example=0;this.start_wiggle=t.startWiggle;this.encourage=true;this.container=d3.select(e);this.dl_div=null;this.dl=null;this.play_btn=gmath.svg_play_button();this.player=null;this.practice_problem=t.practice_problem;this.allow_restart_after_done="allow_restart_after_done"in t?t.allow_restart_after_done:true;this.answered=false;this.log_mouse_trajectories=t.log_mouse_trajectories;this.task_name=t.task_name;this.init()};e.prototype.parsedAscii=function(e){return new gmath.AlgebraModel(e).to_ascii()};e.prototype.replay=function(){this.play_btn.hidden(true);this.player.replay(500,function e(){setTimeout(function e(){this.play_btn.hidden(false);if(!this.answered){if(this.encourage){this.dl_div.append("span").text("Try it!").classed("tryit",true);if(this.start_wiggle)this.dl.startWiggle(this.start_wiggle)}this.dl_div.on("mousedown",function e(){var e=new Date;this.startTime=e.getTime();this.dl_div.select("span.tryit").remove();this.dl_div.on("mousedown",null)}.bind(this))}}.bind(this),1e3)}.bind(this))};e.prototype.init=function(){this.container.append("h2").text(this.title);this.container.append("p").attr("class","tutorial-instructions").text(this.text);var e=this.container.append("div").classed("tutorial",true);var t=e.append("div").classed("choice",true).classed("large-choice",this.practice_problem);this.gesture_data.options.pos={x:"center",y:"center"};this.gesture_data.options.hold_time=1e6;this.gesture_data.options.draggable=false;this.gesture_data.options.collapsed_mode=true;this.gesture_data.options.no_history=false;this.gesture_data.options.no_handles=true;this.gesture_data.options.edit_mode_drag_box_width="0px";this.gesture_data.options.row_padding={left:0,right:0,top:7,bottom:3};this.gesture_data.options.padding={left:0,right:0,top:0,bottom:0};this.gesture_data.options.replace_value_on=false;var n=t.append("div").style({position:"absolute",left:0,right:0,top:0,bottom:0});this.player=new gmath.EventRecorder(this.gesture_data,n.node());this.player.showPreview();t.append("div").classed("animation",true).call(this.play_btn.on("click",this.replay.bind(this)));if(this.initial_expressions.length){this.dl_div=e.append("div").classed("choice",true).classed("large-choice",this.practice_problem);var a=new gmath.ui.CanvasFactory(this.dl_div.node(),{vertical_scroll:false,use_toolbar:false,use_keyboard:false,use_hold_menu:false,svg_height:"100%",log_mouse_trajectories:this.log_mouse_trajectories,overflow_visible:true});this.logger=a.logger;this.model=a.model;this.setDLToExpression(this.initial_expressions[this.current_example]);this.startTime=-1}};e.prototype.chainTransition=function(e,t){if(e.node().__transition__&&e.id&&e.node().__transition__[e.id]){var n=e.node().__transition__[e.id];console.log("extra delay",n.delay+n.duration);t+=n.delay+n.duration}return e.transition().delay(t)};e.prototype.neutralTransition=function(e,t,n,a){e.selectAll("button").remove();e.select("span").remove();var i=this.chainTransition(e,t).duration(n||500);if(a)i.styleTween("background",function(){return d3.interpolate(a,"#EEEEEE")});else i.style("background","#eee");return i};e.prototype.wrongTransition=function(e,t,n,a){var i=d3.select(e.node());i.append("span").attr("class","feedback").style({opacity:1e-5}).text("");var r=this.chainTransition(e,t).duration(n||500);if(a)r.styleTween("background",function(){return d3.interpolate(a,"#E0A8A8")});else r.style("background","#E0A8A8");r.select(".feedback").style("opacity",1);return r};e.prototype.correctTransition=function(e,t,n,a){var i=d3.select(e.node());i.append("span").attr("class","feedback").style({opacity:1e-5}).text("");this.initDoItAgainBtn(i);if(this.initial_expressions.length>1)this.initTryAnotherBtn(i);var r=this.chainTransition(e,t).duration(n||500);if(a)r.styleTween("background",function(){return d3.interpolate(a,"#A8E0B3")});else r.style("background","#A8E0B3");r.select(".feedback").style("opacity",1);r.selectAll("button").style("opacity",1);return r};e.prototype.initDoItAgainBtn=function(e){e.append("button").text("do it again").style({top:"10px",opacity:1e-5}).on("click",function t(){this.logger.logCustomInteraction("tutorial-reset",{task_name:this.task_name,eq_start:this.dl.rows[0].model.to_ascii(),eq_end:this.dl.getLastModel().to_ascii()});if(this.allow_restart_after_done)this.retry()}.bind(this))};e.prototype.initTryAnotherBtn=function(e){e.append("button").text("try another").style({top:"62px",opacity:1e-5}).on("click",function t(){this.logger.logCustomInteraction("tutorial-alternative-example",{task_name:this.task_name,eq_start:this.dl.rows[0].model.to_ascii()});if(this.initial_expressions.length>1)this.loadNextExample();else this.retry()}.bind(this))};e.prototype.checkAnswer=function(){var e=400;setTimeout(function t(){this.dl.getLastView().interactive(false);var e=this.dl.getLastModel().to_ascii();var t=new Date;var n=-1;var a=-1;if(this.startTime!==-1)n=t.getTime()-this.startTime;if(this.parsedAscii(this.initial_expressions[this.current_example])===this.dl.getLastModel().to_ascii()){this.dl.getLastView().interactive(true);a="initial state"}else if(this.answerIsCorrect(e)){a="correct";this.answered=true;this.logger.logCustomInteraction("tutorial-success",{task_name:this.task_name,eq_start:this.dl.rows[0].model.to_ascii(),eq_end:this.dl.getLastModel().to_ascii()});if(this.dl_div.selectAll("div").size()===2)return;this.correctTransition(this.dl_div,200,null,"#EEEEEE").each("end",this.events.done)}else if(!this.practice_problem){a="wrong";this.logger.logCustomInteraction("tutorial-fail",{task_name:this.task_name,eq_start:this.dl.rows[0].model.to_ascii(),eq_end:this.dl.getLastModel().to_ascii()});this.wrongTransition(this.dl_div,200,null,"#EEEEEE").transition().duration(500).each("end",this.retry.bind(this));this.encourage=true}else{a="intermediate state";this.dl.getLastView().interactive(true)}if(gmath.log_ga)gmath.log_ga.trackEvent("tutorial",a,this.eq,n)}.bind(this),e)};e.prototype.answerIsCorrect=function(e){return this.correct_answers[this.current_example].indexOf(e)!==-1};e.prototype.loadNextExample=function(){var e=this.dl.rows[0].model.to_ascii();this.neutralTransition(this.dl_div,0,1).each("end",function t(){this.current_example++;if(this.current_example===this.initial_expressions.length)this.current_example=0;this.setDLToExpression(this.initial_expressions[this.current_example]);if(this.current_example===0)this.encourage=true;else this.encourage=false;this.events.next()}.bind(this))};e.prototype.retry=function(){this.neutralTransition(this.dl_div,0,1).each("end",function e(){this.setDLToExpression(this.initial_expressions[this.current_example]);this.events.retry()}.bind(this));this.answered=false;this.encourage=true};e.prototype.setDLToExpression=function(e){var t=gmath.deepCopy(this.gesture_data.options);t.eq=e;t.inactive_color=gmath.AlgebraView.defaultOptions.inactive_color;t.color=gmath.AlgebraView.defaultOptions.color;t.h_align="center";t.edit_mode_drag_box_width="0px";this.logger.listen(false);if(this.dl)this.model.removeElement(this.dl);this.dl=this.model.createDL(t);this.model.focusOnDL(this.dl);this.logger.listen(true);this.dl.getLastRow().view.interaction_handler.events.on("touch",function(){this.encourage=false}.bind(this));this.dl.getLastView().interactive(true);this.dl.events.on("end-of-interaction."+this.id,this.checkAnswer.bind(this))};e.prototype.stop=function(){this.player.stop_animation()};return e}();var Timeline={};Timeline.entryTypes={};Timeline.entry=function(e,t){e=e[0];for(var n in Timeline.entryTypes){var a=Timeline.entryTypes[n];if(a.prototype.match(e))return new a(e,t)}return null};var EntryType=function(e){this.type=e};EntryType.prototype.match=function(e){return this.type===e.subtype};var AlgebraEntry=function(e,t){EntryType.call(this,e.subtype);this.summary=e;this.object=t.getElementByID(this.summary.el_id)};gmath.inherit(EntryType,AlgebraEntry);AlgebraEntry.prototype.type="rewrite";Timeline.entryTypes.AlgebraEntry=AlgebraEntry;AlgebraEntry.prototype.undo=function(e){this.rows=[];this.packState=this.object.rows.map(function(e){return e.hidden?true:false});while(this.object.getLastRow().idx!==this.summary.el_subid){this.rows.push(this.object.undo())}};AlgebraEntry.prototype.redo=function(e){for(var t=this.rows.length-1;t>=0;t--){this.object.redo(this.rows[t])}for(var t=0;t<this.object.rows.length;t++){var n=this.object.rows[t];if(this.packState[t]&&!n.hidden)n.hide();else if(!this.packState[t]&&n.hidden)n.unhide()}this.object.layoutRows()};var CreateEntry=function(e,t){EntryType.call(this,e.subtype);this.summary=e;this.objects=[];this.objects.push(t.getElementByID(this.summary.el_id))};gmath.inherit(EntryType,CreateEntry);CreateEntry.prototype.type="create";Timeline.entryTypes.CreateEntry=CreateEntry;CreateEntry.prototype.match=function(e){return this.type===e.subtype&&(e.el_type==="derivation"||e.el_type==="textbox"||e.el_type==="image");
};CreateEntry.prototype.undo=function(e){for(var t=0;t<this.objects.length;t++){e.removeElement(this.objects[t])}};CreateEntry.prototype.redo=function(e){for(var t=0;t<this.objects.length;t++){e.addElement(this.objects[t])}};var DeleteEntry=function(e,t){EntryType.call(this,e.subtype);this.summary=e;this.object=t.getDeletedElementByID(this.summary.el_id)};gmath.inherit(EntryType,DeleteEntry);DeleteEntry.prototype.type="delete";Timeline.entryTypes.Entry=DeleteEntry;DeleteEntry.prototype.match=function(e){return this.type===e.subtype&&(e.el_type==="derivation"||e.el_type==="textbox"||e.el_type==="image")};DeleteEntry.prototype.undo=function(e){e.addElement(this.object)};DeleteEntry.prototype.redo=function(e){e.removeElement(this.object)};var DrawEntry=function(e,t){EntryType.call(this,e.subtype);this.summary=e;this.object=t.getElementByID(this.summary.el_id)};gmath.inherit(EntryType,DrawEntry);DrawEntry.prototype.type="draw";Timeline.entryTypes.DrawEntry=DrawEntry;DrawEntry.prototype.undo=function(e){e.removePath(this.object)};DrawEntry.prototype.redo=function(e){e.addPath(this.object)};var EraseEntry=function(e){EntryType.call(this,e.subtype);this.summary=e};gmath.inherit(EntryType,EraseEntry);EraseEntry.prototype.type="erase";Timeline.entryTypes.EraseEntry=EraseEntry;EraseEntry.prototype.undo=function(e){if(!this.modification){console.warn("erase modification was not set");return}this.modification.removed.forEach(function(t){e.addPath(t)});this.modification.added.forEach(function(t){e.removePath(t)});this.modification.modified.forEach(function(t){t.path.points=t.points_before;e.updatePath(t.path)})};EraseEntry.prototype.redo=function(e){this.modification.removed.forEach(function(t){e.removePath(t)});this.modification.modified.forEach(function(t){t.path.points=t.points_after;e.updatePath(t.path)});this.modification.added.forEach(function(t){e.addPath(t)})};var MoveEntry=function(e,t){EntryType.call(this,e.subtype);this.summary=e;this.object=t.getElementByID(this.summary.el_id)};gmath.inherit(EntryType,MoveEntry);MoveEntry.prototype.type="move";Timeline.entryTypes.MoveEntry=MoveEntry;MoveEntry.prototype.match=function(e){return this.type===e.subtype&&(e.el_type==="derivation"||e.el_type==="textbox"||e.el_type==="image")};MoveEntry.prototype.undo=function(e){this.object.translateElement(JSON.parse(this.summary.old_state))};MoveEntry.prototype.redo=function(e){this.object.translateElement(JSON.parse(this.summary.new_state))};var PackEntry=function(e,t){EntryType.call(this,e.subtype);this.summary=e;this.object=t.getElementByID(this.summary.el_id)};gmath.inherit(EntryType,PackEntry);PackEntry.prototype.type="pack";Timeline.entryTypes.PackEntry=PackEntry;PackEntry.prototype.match=function(e){return this.type===e.subtype&&!this.startingAndEndingPackStateAreTheSame(e)};PackEntry.prototype.startingAndEndingPackStateAreTheSame=function(e){var t=e.old_state,n=e.new_state;for(var a=0;a<t.length;a++){if(t[a]!==n[a])return false}return true};PackEntry.prototype.undo=function(e){var t=this.object.rows,n=this.summary.old_state;for(var a=0;a<t.length;a++){if(t[a].hidden&&!n[a])t[a].unhide();else if(!t[a].hidden&&n[a])t[a].hide()}this.object.layoutRows()};PackEntry.prototype.redo=function(e){var t=this.object.rows,n=this.summary.new_state;for(var a=0;a<t.length;a++){if(t[a].hidden&&!n[a])t[a].unhide();else if(!t[a].hidden&&n[a])t[a].hide()}this.object.layoutRows()};var CloneEntry=function(e,t){EntryType.call(this,e.subtype);this.summary=e;this.object=t.getElementByID(this.summary.target_id)};gmath.inherit(EntryType,CloneEntry);CloneEntry.prototype.type="clone";Timeline.entryTypes.CloneEntry=CloneEntry;CloneEntry.prototype.undo=function(e){this.links=e.removeElement(this.object)};CloneEntry.prototype.redo=function(e){e.addDL(this.object);gmath.LinkCoordinator.addLinks(this.links)};var ScrubEntry=function(e,t){EntryType.call(this,e.subtype);this.summary=e;this.object=t.getElementByID(this.summary.el_id)};gmath.inherit(EntryType,ScrubEntry);ScrubEntry.prototype.type="scrub";Timeline.entryTypes.ScrubEntry=ScrubEntry;ScrubEntry.prototype.undo=function(e){var t=this.object.rows[0].model;var n=t.replace_with(new gmath.AlgebraModel(this.summary.old_state,t.options));this.object.rows[0].updateDimensionAfterInteraction();this.object.updateDims();this.object.rows[0].view.update_existing()};ScrubEntry.prototype.redo=function(e){var t=this.object.rows[0].model;var n=t.replace_with(new gmath.AlgebraModel(this.summary.new_state,t.options));this.object.rows[0].updateDimensionAfterInteraction();this.object.updateDims();this.object.rows[0].view.update_existing()};var TextEditEntry=function(e,t){EntryType.call(this,e.subtype);this.summary=e;this.textbox=t.getElementByID(this.summary.el_id)};gmath.inherit(EntryType,TextEditEntry);TextEditEntry.prototype.type="edit";Timeline.entryTypes.TextEditEntry=TextEditEntry;TextEditEntry.prototype.match=function(e){return this.type===e.subtype&&e.el_type==="textbox"};TextEditEntry.prototype.undo=function(e){this.textbox.setText(this.summary.old_state)};TextEditEntry.prototype.redo=function(e){this.textbox.setText(this.summary.new_state)};var ResizeEntry=function(e,t){EntryType.call(this,e.subtype);this.summary=e;this.canvasElement=t.getElementByID(this.summary.el_id)};gmath.inherit(EntryType,ResizeEntry);ResizeEntry.prototype.type="resize";Timeline.entryTypes.ResizeEntry=ResizeEntry;ResizeEntry.prototype.match=function(e){return this.type===e.subtype};ResizeEntry.prototype.undo=function(e){this.canvasElement.resizeElement(JSON.parse(this.summary.old_state))};ResizeEntry.prototype.redo=function(e){this.canvasElement.resizeElement(JSON.parse(this.summary.new_state))};gmath.gmifyPage=function(e,t){t=t||{};coordinator=new DLCoordinator;var n=e?d3.select(e):d3.select("body");var a=n.size()>0&&n.classed("gmify-canvas")?n:n.selectAll(".gmify-canvas");a.each(function(){var e=d3.select(this);var t=e.text().split(";");try{t.forEach(gmath.AlgebraModel.getDefaultParser().parse);e.classed("gmify-canvas",false).classed("gmified-canvas",true);e.classed("bootstrap-styles",true);e.select("*").remove();var n=new gmath.ui.CanvasFactory(this,{height:"500px"});fixAggressiveAssistmentsStyles(e);var a={pos:["auto",20],v_align:"top"};n.model.createDLs(t,a)}catch(i){console.log('could not parse "'+t+'". Error:',i)}});a=n.size()>0&&n.classed("gmify-minimal")?n:n.selectAll(".gmify-minimal");a.each(function(){var e=d3.select(this);var t=e.text();try{gmath.AlgebraModel.getDefaultParser().parse(t);e.classed("gmify-minimal",false).classed("gmified-minimal",true);e.classed("bootstrap-styles",true);e.select("*").remove();e.text("");var n=e.insert("svg").style({overflow:"visible",display:"block",width:"100%"});gmath.DerivationList.createFixedSingleLineDL(n.node(),{eq:t})}catch(a){console.log('could not parse "'+t+'". Error:',a)}});a=n.size()>0&&n.classed("gmify")?n:n.selectAll(".gmify");a.each(function(e,n){var a=d3.select(this),i=a.text();try{gmath.AlgebraModel.getDefaultParser().parse(i);a.classed("gmify",false).classed("gmified",true);a.classed("bootstrap-styles",true);a.select("*").remove();a.text("");var r=a.insert("div").style({overflow:"visible",display:"block","margin-top":"30px"});var o=new gmath.ui.CanvasFactory(r.node(),{minimal:true,logo_src:t.logo_src}),s=o.model.createDL({eq:i,pos:{x:0,y:0},cloning_on:false,normal_font:{family:"Kalam"},italic_font:{family:"Kalam"},font_baseline_shift:.4,font_ascent:.9,font_descent:.2,slanted_div_bar:true,div_bar_height:1/14,font_size:"45",row_border_color:"#ddd",handle_stroke_color:"#d8d8d8",keep_in_container:true});fixAggressiveAssistmentsStyles(a);coordinator.subscribeToCanvasModel(o.model);coordinator.addDL(s);o.model.focusOnDL(s);o.controller.clearInteractionTimeline()}catch(l){console.log('could not parse "'+i+'". Error:',l)}})};fixAggressiveAssistmentsStyles=function(e){e.selectAll(".btn-toolbar button span").style("font-size","12px");e.selectAll(".btn-toolbar button br").style("font-size","12px")};
