!function(a){function b(a,b,e){return 4===arguments.length?c.apply(this,arguments):void d(a,{declarative:!0,deps:b,declare:e})}function c(a,b,c,e){d(a,{declarative:!1,deps:b,executingRequire:c,execute:e})}function d(a,b){b.name=a,a in o||(o[a]=b),b.normalizedDeps=b.deps}function e(a,b){if(b[a.groupIndex]=b[a.groupIndex]||[],-1==p.call(b[a.groupIndex],a)){b[a.groupIndex].push(a);for(var c=0,d=a.normalizedDeps.length;d>c;c++){var f=a.normalizedDeps[c],g=o[f];if(g&&!g.evaluated){var h=a.groupIndex+(g.declarative!=a.declarative);if(void 0===g.groupIndex||g.groupIndex<h){if(void 0!==g.groupIndex&&(b[g.groupIndex].splice(p.call(b[g.groupIndex],g),1),0==b[g.groupIndex].length))throw new TypeError("Mixed dependency cycle detected");g.groupIndex=h}e(g,b)}}}}function f(a){var b=o[a];b.groupIndex=0;var c=[];e(b,c);for(var d=!!b.declarative==c.length%2,f=c.length-1;f>=0;f--){for(var g=c[f],i=0;i<g.length;i++){var k=g[i];d?h(k):j(k)}d=!d}}function g(a){return s[a]||(s[a]={name:a,dependencies:[],exports:{},importers:[]})}function h(b){if(!b.module){var c=b.module=g(b.name),d=b.module.exports,e=b.declare.call(a,function(a,b){if(c.locked=!0,"object"==typeof a)for(var e in a)d[e]=a[e];else d[a]=b;for(var f=0,g=c.importers.length;g>f;f++){var h=c.importers[f];if(!h.locked)for(var i=0;i<h.dependencies.length;++i)h.dependencies[i]===c&&h.setters[i](d)}return c.locked=!1,b},{id:b.name});c.setters=e.setters,c.execute=e.execute;for(var f=0,i=b.normalizedDeps.length;i>f;f++){var j,k=b.normalizedDeps[f],l=o[k],m=s[k];m?j=m.exports:l&&!l.declarative?j=l.esModule:l?(h(l),m=l.module,j=m.exports):j=n(k),m&&m.importers?(m.importers.push(c),c.dependencies.push(m)):c.dependencies.push(null),c.setters[f]&&c.setters[f](j)}}}function i(a){var b,c=o[a];if(c)c.declarative?m(a,[]):c.evaluated||j(c),b=c.module.exports;else if(b=n(a),!b)throw new Error("Unable to load dependency "+a+".");return(!c||c.declarative)&&b&&b.__useDefault?b.default:b}function j(b){if(!b.module){var c={},d=b.module={exports:c,id:b.name};if(!b.executingRequire)for(var e=0,f=b.normalizedDeps.length;f>e;e++){var g=b.normalizedDeps[e],h=o[g];h&&j(h)}b.evaluated=!0;var l=b.execute.call(a,function(a){for(var c=0,d=b.deps.length;d>c;c++)if(b.deps[c]==a)return i(b.normalizedDeps[c]);throw new TypeError("Module "+a+" not declared as a dependency.")},c,d);l&&(d.exports=l),c=d.exports,c&&c.__esModule?b.esModule=c:b.esModule=k(c)}}function k(b){var c={};if(("object"==typeof b||"function"==typeof b)&&b!==a)if(q)for(var d in b)"default"!==d&&l(c,b,d);else{var e=b&&b.hasOwnProperty;for(var d in b)"default"===d||e&&!b.hasOwnProperty(d)||(c[d]=b[d])}return c.default=b,r(c,"__useDefault",{value:!0}),c}function l(a,b,c){try{var d;(d=Object.getOwnPropertyDescriptor(b,c))&&r(a,c,d)}catch(d){return a[c]=b[c],!1}}function m(b,c){var d=o[b];if(d&&!d.evaluated&&d.declarative){c.push(b);for(var e=0,f=d.normalizedDeps.length;f>e;e++){var g=d.normalizedDeps[e];-1==p.call(c,g)&&(o[g]?m(g,c):n(g))}d.evaluated||(d.evaluated=!0,d.module.execute.call(a))}}function n(a){if(u[a])return u[a];if("@node/"==a.substr(0,6))return u[a]=k(t(a.substr(6)));var b=o[a];if(!b)throw"Module "+a+" not present.";return f(a),m(a,[]),o[a]=void 0,b.declarative&&r(b.module.exports,"__esModule",{value:!0}),u[a]=b.declarative?b.module.exports:b.esModule}var o={},p=Array.prototype.indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(this[b]===a)return b;return-1},q=!0;try{Object.getOwnPropertyDescriptor({a:0},"a")}catch(a){q=!1}var r;!function(){try{Object.defineProperty({},"a",{})&&(r=Object.defineProperty)}catch(a){r=function(a,b,c){try{a[b]=c.value||c.get.call(a)}catch(a){}}}}();var s={},t="undefined"!=typeof System&&System._nodeRequire||"undefined"!=typeof require&&require.resolve&&"undefined"!=typeof process&&require,u={"@empty":{}};return function(a,d,e,f){return function(g){g(function(g){for(var h={_nodeRequire:t,register:b,registerDynamic:c,get:n,set:function(a,b){u[a]=b},newModule:function(a){return a}},i=0;i<d.length;i++)(function(a,b){b&&b.__esModule?u[a]=b:u[a]=k(b)})(d[i],arguments[i]);f(h);var j=n(a[0]);if(a.length>1)for(var i=1;i<a.length;i++)n(a[i]);return e?j.default:j})}}}("undefined"!=typeof self?self:global)(["1"],[],!1,function(a){var b=(this.require,this.exports,this.module);!function(b){function c(a,b){for(var c=a.split(".");c.length;)b=b[c.shift()];return b}function d(a){if("string"==typeof a)return c(a,b);if(!(a instanceof Array))throw new Error("Global exports must be a string or array.");for(var d={},e=!0,f=0;f<a.length;f++){var g=c(a[f],b);e&&(d.default=g,e=!1),d[a[f].split(".").pop()]=g}return d}function e(a){if(Object.keys)Object.keys(b).forEach(a);else for(var c in b)i.call(b,c)&&a(c)}function f(a){e(function(c){if(-1==j.call(k,c)){try{var d=b[c]}catch(a){k.push(c)}a(c,d)}})}var g,h=a,i=Object.prototype.hasOwnProperty,j=Array.prototype.indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(this[b]===a)return b;return-1},k=["_g","sessionStorage","localStorage","clipboardData","frames","frameElement","external","mozAnimationStartTime","webkitStorageInfo","webkitIndexedDB","mozInnerScreenY","mozInnerScreenX"];h.set("@@global-helpers",h.newModule({prepareGlobal:function(a,c,e){var h=b.define;b.define=void 0;var i;if(e){i={};for(var j in e)i[j]=b[j],b[j]=e[j]}return c||(g={},f(function(a,b){g[a]=b})),function(){var a;if(c)a=d(c);else{a={};var e,j;f(function(b,c){g[b]!==c&&"undefined"!=typeof c&&(a[b]=c,"undefined"!=typeof e?j||e===c||(j=!0):e=c)}),a=j?a:e}if(i)for(var k in i)b[k]=i[k];return b.define=h,a}}}))}("undefined"!=typeof self?self:global),a.registerDynamic("2",[],!0,function(a,b,c){var d=(this||self,function(a){"use strict";function b(a,c){return"undefined"==typeof a?b[0]:"undefined"!=typeof c?10===+c?Q(a):_(a,c):Q(a)}function c(a,b){this.value=a,this.sign=b,this.isSmall=!1}function e(a){this.value=a,this.sign=a<0,this.isSmall=!0}function f(a){return-T<a&&a<T}function g(a){return a<1e7?[a]:a<1e14?[a%1e7,Math.floor(a/1e7)]:[a%1e7,Math.floor(a/1e7)%1e7,Math.floor(a/1e14)]}function h(a){i(a);var b=a.length;if(b<4&&C(a,U)<0)switch(b){case 0:return 0;case 1:return a[0];case 2:return a[0]+a[1]*R;default:return a[0]+(a[1]+a[2]*R)*R}return a}function i(a){for(var b=a.length;0===a[--b];);a.length=b+1}function j(a){for(var b=new Array(a),c=-1;++c<a;)b[c]=0;return b}function k(a){return a>0?Math.floor(a):Math.ceil(a)}function l(a,b){var c,d,e=a.length,f=b.length,g=new Array(e),h=0,i=R;for(d=0;d<f;d++)c=a[d]+b[d]+h,h=c>=i?1:0,g[d]=c-h*i;for(;d<e;)c=a[d]+h,h=c===i?1:0,g[d++]=c-h*i;return h>0&&g.push(h),g}function m(a,b){return a.length>=b.length?l(a,b):l(b,a)}function n(a,b){var c,d,e=a.length,f=new Array(e),g=R;for(d=0;d<e;d++)c=a[d]-g+b,b=Math.floor(c/g),f[d]=c-b*g,b+=1;for(;b>0;)f[d++]=b%g,b=Math.floor(b/g);return f}function o(a,b){var c,d,e=a.length,f=b.length,g=new Array(e),h=0,j=R;for(c=0;c<f;c++)d=a[c]-h-b[c],d<0?(d+=j,h=1):h=0,g[c]=d;for(c=f;c<e;c++){if(d=a[c]-h,!(d<0)){g[c++]=d;break}d+=j,g[c]=d}for(;c<e;c++)g[c]=a[c];return i(g),g}function p(a,b,d){var f;return C(a,b)>=0?f=o(a,b):(f=o(b,a),d=!d),f=h(f),"number"==typeof f?(d&&(f=-f),new e(f)):new c(f,d)}function q(a,b,d){var f,g,i=a.length,j=new Array(i),k=-b,l=R;for(f=0;f<i;f++)g=a[f]+k,k=Math.floor(g/l),g%=l,j[f]=g<0?g+l:g;return j=h(j),"number"==typeof j?(d&&(j=-j),new e(j)):new c(j,d)}function r(a,b){var c,d,e,f,g,h=a.length,k=b.length,l=h+k,m=j(l),n=R;for(e=0;e<h;++e){f=a[e];for(var o=0;o<k;++o)g=b[o],c=f*g+m[e+o],d=Math.floor(c/n),m[e+o]=c-d*n,m[e+o+1]+=d}return i(m),m}function s(a,b){var c,d,e=a.length,f=new Array(e),g=R,h=0;for(d=0;d<e;d++)c=a[d]*b+h,h=Math.floor(c/g),f[d]=c-h*g;for(;h>0;)f[d++]=h%g,h=Math.floor(h/g);return f}function t(a,b){for(var c=[];b-- >0;)c.push(0);return c.concat(a)}function u(a,b){var c=Math.max(a.length,b.length);if(c<=30)return r(a,b);c=Math.ceil(c/2);var d=a.slice(c),e=a.slice(0,c),f=b.slice(c),g=b.slice(0,c),h=u(e,g),j=u(d,f),k=u(m(e,d),m(g,f)),l=m(m(h,t(o(o(k,h),j),c)),t(j,2*c));return i(l),l}function v(a,b){return-.012*a-.012*b+15e-6*a*b>0}function w(a,b,d){return a<R?new c(s(b,a),d):new c(r(b,g(a)),d)}function x(a){var b,c,d,e,f,g=a.length,h=j(g+g),k=R;for(d=0;d<g;d++){e=a[d];for(var l=0;l<g;l++)f=a[l],b=e*f+h[d+l],c=Math.floor(b/k),h[d+l]=b-c*k,h[d+l+1]+=c}return i(h),h}function y(a,b){var c,d,e,f,g,i,k,l=a.length,m=b.length,n=R,o=j(b.length),p=b[m-1],q=Math.ceil(n/(2*p)),r=s(a,q),t=s(b,q);for(r.length<=l&&r.push(0),t.push(0),p=t[m-1],d=l-m;d>=0;d--){for(c=n-1,r[d+m]!==p&&(c=Math.floor((r[d+m]*n+r[d+m-1])/p)),e=0,f=0,i=t.length,g=0;g<i;g++)e+=c*t[g],k=Math.floor(e/n),f+=r[d+g]-(e-k*n),e=k,f<0?(r[d+g]=f+n,f=-1):(r[d+g]=f,f=0);for(;0!==f;){for(c-=1,e=0,g=0;g<i;g++)e+=r[d+g]-n+t[g],e<0?(r[d+g]=e+n,e=0):(r[d+g]=e,e=1);f+=e}o[d]=c}return r=A(r,q)[0],[h(o),h(r)]}function z(a,b){for(var c,d,e,f,g,i=a.length,j=b.length,k=[],l=[],m=R;i;)if(l.unshift(a[--i]),C(l,b)<0)k.push(0);else{d=l.length,e=l[d-1]*m+l[d-2],f=b[j-1]*m+b[j-2],d>j&&(e=(e+1)*m),c=Math.ceil(e/f);do{if(g=s(b,c),C(g,l)<=0)break;c--}while(c);k.push(c),l=o(l,g)}return k.reverse(),[h(k),h(l)]}function A(a,b){var c,d,e,f,g=a.length,h=j(g),i=R;for(e=0,c=g-1;c>=0;--c)f=e*i+a[c],d=k(f/b),e=f-d*b,h[c]=0|d;return[h,0|e]}function B(a,d){var f,i,j=Q(d),l=a.value,m=j.value;if(0===m)throw new Error("Cannot divide by zero");if(a.isSmall)return j.isSmall?[new e(k(l/m)),new e(l%m)]:[b[0],a];if(j.isSmall){if(1===m)return[a,b[0]];if(m==-1)return[a.negate(),b[0]];var n=Math.abs(m);if(n<R){f=A(l,n),i=h(f[0]);var o=f[1];return a.sign&&(o=-o),"number"==typeof i?(a.sign!==j.sign&&(i=-i),[new e(i),new e(o)]):[new c(i,a.sign!==j.sign),new e(o)]}m=g(n)}var p=C(l,m);if(p===-1)return[b[0],a];if(0===p)return[b[a.sign===j.sign?1:-1],b[0]];f=l.length+m.length<=200?y(l,m):z(l,m),i=f[0];var q=a.sign!==j.sign,r=f[1],s=a.sign;return"number"==typeof i?(q&&(i=-i),i=new e(i)):i=new c(i,q),"number"==typeof r?(s&&(r=-r),r=new e(r)):r=new c(r,s),[i,r]}function C(a,b){if(a.length!==b.length)return a.length>b.length?1:-1;for(var c=a.length-1;c>=0;c--)if(a[c]!==b[c])return a[c]>b[c]?1:-1;return 0}function D(a){var b=a.abs();return!b.isUnit()&&(!!(b.equals(2)||b.equals(3)||b.equals(5))||!(b.isEven()||b.isDivisibleBy(3)||b.isDivisibleBy(5))&&(!!b.lesser(25)||void 0))}function E(a){return("number"==typeof a||"string"==typeof a)&&+Math.abs(a)<=R||a instanceof c&&a.value.length<=1}function F(a,b,c){b=Q(b);for(var e=a.isNegative(),f=b.isNegative(),g=e?a.not():a,h=f?b.not():b,i=[],j=[],k=!1,l=!1;!k||!l;)g.isZero()?(k=!0,i.push(e?1:0)):e?i.push(g.isEven()?1:0):i.push(g.isEven()?0:1),h.isZero()?(l=!0,j.push(f?1:0)):f?j.push(h.isEven()?1:0):j.push(h.isEven()?0:1),g=g.over(2),h=h.over(2);for(var m=[],n=0;n<i.length;n++)m.push(c(i[n],j[n]));for(var o=d(m.pop()).negate().times(d(2).pow(m.length));m.length;)o=o.add(d(m.pop()).times(d(2).pow(m.length)));return o}function G(a){var b=a.value,c="number"==typeof b?b|Z:b[0]+b[1]*R|$;return c&-c}function H(a,b){return a=Q(a),b=Q(b),a.greater(b)?a:b}function I(a,b){return a=Q(a),b=Q(b),a.lesser(b)?a:b}function J(a,c){if(a=Q(a).abs(),c=Q(c).abs(),a.equals(c))return a;if(a.isZero())return c;if(c.isZero())return a;for(var d,e,f=b[1];a.isEven()&&c.isEven();)d=Math.min(G(a),G(c)),a=a.divide(d),c=c.divide(d),f=f.multiply(d);for(;a.isEven();)a=a.divide(G(a));do{for(;c.isEven();)c=c.divide(G(c));a.greater(c)&&(e=c,c=a,a=e),c=c.subtract(a)}while(!c.isZero());return f.isUnit()?a:a.multiply(f)}function K(a,b){return a=Q(a).abs(),b=Q(b).abs(),a.divide(J(a,b)).multiply(b)}function L(a,b){a=Q(a),b=Q(b);var d=I(a,b),f=H(a,b),g=f.subtract(d);if(g.isSmall)return d.add(Math.round(Math.random()*g));for(var i=g.value.length-1,j=[],l=!0,m=i;m>=0;m--){var n=l?g.value[m]:R,o=k(Math.random()*n);j.unshift(o),o<n&&(l=!1)}return j=h(j),d.add("number"==typeof j?new e(j):new c(j,!1))}function M(a){var b=a.value;return"number"==typeof b&&(b=[b]),1===b.length&&b[0]<=35?"0123456789abcdefghijklmnopqrstuvwxyz".charAt(b[0]):"<"+b+">"}function N(a,b){if(b=d(b),b.isZero()){if(a.isZero())return"0";throw new Error("Cannot convert nonzero numbers to base 0.")}if(b.equals(-1))return a.isZero()?"0":a.isNegative()?new Array(1-a).join("10"):"1"+new Array(+a).join("01");var c="";if(a.isNegative()&&b.isPositive()&&(c="-",a=a.abs()),b.equals(1))return a.isZero()?"0":c+new Array(+a+1).join(1);for(var e,f=[],g=a;g.isNegative()||g.compareAbs(b)>=0;){e=g.divmod(b),g=e.quotient;var h=e.remainder;h.isNegative()&&(h=b.minus(h).abs(),g=g.next()),f.push(M(h))}return f.push(M(g)),c+f.reverse().join("")}function O(a){if(f(+a)){var b=+a;if(b===k(b))return new e(b);throw"Invalid integer: "+a}var d="-"===a[0];d&&(a=a.slice(1));var g=a.split(/e/i);if(g.length>2)throw new Error("Invalid integer: "+g.join("e"));if(2===g.length){var h=g[1];if("+"===h[0]&&(h=h.slice(1)),h=+h,h!==k(h)||!f(h))throw new Error("Invalid integer: "+h+" is not a valid exponent.");var j=g[0],l=j.indexOf(".");if(l>=0&&(h-=j.length-l-1,j=j.slice(0,l)+j.slice(l+1)),h<0)throw new Error("Cannot include negative exponent part for integers");j+=new Array(h+1).join("0"),a=j}var m=/^([0-9][0-9]*)$/.test(a);if(!m)throw new Error("Invalid integer: "+a);for(var n=[],o=a.length,p=S,q=o-p;o>0;)n.push(+a.slice(q,o)),q-=p,q<0&&(q=0),o-=p;return i(n),new c(n,d)}function P(a){if(f(a)){if(a!==k(a))throw new Error(a+" is not an integer.");return new e(a)}return O(a.toString())}function Q(a){return"number"==typeof a?P(a):"string"==typeof a?O(a):a}var R=1e7,S=7,T=9007199254740992,U=g(T),V=Math.log(T);c.prototype=Object.create(b.prototype),e.prototype=Object.create(b.prototype),c.prototype.add=function(a){var b=Q(a);if(this.sign!==b.sign)return this.subtract(b.negate());var d=this.value,e=b.value;return b.isSmall?new c(n(d,Math.abs(e)),this.sign):new c(m(d,e),this.sign)},c.prototype.plus=c.prototype.add,e.prototype.add=function(a){var b=Q(a),d=this.value;if(d<0!==b.sign)return this.subtract(b.negate());var h=b.value;if(b.isSmall){if(f(d+h))return new e(d+h);h=g(Math.abs(h))}return new c(n(h,Math.abs(d)),d<0)},e.prototype.plus=e.prototype.add,c.prototype.subtract=function(a){var b=Q(a);if(this.sign!==b.sign)return this.add(b.negate());var c=this.value,d=b.value;return b.isSmall?q(c,Math.abs(d),this.sign):p(c,d,this.sign)},c.prototype.minus=c.prototype.subtract,e.prototype.subtract=function(a){var b=Q(a),c=this.value;if(c<0!==b.sign)return this.add(b.negate());var d=b.value;return b.isSmall?new e(c-d):q(d,Math.abs(c),c>=0)},e.prototype.minus=e.prototype.subtract,c.prototype.negate=function(){return new c(this.value,!this.sign)},e.prototype.negate=function(){var a=this.sign,b=new e(-this.value);return b.sign=!a,b},c.prototype.abs=function(){return new c(this.value,!1)},e.prototype.abs=function(){return new e(Math.abs(this.value))},c.prototype.multiply=function(a){var d,e=Q(a),f=this.value,h=e.value,i=this.sign!==e.sign;if(e.isSmall){if(0===h)return b[0];if(1===h)return this;if(h===-1)return this.negate();if(d=Math.abs(h),d<R)return new c(s(f,d),i);h=g(d)}return v(f.length,h.length)?new c(u(f,h),i):new c(r(f,h),i)},c.prototype.times=c.prototype.multiply,e.prototype._multiplyBySmall=function(a){return f(a.value*this.value)?new e(a.value*this.value):w(Math.abs(a.value),g(Math.abs(this.value)),this.sign!==a.sign)},c.prototype._multiplyBySmall=function(a){return 0===a.value?b[0]:1===a.value?this:a.value===-1?this.negate():w(Math.abs(a.value),this.value,this.sign!==a.sign)},e.prototype.multiply=function(a){return Q(a)._multiplyBySmall(this)},e.prototype.times=e.prototype.multiply,c.prototype.square=function(){return new c(x(this.value),!1)},e.prototype.square=function(){var a=this.value*this.value;return f(a)?new e(a):new c(x(g(Math.abs(this.value))),!1)},c.prototype.divmod=function(a){var b=B(this,a);return{quotient:b[0],remainder:b[1]}},e.prototype.divmod=c.prototype.divmod,c.prototype.divide=function(a){return B(this,a)[0]},e.prototype.over=e.prototype.divide=c.prototype.over=c.prototype.divide,c.prototype.mod=function(a){return B(this,a)[1]},e.prototype.remainder=e.prototype.mod=c.prototype.remainder=c.prototype.mod,c.prototype.pow=function(a){var c,d,g,h=Q(a),i=this.value,j=h.value;if(0===j)return b[1];if(0===i)return b[0];if(1===i)return b[1];if(i===-1)return h.isEven()?b[1]:b[-1];if(h.sign)return b[0];if(!h.isSmall)throw new Error("The exponent "+h.toString()+" is too large.");if(this.isSmall&&f(c=Math.pow(i,j)))return new e(k(c));for(d=this,g=b[1];;){if(j&!0&&(g=g.times(d),--j),0===j)break;j/=2,d=d.square()}return g},e.prototype.pow=c.prototype.pow,c.prototype.modPow=function(a,c){if(a=Q(a),c=Q(c),c.isZero())throw new Error("Cannot take modPow with modulus 0");for(var d=b[1],e=this.mod(c);a.isPositive();){if(e.isZero())return b[0];a.isOdd()&&(d=d.multiply(e).mod(c)),a=a.divide(2),e=e.square().mod(c)}return d},e.prototype.modPow=c.prototype.modPow,c.prototype.compareAbs=function(a){var b=Q(a),c=this.value,d=b.value;return b.isSmall?1:C(c,d)},e.prototype.compareAbs=function(a){var b=Q(a),c=Math.abs(this.value),d=b.value;return b.isSmall?(d=Math.abs(d),c===d?0:c>d?1:-1):-1},c.prototype.compare=function(a){if(a===1/0)return-1;if(a===-(1/0))return 1;var b=Q(a),c=this.value,d=b.value;return this.sign!==b.sign?b.sign?1:-1:b.isSmall?this.sign?-1:1:C(c,d)*(this.sign?-1:1)},c.prototype.compareTo=c.prototype.compare,e.prototype.compare=function(a){if(a===1/0)return-1;if(a===-(1/0))return 1;var b=Q(a),c=this.value,d=b.value;return b.isSmall?c==d?0:c>d?1:-1:c<0!==b.sign?c<0?-1:1:c<0?1:-1},e.prototype.compareTo=e.prototype.compare,c.prototype.equals=function(a){return 0===this.compare(a)},e.prototype.eq=e.prototype.equals=c.prototype.eq=c.prototype.equals,c.prototype.notEquals=function(a){return 0!==this.compare(a)},e.prototype.neq=e.prototype.notEquals=c.prototype.neq=c.prototype.notEquals,c.prototype.greater=function(a){return this.compare(a)>0},e.prototype.gt=e.prototype.greater=c.prototype.gt=c.prototype.greater,c.prototype.lesser=function(a){return this.compare(a)<0},e.prototype.lt=e.prototype.lesser=c.prototype.lt=c.prototype.lesser,c.prototype.greaterOrEquals=function(a){return this.compare(a)>=0},e.prototype.geq=e.prototype.greaterOrEquals=c.prototype.geq=c.prototype.greaterOrEquals,c.prototype.lesserOrEquals=function(a){return this.compare(a)<=0},e.prototype.leq=e.prototype.lesserOrEquals=c.prototype.leq=c.prototype.lesserOrEquals,c.prototype.isEven=function(){return 0===(1&this.value[0])},e.prototype.isEven=function(){return 0===(1&this.value)},c.prototype.isOdd=function(){return 1===(1&this.value[0])},e.prototype.isOdd=function(){return 1===(1&this.value)},c.prototype.isPositive=function(){return!this.sign},e.prototype.isPositive=function(){return this.value>0},c.prototype.isNegative=function(){return this.sign},e.prototype.isNegative=function(){return this.value<0},c.prototype.isUnit=function(){return!1},e.prototype.isUnit=function(){return 1===Math.abs(this.value)},c.prototype.isZero=function(){return!1},e.prototype.isZero=function(){return 0===this.value},c.prototype.isDivisibleBy=function(a){var c=Q(a),d=c.value;return 0!==d&&(1===d||(2===d?this.isEven():this.mod(c).equals(b[0])))},e.prototype.isDivisibleBy=c.prototype.isDivisibleBy,c.prototype.isPrime=function(){var c=D(this);if(c!==a)return c;for(var e,f,g,h,i=this.abs(),j=i.prev(),k=[2,3,5,7,11,13,17,19],l=j;l.isEven();)l=l.divide(2);for(g=0;g<k.length;g++)if(h=d(k[g]).modPow(l,i),!h.equals(b[1])&&!h.equals(j)){for(f=!0,e=l;f&&e.lesser(j);e=e.multiply(2))h=h.square().mod(i),h.equals(j)&&(f=!1);if(f)return!1}return!0},e.prototype.isPrime=c.prototype.isPrime,c.prototype.isProbablePrime=function(b){var c=D(this);if(c!==a)return c;for(var e=this.abs(),f=b===a?5:b,g=0;g<f;g++){var h=d.randBetween(2,e.minus(2));if(!h.modPow(e.prev(),e).isUnit())return!1}return!0},e.prototype.isProbablePrime=c.prototype.isProbablePrime,c.prototype.modInv=function(a){for(var b,c,e,f=d.zero,g=d.one,h=Q(a),i=this.abs();!i.equals(d.zero);)b=h.divide(i),c=f,e=h,f=g,h=i,g=c.subtract(b.multiply(g)),i=e.subtract(b.multiply(i));return f.compare(0)===-1&&(f=f.add(a)),f},e.prototype.modInv=c.prototype.modInv,c.prototype.next=function(){var a=this.value;return this.sign?q(a,1,this.sign):new c(n(a,1),this.sign)},e.prototype.next=function(){var a=this.value;return a+1<T?new e(a+1):new c(U,!1)},c.prototype.prev=function(){var a=this.value;return this.sign?new c(n(a,1),!0):q(a,1,this.sign)},e.prototype.prev=function(){var a=this.value;return a-1>-T?new e(a-1):new c(U,!0)};for(var W=[1];W[W.length-1]<=R;)W.push(2*W[W.length-1]);var X=W.length,Y=W[X-1];c.prototype.shiftLeft=function(a){if(!E(a))throw new Error(String(a)+" is too large for shifting.");if(a=+a,a<0)return this.shiftRight(-a);for(var b=this;a>=X;)b=b.multiply(Y),a-=X-1;return b.multiply(W[a])},e.prototype.shiftLeft=c.prototype.shiftLeft,c.prototype.shiftRight=function(a){var b;if(!E(a))throw new Error(String(a)+" is too large for shifting.");if(a=+a,a<0)return this.shiftLeft(-a);for(var c=this;a>=X;){if(c.isZero())return c;b=B(c,Y),c=b[1].isNegative()?b[0].prev():b[0],a-=X-1}return b=B(c,W[a]),b[1].isNegative()?b[0].prev():b[0]},e.prototype.shiftRight=c.prototype.shiftRight,c.prototype.not=function(){return this.negate().prev()},e.prototype.not=c.prototype.not,c.prototype.and=function(a){return F(this,a,function(a,b){return a&b})},e.prototype.and=c.prototype.and,c.prototype.or=function(a){return F(this,a,function(a,b){return a|b})},e.prototype.or=c.prototype.or,c.prototype.xor=function(a){return F(this,a,function(a,b){return a^b})},e.prototype.xor=c.prototype.xor;var Z=1<<30,$=(R&-R)*(R&-R)|Z,_=function(a,c){var d=b[0],f=b[1],g=a.length;if(2<=c&&c<=36&&g<=V/Math.log(c))return new e(parseInt(a,c));c=Q(c);var h,i=[],j="-"===a[0];for(h=j?1:0;h<a.length;h++){var k=a[h].toLowerCase(),l=k.charCodeAt(0);if(48<=l&&l<=57)i.push(Q(k));else if(97<=l&&l<=122)i.push(Q(k.charCodeAt(0)-87));else{if("<"!==k)throw new Error(k+" is not a valid character");var m=h;do h++;while(">"!==a[h]);i.push(Q(a.slice(m+1,h)))}}for(i.reverse(),h=0;h<i.length;h++)d=d.add(i[h].times(f)),f=f.times(c);return j?d.negate():d};c.prototype.toString=function(b){if(b===a&&(b=10),10!==b)return N(this,b);for(var c,d=this.value,e=d.length,f=String(d[--e]),g="0000000";--e>=0;)c=String(d[e]),f+=g.slice(c.length)+c;var h=this.sign?"-":"";return h+f},e.prototype.toString=function(b){return b===a&&(b=10),10!=b?N(this,b):String(this.value)},c.prototype.valueOf=function(){return+this.toString()},c.prototype.toJSNumber=c.prototype.valueOf,e.prototype.valueOf=function(){return this.value},e.prototype.toJSNumber=e.prototype.valueOf;for(var aa=0;aa<1e3;aa++)b[aa]=new e(aa),aa>0&&(b[-aa]=new e(-aa));return b.one=b[1],b.zero=b[0],b.minusOne=b[-1],b.max=H,b.min=I,b.gcd=J,b.lcm=K,b.isInstance=function(a){return a instanceof c||a instanceof e},b.randBetween=L,b}());return"undefined"!=typeof c&&c.hasOwnProperty("exports")&&(c.exports=d),c.exports}),a.registerDynamic("3",["2"],!0,function(a,b,c){this||self;return function(){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,$,_,aa,ba,ca,da,ea,fa,ga,ha,ia,ja,ka,la,ma,na,oa,pa,qa,ra,sa,ta,ua,va,wa,xa,ya,za,Aa,Ba,Ca,Da,Ea,Fa,Ga,Ha,Ia,Ja,Ka,La,Ma,Na,Oa,Pa,Qa,Ra,Sa,Ta,Ua,Va,Wa,Xa,Ya,Za,$a,_a,ab,bb,cb,db,eb,fb,gb,hb,ib,jb,kb,lb,mb,nb,ob,pb,qb,rb,sb,tb,ub,vb,wb,xb,yb,zb,Ab,Bb,Cb,Db,Eb,Fb,Gb,Hb,Ib,Jb,Kb,Lb,Mb,Nb,Ob,Pb,Qb,Rb,Sb,Tb,Ub,Vb,Wb,Xb,Yb,Zb,$b,_b,ac,bc,cc,dc,ec,fc,gc,hc,ic,jc,kc,lc,mc,nc,oc,pc,qc,rc,sc,tc,uc,vc,wc,xc,yc,zc,Ac,Bc,Cc,Dc,Ec,Fc,Gc,Hc,Ic,Jc,Kc,Lc,Mc,Nc,Oc,Pc,Qc,Rc,Sc,Tc,Uc,Vc,Wc,Xc,Yc,Zc,$c,_c,ad,bd,cd,dd,ed,fd,gd,hd,id,jd,kd,ld,md,nd,od,pd,qd,rd,sd,td,ud,vd,wd,xd,yd,zd,Ad,Bd,Cd,Dd,Ed,Fd,Gd,Hd,Id,Jd,Kd,Ld,Md,Nd,Od,Pd,Qd,Rd,Sd,Td,Ud,Vd,Wd,Xd,Yd,Zd,$d,_d,ae,be,ce,de,ee,fe,ge,he,ie,je,ke,le,me,ne,oe,pe,qe,re,se,te,ue,ve,we,xe,ye,ze,Ae,Be,Ce,De,Ee,Fe,Ge,He,Ie,Je,Ke,Le,Me,Ne,Oe,Pe,Qe,Re,Se,Te,Ue,Ve,We,Xe,Ye,Ze,$e,_e,af,bf,cf,df,ef,ff,gf,hf,jf,kf,lf,mf,nf,of,pf,qf,rf,sf,tf,uf,vf,wf,xf,yf,zf,Af,Bf,Cf,Df,Ef,Ff,Gf,Hf,If,Jf,Kf,Lf,Mf,Nf,Of,Pf,Qf,Rf,Sf,Tf,Uf,Vf,Wf,Xf,Yf,Zf,$f,_f,ag,bg,cg,dg,eg,fg,gg,hg,ig,jg,kg,lg,mg,ng,og,pg,qg,rg,sg,tg,ug,vg,wg,xg,yg,zg,Ag,Bg,Cg,Dg,Eg,Fg,Gg,Hg,Ig,Jg,Kg,Lg,Mg,Ng,Og,Pg,Qg,Rg,Sg,Tg,Ug,Vg,Wg,Xg,Yg,Zg,$g,_g,ah,bh,ch,dh,eh,fh,gh,hh,ih,jh,kh,lh,mh,nh,oh,ph,qh,rh,sh,th,uh,vh,wh,xh,yh,zh,Ah,Bh,Ch,Dh,Eh,Fh,Gh,Hh,Ih,Jh,Kh,Lh,Mh,Nh,Oh,Ph,Qh,Rh,Sh,Th,Uh,Vh,Wh,Xh,Yh,Zh,$h,_h,ai,bi,ci,di,ei,fi,gi,hi,ii,ji,ki,li,mi,ni,oi,pi,qi,ri,si,ti,ui,vi,wi,xi,yi,zi,Ai,Bi,Ci,Di,Ei,Fi,Gi,Hi,Ii,Ji,Ki,Li,Mi,Ni,Oi,Pi,Qi,Ri,Si,Ti,Ui,Vi,Wi,Xi,Yi,Zi,$i,_i,aj,bj,cj,dj,ej,fj,gj,hj,ij,jj,kj,lj,mj,nj,oj,pj,qj,rj,sj,tj,uj,vj,wj,xj,yj,zj,Aj,Bj,Cj,Dj,Ej,Fj,Gj,Hj,Ij,Jj,Kj,Lj,Mj,Nj,Oj,Pj,Qj,Rj,Sj,Tj,Uj,Vj,Wj,Xj,Yj,Zj,$j,_j,ak,bk,ck,dk,ek,fk,gk,hk,ik,jk,kk,lk,mk,nk,ok,pk,qk,rk,sk,tk,uk,vk,wk,xk,yk,zk,Ak,Bk,Ck,Dk,Ek,Fk,Gk,Hk,Ik,Jk,Kk,Lk,Mk,Nk,Ok,Pk,Qk,Rk,Sk,Tk,Uk,Vk,Wk,Xk,Yk,Zk,$k,_k,al,bl,cl,dl,el,fl,gl,hl,il,jl,kl,ll,ml,nl,ol,pl,ql,rl,sl,tl,ul,vl,wl,xl,yl,zl,Al,Bl,Cl,Dl,El,Fl,Gl,Hl,Il,Jl,Kl,Ll,Ml,Nl,Ol,Pl,Ql,Rl,Sl,Tl,Ul,Vl,Wl,Xl,Yl,Zl,$l,_l,am,bm,cm,dm,em,fm,gm,hm,im,jm,km,lm,mm,nm,om,pm,qm,rm,sm,tm,um,vm,wm,xm,ym,zm,Am,Bm,Cm,Dm,Em,Fm,Gm,Hm,Im,Jm,Km,Lm,Mm,Nm,Om,Pm,Qm,Rm,Sm,Tm,Um,Vm,Wm,Xm,Ym,Zm,$m,_m,an,bn,cn,dn,en,fn,gn,hn,kn,ln,mn,nn,on,pn,qn,rn,sn,tn,un,vn,wn,xn,zn,An,Bn,Cn,Dn,En,Fn,Gn,Hn,In,Jn,Kn,Ln,Mn,Nn,On,Pn,Qn,Rn,Sn,Tn,Un,Vn,Wn,Xn,Yn,Zn,$n,_n,ao,bo,co,eo,fo,go,ho,io,jo,ko,lo,mo,no,oo,po,qo,ro,so,to,uo,vo,wo,xo,yo,zo,Ao,Bo,Co,Do,Eo,Fo,Go,Ho,Io,Jo,Ko,Lo,Mo,No,Oo,Po,Qo,Ro,So,To,Uo,Vo,Wo,Xo,Yo,Zo,$o,_o,ap,bp,cp,dp,ep,fp,gp,hp,ip,jp,kp,lp,mp,np,op,pp,qp,rp,sp,tp,up,vp,wp,xp,yp,zp,Ap,Bp,Cp,Dp,Ep,Fp,Gp,Hp,Ip,Jp,Kp,Lp,Mp,Np,Op,Pp,Qp,Rp,Sp,Tp,Up,Vp,Wp,Xp,Yp,Zp,$p,_p,aq,bq,cq,dq,eq,fq,gq,hq,iq,jq,kq,lq,mq,nq,oq,pq,qq,rq,sq,tq,uq,vq,wq,xq,yq,zq,Aq,Bq,Cq,Dq,Eq,Fq,Gq,Hq,Iq,Jq,Kq,Lq,Mq,Nq,Oq,Pq,Qq,Rq,Sq,Tq,Uq,Vq,Wq,Xq,Yq,Zq,$q,_q,ar=[].slice;for(Yf=a("2"),he=1,Od=1e3,S=!1,$d=!1,wo=function(){function a(){}return a.prototype.a=null,a.prototype.b=null,a}(),ef=function(){function a(){this.cons={},this.cons.car=null,this.cons.cdr=null,this.q=new wo}return a.prototype.cons=null,a.prototype.printname="",a.prototype.str="",a.prototype.tensor=null,a.prototype.q=null,a.prototype.d=0,a.prototype.k=0,a.prototype.tag=0,a.prototype.toString=function(){return Yg(this)},a}(),aj="",N=0,Pd=1,ea=2,se=3,Me=4,ve=5,rh=0,d=rh++,e=rh++,f=rh++,g=rh++,h=rh++,i=rh++,j=rh++,k=rh++,l=rh++,m=rh++,n=rh++,o=rh++,r=rh++,s=rh++,t=rh++,u=rh++,D=rh++,E=rh++,F=rh++,G=rh++,H=rh++,I=rh++,J=rh++,K=rh++,L=rh++,M=rh++,O=rh++,P=rh++,Q=rh++,T=rh++,U=rh++,V=rh++,W=rh++,X=rh++,Y=rh++,$=rh++,_=rh++,aa=rh++,ba=rh++,ca=rh++,da=rh++,fa=rh++,ha=rh++,ja=rh++,ka=rh++,la=rh++,qa=rh++,ra=rh++,sa=rh++,ta=rh++,ua=rh++,va=rh++,wa=rh++,Oc=rh++,Pc=rh++,Qc=rh++,Rc=rh++,Sc=rh++,Tc=rh++,Uc=rh++,Wc=rh++,Xc=rh++,Yc=rh++,Zc=rh++,$c=rh++,_c=rh++,ad=rh++,bd=rh++,cd=rh++,dd=rh++,gd=rh++,hd=rh++,id=rh++,kd=rh++,ld=rh++,md=rh++,nd=rh++,pd=rh++,yd=rh++,Cd=rh++,Gd=rh++,Hd=rh++,Qd=rh++,Rd=rh++,Sd=rh++,Td=rh++,Ud=rh++,Wd=rh++,Xd=rh++,Yd=rh++,Zd=rh++,_d=rh++,ae=rh++,be=rh++,ce=rh++,de=rh++,ee=rh++,kf=rh++,fe=rh++,ie=rh++,je=rh++,le=rh++,me=rh++,ne=rh++,ke=rh++,qe=rh++,re=rh++,te=rh++,ue=rh++,Je=rh++,Ke=rh++,Le=rh++,Ne=rh++,Oe=rh++,Pe=rh++,Qe=rh++,Re=rh++,Se=rh++,Ve=rh++,ff=rh++,lf=rh++,Fd=rh++,p=rh++,q=rh++,jd=rh++,Ue=rh++,We=rh++,jf=rh++,ga=rh++,ud=rh++,vd=rh++,wd=rh++,ge=rh++,Vd=rh++,we=rh++,xe=rh++,ye=rh++,ze=rh++,Ae=rh++,Be=rh++,Ce=rh++,De=rh++,Ee=rh++,Fe=rh++,Ge=rh++,He=rh++,Ie=rh++,x=rh++,y=rh++,z=rh++,A=rh++,B=rh++,C=rh++,gf=rh++,ia=jf,Te=1e5,w=1e4,sd=100001,rd=1e4,qd=24,Up=function(){function a(){this.dim=function(){var a,b,c;for(c=[],a=0,b=qd;0<=b?a<=b:a>=b;0<=b?a++:a--)c.push(0);return c}(),this.elem=[]}return a.prototype.ndim=0,a.prototype.dim=null,a.prototype.nelem=0,a.prototype.elem=null,a}(),bi=function(){function a(){}return a.prototype.h=0,a.prototype.w=0,a.prototype.n=0,a.prototype.a=[],a}(),Yp=function(){function a(){}return a.prototype.ascent=0,a.prototype.descent=0,a.prototype.width=0,a}(),cq=0,kj=0,Tj=0,Rj=0,Sj=0,nq=0,In=function(){var a,b,c,d;for(d=[2],b=3;d.length<rd;){for(c=0,a=Math.sqrt(b);c<d.length&&d[c]<=a;){if(b%d[c]===0){c=-1;break}c++}c!==-1&&d.push(b),b+=2}return d[rd]=0,d}(),bj=0,oi=0,sm=0,fq=0,Ql="",ao="",Rp=[],dg=[],Sf=[],Cp=[],Uj=0,cn=null,dn=null,en=null,fn=null,gn=null,hn=null,kn=null,ln=null,mn=null,nn=null,_q=null,Ym=null,vk=null,Rp=[],$m="",_m=0,Xp=0,pi=null,Pp=function(a){return Rp[a]},Tk=function(a){return a.k===N},yl=function(a){return a.k===Pd},Wk=function(a){return a.k===ea},nl=function(a){return yl(a)||Wk(a)},Al=function(a){return a.k===se},Dl=function(a){if(null!=a)return a.k===Me},Bl=function(a){return a.k===ve},el=function(a){return Bl(a)&&Qp(a)<Fd},ug=function(a){return Tk(a)?a.cons.car:Pp(Fd)},Eg=function(a){return Tk(a)?a.cons.cdr:Pp(Fd)},jg=function(a){return ug(ug(a))},tg=function(a){return ug(Eg(a))},xg=function(a){return Eg(ug(a))},Dg=function(a){return Eg(Eg(a))},ig=function(a){return ug(ug(Eg(a)))},sg=function(a){return ug(Eg(Eg(a)))},mg=function(a){return ug(Eg(ug(a)))},wg=function(a){return Eg(ug(Eg(a)))},zg=function(a){return Eg(Eg(ug(a)))},Cg=function(a){return Eg(Eg(Eg(a)))},hg=function(a){return ug(ug(Eg(Eg(a))))},lg=function(a){return ug(Eg(ug(Eg(a))))},pg=function(a){return ug(Eg(Eg(ug(a))))},vg=function(a){return Eg(ug(Eg(Eg(a))))},rg=function(a){return ug(Eg(Eg(Eg(a))))},Bg=function(a){return Eg(Eg(Eg(Eg(a))))},qg=function(a){return ug(Eg(Eg(Eg(Eg(a)))))},kg=function(a){return ug(Eg(ug(Eg(Eg(a)))))},yg=function(a){return Eg(Eg(ug(Eg(Eg(a)))))},og=function(a){return ug(Eg(Eg(ug(Eg(a)))))},Ag=function(a){return Eg(Eg(Eg(ug(Eg(Eg(a))))))},ng=function(a){return ug(Eg(Eg(ug(Eg(Eg(a))))))},Pk=function(a){return ug(a)===Pp(e)},hl=function(a){return ug(a)===Pp(Cd)},wl=function(a){return ug(a)===Pp(Xd)},Zk=function(a){return ug(a)===Pp(Pc)},Bd=function(a){return a.isPositive()?1:a.isZero()?0:-1},xd=function(a){return a.toString().length},Dd=function(a){return a.isZero()},td=function(a,b){return a.equals(b)},c="undefined"!=typeof b&&null!==b?b:this,c.isadd=Pk,c.ismultiply=hl,c.ispower=wl,c.isfactorial=Zk,c.car=ug,c.cdr=Eg,c.caar=jg,c.cadr=tg,c.cdar=xg,c.cddr=Dg,c.caadr=ig,c.caddr=sg,c.cadar=mg,c.cdadr=wg,c.cddar=zg,c.cdddr=Cg,c.caaddr=hg,c.cadadr=lg,c.caddar=pg,c.cdaddr=vg,c.cadddr=rg,c.cddddr=Bg,c.caddddr=qg,c.cadaddr=kg,c.cddaddr=yg,c.caddadr=og,c.cdddaddr=Ag,c.caddaddr=ng,c.symbol=Pp,c.iscons=Tk,c.isrational=yl,c.isdouble=Wk,c.isnum=nl,c.isstr=Al,c.istensor=Dl,c.issymbol=Bl,c.iskeyword=el,c.CONS=N,c.NUM=Pd,c.DOUBLE=ea,c.STR=se,c.TENSOR=Me,c.SYM=ve,za=function(){return co(tg(dn)),xa(),yf()},yf=function(){var a;if(a=0,No(),dn=zn(),Dl(dn))return zf(),void Go();if(nl(dn))return co(dn),jl(dn)&&Dm(),void Go();if(Sk(dn))return co(dn),co(dn),fh(),um(),ko(1,2),Dn(),void Go();if(ug(dn)===Pp(Xd)&&kl(sg(dn)))return co(dn),Ao(),yf(),Ao(),void Go();if(ug(dn)===Pp(Cd)){for(a=cq,dn=Eg(dn);Tk(dn);)co(ug(dn)),yf(),dn=Eg(dn);return vm(cq-a),void Go()}return(kl(dn)||ug(dn)===Pp(e)&&kl(tg(dn)))&&(co(dn),Dm(),dn=zn()),lo(d),co(dn),Ol(2),Go()},zf=function(){return 1!==dn.tensor.ndim&&Hp("abs(tensor) with tensor rank > 1"),co(dn),co(dn),fh(),Ak(),ko(1,2),Dn(),qp(),xa()},Qj=0,Aa=function(){var a;for(a=cq,dn=Eg(dn);Tk(dn);)co(ug(dn)),xa(),en=zn(),no(en),dn=Eg(dn);return Ff(cq-a)},Dp=0,Ff=function(a){var b,c,d,f,g,h,i,j,k,l;if(Dp++,f=0,d=cq-a,k=d,S&&console.log("stack before adding terms #"+Dp),S)for(f=g=0,h=cq;0<=h?g<h:g>h;f=0<=h?++g:--g)Jn(Cp[f]);for(f=b=0;b<10&&!(a<2)&&(Qj=0,l=Cp.slice(d,d+a),l.sort(Ug),Cp=Cp.slice(0,d).concat(l).concat(Cp.slice(d+a)),0!==Qj);f=++b)a=_g(d,a);switch(cq=d+a,a){case 0:jo(0);break;case 1:break;default:Ol(a),dn=zn(),lo(e),co(dn),gh()}if(S&&console.log("stack after adding terms #"+Dp),S){for(j=[],f=c=0,i=cq;0<=i?c<i:c>i;f=0<=i?++c:--c)j.push(Jn(Cp[f]));return j}},Vg=0,Ug=function(a,b){var c,d,e,f;if(Vg++,c=0,nl(a)&&nl(b))return Qj=1,0;if(Dl(a)&&Dl(b)){if(a.tensor.ndim<b.tensor.ndim)return-1;if(a.tensor.ndim>b.tensor.ndim)return 1;for(c=d=0,e=a.tensor.ndim;0<=e?d<e:d>e;c=0<=e?++d:--d){if(a.tensor.dim[c]<b.tensor.dim[c])return-1;if(a.tensor.dim[c]>b.tensor.dim[c])return 1}return Qj=1,0}return ug(a)===Pp(Cd)&&(a=Eg(a),nl(ug(a))&&(a=Eg(a),Eg(a)===Pp(Fd)&&(a=ug(a)))),
ug(b)===Pp(Cd)&&(b=Eg(b),nl(ug(b))&&(b=Eg(b),Eg(b)===Pp(Fd)&&(b=ug(b)))),f=Tg(a,b),0===f&&(Qj=1),f},_g=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t;for(g=0;g<b-1;)if(Ig(),fn=Cp[a+g],gn=Cp[a+g+1],Dl(fn)&&Dl(gn)){if(co(fn),co(gn),Vp(),dn=zn(),dn!==Pp(Fd)){for(Cp[a+g]=dn,h=i=j=g+1,k=b-1;j<=k?i<k:i>k;h=j<=k?++i:--i)Cp[a+h]=Cp[a+h+1];b--,g--}g++}else if(Dl(fn)||Dl(gn))g++;else if(nl(fn)&&nl(gn)){if(co(fn),co(gn),Ef(),dn=zn(),El(dn)){for(h=c=l=g,m=b-2;l<=m?c<m:c>m;h=l<=m?++c:--c)Cp[a+h]=Cp[a+h+2];b-=2}else{for(Cp[a+g]=dn,h=d=n=g+1,o=b-1;n<=o?d<o:d>o;h=n<=o?++d:--d)Cp[a+h]=Cp[a+h+1];b--}g--,g++}else if(nl(fn)||nl(gn))g++;else if(dn=Ym,en=Ym,t=0,ug(fn)===Pp(Cd)&&(fn=Eg(fn),t=1,nl(ug(fn))&&(dn=ug(fn),fn=Eg(fn),Eg(fn)===Pp(Fd)&&(fn=ug(fn),t=0))),ug(gn)===Pp(Cd)&&(gn=Eg(gn),nl(ug(gn))&&(en=ug(gn),gn=Eg(gn),Eg(gn)===Pp(Fd)&&(gn=ug(gn)))),Yi(fn,gn))if(co(dn),co(en),Ef(),dn=zn(),El(dn)){for(h=e=p=g,q=b-2;p<=q?e<q:e>q;h=p<=q?++e:--e)Cp[a+h]=Cp[a+h+2];b-=2,g--,g++}else{for(co(dn),t?(co(Pp(Cd)),co(fn),gh()):co(fn),um(),Cp[a+g]=zn(),h=f=r=g+1,s=b-1;r<=s?f<s:f>s;h=r<=s?++f:--f)Cp[a+h]=Cp[a+h+1];b--,g--,g++}else g++;return b},no=function(a){var b;if(ug(a)===Pp(e)){for(a=Eg(a),b=[];Tk(a);)co(ug(a)),b.push(a=Eg(a));return b}if(!El(a))return co(a)},Cf=function(){var a;return No(),en=zn(),dn=zn(),a=cq,no(dn),no(en),Ff(cq-a),Go()},Df=function(a){var b,c,d,e,f;for(c=0,No(),f=cq-a,b=cq,c=d=0,e=a;0<=e?d<e:d>e;c=0<=e?++d:--d)no(Cp[f+c]);return Ff(cq-b),dn=zn(),cq-=a,co(dn),Go()},Mp=function(){return Dm(),Cf()},Ba=function(){return co(tg(dn)),xa(),Hf()},Hf=function(){var a,b,c,d,e,f,g,h;for(c=0,d=0,e=0,No(),dn=zn(),Dl(dn)&&2===dn.tensor.ndim&&dn.tensor.dim[0]===dn.tensor.dim[1]?b=1:Hp("adj: square matrix expected"),e=dn.tensor.dim[0],en=If(e*e),en.tensor.ndim=2,en.tensor.dim[0]=e,en.tensor.dim[1]=e,c=f=0,g=e;0<=g?f<g:f>g;c=0<=g?++f:--f)for(d=a=0,h=e;0<=h?a<h:a>h;d=0<=h?++a:--a)Xg(dn,e,c,d),en.tensor.elem[e*d+c]=zn();return co(en),Go()},Da=function(){return co(tg(dn)),xa(),Lf()},Lf=function(){var a,b,c;if(c=0,a=0,No(),dn=zn(),ug(dn)===Pp(P))return co(tg(dn)),void Go();if(Wk(dn))return b=0,a=Math.acos(dn.d),b&&Hp("arccos function argument is not in the interval [-1,1]"),fo(a),void Go();if(pl(dn))return ko(1,4),lo(Vd),um(),void Go();if(gl(dn))return ko(3,4),lo(Vd),um(),void Go();if(!yl(dn))return lo(h),co(dn),Ol(2),void Go();switch(co(dn),jo(2),um(),c=Cn()){case-2:lo(Vd);break;case-1:ko(2,3),lo(Vd),um();break;case 0:ko(1,2),lo(Vd),um();break;case 1:ko(1,3),lo(Vd),um();break;case 2:co(_q);break;default:lo(h),co(dn),Ol(2)}return Go()},Ea=function(){return co(tg(dn)),xa(),Mf()},Mf=function(){var a;return a=0,No(),dn=zn(),ug(dn)===Pp(Q)?(co(tg(dn)),void Go()):Wk(dn)?(a=dn.d,a<1&&Hp("arccosh function argument is less than 1.0"),a=Math.log(a+Math.sqrt(a*a-1)),fo(a),void Go()):ql(dn)?(co(_q),void Go()):(lo(i),co(dn),Ol(2),Go())},Fa=function(){return co(tg(dn)),xa(),Nf()},Nf=function(){var a,b,c;if(c=0,a=0,No(),dn=zn(),ug(dn)===Pp(me))return co(tg(dn)),void Go();if(Wk(dn))return b=0,a=Math.asin(dn.d),b&&Hp("arcsin function argument is not in the interval [-1,1]"),fo(a),void Go();if(pl(dn))return ko(1,4),lo(Vd),um(),void Go();if(gl(dn))return ko(-1,4),lo(Vd),um(),void Go();if(!yl(dn))return lo(j),co(dn),Ol(2),void Go();switch(co(dn),jo(2),um(),c=Cn()){case-2:ko(-1,2),lo(Vd),um();break;case-1:ko(-1,6),lo(Vd),um();break;case 0:co(_q);break;case 1:ko(1,6),lo(Vd),um();break;case 2:ko(1,2),lo(Vd),um();break;default:lo(j),co(dn),Ol(2)}return Go()},Ga=function(){return co(tg(dn)),xa(),Of()},Of=function(){var a;return a=0,No(),dn=zn(),ug(dn)===Pp(ne)?(co(tg(dn)),void Go()):Wk(dn)?(a=dn.d,a=Math.log(a+Math.sqrt(a*a+1)),fo(a),void Go()):El(dn)?(co(_q),void Go()):(lo(k),co(dn),Ol(2),Go())},Ha=function(){return co(tg(dn)),xa(),Pf()},Pf=function(){var a,b;return a=0,No(),dn=zn(),ug(dn)===Pp(Je)?(co(tg(dn)),void Go()):Wk(dn)?(b=0,a=Math.atan(dn.d),b&&Hp("arctan function error"),fo(a),void Go()):El(dn)?(co(_q),void Go()):il(dn)?(co(dn),Dm(),Pf(),Dm(),void Go()):Vc(dn,Pp(me))&&Vc(dn,Pp(P))&&(co(dn),Vm(),en=zn(),co(dn),Sh(),fn=zn(),ug(en)===Pp(me)&&ug(fn)===Pp(P)&&Yi(tg(en),tg(fn)))?(co(tg(en)),void Go()):ug(dn)===Pp(Xd)&&Zi(tg(dn),3)&&$i(sg(dn),-1,2)?(ko(1,6),co(Pp(Vd)),um(),void Go()):Zi(dn,1)?(ko(1,4),co(Pp(Vd)),um(),void Go()):ug(dn)===Pp(Xd)&&Zi(tg(dn),3)&&$i(sg(dn),1,2)?(ko(1,3),co(Pp(Vd)),um(),void Go()):(lo(l),co(dn),Ol(2),Go())},Ia=function(){return co(tg(dn)),xa(),Qf()},Qf=function(){var a;return a=0,No(),dn=zn(),ug(dn)===Pp(Ke)?(co(tg(dn)),void Go()):Wk(dn)?(a=dn.d,(a<-1||a>1)&&Hp("arctanh function argument is not in the interval [-1,1]"),a=Math.log((1+a)/(1-a))/2,fo(a),void Go()):El(dn)?(co(_q),void Go()):(lo(m),co(dn),Ol(2),Go())},Ja=function(){return co(tg(dn)),xa(),Rf()},Rf=function(){return No(),dn=zn(),co(dn),Vm(),xq(),co(dn),Sh(),xq(),Mp(),Go()},xq=function(){if(No(),dn=zn(),jl(dn))co(Pp(Vd)),Dm();else if(ug(dn)===Pp(Xd)&&Zi(tg(dn),-1))co(Pp(Vd)),co(sg(dn)),um();else if(ug(dn)===Pp(Xd)&&tg(dn)===Pp(ia))co(sg(dn)),uk();else if(ug(dn)===Pp(Cd))for(jo(0),dn=Eg(dn);Tk(dn);)co(ug(dn)),Rf(),Cf(),dn=Eg(dn);else ug(dn)===Pp(e)?(co(dn),Bo(),dn=zn(),co(dn),zo(),en=zn(),co(dn),uk(),fn=zn(),El(en)?(co(Pp(Vd)),il(fn)&&Dm()):(co(fn),co(en),ei(),Pf(),il(en)&&(lo(Vd),il(fn)?Mp():Cf()))):jo(0);return Go()},Tf=function(){var a,b,c,d,e,f;if(a=0,b=0,c=0,d=0,e=0,f=0,kj++,No(),dn=zn(),b=rl(dn,Pp(Ee)),c=rl(dn,Pp(Fe)),d=rl(dn,Pp(Ge)),e=rl(dn,Pp(He)),f=rl(dn,Pp(Ie)),1===b&&0===c&&0===d&&0===e&&0===f)en=Pp(Ee),Uf();else if(0===b&&1===c&&0===d&&0===e&&0===f)en=Pp(Fe),Uf();else if(0===b&&0===c&&1===d&&0===e&&0===f)en=Pp(Ge),Uf();else if(0===b&&0===c&&0===d&&1===e&&0===f)en=Pp(He),Uf();else if(0===b&&0===c&&0===d&&0===e&&1===f)en=Pp(Ie),Uf();else if(Tk(dn)){for(a=cq,co(ug(dn)),dn=Eg(dn);Tk(dn);)co(ug(dn)),Tf(),dn=Eg(dn);Ol(cq-a)}else co(dn);return Go(),kj--},xn=function(){var a;if(a=0,No(),en=zn(),dn=zn(),rl(dn,en))Uf();else if(Tk(dn)){for(a=cq,co(ug(dn)),dn=Eg(dn);Tk(dn);)co(ug(dn)),co(en),xn(),dn=Eg(dn);Ol(cq-a)}else co(dn);return Go()},Uf=function(){var a,b,c,d,f,g,h;for(b=0,c=0,d=0,f=0,a=cq,co(dn),co(en),d=Wg(),b=cq,c=g=h=d-1;g>=0;c=g+=-1)dn=Cp[a+c],Vf(c);return f=cq-b,f>1&&(Ol(f),co(Pp(e)),Op(),gh()),dn=zn(),cq-=d,co(dn)},Vf=function(a){var b,c;if(b=0,c=0,!El(dn)){if(0!==a){if(b=cq,ug(dn)===Pp(Cd))for(dn=Eg(dn);Tk(dn);)co(ug(dn)),dn=Eg(dn);else Zi(dn,1)||co(dn);return 1===a?co(en):(co(Pp(Xd)),co(en),jo(a),Ol(3)),c=cq-b,c>1?(Ol(c),co(Pp(Cd)),Op(),gh()):void 0}if(ug(dn)===Pp(e))for(dn=Eg(dn);Tk(dn);)co(ug(dn)),dn=Eg(dn);else co(dn)}},Ka=function(){return co(tg(dn)),xa(),co(sg(dn)),xa(),Wf()},Wf=function(){return No(),yq(),Go()},yq=function(){var a,b;return a=0,b=0,en=zn(),dn=zn(),co(en),b=Cn(),Wk(dn)&&2147483648!==b?(a=jn(b,dn.d),void fo(a)):El(dn)&&El(en)?void jo(1):El(dn)&&2147483648!==b?void jo(0):en.k===Pd&&td(en.q.b,2)?td(en.q.a,1)?(jo(2),lo(Vd),ei(),co(dn),ei(),ko(1,2),Dn(),co(dn),wp(),void um()):td(en.q.a,-1)?(jo(2),lo(Vd),ei(),co(dn),ei(),ko(1,2),Dn(),co(dn),mh(),void um()):(jo(Bd(en.q.a)),fn=zn(),jo(2),co(dn),ei(),co(en),co(fn),Mp(),um(),co(dn),co(en),co(fn),Mp(),Wf(),um(),co(dn),co(en),jo(2),co(fn),um(),Mp(),Wf(),void Mp()):kl(dn)?(co(dn),Dm(),co(en),Dn(),co(dn),co(en),Dm(),Dn(),um(),lo(r),co(dn),Dm(),co(en),Ol(3),void um()):kl(en)?(jo(-1),co(en),Dn(),lo(r),co(dn),co(en),Dm(),Ol(3),void um()):(co(Pp(r)),co(dn),co(en),Ol(3))},La=function(){return co(tg(dn)),xa(),co(sg(dn)),xa(),Xf()},Xf=function(){return No(),zq(),Go()},zq=function(){var a,b;return a=0,b=0,en=zn(),dn=zn(),co(en),b=Cn(),Wk(dn)&&2147483648!==b?(a=yn(b,dn.d),void fo(a)):kl(en)?(jo(-1),co(en),Dn(),lo(s),co(dn),co(en),Dm(),Ol(3),void um()):(lo(s),co(dn),co(en),void Ol(3))},Ad=2,zd=1e3,sm=0,Vj=[],dm=function(a){return Yf(a)},dp=function(a,b){if(a.isPositive()){if(b<0)return a.multiply(Yf(-1))}else if(b>0)return a.multiply(Yf(-1));return a},Wl=function(a,b){if(a.isPositive()){if(b.isNegative())return a.multiply(Yf(-1))}else if(b.isPositive())return a.multiply(Yf(-1));return a},Vl=function(a){return a.isNegative()?a.multiply(Yf(-1)):a},Ef=function(){var a,b,c;return a=1,b=1,yl(Cp[cq-1])&&yl(Cp[cq-2])?void po():(No(),en=zn(),dn=zn(),a=Wk(dn)?dn.d:kh(dn),b=Wk(en)?en.d:kh(en),c=a+b,fo(c),Go())},Np=function(){var a,b;return a=0,b=0,yl(Cp[cq-1])&&yl(Cp[cq-2])?void qsub():(No(),en=zn(),dn=zn(),a=Wk(dn)?dn.d:kh(dn),b=Wk(en)?en.d:kh(en),fo(a-b),Go())},Bm=function(){var a,b;return a=0,b=0,yl(Cp[cq-1])&&yl(Cp[cq-2])?void ro():(No(),en=zn(),dn=zn(),a=Wk(dn)?dn.d:kh(dn),b=Wk(en)?en.d:kh(en),fo(a*b),Go())},fi=function(){var a,b;return a=0,b=0,yl(Cp[cq-1])&&yl(Cp[cq-2])?void qo():(No(),en=zn(),dn=zn(),El(en)&&Hp("divide by zero"),a=Wk(dn)?dn.d:kh(dn),b=Wk(en)?en.d:kh(en),fo(a/b),Go())},Jk=function(){var a,b;return No(),dn=zn(),El(dn)&&Hp("divide by zero"),Wk(dn)?(fo(1/dn.d),void Go()):(a=Yf(dn.q.a),b=Yf(dn.q.b),b=Wl(b,a),a=dp(a,1),dn=new ef,dn.k=Pd,dn.q.a=b,dn.q.b=a,co(dn),Go())},bh=function(a,b){var c,d,e;return e=0,c=fm(a.q.a,b.q.b),d=fm(a.q.b,b.q.a),e=Yl(c,d)},ah=function(a,b){var c,d;return c=0,d=0,yl(a)&&yl(b)?bh(a,b):(c=Wk(a)?a.d:kh(a),d=Wk(b)?b.d:kh(b),c<d?-1:c>d?1:0)},Gm=function(){if(No(),dn=zn(),El(dn))return co(dn),void Go();switch(dn.k){case Pd:en=new ef,en.k=Pd,en.q.a=Yf(dn.q.a.multiply(Yf.minusOne)),en.q.b=Yf(dn.q.b),co(en);break;case ea:fo(-dn.d);break;default:Hp("bug caught in mp_negate_number")}return Go()},cg=function(){var a;return No(),dn=zn(),a=$l(dn.q.a,dn.q.b),dn=new ef,dn.k=Pd,dn.q.a=a,dn.q.b=Yf(1),co(dn),Go()},lm=function(){return No(),dn=zn(),dn.k!==Pd?(co(Ym),void Go()):(en=new ef,en.k=Pd,en.q.a=Yf(dn.q.a),en.q.b=Yf(1),co(en),Go())},km=function(){return No(),dn=zn(),dn.k!==Pd?(co(Ym),void Go()):(en=new ef,en.k=Pd,en.q.a=Yf(dn.q.b),en.q.b=Yf(1),co(en),Go())},_f=function(a){var b,c,d;return No(),dn=zn(),b=nm(dn.q.a,Math.abs(a)),c=nm(dn.q.b,Math.abs(a)),a<0&&(d=b,b=c,c=d,b=Wl(b,c),c=dp(c,1)),dn=new ef,dn.k=Pd,dn.q.a=b,dn.q.b=c,co(dn),Go()},jh=function(a){return a.toJSNumber()},kh=function(a){var b,c;return null==a.q,b=a.q.a.divmod(a.q.b),c=b.quotient+b.remainder/a.q.b.toJSNumber()},jo=function(a){return S&&console.log("pushing integer "+a),No(),dn=new ef,dn.k=Pd,dn.q.a=Yf(a),dn.q.b=Yf(1),co(dn),Go()},fo=function(a){return No(),dn=new ef,dn.k=ea,dn.d=a,co(dn),Go()},ko=function(a,b){var c;return c=new ef,c.k=Pd,c.q.a=Yf(a),c.q.b=Yf(b),co(c)},Cn=function(){var a;switch(a=0,No(),dn=zn(),dn.k){case Pd:a=cl(dn)&&dn.q.a.isSmall?dn.q.a.toJSNumber():2147483648;break;case ea:a=Math.floor(dn.q.a);break;default:a=2147483648}return Go(),a},Nn=function(a,b){var c;return c="",c=""+ki(a.d),Un(1===b&&"-"===c?c+1:c)},bg=function(a){var b,c,d;return No(),c=0,d=a[c],"+"!==d&&"-"!==d||c++,b=Yf(a.substring(c)),dn=new ef,dn.k=Pd,dn.q.a=b,dn.q.b=Yf(1),co(dn),"-"===d&&Dm(),Go()},ag=function(a){return fo(parseFloat(a))},Tn=function(a,b){var c,d,e,f;switch(f=!1,null==b&&(f=!0,b=""),e="",d="",a.k){case Pd:c=a.q.a.toString(),"-"===c[0]&&(c=c.substring(1)),b+=c,Jp+=c,_k(a)&&(b+="/",Jp+="/",e=a.q.b.toString(),b+=e,Jp+=e);break;case ea:c=""+ki(a.d),"-"===c[0]&&(c=c.substring(1)),b+=c,Jp+=c}return b},ck=function(){return No(),en=zn(),dn=zn(),fn=new ef,fn.k=Pd,fn.q.a=bm(dn.q.a,en.q.a),fn.q.b=bm(dn.q.b,en.q.b),fn.q.a=dp(fn.q.a,1),co(fn),Go()},An=function(){var a;switch(a=0,No(),dn=zn(),dn.k){case Pd:a=kh(dn);break;case ea:a=dn.d;break;default:a=0}return Go(),a},$f=function(){var a;return a=0,a=kh(zn()),fo(a)},Zf=function(a){return No(),dn=new ef,dn.k=Pd,dn.q.a=pf(a),dn.q.b=Yf(1),co(dn),Go()},pf=function(a){var b,c,d,e,f,g;if(d=0,0===a||1===a)return b=Yf(1);if(b=Yf(2),c=Yf(0),3<=a)for(d=e=3,f=a;3<=f?e<=f:e>=f;d=3<=f?++e:--e)c=Yf(d),g=fm(b,c),b=g;return b},Xl=[1,2,4,8,16,32,64,128,256,512,1024,2048,4096,8192,16384,32768,65536,131072,262144,524288,1048576,2097152,4194304,8388608,16777216,33554432,67108864,134217728,268435456,536870912,1073741824,2147483648],mm=function(a,b){return console.log("not implemented yet"),a[b/32]|=Xl[b%32]},jm=function(a,b){return console.log("not implemented yet"),a[b/32]&=~Xl[b%32]},qm=function(a){return a=a.shiftRight()},Na=function(){return co(tg(dn)),xa(),co(sg(dn)),xa(),eg()},eg=function(){return No(),pq(),Go()},pq=function(){return en=zn(),dn=zn(),0===v()?void co(_q):(co(dn),Dj(),co(en),Dj(),ei(),co(dn),co(en),Mp(),Dj(),ei())},v=function(){return nl(dn)&&Ml(dn,_q)?0:nl(en)&&Ml(en,_q)?0:nl(dn)&&nl(en)&&Ml(dn,en)?0:1},Oa=function(){return co(tg(dn)),xa(),Fg()},Fg=function(){return No(),Aq(),Go()},Aq=function(){var a,b;return a=0,dn=zn(),nl(dn)?Wk(dn)?(a=Math.ceil(dn.d),void fo(a)):cl(dn)?void co(dn):(fn=new ef,fn.k=Pd,fn.q.a=$l(dn.q.a,dn.q.b),fn.q.b=dm(1),co(fn),jl(dn)?b=1:(jo(1),Cf())):(lo(D),co(dn),void Ol(2))},Qa=function(){return co(tg(dn)),xa(),co(sg(dn)),xa(),Kg()},Kg=function(){return No(),en=zn(),dn=zn(),0===Lg()?(jo(0),void Go()):(co(dn),Dj(),co(en),Dj(),ei(),co(dn),co(en),Mp(),Dj(),ei(),Go())},Lg=function(){return nl(dn)&&Ml(dn,_q)?0:nl(en)&&Ml(en,_q)?0:nl(dn)&&nl(en)&&Ml(dn,en)?0:1},Ra=function(){return co(tg(dn)),xa(),Mg(),xa()},Mg=function(){var a,b,c,d;if(b=0,a=0,No(),dn=zn(),ug(dn)===Pp(P))return co(tg(dn)),lj(),void Go();if(ug(dn)===Pp(me))return co(tg(dn)),oj(),void Go();if(ug(dn)===Pp(Je))return dn=tg(dn),co(vk),co(dn),um(),mj(),en=zn(),co(vk),co(dn),um(),Dm(),mj(),fn=zn(),co(fn),co(en),Mp(),co(vk),um(),co(en),co(fn),Cf(),ei(),void Go();if(ug(dn)===Pp(Q))return dn=tg(dn),co(dn),mj(),co(dn),Dm(),mj(),Cf(),ko(1,2),um(),void Go();if(ug(dn)===Pp(ne))return dn=tg(dn),co(dn),mj(),co(dn),Dm(),mj(),Mp(),ko(1,2),um(),void Go();if(ug(dn)===Pp(Ke))return dn=tg(dn),co(dn),jo(2),um(),mj(),dn=zn(),co(dn),jo(1),Mp(),co(dn),jo(1),Cf(),ei(),void Go();if(Tk(dn)){for(a=cq;Tk(dn);)co(ug(dn)),Mg(),dn=Eg(dn);return Ol(cq-a),void Go()}if(dn.k===Me){for(co(dn),lh(),dn=zn(),b=c=0,d=dn.tensor.nelem;0<=d?c<d:c>d;b=0<=d?++c:--c)co(dn.tensor.elem[b]),Mg(),dn.tensor.elem[b]=zn();return co(dn),void Go()}return co(dn),Go()},Sa=function(){return 0===Xp&&Pg(),Og(),Ph(),co(Pp(Fd))},Ng=function(){return Mo("clear")},Ta=function(){return co(tg(dn)),xa(),Qg()},Qg=function(){return No(),dn=zn(),co(dn),Ul(),jo(-1),co(dn),Rf(),co(Pp(Vd)),ei(),Dn(),um(),Go()},Ua=function(){return co(tg(dn)),xa(),co(sg(dn)),xa(),co(rg(dn)),xa(),fn=zn(),en=zn(),dn=zn(),fn===Pp(Fd)&&(fn=en,en=Pp(Ge)),co(dn),co(en),co(fn),Dn(),ei(),co(en),Ij()},Wg=function(){var a,b;for(No(),en=zn(),dn=zn(),a=cq;;){if(co(dn),co(en),co(_q),Lp(),xa(),fn=zn(),co(fn),co(dn),co(fn),Mp(),dn=zn(),Yi(dn,_q))return b=cq-a,Go(),b;co(dn),co(en),ei(),dn=zn()}},Va=function(){var a,b,c,d;return b=0,c=0,d=0,co(tg(dn)),xa(),en=zn(),Dl(en)&&2===en.tensor.ndim&&en.tensor.dim[0]===en.tensor.dim[1]?a=1:Hp("cofactor: 1st arg: square matrix expected"),d=en.tensor.dim[0],co(sg(dn)),xa(),b=Cn(),(b<1||b>d)&&Hp("cofactor: 2nd arg: row index expected"),co(rg(dn)),xa(),c=Cn(),(c<1||c>d)&&Hp("cofactor: 3rd arg: column index expected"),Xg(en,d,b-1,c-1)},Xg=function(a,b,c,d){var e,f,g,h,i,j;for(f=0,g=0,f=h=0,i=b;0<=i?h<i:h>i;f=0<=i?++h:--h)for(g=e=0,j=b;0<=j?e<j:e>j;g=0<=j?++e:--e)f!==c&&g!==d&&co(a.tensor.elem[b*f+g]);if(Yh(b-1),(c+d)%2)return Dm()},Wa=function(){return co(tg(dn)),xa(),R()},R=function(){var a;return a=0,a=kj,No(),Bq(),Go(),kj=a},Bq=function(){if(kj=0,dn=zn(),ug(dn)!==Pp(e))return void co(dn);for(fn=Eg(dn),co(ug(fn)),fn=Eg(fn);Tk(fn);)co(ug(fn)),Zj(),fn=Eg(fn);for(Ik(),en=zn(),co(_q),fn=Eg(dn);Tk(fn);)co(en),co(ug(fn)),um(),Cf(),fn=Eg(fn);return Jq(),co(en),ei()},Xa=function(){return co(tg(dn)),xa(),dn=zn(),co(dn),Vc(dn,vk)?fh():(vn(),fh(),Qg())},fh=function(){return co(vk),co(vk),Dm(),Lp(),xa()},hh=0,gh=function(){var a;return hh++,S&&console.log("cons tos: "+cq+" # "+hh),a=new ef,a.k=N,a.cons.cdr=zn(),a===a.cons.cdr&&console.log("something wrong p == its cdr"),a.cons.car=zn(),co(a)},Za=function(){return co(tg(dn)),xa(),Dg(dn)===Pp(Fd)?(jo(1),jo(2)):(co(sg(dn)),xa(),co(rg(dn)),xa()),ih()},ih=function(){return No(),Cq(),Go()},Cq=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A;if(k=0,l=0,m=0,n=0,o=0,p=0,q=0,r=0,s=0,h=[],i=[],fn=zn(),en=zn(),dn=zn(),!Dl(dn))return El(dn)||Hp("contract: tensor expected, 1st arg is not a tensor"),void co(_q);for(co(en),o=Cn(),co(fn),p=Cn(),r=dn.tensor.ndim,(o<1||o>r||p<1||p>r||o===p||dn.tensor.dim[o-1]!==dn.tensor.dim[p-1])&&Hp("contract: index out of range"),o--,p--,q=dn.tensor.dim[o],s=1,l=t=0,u=r;0<=u?t<u:t>u;l=0<=u?++t:--t)l!==o&&l!==p&&(s*=dn.tensor.dim[l]);for(en=If(s),en.tensor.ndim=r-2,m=0,l=b=0,v=r;0<=v?b<v:b>v;l=0<=v?++b:--b)l!==o&&l!==p&&(en.tensor.dim[m++]=dn.tensor.dim[l]);for(a=dn.tensor.elem,j=en.tensor.elem,l=c=0,w=r;0<=w?c<w:c>w;l=0<=w?++c:--c)h[l]=0,i[l]=dn.tensor.dim[l];for(l=d=0,x=s;0<=x?d<x:d>x;l=0<=x?++d:--d){for(co(_q),m=e=0,y=q;0<=y?e<y:e>y;m=0<=y?++e:--e){for(h[o]=m,h[p]=m,k=0,n=f=0,z=r;0<=z?f<z:f>z;n=0<=z?++f:--f)k=k*i[n]+h[n];co(a[k]),Cf()}for(j[l]=zn(),m=g=A=r-1;A<=0?g<=0:g>=0;m=A<=0?++g:--g)if(m!==o&&m!==p){if(++h[m]<i[m])break;h[m]=0}}return co(1===s?j[0]:en)},$a=function(){return co(tg(dn)),xa(),mh()},mh=function(){return No(),dn=zn(),ug(dn)===Pp(e)?oh():nh(),Go()},oh=function(){for(en=Eg(dn);Tk(en);){if(gn=ug(en),ml(gn))return co(dn),co(gn),Mp(),fn=zn(),co(fn),mh(),co(gn),mh(),um(),co(fn),wp(),co(gn),wp(),um(),void Mp();en=Eg(en)}return nh()},nh=function(){var a,b;if(ug(dn)===Pp(h))return void co(tg(dn));if(Wk(dn))return a=Math.cos(dn.d),Math.abs(a)<1e-10&&(a=0),void fo(a);if(il(dn)&&(co(dn),Dm(),dn=zn()),ug(dn)===Pp(l))return jo(1),co(tg(dn)),jo(2),Dn(),Cf(),ko(-1,2),void Dn();if(co(dn),jo(180),um(),lo(Vd),ei(),b=Cn(),b<0||2147483648===b)return co(Pp(P)),co(dn),void Ol(2);switch(b%360){case 90:case 270:return jo(0);case 60:case 300:return ko(1,2);case 120:case 240:return ko(-1,2);case 45:case 315:return ko(1,2),jo(2),ko(1,2),Dn(),um();case 135:case 225:return ko(-1,2),jo(2),ko(1,2),Dn(),um();case 30:case 330:return ko(1,2),jo(3),ko(1,2),Dn(),um();case 150:case 210:return ko(-1,2),jo(3),ko(1,2),Dn(),um();case 0:return jo(1);case 180:return jo(-1);default:return co(Pp(P)),co(dn),Ol(2)}},_a=function(){return co(tg(dn)),xa(),qq()},qq=function(){return No(),Dq(),Go()},Dq=function(){var a;return a=0,dn=zn(),ug(dn)===Pp(i)?void co(tg(dn)):Wk(dn)?(a=Math.cosh(dn.d),Math.abs(a)<1e-10&&(a=0),void fo(a)):El(dn)?void co(Ym):(lo(Q),co(dn),Ol(2))},ab=function(){var a;return a=cq,co(Pp(Fd)),co(tg(dn)),xa(),co(sg(dn)),xa(),dn=zn(),dn===Pp(Fd)?qk():co(dn),Lh(),Ol(cq-a)},Lh=function(){if(No(),en=zn(),dn=zn(),0===Vc(dn,en))return co(dn),void Go();if(Pk(dn))return Nh(),void Go();if(ug(dn)===Pp(Cd))return Mh(),void Go();for(fn=Eg(dn);Tk(fn);)co(ug(fn)),co(en),Lh(),fn=Eg(fn);return Go()},Nh=function(){var a;for(a=0,fn=Eg(dn);Tk(fn);)Vc(ug(fn),en)&&(co(ug(fn)),co(en),Lh()),fn=Eg(fn);for(a=cq,fn=Eg(dn);Tk(fn);)0===Vc(ug(fn),en)&&co(ug(fn)),fn=Eg(fn);if(cq-a)return Df(cq-a),fn=zn(),co(fn),co(fn),Dm()},Mh=function(){var a;for(a=0,fn=Eg(dn);Tk(fn);)Vc(ug(fn),en)&&(co(ug(fn)),co(en),Lh()),fn=Eg(fn);for(a=cq,fn=Eg(dn);Tk(fn);)0===Vc(ug(fn),en)&&co(ug(fn)),fn=Eg(fn);if(cq-a)return vm(cq-a)},Oh=function(){return fn=ig(dn),gn=wg(dn),hn=sg(dn),Bl(fn)||Hp("function name?"),ug(hn)===Pp(sa)&&(co(tg(hn)),xa(),hn=zn()),fp(fn,hn,gn),lo(Fd)},bb=function(){for(co(tg(dn)),xa(),en=zn(),dn=Dg(dn);Tk(dn);)co(ug(dn)),dn=Eg(dn),xa(),fn=zn(),co(ug(dn)),dn=Eg(dn),xa(),gn=zn(),co(ug(dn)),dn=Eg(dn),xa(),hn=zn(),co(en),co(fn),Dk(),en=zn(),co(en),co(fn),co(hn),Lp(),xa(),co(en),co(fn),co(gn),Lp(),xa(),Mp(),en=zn();return co(en)},cb=function(){return co(tg(dn)),xa(),co(sg(dn)),xa(),dn=zn(),dn===Pp(Fd)?qk():co(dn),Rh()},Rh=function(){return No(),en=zn(),dn=zn(),fn=_q,Eq(dn),co(fn),Go()},Eq=function(a){var b;if(Yi(a,en)){if(El(fn))return fn=Ym}else if(ug(a)===Pp(Xd)){if(Yi(tg(a),en)&&nl(sg(a))&&Ml(fn,sg(a)))return fn=sg(a)}else if(Tk(a)){for(a=Eg(a),b=[];Tk(a);)Eq(ug(a)),b.push(a=Eg(a));return b}},db=function(){return co(tg(dn)),xa(),Sh()},Sh=function(){var a;if(a=0,No(),dn=zn(),ug(dn)===Pp(e)&&(co(dn),xo(),dn=zn()),ug(dn)===Pp(Cd)){for(a=cq,dn=Eg(dn);Tk(dn);)co(ug(dn)),Sh(),dn=Eg(dn);vm(cq-a)}else yl(dn)?(co(dn),km()):ug(dn)===Pp(Xd)&&kl(sg(dn))?(co(dn),Ao()):co(Ym);return Go()},eb=function(){var a,b,c,d,e,f,g;for(c=0,dn=Eg(dn),co(ug(dn)),xa(),dn=Eg(dn),co(ug(dn)),xa(),en=zn(),en===Pp(Fd)?(qk(),co(Pp(Fd))):nl(en)?(qk(),co(en)):(co(en),dn=Eg(dn),co(ug(dn)),xa()),hn=zn(),gn=zn(),fn=zn();;){if(nl(hn)?(co(hn),d=Cn(),2147483648===d&&Hp("nth derivative: check n")):d=1,co(fn),d>=0)for(c=e=0,f=d;0<=f?e<f:e>f;c=0<=f?++e:--e)co(gn),Vh();else for(d=-d,c=a=0,g=d;0<=g?a<g:a>g;c=0<=g?++a:--a)co(gn),Dk();if(fn=zn(),hn===Pp(Fd))break;if(nl(hn)){if(dn=Eg(dn),co(ug(dn)),xa(),hn=zn(),hn===Pp(Fd))break;nl(hn)?b=1:(gn=hn,dn=Eg(dn),co(ug(dn)),xa(),hn=zn())}else gn=hn,dn=Eg(dn),co(ug(dn)),xa(),hn=zn()}return co(fn)},Vh=function(){return No(),en=zn(),dn=zn(),nl(en)&&Hp("undefined function"),Dl(dn)?Dl(en)?wh():vh():Dl(en)?uh():sh(),Go()},sh=function(){return Bl(en)?th():(co(dn),co(en),co(Pp(ge)),Lp(),co(Pp(ge)),Vh(),co(Pp(ge)),co(en),Lp())},th=function(){return Yi(dn,en)?void co(Ym):Tk(dn)?Pk(dn)?void ti():ug(dn)===Pp(Cd)?void ni():ug(dn)===Pp(Xd)?void mi():ug(dn)===Pp(X)?void Kh():ug(dn)===Pp(nd)?void ji():ug(dn)===Pp(me)?void ri():ug(dn)===Pp(P)?void Ih():ug(dn)===Pp(Je)?void ui():ug(dn)===Pp(j)?void Ah():ug(dn)===Pp(h)?void yh():ug(dn)===Pp(l)?void Ch():ug(dn)===Pp(ne)?void si():ug(dn)===Pp(Q)?void Jh():ug(dn)===Pp(Ke)?void vi():ug(dn)===Pp(k)?void Bh():ug(dn)===Pp(i)?void zh():ug(dn)===Pp(m)?void Dh():ug(dn)===Pp(d)?void xh():ug(dn)===Pp(je)?void qi():ug(dn)===Pp(Yc)?void _h():ug(dn)===Pp(qa)?void Th():ug(dn)===Pp(ra)?void Uh():ug(dn)===Pp(r)?void(El(sg(dn))?Eh():Fh()):ug(dn)===Pp(s)?void(El(sg(dn))?Gh():Hh()):ug(dn)===Pp(bd)&&sg(dn)===en?void Wh():$h():void co(_q)},ti=function(){var a;for(a=cq,dn=Eg(dn);Tk(dn);)co(ug(dn)),co(en),Vh(),dn=Eg(dn);return Df(cq-a)},ni=function(){var a,b,c,d,e,f,g;for(b=0,c=0,d=0,d=Ll(dn)-1,b=e=0,f=d;0<=f?e<f:e>f;b=0<=f?++e:--e){for(fn=Eg(dn),c=a=0,g=d;0<=g?a<g:a>g;c=0<=g?++a:--a)co(ug(fn)),b===c&&(co(en),Vh()),fn=Eg(fn);vm(d)}return Df(d)},mi=function(){return co(sg(dn)),co(tg(dn)),ei(),co(tg(dn)),co(en),Vh(),um(),co(tg(dn)),Pl(),co(sg(dn)),co(en),Vh(),um(),Cf(),co(dn),um()},ji=function(){return co(tg(dn)),co(en),Vh(),co(tg(dn)),ei()},Kh=function(){return co(tg(dn)),co(en),Vh(),fn=zn(),ug(fn)===Pp(X)?(lo(X),lo(X),co(tg(fn)),Ml(sg(fn),sg(dn))?(co(sg(fn)),Ol(3),co(sg(dn))):(co(sg(dn)),Ol(3),co(sg(fn))),Ol(3)):(co(fn),co(sg(dn)),Vh())},$h=function(){return fn=Eg(dn),fn===Pp(Fd)||Vc(fn,en)?(lo(X),co(dn),co(en),Ol(3)):co(_q)},ri=function(){return co(tg(dn)),co(en),Vh(),co(tg(dn)),mh(),um()},Ih=function(){return co(tg(dn)),co(en),Vh(),co(tg(dn)),wp(),um(),Dm()},ui=function(){return co(tg(dn)),co(en),Vh(),co(tg(dn)),mh(),jo(-2),Dn(),um()},Ah=function(){return co(tg(dn)),co(en),Vh(),jo(1),co(tg(dn)),jo(2),Dn(),Mp(),ko(-1,2),Dn(),um()},yh=function(){return co(tg(dn)),co(en),Vh(),jo(1),co(tg(dn)),jo(2),Dn(),Mp(),ko(-1,2),Dn(),um(),Dm()},Ch=function(){return co(tg(dn)),co(en),Vh(),jo(1),co(tg(dn)),jo(2),Dn(),Cf(),Ik(),um(),qp()},si=function(){return co(tg(dn)),co(en),Vh(),co(tg(dn)),qq(),um()},Jh=function(){return co(tg(dn)),co(en),Vh(),co(tg(dn)),wq(),um()},vi=function(){return co(tg(dn)),co(en),Vh(),co(tg(dn)),qq(),jo(-2),Dn(),um()},Bh=function(){return co(tg(dn)),co(en),Vh(),co(tg(dn)),jo(2),Dn(),jo(1),Cf(),ko(-1,2),Dn(),um()},zh=function(){return co(tg(dn)),co(en),Vh(),co(tg(dn)),jo(2),Dn(),jo(-1),Cf(),ko(-1,2),Dn(),um()},Dh=function(){return co(tg(dn)),co(en),Vh(),jo(1),co(tg(dn)),jo(2),Dn(),Mp(),Ik(),um()},xh=function(){return co(tg(dn)),co(en),Vh(),co(tg(dn)),kp(),um()},qi=function(){return co(tg(dn)),co(en),Vh(),co(tg(dn)),ai(),um(),jo(2),um()},_h=function(){return co(tg(dn)),co(en),Vh(),jo(2),co(sg(dn)),um(),um(),co(tg(dn)),co(sg(dn)),jo(-1),Cf(),sk(),um()},Th=function(){return co(tg(dn)),jo(2),Dn(),jo(-1),um(),mj(),lo(Vd),ko(-1,2),Dn(),um(),jo(2),um(),co(tg(dn)),co(en),Vh(),um()},Uh=function(){return co(tg(dn)),jo(2),Dn(),jo(-1),um(),mj(),lo(Vd),ko(-1,2),Dn(),um(),jo(-2),um(),co(tg(dn)),co(en),Vh(),um()},Eh=function(){return co(tg(dn)),co(en),Vh(),co(tg(dn)),jo(1),Wf(),um(),jo(-1),um()},Fh=function(){return co(tg(dn)),co(en),Vh(),co(tg(dn)),co(sg(dn)),jo(-1),Cf(),Wf(),co(sg(dn)),jo(-1),um(),co(tg(dn)),ei(),co(tg(dn)),co(sg(dn)),Wf(),um(),Cf(),um()},Gh=function(){return co(tg(dn)),co(en),Vh(),co(tg(dn)),jo(1),Wf(),um(),jo(-1),um()},Hh=function(){return co(tg(dn)),co(en),Vh(),co(tg(dn)),co(sg(dn)),jo(-1),Cf(),Xf(),co(sg(dn)),jo(-1),um(),co(tg(dn)),ei(),co(tg(dn)),co(sg(dn)),Xf(),um(),Cf(),um()},Wh=function(){return co(tg(dn))},Z=function(){return Dl(dn)?2!==dn.tensor.ndim?0:dn.tensor.dim[0]!==dn.tensor.dim[1]?0:1:0},Xh=function(){var a,b,c,d,e,f,g;if(c=0,d=0,No(),dn=zn(),0===Z())return lo(Y),co(dn),Ol(2),void Go();for(d=dn.tensor.nelem,a=dn.tensor.elem,c=e=0,f=d;(0<=f?e<f:e>f)&&nl(a[c]);c=0<=f?++e:--e);if(c===d)Fq();else{for(c=b=0,g=dn.tensor.nelem;0<=g?b<g:b>g;c=0<=g?++b:--b)co(dn.tensor.elem[c]);Yh(dn.tensor.dim[0])}return Go()},Yh=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o;for(e=0,f=0,g=0,h=0,j=0,m=0,n=0,o=0,b=[],e=cq-a*a,f=i=0,k=a;0<=k?i<k:i>k;f=0<=k?++i:--i)b[f]=f,b[f+a]=0,b[f+a+a]=1;for(n=1,co(_q);;){for(jo(1===n?1:-1),f=c=0,l=a;0<=l?c<l:c>l;f=0<=l?++c:--c)h=a*b[f]+f,co(Cp[e+h]),um();for(Cf(),g=a-1,m=0,d=!1;;)if(j=b[a+g]+b[a+a+g],j<0)b[a+a+g]=-b[a+a+g],g--;else{if(j!==g+1)break;if(0===g){d=!0;break}m++,b[a+a+g]=-b[a+a+g],g--}if(d)break;o=b[g-b[a+g]+m],b[g-b[a+g]+m]=b[g-j+m],b[g-j+m]=o,b[a+g]=j,n=-n}return Cp[e]=Cp[cq-1],cq=e+1},Zh=function(){return No(),dn=zn(),0===Z()?(lo(Y),co(dn),Ol(2),void Go()):(Fq(),Go())},Fq=function(){var a,b,c,d;for(a=0,b=0,b=dn.tensor.dim[0],a=c=0,d=b*b;0<=d?c<d:c>d;a=0<=d?++c:--c)co(dn.tensor.elem[a]);return Sl(b),cq-=b*b,co(dn)},od=function(a,b,c,d){return Cp[a+b*c+d]},cp=function(a,b,c,d,e){return Cp[a+b*c+d]=e},Sl=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s;for(f=0,g=0,h=0,i=0,g=cq-a*a,dn=Ym,f=j=0,k=a-1;0<=k?j<k:j>k;f=0<=k?++j:--j){if(Yi(od(g,a,f,f),_q)){for(h=b=l=f+1,m=a;(l<=m?b<m:b>m)&&Yi(od(g,a,h,f),_q);h=l<=m?++b:--b);if(h===a){dn=_q;break}for(i=c=n=f,o=a;n<=o?c<o:c>o;i=n<=o?++c:--c)en=od(g,a,f,i),cp(g,a,f,i,od(g,a,h,i)),cp(g,a,h,i,en);co(dn),Dm(),dn=zn()}for(co(dn),co(od(g,a,f,f)),um(),dn=zn(),h=d=p=f+1,q=a;p<=q?d<q:d>q;h=p<=q?++d:--d)for(co(od(g,a,h,f)),co(od(g,a,f,f)),ei(),Dm(),en=zn(),cp(g,a,h,f,_q),i=e=r=f+1,s=a;r<=s?e<s:e>s;i=r<=s?++e:--e)co(od(g,a,f,i)),co(en),um(),co(od(g,a,h,i)),Cf(),cp(g,a,h,i,zn())}return co(dn),co(od(g,a,a-1,a-1)),um(),dn=zn()},hb=function(){return co(tg(dn)),xa(),ai()},ai=function(){return No(),rq(),Go()},rq=function(){return dn=zn(),Wk(dn)?0===dn.d?void jo(1):void jo(0):yl(dn)?Dd(fm(dn.q.a,dn.q.b))?void jo(1):void jo(0):ug(dn)===Pp(Xd)?(lo(_),co(tg(dn)),void Ol(2)):kl(dn)?(lo(_),co(dn),Dm(),void Ol(2)):((kl(dn)||ug(dn)===Pp(e)&&kl(tg(dn)))&&(co(dn),Dm(),dn=zn()),lo(_),co(dn),Ol(2))},gi=function(){var a,b,c,d,e,f;for(b=0,a=0,c=0,No(),a=cq-1,hi(),c=cq-a,f=Cp.slice(a,a+c),f.sort(Tg),Cp=Cp.slice(0,a).concat(f).concat(Cp.slice(a+c)),dn=If(c),dn.tensor.ndim=1,dn.tensor.dim[0]=c,b=d=0,e=c;0<=e?d<e:d>e;b=0<=e?++d:--d)dn.tensor.elem[b]=Cp[a+b];return cq=a,co(dn),Go()},hi=function(){var a,b,c,d,f,g;if(a=0,b=0,c=0,d=0,No(),dn=zn(),a=cq,nl(dn))co(dn),Bj();else if(ug(dn)===Pp(e))co(dn),of();else if(ug(dn)===Pp(Cd))for(dn=Eg(dn),nl(ug(dn))&&(co(ug(dn)),Bj(),dn=Eg(dn));Tk(dn);)en=ug(dn),ug(en)===Pp(Xd)?(co(tg(en)),co(sg(en))):(co(en),co(Ym)),dn=Eg(dn);else ug(dn)===Pp(Xd)?(co(tg(dn)),co(sg(dn))):(co(dn),co(Ym));for(c=cq,co(Ym),fk(a,c),d=cq-c,b=f=0,g=d;0<=g?f<g:f>g;b=0<=g?++f:--f)Cp[a+b]=Cp[c+b];return cq=a+d,Go()},fk=function(a,b){var c,d,e,f;if(c=0,d=0,No(),dn=zn(),a===b)return co(dn),void Go();if(en=Cp[a+0],fn=Cp[a+1],co(fn),c=Cn(),2147483648!==c)for(d=e=0,f=Math.abs(c);0<=f?e<=f:e>=f;d=0<=f?++e:--e)co(dn),co(en),jo(mp(c)*d),Dn(),um(),fk(a+2,b);return Go()},of=function(){for(No(),dn=zn(),fn=Eg(dn),co(ug(fn)),fn=Eg(fn);Tk(fn);)co(ug(fn)),Zj(),fn=Eg(fn);if(en=zn(),ql(en))return co(dn),co(Ym),void Go();if(nl(en))co(en),Bj();else if(ug(en)===Pp(Cd))for(fn=Eg(en),nl(ug(fn))?(co(ug(fn)),Bj()):(co(ug(fn)),co(Ym)),fn=Eg(fn);Tk(fn);)co(ug(fn)),co(Ym),fn=Eg(fn);else co(en),co(Ym);for(co(en),Ik(),en=zn(),co(_q),fn=Eg(dn);Tk(fn);)co(en),co(ug(fn)),um(),Cf(),fn=Eg(fn);return co(Ym),Go()},li=function(){var a,b,c,d,e,f;return a=0,b=0,c=0,d=0,e=0,f=0,d=An(),c=An(),0===c&&d<0&&Hp("divide by zero"),c>=0||d%1===0?(e=Math.pow(c,d),void fo(e)):(e=Math.pow(Math.abs(c),d),f=Math.PI*d,d%.5===0?(a=0,b=Math.sin(f)):(a=Math.cos(f),b=Math.sin(f)),fo(a*e),fo(b*e),co(vk),um(),Cf())},ma=0,oa=[],pa=[],lb=function(){return 0===na()&&Hp("eigen: argument is not a square matrix"),yi(ja),dn=mq("D"),ep(dn,en),dn=mq("Q"),ep(dn,fn),co(Pp(Fd))},mb=function(){return 0===na()?(lo(ka),co(dn),void Ol(2)):(yi(ka),co(en))},nb=function(){return 0===na()?(lo(la),co(dn),void Ol(2)):(yi(la),co(fn))},na=function(){var a,b,c,d,e,f,g,h,i,j,k;if(d=0,e=0,co(tg(dn)),xa(),Lq(),xa(),dn=zn(),!Dl(dn))return 0;for(2===dn.tensor.ndim&&dn.tensor.dim[0]===dn.tensor.dim[1]||Hp("eigen: argument is not a square matrix"),ma=dn.tensor.dim[0],d=f=0,g=ma;0<=g?f<g:f>g;d=0<=g?++f:--f)for(e=a=0,h=ma;0<=h?a<h:a>h;e=0<=h?++a:--a)Wk(dn.tensor.elem[ma*d+e])||Hp("eigen: matrix is not numerical");for(d=b=0,i=ma-1;0<=i?b<i:b>i;d=0<=i?++b:--b)for(e=c=j=d+1,k=ma;j<=k?c<k:c>k;e=j<=k?++c:--c)Math.abs(dn.tensor.elem[ma*d+e].d-dn.tensor.elem[ma*e+d].d)>1e-10&&Hp("eigen: matrix is not symmetrical");return 1},yi=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y;for(k=0,l=0,k=m=0,n=ma*ma;0<=n?m<n:m>n;k=0<=n?++m:--m)oa[k]=0;for(k=b=0,o=ma*ma;0<=o?b<o:b>o;k=0<=o?++b:--b)pa[k]=0;for(k=c=0,q=ma;0<=q?c<q:c>q;k=0<=q?++c:--c)for(oa[ma*k+k]=dn.tensor.elem[ma*k+k].d,l=d=r=k+1,s=ma;r<=s?d<s:d>s;l=r<=s?++d:--d)oa[ma*k+l]=dn.tensor.elem[ma*k+l].d,oa[ma*l+k]=dn.tensor.elem[ma*k+l].d;for(k=e=0,t=ma;0<=t?e<t:e>t;k=0<=t?++e:--e)for(pa[ma*k+k]=1,l=f=u=k+1,v=ma;u<=v?f<v:f>v;l=u<=v?++f:--f)pa[ma*k+l]=0,pa[ma*l+k]=0;for(k=g=0;g<100&&0!==Fp();k=++g);if(100===k&&printstr("\nnote: eigen did not converge\n"),a===ja||a===ka)for(co(dn),lh(),en=zn(),k=h=0,w=ma;0<=w?h<w:h>w;k=0<=w?++h:--h)for(l=i=0,x=ma;0<=x?i<x:i>x;l=0<=x?++i:--i)fo(oa[ma*k+l]),en.tensor.elem[ma*k+l]=zn();if(a===ja||a===la){for(co(dn),lh(),fn=zn(),y=[],k=j=0,p=ma;0<=p?j<p:j>p;k=0<=p?++j:--j)y.push(function(){var a,b,c;for(c=[],l=a=0,b=ma;0<=b?a<b:a>b;l=0<=b?++a:--a)fo(pa[ma*k+l]),c.push(fn.tensor.elem[ma*k+l]=zn());return c}());return y}},Fp=function(){var a,b,c,d,e,f,g,h;for(c=0,d=0,b=0,c=e=0,f=ma-1;0<=f?e<f:e>f;c=0<=f?++e:--e)for(d=a=g=c+1,h=ma;g<=h?a<h:a>h;d=g<=h?++a:--a)0!==oa[ma*c+d]&&(Gp(c,d),b++);return b},Gp=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o;for(g=0,n=0,o=0,e=0,f=0,l=0,m=0,o=.5*(oa[ma*a+a]-oa[ma*b+b])/oa[ma*a+b],n=1/(Math.abs(o)+Math.sqrt(o*o+1)),o<0&&(n=-n),e=1/Math.sqrt(n*n+1),l=n*e,g=h=0,i=ma;0<=i?h<i:h>i;g=0<=i?++h:--h)f=oa[ma*a+g],m=oa[ma*b+g],oa[ma*a+g]=e*f+l*m,oa[ma*b+g]=e*m-l*f;for(g=c=0,j=ma;0<=j?c<j:c>j;g=0<=j?++c:--c)f=oa[ma*g+a],m=oa[ma*g+b],oa[ma*g+a]=e*f+l*m,oa[ma*g+b]=e*m-l*f;for(g=d=0,k=ma;0<=k?d<k:d>k;g=0<=k?++d:--d)f=pa[ma*a+g],m=pa[ma*b+g],pa[ma*a+g]=e*f+l*m,pa[ma*b+g]=e*m-l*f;return oa[ma*a+b]=0,oa[ma*b+a]=0},ob=function(){return co(tg(dn)),xa(),sq()},sq=function(){return No(),Hq(),Go()},Hq=function(){var a;return a=0,dn=zn(),Wk(dn)?(a=1-_i(dn.d),void fo(a)):kl(dn)?(lo(qa),co(dn),Dm(),Ol(2),void Dm()):(lo(qa),co(dn),void Ol(2))},pb=function(){return co(tg(dn)),xa(),tq()},tq=function(){return No(),Iq(),Go()},Iq=function(){var a;return a=0,dn=zn(),Wk(dn)?(a=_i(dn.d),void fo(a)):(lo(ra),co(dn),void Ol(2))},_i=function(a){var b,c,d;return c=0,d=0,b=0,d=Math.abs(a),c=1/(1+.5*d),b=c*Math.exp(-d*d-1.26551223+c*(1.00002368+c*(.37409196+c*(.09678418+c*(-.18628806+c*(.27886807+c*(-1.13520398+c*(1.48851587+c*(-.82215223+.17087277*c))))))))),a>=0?b:2-b},xa=function(){switch(Ig(),No(),dn=zn(),dn.k){case N:Ya();break;case Pd:co(dn);break;case ea:co(dn);break;case se:co(dn);break;case Me:Cc();break;case ve:yc();break;default:Hp("atom?")}return Go()},yc=function(){return el(dn)?(co(dn),co(Pp(jd)),Ol(2),void xa()):(en=hk(dn),co(en),dn!==en?xa():void 0)},Ya=function(){switch(Bl(ug(dn))||Hp("cons?"),Qp(ug(dn))){case d:return za();case e:return Aa();case f:
return Ba();case g:return Ca();case h:return Da();case i:return Ea();case j:return Fa();case k:return Ga();case l:return Ha();case m:return Ia();case n:return Ja();case o:return Eval_atomize();case r:return Ka();case s:return La();case t:return Ma();case u:return Na();case D:return Oa();case E:return Pa();case F:return Qa();case G:return Ra();case H:return Sa();case I:return Ta();case J:return Ua();case K:return Va();case L:return Wa();case M:return Xa();case O:return Za();case P:return $a();case Q:return _a();case T:return ab();case V:return cb();case U:return bb();case W:return db();case X:return eb();case Y:return fb();case $:return gb();case _:return hb();case aa:return Eval_display();case ba:return ib();case ca:return jb();case da:return Hb();case fa:return Eval_draw();case ha:return kb();case ja:return lb();case ka:return mb();case la:return nb();case qa:return ob();case ra:return pb();case sa:return ya();case ta:return qb();case ua:return rb();case va:return sb();case wa:return tb();case Oc:return ub();case Pc:return vb();case Qc:return wb();case Rc:return xb();case Sc:return yb();case Tc:return zb();case Uc:return Ab();case Wc:return Bb();case Xc:return Cb();case Yc:return Db();case Zc:return Eb();case $c:return Fb();case _c:return Gb();case ad:return Hb();case bd:return Ib();case cd:return Jb();case dd:return Kb();case gd:return Lb();case hd:return Mb();case id:return Nb();case kd:return Ob();case ld:return Pb();case md:return Qb();case nd:return Rb();case pd:return Sb();case yd:return Tb();case Cd:return Ub();case Gd:return Wb();case Hd:return Xb();case Qd:return Yb();case Rd:return Zb();case Sd:return $b();case Td:return _b();case Ud:return ac();case Wd:return bc();case Xd:return cc();case Yd:return ec();case Zd:return Eval_display();case _d:return gc();case ae:return hc();case be:return ic();case ce:return jc();case de:return kc();case ee:return lc();case kf:return mc();case fe:return nc();case ie:return oc();case je:return pc();case le:return sc();case me:return tc();case ne:return uc();case ke:return qc();case qe:return vc();case re:return wc();case te:return xc();case ue:return Eval_sum();case Je:return zc();case Ke:return Ac();case Le:return Bc();case Ne:return Dc();case Oe:return Ec();case Pe:return Fc();case Qe:return Gc();case Re:return Hc();case Se:return Ic();case Ve:return Jc();case ff:return Kc();case lf:return Mc();default:return Lc()}},Ma=function(){return co(hk(tg(dn)))},Pa=function(){return co(tg(dn)),dc(),dn=zn(),El(dn)&&Hp("check(arg): arg is zero"),co(Pp(Fd))},fb=function(){return co(tg(dn)),xa(),Xh()},gb=function(){var a;return co(tg(dn)),xa(),en=zn(),Tk(Dg(dn))?(co(sg(dn)),xa(),a=Cn()):a=1,Dl(en)?a<1||a>en.tensor.ndim?co(dn):jo(en.tensor.dim[a-1]):jo(1)},ib=function(){return co(tg(dn)),xa(),gi()},jb=function(){var a;for(co(ug(dn)),dn=Eg(dn),a=[];Tk(dn);)zn(),co(ug(dn)),xa(),a.push(dn=Eg(dn));return a},kb=function(){return co(tg(dn)),xa(),co(sg(dn)),xa(),co(rg(dn)),xa(),dsolve()},ya=function(){for(co(tg(dn)),xa(),dn=Dg(dn);Tk(dn);)co(ug(dn)),xa(),co(tg(dn)),xa(),Lp(),dn=Dg(dn);return xa()},qb=function(){return co(tg(dn)),xa(),mj()},vb=function(){return co(tg(dn)),xa(),Dj()},wb=function(){var a;for(dn=Eg(dn),co(ug(dn)),xa(),dn=Eg(dn),co(ug(dn)),xa(),Ej(),dn=Eg(dn),a=[];Tk(dn);)co(ug(dn)),xa(),Ej(),a.push(dn=Eg(dn));return a},Db=function(){return co(tg(dn)),xa(),co(sg(dn)),xa(),sk()},Eb=function(){return co(tg(dn)),xa(),tk()},Gb=function(){var a;for(a=cq,dn=Eg(dn);Tk(dn);)co(ug(dn)),xa(),dn=Eg(dn);return wk(cq-a)},Jb=function(){return co(tg(dn)),xa(),Hk()},Kb=function(){return co(tg(dn)),xa(),Kk()},Lb=function(){var a;return co(tg(dn)),xa(),dn=zn(),yl(dn)?void co(cl(dn)?Ym:_q):Wk(dn)?(a=Math.floor(dn.d),void co(a===dn.d?Ym:_q)):(lo(gd),co(dn),Ol(2))},Ub=function(){var a;for(co(tg(dn)),xa(),dn=Dg(dn),a=[];Tk(dn);)co(ug(dn)),xa(),um(),a.push(dn=Eg(dn));return a},Yb=function(){return co(tg(dn)),xa(),dn=zn(),jo(dn.k===Pd||dn.k===ea?1:0)},$b=function(){var a;for(a=cq,lo(Sd),dn=Eg(dn);Tk(dn);)co(ug(dn)),xa(),dn=Eg(dn);return Ol(cq-a)},fc=function(){for(dn=Eg(dn);Tk(dn);)co(ug(dn)),xa(),Zi(hk(Pp(We)),1)?_n(zn()):bi(zn()),dn=Eg(dn);return co(Pp(Fd))},hc=function(){return co(tg(dn))},jc=function(){return co(tg(dn)),xa(),dn=zn(),Dl(dn)?jo(dn.tensor.ndim):co(_q)},hp=function(){var a;for(gn=lg(dn),Bl(gn)||Hp("indexed assignment: error in symbol"),a=cq,co(sg(dn)),xa(),en=wg(dn);Tk(en);)co(ug(en)),xa(),en=Eg(en);return gp(cq-a),fn=zn(),ep(gn,fn),co(Pp(Fd))},oc=function(){return ig(dn)===Pp(_c)?void hp():Tk(tg(dn))?void Oh():(Bl(tg(dn))||Hp("symbol assignment: error in symbol"),co(sg(dn)),xa(),en=zn(),ep(tg(dn),en),co(Pp(Fd)))},vc=function(){return co(tg(dn)),xa(),ko(1,2),Dn()},wc=function(){return Hp("user stop")},xc=function(){return co(rg(dn)),xa(),co(sg(dn)),xa(),co(tg(dn)),xa(),Lp(),xa()},Kc=function(){var a,b,c,d;if(a=0,b=0,co(tg(dn)),xa(),b=Cn(),b<2)return void co(dn);for(dn=If(b*b),dn.tensor.ndim=2,dn.tensor.dim[0]=b,dn.tensor.dim[1]=b,a=c=0,d=b;0<=d?c<d:c>d;a=0<=d?++c:--c)dn.tensor.elem[b*a+a]=Ym;return dn.tensor.nelem!==dn.tensor.elem.length&&console.log("something wrong in tensor dimensions"),co(dn)},Vb=function(){var a;return a=kj,kj=0,xa(),kj=a},dc=function(){return No(),dn=zn(),ug(dn)===Pp(ie)?Ec():(co(dn),xa()),Go()},rb=function(){return co(tg(dn)),xa(),co(sg(dn)),xa(),en=zn(),en===Pp(Fd)?qk():co(en),dj()},dj=function(){if(No(),nn=zn(),hn=zn(),Dl(hn))return jj(),void Go();if(ug(hn)===Pp(e)){for(jo(0),dn=Eg(hn);Tk(dn);)co(ug(dn)),co(nn),dj(),Cf(),dn=Eg(dn);return void Go()}return co(hn),Vm(),fn=zn(),co(hn),Sh(),en=zn(),Eo(),co(fn),co(en),co(nn),!isone(fn)&&!isone(en)||rl(en,nn)&&!isone(en)?(ii(),ln=zn(),co(fn),co(en),co(ln),um(),Mp(),fn=zn(),El(fn)?(co(ln),void Go()):(co(en),co(nn),Ej(),en=zn(),hj(),gj(),ej(),Dl(gn)?(co(gn),Hk(),co(fn),Ak(),co(en),Ak()):(co(fn),co(gn),ei(),co(en),um()),co(ln),Cf(),Go())):(zn(),zn(),zn(),co(hn),void Go())},jj=function(){var a,b,c;for(a=0,co(hn),lh(),hn=zn(),a=b=0,c=hn.tensor.nelem;0<=c?b<c:b>c;a=0<=c?++b:--b)co(hn.tensor.elem[a]),co(nn),dj(),hn.tensor.elem[a]=zn();return co(hn)},Eo=function(){var a,b,c,d,e,f,g;for(a=0,b=0,c=0,d=0,e=0,a=cq,Fj(en),Fj(fn),e=cq-a,c=0,b=f=0,g=e;0<=g?f<g:f>g;b=0<=g?++f:--f)dn=Cp[a+b],ug(dn)===Pp(Xd)&&tg(dn)===nn&&(co(sg(dn)),d=Cn(),2147483648!==d&&d<c&&(c=d));if(cq=a,0!==c)return co(en),co(nn),jo(-c),Dn(),um(),en=zn(),co(fn),co(nn),jo(-c),Dn(),um(),fn=zn()},hj=function(){var a,b,c,d,e,f,g,h,i;if(c=0,d=0,e=0,f=0,c=cq,ug(en)===Pp(Cd))for(dn=Eg(en);Tk(dn);)hn=ug(dn),ij(),dn=Eg(dn);else hn=en,ij();if(f=cq-c,1===f)return void(gn=zn());for(gn=If(f*f),gn.tensor.ndim=2,gn.tensor.dim[0]=f,gn.tensor.dim[1]=f,a=c,d=g=0,h=f;0<=h?g<h:g>h;d=0<=h?++g:--g)for(e=b=0,i=f;0<=i?b<i:b>i;e=0<=i?++b:--b)co(Cp[a+e]),co(nn),jo(d),Dn(),ei(),co(nn),Ij(),gn.tensor.elem[f*d+e]=zn();return cq-=f},ij=function(){var a,b,c,d,e,f,g;if(a=0,b=0,c=0,d=0,Vc(hn,nn)){for(gq(),ug(hn)===Pp(Xd)?(co(sg(hn)),d=Cn(),kn=tg(hn)):(d=1,kn=hn),co(kn),co(nn),Rh(),a=Cn(),g=[],b=e=0,f=d;0<=f?e<f:e>f;b=0<=f?++e:--e)g.push(function(){var d,e,f;for(f=[],c=d=0,e=a;0<=e?d<e:d>e;c=0<=e?++d:--d)co(mn),co(kn),jo(b),Dn(),um(),co(nn),jo(c),Dn(),f.push(um());return f}());return g}},gq=function(){var a;if(a=0,ug(en)===Pp(Cd)){for(a=cq,cn=Eg(en);Tk(cn);)Yi(ug(cn),hn)||(co(ug(cn)),xa()),cn=Eg(cn);vm(cq-a)}else jo(1);return mn=zn()},gj=function(){var a,b,c,d;if(a=0,b=0,Dl(gn)){for(b=gn.tensor.dim[0],mn=If(b),mn.tensor.ndim=1,mn.tensor.dim[0]=b,a=c=0,d=b;0<=d?c<d:c>d;a=0<=d?++c:--c)co(fn),co(nn),jo(a),Dn(),ei(),co(nn),Ij(),mn.tensor.elem[a]=zn();return fn=mn}},ej=function(){var a,b,c,d,e;if(a=0,b=0,c=0,!Dl(gn))return co(en),Ao(),void(en=zn());if(a=cq,ug(en)===Pp(Cd))for(mn=Eg(en);Tk(mn);)hn=ug(mn),fj(),mn=Eg(mn);else hn=en,fj();for(c=cq-a,mn=If(c),mn.tensor.ndim=1,mn.tensor.dim[0]=c,b=d=0,e=c;0<=e?d<e:d>e;b=0<=e?++d:--d)mn.tensor.elem[b]=Cp[a+b];return cq=a,en=mn},fj=function(){var a,b,c,d,e,f,g;if(a=0,b=0,c=0,d=1,Vc(hn,nn)){for(ug(hn)===Pp(Xd)&&(co(sg(hn)),d=Cn(),hn=tg(hn)),co(hn),co(nn),Rh(),a=Cn(),g=[],b=e=f=d;f<=0?e<0:e>0;b=f<=0?++e:--e)g.push(function(){var d,e,f;for(f=[],c=d=0,e=a;0<=e?d<e:d>e;c=0<=e?++d:--d)co(hn),jo(b),Dn(),Ao(),co(nn),jo(c),Dn(),f.push(um());return f}());return g}},sb=function(){return co(tg(dn)),xa(),lj()},lj=function(){return No(),dn=zn(),co(vk),co(dn),um(),mj(),ko(1,2),um(),co(vk),Dm(),co(dn),um(),mj(),ko(1,2),um(),Cf(),Go()},tb=function(){return co(tg(dn)),xa(),oj()},oj=function(){return No(),dn=zn(),co(vk),co(dn),um(),mj(),co(vk),ei(),ko(1,2),um(),co(vk),Dm(),co(dn),um(),mj(),co(vk),ei(),ko(1,2),um(),Mp(),Go()},ub=function(){var a;for(co(tg(dn)),xa(),co(sg(dn)),xa(),en=zn(),en===Pp(Fd)?qk():co(en),wj(),dn=Cg(dn),a=[];Tk(dn);)co(ug(dn)),xa(),yj(),a.push(dn=Eg(dn));return a},yj=function(){var a,b;if(No(),en=zn(),dn=zn(),a=cq,ug(dn)===Pp(Cd))for(dn=Eg(dn);Tk(dn);)co(ug(dn)),co(en),Cj(),dn=Eg(dn);else co(dn),co(en),Cj();return b=cq-a,b>1&&wm(b),Go()},Cj=function(){if(No(),Ej(),dn=zn(),ug(dn)===Pp(Cd))for(dn=Eg(dn);Tk(dn);)co(ug(dn)),dn=Eg(dn);else co(dn);return Go()},wj=function(){return No(),en=zn(),dn=zn(),cl(dn)?(co(dn),Aj()):(co(dn),co(en),Ej()),Go()},Bj=function(){var a,b,c,d,e,f;for(c=0,No(),d=Cn(),2147483648===d&&Hp("number too big to factor"),d<0&&(d=-d),c=e=0,f=rd;(0<=f?e<f:e>f)&&(a=In[c],!(a>d/a));c=0<=f?++e:--e){for(b=0;d%a===0;)d/=a,b++;b&&(jo(a),jo(b))}return d>1&&(jo(d),jo(1)),Go()},Dj=function(){var a;return a=0,No(),dn=zn(),co(dn),a=Cn(),a<0||2147483648===a?(lo(Pc),co(dn),Ol(2),void Go()):(Zf(a),Go())},vp=function(){var a;if(a=0,No(),a=kj,kj=0,dn=zn(),ug(dn)===Pp(e)){for(co(_q),dn=Eg(dn);Tk(dn);)co(ug(dn)),vp(),Cf(),dn=Eg(dn);return kj=a,void Go()}return ug(dn)===Pp(Cd)?(ip(),kj=a,void Go()):(co(dn),kj=a,Go())},ip=function(){var a,b,c,d,e,f,g,h,i,j,k;for(c=0,d=0,e=0,k=cq,dn=Eg(dn),e=0;Tk(dn);)co(ug(dn)),dn=Eg(dn),e++;for(c=f=0,g=e-1;0<=g?f<g:f>g;c=0<=g?++f:--f)if(Cp[k+c]!==Pp(Fd))for(d=a=h=c+1,i=e;h<=i?a<i:a>i;d=h<=i?++a:--a)Cp[k+d]!==Pp(Fd)&&jp(k,c,d);for(co(Ym),c=b=0,j=e;0<=j?b<j:b>j;c=0<=j?++b:--b)Cp[k+c]!==Pp(Fd)&&(co(Cp[k+c]),um());return dn=zn(),cq-=e,co(dn)},jp=function(a,b,c){var d,e,f,g;if(d=0,e=0,dn=Cp[a+b],en=Cp[a+c],wl(dn)?(fn=sg(dn),dn=tg(dn)):fn=Ym,wl(en)?(gn=sg(en),en=tg(en)):gn=Ym,Zk(dn)&&Zk(en)){if(co(fn),co(gn),Cf(),Jq(),e=Cn(),0!==e)return;if(co(tg(dn)),co(tg(en)),Mp(),Jq(),e=Cn(),0===e||2147483648===e)return;for(e<0&&(e=-e,hn=dn,dn=en,en=hn,hn=fn,fn=gn,gn=hn),co(Ym),d=f=1,g=e;1<=g?f<=g:f>=g;d=1<=g?++f:--f)co(tg(en)),jo(d),Cf(),co(fn),Dn(),um();return Cp[a+b]=zn(),Cp[a+c]=Pp(Fd)}},wn=0,Gj=0,Ej=function(){return No(),en=zn(),dn=zn(),Vc(dn,en)&&rl(dn,en)&&Bl(en)?(co(dn),co(en),Kq(),Go()):(co(dn),void Go())},Kq=function(){var a,b,c,d;for(a=0,b=0,No(),en=zn(),dn=zn(),a=cq,$k(dn)&&Hp("floating point numbers in polynomial"),wn=cq,co(dn),co(en),Gj=Wg()-1,yo(a);Gj>0;){if(El(Cp[wn+0]))jo(1),gn=zn(),jo(0),hn=zn();else if(0===ik()){nq&&printf("no factor found\n");break}for(co(gn),co(en),um(),co(hn),Cf(),mn=zn(),nq&&(printf("success\nFACTOR="),print(mn),printf("\n")),co(ln),co(mn),Am(),ln=zn(),Gq();Gj&&El(Cp[wn+Gj]);)Gj--}for(co(_q),b=c=0,d=Gj;0<=d?c<=d:c>=d;b=0<=d?++c:--c)co(Cp[wn+b]),co(en),jo(b),Dn(),um(),Cf();return dn=zn(),nq&&(printf("POLY="),print(dn),printf("\n")),Gj>0&&kl(Cp[wn+Gj])&&(co(dn),Dm(),dn=zn(),co(ln),Fm(),ln=zn()),co(ln),co(dn),Am(),ln=zn(),nq&&(printf("RESULT="),print(ln),printf("\n")),Cp[a]=ln,cq=a+1,Go()},yo=function(a){var b,c,d,e,f,g,h;for(c=0,ln=Ym,c=d=e=a,f=cq;e<=f?d<f:d>f;c=e<=f?++d:--d)co(Cp[c]),Sh(),co(ln),Il(),ln=zn();for(c=b=g=a,h=cq;g<=h?b<h:b>h;c=g<=h?++b:--b)co(ln),co(Cp[c]),um(),Cp[c]=zn();if(co(ln),Ao(),ln=zn(),S)return console.log("rationalize_coefficients result")},ik=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s;if(h=0,i=0,g=0,a=0,f=0,j=0,k=0,nq){for(co(_q),h=l=0,m=Gj;0<=m?l<=m:l>=m;h=0<=m?++l:--l)co(Cp[wn+h]),co(en),jo(h),Dn(),um(),Cf();dn=zn(),printf("POLY="),print(dn),printf("\n")}if(g=cq,f=cq,co(Cp[wn+Gj]),hi(),k=cq-f,a=cq,co(Cp[wn+0]),hi(),j=cq-a,nq){for(printf("divisors of base term"),h=b=0,n=j;0<=n?b<n:b>n;h=0<=n?++b:--b)printf(", "),print(Cp[a+h]);for(printf("\n"),printf("divisors of leading term"),h=c=0,o=k;0<=o?c<o:c>o;h=0<=o?++c:--c)printf(", "),print(Cp[f+h]);printf("\n")}for(r=d=0,p=k;0<=p?d<p:d>p;r=0<=p?++d:--d)for(s=e=0,q=j;0<=q?e<q:e>q;s=0<=q?++e:--e){if(gn=Cp[f+r],hn=Cp[a+s],co(hn),co(gn),ei(),Dm(),fn=zn(),Nc(),nq&&(printf("try A="),print(gn),printf(", B="),print(hn),printf(", root "),print(en),printf("=-B/A="),print(fn),printf(", POLY("),print(fn),printf(")="),print(kn),printf("\n")),El(kn))return cq=g,S&&console.log("get_factor returning 1"),1;if(co(hn),Dm(),hn=zn(),co(fn),Dm(),fn=zn(),Nc(),nq&&(printf("try A="),print(gn),printf(", B="),print(hn),printf(", root "),print(en),printf("=-B/A="),print(fn),printf(", POLY("),print(fn),printf(")="),print(kn),printf("\n")),El(kn))return cq=g,S&&console.log("get_factor returning 1"),1}return cq=g,S&&console.log("get_factor returning 0"),0},Gq=function(){var a,b,c;for(a=0,kn=_q,a=b=c=Gj;c<=0?b<0:b>0;a=c<=0?++b:--b)co(Cp[wn+a]),Cp[wn+a]=kn,co(gn),ei(),kn=zn(),co(Cp[wn+a-1]),co(kn),co(hn),um(),Mp(),Cp[wn+a-1]=zn();if(Cp[wn+0]=kn,S)return console.log("yydivpoly Q:")},Nc=function(){var a,b,c;for(a=0,co(_q),a=b=c=Gj;c<=0?b<=0:b>=0;a=c<=0?++b:--b)co(fn),um(),co(Cp[wn+a]),S&&(console.log("Evalpoly top of stack:"),Jn(Cp[cq-a])),Cf();return kn=zn()},Fj=function(a){var b;if(b=cq,ug(a)===Pp(e))for(a=Eg(a);Tk(a);)mo(ug(a)),a=Eg(a);else mo(a);return cq-b},mo=function(a){var b;if(ug(a)===Pp(Cd)){for(a=Eg(a),b=[];Tk(a);)co(ug(a)),b.push(a=Eg(a));return b}return co(a)},xb=function(){var a;for(dn=Eg(dn),co(ug(dn)),xa(),dn=Eg(dn),a=[];Tk(dn);)co(ug(dn)),xa(),Ij(),a.push(dn=Eg(dn));return a},Ij=function(){return No(),en=zn(),dn=zn(),Jj(),Go()},Jj=function(){return ug(dn)===Pp(e)?Kj():Dl(dn)?Lj():Vc(dn,en)?jo(0):co(dn)},Kj=function(){var a;for(jo(0),dn=Eg(dn),a=[];Tk(dn);)co(ug(dn)),co(en),Ij(),Cf(),a.push(dn=Eg(dn));return a},Lj=function(){var a,b,c,d,e,f;for(b=0,c=0,c=dn.tensor.nelem,fn=If(c),fn.tensor.ndim=dn.tensor.ndim,b=d=0,e=dn.tensor.ndim;0<=e?d<e:d>e;b=0<=e?++d:--d)fn.tensor.dim[b]=dn.tensor.dim[b];for(b=a=0,f=c;0<=f?a<f:a>f;b=0<=f?++a:--a)co(dn.tensor.elem[b]),co(en),Ij(),fn.tensor.elem[b]=zn();return co(fn)},yb=function(){return co(tg(dn)),xa(),Lq(),xa()},Lq=function(){var a,b,c,d;if(b=0,a=0,No(),dn=zn(),Tk(dn)){for(a=cq;Tk(dn);)co(ug(dn)),Lq(),dn=Eg(dn);Ol(cq-a)}else if(dn.k===Me){for(co(dn),lh(),dn=zn(),b=c=0,d=dn.tensor.nelem;0<=d?c<d:c>d;b=0<=d?++c:--c)co(dn.tensor.elem[b]),Lq(),dn.tensor.elem[b]=zn();co(dn)}else dn.k===Pd?(co(dn),$f()):dn===Pp(Vd)?fo(Math.PI):dn===Pp(ia)?fo(Math.E):co(dn);return Go()},zb=function(){return co(tg(dn)),xa(),uq()},uq=function(){return No(),Mq(),Go()},Mq=function(){var a;return a=0,dn=zn(),nl(dn)?Wk(dn)?(a=Math.floor(dn.d),void fo(a)):cl(dn)?void co(dn):(fn=new ef,fn.k=Pd,fn.q.a=$l(dn.q.a,dn.q.b),fn.q.b=dm(1),co(fn),jl(dn)?(jo(-1),Cf()):void 0):(lo(Tc),co(dn),void Ol(2))},Ab=function(){var a,b,c,d,e,f;for(a=0,b=0,c=0,kn=tg(dn),Bl(kn)||Hp("for: 1st arg?"),co(sg(dn)),xa(),b=Cn(),2147483648===b&&Hp("for: 2nd arg?"),co(rg(dn)),xa(),c=Cn(),2147483648===c&&Hp("for: 3rd arg?"),dn=Bg(dn),gn=hk(kn),fn=gk(kn),a=d=e=b,f=c;e<=f?d<=f:d>=f;a=e<=f?++d:--d)for(jo(a),hn=zn(),ep(kn,hn),en=dn;Tk(en);)co(ug(en)),xa(),zn(),en=Eg(en);return fp(kn,gn,fn),lo(Fd)},Bb=function(){return co(tg(dn)),xa(),Wj()},Wj=function(){return No(),Yj(),Go()},Yj=function(){return dn=zn(),yl(dn)&&td(dn.q.a,1)&&td(dn.q.b,2)?(lo(Vd),ko(1,2),void Dn()):yl(dn)&&td(dn.q.a,3)&&td(dn.q.b,2)?(lo(Vd),ko(1,2),Dn(),ko(1,2),void um()):kl(dn)?(lo(Vd),jo(-1),um(),lo(Vd),co(dn),um(),wp(),co(dn),um(),co(dn),Dm(),Wj(),um(),void ei()):ug(dn)===Pp(e)?void Xj():(lo(Wc),co(dn),void Ol(2))},Xj=function(){return fn=Eg(dn),yl(ug(fn))&&td(ug(fn).q.a,1)&&td(ug(fn).q.b,1)?(co(tg(fn)),co(tg(fn)),Wj(),um()):yl(ug(fn))&&td(ug(fn).q.a,-1)&&td(ug(fn).q.b,1)?(co(tg(fn)),Wj(),co(tg(fn)),jo(-1),Cf(),ei()):(lo(Wc),co(dn),Ol(2),void 0)},Cb=function(){var a;for(dn=Eg(dn),co(ug(dn)),xa(),dn=Eg(dn),a=[];Tk(dn);)co(ug(dn)),xa(),Zj(),a.push(dn=Eg(dn));return a},Zj=function(){var a;return a=kj,No(),bk(),Go(),kj=a},bk=function(){return kj=1,en=zn(),dn=zn(),Yi(dn,en)?void co(dn):yl(dn)&&yl(en)?(co(dn),co(en),void ck()):ug(dn)===Pp(e)&&ug(en)===Pp(e)?void _j():(ug(dn)===Pp(e)&&($j(dn),dn=zn()),ug(en)===Pp(e)&&($j(en),en=zn()),ug(dn)===Pp(Cd)&&ug(en)===Pp(Cd)?void ek():ug(dn)===Pp(Cd)?void dk():ug(en)===Pp(Cd)?void ak():(ug(dn)===Pp(Xd)?(fn=sg(dn),dn=tg(dn)):fn=Ym,ug(en)===Pp(Xd)?(gn=sg(en),en=tg(en)):gn=Ym,Yi(dn,en)?nl(fn)&&nl(gn)?(co(dn),co(Ml(fn,gn)?fn:gn),void Dn()):(co(fn),co(gn),ei(),hn=zn(),nl(hn)?(co(dn),hn=ug(fn)===Pp(Cd)&&nl(tg(fn))?tg(fn):Ym,kn=ug(gn)===Pp(Cd)&&nl(tg(gn))?tg(gn):Ym,co(Ml(hn,kn)?fn:gn),void Dn()):(co(fn),co(gn),Mp(),hn=zn(),nl(hn)?(co(dn),co(jl(hn)?fn:gn),Dn()):void co(Ym))):void co(Ym)))},_j=function(){if(Ll(dn)!==Ll(en))return void co(Ym);for(fn=Eg(dn),co(ug(fn)),fn=Eg(fn);Tk(fn);)co(ug(fn)),Zj(),fn=Eg(fn);for(fn=zn(),gn=Eg(en),co(ug(gn)),gn=Eg(gn);Tk(gn);)co(ug(gn)),Zj(),gn=Eg(gn);return gn=zn(),co(dn),co(fn),ei(),hn=zn(),co(en),co(gn),ei(),kn=zn(),Yi(hn,kn)?(co(hn),co(fn),co(gn),Zj(),um()):co(Ym)},$j=function(a){var b;for(a=Eg(a),co(ug(a)),a=Eg(a),b=[];Tk(a);)co(ug(a)),Zj(),b.push(a=Eg(a));return b},ek=function(){var a;for(co(Ym),fn=Eg(dn),a=[];Tk(fn);){for(gn=Eg(en);Tk(gn);)co(ug(fn)),co(ug(gn)),Zj(),um(),gn=Eg(gn);a.push(fn=Eg(fn))}return a},dk=function(){var a;for(co(Ym),fn=Eg(dn),a=[];Tk(fn);)co(ug(fn)),co(en),Zj(),um(),a.push(fn=Eg(fn));return a},ak=function(){var a;for(co(Ym),gn=Eg(en),a=[];Tk(gn);)co(dn),co(ug(gn)),Zj(),um(),a.push(gn=Eg(gn));return a},qk=function(){var a;return a=zn(),co(a),lo(Vc(a,Pp(Ge))?Ge:Vc(a,Pp(He))?He:Vc(a,Pp(Ie))?Ie:Vc(a,Pp(Fe))?Fe:Vc(a,Pp(Ee))?Ee:Ge)},sk=function(){return No(),Nq(),Go()},Nq=function(){var a;return a=0,en=zn(),dn=zn(),co(en),a=Cn(),a<0||2147483648===a?(lo(Yc),co(dn),co(en),void Ol(3)):Bl(dn)?Oq(a):(fn=dn,dn=Pp(ge),Oq(a),dn=fn,co(Pp(ge)),co(dn),Lp(),xa())},Oq=function(a){var b,c,d,e;for(b=0,jo(1),jo(0),gn=zn(),e=[],b=c=0,d=a;0<=d?c<d:c>d;b=0<=d?++c:--c)hn=gn,gn=zn(),co(dn),co(gn),um(),jo(b),co(hn),um(),Mp(),jo(2),e.push(um());return e},tk=function(){var a,b,c,d,e,f,g;if(b=0,c=0,d=0,No(),en=zn(),co(en),d=Cn(),d<2)return lo(Zc),co(en),Ol(2),void Go();for(oo(d,d),dn=zn(),b=e=0,f=d;0<=f?e<f:e>f;b=0<=f?++e:--e)for(c=a=0,g=d;0<=g?a<g:a>g;c=0<=g?++a:--a)jo(b+c+1),Ik(),dn.tensor.elem[b*d+c]=zn();return co(dn),Go()},Fb=function(){return co(tg(dn)),xa(),uk()},uk=function(){return No(),Bo(),dn=zn(),co(dn),co(dn),fh(),Mp(),jo(2),ei(),co(vk),ei(),Go()},wk=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u;if(f=0,g=0,h=0,i=0,j=0,u=0,No(),t=cq-a,dn=Cp[t],!Dl(dn))return cq-=a,co(dn),void Go();for(i=dn.tensor.ndim,h=a-1,h>i&&Hp("too many indices for tensor"),g=0,f=k=0,l=h;0<=l?k<l:k>l;f=0<=l?++k:--k)co(Cp[t+f+1]),u=Cn(),(u<1||u>dn.tensor.dim[f])&&Hp("index out of range"),g=g*dn.tensor.dim[f]+u-1;if(i===h)return cq-=a,co(dn.tensor.elem[g]),void Go();for(f=b=m=h,n=i;m<=n?b<n:b>n;f=m<=n?++b:--b)g=g*dn.tensor.dim[f]+0;for(j=1,f=c=o=h,p=i;o<=p?c<p:c>p;f=o<=p?++c:--c)j*=dn.tensor.dim[f];for(en=If(j),en.tensor.ndim=i-h,f=d=q=h,r=i;q<=r?d<r:d>r;f=q<=r?++d:--d)en.tensor.dim[f-h]=dn.tensor.dim[f];for(f=e=0,s=j;0<=s?e<s:e>s;f=0<=s?++e:--e)en.tensor.elem[f]=dn.tensor.elem[g+f];return dn.tensor.nelem!==dn.tensor.elem.length&&console.log("something wrong in tensor dimensions"),en.tensor.nelem!==en.tensor.elem.length&&console.log("something wrong in tensor dimensions"),cq-=a,co(en),Go()},gp=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t;for(g=0,h=0,i=0,j=0,t=0,No(),a<3&&Hp("error in indexed assign"),s=cq-a,en=Cp[s],dn=Cp[s+1],Dl(dn)||Hp("error in indexed assign"),j=dn.tensor.ndim,i=a-2,i>j&&Hp("error in indexed assign"),h=0,g=k=0,l=i;0<=l?k<l:k>l;g=0<=l?++k:--k)co(Cp[s+g+2]),t=Cn(),(t<1||t>dn.tensor.dim[g])&&Hp("error in indexed assign\n"),h=h*dn.tensor.dim[g]+t-1;for(g=b=m=i,n=j;m<=n?b<n:b>n;g=m<=n?++b:--b)h=h*dn.tensor.dim[g]+0;for(fn=If(dn.tensor.nelem),fn.tensor.ndim=dn.tensor.ndim,g=c=0,o=dn.tensor.ndim;0<=o?c<o:c>o;g=0<=o?++c:--c)fn.tensor.dim[g]=dn.tensor.dim[g];for(g=d=0,p=dn.tensor.nelem;0<=p?d<p:d>p;g=0<=p?++d:--d)fn.tensor.elem[g]=dn.tensor.elem[g];if(dn.tensor.nelem!==dn.tensor.elem.length&&console.log("something wrong in tensor dimensions"),fn.tensor.nelem!==fn.tensor.elem.length&&console.log("something wrong in tensor dimensions"),dn=fn,j===i)return Dl(en)&&Hp("error in indexed assign"),dn.tensor.elem[h]=en,dn.tensor.nelem!==dn.tensor.elem.length&&console.log("something wrong in tensor dimensions"),cq-=a,co(dn),void Go();for(Dl(en)||Hp("error in indexed assign"),j-i!==en.tensor.ndim&&Hp("error in indexed assign"),g=e=0,q=en.tensor.ndim;0<=q?e<q:e>q;g=0<=q?++e:--e)dn.tensor.dim[i+g]!==en.tensor.dim[g]&&Hp("error in indexed assign");for(g=f=0,r=en.tensor.nelem;0<=r?f<r:f>r;g=0<=r?++f:--f)dn.tensor.elem[h+g]=en.tensor.elem[g];return dn.tensor.nelem!==dn.tensor.elem.length&&console.log("something wrong in tensor dimensions"),en.tensor.nelem!==en.tensor.elem.length&&console.log("something wrong in tensor dimensions"),cq-=a,co(dn),Go()},Hb=function(){var a;for(dn=Eg(dn),co(ug(dn)),xa(),dn=Eg(dn),a=[];Tk(dn);)co(ug(dn)),xa(),Ak(),a.push(dn=Eg(dn));return a},Ak=function(){return No(),en=zn(),dn=zn(),Dl(dn)&&Dl(en)?Bk():(co(dn),co(en),Dl(dn)?Wp():Dl(en)?Oo():um()),Go()},Bk=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x;for(l=0,o=dn.tensor.dim[dn.tensor.ndim-1],o!==en.tensor.dim[0]&&Hp("inner: tensor dimension check"),p=dn.tensor.ndim+en.tensor.ndim-2,p>qd&&Hp("inner: rank of result exceeds maximum"),a=dn.tensor.elem,i=en.tensor.elem,h=1,l=q=0,r=dn.tensor.ndim-1;0<=r?q<r:q>r;l=0<=r?++q:--q)h*=dn.tensor.dim[l];for(j=1,l=b=1,s=en.tensor.ndim;1<=s?b<s:b>s;l=1<=s?++b:--b)j*=en.tensor.dim[l];for(fn=If(h*j),k=fn.tensor.elem,l=c=0,t=h;0<=t?c<t:c>t;l=0<=t?++c:--c)for(m=d=0,u=o;0<=u?d<u:d>u;m=0<=u?++d:--d)if(!El(a[l*o+m]))for(n=e=0,v=j;0<=v?e<v:e>v;n=0<=v?++e:--e)co(a[l*o+m]),co(i[m*j+n]),um(),co(k[l*j+n]),Cf(),k[l*j+n]=zn();if(0===p)return co(fn.tensor.elem[0]);for(fn.tensor.ndim=p,m=0,l=f=0,w=dn.tensor.ndim-1;0<=w?f<w:f>w;l=0<=w?++f:--f)fn.tensor.dim[l]=dn.tensor.dim[l];for(m=dn.tensor.ndim-1,l=g=0,x=en.tensor.ndim-1;0<=x?g<x:g>x;l=0<=x?++g:--g)fn.tensor.dim[m+l]=en.tensor.dim[l+1];return co(fn)},Fl=["f(a,a*x)","f(1/x,log(x))","f(x^a,x^(a+1)/(a+1))","f(exp(a*x),1/a*exp(a*x))","f(exp(a*x+b),1/a*exp(a*x+b))","f(x*exp(a*x^2),exp(a*x^2)/(2*a))","f(x*exp(a*x^2+b),exp(a*x^2+b)/(2*a))","f(log(a*x),x*log(a*x)-x)","f(a^x,a^x/log(a),or(not(number(a)),a>0))","f(1/(a+x^2),1/sqrt(a)*arctan(x/sqrt(a)),or(not(number(a)),a>0))","f(1/(a-x^2),1/sqrt(a)*arctanh(x/sqrt(a)))","f(1/sqrt(a-x^2),arcsin(x/(sqrt(a))))","f(1/sqrt(a+x^2),log(x+sqrt(a+x^2)))","f(1/(a+b*x),1/b*log(a+b*x))","f(1/(a+b*x)^2,-1/(b*(a+b*x)))","f(1/(a+b*x)^3,-1/(2*b)*1/(a+b*x)^2)","f(x/(a+b*x),x/b-a*log(a+b*x)/b/b)","f(x/(a+b*x)^2,1/b^2*(log(a+b*x)+a/(a+b*x)))","f(x^2/(a+b*x),1/b^2*(1/2*(a+b*x)^2-2*a*(a+b*x)+a^2*log(a+b*x)))","f(x^2/(a+b*x)^2,1/b^3*(a+b*x-2*a*log(a+b*x)-a^2/(a+b*x)))","f(x^2/(a+b*x)^3,1/b^3*(log(a+b*x)+2*a/(a+b*x)-1/2*a^2/(a+b*x)^2))","f(1/x*1/(a+b*x),-1/a*log((a+b*x)/x))","f(1/x*1/(a+b*x)^2,1/a*1/(a+b*x)-1/a^2*log((a+b*x)/x))","f(1/x*1/(a+b*x)^3,1/a^3*(1/2*((2*a+b*x)/(a+b*x))^2+log(x/(a+b*x))))","f(1/x^2*1/(a+b*x),-1/(a*x)+b/a^2*log((a+b*x)/x))","f(1/x^3*1/(a+b*x),(2*b*x-a)/(2*a^2*x^2)+b^2/a^3*log(x/(a+b*x)))","f(1/x^2*1/(a+b*x)^2,-(a+2*b*x)/(a^2*x*(a+b*x))+2*b/a^3*log((a+b*x)/x))","f(1/(a+b*x^2),1/sqrt(a*b)*arctan(x*sqrt(a*b)/a),or(not(number(a*b)),a*b>0))","f(1/(a+b*x^2),1/(2*sqrt(-a*b))*log((a+x*sqrt(-a*b))/(a-x*sqrt(-a*b))),or(not(number(a*b)),a*b<0))","f(x/(a+b*x^2),1/2*1/b*log(a+b*x^2))","f(x^2/(a+b*x^2),x/b-a/b*integral(1/(a+b*x^2),x))","f(1/(a+b*x^2)^2,x/(2*a*(a+b*x^2))+1/2*1/a*integral(1/(a+b*x^2),x))","f(1/x*1/(a+b*x^2),1/2*1/a*log(x^2/(a+b*x^2)))","f(1/x^2*1/(a+b*x^2),-1/(a*x)-b/a*integral(1/(a+b*x^2),x))","f(1/(a+b*x^3),1/3*1/a*(a/b)^(1/3)*(1/2*log(((a/b)^(1/3)+x)^3/(a+b*x^3))+sqrt(3)*arctan((2*x-(a/b)^(1/3))*(a/b)^(-1/3)/sqrt(3))))","f(x^2/(a+b*x^3),1/3*1/b*log(a+b*x^3))","f(1/(a+b*x^4),1/2*1/a*(a/b/4)^(1/4)*(1/2*log((x^2+2*(a/b/4)^(1/4)*x+2*(a/b/4)^(1/2))/(x^2-2*(a/b/4)^(1/4)*x+2*(a/b/4)^(1/2)))+arctan(2*(a/b/4)^(1/4)*x/(2*(a/b/4)^(1/2)-x^2))),or(not(number(a*b)),a*b>0))","f(1/(a+b*x^4),1/2*(-a/b)^(1/4)/a*(1/2*log((x+(-a/b)^(1/4))/(x-(-a/b)^(1/4)))+arctan(x*(-a/b)^(-1/4))),or(not(number(a*b)),a*b<0))","f(x/(a+b*x^4),1/2*sqrt(b/a)/b*arctan(x^2*sqrt(b/a)),or(not(number(a*b)),a*b>0))","f(x/(a+b*x^4),1/4*sqrt(-b/a)/b*log((x^2-sqrt(-a/b))/(x^2+sqrt(-a/b))),or(not(number(a*b)),a*b<0))","f(x^2/(a+b*x^4),1/4*1/b*(a/b/4)^(-1/4)*(1/2*log((x^2-2*(a/b/4)^(1/4)*x+2*sqrt(a/b/4))/(x^2+2*(a/b/4)^(1/4)*x+2*sqrt(a/b/4)))+arctan(2*(a/b/4)^(1/4)*x/(2*sqrt(a/b/4)-x^2))),or(not(number(a*b)),a*b>0))","f(x^2/(a+b*x^4),1/4*1/b*(-a/b)^(-1/4)*(log((x-(-a/b)^(1/4))/(x+(-a/b)^(1/4)))+2*arctan(x*(-a/b)^(-1/4))),or(not(number(a*b)),a*b<0))","f(x^3/(a+b*x^4),1/4*1/b*log(a+b*x^4))","f(sqrt(a+b*x),2/3*1/b*sqrt((a+b*x)^3))","f(x*sqrt(a+b*x),-2*(2*a-3*b*x)*sqrt((a+b*x)^3)/15/b^2)","f(x^2*sqrt(a+b*x),2*(8*a^2-12*a*b*x+15*b^2*x^2)*sqrt((a+b*x)^3)/105/b^3)","f(sqrt(a+b*x)/x,2*sqrt(a+b*x)+a*integral(1/x*1/sqrt(a+b*x),x))","f(sqrt(a+b*x)/x^2,-sqrt(a+b*x)/x+b/2*integral(1/x*1/sqrt(a+b*x),x))","f(1/sqrt(a+b*x),2*sqrt(a+b*x)/b)","f(x/sqrt(a+b*x),-2/3*(2*a-b*x)*sqrt(a+b*x)/b^2)","f(x^2/sqrt(a+b*x),2/15*(8*a^2-4*a*b*x+3*b^2*x^2)*sqrt(a+b*x)/b^3)","f(1/x*1/sqrt(a+b*x),1/sqrt(a)*log((sqrt(a+b*x)-sqrt(a))/(sqrt(a+b*x)+sqrt(a))),or(not(number(a)),a>0))","f(1/x*1/sqrt(a+b*x),2/sqrt(-a)*arctan(sqrt(-(a+b*x)/a)),or(not(number(a)),a<0))","f(1/x^2*1/sqrt(a+b*x),-sqrt(a+b*x)/a/x-1/2*b/a*integral(1/x*1/sqrt(a+b*x),x))","f(sqrt(x^2+a),1/2*(x*sqrt(x^2+a)+a*log(x+sqrt(x^2+a))))","f(1/sqrt(x^2+a),log(x+sqrt(x^2+a)))","f(1/x*1/sqrt(x^2+a),arcsec(x/sqrt(-a))/sqrt(-a),or(not(number(a)),a<0))","f(1/x*1/sqrt(x^2+a),-1/sqrt(a)*log((sqrt(a)+sqrt(x^2+a))/x),or(not(number(a)),a>0))","f(sqrt(x^2+a)/x,sqrt(x^2+a)-sqrt(a)*log((sqrt(a)+sqrt(x^2+a))/x),or(not(number(a)),a>0))","f(sqrt(x^2+a)/x,sqrt(x^2+a)-sqrt(-a)*arcsec(x/sqrt(-a)),or(not(number(a)),a<0))","f(x/sqrt(x^2+a),sqrt(x^2+a))","f(x*sqrt(x^2+a),1/3*sqrt((x^2+a)^3))","f(sqrt(a+x^6+3*a^(1/3)*x^4+3*a^(2/3)*x^2),1/4*(x*sqrt((x^2+a^(1/3))^3)+3/2*a^(1/3)*x*sqrt(x^2+a^(1/3))+3/2*a^(2/3)*log(x+sqrt(x^2+a^(1/3)))))","f(sqrt(-a+x^6-3*a^(1/3)*x^4+3*a^(2/3)*x^2),1/4*(x*sqrt((x^2-a^(1/3))^3)-3/2*a^(1/3)*x*sqrt(x^2-a^(1/3))+3/2*a^(2/3)*log(x+sqrt(x^2-a^(1/3)))))","f(1/sqrt(a+x^6+3*a^(1/3)*x^4+3*a^(2/3)*x^2),x/a^(1/3)/sqrt(x^2+a^(1/3)))","f(x/sqrt(a+x^6+3*a^(1/3)*x^4+3*a^(2/3)*x^2),-1/sqrt(x^2+a^(1/3)))","f(x*sqrt(a+x^6+3*a^(1/3)*x^4+3*a^(2/3)*x^2),1/5*sqrt((x^2+a^(1/3))^5))","f(x^2*sqrt(x^2+a),1/4*x*sqrt((x^2+a)^3)-1/8*a*x*sqrt(x^2+a)-1/8*a^2*log(x+sqrt(x^2+a)))","f(x^3*sqrt(x^2+a),(1/5*x^2-2/15*a)*sqrt((x^2+a)^3),and(number(a),a>0))","f(x^3*sqrt(x^2+a),sqrt((x^2+a)^5)/5-a*sqrt((x^2+a)^3)/3,and(number(a),a<0))","f(x^2/sqrt(x^2+a),1/2*x*sqrt(x^2+a)-1/2*a*log(x+sqrt(x^2+a)))","f(x^3/sqrt(x^2+a),1/3*sqrt((x^2+a)^3)-a*sqrt(x^2+a))","f(1/x^2*1/sqrt(x^2+a),-sqrt(x^2+a)/a/x)","f(1/x^3*1/sqrt(x^2+a),-1/2*sqrt(x^2+a)/a/x^2+1/2*log((sqrt(a)+sqrt(x^2+a))/x)/a^(3/2),or(not(number(a)),a>0))","f(1/x^3*1/sqrt(x^2-a),1/2*sqrt(x^2-a)/a/x^2+1/2*1/(a^(3/2))*arcsec(x/(a^(1/2))),or(not(number(a)),a>0))","f(x^2*sqrt(a+x^6+3*a^(1/3)*x^4+3*a^(2/3)*x^2),1/6*x*sqrt((x^2+a^(1/3))^5)-1/24*a^(1/3)*x*sqrt((x^2+a^(1/3))^3)-1/16*a^(2/3)*x*sqrt(x^2+a^(1/3))-1/16*a*log(x+sqrt(x^2+a^(1/3))),or(not(number(a)),a>0))","f(x^2*sqrt(-a-3*a^(1/3)*x^4+3*a^(2/3)*x^2+x^6),1/6*x*sqrt((x^2-a^(1/3))^5)+1/24*a^(1/3)*x*sqrt((x^2-a^(1/3))^3)-1/16*a^(2/3)*x*sqrt(x^2-a^(1/3))+1/16*a*log(x+sqrt(x^2-a^(1/3))),or(not(number(a)),a>0))","f(x^3*sqrt(a+x^6+3*a^(1/3)*x^4+3*a^(2/3)*x^2),1/7*sqrt((x^2+a^(1/3))^7)-1/5*a^(1/3)*sqrt((x^2+a^(1/3))^5),or(not(number(a)),a>0))","f(x^3*sqrt(-a-3*a^(1/3)*x^4+3*a^(2/3)*x^2+x^6),1/7*sqrt((x^2-a^(1/3))^7)+1/5*a^(1/3)*sqrt((x^2-a^(1/3))^5),or(not(number(a)),a>0))","f(1/(x-a)/sqrt(x^2-a^2),-sqrt(x^2-a^2)/a/(x-a))","f(1/(x+a)/sqrt(x^2-a^2),sqrt(x^2-a^2)/a/(x+a))","f(sqrt(a-x^2),1/2*(x*sqrt(a-x^2)+a*arcsin(x/sqrt(abs(a)))))","f(1/x*1/sqrt(a-x^2),-1/sqrt(a)*log((sqrt(a)+sqrt(a-x^2))/x),or(not(number(a)),a>0))","f(sqrt(a-x^2)/x,sqrt(a-x^2)-sqrt(a)*log((sqrt(a)+sqrt(a-x^2))/x),or(not(number(a)),a>0))","f(x/sqrt(a-x^2),-sqrt(a-x^2))","f(x*sqrt(a-x^2),-1/3*sqrt((a-x^2)^3))","f(x^2*sqrt(a-x^2),-x/4*sqrt((a-x^2)^3)+1/8*a*(x*sqrt(a-x^2)+a*arcsin(x/sqrt(a))),or(not(number(a)),a>0))","f(x^3*sqrt(a-x^2),(-1/5*x^2-2/15*a)*sqrt((a-x^2)^3),or(not(number(a)),a>0))","f(x^2/sqrt(a-x^2),-x/2*sqrt(a-x^2)+a/2*arcsin(x/sqrt(a)),or(not(number(a)),a>0))","f(1/x^2*1/sqrt(a-x^2),-sqrt(a-x^2)/a/x,or(not(number(a)),a>0))","f(sqrt(a-x^2)/x^2,-sqrt(a-x^2)/x-arcsin(x/sqrt(a)),or(not(number(a)),a>0))","f(sqrt(a-x^2)/x^3,-1/2*sqrt(a-x^2)/x^2+1/2*log((sqrt(a)+sqrt(a-x^2))/x)/sqrt(a),or(not(number(a)),a>0))","f(sqrt(a-x^2)/x^4,-1/3*sqrt((a-x^2)^3)/a/x^3,or(not(number(a)),a>0))","f(sqrt(a*x^2+b),x*sqrt(a*x^2+b)/2+b*log(x*sqrt(a)+sqrt(a*x^2+b))/2/sqrt(a),and(number(a),a>0))","f(sqrt(a*x^2+b),x*sqrt(a*x^2+b)/2+b*arcsin(x*sqrt(-a/b))/2/sqrt(-a),and(number(a),a<0))","f(sin(a*x),-cos(a*x)/a)","f(cos(a*x),sin(a*x)/a)","f(tan(a*x),-log(cos(a*x))/a)","f(1/tan(a*x),log(sin(a*x))/a)","f(1/cos(a*x),log(tan(pi/4+a*x/2))/a)","f(1/sin(a*x),log(tan(a*x/2))/a)","f(sin(a*x)^2,x/2-sin(2*a*x)/(4*a))","f(sin(a*x)^3,-cos(a*x)*(sin(a*x)^2+2)/(3*a))","f(sin(a*x)^4,3/8*x-sin(2*a*x)/(4*a)+sin(4*a*x)/(32*a))","f(cos(a*x)^2,x/2+sin(2*a*x)/(4*a))","f(cos(a*x)^3,sin(a*x)*(cos(a*x)^2+2)/(3*a))","f(cos(a*x)^4,3/8*x+sin(2*a*x)/(4*a)+sin(4*a*x)/(32*a))","f(1/sin(a*x)^2,-1/(a*tan(a*x)))","f(1/cos(a*x)^2,tan(a*x)/a)","f(sin(a*x)*cos(a*x),sin(a*x)^2/(2*a))","f(sin(a*x)^2*cos(a*x)^2,-sin(4*a*x)/(32*a)+x/8)","f(sin(a*x)/cos(a*x)^2,1/(a*cos(a*x)))","f(sin(a*x)^2/cos(a*x),(log(tan(pi/4+a*x/2))-sin(a*x))/a)","f(cos(a*x)/sin(a*x)^2,-1/(a*sin(a*x)))","f(1/(sin(a*x)*cos(a*x)),log(tan(a*x))/a)","f(1/(sin(a*x)*cos(a*x)^2),(1/cos(a*x)+log(tan(a*x/2)))/a)","f(1/(sin(a*x)^2*cos(a*x)),(log(tan(pi/4+a*x/2))-1/sin(a*x))/a)","f(1/(sin(a*x)^2*cos(a*x)^2),-2/(a*tan(2*a*x)))","f(sin(a+b*x),-cos(a+b*x)/b)","f(cos(a+b*x),sin(a+b*x)/b)","f(1/(b+b*sin(a*x)),-tan(pi/4-a*x/2)/a/b)","f(1/(b-b*sin(a*x)),tan(pi/4+a*x/2)/a/b)","f(1/(b+b*cos(a*x)),tan(a*x/2)/a/b)","f(1/(b-b*cos(a*x)),-1/tan(a*x/2)/a/b)","f(1/(a+b*sin(x)),1/sqrt(b^2-a^2)*log((a*tan(x/2)+b-sqrt(b^2-a^2))/(a*tan(x/2)+b+sqrt(b^2-a^2))),b^2-a^2)","f(1/(a+b*cos(x)),1/sqrt(b^2-a^2)*log((sqrt(b^2-a^2)*tan(x/2)+a+b)/(sqrt(b^2-a^2)*tan(x/2)-a-b)),b^2-a^2)","f(x*sin(a*x),sin(a*x)/a^2-x*cos(a*x)/a)","f(x^2*sin(a*x),2*x*sin(a*x)/a^2-(a^2*x^2-2)*cos(a*x)/a^3)","f(x*cos(a*x),cos(a*x)/a^2+x*sin(a*x)/a)","f(x^2*cos(a*x),2*x*cos(a*x)/a^2+(a^2*x^2-2)*sin(a*x)/a^3)","f(arcsin(a*x),x*arcsin(a*x)+sqrt(1-a^2*x^2)/a)","f(arccos(a*x),x*arccos(a*x)-sqrt(1-a^2*x^2)/a)","f(arctan(a*x),x*arctan(a*x)-1/2*log(1+a^2*x^2)/a)","f(log(a*x),x*log(a*x)-x)","f(x*log(a*x),x^2*log(a*x)/2-x^2/4)","f(x^2*log(a*x),x^3*log(a*x)/3-1/9*x^3)","f(log(x)^2,x*log(x)^2-2*x*log(x)+2*x)","f(1/x*1/(a+log(x)),log(a+log(x)))","f(log(a*x+b),(a*x+b)*log(a*x+b)/a-x)","f(log(a*x+b)/x^2,a/b*log(x)-(a*x+b)*log(a*x+b)/b/x)","f(sinh(x),cosh(x))","f(cosh(x),sinh(x))","f(tanh(x),log(cosh(x)))","f(x*sinh(x),x*cosh(x)-sinh(x))","f(x*cosh(x),x*sinh(x)-cosh(x))","f(sinh(x)^2,sinh(2*x)/4-x/2)","f(tanh(x)^2,x-tanh(x))","f(cosh(x)^2,sinh(2*x)/4+x/2)","f(x^3*exp(a*x^2),exp(a*x^2)*(x^2/a-1/(a^2))/2)","f(x^3*exp(a*x^2+b),exp(a*x^2)*exp(b)*(x^2/a-1/(a^2))/2)","f(exp(a*x^2),-i*sqrt(pi)*erf(i*sqrt(a)*x)/sqrt(a)/2)","f(erf(a*x),x*erf(a*x)+exp(-a^2*x^2)/a/sqrt(pi))","f(x^2*(1-x^2)^(3/2),(x*sqrt(1-x^2)*(-8*x^4+14*x^2-3)+3*arcsin(x))/48)","f(x^2*(1-x^2)^(5/2),(x*sqrt(1-x^2)*(48*x^6-136*x^4+118*x^2-15)+15*arcsin(x))/384)","f(x^4*(1-x^2)^(3/2),(-x*sqrt(1-x^2)*(16*x^6-24*x^4+2*x^2+3)+3*arcsin(x))/128)","f(x*exp(a*x),exp(a*x)*(a*x-1)/(a^2))","f(x*exp(a*x+b),exp(a*x+b)*(a*x-1)/(a^2))","f(x^2*exp(a*x),exp(a*x)*(a^2*x^2-2*a*x+2)/(a^3))","f(x^2*exp(a*x+b),exp(a*x+b)*(a^2*x^2-2*a*x+2)/(a^3))","f(x^3*exp(a*x),exp(a*x)*x^3/a-3/a*integral(x^2*exp(a*x),x))","f(x^3*exp(a*x+b),exp(a*x+b)*x^3/a-3/a*integral(x^2*exp(a*x+b),x))",0],
Ib=function(){var a,b,c,d,e,f,g;for(c=0,d=0,dn=Eg(dn),co(ug(dn)),xa(),dn=Eg(dn),co(ug(dn)),xa(),en=zn(),en===Pp(Fd)?(qk(),co(Pp(Fd))):nl(en)?(qk(),co(en)):(co(en),dn=Eg(dn),co(ug(dn)),xa()),hn=zn(),gn=zn(),fn=zn();;){if(nl(hn)?(co(hn),d=Cn(),2147483648===d&&Hp("nth integral: check n")):d=1,co(fn),d>=0)for(c=e=0,f=d;0<=f?e<f:e>f;c=0<=f?++e:--e)co(gn),Dk();else for(d=-d,c=a=0,g=d;0<=g?a<g:a>g;c=0<=g?++a:--a)co(gn),Vh();if(fn=zn(),hn===Pp(Fd))break;if(nl(hn)){if(dn=Eg(dn),co(ug(dn)),xa(),hn=zn(),hn===Pp(Fd))break;nl(hn)?b=1:(gn=hn,dn=Eg(dn),co(ug(dn)),xa(),hn=zn())}else gn=hn,dn=Eg(dn),co(ug(dn)),xa(),hn=zn()}return co(fn)},Dk=function(){return No(),en=zn(),dn=zn(),ug(dn)===Pp(e)?Gk():ug(dn)===Pp(Cd)?Fk():Ek(),dn=zn(),Vc(dn,Pp(bd))&&Hp("integral: sorry, could not find a solution"),co(dn),qp(),xa(),Go()},Gk=function(){var a;for(dn=Eg(dn),co(ug(dn)),co(en),Dk(),dn=Eg(dn),a=[];Tk(dn);)co(ug(dn)),co(en),Dk(),Cf(),a.push(dn=Eg(dn));return a},Fk=function(){return co(dn),co(en),sn(),dn=zn(),Ek(),um()},Ek=function(){return co(dn),co(en),dq(Fl),fn=zn(),fn===Pp(Fd)?(lo(bd),co(dn),co(en),Ol(3)):co(fn)},ed=function(){return Dl(dn)?2!==dn.tensor.ndim?0:dn.tensor.dim[0]!==dn.tensor.dim[1]?0:1:0},Hk=function(){var a,b,c,d,e;if(b=0,c=0,No(),dn=zn(),0===ed())return lo(cd),co(dn),Ol(2),void Go();for(c=dn.tensor.nelem,a=dn.tensor.elem,b=d=0,e=c;(0<=e?d<e:d>e)&&nl(a[b]);b=0<=e?++d:--d);return b===c?Pq():(co(dn),Hf(),co(dn),Xh(),en=zn(),El(en)&&Hp("inverse of singular matrix"),co(en),ei()),Go()},Kk=function(){return No(),dn=zn(),0===ed()?(lo(dd),co(dn),Ol(2),void Go()):(Pq(),Go())},Pq=function(){var a,b,c,d,e,f,g,h,i,j,k,l;for(d=0,e=0,f=0,g=0,g=dn.tensor.dim[0],d=cq,e=h=0,i=g;0<=i?h<i:h>i;e=0<=i?++h:--h)for(f=a=0,j=g;0<=j?a<j:a>j;f=0<=j?++a:--a)co(e===f?Ym:_q);for(e=b=0,k=g*g;0<=k?b<k:b>k;e=0<=k?++b:--b)co(dn.tensor.elem[e]);for(fd(g),dn=If(g*g),dn.tensor.ndim=2,dn.tensor.dim[0]=g,dn.tensor.dim[1]=g,e=c=0,l=g*g;0<=l?c<l:c>l;e=0<=l?++c:--c)dn.tensor.elem[e]=Cp[d+e];return cq-=2*g*g,co(dn)},fd=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p;for(b=0,f=0,g=0,h=0,p=0,b=cq-a*a,p=b-a*a,o=[],f=i=0,j=a;0<=j?i<j:i>j;f=0<=j?++i:--i){if(Yi(Cp[b+a*f+f],_q)){for(g=c=k=f+1,l=a;(k<=l?c<l:c>l)&&Yi(Cp[b+a*g+f],_q);g=k<=l?++c:--c);for(g===a&&Hp("inverse of singular matrix"),h=d=0,m=a;0<=m?d<m:d>m;h=0<=m?++d:--d)en=Cp[b+a*f+h],Cp[b+a*f+h]=Cp[b+a*g+h],Cp[b+a*g+h]=en,en=Cp[p+a*f+h],Cp[p+a*f+h]=Cp[p+a*g+h],Cp[p+a*g+h]=en}for(en=Cp[b+a*f+f],h=e=0,n=a;0<=n?e<n:e>n;h=0<=n?++e:--e)h>f&&(co(Cp[b+a*f+h]),co(en),ei(),Cp[b+a*f+h]=zn()),co(Cp[p+a*f+h]),co(en),ei(),Cp[p+a*f+h]=zn();o.push(function(){var c,d,e;for(e=[],g=c=0,d=a;0<=d?c<d:c>d;g=0<=d?++c:--c)g!==f&&(en=Cp[b+a*g+f],e.push(function(){var c,d,e;for(e=[],h=c=0,d=a;0<=d?c<d:c>d;h=0<=d?++c:--c)h>f&&(co(Cp[b+a*g+h]),co(Cp[b+a*f+h]),co(en),um(),Mp(),Cp[b+a*g+h]=zn()),co(Cp[p+a*g+h]),co(Cp[p+a*f+h]),co(en),um(),Mp(),e.push(Cp[p+a*g+h]=zn());return e}()));return e}())}return o},El=function(a){var b,c,d;switch(b=0,a.k){case Pd:if(Dd(a.q.a))return 1;break;case ea:if(0===a.d)return 1;break;case Me:for(b=c=0,d=a.tensor.nelem;0<=d?c<d:c>d;b=0<=d?++c:--c)if(!El(a.tensor.elem[b]))return 0;return 1}return 0},jl=function(a){switch(a.k){case Pd:if(Bd(a.q.a)===-1)return 1;break;case ea:if(a.d<0)return 1}return 0},ql=function(a){switch(a.k){case Pd:if(td(a.q.a,1)&&td(a.q.b,1))return 1;break;case ea:if(1===a.d)return 1}return 0},fl=function(a){switch(a.k){case Pd:if(td(a.q.a,-1)&&td(a.q.b,1))return 1;break;case ea:if(a.d===-1)return 1}return 0},cl=function(a){return a.k===Pd&&td(a.q.b,1)?1:0},ll=function(a){return yl(a)&&td(a.q.b,1)&&1===Bd(a.q.a)?1:0},vl=function(a){return cl(a)&&1===Bd(a.q.a)?1:0},rl=function(a,b){return Vc(a,b)?sl(a,b):0},sl=function(a,b){if(ug(a)===Pp(e)){for(a=Eg(a);Tk(a);){if(!ul(ug(a),b))return 0;a=Eg(a)}return 1}return ul(a,b)},ul=function(a,b){if(ug(a)===Pp(Cd)){for(a=Eg(a);Tk(a);){if(!tl(ug(a),b))return 0;a=Eg(a)}return 1}return tl(a,b)},tl=function(a,b){return Yi(a,b)?1:ug(a)===Pp(Xd)&&Yi(tg(a),b)?vl(sg(a))?1:0:Vc(a,b)?0:1},kl=function(a){return jl(a)?1:ug(a)===Pp(Cd)&&jl(tg(a))?1:0},al=function(a){return ug(a)===Pp(Cd)&&3===Ll(a)&&nl(tg(a))&&Yi(sg(a),vk)||Yi(a,vk)?1:0},Sk=function(a){return ug(a)===Pp(e)&&3===Ll(a)&&nl(tg(a))&&al(sg(a))||al(a)?1:0},Xk=function(a){return cl(a)&&a.q.a.isEven()?1:0},il=function(a){return ug(a)===Pp(e)&&kl(tg(a))?1:kl(a)?1:0},Cl=function(a){if(Bl(a))return 1;for(;Tk(a);){if(Cl(ug(a)))return 1;a=Eg(a)}return 0},dl=function(a){return cl(a)||ug(a)===Pp(Xd)&&cl(tg(a))&&cl(sg(a))?1:0},ol=function(a){return ug(a)===Pp(Xd)&&fl(sg(a))?1:0},_k=function(a){return a.k!==Pd||td(a.q.b,1)?0:1},Zi=function(a,b){switch(a.k){case Pd:if(td(a.q.a,b)&&td(a.q.b,1))return 1;break;case ea:if(a.d===b)return 1}return 0},$i=function(a,b,c){switch(a.k){case Pd:if(td(a.q.a,b)&&td(a.q.b,c))return 1;break;case ea:if(a.d===b/c)return 1}return 0},pl=function(a){return ug(a)===Pp(Xd)&&Zi(tg(a),2)&&$i(sg(a),-1,2)?1:0},gl=function(a){return ug(a)===Pp(Cd)&&Zi(tg(a),-1)&&pl(sg(a))&&3===Ll(a)?1:0},$k=function(a){if(a.k===ea)return 1;for(;Tk(a);){if($k(ug(a)))return 1;a=Eg(a)}return 0},bl=function(a){return Yi(a,vk)?1:0},xl=function(a){var b,c;if(c=0,b=0,ug(a)!==Pp(Cd))return 0;if(Yi(tg(a),vk))return sg(a)!==Pp(Vd)?0:3!==Ll(a)?0:2;if(!nl(tg(a)))return 0;if(!Yi(sg(a),vk))return 0;if(rg(a)!==Pp(Vd))return 0;if(4!==Ll(a))return 0;if(co(tg(a)),jo(2),um(),c=Cn(),2147483648===c)return 0;switch(c<1&&(b=1,c=-c),c%4){case 0:c=1;break;case 1:c=b?4:3;break;case 2:c=2;break;case 3:c=b?3:4}return c},ml=function(a){var b,c;return c=0,a===Pp(Vd)?2:ug(a)===Pp(Cd)&&nl(tg(a))&&sg(a)===Pp(Vd)&&3===Ll(a)?(b=0,co(tg(a)),jo(2),um(),c=Cn(),2147483648===c?0:c=c<0?4- -c%4:1+(c-1)%4):0},c.iszero=El,c.isnegativenumber=jl,c.isplusone=ql,c.isminusone=fl,c.isinteger=cl,c.isnonnegativeinteger=ll,c.isposint=vl,c.isnegativeterm=kl,c.isimaginarynumber=al,c.iscomplexnumber=Sk,c.iseveninteger=Xk,c.isnegative=il,c.issymbolic=Cl,c.isintegerfactor=dl,c.isoneover=ol,c.isfraction=_k,c.isoneoversqrttwo=pl,c.isminusoneoversqrttwo=gl,c.isfloating=$k,c.isimaginaryunit=bl,c.isquarterturn=xl,c.isnpi=ml,Mb=function(){return co(tg(dn)),xa(),dn=zn(),jo(ll(dn)&&om(dn.q.a)?1:0)},Nb=function(){return co(tg(dn)),xa(),co(sg(dn)),xa(),co(rg(dn)),xa(),en=zn(),en===Pp(Fd)?jo(0):co(en),Gl()},Gl=function(){var a;return a=0,No(),fn=zn(),en=zn(),dn=zn(),co(en),a=Cn(),a<0||2147483648===a?(lo(id),co(dn),co(en),co(fn),Ol(4),void Go()):(Bl(dn)?Hl(a):(gn=dn,dn=Pp(ge),Hl(a),dn=gn,co(Pp(ge)),co(dn),Lp(),xa()),Go())},Hl=function(a){var b,c,d,e;for(b=0,jo(1),jo(0),kn=zn(),e=[],b=c=0,d=a;0<=d?c<d:c>d;b=0<=d?++c:--c)hn=kn,kn=zn(),jo(2*b+1),co(dn),Mp(),co(fn),Cf(),co(kn),um(),jo(b),co(fn),Cf(),co(hn),um(),Mp(),jo(b+1),e.push(ei());return e},Ob=function(){var a;for(dn=Eg(dn),co(ug(dn)),xa(),dn=Eg(dn),a=[];Tk(dn);)co(ug(dn)),xa(),Il(),a.push(dn=Eg(dn));return a},Il=function(){var a;return a=0,a=kj,No(),Qq(),Go(),kj=a},Qq=function(){return kj=1,en=zn(),dn=zn(),co(dn),co(en),Zj(),co(dn),ei(),co(en),ei(),Ik()},Pb=function(){return co(tg(dn)),xa(),co(sg(dn)),xa(),dn=zn(),dn===Pp(Fd)?qk():co(dn),Jl()},Jl=function(){return No(),en=zn(),dn=zn(),co(dn),co(en),Rh(),fn=zn(),co(dn),co(en),co(fn),Dn(),ei(),co(en),Ij(),Go()},Qb=function(){return co(tg(dn)),xa(),co(sg(dn)),xa(),co(rg(dn)),xa(),en=zn(),en===Pp(Fd)?jo(0):co(en),Kl()},Kl=function(){return No(),tf(),Go()},tf=function(){var a,b;return a=0,b=0,fn=zn(),en=zn(),dn=zn(),co(en),b=Cn(),co(fn),a=Cn(),b<0||2147483648===b||a<0||2147483648===a?(lo(md),co(dn),co(en),co(fn),void Ol(4)):(Bl(dn)?uf(b,a):(gn=dn,dn=Pp(ge),uf(b,a),dn=gn,co(Pp(ge)),co(dn),Lp(),xa()),vf(a))},uf=function(a,b){var c,d,e,f,g,h;for(d=0,jo(1),jo(0),kn=zn(),d=e=0,f=a;0<=f?e<f:e>f;d=0<=f?++e:--e)hn=kn,kn=zn(),jo(2*d+1),co(dn),um(),co(kn),um(),jo(d),co(hn),um(),Mp(),jo(d+1),ei();for(h=[],d=c=0,g=b;0<=g?c<g:c>g;d=0<=g?++c:--c)co(dn),h.push(Vh());return h},vf=function(a){if(0!==a)return ug(dn)===Pp(P)?(co(tg(dn)),wp(),Ap()):ug(dn)===Pp(me)?(co(tg(dn)),mh(),Ap()):(jo(1),co(dn),Ap(),Mp()),jo(a),ko(1,2),um(),Dn(),um(),a%2?Dm():void 0},Ol=function(a){var b,c,d,e;for(b=0,co(Pp(Fd)),e=[],b=c=0,d=a;0<=d?c<d:c>d;b=0<=d?++c:--c)e.push(gh());return e},Rb=function(){return co(tg(dn)),xa(),Pl()},Pl=function(){return No(),Rq(),Go()},Rq=function(){var a;if(a=0,dn=zn(),dn===Pp(ia))return void jo(1);if(Zi(dn,1))return void jo(0);if(jl(dn))return co(dn),Dm(),Pl(),co(vk),lo(Vd),um(),void Cf();if(Wk(dn))return a=Math.log(dn.d),void fo(a);if(_k(dn))return co(dn),Vm(),Pl(),co(dn),Sh(),Pl(),void Mp();if(ug(dn)===Pp(Xd))return co(sg(dn)),co(tg(dn)),Pl(),void um();if(ug(dn)!==Pp(Cd))return lo(nd),co(dn),Ol(2);for(jo(0),dn=Eg(dn);Tk(dn);)co(ug(dn)),Pl(),Cf(),dn=Eg(dn)},Tl=function(a,b){return a.add(b)},rm=function(a,b){return a.subtract(b)},Gf=function(a,b){return a.add(b)},Kp=function(a,b){return a.subtract(b)},iq=function(a,b){return a.compareAbs(b)},Sb=function(){return co(tg(dn)),xa(),Ul()},Ul=function(){return No(),dn=zn(),co(dn),Vm(),Sq(),co(dn),Sh(),Sq(),ei(),Go()},Sq=function(){if(No(),dn=zn(),jl(dn))co(dn),Dm();else if(ug(dn)===Pp(Xd)&&Zi(tg(dn),-1))jo(1);else if(ug(dn)===Pp(Xd)&&tg(dn)===Pp(ia))co(sg(dn)),zo(),mj();else if(ug(dn)===Pp(Cd))for(jo(1),dn=Eg(dn);Tk(dn);)co(ug(dn)),Ul(),um(),dn=Eg(dn);else ug(dn)===Pp(e)?(co(dn),Bo(),dn=zn(),co(dn),zo(),jo(2),Dn(),co(dn),uk(),jo(2),Dn(),Cf(),ko(1,2),Dn(),up()):co(dn);return Go()},bm=function(a,b){return Yf.gcd(a,b)},Hm=function(a){return No(),dn=new ef,dn.k=se,dn.str=a,co(dn),Go()},an=function(){return Hp("out of memory")},oo=function(a,b){return co(If(a*b)),Cp[cq-1].tensor.ndim=2,Cp[cq-1].tensor.dim[0]=a,Cp[cq-1].tensor.dim[1]=b},io=function(a){var b,c,d;for(oo(a,a),b=0,b=c=0,d=a;0<=d?c<d:c>d;b=0<=d?++c:--c)Cp[cq-1].tensor.elem[b*a+b]=Ym;Cp[cq-1].tensor.nelem!==Cp[cq-1].tensor.elem.length&&console.log("something wrong in tensor dimensions")},eo=function(a){var b;for(b=[];Tk(a);)co(ug(a)),b.push(a=Eg(a));return b},tn=function(){return No(),dn=zn(),co(dn),_n(dn),Go()},un=function(){return print_lisp(Cp[cq-2]),print_lisp(Cp[cq-1])},Yi=function(a,b){return 0===Tg(a,b)?1:0},Ml=function(a,b){return Tg(a,b)<0?1:0},mp=function(a){return a<0?-1:a>0?1:0},Tg=function(a,b){var c;if(c=0,a===b)return 0;if(a===Pp(Fd))return-1;if(b===Pp(Fd))return 1;if(nl(a)&&nl(b))return mp(ah(a,b));if(nl(a))return-1;if(nl(b))return 1;if(Al(a)&&Al(b))return mp(Ip(a.str,b.str));if(Al(a))return-1;if(Al(b))return 1;if(Bl(a)&&Bl(b))return mp(Ip(kk(a),kk(b)));if(Bl(a))return-1;if(Bl(b))return 1;if(Dl(a)&&Dl(b))return ch(a,b);if(Dl(a))return-1;if(Dl(b))return 1;for(;Tk(a)&&Tk(b);){if(c=Tg(ug(a),ug(b)),0!==c)return c;a=Eg(a),b=Eg(b)}return Tk(b)?-1:Tk(a)?1:0},Ll=function(a){var b;for(b=0;Tk(a);)a=Eg(a),b++;return b},jq=function(a){return No(),dn=Pp(Fd),en=Pp(Fd),kq(a),en!==Pp(Fd)&&(dn=Pp(Fd)),a=dn,Go(),a},kq=function(a){if(Al(a))return void(dn===Pp(Fd)?dn=a:a!==dn&&(en=a));for(;Tk(a);){if(kq(ug(a)),en!==Pp(Fd))return;a=Eg(a)}},Bp=function(){return ko(1,2),Dn()},Jq=function(){var a;return a=kj,kj=1,xa(),kj=a},mj=function(){return lo(ia),Op(),Dn()},Ap=function(){return jo(2),Dn()},zp=function(a){var b,c;return b=cq-a,c=Cp.slice(b,b+a),c.sort(Tg),Cp=Cp.slice(0,b).concat(c).concat(Cp.slice(b+a))},c.equal=Yi,c.length=Ll,fm=function(a,b){return a.multiply(b)},$l=function(a,b){return a.divide(b)},em=function(a,b){return a.mod(b)},_l=function(a,b){var c;return c=a.divmod(b),[c.quotient,c.remainder]},Tb=function(){return co(tg(dn)),xa(),co(sg(dn)),xa(),gm()},gm=function(){var a;return a=0,No(),en=zn(),dn=zn(),El(en)&&Hp("mod function: divide by zero"),nl(dn)&&nl(en)?(Wk(dn)&&(co(dn),a=Cn(),2147483648===a&&Hp("mod function: cannot convert float value to integer"),jo(a),dn=zn()),Wk(en)&&(co(en),a=Cn(),2147483648===a&&Hp("mod function: cannot convert float value to integer"),jo(a),en=zn()),cl(dn)&&cl(en)||Hp("mod function: integer arguments expected"),fn=new ef,fn.k=Pd,fn.q.a=em(dn.q.a,en.q.a),fn.q.b=dm(1),co(fn),Go()):(lo(yd),co(dn),co(en),Ol(3),void Go())},nm=function(a,b){return a.pow(b)},om=function(a){return a.isProbablePrime()},pm=function(a,b){var c,d,e,f,g,h,i;for(a=a.abs(),c=0,d=0,e=0,0===b&&Hp("root index is zero"),e=0;a.shiftRight(e)>0;)e++;if(0===e)return dm(0);for(e=Math.floor((e-1)/b),d=Math.floor(e/32+1),h=Yf(d),c=f=0,g=d;0<=g?f<g:f>g;c=0<=g?++f:--f)h=h.and(Yf(1).shiftLeft(c).not());for(;e>=0;){switch(h=h.or(Yf(1).shiftLeft(e)),i=nm(h,b),Yl(i,a)){case 0:return h;case 1:h=h.and(Yf(1).shiftLeft(e).not())}e--}return 0},um=function(){return bj&&Hp("escape key stop"),nl(Cp[cq-2])&&nl(Cp[cq-1])?Bm():(No(),Tq(),Go())},Tq=function(){var a,b,c,d,e,f;if(a=0,b=0,c=0,en=zn(),dn=zn(),a=cq,El(dn)||El(en))return void co(_q);if(kj&&Pk(dn))for(dn=Eg(dn),co(_q);Tk(dn);)co(ug(dn)),co(en),um(),Cf(),dn=Eg(dn);else if(kj&&Pk(en))for(en=Eg(en),co(_q);Tk(en);)co(dn),co(ug(en)),um(),Cf(),en=Eg(en);else{if(!Dl(dn)&&Dl(en))return co(dn),co(en),void Oo();if(Dl(dn)&&!Dl(en))return co(dn),co(en),void Wp();for(ug(dn)===Pp(Cd)?dn=Eg(dn):(co(dn),Ol(1),dn=zn()),ug(en)===Pp(Cd)?en=Eg(en):(co(en),Ol(1),en=zn()),nl(ug(dn))&&nl(ug(en))?(co(ug(dn)),co(ug(en)),Bm(),dn=Eg(dn),en=Eg(en)):nl(ug(dn))?(co(ug(dn)),dn=Eg(dn)):nl(ug(en))?(co(ug(en)),en=Eg(en)):co(Ym),qn(),rn();Tk(dn)&&Tk(en);)if(jg(dn)!==Pp(Sd)||jg(en)!==Pp(Sd))switch(Tg(fn,gn)){case-1:co(ug(dn)),dn=Eg(dn),qn();break;case 1:co(ug(en)),en=Eg(en),rn();break;case 0:Zg(a),dn=Eg(dn),en=Eg(en),qn(),rn();break;default:Hp("internal error 2")}else lo(Sd),co(xg(dn)),co(xg(en)),append(),gh(),dn=Eg(dn),en=Eg(en),qn(),rn();for(;Tk(dn);)co(ug(dn)),dn=Eg(dn);for(;Tk(en);)co(ug(en)),en=Eg(en);if(wf(a),kj)for(b=d=e=a,f=cq;e<=f?d<f:d>f;b=e<=f?++d:--d)if(Pk(Cp[b]))return void vm(cq-a);if(c=cq-a,1!==c)return yl(Cp[a])&&Zi(Cp[a],1)?void(2===c?(ln=zn(),zn(),co(ln)):(Cp[a]=Pp(Cd),Ol(c))):(Ol(c),ln=zn(),lo(Cd),co(ln),gh())}},qn=function(){if(fn=ug(dn),hn=Ym,ug(fn)===Pp(Xd))return hn=sg(fn),fn=tg(fn)},rn=function(){if(gn=ug(en),kn=Ym,ug(gn)===Pp(Xd))return kn=sg(gn),gn=tg(gn)},Zg=function(a){return co(gn),co(hn),co(kn),Cf(),Dn(),ln=zn(),nl(ln)?(co(Cp[a]),co(ln),Bm(),Cp[a]=zn()):ug(ln)===Pp(Cd)&&nl(tg(ln))&&Cg(ln)===Pp(Fd)?(co(Cp[a]),co(tg(ln)),Bm(),Cp[a]=zn(),co(sg(ln))):co(ln)},pk=[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,1,-6,-7,-8,-3,-4,-5,13,14,15,-16,9,10,11,-12],[0,0,6,-1,-11,10,-2,-15,14,12,-5,4,-9,16,-8,7,-13],[0,0,7,11,-1,-9,15,-2,-13,5,12,-3,-10,8,16,-6,-14],[0,0,8,-10,9,-1,-14,13,-2,-4,3,12,-11,-7,6,16,-15],[0,0,3,2,15,-14,1,11,-10,16,-8,7,13,12,-5,4,9],[0,0,4,-15,2,13,-11,1,9,8,16,-6,14,5,12,-3,10],[0,0,5,14,-13,2,10,-9,1,-7,6,16,15,-4,3,12,11],[0,0,13,12,-5,4,16,-8,7,-1,-11,10,-3,-2,-15,14,-6],[0,0,14,5,12,-3,8,16,-6,11,-1,-9,-4,15,-2,-13,-7],[0,0,15,-4,3,12,-7,6,16,-10,9,-1,-5,-14,13,-2,-8],[0,0,16,-9,-10,-11,-13,-14,-15,-3,-4,-5,1,-6,-7,-8,2],[0,0,9,-16,8,-7,-12,5,-4,-2,-15,14,6,-1,-11,10,3],[0,0,10,-8,-16,6,-5,-12,3,15,-2,-13,7,11,-1,-9,4],[0,0,11,7,-6,-16,4,-3,-12,-14,13,-2,8,-10,9,-1,5],[0,0,12,13,14,15,9,10,11,-6,-7,-8,-2,-3,-4,-5,-1]],$g=function(a){var b;if(b=pk[Math.floor(dn.gamma)][Math.floor(en.gamma)],b<0&&(b=-b,co(Cp[a]),Dm(),Cp[a]=zn()),b>1)return co(_gamma[b])},Am=function(){var a;return a=kj,kj=0,um(),kj=a},vm=function(a){var b,c,d,e;if(c=0,1!==a){if(0===a)return void co(Ym);for(b=cq-a,co(Cp[b]),c=d=1,e=a;1<=e?d<e:d>e;c=1<=e?++d:--d)co(Cp[b+c]),um();return Cp[b]=zn(),cq=b+1}},wm=function(a){var b;return b=kj,kj=0,vm(a),kj=b},ei=function(){return nl(Cp[cq-2])&&nl(Cp[cq-1])?fi():(Ik(),um())},Ik=function(){return nl(Cp[cq-1])?Jk():(jo(-1),Dn())},Ao=function(){return nl(Cp[cq-1])?Jk():(jo(-1),Dn())},Dm=function(){return nl(Cp[cq-1])?Gm():(jo(-1),um())},Em=function(){var a;return a=kj,kj=1,Dm(),kj=a},Fm=function(){var a;return a=kj,kj=0,Dm(),kj=a},wf=function(a){var b,c,d,e,f,g,h,i,j,k;if(d=0,!(ql(Cp[a])||fl(Cp[a])||Wk(Cp[a]))){for(d=e=f=a+1,g=cq;(f<=g?e<g:e>g)&&!rf(Cp[d]);d=f<=g?++e:--e);if(d!==cq){for(No(),co(Cp[a]),lm(),dn=zn(),d=b=h=a+1,i=cq;(h<=i?b<i:b>i)&&(!ql(dn)&&!fl(dn));d=h<=i?++b:--b)rf(Cp[d])&&(fn=tg(Cp[d]),gn=sg(Cp[d]),jl(gn)&&(co(dn),co(fn),ei(),hn=zn(),cl(hn)&&(dn=hn,lo(Xd),co(fn),co(Ym),co(gn),Cf(),Ol(3),Cp[d]=zn())));for(co(Cp[a]),km(),en=zn(),d=c=j=a+1,k=cq;(j<=k?c<k:c>k)&&!ql(en);d=j<=k?++c:--c)rf(Cp[d])&&(fn=tg(Cp[d]),gn=sg(Cp[d]),jl(gn)||(co(en),co(fn),ei(),hn=zn(),cl(hn)&&(en=hn,lo(Xd),co(fn),co(gn),co(Ym),Mp(),Ol(3),Cp[d]=zn())));return co(dn),co(en),ei(),Cp[a]=zn(),Go()}}},rf=function(a){return ug(a)===Pp(Xd)&&nl(tg(a))&&nl(sg(a))&&!fl(tg(a))?1:0},Md=101,Jd=1e-6,Kd=1e-9,Id=function(a){return Math.sqrt(a.r*a.r+a.i*a.i)},Zp=0,Ld=function(){return 4*Math.random()-2},Wm=function(){function a(){}return a.prototype.r=0,a.prototype.i=0,a}(),Lm=new Wm,Mm=new Wm,Sm=new Wm,Tm=new Wm,Qm=new Wm,Rm=new Wm,Pm=new Wm,Om=new Wm,Nm=[],yk=Xm=0,Co=Md;0<=Co?Xm<Co:Xm>Co;yk=0<=Co?++Xm:--Xm)Nm[yk]=new Wm;for(Xb=function(){var a,b,c,d,e,f,g,h,i,j;for(d=0,e=0,f=0,g=0,co(tg(dn)),xa(),co(sg(dn)),xa(),en=zn(),en===Pp(Fd)?qk():co(en),en=zn(),dn=zn(),rl(dn,en)||Hp("nroots: polynomial?"),d=cq,co(dn),co(en),g=Wg(),g>Md&&Hp("nroots: degree?"),e=a=0,h=g;0<=h?a<h:a>h;e=0<=h?++a:--a)co(Cp[d+e]),zo(),Lq(),xa(),dn=zn(),co(Cp[d+e]),uk(),Lq(),xa(),en=zn(),Wk(dn)&&Wk(en)||Hp("nroots: coefficients?"),Nm[e].r=dn.d,Nm[e].i=en.d;for(cq=d,hm(g),f=b=i=g;b>1;f=b+=-1)Mj(f),Math.abs(Lm.r)<Jd&&(Lm.r=0),Math.abs(Lm.i)<Jd&&(Lm.i=0),fo(Lm.r),fo(Lm.i),co(vk),um(),Cf(),Nd(f);if(g=cq-d,g>1){for(zp(g),dn=If(g),dn.tensor.ndim=1,dn.tensor.dim[0]=g,e=c=0,j=g;0<=j?c<j:c>j;e=0<=j?++c:--c)dn.tensor.elem[e]=Cp[d+e];return cq=d,co(dn)}},hm=function(a){var b,c,d,e;for(c=0,e=0,Tm.r=Nm[a-1].r,Tm.i=Nm[a-1].i,e=Tm.r*Tm.r+Tm.i*Tm.i,c=b=0,d=a-1;0<=d?b<d:b>d;c=0<=d?++b:--b)Nm[c].r=(Nm[c].r*Tm.r+Nm[c].i*Tm.i)/e,Nm[c].i=(Nm[c].i*Tm.r-Nm[c].r*Tm.i)/e;return Nm[a-1].r=1,Nm[a-1].i=0},Mj=function(a){var b,c,d,e,f,g;if(d=0,e=0,g=0,Id(Nm[0])<Jd)return Lm.r=0,void(Lm.i=0);for(d=b=0;b<100;d=++b)for(Lm.r=Ld(),Lm.i=Ld(),eh(a),Mm.r=Lm.r,Mm.i=Lm.i,Rm.r=Qm.r,Rm.i=Qm.i,Lm.r=Ld(),Lm.i=Ld(),e=c=0;c<1e3;e=++c){if(eh(a),f=Id(Qm),S&&console.log("nrabs: "+f),f<Kd)return;if(Id(Qm)<Id(Rm)&&(Sm.r=Lm.r,Sm.i=Lm.i,Lm.r=Mm.r,Lm.i=Mm.i,Mm.r=Sm.r,Mm.i=Sm.i,Sm.r=Qm.r,Sm.i=Qm.i,Qm.r=Rm.r,Qm.i=Rm.i,Rm.r=Sm.r,Rm.i=Sm.i),Pm.r=Mm.r-Lm.r,Pm.i=Mm.i-Lm.i,Om.r=Rm.r-Qm.r,Om.i=Rm.i-Qm.i,g=Om.r*Om.r+Om.i*Om.i,0===g)break;Tm.r=(Pm.r*Om.r+Pm.i*Om.i)/g,Tm.i=(Pm.i*Om.r-Pm.r*Om.i)/g,Lm.r=Mm.r-(Tm.r*Rm.r-Tm.i*Rm.i),Lm.i=Mm.i-(Tm.r*Rm.i+Tm.i*Rm.r)}return Hp("nroots: convergence error")},eh=function(a){var b,c,d,e,f;for(c=0,f=0,Sm.r=Lm.r,Sm.i=Lm.i,Qm.r=Nm[0].r+Nm[1].r*Sm.r-Nm[1].i*Sm.i,Qm.i=Nm[0].i+Nm[1].r*Sm.i+Nm[1].i*Sm.r,e=[],c=b=2,d=a;2<=d?b<d:b>d;c=2<=d?++b:--b)f=Lm.r*Sm.r-Lm.i*Sm.i,Sm.i=Lm.r*Sm.i+Lm.i*Sm.r,Sm.r=f,Qm.r+=Nm[c].r*Sm.r-Nm[c].i*Sm.i,e.push(Qm.i+=Nm[c].r*Sm.i+Nm[c].i*Sm.r);return e},Nd=function(a){var b,c,d,e,f,g;for(d=0,d=b=e=a-1;e<=0?b<0:b>0;d=e<=0?++b:--b)Nm[d-1].r+=Nm[d].r*Lm.r-Nm[d].i*Lm.i,Nm[d-1].i+=Nm[d].i*Lm.r+Nm[d].r*Lm.i;for(Id(Nm[0])>Jd&&Hp("nroots: residual error"),g=[],d=c=0,f=a-1;0<=f?c<f:c>f;d=0<=f?++c:--c)Nm[d].r=Nm[d+1].r,g.push(Nm[d].i=Nm[d+1].i);return g},Zb=function(){return co(tg(dn)),xa(),Vm()},Vm=function(){var a;if(a=0,No(),dn=zn(),ug(dn)===Pp(e)&&(co(dn),xo(),dn=zn()),ug(dn)===Pp(Cd)){for(a=cq,dn=Eg(dn);Tk(dn);)co(ug(dn)),Vm(),dn=Eg(dn);vm(cq-a)}else yl(dn)?(co(dn),lm()):co(ug(dn)===Pp(Xd)&&kl(sg(dn))?Ym:dn);return Go()},ac=function(){var a;for(dn=Eg(dn),co(ug(dn)),xa(),dn=Eg(dn),a=[];Tk(dn);)co(ug(dn)),xa(),bn(),a.push(dn=Eg(dn));return a},bn=function(){return No(),en=zn(),dn=zn(),Dl(dn)&&Dl(en)?Uq():(co(dn),co(en),Dl(dn)?Wp():Dl(en)?Oo():um()),Go()},Uq=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m;for(e=0,f=0,g=0,h=0,i=0,h=dn.tensor.ndim+en.tensor.ndim,h>qd&&Hp("outer: rank of result exceeds maximum"),i=dn.tensor.nelem*en.tensor.nelem,fn=If(i),fn.tensor.ndim=h,e=a=0,j=dn.tensor.ndim;0<=j?a<j:a>j;e=0<=j?++a:--a)fn.tensor.dim[e]=dn.tensor.dim[e];for(f=e,e=b=0,k=en.tensor.ndim;0<=k?b<k:b>k;e=0<=k?++b:--b)fn.tensor.dim[f+e]=en.tensor.dim[e];for(g=0,e=c=0,l=dn.tensor.nelem;0<=l?c<l:c>l;e=0<=l?++c:--c)for(f=d=0,m=en.tensor.nelem;0<=m?d<m:d>m;f=0<=m?++d:--d)co(dn.tensor.elem[e]),co(en.tensor.elem[f]),um(),fn.tensor.elem[g++]=zn();return co(fn)},sn=function(){for(No(),en=zn(),dn=zn(),jo(1),fn=zn(),gn=fn,dn=Eg(dn);Tk(dn);)Vc(ug(dn),en)?(co(gn),co(ug(dn)),um(),gn=zn()):(co(fn),co(ug(dn)),um(),fn=zn()),dn=Eg(dn);return co(fn),co(gn),Go()},bc=function(){return co(tg(dn)),xa(),vn()},vn=function(){return No(),dn=zn(),co(dn),Ul(),co(vk),co(dn),Rf(),um(),mj(),um(),Go()},Cm=0,Aj=function(){var a;return a=0,No(),dn=zn(),Zi(dn,0)||Zi(dn,1)||Zi(dn,-1)?(co(dn),void Go()):(Cm=dn.q.a,a=cq,xj(),cq-a>1&&(Ol(cq-a),lo(Cd),Op(),gh()),Go())},xj=function(){var a,b;for(b=0,Cm.isNegative()&&(Cm=dp(Cm,1),jo(-1)),b=a=0;a<1e4;b=++a)if(hq(b),0===Cm.compare(1))return;return zj()},hq=function(a){var b,c,d,e,f;for(b=0,c=dm(In[a]),b=0;;){if(0===Cm.compare(1))return void(b&&go(c,b));if(f=_l(Cm,c),d=f[0],e=f[1],!e.isZero())break;b++,Cm=d}if(b&&go(c,b),Yl(d,c)===-1)return go(Cm,1),Cm=dm(1)},zj=function(){var a,b,c,d,e,f,g;for(c=0,d=0,a=dm(1),f=dm(5),g=dm(2),c=1,d=1;;){if(om(Cm))return go(Cm,1),0;for(;;){if(bj&&Hp("esc"),e=rm(g,f),e=dp(e,1),b=bm(e,Cm),!td(b,1)){if(go(b,1),0===Yl(b,Cm))return-1;e=$l(Cm,b),Cm=e,e=em(f,Cm),f=e,e=em(g,Cm),g=e;break}0===--c&&(g=f,d*=2,c=d),e=fm(f,f),f=Tl(e,a),e=em(f,Cm),f=e}}},go=function(a,b){if(dn=new ef,dn.k=Pd,dn.q.a=a,dn.q.b=dm(1),co(dn),b>1)return lo(Xd),Op(),dn=new ef,dn.k=Pd,dn.q.a=dm(b),dn.q.b=dm(1),co(dn),Ol(3)},cc=function(){return co(tg(dn)),xa(),co(sg(dn)),xa(),Dn()},Dn=function(){return No(),Vq(),Go()},Vq=function(){var a;if(a=0,en=zn(),dn=zn(),yl(dn)&&yl(en))return co(dn),co(en),void so();if(nl(dn)&&nl(en))return co(dn),co(en),void li();if(Dl(dn))return void Gn();if(dn===Pp(ia)&&ug(en)===Pp(nd))return void co(tg(en));if(dn===Pp(ia)&&Wk(en))return void fo(Math.exp(en.d));if(Yi(dn,Ym)||El(en))return void co(Ym);if(Yi(en,Ym))return void co(dn);if(ug(dn)!==Pp(Cd)){if(ug(dn)===Pp(Xd))return co(tg(dn)),co(sg(dn)),co(en),um(),void Dn();if(kj&&Pk(dn)&&nl(en)&&(co(en),a=Cn(),a>1&&2147483648!==a))return void Fn(a);if(1===fq&&ug(dn)===Pp(me)&&Xk(en))return jo(1),co(tg(dn)),mh(),jo(2),Dn(),Mp(),co(en),ko(1,2),um(),void Dn();if(2===fq&&ug(dn)===Pp(P)&&Xk(en))return jo(1),co(tg(dn)),wp(),jo(2),Dn(),Mp(),co(en),ko(1,2),um(),void Dn();if(Sk(dn)){if(cl(en))return co(dn),fh(),fn=zn(),co(fn),co(fn),co(dn),um(),ei(),co(en),Dm(),void Dn();if(nl(en))return co(dn),Ul(),co(en),Dn(),jo(-1),co(dn),Rf(),co(en),um(),co(Pp(Vd)),ei(),Dn(),void um()}if(!sp())return lo(Xd),co(dn),co(en),Ol(3)}else for(dn=Eg(dn),co(ug(dn)),co(en),Dn(),dn=Eg(dn);Tk(dn);)co(ug(dn)),co(en),Dn(),um(),dn=Eg(dn)},Fn=function(a){var b,c,d,e,f,g,h,i,j,k;for(b=[],f=0,g=0,h=0,h=Ll(dn)-1,ho(h*(a+1)),dn=Eg(dn),f=c=0,i=h;0<=i?c<i:c>i;f=0<=i?++c:--c){for(g=d=0,j=a;0<=j?d<=j:d>=j;g=0<=j?++d:--d)co(ug(dn)),jo(g),Dn(),Cp[Uj+f*(a+1)+g]=zn();dn=Eg(dn)}for(jo(a),Dj(),dn=zn(),f=e=0,k=h;0<=k?e<k:e>k;f=0<=k?++e:--e)b[f]=0;return co(_q),tm(h,a,b,0,a),Bn(h*(a+1))},tm=function(a,b,c,d,e){var f,g,h,i,j,k,l;i=0;{if(!(d<a-1)){for(c[d]=e,co(dn),i=g=0,k=a;0<=k?g<k:g>k;i=0<=k?++g:--g)jo(c[i]),Dj(),ei();for(i=h=0,l=a;0<=l?h<l:h>l;i=0<=l?++h:--h)co(Cp[Uj+i*(b+1)+c[i]]),um();return Cf()}for(i=f=0,j=e;0<=j?f<=j:f>=j;i=0<=j?++f:--f)c[d]=i,tm(a,b,c,d+1,e-i)}},sp=function(){var a,b;switch(b=0,b=xl(en)){case 0:a=1;break;case 1:return jo(1),1;case 2:return jo(-1),1;case 3:return co(vk),1;case 4:return co(vk),Dm(),1}if(ug(en)===Pp(e)){for(fn=Eg(en);Tk(fn)&&!(b=xl(ug(fn)));)fn=Eg(fn);switch(b){case 0:return 0;case 1:jo(1);break;case 2:jo(-1);break;case 3:co(vk);break;case 4:co(vk),Dm()}return co(en),co(ug(fn)),Mp(),mj(),um(),1}return 0},ec=function(){return co(tg(dn)),xa(),Hn()},Hn=function(){var a;return a=0,a=Cn(),(a<1||a>rd)&&Hp("prime: Argument out of range."),a=In[a-1],jo(a)},En="^",Jp="",Un=function(a){return Jp+=a},Ln=function(a){return Jp+=a},Yg=function(a){return Jp="",On(a),Jp},_n=function(a){return Jp="",On(a),console.log(Jp)},Mn=function(a,b){return No(),dn=tg(a),en=sg(a),1!==b||fl(en)||Ln("("),_k(dn)||ug(dn)===Pp(e)||ug(dn)===Pp(Cd)||ug(dn)===Pp(Xd)||Ml(dn,_q)?(Ln("("),On(dn),Ln(")")):On(dn),fl(en)?void Go():(0===Xp?Un(En):Ln("^"),co(en),Dm(),en=zn(),_k(en)||ug(en)===Pp(e)||ug(en)===Pp(Cd)||ug(en)===Pp(Xd)?(Ln("("),On(en),Ln(")")):On(en),1===b&&Ln(")"),Go())},Kn=function(a){var b,c,d;for(Qj=0,d=0,b=0,No(),d=0,b=0,dn=Eg(a),en=ug(dn),yl(en)?(co(en),lm(),yf(),fn=zn(),co(en),km(),gn=zn(),ql(fn)||d++,ql(gn)||b++,dn=Eg(dn)):(fn=Ym,gn=Ym);Tk(dn);)en=ug(dn),Lk(en)?b++:d++,dn=Eg(dn);if(0===d)Ln("1");else for(Qj=0,dn=Eg(a),yl(ug(dn))&&(dn=Eg(dn)),ql(fn)||(Pn(fn),Qj=1);Tk(dn);)en=ug(dn),Lk(en)?c=1:(Qj&&Sn(),Pn(en),Qj=1),dn=Eg(dn);for(Un(0===Xp?" / ":"/"),b>1&&Ln("("),Qj=0,dn=Eg(a),yl(ug(dn))&&(dn=Eg(dn)),ql(gn)||(Pn(gn),Qj=1);Tk(dn);)en=ug(dn),Lk(en)&&(Qj&&Sn(),Mn(en,b),Qj=1),dn=Eg(dn);return b>1&&Ln(")"),Go()},On=function(a){var b;if(Pk(a)){for(a=Eg(a),"-"===np(ug(a))&&Un("-"),Yn(ug(a)),a=Eg(a),b=[];Tk(a);)Un("+"===np(ug(a))?0===Xp?" + ":"+":0===Xp?" - ":"-"),Yn(ug(a)),b.push(a=Eg(a));return b}return"-"===np(a)&&Un("-"),Yn(a)},np=function(a){return ug(a)===Pp(Cd)&&nl(tg(a))&&Ml(tg(a),_q)?"-":nl(a)&&Ml(a,_q)?"-":"+"},Yn=function(a){var b;if(ug(a)===Pp(Cd)&&Kf(a))return void Kn(a);if(ug(a)===Pp(Cd)){for(a=Eg(a),fl(ug(a))&&(a=Eg(a)),Pn(ug(a)),a=Eg(a),b=[];Tk(a);)Sn(),Pn(ug(a)),b.push(a=Eg(a));return b}return Pn(a)},Vn=function(a){return Ln("("),On(a),Ln(")")},Qn=function(a){return a=tg(a),ug(a)===Pp(e)||ug(a)===Pp(Cd)||ug(a)===Pp(Xd)||ug(a)===Pp(Pc)?Vn(a):On(a),Ln("!")},Wn=function(a){return Xn(a,0,0)},Xn=function(a,b,c){var d,e,f;for(e=0,Un("("),e=d=0,f=a.tensor.dim[b];0<=f?d<f:d>f;e=0<=f?++d:--d)b+1===a.tensor.ndim?(On(a.tensor.elem[c]),c++):c=Xn(a,b+1,c),e+1<a.tensor.dim[b]&&Un(0===Xp?",":",");return Un(")"),c},Pn=function(a){if(nl(a))return void Tn(a);if(Al(a))return Un('"'),Un(a.str),void Un('"');if(Dl(a))return void Wn(a);if(Pk(a)||ug(a)===Pp(Cd))return Un("("),On(a),void Un(")");if(ug(a)===Pp(Xd))return tg(a)===Pp(ia)?(Un("exp("),On(sg(a)),void Un(")")):fl(sg(a))?(Un(0===Xp?"1 / ":"1/"),void(Tk(tg(a))?(Un("("),On(tg(a)),Un(")")):On(tg(a)))):(Pk(tg(a))||ig(a)===Pp(Cd)||ig(a)===Pp(Xd)||jl(tg(a))?(Un("("),On(tg(a)),Un(")")):nl(tg(a))&&(Ml(tg(a),_q)||_k(tg(a)))?(Un("("),Pn(tg(a)),Un(")")):Pn(tg(a)),Un(0===Xp?En:"^"),void(Tk(sg(a))||_k(sg(a))||nl(sg(a))&&Ml(sg(a),_q)?(Un("("),On(sg(a)),Un(")")):Pn(sg(a))));if(ug(a)===Pp(_c)&&Bl(tg(a)))return void print_index_function(a);if(ug(a)===Pp(Pc))return void Qn(a);if(Tk(a)){if(Pn(ug(a)),a=Eg(a),Un("("),Tk(a))for(On(ug(a)),a=Eg(a);Tk(a);)Un(0===Xp?",":","),On(ug(a)),a=Eg(a);return void Un(")")}return a===Pp(X)?Ln("d"):Un(a===Pp(ia)?"exp(1)":a===Pp(Vd)?"pi":kk(a))},Jn=function(a,b){var c;switch(c=!1,null==b&&(c=!0,b=""),a.k){case N:for(b+="(",b=Jn(ug(a),b),a===Eg(a)&&console.log("oh no recursive!"),a=Eg(a);Tk(a);)b+=" ",b=Jn(ug(a),b),a=Eg(a),a===Eg(a)&&console.log("oh no recursive!");a!==Pp(Fd)&&(b+=" . ",b=Jn(a,b)),b+=")";break;case se:b+=a.str;break;case Pd:case ea:b=Tn(a,b);break;case ve:b+=kk(a);break;default:b+="<tensor>"}return c?console.log(b):b},Sn=function(){return Un(0===Xp?" ":"*")},Lk=function(a){return ug(a)===Pp(Xd)&&tg(a)!==Pp(ia)&&kl(sg(a))?1:0},Kf=function(a){var b;for(a=Eg(a);Tk(a);){if(b=ug(a),Lk(b))return 1;a=Eg(a)}return 0},gc=function(){var a,b,c,d,e,f;for(b=0,c=0,d=0,kn=tg(dn),Bl(kn)||Hp("product: 1st arg?"),co(sg(dn)),xa(),c=Cn(),2147483648===c&&Hp("product: 2nd arg?"),co(rg(dn)),xa(),d=Cn(),2147483648===d&&Hp("product: 3rd arg?"),dn=qg(dn),gn=hk(kn),fn=gk(kn),jo(1),b=a=e=c,f=d;e<=f?a<=f:a>=f;b=e<=f?++a:--a)jo(b),hn=zn(),ep(kn,hn),co(dn),xa(),um();return fp(kn,gn,fn)},po=function(){var a,b,c,d,e;return No(),en=zn(),dn=zn(),b=fm(dn.q.a,en.q.b),d=fm(dn.q.b,en.q.a),a=Tl(b,d),Dd(a)?(co(_q),void Go()):(c=fm(dn.q.b,en.q.b),e=bm(a,c),e=Wl(e,c),dn=new ef,dn.k=Pd,dn.q.a=$l(a,e),dn.q.b=$l(c,e),co(dn),Go())},qo=function(){var a,b,c;return No(),en=zn(),dn=zn(),Dd(en.q.a)&&Hp("divide by zero"),Dd(dn.q.a)?(co(_q),void Go()):(a=fm(dn.q.a,en.q.b),b=fm(dn.q.b,en.q.a),c=bm(a,b),c=Wl(c,b),dn=new ef,dn.k=Pd,dn.q.a=$l(a,c),dn.q.b=$l(b,c),co(dn),Go())},ro=function(){var a,b,c;return No(),en=zn(),dn=zn(),Dd(dn.q.a)||Dd(en.q.a)?(co(_q),void Go()):(a=fm(dn.q.a,en.q.a),b=fm(dn.q.b,en.q.b),c=bm(a,b),c=Wl(c,b),dn=new ef,dn.k=Pd,dn.q.a=$l(a,c),dn.q.b=$l(b,c),co(dn),Go())},so=function(){return No(),to(),Go()},to=function(){var a,b,c,d,e,f;return c=0,en=zn(),dn=zn(),ql(dn)||El(en)?void jo(1):El(dn)?(jl(en)&&Hp("divide by zero"),void co(_q)):ql(en)?void co(dn):cl(en)?(co(en),c=Cn(),2147483648===c?(lo(Xd),co(dn),co(en),void Ol(3)):(e=nm(dn.q.a,Math.abs(c)),f=nm(dn.q.b,Math.abs(c)),c<0&&(d=e,e=f,f=d,e=Wl(e,f),f=Vl(f)),fn=new ef,fn.k=Pd,fn.q.a=e,fn.q.b=f,void co(fn))):fl(dn)?(co(en),void Km()):jl(dn)?(co(dn),Dm(),co(en),so(),jo(-1),co(en),so(),void um()):cl(dn)?Nk(dn)?(co(dn),co(en),void uo()):en.q.a.isSmall&&en.q.b.isSmall?(a=en.q.a,b=en.q.b,e=pm(dn.q.a,b),0===e?(lo(Xd),co(dn),co(en),void Ol(3)):(f=nm(e,a),fn=new ef,fn.k=Pd,en.q.a.isNegative()?(fn.q.a=Yf(1),fn.q.b=f):(fn.q.a=f,fn.q.b=Yf(1)),co(fn))):(lo(Xd),co(dn),co(en),void Ol(3)):(co(dn),lm(),co(en),so(),co(dn),km(),co(en),Dm(),so(),void um())},Km=function(){return No(),dn=zn(),cl(dn)?(jo(dn.q.a.isOdd()?-1:1),void Go()):(co(dn),cg(),en=zn(),jl(dn)&&(co(en),jo(-1),Cf(),en=zn()),co(dn),co(en),Mp(),fn=zn(),lo(Xd),jo(-1),co(fn),Ol(3),en.q.a.isOdd()&&Dm(),Go())},Nk=function(a){return a.q.a.isSmall},uo=function(){var a,b,c,d,e,f;for(c=0,No(),en=zn(),dn=zn(),b=cq,co(dn),Bj(),d=cq-b,f=b,c=a=0,e=d;a<e;c=a+=2)co(Cp[f+c]),co(Cp[f+c+1]),co(en),um(),vo();return vm(cq-b-d),dn=zn(),cq=b,co(dn),Go()},vo=function(){var a;return a=0,No(),en=zn(),dn=zn(),co(en),cg(),fn=zn(),co(en),co(fn),Mp(),gn=zn(),El(gn)||(lo(Xd),co(dn),co(gn),Ol(3)),co(fn),a=Cn(),2147483648===a?(lo(Xd),co(dn),co(fn),Ol(3),void Go()):0===a?void Go():(co(dn),_f(a),Go())},ic=function(){return co(tg(dn)),xa(),co(sg(dn)),xa(),co(rg(dn)),xa(),dn=zn(),dn===Pp(Fd)&&(dn=Pp(Ge)),co(dn),ii()},ii=function(){var a,b,c,d,e,f,g,h,i;for(d=0,e=0,f=0,g=0,i=0,No(),fn=zn(),en=zn(),dn=zn(),d=cq,b=cq,co(dn),co(fn),f=Wg()-1,c=cq,co(en),co(fn),g=Wg()-1,i=f-g,jo(0),hn=zn();i>=0;){for(co(Cp[b+f]),co(Cp[c+g]),ei(),gn=zn(),e=a=0,h=g;0<=h?a<=h:a>=h;e=0<=h?++a:--a)co(Cp[b+i+e]),co(Cp[c+e]),co(gn),um(),Mp(),Cp[b+i+e]=zn();co(hn),co(gn),co(fn),jo(i),Dn(),um(),Cf(),hn=zn(),f--,i--}return cq=d,co(hn),Go()},S=0,kc=function(){return co(tg(dn)),xa(),xo()},xo=function(){var a;return a=kj,No(),Wq(),Go(),kj=a},Wq=function(){if(dn=zn(),Dl(dn))return void xf();if(kj=0,ug(dn)!==Pp(e))return void co(dn);for(S&&(printf("rationalize: this is the input expr:\n"),_n(dn)),co(Ym),xm(dn),en=zn(),S&&(printf("rationalize: this is the common denominator:\n"),_n(en)),co(_q),fn=Eg(dn);Tk(fn);)co(en),co(ug(fn)),um(),Cf(),fn=Eg(fn);return S&&(printf("rationalize: original expr times common denominator:\n"),_n(Cp[cq-1])),R(),S&&(printf("rationalize: after factoring:\n"),_n(Cp[cq-1])),co(en),ei(),S?(printf("rationalize: after dividing by common denom. (and we're done):\n"),_n(Cp[cq-1])):void 0},xm=function(a){var b;if(ug(a)===Pp(e)){for(a=Eg(a),b=[];Tk(a);)zm(ug(a)),b.push(a=Eg(a));return b}return zm(a)},zm=function(a){var b;if(ug(a)===Pp(Cd)){for(a=Eg(a),b=[];Tk(a);)ym(ug(a)),b.push(a=Eg(a));return b}return ym(a)},ym=function(a){if(ug(a)===Pp(Xd))return co(a),a=sg(a),jl(a)?(Ik(),void sf()):ug(a)===Pp(Cd)&&jl(tg(a))?(Ik(),void sf()):zn()},xf=function(){var a,b,c,d;if(b=0,co(dn),xa(),dn=zn(),!Dl(dn))return void co(dn);for(c=dn.tensor.nelem,b=a=0,d=c;0<=d?a<d:a>d;b=0<=d?++a:--a)co(dn.tensor.elem[b]),xo(),dn.tensor.elem[b]=zn();return dn.tensor.nelem!==dn.tensor.elem.length&&console.log("something wrong in tensor dimensions"),co(dn)},sf=function(){return No(),dn=zn(),en=zn(),co(dn),co(en),um(),co(dn),co(en),Zj(),ei(),Go()},lc=function(){return co(tg(dn)),xa(),zo()},zo=function(){return No(),Bo(),dn=zn(),co(dn),co(dn),fh(),Cf(),jo(2),ei(),Go()},mc=function(){return co(tg(dn)),xa(),Bo()},Bo=function(){if(No(),dn=zn(),ug(dn)===Pp(e))for(jo(0),dn=Eg(dn);Tk(dn);)co(ug(dn)),Bo(),Cf(),dn=Eg(dn);else co(dn),Ul(),co(dn),Rf(),dn=zn(),co(dn),mh(),co(vk),co(dn),wp(),um(),Cf(),um();return Go();
},nc=function(){return en=tg(dn),ug(en)===Pp(ie)||ug(en)===Pp(Oe)?(co(tg(en)),xa(),co(sg(en)),xa(),Mp()):(co(en),xa(),en=zn(),ug(en)===Pp(ie)||ug(en)===Pp(Oe)?(co(tg(en)),xa(),co(sg(en)),xa(),Mp()):co(en)),co(sg(dn)),xa(),en=zn(),en===Pp(Fd)?qk():co(en),en=zn(),dn=zn(),rl(dn,en)||Hp("roots: 1st argument is not a polynomial"),co(dn),co(en),Jo()},rk=function(){var a,b,c,d,e,f;for(wn=cq,co(dn),co(en),e=Wg(),d=!1,b=cq,c=a=f=e;a>0;c=a+=-1)if(Sk(Cp[cq-c])){d=!0;break}return cq-=e,d},Jo=function(){var a,b,c,d,e;if(b=0,c=0,d=0,b=cq-2,Ko(),d=cq-b,0===d&&Hp("roots: the polynomial is not factorable, try nroots"),1!==d){for(zp(d),No(),dn=If(d),dn.tensor.ndim=1,dn.tensor.dim[0]=d,c=a=0,e=d;0<=e?a<e:a>e;c=0<=e?++a:--a)dn.tensor.elem[c]=Cp[b+c];return cq=b,co(dn),Go()}},Ko=function(){if(No(),en=zn(),dn=zn(),co(dn),co(en),rk()?(zn(),zn()):(Ej(),dn=zn()),ug(dn)===Pp(Cd))for(dn=Eg(dn);Tk(dn);)co(ug(dn)),co(en),Lo(),dn=Eg(dn);else co(dn),co(en),Lo();return Go()},Lo=function(){return No(),en=zn(),dn=zn(),ug(dn)===Pp(Xd)&&rl(tg(dn),en)&&vl(sg(dn))?(co(tg(dn)),co(en),cm()):rl(dn,en)&&(co(dn),co(en),cm()),Go()},cm=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J;if(G=0,No(),en=zn(),dn=zn(),co(dn),co(en),G=Wg(),2===G)return fn=zn(),gn=zn(),co(gn),co(fn),ei(),Dm(),void Go();if(3===G)return fn=zn(),gn=zn(),hn=zn(),co(gn),co(gn),um(),jo(4),co(fn),um(),co(hn),um(),Mp(),ko(1,2),Dn(),kn=zn(),co(kn),co(gn),Mp(),co(fn),ei(),ko(1,2),um(),co(kn),co(gn),Cf(),Dm(),co(fn),ei(),ko(1,2),um(),void Go();if(4===G){if(fn=zn(),gn=zn(),hn=zn(),kn=zn(),co(hn),co(hn),um(),w=zn(),co(w),co(hn),um(),x=zn(),co(gn),co(gn),um(),t=zn(),co(t),co(gn),um(),v=zn(),co(v),co(kn),jo(-4),um(),um(),B=zn(),co(v),jo(2),um(),d=zn(),jo(3),co(fn),um(),e=zn(),co(e),jo(9),um(),co(fn),um(),co(kn),um(),c=zn(),co(c),co(kn),um(),Dm(),z=zn(),co(e),jo(2),um(),i=zn(),co(fn),co(hn),um(),s=zn(),co(s),co(gn),um(),r=zn(),co(s),jo(3),um(),g=zn(),jo(-4),co(fn),co(x),um(),um(),A=zn(),co(r),jo(9),um(),Dm(),C=zn(),co(C),co(kn),jo(-2),um(),um(),b=zn(),co(t),co(g),Mp(),n=zn(),co(t),co(w),um(),u=zn(),co(n),jo(3),Dn(),jo(4),um(),h=zn(),co(n),qp(),xa(),Lq(),xa(),yf(),o=zn(),co(b),co(B),co(u),co(A),co(z),Cf(),Cf(),Cf(),Cf(),qp(),xa(),Lq(),xa(),yf(),y=zn(),co(d),co(C),co(c),Cf(),Cf(),p=zn(),co(p),jo(2),Dn(),co(h),Mp(),ko(1,2),Dn(),q=zn(),co(gn),Dm(),co(e),ei(),D=zn(),El(y))return El(o)?(co(D),void Go()):(co(fn),co(kn),jo(9),um(),um(),co(gn),co(hn),um(),Mp(),co(n),jo(2),um(),ei(),J=zn(),co(J),co(J),co(r),jo(4),um(),co(fn),co(fn),co(kn),jo(9),um(),um(),um(),Dm(),co(v),Dm(),Cf(),Cf(),co(fn),co(n),um(),ei(),void Go());for(a=!1,E=!1;!a;)co(q),E&&Dm(),co(p),Cf(),ko(1,2),um(),ko(1,3),Dn(),k=zn(),co(k),qp(),xa(),Lq(),xa(),yf(),m=zn(),El(m)?E=!0:a=!0;return co(k),co(e),um(),f=zn(),co(f),jo(2),um(),j=zn(),co(vk),jo(3),ko(1,2),Dn(),um(),F=zn(),jo(1),co(F),Cf(),I=zn(),jo(1),co(F),Mp(),H=zn(),co(k),co(e),ei(),l=zn(),co(D),co(l),Dm(),co(n),co(f),ei(),Dm(),Cf(),Cf(),qp(),co(D),co(l),co(I),um(),jo(2),ei(),co(H),co(n),um(),co(j),ei(),Cf(),Cf(),qp(),co(D),co(l),co(H),um(),jo(2),ei(),co(I),co(n),um(),co(j),ei(),Cf(),Cf(),qp(),void Go()}return cq-=G,Go()},_e=1001,Xe=1002,df=1003,Ze=1004,bf=1006,cf=1007,$e=1008,af=1009,Ye=1010,$p="",Im=0,am=0,Ck=0,Yo=0,aq=0,_p=0,bp="",Po=function(a){return S&&console.log("#### scanning "+a),bp=a,am=0,kj++,Ck=0,Yo=0,jk(),""===$p?(co(Pp(Fd)),kj--,0):(Xo(),kj--,aq-Ck)},Uo=function(a){return bp=a,am=1,kj++,Ck=0,Yo=0,jk(),""===$p?(co(Pp(Fd)),kj--,0):(Xo(),kj--,aq-Ck)},Xo=function(){if(Wo(),"="===$p)return jk(),lo(ie),Op(),Wo(),Ol(3)},Wo=function(){switch(Ro(),$p){case Ye:return lo(Oe),Op(),jk(),Ro(),Ol(3);case af:return lo(Re),Op(),jk(),Ro(),Ol(3);case $e:return lo(Pe),Op(),jk(),Ro(),Ol(3);case"<":return lo(Se),Op(),jk(),Ro(),Ol(3);case">":return lo(Qe),Op(),jk(),Ro(),Ol(3)}},Ro=function(){var a;switch(a=cq,$p){case"+":jk(),ap();break;case"-":jk(),ap(),Dm();break;default:ap()}for(;0===Im&&("+"===$p||"-"===$p);)"+"===$p?(jk(),ap()):(jk(),ap(),Dm());if(cq-a>1)return Ol(cq-a),lo(e),Op(),gh()},Mk=function(){switch($p){case"*":case"/":return 1;case"(":case df:case Ze:case _e:case Xe:case cf:return Im?(Yo=aq,0):1}return 0},ap=function(){var a;for(a=cq,Vo(),cq>a&&yl(Cp[cq-1])&&Zi(Cp[cq-1],1)&&zn();Mk();)"*"===$p?(jk(),Vo()):"/"===$p?(jk(),Vo(),Ik()):Vo(),cq>a+1&&nl(Cp[cq-2])&&nl(Cp[cq-1])&&um(),cq>a&&yl(Cp[cq-1])&&Zi(Cp[cq-1],1)&&zn();return a===cq?jo(1):cq-a>1?(Ol(cq-a),lo(Cd),Op(),gh()):void 0},Vo=function(){if(So(),"^"===$p)return jk(),lo(Xd),Op(),Vo(),Ol(3)},So=function(){var a,b;if(a=cq,"("===$p?$o():$p===df?_o():$p===Ze?To():$p===_e?(bg(_p),jk()):$p===Xe?(ag(_p),jk()):$p===cf?Zo():Qo("syntax error"),"["===$p){for(jk(),lo(_c),Op(),Ro();","===$p;)jk(),Ro();"]"!==$p&&Qo("] expected"),jk(),Ol(cq-a)}for(b=[];"!"===$p;)jk(),lo(Pc),Op(),b.push(Ol(2));return b},_o=function(){if($p!==df&&Qo("symbol expected"),am&&1===_p.length)switch(_p[0]){case"a":co(Pp(ud));break;case"b":co(Pp(vd));break;case"x":co(Pp(wd));break;default:co(mq(_p))}else co(mq(_p));return jk()},Zo=function(){return Hm(_p),jk()},To=function(){var a,b;if(a=1,b=new ef,b=mq(_p),co(b),jk(),jk(),")"!==$p)for(Xo(),a++;","===$p;)jk(),Xo(),a++;return")"!==$p&&Qo(") expected"),jk(),Ol(a)},$o=function(){var a;if(a=0,"("!==$p&&Qo("( expected"),jk(),Xo(),","===$p){for(a=1;","===$p;)jk(),Xo(),a++;gg(a)}return")"!==$p&&Qo(") expected"),jk()},Qo=function(a){for(aj="";Ck!==Yo&&("\n"!==bp[Ck]&&"\r"!==bp[Ck]||Ck+1!==Yo);)aj+=bp[Ck++];for(aj+=" ? ";bp[Ck]&&"\n"!==bp[Ck]&&"\r"!==bp[Ck];)aj+=bp[Ck++];return aj+="\n",Hp(a)},gg=function(a){var b,c,d;for(c=0,No(),en=If(a),en.tensor.ndim=1,en.tensor.dim[0]=a,c=b=0,d=a;0<=d?b<d:b>d;c=0<=d?++b:--b)en.tensor.elem[c]=Cp[cq-a+c];return en.tensor.nelem!==en.tensor.elem.length&&console.log("something wrong in tensor dimensions"),cq-=a,co(en),Go()},jk=function(){for(Im=0;;){if(mk(),$p!==bf)break;Im=1}if(S)return console.log("get_next_token token: "+$p)},mk=function(){for(;zl(bp[Yo]);){if("\n"===bp[Yo]||"\r"===bp[Yo])return $p=bf,void Yo++;Yo++}if(aq=Yo,Yo===bp.length)return void($p="");if(Vk(bp[Yo])||"."===bp[Yo]){for(;Vk(bp[Yo]);)Yo++;if("."===bp[Yo]){for(Yo++;Vk(bp[Yo]);)Yo++;if("e"===bp[Yo]&&("+"===bp[Yo+1]||"-"===bp[Yo+1]||Vk(bp[Yo+1])))for(Yo+=2;Vk(bp[Yo]);)Yo++;$p=Xe}else $p=_e;return void lq(aq,Yo)}if(Rk(bp[Yo])){for(;Qk(bp[Yo]);)Yo++;return $p="("===bp[Yo]?Ze:df,void lq(aq,Yo)}if('"'===bp[Yo]){for(Yo++;'"'!==bp[Yo];)Yo!==bp.length&&"\n"!==bp[Yo]&&"\r"!==bp[Yo]||Qo("runaway string"),Yo++;return Yo++,$p=cf,void lq(aq+1,Yo-1)}if("#"===bp[Yo]||"-"===bp[Yo]&&"-"===bp[Yo+1]){for(;bp[Yo]&&"\n"!==bp[Yo]&&"\r"!==bp[Yo];)Yo++;return bp[Yo]&&Yo++,void($p=bf)}return"="===bp[Yo]&&"="===bp[Yo+1]?(Yo+=2,void($p=Ye)):"<"===bp[Yo]&&"="===bp[Yo+1]?(Yo+=2,void($p=af)):">"===bp[Yo]&&"="===bp[Yo+1]?(Yo+=2,void($p=$e)):$p=bp[Yo++]},lq=function(a,b){return _p=bp.substring(a,b)},c.scan=Po,pc=function(){return co(tg(dn)),xa(),kp()},kp=function(){return No(),Xq(),Go()},Xq=function(){return dn=zn(),Wk(dn)?dn.d>0?void jo(1):0===dn.d?void jo(1):void jo(-1):yl(dn)?Bd(fm(dn.q.a,dn.q.b))===-1?void jo(-1):Dd(fm(dn.q.a,dn.q.b))?void jo(0):void jo(1):Sk(dn)?(jo(-1),co(dn),yf(),Dn(),co(dn),void um()):kl(dn)?(lo(je),co(dn),Dm(),Ol(2),jo(-1),void um()):(lo(je),co(dn),Ol(2))},qc=function(){return co(tg(dn)),xa(),lp()},lp=function(){var a,b,c,d,e,f,g,h,i;for(e=0,f=0,i=0,c=[],d=[],e=a=0,g=qd;0<=g?a<g:a>g;e=0<=g?++a:--a)c[e]=0,d[e]=0;if(No(),dn=zn(),!Dl(dn))return El(dn)||Hp("transpose: tensor expected, 1st arg is not a tensor"),co(_q),void Go();for(f=dn.tensor.ndim,en=If(f),en.tensor.ndim=1,en.tensor.dim[0]=f,e=b=0,h=f;0<=h?b<h:b>h;e=0<=h?++b:--b)jo(dn.tensor.dim[e]),en.tensor.elem[e]=zn();return co(en),Go()},rc=function(){return co(tg(dn)),xa(),op()},op=function(){var a;if(a=0,No(),dn=zn(),ug(dn)===Pp(e)){for(a=cq,dn=Eg(dn);dn!==Pp(Fd);)co(ug(dn)),pp(),dn=Eg(dn);Df(cq-a)}else co(dn),pp();return Go()},pp=function(){var a,b;if(b=0,No(),dn=zn(),ug(dn)!==Pp(Cd))return co(dn),void Go();for(b=cq,dn=Eg(dn);dn!==Pp(Fd);)co(ug(dn)),dn=Eg(dn);for(;Yq(b);)a=1;return wm(cq-b),Go()},Yq=function(a){var b,c,d,e,f,g,h,i;for(d=0,e=0,d=b=f=a,g=cq;f<=g?b<g:b>g;d=f<=g?++b:--b)for(dn=Cp[d],e=c=h=a,i=cq;h<=i?c<i:c>i;e=h<=i?++c:--c)if(d!==e){if(en=Cp[e],ug(dn)===Pp(Pc)&&ug(en)===Pp(Xd)&&fl(sg(en))&&Yi(tg(dn),tg(en)))return co(tg(dn)),co(Ym),Mp(),Dj(),Cp[d]=zn(),Cp[e]=Ym,1;if(ug(en)===Pp(Xd)&&fl(sg(en))&&ig(en)===Pp(Pc)&&Yi(dn,lg(en)))return co(dn),jo(-1),Cf(),Dj(),Ao(),Cp[d]=zn(),Cp[e]=Ym,1;if(ug(en)===Pp(Pc)&&(co(dn),co(tg(en)),Mp(),fn=zn(),ql(fn)))return co(dn),Dj(),Cp[d]=zn(),Cp[e]=Ym,1;if(ug(dn)===Pp(Xd)&&fl(sg(dn))&&ug(en)===Pp(Xd)&&fl(sg(en))&&ig(en)===Pp(Pc)&&(co(tg(dn)),co(tg(tg(en))),Mp(),fn=zn(),ql(fn)))return co(tg(dn)),Dj(),Ao(),Cp[d]=zn(),Cp[e]=Ym,1;if(ug(dn)===Pp(Pc)&&ug(en)===Pp(Xd)&&fl(sg(en))&&ig(en)===Pp(Pc)){if(co(tg(dn)),co(tg(tg(en))),Mp(),fn=zn(),ql(fn))return Cp[d]=tg(dn),Cp[e]=Ym,1;if(fl(fn))return co(tg(tg(en))),Ao(),Cp[d]=zn(),Cp[e]=Ym,1;if(Zi(fn,2))return Cp[d]=tg(dn),co(tg(dn)),jo(-1),Cf(),Cp[e]=zn(),1;if(Zi(fn,-2))return co(tg(tg(en))),Ao(),Cp[d]=zn(),co(tg(tg(en))),jo(-1),Cf(),Ao(),Cp[e]=zn(),1}}return 0},sc=function(){return co(tg(dn)),xa(),qp()},qp=function(){return No(),rp(),Go()},rp=function(){return dn=zn(),Dl(dn)?void tp():(Vc(dn,Pp(Pc))&&(co(dn),op(),en=zn(),co(dn),xo(),op(),fn=zn(),dn=ph(en)<ph(fn)?en:fn),pj(),qj(),rj(),sj(),tj(),uj(),co(dn))},tp=function(){var a,b,c,d,e;for(c=0,en=If(dn.tensor.nelem),en.tensor.ndim=dn.tensor.ndim,c=a=0,d=dn.tensor.ndim;0<=d?a<d:a>d;c=0<=d?++a:--a)en.tensor.dim[c]=dn.tensor.dim[c];for(c=b=0,e=dn.tensor.nelem;0<=e?b<e:b>e;c=0<=e?++b:--b)co(dn.tensor.elem[c]),qp(),en.tensor.elem[c]=zn();return en.tensor.nelem!==en.tensor.elem.length&&console.log("something wrong in tensor dimensions"),El(en)&&(en=_q),co(en)},ph=function(a){var b;if(Tk(a))for(b=0;Tk(a);)b+=ph(ug(a))+1,a=Eg(a);else b=1;return b},pj=function(){if(ug(dn)===Pp(e))return co(dn),xo(),en=zn(),ph(en)<ph(dn)?dn=en:void 0},qj=function(){if(ug(dn)===Pp(e))return co(dn),R(),en=zn(),ph(en)<=ph(dn)?dn=en:void 0},rj=function(){if(co(dn),xo(),Dm(),xo(),Dm(),xo(),en=zn(),ph(en)<ph(dn))return dn=en},sj=function(){if(!El(dn))return co(dn),xo(),Ik(),xo(),Ik(),xo(),en=zn(),ph(en)<ph(dn)?dn=en:void 0},up=function(){return No(),dn=zn(),tj(),co(dn),Go()},tj=function(){if(0!==Vc(dn,Pp(me))||0!==Vc(dn,Pp(P)))return en=dn,fq=1,co(en),xa(),fn=zn(),fq=2,co(en),xa(),gn=zn(),fq=0,(ph(gn)<ph(fn)||Um(gn)<Um(fn))&&(fn=gn),ph(fn)<ph(dn)||Um(fn)<Um(dn)?dn=fn:void 0},uj=function(){if(ug(dn)===Pp(e)){for(jo(0),en=Eg(dn);Tk(en);)co(ug(en)),qp(),Cf(),en=Eg(en);return en=zn(),ph(en)<ph(dn)?dn=en:void 0}},Um=function(a){return ug(a)!==Pp(e)?1:Ll(a)-1},tc=function(){return co(tg(dn)),xa(),wp()},wp=function(){return No(),dn=zn(),ug(dn)===Pp(e)?yp():xp(),Go()},yp=function(){for(en=Eg(dn);Tk(en);){if(gn=ug(en),ml(gn))return co(dn),co(gn),Mp(),fn=zn(),co(fn),wp(),co(gn),mh(),um(),co(fn),mh(),co(gn),wp(),um(),void Cf();en=Eg(en)}return xp()},xp=function(){var a,b;if(ug(dn)===Pp(j))return void co(tg(dn));if(Wk(dn))return a=Math.sin(dn.d),Math.abs(a)<1e-10&&(a=0),void fo(a);if(il(dn))return co(dn),Dm(),wp(),void Dm();if(ug(dn)===Pp(l))return co(tg(dn)),jo(1),co(tg(dn)),jo(2),Dn(),Cf(),ko(-1,2),Dn(),void um();if(co(dn),jo(180),um(),lo(Vd),ei(),b=Cn(),b<0||2147483648===b)return co(Pp(me)),co(dn),void Ol(2);switch(b%360){case 0:case 180:return jo(0);case 30:case 150:return ko(1,2);case 210:case 330:return ko(-1,2);case 45:case 135:return ko(1,2),jo(2),ko(1,2),Dn(),um();case 225:case 315:return ko(-1,2),jo(2),ko(1,2),Dn(),um();case 60:case 120:return ko(1,2),jo(3),ko(1,2),Dn(),um();case 240:case 300:return ko(-1,2),jo(3),ko(1,2),Dn(),um();case 90:return jo(1);case 270:return jo(-1);default:return co(Pp(me)),co(dn),Ol(2)}},uc=function(){return co(tg(dn)),xa(),wq()},wq=function(){return No(),Zq(),Go()},Zq=function(){var a;return a=0,dn=zn(),ug(dn)===Pp(k)?void co(tg(dn)):Wk(dn)?(a=Math.sinh(dn.d),Math.abs(a)<1e-10&&(a=0),void fo(a)):El(dn)?void co(_q):(lo(ne),co(dn),Ol(2))},Lp=function(){var a,b,c,d,e;if(c=0,No(),fn=zn(),en=zn(),en===Pp(Fd)||fn===Pp(Fd))return void Go();if(dn=zn(),Dl(dn)){for(gn=If(dn.tensor.nelem),gn.tensor.ndim=dn.tensor.ndim,c=a=0,d=dn.tensor.ndim;0<=d?a<d:a>d;c=0<=d?++a:--a)gn.tensor.dim[c]=dn.tensor.dim[c];for(c=b=0,e=dn.tensor.nelem;0<=e?b<e:b>e;c=0<=e?++b:--b)co(dn.tensor.elem[c]),co(en),co(fn),Lp(),gn.tensor.elem[c]=zn(),gn.tensor.nelem!==gn.tensor.elem.length&&console.log("something wrong in tensor dimensions");co(gn)}else Yi(dn,en)?co(fn):Tk(dn)?(co(ug(dn)),co(en),co(fn),Lp(),co(Eg(dn)),co(en),co(fn),Lp(),gh()):co(dn);return Go()},zc=function(){return co(tg(dn)),xa(),Sp()},Sp=function(){return No(),$q(),Go()},$q=function(){var a,b;if(b=0,a=0,dn=zn(),ug(dn)===Pp(l))return void co(tg(dn));if(Wk(dn))return a=Math.tan(dn.d),Math.abs(a)<1e-10&&(a=0),void fo(a);if(il(dn))return co(dn),Dm(),Sp(),void Dm();if(co(dn),jo(180),um(),lo(Vd),ei(),b=Cn(),b<0||2147483648===b)return co(Pp(Je)),co(dn),void Ol(2);switch(b%360){case 0:case 180:return jo(0);case 30:case 210:return ko(1,3),jo(3),ko(1,2),Dn(),um();case 150:case 330:return ko(-1,3),jo(3),ko(1,2),Dn(),um();case 45:case 225:return jo(1);case 135:case 315:return jo(-1);case 60:case 240:return jo(3),ko(1,2),Dn();case 120:case 300:return jo(3),ko(1,2),Dn(),Dm();default:return co(Pp(Je)),co(dn),Ol(2)}},Ac=function(){var a;return a=0,co(tg(dn)),xa(),dn=zn(),ug(dn)===Pp(m)?void co(tg(dn)):Wk(dn)?(a=Math.tanh(dn.d),Math.abs(a)<1e-10&&(a=0),void fo(a)):El(dn)?void co(_q):(lo(Ke),co(dn),Ol(2))},Bc=function(){return dn=Eg(dn),co(ug(dn)),xa(),dn=Eg(dn),co(ug(dn)),xa(),en=zn(),en===Pp(Fd)?qk():co(en),dn=Eg(dn),co(ug(dn)),xa(),en=zn(),en===Pp(Fd)?jo(24):co(en),dn=Eg(dn),co(ug(dn)),xa(),en=zn(),en===Pp(Fd)?jo(0):co(en),Tp()},Tp=function(){var a,b,c,d;if(b=0,c=0,No(),gn=zn(),fn=zn(),en=zn(),dn=zn(),co(fn),c=Cn(),2147483648===c)return lo(Le),co(dn),co(en),co(fn),co(gn),Ol(5),void Go();for(co(dn),co(en),co(gn),Lp(),xa(),jo(1),hn=zn(),b=a=1,d=c;(1<=d?a<=d:a>=d)&&(co(dn),co(en),Vh(),dn=zn(),!El(dn));b=1<=d?++a:--a)co(hn),co(en),co(gn),Mp(),um(),hn=zn(),co(dn),co(en),co(gn),Lp(),xa(),co(hn),um(),jo(b),Dj(),ei(),Cf();return Go()},Cc=function(){var a,b,c,d,e,f,g,h,i;for(e=0,f=0,g=0,dn.tensor.nelem!==dn.tensor.elem.length&&console.log("something wrong in tensor dimensions"),g=dn.tensor.nelem,f=dn.tensor.ndim,en=If(g),en.tensor.ndim=f,e=b=0,h=f;0<=h?b<h:b>h;e=0<=h?++b:--b)en.tensor.dim[e]=dn.tensor.dim[e];for(a=dn.tensor.elem,d=en.tensor.elem,en.tensor.nelem!==en.tensor.elem.length&&console.log("something wrong in tensor dimensions"),e=c=0,i=g;0<=i?c<i:c>i;e=0<=i?++c:--c)co(a[e]),xa(),d[e]=zn();return dn.tensor.nelem!==dn.tensor.elem.length&&console.log("something wrong in tensor dimensions"),en.tensor.nelem!==en.tensor.elem.length&&console.log("something wrong in tensor dimensions"),co(en),bo()},Vp=function(){var a,b,c,d,e,f,g,h,i,j,k,l;if(g=0,h=0,i=0,No(),en=zn(),dn=zn(),h=dn.tensor.ndim,h!==en.tensor.ndim)return co(Pp(Fd)),void Go();for(g=b=0,j=h;0<=j?b<j:b>j;g=0<=j?++b:--b)if(dn.tensor.dim[g]!==en.tensor.dim[g])return co(Pp(Fd)),void Go();for(i=dn.tensor.nelem,fn=If(i),fn.tensor.ndim=h,g=c=0,k=h;0<=k?c<k:c>k;g=0<=k?++c:--c)fn.tensor.dim[g]=dn.tensor.dim[g];for(a=dn.tensor.elem,e=en.tensor.elem,f=fn.tensor.elem,g=d=0,l=i;0<=l?d<l:d>l;g=0<=l?++d:--d)co(a[g]),co(e[g]),Cf(),f[g]=zn();return co(fn),Go()},Wp=function(){var a,b,c,d,e,f,g,h,i;for(e=0,f=0,g=0,No(),en=zn(),dn=zn(),f=dn.tensor.ndim,g=dn.tensor.nelem,fn=If(g),fn.tensor.ndim=f,e=b=0,h=f;0<=h?b<h:b>h;e=0<=h?++b:--b)fn.tensor.dim[e]=dn.tensor.dim[e];for(a=dn.tensor.elem,d=fn.tensor.elem,e=c=0,i=g;0<=i?c<i:c>i;e=0<=i?++c:--c)co(a[e]),co(en),um(),d[e]=zn();return co(fn),Go()},Oo=function(){var a,b,c,d,e,f,g,h,i;for(e=0,f=0,g=0,No(),en=zn(),dn=zn(),f=en.tensor.ndim,g=en.tensor.nelem,fn=If(g),fn.tensor.ndim=f,e=b=0,h=f;0<=h?b<h:b>h;e=0<=h?++b:--b)fn.tensor.dim[e]=en.tensor.dim[e];for(a=en.tensor.elem,d=fn.tensor.elem,e=c=0,i=g;0<=i?c<i:c>i;e=0<=i?++c:--c)co(dn),co(a[e]),um(),d[e]=zn();return co(fn),Go()},Ok=function(a){return Dl(a)&&2===a.tensor.ndim&&a.tensor.dim[0]===a.tensor.dim[1]?1:0},wh=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m;if(g=0,h=0,i=0,j=0,i=dn.tensor.ndim,j=dn.tensor.nelem,i+1>=qd)return lo(X),co(dn),co(en),void Ol(3);for(fn=If(j*en.tensor.nelem),fn.tensor.ndim=i+1,g=b=0,k=i;0<=k?b<k:b>k;g=0<=k?++b:--b)fn.tensor.dim[g]=dn.tensor.dim[g];for(fn.tensor.dim[i]=en.tensor.dim[0],a=dn.tensor.elem,e=en.tensor.elem,f=fn.tensor.elem,g=c=0,l=j;0<=l?c<l:c>l;g=0<=l?++c:--c)for(h=d=0,m=en.tensor.nelem;0<=m?d<m:d>m;h=0<=m?++d:--d)co(a[g]),co(e[h]),Vh(),f[g*en.tensor.nelem+h]=zn();return co(fn)},uh=function(){var a,b,c,d,e;for(fn=If(en.tensor.nelem),fn.tensor.ndim=1,fn.tensor.dim[0]=en.tensor.dim[0],a=en.tensor.elem,c=fn.tensor.elem,d=b=0,e=en.tensor.nelem;0<=e?b<e:b>e;d=0<=e?++b:--b)co(dn),co(a[d]),Vh(),c[d]=zn();return co(fn)},vh=function(){var a,b,c,d,e,f,g;for(e=0,fn=If(dn.tensor.nelem),fn.tensor.ndim=dn.tensor.ndim,e=b=0,f=dn.tensor.ndim;0<=f?b<f:b>f;e=0<=f?++b:--b)fn.tensor.dim[e]=dn.tensor.dim[e];for(a=dn.tensor.elem,d=fn.tensor.elem,e=c=0,g=dn.tensor.nelem;0<=g?c<g:c>g;e=0<=g?++c:--c)co(a[e]),co(en),Vh(),d[e]=zn();return co(fn)},ch=function(a,b){var c,d,e,f,g;if(e=0,a.tensor.ndim<b.tensor.ndim)return-1;if(a.tensor.ndim>b.tensor.ndim)return 1;for(e=c=0,f=a.tensor.ndim;0<=f?c<f:c>f;e=0<=f?++c:--c){if(a.tensor.dim[e]<b.tensor.dim[e])return-1;if(a.tensor.dim[e]>b.tensor.dim[e])return 1}for(e=d=0,g=a.tensor.nelem;0<=g?d<g:d>g;e=0<=g?++d:--d)if(!Yi(a.tensor.elem[e],b.tensor.elem[e]))return Ml(a.tensor.elem[e],b.tensor.elem[e])?-1:1;return 0},Gn=function(){var a,b,c,d,e,f,g,h;if(c=0,d=0,e=0,d=dn.tensor.ndim-1,dn.tensor.dim[0]!==dn.tensor.dim[d])return lo(Xd),co(dn),co(en),void Ol(3);if(co(en),e=Cn(),2147483648===e)return lo(Xd),co(dn),co(en),void Ol(3);if(0===e){for(2!==dn.tensor.ndim&&Hp("power(tensor,0) with tensor rank not equal to 2"),e=dn.tensor.dim[0],dn=If(e*e),dn.tensor.ndim=2,dn.tensor.dim[0]=e,dn.tensor.dim[1]=e,c=a=0,f=e;0<=f?a<f:a>f;c=0<=f?++a:--a)dn.tensor.elem[e*c+c]=Ym;return dn.tensor.nelem!==dn.tensor.elem.length&&console.log("something wrong in tensor dimensions"),void co(dn)}for(e<0&&(e=-e,co(dn),Hk(),dn=zn()),co(dn),h=[],c=b=1,g=e;(1<=g?b<g:b>g)&&(co(dn),Ak(),!El(Cp[cq-1]));c=1<=g?++b:--b)h.push(void 0);return h},lh=function(){var a,b,c,d,e;for(c=0,No(),dn=zn(),en=If(dn.tensor.nelem),en.tensor.ndim=dn.tensor.ndim,c=a=0,d=dn.tensor.ndim;0<=d?a<d:a>d;c=0<=d?++a:--a)en.tensor.dim[c]=dn.tensor.dim[c];for(c=b=0,e=dn.tensor.nelem;0<=e?b<e:b>e;c=0<=e?++b:--b)en.tensor.elem[c]=dn.tensor.elem[c];return dn.tensor.nelem!==dn.tensor.elem.length&&console.log("something wrong in tensor dimensions"),en.tensor.nelem!==en.tensor.elem.length&&console.log("something wrong in tensor dimensions"),co(en),Go()},bo=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o;if(f=0,g=0,h=0,j=0,i=0,No(),dn=zn(),!Dl(dn))return co(dn),void Go();for(en=dn.tensor.elem[0],f=a=1,k=dn.tensor.nelem;1<=k?a<k:a>k;f=1<=k?++a:--a)dh(en,dn.tensor.elem[f])||Hp("Cannot promote tensor due to inconsistent tensor components.");if(!Dl(en))return co(dn),void Go();for(i=dn.tensor.ndim+en.tensor.ndim,i>qd&&Hp("tensor rank > 24"),j=dn.tensor.nelem*en.tensor.nelem,fn=If(j),fn.tensor.ndim=i,f=b=0,l=dn.tensor.ndim;0<=l?b<l:b>l;f=0<=l?++b:--b)fn.tensor.dim[f]=dn.tensor.dim[f];for(g=c=0,m=en.tensor.ndim;0<=m?c<m:c>m;g=0<=m?++c:--c)fn.tensor.dim[f+g]=en.tensor.dim[g];for(h=0,f=d=0,n=dn.tensor.nelem;0<=n?d<n:d>n;f=0<=n?++d:--d)for(en=dn.tensor.elem[f],g=e=0,o=en.tensor.nelem;0<=o?e<o:e>o;g=0<=o?++e:--e)fn.tensor.elem[h++]=en.tensor.elem[g];return en.tensor.nelem!==en.tensor.elem.length&&console.log("something wrong in tensor dimensions"),fn.tensor.nelem!==fn.tensor.elem.length&&console.log("something wrong in tensor dimensions"),co(fn),Go()},dh=function(a,b){var c,d,e;if(!Dl(a)&&!Dl(b))return 1;if(!Dl(a)||!Dl(b))return 0;if(a.tensor.ndim!==b.tensor.ndim)return 0;for(d=c=0,e=a.tensor.ndim;0<=e?c<e:c>e;d=0<=e?++c:--c)if(a.tensor.dim[d]!==b.tensor.dim[d])return 0;return 1},Dc=function(){for(dn=Eg(dn);Tk(dn);){if(Eg(dn)===Pp(Fd))return co(ug(dn)),void xa();if(co(ug(dn)),dc(),en=zn(),!El(en))return co(tg(dn)),void xa();dn=Dg(dn)}return jo(0)},Ec=function(){return co(tg(dn)),xa(),co(sg(dn)),xa(),Mp(),dn=zn(),jo(El(dn)?1:0)},Fc=function(){return jo(Sg()>=0?1:0)},Gc=function(){return jo(Sg()>0?1:0)},Hc=function(){return jo(Sg()<=0?1:0)},Ic=function(){return jo(Sg()<0?1:0)},Wb=function(){return co(tg(dn)),dc(),dn=zn(),jo(El(dn)?1:0)},Ca=function(){for(dn=Eg(dn);Tk(dn);){if(co(ug(dn)),dc(),en=zn(),El(en))return void jo(0);dn=Eg(dn)}return jo(1)},_b=function(){for(dn=Eg(dn);Tk(dn);){if(co(ug(dn)),dc(),en=zn(),!El(en))return void jo(1);dn=Eg(dn)}return jo(0)},Sg=function(){var a;if(a=0,co(tg(dn)),xa(),co(sg(dn)),xa(),Mp(),dn=zn(),dn.k!==Pd&&dn.k!==ea&&(co(dn),Lq(),xa(),dn=zn()),El(dn))return 0;switch(dn.k){case Pd:a=Bd(dn.q.a)===-1?-1:1;break;case ea:a=dn.d<0?-1:1;break;default:Hp("relational operator: cannot determine due to non-numerical comparison"),a=0}return a},dq=function(a){var b,c,d,e;for(d=0,No(),gn=zn(),fn=zn(),co(hk(Pp(ud))),co(hk(Pp(vd))),co(hk(Pp(wd))),ep(Pp(wd),gn),d=cq,jo(1),co(fn),co(gn),xn(),co(gn),Lh(),b=0,e=a.length;b<e&&(c=a[b],S&&console.log("scanning table entry "+c),!c||(Uo(c),dn=zn(),hn=tg(dn),kn=sg(dn),ln=Cg(dn),!vj(d)));b++);return cq=d,c?(co(kn),xa(),dn=zn()):dn=Pp(Fd),ep(Pp(wd),zn()),ep(Pp(vd),zn()),ep(Pp(ud),zn()),co(dn),Go()},vj=function(a){var b,c,d,e,f,g,h,i;for(d=0,e=0,d=b=f=a,g=cq;f<=g?b<g:b>g;d=f<=g?++b:--b)for(ep(Pp(ud),Cp[d]),e=c=h=a,i=cq;h<=i?c<i:c>i;e=h<=i?++c:--c){for(ep(Pp(vd),Cp[e]),dn=ln;Tk(dn)&&(co(ug(dn)),xa(),en=zn(),!El(en));)dn=Eg(dn);if(!Tk(dn)&&(co(fn),co(hn),xa(),Mp(),dn=zn(),El(dn)))return 1}return 0},Jc=function(){return co(tg(dn)),xa(),Dg(dn)===Pp(Fd)?(jo(1),jo(2)):(co(sg(dn)),xa(),co(rg(dn)),xa()),eq()},eq=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x;for(k=0,l=0,m=0,n=0,o=0,p=0,q=0,x=0,h=[],i=[],k=b=0,r=qd;0<=r?b<r:b>r;k=0<=r?++b:--b)h[k]=0,i[k]=0;if(No(),fn=zn(),en=zn(),dn=zn(),!Dl(dn))return El(dn)||Hp("transpose: tensor expected, 1st arg is not a tensor"),co(_q),void Go();if(p=dn.tensor.ndim,q=dn.tensor.nelem,1===p)return co(dn),void Go();for(co(en),n=Cn(),co(fn),o=Cn(),(n<1||n>p||o<1||o>p)&&Hp("transpose: index out of range"),n--,o--,en=If(q),en.tensor.ndim=p,k=c=0,s=p;0<=s?c<s:c>s;k=0<=s?++c:--c)en.tensor.dim[k]=dn.tensor.dim[k];for(en.tensor.dim[n]=dn.tensor.dim[o],en.tensor.dim[o]=dn.tensor.dim[n],a=dn.tensor.elem,j=en.tensor.elem,k=d=0,t=p;0<=t?d<t:d>t;k=0<=t?++d:--d)h[k]=0,i[k]=dn.tensor.dim[k];for(k=e=0,u=q;0<=u?e<u:e>u;k=0<=u?++e:--e){for(x=h[n],h[n]=h[o],h[o]=x,x=i[n],i[n]=i[o],i[o]=x,m=0,l=f=0,v=p;0<=v?f<v:f>v;l=0<=v?++f:--f)m=m*i[l]+h[l];for(x=h[n],h[n]=h[o],h[o]=x,x=i[n],i[n]=i[o],i[o]=x,j[m]=a[k],l=g=w=p-1;(w<=0?g<=0:g>=0)&&!(++h[l]<i[l]);l=w<=0?++g:--g)h[l]=0}return co(en),Go()},Lc=function(){var a;if(ug(dn)===Pp(ze)&&gk(Pp(ze))===Pp(Fd))return void eb();if(fn=hk(ug(dn)),gn=gk(ug(dn)),hn=Eg(dn),fn===ug(dn)){for(a=cq,co(fn),dn=hn;Tk(dn);)co(ug(dn)),xa(),dn=Eg(dn);return void Ol(cq-a)}for(dn=gn,en=hn,a=cq;Tk(dn)&&Tk(en);)co(ug(dn)),co(ug(en)),xa(),dn=Eg(dn),en=Eg(en);return Ol(cq-a),kn=zn(),co(fn),Tk(kn)&&(co(kn),Ho()),xa()},Ho=function(){var a,b;if(b=0,No(),en=zn(),dn=zn(),Dl(dn))return b=Io(),Go(),b;if(Tk(dn)){for(a=cq,co(ug(dn)),dn=Eg(dn);Tk(dn);)co(ug(dn)),co(en),b+=Ho(),dn=Eg(dn);return Ol(cq-a),Go(),b}if(!Bl(dn))return co(dn),Go(),0;for(fn=en;Tk(fn);){if(dn===ug(fn))return co(tg(fn)),Go(),1;fn=Dg(fn)}return fn=hk(dn),co(fn),dn!==fn&&(co(en),b=Ho(),0===b&&(zn(),co(dn))),Go(),b},Io=function(){var a,b,c,d;for(c=0,b=0,co(dn),lh(),dn=zn(),b=a=0,d=dn.tensor.nelem;0<=d?a<d:a>d;b=0<=d?++a:--a)co(dn.tensor.elem[b]),co(en),c+=Ho(),dn.tensor.elem[b]=zn();return dn.tensor.nelem!==dn.tensor.elem.length&&console.log("something wrong in tensor dimensions"),co(dn),c},Mc=function(){var a,b,c,d,e,f,g,h;for(c=0,d=[],e=0,f=0,c=a=0,g=qd;0<=g?a<g:a>g;c=0<=g?++a:--a)d[c]=0;for(e=1,f=0,en=Eg(dn);Tk(en);){if(co(ug(en)),xa(),c=Cn(),c<2)return void co(_q);e*=c,d[f++]=c,en=Eg(en)}if(0===f)return void co(_q);for(dn=If(e),dn.tensor.ndim=f,c=b=0,h=f;0<=h?b<h:b>h;c=0<=h?++b:--b)dn.tensor.dim[c]=d[c];return co(dn)},Jf=0,If=function(a){var b,c,d,e;for(c=0,d=new ef,d.k=Me,d.tensor=new Up,d.tensor.nelem=a,c=b=0,e=a;0<=e?b<e:b>e;c=0<=e?++b:--b)d.tensor.elem[c]=_q;return d.tensor.allocatedId=Jf,Jf++,d.tensor.nelem!==d.tensor.elem.length&&console.log("something wrong in tensor dimensions"),d},hf=1e4,ok=function(){function a(){}return a.prototype.c=0,a.prototype.x=0,a.prototype.y=0,a}(),Hg=[],Gg=Af=0,Do=hf;0<=Do?Af<Do:Af>Do;Gg=0<=Do?++Af:--Af)Hg[Gg]=new ok;for(vq=0,Nl=0,Xi=0,nj=0,ci=0,$n=function(a,b){var c;return null==b&&(c=!0,b=""),b+=a},Zn=function(a,b){return $n(a,b)},bi=function(a){var b,c,d,e;return b=0,d=0,e=0,No(),vq=0,Nl=0,Xi=0,Vi(a),c=lk(0,vq),b=c[0],d=c[1],e=c[2],d>100?(_n(a),void Go()):(Rn(),Go())},Vi=function(a){return ug(a)===Pp(ie)?(Di(tg(a)),nf(" = "),void Di(sg(a))):Dl(a)?Si(a):Di(a)},oq=function(a){if(Nl>0)return 0;if(_k(a))return 1;if(ug(a)!==Pp(Cd))return 0;if(_k(tg(a)))return 1;for(;Tk(a);){if(Uk(ug(a)))return 1;a=Eg(a)}return 0},Di=function(a){if(nj++,ug(a)===Pp(e))for(a=Eg(a),qf(ug(a))&&(mf("-"),oq(ug(a))&&mf(" ")),Ui(ug(a)),a=Eg(a);Tk(a);)qf(ug(a))?(mf(" "),mf("-"),mf(" ")):(mf(" "),mf("+"),mf(" ")),Ui(ug(a)),a=Eg(a);else qf(a)&&(mf("-"),oq(a)&&mf(" ")),Ui(a);return nj--},Wi=function(a){var b;if(ug(a)===Pp(e)){for(a=Eg(a),Ui(ug(a)),a=Eg(a),b=[];Tk(a);)qf(ug(a))?(mf(" "),mf("-"),mf(" ")):(mf(" "),mf("+"),mf(" ")),Ui(ug(a)),b.push(a=Eg(a));return b}return Ui(a)},qf=function(a){return jl(a)?1:ug(a)===Pp(Cd)&&jl(tg(a))?1:0},Ui=function(a){var b;return ug(a)===Pp(Cd)?(b=qh(a),b&&0===Nl?Hi(a,b):Ki(a,b)):Ei(a)},Uk=function(a){return ug(a)===Pp(Xd)&&tg(a)!==Pp(ia)&&qf(sg(a))?1:0},qh=function(a){var b;for(ph=0,a=Eg(a);Tk(a);)b=ug(a),Uk(b)&&ph++,a=Eg(a);return ph},Ki=function(a,b){var c;if(0===b){for(a=Eg(a),(ql(ug(a))||fl(ug(a)))&&(a=Eg(a)),Ei(ug(a)),a=Eg(a),c=[];Tk(a);)mf(" "),Ei(ug(a)),c.push(a=Eg(a));return c}return Mi(a),mf("/"),b>1||_k(tg(a))?(mf("("),Ci(a),mf(")")):Ci(a)},Hi=function(a,b){var c,d,e,f,g;for(ph=0,d=0,e=0,f=0,g=0,No(),fn=Ym,gn=Ym,yl(tg(a))&&(co(tg(a)),lm(),yf(),fn=zn(),co(tg(a)),km(),gn=zn()),Wk(tg(a))&&(co(tg(a)),yf(),fn=zn()),f=ql(fn)?0:1,dn=Eg(a),nl(ug(dn))&&(dn=Eg(dn));Tk(dn);)en=ug(dn),Uk(en)?c=1:f++,dn=Eg(dn);for(g=Xi,d=vq,ph=0,ql(fn)||(Li(fn,0),ph++),dn=Eg(a),nl(ug(dn))&&(dn=Eg(dn));Tk(dn);)en=ug(dn),Uk(en)?c=1:(ph>0&&mf(" "),1===f?Di(en):Ei(en),ph++),dn=Eg(dn);for(0===ph&&mf("1"),e=vq,ph=0,ql(gn)||(Li(gn,0),ph++,b++),dn=Eg(a),yl(ug(dn))&&(dn=Eg(dn));Tk(dn);)en=ug(dn),Uk(en)&&(ph>0&&mf(" "),Bi(en,b),ph++),dn=Eg(dn);return Oj(g,d,e),Go()},Mi=function(a){var b,c;for(int(c),No(),dn=Ym,a=Eg(a),yl(ug(a))?(co(ug(a)),lm(),yf(),dn=zn(),a=Eg(a)):Wk(ug(a))&&(co(ug(a)),yf(),dn=zn(),a=Eg(a)),c=0,ql(dn)||(Li(dn,0),c++);Tk(a);)Uk(ug(a))?b=1:(c>0&&mf(" "),Ei(ug(a)),c++),a=Eg(a);return 0===c&&mf("1"),Go()},Ci=function(a){var b;for(int(b),No(),b=0,a=Eg(a),_k(ug(a))&&(co(ug(a)),km(),dn=zn(),Li(dn,0),b++,a=Eg(a));Tk(a);)Uk(ug(a))&&(b>0&&mf(" "),Bi(ug(a),0),b++),a=Eg(a);return Go()},Ei=function(a){return Dl(a)?void Gi(0===Nl?a:a):Wk(a)?void Li(a,0):ug(a)===Pp(e)||ug(a)===Pp(Cd)?void Qi(a):ug(a)===Pp(Xd)?void Oi(a):Tk(a)?void Ii(a):nl(a)?void(0===Nl?Ni(a):Li(a,0)):Bl(a)?void Ri(a):void(Al(a)&&Pi(a))},Ni=function(a){var b,c,d;return b=0,c=0,d=0,No(),co(a),lm(),yf(),fn=zn(),co(a),km(),gn=zn(),ql(gn)?(Li(fn,0),void Go()):(d=Xi,b=vq,Li(fn,0),c=vq,Li(gn,0),Oj(d,b,c),Go())},Yk=function(a){return Tk(a)&&ug(a)!==Pp(e)&&ug(a)!==Pp(Cd)&&ug(a)!==Pp(Xd)?1:Bl(a)?1:_k(a)?0:jl(a)?0:nl(a)?1:0},Oi=function(a){var b,c,d;return b=0,c=0,d=0,tg(a)===Pp(ia)?(nf("exp("),Di(sg(a)),void mf(")")):Nl>0?void(fl(sg(a))?(mf("1"),mf("/"),Yk(tg(a))?Ei(tg(a)):Qi(tg(a))):(Yk(tg(a))?Ei(tg(a)):Qi(tg(a)),mf("^"),Yk(sg(a))?Ei(sg(a)):Qi(sg(a)))):qf(sg(a))?(d=Xi,b=vq,mf("1"),c=vq,Bi(a,1),void Oj(d,b,c)):(b=vq,Yk(tg(a))?Ei(tg(a)):Qi(tg(a)),c=vq,Nl++,Di(sg(a)),Nl--,Pj(b,c))},Bi=function(a,b){var c,d;return c=0,d=0,fl(sg(a))?void(1===b?Di(tg(a)):Ei(tg(a))):(c=vq,Yk(tg(a))?Ei(tg(a)):Qi(tg(a)),d=vq,Nl++,Wi(sg(a)),Nl--,Pj(c,d))},Ii=function(a){if(ug(a)===Pp(_c)&&Bl(tg(a)))return void Ji(a);if(ug(a)===Pp(Pc))return void Fi(a);if(ug(a)===Pp(X)?mf("d"):Ri(ug(a)),mf("("),a=Eg(a),Tk(a))for(Di(ug(a)),a=Eg(a);Tk(a);)mf(","),Di(ug(a)),a=Eg(a);return mf(")")},Ji=function(a){if(a=Eg(a),jg(a)===Pp(e)||jg(a)===Pp(Cd)||jg(a)===Pp(Xd)||jg(a)===Pp(Pc)?Qi(ug(a)):Di(ug(a)),mf("["),a=Eg(a),Tk(a))for(Di(ug(a)),a=Eg(a);Tk(a);)mf(","),Di(ug(a)),a=Eg(a);return mf("]")},Fi=function(a){return a=tg(a),ug(a)===Pp(e)||ug(a)===Pp(Cd)||ug(a)===Pp(Xd)||ug(a)===Pp(Pc)?Qi(a):Di(a),mf("!")},Qi=function(a){return mf("("),Di(a),mf(")")},Ri=function(a){var b,c,d,e,f;if(c=0,a===Pp(ia))return void nf("exp(1)");for(d=kk(a),f=[],c=b=0,e=d.length;0<=e?b<e:b>e;c=0<=e?++b:--b)f.push(mf(d[c]));return f},Pi=function(a){var b,c,d,e;for(c=0,d=a.str,mf('"'),c=b=0,e=d.length;0<=e?b<e:b>e;c=0<=e?++b:--b)mf(d[c]);return mf('"')},Oj=function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s;for(e=0,f=0,i=0,n=0,q=0,g=0,o=0,r=0,h=0,p=0,s=0,j=lk(b,c),g=j[0],o=j[1],r=j[2],k=lk(c,vq),h=k[0],p=k[1],s=k[2],e=p>o?(p-o)/2:0,e++,q=r+g-1,f=-q-1,im(b,c,e,f),e=p>o?-o:-o+(o-p)/2,e++,f=-s+1,im(c,vq,e,f),n=p>o?p:o,n+=2,Xi=a,m=[],i=d=0,l=n;0<=l?d<l:d>l;i=0<=l?++d:--d)m.push(mf("-"));return m},Pj=function(a,b){var c,d,e,f,g,h,i,j,k;return c=0,d=0,h=0,j=0,e=0,i=0,k=0,f=lk(a,b),d=f[0],h=f[1],j=f[2],g=lk(b,vq),e=g[0],i=g[1],k=g[2],c=-k-e+1,c+=j-1,im(b,vq,0,c)},im=function(a,b,c,d){var e,f,g,h,i;for(f=0,i=[],f=e=g=a,h=b;g<=h?e<h:e>h;f=g<=h?++e:--e)Hg[f].x+=c,i.push(Hg[f].y+=d);return i},lk=function(a,b){var c,d,e,f,g,h,i,j,k,l,m;for(e=0,h=Hg[a].x,f=Hg[a].x,i=Hg[a].y,g=Hg[a].y,e=c=j=a+1,k=b;j<=k?c<k:c>k;e=j<=k?++c:--c)Hg[e].x<h&&(h=Hg[e].x),Hg[e].x>f&&(f=Hg[e].x),Hg[e].y<i&&(i=Hg[e].y),Hg[e].y>g&&(g=Hg[e].y);return d=g-i+1,l=f-h+1,m=i,[d,l,m]},di=function(a){return mf(a)},mf=function(a){if(vq!==hf)return null==Hg[vq],Hg[vq].c=a,Hg[vq].x=Xi,Hg[vq].y=0,vq++,Xi++},nf=function(a){var b,c,d,e;for(c=0,e=[],c=b=0,d=a.length;0<=d?b<d:b>d;c=0<=d?++b:--b)e.push(mf(a[c]));return e},Li=function(a,b){var c,d,e,f,g,h,i,j,k,l;switch(l="",f=0,a.k){case Pd:for(l=a.q.a.toString(),"-"===l[0]&&0===b&&(l=l.substring(1)),f=c=0,g=l.length;0<=g?c<g:c>g;f=0<=g?++c:--c)mf(l[f]);if(l=a.q.b.toString(),"1"===l)break;for(mf("/"),j=[],f=d=0,h=l.length;0<=h?d<h:d>h;f=0<=h?++d:--d)j.push(mf(l[f]));return j;case ea:for(l=ki(a.d),"-"===l[0]&&0===b&&(l=l.substring(1)),k=[],f=e=0,i=l.length;0<=i?e<i:e>i;f=0<=i?++e:--e)k.push(mf(l[f]));return k}},Rg=function(a,b){return a.y<b.y?-1:a.y>b.y?1:a.x<b.x?-1:a.x>b.x?1:0},Rn=function(){var a,b,c,d,e,f,g;for(c=0,a="",e=Hg.slice(0,vq),e.sort(Rg),Hg=[].concat(e).concat(Hg.slice(vq)),f=0,g=Hg[0].y,c=b=0,d=vq;0<=d?b<d:b>d;c=0<=d?++b:--b){for(;Hg[c].y>g;)a=Zn("\n",a),f=0,g++;for(;Hg[c].x>f;)a=$n(" ",a),f++;a=$n(Hg[c].c,a),f++}if($d)return console.log(a)},fg="",nk=function(){return vq=0,Nl=0,Xi=0,Di(zn()),Hj(),fg},Hj=function(){var a,b,c,d,e,f,g,h;for(f=fg,d=0,b=0,e=Hg.slice(0,vq),e.sort(Rg),Hg=[].concat(e).concat(Hg.slice(vq)),g=0,h=Hg[0].y,b=a=0,c=vq;0<=c?a<c:a>c;b=0<=c?++a:--a){for(;Hg[b].y>h;)f[d++]="\n",g=0,h++;for(;Hg[b].x>g;)f[d++]=" ",g++;f[d++]=Hg[b].c,g++}return f[d++]="\n"},Ed=100,Zm=function(){function a(){}return a.prototype.x=0,a.prototype.y=0,a.prototype.h=0,a.prototype.w=0,a.prototype.index=0,a.prototype.count=0,a}(),Ai=[],zi=Bf=0;Bf<1e4;zi=++Bf)Ai[zi]=new Zm;oe=3,pe=1,Si=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x;if(l=0,m=0,o=0,n=0,w=0,x=0,k=0,v=0,g=0,h=0,i=0,j=0,u=0,f=0,a.tensor.ndim>2)return void Gi(a);if(o=a.tensor.dim[0],n=2===a.tensor.ndim?a.tensor.dim[1]:1,m=o*n,m>Ed)return void Gi(a);for(w=Xi,l=b=0,p=m;0<=p?b<p:b>p;l=0<=p?++b:--b)Ai[l].index=vq,Ai[l].x=Xi,Di(a.tensor.elem[l]),Ai[l].count=vq-Ai[l].index,q=lk(Ai[l].index,vq),Ai[l].h=q[0],Ai[l].w=q[1],Ai[l].y=q[2];for(i=0,j=0,l=c=0,r=m;0<=r?c<r:c>r;l=0<=r?++c:--c)Ai[l].h>i&&(i=Ai[l].h),Ai[l].w>j&&(j=Ai[l].w);for(k=o*i+(o-1)*pe,v=n*j+(n-1)*oe,x=-(k/2),u=d=0,
s=o;0<=s?d<s:d>s;u=0<=s?++d:--d)for(f=e=0,t=n;0<=t?e<t:e>t;f=0<=t?++e:--e)l=u*n+f,g=w-Ai[l].x,h=x-Ai[l].y,im(Ai[l].index,Ai[l].index+Ai[l].count,g,h),g=0,f>0&&(g=f*(j+oe)),h=0,u>0&&(h=u*(i+pe)),g+=(j-Ai[l].w)/2,h+=(i-Ai[l].h)/2,im(Ai[l].index,Ai[l].index+Ai[l].count,g,h);return Xi=w+v},Gi=function(a){return Ti(a,0,0)},Ti=function(a,b,c){var d,e,f;for(e=0,mf("("),e=d=0,f=a.tensor.dim[b];0<=f?d<f:d>f;e=0<=f?++d:--d)b+1===a.tensor.ndim?(Di(a.tensor.elem[c]),c+=1):c=Ti(a,b+1,c),e+1<a.tensor.dim[b]&&mf(",");return mf(")"),c},Vc=function(a,b){var c,d,e;if(d=0,Yi(a,b))return 1;if(Dl(a)){for(d=c=0,e=a.tensor.nelem;0<=e?c<e:c>e;d=0<=e?++c:--c)if(Vc(a.tensor.elem[d],b))return 1;return 0}for(;Tk(a);){if(Vc(ug(a),b))return 1;a=Eg(a)}return 0},c.Find=Vc,xk=function(){var a,b,c,v,w;if(c=0,Qj=0,cq=0,bj=0,oi=0,Uj=Te,!Qj){for(Qj=1,c=a=0,v=Od;0<=v?a<v:a>v;c=0<=v?++a:--a)Rp[c]=new ef;for(c=b=0,w=Od;0<=w?b<w:b>w;c=0<=w?++b:--b)Rp[c].k=ve,dg[c]=Rp[c],Sf[c]=Pp(Fd);return cn=Pp(Fd),dn=Pp(Fd),en=Pp(Fd),fn=Pp(Fd),gn=Pp(Fd),hn=Pp(Fd),kn=Pp(Fd),ln=Pp(Fd),mn=Pp(Fd),nn=Pp(Fd),Ep("abs",d),Ep("add",e),Ep("adj",f),Ep("and",g),Ep("arccos",h),Ep("arccosh",i),Ep("arcsin",j),Ep("arcsinh",k),Ep("arctan",l),Ep("arctanh",m),Ep("arg",n),Ep("atomize",o),Ep("besselj",r),Ep("bessely",s),Ep("binding",t),Ep("binomial",u),Ep("ceiling",D),Ep("check",E),Ep("choose",F),Ep("circexp",G),Ep("clear",H),Ep("clock",I),Ep("coeff",J),Ep("cofactor",K),Ep("condense",L),Ep("conj",M),Ep("contract",O),Ep("cos",P),Ep("cosh",Q),Ep("decomp",T),Ep("defint",U),Ep("deg",V),Ep("denominator",W),Ep("det",Y),Ep("derivative",X),Ep("dim",$),Ep("dirac",_),Ep("display",aa),Ep("divisors",ba),Ep("do",ca),Ep("dot",da),Ep("draw",fa),Ep("dsolve",ha),Ep("erf",qa),Ep("erfc",ra),Ep("eigen",ja),Ep("eigenval",ka),Ep("eigenvec",la),Ep("eval",sa),Ep("exp",ta),Ep("expand",ua),Ep("expcos",va),Ep("expsin",wa),Ep("factor",Oc),Ep("factorial",Pc),Ep("factorpoly",Qc),Ep("filter",Rc),Ep("float",Sc),Ep("floor",Tc),Ep("for",Uc),Ep("Gamma",Wc),Ep("gcd",Xc),Ep("hermite",Yc),Ep("hilbert",Zc),Ep("imag",$c),Ep("component",_c),Ep("inner",ad),Ep("integral",bd),Ep("inv",cd),Ep("invg",dd),Ep("isinteger",gd),Ep("isprime",hd),Ep("laguerre",id),Ep("lcm",kd),Ep("leading",ld),Ep("legendre",md),Ep("log",nd),Ep("mag",pd),Ep("mod",yd),Ep("multiply",Cd),Ep("not",Gd),Ep("nroots",Hd),Ep("number",Qd),Ep("numerator",Rd),Ep("operator",Sd),Ep("or",Td),Ep("outer",Ud),Ep("polar",Wd),Ep("power",Xd),Ep("prime",Yd),Ep("print",Zd),Ep("product",_d),Ep("quote",ae),Ep("quotient",be),Ep("rank",ce),Ep("rationalize",de),Ep("real",ee),Ep("rect",kf),Ep("roots",fe),Ep("equals",ie),Ep("sgn",je),Ep("simplify",le),Ep("sin",me),Ep("sinh",ne),Ep("shape",ke),Ep("sqrt",qe),Ep("stop",re),Ep("subst",te),Ep("sum",ue),Ep("tan",Je),Ep("tanh",Ke),Ep("taylor",Le),Ep("test",Ne),Ep("testeq",Oe),Ep("testge",Pe),Ep("testgt",Qe),Ep("testle",Re),Ep("testlt",Se),Ep("transpose",Ve),Ep("unit",ff),Ep("zero",lf),Ep("nil",Fd),Ep("autoexpand",p),Ep("bake",q),Ep("last",jd),Ep("trace",Ue),Ep("tty",We),Ep("~",jf),Ep("$DRAWX",ga),Ep("$METAA",ud),Ep("$METAB",vd),Ep("$METAX",wd),Ep("$SECRETX",ge),Ep("pi",Vd),Ep("a",we),Ep("b",xe),Ep("c",ye),Ep("d",ze),Ep("i",Ae),Ep("j",Be),Ep("n",Ce),Ep("r",De),Ep("s",Ee),Ep("t",Fe),Ep("x",Ge),Ep("y",He),Ep("z",Ie),Ep("$C1",x),Ep("$C2",y),Ep("$C3",z),Ep("$C4",A),Ep("$C5",B),Ep("$C6",C),jo(0),_q=zn(),jo(1),Ym=zn(),lo(Xd),S&&Jn(Cp[cq-1]),jo(-1),S&&Jn(Cp[cq-1]),ko(1,2),S&&Jn(Cp[cq-1]),Ol(3),S&&Jn(Cp[cq-1]),vk=zn(),Ph()}},Qh=["e=exp(1)","i=sqrt(-1)","autoexpand=1","trange=(-pi,pi)","xrange=(-10,10)","yrange=(-10,10)","last=0","trace=0","tty=0","cross(u,v)=(u[2]*v[3]-u[3]*v[2],u[3]*v[1]-u[1]*v[3],u[1]*v[2]-u[2]*v[1])","curl(v)=(d(v[3],y)-d(v[2],z),d(v[1],z)-d(v[3],x),d(v[2],x)-d(v[1],y))","div(v)=d(v[1],x)+d(v[2],y)+d(v[3],z)","ln(x)=log(x)"],Ph=function(){var a,b,c,d,e;for(e=[],c=a=0,d=Qh.length;0<=d?a<d:a>d;c=0<=d?++a:--a)b=Qh[c],Po(b),S&&(console.log("... evaling "+b),console.log("top of stack:"),Jn(Cp[cq-1])),xa(),e.push(zn());return e},Yl=function(a,b){return a.compare(b)},Zl=function(a,b){var c,d;return c=Yf(b),d=Yl(a,c)},Ip=function(a,b){return a===b?0:a>b?1:-1},ki=function(a){return parseFloat(a.toPrecision(6))},Pg=function(){},zl=function(a){return null!=a&&(" "===a||"\t"===a||"\n"===a||"\v"===a||"\f"===a||"\r"===a)},Vk=function(a){return null!=a&&/^\d+$/.test(a)},Rk=function(a){return null!=a&&a.search(/[^A-Za-z]/)===-1},Qk=function(a){return null!=a&&(Rk(a)||Vk(a))},Hp=function(a){var b;throw aj+="Stop: ",aj+=a,b=aj,aj="",cq=0,new Error(b)},zk=!1,Mo=function(a){var b,c,d,e,f,g;if(a=a,"selftest"===a)return void selftest();for(zk||(zk=!0,xk()),e=0,g=0,f=0,b="";;){try{aj="",Jg(),g=Po(a.substring(f)),dn=zn(),Jg()}catch(a){d=a,$d&&console.log(d),b+=d.message,xk();break}if(0===g)break;f+=g,co(dn);try{if(bq(),en=zn(),Jg(),en===Pp(Fd))continue;if(Al(en)){console.log(en.str),console.log("\n");continue}c=Yg(en),b+=c,$d&&(console.log("printline"),console.log(c)),$d&&(console.log("display:"),bi(en)),b+="\n"}catch(a){d=a,c=d.message,$d&&console.log(c),b+=c,b+="\n",xk()}}return"\n"===b[b.length-1]&&(b=b.substring(0,b.length-1)),b},Jg=function(){if(0!==cq&&Hp("stack error"),Uj!==Te)return Hp("frame error")},xi=function(a){return console.log(a),console.log("\n")},bq=function(){var a;return S&&console.log("#### top level eval"),No(),fq=0,dn=Pp(p),kj=El(hk(dn))?0:1,dn=zn(),co(dn),xa(),en=zn(),en===Pp(Fd)?(co(en),void Go()):(ep(Pp(jd),en),El(hk(Pp(q)))||(co(en),Tf(),en=zn()),dn!==Pp(Ae)&&dn!==Pp(Be)||!bl(en)?bl(hk(Pp(Be)))?(co(en),co(vk),lo(Be),Lp(),en=zn()):bl(hk(Pp(Ae)))&&(co(en),co(vk),lo(Ae),Lp(),en=zn()):a=0,co(en),Go())},Ig=function(){if(bj)return Hp("esc key")},("undefined"!=typeof b&&null!==b?b:this).run=Mo,cq=0,Jm=0,co=function(a){return null!=a.isZero,a===Pp(Fd)&&(Jm++,S&&console.log("pushing symbol(NIL) #"+Jm)),cq>=Uj&&Hp("stack overflow"),Cp[cq++]=a},zn=function(){var a;return 0===cq&&Hp("stack underflow"),null==Cp[cq-1],a=Cp[--cq]},ho=function(a){var b,c,d,e;for(c=0,Uj-=a,Uj<cq&&Hp("frame overflow, circular reference?"),e=[],c=b=0,d=a;0<=d?b<d:b>d;c=0<=d?++b:--b)e.push(Cp[Uj+c]=Pp(Fd));return e},Bn=function(a){if(Uj+=a,Uj>Te)return Hp("frame underflow")},No=function(){return Uj-=10,Uj<cq&&Hp("frame overflow, circular reference?"),Cp[Uj+0]=cn,Cp[Uj+1]=dn,Cp[Uj+2]=en,Cp[Uj+3]=fn,Cp[Uj+4]=gn,Cp[Uj+5]=hn,Cp[Uj+6]=kn,Cp[Uj+7]=ln,Cp[Uj+8]=mn,Cp[Uj+9]=nn},Go=function(){return Uj>Te-10&&Hp("frame underflow"),cn=Cp[Uj+0],dn=Cp[Uj+1],en=Cp[Uj+2],fn=Cp[Uj+3],gn=Cp[Uj+4],hn=Cp[Uj+5],kn=Cp[Uj+6],ln=Cp[Uj+7],mn=Cp[Uj+8],nn=Cp[Uj+9],Uj+=10},Op=function(){var a,b;return a=zn(),b=zn(),co(a),co(b)},wi=function(){var a;return a=zn(),co(a),co(a)},c.dupl=wi,c.swap=Op,c.restore=Go,c.save=No,c.push=co,c.pop=zn,Ep=function(a,b){var c;return c=Rp[b],c.printname=a},mq=function(a){var b,c,d,e;for(c=0,c=b=0,e=Od;(0<=e?b<e:b>e)&&""!==Rp[c].printname;c=0<=e?++b:--b)if(a===Rp[c].printname)return Rp[c];return c===Od&&Hp("symbol table overflow"),d=Rp[c],d.printname=a,d},kk=function(a){return a.k!==ve&&Hp("symbol error"),a.printname},ep=function(a,b){var c;return a.k!==ve&&Hp("symbol error"),c=Rp.indexOf(a),Rp.indexOf(a,c+1)!==-1&&console.log("ops, more than one element!"),S&&console.log("lookup >> set_binding lookup "+c),dg[c]=b,Sf[c]=Pp(Fd)},hk=function(a){var b;return a.k!==ve&&Hp("symbol error"),b=Rp.indexOf(a),Rp.indexOf(a,b+1)!==-1&&console.log("ops, more than one element!"),S&&console.log("lookup >> get_binding lookup "+b),dg[b]},fp=function(a,b,c){var d;return a.k!==ve&&Hp("symbol error"),d=Rp.indexOf(a),Rp.indexOf(a,d+1)!==-1&&console.log("ops, more than one element!"),S&&console.log("lookup >> set_binding_and_arglist lookup "+d),dg[d]=b,Sf[d]=c},gk=function(a){var b;return a.k!==ve&&Hp("symbol error"),b=Rp.indexOf(a),Rp.indexOf(a,b+1)!==-1&&console.log("ops, more than one element!"),S&&console.log("lookup >> get_arglist lookup "+b),Sf[b]},Rl=0,Qp=function(a){var b;return Rl++,a.k!==ve&&Hp("symbol error"),b=Rp.indexOf(a),Rp.indexOf(a,b+1)!==-1&&console.log("ops, more than one element!"),S&&console.log("lookup >> symnum lookup "+b+" lookup # "+Rl),b},lo=function(a){return co(Rp[a])},Og=function(){var a,b,c,d;for(b=0,d=[],b=a=0,c=Od;0<=c?a<c:a>c;b=0<=c?++a:--a)dg[b]=Rp[b],d.push(Sf[b]=Pp(Fd));return d},c.get_binding=hk,c.set_binding=ep,c.usr_symbol=mq,zk||(zk=!0,xk()),c.init=xk,pn=function(a){return"string"==typeof a?Po(a):"number"==typeof a?a%1===0?jo(a):fo(a):a instanceof ef?co(a):(console.warn("unknown argument type",a),co(Pp(Fd)))},on=function(a){var b,c;try{pn(a),b=zn(),Jg()}catch(a){throw c=a,Fo(),c}return b},cj=function(){var a,b,c,d,e,f,g,h;for(g=arguments[0],c=2<=arguments.length?ar.call(arguments,1):[],e=hk(mq(g)),Jg(),co(e),a=0,f=c.length;a<f;a++)b=c[a],pn(b);Ol(1+c.length),dn=zn(),co(dn);try{Nj(),h=zn(),Jg()}catch(a){throw d=a,Fo(),d}return h},Fo=function(){return cq=0,bj=0,oi=0,Uj=Te},Nj=function(){return No(),fq=0,dn=Pp(p),kj=El(hk(dn))?0:1,dn=zn(),co(dn),xa(),en=zn(),en===Pp(Fd)?(co(en),void Go()):(El(hk(Pp(q)))||(co(en),Tf(),en=zn()),co(en),Go())},c.exec=cj,c.parse=on,function(){var a,b,d,e,f;for(b=["abs","add","adj","and","arccos","arccosh","arcsin","arcsinh","arctan","arctanh","arg","atomize","besselj","bessely","binding","binomial","ceiling","check","choose","circexp","clear","clock","coeff","cofactor","condense","conj","contract","cos","cosh","decomp","defint","deg","denominator","det","derivative","dim","dirac","display","divisors","do","dot","draw","dsolve","erf","erfc","eigen","eigenval","eigenvec","eval","exp","expand","expcos","expsin","factor","factorial","factorpoly","filter","float","floor","for","Gamma","gcd","hermite","hilbert","imag","component","inner","integral","inv","invg","isinteger","isprime","laguerre","lcm","leading","legendre","log","mag","mod","multiply","not","nroots","number","numerator","operator","or","outer","polar","power","prime","print","product","quote","quotient","rank","rationalize","real","rect","roots","equals","sgn","simplify","sin","sinh","sqrt","stop","subst","sum","tan","tanh","taylor","test","testeq","testge","testgt","testle","testlt","transpose","unit","zero"],f=[],a=0,e=b.length;a<e;a++)d=b[a],f.push(c[d]=cj.bind(this,d));return f}()}.call(this),c.exports}),a.registerDynamic("4",[],!0,function(a,b,c){var d=(this||self,{version:"1.3.2"});return"undefined"!=typeof b&&(b.Tree=d),d.parse=function(a){var b,c=new d.Node,e=c.append(new d.Node);for(e.value="",b=0;b<a.length;b++){var f=a[b];if("["==f)e=e.append(new d.Node),e.value="";else if("]"==f){if(e=e.parent,e===c)throw"parse error"}else","==f?(e=e.parent.append(new d.Node),e.value=""):e.value+=f}for(b=0;b<c.children.length;b++)c.children[b].parent=null;return 1===c.children.length?c.children[0]:c.children},d.stringify=function(a){var b=function(a){var c="";return"value"in a&&(c+=a.value),a.children&&a.children[0]&&(c+="["+a.children.map(b).join(",")+"]"),c};return Array.isArray(a)||(a=[a]),a.map(b).join(",")},function(){function a(){var a=0,d=Math.random()*b;return e[a++]=f[d&c],e[a++]=f[d>>>4&c],e[a++]=f[d>>>8&c],e[a++]=f[d>>>12&c],e[a++]=f[d>>>16&c],e[a++]=f[d>>>20&c],e[a++]=f[d>>>24&c],e[a++]=f[d>>>28&c],d=Math.random()*b,e[a++]=f[d&c],e[a++]=f[d>>>4&c],e[a++]=f[d>>>8&c],e[a++]=f[d>>>12&c],e[a++]=f[d>>>16&c],e[a++]=f[d>>>20&c],e[a++]=f[d>>>24&c],e[a++]=f[d>>>28&c],"_"+e.join("")}var b=4294967296,c=15,e=[],f=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];d.uid=a}(),d.clone=function(a,b,c){var e=function(a){var f,g=new a.constructor;if(c)for(f=0;f<c.length;f++)g[c[f]]=a[c[f]];else for(var h in a)"_"!==h[0]&&(g[h]=a[h]);if(delete g.ls,delete g.rs,delete g.parent,a.id&&!b&&(g.id=d.uid()),a.children){for(g.children=[],f=0;f<a.children.length;f++)g.children.push(e(a.children[f])),g.children[f].parent=g;for(f=0;f<a.children.length;f++)g.children[f].ls=g.children[f-1],g.children[f].rs=g.children[f+1]}return g};if(!Array.isArray(a))return e(a);var f=a.map(e);if(a.length>1)for(var g=0;g<a.length;g++)g>0&&a[g].ls===a[g-1]&&(f[g].ls=f[g-1]),g<a.length-1&&a[g].rs===a[g+1]&&(f[g].rs=f[g+1]);return f},d.get_mapping_between=function(a,b){function c(a,b){if(a.id in d)throw"duplicate id in source tree";if(d[a.id]=[b],a.children.length!==b.children.length)if(a.has_children()){if(b.has_children())throw"tree structures don't match";a.for_each(function(a){d[a.id]=[b]})}else d[a.id]=b.select_all();else for(var e=0;e<a.children.length;e++)c(a.children[e],b.children[e])}var d={};if(Array.isArray(a)){if(a.length!==b.length)throw"tree structures don't match";for(var e=0;e<a.length;e++)c(a[e],b[e])}else c(a,b);return d},d.get_1to1_mapping_between=function(a,b,c){function d(a,b){if(c&&a.id in e)throw"duplicate id in source tree";if(e[a.id]=[b],c&&a.children.length!==b.children.length)throw"tree structures don't match";for(var f=a.children.length,g=b.children.length,h=0;h<f;h++)h<g?d(a.children[h],b.children[h]):a.children[h].for_each(function(a){e[a.id]=[]})}var e={};if(arguments.length<3&&(c=!0),Array.isArray(a)){if(c&&a.length!==b.length)throw"tree structures don't match";for(var f=a.length,g=b.length,h=0;h<f;h++)h<g?d(a[h],b[h]):a[h].for_each(function(a){e[a.id]=[]})}else d(a,b);return e},d.nodes_to_range=function(a){var b=a.length;if(0===b)return[];if(1===b)return[a[0]];for(var c=a[0];c.parent;)c=c.parent;for(var e=a.map(function(a){return d.get_path(a)}),f=function(a){for(var b=e[0][a],c=0;c<e.length;c++){if(e[c].length<=a+1)return!1;if(e[c][a]!==b)return!1}return!0},g=0;f(g);)g++;var h,i=d.get_child(e[0].slice(0,g),c),j=-1,k=i.children.length;for(h=0;h<b;h++){var l=d.get_child(e[h].slice(0,g+1),c),m=i.children.indexOf(l);m>j&&(j=m),m<k&&(k=m)}var n=[];for(h=k;h<=j;h++)n.push(i.children[h]);return n},d.insert=function(a,b,c){return c.ls=a.children[b-1],a.children[b-1]&&(a.children[b-1].rs=c),c.rs=a.children[b],a.children[b]&&(a.children[b].ls=c),c.parent=a,a.children.splice(b,0,c),c},d.insert_range=function(a,b,c){var d=c.length;if(0!==d){c[0].ls=a.children[b-1],a.children[b-1]&&(a.children[b-1].rs=c[0]),c[d-1].rs=a.children[b],a.children[b]&&(a.children[b].ls=c[d-1]);for(var e=0;e<d;e++)c[e].parent=a;return a.children=a.children.slice(0,b).concat(c,a.children.slice(b)),c}},d.append_range=function(a,b){var c=b.length;if(0!==c){var d=a.children[a.children.length-1];d&&(d.rs=b[0]),b[0].ls=d,b[c-1].rs=null;for(var e=0;e<c;e++)b[e].parent=a;return a.children=a.children.concat(b),b}},d.filterRange=function(a,b){for(var c=[],d=Array.isArray(b)?b:[b],e=function(b,d){for(var f=[],g=d;g<b.length;g++)f.push(b[g]),a(f)&&c.push(f.slice());if(b[d].children)for(var g=0;g<b[d].children.length;g++)e(b[d].children,g)},f=0;f<d.length;f++)e(d,f);return c},d.append=function(a,b){var c=a.children[a.children.length-1];return c&&(c.rs=b),b.ls=c,b.rs=null,b.parent=a,a.children.push(b),b},d.remove=function(a){var b,c=a.parent.children;return b=c.indexOf(a),c[b-1]&&(c[b-1].rs=a.rs),c[b+1]&&(c[b+1].ls=a.ls),c.splice(b,1),b},d.remove_range=function(a){var b=a.length;if(0!==b){var c=a[0].parent.children,d=c.indexOf(a[0]);return c[d-1]&&(c[d-1].rs=a[b-1].rs),c[d+b]&&(c[d+b].ls=a[0].ls),c.splice(d,b),d}},d.replace=function(a,b){b.parent&&d.remove(b);var c=d.remove(a);return d.insert(a.parent,c,b)},d.switch_siblings=function(a,b){if(a.parent!=b.parent)throw"Called switch_siblings on nodes that are no siblings!";var c=a.parent,d=c.children.indexOf(a),e=c.children.indexOf(b);c.children[d]=b,c.children[e]=a;var f;a.rs==b?(a.ls&&(a.ls.rs=b),b.rs&&(b.rs.ls=a),a.rs=b.rs,b.ls=a.ls,a.ls=b,b.rs=a):a.ls==b?(a.rs&&(a.rs.ls=b),b.ls&&(b.ls.rs=a),a.ls=b.ls,b.rs=a.rs,a.rs=b,b.ls=a):(a.ls&&(a.ls.rs=b),a.rs&&(a.rs.ls=b),b.ls&&(b.ls.rs=a),b.rs&&(b.rs.ls=a),f=a.ls,a.ls=b.ls,b.ls=f,f=a.rs,a.rs=b.rs,b.rs=f)},d.validate=function(a){var b=function(a,c){if(a.parent!=c)throw"wrong parent information";if(a.children)for(var d=0;d<a.children.length;d++){var e=a.children[d];if(e.ls!=a.children[d-1])throw"wrong ls information";if(e.rs!=a.children[d+1])throw"wrong rs information";b(e,a)}};Array.isArray(a)||(a=[a]);for(var c=0;c<a.length;c++)b(a[c],null)},d.get_idx=function(a){return a.parent?a.parent.children.indexOf(a):-1},d.get_child=function(a,b){for(var c=0;c<a.length;c++){if(!b.children||b.children.length<=a[c])throw"invalid path";b=b.children[a[c]]}return b},d.get_parent=function(a,b){for(var c=0;c<a;c++){if(!b.parent)throw"invalid path";b=b.parent}return b},d.get_path=function(a){for(var b=[];a.parent;)b.unshift(a.parent.children.indexOf(a)),a=a.parent;return b},d.for_each=function(a,b){for(var c=Array.isArray(b)?b:[b],d=function(b){if(a(b),b.children)for(var c=0;c<b.children.length;c++)d(b.children[c])},e=0;e<c.length;e++)d(c[e])},d.map=function(a,b){for(var c=Array.isArray(b)?b:[b],d=[],e=function(b){if(d.push(a(b)),b.children)for(var c=0;c<b.children.length;c++)e(b.children[c])},f=0;f<c.length;f++)e(c[f]);return d},d.filter=function(a,b){for(var c=[],d=Array.isArray(b)?b:[b],e=function(b){if(a(b)&&c.push(b),b.children)for(var d=0;d<b.children.length;d++)e(b.children[d])},f=0;f<d.length;f++)e(d[f]);return c},d.select_all=function(a){return d.filter(function(){return!0},a)},d.select_first=function(a,b){for(var c=function(b){for(var c=b;;){if(a(c))return c;if(c.children&&c.children[0])c=c.children[0];else{if(c===b)return null;for(;!c.rs;)if(c=c.parent,c===b)return null;c=c.rs}}},d=Array.isArray(b)?b:[b],e=0;e<d.length;e++){var f=c(d[e]);if(f)return f}return null},d.get_cca=function(a){for(var b=a.map(function(a){return d.get_path(a)}),c=function(a){for(var c=b[0][a],d=0;d<b.length;d++){if(b[d].length<=a+1)return!1;if(b[d][a]!==c)return!1}return!0},e=0;c(e);)e++;for(var f=b[0].length-e,g=a[0],h=0;h<f;h++)g=g.parent;return g},d.get_leaf_nodes=function(a){return d.filter(function(a){return!(a.children&&a.children.length)},a)},d.is_root=function(a){return!a.parent},d.is_range=function(a){for(var b=1;b<a.length;b++)if(a[b-1].rs!==a[b])return!1;return!0},d.get_root=function(a){for(;a.parent;)a=a.parent;return a},d.get_by_value=function(a,b){return d.filter(function(b){return b.value===a},b)},d.get_by_id=function(a,b){return d.select_first(function(b){return b.id===a},b)},d.Node=function(){this.children=[],this.parent=null,this.ls=null,this.rs=null,this.id=d.uid()},d.Node.prototype.stringify=function(){return d.stringify(this)},d.Node.prototype.clone=function(a,b){return d.clone(this,a,b)},d.Node.prototype.get_mapping_to=function(a){return d.get_mapping_between(this,a)},d.Node.prototype.get_1to1_mapping_to=function(a,b){return d.get_1to1_mapping_between(this,a,b)},d.Node.prototype.insert=function(a,b){return d.insert(this,a,b)},d.Node.prototype.insert_range=function(a,b){return d.insert_range(this,a,b)},d.Node.prototype.append_range=function(a){return d.append_range(this,a)},d.Node.prototype.append=function(a){return d.append(this,a)},d.Node.prototype.remove=function(){return d.remove(this)},d.Node.prototype.remove_range=function(a){return d.remove_range(a)},d.Node.prototype.replace_with=function(a){return d.replace(this,a)},d.Node.prototype.switch_with_sibling=function(a){return d.switch_siblings(this,a)},d.Node.prototype.validate=function(){return d.validate(this)},d.Node.prototype.get_child=function(a){return d.get_child(a,this)},d.Node.prototype.get_parent=function(a){return d.get_parent(a,this)},d.Node.prototype.get_path=function(){return d.get_path(this)},d.Node.prototype.for_each=function(a){return d.for_each(a,this)},d.Node.prototype.map=function(a){return d.map(a,this)},d.Node.prototype.filter=function(a){return d.filter(a,this)},d.Node.prototype.filterRange=function(a){return d.filterRange(a,this)},d.Node.prototype.select_all=function(){return d.select_all(this)},d.Node.prototype.select_first=function(a){return d.select_first(a,this)},d.Node.prototype.get_leaf_nodes=function(){return d.get_leaf_nodes(this)},d.Node.prototype.is_root=function(){return d.is_root(this)},d.Node.prototype.get_root=function(){return d.get_root(this)},d.Node.prototype.get_by_value=function(a){return d.get_by_value(a,this)},d.Node.prototype.get_by_id=function(a){return d.get_by_id(a,this)},d.Node.prototype.has_children=function(){return this.children&&this.children.length>0},d.Node.prototype.get_idx=function(){return d.get_idx(this)},c.exports}),a.registerDynamic("5",[],!1,function(b,c,d){var e=a.get("@@global-helpers").prepareGlobal(d.id,null,null);return function(a){}(this),e()}),a.registerDynamic("6",["5"],!0,function(a,b,c){this||self;return function(){function a(){}function b(a){var b=a.length-1;return function(){var c=v.call(arguments,0,b),d=v.call(arguments,b);return a.apply(this,c.concat([d]))}}function c(a){return b(function(b,c){"function"!=typeof b&&(b=w(b));var d=function(a){return b.apply(a,[a].concat(c))};return a.call(this,d)})}function d(a){var b=v.call(arguments,1);return function(){return a.apply(this,b)}}function e(a,b){if(!b)throw new Error("prayer failed: "+a)}function f(a){e("a direction was passed",a===y||a===z)}function g(a,b,c){e("a parent is always present",a),e("leftward is properly set up",function(){return b?b[z]===c&&b.parent===a:a.ends[y]===c}()),e("rightward is properly set up",function(){return c?c[y]===b&&c.parent===a:a.ends[z]===b}())}function h(){window.console&&console.warn('You are using the MathQuill API without specifying an interface version, which will fail in v1.0.0. Easiest fix is to do the following before doing anything else:\n\n    MathQuill = MathQuill.getInterface(1);\n    // now MathQuill.MathField() works like it used to\n\nSee also the "`dev` branch (2014–2015) → v0.10.0 Migration Guide" at\n  https://github.com/mathquill/mathquill/wiki/%60dev%60-branch-(2014%E2%80%932015)-%E2%86%92-v0.10.0-Migration-Guide')}function i(a){return h(),Ka(a)}function j(b){function c(a){if(!a||!a.nodeType)return null;var b=A(a).children(".mq-root-block").attr(s),c=b&&C.byId[b].controller;return c?e[c.KIND_OF_MQ](c):null}function d(a,b){b&&b.handlers&&(b.handlers={fns:b.handlers,APIClasses:e});for(var c in b)if(b.hasOwnProperty(c)){var d=b[c],f=L[c];a[c]=f?f(d):d}}if(!(O<=b&&b<=P))throw"Only interface versions between "+O+" and "+P+" supported. You specified: "+b;var e={};c.L=y,c.R=z,c.config=function(a){return d(K.p,a),this},c.registerEmbed=function(a,b){if(!/^[a-z][a-z0-9]*$/i.test(a))throw"Embed name must start with letter and be only letters and digits";N[a]=b};var f=e.AbstractMathQuill=x(M,function(a){a.init=function(a){this.__controller=a,this.__options=a.options,this.id=a.id,this.data=a.data},a.__mathquillify=function(a){var b=this.__controller,c=b.root,d=b.container;b.createTextarea();var e=d.addClass(a).contents().detach();c.jQ=A('<span class="mq-root-block"/>').attr(s,c.id).appendTo(d),this.latex(e.text()),this.revert=function(){return d.empty().unbind(".mathquill").removeClass("mq-editable-field mq-math-mode mq-text-mode").append(e)}},a.config=function(a){return d(this.__options,a),this},a.el=function(){return this.__controller.container[0]},a.text=function(){return this.__controller.exportText()},a.latex=function(a){return arguments.length>0?(this.__controller.renderLatexMath(a),this.__controller.blurred&&this.__controller.cursor.hide().parent.blur(),this):this.__controller.exportLatex()},a.html=function(){return this.__controller.root.jQ.html().replace(/ mathquill-(?:command|block)-id="?\d+"?/g,"").replace(/<span class="?mq-cursor( mq-blink)?"?>.?<\/span>/i,"").replace(/ mq-hasCursor|mq-hasCursor ?/,"").replace(/ class=(""|(?= |>))/g,"")},a.reflow=function(){return this.__controller.root.postOrder("reflow"),this}});c.prototype=f.prototype,e.EditableField=x(f,function(b,c){b.__mathquillify=function(){return c.__mathquillify.apply(this,arguments),this.__controller.editable=!0,this.__controller.delegateMouseEvents(),this.__controller.editablesTextareaEvents(),this},b.focus=function(){return this.__controller.textarea.focus(),this},b.blur=function(){return this.__controller.textarea.blur(),this},b.write=function(a){return this.__controller.writeLatex(a),this.__controller.scrollHoriz(),this.__controller.blurred&&this.__controller.cursor.hide().parent.blur(),this},b.cmd=function(a){var b=this.__controller.notify(),c=b.cursor;if(/^\\[a-z]+$/i.test(a)){a=a.slice(1);var d=E[a];d&&(a=d(a),c.selection&&a.replaces(c.replaceSelection()),a.createLeftOf(c.show()),this.__controller.scrollHoriz())}else c.parent.write(c,a);return b.blurred&&c.hide().parent.blur(),this},b.select=function(){var a=this.__controller;for(a.notify("move").cursor.insAtRightEnd(a.root);a.cursor[y];)a.selectLeft();return this},b.clearSelection=function(){return this.__controller.cursor.clearSelection(),this},b.moveToDirEnd=function(a){return this.__controller.notify("move").cursor.insAtDirEnd(a,this.__controller.root),this},b.moveToLeftEnd=function(){return this.moveToDirEnd(y)},b.moveToRightEnd=function(){return this.moveToDirEnd(z)},b.keystroke=function(b){for(var b=b.replace(/^\s+|\s+$/g,"").split(/\s+/),c=0;c<b.length;c+=1)this.__controller.keystroke(b[c],{preventDefault:a});return this},b.typedText=function(a){for(var b=0;b<a.length;b+=1)this.__controller.typedText(a.charAt(b));return this},b.dropEmbedded=function(a,b,c){var d=a-A(window).scrollLeft(),e=b-A(window).scrollTop(),f=document.elementFromPoint(d,e);this.__controller.seek(A(f),a,b);var g=Ja().setOptions(c);g.createLeftOf(this.__controller.cursor)},b.clickAt=function(a,b,c){c=c||document.elementFromPoint(a,b);var d=this.__controller,e=d.root;return q.contains(e.jQ[0],c)||(c=e.jQ[0]),d.seek(A(c),a+pageXOffset,b+pageYOffset),d.blurred&&this.focus(),this},b.ignoreNextMousedown=function(a){return this.__controller.cursor.options.ignoreNextMousedown=a,this}}),c.EditableField=function(){throw"wtf don't call me, I'm 'abstract'"},c.EditableField.prototype=e.EditableField.prototype;for(var g in J)(function(a,d){var f=e[a]=d(e);c[a]=function(d,e){var g=c(d);if(g instanceof f||!d||!d.nodeType)return g;var h=I(f.RootBlock(),A(d),K());return h.KIND_OF_MQ=a,f(h).__mathquillify(e,b)},c[a].prototype=f.prototype})(g,J[g]);return c}function k(a){for(var b="moveOutOf deleteOutOf selectOutOf upOutOf downOutOf".split(" "),c=0;c<b.length;c+=1)(function(b){a[b]=function(a){this.controller.handle(b,a)}})(b[c]);a.reflow=function(){this.controller.handle("reflow"),this.controller.handle("edited"),this.controller.handle("edit")}}function l(a,b,c){return x(_,{ctrlSeq:a,htmlTemplate:"<"+b+" "+c+">&0</"+b+">"})}function m(a){var b=this.parent,c=a;do{if(c[z])return a.insLeftOf(b);c=c.parent.parent}while(c!==b);a.insRightOf(b)}function n(a,b){a.jQadd=function(){b.jQadd.apply(this,arguments),this.delimjQs=this.jQ.children(":first").add(this.jQ.children(":last")),this.contentjQ=this.jQ.children(":eq(1)")},a.reflow=function(){var a=this.contentjQ.outerHeight()/parseFloat(this.contentjQ.css("fontSize"));sa(this.delimjQs,t(1+.2*(a-1),1.2),1.2*a)}}function o(a,b){var b=b||a,c=Ha[a],e=Ha[b];F[a]=d(Ga,y,a,c,b,e),F[c]=d(Ga,z,a,c,b,e)}var p,q=window.jQuery,r="mathquill-command-id",s="mathquill-block-id",t=Math.min,u=Math.max,v=[].slice,w=b(function(a,c){return b(function(b,d){if(a in b)return b[a].apply(b,c.concat(d))})}),x=function(a,b,c){function d(a){return"object"==typeof a}function e(a){return"function"==typeof a}function f(){}return function g(h,i){function j(){var a=new k;return e(a.init)&&a.init.apply(a,arguments),a}function k(){}i===c&&(i=h,h=Object),j.Bare=k;var l,m=f[a]=h[a],n=k[a]=j[a]=j.p=new f;return n.constructor=j,j.extend=function(a){return g(j,a)},(j.open=function(a){if(l={},e(a)?l=a.call(j,n,m,j,h):d(a)&&(l=a),d(l))for(var c in l)b.call(l,c)&&(n[c]=l[c]);return e(n.init)||(n.init=h),j})(i)}}("prototype",{}.hasOwnProperty),y=-1,z=1,A=x(q,function(a){a.insDirOf=function(a,b){return a===y?this.insertBefore(b.first()):this.insertAfter(b.last())},a.insAtDirEnd=function(a,b){return a===y?this.prependTo(b):this.appendTo(b)}}),B=x(function(a){a.parent=0,a[y]=0,a[z]=0,a.init=function(a,b,c){this.parent=a,this[y]=b,this[z]=c},this.copy=function(a){return B(a.parent,a[y],a[z])}}),C=x(function(a){function b(){return d+=1}a[y]=0,a[z]=0,a.parent=0;var d=0;this.byId={},a.init=function(){this.id=b(),C.byId[this.id]=this,this.ends={},this.ends[y]=0,this.ends[z]=0},a.dispose=function(){delete C.byId[this.id]},a.toString=function(){return"{{ MathQuill Node #"+this.id+" }}"},a.jQ=A(),a.jQadd=function(a){return this.jQ=this.jQ.add(a)},a.jQize=function(a){function b(a){if(a.getAttribute){var c=a.getAttribute("mathquill-command-id"),d=a.getAttribute("mathquill-block-id");c&&C.byId[c].jQadd(a),d&&C.byId[d].jQadd(a)}for(a=a.firstChild;a;a=a.nextSibling)b(a)}for(var a=A(a||this.html()),c=0;c<a.length;c+=1)b(a[c]);return a},a.createDir=function(a,b){f(a);var c=this;return c.jQize(),c.jQ.insDirOf(a,b.jQ),b[a]=c.adopt(b.parent,b[y],b[z]),c},a.createLeftOf=function(a){return this.createDir(y,a)},a.selectChildren=function(a,b){return H(a,b)},a.bubble=c(function(a){for(var b=this;b;b=b.parent){var c=a(b);if(c===!1)break}return this}),a.postOrder=c(function(a){return function b(c){c.eachChild(b),a(c)}(this),this}),a.isEmpty=function(){return 0===this.ends[y]&&0===this.ends[z]},a.children=function(){return D(this.ends[y],this.ends[z])},a.eachChild=function(){var a=this.children();return a.each.apply(a,arguments),this},a.foldChildren=function(a,b){return this.children().fold(a,b)},a.withDirAdopt=function(a,b,c,d){return D(this,this).withDirAdopt(a,b,c,d),this},a.adopt=function(a,b,c){return D(this,this).adopt(a,b,c),this},a.disown=function(){return D(this,this).disown(),this},a.remove=function(){return this.jQ.remove(),this.postOrder("dispose"),this.disown()}}),D=x(function(a){a.init=function(a,b,c){if(c===p&&(c=y),f(c),e("no half-empty fragments",!a==!b),this.ends={},a){e("withDir is passed to Fragment",a instanceof C),e("oppDir is passed to Fragment",b instanceof C),e("withDir and oppDir have the same parent",a.parent===b.parent),this.ends[c]=a,this.ends[-c]=b;var d=this.fold([],function(a,b){return a.push.apply(a,b.jQ.get()),a});this.jQ=this.jQ.add(d)}},a.jQ=A(),a.withDirAdopt=function(a,b,c,d){return a===y?this.adopt(b,c,d):this.adopt(b,d,c)},a.adopt=function(a,b,c){g(a,b,c);var d=this;d.disowned=!1;var e=d.ends[y];if(!e)return this;var f=d.ends[z];return b||(a.ends[y]=e),c?c[y]=f:a.ends[z]=f,d.ends[z][z]=c,d.each(function(c){c[y]=b,c.parent=a,b&&(b[z]=c),b=c}),d},a.disown=function(){var a=this,b=a.ends[y];if(!b||a.disowned)return a;a.disowned=!0;var c=a.ends[z],d=b.parent;return g(d,b[y],b),g(d,c,c[z]),b[y]?b[y][z]=c[z]:d.ends[y]=c[z],c[z]?c[z][y]=b[y]:d.ends[z]=b[y],a},a.remove=function(){return this.jQ.remove(),this.each("postOrder","dispose"),this.disown()},a.each=c(function(a){var b=this,c=b.ends[y];if(!c)return b;for(;c!==b.ends[z][z];c=c[z]){var d=a(c);if(d===!1)break}return b}),a.fold=function(a,b){return this.each(function(c){a=b.call(this,a,c)}),a}}),E={},F={},G=x(B,function(a){a.init=function(a,b){this.parent=a,this.options=b;var c=this.jQ=this._jQ=A('<span class="mq-cursor">&#8203;</span>');this.blink=function(){c.toggleClass("mq-blink")},this.upDownCache={}},a.show=function(){return this.jQ=this._jQ.removeClass("mq-blink"),"intervalId"in this?clearInterval(this.intervalId):(this[z]?this.selection&&this.selection.ends[y][y]===this[y]?this.jQ.insertBefore(this.selection.jQ):this.jQ.insertBefore(this[z].jQ.first()):this.jQ.appendTo(this.parent.jQ),this.parent.focus()),this.intervalId=setInterval(this.blink,500),this},a.hide=function(){return"intervalId"in this&&clearInterval(this.intervalId),delete this.intervalId,this.jQ.detach(),this.jQ=A(),this},a.withDirInsertAt=function(a,b,c,d){var e=this.parent;this.parent=b,this[a]=c,this[-a]=d,e!==b&&e.blur&&e.blur(this)},a.insDirOf=function(a,b){return f(a),this.jQ.insDirOf(a,b.jQ),this.withDirInsertAt(a,b.parent,b[a],b),this.parent.jQ.addClass("mq-hasCursor"),this},a.insLeftOf=function(a){return this.insDirOf(y,a)},a.insRightOf=function(a){return this.insDirOf(z,a)},a.insAtDirEnd=function(a,b){return f(a),this.jQ.insAtDirEnd(a,b.jQ),this.withDirInsertAt(a,b,0,b.ends[a]),b.focus(),this},a.insAtLeftEnd=function(a){return this.insAtDirEnd(y,a)},a.insAtRightEnd=function(a){return this.insAtDirEnd(z,a)},a.jumpUpDown=function(a,b){var c=this;c.upDownCache[a.id]=B.copy(c);
var d=c.upDownCache[b.id];if(d)d[z]?c.insLeftOf(d[z]):c.insAtRightEnd(d.parent);else{var e=c.offset().left;b.seek(e,c)}},a.offset=function(){var a=this,b=a.jQ.removeClass("mq-cursor").offset();return a.jQ.addClass("mq-cursor"),b},a.unwrapGramp=function(){var a=this.parent.parent,b=a.parent,c=a[z],d=this,e=a[y];if(a.disown().eachChild(function(d){d.isEmpty()||(d.children().adopt(b,e,c).each(function(b){b.jQ.insertBefore(a.jQ.first())}),e=d.ends[z])}),!this[z])if(this[y])this[z]=this[y][z];else for(;!this[z];){if(this.parent=this.parent[z],!this.parent){this[z]=a[z],this.parent=b;break}this[z]=this.parent.ends[y]}this[z]?this.insLeftOf(this[z]):this.insAtRightEnd(b),a.jQ.remove(),a[y].siblingDeleted&&a[y].siblingDeleted(d.options,z),a[z].siblingDeleted&&a[z].siblingDeleted(d.options,y)},a.startSelection=function(){for(var a=this.anticursor=B.copy(this),b=a.ancestors={},c=a;c.parent;c=c.parent)b[c.parent.id]=c},a.endSelection=function(){delete this.anticursor},a.select=function(){var a=this.anticursor;if(this[y]===a[y]&&this.parent===a.parent)return!1;for(var b=this;b.parent;b=b.parent)if(b.parent.id in a.ancestors){var c=b.parent;break}e("cursor and anticursor in the same tree",c);var d,f,g=a.ancestors[c.id],h=z;if(b[y]!==g)for(var i=b;i;i=i[z])if(i[z]===g[z]){h=y,d=b,f=g;break}return h===z&&(d=g,f=b),d instanceof B&&(d=d[z]),f instanceof B&&(f=f[y]),this.hide().selection=c.selectChildren(d,f),this.insDirOf(h,this.selection.ends[h]),this.selectionChanged(),!0},a.clearSelection=function(){return this.selection&&(this.selection.clear(),delete this.selection,this.selectionChanged()),this},a.deleteSelection=function(){this.selection&&(this[y]=this.selection.ends[y][y],this[z]=this.selection.ends[z][z],this.selection.remove(),this.selectionChanged(),delete this.selection)},a.replaceSelection=function(){var a=this.selection;return a&&(this[y]=a.ends[y][y],this[z]=a.ends[z][z],delete this.selection),a}}),H=x(D,function(a,b){a.init=function(){b.init.apply(this,arguments),this.jQ=this.jQ.wrapAll('<span class="mq-selection"></span>').parent()},a.adopt=function(){return this.jQ.replaceWith(this.jQ=this.jQ.children()),b.adopt.apply(this,arguments)},a.clear=function(){return this.jQ.replaceWith(this.jQ[0].childNodes),this},a.join=function(a){return this.fold("",function(b,c){return b+c[a]()})}}),I=x(function(a){a.init=function(a,b,c){this.id=a.id,this.data={},this.root=a,this.container=b,this.options=c,a.controller=this,this.cursor=a.cursor=G(a,c)},a.handle=function(a,b){var c=this.options.handlers;if(c&&c.fns[a]){var d=c.APIClasses[this.KIND_OF_MQ](this);b===y||b===z?c.fns[a](b,d):c.fns[a](d)}};var b=[];this.onNotify=function(a){b.push(a)},a.notify=function(){for(var a=0;a<b.length;a+=1)b[a].apply(this.cursor,arguments);return this}}),J={},K=x(),L={},M=x(),N={};i.prototype=M.p,i.interfaceVersion=function(a){if(1!==a)throw"Only interface version 1 supported. You specified: "+a;return h=function(){window.console&&console.warn('You called MathQuill.interfaceVersion(1); to specify the interface version, which will fail in v1.0.0. You can fix this easily by doing this before doing anything else:\n\n    MathQuill = MathQuill.getInterface(1);\n    // now MathQuill.MathField() works like it used to\n\nSee also the "`dev` branch (2014–2015) → v0.10.0 Migration Guide" at\n  https://github.com/mathquill/mathquill/wiki/%60dev%60-branch-(2014%E2%80%932015)-%E2%86%92-v0.10.0-Migration-Guide')},h(),i},i.getInterface=j;var O=j.MIN=1,P=j.MAX=2;i.noConflict=function(){return window.MathQuill=Q,i};var Q=window.MathQuill;window.MathQuill=i;var R=x(function(a,b,c){function d(a,b){throw a=a?"'"+a+"'":"EOF","Parse Error: "+b+" at "+a}a.init=function(a){this._=a},a.parse=function(a){function b(a,b){return b}return this.skip(h)._(""+a,b,d)},a.or=function(a){e("or is passed a parser",a instanceof c);var b=this;return c(function(c,d,e){function f(b){return a._(c,d,e)}return b._(c,d,f)})},a.then=function(a){var b=this;return c(function(d,f,g){function h(b,d){var h=a instanceof c?a:a(d);return e("a parser is returned",h instanceof c),h._(b,f,g)}return b._(d,h,g)})},a.many=function(){var a=this;return c(function(b,c,d){function e(a,c){return b=a,g.push(c),!0}function f(){return!1}for(var g=[];a._(b,e,f););return c(b,g)})},a.times=function(a,b){arguments.length<2&&(b=a);var d=this;return c(function(c,e,f){function g(a,b){return k.push(b),c=a,!0}function h(a,b){return j=b,c=a,!1}function i(a,b){return!1}for(var j,k=[],l=!0,m=0;m<a;m+=1)if(l=d._(c,g,h),!l)return f(c,j);for(;m<b&&l;m+=1)l=d._(c,g,i);return e(c,k)})},a.result=function(a){return this.then(g(a))},a.atMost=function(a){return this.times(0,a)},a.atLeast=function(a){var b=this;return b.times(a).then(function(a){return b.many().map(function(b){return a.concat(b)})})},a.map=function(a){return this.then(function(b){return g(a(b))})},a.skip=function(a){return this.then(function(b){return a.result(b)})};var f=(this.string=function(a){var b=a.length,d="expected '"+a+"'";return c(function(c,e,f){var g=c.slice(0,b);return g===a?e(c.slice(b),g):f(c,d)})},this.regex=function(a){e("regexp parser is anchored","^"===a.toString().charAt(1));var b="expected "+a;return c(function(c,d,e){var f=a.exec(c);if(f){var g=f[0];return d(c.slice(g.length),g)}return e(c,b)})}),g=c.succeed=function(a){return c(function(b,c){return c(b,a)})},h=(c.fail=function(a){return c(function(b,c,d){return d(b,a)})},c.letter=f(/^[a-z]/i),c.letters=f(/^[a-z]*/i),c.digit=f(/^[0-9]/),c.digits=f(/^[0-9]*/),c.whitespace=f(/^\s+/),c.optWhitespace=f(/^\s*/),c.any=c(function(a,b,c){return a?b(a.slice(1),a.charAt(0)):c(a,"expected any character")}),c.all=c(function(a,b,c){return b("",a)}),c.eof=c(function(a,b,c){return a?c(a,"expected EOF"):b(a,a)}))}),S=function(){function b(a){var b,d=a.which||a.keyCode,e=c[d],f=[];return a.ctrlKey&&f.push("Ctrl"),a.originalEvent&&a.originalEvent.metaKey&&f.push("Meta"),a.altKey&&f.push("Alt"),a.shiftKey&&f.push("Shift"),b=e||String.fromCharCode(d),f.length||e?(f.push(b),f.join("-")):b}var c={8:"Backspace",9:"Tab",10:"Enter",13:"Enter",16:"Shift",17:"Control",18:"Alt",20:"CapsLock",27:"Esc",32:"Spacebar",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",45:"Insert",46:"Del",144:"NumLock"};return function(c,d){function e(a){u=a,clearTimeout(o),o=setTimeout(a)}function f(b){u(),u=a,clearTimeout(o),s.val(b),b&&s[0].select&&s[0].select(),v=!!b}function g(){var a=s[0];return"selectionStart"in a&&a.selectionStart!==a.selectionEnd}function h(){d.keystroke(b(p),p)}function i(b){p=b,r=null,v&&e(function(b){b&&"focusout"===b.type||!s[0].select||s[0].select(),u=a,clearTimeout(o)}),h()}function j(a){p&&r&&h(),r=a,e(k)}function k(){if(!g()){var a=s.val();1===a.length?(s.val(""),d.typedText(a)):a&&s[0].select&&s[0].select()}}function l(){p=r=null}function m(a){s.focus(),e(n)}function n(){var a=s.val();s.val(""),a&&d.paste(a)}var o,p=null,r=null,s=q(c),t=q(d.container||s),u=a;t.bind("keydown keypress input keyup focusout paste",function(a){u(a)});var v=!1;return t.bind({keydown:i,keypress:j,focusout:l,paste:m}),{select:f}}}();I.open(function(a,b){a.exportText=function(){return this.root.foldChildren("",function(a,b){return a+b.text()})}}),I.open(function(a){a.focusBlurEvents=function(){function a(){clearTimeout(c),f.selection&&f.selection.jQ.addClass("mq-blur"),b()}function b(){f.hide().parent.blur(),d.container.removeClass("mq-focused"),A(window).off("blur",a)}var c,d=this,e=d.root,f=d.cursor;d.textarea.focus(function(){d.blurred=!1,clearTimeout(c),d.container.addClass("mq-focused"),f.parent||f.insAtRightEnd(e),f.selection?(f.selection.jQ.removeClass("mq-blur"),d.selectionChanged()):f.show()}).blur(function(){d.blurred=!0,c=setTimeout(function(){e.postOrder("intentionalBlur"),f.clearSelection().endSelection(),b()}),A(window).on("blur",a)}),d.blurred=!0,f.hide().parent.blur()}}),I.open(function(a){a.keystroke=function(a,b){this.cursor.parent.keystroke(a,b,this)}}),C.open(function(a){a.keystroke=function(a,b,c){var d=c.cursor;switch(a){case"Ctrl-Shift-Backspace":case"Ctrl-Backspace":c.ctrlDeleteDir(y);break;case"Shift-Backspace":case"Backspace":c.backspace();break;case"Esc":case"Tab":return void c.escapeDir(z,a,b);case"Shift-Tab":case"Shift-Esc":return void c.escapeDir(y,a,b);case"End":c.notify("move").cursor.insAtRightEnd(d.parent);break;case"Ctrl-End":c.notify("move").cursor.insAtRightEnd(c.root);break;case"Shift-End":for(;d[z];)c.selectRight();break;case"Ctrl-Shift-End":for(;d[z]||d.parent!==c.root;)c.selectRight();break;case"Home":c.notify("move").cursor.insAtLeftEnd(d.parent);break;case"Ctrl-Home":c.notify("move").cursor.insAtLeftEnd(c.root);break;case"Shift-Home":for(;d[y];)c.selectLeft();break;case"Ctrl-Shift-Home":for(;d[y]||d.parent!==c.root;)c.selectLeft();break;case"Left":c.moveLeft();break;case"Shift-Left":c.selectLeft();break;case"Ctrl-Left":break;case"Right":c.moveRight();break;case"Shift-Right":c.selectRight();break;case"Ctrl-Right":break;case"Up":c.moveUp();break;case"Down":c.moveDown();break;case"Shift-Up":if(d[y])for(;d[y];)c.selectLeft();else c.selectLeft();case"Shift-Down":if(d[z])for(;d[z];)c.selectRight();else c.selectRight();case"Ctrl-Up":break;case"Ctrl-Down":break;case"Ctrl-Shift-Del":case"Ctrl-Del":c.ctrlDeleteDir(z);break;case"Shift-Del":case"Del":c.deleteForward();break;case"Meta-A":case"Ctrl-A":for(c.notify("move").cursor.insAtRightEnd(c.root);d[y];)c.selectLeft();break;default:return}b.preventDefault(),c.scrollHoriz()},a.moveOutOf=a.moveTowards=a.deleteOutOf=a.deleteTowards=a.unselectInto=a.selectOutOf=a.selectTowards=function(){e("overridden or never called on this node")}}),I.open(function(a){function b(a,b){var c=a.notify("upDown").cursor,d=b+"Into",e=b+"OutOf";return c[z][d]?c.insAtLeftEnd(c[z][d]):c[y][d]?c.insAtRightEnd(c[y][d]):c.parent.bubble(function(a){var b=a[e];if(b&&("function"==typeof b&&(b=a[e](c)),b instanceof C&&c.jumpUpDown(a,b),b!==!0))return!1}),a}this.onNotify(function(a){"move"!==a&&"upDown"!==a||this.show().clearSelection()}),a.escapeDir=function(a,b,c){f(a);var d=this.cursor;if(d.parent!==this.root&&c.preventDefault(),d.parent!==this.root)return d.parent.moveOutOf(a,d),this.notify("move")},L.leftRightIntoCmdGoes=function(a){if(a&&"up"!==a&&"down"!==a)throw'"up" or "down" required for leftRightIntoCmdGoes option, got "'+a+'"';return a},a.moveDir=function(a){f(a);var b=this.cursor,c=b.options.leftRightIntoCmdGoes;return b.selection?b.insDirOf(a,b.selection.ends[a]):b[a]?b[a].moveTowards(a,b,c):b.parent.moveOutOf(a,b,c),this.notify("move")},a.moveLeft=function(){return this.moveDir(y)},a.moveRight=function(){return this.moveDir(z)},a.moveUp=function(){return b(this,"up")},a.moveDown=function(){return b(this,"down")},this.onNotify(function(a){"upDown"!==a&&(this.upDownCache={})}),this.onNotify(function(a){"edit"===a&&this.show().deleteSelection()}),a.deleteDir=function(a){f(a);var b=this.cursor,c=b.selection;return this.notify("edit"),c||(b[a]?b[a].deleteTowards(a,b):b.parent.deleteOutOf(a,b)),b[y].siblingDeleted&&b[y].siblingDeleted(b.options,z),b[z].siblingDeleted&&b[z].siblingDeleted(b.options,y),b.parent.bubble("reflow"),this},a.ctrlDeleteDir=function(a){f(a);var b=this.cursor;return!b[y]||b.selection?ctrlr.deleteDir():(this.notify("edit"),D(b.parent.ends[y],b[y]).remove(),b.insAtDirEnd(y,b.parent),b[y].siblingDeleted&&b[y].siblingDeleted(b.options,z),b[z].siblingDeleted&&b[z].siblingDeleted(b.options,y),b.parent.bubble("reflow"),this)},a.backspace=function(){return this.deleteDir(y)},a.deleteForward=function(){return this.deleteDir(z)},this.onNotify(function(a){"select"!==a&&this.endSelection()}),a.selectDir=function(a){var b=this.notify("select").cursor,c=b.selection;f(a),b.anticursor||b.startSelection();var d=b[a];d?c&&c.ends[a]===d&&b.anticursor[-a]!==d?d.unselectInto(a,b):d.selectTowards(a,b):b.parent.selectOutOf(a,b),b.clearSelection(),b.select()||b.show()},a.selectLeft=function(){return this.selectDir(y)},a.selectRight=function(){return this.selectDir(z)}});var T=function(){function a(a){var b=Z();return a.adopt(b,0,0),b}function b(a){for(var b=a[0]||Z(),c=1;c<a.length;c+=1)a[c].children().adopt(b,b.ends[z],0);return b}var c=R.string,d=R.regex,e=R.letter,f=R.any,g=R.optWhitespace,h=R.succeed,i=R.fail,j=e.map(function(a){return fa(a)}),k=d(/^[^${}\\_^]/).map(function(a){return X(a)}),l=d(/^[^\\a-eg-zA-Z]/).or(c("\\").then(d(/^[a-z]+/i).or(d(/^\s+/).result(" ")).or(f))).then(function(a){var b=E[a];return b?b(a).parser():i("unknown command: \\"+a)}),m=l.or(j).or(k),n=c("{").then(function(){return p}).skip(c("}")),o=g.then(n.or(m.map(a))),p=o.many().map(b).skip(g),q=c("[").then(o.then(function(a){return"]"!==a.join("latex")?h(a):i()}).many().map(b).skip(g)).skip(c("]")),r=p;return r.block=o,r.optBlock=q,r}();I.open(function(a,b){a.exportLatex=function(){return this.root.latex().replace(/(\\[a-z]+) (?![a-z])/gi,"$1")},a.writeLatex=function(a){var b=this.notify("edit").cursor,c=R.all,d=R.eof,e=T.skip(d).or(c.result(!1)).parse(a);if(e&&!e.isEmpty()){e.children().adopt(b.parent,b[y],b[z]);var f=e.jQize();f.insertBefore(b.jQ),b[y]=e.ends[z],e.finalizeInsert(b.options,b),e.ends[z][z].siblingCreated&&e.ends[z][z].siblingCreated(b.options,y),e.ends[y][y].siblingCreated&&e.ends[y][y].siblingCreated(b.options,z),b.parent.bubble("reflow")}return this},a.renderLatexMath=function(a){var b=this.root,c=this.cursor,d=R.all,e=R.eof,f=T.skip(e).or(d.result(!1)).parse(a);b.eachChild("postOrder","dispose"),b.ends[y]=b.ends[z]=0,f&&f.children().adopt(b,0,0);var g=b.jQ;if(f){var h=f.join("html");g.html(h),b.jQize(g.children()),b.finalizeInsert(c.options)}else g.empty();delete c.selection,c.insAtRightEnd(b)},a.renderLatexText=function(a){var b=this.root,c=this.cursor;b.jQ.children().slice(1).remove(),b.eachChild("postOrder","dispose"),b.ends[y]=b.ends[z]=0,delete c.selection,c.show().insAtRightEnd(b);var d=R.regex,e=R.string,f=R.eof,g=R.all,h=e("$").then(T).skip(e("$").or(f)).map(function(a){var b=ba(c);b.createBlocks();var d=b.ends[y];return a.children().adopt(d,0,0),b}),i=e("\\$").result("$"),j=i.or(d(/^[^$]/)).map(X),k=h.or(j).many(),l=k.skip(f).or(g.result(!1)).parse(a);if(l){for(var m=0;m<l.length;m+=1)l[m].adopt(b,b.ends[z],0);b.jQize().appendTo(b.jQ),b.finalizeInsert(c.options)}}}),I.open(function(b){K.p.ignoreNextMousedown=a,b.delegateMouseEvents=function(){var b=this.root.jQ;this.container.bind("mousedown.mathquill",function(c){function d(a){n=A(a.target)}function e(a){j.anticursor||j.startSelection(),i.seek(n,a.pageX,a.pageY).cursor.select(),n=p}function f(a){j.blink=k,j.selection||(i.editable?j.show():l.detach()),g.unbind("mousemove",d),A(a.target.ownerDocument).unbind("mousemove",e).unbind("mouseup",f)}var g=A(c.target).closest(".mq-root-block"),h=C.byId[g.attr(s)||b.attr(s)],i=h.controller,j=i.cursor,k=j.blink,l=i.textareaSpan,m=i.textarea;if(c.preventDefault(),c.target.unselectable=!0,!j.options.ignoreNextMousedown(c)){j.options.ignoreNextMousedown=a;var n;i.blurred&&(i.editable||g.prepend(l),m.focus()),j.blink=a,i.seek(A(c.target),c.pageX,c.pageY).cursor.startSelection(),g.mousemove(d),A(c.target.ownerDocument).mousemove(e).mouseup(f)}})}}),I.open(function(a){a.seek=function(a,b,c){var d=this.notify("select").cursor;if(a){var f=a.attr(s)||a.attr(r);if(!f){var g=a.parent();f=g.attr(s)||g.attr(r)}}var h=f?C.byId[f]:this.root;return e("nodeId is the id of some Node that exists",h),d.clearSelection().show(),h.seek(b,d),this.scrollHoriz(),this}}),I.open(function(a){a.scrollHoriz=function(){var a=this.cursor,b=a.selection,c=this.root.jQ[0].getBoundingClientRect();if(b){var d=b.jQ[0].getBoundingClientRect(),e=d.left-(c.left+20),f=d.right-(c.right-20);if(b.ends[y]===a[z])if(e<0)var g=e;else{if(!(f>0))return;if(d.left-f<c.left+20)var g=e;else var g=f}else if(f>0)var g=f;else{if(!(e<0))return;if(d.right-e>c.right-20)var g=f;else var g=e}}else{var h=a.jQ[0].getBoundingClientRect().left;if(h>c.right-20)var g=h-(c.right-20);else{if(!(h<c.left+20))return;var g=h-(c.left+20)}}this.root.jQ.stop().animate({scrollLeft:"+="+g},100)}}),I.open(function(a){K.p.substituteTextarea=function(){return A("<textarea autocapitalize=off autocomplete=off autocorrect=off spellcheck=false x-palm-disable-ste-all=true />")[0]},a.createTextarea=function(){var a=this.textareaSpan=A('<span class="mq-textarea"></span>'),b=this.options.substituteTextarea();if(!b.nodeType)throw"substituteTextarea() must return a DOM element, got "+b;b=this.textarea=A(b).appendTo(a);var c=this;c.cursor.selectionChanged=function(){c.selectionChanged()},c.container.bind("copy",function(){c.setTextareaSelection()})},a.selectionChanged=function(){var a=this;ua(a.container[0]),a.textareaSelectionTimeout===p&&(a.textareaSelectionTimeout=setTimeout(function(){a.setTextareaSelection()}))},a.setTextareaSelection=function(){this.textareaSelectionTimeout=p;var a="";this.cursor.selection&&(a=this.cursor.selection.join("latex"),this.options.statelessClipboard&&(a="$"+a+"$")),this.selectFn(a)},a.staticMathTextareaEvents=function(){function a(){e.detach(),b.blurred=!0}var b=this,c=(b.root,b.cursor),d=b.textarea,e=b.textareaSpan;this.container.prepend('<span class="mq-selectable">$'+b.exportLatex()+"$</span>"),b.blurred=!0,d.bind("cut paste",!1).focus(function(){b.blurred=!1}).blur(function(){c.selection&&c.selection.clear(),setTimeout(a)}),b.selectFn=function(a){d.val(a),a&&d.select()}},a.editablesTextareaEvents=function(){var a=this,b=(a.root,a.cursor),c=a.textarea,d=a.textareaSpan,e=S(c,this);this.selectFn=function(a){e.select(a)},this.container.prepend(d).on("cut",function(c){b.selection&&setTimeout(function(){a.notify("edit"),b.parent.bubble("reflow")})}),this.focusBlurEvents()},a.typedText=function(a){if("\n"===a)return this.handle("enter");var b=this.notify().cursor;b.parent.write(b,a),this.scrollHoriz()},a.paste=function(a){this.options.statelessClipboard&&(a="$"===a.slice(0,1)&&"$"===a.slice(-1)?a.slice(1,-1):"\\text{"+a+"}"),this.writeLatex(a).cursor.show()}});var U=x(C,function(a,b){a.finalizeInsert=function(a,b){var c=this;c.postOrder("finalizeTree",a),c.postOrder("contactWeld",b),c.postOrder("blur"),c.postOrder("reflow"),c[z].siblingCreated&&c[z].siblingCreated(a,y),c[y].siblingCreated&&c[y].siblingCreated(a,z),c.bubble("reflow")}}),V=x(U,function(a,b){a.init=function(a,c,d){var e=this;b.init.call(e),e.ctrlSeq||(e.ctrlSeq=a),c&&(e.htmlTemplate=c),d&&(e.textTemplate=d)},a.replaces=function(a){a.disown(),this.replacedFragment=a},a.isEmpty=function(){return this.foldChildren(!0,function(a,b){return a&&b.isEmpty()})},a.parser=function(){var a=T.block,b=this;return a.times(b.numBlocks()).map(function(a){b.blocks=a;for(var c=0;c<a.length;c+=1)a[c].adopt(b,b.ends[z],0);return b})},a.createLeftOf=function(a){var c=this,d=c.replacedFragment;c.createBlocks(),b.createLeftOf.call(c,a),d&&(d.adopt(c.ends[y],0,0),d.jQ.appendTo(c.ends[y].jQ)),c.finalizeInsert(a.options),c.placeCursor(a)},a.createBlocks=function(){for(var a=this,b=a.numBlocks(),c=a.blocks=Array(b),d=0;d<b;d+=1){var e=c[d]=Z();e.adopt(a,a.ends[z],0)}},a.placeCursor=function(a){a.insAtRightEnd(this.foldChildren(this.ends[y],function(a,b){return a.isEmpty()?a:b}))},a.moveTowards=function(a,b,c){var d=c&&this[c+"Into"];b.insAtDirEnd(-a,d||this.ends[-a])},a.deleteTowards=function(a,b){this.isEmpty()?b[a]=this.remove()[a]:this.moveTowards(a,b,null)},a.selectTowards=function(a,b){b[-a]=this,b[a]=this[a]},a.selectChildren=function(){return H(this,this)},a.unselectInto=function(a,b){b.insAtDirEnd(-a,b.anticursor.ancestors[this.id])},a.seek=function(a,b){function c(a){var b={};return b[y]=a.jQ.offset().left,b[z]=b[y]+a.jQ.outerWidth(),b}var d=this,e=c(d);if(a<e[y])return b.insLeftOf(d);if(a>e[z])return b.insRightOf(d);var f=e[y];d.eachChild(function(g){var h=c(g);return a<h[y]?(a-f<h[y]-a?g[y]?b.insAtRightEnd(g[y]):b.insLeftOf(d):b.insAtLeftEnd(g),!1):a>h[z]?void(g[z]?f=h[z]:e[z]-a<a-h[z]?b.insRightOf(d):b.insAtRightEnd(g)):(g.seek(a,b),!1)})},a.numBlocks=function(){var a=this.htmlTemplate.match(/&\d+/g);return a?a.length:0},a.html=function(){var a=this,b=a.blocks,c=" mathquill-command-id="+a.id,d=a.htmlTemplate.match(/<[^<>]+>|[^<>]+/g);e("no unmatched angle brackets",d.join("")===this.htmlTemplate);for(var f=0,g=d[0];g;f+=1,g=d[f])if("/>"===g.slice(-2))d[f]=g.slice(0,-2)+c+"/>";else if("<"===g.charAt(0)){e("not an unmatched top-level close tag","/"!==g.charAt(1)),d[f]=g.slice(0,-1)+c+">";var h=1;do f+=1,g=d[f],e("no missing close tags",g),"</"===g.slice(0,2)?h-=1:"<"===g.charAt(0)&&"/>"!==g.slice(-2)&&(h+=1);while(h>0)}return d.join("").replace(/>&(\d+)/g,function(a,c){return" mathquill-block-id="+b[c].id+">"+b[c].join("html")})},a.latex=function(){return this.foldChildren(this.ctrlSeq,function(a,b){return a+"{"+(b.latex()||" ")+"}"})},a.textTemplate=[""],a.text=function(){var a=this,b=0;return a.foldChildren(a.textTemplate[b],function(c,d){b+=1;var e=d.text();return c&&"("===a.textTemplate[b]&&"("===e[0]&&")"===e.slice(-1)?c+e.slice(1,-1)+a.textTemplate[b]:c+d.text()+(a.textTemplate[b]||"")})}}),W=x(V,function(b,c){b.init=function(a,b,d){d||(d=a&&a.length>1?a.slice(1):a),c.init.call(this,a,b,[d])},b.parser=function(){return R.succeed(this)},b.numBlocks=function(){return 0},b.replaces=function(a){a.remove()},b.createBlocks=a,b.moveTowards=function(a,b){b.jQ.insDirOf(a,this.jQ),b[-a]=this,b[a]=this[a]},b.deleteTowards=function(a,b){b[a]=this.remove()[a]},b.seek=function(a,b){a-this.jQ.offset().left<this.jQ.outerWidth()/2?b.insLeftOf(this):b.insRightOf(this)},b.latex=function(){return this.ctrlSeq},b.text=function(){return this.textTemplate},b.placeCursor=a,b.isEmpty=function(){return!0}}),X=x(W,function(a,b){a.init=function(a,c){b.init.call(this,a,"<span>"+(c||a)+"</span>")}}),Y=x(W,function(a,b){a.init=function(a,c,d){b.init.call(this,a,'<span class="mq-binary-operator">'+c+"</span>",d)}}),Z=x(U,function(a,b){a.join=function(a){return this.foldChildren("",function(b,c){return b+c[a]()})},a.html=function(){return this.join("html")},a.latex=function(){return this.join("latex")},a.text=function(){return this.ends[y]===this.ends[z]&&0!==this.ends[y]?this.ends[y].text():this.join("text")},a.keystroke=function(a,c,d){return!d.options.spaceBehavesLikeTab||"Spacebar"!==a&&"Shift-Spacebar"!==a?b.keystroke.apply(this,arguments):(c.preventDefault(),void d.escapeDir("Shift-Spacebar"===a?y:z,a,c))},a.moveOutOf=function(a,b,c){var d=c&&this.parent[c+"Into"];!d&&this[a]?b.insAtDirEnd(-a,this[a]):b.insDirOf(a,this.parent)},a.selectOutOf=function(a,b){b.insDirOf(a,this.parent)},a.deleteOutOf=function(a,b){b.unwrapGramp()},a.seek=function(a,b){var c=this.ends[z];if(!c||c.jQ.offset().left+c.jQ.outerWidth()<a)return b.insAtRightEnd(this);if(a<this.ends[y].jQ.offset().left)return b.insAtLeftEnd(this);for(;a<c.jQ.offset().left;)c=c[y];return c.seek(a,b)},a.chToCmd=function(a){var b;return a.match(/^[a-eg-zA-Z]$/)?fa(a):/^\d$/.test(a)?da(a):(b=F[a]||E[a])?b(a):X(a)},a.write=function(a,b){var c=this.chToCmd(b);a.selection&&c.replaces(a.replaceSelection()),c.createLeftOf(a.show())},a.focus=function(){return this.jQ.addClass("mq-hasCursor"),this.jQ.removeClass("mq-empty"),this},a.blur=function(){return this.jQ.removeClass("mq-hasCursor"),this.isEmpty()&&this.jQ.addClass("mq-empty"),this}});J.StaticMath=function(a){return x(a.AbstractMathQuill,function(b,c){this.RootBlock=Z,b.__mathquillify=function(){return c.__mathquillify.call(this,"mq-math-mode"),this.__controller.delegateMouseEvents(),this.__controller.staticMathTextareaEvents(),this},b.init=function(){c.init.apply(this,arguments),this.__controller.root.postOrder("registerInnerField",this.innerFields=[],a.MathField)},b.latex=function(){var b=c.latex.apply(this,arguments);return arguments.length>0&&this.__controller.root.postOrder("registerInnerField",this.innerFields=[],a.MathField),b}})};var $=x(Z,k);J.MathField=function(b){return x(b.EditableField,function(b,c){this.RootBlock=$,b.__mathquillify=function(b,d){return this.config(b),d>1&&(this.__controller.root.reflow=a),c.__mathquillify.call(this,"mq-editable-field mq-math-mode"),delete this.__controller.root.reflow,this}})};var _=x(C,function(a,b){function c(a){a.jQ[0].normalize();var b=a.jQ[0].firstChild;if(b){e("only node in TextBlock span is Text node",3===b.nodeType);var c=aa(b.data);return c.jQadd(b),a.children().disown(),c.adopt(a,0,0)}}a.ctrlSeq="\\text",a.replaces=function(a){a instanceof D?this.replacedText=a.remove().jQ.text():"string"==typeof a&&(this.replacedText=a)},a.jQadd=function(a){b.jQadd.call(this,a),this.ends[y]&&this.ends[y].jQadd(this.jQ[0].firstChild)},a.createLeftOf=function(a){var c=this;if(b.createLeftOf.call(this,a),c[z].siblingCreated&&c[z].siblingCreated(a.options,y),c[y].siblingCreated&&c[y].siblingCreated(a.options,z),c.bubble("reflow"),a.insAtRightEnd(c),c.replacedText)for(var d=0;d<c.replacedText.length;d+=1)c.write(a,c.replacedText.charAt(d))},a.parser=function(){var a=this,b=R.string,c=R.regex,d=R.optWhitespace;return d.then(b("{")).then(c(/^[^}]*/)).skip(b("}")).map(function(b){return 0===b.length?D():(aa(b).adopt(a,0,0),a)})},a.textContents=function(){return this.foldChildren("",function(a,b){return a+b.text})},a.text=function(){return'"'+this.textContents()+'"'},a.latex=function(){var a=this.textContents();return 0===a.length?"":"\\text{"+a+"}"},a.html=function(){return'<span class="mq-text-mode" mathquill-command-id='+this.id+">"+this.textContents()+"</span>"},a.moveTowards=function(a,b){b.insAtDirEnd(-a,this)},a.moveOutOf=function(a,b){b.insDirOf(a,this)},a.unselectInto=a.moveTowards,a.selectTowards=V.prototype.selectTowards,a.deleteTowards=V.prototype.deleteTowards,a.selectOutOf=function(a,b){b.insDirOf(a,this)},a.deleteOutOf=function(a,b){this.isEmpty()&&b.insRightOf(this)},a.write=function(a,c){if(a.show().deleteSelection(),"$"!==c)a[y]?a[y].appendText(c):aa(c).createLeftOf(a);else if(this.isEmpty())a.insRightOf(this),X("\\$","$").createLeftOf(a);else if(a[z])if(a[y]){var d=_(),e=this.ends[y];e.disown().jQ.detach(),e.adopt(d,0,0),a.insLeftOf(this),b.createLeftOf.call(d,a)}else a.insLeftOf(this);else a.insRightOf(this)},a.seek=function(a,b){b.hide();var d=c(this),e=this.jQ.width()/this.text.length,f=Math.round((a-this.jQ.offset().left)/e);f<=0?b.insAtLeftEnd(this):f>=d.text.length?b.insAtRightEnd(this):b.insLeftOf(d.splitRight(f));for(var g=a-b.show().offset().left,h=g&&g<0?y:z,i=h;b[h]&&g*i>0;)b[h].moveTowards(h,b),i=g,g=a-b.offset().left;if(h*g<-h*i&&b[-h].moveTowards(-h,b),b.anticursor){if(b.anticursor.parent===this){var j=b[y]&&b[y].text.length;if(this.anticursorPosition===j)b.anticursor=B.copy(b);else{if(this.anticursorPosition<j){var k=b[y].splitRight(this.anticursorPosition);b[y]=k}else var k=b[z].splitRight(this.anticursorPosition-j);b.anticursor=B(this,k[y],k)}}}else this.anticursorPosition=b[y]&&b[y].text.length},a.blur=function(a){Z.prototype.blur.call(this),a&&(""===this.textContents()?(this.remove(),a[y]===this?a[y]=this[y]:a[z]===this&&(a[z]=this[z])):c(this))},a.focus=Z.prototype.focus}),aa=x(C,function(a,b){function c(a,b){return b.charAt(a===y?0:-1+b.length)}a.init=function(a){b.init.call(this),this.text=a},a.jQadd=function(a){this.dom=a,this.jQ=A(a)},a.jQize=function(){return this.jQadd(document.createTextNode(this.text))},a.appendText=function(a){this.text+=a,this.dom.appendData(a)},a.prependText=function(a){this.text=a+this.text,this.dom.insertData(0,a)},a.insTextAtDirEnd=function(a,b){f(b),b===z?this.appendText(a):this.prependText(a)},a.splitRight=function(a){var b=aa(this.text.slice(a)).adopt(this.parent,this,this[z]);return b.jQadd(this.dom.splitText(a)),this.text=this.text.slice(0,a),b},a.moveTowards=function(a,b){f(a);var d=c(-a,this.text),e=this[-a];return e?e.insTextAtDirEnd(d,a):aa(d).createDir(-a,b),this.deleteTowards(a,b)},a.latex=function(){return this.text},a.deleteTowards=function(a,b){this.text.length>1?a===z?(this.dom.deleteData(0,1),this.text=this.text.slice(1)):(this.dom.deleteData(-1+this.text.length,1),this.text=this.text.slice(0,-1)):(this.remove(),this.jQ.remove(),b[a]=this[a])},a.selectTowards=function(a,b){f(a);var d=b.anticursor,e=c(-a,this.text);if(d[a]===this){var g=aa(e).createDir(a,b);d[a]=g,b.insDirOf(a,g)}else{var h=this[-a];if(h)h.insTextAtDirEnd(e,a);else{var g=aa(e).createDir(-a,b);g.jQ.insDirOf(-a,b.selection.jQ)}1===this.text.length&&d[-a]===this&&(d[-a]=this[-a])}return this.deleteTowards(a,b)}});F.$=E.text=E.textnormal=E.textrm=E.textup=E.textmd=_,E.em=E.italic=E.italics=E.emph=E.textit=E.textsl=l("\\textit","i",'class="mq-text-mode"'),E.strong=E.bold=E.textbf=l("\\textbf","b",'class="mq-text-mode"'),E.sf=E.textsf=l("\\textsf","span",'class="mq-sans-serif mq-text-mode"'),E.tt=E.texttt=l("\\texttt","span",'class="mq-monospace mq-text-mode"'),E.textsc=l("\\textsc","span",'style="font-variant:small-caps" class="mq-text-mode"'),E.uppercase=l("\\uppercase","span",'style="text-transform:uppercase" class="mq-text-mode"'),E.lowercase=l("\\lowercase","span",'style="text-transform:lowercase" class="mq-text-mode"');var ba=x(V,function(a,b){a.init=function(a){b.init.call(this,"$"),this.cursor=a},a.htmlTemplate='<span class="mq-math-mode">&0</span>',a.createBlocks=function(){b.createBlocks.call(this),this.ends[y].cursor=this.cursor,this.ends[y].write=function(a,b){"$"!==b?Z.prototype.write.call(this,a,b):this.isEmpty()?(a.insRightOf(this.parent),this.parent.deleteTowards(dir,a),X("\\$","$").createLeftOf(a.show())):a[z]?a[y]?Z.prototype.write.call(this,a,b):a.insLeftOf(this.parent):a.insRightOf(this.parent)}},a.latex=function(){return"$"+this.ends[y].latex()+"$"}}),ca=x($,function(a,b){a.keystroke=function(a){if("Spacebar"!==a&&"Shift-Spacebar"!==a)return b.keystroke.apply(this,arguments)},a.write=function(a,b){if(a.show().deleteSelection(),"$"===b)ba(a).createLeftOf(a);else{var c;"<"===b?c="&lt;":">"===b&&(c="&gt;"),X(b,c).createLeftOf(a)}}});J.TextField=function(a){return x(a.EditableField,function(a,b){this.RootBlock=ca,a.__mathquillify=function(){return b.__mathquillify.call(this,"mq-editable-field mq-text-mode")},a.latex=function(a){return arguments.length>0?(this.__controller.renderLatexText(a),this.__controller.blurred&&this.__controller.cursor.hide().parent.blur(),this):this.__controller.exportLatex()}})},E.notin=E.cong=E.equiv=E.oplus=E.otimes=x(Y,function(a,b){a.init=function(a){b.init.call(this,"\\"+a+" ","&"+a+";")}}),E["≠"]=E.ne=E.neq=d(Y,"\\ne ","&ne;"),E.ast=E.star=E.loast=E.lowast=d(Y,"\\ast ","&lowast;"),E.therefor=E.therefore=d(Y,"\\therefore ","&there4;"),E.cuz=E.because=d(Y,"\\because ","&#8757;"),E.prop=E.propto=d(Y,"\\propto ","&prop;"),E["≈"]=E.asymp=E.approx=d(Y,"\\approx ","&asymp;"),E.isin=E.in=d(Y,"\\in ","&isin;"),E.ni=E.contains=d(Y,"\\ni ","&ni;"),E.notni=E.niton=E.notcontains=E.doesnotcontain=d(Y,"\\not\\ni ","&#8716;"),E.sub=E.subset=d(Y,"\\subset ","&sub;"),E.sup=E.supset=E.superset=d(Y,"\\supset ","&sup;"),E.nsub=E.notsub=E.nsubset=E.notsubset=d(Y,"\\not\\subset ","&#8836;"),E.nsup=E.notsup=E.nsupset=E.notsupset=E.nsuperset=E.notsuperset=d(Y,"\\not\\supset ","&#8837;"),E.sube=E.subeq=E.subsete=E.subseteq=d(Y,"\\subseteq ","&sube;"),E.supe=E.supeq=E.supsete=E.supseteq=E.supersete=E.superseteq=d(Y,"\\supseteq ","&supe;"),E.nsube=E.nsubeq=E.notsube=E.notsubeq=E.nsubsete=E.nsubseteq=E.notsubsete=E.notsubseteq=d(Y,"\\not\\subseteq ","&#8840;"),E.nsupe=E.nsupeq=E.notsupe=E.notsupeq=E.nsupsete=E.nsupseteq=E.notsupsete=E.notsupseteq=E.nsupersete=E.nsuperseteq=E.notsupersete=E.notsuperseteq=d(Y,"\\not\\supseteq ","&#8841;"),E.N=E.naturals=E.Naturals=d(X,"\\mathbb{N}","&#8469;"),E.P=E.primes=E.Primes=E.projective=E.Projective=E.probability=E.Probability=d(X,"\\mathbb{P}","&#8473;"),E.Z=E.integers=E.Integers=d(X,"\\mathbb{Z}","&#8484;"),E.Q=E.rationals=E.Rationals=d(X,"\\mathbb{Q}","&#8474;"),E.R=E.reals=E.Reals=d(X,"\\mathbb{R}","&#8477;"),E.C=E.complex=E.Complex=E.complexes=E.Complexes=E.complexplane=E.Complexplane=E.ComplexPlane=d(X,"\\mathbb{C}","&#8450;"),E.H=E.Hamiltonian=E.quaternions=E.Quaternions=d(X,"\\mathbb{H}","&#8461;"),E.quad=E.emsp=d(X,"\\quad ","    "),E.qquad=d(X,"\\qquad ","        "),E.diamond=d(X,"\\diamond ","&#9671;"),E.bigtriangleup=d(X,"\\bigtriangleup ","&#9651;"),
E.ominus=d(X,"\\ominus ","&#8854;"),E.uplus=d(X,"\\uplus ","&#8846;"),E.bigtriangledown=d(X,"\\bigtriangledown ","&#9661;"),E.sqcap=d(X,"\\sqcap ","&#8851;"),E.triangleleft=d(X,"\\triangleleft ","&#8882;"),E.sqcup=d(X,"\\sqcup ","&#8852;"),E.triangleright=d(X,"\\triangleright ","&#8883;"),E.odot=E.circledot=d(X,"\\odot ","&#8857;"),E.bigcirc=d(X,"\\bigcirc ","&#9711;"),E.dagger=d(X,"\\dagger ","&#0134;"),E.ddagger=d(X,"\\ddagger ","&#135;"),E.wr=d(X,"\\wr ","&#8768;"),E.amalg=d(X,"\\amalg ","&#8720;"),E.models=d(X,"\\models ","&#8872;"),E.prec=d(X,"\\prec ","&#8826;"),E.succ=d(X,"\\succ ","&#8827;"),E.preceq=d(X,"\\preceq ","&#8828;"),E.succeq=d(X,"\\succeq ","&#8829;"),E.simeq=d(X,"\\simeq ","&#8771;"),E.mid=d(X,"\\mid ","&#8739;"),E.ll=d(X,"\\ll ","&#8810;"),E.gg=d(X,"\\gg ","&#8811;"),E.parallel=d(X,"\\parallel ","&#8741;"),E.nparallel=d(X,"\\nparallel ","&#8742;"),E.bowtie=d(X,"\\bowtie ","&#8904;"),E.sqsubset=d(X,"\\sqsubset ","&#8847;"),E.sqsupset=d(X,"\\sqsupset ","&#8848;"),E.smile=d(X,"\\smile ","&#8995;"),E.sqsubseteq=d(X,"\\sqsubseteq ","&#8849;"),E.sqsupseteq=d(X,"\\sqsupseteq ","&#8850;"),E.doteq=d(X,"\\doteq ","&#8784;"),E.frown=d(X,"\\frown ","&#8994;"),E.vdash=d(X,"\\vdash ","&#8870;"),E.dashv=d(X,"\\dashv ","&#8867;"),E.nless=d(X,"\\nless ","&#8814;"),E.ngtr=d(X,"\\ngtr ","&#8815;"),E.longleftarrow=d(X,"\\longleftarrow ","&#8592;"),E.longrightarrow=d(X,"\\longrightarrow ","&#8594;"),E.Longleftarrow=d(X,"\\Longleftarrow ","&#8656;"),E.Longrightarrow=d(X,"\\Longrightarrow ","&#8658;"),E.longleftrightarrow=d(X,"\\longleftrightarrow ","&#8596;"),E.updownarrow=d(X,"\\updownarrow ","&#8597;"),E.Longleftrightarrow=d(X,"\\Longleftrightarrow ","&#8660;"),E.Updownarrow=d(X,"\\Updownarrow ","&#8661;"),E.mapsto=d(X,"\\mapsto ","&#8614;"),E.nearrow=d(X,"\\nearrow ","&#8599;"),E.hookleftarrow=d(X,"\\hookleftarrow ","&#8617;"),E.hookrightarrow=d(X,"\\hookrightarrow ","&#8618;"),E.searrow=d(X,"\\searrow ","&#8600;"),E.leftharpoonup=d(X,"\\leftharpoonup ","&#8636;"),E.rightharpoonup=d(X,"\\rightharpoonup ","&#8640;"),E.swarrow=d(X,"\\swarrow ","&#8601;"),E.leftharpoondown=d(X,"\\leftharpoondown ","&#8637;"),E.rightharpoondown=d(X,"\\rightharpoondown ","&#8641;"),E.nwarrow=d(X,"\\nwarrow ","&#8598;"),E.ldots=d(X,"\\ldots ","&#8230;"),E.cdots=d(X,"\\cdots ","&#8943;"),E.vdots=d(X,"\\vdots ","&#8942;"),E.ddots=d(X,"\\ddots ","&#8945;"),E.surd=d(X,"\\surd ","&#8730;"),E.triangle=d(X,"\\triangle ","&#9651;"),E.ell=d(X,"\\ell ","&#8467;"),E.top=d(X,"\\top ","&#8868;"),E.flat=d(X,"\\flat ","&#9837;"),E.natural=d(X,"\\natural ","&#9838;"),E.sharp=d(X,"\\sharp ","&#9839;"),E.wp=d(X,"\\wp ","&#8472;"),E.bot=d(X,"\\bot ","&#8869;"),E.clubsuit=d(X,"\\clubsuit ","&#9827;"),E.diamondsuit=d(X,"\\diamondsuit ","&#9826;"),E.heartsuit=d(X,"\\heartsuit ","&#9825;"),E.spadesuit=d(X,"\\spadesuit ","&#9824;"),E.parallelogram=d(X,"\\parallelogram ","&#9649;"),E.square=d(X,"\\square ","&#11036;"),E.oint=d(X,"\\oint ","&#8750;"),E.bigcap=d(X,"\\bigcap ","&#8745;"),E.bigcup=d(X,"\\bigcup ","&#8746;"),E.bigsqcup=d(X,"\\bigsqcup ","&#8852;"),E.bigvee=d(X,"\\bigvee ","&#8744;"),E.bigwedge=d(X,"\\bigwedge ","&#8743;"),E.bigodot=d(X,"\\bigodot ","&#8857;"),E.bigotimes=d(X,"\\bigotimes ","&#8855;"),E.bigoplus=d(X,"\\bigoplus ","&#8853;"),E.biguplus=d(X,"\\biguplus ","&#8846;"),E.lfloor=d(X,"\\lfloor ","&#8970;"),E.rfloor=d(X,"\\rfloor ","&#8971;"),E.lceil=d(X,"\\lceil ","&#8968;"),E.rceil=d(X,"\\rceil ","&#8969;"),E.opencurlybrace=E.lbrace=d(X,"\\lbrace ","{"),E.closecurlybrace=E.rbrace=d(X,"\\rbrace ","}"),E.lbrack=d(X,"["),E.rbrack=d(X,"]"),E.slash=d(X,"/"),E.vert=d(X,"|"),E.perp=E.perpendicular=d(X,"\\perp ","&perp;"),E.nabla=E.del=d(X,"\\nabla ","&nabla;"),E.hbar=d(X,"\\hbar ","&#8463;"),E.AA=E.Angstrom=E.angstrom=d(X,"\\text\\AA ","&#8491;"),E.ring=E.circ=E.circle=d(X,"\\circ ","&#8728;"),E.bull=E.bullet=d(X,"\\bullet ","&bull;"),E.setminus=E.smallsetminus=d(X,"\\setminus ","&#8726;"),E.not=E["¬"]=E.neg=d(X,"\\neg ","&not;"),E["…"]=E.dots=E.ellip=E.hellip=E.ellipsis=E.hellipsis=d(X,"\\dots ","&hellip;"),E.converges=E.darr=E.dnarr=E.dnarrow=E.downarrow=d(X,"\\downarrow ","&darr;"),E.dArr=E.dnArr=E.dnArrow=E.Downarrow=d(X,"\\Downarrow ","&dArr;"),E.diverges=E.uarr=E.uparrow=d(X,"\\uparrow ","&uarr;"),E.uArr=E.Uparrow=d(X,"\\Uparrow ","&uArr;"),E.to=d(Y,"\\to ","&rarr;"),E.rarr=E.rightarrow=d(X,"\\rightarrow ","&rarr;"),E.implies=d(Y,"\\Rightarrow ","&rArr;"),E.rArr=E.Rightarrow=d(X,"\\Rightarrow ","&rArr;"),E.gets=d(Y,"\\gets ","&larr;"),E.larr=E.leftarrow=d(X,"\\leftarrow ","&larr;"),E.impliedby=d(Y,"\\Leftarrow ","&lArr;"),E.lArr=E.Leftarrow=d(X,"\\Leftarrow ","&lArr;"),E.harr=E.lrarr=E.leftrightarrow=d(X,"\\leftrightarrow ","&harr;"),E.iff=d(Y,"\\Leftrightarrow ","&hArr;"),E.hArr=E.lrArr=E.Leftrightarrow=d(X,"\\Leftrightarrow ","&hArr;"),E.Re=E.Real=E.real=d(X,"\\Re ","&real;"),E.Im=E.imag=E.image=E.imagin=E.imaginary=E.Imaginary=d(X,"\\Im ","&image;"),E.part=E.partial=d(X,"\\partial ","&part;"),E.infty=E.infin=E.infinity=d(X,"\\infty ","&infin;"),E.alef=E.alefsym=E.aleph=E.alephsym=d(X,"\\aleph ","&alefsym;"),E.xist=E.xists=E.exist=E.exists=d(X,"\\exists ","&exist;"),E.nexists=E.nexist=d(X,"\\nexists ","&#8708;"),E.and=E.land=E.wedge=d(X,"\\wedge ","&and;"),E.or=E.lor=E.vee=d(X,"\\vee ","&or;"),E.o=E.O=E.empty=E.emptyset=E.oslash=E.Oslash=E.nothing=E.varnothing=d(Y,"\\varnothing ","&empty;"),E.cup=E.union=d(Y,"\\cup ","&cup;"),E.cap=E.intersect=E.intersection=d(Y,"\\cap ","&cap;"),E.deg=E.degree=d(X,"\\degree ","&deg;"),E.ang=E.angle=d(X,"\\angle ","&ang;"),E.measuredangle=d(X,"\\measuredangle ","&#8737;");var da=x(X,function(a,b){a.createLeftOf=function(a){a.options.autoSubscriptNumerals&&a.parent!==a.parent.parent.sub&&(a[y]instanceof ea&&a[y].isItalic!==!1||a[y]instanceof Aa&&a[y][y]instanceof ea&&a[y][y].isItalic!==!1)?(E._().createLeftOf(a),b.createLeftOf.call(this,a),a.insRightOf(a.parent.parent)):b.createLeftOf.call(this,a)}}),ea=x(W,function(a,b){a.init=function(a,c){b.init.call(this,a,"<var>"+(c||a)+"</var>")},a.text=function(){var a=this.ctrlSeq;return!this[y]||this[y]instanceof ea||this[y]instanceof Y||"\\ "===this[y].ctrlSeq||(a="*"+a),!this[z]||this[z]instanceof Y||this[z]instanceof Aa||(a+="*"),a}});K.p.autoCommands={_maxLength:0},L.autoCommands=function(a){if(!/^[a-z]+(?: [a-z]+)*$/i.test(a))throw'"'+a+'" not a space-delimited list of only letters';for(var b=a.split(" "),c={},d=0,e=0;e<b.length;e+=1){var f=b[e];if(f.length<2)throw'autocommand "'+f+'" not minimum length of 2';if(E[f]===ja)throw'"'+f+'" is a built-in operator name';c[f]=1,d=u(d,f.length)}return c._maxLength=d,c};var fa=x(ea,function(a,b){function c(a){return!a||a instanceof Y||a instanceof Ba}a.init=function(a){return b.init.call(this,this.letter=a)},a.createLeftOf=function(a){b.createLeftOf.apply(this,arguments);var c=a.options.autoCommands,d=c._maxLength;if(d>0){for(var e="",f=this,g=0;f instanceof fa&&f.ctrlSeq===f.letter&&g<d;)e=f.letter+e,f=f[y],g+=1;for(;e.length;){if(c.hasOwnProperty(e)){for(var g=1,f=this;g<e.length;g+=1,f=f[y]);return D(f,this).remove(),a[y]=f[y],E[e](e).createLeftOf(a)}e=e.slice(1)}}},a.italicize=function(a){return this.isItalic=a,this.jQ.toggleClass("mq-operator-name",!a),this},a.finalizeTree=a.siblingDeleted=a.siblingCreated=function(a,b){b!==y&&this[z]instanceof fa||this.autoUnItalicize(a)},a.autoUnItalicize=function(a){var b=a.autoOperatorNames;if(0!==b._maxLength){for(var d=this.letter,e=this[y];e instanceof fa;e=e[y])d=e.letter+d;for(var f=this[z];f instanceof fa;f=f[z])d+=f.letter;D(e[z]||this.parent.ends[y],f[y]||this.parent.ends[z]).each(function(a){a.italicize(!0).jQ.removeClass("mq-first mq-last mq-followed-by-supsub"),a.ctrlSeq=a.letter});a:for(var g=0,h=e[z]||this.parent.ends[y];g<d.length;g+=1,h=h[z])for(var i=t(b._maxLength,d.length-g);i>0;i-=1){var j=d.slice(g,g+i);if(b.hasOwnProperty(j)){for(var k=0,l=h;k<i;k+=1,l=l[z]){l.italicize(!1);var m=l}var n=ga.hasOwnProperty(j);if(h.ctrlSeq=(n?"\\":"\\operatorname{")+h.ctrlSeq,m.ctrlSeq+=n?" ":"}",ia.hasOwnProperty(j)&&m[y][y][y].jQ.addClass("mq-last"),c(h[y])||h.jQ.addClass("mq-first"),!c(m[z]))if(m[z]instanceof Aa){var o=m[z],p=o.siblingCreated=o.siblingDeleted=function(){o.jQ.toggleClass("mq-after-operator-name",!(o[z]instanceof Ga))};p()}else m.jQ.toggleClass("mq-last",!(m[z]instanceof Ga));g+=i-1,h=m;continue a}}}}}),ga={},ha=K.p.autoOperatorNames={_maxLength:9},ia={limsup:1,liminf:1,projlim:1,injlim:1};!function(){for(var a="arg deg det dim exp gcd hom inf ker lg lim ln log max min sup limsup liminf injlim projlim Pr".split(" "),b=0;b<a.length;b+=1)ga[a[b]]=ha[a[b]]=1;for(var c="sin cos tan arcsin arccos arctan sinh cosh tanh sec csc cot coth".split(" "),b=0;b<c.length;b+=1)ga[c[b]]=1;for(var d="sin cos tan sec cosec csc cotan cot ctg".split(" "),b=0;b<d.length;b+=1)ha[d[b]]=ha["arc"+d[b]]=ha[d[b]+"h"]=ha["ar"+d[b]+"h"]=ha["arc"+d[b]+"h"]=1;for(var e="gcf hcf lcm proj span".split(" "),b=0;b<e.length;b+=1)ha[e[b]]=1}(),L.autoOperatorNames=function(a){if(!/^[a-z]+(?: [a-z]+)*$/i.test(a))throw'"'+a+'" not a space-delimited list of only letters';for(var b=a.split(" "),c={},d=0,e=0;e<b.length;e+=1){var f=b[e];if(f.length<2)throw'"'+f+'" not minimum length of 2';c[f]=1,d=u(d,f.length)}return c._maxLength=d,c};var ja=x(W,function(a,b){a.init=function(a){this.ctrlSeq=a},a.createLeftOf=function(a){for(var b=this.ctrlSeq,c=0;c<b.length;c+=1)fa(b.charAt(c)).createLeftOf(a)},a.parser=function(){for(var a=this.ctrlSeq,b=Z(),c=0;c<a.length;c+=1)fa(a.charAt(c)).adopt(b,b.ends[z],0);return R.succeed(b.children())}});for(var ka in ha)ha.hasOwnProperty(ka)&&(E[ka]=ja);E.operatorname=x(V,function(b){b.createLeftOf=a,b.numBlocks=function(){return 1},b.parser=function(){return T.block.map(function(a){return a.children()})}}),E.f=x(fa,function(a,b){a.init=function(){W.p.init.call(this,this.letter="f",'<var class="mq-f">f</var>')},a.italicize=function(a){return this.jQ.html("f").toggleClass("mq-f",a),b.italicize.apply(this,arguments)}}),E[" "]=E.space=d(X,"\\ ","&nbsp;"),E["'"]=E.prime=d(X,"'","&prime;"),E.backslash=d(X,"\\backslash ","\\"),F["\\"]||(F["\\"]=E.backslash),E.$=d(X,"\\$","$");var la=x(W,function(a,b){a.init=function(a,c){b.init.call(this,a,'<span class="mq-nonSymbola">'+(c||a)+"</span>")}});E["@"]=la,E["&"]=d(la,"\\&","&amp;"),E["%"]=d(la,"\\%","%"),E.alpha=E.beta=E.gamma=E.delta=E.zeta=E.eta=E.theta=E.iota=E.kappa=E.mu=E.nu=E.xi=E.rho=E.sigma=E.tau=E.chi=E.psi=E.omega=x(ea,function(a,b){a.init=function(a){b.init.call(this,"\\"+a+" ","&"+a+";")}}),E.phi=d(ea,"\\phi ","&#981;"),E.phiv=E.varphi=d(ea,"\\varphi ","&phi;"),E.epsilon=d(ea,"\\epsilon ","&#1013;"),E.epsiv=E.varepsilon=d(ea,"\\varepsilon ","&epsilon;"),E.piv=E.varpi=d(ea,"\\varpi ","&piv;"),E.sigmaf=E.sigmav=E.varsigma=d(ea,"\\varsigma ","&sigmaf;"),E.thetav=E.vartheta=E.thetasym=d(ea,"\\vartheta ","&thetasym;"),E.upsilon=E.upsi=d(ea,"\\upsilon ","&upsilon;"),E.gammad=E.Gammad=E.digamma=d(ea,"\\digamma ","&#989;"),E.kappav=E.varkappa=d(ea,"\\varkappa ","&#1008;"),E.rhov=E.varrho=d(ea,"\\varrho ","&#1009;"),E.pi=E["π"]=d(la,"\\pi ","&pi;"),E.lambda=d(la,"\\lambda ","&lambda;"),E.Upsilon=E.Upsi=E.upsih=E.Upsih=d(W,"\\Upsilon ",'<var style="font-family: serif">&upsih;</var>'),E.Gamma=E.Delta=E.Theta=E.Lambda=E.Xi=E.Pi=E.Sigma=E.Phi=E.Psi=E.Omega=E.forall=x(X,function(a,b){a.init=function(a){b.init.call(this,"\\"+a+" ","&"+a+";")}});var ma=x(V,function(a){a.init=function(a){this.latex=a},a.createLeftOf=function(a){var b=T.parse(this.latex);b.children().adopt(a.parent,a[y],a[z]),a[y]=b.ends[z],b.jQize().insertBefore(a.jQ),b.finalizeInsert(a.options,a),b.ends[z][z].siblingCreated&&b.ends[z][z].siblingCreated(a.options,y),b.ends[y][y].siblingCreated&&b.ends[y][y].siblingCreated(a.options,z),a.parent.bubble("reflow")},a.parser=function(){var a=T.parse(this.latex).children();return R.succeed(a)}});E["¹"]=d(ma,"^1"),E["²"]=d(ma,"^2"),E["³"]=d(ma,"^3"),E["¼"]=d(ma,"\\frac14"),E["½"]=d(ma,"\\frac12"),E["¾"]=d(ma,"\\frac34");var na=x(Y,function(a){a.init=X.prototype.init,a.contactWeld=a.siblingCreated=a.siblingDeleted=function(a,b){if(b!==z)return this.jQ[0].className=!this[y]||this[y]instanceof Y||/^[,;:\(\[]$/.test(this[y].ctrlSeq)?"":"mq-binary-operator",this}});E["+"]=d(na,"+","+"),E["–"]=E["-"]=d(na,"-","&minus;"),E["±"]=E.pm=E.plusmn=E.plusminus=d(na,"\\pm ","&plusmn;"),E.mp=E.mnplus=E.minusplus=d(na,"\\mp ","&#8723;"),F["*"]=E.sdot=E.cdot=d(Y,"\\cdot ","&middot;","*");var oa=x(Y,function(a,b){a.init=function(a,c){this.data=a,this.strict=c;var d=c?"Strict":"";b.init.call(this,a["ctrlSeq"+d],a["html"+d],a["text"+d])},a.swap=function(a){this.strict=a;var b=a?"Strict":"";this.ctrlSeq=this.data["ctrlSeq"+b],this.jQ.html(this.data["html"+b]),this.textTemplate=[this.data["text"+b]]},a.deleteTowards=function(a,c){return a!==y||this.strict?void b.deleteTowards.apply(this,arguments):(this.swap(!0),void this.bubble("reflow"))}}),pa={ctrlSeq:"\\le ",html:"&le;",text:"≤",ctrlSeqStrict:"<",htmlStrict:"&lt;",textStrict:"<"},qa={ctrlSeq:"\\ge ",html:"&ge;",text:"≥",ctrlSeqStrict:">",htmlStrict:"&gt;",textStrict:">"};E["<"]=E.lt=d(oa,pa,!0),E[">"]=E.gt=d(oa,qa,!0),E["≤"]=E.le=E.leq=d(oa,pa,!1),E["≥"]=E.ge=E.geq=d(oa,qa,!1);var ra=x(Y,function(a,b){a.init=function(){b.init.call(this,"=","=")},a.createLeftOf=function(a){return a[y]instanceof oa&&a[y].strict?(a[y].swap(!1),void a[y].bubble("reflow")):void b.createLeftOf.apply(this,arguments)}});E["="]=ra,E["×"]=E.times=d(Y,"\\times ","&times;","[x]"),E["÷"]=E.div=E.divide=E.divides=d(Y,"\\div ","&divide;","[/]"),F["~"]=E.sim=d(Y,"\\sim ","~","~");var sa,ta,ua=a,va=document.createElement("div"),wa=va.style,xa={transform:1,WebkitTransform:1,MozTransform:1,OTransform:1,msTransform:1};for(var ya in xa)if(ya in wa){ta=ya;break}ta?sa=function(a,b,c){a.css(ta,"scale("+b+","+c+")")}:"filter"in wa?(ua=function(a){a.className=a.className},sa=function(a,b,c){function d(){a.css("marginRight",(e.width()-1)*(b-1)/b+"px")}b/=1+(c-1)/2,a.css("fontSize",c+"em"),a.hasClass("mq-matrixed-container")||a.addClass("mq-matrixed-container").wrapInner('<span class="mq-matrixed"></span>');var e=a.children().css("filter","progid:DXImageTransform.Microsoft.Matrix(M11="+b+",SizingMethod='auto expand')");d();var f=setInterval(d);A(window).load(function(){clearTimeout(f),d()})}):sa=function(a,b,c){a.css("fontSize",c+"em")};var za=x(V,function(a,b){a.init=function(a,c,d){b.init.call(this,a,"<"+c+" "+d+">&0</"+c+">")}});E.mathrm=d(za,"\\mathrm","span",'class="mq-roman mq-font"'),E.mathit=d(za,"\\mathit","i",'class="mq-font"'),E.mathbf=d(za,"\\mathbf","b",'class="mq-font"'),E.mathsf=d(za,"\\mathsf","span",'class="mq-sans-serif mq-font"'),E.mathtt=d(za,"\\mathtt","span",'class="mq-monospace mq-font"'),E.underline=d(za,"\\underline","span",'class="mq-non-leaf mq-underline"'),E.overline=E.bar=d(za,"\\overline","span",'class="mq-non-leaf mq-overline"'),E.overrightarrow=d(za,"\\overrightarrow","span",'class="mq-non-leaf mq-overarrow mq-arrow-right"'),E.overleftarrow=d(za,"\\overleftarrow","span",'class="mq-non-leaf mq-overarrow mq-arrow-left"');var Aa=(E.textcolor=x(V,function(a,b){a.setColor=function(a){this.color=a,this.htmlTemplate='<span class="mq-textcolor" style="color:'+a+'">&0</span>'},a.latex=function(){return"\\textcolor{"+this.color+"}{"+this.blocks[0].latex()+"}"},a.parser=function(){var a=this,c=R.optWhitespace,d=R.string,e=R.regex;return c.then(d("{")).then(e(/^[#\w\s.,()%-]*/)).skip(d("}")).then(function(c){return a.setColor(c),b.parser.call(a)})}}),E.class=x(V,function(a,b){a.parser=function(){var a=this,c=R.string,d=R.regex;return R.optWhitespace.then(c("{")).then(d(/^[-\w\s\\\xA0-\xFF]*/)).skip(c("}")).then(function(c){return a.htmlTemplate='<span class="mq-class '+c+'">&0</span>',b.parser.call(a)})}}),x(V,function(a,b){a.ctrlSeq="_{...}^{...}",a.createLeftOf=function(a){if(a[y]||!a.options.supSubsRequireOperand)return b.createLeftOf.apply(this,arguments)},a.contactWeld=function(a){for(var b=y;b;b=b===y&&z)if(this[b]instanceof Aa){for(var c="sub";c;c="sub"===c&&"sup"){var d=this[c],e=this[b][c];if(d){if(e)if(d.isEmpty())var f=B(e,0,e.ends[y]);else{d.jQ.children().insAtDirEnd(-b,e.jQ);var g=d.children().disown(),f=B(e,g.ends[z],e.ends[y]);b===y?g.adopt(e,e.ends[z],0):g.adopt(e,0,e.ends[y])}else this[b].addBlock(d.disown());this.placeCursor=function(a,c){return function(d){d.insAtDirEnd(-b,a||c)}}(e,d)}}this.remove(),a&&a[y]===this&&(b===z&&f?f[y]?a.insRightOf(f[y]):a.insAtLeftEnd(f.parent):a.insRightOf(this[b]));break}},K.p.charsThatBreakOutOfSupSub="",a.finalizeTree=function(){this.ends[y].write=function(a,b){if(a.options.autoSubscriptNumerals&&this===this.parent.sub){if("_"===b)return;var c=this.chToCmd(b);return c instanceof W?a.deleteSelection():a.clearSelection().insRightOf(this.parent),c.createLeftOf(a.show())}a[y]&&!a[z]&&!a.selection&&a.options.charsThatBreakOutOfSupSub.indexOf(b)>-1&&a.insRightOf(this.parent),Z.p.write.apply(this,arguments)}},a.moveTowards=function(a,c,d){c.options.autoSubscriptNumerals&&!this.sup?c.insDirOf(a,this):b.moveTowards.apply(this,arguments)},a.deleteTowards=function(a,c){if(c.options.autoSubscriptNumerals&&this.sub){var d=this.sub.ends[-a];d instanceof W?d.remove():d&&d.deleteTowards(a,c.insAtDirEnd(-a,this.sub)),this.sub.isEmpty()&&(this.sub.deleteOutOf(y,c.insAtLeftEnd(this.sub)),this.sup&&c.insDirOf(-a,this))}else b.deleteTowards.apply(this,arguments)},a.latex=function(){function a(a,b){var c=b&&b.latex();return b?a+(1===c.length?c:"{"+(c||" ")+"}"):""}return a("_",this.sub)+a("^",this.sup)},a.addBlock=function(a){"sub"===this.supsub?(this.sup=this.upInto=this.sub.upOutOf=a,a.adopt(this,this.sub,0).downOutOf=this.sub,a.jQ=A('<span class="mq-sup"/>').append(a.jQ.children()).attr(s,a.id).prependTo(this.jQ)):(this.sub=this.downInto=this.sup.downOutOf=a,a.adopt(this,0,this.sup).upOutOf=this.sup,a.jQ=A('<span class="mq-sub"></span>').append(a.jQ.children()).attr(s,a.id).appendTo(this.jQ.removeClass("mq-sup-only")),this.jQ.append('<span style="display:inline-block;width:0">&#8203;</span>'));for(var b=0;b<2;b+=1)(function(a,b,c,d){a[b].deleteOutOf=function(e,f){if(f.insDirOf(this[e]?-e:e,this.parent),!this.isEmpty()){var g=this.ends[e];this.children().disown().withDirAdopt(e,f.parent,f[e],f[-e]).jQ.insDirOf(-e,f.jQ),f[-e]=g}a.supsub=c,delete a[b],delete a[d+"Into"],a[c][d+"OutOf"]=m,delete a[c].deleteOutOf,"sub"===b&&A(a.jQ.addClass("mq-sup-only")[0].lastChild).remove(),this.remove()}})(this,"sub sup".split(" ")[b],"sup sub".split(" ")[b],"down up".split(" ")[b])}}));E.subscript=E._=x(Aa,function(a,b){a.supsub="sub",a.htmlTemplate='<span class="mq-supsub mq-non-leaf"><span class="mq-sub">&0</span><span style="display:inline-block;width:0">&#8203;</span></span>',a.textTemplate=["_"],a.finalizeTree=function(){this.downInto=this.sub=this.ends[y],this.sub.upOutOf=m,b.finalizeTree.call(this)}}),E.superscript=E.supscript=E["^"]=x(Aa,function(a,b){a.supsub="sup",a.htmlTemplate='<span class="mq-supsub mq-non-leaf mq-sup-only"><span class="mq-sup">&0</span></span>',a.textTemplate=["^"],a.finalizeTree=function(){this.upInto=this.sup=this.ends[z],this.sup.downOutOf=m,b.finalizeTree.call(this)}});var Ba=x(V,function(a,b){a.init=function(a,b){var c='<span class="mq-large-operator mq-non-leaf"><span class="mq-to"><span>&1</span></span><big>'+b+'</big><span class="mq-from"><span>&0</span></span></span>';W.prototype.init.call(this,a,c)},a.createLeftOf=function(a){b.createLeftOf.apply(this,arguments),a.options.sumStartsWithNEquals&&(fa("n").createLeftOf(a),ra().createLeftOf(a))},a.latex=function(){function a(a){return 1===a.length?a:"{"+(a||" ")+"}"}return this.ctrlSeq+"_"+a(this.ends[y].latex())+"^"+a(this.ends[z].latex())},a.parser=function(){for(var a=R.string,b=R.optWhitespace,c=R.succeed,d=T.block,e=this,f=e.blocks=[Z(),Z()],g=0;g<f.length;g+=1)f[g].adopt(e,e.ends[z],0);return b.then(a("_").or(a("^"))).then(function(a){var b=f["_"===a?0:1];return d.then(function(a){return a.children().adopt(b,b.ends[z],0),c(e)})}).many().result(e)},a.finalizeTree=function(){this.downInto=this.ends[y],this.upInto=this.ends[z],this.ends[y].upOutOf=this.ends[z],this.ends[z].downOutOf=this.ends[y]}});E["∑"]=E.sum=E.summation=d(Ba,"\\sum ","&sum;"),E["∏"]=E.prod=E.product=d(Ba,"\\prod ","&prod;"),E.coprod=E.coproduct=d(Ba,"\\coprod ","&#8720;"),E["∫"]=E.int=E.integral=x(Ba,function(a,b){a.init=function(){var a='<span class="mq-int mq-non-leaf"><big>&int;</big><span class="mq-supsub mq-non-leaf"><span class="mq-sup"><span class="mq-sup-inner">&1</span></span><span class="mq-sub">&0</span><span style="display:inline-block;width:0">&#8203</span></span></span>';W.prototype.init.call(this,"\\int ",a)},a.createLeftOf=V.p.createLeftOf});var Ca=E.frac=E.dfrac=E.cfrac=E.fraction=x(V,function(a,b){a.ctrlSeq="\\frac",a.htmlTemplate='<span class="mq-fraction mq-non-leaf"><span class="mq-numerator">&0</span><span class="mq-denominator">&1</span><span style="display:inline-block;width:0">&#8203;</span></span>',a.textTemplate=["(",")/(",")"],a.finalizeTree=function(){this.upInto=this.ends[z].upOutOf=this.ends[y],this.downInto=this.ends[y].downOutOf=this.ends[z]}}),Da=E.over=F["/"]=x(Ca,function(b,c){b.createLeftOf=function(b){if(!this.replacedFragment){for(var d=b[y];d&&!(d instanceof Y||d instanceof(E.text||a)||d instanceof Ba||"\\ "===d.ctrlSeq||/^[,;:]$/.test(d.ctrlSeq));)d=d[y];d instanceof Ba&&d[z]instanceof Aa&&(d=d[z],d[z]instanceof Aa&&d[z].ctrlSeq!=d.ctrlSeq&&(d=d[z])),d!==b[y]&&(this.replaces(D(d[z]||b.parent.ends[y],b[y])),b[y]=d)}c.createLeftOf.call(this,b)}}),Ea=E.sqrt=E["√"]=x(V,function(a,b){a.ctrlSeq="\\sqrt",a.htmlTemplate='<span class="mq-non-leaf"><span class="mq-scaled mq-sqrt-prefix">&radic;</span><span class="mq-non-leaf mq-sqrt-stem">&0</span></span>',a.textTemplate=["sqrt(",")"],a.parser=function(){return T.optBlock.then(function(a){return T.block.map(function(b){var c=Fa();return c.blocks=[a,b],a.adopt(c,0,0),b.adopt(c,a,0),c})}).or(b.parser.call(this))},a.reflow=function(){var a=this.ends[z].jQ;sa(a.prev(),1,a.innerHeight()/+a.css("fontSize").slice(0,-2)-.1)}}),Fa=(E.vec=x(V,function(a,b){a.ctrlSeq="\\vec",a.htmlTemplate='<span class="mq-non-leaf"><span class="mq-vector-prefix">&rarr;</span><span class="mq-vector-stem">&0</span></span>',a.textTemplate=["vec(",")"]}),E.nthroot=x(Ea,function(a,b){a.htmlTemplate='<sup class="mq-nthroot mq-non-leaf">&0</sup><span class="mq-scaled"><span class="mq-sqrt-prefix mq-scaled">&radic;</span><span class="mq-sqrt-stem mq-non-leaf">&1</span></span>',a.textTemplate=["sqrt[","](",")"],a.latex=function(){return"\\sqrt["+this.ends[y].latex()+"]{"+this.ends[z].latex()+"}"}})),Ga=x(x(V,n),function(b,c){b.init=function(a,b,d,e,f){c.init.call(this,"\\left"+e,p,[b,d]),this.side=a,this.sides={},this.sides[y]={ch:b,ctrlSeq:e},this.sides[z]={ch:d,ctrlSeq:f}},b.numBlocks=function(){return 1},b.html=function(){return this.htmlTemplate='<span class="mq-non-leaf"><span class="mq-scaled mq-paren'+(this.side===z?" mq-ghost":"")+'">'+this.sides[y].ch+'</span><span class="mq-non-leaf">&0</span><span class="mq-scaled mq-paren'+(this.side===y?" mq-ghost":"")+'">'+this.sides[z].ch+"</span></span>",c.html.call(this)},b.latex=function(){return"\\left"+this.sides[y].ctrlSeq+this.ends[y].latex()+"\\right"+this.sides[z].ctrlSeq},b.oppBrack=function(a,b,c){return b instanceof Ga&&b.side&&b.side!==-c&&("|"===this.sides[this.side].ch||b.side===-this.side)&&(!a.restrictMismatchedBrackets||Ha[this.sides[this.side].ch]===b.sides[b.side].ch||{"(":"]","[":")"}[this.sides[y].ch]===b.sides[z].ch)&&b},b.closeOpposing=function(a){a.side=0,a.sides[this.side]=this.sides[this.side],a.delimjQs.eq(this.side===y?0:1).removeClass("mq-ghost").html(this.sides[this.side].ch)},b.createLeftOf=function(a){if(!this.replacedFragment)var b=a.options,d=this.oppBrack(b,a[y],y)||this.oppBrack(b,a[z],z)||this.oppBrack(b,a.parent.parent);if(d){var e=this.side=-d.side;this.closeOpposing(d),d===a.parent.parent&&a[e]&&(D(a[e],a.parent.ends[e],-e).disown().withDirAdopt(-e,d.parent,d,d[e]).jQ.insDirOf(e,d.jQ),d.bubble("reflow"))}else d=this,e=d.side,d.replacedFragment?d.side=0:a[-e]&&(d.replaces(D(a[-e],a.parent.ends[-e],e)),a[-e]=0),c.createLeftOf.call(d,a);e===y?a.insAtLeftEnd(d.ends[y]):a.insRightOf(d)},b.placeCursor=a,b.unwrap=function(){this.ends[y].children().disown().adopt(this.parent,this,this[z]).jQ.insertAfter(this.jQ),this.remove()},b.deleteSide=function(a,b,c){var d=this.parent,e=this[a],f=d.ends[a];if(a===this.side)return this.unwrap(),void(e?c.insDirOf(-a,e):c.insAtDirEnd(a,d));var g=c.options,h=!this.side;if(this.side=-a,this.oppBrack(g,this.ends[y].ends[this.side],a)){this.closeOpposing(this.ends[y].ends[this.side]);var i=this.ends[y].ends[a];this.unwrap(),i.siblingCreated&&i.siblingCreated(c.options,a),e?c.insDirOf(-a,e):c.insAtDirEnd(a,d)}else{if(this.oppBrack(g,this.parent.parent,a))this.parent.parent.closeOpposing(this),this.parent.parent.unwrap();else{if(b&&h)return this.unwrap(),void(e?c.insDirOf(-a,e):c.insAtDirEnd(a,d));this.sides[a]={ch:Ha[this.sides[this.side].ch],ctrlSeq:Ha[this.sides[this.side].ctrlSeq]},this.delimjQs.removeClass("mq-ghost").eq(a===y?0:1).addClass("mq-ghost").html(this.sides[a].ch)}if(e){var i=this.ends[y].ends[a];D(e,f,-a).disown().withDirAdopt(-a,this.ends[y],i,0).jQ.insAtDirEnd(a,this.ends[y].jQ.removeClass("mq-empty")),i.siblingCreated&&i.siblingCreated(c.options,a),c.insDirOf(-a,e)}else b?c.insDirOf(a,this):c.insAtDirEnd(a,this.ends[y])}},b.deleteTowards=function(a,b){this.deleteSide(-a,!1,b)},b.finalizeTree=function(){this.ends[y].deleteOutOf=function(a,b){this.parent.deleteSide(a,!0,b)},this.finalizeTree=this.intentionalBlur=function(){this.delimjQs.eq(this.side===y?1:0).removeClass("mq-ghost"),this.side=0}},b.siblingCreated=function(a,b){b===-this.side&&this.finalizeTree()}}),Ha={"(":")",")":"(","[":"]","]":"[","{":"}","}":"{","\\{":"\\}","\\}":"\\{","&lang;":"&rang;","&rang;":"&lang;","\\langle ":"\\rangle ","\\rangle ":"\\langle ","|":"|"};o("("),o("["),o("{","\\{"),E.langle=d(Ga,y,"&lang;","&rang;","\\langle ","\\rangle "),E.rangle=d(Ga,z,"&lang;","&rang;","\\langle ","\\rangle "),F["|"]=d(Ga,y,"|","|","|","|"),E.left=x(V,function(a){a.parser=function(){var a=R.regex,b=R.string,c=(R.succeed,R.optWhitespace);return c.then(a(/^(?:[([|]|\\\{)/)).then(function(d){var e="\\"===d.charAt(0)?d.slice(1):d;return T.then(function(f){return b("\\right").skip(c).then(a(/^(?:[\])|]|\\\})/)).map(function(a){var b="\\"===a.charAt(0)?a.slice(1):a,c=Ga(0,e,b,d,a);return c.blocks=[f],f.adopt(c,0,0),c})})})}}),E.right=x(V,function(a){a.parser=function(){return R.fail("unmatched \\right")}});var Ia=E.binom=E.binomial=x(x(V,n),function(a,b){a.ctrlSeq="\\binom",a.htmlTemplate='<span class="mq-non-leaf"><span class="mq-paren mq-scaled">(</span><span class="mq-non-leaf"><span class="mq-array mq-non-leaf"><span>&0</span><span>&1</span></span></span><span class="mq-paren mq-scaled">)</span></span>',a.textTemplate=["choose(",",",")"]});E.choose=x(Ia,function(a){a.createLeftOf=Da.prototype.createLeftOf});E.editable=E.MathQuillMathField=x(V,function(a,b){a.ctrlSeq="\\MathQuillMathField",a.htmlTemplate='<span class="mq-editable-field"><span class="mq-root-block">&0</span></span>',a.parser=function(){var a=this,c=R.string,d=R.regex,e=R.succeed;return c("[").then(d(/^[a-z][a-z0-9]*/i)).skip(c("]")).map(function(b){a.name=b}).or(e()).then(b.parser.call(a))},a.finalizeTree=function(){var a=I(this.ends[y],this.jQ,K());a.KIND_OF_MQ="MathField",a.editable=!0,a.createTextarea(),a.editablesTextareaEvents(),a.cursor.insAtRightEnd(a.root),k(a.root)},a.registerInnerField=function(a,b){a.push(a[this.name]=b(this.ends[y].controller))},a.latex=function(){return this.ends[y].latex()},a.text=function(){return this.ends[y].text()}});var Ja=E.embed=x(W,function(a,b){a.setOptions=function(a){function b(){return""}return this.text=a.text||b,this.htmlTemplate=a.htmlString||"",this.latex=a.latex||b,this},a.parser=function(){var a=this;return string=R.string,regex=R.regex,succeed=R.succeed,string("{").then(regex(/^[a-z][a-z0-9]*/i)).skip(string("}")).then(function(b){return string("[").then(regex(/^[-\w\s]*/)).skip(string("]")).or(succeed()).map(function(c){return a.setOptions(N[b](c))})})}}),Ka=(F["\\"]=x(V,function(a,b){a.ctrlSeq="\\",a.replaces=function(a){this._replacedFragment=a.disown(),this.isEmpty=function(){return!1}},a.htmlTemplate='<span class="mq-latex-command-input mq-non-leaf">\\<span>&0</span></span>',a.textTemplate=["\\"],a.createBlocks=function(){b.createBlocks.call(this),this.ends[y].focus=function(){return this.parent.jQ.addClass("mq-hasCursor"),this.isEmpty()&&this.parent.jQ.removeClass("mq-empty"),this},this.ends[y].blur=function(){return this.parent.jQ.removeClass("mq-hasCursor"),this.isEmpty()&&this.parent.jQ.addClass("mq-empty"),this},this.ends[y].write=function(a,b){a.show().deleteSelection(),b.match(/[a-z]/i)?X(b).createLeftOf(a):(this.parent.renderCommand(a),"\\"===b&&this.isEmpty()||this.parent.parent.write(a,b))},this.ends[y].keystroke=function(a,c,d){return"Tab"===a||"Enter"===a||"Spacebar"===a?(this.parent.renderCommand(d.cursor),void c.preventDefault()):b.keystroke.apply(this,arguments)}},a.createLeftOf=function(a){if(b.createLeftOf.call(this,a),this._replacedFragment){var c=this.jQ[0];this.jQ=this._replacedFragment.jQ.addClass("mq-blur").bind("mousedown mousemove",function(a){return A(a.target=c).trigger(a),!1}).insertBefore(this.jQ).add(this.jQ)}},a.latex=function(){return"\\"+this.ends[y].latex()+" "},a.renderCommand=function(a){this.jQ=this.jQ.last(),this.remove(),this[z]?a.insLeftOf(this[z]):a.insAtRightEnd(this.parent);var b=this.ends[y].latex();b||(b=" ");var c=E[b];c?(c=c(b),this._replacedFragment&&c.replaces(this._replacedFragment),c.createLeftOf(a)):(c=_(),c.replaces(b),c.createLeftOf(a),a.insRightOf(c),this._replacedFragment&&this._replacedFragment.remove())}}),j(1));for(var La in Ka)(function(a,b){"function"==typeof b?(i[a]=function(){return h(),b.apply(this,arguments)},i[a].prototype=b.prototype):i[a]=b})(La,Ka[La])}(),c.exports}),a.register("1",["3","4","6"],function(a,c){"use strict";function d(){var a=0,b=Math.random()*Xa;return Za[a++]=$a[b&Ya],Za[a++]=$a[b>>>4&Ya],Za[a++]=$a[b>>>8&Ya],Za[a++]=$a[b>>>12&Ya],Za[a++]=$a[b>>>16&Ya],Za[a++]=$a[b>>>20&Ya],Za[a++]=$a[b>>>24&Ya],Za[a++]=$a[b>>>28&Ya],b=Math.random()*Xa,Za[a++]=$a[b&Ya],Za[a++]=$a[b>>>4&Ya],Za[a++]=$a[b>>>8&Ya],Za[a++]=$a[b>>>12&Ya],Za[a++]=$a[b>>>16&Ya],Za[a++]=$a[b>>>20&Ya],Za[a++]=$a[b>>>24&Ya],Za[a++]=$a[b>>>28&Ya],"_"+Za.join("")}function e(a,b){var c=b.prototype;b.prototype=Object.create(a.prototype);for(var d in c)b.prototype[d]=c[d];b.prototype.constructor=b,Object.defineProperty(b.prototype,"constructor",{enumerable:!1,value:b})}function f(a,b){for(var c=0;c<a.length;c++)if(b(a[c],c,a))return a[c]}function g(a,b){for(var c=0;c<a.length;c++)if(b(a[c],c,a))return c;return-1}function i(a){var b=RegExp(a+"=(.+?)(&|$)").exec(location.search);return b?decodeURIComponent(b[1]):null}function j(a){for(var b=a.length,c=a.length-1;c>=0;c--){var d=a.charCodeAt(c);d>127&&d<=2047?b++:d>2047&&d<=65535&&(b+=2),d>=56320&&d<=57343&&c--}return b}function k(a){var b={roots_as_powers:!0,bracketed_negatives:!0,subscripts_as_long_names:!0,var_subscripts_only:!0,rationalize_reals:!0};return Array.isArray(a)||(a=[a]),Va.is_range(a)&&a[0].is_group("div","mul")?a.map(function(a){return a.children[1].to_ascii(b)}).join("*"):a.map(function(a){return a.to_ascii(b)}).join("")}function l(a,b){a&&!Array.isArray(a)&&(a=[a]);var c=a.length;a.forEach(function(a,d){var e=document.createElement("script");e.type="text/javascript",b&&d===c-1&&(e.readyState?e.onreadystatechange=function(){"loaded"!=e.readyState&&"complete"!=e.readyState||(e.onreadystatechange=null,b&&b())}:e.onload=function(){b&&b()}),e.src=a,e.async=!1,document.head.appendChild(e)})}function m(a){var b=new RegExp("^\\s*([0-9]*\\.?[0-9]+([eE][-+]?[0-9]+)?)"),c=new RegExp("^\\s*\\{(\\??[A-Za-z0-9_]*)\\:"),d=new RegExp("^\\s*(sin|cos|tan|log|ln|sqrt)"),e=new RegExp("^\\s*([a-zA-Z_₀₁₂₃₄₅₆₇₈₉])"),f=new RegExp("^\\s*([α-ωΑ-Ω])"),g=new RegExp('^\\s*"([^"]+)"'),h=new RegExp("^\\s*(>=|<=|\\*\\*|[-\\–+*/=><();,^\\{\\}\\[\\]\\|±⁰¹²³⁴⁵⁶⁷⁸⁹ⁿ:≥≤√])"),i=new RegExp("^\\s*(\\\\[^A-Za-z0-9\\s]|\\\\[A-Za-z]+)"),j=new RegExp("^(\\s+)"),k=[],l=0;
a&&(l=a.length);for(var m=0;m<l;){var n,o=a.substr(m);if(n=b.exec(o))k.push({type:"number",value:parseFloat(n[1]),from:m+(n[0].length-n[1].length),to:m+n[0].length}),m+=n[0].length;else if(n=c.exec(o))k.push({type:"operator",value:"{",from:m,to:m+1}),k.push({type:"name",value:n[1],from:m+1,to:m+n[1].length+1}),k.push({type:"operator",value:":",from:m+n[0].length-1,to:m+n[0].length}),m+=n[0].length;else if(n=d.exec(o))k.push({type:"name",value:n[1],from:m+(n[0].length-n[1].length),to:m+n[0].length}),m+=n[0].length;else if(n=e.exec(o))k.push({type:"name",value:n[1],from:m+(n[0].length-n[1].length),to:m+n[0].length}),m+=n[0].length;else if(n=f.exec(o))k.push({type:"name",value:n[1],from:m+(n[0].length-n[1].length),to:m+n[0].length}),m+=n[0].length;else if(n=g.exec(o))k.push({type:"name",value:n[1],from:m+(n[0].length-n[1].length),to:m+n[0].length}),m+=n[0].length;else if(n=h.exec(o))k.push({type:"operator",value:n[1],from:m+(n[0].length-n[1].length),to:m+n[0].length}),m+=n[0].length;else if(n=i.exec(o))k.push({type:"latex",value:n[1],from:m+(n[0].length-n[1].length),to:m+n[0].length}),m+=n[0].length;else{if(!(n=j.exec(o)))throw"can't tokenize '"+o+"'";m+=n[0].length}}return k}function o(a){var b,c,d,e,f={},g=function(a,b){throw b=b||this,b.name="SyntaxError",b.message=a,b},h=function(){this.def={}};h.prototype.find_or_define=function(a){var b=this.def[a.value];return b&&"function"!=typeof b||(b=f[a.value]),b&&"function"!=typeof b?b:(b=Object.create(f["(name)"]),b.lpb=0,this.def[a.value]=b,b)};var i=function(a,h){var i,j,k,l;if(a&&b.id!==a){if(h)return;g("Expected '"+a+"'.",b)}return d>=c.length?void(b=f["(end)"]):(k=c[d],d+=1,l=k.value,i=k.type,"name"===i?j=e.find_or_define(k):"operator"===i?(j=f[l],j||g("Unknown operator.",k)):"latex"===i?(j=f[l],j||g("Unknown latex command.",k)):"string"===i||"number"===i?(j=f["(number)"],i="number"):g("Unexpected token.",k),b=Object.create(j),b.from=k.from,b.to=k.to,b.value=l,b.type=i,b)},j=function(a){d--,b=a},k=function(a,c){var d,e=c||b;for(c||i(),d=e.nud();a<b.lbp;)e=b,i(),d=e.led(d);return d},l={nud:function(){g("Undefined.",this)},led:function(a){g("Missing operator.",this)}},n=function(a,b){var c=f[a];return b=b||0,c?b>c.lbp&&(c.lbp=b):(c=Object.create(l),c.id=c.value=a,c.lbp=b,f[a]=c),c};n("(end)");var o=function(a){if(c=m(a),0==c.length)return null;e=new h,d=0,i();var b=k(0);return i("(end)"),b},p={};p.parse=o,p.parseExpression=k,p.advance=i,p.regress=j,p.registerSymbol=n,p.symbols=a;for(var q=0;q<a.length;q++){var r=Wa.expressions[a[q]];r&&r.registerAtParser&&r.registerAtParser(p)}return p}function p(a,b){this.name=a,this.description=b,this.id=Wa.uid(),this.priority=0,this.node_map={},this.initial_node_map={},this.touched_nodes={},this.new_selection=null,this.timeoutID=null,this.settings={},this.is_inner_action}function q(){this.simple_models=[];for(var a=0;a<arguments.length;a++){var b=new Wa.AlgebraModel(arguments[a],{parser:q.getRegExpParser()});this.simple_models=this.simple_models.concat(this.getVariations(b))}}function r(a){this.prototype.name=a,this.prototype.bp=100,Wa.expressions[a]=this,this.prototype.get_subscript_helper=function(a,b){if(b&&b.var_subscripts_only&&"var"!==this.name)return"";if(!this.has_subscript())return"";var c=this.get_subscript()[a](b);return c.length>1?"_{"+c+"}":"_"+c},this.prototype.to_string=function(){return""+this.get_base().value+this.get_subscript_helper("to_string")},this.prototype.to_ascii=function(a){var b=this.get_base().value,c=this.get_subscript_helper("to_ascii",a);return c.length>0&&a&&a.subscripts_as_long_names?'"'+b+c+'"':b.toString()+c},this.prototype.to_latex=function(){return this.hidden?"":""+this.get_base().value+this.get_subscript_helper("to_latex")},this.prototype.is_leaf_node=!0,this.prototype.is_group=function(){for(var a=0;a<arguments.length;a++)if(arguments[a]===this.name)return!0;return!1},this.prototype.get_value=function(a){return a?this.value:this.get_base().value},this.prototype.set_value=function(a){this.has_subscript()?(this.get_base().value=a,this.value=this.to_ascii()):this.value=a},this.prototype.get_base=function(){return this.has_children()?this.children[0]:this},this.prototype.set_subscript=function(a,b){if(this.parent&&0===this.get_idx()&&this.parent.has_subscript())throw"Do not set a subscript on the base of a node with a subscript.";this.children[1]&&this.children[1].remove(),this.append(new Wa.expressions[this.name](this.value)),this.append(a),this.value=this.to_ascii(),b&&this.fix_subscript(b)},this.prototype.has_subscript=function(){return this.has_children()},this.prototype.get_subscript=function(){return this.has_children()?this.children[1]:null},this.prototype.fix_subscript=function(a){this.children[0].fixed=a,this.children[1].for_each(function(b){b.fixed=a})}}function s(a,b){Wa.inherit(fb,this),this.prototype.bp=b.bp||0,this.prototype.associative=b.associative||!1,this.prototype.commutative=b.commutative||!1,this.prototype.has_inverse=b.has_inverse||!1,this.prototype.inverse_group_name=b.inverse_group_name,this.prototype.group_name=b.group_name||b.group_class&&b.group_class.prototype.name,this.prototype.group_class=b.group_class,this.prototype.value=a,this.prototype.name=a,this.prototype.action_handlers=[],this.prototype.vertical_notation=b.vertical_notation||!1,this.prototype.add_action_handler=function(a){this.action_handlers.indexOf(a)==-1&&this.action_handlers.push(a)},this.prototype.getBestMatchingAction=function(a,b){b||(b=[]);for(var c=null,d=0;d<this.action_handlers.length;d++){var e=this.action_handlers[d];e.name&&b.indexOf(e.name)!==-1||e.match(this)&&(!(null===c||e.priority>c.priority)||a&&("tap"!==a.type||e.triggerType)&&e.triggerType!==a.type||(c=e))}return c},this.prototype.createGroup=function(){return new this.group_class},this.createGroup=this.prototype.createGroup,this.prototype.getInverse=function(){return this.inverse&&Wa.expressions[this.inverse]},this.prototype.clean_up_commutative=function(){if(!this.ls&&!this.rs){var a=this.children[1];return Va.replace(this.parent,a),Brackets.handle(a),!0}if(this.merge_nested_group())return!0},this.prototype.merge_nested_group=function(){if(this.associative&&this.children[1].is_group(this.group_name)){var a=this.parent,b=this.children[1];Va.get_child([1,0,0],this).value===Va.get_child([0],this).value&&Va.replace(Va.get_child([1,0,0],this),Va.get_child([0],this));for(var c=Va.remove(this),d=0;d<b.children.length;d++)Va.insert(a,c+d,b.children[d]);return!0}},Wa.expressions[a]=this}function t(a){Va.Node.call(this,"sym"),this.value=a}function u(){fb.call(this)}function v(a,b){if(fb.call(this),a){switch(b){case"sub":this.value="sub";break;case"addsub":this.value="addsub";break;default:this.value="add"}Va.append(this,new t(v.value2sym[this.value])),Va.append(this,a),x.handle(a)}this.associative="add"==this.value}function w(a){Va.Node.call(this),1===a||"T"===a||"t"===a||a===!0?this.value="T":this.value="F",this.id=Wa.uid()}function x(a,b,c){fb.call(this),a&&(Va.append(this,new t(b||"(")),Va.append(this,a),Va.append(this,new t(c||")")))}function y(a){fb.call(this),a&&(Va.append(this,new t("|")),Va.append(this,a),Va.append(this,new t("|")))}function z(){fb.call(this)}function A(a){fb.call(this),a&&(Va.append(this,new t("∧")),Va.append(this,a),x.handle(a))}function B(){fb.call(this)}function C(a){fb.call(this),a&&(Va.append(this,new t("∨")),Va.append(this,a),Brackets.handle(a))}function D(a,b){fb.call(this),this.set_degree(b),this.init_symbols(),this.set_radicand(a)}function E(a){return Va.Node.call(this),this.view_precision=3,this.max_precision=12,"number"!=typeof a&&(a=0),a>=0?void(this.value=a):new Q(new E(-a))}function F(a){fb.call(this),a&&(Va.append(this,a),x.handle(a))}function G(a,b,c){if(fb.call(this),this.value=c,a&&b){if("lte"!==c&&"gte"!==c&&"lt"!==c&&"gt"!==c)throw"(Inequality) Unaccepted mode type.";Va.append(this,a),Va.append(this,new t(G.value2sym[c])),Va.append(this,b)}}function H(a,b){fb.call(this),a&&b&&(Va.append(this,a),Va.append(this,new t("=")),Va.append(this,b))}function I(a,b){fb.call(this),a&&b&&(this.append(a),b.is_group("exponent")?this.append(b):this.append(new M(b)),x.handle(a))}function J(){fb.call(this)}function K(a,b){fb.call(this),this.value="div"==b?"div":"mul",a&&(Va.append(this,new t("mul"==this.value?"*":"/")),Va.append(this,a),x.handle(a)),this.associative="mul"==this.value,this.bp=("mul"==this.value,30)}function L(a){Va.Node.call(this),this.value=a}function M(a){fb.call(this),a&&(Va.append(this,a),x.handle(a))}function N(a,b){fb.call(this),Va.append(this,new t(a)),"undefined"!=typeof b&&this.set_argument(b),this.value=a,this.units=N.units[this.value]}function O(a){fb.call(this),this.value="param",a&&(this.append(new t(",")),this.children[0].fixed=!0,this.append(a)),this.group_class=R,this.group_name="tuple",this.associative=!1,this.commutative=!1}function P(a){Va.Node.call(this),this.value=a}function Q(a,b){fb.call(this),a&&(Va.append(this,new t(b?"±":"-")),Va.append(this,a),x.handle(a)),b&&(this.value="plusminus")}function R(){fb.call(this),this.bp=5,this.value="tuple";for(var a=0;a<arguments.length;a++){var b=arguments[a];b instanceof O?this.append(b):this.append(new O(b))}}function S(a,b){this.default_precision=1,this.interaction_handler=b,this.precision=null,this.view=a,this.dy=0,this.pixels_per_unit=50,this.node=null,this.value=null,this.value0=null}function T(a,b){"undefined"==typeof b&&(b=1e3);var c,d={},e=[];d.fonts=[],d.map={},d.finished=!1,d.success=!1,d.svg=d3.select("body").append("svg").style({position:"absolute",visibility:"hidden",width:"1px",height:"1px"}),d.on_fonts_loaded=function(a){this.finished?a(this.success):e.push(a)};var f=function(){d.loadSizes();for(var a=0;a<e.length;a++)e[a](this.success);e=[]};d.add_fonts=function(a){var b=!1;a.forEach(function(a){var c=g(a);c?a.id=c.id:(a.id=Wa.uid(),d.fonts.push(a),b=!0)}),b&&d.wait_for_fonts()};var g=function(a){for(var b=0;b<d.fonts.length;b++){var c=d.fonts[b];if(c.style===a.style&&c.family===a.family&&c.weight===a.weight)return c}return null};return d.wait_for_fonts=function(){c&&clearInterval(c),this.finished=!1,this.success=!1,this.fonts.unshift({family:"serif"});var a=this.svg.selectAll("text.temp").data(this.fonts);a.enter().append("text").classed("temp",!0).style("font-size","100px").style("font-family",function(a){return a.family.indexOf(" ")===-1?a.family+", serif":"'"+a.family+"', serif"}).style("font-style",function(a){return a.style}).style("font-weight",function(a){return a.weight}).text("012abc"),a.exit().remove(),this.fonts.shift();var d=Date.now(),e=this;c=setInterval(function(){var g=[],h=!0;a.each(function(a,b){g[b]=this.getBBox().width});for(var i=1;i<g.length;i++)g[i]===g[0]&&(h=!1);var j=Date.now()-d;!h&&j<=b||(e.success=h,e.finished=!0,a.remove(),clearInterval(c),f.call(e))},20)},d.loadSizes=function(a,b){a=a||"abcdefghijklmnopqrstuvwxyzABCDEFGHJKLMNOPQRSTUVWXYZ0123456789()=+-*^∗·•−,.√",b=b||this.fonts;for(var c=[],d=0;d<b.length;d++){this.map[b[d].id]||(this.map[b[d].id]={});for(var e=0;e<a.length;e++){var f={font:b[d],char:a[e],width:0,height:0};this.map[b[d].id][a[e]]=f,c.push(f)}}this.svg.selectAll(".hiddenChars").data(c).enter().append("text").style("font-size","100px").style("font-family",function(a){return a.font.family}).style("font-style",function(a){return a.font.style}).style("font-weight",function(a){return a.font.weight}).text(function(a){return a.char}).each(function(a){var b=this.getBBox();a.width=b.width,a.height=b.height}).remove()},d.width=function(a,b,c){for(var d=0,e=0;e<a.length;e++)this.map[c.id]&&this.map[c.id][a[e]]||this.loadSizes(a[e],[c]),d+=this.map[c.id][a[e]].width;return d*b/100},d.height=function(a,b,c){for(var d=0,e=0;e<a.length;e++)this.map[c.id]&&this.map[c.id][a[e]]||this.loadSizes(a[e],[c]),d=Math.max(this.map[c.id][a[e]].height,d);return d*b/100},d.add_fonts(a),d}function U(){hb.Rule.call(this,"reselect whole power",1)}function V(){function a(){n=this,a.connected(!0)}function b(){if(h(d3.event)){var a=d3.select(window),b=this,f=arguments;a.on("mousemove.mtouch",function(){d.apply(b,f)}),a.on("mouseup.mtouch",function(){a.on("mousemove.mtouch",null),a.on("mouseup.mtouch",null),e.apply(b,f)}),c.apply(this,arguments)}}function c(){d3.event.preventDefault();for(var b=this,c=l.of(b,arguments),d=g(),e=t?t.apply(this,arguments):null,h=0,i=d.length;h<i;h++){var j=new f(d[h].identifier,c,b,e);o.push(j),p[d[h].identifier]=j,c({type:"touch",finger:j,fingers:o,idx:a.idx})}}function d(){d3.event.preventDefault();for(var a=this,b=l.of(a,arguments),c=g(),d=0,e=o.length;d<e;d++)o[d].changed=!1;for(var f=[],d=0,e=c.length;d<e;d++){var h=p[c[d].identifier];h&&(h.move(b),f.push(h))}b({type:"mdrag",dragged_fingers:f,fingers:o})}function e(){d3.event.preventDefault();for(var a=this,b=l.of(a,arguments),c=g(),d=0,e=c.length;d<e;d++){var f=p[c[d].identifier];f&&(delete p[c[d].identifier],o=d3.values(p),b({type:"release",finger:f,fingers:o}),f.end(b))}}function f(a,b,c,d){this.id=a,this.target=c,this.event=b,this.parent=c.parentNode,this.timeStamp0=d3.event.timeStamp,this.timeStamp=this.timeStamp0,this.hold_timer=setTimeout(this.held.bind(this),z),this.pos=d?d.slice():j(this.id,s),this.pos0=[this.pos[0],this.pos[1]],this.pos_client=j(this.id,"client"),this.dist_x=0,this.dist_y=0,this.dx=0,this.dy=0,this.dt=0,this.changed=!0,this.gesture=null}function g(){return d3.event.changedTouches||[{identifier:r}]}function h(a){return"buttons"in a?1===a.buttons:"which"in a?1===a.which:1===a.button}function i(a,b,c){var d=-1,e=[b,c];return q=q.filter(function(b,c){return a-b.timeStamp<=C&&k(b.pos,e)<=D&&(d=c),b.timeStamp-a<=C&&d!==c}),d===-1&&q.push({timeStamp:a,pos:e}),d!==-1}function j(a,b){if("client"===b){if(a===r)return[d3.event.clientX/E,d3.event.clientY/E];for(var c=0;c<d3.event.touches.length;c++){var d=d3.event.touches[c];if(d.identifier===a)return[d.clientX/E,d.clientY/E]}}else{if(a===r)return X(b,d3.event,E);for(var c=0;c<d3.event.touches.length;c++){var d=d3.event.touches[c];if(d.identifier===a)return X(b,d,E)}}}function k(a,b){return Math.sqrt((a[0]-b[0])*(a[0]-b[0])+(a[1]-b[1])*(a[1]-b[1]))}var l=W(a,"tap","dbltap","hold","drag","mdrag","touch","release"),m=Wa.uid(),n=null,o=[],p={},q=[],r="mouse",s="client",t=null,u=!1,v=V.defaultOptions.input_types,w=V.defaultOptions.tap_max_time,x=V.defaultOptions.tap_max_dist,y=x*x,z=V.defaultOptions.hold_time,A=V.defaultOptions.hold_max_dist,B=A*A,C=V.defaultOptions.dbltap_max_delay,D=V.defaultOptions.dbltap_max_dist,E=V.defaultOptions.zoom;return a.connected=function(a){if(0==arguments.length)return u;if(!n)return this;var f="all"===v||"touch"===v,g="all"===v||"mouse"===v;return n.on("touchstart."+m,a&&f?c:null).on("mousedown."+m,a&&g?b:null).on("touchmove."+m,a&&f?d:null).on("touchend."+m,a&&f?e:null).on("touchcancel."+m,a&&f?e:null),u=a,this},a.call=function(b){return b.apply(a,arguments),this},a.input_types=function(b){return 0===arguments.length?v:(v!==b&&(v=b,a.connected(u)),this)},a.frame=function(a){return 0===arguments.length?s:(s=a,this)},a.origin=function(a){return 0===arguments.length?t:(t=a,this)},a.zoom=function(a){return 0===arguments.length?E:(E=a,this)},a.hold_time=function(a){return 0===arguments.length?z:(z=a,this)},a.fingers=function(){return o},a.hold_max_dist=function(a){return 0===arguments.length?A:(A=a,B=A*A,this)},a.dbltap_max_dist=function(a){return 0===arguments.length?D:(D=a,this)},f.prototype.cancel_hold=function(){this.hold_timer&&clearTimeout(this.hold_timer),this.hold_timer=null},f.prototype.held=function(){this.event({type:"hold",finger:this,fingers:o}),this.hold_timer=null},f.prototype.move=function(a){this.changed=!0,this.event=a;var b=j(this.id,"client"),c=d3.event.timeStamp;this.dx=b[0]-this.pos_client[0],this.dy=b[1]-this.pos_client[1],this.pos[0]+=this.dx,this.pos[1]+=this.dy,this.dist_x=this.pos[0]-this.pos0[0],this.dist_y=this.pos[1]-this.pos0[1],this.pos_client=b,this.dt=c-this.timeStamp,this.timeStamp=c,this.dist_x*this.dist_x+this.dist_y*this.dist_y>B&&this.cancel_hold(),this.gesture||a({type:"drag",finger:this,x:this.pos[0],y:this.pos[1],dx:this.dx,dy:this.dy,fingers:o})},f.prototype.end=function(a){var b=d3.event.timeStamp-this.timeStamp0;b<=w&&this.dist_x*this.dist_x+this.dist_y*this.dist_y<=y&&a(i(d3.event.timeStamp,this.pos[0],this.pos[1])?{type:"dbltap",finger:this,fingers:o}:{type:"tap",finger:this,fingers:o}),this.cancel_hold()},d3.rebind(a,l,"on")}function W(a){var b=d3.dispatch.apply(this,Array.apply(null,arguments).slice(1));return b.of=function(c,d){return function(e){try{var f=e.sourceEvent=d3.event;e.target=a,d3.event=e,b[e.type].apply(c,d)}finally{d3.event=f}}},b}function X(a,b,c){var d=a.ownerSVGElement||a;if(d.createSVGPoint){var e=d.createSVGPoint();if(ib<0&&(window.scrollX||window.scrollY)){d=d3.select("body").append("svg").style({position:"absolute",top:0,left:0,margin:0,padding:0,border:"none"},"important");var f=d[0][0].getScreenCTM();ib=!(f.f||f.e),d.remove()}return ib?(e.x=b.pageX,e.y=b.pageY):(e.x=b.clientX,e.y=b.clientY),e=e.matrixTransform(a.getScreenCTM().inverse()),[e.x/c,e.y/c]}var g=a.getBoundingClientRect();return[(b.clientX-g.left-a.clientLeft)/c,(b.clientY-g.top-a.clientTop)/c]}function Y(){function a(a,b){return Math.sqrt((a[0]-b[0])*(a[0]-b[0])+(a[1]-b[1])*(a[1]-b[1]))}var b,c,d,e,f=W(l,"drag","drag-start","drag-end"),g=[],h=!1,i=10,j=5,k=!0,l=function(){this.on("touch.drag",m).on("mdrag.drag",n).on("release.drag",o)};l.min_single_dist=function(a){return 0===arguments.length?i:(i=a,this)},l.min_double_dist=function(a){return 0===arguments.length?j:(j=a,this)},l.allow_double_drag=function(a){return 0===arguments.length?k:(k=a,this)};var m=function(){2===g.length||k&&1===g.length||(g.push(d3.event.finger),2===g.length?(b=[(g[0].pos[0]+g[1].pos[0])/2,(g[0].pos[1]+g[1].pos[1])/2],c=[b[0],b[1]],e=d=a(g[0].pos,g[1].pos)):(b=[g[0].pos[0],g[0].pos[1]],c=[b[0],b[1]],d=e=0))},n=function(){if(0!==g.length){var k,l=f.of(this,arguments);if(1===g.length){if(!g[0].changed)return;k=[g[0].pos[0],g[0].pos[1]],!h&&a(b,c)>=i&&(h=!0,l({type:"drag-start",fingers:g,pos0:b,pos:c,dist0:d,dist:e}))}else{if(!g[0].changed&&!g[1].changed)return;k=[(g[0].pos[0]+g[1].pos[0])/2,(g[0].pos[1]+g[1].pos[1])/2],e=a(g[0].pos,g[1].pos),!h&&a(b,c)>=j&&(h=!0,l({type:"drag-start",fingers:g,pos0:b,pos:c,dist0:d,dist:e}))}h&&l({type:"drag",fingers:g,pos0:b,pos:k,dist0:d,dist:e,dx:k[0]-c[0],dy:k[1]-c[1]}),c=k}},o=function(){if(0!==g.length){var a=d3.event.finger,d=g.indexOf(a);d!==-1&&(g.splice(d,1),h&&(1===g.length&&(b=[g[0].pos[0],g[0].pos[1]],c=[b[0],b[1]]),0===g.length&&(h=!1,f.of(this,arguments)({type:"drag-end"}))))}};return d3.rebind(l,f,"on")}function Z(){function a(a,b){return Math.sqrt((a[0]-b[0])*(a[0]-b[0])+(a[1]-b[1])*(a[1]-b[1]))}function b(a,b){return[(a[0]+b[0])/2,(a[1]+b[1])/2]}function c(a,b){return Math.atan2(a[1]-b[1],a[0]-b[0])}var d,e,f,g,h,i,j,k,l,m=W(u,"transform","transformend","transformstart"),n=[],o=0,p=0,q=0,r=1,s={scale:!0,translate:!0,rotate:!0},t=!0,u=function(){this.on("touch.transform",v).on("mdrag.transform",w).on("release.transform",x)};u.transform=function(a){return arguments.length?("scale"in a&&(r=a.scale),"rotate"in a&&(q=a.rotate),"translate"in a&&(o=a.translate[0],p=a.translate[1]),u):{scale:r,rotate:q,translate:[o,p]}},u.one_finger_drag=function(a){return arguments.length?(t=a,u):t},u.allow_translate=function(a){return arguments.length?(s.translate=a,u):s.translate},u.allow_scale=function(a){return arguments.length?(s.scale=a,u):s.scale},u.allow_rotate=function(a){return arguments.length?(s.rotate=a,u):s.rotate};var v=function(){2!==n.length&&(n.push(d3.event.finger),1===n.length&&t&&(d=e=[n[0].pos[0],n[0].pos[1]],f=A(e),m.of(this,arguments)({type:"transformstart"})),2===n.length&&(d=e=b(n[0].pos,n[1].pos),g=h=a(n[0].pos,n[1].pos),i=j=c(n[0].pos,n[1].pos),f=A(e),k=r,l=q))},w=function(){if(0!==n.length&&d3.event.dragged_fingers.some(function(a){return a.changed})){if(1===n.length){if(!t)return;s.translate&&(d=[n[0].pos[0],n[0].pos[1]]),B(d,f)}2===n.length&&(s.scale&&(g=a(n[0].pos,n[1].pos)),s.translate&&(d=b(n[0].pos,n[1].pos)),s.rotate&&(i=c(n[0].pos,n[1].pos)),y()),m.of(this,arguments)({type:"transform",fingers:n,transform:{scale:r,rotate:q,translate:[o,p]}})}},x=function(){if(0!==n.length){var a=d3.event.finger,b=n.indexOf(a);b!==-1&&(n.splice(b,1),0===n.length&&m.of(this,arguments)({type:"transformend"}),1===n.length&&(d=e=[n[0].pos[0],n[0].pos[1]],f=A(e)))}},y=function(){s.rotate&&(q=l+(i-j)),s.scale&&(r=k*g/h),(s.translate||s.rotate||s.scale)&&B(d,f)},z=function(a){var b=Math.cos(q),c=Math.sin(q),d=a[0]*b-a[1]*c,e=a[1]*b+a[0]*c;return[d*r+o,e*r+p]},A=function(a){var b=(a[0]-o)/r,c=(a[1]-p)/r,d=Math.cos(-q),e=Math.sin(-q);return[b*d-c*e,c*d+b*e]},B=function(a,b){b=z(b),o+=a[0]-b[0],p+=a[1]-b[1]};return d3.rebind(u,m,"on")}function _(a,b){this.id=Wa.uid(),this.view=a,this.interaction_handler=b,this.dl=a.options.derivation_list,this.dy0=0,this.dx=0,this.dy=0,this.finger_delta={x:0,y:0},this.dx_queue=[],this.dy_queue=[],this.nodes=[],this.leaf_nodes=[],this.smooshedNodes=[],this.smooshing=!1,this.rubberband_dir=0,this.bbox=null,this.actions=[],this.on_release_action=null,this.target_areas=null,this.active=!1,this.indicator=this.view.options.show_drag_indicator?_.Indicator(_.indicator_vis_mode):null}function aa(a,b){this.type="InterDerivationHandler",this.interaction_handler=b,this.derivation=a.options.derivation_list,this.view=a,this.line={A:{},B:{}},this.line_el=null,this.bbox=null,this.targets=[],this.pending_ce_target,this.sub_visible=!0,this.sub_enabled=!0,this.eq_target_area_style={fill:"#FFF","fill-opacity":.5,stroke:"steelblue","stroke-width":1,"stroke-dasharray":"5,5",rx:"12",ry:"12"},this.eq_target_area_style_active={fill:"#BBB"}}function ba(a,b,c){this.id=Wa.uid(),this.send_events=!0,this.events=d3.dispatch("tap","dbltap","drag_start","drag","drag_end","touch","release","hold","inspect_node","keyup","keydown","node_selection"),this.view=a,this.canvas=this.view.options.derivation_list?this.view.options.derivation_list.canvas_model:null,this.recorder=c,this.mode="edit",this.modes=["edit","inspect","arrange"],this.interactive=b,this.init(),b||this.set_interactive(!1),this.selected_nodes=[],this.handlers={edit:[new ca(this.view,this),new _(this.view,this),new da(this.view,this),new ea(this.view,this)],inspect:[new S(this.view,this)],row:new aa(this.view,this)},this.active_handler=null,this.active_action=null,this.pending_eoi=null,this.ignore_next_release_event=!1,this.always_visualize_fingers=!1,this.finger_vis=null}function ca(a,b){this.view=a,this.alm=this.view.model,this.interaction_handler=b,this.initial_nodes=[],this.nodes=[],this.pos0=null,this.pos=null,this.box_el=null}function da(a){this.view=a,this.alm=this.view.model,this.nodes=[],this.node_ids=[],this.joined=!1,this.unjoined_state=null}function ea(a,b){this.view=a,this.nodes=null,this.splitted=!1,this.new_state=null,this.prevDist=null,this.interaction_handler=b,this.actions=[Wa.actions.SplitNumberAction,Wa.actions.SplitProductAction,Wa.actions.SplitPowerAction,Wa.actions.SplitPowerSumAction,Wa.actions.RemoveBracketsAction]}function fa(a,b){Va.Node.call(this),this.type="AlgebraModel",this.id=Wa.uid(),this.events=d3.dispatch("create","change","mistake","start-of-interaction","end-of-interaction","node-changed","scrubbability-changed","restraint"),this.options=Wa.object.merged(fa.defaultOptions,b),this.hide_rules=[],this.watchedAspects=[],this.parser=this.options.parser||fa.getDefaultParser(),this.init_hide_rules(),this.parseAndSet(a,!0),this.setLocked(this.options.locked)}function ga(a,b,c,d){this.id=d||Wa.uid(),this.source=a,this.target=b,this.action=c,this.action.broken=!1,this.model_before_broken=null,this.source.events.on("change."+this.id,this.onChange.bind(this)),this.target.events.on("change."+this.id,this.onTargetChange.bind(this))}function ha(a,b,c){function d(a){var c=!(arguments.length<=1||void 0===arguments[1])&&arguments[1],g=arguments.length<=2||void 0===arguments[2]||arguments[2];a.is_group("sign")?(b=!b,d(a.children[1],c,g)):a.is_group("brackets")&&x.is_optional(a)?d(a.children[1],c,g):a.is_group("fraction","product")&&g?(a.get_top().forEach(function(a){return d(a.children[1],!1,!1)}),a.get_bottom().forEach(function(a){return d(a.children[1],!0,!1)})):c?f.push(a):e.push(a)}var e=[],f=[];a.forEach(function(a){return d(a)});var g=ia(e,f,c);return b&&Q.wrapTerm(g),g}function ia(a,b,c){function d(a,b){var c=a.is_group("power")?a.children[0]:a,d=c.to_ascii(),e=a.is_group("power")?a.get_exponent_term():new E(1);b&&(e=Q.invertTerm(e)),d in g||(g[d]={base:c,exps:[]}),g[d].exps.push(e)}var e=1,f=1,g={};a.forEach(function(a){a.is_group("num")?e*=a.value:d(a,!1)}),b.forEach(function(a){a.is_group("num")?f*=a.value:d(a,!0)});var h=new J;if(e!==f){var i=Wa.factoring.get_gcf(e,f);if(e/=i,f/=i,1===f)h.append(new K(new E(e)));else{var j=new J;j.append(new K(new E(e))),j.append(new K(new E(f),"div")),h.append(new K(j))}}var k=new J,l=function(a){n=g[a];var b=void 0;if(1===n.exps.length)b=n.exps[0];else{b=new u,n.exps.forEach(function(a){var d=b.append(new v(a));c&&c.applyInnerAction("AddSubCombineSigns",{actor:d})});for(var d=b.children.length-1;d>=0;d--)p.cleanupInPlace(b.children[d])}var e=b.is_group("sum")?b.children.reduce(function(a,b){return a+E.get_value(b)},0):E.get_value(b),f=void 0;f=Number.isNaN(e)?new K(new I(n.base,b)):1===e?new K(n.base):0===e?null:e===-1?new K(n.base,"div"):e<0?new K(new I(n.base,new E(-e)),"div"):new K(new I(n.base,new E(e))),f&&k.append(f)};for(var m in g){var n;l(m)}return(0===k.children.length&&0===h.children.length||k.children.length>0&&!k.children[0].is_group("mul"))&&k.append(new K(new E(1))),0===h.children.length?k:0===k.children.length?h:(h.append(new K(k)),h)}function ja(a,b,c){this.view=a,this.h_align=b||"center",this.v_align=c||"alphabetic"}function ka(a,b,c){this.id=Wa.uid(),this.model=a,this.events=d3.dispatch("updated"),this.model.events.on("change."+this.id,this.onChange.bind(this)),this.model.events.on("end-of-interaction."+this.id,this.onEOI.bind(this));var d=this;this.model.events.on("scrubbability-changed."+this.id,function(){d.update_existing("normal",!0)}),this.svg=b,this.main=null,this.initializeOptions(c),this.mode=this.options.mode,this.is_animating=0,this.afterAnimationCallbacks=[]}function la(a,b,c){a.attr("x1",0).attr("x2",function(a){return a.width}).style("stroke-width",function(a){return"normal"!==c&&c?a.height/2:a.height}).style("stroke",function(a){return"normal"!==c&&c?"#ddd":a.color}),b&&a.attr("y1",function(a){return.2*a.height}).attr("y2",function(a){return-.2*a.height})}function ma(a,b,c){c=c||{},this.id=c.id||Wa.uid(),this.type="canvas-element",this.canvas_model=a,this.events=d3.dispatch("start-of-interaction","end-of-interaction","active","move","resize"),this.mouse_events=d3.dispatch("touch","drag","release"),this.dragging=!1,this.initCanvasElementOptions(c),this.initElement(b),this.initCanvasElementProperties(),this.enterMode(this.mode,!0)}function na(a,b){this.type="derivation-row",this.dl=a,this.id=Wa.uid(),this.action=b.action,this.model=b.model,this.handle=null,this.view=null,this.el=b.el,this.padding=b.padding,this.dims=b.dims||{},this.idx=b.row_idx,this.pos=b.pos,this.link=null,this.lpos=null,this.preview=null,this.subable=!0,this.sub=!1,this.error=null}function oa(a,b,c,d){var e=Wa.object.merged(oa.defaultOptions,c);ma.call(this,a,b,e),this.type="derivation",this.events=Wa.extend(this.events,d3.dispatch("added_line","change","inspect_node","clone","pack_state","hover","mistake","auto_undo")),this.row_events=d3.dispatch("drag","touch","tap","release"),this.update_sequence=0,this.initDerivationListOptions(c),this.initDerivationListProperties(),this.initDerivationList(d),this.canvas_model&&this.canvas_model.on("input_mode."+this.id,this.inputModeChanged.bind(this))}function pa(a,b){this.id=Wa.uid(),a&&a.version!==Wa.version&&(console.warn("Incompatible versions!"),console.info("Recorded data gmath version:",a.version),console.info("Current gmath version:",Wa.version)),this.event_log=a||{},this.container=b,this.ignore_custom_events_during_playback=!0,this.ajust_time_of_next_event=!0,this.event_dt=0}function qa(a,b){this.id=Wa.uid(),this.interaction_logger=a,this.log_mouse_trajectories=this.interaction_logger.log_mouse_trajectories,this.dl=b,b.rows.length&&this.initListeners(),this.events=[],this.interaction=null,this.scrubbed_in_this_interaction=!1}function ra(a,b){this.data_logger=a,this.interactionSequence=[],this.dlLoggers=[],this.setupListeners(b)}function sa(a,b,c,d){c=Wa.object.merged(sa.defaultOptions,c),ma.call(this,a,b,c),this.type="ggb-element",this.events=Wa.extend(this.events,d3.dispatch("ggb_add","ggb_remove","ggb_update","ggb_rename","ggb_click","ggb_init")),this.ggb_objs=[],this.adding_ggb_object_for_row=void 0,this.dont_update=void 0,this.links=[],this.initOptions(c),this.ggbApplet=null,this.init(d)}function ta(a,b,c){this.id=d(),this.type="GM_GGB_Link",this.ggb_obj=a,this.row=b,this.model=b.model,this.ggb_panel=c,"segment"===a.type&&this.onGGBChange(a.name),this.model.events.on("change."+this.id,this.onAMChange.bind(this)),this.model.events.on("end-of-interaction."+this.id,this.onAMeoi.bind(this))}function ua(a,b,c,e,f){this.id=d(),this.type="GM_GGB_SI_Line_Link",this.ggb_ic=a,this.ggb_2nd=b,this.ggb_obj=c,this.model=e.model,this.row=e,this.ggb_panel=f,this.model.events.on("change."+this.id,this.onAMChange.bind(this))}function va(a,b){Cb[a]=b}function wa(a,b,c,d){c=_a.merged(wa.defaultOptions,c),ma.call(this,a,b,c),this.type="ggb-panel",this.ggb_objs=[],this.adding_ggb_object_for_row=void 0,this.dont_update=void 0,this.links=[],this.initOptions(c),this.ggbElement=c.ggbElement,this.ggbElement.ggbPanel=this,this.init()}function xa(a,b){this.id=Wa.uid(),this.events=d3.dispatch("interaction"),this.listening=!0,this.log_mouse_trajectories=b,this.trial_id=null,this.canvas_logger=new ra(this,a),this.canvas=a,Wa.TrialLogger.events.on("start_trial."+this.id,this.setTrialInfo.bind(this)),Wa.TrialLogger.trial&&this.setTrialInfo(Wa.TrialLogger.trial)}function ya(a,b){this.event_log=a,this.dl=null,this.other_dl=null,this.div=d3.select(b),this.stop_timer=!1}function za(){this.posting=!1,this.log_to_console=!1,this.trial_collection=null,this.data_collection=null,this.server_url="https://graspablemath.com:7010"}function Aa(){var a,b,c,d,e,f=d3.dispatch("click"),g=!1,h=function b(c){return a=c,b.init(),b};return h.hidden=function(a){return 0===arguments.length?g:(g=a,d&&d.style("display",g?"none":null),e&&e.attr("opacity",0),this)},h.remove=function(){c&&c.remove()},h.init=function(){b=a.node().getBoundingClientRect(),c=a.append("svg").attr("id","button").attr("width","100%").attr("height","100%").attr("cursor","pointer"),d=c.append("g").style("display",g?"none":null).attr("transform","translate("+[b.width/2,b.height/2]+")"),d.append("rect").attr({x:-b.width/2,y:-b.height/2,width:b.width,height:b.height}).attr({fill:"black",opacity:.1}),d.append("circle").attr({r:"35px"}).attr({fill:"#666",stroke:"white","stroke-width":"4px","fill-opacity":.6}),d.append("circle").attr({r:"37px"}).attr({fill:"none",stroke:"silver","stroke-width":1.5}),d.append("path").attr("d","M0,0 L0,1 L0.8,0.5 Z").attr("transform","scale(40)translate(-0.3,-0.5)").attr("fill","white"),e=c.append("rect").classed("overlay",!0).attr({width:b.width,height:b.height}).attr({fill:"black",opacity:0}).attr("pointer-events","all").on("mouseover",function(){e.attr("opacity",g?0:.1)}).on("mouseout",function(){e.attr("opacity",0)}).on("click",function(){g||f.click()})},d3.rebind(h,f,"on")}function Ba(){this.trial=null,this.active_trials=[],this.events=d3.dispatch("start_trial","end_trial"),this.experiment_id=null}function Ca(a,b,c){c=c||20;var d=[],e=function(a){var e=b[0][0],f=b[0][1],g=0,h=0;if(1===a.length&&!Fa(a[0][0],a[0][1],e,f,c))return void d.push(a);for(var i;g<a.length-1;){var j=a[g],k=a[g+1],l=Fa(j[0],j[1],e,f,c),m=Fa(k[0],k[1],e,f,c);if(l&&m)g++,h=g;else if(l&&!m){var n=Ja(j[0],j[1],k[0],k[1],e,f,c);n?(a[g]=n,h=g):g++}else if(!l&&m){var n=Ja(k[0],k[1],j[0],j[1],e,f,c);
n&&(i=a.slice(h,g+1),i.push(n),d.push(i)),g++,h=g}else{var o=Ka(j[0],j[1],k[0],k[1],e,f,c);o?(i=a.slice(h,g+1),i[i.length-1][0]===o[0][0]&&i[i.length-1][1]===o[0][1]||i.push(o[0]),i.length>1&&d.push(i),a[g]=o[1],a[g+1]&&a[g+1][0]==o[1][0]&&a[g+1][1]==o[1][1]&&g++,h=g):g++}}h!==g&&(i=a.slice(h,a.length),i&&d.push(i))},f=function(a,e){if(a.path){c+=a.width/2;var a=a.path}var f=b[e],g=b[e+1],e=0,h=0;if(1===a.length){var i=Ha(a[0][0],a[0][1],f[0],f[1],g[0],g[1],c);if(i.indexOf(1)===-1)return void d.push(a)}for(var j;e<a.length-1;){var k=a[e],l=a[e+1],i=Ha(k[0],k[1],f[0],f[1],g[0],g[1],c),m=Ha(l[0],l[1],f[0],f[1],g[0],g[1],c);if(i.indexOf(1)!==-1&&m.indexOf(1)!==-1)e++,h=e;else if(i.indexOf(1)!==-1&&m.indexOf(1)===-1){var n=Ma(k[0],k[1],i,l[0],l[1],f[0],f[1],g[0],g[1],c);n?(a[e]=n,h=e):e++}else if(i.indexOf(1)===-1&&m.indexOf(1)!==-1){var n=Ma(l[0],l[1],m,k[0],k[1],f[0],f[1],g[0],g[1],c);n?(j=a.slice(h,e+1),j.push(n),d.push(j),e++,h=e):e++}else{var o=Na(k[0],k[1],l[0],l[1],f[0],f[1],g[0],g[1],c);o?(j=a.slice(h,e+1),j[j.length-1][0]===o[0][0]&&j[j.length-1][1]===o[0][1]||j.push(o[0]),j.length>1&&d.push(j),a[e]=o[1],a[e+1]&&a[e+1][0]==o[1][0]&&a[e+1][1]==o[1][1]&&e++,h=e):e++}}h!==e&&(j=a.slice(h,a.length),j&&d.push(j))};if(b=Da({path:b}),1===b.length){for(var g=0;g<a.length;g++)e(a[g]);a=d}else for(var h=0;h<b.length-1;h++){for(var g=0;g<a.length;g++)f(a[g],h);a=d,d=[]}for(var i=0;i<a.length;i++)for(var j=0;j<a[i].length;j++)a[i][j][0]=Math.round(a[i][j][0]),a[i][j][1]=Math.round(a[i][j][1]);return a}function Da(a){if(a.path)var a=a.path;var b=[];if(1===a.length)b=a;else{for(var c=0;c<a.length-1;)a[c][0]===a[c+1][0]&&a[c][1]===a[c+1][1]||b.push(a[c]),c++;0!==a.length&&0===b.length&&b.push(a[0]),a[a.length-1][0]===a[b.length-1][0]&&a[a.length-1][1]===a[b.length-1][1]||b.push(a[c])}return b}function Ea(a,b,c,d){return Math.sqrt(Math.pow(c-a,2)+Math.pow(d-b,2))}function Fa(a,b,c,d,e){var f=Ea(a,b,c,d);return f<e?1:0}function Ga(a,b,c,d,e,f,g){var h=[e-c,f-d],i=[a-c,b-d],j=[-h[1],h[0]],k=Math.sqrt(Math.pow(j[0],2)+Math.pow(j[1],2)),l=[j[0]/k,j[1]/k],m=Math.sqrt(Math.pow(h[0],2)+Math.pow(h[1],2)),n=[h[0]/m,h[1]/m],o=i[0]*n[0]+i[1]*n[1];if(o<=0||o>=m)return 0;var p=i[0]*l[0]+i[1]*l[1];return p>=g||p<=-g?0:1}function Ha(a,b,c,d,e,f,g){var h=[];return h.push(Fa(a,b,c,d,g)),h.push(Fa(a,b,e,f,g)),h.push(Ga(a,b,c,d,e,f,g)),h}function Ia(a,b,c,d,e){var f=[c-a,d-b],g=[-f[1],f[0]],h=Math.sqrt(Math.pow(g[0],2)+Math.pow(g[1],2)),i=[g[0]/h,g[1]/h],j=[a+e*i[0],b+e*i[1]],k=[a-e*i[0],b-e*i[1]],l=[c-e*i[0],d-e*i[1]],m=[c+e*i[0],d+e*i[1]];return[j,k,l,m]}function Ja(a,b,c,d,e,f,g){var h,i=[e-a,f-b],j=[c-a,d-b],k=Math.sqrt(Math.pow(j[0],2)+Math.pow(j[1],2)),l=[j[0]/k,j[1]/k],m=i[0]*l[0]+i[1]*l[1],n=[a+m*l[0],b+m*l[1]],o=Math.sqrt(Math.pow(e-n[0],2)+Math.pow(f-n[1],2));if(0===o)h=g;else var h=Math.sqrt(Math.pow(g,2)-Math.pow(o,2));var p=[a+m*l[0]+h*l[0],b+m*l[1]+h*l[1]];return p[0]===a&&p[1]===b?null:p}function Ka(a,b,c,d,e,f,g){var h=[e-a,f-b],i=[c-a,d-b],j=[-i[1],i[0]],k=Math.sqrt(Math.pow(j[0],2)+Math.pow(j[1],2)),l=[j[0]/k,j[1]/k],m=h[0]*l[0]+h[1]*l[1],n=Tb([a,b],[c,d],[e,f]),o=Rb([n[0]-e,n[1]-f]);if(o>=g)return null;var p=Math.sqrt(Math.pow(g,2)-Math.pow(m,2)),q=[e-m*l[0],f-m*l[1]],r=Math.sqrt(Math.pow(i[0],2)+Math.pow(i[1],2)),s=[i[0]/r,i[1]/r],t=[[q[0]-s[0]*p,q[1]-s[1]*p],[q[0]+s[0]*p,q[1]+s[1]*p]];return t[0][0]===a&&t[0][1]===b?null:t}function La(a,b,c,d,e,f,g,h){var i,j,k,l;i=c-a,j=d-b,k=g-e,l=h-f;var m,n;if(-k*j+i*l===0)return null;if(m=(-j*(a-e)+i*(b-f))/(-k*j+i*l),n=(k*(b-f)-l*(a-e))/(-k*j+i*l),m>=0&&m<=1&&n>=0&&n<=1){var o=a+n*i,p=b+n*j;return[o,p]}return null}function Ma(a,b,c,d,e,f,g,h,i,j){var k=Ia(f,g,h,i,j),l=[];if(c[0]&&!c[1]){l.push(Ja(a,b,d,e,f,g,j)),l.push(La(a,b,d,e,k[0][0],k[0][1],k[3][0],k[3][1])),l.push(La(a,b,d,e,k[1][0],k[1][1],k[2][0],k[2][1]));var m=Ka(a,b,d,e,h,i,j);m&&l.push(m[0],m[1])}else if(!c[0]&&c[1]){l.push(Ja(a,b,d,e,h,i,j)),l.push(La(a,b,d,e,k[0][0],k[0][1],k[3][0],k[3][1])),l.push(La(a,b,d,e,k[1][0],k[1][1],k[2][0],k[2][1]));var m=Ka(a,b,d,e,f,g,j);m&&l.push(m[0],m[1])}else if(c[0]&&c[1])l.push(Ja(a,b,d,e,f,g,j)),l.push(La(a,b,d,e,k[0][0],k[0][1],k[3][0],k[3][1])),l.push(La(a,b,d,e,k[1][0],k[1][1],k[2][0],k[2][1])),l.push(Ja(a,b,d,e,h,i,j));else{var m=Ka(a,b,d,e,h,i,j),n=Ka(a,b,d,e,f,g,j);m&&l.push(m[0],m[1]),n&&l.push(n[0],n[1]),l.push(La(a,b,d,e,k[0][0],k[0][1],k[3][0],k[3][1])),l.push(La(a,b,d,e,k[1][0],k[1][1],k[2][0],k[2][1]))}for(var o=[a,b],p=0;p<l.length;p++)l[p]&&Ea(l[p][0],l[p][1],d,e)<Ea(o[0],o[1],d,e)&&(o=l[p]);return o[0]===a&&o[1]===b?null:o}function Na(a,b,c,d,e,f,g,h,i){var j=Ia(e,f,g,h,i),k=[],l=Ka(a,b,c,d,e,f,i);l&&k.push(l[0],l[1]),l=Ka(a,b,c,d,g,h,i),l&&k.push(l[0],l[1]),k.push(La(a,b,c,d,j[0][0],j[0][1],j[3][0],j[3][1])),k.push(La(a,b,c,d,j[1][0],j[1][1],j[2][0],j[2][1]));for(var m=[c,d],n=[a,b],o=0;o<k.length;o++)k[o]&&Ea(k[o][0],k[o][1],a,b)<Ea(m[0],m[1],a,b)&&(m=k[o]);for(var p=0;p<k.length;p++)k[p]&&Ea(k[p][0],k[p][1],c,d)<Ea(n[0],n[1],c,d)&&(n=k[p]);return m[0]===c&&m[1]===d||n[0]===a&&n[1]===b?null:[m,n]}function Oa(a){this.modal=null,this.init(),this.events=d3.dispatch("identified"),this.max_idle_time=a,this.timer_id=null,this.resetTimer(),this.showGlassPane(!0)}function Pa(a,b){var c=arguments.length<=2||void 0===arguments[2]?null:arguments[2];Ub=a,Wb=b,Vb=[{label:"select one and click on the canvas",header:!0}];for(var d in Xb)c&&(!c[d]||c[d].cond&&!c[d].cond(Ub))||Vb.push(Xb[d]);var e=Ub.appendButtonGroup([{type:"dropdown",label:"insert",icon:"glyphicon glyphicon-plus-sign",html_fn:Ra}],null,!0);$(e.node()).on("show.bs.dropdown",Qa)}function Qa(){Ub.controller.cancelInsertElementOnNextClick()}function Ra(a,b){var c=d3.select(a).append("ul"),d=c.selectAll("li").data(Vb).enter(),e=d.append("li"),f=e.filter(function(a){return a.header}),g=e.filter(function(a){return!a.header});f.classed("dropdown-header",!0).text(function(a){return a.label});var h=g.append("a").attr("href","#").style("padding","10px 20px").on("click",function(a){d3.event.preventDefault(),Sa(a)}),i={"vertical-align":"bottom",position:"relative",height:"1.8em",left:"-0.5em",top:"0.15em"};return h.filter(function(a){return a.icon}).append("img").style(i).style("opacity",.5).attr("src",function(a){return Wb+a.icon}),h.filter(function(a){return!a.icon}).append("span").style(i).style("width","1.8em").style("display","inline-block").style("opacity",.5).attr("class",function(a){return a.class||null}),h.append("span").text(function(a){return a.label}),c.node()}function Sa(a){"homework"===a.value?setTimeout(function(){$("button#problems").trigger("click")},0):Ub.controller.insertElementOnNextClick(a.value)}function Ta(a){a.selectAll(".btn-toolbar button span").style("font-size","12px"),a.selectAll(".btn-toolbar button br").style("font-size","12px")}var Ua,Va,Wa,Xa,Ya,Za,$a,_a,ab,bb,cb,db,eb,fb,gb,hb,ib,jb,kb,lb,mb,nb,ob,pb,qb,rb,sb,tb,ub,vb,wb,xb,yb,zb,Ab,Bb,Cb,Db,Eb,Fb,Gb,Hb,Ib,Jb,Kb,Lb,Mb,Nb,Ob,Pb,Qb,Rb,Sb,Tb,Ub,Vb,Wb,Xb,Yb,Zb,$b,_b,ac,bc,cc,dc,ec,fc,gc,hc,ic,jc,kc,lc,mc,nc,oc,pc,qc,rc,sc,tc,uc,vc,wc,xc,yc,zc,Ac,Bc,Cc,Dc,Ec,Fc,Gc,Hc,Ic,Jc,Kc,Lc,Mc,Nc,Oc,Pc,Qc,Rc,Sc,Tc,Uc;return{setters:[function(a){Ua=a.default},function(a){Va=a.Tree},function(a){}],execute:function(){Wa={expressions:{},ui:{}},Xa=4294967296,Ya=15,Za=[],$a=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"],Wa.uid=d,Wa.inherit=e,a("object",_a={}),Wa.object=_a,_a.extend=function(a,b){if("object"==typeof b&&b)for(var c in b)a[c]=b[c];return a},Wa.extend=_a.extend,a("extend",ab=_a.extend),_a.extendExisting=function(a,b){for(var c in a)c in b&&(a[c]=b[c]);return a},_a.extendChanged=function(a,b,c){for(var d in b)d in c&&!_a.deepEquals(c[d],b[d])&&(a[d]=b[d]);return a},_a.extendDifferent=function(a,b,c){for(var d in b)d in c&&_a.deepEquals(c[d],b[d])||(a[d]=b[d]);return a},_a.merged=function(a,b){return Wa.object.extend(Wa.object.extend({},a),b)},_a.deepCopy=function(a){var b=a;if(Array.isArray(a)){b=[];for(var c=0;c<a.length;c++)b[c]=Wa.deepCopy(a[c])}else if("object"==typeof a&&a){b={};for(var d in a)a.hasOwnProperty(d)&&(b[d]=Wa.deepCopy(a[d]))}return b},Wa.deepCopy=_a.deepCopy,a("deepCopy",bb=_a.deepCopy),_a.deepEquals=function(a,b){if(a===b)return!0;if(Array.isArray(a)){if(!Array.isArray(b))return!1;if(a.length!==b.length)return!1;for(var c=0;c<a.length;c++)if(!_a.deepEquals(a[c],b[c]))return!1;return!0}if("object"==typeof a&&a){if(!b)return!1;for(var d in a)if(a.hasOwnProperty(d)){if(!b.hasOwnProperty(d))return!1;if(!_a.deepEquals(a[d],b[d]))return!1}return!0}return!1},Wa.deepEquals=_a.deepEquals,a("deepEquals",cb=_a.deepEquals),Wa.find=f,Wa.findIndex=g,a("array",db={}),Wa.array=db,db.containsAll=function(a,b){if(b.length>a.length)return!1;for(var c=0;c<b.length;c++)if(a.indexOf(b[c])===-1)return!1;return!0},db.remove=function(a,b){var c=a.indexOf(b);return c===-1?[]:a.splice(c,1)},db.equals=function(a,b){if(a.length!==b.length)return!1;for(var c=0;c<a.length;c++)if(a[c]!==b[c])return!1;return!0},db.isPermutation=function(a,b){var a=a.slice();if(b.length!==a.length)return!1;for(var c=0;c<b.length;c++){var d=a.indexOf(b[c]);if(d===-1)return!1;a[d]=void 0}return!0},db.mergedNew=function(a,b){for(var c=a.slice(),d=0;d<b.length;d++)a.indexOf(b[d])===-1&&c.push(b[d]);return c},db.xor=function(a,b){for(var c=[],d=0;d<a.length;d++)b.indexOf(a[d])===-1&&c.push(a[d]);for(var d=0;d<b.length;d++)a.indexOf(b[d])===-1&&c.push(b[d]);return c},db.flatten=function(a){for(var b=[],c=0;c<a.length;c++)b=b.concat(a[c]);return b},db.includes=function(a,b){return a.indexOf(b)!==-1},Wa.getURLParameter=i,Wa.byteLength=j,Wa.termsToAlgebriteString=k,Wa.loadScripts=l,Wa.options={},Wa.options.actions={},Wa.options.actions.substitution_on=!0,Wa.options.actions.only_integer_division=!1,Wa.options.actions.simplify_sum_in_numerator_after_adding_fractions=!1,Wa.options.actions.second_child_eq_inversion=!1,Wa.options.actions.cancel_powers=!0,Wa.options.actions.tap_to_cancel=!0,Wa.options.actions.factor_after_finding_gcf=!0,Wa.options.actions.cancel_common_terms_after_finding_gcf=!0,Wa.options.actions.simplify_sum_after_canceling_powers=!0,Wa.tokenize=m,Wa.AlgebraParser=o,Wa.actions={},Wa.Action=p,p.prototype.printMap=function(a){a&&console.log(a);for(var b in this.node_map){var c=this.oldTree.get_by_id(b);console.log(c?c.to_ascii():"?","==>",this.node_map[b].map(function(a){return a.to_ascii()}).join(", "))}},p.prototype.createBoundAction=function(a,b,c){var d=new this.constructor(b);return d.oldTree=a,d.newTree=a,d.trigger=c,d},p.prototype.getSourceAndTarget=function(a){return"drag"===this.triggerType?{source:a?this.nodes:this.nodes[0],target:this.target}:{source:a?[this.actor]:this.actor,target:this.actor.ls||this.actor.rs}},p.prototype.bindActionForEachTarget=function(a,b,c){var d=[],e=a[0].get_root();return b.forEach(function(b,f){c&&0===f&&d.push(this.createBoundAction(e,{nodes:a,target:b,side:"left-of"})),d.push(this.createBoundAction(e,{nodes:a,target:b,side:c?"right-of":"around"}))},this),d},p.prototype.rebind=function(a,b,c){if(this.oldTree!==c)throw"wrong old tree during rebinding an action!";var d=new p;d.node_map=b,this.oldTree=a,this.nodes&&(this.nodes=d.mapNodes(this.nodes)),this.target&&(this.target=Array.isArray(this.target)?[d.mapNodes(this.target)[0]]:d.mapNodes(this.target)[0]),this.actor&&(this.actor=d.mapNodes(this.actor)[0])},p.prototype.createAndRun=function(a,b,c){var d=new this.constructor(b);return d.oldTree=a,d.run(c),d},p.prototype.createAndDoInPlace=function(a,b,c){var d=new this.constructor(b);return b.is_inner_action&&(d.is_inner_action=!0),d.oldTree=a,d.newTree=a,d.doInPlace(c),d},p.prototype.initNodeMap=function(){this.is_inner_action||(this.initial_node_map=this.oldTree.children[0].get_mapping_to(this.newTree.children[0])),this.node_map=this.oldTree.children[0].get_mapping_to(this.newTree.children[0])},p.prototype.removeDeletedNodesFromNodeMap=function(){var a=this.newTree.select_all(),b=function(b){return a.indexOf(b)!==-1};for(var c in this.node_map)this.node_map[c]=this.node_map[c].filter(b)},p.prototype.updateNodeMap=function(a,b){if(1===arguments.length)Wa.extend(this.node_map,a);else{var c=a;if(Array.isArray(c))for(var d=0;d<c.length;d++)this.node_map[c[d].id]=Array.isArray(b)?b:[b];else this.node_map[c.id]=Array.isArray(b)?b:[b]}},p.pushNew=function(a,b){for(var c=0;c<b.length;c++)a.indexOf(b[c])===-1?a.push(b[c]):(a.splice(a.indexOf(b[c]),1),a.push(b[c]))},p.prototype.extendNodeMap=function(a,b){if(2===arguments.length){var c=a,d=Array.isArray(b)?b:[b];return void(c.id in this.node_map?p.pushNew(this.node_map[c.id],d):this.node_map[c.id]=d)}var e=a;for(var f in e)e.hasOwnProperty(f)&&(f in this.node_map?p.pushNew(this.node_map[f],e[f]):this.node_map[f]=e[f])},p.prototype.getNewTreeNode=function(a){return this.is_inner_action?a:this.getCorrespondingNodeFromTree(a,this.newTree)},p.prototype.getOldTreeNode=function(a){return this.is_inner_action?a:this.getCorrespondingNodeFromTree(a,this.oldTree)},p.prototype.getCorrespondingNodeFromTree=function(a,b){var c=function(a){return a.get_root()===b?a:b.get_child(a.get_path())};return Array.isArray(a)?a.map(c):c(a)},p.prototype.addTouchedNodes=function(a){var b=this;Va.for_each(function(a){b.touched_nodes[a.id]=!0},a)},p.prototype.getOrInferTriggerType=function(){return this.triggerType?this.triggerType:this.actor?"tap":this.nodes?"drag":"unknown"},p.prototype.setNodesToReselectAfterAction=function(a){Array.isArray(a)?this.new_selection=a.slice():this.new_selection=[a]},p.cleanupInPlace=function(a){if(!a.cleanupAction)return!1;if(!a.cleanupAction.match(a))return!1;for(var b=a;b.parent&&"AlgebraModel"!==b.type;)b=b.parent;a.cleanupAction.createAndDoInPlace(b,{actor:a})},p.prototype.cleanup=function(a){if(!a.cleanupAction)return!1;if(!a.cleanupAction.match(a))return!1;var b=a.cleanupAction.createAndDoInPlace(this.newTree,{actor:a,is_inner_action:!0});return this.compose(b,!1),b},p.prototype.cleanup_cascade=function(a){for(var b=!1;;){var c=this.cleanup(a);if(!c)return b;b=!0;var d=c.mapNodes(a);if(0===d.length)return b;a=d[0].parent}},p.prototype.applyInnerAction=function(a,b){var c=Wa.actions[a];if(!c.match(b.actor))return!1;var d=b.tree||b.actor,e=d;if("AlgebraModel"!==d.type){var f=new Va.Node;f.children=[d],f.type="AlgebraModel"}return this.compose(c.createAndDoInPlace(e,{actor:b.actor,is_inner_action:!0})),!0},p.prototype.compose=function(a){var b=arguments.length<=1||void 0===arguments[1]||arguments[1];for(var c in this.node_map){var d=this.node_map[c];this.node_map[c]=a.mapNodes(d);var e=d.filter(function(b){return!a.node_map[b.id]});if(e.length>0&&b&&!a.is_inner_action)throw"Second mapping does not mention all nodes from first mapping.";this.node_map[c]=this.node_map[c].concat(e),a.touched_nodes[c]&&(this.touched_nodes[c]=!0)}this.new_selection&&(this.new_selection=a.mapNodes(this.new_selection)),a.is_inner_action||(this.newTree=a.newTree)},p.prototype.run=function(a){return this.newTree=this.oldTree.clone(),this.doInPlace(a)},p.prototype.match=function(){throw"called abstract method Action.match()"},p.prototype.rematch=function(){if(!(this.actor||this.nodes&&this.nodes.length>0&&this.target&&(!Array.isArray(this.target)||this.target.length>0)))return!1;if(this.actor)return this.match(this.actor);if(this.getAllAvailableActions){var a=this.getAllAvailableActions(this.nodes);return a.some(function(a){return Array.isArray(a.target)?Wa.array.equals(a.target,this.target):a.target===this.target},this)}},p.prototype.transform=function(a){throw"called abstract method Action.transform()"},p.prototype.doInPlace=function(a){this.initNodeMap();var b=this.transform(a);return this.removeDeletedNodesFromNodeMap(),b},p.prototype.wasNodeTouched=function(a){return this.touched_nodes[a.id]},p.prototype.mapNodes=function(a){var b=[],c=this;return Array.isArray(a)||(a=[a]),a.forEach(function(a){var d=c.node_map[a.id]||[];d.forEach(function(a){b.indexOf(a)===-1&&b.push(a)})}),b},p.prototype.unmapNodes=function(a){var b=[];Array.isArray(a)||(a=[a]);for(var c in this.node_map)Wa.array.isPermutation(a,this.node_map[c])&&b.push(this.oldTree.get_by_id(c));return b},p.createComposedAction=function(a,b,c){function d(){function b(c,d,f){return f>=a.length?c:(e.touched_nodes[d]||(e.touched_nodes[d]=c.some(a[f].wasNodeTouched.bind(a[f]))),b(a[f].mapNodes(c),d,f+1))}e.node_map={},e.touched_nodes={};for(var c in a[0].node_map)e.touched_nodes[c]=a[0].touched_nodes[c],e.node_map[c]=b(a[0].node_map[c],c,1)}var e=new p(b,c);return d(),e.oldTree=a[0].oldTree,e.newTree=a[a.length-1].newTree,e.new_selection=a[a.length-1].new_selection,e},Wa.AlgebraRegExp=q,q.getRegExpParser=function(){if(!q.regexpParser){var a=o(fa.getDefaultParser().symbols);a.registerSymbol(":",1).led=function(b){var c=a.parseExpression(0),d="?"===b.value[0];return c.match_name=d?b.value.slice(1):b.value,c.match_optional=d,c},["NUM","VAR","ANY"].forEach(function(b){a.registerSymbol("\\"+b).nud=function(){return new Wa.expressions.placeholder(b.toLowerCase())}}),q.regexpParser=a}return q.regexpParser},q.prototype.getVariations=function(a,b){b=b||0;var c=a.select_first(function(a){return a.match_optional});if(!c)return[a];c.match_optional=!1;var d=a.clone(!1,["id","value","name","bp","associative","commutative","vertical_notation","match_name","match_optional"]),e=this.getVariations(d,b+1),f=new p;if(f.newTree=a,c.parent.commutative&&(c=c.parent),c.commutative)c.remove(),f.cleanup_cascade(c.parent),e=e.concat(this.getVariations(a,b+1));else if(0===b)throw"only nodes in commutative groups can be optional";return e},q.prototype.combineWith=function(a){this.simple_models=this.simple_models.concat(a.simple_models)},q.prototype.match_node=function(a,b){return!(!a.is_group("sym")||!b.is_group("sym")||"±"!==b.value||"-"!==a.value&&"+"!==a.value)||(!(!a.is_group("add","sub")||!b.is_group("addsub"))||(!(!a.is_group("sign")||!b.is_group("plusminus"))||a.name===b.name&&a.value===b.value&&a.children.length===b.children.length))},q.checkAndSetMatch=function(a,b,c){return!b||(!a[b]||a[b].to_ascii()===c.to_ascii())&&(a[b]=c,!0)},q.prototype.match_tree=function(a,b,c){if(b.is_group("plusminus")&&!a.is_group("sign","plusminus")){if(!q.checkAndSetMatch(c,b.match_name,a))return!1;b=b.children[1]}if(b.is_group("brackets")&&b.children[1].is_group("plusminus")&&!a.is_group("brackets")){if(!q.checkAndSetMatch(c,b.match_name,a))return!1;b=b.children[1].children[1]}if(b.is_group("placeholder")){var d=b.match(a);return!!d&&!!q.checkAndSetMatch(c,b.match_name,a)}if(!q.checkAndSetMatch(c,b.match_name,a))return!1;if(!this.match_node(a,b))return!1;for(var e=0;e<a.children.length;e++){var d=this.match_tree(a.children[e],b.children[e],c);if(!d)return!1}return!0},q.prototype.match=function(a){for(var b={},c="AlgebraModel"===a.type?a.children[0]:a,d=0;d<this.simple_models.length;d++){var e=this.match_tree(c,this.simple_models[d].children[0],b);if(e)return b}return!1},eb={},eb.registerAtParser=function(a){a.registerSymbol("\\quad").nud=function(){return a.parseExpression(0)}},Wa.expressions.latex=eb,fb=function(a,b){Va.Node.call(this),arguments.length>1&&(this.bp=b),arguments.length>0&&(this.value=a)},Wa.inherit(Va.Node,fb),fb.prototype.to_ascii=function(a){return this.children.map(function(b){return b.is_group()&&b.commutative&&!b.ls&&b.associative?b.children[1].to_ascii(a):b.to_ascii(a)}).join("")},fb.prototype.to_latex=function(){return this.children.map(function(a){return a.is_group()&&a.commutative&&!a.ls&&a.associative?a.children[1].to_latex():a.to_latex()}).join("")},fb.prototype.is_group=function(a){if(0===arguments.length)return!0;for(var b=0;b<arguments.length;b++)if(this.value===arguments[b])return!0;return!1},fb.prototype.get_last_child=function(){return this.children[this.children.length-1]},fb.prototype.is_leaf_node=!1,fb.prototype.has_subscript=function(){return!1},Wa.inherit(Va.Node,t),r.call(t,"sym"),t.mappings={"-":"−","*":"·","/":"·","//":""},t.prototype.to_string=function(){return""+this.to_string_value_modifier(this.get_base().value)+this.get_subscript_helper("to_string")},t.prototype.to_latex=function(){return this.hidden?"":""+this.to_latex_value_modifier(this.get_base().value)+this.get_subscript_helper("to_latex")},t.prototype.to_string_value_modifier=function(a){return"-"===a&&this.parent&&this.parent.is_group("sign")?"-":a in t.mappings?t.mappings[a]:a},t.prototype.to_latex_value_modifier=function(a){return"/"===a?"\\cdot ":"*"===a?"\\cdot ":"("===a?"\\left(":")"===a?"\\right)":"["===a?"\\left[":"]"===a?"\\right]":a},s.call(u,"sum",{bp:20}),u.prototype.to_ascii=function(a){return this.children.map(function(b,c){var d=b.children[1],e=!b.is_group("add")||c>0||d.is_group("plusminus","sign"),f=b.to_ascii(a);return"+"!==f[0]||e?f:f.substring(1)}).join("")},v.value2sym={add:"+",sub:"-",addsub:"±"},s.call(v,"add-sub",{group_class:u,group_name:"sum",bp:20,associative:!0,commutative:!0,has_inverse:!0}),v.prototype.invert=function(){"add"===this.value?this.setValue("sub"):"sub"===this.value&&this.setValue("add")},v.prototype.setValue=function(a){this.value=a,this.children[0].value=v.value2sym[a],this.associative="add"===a},v.prototype.symIsHidden=function(){return this.get_child([0]).hidden},v.prototype.map_group_and_sym=function(a,b,c){var d=c?"updateNodeMap":"extendNodeMap";a[d](this,b),a[d](this.children[0],b.children[0])},v.prototype.to_ascii=function(a){var b=!this.ls&&(this.children[1].is_group("product")||this.children[1].is_group("fraction")&&!this.children[1].children[1].is_group("mul"))&&this.children[1].children[0].children[1].is_group("plusminus","sign");return this.children[0].to_ascii(a)+this.children[1].to_ascii(a,b)},v.registerAtParser=function(a){function b(b){var d=a.parseExpression(v.prototype.bp);if(b.is_group("sum"))return b.append(new v(d,"addsub")),b;var e=c(b);return e.append(new v(d,"addsub")),e}var c=function(a){var b=v.prototype.createGroup(),c=a.is_group("product","fraction")?a.children[0].children[1]:null;return a.had_leading_plus?b.append(new v(a)):a.is_group("sign")&&!a.user_grouped?b.append(new v(a.children[1],"sub")):a.is_group("plusminus")&&!a.user_grouped?b.append(new v(a.children[1],"addsub")):c&&!c.user_grouped&&c.is_group("sign","plusminus")&&!c.had_leading_plus?(c.replace_with(c.children[1]),c.is_group("sign")&&b.append(new v(a,"sub")),c.is_group("plusminus")&&b.append(new v(a,"addsub"))):b.append(new v(a)),b},d=a.registerSymbol("+",v.prototype.bp);d.led=function(b){var d=a.parseExpression(v.prototype.bp);if(b.is_group("sum"))return b.append(new v(d,"add")),b;var e=c(b);return e.append(new v(d,"add")),e};var e=a.registerSymbol("-",v.prototype.bp),f=a.registerSymbol("–",v.prototype.bp);e.led=function(b){var d=a.parseExpression(v.prototype.bp);if(b.is_group("sum"))return b.append(new v(d,"sub")),b;var e=c(b);return e.append(new v(d,"sub")),e},f.led=e.led;var g=["±","\\pm"];g.forEach(function(c){a.registerSymbol(c,v.prototype.bp).led=b})},Wa.expressions.addsub=v,Wa.inherit(Va.Node,w),w.prototype.name="bool",w.prototype.to_string=function(){return this.value},w.prototype.to_ascii=w.prototype.to_string,w.prototype.is_group=function(){return!1},w.registerAtParser=function(a){var b=a.registerSymbol("(number)");b.nud=function(){return new w(this.value)}},Wa.expressions=Wa.expressions||{},Wa.expressions[w.prototype.name]=w,s.call(x,"brackets",{bp:0}),s.call(y,"abs-val",{bp:0}),x.registerAtParser=function(a){var b=a.registerSymbol("|");b.nud=function(){var b=a.parseExpression(0);return a.advance("\\right",!0),a.advance("|"),new y(b)},b.led=function(b){var c=a.parseExpression(K.prototype.bp,this);return K.createProduct(b,c)};var c=a.registerSymbol("[",30);c.nud=function(){var b=a.parseExpression(0);return a.advance("\\right",!0),a.advance("]"),new x(b,"[","]")},c.led=function(b){var c=a.parseExpression(K.prototype.bp,this);return K.createProduct(b,c)},a.registerSymbol("]");var d=a.registerSymbol("(",30);d.nud=function(){var b=a.parseExpression(0);return a.advance("\\right",!0),a.advance(")"),new x(b)},d.led=function(b){var c=a.parseExpression(K.prototype.bp,this);return K.createProduct(b,c)},a.registerSymbol(")");var e=a.registerSymbol("\\left",30);e.nud=function(){return a.advance("[",!0)?c.nud():a.advance("(",!0)?d.nud():a.advance("|",!0)?b.nud():void 0},e.led=function(e){return a.advance("[",!0)?c.led(e):a.advance("(",!0)?d.led(e):a.advance("|",!0)?b.led(e):void 0},a.registerSymbol("\\right");var f=a.registerSymbol("{",30);f.nud=function(){var b=a.parseExpression(0);return b.user_grouped=!0,a.advance("}"),b},f.led=d.led,a.registerSymbol("}")},x.areHidden=function(a){return a&&a.is_group("brackets")&&a.children[0].hidden},x.handle=function(a,b){if(a.is_group("brackets"))return!(!b||!x.is_optional(a))&&(Va.replace(a,a.children[1]),"removed");if(!x.is_optional(a)){var c=Va.remove(a);return Va.insert(a.parent,c,new x(a)),"added"}return!1},x.is_optional=function(a,b){if(a.is_group("brackets")&&a.children[1].is_group("brackets"))return!0;var c=a.is_group("brackets")?a.children[1]:a,b=b||a.parent;return!(c.is_group("tuple")&&!b.is_group("func"))&&(!!b.is_group("tuple")||(!!c.is_group("abs-val")||(!c.has_children()||(b instanceof fa||(!(!b.is_group("radical")||b.get_radicand()!==a)||(!(!b.has_subscript()||b.get_subscript()!==a)||(!(!b.is_group("sign","plusminus")||!c.is_group("fraction"))||(b.is_group("func")&&c.is_group("tuple")?1===b.arg_length()&&b.get_arg().is_leaf_node:!(b.bp>c.bp)&&(!!c.is_group("sign","plusminus")||(b.bp<c.bp||(!(!b.is_group("sign")||!c.is_group("sign"))||(!(!b.associative||!c.is_group(b.group_name))||(!(!c.commutative||!b.is_group(c.group_name))||(!(!c.is_group("mul","div")||!b.is_group("fraction"))||(!!(c.is_group("product")&&b.is_group("div")&&b.parent&&b.parent.is_group("fraction"))||!(!c.is_group("fraction")||!b.is_group("mul","div")))))))))))))))))},s.call(z,"disjunction",{bp:30}),s.call(A,"and",{group_name:"disjunction",group_class:z,bp:30,associative:!0,commutative:!0}),A.registerAtParser=function(a){var b=a.registerSymbol("*",A.prototype.bp);b.led=function(b){var c=a.parseExpression(A.prototype.bp);if(b.is_group("disjunction"))return b.append(new A(c)),b;var d=A.prototype.createGroup();return d.append(new A(b)),d.append(new A(c)),d}},s.call(B,"conjunction",{bp:30}),s.call(C,"or",{group_name:"conjunction",group_class:B,bp:20,associative:!0,commutative:!0}),C.registerAtParser=function(a){var b=a.registerSymbol("+",C.prototype.bp);b.led=function(b){var c=a.parseExpression(C.prototype.bp);if(b.is_group("conjunction"))return b.append(new C(c)),b;var d=C.prototype.createGroup();return d.append(new C(b)),d.append(new C(c)),d}},s.call(D,"radical",{bp:50,vertical_notation:!1}),D.prototype.set_degree=function(a){var b;this.has_children()&&this.children[0].is_group("degree")&&this.children[0].remove(),b=a&&a.is_group("degree")?a:new F(a?a:new E(2)),this.insert(0,b)},D.prototype.init_symbols=function(){this.insert(1,new t("√")),this.insert(2,new t("//"))},D.prototype.set_radicand=function(a){this.has_children()&&this.children[3]&&this.children[3].remove(),a&&(this.insert(3,a),x.handle(a))},D.prototype.is_square_root=function(){return this.match("sqrt[2]\\ANY")},D.prototype.get_degree=function(){return this.children[0]},D.prototype.get_degree_term=function(){return this.children[0].get_term()},D.prototype.get_radicand=function(){return this.children[3]},D.prototype.map_to_radical=function(a,b,c){var d=c?a.updateNodeMap.bind(a):a.extendNodeMap.bind(a);d(this,b),d(this.children[0],b.children[0]),d(this.children[1],b.children[1]),d(this.children[2],b.children[2])},D.parsable_syms=["sqrt","\\sqrt","√"],D.registerAtParser=function(a){var b=function(){var b=new D,c=a.parseExpression(1/0);if(c.is_group("brackets")&&"["===c.children[0].value){var d=c.children[1];b.set_degree(d);var e=a.parseExpression(1/0);b.set_radicand(e)}else b.set_radicand(c);return b},c=function(b){var c=a.parseExpression(K.prototype.bp,this);return K.createProduct(b,c)};D.parsable_syms.forEach(function(d){var e=a.registerSymbol(d,D.prototype.bp);e.nud=b,e.led=c})},D.prototype.to_ascii=function(a){var b=this.get_radicand().to_ascii(a);if(a&&a.roots_as_powers){var c=this.get_degree_term().to_ascii(a);return"("+b+")^(1/("+c+"))"}var d="sqrt";return 2!==this.get_degree().get_term().value&&(d+=this.get_degree().to_ascii(a)),b.length>1?d+"{"+b+"}":d+b},D.prototype.to_latex=function(){return"\\"+this.to_ascii()},Wa.inherit(Va.Node,E),r.call(E,"num"),E.is_num=function(a){return a.is_group("num")||a.is_group("sign","add","sub")&&a.children[1]&&a.children[1].is_group("num")},E.get_value=function(a){return a?a instanceof E?a.get_base().value:a.is_group("sign")&&a.children[1]instanceof E?-a.children[1].get_base().value:a.is_group("add")&&a.children[1]instanceof E?a.children[1].get_base().value:a.is_group("sub")&&a.children[1]instanceof E?-a.children[1].get_base().value:NaN:NaN},E.is_equal_to=function(a){for(var b=E.get_value(a),c=arguments.length,d=Array(c>1?c-1:0),e=1;e<c;e++)d[e-1]=arguments[e];return!isNaN(b)&&d.some(function(a){return a===b})},E.is_inequal_to=function(a,b,c){var d=E.get_value(a);if(isNaN(d))return!1;if("<"===b||"lt"===b)return d<c;if(">"===b||"gt"===b)return d>c;if("<="===b||"lte"===b)return d<=c;if(">="===b||"gte"===b)return d>=c;throw"(Num:is_inequal_to) Comparator not accepted."},E.prototype.get_signed_value=function(){var a=this.parent;if(!a)return this.get_base().value;var b=this.get_base().value;return a&&a.is_group("sign","sub")?-b:E.is_leading_num_in_sub_product(this)?-b:b},E.is_leading_num_in_sub_product=function(a){var b=a.parent;return!!(a instanceof E&&b.is_group("mul")&&!b.ls&&b.parent.is_group("product")&&b.parent.parent.is_group("sub"))&&b.parent.parent},E.apply_precision=function(a,b){var c=Math.pow(10,b);return Math.round(a*c)/c},E.prototype.decimal_count=function(){var a=this.get_base().to_ascii(),b=a.indexOf(".");return b===-1?0:a.length-b-1},E.prototype.to_string=function(){if(this.value===1/0)return"∞";var a=this.value;return this.scrubbingThisNum?a.toFixed(2):E.apply_precision(a,this.view_precision).toString()},E.prototype.to_ascii=function(a){var b=E.apply_precision(this.get_base().value,this.max_precision),c=this.get_subscript_helper("to_ascii",a),d=void 0;if(a&&a.rationalize_reals)if(Math.round(b)===b)d=b+c;else{var e=b.toString().split(".");d="("+("0"===e[0]?e[1]:e[0]+e[1])+"/1"+Array(e[1].length+1).join("0")+")"}else d=""+b+c;return c.length>0&&a&&a.subscripts_as_long_names?'"'+d+'"':d},E.prototype.to_latex=function(){return""+E.apply_precision(this.get_base().value,this.max_precision)+this.get_subscript_helper("to_latex")},E.registerAtParser=function(a){var b=a.registerSymbol("(number)",30);b.nud=function(){return new E(this.value)},b.led=function(b){var c=a.parseExpression(MulDiv.prototype.bp,this);return MulDiv.createProduct(b,c)}},s.call(F,"degree",{group_class:D,group_name:"radical",bp:51,vertical_notation:!0}),F.prototype.get_term=function(){return x.areHidden(this.children[0])?this.children[0].children[1]:this.children[0]},F.prototype.to_ascii=function(a){return 0===this.children.length?"":"["+this.children[0].to_ascii(a)+"]"},F.prototype.to_latex=function(){return 0===this.children.length?"":"["+this.children[0].to_latex()+"]"},F.hide_rule={name:"hide degree of 2",disabled:!1,apply:function(a){a.parent.is_group("degree")&&E.is_equal_to(a,2)&&(a.hidden=!0)}},G.unicode_syms=["≤","≥","<",">"],G.value2sym={lte:"≤",gte:"≥",lt:"<",gt:">"},G.sym2Ascii={"≤":"<=","≥":">=","<":"<",">":">"},s.call(G,"inequality",{bp:10}),G.prototype.to_ascii=function(a){return this.children.map(function(b,c){return 1===c?G.sym2Ascii[b.to_ascii(a)]:b.to_ascii(a)}).join("")},G.is_inequality=function(a){return a.is_group("lte","gte","lt","gt")},G.prototype.setValue=function(a){this.value=a,this.get_child([1]).value=G.value2sym[this.value]},G.prototype.invert=function(){"lte"===this.value?this.setValue("gte"):"gte"===this.value?this.setValue("lte"):"lt"===this.value?this.setValue("gt"):"gt"===this.value&&this.setValue("lt")},G.registerAtParser=function(a){var b={"<":"lt","\\lt":"lt",">":"gt","\\gt":"gt","<=":"lte","\\le":"lte",
"≤":"lte",">=":"gte","\\ge":"gte","≥":"gte"};for(var c in b)a.registerSymbol(c,G.prototype.bp).led=function(b,c){var d=a.parseExpression(G.prototype.bp);if(G.is_inequality(c)||G.is_inequality(d)||c.is_group("equals")||d.is_group("equals"))throw"More than one comparator in equation.";return new G(c,d,b)}.bind(null,b[c])},s.call(H,"equals",{bp:10}),H.registerAtParser=function(a){var b=a.registerSymbol("=",H.prototype.bp);b.led=function(b){var c=a.parseExpression(H.prototype.bp);if(b.is_group("equals")||c.is_group("equals")||G.is_inequality(b)||G.is_inequality(c))throw"More than one comparator in equation.";return new H(b,c)}},H.prototype.getSideOfNode=function(a){for(;!(a.parent instanceof H);)a=a.parent;return a},H.prototype.getOppositeSideOfNode=function(a){return this.isOnLeftSide(a)?this.getRightSide():this.getLeftSide()},H.prototype.getLeftSide=function(){return this.children[0]},H.prototype.getRightSide=function(){return this.children[2]},H.prototype.isOnLeftSide=function(a){return this.getSideOfNode(a)==this.getLeftSide()},H.prototype.isOnRightSide=function(a){return this.getSideOfNode(a)==this.getRightSide()},H.prototype.areOnSameSide=function(a,b){var c=this.isOnLeftSide(a),d=this.isOnLeftSide(b);return c&&d||!c&&!d},s.call(I,"power",{bp:50,vertical_notation:!1}),I.prototype.is_square_root=function(){return this.match("\\ANY^0.5","\\ANY^(1/2)")},I.prototype.get_exponent_term=function(){return this.children[1].get_term()},I.getNumericalValueOfExponent=function(a){return a.is_group("power")||a.is_group("exponent")?(a.is_group("exponent")?a=a.children[0]:a.is_group("power")&&(a=a.get_child([1,0])),x.areHidden(a)&&(a=a.children[1]),E.get_value(a)):1},I.haveSameBase=function(a,b){return a.is_group("power")&&(a=a.children[0]),b.is_group("power")&&(b=b.children[0]),a.to_ascii()===b.to_ascii()},s.call(J,"product",{bp:30,vertical_notation:!1}),J.prototype.invert=function(){var a=this.children.length;if("product"==this.value){this.value="fraction",this.vertical_notation=!0;for(var b=this.children[a-1],c=a-1;b&&"div"==b.value;)b=b.ls,c--;b&&"//"===b.value||Va.insert(this,c+1,new t("//"))}else if(this.value="product",this.vertical_notation=!1,a>0)for(var d=this.children[0];d;)"//"==d.value&&Va.remove(d),d=d.rs},J.prototype.append=function(a){if("product"==this.value&&"div"==a.value)this.invert(),Va.append(this,a);else if("fraction"==this.value&&"mul"==a.value){for(var b=0;b<this.children.length&&"//"!==this.children[b].value;)b++;Va.insert(this,b,a)}else Va.append(this,a);return this};J.prototype.insert=function(a,b,c){if("product"==this.value&&"div"==b.value)this.invert(),Va.append(this,b);else if("fraction"==this.value&&"mul"==b.value){var d=this.get_top().length;a>d&&(a=d),Va.insert(this,a,b)}else if("fraction"==this.value&&"div"==b.value&&c){a+=this.get_top().length+1;var e=this.children.length;a>e&&(a=e),Va.insert(this,a,b)}else Va.insert(this,a,b)};J.prototype.append_range=function(a){a.forEach(function(a){this.append(a)},this)},J.prototype.insert_range=function(a,b,c){"product"==this.value&&"div"==b[0].value?this.append_range(b):b.forEach(function(b){this.insert(a++,b,c)},this)},J.prototype.insert_into_demominator=function(a,b){if(!b.is_group("div"))throw'wrong type of term, expected "div", not "'+b.name+'"';if("product"==this.value)this.invert(),Va.append(this,b);else{for(var c=0;c<this.children.length&&"//"!==this.children[c].value;)c++;c=Math.max(this.children.length,c+1+a),Va.insert(this,c,term)}return this},J.prototype.get_top=function(){for(var a=this.children[0],b=[];a;)"mul"==a.value&&b.push(a),a=a.rs;return b},J.prototype.get_bottom=function(){for(var a=this.children[0],b=[];a;)"div"==a.value&&b.push(a),a=a.rs;return b},J.prototype.get_fraction_bar=function(){for(var a=this.children[0];a;){if("//"==a.value)return a;a=a.rs}return null},J.convert_to_reciprocal=function(a){function b(a){Va.remove_range(a),a.forEach(function(a){a.invert()})}var c=!1;if(a.is_group("sign")&&(c=!0,a=a.children[1]),E.is_equal_to(a,1))return c?a.parent:a;var d;if(a.is_group("fraction")&&1===a.get_top().length&&E.is_equal_to(a.get_top()[0].children[1],1)&&1===a.get_bottom().length){var e=a.parent,f=a.remove();d=a.get_bottom()[0].children[1],d.remove(),e.insert(f,d)}else if(a.is_group("fraction")){d=a;var g=a.get_top(),h=a.get_bottom();b(g),b(h),a.append_range(h),1===g.length&&E.is_equal_to(g[0].children[1],1)?a.invert():a.append_range(g)}else if(a.is_group("product")){d=a;var g=a.get_top();b(g),a.invert(),a.append(new K(new E(1))),a.append_range(g)}else{var e=a.parent,i=a.remove(),j=new J;j.invert(),j.append(new K(new E(1))),j.append(new K(a,"div")),e.insert(i,j),d=j}return c?d.parent:d},J.is_fraction=function(a){return a.is_group("fraction")||a.is_group("sign")&&a.children[1].is_group("fraction")},J.is_fraction_with_identity_numerator=function(a){return!(!a.is_group("fraction")||!J.is_lone_fraction_part(a.children[0]))&&E.is_equal_to(a.get_child([0,1]),1)},J.is_lone_fraction_part=function(a){return a.is_group("mul")&&!a.ls&&"//"===a.rs.value||a.is_group("div")&&!a.rs&&"//"===a.ls.value},J.matchSource=function(a){return!a.is_group("mul")&&(a.is_group("div")&&(a=a.parent),!!a.is_group("fraction")&&(1===a.get_bottom().length&&{fraction:a,mul:a.get_top()[0],div:a.get_bottom()[0]}))},J.getSourceAndTarget=function(a){if("drag"===this.triggerType)return{source:a?this.nodes:this.nodes[0],target:this.target};var b=J.matchSource(this.actor);return{source:b.div,target:b.mul}},J.prototype.group_nodes=function(){for(var a,b=this.children[0],c=[],d=[];b;)"div"==b.value?d.push(b):"mul"==b.value?c.push(b):a=b,b=b.rs;return{top:c,bottom:d,bar:a}},J.prototype.to_latex=function(){for(var a=this.get_top(),b=this.get_bottom(),c=b.length>0?"\\frac{":"",d=0;d<a.length;d++)c+=0==d?a[d].children[1].to_latex():a[d].to_latex();if(b.length>0){c+="}{";for(var d=0;d<b.length;d++)c+=0==d?b[d].children[1].to_latex():b[d].to_latex();c+="}"}return c},J.prototype.to_ascii=function(a,b){for(var c=this.get_top(),d=this.get_bottom(),e=[],f=[],g=0;g<c.length;g++){var h=(0===g?"":"*")+c[g].children[1].to_ascii(a);b&&0===g?e.push("{"+h+"}"):e.push(h)}var i=e.join("");if(0==d.length)return this.finish_ascii(i,a);for(var g=0;g<d.length;g++)f.push((0==g?"":"*")+d[g].children[1].to_ascii(a));var j=f.join("");c.length>1&&(i="("+i+")"),d.length>1&&(j="("+j+")");var k=i+"/"+j;return this.finish_ascii(k,a)},J.prototype.finish_ascii=function(a,b){if(this.is_group("fraction")&&this.parent){var c=this.parent.parent;if(c&&c.is_group("fraction")){if(this.parent.is_group("mul")&&1===c.get_top().length)return"{"+a+"}";if(this.parent.is_group("div")&&1===c.get_bottom().length)return"{"+a+"}"}}return a},s.call(K,"mul-div",{group_class:J,bp:30,associative:!0,commutative:!0,has_inverse:!0}),K.createProduct=function(a,b){if(a.is_group("product"))return a.append(new K(b)),a;var c=K.prototype.createGroup();return c.append(new K(a)),c.append(new K(b)),c},K.registerAtParser=function(a){var b=a.registerSymbol("*",K.prototype.bp);b.led=function(b){var c=a.parseExpression(K.prototype.bp);return K.createProduct(b,c)};var c=a.registerSymbol("\\cdot",K.prototype.bp);c.led=b.led;var d=a.registerSymbol("\\times",K.prototype.bp);d.led=b.led;var e=a.registerSymbol("/",K.prototype.bp+1);e.led=function(b){var c,d=a.parseExpression(K.prototype.bp+1);if(b.is_group("brackets")&&b.children[1].is_group("product")&&(b=b.children[1],b.children[0].children[1].user_grouped=!0),b.is_group("product")?c=b:(c=K.prototype.createGroup(),c.append(new K(b))),d.is_group("brackets")&&d.children[1].is_group("product")&&(d=d.children[1]),d.is_group("product"))for(var e=d.children,f=0;f<e.length;f++)e[f].invert(),c.append(e[f]);else c.append(new K(d,"div"));return c};var f=function(){var b,c=a.parseExpression(100),d=a.parseExpression(100);return c.is_group("product")?(b=c,c.children[0].children[1].user_grouped=!0):(b=K.prototype.createGroup(),b.append(new K(c))),d.is_group("product")?d.children.forEach(function(a){a.invert(),b.append(a)}):b.append(new K(d,"div")),b};a.registerSymbol("\\frac").nud=f,a.registerSymbol("\\dfrac").nud=f,a.registerSymbol("\\tfrac").nud=f},K.hide_rule={name:"hide multiplication sign between variables",disabled:!1,apply:function(a){if(!(a instanceof t)||"*"!==a.value&&"/"!==a.value)return!1;var b=a.parent;if(!b||!b.is_group("mul")&&!b.is_group("div"))return!1;if(!b.ls||b.ls.value!==b.value||!a.rs)return!1;var c=b.ls.children[1];(a.rs.is_group("var")||a.rs.is_group("power")&&a.rs.children[0].is_group("var"))&&(E.is_num(c)||c.is_group("var")||c.is_group("sign")&&c.children[1].is_group("var"))&&(b.dragging?a.hide_after_drop=!0:a.hidden=!0)}},K.prototype.invert=function(){"mul"==this.value?(this.value="div",this.children[0]&&(this.children[0].value="/"),this.associative=!1,this.bp=30):(this.value="mul",this.children[0]&&(this.children[0].value="*"),this.associative=!0,this.bp=30)},K.prototype.symIsHidden=function(){return this.get_child([0]).hidden},K.prototype.map_group_and_sym=function(a,b,c){var d=c?a.updateNodeMap.bind(a):a.extendNodeMap.bind(a);d(this,b),d(this.children[0],b.children[0])},Wa.inherit(Va.Node,L),r.call(L,"var"),L.prototype.to_ascii=function(a){var b=this.to_ascii_value_modifier(this.get_base().value),c=this.get_subscript_helper("to_ascii",a);return c.length>0&&a&&a.subscripts_as_long_names?'"'+b+c+'"':b.toString()+c},L.prototype.to_ascii_value_modifier=function(a){return a.length>1?'"'+a+'"':a},L.constant_values=["i"],L.constant_value=function(a){return Boolean(~Wa.findIndex(L.constant_values,function(b){return b===a}))},L.is_constant=function(a){return Boolean(a instanceof L&&L.constant_value(a.value)||a.is_group("sign")&&L.constant_value(a.children[1].value))},L.is_var=function(a){return a instanceof L||a.is_group("power")&&a.children[0]instanceof L},L.latex_to_unicode={"(name)":"","\\alpha":"α","\\Alpha":"Α","\\beta":"β","\\Beta":"Β","\\gamma":"γ","\\Gamma":"Γ","\\delta":"δ","\\Delta":"Δ","\\epsilon":"ε","\\Epsilon":"Ε","\\zeta":"ζ","\\Zeta":"Ζ","\\eta":"η","\\Eta":"Η","\\theta":"θ","\\Theta":"Θ","\\iota":"ι","\\Iota":"Ι","\\kappa":"κ","\\Kappa":"Κ","\\lambda":"λ","\\Lambda":"Λ","\\mu":"μ","\\Mu":"Μ","\\nu":"ν","\\Nu":"Ν","\\xi":"ξ","\\Xi":"Ξ","\\omicron":"ο","\\Omicron":"Ο","\\pi":"π","\\Pi":"Π","\\rho":"ρ","\\Rho":"Ρ","\\sigma":"σ","\\Sigma":"Σ","\\tau":"τ","\\Tau":"Τ","\\upsilon":"υ","\\Upsilon":"Υ","\\phi":"φ","\\Phi":"Φ","\\chi":"χ","\\Chi":"Χ","\\psi":"ψ","\\Psi":"Ψ","\\omega":"ω","\\Omega":"Ω"},L.utf8_subscripts=[{char:"₀",val:0},{char:"₁",val:1},{char:"₂",val:2},{char:"₃",val:3},{char:"₄",val:4},{char:"₅",val:5},{char:"₆",val:6},{char:"₇",val:7},{char:"₈",val:8},{char:"₉",val:9}],L.registerAtParser=function(a){var b=a.registerSymbol("_",100);b.led=function(b){var c=a.parseExpression(99);if(b.is_leaf_node)b.set_subscript(c,!0);else{var d=b.children[b.children.length-1];if(!d.is_leaf_node)return!1;d.set_subscript(c,!0)}return b},L.utf8_subscripts.forEach(function(b){a.registerSymbol(b.char,100).led=function(a){return!!a.is_leaf_node&&(a.set_subscript(new E(b.val)),a)}});var c=function(){return new L("name"===this.type?this.value:L.latex_to_unicode[this.value])},d=function(b){var c=a.parseExpression(K.prototype.bp,this);return K.createProduct(b,c)};for(var e in L.latex_to_unicode){var f=a.registerSymbol(e,30);f.nud=c,f.led=d}},s.call(M,"exponent",{group_class:I,group_name:"power",bp:51,vertical_notation:!0}),M.prototype.get_term=function(){return x.areHidden(this.children[0])?this.children[0].children[1]:this.children[0]},M.prototype.to_ascii=function(a){return 0===this.children.length?"":"^"+this.children[0].to_ascii(a)},M.prototype.to_latex=function(){if(0===this.children.length)return"";var a=this.children[0].to_latex();return a.length<2||this.children[0].is_group("brackets","abs-val")&&!x.areHidden(this.children[0])?"^"+a:"^{"+a+"}"},M.registerAtParser=function(a){a.registerSymbol("^",M.prototype.bp).led=function(b){var c=a.parseExpression(M.prototype.bp-1);return new I(b,c)};var b=[{char:"⁰",val:0},{char:"¹",val:1},{char:"²",val:2},{char:"³",val:3},{char:"⁴",val:4},{char:"⁵",val:5},{char:"⁶",val:6},{char:"⁷",val:7},{char:"⁸",val:8},{char:"⁹",val:9}];b.forEach(function(b){a.registerSymbol(b.char,M.prototype.bp).led=function(a){return new I(a,new E(b.val))}}),a.registerSymbol("ⁿ",M.prototype.bp).led=function(a){return new I(a,new L("n"))},a.registerSymbol("\\scriptscriptstyle").nud=function(){var b=a.parseExpression(M.prototype.bp);return b}},Wa.inherit(fb,N),s.call(N,"func",{bp:60,commutative:!1}),N.units={sin:["rad","deg"],cos:["rad","deg"],tan:["rad","deg"]},N.prototype.is_leaf_node=!1,N.prototype.is_group=function(){if(0===arguments.length)return!0;for(var a=0;a<arguments.length;a++){if("func"===arguments[a])return!0;if(arguments[a]===this.value)return!0}return!1},N.prototype.to_string=function(){return this.value},N.prototype.set_arg=function(a){if(Array.isArray(a))this.append(new x(new R(a)));else if(a.is_group("tuple"))this.append(a),x.handle(this.children[1]);else if(a.is_group("brackets")&&a.children[1].is_group("tuple"))this.append(a);else if(a.is_group("brackets")&&!a.children[1].is_group("tuple")){var b=a,c=b.children[1];b.insert(c.remove(),new R(c)),this.append(b)}else this.append(new R(a)),x.handle(this.children[1])},N.prototype.arg_length=function(){var a=this.children[1],b=a.is_group("tuple")?a:a.children[1];return b.children.length},N.prototype.get_arg=function(a){var b=this.children[1];return b.get_child(b.is_group("brackets")?[1,a||0,1]:[a||0,1])},N.prototype.map_to_func=function(a,b,c){var d=c?a.updateNodeMap.bind(a):a.extendNodeMap.bind(a);d(this,b),d(this.children[0].get_mapping_to(b.children[0]));var e=this.children[1],f=b.children[1];e.is_group("brackets")&&f.is_group("brackets")&&(d(e,f),d(e.children[0],f.children[0]),d(e.children[2],f.children[2]),e=e.children[1],f=f.children[1]),d(e,f)},N.prototype.map_to_group=function(a,b,c){var d=c?a.updateNodeMap.bind(a):a.extendNodeMap.bind(a),e=[];this.for_each(function(a){e.push(a)},this),e.forEach(function(a){d(a,b)}),d=a.extendNodeMap.bind(a),b.children.forEach(function(a){a.for_each(function(a){e.forEach(function(b){d(b,a)})},this)},this)},N.Trig={},N.Trig.evaluate=function(a){var b=E.get_value(a.get_arg());return Number.isNaN(b)?NaN:("deg"===a.units&&(b*=Math.PI/180),Math[a.value](b))},N.Trig.is_trig_func=function(a){return a&&a.is_group("func")&&("sin"===a.value||"cos"===a.value||"tan"===a.value)},N.Logs={},N.Logs.is_log_func=function(a){return a&&a.is_group("func")&&("log"===a.value||"ln"===a.value)},N.Logs.get_log_base=function(a,b){var c;return a.children[0].has_subscript()&&(c=a.children[0].get_subscript()),c||b||(c=N.Logs.get_implied_subscript(a)),c},N.Logs.get_implied_subscript=function(a){var b=a.children[0].get_value();return"log"===b?new E(10):"ln"===b?new L("e"):null},N.Logs.within_domain=function(a){return E.is_inequal_to(a,"gt",0)||L.is_var(a)&&"e"===a.get_value()},N.Logs.evaluate=function(a){var b=N.Logs.get_log_base(a).get_value(),c=a.get_arg().get_value();return"e"===c&&(c=Math.E),"e"===b&&(b=Math.E),Math.log(c)/Math.log(b)},N.parsable_syms=["sin","cos","tan","\\sin","\\cos","\\tan","log","ln","\\log","\\ln"],N.registerAtParser=function(a){function b(b){if(a.advance("_",!0)){var c=b.children[0].value,d=a.parseExpression(99);("ln"===c&&E.is_num(d)||"ln"===c&&L.is_var(d)&&"e"!==d.value)&&(b.value="log",b.children[0].value="log"),b.children[0].set_subscript(d)}}var c=function(){var c=new N("\\"===this.value[0]?this.value.substr(1):this.value);b(c);var d=a.parseExpression(N.prototype.bp);return c.set_arg(d),c},d=function(b){var c=a.parseExpression(K.prototype.bp,this);return K.createProduct(b,c)};N.parsable_syms.forEach(function(b){var b=a.registerSymbol(b,N.prototype.bp);b.nud=c,b.led=d})},Wa.inherit(fb,O),O.prototype.name="param",O.prototype.bp=5,O.createTuple=function(a,b){if(a.is_group("tuple"))return a.append(new O(b)),a;var c=new R;return c.append(new O(a)),c.append(new O(b)),c},O.prototype.append=function(a){Va.append(this,a),a instanceof t&&(a.fixed=!0)},O.registerAtParser=function(a){var b=a.registerSymbol(",",O.prototype.bp);b.led=function(b){var c=a.parseExpression(O.prototype.bp);return O.createTuple(b,c)};var c=a.registerSymbol("\\,",O.prototype.bp);c.led=b.led},O.hide_rule={name:"Do not show the first comma in a tuple set.",disabled:!1,apply:function(a){if(!(a instanceof t)||","!==a.value)return!1;var b=a.parent;return!(!b||!b.is_group("param"))&&void(b.ls&&b.ls.value===b.value||(a.hidden=!0))}},Wa.expressions[O.prototype.name]=O,Wa.inherit(Va.Node,P),r.call(P,"placeholder"),P.prototype.to_string=function(){return"[]"},P.prototype.match=function(a){return"any"===this.value||a.name===this.value},P.prototype.to_ascii=function(a){return"\\"+this.value.toUpperCase()},P.prototype.to_latex=function(){return"\\"+this.value.toUpperCase()},P.prototype.is_group=function(){for(var a=0;a<arguments.length;a++)if("placeholder"===arguments[a])return!0;return!1},Wa.expressions[P.prototype.name]=P,s.call(Q,"sign",{bp:40,associative:!0,commutative:!1,inverse:"sign"}),Q.registerAtParser=function(a){function b(){var b=a.parseExpression(Q.prototype.bp);return new Q(b,!0)}a.registerSymbol("+").nud=function(){var b=a.parseExpression(Q.prototype.bp);return b.had_leading_plus=!0,b};var c=a.registerSymbol("-");c.nud=function(){var b=a.parseExpression(Q.prototype.bp);return new Q(b)};var d=["±","\\pm"];d.forEach(function(c){a.registerSymbol(c).nud=b}),a.registerSymbol("–").nud=c.nud},Q.prototype.deconstruct=function(){var a=[];return a.push(this),a},Q.prototype.to_ascii=function(a){var b=this.children[0].to_ascii(a),c=this.children[1].to_ascii(a),d=void 0;return d=this.children[1].is_group("fraction")?b+"{"+c+"}":b+c,a&&a.bracketed_negatives?"("+d+")":d},Q.wrapTerm=function(a){return Q.invertTerm(a,!1)},Q.invertTerm=function(a){var b=arguments.length<=1||void 0===arguments[1]||arguments[1],c=a;c.is_group("product")?c=c.children[0].children[1]:c.is_group("mul","div","add","sub")&&(c=c.children[1]);var d=c.parent;if(d){var e=c.remove();if(c.is_group("sign")&&b){var f=c.children[1];return d.insert(e,f),f}return d.insert(e,new Q(c))}if(c.is_group("sign")&&b){var g=c.children[1];return g.remove(),g.parent=null,g.ls=null,g.rs=null,g}return new Q(c)},Wa.inherit(fb,R),R.prototype.name="tuple",R.is_tuple=function(a){return a instanceof R||a.is_group("brackets")&&a.children[1]instanceof R},R.prototype.to_ascii=function(a){return this.children.map(function(b){return b.ls?b.to_ascii(a):b.children[1].to_ascii(a)}).join("")},R.prototype.to_latex=function(){return this.children.map(function(a){return a.ls?a.to_latex():a.children[1].to_latex()}).join("")},Wa.expressions[R.prototype.name]=R,S.prototype.check=function(a){if(this.view.model.options.locked)return!1;var b=a.pos0[1]-a.pos[1];return Math.abs(b)>=10},S.prototype.start=function(a,b){return this.old_anim_dur=this.view.options.dur,this.view.options.dur=0,this.node=this.process_selection(b),this.node?(this.node&&this.node.precision?this.precision=this.node.precision:this.precision=this.default_precision,this.dy=0,this.value=this.value0=this.view.model.numeric_value(this.node),[this.node]):[]},S.prototype.update=function(a){if(this.node&&a.dy){this.dy+=a.dy;var b=-this.dy/this.pixels_per_unit;this.set_value(this.value0+b)}},S.prototype.set_value=function(a){if(a=+a.toFixed(this.precision),a!==this.value){this.value=a;var b=this.view.model.numeric_value(this.node,a);b instanceof E?(b.scrubbingThisNum=!0,b.precision=this.precision):b.is_group("add","sub","sign")&&(b.children[1].scrubbingThisNum=!0,b.children[1].precision=this.precision),b!==this.node&&this.interaction_handler.highlight_nodes(this.start(null,[b]))}},S.prototype.end=function(){this.node&&(this.node instanceof E&&delete this.node.scrubbingThisNum,this.node.is_group("add","sub","sign")&&delete this.node.children[1].scrubbingThisNum,this.view.update_all()),this.view.options.dur=this.old_anim_dur,this.node=null},S.prototype.process_selection=function(a){var b=function(a){return a.is_group("sign")||a.is_group("add")||a.is_group("sub")};if(0===a.length||a.length>2)return null;if(2===a.length){var c=a[1];return c instanceof E&&b(c)?c.parent:null}var d=a[0];return d instanceof E?b(d.parent)?d.parent:d:b(d)?d:null},Wa.ChangeNumberHandler=S,Wa.FontLoader=T,gb={},Wa.HitTester=gb,gb.draw=function(a,b,c){var d=a.selectAll(".target_area").data(b?b:[]);d.enter().append("rect").classed("target_area",!0).style({fill:"none",stroke:"lightpink","stroke-width":2,"stroke-style":"dashed"}),d.attr("x",function(a){return a.x}).attr("y",function(a){return a.y}).attr("width",function(a){return a.width}).attr("height",function(a){return a.height}),d.exit().remove();var e=a.selectAll(".source_area").data(c?[c]:[]);e.enter().append("rect").classed("source_area",!0).style({fill:"none",stroke:"steelblue","stroke-width":2}),e.attr("x",function(a){return a.x}).attr("y",function(a){return a.y}).attr("width",function(a){return a.width}).attr("height",function(a){return a.height}),e.exit().remove()},gb.getBoundingBox=function(a,b,c){arguments.length<2&&(b=1);for(var d=1/0,e=-(1/0),f=1/0,g=-(1/0),h=0;h<a.length;h++){var i=a[h];if(!i.hidden||i.smooshing){var j=c?i.x0||0:i.x,k=c?i.y0||0:i.y;d=Math.min(d,i.sel_box.x+j),e=Math.max(e,i.sel_box.x+j+i.sel_box.width),f=Math.min(f,i.sel_box.y+k),g=Math.max(g,i.sel_box.y+k+i.sel_box.height)}}var l=e-d,m=g-f;return{x:d+l*(1-b)/2,y:f+m*(1-b)/2,width:l*b,height:m*b}},gb.setTargetRegions=function(a,b){a.forEach(function(a){var c,d=gb.getRawTargetBox(a.target,a.settings.side);if(a.raw_target_box={},Wa.extend(a.raw_target_box,d),a.settings.target_group){var e=a.target.get_parent(1);if(e.is_group("fraction")&&"around"===a.settings.group_side){var f=gb.getRawTargetBox(e,"around"),g=a.target.is_group("mul")?e.get_top():e.get_bottom();c=gb.getRawTargetBox(g,"around"),c.width=f.width,c.x=f.x}else c=gb.getRawTargetBox(e,a.settings.group_side)}else c=d;a.settings&&a.settings.offset&&gb.adjustTargetBoxByOffset(c,a.settings.offset),a.settings&&a.settings.margin&&gb.adjustTargetBoxByMargin(c,a.settings.margin,b),Wa.extend(a,c)}),gb.extendExtremeTargetBoxes(a)},gb.getRawTargetBox=function(a,b){var c={};switch(b){case"left-of":c.x=a.sel_box.x+a.x0-.5,c.width=1,c.y=a.sel_box.y+a.y0,c.height=a.sel_box.height;break;case"right-of":c.x=a.sel_box.x+a.x0+a.sel_box.width-.5,c.width=1,c.y=a.sel_box.y+a.y0,c.height=a.sel_box.height;break;case"below":c.x=a.sel_box.x+a.x0,c.width=a.sel_box.width,c.y=a.sel_box.y+a.y0+a.sel_box.height-.5,c.height=1;break;case"above":c.x=a.sel_box.x+a.x0,c.width=a.sel_box.width,c.y=a.sel_box.y+a.y0-.5,c.height=1;break;default:if(Array.isArray(a)){var d=gb.getBoundingBox(a);c.x=d.x,c.width=d.width,c.y=d.y,c.height=d.height}else c.x=a.sel_box.x+a.x0,c.width=a.sel_box.width,c.y=a.sel_box.y+a.y0,c.height=a.sel_box.height}return c},gb.adjustTargetBoxByMargin=function(a,b,c){var d=0,e=0,f=0,g=0;b.all&&(d=e=f=g=b.all),b.x&&(d=e=b.x),b.y&&(f=g=b.y),b.x1&&(d=b.x1),b.y1&&(f=b.y1),b.x2&&(e=b.x2),b.y2&&(g=b.y2),d*=c,f*=c,e*=c,g*=c,a.x+=d,a.width-=e+d,a.y+=f,a.height-=g+f,a.width<=0&&(a.x+=-d>-e?-a.width/2:a.width/2,a.width=1),a.height<=0&&(a.y+=-f>-g?-a.height/2:a.height/2,a.height=1)},gb.adjustTargetBoxByOffset=function(a,b){a.x+=b.x,a.y+=b.y},gb.extendExtremeTargetBoxes=function(a){for(var b,c,d,e=0;e<a.length;e++){var f=a[e];f.settings.extend_extreme_target_boxes&&f.nodes&&(1===f.nodes.length&&"AlgebraModel"===f.nodes[0].type||(d||(d=gb.getBoundingBox(f.nodes,1,!0)),(!b&&f.x+f.width<d.x||b&&f.x<b.x&&f.x+f.width<d.x)&&(b=f),(!c&&d.x+d.width<f.x||c&&c.x<f.x&&d.x+d.width<f.x)&&(c=f)))}b&&"inside"!==b.settings.side&&(b.x-=1e3,b.width+=1e3,b.y-=500,b.height+=1e3),c&&"inside"!==c.settings.side&&(c.width+=1e3,c.y-=500,c.height+=1e3)},gb.getHits=function(a,b){var c=[];return c=c.concat(a.filter(function(a){return(!a.settings.target_group&&"outside"!==a.settings.side||a.settings.target_group&&"outside"!==a.settings.group_side)&&gb.overlaps(a,b)})),c=c.concat(a.filter(function(a){return(!a.settings.target_group&&"outside"===a.settings.side||a.settings.target_group&&"outside"===a.settings.group_side)&&!gb.overlaps(a,b)}))},gb.getBestHit=function(a,b){var c=gb.getHits(a,b);return gb.getHighestPriorityHit(c,b)},gb.getEnclosingRectForSourceLineEndpoint=function(a){return{xmin:a.B.x-2,ymin:a.B.y-2,xmax:a.B.x+2,ymax:a.B.y+2}},gb.overlaps=function(a,b){return(a.x>=b.x&&a.x<=b.x+b.width||a.x+a.width>=b.x&&a.x+a.width<=b.x+b.width||a.x<=b.x&&a.x+a.width>=b.x+b.width)&&(a.y>=b.y&&a.y<=b.y+b.height||a.y+a.height>=b.y&&a.y+a.height<=b.y+b.height||a.y<=b.y&&a.y+a.height>=b.y+b.height)},gb.getHighestPriorityHit=function(a,b){for(var c=null,d=0;d<a.length;d++){var e=a[d];if(c){if("outside"===c.settings.side)c=e;else if(e.priority>c.priority)c=e;else if(e.priority===c.priority){var f=c.settings.target_group?c.raw_target_box:c,g=e.settings.target_group?e.raw_target_box:e;gb.getCenterDist(g,b)<gb.getCenterDist(f,b)&&(c=e)}}else c=e}return c},gb.getCenterDist=function(a,b){var c=a.x+a.width/2-b.x-b.width/2,d=a.y+a.height/2-b.y-b.height/2;return Math.sqrt(c*c+d*d)},gb.getOverlapArea=function(a,b){var c=Math.max(a.x,b.x)-Math.min(a.x+a.width,b.x+b.width),d=Math.max(a.y,b.y)-Math.min(a.y+a.height,b.y+b.height);return Math.max(0,c)*Math.max(0,d)},hb={},Wa.Reselector=hb,hb.rules=[],hb.getNewSelection=function(a){var b=this.getBestRule(a);return!!b&&b.apply(a)},hb.getBestRule=function(a){for(var b=null,c=0;c<this.rules.length;c++){var d=this.rules[c];d.match(a)&&(!b||b.priority<d.priority)&&(b=d)}return b},hb.hasMatchingRule=function(a){for(var b=0;b<this.rules.length;b++)if(rules[b].match(a))return!0;return!1},hb.Rule=function(a,b){this.name=a,this.priority=b||0},hb.Rule.prototype.match=function(a){throw"override match function!"},hb.Rule.prototype.apply=function(a){throw"override apply function!"},Wa.inherit(U,hb.Rule),U.prototype.match=function(a){if(1!==a.length)return!1;var b=a[0],c=b.parent;if(!b.is_group("exponent"))return!1;if(!c.parent.is_group("mul","div"))return!1;var d=c.parent.parent;return d.children.some(function(a){if("//"===a.to_ascii())return!1;var b=a.children[1];return b!==c&&Wa.actions.MultiplyPowersAction.areLikeTerms(c,b)})},U.prototype.apply=function(a){return[a[0].parent.parent]},hb.rules.push(new U),V.defaultOptions={zoom:1,input_types:"all",tap_max_time:250,tap_max_dist:10,hold_time:500,hold_max_dist:10,dbltap_max_delay:400,dbltap_max_dist:20},Wa.mtouch_defaults=V.defaultOptions,Wa.mtouch_events=V,Wa.d3_eventDispatch=W,ib=0,"undefined"!=typeof window&&(ib=/WebKit/.test(window.navigator.userAgent)?-1:0),Wa.transform_behavior=Z,_.indicator_vis_mode=1,_.show_target_areas=!1,_.prototype.check=function(a,b){var c=a.pos0[0]-a.pos[0],d=a.pos0[1]-a.pos[1];return(1!==a.fingers.length||0!==b.length)&&c*c+d*d>=64},_.prototype.isActive=function(){return this.active},_.prototype.start=function(a,b,c){var d=this;this.view.options.hide_mouse_cursor===!0&&d3.select("html").style("cursor","none"),this.dl&&this.dl.setLastHandleVisibility(!1);var e=Wa.extend({reselect_nodes:!0,move_nodes:!0},c);this.active=!0,this.setNodes(e.reselect_nodes?_.process_selection(b):b),this.rubberband_dir=0,this.center=this.getCenter(this.nodes),this.indicator&&this.indicator.move_to(this.center,!0),this.interaction_handler.events.on("keydown."+this.id,function(a){18!==a.keyCode&&32!==a.keyCode||d.selectNodesOneLevelUp()}),this.do_not_move_nodes=!e.move_nodes;for(var f=0;f<this.nodes.length;f++){var g=this.nodes[f];g.dragging=!0,g.x0=g.x,g.y0=g.y}return this.view.model.hide_nodes()&&(this.view.renderer.set_style(this.nodes),this.view.update_style()),this.indicator&&this.view.main.call(this.indicator),this.view.enter_and_exit("shadow"),this.view.update_existing("shadow"),this.setupActions(e.actions),this.nodes},_.prototype.getCenter=function(a){var b=gb.getBoundingBox(a);return[b.x+b.width/2,b.y+b.height/2]},_.prototype.setNodes=function(a){this.nodes=a,this.leaf_nodes=Va.filter(function(a){return!a.has_children()},a)},_.prototype.selectNodesOneLevelUp=function(){if(0!==this.nodes.length&&Va.is_range(this.nodes)&&!this.nodes[0].parent.is_root()){this.smooshing&&this.cancelSmooshing();for(var a=[],b=0;b<this.nodes.length;b++)a.indexOf(this.nodes[b].parent!==-1)&&a.push(this.nodes[b].parent);if(a=_.process_selection(a),!(a.length>0&&a[0].is_group("equals")||this.nodes.some(function(b){return a.indexOf(b)!==-1}))){this.nodes.forEach(function(a){a.dragging=!1});var c={x:this.nodes[0].x-this.nodes[0].x0,y:this.nodes[0].y-this.nodes[0].y0};this.setNodes(a),this.view.model.hide_nodes()&&(this.view.renderer.set_style(this.nodes),this.view.update_style()),this.interaction_handler.highlight_nodes(this.nodes),this.view.renderer.set_position(this.nodes);for(var b=0;b<this.nodes.length;b++){var d=this.nodes[b];d.dragging=!0,d.for_each(function(a){a.x+=c.x,a.y+=c.y})}return this.view.enter_and_exit("shadow"),this.view.update_existing("shadow"),this.view.update_positions(this.leaf_nodes),this.setupActions(),this.center=this.getCenter(this.nodes),this.indicator&&this.indicator.move_to(this.center),this.nodes}}},_.prototype.update=function(a){var b=a.dx,c=a.dy;this.dy+=c,this.finger_delta.x+=b,this.finger_delta.y+=c,this.pushToDeltaQueue(b,c),this.fingerMoved(this.finger_delta,3)&&this.stopAllTimeouts();var d=3.5*this.interaction_handler.view.options.font_size;if(!this.smooshing&&Math.abs(this.dy-this.dy0)>d&&0!==this.dy){var e=this.dy>this.dy0?1:-1;e!==-1*this.rubberband_dir&&(this.dy0=this.dy,this.rubberband_dir=e,this.view.options.rubber_band_selection&&this.selectNodesOneLevelUp())}this.do_not_move_nodes||(Va.for_each(function(a){a.x+=b,a.y+=c},this.nodes),this.smooshedNodes.forEach(function(a){Va.for_each(function(a){a.x+=b,a.y+=c},a)})),this.bbox.x+=b,this.bbox.y+=c,this.center[0]+=b,this.center[1]+=c,this.indicator&&this.indicator.move_to(this.center),this.displayTargets(!0);var f=this.applyShakeToShakeActions();f.length>0&&this.performAsyncronousAction(f[0]);var g=gb.getBestHit(this.actions,this.bbox);g&&g.settings.delay&&!g.timeoutID?this.applyTimeout(g):!g||g.settings.delay||g.timeoutID?g||this.stopAllTimeouts():this.performAction(g),this.view.update_positions(this.leaf_nodes),this.smooshing&&this.view.updateSmooshed(this.smooshedNodes)},_.prototype.pushToDeltaQueue=function(a,b){this.dx_queue.push(a),this.dy_queue.push(b),this.dx_queue.length>4&&this.dx_queue.shift(),this.dy_queue.length>4&&this.dy_queue.shift()},_.prototype.reduceDeltaQueues=function(){return{x:this.dx_queue.reduce(function(a,b){return a+b},0),y:this.dy_queue.reduce(function(a,b){return a+b},0)}},_.prototype.fingerMoved=function(a,b){return a.x*a.x+a.y*a.y>b*b},_.reorderInRanges=function(a){if(a.length<2)return a;var b=a[0].get_root(),c=0;return b.for_each(function(a){a.order_num=c++}),a.sort(function(a,b){return a.order_num-b.order_num})},_.getNewSelectionAfterAction=function(a,b){var c=a.new_selection?a.new_selection:a.mapNodes(b);return this.reorderInRanges(c),_.process_each_selection(c)},_.prototype.performAsyncronousAction=function(a){this.end(),this.interaction_handler.performAction(a,!1)},_.prototype.performAction=function(a){this.stopAllTimeouts();var b={};Va.for_each(function(a){b[a.id]={x:a.x,y:a.y}},this.nodes);var a=this.view.model.performAction(a);this.dl&&this.dl.setLastHandleVisibility(!1);var c=_.getNewSelectionAfterAction(a,this.nodes);if(0===c.length)throw this.interaction_handler.abort_interaction(),this.interaction_handler.end_of_interaction(),"(DragHandler) Non-existant new node selection after move action.";var d=hb.getNewSelection(c);c=d||c,a.settings.is_join_action&&!d||(a.settings.is_join_action=!1,this.smooshing&&this.cancelSmooshing()),a.settings.is_join_action&&(this.addSmooshedNodes(a),this.view.enterSmooshed(this.smooshedNodes),this.shrinkNewSmooshedNodes(),this.positionSmooshedNodesInWheel(),this.view.updateSmooshed(this.smooshedNodes)),this.interaction_handler.highlight_nodes(c);for(var e=0;e<this.nodes.length;e++)this.nodes[e].dragging=!1;a.newTree.for_each(function(a){a.dragging=!1});for(var f=0;f<c.length;f++)c[f].dragging=!0;
this.correctNodePositions(c,this.nodes,a,b),this.view.model.hide_nodes(),a.settings.is_join_action&&(Va.for_each(function(a){a.smooshing=!1},this.nodes),Va.for_each(function(a){a.smooshing=!0},c)),this.setNodes(c),(a.settings.reset_x||a.settings.reset_y)&&this.resetPositionOfNodes(c,a.settings.reset_x,a.settings.reset_y),this.updateNodePositionsAroundTarget(c,a),this.smooshing||(this.center=this.getCenter(this.nodes)),this.view.update_style(),this.view.enter_and_exit("shadow"),this.view.update_existing("shadow"),this.view.update_existing("normal"),this.setupActions(),this.dy=0},_.prototype.addSmooshedNodes=function(a){var b=a.nodes[0],c=a.target,d=function(a){var b=Va.clone(a,!1,["id","value","name","bp","associative","commutative","vertical_notation","selected","dragging","locked","fixed","hidden","simplify","deleted","precision","color","size","width","height","x","y","x0","y0","rel_x","rel_y","lmar","rmar"]);return b.children[0]&&b.symIsHidden()&&(b.children[0].hidden=!1),b};this.smooshing=!0,0===this.smooshedNodes.length&&this.smooshedNodes.push(d(b)),this.smooshedNodes.push(d(c))},_.prototype.shrinkNewSmooshedNodes=function(){2===this.smooshedNodes.length?this.smooshedNodes.forEach(this.shrinkSmooshedNodesGroup.bind(this)):this.shrinkSmooshedNodesGroup(this.smooshedNodes[this.smooshedNodes.length-1])},_.prototype.shrinkSmooshedNodesGroup=function(a){a.size=a.size*this.view.options.smooshed_nodes_shrink_factor,Va.for_each(function(b){b.size=a.size},a),this.view.renderer.set_position([a],!0)},_.prototype.positionSmooshedNodesInWheel=function(){for(var a=this.smooshedNodes.length,b=this.calculatePositionOnCircleForEachGroup(a),c=0;c<this.smooshedNodes.length;c++){var d=this.smooshedNodes[c],e=this.center[0]+d.width/2+b[c][0],f=this.center[1]+d.height/2+b[c][1],g=e-d.x,h=f-d.y;d.for_each(function(a){a.x+=g,a.y+=h})}},_.prototype.calculatePositionOnCircleForEachGroup=function(a){for(var b=this.view.options.font_size,c=360/a,d=270,e=d,f=[d],g=0;g<a-1;g++)e+=c,e=(e+360)%360,f.push(e);var h=function(a){return a*Math.PI/180};return f.map(function(a){return[b*Math.cos(h(a)),b*Math.sin(h(a))]})},_.prototype.cancelSmooshing=function(){this.nodes.forEach(function(a){a.for_each(function(a){a.smooshing=!1})}),this.smooshing=!1,this.smooshedNodes=[],this.view.exitSmooshed()},_.prototype.setupActions=function(a){this.dx_queue=[],this.dy_queue=[],this.finger_delta={x:0,y:0};var b=this.nodes.length>0?.1*this.nodes[0].size:.1*this.view.options.font_size;this.smooshing?this.bbox={x:this.center[0]-b,y:this.center[1]-b,width:2*b,height:2*b}:(this.bbox=gb.getBoundingBox(this.nodes,0),this.bbox.x-=b,this.bbox.width=2*b,this.bbox.y-=1.5*b,this.bbox.height=3*b),this.actions=a||this.view.model.getMoveActions(this.nodes),this.shake_actions=this.actions.filter(function(a){return"shake"===a.settings.side}),this.actions=this.actions.filter(function(a){return"shake"!==a.settings.side}),this.view.options.enable_drag_to_join||(this.actions=this.actions.filter(function(a){return!a.settings.is_join_action})),gb.setTargetRegions(this.actions,this.view.options.font_size),this.displayTargets(!0),this.indicator&&(this.indicator.animate(0,0),this.indicator.move_to(this.center))},_.prototype.correctNodePositions=function(a,b,c,d){if(!c.settings.makes_no_changes||c.settings.update_node_positions){var e;if(Va.select_first(function(b){var d=c.mapNodes(b);if(1!==d.length)return!1;var f=Va.select_first(function(a){return a===d[0]},a);return!!f&&(e={old:b,new:f},!0)},b),e){var f=d[e.old.id].x-e.new.x0,g=d[e.old.id].y-e.new.y0;Va.for_each(function(a){a.x=a.x0+f,a.y=a.y0+g},a)}}},_.prototype.resetPositionOfNodes=function(a,b,c){a.forEach(function(a){a.for_each(function(a){b&&(a.x=a.x0),c&&(a.y=a.y0)})})},_.prototype.updateNodePositionsAroundTarget=function(a,b){if(!b.settings.makes_no_changes){var c;if(b.settings.is_join_action){for(var d=0,e=0;e<a[0].children.length;e++)d+=a[0].children[e].sel_box.width;c=this.center[0]+d/2-a[0].x0}else c=a[0].x-a[0].x0;var f=b.newTree.filter(function(a){return!a.dragging});f=f.filter(function(a){var b=a.parent;if(b)for(;!fa.is_top_most(b);){if(b.dragging)return!1;b=b.parent}return!0}),f.forEach(function(a){a.x+=c,a.x0+=c});var g=b.newTree.filter(function(a){return a.dragging});b.settings.is_join_action?fa.is_top_most(g[0])||Va.for_each(function(a){a.x+=c,a.x0+=c},g):Va.for_each(function(a){a.x0+=c},g)}},_.prototype.displayTargets=function(a){_.show_target_areas&&(a?gb.draw(this.view.main,this.actions,this.bbox):gb.draw(this.view.main))},_.prototype.end=function(){d3.select("html").style("cursor",null),this.indicator&&this.indicator.remove(),this.on_release_action&&this.performAction(this.on_release_action),this.interaction_handler.events.on("keydown",null),this.dl&&this.dl.setLastHandleVisibility(!0),this.stopAllTimeouts(),Va.for_each(function(a){a.selected=!1,a.dragging=!1},this.view.model.children),this.view.enter_and_exit("shadow"),this.view.update_existing("shadow"),this.cancelSmooshing(),this.view.model.hide_nodes(),this.setNodes([]),this.actions=[],this.bbox=null,this.view.update_all(),this.displayTargets(!1),this.active=!1,this.dy=0,this.dy0=0},_.prototype.applyTimeout=function(a){this.indicator&&this.indicator.animate(1,a.settings.delay),this.finger_delta.x=0,this.finger_delta.y=0,a.timeoutID=setTimeout(function(){a.settings.on_release?(this.on_release_action=a,this.indicator&&this.indicator.fill(),this.finger_delta={x:0,y:0}):this.performAction(a)}.bind(this),a.settings.delay)},_.prototype.stopAllTimeouts=function(){this.indicator&&this.indicator.animate(0,0),this.on_release_action=null;for(var a=0;a<this.actions.length;a++){var b=this.actions[a];b.timeoutID&&this.clearActionTimeout(b)}},_.prototype.clearActionTimeout=function(a){clearTimeout(a.timeoutID),delete a.timeoutID,delete a.dx,delete a.dy},_.prototype.applyShakeToShakeActions=function(){var a=this.reduceDeltaQueues();return this.fingerMoved(a,3)?Math.abs(a.x)>Math.abs(a.y)?this.penalizeNonShake(this.shake_actions):this.incrementShake(this.shake_actions,a):[]},_.prototype.incrementShake=function(a,b){var c=[],d=b.y<0?"up":"down";return a.forEach(function(a){a.settings.shakes||(a.settings.shakes=0),a.settings.current_direction||(a.settings.current_direction="up",a.settings.distance=0),d===a.settings.current_direction?(a.settings.distance+=b.y,Math.abs(a.settings.distance)>100&&(a.settings.shakes++,a.settings.current_direction="up"===d?"down":"up",a.settings.distance=0)):d!==a.settings.current_direction&&(a.settings.distance=0),a.settings.shakes>=4&&c.push(a),a.settings.non_shakes=0},this),c},_.prototype.penalizeNonShake=function(a){return a.forEach(function(a){a.settings.non_shakes||(a.settings.non_shakes=0),++a.settings.non_shakes>2&&(a.settings.shakes=0,a.settings.current_direction="up",a.settings.distance=0)},this),[]},_.process_each_selection=function(a){if(0===a.length)return[];var b=fa.groupNodeRanges(a),c=[];return b.map(function(a){return _.process_selection(a)}).forEach(function(a){c=Wa.array.mergedNew(c,a)}),c},_.process_selection=function(a){var b=a.slice();if(0===b.length)return[];if(_.special_selection(b))return _.special_selection(b);if(b[0].commutative){var c=b[0].parent;if(b.length<c.children.length)return b;b=[c]}for(var d=b[0];!fa.is_top_most(d)&&!d.parent.is_group("equals","gte","lte","gt","lt")&&!d.commutative&&!d.is_group("exponent","degree")&&!d.parent.is_group("param")&&(!d.parent.is_group("radical")||d.parent.get_radicand()!==d)&&(!d.is_group()||1!==d.get_idx()||!d.parent.is_group("brackets")||x.areHidden(d.parent));)d=d.parent;return 1===d.get_idx()&&d.parent&&(d.parent.is_group("equals")||G.is_inequality(d.parent))&&(d=d.parent),[d]},_.special_selection=function(a){if(1!==a.length)return!1;var b=a[0];return!b.fixed&&b.parent.is_leaf_node&&1===b.get_idx()?a:"-"===b.to_ascii()?a:"|"===b.to_ascii()&&0===b.get_idx()?a:(E.is_num(b)&&b.parent.is_group("sign")&&(b=b.parent),!!(E.is_equal_to(b,-1)&&b.parent.is_group("brackets")&&b.get_parent(2).is_group("power")&&b.get_parent(2).is_square_root())&&[b])},_.Indicator=function(a){var b,c,d,e=0,f=0,g=12,h=!0,i="#FFA500",j=d3.svg.arc().innerRadius(g-2.5).outerRadius(g).startAngle(0),k=2*Math.PI,l=function(k){b=k.insert("g","*").attr("transform","translate("+[e,f]+")").style("display",h?null:"none"),0===a?(b.append("image").attr("xlink:href","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAAAXNSR0IArs4c6QAACx9JREFUaAXF2k+SHUcRBvB680eaERjCAV6w8MYLrmFxAlZwBPsYFsdgwwHwCi5g6QTes9DGC4iQHY6wzPyRZvTIX32dr59GljRGDqiInq6uysr6MvPLqup+M8ZPWLZ/HYfbbV1/HsfbL8bR7q7+oC59JfMTTjk276oMqPGw9Dwep+PXi7av6/7e2I6n1d53ffvtH43zcX9sN5tx/S4Y/isDphe/HQfj/XF3Tn63gF6Ok/H9AuXndb8og06W5+sy5rBaLkrupOruvywDLquufFu1T8Z1GfNiGXHr2482ADXGk4LBu8cTJEABe1Hz3llgX1adeX0HSX1T0scF/HnVmMmgp3UXoV+M883vxlXVbl1ubcAE3jRpbx8VcGVbMIAF6rBq19M4z2s5nv2eY0Abo+WqoiFqd6tPVD4YF7c15FYG7Lw+FsDXBfhq3Fs8eVr3UcHfFuzTCV79oJ76fljPjCGnbAuw/rSdT8OPxtkezc7QavPpSy7I2Bt/j248v/Jo9ZgJii6jgOM1Jqs36O0C3p0Z3HJQ/Qd1l6KYflzeRQ4zXpeuTRmRDKiGKitxjN6W3KYct31bJN4YgR1tgD+uAPOw0B9MAKflMYBPptcP531UGwNFYi3aSKKP9sjEINEQmavqe1F1VDyo+qi63KjV6k1GvDYCE/x3E2i8fVV1XudVAA/mVBxwsgMdd6BXQL4oScBBV4/h1qB4PLFa63SjlbWIzHH9fTK2heW1OZEpS3a/2ICWJZInT0rNaSkFDHBA+CkJzAD1eJZsdIId0OvdJPolrSi8KA+LgDqPiwL9R1W/rMuKRdY691VF4kE93SivRGChzUkNiceBB/KoLlSKihh1VW2hA04rFsUubWA/n+8MIusii3qAqjPOnfFcpHCP8mE1f/EqnV4xYCZsJ2nW9JPxrNSEQlRJXpGIEYCIUiDdnSDJoINLUgcqGdy2QqWlDeGUFQljAjvOEpFt7eijsClP59/lzzqsGhbeZ8MhgItWGoWk1SPgTOA6rV79MagqixcDIFyOCelpY+g5n9LGd6s7uetJnzz1/DKnNjsY95M6QjWqzjQH4+/jZ+ObAmZfbd6HQoCuoBOFezWMp0G4N/t5Vq4oqa9RQA4GiUKIYsuyH2i3tjFIDpyVASKV/ECvrq/58O/Kh6ltjcCfamjxbIYKRXjVHXA83adNG4NG1Lh32I3rEuMZGI5rx/MYYzGIUb3pZVzvJKiTgkp35gxZZj+qkeHHTkSSSMTQIms9nia8WQ5jRLweysSjoVXTCWjjGLwC5Qzejk5mdD1rfqIGbtPpsOR7fvtEjh6nuwPjkgvTxnkk/rzEFQG7O0HEGJ5tWkyB3RQ8D2yWWIapK4wAnvm8nEIPisSYyIHrCpW0WY7FKCygJZFwALTM1g5dxmxhdhRPkB5WY87uJj6dm4lpO0Oy1HUeZA9oSjEwVMpYIEKn9l8bomcJfN2bBIlSnjNjZjVKFGhT0MyqqP1ptcNcJQbYcd+rTuf2HMCoCiDgcTBqeTT5EaowJpFKHmT1VlfIKJJ1v/Bwl5i3/yYQ2d5fnGwZy/s0ioj96Lup4OnRfDnxpmTbJgACD1Kslgl6mQzAtCVGoU2MSA7xcvKivZwIARBPt+70o1VyTX8iq7adqxFZRthIn5UjoLyqtsIM+8H4QzV47QOZx5rvq5fiRYmcZNbTdIqnJbOLhqZU50dkm17GxYs9JpGjJwg6Z8yiL8cMuZHo0+fdAebCfjS55Jz5TTVazUXhWf2V+ZQCnWKnSEKTwklFW5ZcALJ/5CAALLjkEs1eNj3zfgqvNoXiEMsu4BI6L01OqnTBtZ0r0a/q6eHYHI1/VEUmvFeWYR/FwAMTj2dguJ/+6p4eD2V4lNnxfnIiHtWfvpW/5LwLZAmmT9RtbjGUFrS0mTHCU/ah7CXe+hj1dfV/afg/S0AJQ2d1hiu1HIsTxshRqIQamc4zg9cCTCJDrvcI/cY3zznLsyjGDSRWJ6k3dftI0Xfv0B8TrT+zmC4palBAdhiFEmSlOZyJ18mAaVqsRmZERmV8y5FpXft61ckrwKNdroyHEVYHkWLPwXhEsool1G6HPvgNdIBXZZbe9uM1MetE1G2n9Wya0MFOmrN8zjJABTRZ4HndlfeC1P2loYHXwyycmndr2PLN6bdjezQjYE29LEB2YG9Ejq8mzbtrLPe8qTQHsj2d48FKHUBeLvvc1tcHuEhFF5l+DnA7c8yLM+wBHKsthuUzzKPeyKilBmzgGEGpnTB8TUizIalL8DYkkViNqo4qDco9fifHCDqt/ZYMiRmJjEhfdcxCZ5I58/frpqyyd30mAvXOuRwjGGECO128GoPOqi0vKivI1dOdkG3QevKMD7UrjsW50C0XfYlijGv9kQ94xiv2gbAgc9sHPq8IbP44rrd/qy78BztnwPNJn3qsYQbmLIiH64rRa3e2/nVyE/IrTTTSYFLtPEyfw5s2VEl86mGOyjtCcgddlLjC2MTLJ8zaBza/78Pcv0rZ+9XpPViWW2tNmnWYipcpA0KvEKZvGmh35Vk9a3dMQjmgQQ74UAqdyDXo6I6mkNtLvgIbR/ncUp8hNeUw90nB+Usp5jU+y+kz0Eg1kKYDJa6GvhpDlgkpK63iZ4DVHIg7H9BCJPqeuUSGUYkA+liBnlWbtzJ7wP30TQOcq+tgFOH4KJRJ6AxWkhfxTGSbWm0Mz9p9Te5Mpb2NDm3oCbBEQ92MHNJg4wRJTo9xVqHndXHN8j7Qn+UTAQrqg2odUQ1JEodvaxSOqidT+GvttqQla9rTMU6vmuTPQRDo1Zi8mfVKBFTqZgY4oHsPii4GOimL1PnEWhVlNeB+qfFW5qhKyZ3Zb9MAtEH13bQusvEYI9AjiT6b6+lykVrl2uPt3UiGUvIgLzH2oBjkm2p/5NKSz/LRV2N3BvhxoT5ZXMwllV/tdiAKLWBX82mFHc+ln0RMUkMfx+dkiLtRoVJ7v5pKjoGhTjzfEQA+e84K/mTx/ofzM2PHZzWARt9bdrlwuEwqAsx09VtR+76NmIPnBCiTozJTmteRZwqgjLYkKow1ovke+jAYZZhu5XG8X7xfy34+d1WTsotAHuuvXHhSdwOcvSkzJDVnfDz0+TttdSsJdRK9BOJ8jNG77/0pVDo4KLpIZHXJrGlv6kj2Pe9n+Pr3FQNmFFDpcanNad4EAeeviLinfl6GMCrA5UrMSWJ6ShSykgl89pZeEEQiNLJIPJ/OiUGSlWHf113kruoHjxvep57vfrDMz4yPC5yXfauJHYJXrcd9xk8w89q3npm8oKz0od2zCGU57t1YlJhu10dTQFMXCXWet2kVdV/3a81rDTDvS5/Z+7VRh7oPvuFp9gdGNeezc8frgDMgnp+752LgWbWaP21J4NSB96um38y+/OHP6hNF/XmjAYS2D8o3/dXON1Pc7WhMgWrrV1DPvRP3p/emzQo00QhgVIzXHeruTOB68P7sNj/2vdWAidFPq+jke4y8cGbi8az5+ZEv7xGJhkFogW5932/r833G4z6jQhlyb6ENkS63MoDwXk7gbXbY/n04EbHaWEKTJ4AroqO9n3na0qg42zBZojoi8LovhF+9mTZz7PLn1gb0oJcMuag3tI5IC4hM/5Dt7lSlyBeFp5XI+MU5P3Rre8sPekRulh9tAAWVFwfjN0UQX8u8WPS/Gtg7chSxw6yGhFjn83uOj1I5z1/s/nfif/mvBjc9MD9N9v9NCH8XR17Fq99+0a6tvD3u/5/+2WMfz359GvNBGfGoWj+uq+8+nvn+9Fld9RroLXB/3LvU/wNK5Dx9330BewAAAABJRU5ErkJggg==").attr({width:24,height:24,x:-12,y:-12}),c=b.append("path").style({fill:i,stroke:"none",opacity:1}).datum({endAngle:0}).attr("d",j)):1===a?(d=b.append("circle").attr("r",g).style({stroke:"none",fill:"orange",opacity:.4}),c=b.append("path").style({fill:"red",stroke:"none",opacity:.5}).datum({endAngle:0}).attr("d",j)):2===a&&(b.append("circle").attr("r",g).style({stroke:"none",fill:"orange",opacity:.4}),c=b.append("circle").attr("r",0).style({stroke:"none",fill:"red",opacity:.5}))};l.remove=function(){b.remove()};var m=function(a){return function(b){var c=d3.interpolate(b.endAngle,a);return function(a){return b.endAngle=c(a),j(b)}}};return l.visible=function(a){return 0===arguments.length?h:(h=a,void(b&&b.style("display",h?null:"none")))},l.move_to=function(a,c){e=a[0],f=a[1],b&&(c?b.attr("transform","translate("+[e,f]+")"):b.transition().duration(300).ease("circle-out").attr("transform","translate("+[e,f]+")"))},l.animate=function(b,e){var f=Math.min(.3*e,200),h=c.transition().delay(f).duration(e-f);2!==a?h.ease("linear").attrTween("d",m(b*k)):h.ease("quad-out").style("r",b*g),d&&d.style("fill","orange"),c.style("fill","red")},l.fill=function(){c.transition().style("fill","green"),d&&d.transition().style("fill","green")},l},Wa.DragHandler=_,aa.prototype.check=function(a,b){return Wa.options.actions.substitution_on&&1===a.fingers.length},aa.prototype.start=function(a){return this.targets=this.collectTargets(),this.targets.forEach(function(a){this.initTargetVisualization(a)},this),this.initializeControlLine(a),this.sub_visible=!0,this.sub_enabled=!0,this.pending_ce_target=null,[]},aa.prototype.update=function(a){return this.updateControlLine(a),this.updateLineElement(this.line_el,this.line),this.targets.forEach(function(a){this.handleEndpointHits(a,this.targets)},this),this.pending_ce_target||this.targets.some(function(a){return a.hit_substitution_actions.length>0})},aa.prototype.end=function(){var a=this;this.pending_ce_target?this.triggerEquationCombination(this.pending_ce_target):this.sub_enabled&&this.targets.forEach(function(b){b.hit_substitution_actions.length>0&&a.performSubstitution(b)}),this.eraseInfoAndCleanBoard()},aa.prototype.abort=function(){this.eraseInfoAndCleanBoard()},aa.prototype.enableSubstitution=function(a){this.sub_enabled!==a&&(this.sub_enabled=a,this.sub_enabled?this.showSubstitutionLines(!this.pending_ce_target):this.showSubstitutionLines(!1))},aa.prototype.collectTargets=function(){var a=this.derivation.getAllDLs().slice();return Wa.array.remove(a,this.derivation),a.map(function(a){var b=this.getAllAvailableActions(a);return{derivation:a,view:a.getLastView(),substitution_actions:b.filter(function(a){return"SubstitutionAction"===a.name}),hit_substitution_actions:[],lines:[],combine_equations_action:b.filter(function(a){return"EquationCombineAction"===a.name})}},this)},aa.prototype.getAllAvailableActions=function(a){var b=a.getLastModel(),c=Wa.actions.SubstitutionAction.getAllAvailableActions(this.view.model,b).concat(Wa.actions.EquationCombineAction.getAllAvailableActions(this.view.model,b.children[0])),d=this.derivation.getRowByView(this.view),e=this.derivation.pos.x-this.derivation.dims.x+d.pos[0],f=this.derivation.pos.y-this.derivation.dims.y+d.pos[1];return c.forEach(function(b){var c=a.getLastRow();if(this.derivation.coordinator&&a.coordinator){var d=this.derivation.coordinator.getOffset(this.derivation,a);b.settings.offset={x:a.pos.x-a.dims.x+c.pos[0]-e+d[0],y:a.pos.y-a.dims.y+c.pos[1]-f+d[1]}}else b.settings.offset={x:a.pos.x-a.dims.x+c.pos[0]-e,y:a.pos.y-a.dims.y+c.pos[1]-f}},this),gb.setTargetRegions(c,this.view.options.font_size),c},aa.prototype.initTargetVisualization=function(a){this.highlightSubstitutionTargetNodes(a,!0),this.displayCombineEquationTargetArea(a,!0)},aa.prototype.highlightSubstitutionTargetNodes=function(a,b){if(b){var c=a.substitution_actions.reduce(function(a,b){return a.concat(b.target)},[]);a.view.interaction_handler.highlight_nodes(c)}else a.view.interaction_handler.highlight_nodes([])},aa.prototype.displayCombineEquationTargetArea=function(a,b){b&&a.combine_equations_action.length>0?this.drawCombineEquationTargetArea(a.view.main,a.combine_equations_action[0]):this.drawCombineEquationTargetArea(a.view.main,!1)},aa.prototype.drawCombineEquationTargetArea=function(a,b){var c=a.selectAll(".combine_equation_target_area").data(b?[b]:[]);c.enter().append("rect").classed("combine_equation_target_area",!0).style(this.eq_target_area_style),c.attr("x",function(a){return a.x-a.settings.offset.x}).attr("y",function(a){return a.y-a.settings.offset.y}).attr("width",function(a){return a.width}).attr("height",function(a){return a.height}),c.exit().remove()},aa.prototype.displayCombineEquationTargetAreaHit=function(a,b){a.view.main.selectAll(".combine_equation_target_area").transition().style(b?this.eq_target_area_style_active:this.eq_target_area_style)},aa.prototype.initializeControlLine=function(a){this.line_el=this.makeLineElement();var b=this.derivation.getRowByView(this.view).getHandlePos();this.line.A.x=b[0],this.line.A.y=b[1],this.line.B.x=a[0],this.line.B.y=a[1],this.bbox={x:this.line.B.x-2,y:this.line.B.y-2,width:4,height:4}},aa.prototype.makeLineElement=function(){var a=this.view.main.append("line").classed("substitution",!0).style("stroke","#ddd").style("stroke-width",2).style("stroke-linecap","round");return a},aa.prototype.updateControlLine=function(a){this.line.B.x+=a.dx,this.line.B.y+=a.dy,this.bbox={x:this.line.B.x-2,y:this.line.B.y-2,width:4,height:4}},aa.prototype.updateLineElement=function(a,b){a.attr("x1",b.A.x).attr("y1",b.A.y).attr("x2",b.B.x).attr("y2",b.B.y)},aa.prototype.showSubstitutionLines=function(a){var b=this;this.sub_visible!==a&&(this.sub_visible=a,this.targets.forEach(function(c){b.highlightSubstitutionTargetNodes(c,a),b.hideLines(c,!a)}))},aa.prototype.handleEndpointHits=function(a,b){var c=gb.getBestHit(a.substitution_actions,this.bbox);c?(Wa.array.remove(a.substitution_actions,c),a.hit_substitution_actions.push(c),this.highlightSubstitutionTargetNodes(a,!0),this.drawLine(c,a)):(c=gb.getBestHit(a.combine_equations_action,this.bbox),c&&!this.pending_ce_target?(this.pending_ce_target=a,this.displayCombineEquationTargetAreaHit(a,!0),this.showSubstitutionLines(!1)):c||this.pending_ce_target!==a||(this.pending_ce_target=null,this.displayCombineEquationTargetAreaHit(a,!1),this.showSubstitutionLines(!0)))},aa.prototype.drawLine=function(a,b){var c={A:{x:this.line.A.x,y:this.line.A.y},B:{x:a.x+a.width/2,y:a.y+a.height/2}},d=this.makeLineElement();this.updateLineElement(d,c),b.lines.push(d)},aa.prototype.hideLines=function(a,b){a.lines.forEach(function(a){a.transition().style("opacity",b?.001:1)},this)},aa.prototype.performSubstitution=function(a){var b=this.concatenateActionTargetsIntoOneAction(a.hit_substitution_actions);a.view.model.startInteraction(),a.view.model.performAction(b),a.view.model.finishInteraction()},aa.prototype.concatenateActionTargetsIntoOneAction=function(a){return a[0].target=a.reduce(function(a,b){return a.concat(b.target)},[]),a[0]},aa.prototype.triggerEquationCombination=function(a){this.displayEquationIdentities(a,!0),a.view.model.startInteraction(),a.view.interaction_handler.performAction(a.combine_equations_action[0],!1,function(){this.displayEquationIdentities(a,!1)}.bind(this))},aa.prototype.displayEquationIdentities=function(a,b){b?(this.drawEquationIdentity(this.view.main,"E₂"),this.drawEquationIdentity(a.view.main,"E₁")):(this.view.main.select("#combine_equation_identifier").remove(),a.view.main.select("#combine_equation_identifier").remove())},aa.prototype.drawEquationIdentity=function(a,b){var c=a.selectAll("g.math").filter(function(a){return!a.hidden}).datum();if(c){var d="translate("+(c.x0-15)+","+(-c.y0-15)+")",e=a.append("g").attr("id","combine_equation_identifier").attr("transform",d);e.append("circle").attr({cx:0,cy:0,r:20}).style({fill:"none","stroke-opacity":.66,stroke:"steelblue","stroke-width":1.5}),e.append("text").attr({stroke:"none",fill:"steelblue","fill-opacity":.66,"text-anchor":"middle","alignment-baseline":"central","font-size":24}).text(b)}},aa.prototype.eraseInfoAndCleanBoard=function(){this.targets.forEach(function(a){a.lines.forEach(function(a){a.remove()}),this.highlightSubstitutionTargetNodes(a,!1),this.displayCombineEquationTargetArea(a,!1)},this),this.line_el.remove(),this.targets=[]},ba.prototype.getHandlerByClass=function(a){var b=function(b){return b instanceof a};for(var c in this.handlers){var d=this.handlers[c].filter(b);if(d.length>0)return d[0]}};ba.prototype.start_of_interaction=function(){this.view.model.startInteraction()};ba.prototype.end_of_interaction=function(a){this.pending_eoi&&(clearTimeout(this.pending_eoi),this.pending_eoi=null),this.view.model.finishInteraction(a)},ba.prototype.init=function(){var a=this.view.main.node();this.mtouch=Wa.mtouch_events().frame(a).hold_time(this.view.options.hold_time),this.view.event_receiver.call(this.mtouch),this.mtouch.on("touch",this.on_touch.bind(this,null)).on("release",this.on_release.bind(this,null)).on("tap",this.on_tap.bind(this,null)).on("dbltap",this.on_dbltap.bind(this,null)).on("hold",this.on_hold.bind(this,null));var b=Y().on("drag-start",this.on_drag_start.bind(this,null)).on("drag",this.on_drag.bind(this,null)).on("drag-end",this.on_drag_end.bind(this,null));this.mtouch.call(b),d3.select(document).on("keydown."+this.id,this.on_keydown.bind(this,null)),d3.select(document).on("keyup."+this.id,this.on_keyup.bind(this,null))},ba.prototype.abort_interaction=function(){this.active_handler&&this.active_handler.end(),this.active_handler=null,this.highlight_nodes([])},ba.prototype.setMode=function(a){this.modes.every(function(b){return b!==a})||(this.view.setMode(a),a!==this.mode&&this.view.update_existing("normal"),this.mode=a,this.interactive||this.mtouch.connected("inspect"===this.mode))},ba.prototype.set_interactive=function(a){this.interactive=!!a,"inspect"===this.mode?this.mtouch.connected(!0):this.mtouch.connected(this.interactive)},ba.prototype.select_new_handler=function(a){for(var b=this.handlers[this.mode]||[],c=0;c<b.length;c++){var d=b[c];if(d.check(a,this.selected_nodes))return this.active_handler=d,void this.highlight_nodes(d.start(a.pos,this.selected_nodes))}},ba.prototype.on_keydown=function(a){function b(){this.highlight_nodes(this.selected_nodes.map(function(a){return this.get_user_selection(null,null,{altKey:!0},a)},this).reduce(function(a,b){return a.concat(b[0])},[])),this.mtouch.fingers().forEach(function(a){a.cancel_hold()})}var c=a||d3.event;if(16===c.keyCode);else if(18===c.keyCode)this.mtouch.fingers().length>0&&this.selected_nodes.length>0&&b.call(this);else if(32===c.keyCode)this.spaceBarDown=!0,this.mtouch.fingers().length>0&&this.selected_nodes.length>0&&(b.call(this),c.preventDefault&&c.preventDefault());else{if(27!==c.keyCode)return;this.active_handler&&!this.active_action&&(this.active_handler.end(),this.active_handler=null,this.end_of_interaction(),this.ignore_next_release_event=!0,this.highlight_nodes([]),c.preventDefault&&c.preventDefault())}this.active_handler&&c.preventDefault&&c.preventDefault(),this.send_events&&this.events.keydown(new nb("down",c,this.id))},ba.prototype.on_keyup=function(a){var b=a||d3.event;if(16===b.keyCode);else{if(32!==b.keyCode)return;this.spaceBarDown=!1}this.active_handler&&b.preventDefault&&b.preventDefault(),this.send_events&&this.events.keyup(new nb("up",b,this.id))},ba.prototype.on_tap=function(a){var b=this;if(!this.active_action){var c=this.selectInputEvent(a,d3.event);if(!this.active_handler&&!c.shiftKey){var d,e=this.get_closest_node_at(c.finger.pos);if(e&&(d=this.getFirstUnfixedParent(e)),this.send_events&&this.events.tap(new lb(c,this.id,e,d)),d){var f=this;"inspect"===this.mode&&(this.highlight_nodes([]),this.events.inspect_node({node:d}),this.end_of_interaction(!0)),"edit"===this.mode&&this.view.model.process_operator(d,function(a){var c=!a;c&&b.canvas&&b.view.model.getBestMatchingAction(d,{type:"dbltap"}).action&&b.canvas.showNotice("Try double clicking?",!0),f.end_of_interaction(c),f.highlight_nodes([])},new lb(c,this.id))}}}},ba.prototype.on_dbltap=function(a){var b=this;if(!this.active_action){var c=this.selectInputEvent(a,d3.event);if(!this.active_handler&&!c.shiftKey){var d,e=this.get_closest_node_at(c.finger.pos);e&&(d=this.getFirstUnfixedParent(e)),this.send_events&&this.events.tap(new mb(c,this.id,e,d)),d&&"edit"===this.mode&&this.view.model.process_operator(d,function(a){b.end_of_interaction(!a),b.highlight_nodes([])},new mb(c,this.id))}}},ba.prototype.on_hold=function(a){var b=this;if(!this.active_action){var c=this.selectInputEvent(a,d3.event);if(!this.active_handler&&"edit"===this.mode){this.send_events&&this.events.hold(new ob(c,this.id));var d=this.get_closest_node_at(c.finger.pos);if(d&&"edit"===this.mode)if(Wa.actions.showRoundedAction.match(d)){var e=Wa.actions.showRoundedAction.createBoundAction(this.view.model,{actor:d});this.performAction(e,!0)}else this.active_action=this.view.model.process_operator(d,function(a){b.end_of_interaction(!a),b.highlight_nodes([]),b.active_action=null},new ob(c,this.id))}}},ba.prototype.performAction=function(a,b,c){this.active_action=a,this.view.model.performAction(a,function(){this.active_action=null,this.end_of_interaction(),this.highlight_nodes([]),c&&c()}.bind(this),b)},ba.prototype.getFirstUnfixedParent=function(a){for(;a.fixed&&a.parent&&"AlgebraModel"!==a.parent.type;)a=a.parent;return a},ba.prototype.selectInputEvent=function(a,b){if(a)return a;for(var c=b;c.sourceEvent;)c=c.sourceEvent;return b.shiftKey=c.shiftKey,b.altKey=c.altKey,b},ba.prototype.on_drag_start=function(a){if(!this.active_action&&(this.interactive||"inspect"===this.mode)){var b=this.selectInputEvent(a,d3.event),c=this.selected_nodes.slice();if(this.active_handler)return void(this.send_events&&this.events.drag_start(new kb(b,this.id,c)));this.selected_nodes.length>1&&(this.selected_nodes=Va.nodes_to_range(this.selected_nodes)),this.select_new_handler(b),this.send_events&&this.events.drag_start(new kb(b,this.id,c,this.selected_nodes))}},ba.prototype.update_fingers=function(a,b){if(!this.finger_sel){var c=this.view.main.node();this.finger_sel=d3.select(c).selectAll(".finger");var d=d3.touches(c,[{pageX:0,pageY:0,clientX:0,clientY:0}])[0],e=d3.touches(this.view.svg.node(),[{pageX:0,pageY:0,clientX:0,clientY:0}])[0];this.dpos_finger_vis=[e[0]-d[0],e[1]-d[1]],this.finger_vis_start=Date.now()}var f=this.finger_sel.data(a);b||f.enter().append("circle").classed("finger",!0).attr("r",20).style({stroke:"#4D4D4D","stroke-opacity":.5,fill:"#B2CAED","fill-opacity":.5}).transition().ease("bounce").attr("r",17);var g=this.dpos_finger_vis;f.attr("cx",function(a){return a.pos[0]-g[0]}).attr("cy",function(a){return a.pos[1]-g[1]});var h=this.finger_vis_start;f.exit().transition().delay(Math.max(0,250-(Date.now()-h))).style("opacity",1e-4).remove(),this.finger_sel=0===f.size()?null:f},ba.prototype.on_drag=function(a){if(!this.active_action&&(this.interactive||"inspect"===this.mode)){var b=this.selectInputEvent(a,d3.event);this.send_events&&this.events.drag(new pb(b,this.id,this.selected_nodes)),(a||this.always_visualize_fingers)&&this.update_fingers(b.fingers,!0),this.active_handler||this.select_new_handler(b),this.active_handler&&this.active_handler.update(b)}},ba.prototype.on_drag_end=function(a){this.send_events&&this.events.drag_end(new qb(this.uid))},ba.prototype.on_touch=function(a){if(!this.active_action&&(this.interactive||"inspect"===this.mode)){var b=this.selectInputEvent(a,d3.event);if((a||this.always_visualize_fingers)&&this.update_fingers(b.fingers),this.active_handler)return void(this.send_events&&this.events.touch(new rb(b,this.id)));var c,d=this.get_user_selection(b.finger,null,b);1===b.fingers.length?(b.shiftKey||this.start_of_interaction(),b.shiftKey?c=Wa.array.xor(this.selected_nodes,d):Wa.array.containsAll(this.selected_nodes,d)||(c=d)):2===b.fingers.length&&(c=this.get_user_selection(b.fingers[0],b.fingers[1],b)),this.send_events&&this.events.touch(new rb(b,this.id,d,c||this.selected_nodes)),c&&this.highlight_nodes(c)}},ba.prototype.on_release=function(a){if(this.interactive||"inspect"===this.mode){var b=this.selectInputEvent(a,d3.event);if((a||this.always_visualize_fingers)&&this.update_fingers(b.fingers),this.ignore_next_release_event)return void(this.ignore_next_release_event=!1);if(this.send_events&&this.events.release(new sb(b,this.id)),0===b.fingers.length){var c=b.shiftKey;this.active_handler&&(this.active_handler instanceof ca&&(c=!0),this.active_handler.end(),this.active_handler=null),this.active_action||c||(this.pending_eoi=setTimeout(function(){this.pending_eoi=null,this.end_of_interaction(),this.highlight_nodes([])}.bind(this),1))}}},ba.prototype.get_user_selection=function(a,b,c,d){var e;if(b)e=this.get_nodes_between(a.pos,b.pos);else{var f=d||this.get_closest_node_at(a.pos);if(!f)return[];if(f=this.getFirstUnfixedParent(f),c.altKey||this.spaceBarDown){for(;f.parent.parent&&!f.parent.commutative;)f=f.parent;var g=f.parent.parent;e=g&&g.is_group("fraction")?f.parent.is_group("mul")?g.get_top():g.get_bottom():f.parent.commutative?[f.parent.parent]:"AlgebraModel"===f.parent.type?[f]:[f.parent]}else e=[f]}return Va.nodes_to_range(e)},ba.prototype.highlight_nodes=function(a,b){if(!Wa.array.equals(this.selected_nodes,a)){this.selected_nodes=a;var c=this.view;Va.for_each(function(a){a.selected=!1},c.model.children);for(var d=0;d<a.length;d++)a[d].selected=!0;c.renderer.set_style(c.model.children),c.update_style(b),this.send_events&&this.events.node_selection(new tb(this.id,a))}},ba.prototype.get_hits=function(a){var b=a[0],c=a[1];return Va.get_leaf_nodes(this.view.model).filter(function(a){return!a.hidden&&a.sel_box&&b<=a.x+a.sel_box.x+a.sel_box.width&&b>=a.x+a.sel_box.x&&c<=a.y+a.sel_box.y+a.sel_box.height&&c>=a.y+a.sel_box.y})},ba.prototype.get_closest_node_at=function(a){for(var b=null,c=1/0,d=a[0],e=a[1],f=this.get_hits(a),g=0;g<f.length;g++)if(!f[g].hidden){var h=f[g].x-d,i=f[g].y-f[g].baseline_shift-e,j=h*h+i*i;j<c&&(c=j,b=f[g])}return b},ba.prototype.get_nodes_between=function(a,b){var c=0;return Va.get_leaf_nodes(this.view.model).filter(function(d){if(d.hidden||!d.sel_box||"//"==d.value)return!1;var e=[d.x+d.sel_box.x+d.sel_box.width/2,d.y+d.sel_box.y+d.sel_box.height/2],f=jb(a,b,e),g=d.sel_box.width/4+d.sel_box.height/4;return 0==f.len?f.dist<=g+c:f.k>=0&&f.k<=1&&f.dist<=g+c})},jb=function(a,b,c){var d,e,f=.5,g=[b[0]-a[0],b[1]-a[1]],h=Math.sqrt(g[0]*g[0]+g[1]*g[1]);if(h<1e-6)d=a[0]-c[0],e=a[1]-c[1],h=0;else{var d,e,i=[c[0]-a[0],c[1]-a[1]],f=(g[0]*i[0]+g[1]*i[1])/h;f<0?(d=a[0]-c[0],e=a[1]-c[1]):f>h?(d=b[0]-c[0],e=b[1]-c[1]):(d=a[0]+f*g[0]/h-c[0],e=a[1]+f*g[1]/h-c[1])}return{dist:Math.sqrt(d*d+e*e),k:f/h,len:h}},kb=function(a,b,c,d){this.type="drag_start",this.performee=b,this.performee_type="interaction-handler",this.time=Date.now(),this.pos=[a.pos[0],a.pos[1]],this.pos0=[a.pos0[0],a.pos0[1]],this.dist=a.dist,this.dist0=a.dist0,a.altKey&&(this.altKey=a.altKey),a.shiftKey&&(this.shiftKey=a.shiftKey),this.fingers={length:a.fingers.length},this.target=c,this.selection=d},lb=function(a,b,c,d){this.type="tap",this.performee=b,this.performee_type="interaction-handler",this.time=Date.now(),a.altKey&&(this.altKey=a.altKey),a.shiftKey&&(this.shiftKey=a.shiftKey),this.finger={pos:[a.finger.pos[0],a.finger.pos[1]]},this.target=c,this.selection=d},mb=function(a,b,c,d){this.type="dbltap",this.performee=b,this.performee_type="interaction-handler",this.time=Date.now(),a.altKey&&(this.altKey=a.altKey),a.shiftKey&&(this.shiftKey=a.shiftKey),this.finger={pos:[a.finger.pos[0],a.finger.pos[1]]},this.target=c,this.selection=d},nb=function(a,b,c){this.type="key"+a,this.performee=c,this.performee_type="interaction-handler",
this.time=Date.now(),this.keyCode=b.keyCode},ob=function(a,b){this.type="hold",this.performee=b,this.performee_type="interaction-handler",this.time=Date.now(),this.finger={pos:[a.finger.pos[0],a.finger.pos[1]]}},pb=function(a,b,c){this.type="drag",this.performee=b,this.performee_type="interaction-handler",this.time=Date.now(),this.dx=a.dx,this.dy=a.dy,this.dist=a.dist,this.dist0=a.dist0,this.pos=[a.pos[0],a.pos[1]],this.pos0=[a.pos0[0],a.pos0[1]],this.fingers=a.fingers.map(function(a){return{pos:[a.pos[0],a.pos[1]]}}),this.selection=c},qb=function(a){this.type="drag_end",this.performee=a,this.performee_type="interaction-handler",this.time=Date.now()},rb=function(a,b,c,d){this.type="touch",this.performee=b,this.performee_type="interaction-handler",this.time=Date.now(),a.altKey&&(this.altKey=a.altKey),a.shiftKey&&(this.shiftKey=a.shiftKey),a.finger&&(this.finger={pos:[a.finger.pos[0],a.finger.pos[1]],id:a.finger.id}),this.fingers=a.fingers.map(function(a){return{pos:[a.pos[0],a.pos[1]]}}),this.target=c,this.selection=d},sb=function(a,b){this.type="release",this.performee=b,this.performee_type="interaction-handler",this.time=Date.now(),a.altKey&&(this.altKey=a.altKey),a.shiftKey&&(this.shiftKey=a.shiftKey),this.fingers=a.fingers.map(function(a){return{pos:[a.pos[0],a.pos[1]]}}),a.finger&&(this.finger={pos:[a.finger.pos[0],a.finger.pos[1]],id:a.finger.id})},tb=function(a,b){this.type="node_selection",this.performee=a,this.performee_type="interaction-handler",this.time=Date.now(),this.selection=b},ca.prototype.check=function(a){return a.shiftKey},ca.prototype.start=function(a,b){return this.pos0=a.slice(),this.pos=a.slice(),this.initBox(),this.initial_nodes=b,b},ca.prototype.update=function(a){this.pos[0]+=a.dx,this.pos[1]+=a.dy,this.updateBox();var b=this.getNodesInRect(this.pos0[0],this.pos0[1],this.pos[0],this.pos[1]);Wa.array.isPermutation(b,this.nodes)||(this.nodes=b,this.highlight())},ca.prototype.initBox=function(){this.box_el=this.view.main.append("rect").attr("transform","translate("+this.pos0+")").style("stroke",this.view.options.selection_color).style("stroke-width",2).style("fill",this.view.options.selection_color).style("fill-opacity",.33)},ca.prototype.updateBox=function(){this.box_el.attr("width",Math.abs(this.pos[0]-this.pos0[0])).attr("height",Math.abs(this.pos[1]-this.pos0[1])).attr("transform","translate("+Math.min(this.pos0[0],this.pos[0])+","+Math.min(this.pos0[1],this.pos[1])+")")},ca.prototype.getNodesInRect=function(a,b,c,d){var e=Math.min(a,c),f=Math.max(a,c),g=Math.min(b,d),h=Math.max(b,d),i=Va.get_leaf_nodes(this.view.model).filter(function(a){return!a.hidden&&a.sel_box&&e<=a.x+a.sel_box.x+a.sel_box.width&&f>=a.x+a.sel_box.x&&g<=a.y+a.sel_box.y+a.sel_box.height&&h>=a.y+a.sel_box.y});return i},ca.prototype.updatedSelection=function(){return Wa.array.mergedNew(this.initial_nodes,this.nodes).filter(ca.nodeIsNotFractionBar)},ca.nodeIsNotFractionBar=function(a){return"//"!==a.value},ca.prototype.highlight=function(){this.interaction_handler.highlight_nodes(this.updatedSelection())},ca.prototype.end=function(){return this.box_el.remove(),this.updatedSelection()},da.prototype.check=function(a){return a.dist-a.dist0<-15},da.prototype.start=function(a,b){return this.nodes=this.proccess_selection(b),this.node_ids=this.nodes.map(function(a){return a.id}),this.nodes},da.prototype.update=function(a){if(this.joined)return void(a.dist>3*a.dist0/4+10&&this.unjoin());if(!(this.nodes.length<1||a.dist>3*a.dist0/4)){var b=this.nodes[0].commutative?1:0;this.unjoined_state=Va.clone(this.alm.children[0],!0),this.unjoined_state.parent=this.alm,this.joined=!0;var c=this,d=function a(b){c.alm.process_operator(c.nodes[b],function(){b+1<c.nodes.length?a(b+1):c.nodes=[]})};d(b)}},da.prototype.unjoin=function(){var a=this.alm;this.joined=!1,a.children[0]=this.unjoined_state,a.changed(),this.nodes=this.node_ids.map(function(b){return Va.get_by_id(b,a.children)})},da.prototype.end=function(){this.nodes=[],this.node_ids=[],this.unjoined_state=null,this.joined=!1},da.prototype.proccess_selection=function(a){return 2!==a.length?a:a[0].parent.commutative&&a[1].is_group()?a[1].children.slice():a},Wa.JoinHandler=da,ea.prototype.check=function(a){return a.dist-a.dist0>15},ea.prototype.start=function(a,b){return this.prevDist=null,this.nodes=b,this.nodes||[]},ea.prototype.end=function(){this.node=null,this.splitted=!1},ea.prototype.getBestAction=function(a,b,c){var d=c;this.actions.forEach(function(c){d&&c.priority<=d.priority||c.match(b)&&(d=c.createBoundAction(a,{actor:b}))});for(var e=b.children.length-1;e>=0;e--){var f=b.children[e],g=this.getBestAction(a,f,d);g&&(d=g)}return d},ea.prototype.split=function(a,b){for(var c,d=b.length-1;d>=0;d--)c=this.getBestAction(a,b[d],c);if(!c)return!1;a.performAction(c);var e=Va.nodes_to_range(c.mapNodes(c.actor));return e},ea.prototype.update=function(a){if(this.nodes&&!(null!==this.prevDist&&a.dist-this.prevDist<=30)){var b=this.split(this.view.model,this.nodes);b&&(this.prevDist=a.dist,this.nodes=b,this.interaction_handler.highlight_nodes(this.nodes))}},"object"==typeof b&&b.exports&&(b.exports=ea),Wa.SplitHandler=ea,Wa.inherit(Va.Node,fa),Wa.AlgebraModel=fa,fa.getDefaultParser=function(){return fa.defaultParser||(fa.defaultParser=o(["num","var","sym","brackets","sign","add-sub","mul-div","exponent","equals","inequality","param","func","abs-val","radical","degree","latex"])),fa.defaultParser},fa.defaultOptions={hide_mult_op:!0,hide_leading_op:!0,parser:null,no_history:!1,auto_simplify_distributions:!0,auto_simplify_vector_additions:!0,auto_simplify_variables:!0,locked:!1,action_blacklist:[]},fa.prototype.clone=function(a,b){var c=new fa(null,this.options);return c.hide_rules=this.hide_rules.slice(),Va.append(c,Va.clone(this.children[0],a,b||["id","value","name","bp","associative","commutative","vertical_notation","selected","dragging","locked","fixed","hidden","simplify","deleted","precision","color","size","width","height","x","y","x0","y0","rel_x","rel_y","lmar","rmar"])),c},fa.prototype.move_actions=[],fa.is_top_most=function(a){return!a.parent||a.parent instanceof fa},fa.prototype.init_hide_rules=function(){for(var a=0;a<this.parser.symbols.length;a++){var b=Wa.expressions[this.parser.symbols[a]];b.hide_rule&&this.hide_rules.push(b.hide_rule)}},fa.prototype.parseAndSet=function(a,b,c){var d=this.children[0];this.children=[];var e=this.parser.parse(a);if(!e)return!1;Va.append(this,e),b||this.remove_brackets(),this.hide_nodes(),this.setLocked(this.options.locked);var f=null;try{d&&(f=d.get_mapping_to(this.children[0]))}catch(a){console.log("could not auto-map",d.to_ascii(),"to",this.to_ascii())}finally{return this.events.change(new fa.ChangeEvent({model:this,node_map:f,no_anim:!0,sender:c})),!0}},fa.prototype.replace_with=function(a,b){var c,d;a instanceof fa?(c=a,c.setLocked(this.options.locked)):c=new fa(a,this.options);try{d=this.children[0].get_1to1_mapping_to(c.children[0],!1)}catch(a){console.log("could not auto-map",this.to_ascii(),"to",c.to_ascii())}finally{return this.events.change(new fa.ChangeEvent({model:this,new_model:c,node_map:d,no_anim:!0,sender:b})),c}},fa.prototype.parse=function(a,b){var c=this.parser.parse(a);return c?(b||this.remove_brackets([c]),c):null},fa.prototype.to_ascii=function(a){return fa.to_ascii(this.children,a)},fa.to_ascii=function(a,b){return Array.isArray(a)||(a=[a]),a.map(function(a){return a.to_ascii(b)}).join("")},fa.prototype.to_latex=function(a){return a=a||this.children,Array.isArray(a)||(a=[a]),a.map(function(a){return a.to_latex()}).join("")},fa.select_range_by_value=function(a,b){return function(c){return!!c[0].parent&&((!c[0].parent.parent||!fa.range_contains_all_siblings(c))&&(fa.rangeToAscii(c)===a||fa.rangeToAsciiNoLeadingOp(c,b)===a||1===c.length&&fa.fractionToAscii(c[0])===a))}},fa.rangeToAscii=function(a){return 1===a.length&&a[0].hidden?"":a.map(function(a){return a.to_ascii()}).join("")},fa.isLeadingCommutativeOp=function(a){return a.is_group()&&a.commutative&&a.associative},fa.rangeToAsciiNoLeadingOp=function(a,b){if(0===a.length)return"";if(1===a.length&&a[0].hidden)return"";var c=a.map(function(a){return a.to_ascii()}).join("");return(1!==a.length||b)&&fa.isLeadingCommutativeOp(a[0])?c.substring(a[0].children[0].to_ascii().length):c},fa.fractionToAscii=function(a){if(!a.is_group("fraction"))return"";var b=a.to_ascii();return"("===b.slice(0,1)&&")"===b.slice(b.length-1,b.length)&&(b=b.substr(1,b.length-2)),b},fa.range_contains_all_siblings=function(a){return a[0]&&a[0].parent&&!a[0].parent.is_group("exponent")&&a.length===a[0].parent.children.length},fa.select_node_by_value=function(a){return function(b){return!b.is_root()&&!b.hidden&&!b.fixed&&b.to_ascii()===a}},fa.getRanges=function(a,b,c){var d=Va.filterRange(fa.select_range_by_value(a),c);return"number"==typeof b?d[b]:d},fa.prototype.getRanges=function(a,b,c){return fa.getRanges(a,b,c||this.children)},fa.getNodes=function(a,b,c){var d=Va.filter(fa.select_node_by_value(a,!0),c);return"number"==typeof b?d[b]:d},fa.prototype.getNodes=function(a,b,c){return fa.getNodes(a,b,c||this.children)},fa.select_node_by_stringified_value=function(a){return function(b){return!b.is_root()&&!b.hidden&&b.stringify()===a}},fa.getNodesStringified=function(a,b,c){var d=Va.filter(fa.select_node_by_stringified_value(a),c);return"number"==typeof b?d[b]:d},fa.prototype.getNodesStringified=function(a,b,c){return fa.getNodesStringified(a,b,c||this.children)},fa.prototype.setLocked=function(a){this.options.locked=a,this.for_each(function(b){b.locked=a}),this.events["scrubbability-changed"]({type:"scrubbability-changed"})},fa.ChangeEvent=function(a){this.type="change",this.old_model_ascii=a.old_model_ascii,this.old_model_string=a.old_model_string,this.old_model=a.model,this.new_model=a.new_model||a.model,this.node_map=a.node_map||a.action&&a.action.node_map||[],this.action=a.action,this.sel=a.sel,this.no_anim=a.no_anim,this.sender=a.sender},fa.prototype.created=function(a,b){this.events.create({type:"create",term:a&&a.newTree&&a.newTree.to_ascii(),action:a,sender_id:b||this.id})},fa.prototype.startInteraction=function(){this.events["start-of-interaction"]({type:"start-of-interaction",source:this,model:this,time:Date.now()})},fa.prototype.finishInteraction=function(a){var b={type:"end-of-interaction",source:this,time:Date.now()};if(a)return void this.events["end-of-interaction"](b);var c=this.children[0].filter(function(a){return a.simplify});if(0===c.length)return void this.events["end-of-interaction"](b);var d=Wa.actions.PostInteractionSimplificationAction.createBoundAction(this,{nodes:c,auto_simplify_distributions:this.options.auto_simplify_distributions,auto_simplify_vector_additions:this.options.auto_simplify_vector_additions,auto_simplify_variables:this.options.auto_simplify_variables}),e=this;(this.options.no_history?d.doInPlace():d.run())&&(e=d.newTree,d.newTree.hide_nodes(),d.newTree===d.oldTree?this.events.change(new fa.ChangeEvent({model:this,action:d})):this.created(d)),c.forEach(function(a){a.simplify=!1}),b.source=e,this.events["end-of-interaction"](b)},fa.prototype.root=function(){return this.children[0]},fa.prototype.is_group=function(){return!1},fa.prototype.get_parent_of_product_with_leading_num=function(a){var b=a.parent;return!!(a instanceof E&&b.is_group("mul")&&!b.ls&&b.parent.is_group("product"))&&b.parent.parent},fa.prototype.numeric_value=function(a,b,c){var d,e=this.to_ascii(),f=this.stringify(),g=this.getSelectorOfNodes(a),h=a,i=a.parent;if(a instanceof E&&i&&(i.is_group("sign")||i.is_group("add")||i.is_group("sub"))&&(a=i),d=E.get_value(a),isNaN(d))return NaN;var j=this.get_parent_of_product_with_leading_num(a),k=j&&j.is_group("add")?j:null,l=j&&j.is_group("sub")?j:null;if(l&&(d=-d),arguments.length<2)return d;var m=d>0||0===d&&(a instanceof E||a.is_group("add")),n=b>0||0===b&&(a instanceof E||a.is_group("add"));if(m&&!n)if(a.is_group("add"))a.invert(),this.hide_nodes();else if(k)k.invert(),this.hide_nodes();else{var o=Va.remove(a),p=new Q(a);p.children[0].no_anim=!0,Va.insert(i,o,p),p.selected=a.selected,a=p}else if(!m&&n)if(a.is_group("sign")){var q=a.children[1];Va.replace(a,q),a.children[0].no_anim=!0,q.selected=a.selected,a=q}else a.is_group("sub")?(a.invert(),this.hide_nodes()):l&&(l.invert(),this.hide_nodes());else if(this.f_eqls(d,b))return a;a.is_group()?a.children[1].value=Math.abs(b):a.value=Math.abs(b);var r=this.children[0].get_mapping_to(this.children[0]);return r[h.id]=[a],this.events.change(new fa.ChangeEvent({model:this,node_map:r,no_anim:!0,old_model_ascii:e,old_model_string:f,sel:g,sender:c})),a},fa.prototype.f_eqls=function(a,b){return Math.abs(a-b)<1e-6},fa.prototype.remove_brackets=function(a){Va.for_each(function(a){a.is_group("fraction")&&a.parent.is_group("brackets")&&x.handle(a.parent,!0)},a||this.children)},fa.prototype.process_operator=function(a,b,c){var d=this.getBestMatchingAction(a,c),e=d.term,f=d.action;if(!f)return b&&b(!1),!1;var g=f.createBoundAction(this,{actor:e},c);return this.performAction(g,b),g},fa.prototype.getBestMatchingAction=function(a,b){var c=a;if(c.fixed)return{term:c,action:null};for(;!c.getBestMatchingAction&&c.parent&&(!c.parent.is_group("equals")||1===c.get_idx()&&c.parent.is_group("equals"));)c=c.parent;return c.getBestMatchingAction&&c.parent&&"AlgebraModel"!==c.parent.type&&!c.getBestMatchingAction(b,this.options.action_blacklist)&&(!c.parent.is_group("equals")||1===c.get_idx()&&c.parent.is_group("equals"))&&!c.is_group("fraction","power","radical")&&(c=c.parent),x.areHidden(c)&&(c=c.parent),c.getBestMatchingAction?{term:c,action:c.getBestMatchingAction(b)}:{term:c,action:null}},fa.prototype.performAction=function(a,b,c,d){var e=[a];if(a&&a.settings&&a.settings.makes_no_changes)return a.doInPlace(),a;"undefined"==typeof c&&(c=this.options.no_history);var f=this,g=function(a){if(!a)return f.events.mistake(f),void(b&&b(a));if(c?(f.hide_nodes(),f.events.change(new fa.ChangeEvent({model:f,action:a}))):(a.newTree.hide_nodes(),f.created(a)),!d&&a.settings.restraint&&f.events.restraint(a.settings.restraint),a.followup){var g=a.newTree.performAction(a.followup,b,c);e=e.concat(g)}else b&&b(a.newTree)};return a?(c?a.doInPlace(g):a.run(g),1===e.length?e[0]:p.createComposedAction(e,e[0].name,e[0].description)):(g(),null)},fa.prototype.hide_nodes=function(){return this.hideNodesAction.doInPlace(this)},fa.prototype.performSplitAction=function(a){var b=new ea;b.split(this,a||this.children)},fa.prototype.getMoveActions=function(a){if(0===a.length)return[];if(a.some(function(a){return a.fixed}))return[];for(var b=[],c=0;c<this.move_actions.length;c++){var d=this.move_actions[c];d.name&&this.options.action_blacklist.indexOf(d.name)!==-1||(b=b.concat(this.move_actions[c].getAllAvailableActions(a)))}return b},fa.groupNodeRanges=function(a){return fa.groupNodes(a,function(a,b){return a[a.length-1].rs===b})},fa.groupNodes=function(a,b){if(!a.length)return[];var c=[],d=[a[0]];c.push(d);for(var e=1;e<a.length;e++)b(d,a[e])?d.push(a[e]):(d=[a[e]],c.push(d));return c},fa.__reg_exp_cache={},fa.match=function(a,b){for(var c=fa.__reg_exp_cache,d=0;d<b.length;d++){var e=b[d];c[e]||(c[e]=new q(e));var f=c[e].match(a);if(f)return f}return!1},Va.Node.prototype.match=function(){return fa.match(this,arguments)},fa.prototype.make_flat=function(){var a=Va.get_leaf_nodes(this),b=new Group("flat",0);b.commutative=!0,a.forEach(function(a){a.hidden||(a.commutative=!0,a.associative=!0,Va.append(b,a))}),this.children=[],Va.append(this,b),this.events.change(new fa.ChangeEvent({model:this}))},fa.prototype.getSelectorOfNodes=function(a){Array.isArray(a)||(a=[a]);for(var b=[],c=0;c<a.length;c++){var d=a[c];if(d===this)b.push(this.to_ascii());else{var e=this.getNodes(d.to_ascii()),f=e.indexOf(d);f===-1?b.push(""):0===f?b.push(d.to_ascii()):b.push(d.to_ascii()+":"+f)}}return b},fa.prototype.getNodesFromSelector=function(a){var b=a.split(";");return b.map(function(a){var b=a.split(":");return this.getNodes(b[0],+b[1]||0)}.bind(this))},fa.evalExpression=function(a,b){var c=function(a,b){return a+b},d=function(a,b){return a*b},b=b||{};a&&a instanceof fa&&(a=a.children[0]);var e=function a(e){return e?E.is_num(e)?E.get_value(e):e.is_group("mul","add","brackets")?a(e.children[1]):e.is_group("sign","sub")?-a(e.children[1]):e.is_group("div")?1/a(e.children[1]):e.is_group("exponent")?a(e.children[0]):"//"===e.value?1:e.is_group("product","fraction")?e.children.map(a).reduce(d,1):e.is_group("sum")?e.children.map(a).reduce(c,0):e.is_group("power")?Math.pow(a(e.children[0]),a(e.children[1])):Func.Trig.is_trig_func(e)?Func.Trig.evaluate(e):e.is_group("var")&&e.get_value()in b?b[e.get_value()]:NaN:NaN};return Array.isArray(a)?Va.is_range(a)?a[0].get_parent(1).is_group("product","fraction")?a.map(e).reduce(d,1):a[0].get_parent(1).is_group("sum")?a.map(e).reduce(c,0):NaN:NaN:e(a)},Wa.AlgebraModelLink=ga,ga.prototype.onChange=function(a){if(a.old_model!==this.source)throw"wrong old_model";a.new_model!==a.old_model&&(this.source.events.on("change."+this.id,null),this.source=a.new_model,Wa.LinkCoordinator.replaceNode(a.old_model,a.new_model),this.source.events.on("change."+this.id,this.onChange.bind(this)));var b=this.action.nodes,c=this.action.target,d=this.action.actor;if(this.action.broken)try{var e=this.model_before_broken.children[0].get_1to1_mapping_to(a.new_model.children[0],!1);this.action.rebind(a.new_model,e,a.old_model)}catch(b){return void console.log("scrubbing broke, can't reapply",this.action.name,"to",a.new_model.to_ascii())}else this.action.rebind(a.new_model,a.node_map,a.old_model);this.action.rematch()?(this.action.broken=!1,this.model_before_broken=null,this.action.run(),this.action.newTree.hide_nodes(),this.action.newTree.for_each(function(a){a.selected=!1}),this.target.replace_with(this.action.newTree)):(this.action.nodes=b,this.action.target=c,this.action.actor=d,this.action.broken||(this.action.broken=!0,this.model_before_broken=a.old_model),console.log("scrubbing broke, can't reapply",this.action.name,"to",this.source.to_ascii()))},ga.prototype.onTargetChange=function(a){if(a.old_model!==this.target)throw"wrong old_model";a.new_model!==a.old_model&&(this.target.events.on("change."+this.id,null),this.target=a.new_model,Wa.LinkCoordinator.replaceNode(a.old_model,a.new_model),this.target.events.on("change."+this.id,this.onTargetChange.bind(this)))},Wa.LinkCoordinator=function(){var a=function(){this.id=Wa.uid(),this.links=[],this.groups=[],this.node_to_group={},this.unlinked_nodes=[],this.events=d3.dispatch("link_added","link_removed"),this.auto_update_scrubbability=!0};return Wa.LinkCoordinatorClass=a,a.prototype.addLinks=function(a,b){var c=this;a.forEach(function(a){c.addLink(a,b)})},a.prototype.addLink=function(a,b){this.links.push(a),this.registerLink(a,b),this.events.link_added({link:a})},a.prototype.registerLink=function(a,b){var c=this.getGroup(a.source),d=this.getGroup(a.target);if(a.bidirectional){if(c!==d){var e=this.mergeGroups(c,d);this.auto_update_scrubbability&&!b&&this.setLocked(e)}}else{if(c===d)throw"unidirectional linking between bidirectionally linked nodes!";d.deps++,this.auto_update_scrubbability&&!b&&this.setLocked(d)}},a.prototype.getGroup=function(a){var b=this.node_to_group[a.id];return b||(b={deps:0,nodes:[a]},this.groups.push(b),this.node_to_group[a.id]=b),b},a.prototype.replaceNode=function(a,b){if(this.node_to_group[a.id]){var c=this.node_to_group[a.id];delete this.node_to_group[a.id],this.node_to_group[b.id]=c;var d=c.nodes.indexOf(a);c.nodes[d]=b}},a.prototype.unlinkCanvasModel=function(a,b){var c=this;a.dls().forEach(function(a){c.unlinkDL(a,!0)}),a.graphs().forEach(function(a){c.unlinkGraph(a,!0)}),this.auto_update_scrubbability&&!b&&this.updateAll()},a.prototype.unlinkDL=function(a,b){return this.unlinkContainer(a.rows,"model",b)},a.prototype.unlinkGraph=function(a,b){return this.unlinkContainer(a.geoms,null,b)},a.prototype.unlinkContainer=function(a,b,c){var d=this,e=[];return a.forEach(function(a){e=e.concat(d.unlinkElement(b?a[b]:a,!0))}),this.auto_update_scrubbability&&!c&&this.updateAll(),e},a.prototype.unlinkElement=function(a,b){var c=[],d=this;return this.links=this.links.filter(function(b){if(b.source===a||b.target===a){var e=b.source===a?b.target:b.source;return d.unlinked_nodes.indexOf(e)===-1&&d.unlinked_nodes.push(e),c.push(b),!1}return!0}),this.unlinked_nodes.indexOf(a)===-1&&this.unlinked_nodes.push(a),this.auto_update_scrubbability&&!b&&this.updateAll(),c},a.prototype.updateAll=function(){this.groups=[],this.node_to_group={};for(var a=0;a<this.unlinked_nodes.length;a++)this.getGroup(this.unlinked_nodes[a]);this.unlinked_nodes=[];for(var a=0;a<this.links.length;a++)this.registerLink(this.links[a],!0);for(var a=0;a<this.groups.length;a++)this.setLocked(this.groups[a])},a.prototype.setLocked=function(a){a.nodes.forEach(function(b){b.setLocked(a.deps>0)})},a.prototype.mergeGroups=function(a,b){var c=this,d=this.groups.indexOf(b);return this.groups.splice(d,1),b.nodes.forEach(function(b){c.node_to_group[b.id]=a}),a.nodes=a.nodes.concat(b.nodes),a.deps+=b.deps,a},new a}(),Wa.factoring={},Wa.factoring.bypass_negatives=function(a){for(;a.is_group("sign");)a=a.get_child([1]);return a},Wa.factoring.factorable_muldiv=function(a){var b=a;if(b.get_parent(1).is_group("fraction")&&b.get_parent(2).is_group("mul")&&(b=b.get_parent(2)),!b.is_group("mul","div"))return!1;var c=b.get_parent(1);if(!c.is_group("product","fraction"))return!1;var d=c.get_parent(1);if(!d.is_group("add","sub"))return!1;var e=d.get_parent(1);return!!e.is_group("sum")&&{ancestor_sum:e,addsub_idx:d.get_idx()}},Wa.factoring.val1_is_a_multiple_of_val2=function(a,b){return Math.abs(a)>=Math.abs(b)&&1!==Math.abs(b)&&a%b===0},Wa.factoring.get_gcf=function(a,b){if(!Number.isInteger(a)||!Number.isInteger(b))return 1;if(a<0&&(a=-a),b<0&&(b=-b),b>a){var c=a;a=b,b=c}for(;;){if(a%=b,0==a)return b;if(b%=a,0==b)return a}},Wa.factoring.numbers_are_multiples=function(a,b){var c=E.get_value(a),d=E.get_value(b);return!(!c||!d)&&(!!Wa.factoring.val1_is_a_multiple_of_val2(c,d)||(!!Wa.factoring.val1_is_a_multiple_of_val2(d,c)||1!==Wa.factoring.get_gcf(c,d)))},Wa.factoring.operator_ranges_are_permutations=function(a,b){var c=a.map(function(a){return a.children[1].to_ascii()}),d=b.map(function(a){return a.children[1].to_ascii()});return Wa.array.isPermutation(c,d)},Wa.canceling={},Wa.canceling.find_top_level_group_for_canceling=function(a){return Wa.canceling.nodes_are_in_a_fraction_within_a_product(a[0])||Wa.canceling.get_parent_product_containing_fraction(a[0])||Wa.canceling.get_parent_fraction(a[0])},Wa.canceling.nodes_are_in_a_fraction_within_a_product=function(a){var b=a.parent;return!!(b.is_group("fraction")&&b.parent&&b.parent.is_group("mul")&&b.parent.parent.is_group("product"))&&b.parent.parent},Wa.canceling.get_parent_product_containing_fraction=function(a){var b=a.parent;return!(!b.is_group("product")||!b.children.some(function(a){return a.children[1].is_group("fraction")}))&&b},Wa.canceling.get_parent_fraction=function(a){var b=a.parent;return b.is_group("fraction")?b:null},Wa.canceling.node_is_ancestor_of_nodes=function(a,b){return b.every(function(b){for(var c=b;c;){if(c===a)return!0;c=c.parent}return!1})},Wa.actions.CloneAction=function(){var a=function(){p.call(this,"CloneAction","clone"),this.triggerType="drag"};return Wa.inherit(p,a),a.prototype.rematch=function(){return!0},a.prototype.transform=function(a){return"function"!=typeof a||void a(this)},new a}(),Wa.actions.AbsValAction=function(){var a=function(a){p.call(this,"AbsValAction","evaluate absolute value"),this.priority=4,this.triggerType="tap",a&&(this.actor=a.actor)};Wa.inherit(p,a),a.prototype.match=function(a){return!!a.match("|±\\NUM|")||!(!a.is_group("abs-val")||!this.prodFracContainingNumbers(a.get_child([1])))},a.prototype.prodFracContainingNumbers=function(a){return!!a.is_group("product","fraction")&&a.get_top().concat(a.get_bottom()).every(function(a){return E.is_num(a.get_child([1]))})},a.prototype.transform=function(a){var b=this.getNewTreeNode(this.actor);this.addTouchedNodes(this.actor);var c=b.match("|±{n:\\NUM}|");if(c){var d=c.n;Va.replace(b,d),this.cleanup(d.parent)}else{var e=b.get_child([1]);Va.replace(b,e),e.get_top().concat(e.get_bottom()).forEach(function(a){var b=a.get_child([1]);b.is_group("sign")&&Va.replace(b,b.get_child([1]))}),this.cleanup(e.parent)}return"function"!=typeof a||void a(this)};var b=new a;return y.prototype.add_action_handler(b),b}(),Wa.actions.AbsValDoubleAction=function(){var a=function(a){p.call(this,"AbsValDoubleAction","nested absolute values"),this.priority=4,this.triggerType="tap",a&&(this.actor=a.actor)};Wa.inherit(p,a),a.prototype.match=function(a){return a&&a.match("||±\\ANY||")},a.prototype.transform=function(a){this.addTouchedNodes(this.actor);var b=this.getNewTreeNode(this.actor),c=b.match("|{n:|±\\ANY|}|").n;return Va.replace(b,c),"function"==typeof a&&a(this),!0};var b=new a;return y.prototype.add_action_handler(b),b}(),Wa.actions.AbsValNegVarAction=function(){var a=function(a){p.call(this,"AbsValNegVarAction","absolute value of a negative variable"),this.priority=4,this.triggerType="tap",a&&(this.actor=a.actor)};Wa.inherit(p,a),a.prototype.match=function(a){return!!a.match("|-\\VAR|")||!(!a.is_group("abs-val")||!this.prodFracContainingNegativeTerms(a.get_child([1])))},a.prototype.prodFracContainingNegativeTerms=function(a){return!!a.is_group("product","fraction")&&a.get_top().concat(a.get_bottom()).some(function(a){return a.get_child([1]).is_group("sign")})},a.prototype.transform=function(a){this.addTouchedNodes(this.actor);var b=this.getNewTreeNode(this.actor),c=b.match("|{neg:-{var:\\VAR}}|");if(c)Va.replace(c.neg,c.var);else{var d=b.get_child([1]);d.get_top().concat(d.get_bottom()).forEach(function(a){var b=a.get_child([1]);b.is_group("sign")&&Va.replace(b,b.get_child([1]))})}return"function"!=typeof a||void a(this)};var b=new a;return y.prototype.add_action_handler(b),b}(),Wa.actions.AbsValExtractNumAction=function(){var a=function(a){p.call(this,"AbsValExtractNumAction","pull a number out of an absolute value"),this.priority=4,this.triggerType="drag",this.settings={},a&&(this.nodes=a.nodes,this.target=a.target,this.settings.side=a.side)};return Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(a){if(!Va.is_range(a))return[];if(!a[0].is_group("mul"))return[];if(!a[0].get_parent(2).is_group("abs-val"))return[];if(!a.every(function(a){return E.is_num(a.get_child([1]))}))return[];var b=a[0].get_root(),c=a[0].get_parent(2);return[this.createBoundAction(b,{nodes:a,target:c,side:"left-of"}),this.createBoundAction(b,{nodes:a,target:c,side:"right-of"})]},a.prototype.transform=function(a){this.addTouchedNodes(this.nodes),this.addTouchedNodes(this.target);var b=this.getNewTreeNode(this.target),c=this.getNewTreeNode(this.nodes),d=c[0].get_parent(1),e=b.get_parent(1),f=b.remove(),g=new J;return c.forEach(function(a){var b=a.get_child([1]);b.is_group("sign")&&b.replace_with(b.get_child([1]))}),Va.remove_range(c),g.append(new K(b)),"left-of"===this.settings.side?g.insert_range(0,c):g.append_range(c),e.insert(f,g),this.cleanup(d),this.cleanup_cascade(g.get_parent(1)),"function"!=typeof a||void a(this)},new a}(),fa.prototype.move_actions.push(Wa.actions.AbsValExtractNumAction),Wa.actions.AbsValInsertPosNumAction=function(){var a=function(a){p.call(this,"AbsValInsertPosNumAction","move a range of positive numbers inside an absolute value group"),this.priority=4,this.triggerType="drag",this.settings={},a&&(this.nodes=a.nodes,this.target=a.target,this.settings.side=a.side)};Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(a){if(!Va.is_range(a))return[];if(!a[0].is_group("mul","div"))return[];if(!a.every(this.isPosNum))return[];var b=this.getOtherAbsValMulDivsInGroup(a[0]);return this.bindActionsForEachTarget(a,b)},a.prototype.isPosNum=function(a){var b=a.children[1];return b&&E.is_num(b)&&E.get_value(b)>=0},a.prototype.isAbsVal=function(a){return a.get_child([1]).is_group("abs-val")},a.prototype.getOtherAbsValMulDivsInGroup=function(a){var b=a.get_parent(1),c=b.get_top().concat(b.get_bottom()).filter(function(b){return b.value===a.value&&this.isAbsVal(b)},this);return c},a.prototype.bindActionsForEachTarget=function(a,b){var c=[];a[0].get_root();return b.forEach(function(b){var d=b.get_child([1,1]);d=d.is_group("product")?d.children.slice():[d],c=c.concat(this.bindActionForEachTarget(a,d,!0))},this),c},a.prototype.transform=function(a){this.addTouchedNodes(this.nodes),this.addTouchedNodes(this.target);var b=this.getNewTreeNode(this.nodes),c=this.getNewTreeNode(this.target),d=b[0].get_parent(1);if(Va.remove_range(b),b[0].is_group("div")&&b.forEach(function(a){a.invert()}),c.is_group("mul")){var e=c.get_parent(1);e.insert_range(c.get_idx()+("left-of"===this.settings.side?0:1),b)}else{var f=c.get_parent(1),g=c.remove(),h=new J;h.append(new K(c)),h.insert_range("left-of"===this.settings.side?0:1,b),f.insert(g,h)}return this.cleanup_cascade(d),"function"!=typeof a||void a(this)};var b=new a;return b}(),fa.prototype.move_actions.push(Wa.actions.AbsValInsertPosNumAction),Wa.actions.AbsValExtractVarAction=function(){var a=function(a){p.call(this,"AbsValExtractVarAction","pull a variable out of an absolute value"),this.priority=4,this.triggerType="drag",this.settings={},a&&(this.nodes=a.nodes,this.target=a.target,this.settings.side=a.side)};return Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(a){if(!Va.is_range(a))return[];if(!a[0].is_group("mul"))return[];if(!a[0].get_parent(1).is_group("product"))return[];if(!a[0].get_parent(2).is_group("abs-val"))return[];if(!a.some(function(a){return!E.is_num(a.get_child([1]))}))return[];var b=a[0].get_root(),c=a[0].get_parent(2);return[this.createBoundAction(b,{nodes:a,target:c,side:"left-of"}),this.createBoundAction(b,{nodes:a,target:c,side:"right-of"})]},a.prototype.transform=function(a){this.addTouchedNodes(this.nodes),this.addTouchedNodes(this.target);var b=this.getNewTreeNode(this.target),c=this.getNewTreeNode(this.nodes),d=c[0].get_parent(1),e=b.get_parent(1),f=b.remove(),g=new J,h=new y(new J),i=h.get_child([1]),j=new K(h);return g.append(new K(b)),"left-of"===this.settings.side?g.insert(0,j):g.append(j),Va.remove_range(c),i.append_range(c),e.insert(f,g),this.cleanup(d),this.cleanup(i),this.cleanup_cascade(g.get_parent(1)),this.setNodesToReselectAfterAction(j),"function"!=typeof a||void a(this)},new a}(),fa.prototype.move_actions.push(Wa.actions.AbsValExtractVarAction),Wa.actions.AbsValCombineAction=function(){var a=function(a){p.call(this,"AbsValCombineAction","combine two absolute value terms into one"),this.priority=4,this.triggerType="tap",this.settings={delay:300,side:"inside"},a&&(a.actor?this.actor=a.actor:(this.triggerType="drag",this.nodes=a.nodes,this.target=a.target))};Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(a){if(1!==a.length)return[];if(!a[0].is_group("mul","div")||!a[0].get_child([1]).is_group("abs-val"))return[];var b=this.getOtherAbsValMulDivsInGroup(a[0]);return this.bindActionForEachTarget(a,b)},a.prototype.getOtherAbsValMulDivsInGroup=function(a){var b=a.get_parent(1),c=b.get_top().concat(b.get_bottom()).filter(function(b){return b!==a&&b.value===a.value&&b.get_child([1]).is_group("abs-val")},this);return c},a.prototype.match=function(a){return!(!a.ls||a.ls.value!==a.value)&&(a.ls.get_child([1]).is_group("abs-val")&&a.get_child([1]).is_group("abs-val"))},a.prototype.transform=function(a){this.addTouchedNodes(this.nodes||this.actor),this.target&&this.addTouchedNodes(this.target);var b=this.getNewTreeNode(this.nodes||this.actor),c=this.getNewTreeNode(this.target||this.actor.ls);Array.isArray(b)&&(b=b[0]);var d=this.getOldTreeNode(b),e=this.getOldTreeNode(c),f=b.get_idx()<c.get_idx(),g=b.get_parent(1);b.remove();var h=c.remove(),i=this.getTermForAbsVal(b),j=this.getTermForAbsVal(c),k=new J;k.append(j),f?k.insert(0,i):k.append(i);var l=new y(k),m=new K(l,d.value);return this.mapOpAndSym(d,m),this.mapBars(d.get_child([1]),l),this.mapOpAndSym(e,m),
this.mapBars(e.get_child([1]),l),g.insert(h,m),this.setNodesToReselectAfterAction(i.children[1].is_group("product")?i.children[1].children:i),this.cleanup(i),this.cleanup(j),this.cleanup_cascade(g),"function"!=typeof a||void a(this)},a.prototype.getTermForAbsVal=function(a){var b=a.get_child([1,1]);return b.remove(),new K(b)},a.prototype.mapOpAndSym=function(a,b){this.updateNodeMap(a,b),this.updateNodeMap(a.get_child([1]),b.get_child([1]))},a.prototype.mapBars=function(a,b){this.updateNodeMap(a.get_child([0]),b.get_child([0])),this.updateNodeMap(a.get_child([2]),b.get_child([2]))};var b=new a;return K.prototype.add_action_handler(b),b}(),fa.prototype.move_actions.push(Wa.actions.AbsValCombineAction),Wa.actions.AbsValFracSplitAction=function(){var a=function(a){p.call(this,"AbsValFracSplitAction","isolating the absolute value to the numerator and denominator"),this.priority=4,this.triggerType="drag",this.settings={},a&&(this.nodes=a.nodes,this.target=a.target,this.settings.side=a.side)};return Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(a){if(!Va.is_range(a))return[];var b=a[0].get_parent(1);if(!b.is_group("fraction"))return[];if(a[0].is_group("mul")&&a.length!==b.get_top().length)return[];if(a[0].is_group("div")&&a.length!==b.get_bottom().length)return[];var c=b.get_parent(1);if(!c.is_group("abs-val"))return[];var d=a[0].get_root(),e=a[0].is_group("mul")?"above":"below";return[this.createBoundAction(d,{nodes:a,target:c,side:e})]},a.prototype.transform=function(a){this.addTouchedNodes(this.nodes),this.addTouchedNodes(this.target);var b=this.getNewTreeNode(this.target),c=b.get_child([1]),d=b.get_parent(1),e=b.remove();c.remove();var f=c.get_top();Va.remove_range(f);var g=new J;g.append_range(f);var h=new y(g),i=c.get_bottom();Va.remove_range(i);var j=new J;i.forEach(function(a){a.invert()}),j.append_range(i);var k=new y(j);return c.append(new K(h)),c.append(new K(k,"div")),d.insert(e,c),this.cleanup(g),this.cleanup(j),this.cleanup_cascade(d),"function"!=typeof a||void a(this)},new a}(),fa.prototype.move_actions.push(Wa.actions.AbsValFracSplitAction),Wa.actions.AbsValFracSplitAction=function(){var a=function(a){p.call(this,"AbsValFracSplitAction","isolating the absolute value to the numerator and denominator"),this.priority=4,this.triggerType="tap",this.settings={},a&&(this.actor=a.actor)};Wa.inherit(p,a),a.prototype.match=function(a){return!!a.is_group("fraction")&&(!(1!==a.get_top().length||!a.get_child([0,1]).is_group("abs-val"))&&!(1!==a.get_bottom().length||!a.get_child([2,1]).is_group("abs-val")))},a.prototype.transform=function(a){this.addTouchedNodes(this.actor);var b=this.getNewTreeNode(this.actor),c=b.get_child([0]),d=c.get_child([1,1]),e=b.get_child([2]),f=e.get_child([1,1]);d.remove(),f.remove(),c.get_child([1]).remove(),e.get_child([1]).remove(),c.append(d),e.append(f);var g=b.get_parent(1),h=b.remove(),i=new y(b);return g.insert(h,i),this.cleanup(c),this.cleanup(e),this.cleanup_cascade(b),"function"!=typeof a||void a(this)};var b=new a;return J.prototype.add_action_handler(b),b}(),Wa.actions.AbsValVarPowerAction=function(){var a=function(a){p.call(this,"AbsValVarPowerAction","real even powers are positive"),this.priority=4,this.triggerType="tap",this.settings={restraint:"The power base must be real."},a&&(this.actor=a.actor)};Wa.inherit(p,a),a.prototype.match=function(a){return a.is_group("abs-val")&&a.get_child([1]).is_group("power")&&L.is_var(a.get_child([1,0]))&&this.exponentIsAnEvenNumber(a.get_child([1,1,0]))},a.prototype.exponentIsAnEvenNumber=function(a){return E.is_num(a)&&E.get_value(a)%2===0},a.prototype.transform=function(a){this.addTouchedNodes(this.actor);var b=this.getNewTreeNode(this.actor),c=b.get_child([1]);return Va.replace(b,c),"function"!=typeof a||void a(this)};var b=new a;return y.prototype.add_action_handler(b),b}(),Wa.actions.AbsValReselectGroupAction=function(){var a=function(a){p.call(this,"AbsValReselectGroupAction","drag the left absolute value bar to reselect the whole group"),this.priority=2,this.triggerType="drag",this.settings={makes_no_changes:!0,update_node_positions:!0,side:"outside",margin:{y1:.4,y2:.4}},a&&(this.nodes=a.nodes,this.target=a.target)};return Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(a){if(1!==a.length)return[];var b=a[0];if(!b.is_group("sym")||"|"!==b.value)return[];var c=b.get_root(),d=this.createBoundAction(c,{nodes:[b],target:b});return[d]},a.prototype.transform=function(a){return this.addTouchedNodes(this.target.parent),this.setNodesToReselectAfterAction(this.target.parent),"function"==typeof a&&a(this),this},new a}(),fa.prototype.move_actions.push(Wa.actions.AbsValReselectGroupAction),Wa.actions.AbsValCreateNegativeAction=function(){var a=function(a){p.call(this,"AbsValCreateNegativeAction","drag the absolute value bar to the left to produce a negative sign"),this.priority=1,this.triggerType="drag",this.settings={delay:1e3,side:"left-of"},a&&(this.nodes=a.nodes,this.target=a.target)};return Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(a){return 1!==a.length?[]:a[0]instanceof t&&"|"===a[0].to_ascii()?this.absValTermIsNegative(a[0].get_parent(1).get_child([1]))?[]:this.bindActionForEachTarget(a,a):[]},a.prototype.absValTermIsNegative=function(a){return!!(E.is_num(a)&&E.get_value(a)<0)||(!!a.is_group("sign")||!(!a.is_group("product")||!a.get_child([0,1]).is_group("sign")))},a.prototype.transform=function(a){this.addTouchedNodes(this.target.parent);var b=this.getNewTreeNode(this.target.parent),c=b.get_child([1]);if(c.is_group("product")){var d=c.get_child([0]),e=d.get_child([1]),f=e.remove();d.insert(f,new Q(e))}else c.remove(),b.insert(1,new Q(c));return this.setNodesToReselectAfterAction(b),"function"==typeof a&&a(this),this},new a}(),fa.prototype.move_actions.push(Wa.actions.AbsValCreateNegativeAction),Wa.actions.ApplyMacroAction=function(){var a=function(a){p.call(this,"ApplyMacroAction","macro"),this.settings={},a&&(this.nodes=a.nodes,this.target=a.target)};return Wa.inherit(p,a),a.prototype.toJSON=function(){var a=p.prototype.toJSON.call(this);return this.macro_derivation&&(a.macro_derivation=this.macro_derivation.id),a},a.prototype.ids_to_references_after_parsing=function(a){p.prototype.ids_to_references_after_parsing.call(this,a),this.macro_derivation&&(this.macro_derivation=a[this.macro_derivation])},a.prototype.derivationApplicableAsMacro=function(a){if(a.rows.length<2)return!1;var b=0;return a.rows[0].model.get_child([0]).for_each(function(a){a instanceof L&&b++}),b>0},a.prototype.rebind=function(a,b,c){if(this.nodes[0]===c)this.nodes[0]=a,this.nodes[1]=this.macro_derivation.getLastModel();else{if(this.oldTree!==c)throw"wrong old tree during rebinding an action!";var d=new p;d.node_map=b,this.oldTree=a;var e=d.mapNodes(this.target.get_child([0]));e[0]?this.target=d.mapNodes(this.target.get_child([0]))[0].get_parent(1):this.target=[]}},a.prototype.rematch=function(){if(!(this.nodes&&this.nodes.length>0&&this.target))return!1;if(this.nodes[0]){var a,b=this.getAllAvailableActions(this.nodes,this.target);return b.forEach(function(b){a=b.target}),this.target===a}},a.prototype.getAllAvailableActions=function(a,b){return 2!==a.length?[]:a[0].parent||a[1].parent||b.parent?[]:Object.keys(this.getMatches(a[0],b)).length?[this.createBoundAction(b.get_root(),{nodes:a,target:b})]:[]},a.prototype.getMatches=function(a,b){var c=this.createSimpleModel(a),d=b.clone();this.normalizeModel(d);var e=new AlgebraRegExp,f={},g=e.match_tree(d.get_child([0]),c.get_child([0]),f);return g?f:{}},a.prototype.normalizeModel=function(a){a.for_each(function(a){if(a.is_group("sub")){var b=a.get_child([1]);b.is_group("product")&&(b=b.get_child([0,1]));var c=b.parent;b.remove();var d=new Q(b);d.normalized=!0,c.append(d),a.invert()}})},a.prototype.createSimpleModel=function(a){var b=a.clone();return b.for_each(function(a){if(a instanceof L){var b=new Wa.expressions.placeholder("any");b.match_name=a.value,a.replace_with(b)}}),b},a.prototype.bindMacroDerivation=function(a){this.macro_derivation=a},a.prototype.transform=function(a){var b=this.getNewTreeNode(this.target),c=this.getMatches(this.nodes[0],this.target),d=new fa(this.nodes[1].to_ascii());b.get_child([0]).replace_with(d.get_child([0]));var e=Object.keys(c);return b.get_child([0]).for_each(function(a){for(var b=0;b<e.length;b++)if(a.to_ascii()===e[b]){var d=c[e[b]].clone();c[e[b]].normalized&&(d.normalized=!0),a.replace_with(d),x.handle(d);break}}),this.revertNormalizations(b),this.applyNodeMappings(this.nodes[0],this.nodes[1],this.target,b),"function"==typeof a&&a(this),!0},a.prototype.revertNormalizations=function(a){a.for_each(function(a){if(a.normalized){delete a.normalized;var b=a.parent;b&&b.is_group("mul","div")&&(!b.ls||"//"===b.ls.value)&&b.parent.parent&&b.parent.parent.is_group("add","sub")&&(a.replace_with(a.get_child([1])),b.parent.parent.invert()),b&&b.is_group("add","sub")&&(a.replace_with(a.get_child([1])),b.invert())}})},a.prototype.applyNodeMappings=function(a,b,c,d){if(this.macro_derivation){var e=this.macro_derivation.getRowByModel(a),f=this.macro_derivation.getRowByModel(b),g=this.macro_derivation.get_combined_action(e,f),h=this.createNodeMapFromMacroToTarget(a,c),i=this.createNodeMapFromMacroToTarget(b,d);a.get_child([0]).for_each(function(a){var b=h[a.id],c=g.node_map[a.id];c.forEach(function(a){var c=i[a.id];c&&b.forEach(function(a,b){this.extendNodeMap(a,c[b])},this)},this)}.bind(this))}},a.prototype.createNodeMapFromMacroToTarget=function(a,b){var c={};return a.get_child([0]).for_each(function(a){var d=b.get_child(a.get_path());a.has_children()&&d.has_children()?c[a.id]=[d]:c[a.id]=this.flattenTree(d)}.bind(this)),c},a.prototype.flattenTree=function(a){var b=[];return a.for_each(function(a){b.push(a)}),b},new a}(),Wa.actions.PostInteractionSimplificationAction=function(){var a=function(a){p.call(this,"PostInteractionSimplificationAction","simplify terms after interaction"),this.priority=0,this.triggerType="auto",this.settings={simplify_products:!0,simplify_variables:!0,simplify_sums:!0},a&&(this.nodes=a.nodes,"auto_simplify_distributions"in a&&(this.settings.simplify_products=a.auto_simplify_distributions),"auto_simplify_variables"in a&&(this.settings.simplify_variables=a.auto_simplify_variables),"auto_simplify_vector_additions"in a&&(this.settings.simplify_sums=a.auto_simplify_vector_additions))};return Wa.inherit(p,a),a.prototype.match=function(a){return!0},a.prototype.rematch=function(){return!0},a.prototype.transform=function(a){this.changed=!1;for(var b=this.getNewTreeNode(this.nodes),c=0;c<b.length;c++){var d=this.mapNodes(this.nodes[c])[0];if(d){var e=d.parent;if(d.is_group("brackets"))x.handle(d,!0)&&(this.changed=!0),this.cleanup_cascade(e)&&(this.changed=!0);else if(this.prodFracContainingAMulZero(d)&&this.settings.simplify_variables){var f=Wa.find(d.get_top(),function(a){var b=a.get_child([1]);return E.is_num(b)&&0===E.get_value(b)});if(d.get_top().filter(function(a){return a!==f}).concat(d.get_bottom().filter(function(a){return 0!==E.get_value(a.get_child([1]))})).forEach(function(a){a.remove()}),e.is_group("add","sub")){var g=e.parent;e.remove(),this.cleanup(g)}this.changed=!0}else if(d.is_group("product")&&this.settings.simplify_products||d.is_group("sum")&&this.settings.simplify_sums){var h=this.getNumberOperatorsFromGroup(d);if(h.length>1){var i=d.is_group("product")?Wa.actions.MultiplyNumbersAction:Wa.actions.AddSubNumbersAction;this.applyOperators(h,i),d.is_group("product")&&this.applyNegatives(e),this.changed=!0}}else if(this.muldiv1(d)||this.addsub0(d)){var j=e.parent;this.updateNodeMap(this.nodes[c].select_all(),d.ls||d.rs),d.remove(),this.cleanup(e),this.cleanup(j),fa.is_top_most(j)||x.handle(j,!0),this.changed=!0}else if(this.muldivNeg1(d)){var j=e.parent,k=d.children[1];k.remove();var l=k.children[1];this.updateNodeMap(this.nodes[c],d.ls||d.rs),this.updateNodeMap(this.nodes[c].children[1].children[1].get_mapping_to(d.ls||d.rs));var m=d.ls||d.rs;l.remove();var n=m.children[1];n.is_group("sign")?(n.remove(),n=n.children[1],n.remove(),m.append(n)):(n.remove(),k.append(n),m.append(k)),d.remove(),this.cleanup(e),this.cleanup(j),fa.is_top_most(j)||x.handle(j,!0),this.changed=!0}else if(this.exp1(d)){var o=d.parent,p=o.children[0],e=o.parent,q=o.remove();p.remove(),e.insert(q,p),this.changed=!0}this.changed&&this.removeDeletedNodesFromNodeMap()}}return"function"!=typeof a?this.changed:void a(this)},a.prototype.getNumberOperatorsFromGroup=function(a){for(var b=[],c=0;c<a.children.length;c++){var d=a.children[c];E.is_num(d.children[1])&&b.push(d)}return b},a.prototype.applyOperators=function(a,b){for(var c=a[0],d=a.slice(1),e=0;e<d.length;e++)c=this.runAction(b,c,d[e])},a.prototype.runAction=function(a,b,c){var d=a.createBoundAction(this.newTree,{target:b,nodes:[c],triggerType:"drag"});return d.doInPlace(),this.compose(d,!1),d.mapNodes([b])[0]},a.prototype.applyNegatives=function(a){var b=Wa.actions.AddSubCombineSigns;b.match(a)&&this.compose(b.createAndDoInPlace(this.newTree,{actor:a}),!1)},a.prototype.muldiv1=function(a){return E.is_equal_to(a.children[1],1)&&(a.is_group("div")||a.is_group("mul")&&!(a.parent.is_group("fraction")&&1===a.parent.get_top().length))},a.prototype.muldivNeg1=function(a){return a.is_group("mul","div")&&E.is_num(a.children[1])&&E.get_value(a.children[1])===-1},a.prototype.addsub0=function(a){return a.is_group("add","sub")&&E.is_num(a.children[1])&&0===E.get_value(a.children[1])},a.prototype.prodFracContainingAMulZero=function(a){return a.is_group("product","fraction")&&a.get_top().some(function(a){var b=a.get_child([1]);return E.is_num(b)&&0===E.get_value(b)})},a.prototype.getSumAncestor=function(a){for(var b=a.parent;b&&!b.is_group("sum");)b=b.parent;return b},a.prototype.exp1=function(a){return a.is_group("exponent")&&E.is_num(a.children[0])&&1===E.get_value(a.children[0])},new a}(),Wa.actions.AddSubNumbersAction=function(){var a=function(a){p.call(this,"AddSubNumbersAction","add or subtract numbers"),this.priority=1,this.triggerType="tap",this.settings={is_join_action:!0,delay:300,side:"inside",margin:{x:.1}},a&&(a.nodes?(this.triggerType="drag",this.nodes=a.nodes,this.target=a.target):this.actor=a.actor)};return Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(a){if(a.length>1)return[];if(!a[0].is_group("add","sub"))return[];if(!E.is_num(a[0].children[1]))return[];var b=this.getOtherNumberAddendsInSum(a[0]);return this.bindActionForEachTarget(a,b)},a.prototype.getOtherNumberAddendsInSum=function(a){var b=a.parent,c=b.filter(function(c){return c!==a&&c.is_group("add","sub")&&E.is_num(c.children[1])&&c.parent===b});return c},a.prototype.match=function(a){if(!a.parent.is_group("sum"))return!1;if(!a.ls)return!1;var b=a.ls.children[1],c=a.children[1];return E.is_num(b)&&!(b.is_group("sign")&&b.parent.is_group("sub"))&&E.is_num(c)&&!(c.is_group("sign")&&c.parent.is_group("sub"))},a.prototype.transform=function(a){"drag"===this.triggerType?(this.sourceAddend=this.nodes[0],this.targetAddend=this.target):(this.sourceAddend=this.actor,this.targetAddend=this.actor.ls),this.addTouchedNodes(this.sourceAddend),this.addTouchedNodes(this.targetAddend);var b=this.getNewTreeNode(this.sourceAddend),c=this.getNewTreeNode(this.targetAddend),d=b.parent,e=b.children[1],f=c.children[1],g=(b.is_group("sub")?-1:1)*E.get_value(e)+(c.is_group("sub")?-1:1)*E.get_value(f),h=c.is_group("add")&&c.children[1].is_group("sign"),i=new v(new E(g)),j=c.remove();return d.insert(j,i),b.remove(),h||this.applyInnerAction("AddSubCombineSigns",{actor:i}),this.updateNodeMap(this.sourceAddend,i),this.updateNodeMap(this.sourceAddend.children[0],i.children[0]),this.updateNodeMap(this.sourceAddend.children[1].get_mapping_to(i.children[1])),this.updateNodeMap(this.targetAddend,i),this.updateNodeMap(this.targetAddend.children[0],i.children[0]),this.updateNodeMap(this.targetAddend.children[1].get_mapping_to(i.children[1])),this.cleanup(d),"function"==typeof a&&a(this),this},v.prototype.add_action_handler(new a),new a}(),fa.prototype.move_actions.push(Wa.actions.AddSubNumbersAction),function(){var a=function(a){p.call(this,"SumCleanupAction","sum cleanup action"),a&&(this.actor=a.actor)};Wa.inherit(p,a),Wa.actions.SumCleanupAction=a,a.prototype.match=function(a){return a.is_group("sum")&&a.children.length<=1},a.prototype.doInPlace=function(a){this.initNodeMap();var b=this.getNewTreeNode(this.actor);if(0===b.children.length)Va.remove(b);else if(1===b.children.length){var c,d=b.children[0],e=this.actor.children[0];if(d.is_group("add"))c=d.children[1],this.updateNodeMap(e.children[0],c);else if(d.is_group("sub","addsub")){var f=d.is_group("addsub");if(d.children[1].is_group("product")){var g=d.children[1].children[0].children[1],h=g.parent;g.remove();var i=new Q(g,f);h.append(i),c=d.children[1]}else c=new Q(d.children[1],f);this.updateNodeMap(e.children[0],c.children[0])}this.updateNodeMap(e,c),this.updateNodeMap(e.parent,c),Va.replace(d.parent,c),c.parent&&c.parent.is_group("brackets")?x.handle(c.parent,!0):x.handle(c)}return"function"!=typeof a?this:void a(this)},u.prototype.cleanupAction=new a}(),Wa.actions.AssociateIntoFractionAction=function(){var a=function(a){p.call(this,"AssociateIntoFractionAction","associative property of multiplication--move into fraction"),this.priority=0,this.triggerType="tap",this.settings={},a&&(a.actor&&(a=this.getSettingsFromActor(a.actor)),this.triggerType="drag",this.nodes=a.nodes,this.target=a.target,this.settings.side=a.side,a.triggerType&&(this.triggerType=a.triggerType),a.margin&&(this.settings.margin=a.margin))};return Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(a){if(!this.matchStructure(a))return[];var b=this.findTargets(a),c=b.filter(function(a){return this.matchTarget(a)},this);return this.bindActions(a,c)},a.prototype.matchStructure=function(a){return 0!==a.length&&(!!Va.is_range(a)&&!!a[0].is_group("mul","div"))},a.prototype.findTargets=function(a){for(var b=a[0].get_parent(1),c=[],d=b.children[0];d.value!==a[0].value;)d=d.rs;for(;d!==a[0];)c.push(d),d=d.rs;for(d=b.children[b.children.length-1];d.value!==a[0].value;)d=d.ls;for(;d!==a[a.length-1];)c.push(d),d=d.ls;return c},a.prototype.matchTarget=function(a,b){return b?a.value===b.value&&a.get_child([1]).is_group("fraction"):a.get_child([1]).is_group("fraction")},a.prototype.bindActions=function(a,b){var c=[],d=a[0].get_root();return b.forEach(function(b){var e=b.get_child([1]).get_top(),f=e.length-1;e.forEach(function(b,e){c.push(this.createBoundAction(d,{nodes:a,target:b,side:"left-of",triggerType:"drag"})),e===f&&c.push(this.createBoundAction(d,{nodes:a,target:b,side:"right-of",triggerType:"drag"}))},this)},this),c},a.prototype.getSettingsFromActor=function(a){var b,c,d;if(a&&a.ls&&a.children[1]&&a.children[1].is_group("fraction"))b=a.children[1].children[0],c=[a.ls],d="left-of";else if(a&&a.ls&&a.ls.children[1]&&a.ls.children[1].is_group("fraction")){var e=a.ls.children[1],f=e.get_top();b=f[f.length-1],c=[a],d="right-of"}return{target:b,nodes:c,side:d}},a.prototype.match=function(a,b,c){if(1==arguments.length){var d=this.getSettingsFromActor(a);a=d.nodes,b=d.target,c=d.side}if(!a||0==a.length)return!1;if(!c)return!1;if(!b||!b.is_group("mul","div")||!b.parent.is_group("fraction"))return!1;var e=b.parent.parent.value;return!(!b.parent.parent||b.parent.parent.parent!==a[0].parent)&&(!!a.every(function(a){return a.is_group(e)&&a.children[1]!==b.parent})&&!!Va.is_range(a))},a.prototype.transform=function(a){this.addTouchedNodes(this.nodes),this.addTouchedNodes(this.target);var b=this.getNewTreeNode(this.nodes),c=this.getNewTreeNode(this.target),d=c.parent,e=d.children.indexOf(c);return"right-of"===this.settings.side&&e++,1===d.get_top().length&&1===E.get_value(d.get_child([0,1]))&&(d.get_child([0]).simplify=!0),Va.remove_range(b),b[0].is_group("div")&&b.forEach(function(a){a.invert()}),d.insert_range(e,b),this.cleanup_cascade(d.parent),"function"!=typeof a||void a(this)},K.prototype.add_action_handler(new a),new a}(),fa.prototype.move_actions.push(Wa.actions.AssociateIntoFractionAction),Wa.actions.AssociateOutOfFractionAction=function(){var a=function(a){p.call(this,"AssociateOutOfFractionAction","associative property of multiplication--move out of fraction"),this.priority=0,this.triggerType="drag",this.settings={},a&&(this.nodes=a.nodes,this.target=a.target,this.settings.side=Array.isArray(this.target)?"around":a.side,this.settings.target_is_left="left-of"===a.side,this.settings.margin="right-of"===a.side?{x1:.25,x2:-.25}:{x1:-.25,x2:.25})};return Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(a){if(0===a.length)return[];var b=a[0];return b.is_group("mul")&&b.parent.is_group("fraction")&&this.match(a,b.parent)?[this.bindAction(a,"left-of"),this.bindAction(a,"right-of")]:[]},a.prototype.bindAction=function(a,b){var c=a[0].get_root(),d=[];return this.fractionIsPartOfProduct(a)&&(d=this.getSiblingsOfFraction(a,b)),this.createBoundAction(c,{nodes:a,target:d.length>0?d:a[0].parent,side:b})},a.prototype.fractionIsPartOfProduct=function(a){var b=a[0].parent;return b.parent&&b.parent.is_group("mul")},a.prototype.getSiblingsOfFraction=function(a,b){var c=a[0].parent,d=c.parent,e=d.parent;return"left-of"===b?e.children.slice(0,e.children.indexOf(d)):e.children.slice(e.children.indexOf(d)+1)},a.prototype.match=function(a,b){return 0!==a.length&&((1!==a.length||1!==a[0].children[1].value)&&(!(!this.allNodesAreMuls(a)||!Va.is_range(a))&&(a[0]&&a[0].parent===b&&b.is_group("fraction"))))},a.prototype.allNodesAreMuls=function(a){for(var b=0;b<a.length;b++)if(!a[b].is_group("mul"))return!1;return!0},a.prototype.transform=function(a){var b=this.getNewTreeNode(this.nodes),c=this.settings.target_is_left;Va.remove_range(b);var d=b[0].parent,e=new J;return d.replace_with(e),e.append(new K(d)),e.insert_range(c?0:1,b),this.cleanup(d),this.cleanup(e.parent),"function"!=typeof a||void a(this)},new a}(),fa.prototype.move_actions.push(Wa.actions.AssociateOutOfFractionAction),Wa.actions.AssociateOutOfDenominatorAction=function(){var a=function(a){p.call(this,"AssociateOutOfDenominatorAction","associative property of division--move out of fraction denominator"),this.triggerType="drag",this.settings={},a&&(this.nodes=a.nodes,this.target=a.target,this.settings.side=a.side,this.settings.margin="right-of"===a.side?{x1:.25,x2:-.25}:{x1:-.25,x2:.25},a.margin&&(this.settings.margin=a.margin))};return Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(a){var b=this.matchSource(a);if(!b)return[];var c=this.getTargets(b);return this.bindActionForEachTarget(a,c,!0)},a.prototype.matchSource=function(a){if(!Va.is_range(a)||!a[0].is_group("div"))return!1;var b=a[0].parent;return(!J.is_fraction_with_identity_numerator(b)||a.length!==b.get_bottom().length)&&(!!b.is_group("fraction")&&{nodes:a,fraction:b})},a.prototype.getTargets=function(a){return[a.fraction]},a.prototype.transform=function(a){this.addTouchedNodes(this.nodes[0].parent);var b=this.getNewTreeNode(this.nodes),c=b[0].parent,d=this.getNewTreeNode(this.target);Va.remove_range(b),b.forEach(function(a){a.invert()});var e=this.groupNonFractionRanges(b),f=this.replaceTargetWithProductContainingTargetAndTerms(d,e,this.settings.side);return e.forEach(function(a){J.convert_to_reciprocal(a.children[1])}),this.cleanup(c),this.cleanup(f.parent),this.setNodesToReselectAfterAction(e),"function"!=typeof a?this:void a(this)},a.prototype.groupNonFractionRanges=function(a){if(1===a.length)return a;if(2===a.length&&a.some(function(a){return J.is_fraction(a.children[1])}))return a;for(var b=[],c=[],d=[],e=0;e<a.length;e++){var f=a[e];J.is_fraction(f.children[1])||E.is_equal_to(f.children[1],1,-1)?(d.length&&c.push(d),c.push([f]),d=[]):d.push(f)}d.length&&c.push(d);for(var e=0;e<c.length;e++){var g=c[e];if(g.length>1){var h=new K(new J);g.forEach(function(a){h.children[1].append(a)}),b.push(h)}else b.push(g[0])}return b},a.prototype.replaceTargetWithProductContainingTargetAndTerms=function(a,b,c){var d=new J,e=a.is_group("mul")?a.children[1]:a;return e.replace_with(d),d.append(new K(e)),b.forEach(function(a,b){"right-of"===c?d.append(a):d.insert(b,a)}),d},new a}(),fa.prototype.move_actions.push(Wa.actions.AssociateOutOfDenominatorAction),Wa.actions.AssociateIntoDenominatorAction=function(){var a=function(a){p.call(this,"AssociateIntoDenominatorAction","associative property of denominator--move into denominator"),this.priority=0,this.triggerType="drag",this.settings={},a&&(this.nodes=a.nodes,this.target=a.target,this.settings.side=a.side)};return Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(a){var b=this.matchSource(a);if(!b)return[];var c=this.getTargets(b);return this.bindActionsForEachTarget(a,c)},a.prototype.matchSource=function(a){if(!Va.is_range(a))return!1;var b=a[0].get_parent(1);return!(!b.is_group("fraction")||!b.get_parent(1).is_group("mul","div"))&&(!!a.every(function(a){return a.is_group("div")})&&{nodes:a,frac:b,op:b.get_parent(1),group:b.get_parent(2)})},a.prototype.getTargets=function(a){var b=a.group.children.filter(function(b){return b!==a.op&&b.is_group(a.op.value)});return b.map(function(a){return a.get_child([1])})},a.prototype.bindActionsForEachTarget=function(a,b){var c=[],d=a[0].get_root();return b.forEach(function(b){b.is_group("fraction")?c=c.concat(this.bindActionForEachTarget(a,b.get_bottom(),!0)):c.push(this.createBoundAction(d,{nodes:a,target:b,side:"inside"}))},this),c},a.prototype.transform=function(a){var b=this;this.nodes.map(this.addTouchedNodes.bind(b)),this.addTouchedNodes(this.target);var c=this.settings.side,d=this.getNewTreeNode(this.nodes),e=d[0].parent,f=this.getNewTreeNode(this.target);return Va.remove_range(d),this.insertDivsInNewLocation(d,f,c),this.cleanupSourceFraction(e),"function"!=typeof a?this:void a(this)},a.prototype.insertDivsInNewLocation=function(a,b,c){b.is_group("div")?this.insertDivRangeIntoDenominator(a,b,c):this.replaceTargetWithFractionContainingTargetAndDivs(a,b)},a.prototype.insertDivRangeIntoDenominator=function(a,b,c){var d=b.parent;d.insert_range(d.children.indexOf(b)+("left-of"===c?0:1),a)},a.prototype.replaceTargetWithFractionContainingTargetAndDivs=function(a,b){var c=(b.parent,new J);b.replace_with(c),c.append(new K(b)),a.forEach(function(a){c.append(a)})},a.prototype.cleanupSourceFraction=function(a){var b=a.parent,c=b.parent;this.cleanup(a);var d=this.cleanup(b);!d&&E.is_num(b.children[1])&&1===E.get_value(b.children[1])&&(b.remove(),this.cleanup(c))},new a}(),fa.prototype.move_actions.push(Wa.actions.AssociateIntoDenominatorAction),function(){var a=function(a){p.call(this,"AddSubBracketsAction","add or subtract a bracketed sum"),this.priority=4,this.triggerType="tap",a&&(this.actor=a.actor)};Wa.inherit(p,a),a.prototype.match=function(a){return!(!a.is_group("add")&&!a.is_group("sub"))&&(!!a.children[1].is_group("brackets")&&(a.children[1].children[1].is_group("sum")||x.is_optional(a.children[1])))},a.prototype.transform=function(a){var b=this.getNewTreeNode(this.actor),c=this.actor.children[0];this.addTouchedNodes(this.actor);var d=b.children[1],e=b.children[1].children[1];if(Va.replace(d,e),b.is_group("sub")&&e.is_group("sum")){b.invert();for(var f=[],g=0;g<e.children.length;g++)e.children[g].invert(),f.push(e.children[g].children[0]);this.updateNodeMap(c,f)}return this.cleanup(b),"function"!=typeof a?this:void a(this)},v.prototype.add_action_handler(new a)}(),function(){var a=function(a){p.call(this,"AddSubCleanUp","addsub cleanup action"),a&&(this.addsub=a.actor)};Wa.inherit(p,a),a.prototype.match=function(a){return a.is_group("add","sub")&&a.children[1].is_group("sum")},a.prototype.doInPlace=function(a){this.initNodeMap();var b=this.getNewTreeNode(this.addsub);if(b.is_group("add","sub")&&b.children[1].is_group("sum")){var c=b.is_group("sub"),d=b.parent,e=b.children[1],f=this.addsub.children[1];this.updateNodeMap(this.addsub,d),this.updateNodeMap(f,e.children);var g=Va.remove(b);if(c)for(var h=0;h<e.children.length;h++)e.children[h].invert();d.insert_range(g,e.children)}return"function"!=typeof a?this:void a(this)},v.prototype.cleanupAction=new a}(),Wa.actions.AddVariablesAction=function(){function a(a){return a.map(function(a){return a.to_ascii()}).join("")}function b(a){return a.is_group()&&a.commutative&&a.associative}function c(a){if(0===a.length)return"";var c=a.map(function(a){return a.to_ascii()}).join("");return 1===a.length?c:b(a[0])?c.substring(a[0].children[0].to_ascii().length):c}function d(a){if(0===a.length)return"";var c=a.map(function(a){return a.to_ascii()}).join("");return b(a[0])?c.substring(a[0].children[0].to_ascii().length):c}function e(a){return a.is_group("product")&&a.children[0].children[1].is_group("sign")?a.children[0].children[1].children[1].to_ascii()+a.children.slice(1).map(function(a){return a.to_ascii()}).join(""):""}function f(a){return a.length===a[0].parent.children.length}function g(a){return a.parent}function h(b){return function(d){return 0!==d.length&&(!!d[0].parent&&((!g(d[0].parent)||!f(d))&&(a(d)===b||c(d)===b)))}}function i(a){return function(b){return!!b.parent&&(!(!b.parent.is_group("add")&&!b.parent.is_group("sub"))&&(b.to_ascii()===a||e(b)===a))}}function j(a){var b=a.parent;return function(c){var d,e;try{if(Array.isArray(c)?(d=Va.get_parent(3,c[0]),e=Va.get_parent(2,c[0])):(d=Va.get_parent(2,c),e=Va.get_parent(1,c)),!b.is_group("sum")||!d.is_group("sum")||b!==d||e===a)return!1}catch(a){if("invalid path"===a)return!1;throw a}return!0}}function k(a){return function(a){if(!Array.isArray(a))return!0;var b=a[0].parent;if(b.children.length!==a.length+1)return!1;for(var c=0;c<b.children.length;c++){var d=b.children[c];if(a.indexOf(d)===-1&&!E.is_num(d.children[1]))return!1}return!0}}var l=function(a){p.call(this,"AddVariablesAction","add variables"),this.priority=1,this.triggerType="tap",this.settings={is_join_action:!0,delay:300,side:"inside",margin:{x:.1}},a&&("drag"===a.triggerType?(this.triggerType=a.triggerType,this.nodes=a.nodes,this.target=a.target):this.actor=a.actor)};return Wa.inherit(p,l),l.prototype.getAllAvailableActions=function(b){if(b.length>1)return[];var c=b[0];if(!c.is_group("add","sub"))return[];var e=c.parent,f=this.analyzeAddendStructure(c);if(f.range.length<1)return[];var g,l=this.prepareRangeForSearch(f.range);return l.length<1?[]:(g=Va.filterRange(h(a(l)),e),g=g.concat(Va.filter(i(d(l)),e)),g=g.filter(j(c)),g=g.filter(k(l)),this.bindActionForEachTarget(b,g))},l.prototype.match=function(b){if(!b.ls)return!1;var c=b;if(!c.is_group("add","sub"))return!1;var e=this.analyzeAddendStructure(c);if(e.range.length<1)return!1;var f,g=this.prepareRangeForSearch(e.range);return!(g.length<1)&&(f=Va.filterRange(h(a(g)),c.ls),f=f.concat(Va.filter(i(d(g)),c.ls)),1===f.length&&(f=f.filter(j(c)),f=f.filter(k(g)),1===f.length))},l.prototype.prepareRangeForSearch=function(a){return Array.isArray(a)?a:[new K(Va.clone(a))]},l.prototype.analyzeAddendStructure=function(a){var b=a.children[1];return L.is_var(b)||b.is_group("brackets")?{range:b,coefficientLocation:"none"}:b.is_group("product")?this.analyzeProductStructure(b):{range:[]}},l.prototype.analyzeProductStructure=function(a){var b,c=[a.children[0].children[1],a.children[a.children.length-1].children[1]];if(E.is_num(c[0])&&E.is_num(c[1]))return{range:[]};b=E.is_num(c[0])||E.is_num(c[1])?E.is_num(c[0])?"front":"back":"none";var d,e;"none"===b?(d=0,e=a.children.length):"front"===b?(d=1,e=a.children.length):(d=0,e=a.children.length-1);for(var f=[],g=d;g<e;g++){var h=a.children[g].children[1];if(!(L.is_var(h)||h.is_group("brackets")||h.is_group("sign")&&L.is_var(h.children[1])))return{range:[]};f.push(h.parent)}return{range:f,coefficientLocation:b}},l.prototype.bindActionForEachTarget=function(a,b){for(var c=[],d=a[0].get_root(),e=0;e<b.length;e++){var f={};f.triggerType="drag",f.nodes=a;var g=b[e];Array.isArray(g)?(f.target=g[0].parent.parent,f.range=g):f.target=g.parent,c.push(this.createBoundAction(d,f))}return c},l.prototype.transform=function(a){"drag"===this.triggerType?(this.sourceAddend=this.nodes[0],
this.targetAddend=this.target):(this.sourceAddend=this.actor,this.targetAddend=this.actor.ls),this.addTouchedNodes(this.sourceAddend),this.addTouchedNodes(this.targetAddend);var b=this.analyzeAddendStructure(this.sourceAddend),c=this.analyzeAddendStructure(this.targetAddend);b.addend=this.sourceAddend,c.addend=this.targetAddend;var d=this.getNewTreeNode(this.sourceAddend),e=this.getNewTreeNode(this.targetAddend),f=d.parent,g=d.children[1],h=e.children[1];"none"===b.coefficientLocation&&(g=this.reinterpretTermAsProductWithCoefficientOfOne(g)),"none"===c.coefficientLocation&&(h=this.reinterpretTermAsProductWithCoefficientOfOne(h)),0===e.parent.children.indexOf(e)&&"none"===c.coefficientLocation&&h.children[1].children[1].is_group("sign")&&this.absorbNegativeIntoAddend(e);var i=this.splitProduct(g),j=this.splitProduct(h),k=i.coefficient*(d.is_group("sub")?-1:1)+j.coefficient*(e.is_group("sub")?-1:1),l=K.prototype.createGroup();l.append(new K(new E(Math.abs(k)))),l.append_range(i.variables);var m=k<0?new v(l,"sub"):new v(l,"add"),n=e.remove();f.insert(n,m),d.remove();var o={parentOfSum:m.parent.parent,idxOfSum:m.parent.parent.children.indexOf(m.parent),resultingAddend:m,idxOfResultingAddend:m.parent.children.indexOf(m),resultingProduct:l};return 1===Math.abs(k)&&(l.children[0].simplify=!0),l.simplify=!0,this.mapOldStructureToNewStructure(b,o),this.mapOldStructureToNewStructure(c,o),this.cleanup_cascade(m.parent),"function"==typeof a&&a(this),!0},l.prototype.reinterpretTermAsProductWithCoefficientOfOne=function(a){if(a.is_group("product"))return a.insert(0,new K(new E(1))),a;var b=a.parent;a.remove();var c=K.prototype.createGroup();return c.append(new K(new E(1))),c.append(new K(a)),b.append(c),c},l.prototype.splitProduct=function(a){var b,c,d=this.findIndexOfCoefficient(a);return 0===d?(b=E.get_value(a.children[d].children[1]),c=Va.clone(a.children.slice(1))):(b=E.get_value(a.children[d].children[1]),c=Va.clone(a.children.slice(0,d))),{coefficient:b,variables:c}},l.prototype.findIndexOfCoefficient=function(a){for(var b=a.children,c=0;c<b.length;c++)if(E.is_num(b[c].children[1]))return c},l.prototype.absorbNegativeIntoAddend=function(a){var b=a.children[1].children[1].children[1],c=b.parent,d=b.remove(),e=b.children[1];e.remove(),c.insert(d,e),a.invert()},l.prototype.mapOldStructureToNewStructure=function(a,b){var c,d=b.parentOfSum.children[b.idxOfSum];if(c=d.is_group("sum")?d.children[b.idxOfResultingAddend]:d,E.is_num(c))this.updateNodeMap(a.addend.get_mapping_to(c));else{this.mapAddendGroup(a.addend,c);var e=this.mapNegatives(a.addend,a.coefficientLocation,c);this.mapCoefficients(a.addend,a.coefficientLocation,c),this.mapVariables(a.range,c,e)}},l.prototype.mapAddendGroup=function(a,b){b.is_group("add","sub")&&(this.updateNodeMap(a,b),this.updateNodeMap(a.children[0],b.children[0]))},l.prototype.mapNegatives=function(a,b,c){if(c.is_group("add","sub","sign","product")){var d,e;a.is_group("sub")&&(d=a.children[0]);var f,g="front"===b||"none"===b&&a.children[1].children[0]?a.children[1].children[0]:a.children[1].children[a.children[1].children.length-1];if(g&&g.children[1]&&g.children[1].is_group("sign")&&(e=g.children[1].children[0],f="none"===b),!(d&&e||!d&&!e)){if(c.is_group("sub")&&e)return void this.updateNodeMap(e,c.children[0]);if(c.is_group("sign"))return d&&this.updateNodeMap(d,c.children[0]),void(e&&this.updateNodeMap(e,c.children[0]));if(c.is_group("add")&&(c=c.children[1]),c.is_group("product")&&c.children[0].children[1].is_group("sign")){var h=c.children[0].children[1].children[0];return d&&this.updateNodeMap(d,h),e&&(this.updateNodeMap(e.parent,h.parent),this.updateNodeMap(e,h)),f}}}},l.prototype.mapCoefficients=function(a,b,c){var d,e,f,g;"none"!==b&&("front"===b?d=a.children[1].children[0]:"back"===b&&(d=a.children[1].children[a.children[1].children.length-1]),e=d.children[1],e.is_group("sign")&&(e=e.children[1]),c.is_group("add","sub")&&(c=c.children[1]),c.is_group("product")&&E.is_num(c.children[0].children[1])&&(f=c.children[0],g=c.children[0].children[1],g.is_group("sign")&&(g=g.children[1]),this.updateNodeMap(d,f),this.updateNodeMap(e,g)))},l.prototype.mapVariables=function(a,b,c){if(b.is_group("add","sub")&&(b=b.children[1]),b.is_group("product")){var d=E.is_num(b.children[0].children[1])?b.children.slice(1):b.children.slice();if(Array.isArray(a))for(var e=0;e<a.length;e++){var f=0===e&&c?a[e].children[1].children[1]:a[e].children[1],g=d[e].children[1].is_group("sign")?d[e].children[1].children[1]:d[e].children[1];this.updateNodeMap(a[e],d[e]),this.updateNodeMap(a[e].children[0],d[e].children[0]),this.updateNodeMap(f.get_mapping_to(g))}else{var g=d[0].children[1].is_group("sign")?d[0].children[1].children[1]:d[0].children[1];this.updateNodeMap(a.get_mapping_to(g))}}else{var f=Array.isArray(a)?a[0]:a;this.updateNodeMap(f.get_mapping_to(b.is_group("sign")?b.children[1]:b))}},l.prototype.reselectNodes=function(a){if(!a.parentOfSum.children[a.idxOfSum].is_group("sum"))if(a.parentOfSum.children[a.idxOfSum].is_group("add","sub"))this.setNodesToReselectAfterAction(a.parentOfSum.children[a.idxOfSum]);else{var b=a.resultingProduct.children;b[0].parent===a.resultingProduct?this.setNodesToReselectAfterAction(a.resultingProduct):this.setNodesToReselectAfterAction(b)}},v.prototype.add_action_handler(new l),new l}(),fa.prototype.move_actions.push(Wa.actions.AddVariablesAction),Wa.actions.AddSubTupleAction=function(){var a=function(a){p.call(this,"AddSubTupleAction","add or subtract tuples"),this.priority=1,this.triggerType="tap",this.settings={is_join_action:!0,delay:300,side:"inside",margin:{x:.1}},a&&(a.nodes?(this.triggerType="drag",this.nodes=a.nodes,this.target=a.target):this.actor=a.actor)};return Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(a){if(1!==a.length)return[];var b=a[0];if(!this.isTupleAddend(b))return[];var c=this.getOtherTupleAddendsInSum(b);return this.bindActionForEachTarget(a,c)},a.prototype.isTupleAddend=function(a,b){return a.is_group("add","sub")&&a.children[1].is_group("brackets")&&a.children[1].children[1].is_group("tuple")&&(!b||a.children[1].children[1].children.length===b)},a.prototype.getTupleAddendLen=function(a){return a.children[1].children[1].children.length},a.prototype.getOtherTupleAddendsInSum=function(a){var b=a.parent,c=a.children[1].children[1].children.length,d=b.children.filter(function(b){return b!==a&&this.isTupleAddend(b,c)},this);return d},a.prototype.match=function(a){return this.isTupleAddend(a)&&a.ls&&this.isTupleAddend(a.ls,this.getTupleAddendLen(a))},a.prototype.transform=function(a){var b,c;"drag"===this.triggerType?(b=this.nodes[0],c=this.target):(b=this.actor.ls,c=this.actor),this.addTouchedNodes(b),this.addTouchedNodes(c);var d=b.get_idx()<c.get_idx(),e=this.getNewTreeNode(b),f=this.getNewTreeNode(c),g=e.parent,h=e.children[1].children[1].children.length,i=f.remove();e.remove();var j=new R,k=new v(j);g.insert(i,k);for(var l=0;l<h;l++){var m=new u;m.simplify=!0;var n=new O(m);j.append(n),this.updateNodeMap(e.get_child([1,1,l]),n),this.updateNodeMap(f.get_child([1,1,l]),n),m.append(new v(e.get_child([1,1,l,1]),e.value)),m.insert(d?1:0,new v(f.get_child([1,1,l,1]),f.value)),this.applyInnerAction("AddSubCombineSigns",{actor:m.children[0]}),this.applyInnerAction("AddSubCombineSigns",{actor:m.children[1]}),this.cleanup(m.children[1]),this.cleanup(m.children[0])}return this.updateNodeMap(b,k),this.updateNodeMap(b.get_child([1]),k.get_child([1])),this.updateNodeMap(b.get_child([1,0]),k.get_child([1,0])),this.updateNodeMap(b.get_child([1,1]),k.get_child([1,1])),this.updateNodeMap(b.get_child([1,2]),k.get_child([1,2])),this.updateNodeMap(c,k),this.updateNodeMap(c.get_child([1]),k.get_child([1])),this.updateNodeMap(c.get_child([1,0]),k.get_child([1,0])),this.updateNodeMap(c.get_child([1,1]),k.get_child([1,1])),this.updateNodeMap(c.get_child([1,2]),k.get_child([1,2])),this.cleanup(g),"function"==typeof a&&a(this),this},v.prototype.add_action_handler(new a),new a}(),fa.prototype.move_actions.push(Wa.actions.AddSubTupleAction),Wa.actions.AddSubLogarithmsAction=function(){var a=function(a){p.call(this,"AddSubLogarithmsAction","add or subtract numbers"),this.priority=1,this.triggerType="tap",this.settings={target_group:!0,group_side:"around",delay:300,reset_y:!0},a&&(a.nodes?(this.triggerType="drag",this.nodes=a.nodes,this.target=a.target,this.settings.side=a.side):this.actor=a.actor)};return Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(a){var b=this.matchSource(a);if(!b)return[];var c=this.getTargets(b);return this.bindActionsForEachTarget(a,c)},a.prototype.matchSource=function(a){if(1!==a.length)return!1;var b=a[0];if(!b.is_group("add","sub"))return!1;var c=b.children[1];return!!N.Logs.is_log_func(c)&&{nodes:a,base:N.Logs.get_log_base(c),group:b.parent}},a.prototype.getTargets=function(a){var b=a.base.to_ascii(),c=a.group.children.filter(function(c){return c!==a.nodes[0]&&N.Logs.is_log_func(c.children[1])&&N.Logs.get_log_base(c.children[1]).to_ascii()===b},this);return c},a.prototype.bindActionsForEachTarget=function(a,b){var c=[];return b.forEach(function(b){var d=b.children[1].children[1];c=c.concat(this.bindActionForEachTarget(a,[d],!0))},this),c},a.prototype.match=function(a){if(!a.is_group("add","sub"))return!1;if(!a.ls)return!1;var b=a.ls.children[1],c=a.children[1];return N.Logs.is_log_func(b)&&N.Logs.is_log_func(c)&&N.Logs.get_log_base(b).to_ascii()==N.Logs.get_log_base(c).to_ascii()},a.prototype.transform=function(a){var b=this.getSourceAndTarget();this.addTouchedNodes(b.source),this.addTouchedNodes(b.target);for(var c=this.getNewTreeNode(b.source),d=this.getNewTreeNode(b.target),e=c.parent;!d.is_group("add","sub");)d=d.parent;c.remove();var f=c.children[1],g=d.children[1],h=f.get_arg(),i=g.get_arg(),j=i.parent,k=i.remove(),l=new J,m=new K(i,d.is_group("sub")?"div":"mul"),n=new K(h,c.is_group("sub")?"div":"mul");return l.append(m),l.insert("left-of"===this.settings.side?0:1,n,!0),j.insert(k,l),x.handle(g.children[1]),d.is_group("sub")&&d.invert(),b.source.map_group_and_sym(this,d,!0),b.source.children[1].map_to_func(this,g,!0),this.setNodesToReselectAfterAction(h.is_group("product")?h.children.slice():n),this.cleanup(m),this.cleanup(n),this.cleanup(e),"function"==typeof a&&a(this),this},v.prototype.add_action_handler(new a),new a}(),fa.prototype.move_actions.push(Wa.actions.AddSubLogarithmsAction),Wa.actions.AddSubCombineSigns=function(){var a=function(a){p.call(this,"AddSubCombineSigns","combine signs in a sum"),this.triggerType="tap",this.priority=4,a&&(this.actor=a.actor)};return Wa.inherit(p,a),a.prototype.match=function(a){return!!this.getInnerTerm(a)},a.prototype.getInnerTerm=function(a){return a.is_group("add","sub","addsub")?a.children[1].is_group("sign","plusminus")?a.children[1]:a.children[1].is_group("product")&&a.get_child([1,0,1]).is_group("sign","plusminus")?a.get_child([1,0,1]):null:null},a.prototype.rematch=function(){return this.actor.is_group("add","sub","addsub")},a.prototype.transform=function(a){var b=this.getNewTreeNode(this.actor),c=this.getInnerTerm(b),d=!1;if(c){var e=this.getOldTreeNode(c);c.is_group("plusminus")?b.setValue("addsub"):c.is_group("sign")&&b.invert(),this.updateNodeMap(e,b),this.updateNodeMap(e.children[0],b.children[0]),c.replace_with(c.children[1]),d=!0}return"function"!=typeof a?d:void a(this)},v.prototype.add_action_handler(new a),new a}(),Wa.actions.ConvertAddendToFractionAction=function(){var a=function(a){p.call(this,"ConvertAddendToFractionAction","convert addend to a fraction to allow adding"),this.priority=1,this.triggerType="dbltap",a&&(this.actor=a.actor)};return Wa.inherit(p,a),a.prototype.match=function(a){if(!a)return!1;if(!a.is_group("add","sub"))return!1;if(!a.ls)return!1;var b=a.ls.children[1],c=a.children[1];return b.is_group("fraction")&&!c.is_group("fraction")||!b.is_group("fraction")&&c.is_group("fraction")},a.prototype.transform=function(a){this.addTouchedNodes(this.actor),this.addTouchedNodes(this.actor.ls);var b=this.getNewTreeNode(this.actor.ls),c=this.getNewTreeNode(this.actor),d=((b.children[1].is_group("fraction")?b:c).children[1],(b.children[1].is_group("fraction")?c:b).children[1]),e=d.parent;d.remove();var f=K.prototype.createGroup();return f.append(new K(d)),f.append(new K(new E(1),"div")),e.append(f),f.get_bottom()[0].simplify=!0,this.cleanup(f.get_top()[0]),this.followup=Wa.actions.CrossMultiplyFractionsAction.createBoundAction(this.newTree,{actor:c}),"function"!=typeof a||void a(this)},v.prototype.add_action_handler(new a),new a}(),Wa.actions.AddSubInvertAction=function(){var a=function(a){p.call(this,"AddSubInvertAction","invert addends across an equality or inequality"),this.priority=0,this.triggerType="drag",this.settings={side:"around",extend_extreme_target_boxes:!0},a&&(this.nodes=a.nodes,this.target=a.target)};return Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(a){var b=this.matchSource(a);if(!b)return[];var c=this.getTargets(b);return this.bindActionForEachTarget(a,c)},a.prototype.matchSource=function(a){return!!Va.is_range(a)&&(a[0].is_group("add","sub","addsub")&&a[0].parent.parent.is_group("equals","lte","gte","lt","gt")?{nodes:a,side:a[0].parent.get_idx(),eq:a[0].get_parent(2)}:!!a[0].parent.is_group("equals","lte","gte","lt","gt")&&{nodes:a,side:a[0].get_idx(),eq:a[0].parent})},a.prototype.getTargets=function(a){return[a.eq.get_child([a.side?0:2])]},a.prototype.adjustTargets=function(a){return a.forEach(function(a){var b=a.target;b.is_group("sign")&&(a.target=b.get_child([1]))},this),a},a.prototype.transform=function(a){this.addTouchedNodes(this.nodes),this.addTouchedNodes(this.target);var b=this.getNewTreeNode(this.nodes),c=this.target,d=this.getNewTreeNode(c),e=this.matchSource(b);Va.remove_range(b),b[0].parent.is_group("sum")||e.eq.insert(e.side,new E(0)),b[0].is_group("sum")&&(b=b[0].children.slice());var f,g,h;if(d.is_group("sum")?f=d:(f=new u,e.eq.insert(d.remove(),f),g=f.append(new v(d)),this.applyInnerAction("AddSubCombineSigns",{actor:g})),b[0].is_group("add","sub","addsub"))h=f.append_range(b),b.forEach(function(a){a.invert()});else{if(1!==b.length)throw"math transform error";h=f.append(new v(b[0],"sub")),this.applyInnerAction("AddSubCombineSigns",{actor:h})}return 0===E.get_value(d)&&(d.parent.simplify=!0),this.cleanup(f.get_child([0])),this.cleanup(e.eq.children[e.side]),"function"==typeof a&&a(this),this},new a}(),fa.prototype.move_actions.push(Wa.actions.AddSubInvertAction),Wa.actions.RemoveBracketsAction=function(){var a=function(a){p.call(this,"RemoveBracketsAction","remove optional brackets"),this.priority=4,this.triggerType="tap",a&&(this.actor=a.actor)};Wa.inherit(p,a),a.prototype.match=function(a){return a.is_group("brackets")&&x.is_optional(a)},a.prototype.transform=function(a){var b=this.getNewTreeNode(this.actor);this.addTouchedNodes(this.actor.children[0]),this.addTouchedNodes(this.actor.children[2]);var c=Va.replace(b,b.children[1]);return this.cleanup(c.parent),"function"!=typeof a||void a(this)};var b=new a;return x.prototype.add_action_handler(b),b}(),Wa.actions.editLineAction=function(){var a=function(a){p.call(this,"editLineAction","rewrite dl line"),this.priority=0,a&&(this.actor=a.actor)};return Wa.inherit(p,a),a.prototype.match=function(){return"undefined"!=typeof Keyboard&&null!==Keyboard},a.prototype.removeAllNodesFromNodeMap=function(){this.newTree.select_all();for(var a in this.node_map)this.node_map[a]=[]},a.prototype.transform=function(a){function b(b){var c=e.newTree,f=c.parse(b,!0);f&&(c.children[0].remove(),c.append(f),d.visible(!1),d.on("done",null).on("cancel",null),e.removeAllNodesFromNodeMap(),a(e))}function c(){console.log("cancelled"),d.visible(!1),d.on("done",null).on("cancel",null),a(!1)}var d=Keyboard();d.caption("What do you want to change in this line?").on("done",b).on("cancel",c)();var e=this;d.latex(e.newTree.to_latex()).visible(!0)},new a}(),Wa.actions.DistributePolynomials=function(){var a=function(a){p.call(this,"DistributePolynomials","multiply two sums"),this.priority=1,this.triggerType="dbltap",a&&(this.actor=a.actor)};return Wa.inherit(p,a),a.prototype.match=function(a){return!!a.ls&&(!!(a.is_group("mul")&&a.ls.is_group("mul")||a.is_group("div")&&a.ls.is_group("div"))&&(a.ls.children[1].is_group("brackets")||a.children[1].is_group("brackets")))},a.prototype.transform=function(a){var b=this,c=this.getSourceAndTarget(),d=this.getNewTreeNode(c.source),e=this.getNewTreeNode(c.target);this.addTouchedNodes(d),this.addTouchedNodes(e);var f=e.children[1].is_group("brackets")?e.children[1].children[1]:e.children[1],g=d.children[1].is_group("brackets")?d.children[1].children[1]:d.children[1],h=f.is_group("sum")?f.children:[f],i=g.is_group("sum")?g.children:[g],j=this.getFoilPairs(h,i),k=new u;return j.forEach(function(a){var c=b.getFactors(a.term1).concat(b.getFactors(a.term2)),d=ha(c,a.is_neg,b);k.append(new v(d))}),d.remove(),e.children[1].remove(),e.append(k),k.children.forEach(function(a){return b.applyInnerAction("AddSubCombineSigns",{actor:a})}),x.handle(k),k.children.forEach(function(a){var c=a.children[1];if(c.is_group("product","fraction"))for(var d=c.children.length-1;d>=0;d--)b.cleanup(c.children[d])}),this.cleanup(k),this.cleanup_cascade(e.parent),"function"==typeof a&&a(this),this},a.prototype.getFoilPairs=function(a,b){var c=[];return a.forEach(function(a){b.forEach(function(b){c.push({is_neg:a.is_group("sign","sub")!==b.is_group("sign","sub"),term1:a.is_group("sign","sub","add")?a.children[1].clone():a.clone(),term2:b.is_group("sign","sub","add")?b.children[1].clone():b.clone()})})}),c},a.prototype.getFactors=function(a){return a.is_group("product")?a.children.map(function(a){return a.children[1]}):[a]},K.prototype.add_action_handler(new a),new a}(),Wa.actions.CommuteAction=function(){var a=function(a){p.call(this,"CommuteAction","commute terms"),this.priority=2,this.triggerType="drag",this.settings={margin:{y:-1},extend_extreme_target_boxes:!0},a&&(this.nodes=a.nodes,this.target=a.target,this.settings.side=a.side)};return Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(a){if(0===a.length)return[];var b,c=a[0].get_root(),d=[],e=a[0].parent.is_group("flat");if(e)return[];if(!a[0].commutative||!Va.is_range(a))return[];for(b=a[0].ls;b&&"//"!==b.value;b=b.ls)this.match(a,b,"left-of")&&d.push(this.createBoundAction(c,{nodes:a,target:b,side:"left-of"}));for(b=a[a.length-1].rs;b&&"//"!==b.value;b=b.rs)this.match(a,b,"right-of")&&d.push(this.createBoundAction(c,{nodes:a,target:b,side:"right-of"}));return this.adjustTargetBoxes(d)},a.prototype.match=function(a,b,c){return b.parent===a[0].parent&&(!!a[0].commutative&&(("left-of"!==c||b.ls!==a[a.length-1])&&("right-of"!==c||b.rs!==a[0])))},a.prototype.adjustTargetBoxes=function(a){return a.forEach(function(a){a.target.get_parent(1).is_group("fraction")&&(a.target.is_group("mul")?a.settings.margin={y1:-1,y2:.1}:a.settings.margin={y1:.1,y2:-1})}),a},a.prototype.transform=function(a){var b=this.getNewTreeNode(this.nodes),c=this.getNewTreeNode(this.target),d=this.settings.side,e=c.parent,f=e.children.indexOf(c);if(1===b.length)b[0].remove(),e.insert(f,b[0]);else{"right-of"===d&&f++;var g=Va.remove_range(b);e.insert_range(g<f?f-b.length:f,b)}return"function"!=typeof a||void a(this)},new a}(),fa.prototype.move_actions.push(Wa.actions.CommuteAction),Wa.actions.EqInvertAndCommuteTermAction=function(){var a=function(a){p.call(this,"EqInvertAndCommuteTermAction","composed action of inverting terms across an equation and commuting"),this.priority=0,this.triggerType="drag",this.settings={margin:{y:-1},extend_extreme_target_boxes:!0},a&&(this.nodes=a.nodes,this.target=a.target,this.settings.side=a.side)};return Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(a){var b=a[0].get_root(),c=this.getAndPerformAvailableInversionActionOnClone(b,a);if(!c)return[];var d=this.getAvailableCommuteActionsOnInversionResult(c);if(0===d.length)return[];var e=this.unmapToGetTargets(b,c,d).sort(function(a,b){return a.get_idx()-b.get_idx()});return this.adjustTargets(this.bindActionForEachTarget(a,e,!0))},a.prototype.getAndPerformAvailableInversionActionOnClone=function(a,b){var c=a.clone(),d=[];b.forEach(function(a){d.push(c.get_child(a.get_path()))});var e=Wa.actions.AddSubInvertAction.getAllAvailableActions(d);if(0===e.length&&(e=Wa.actions.MulDivInvertAction.getAllAvailableActions(d)),0===e.length)return!1;var f=e[0];return c.performAction(f,null,!1,!0),f.newTree!==f.oldTree&&f},a.prototype.getAvailableCommuteActionsOnInversionResult=function(a){var b=[],c=a.nodes;1===c.length&&c[0].is_group("sum")&&(c=c[0].children.slice());for(var d=0;d<c.length;d++){var e=c[d],f=this.getTheNodesOnTheSameSideAsTheTarget(a.mapNodes(e),a.target);b.push(this.getCommutativeTermFromNode(f)[0])}return Wa.actions.CommuteAction.getAllAvailableActions(b)},a.prototype.getTheNodesOnTheSameSideAsTheTarget=function(a,b){var c=[],d=b.get_path()[1];return a.forEach(function(a){a.get_path()[1]===d&&c.push(a)}),c},a.prototype.unmapToGetTargets=function(a,b,c){var d=[];c.forEach(function(a){d.push(a.target)});var e=this,f=[];d.forEach(function(a){f.push(e.getCommuteTargetBeforeInversion(a,b))});var g=[];return f.forEach(function(b){g.push(a.get_child(b.get_path()))}),g},a.prototype.getCommuteTargetBeforeInversion=function(a,b){var c=b.unmapNodes(a);if(1===c.length)return c[0];if(a.is_group("mul")&&a.children[1].is_group("brackets")&&a.children[1].children[1].is_group("sum")){var d=a.children[1];if(c=b.unmapNodes(d),0!==c.length)return c[0];var e=d.children[1];return c=b.unmapNodes(e),c[0]}if(a.is_group("add","sub","mul")){var f=a.children[1];return b.unmapNodes(f)[0]}},a.prototype.getCommutativeTermFromNode=function(a){if(1!==a.length)throw"What's happening here?";return a[0].parent.commutative?[a[0].parent]:a[0].is_group("sum")&&a[0].parent.is_group("brackets")&&a[0].parent.parent&&a[0].parent.parent.commutative?[a[0].parent.parent]:a},a.prototype.adjustTargets=function(a){for(var b=0;b<a.length;b++){var c=a[b];(!c.target.ls&&"left-of"===c.side||(!c.target.rs||c.target.rs instanceof t)&&"right-of"===c.side)&&c.target.parent.is_group("fraction")&&(c.target=c.target.parent)}return a},a.prototype.doInPlace=function(a){this.initNodeMap();var b=this.settings.side;if(this.target.is_group("fraction")&&this.nodes[0].is_group("div")){var c=this.target.get_top();this.target="left-of"===b?c[0]:c[c.length-1]}var d=this;this.nodes.forEach(function(a){d.addTouchedNodes(a)});var e,f=this.getNewTreeNode(this.nodes),g=this.getNewTreeNode(this.target);e=f[0].is_group("mul","div")?Wa.actions.MulDivInvertAction.getAllAvailableActions(f)[0]:Wa.actions.AddSubInvertAction.getAllAvailableActions(f)[0],e.doInPlace(),this.compose(e);var h=this.getTheNodesOnTheSameSideAsTheTarget(e.mapNodes(1===f.length&&f[0].is_group("sum")?f[0].children.slice():f),e.mapNodes(g)[0]),g=e.mapNodes(g);1===h.length&&(h=this.getCommutativeTermFromNode(h)),g=this.getCommutativeTermFromNode(g)[0];var i,j=Wa.actions.CommuteAction.getAllAvailableActions(h);if("right-of"!==b||this.target.rs)for(var k=0;k<j.length;k++){var l=j[k];if("right-of"===b&&"left-of"===l.settings.side&&g.rs===l.target){i=l,l.doInPlace(),this.compose(l);break}if("left-of"===b&&g===l.target){i=l,l.doInPlace(),this.compose(l);break}}return this.setNodesToReselectAfterAction(i?this.getTheNodesOnTheSameSideAsTheTarget(i.mapNodes(h),g):this.getTheNodesOnTheSameSideAsTheTarget(h,g)),this.removeDeletedNodesFromNodeMap(),"function"!=typeof a||void a(this)},new a}(),fa.prototype.move_actions.push(Wa.actions.EqInvertAndCommuteTermAction),fa.prototype.hideNodesAction=function(){var a=function(a){p.call(this,"HideNodesAction","apply hide rules")};return Wa.inherit(p,a),a.prototype.doInPlace=function(b,c){var d=!1;if(b.children.length>0){var e=function(c){var e=c.hidden,f=c.hide_afer_drop;if(c.hidden=!1,c.hide_after_drop=!1,b.options.hide_leading_op&&c instanceof t&&c.parent&&c.parent.commutative&&(c.parent.associative&&!c.parent.ls||"div"==c.parent.value&&c.parent.ls&&"//"==c.parent.ls.value)&&(c.parent.dragging?c.hide_after_drop=!0:c.hidden=!0),c instanceof t&&c.parent.is_group("fraction")&&J.is_lone_fraction_part(c)&&(c.hidden=!0),("("===c.value||")"===c.value)&&!a.bracketsAreEssentialElementsToExpressionType(c.parent)){var g=c.parent;if(g.parent.vertical_notation||g.parent.parent&&g.parent.parent.vertical_notation){for(var h=g;h.is_group("brackets");)h=h.children[1];!x.is_optional(h,g.parent)&&a.isLoneMulDivInNumeratorOrDenominator(g.parent)&&(c.parent.dragging?c.hide_after_drop=!0:c.hidden=!0)}}for(var i=0;i<b.hide_rules.length&&!c.hidden;i++){var j=b.hide_rules[i];j.disabled||j.apply(c)}d=d||c.hidden!=e||c.hide_after_drop!=f};b.children[0].for_each(e)}return"function"!=typeof c?d:void c(this)},a.isLoneMulDivInNumeratorOrDenominator=function(a){return!(a.ls&&a.ls.is_group(a.value)||a.rs&&a.rs.is_group(a.value))},a.bracketsAreEssentialElementsToExpressionType=function(a){return a.is_group("brackets")&&a.children[1].is_group("tuple")},new a}(),Wa.actions.SwitchAction=function(){var a=function(a){p.call(this,"SwitchAction","switch terms in a flat representation"),this.priority=0,this.triggerType="drag",this.settings={side:"around"},a&&(this.node=a.node,this.target=a.target)};return Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(a){if(0===a.length)return[];var b,c=a[0].get_root(),d=[],e=a[0].parent.is_group("flat");if(!e)return[];if(!a[0].commutative||!Va.is_range(a))return[];for(b=a[0].ls;b&&"//"!==b.value;b=b.ls)this.match(a[0],b)&&d.push(this.createBoundAction(c,{node:a[0],target:b}));for(b=a[a.length-1].rs;b&&"//"!==b.value;b=b.rs)this.match(a[0],b)&&d.push(this.createBoundAction(c,{node:a[0],target:b}))},a.prototype.match=function(a,b){return!(a.parent!==b.parent||a===b||b instanceof t||a instanceof t)},a.prototype.transform=function(a){var b=tree===this.target.get_root(),c=b?this.node:tree.get_child(this.node.get_path()),d=b?this.target:tree.get_child(this.target.get_path());return Va.switch_siblings(c,d),"function"!=typeof a||void a(this)},new a}(),fa.prototype.move_actions.push(Wa.actions.SwitchAction),Wa.actions.flipEquationAction=function(){var a=function(a){p.call(this,"flipEquationAction","flip equation"),this.priority=1,this.triggerType="tap",a&&(this.actor=a.actor)};Wa.inherit(p,a),a.prototype.match=function(a){return a.is_group("equals")||G.is_inequality(a)},a.prototype.transform=function(a){var d=this.getNewTreeNode(this.actor);this.addTouchedNodes(b(this.actor)),this.addTouchedNodes(c(this.actor));var e=b(d),f=c(d);e.remove(),f.remove();var g=0,h=2;return d.insert(g,f),d.insert(h,e),G.is_inequality(d)&&d.invert(),"function"==typeof a&&a(this),this},H.prototype.add_action_handler(new a),G.prototype.add_action_handler(new a);var b=function(a){return a.children[0]},c=function(a){return a.children[2]};return new a}(),Wa.actions.RewriteExpressionWithKeyboardAction=function(){function a(a){return a.map(function(a){return a.to_ascii()}).join("")}var b=function(a){p.call(this,"RewriteExpressionWithKeyboardAction","replace an expression with an equivalent one"),this.priority=0,this.triggerType="drag",this.settings={side:"shake",asynchronous:!0},this.latex=null,this.original_node_state=null,a&&(this.nodes=a.nodes)};return Wa.inherit(p,b),b.prototype.toJSON=function(){var a=p.prototype.toJSON.call(this);return this.latex&&(a.latex=this.latex),this.original_node_state&&(a.original_node_state=this.original_node_state),a},b.prototype.rematch=function(){if(!(this.nodes&&this.nodes.length>0))return!1;if(this.getAllAvailableActions){var b=this.getAllAvailableActions(this.nodes);return b.every(function(b){return a(b.nodes)===this.original_node_state},this)}},b.prototype.match=function(a){return Wa.ui&&Wa.ui.Keyboard},b.prototype.getAllAvailableActions=function(a){return Wa.ui&&Wa.ui.Keyboard?[this.createBoundAction(a[0].get_root(),{nodes:a})]:[]},b.prototype.adjustTarget=function(a){return 1===a.length&&a[0].is_group("exponent","degree")?[a[0].children[0]]:1===a.length&&a[0].is_group("mul","div")?[a[0].children[1]]:a},b.prototype.transform=function(b){function c(a){a=a.replace(/\\quad/g,"");var b=a.split("\\rightarrow");return b.length>1?b[b.length-1]:b[0]}function d(a){var b=!1;try{this.newTree.parse(a,!0),b=!0}catch(a){console.log(a),r.warning("Could not parse expression.")}return b}function e(a){var b=new fa(a).get_child([0]);return b.remove(),b}function f(a,b){var c=Wa.termsToAlgebriteString;if(1===a.length&&E.is_num(a[0])&&fa.evalExpression(b)===E.get_value(a[0]))return!0;if(Ua){if(b.is_group("equals")||a[0].is_group("equals")){if(!b.is_group("equals")||1!==a.length||!a[0].is_group("equals"))return!1;a=a[0];var d=Ua.simplify(c(b.children[0])),e=Ua.simplify(c(b.children[2])),f=Ua.simplify(c(a.children[0])),g=Ua.simplify(c(a.children[2]));return Ua.equal(d,f)&&Ua.equal(e,g)||Ua.equal(d,g)&&Ua.equal(e,f)}var h=Ua.simplify(c(b)),i=Ua.simplify(c(l));return Ua.equal(i,h)}return!1}function g(a,b,c){var d=b[0].get_parent(1),e=Va.remove_range(b);1===b.length&&b[0].is_group("add","sub")?c=b[0].is_group("add")&&c.is_group("sign")?new v(c.children[1],"sub"):b[0].is_group("sub")&&c.is_group("sign")?new v(c.children[1],"sub"):new v(c):b[0].is_group("mul","div")?c=new K(c,b[0].value):b[0].is_group("add","sub")&&(c=new v(c)),d.insert(e,c),x.handle(c),this.cleanup(c),this.cleanup_cascade(d),a.forEach(function(a){a.for_each(function(a){this.updateNodeMap(a,[])}.bind(this))},this)}function h(){r.visible(!1),r.on("done.rewrite-expression",null).on("cancel.rewrite-expression",null)}function i(a){this.latex=a;var i=c(a);if(d.call(this,i)){var j=e(i);if(o)g.call(this,m,l,j);else{if(!f(l,j))return r.warning("Equivalence with the existing expression could not be ensured. Click done or press enter to replace it anyway."),void(o=!0);g.call(this,m,l,j)}return h(),"function"!=typeof b||void b(this)}}function j(){o=!1,r.caption(p)}function k(){h(),b(!1)}var l=this.adjustTarget(this.getNewTreeNode(this.nodes)),m=this.getOldTreeNode(l);if(this.latex){var n=e(c(this.latex));return g.call(this,m,l,n),"function"==typeof b&&b(this),this}this.original_node_state=a(this.nodes);var o=!1,p="Enter an expression to replace the selected expression.",q=l.map(function(a){return a.to_latex()}).join("");q.startsWith("\\cdot ")&&!l[0].is_group("product")&&(q=q.replace("\\cdot ",""));var r=Wa.ui.Keyboard();console.log(q),r.caption(p).on("done.rewrite-expression",i.bind(this)).on("change.rewrite-expression",j.bind(this)).on("cancel.rewrite-expression",k).visible(!0).latex(q)},new b}(),fa.prototype.move_actions.push(Wa.actions.RewriteExpressionWithKeyboardAction),Wa.actions.EquationFountain=function(){var a=function(a){p.call(this,"EquationFountain","rewrite equation"),this.priority=1,this.triggerType="hold",this.settings={asynchronous:!0},this.latex=null,a&&(this.actor=a.actor)};return Wa.inherit(p,a),a.prototype.toJSON=function(){var a=p.prototype.toJSON.call(this);return this.latex&&(a.latex=this.latex),a},a.prototype.match=function(a){return!(!Wa.ui||!Wa.ui.Keyboard)&&a.is_group("equals")},a.prototype.transform=function(a){function b(b){this.latex=b;var c;try{c=new fa(b).children[0]}catch(a){return console.log(a),void f.warning("Could not parse expression.")}return fa.getNodes("E",0,c)?(this.replaceSideWithInput(d.children[0],c),this.replaceSideWithInput(d.children[2],c),f.visible(!1),f.on("done.eq-fountain",null).on("cancel.eq-fountain",null),"function"==typeof a&&a(this),this):void f.warning('There needs to be an "E" in the expression.')}function c(){return console.log("cancelled"),f.visible(!1),f.on("done.eq-fountain",null).on("cancel.eq-fountain",null),"function"==typeof a&&a(!1),!1}var d=this.getNewTreeNode(this.actor);if(this.latex){var e=new fa(this.latex).children[0];return this.replaceSideWithInput(d.children[0],e),this.replaceSideWithInput(d.children[2],e),"function"==typeof a&&a(this),this}var f=Wa.ui.Keyboard();f.caption("Enter an operation to apply to both sides of the equation.").latex("E").on("done.eq-fountain",b.bind(this)).on("cancel.eq-fountain",c).visible(!0);
},a.prototype.replaceSideWithInput=function(a,b){var c=b.clone(),d=fa.getNodes("E",0,c);Va.replace(a,c),a.parent=null,d.is_group("tuple")&&(d=d.get_child([0,1])),Va.replace(d,a),x.handle(a),this.cleanup(a.parent)},H.prototype.add_action_handler(new a),new a}(),Wa.actions.EquationCombineAction=function(){var a=function(a){p.call(this,"EquationCombineAction","combine equations"),this.settings={asyncronous:!0,side:"below",margin:{y1:.2,y2:-1},layout_hint:"new-line"},a&&(this.nodes=a.nodes,this.target=a.target),this.new_derivation=!0};return Wa.inherit(p,a),a.prototype.toJSON=function(){var a=p.prototype.toJSON.call(this);return this.latex&&(a.latex=this.latex),a},a.prototype.rebind=function(a,b,c){if(this.nodes[0]===c)this.nodes[0]=a;else{if(this.oldTree!==c)throw"wrong old tree during rebinding an action!";var d=new p;d.node_map=b,this.oldTree=a,this.target=d.mapNodes(this.target)[0],this.new_derivation=!this.target.is_group("equals")}},a.prototype.rematch=function(){if(!(this.nodes&&this.nodes.length>0&&this.target))return!1;var a=this.getAllAvailableActions(this.nodes[0],this.target);return this.target===a[0].target},a.prototype.getAllAvailableActions=function(a,b){return a.children[0].is_group("equals")&&!b.is_group("equals")?[]:[this.createBoundAction(b.parent,{nodes:[a],target:b})]},a.prototype.transform=function(a){function b(b){this.latex=b;try{var c=this.newTree.parse(b,!0)}catch(a){return console.log(a),void g.warning("Could not parse expression.")}if(d.is_group("equals")){this.combineEquations(c,d,e);for(var f=d.children[0].children,h=d.children[2].children,i=f.length-1;i>=0;i--)this.cleanup(f[i]);for(var j=h.length-1;j>=0;j--)this.cleanup(h[j])}else{this.combineExpressions(c,d,e);for(var k=d.children.length-1;k>=0;k--)this.cleanup(d.children[k])}this.endKeyboardInteraction(g),a(this)}function c(){this.endKeyboardInteraction(g),a(!1)}var d=this.getNewTreeNode(this.target),e=this.nodes[0].children[0].clone();if(this.new_derivation=!this.target.is_group("equals"),this.latex){var f=this.newTree.parse(this.latex,!0);return d.is_group("equals")?(this.combineEquations(f,d,e),d.children[0].children.forEach(function(a){this.cleanup(a)},this),d.children[2].children.forEach(function(a){this.cleanup(a)},this)):(this.combineExpressions(f,d,e),d.children.forEach(function(a){this.cleanup(a)},this)),"function"==typeof a&&a(this),this}var g=Wa.ui.Keyboard();g.caption("Combine the "+(e.is_group("equals")?"equations":"expressions")+" E₁ and E₂.").latex("E_1+E_2").on("done."+this.name,b.bind(this)).on("cancel."+this.name,c.bind(this)).visible(!0)},a.prototype.combineEquations=function(a,b,c){var d=b.children[0],e=this.target.children[0],f=b.children[2],g=this.target.children[2],h=c.is_group("equals")?c.children[0]:c,i=c.is_group("equals")?this.nodes[0].children[0].children[0]:this.nodes[0].children[0],j=c.is_group("equals")?c.children[2]:c,k=c.is_group("equals")?this.nodes[0].children[0].children[2]:this.nodes[0].children[0],l=a,m=a.clone();Va.replace(d,l),Va.replace(f,m),d.parent=null,f.parent=null,this.replaceAll("E_1",l,d,e),this.replaceAll("E_2",l,h,i),this.replaceAll("E_1",m,f,g),this.replaceAll("E_2",m,j,k)},a.prototype.combineExpressions=function(a,b,c){var d=this.target,e=this.nodes[0].children[0];Va.replace(b,a),b.parent=null,this.replaceAll("E_1",a,b,d),this.replaceAll("E_2",a,c,e)},a.prototype.replaceAll=function(a,b,c,d){var e=fa.getNodes(a,"all",b);e.forEach(function(a){var b=c.clone();Va.replace(a,b),this.updateNodeMap(d.get_mapping_to(b)),x.handle(b)},this)},a.prototype.endKeyboardInteraction=function(a){a.visible(!1),a.on("done."+this.name,null).on("cancel."+this.name,null)},new a}(),Wa.actions.InequalityFountain=function(){var a=function(a){p.call(this,"InequalityFountain","rewrite inequality"),this.priority=1,this.triggerType="hold",this.settings={asynchronous:!0},a&&(this.actor=a.actor)};return Wa.inherit(p,a),a.prototype.toJSON=function(){var a={id:this.id,name:this.name,type:"Action",priority:this.priority,node_map:Wa.object.jsonifyNodeMap(this.node_map),touched_nodes:this.touched_nodes,oldTree:this.oldTree.id,newTree:this.newTree.id,triggerType:this.triggerType,settings:this.settings};return this.actor&&(a.actor=this.actor.id),this.latex&&(a.latex=this.latex),a},a.prototype.ids_to_references_after_parsing=function(a){this.oldTree&&(this.oldTree=a[this.oldTree]),this.newTree&&(this.newTree=a[this.newTree]);for(var b in this.node_map)this.node_map[b]=this.node_map[b].map(function(b){return a[b]});this.actor&&(this.actor=a[this.actor]),this.latex&&(this.latex=this.latex)},a.prototype.match=function(a){return!(!Wa.ui||!Wa.ui.Keyboard)&&G.is_inequality(a)},a.prototype.transform=function(a){function b(b){this.latex=b;var c;try{c=new fa(b).children[0]}catch(a){return console.log(a),void f.warning("Could not parse expression.")}return fa.getNodes("E",0,c)?(this.invertInequalityIfInputIsNegative(c,d),this.replaceSideWithInput(d.children[0],c),this.replaceSideWithInput(d.children[2],c),f.visible(!1),f.on("done.eq-fountain",null).on("cancel.eq-fountain",null),"function"==typeof a&&a(this),this):void f.warning('There needs to be an "E" in the expression.')}function c(){return console.log("cancelled"),f.visible(!1),f.on("done.eq-fountain",null).on("cancel.eq-fountain",null),"function"==typeof a&&a(!1),!1}var d=this.getNewTreeNode(this.actor);if(this.latex){var e=new fa(this.latex).children[0];return this.invertInequalityIfInputIsNegative(e,d),this.replaceSideWithInput(d.children[0],e),this.replaceSideWithInput(d.children[2],e),"function"==typeof a&&a(this),this}var f=Wa.ui.Keyboard();f.caption("Enter an operation to apply to both sides of the equation.").latex("E").on("done.eq-fountain",b.bind(this)).on("cancel.eq-fountain",c).visible(!0)},a.prototype.invertInequalityIfInputIsNegative=function(a,b){var c=!1,d=!1;a.is_group("product","fraction")&&!function(){var b=function a(b){b.is_group("power")&&E.is_num(b.get_child([1,0]))&&E.get_value(b.get_child([1,0]))%2===0||(b.is_group("sign")?(c=!c,a(b.get_child([1]))):0!==b.children.length||E.is_num(b)||b instanceof t||"E"===b.to_ascii()?b.children.length&&b.children.forEach(a):d=!0)};b(a)}(),c&&b.invert(),d&&(this.settings.restraint="All new terms must evaluate to a positive number.")},a.prototype.replaceSideWithInput=function(a,b){var c=b.clone(),d=fa.getNodes("E",0,c);Va.replace(a,c),a.parent=null,Va.replace(d,a),x.handle(a),this.cleanup(a.parent)},G.prototype.add_action_handler(new a),new a}(),Wa.actions.ImaginaryAssociateNegOneOutOfSqrtAction=function(){var a=function(a){p.call(this,"ImaginaryAssociateNegOneOutOfSqrtAction","calculate a power of an imaginary number"),this.priority=1,this.triggerType="drag",this.settings={side:"outside"},a&&(this.nodes=a.nodes,this.target=a.target)};return Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(a){var b=this.matchSource(a);if(!b)return[];var c=this.getTargets(b);return this.bindActionForEachTarget(a,c)},a.prototype.matchSource=function(a){if(1!==a.length)return!1;var b=a[0];return!!E.is_equal_to(b,-1)&&(!!this.withinSqrt(b.parent)&&{nodes:a,power:b.get_parent(2)})},a.prototype.getTargets=function(a){return[a.nodes[0].parent]},a.prototype.withinSqrt=function(a){return a.is_group("brackets")&&a.parent.is_group("power")&&a.parent.is_square_root()},a.prototype.transform=function(a){this.addTouchedNodes(this.nodes);var b=this.getNewTreeNode(this.nodes)[0],c=b.get_parent(2),d=c.parent,e=this.getOldTreeNode(c),f=c.remove(),g=new L("i");return d.insert(f,g),this.updateNodeMap(e.get_mapping_to(g)),this.cleanup_cascade(d),"function"!=typeof a||void a(this)},new a}(),fa.prototype.move_actions.push(Wa.actions.ImaginaryAssociateNegOneOutOfSqrtAction),Wa.actions.ImaginaryAssociateOutOfSqrtAction=function(){var a=function(a){p.call(this,"ImaginaryAssociateOutOfSqrtAction","calculate a power of an imaginary number"),this.priority=1,this.triggerType="drag",this.settings={target_group:!0,group_side:"outside",margin:{x:-.1,y:-.1}},a&&(this.nodes=a.nodes,this.target=a.target,this.settings.side=a.side)};return Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(a){var b=this.matchSource(a);if(!b)return[];var c=this.getTargets(b);return this.bindActionForEachTarget(a,c,!0)},a.prototype.matchSource=function(a){if(1!==a.length)return!1;var b=a[0];return!!E.is_equal_to(b.children[1],-1)&&(!(!b.parent.parent||!this.withinSqrt(b.get_parent(2)))&&{nodes:a,group:b.parent,power:b.get_parent(3)})},a.prototype.getTargets=function(a){return[a.group]},a.prototype.withinSqrt=function(a){return a.is_group("brackets")&&a.parent.is_group("power")&&a.parent.is_square_root()},a.prototype.transform=function(a){this.addTouchedNodes(this.nodes);var b=this.getNewTreeNode(this.nodes)[0],c=b.parent,d=c.get_parent(2),e=d.parent,f=d.remove(),g=new J;b.remove();var h=b.children[1],i=new L("i");return h.replace_with(i),this.updateNodeMap(this.nodes[0].children[1].get_mapping_to(i)),b.is_group("div")&&b.invert(),g.append(new K(d)),g.insert("left-of"===this.settings.side?0:1,b),e.insert(f,g),this.cleanup(c),this.cleanup_cascade(e),"function"!=typeof a||void a(this)},new a}(),fa.prototype.move_actions.push(Wa.actions.ImaginaryAssociateOutOfSqrtAction),function(){var a=function(a){p.call(this,"ImaginaryEvaluateIntegerPowerAction","calculate a power of an imaginary number"),this.priority=1,this.triggerType="tap",a&&(this.actor=a.actor)};Wa.inherit(p,a),a.prototype.match=function(a){var b=a.get_parent(1);if(!b.is_group("power"))return!1;var c=b.children[0];if(!L.is_constant(c)||"i"!==c.value)return!1;var d=b.get_child([1,0]);d.is_group("brackets")&&d.children[0].hidden&&(d=d.children[1]);var e=E.get_value(d);return!isNaN(e)&&Math.round(e)===e},a.prototype.transform=function(a){this.addTouchedNodes(this.actor.parent);var b=this.getNewTreeNode(this.actor),c=(this.actor.get_parent(1),b.parent),d=c.children[0],e=b.children[0];e.is_group("brackets")&&(e=e.children[1]);var f=E.get_value(e);d.remove();var g=this.getEvaluateBase(d,f);return c.replace_with(g),"function"!=typeof a||void a(this)},a.prototype.getEvaluateBase=function(a,b){var c,d=b%4;return 0===d?c=new E(1):d===-3||1===d?c=a:d===-2||2===d?c=new E(-1):d!==-1&&3!==d||(c=new Q(a)),c},M.prototype.add_action_handler(new a)}(),function(){var a=function(a){p.call(this,"ImaginarySqrtOfNegativeOneAction","calculate a power of an imaginary number"),this.priority=0,this.triggerType="tap",a&&(this.actor=a.actor)};Wa.inherit(p,a),a.prototype.match=function(a){if(a.is_group("radical")&&E.is_equal_to(a.get_radicand(),-1))return!0;var b=a.get_parent(1);if(!b.is_group("power"))return!1;var c=b.children[0];if(!c.is_group("brackets"))return!1;var d=E.get_value(c.children[1]);return!isNaN(d)&&d===-1&&!!E.is_equal_to(b.get_child([1,0]),.5)},a.prototype.transform=function(a){if(this.actor.is_group("radical")){this.addTouchedNodes(this.actor);var b=this.actor,c=this.getNewTreeNode(this.actor),d=c.parent,e=c.remove()}else{this.addTouchedNodes(this.actor.parent);var b=this.actor.parent,f=this.getNewTreeNode(b),d=f.parent,e=f.remove()}var g=new L("i");return d.insert(e,g),this.cleanup_cascade(d),this.updateNodeMap(b.get_mapping_to(g)),"function"!=typeof a||void a(this)},D.prototype.add_action_handler(new a),M.prototype.add_action_handler(new a)}(),Wa.actions.GreatestCommonFactorAction=function(){var a=function(a){p.call(this,"GreatestCommonFactorAction","find the greatest common factor between two terms"),this.priority=0,this.triggerType="drag",this.settings={delay:1e3,side:"inside",margin:{x:.1},reset_x:!0,reset_y:!0},a&&(this.nodes=a.nodes,this.target=a.target)};return Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(a){var b=a[0];if(1!==a.length)return[];if(!b.is_group("add","sub","mul","div"))return[];var c,d,e;if(b.is_group("add","sub"))c=b.get_parent(1),d=b.get_idx(),e=!1;else{var f=Wa.factoring.factorable_muldiv(b);if(!f)return[];c=f.ancestor_sum,d=f.addsub_idx,e=b.is_group("div")}var g=[];c.children.forEach(function(a,b){b!==d&&(g=g.concat(this.getPotentialTargets(a,e)))},this);var h=[];return g.forEach(function(a){this.matchTarget(b,a)&&h.push(a)},this),this.bindActionForEachTarget(a,h)},a.prototype.getPotentialTargets=function(a,b,c){var d=[],e=a.get_child([1]);if(e.is_group("product")&&!c)e.children.forEach(function(a){d=d.concat(this.getPotentialTargets(a,b))},this);else if(e.is_group("fraction")&&!c){var f=b?e.get_bottom():e.get_top();f.forEach(function(a){d=d.concat(this.getPotentialTargets(a,b,!0))},this)}else!c&&b||d.push(a);return d},a.prototype.matchTarget=function(a,b){var c=a.get_child([1]),d=b.get_child([1]),e=c.is_group("sign"),f=d.is_group("sign");return e&&(c=c.get_child([1])),f&&(d=d.get_child([1])),c.to_ascii()!==d.to_ascii()&&(!!this.matchNumberMultiples(c,d)||(!(e||f||!this.matchPowers(c,d))||!!(e&&f&&this.matchUnidenticalInnerTerms(c,d))))},a.prototype.matchNumberMultiples=function(a,b){return!(!E.is_num(a)||!E.is_num(b))&&(!(!E.get_value(a)||!E.get_value(b))&&!!Wa.factoring.numbers_are_multiples(a,b))},a.prototype.matchPowers=function(a,b){if(!a.is_group("power")&&!b.is_group("power"))return!1;if(!I.haveSameBase(a,b))return!1;var c=I.getNumericalValueOfExponent(a),d=I.getNumericalValueOfExponent(b);return!(!c&&0!==c)&&!(!d&&0!==d)},a.prototype.matchUnidenticalInnerTerms=function(a,b){return Wa.factoring.bypass_negatives(a).to_ascii()!==Wa.factoring.bypass_negatives(b).to_ascii()},a.prototype.transform=function(a){this.addTouchedNodes(this.nodes),this.addTouchedNodes(this.target);var b=this.nodes[0],c=this.target,d=this.getNewTreeNode(b),e=this.getNewTreeNode(c),f=d.get_child([1]),g=e.get_child([1]),h=f.is_group("sign"),i=g.is_group("sign");h&&(f=f.get_child([1])),i&&(g=g.get_child([1]));var j;if(E.is_num(f)&&E.is_num(g)&&Wa.factoring.numbers_are_multiples(f,g))j=this.factorizeNumbers(b,d,c,e);else if((f.is_group("power")||g.is_group("power"))&&I.haveSameBase(f,g))j=this.factorizePowers(b,d,c,e);else{if(!h||!i)throw"(GreatestCommonFactorAction) There is a case mis-match between the match and transform functions.";j={matching_nodes_factor:this.splitNegativeFromNode(b,d).mul_negative_one,matching_target_factor:this.splitNegativeFromNode(c,e).mul_negative_one},this.setNodesToReselectAfterAction(matching_nodes_factor)}return Wa.options.actions.factor_after_finding_gcf&&(this.followup=Wa.actions.FactorCommonTermsAction.createBoundAction(this.newTree,{nodes:[j.matching_nodes_factor],target:[j.matching_target_factor]})),"function"!=typeof a||void a(this)},a.prototype.splitNegativeFromNode=function(a,b){var c=a.get_child([1]),d=b.get_child([1]),e=d.remove(),f=new J,g=new Q(new E(1)),d=E.is_num(d)?new E(Math.abs(E.get_value(d))):Va.clone(d),h=new K(g),i=new K(d);return f.append(h),f.append(i),b.insert(e,f),this.updateNodeMap(c.get_mapping_to(g)),this.extendNodeMap(c.get_mapping_to(d)),this.cleanup_cascade(b),{mul_negative_one:h,mul_term:i}},a.prototype.factorizeNumbers=function(a,b,c,d){var e,f,g=b.get_child([1]),h=d.get_child([1]),i=E.get_value(g),j=E.get_value(h);if(Wa.factoring.val1_is_a_multiple_of_val2(i,j)){var k=i/j,l=j,e=this.splitIntoFactors(a.get_child([1]),g,k,l).factor2.parent;this.setNodesToReselectAfterAction(e),f=d}else if(Wa.factoring.val1_is_a_multiple_of_val2(j,i)){var k=j/i,l=i;e=b,f=this.splitIntoFactors(c.get_child([1]),h,k,l).factor2.parent}else{var m=Wa.factoring.get_gcf(i,j);e=this.splitIntoFactors(a.get_child([1]),g,m,i/m).factor1.parent,f=this.splitIntoFactors(c.get_child([1]),h,m,j/m).factor1.parent,this.setNodesToReselectAfterAction(e)}return{matching_nodes_factor:e,matching_target_factor:f}},a.prototype.splitIntoFactors=function(a,b,c,d){var e=b.parent,f=b.remove(),g=new J,h=new E(c),i=new E(d),j=new K(h),k=new K(i);return g.append(j),g.append(k),e.insert(f,g),this.mapNumber(a,h),this.mapNumber(a,i,!0),this.cleanup_cascade(e),{factor1:h,factor2:i}},a.prototype.mapNumber=function(a,b,c){var d=c?this.extendNodeMap.bind(this):this.updateNodeMap.bind(this);!a.is_group("sign")&&b.is_group("sign")?d(a,b.get_child([1])):a.is_group("sign")&&!b.is_group("sign")?d(a.get_child([1]),b):d(a.get_mapping_to(b))},a.prototype.factorizePowers=function(a,b,c,d){var e,f,g=b.get_child([1]),h=d.get_child([1]),i=I.getNumericalValueOfExponent(g),j=I.getNumericalValueOfExponent(h);if(g.is_group("power"))if(h.is_group("power"))i>j?(f=d,e=this.splitPower(a,b,j,i-j).mul_power1,this.setNodesToReselectAfterAction(e)):(e=b,f=this.splitPower(c,d,i,j-i).mul_power1);else{f=d;var e=this.splitOffBase(a,b).mul_var;this.setNodesToReselectAfterAction(e)}else f=this.splitOffBase(c,d).mul_var,e=b;return{matching_nodes_factor:e,matching_target_factor:f}},a.prototype.splitOffBase=function(a,b){var c=a.get_child([1]),d=b.get_child([1]),e=d.remove(),f=new J,g=d.get_child([0]).clone(),h=d.clone(),i=I.getNumericalValueOfExponent(h)-1;h.get_child([1]).remove(),h.append(new M(new E(i))),this.mapPowerToVar(c,g),this.mapPowerToPower(c,h);var j=new K(g),k=new K(h);return this.mapOpToOp(a,j),this.mapOpToOp(a,k),f.append(j),f.append(k),b.insert(e,f),1===I.getNumericalValueOfExponent(h)&&(h=h.replace_with(h.get_child([0]))),this.cleanup_cascade(b),{mul_var:j,mul_power:k}},a.prototype.splitPower=function(a,b,c,d){var e=a.get_child([1]),f=b.get_child([1]),g=f.remove(),h=new J,i=f.clone(),j=f.clone();i.get_child([1]).remove(),i.append(new M(new E(c))),j.get_child([1]).remove(),j.append(new M(new E(d))),this.mapPowerToPower(e,i),this.mapPowerToPower(e,j);var k=new K(i),l=new K(j);return this.mapOpToOp(a,k),this.mapOpToOp(a,l),h.append(k),h.append(l),b.insert(g,h),1===I.getNumericalValueOfExponent(j)&&(j=j.replace_with(j.get_child([0]))),this.cleanup_cascade(b),{mul_power1:k,mul_power2:l}},a.prototype.mapPowerToVar=function(a,b){this.extendNodeMap(a.get_child([0]).get_mapping_to(b))},a.prototype.mapPowerToPower=function(a,b){this.extendNodeMap(a,b),this.extendNodeMap(a.get_child([0]).get_mapping_to(b.get_child([0]))),this.extendNodeMap(a.get_child([1]),b.get_child([1])),this.extendNodeMap(a.get_child([1,0]).get_mapping_to(b.get_child([1,0])))},a.prototype.mapOpToOp=function(a,b){this.extendNodeMap(a,b),this.extendNodeMap(a.get_child([0]),b.get_child([0]))},new a}();fa.prototype.move_actions.push(Wa.actions.GreatestCommonFactorAction);Wa.actions.FactorCommonTermsAction=function(){var a=function(a){p.call(this,"FactorCommonTermsAction","factor out matching term ranges"),this.priority=0,this.triggerType="drag",this.settings={delay:600,side:"inside",margin:{x:.1},reset_x:!0,reset_y:!0},a&&(this.nodes=a.nodes,this.target=a.target)};return Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(a){if(a[0].is_group("add","sub")&&1!==a.length)return[];if(a[0].is_group("mul","div")&&!Va.is_range(a))return[];var b,c,d;if(a[0].is_group("add","sub"))b=a[0].get_parent(1),c=a[0].get_idx(),d=!1;else{var e=Wa.factoring.factorable_muldiv(a[0]);if(!e)return[];b=e.ancestor_sum,c=e.addsub_idx,d=a[0].is_group("div")}var f=this.getAsciiRangeFromNodes(a),g=[];return b.children.forEach(function(a,b){b!==c&&(g=g.concat(this.getMatchingTargetRanges(a,f,d)))},this),this.bindActionForEachRange(a,g)},a.prototype.getAsciiRangeFromNodes=function(a){var b=[];if(1===a.length&&a[0].is_group("add","sub")){for(var c=a[0].get_child([1]);c.is_group("sign");)c=c.get_child([1]);c.is_group("product")?c.children.forEach(function(a){b.push(Wa.factoring.bypass_negatives(a.get_child([1])).to_ascii())},this):b.push(c.to_ascii())}else a.forEach(function(a){b.push(Wa.factoring.bypass_negatives(a.get_child([1])).to_ascii())},this);return b},a.prototype.bypassNegatives=function(a){for(;a.is_group("sign");)a=a.get_child([1]);return a},a.prototype.getMatchingTargetRanges=function(a,b,c){var d=[],e=a.get_child([1]);return this.rangeAsciisMatch(b,[Wa.factoring.bypass_negatives(e).to_ascii()])&&d.push([a]),e.is_group("product")&&(c||(d=d.concat(this.matchRangeOfOperators(e.children,b))),e.children.forEach(function(a){var e=a.get_child([1]);e=Wa.factoring.bypass_negatives(e),e.is_group("fraction")&&(d=d.concat(this.getMatchingTargetRangesFromFraction(e,b,c)))},this)),e.is_group("fraction")&&(d=d.concat(this.getMatchingTargetRangesFromFraction(e,b,c))),d},a.prototype.getMatchingTargetRangesFromFraction=function(a,b,c){var d;return d=c?this.matchRangeOfOperators(a.get_bottom(),b):this.matchRangeOfOperators(a.get_top(),b)},a.prototype.matchRangeOfOperators=function(a,b){var c=[],d=b.length,e=a.map(function(a){return Wa.factoring.bypass_negatives(a.get_child([1])).to_ascii()},this);if(a.length===d&&this.rangeAsciisMatch(b,e)&&a[0].get_parent(1).is_group("product"))return[[a[0].get_parent(2)]];for(var f=0;f<a.length-d+1;f++){var g=e.slice(f,f+d);this.rangeAsciisMatch(b,g)&&c.push(a.slice(f,f+d))}return c},a.prototype.rangeAsciisMatch=function(a,b){if(a.length!==b.length)return!1;for(var c=0;c<a.length;c++)if(a[c]!==b[c])return!1;return!0},a.prototype.bindActionForEachRange=function(a,b){var c=a[0].get_root();return b.map(function(b){return this.createBoundAction(c,{nodes:a,target:b})},this)},a.prototype.transform=function(a){this.addTouchedNodes(this.nodes),this.addTouchedNodes(this.target);var b=this.nodes,c=this.target,d=this.analyzeOldStructure(b),e=this.analyzeOldStructure(c),f=this.getNewTreeNode(c),g=this.getNewTreeNode(b);g[0].is_group("add","sub")&&(g=this.insertCoefficientOfOneIntoAddend(g)),f[0].is_group("add","sub")&&(f=this.insertCoefficientOfOneIntoAddend(f));var h=this.analyzeStructure(g),i=this.analyzeStructure(f);h.left_of_target=h.idx_of_addend<i.idx_of_addend;var j=this.stripNegatives(h),k=this.stripNegatives(i);return this.nodesProductIsInMidFactoring(h)?(h.addend.remove(),h.sum_of_coefficients=h.left_of_target?h.product.get_child([0,1,1]):h.product.get_child([h.product.children.length-1,1,1])):h=this.reinterpretNodesStructureForFactoring(h),this.reinterpretTargetStructureForMergingWithNodes(i),this.insertTargetCoefficientsIntoCoefficientsSum(i,h),i.sum.insert(h.left_of_target?i.idx_of_addend-1:i.idx_of_addend,h.addend),this.reapplyNegatives(g,d,h,e,i,j,k),this.mapOldTargetFactorsToNewFactors(e,g),this.cleanupTermsInCoefficientsSum(h),this.cleanupTermsInProductOfCoefficentsSumAndVariables(h),this.cleanup_cascade(i.sum),this.setNodesToReselectAfterAction(g[0].children[1]?g:h.range),"function"!=typeof a||void a(this)},a.prototype.analyzeOldStructure=function(a){function b(a){for(;a.is_group("sign");)d.push(a),a=a.get_child([1]);e.push(a)}var c,d=[],e=[];if(a[0].is_group("add","sub")){c=a[0];var f=a[0].get_child([1]);f.is_group("product")?f.children.forEach(function(a){b(a.get_child([1]))}):b(f)}else{for(c=a[0];!c.is_group("add","sub");)c=c.get_parent(1);a.forEach(function(a){b(a.get_child([1]))})}return{addend:c,negative_groups:d,factors:e}},a.prototype.insertCoefficientOfOneIntoAddend=function(a){for(var b=a[0];!b.is_group("add","sub");)b=b.get_parent(1);var c=b.get_child([1]);c.remove();var d=K.prototype.createGroup();return d.append(new K(new E(1))),d.append(new K(c)),b.append(d),this.cleanup(d.get_child([1])),d.children.slice(1)},a.prototype.analyzeStructure=function(a){var b={};b.range=a;var c=a[0];if(c.parent.is_group("product"))b.product=c.get_parent(1),b.addend=b.product.get_parent(1);else{if(!c.get_parent(1).is_group("fraction"))throw"Can't identify structure for direct factoring.";b.fraction=c.get_parent(1),b.fraction.get_parent(1).is_group("mul")?(b.product=b.fraction.get_parent(2),b.addend=b.product.get_parent(1)):b.addend=b.fraction.get_parent(1)}return b.sum=b.addend.get_parent(1),b.idx_of_addend=b.sum.children.indexOf(b.addend),b},a.prototype.stripNegatives=function(a){var b=0;return a.addend.is_group("sub")&&(a.addend.invert(),b++),a.range.forEach(function(a){for(var c=0,d=a.get_child([1]);d.is_group("sign");)d=d.get_child([1]),c++;c&&(a.get_child([1]).remove(),d.remove(),a.append(d)),b+=c},this),b},a.prototype.nodesProductIsInMidFactoring=function(a){if(a.fraction)return!1;if(a.addend.is_group("sub"))return!1;var b=a.product.get_child([0,1]),c=a.product.get_last_child().children[1];return(!a.left_of_target||a.range.indexOf(b.parent)===-1)&&(!(!a.left_of_target&&a.range.indexOf(c.parent)!==-1)&&(!(!(b.is_group("brackets")&&b.children[1].is_group("sum")||!a.left_of_target)||!(c.is_group("brackets")&&c.children[1].is_group("sum")||a.left_of_target))&&a.product.children.length-1===a.range.length))},a.prototype.reinterpretNodesStructureForFactoring=function(a){a.range.forEach(function(a){a.remove()});var b=this.rearrangeStructure(a);return b},a.prototype.rearrangeStructure=function(a){var b=K.prototype.createGroup();a.range.forEach(function(a){b.append(a)});var c=new K(b);this.cleanupProductOfCoefficients(a);var d=v.prototype.createGroup();a.addend.remove(),a.addend.dragging=!1,a.addend.selected=!1,d.append(a.addend);var e=a.addend.get_idx(),f=new x(d),g=K.prototype.createGroup();a.left_of_target?(g.append(new K(f)),g.append(c)):(g.append(c),g.append(new K(f)));var h=new v(g),i={};return i.idx_of_addend=e,i.addend=h,i.product=g,i.sum_of_coefficients=d,i.left_of_target=a.left_of_target,i.range=[c],i},a.prototype.cleanupProductOfCoefficients=function(a){var b,c;a.fraction&&(b=a.fraction.parent,this.cleanup(a.fraction),b.is_group("mul")&&1===E.get_value(b.children[1])&&(b.remove(),c=!0)),a.product&&(b&&!c&&this.cleanup(b),this.cleanup(a.product))},a.prototype.reinterpretTargetStructureForMergingWithNodes=function(a){a.addend.remove(),a.range.forEach(function(a){a.remove()}),a.fraction&&1===a.fraction.get_top().length&&E.is_num(a.fraction.get_child([0,1]))&&1===E.get_value(a.fraction.get_child([0,1]))&&a.fraction.get_parent(1).is_group("mul")&&a.fraction.get_parent(1).remove()},a.prototype.insertTargetCoefficientsIntoCoefficientsSum=function(a,b){b.left_of_target?b.sum_of_coefficients.append(a.addend):b.sum_of_coefficients.insert(0,a.addend)},a.prototype.reapplyNegatives=function(a,b,c,d,e,f,g){if(f%2===1&&g%2===1){var h=a[0],i=h.get_child([1]);i.remove(),i=new Q(i),h.append(i),b.addend.is_group("sub")?this.extendNodeMap(b.addend.get_child([0]),i.get_child([0])):b.negative_groups.forEach(function(a,b){0===b&&this.updateNodeMap(a.get_child([0]),i.get_child([0]))},this),d.addend.is_group("sub")?this.extendNodeMap(d.addend.get_child([0]),i.get_child([0])):d.negative_groups.forEach(function(a,b){0===b&&this.updateNodeMap(a.get_child([0]),i.get_child([0]))},this)}else if(f!==g&&Math.abs(f-g)%2===1){var j=c.left_of_target?c.sum_of_coefficients.children.length-1:0,k=c.sum_of_coefficients.get_child([j]);f>g?c.sum_of_coefficients.children.forEach(function(a,c){c!==j&&(a.invert(),b.addend.is_group("sub")?this.extendNodeMap(b.addend.get_child([0]),a.get_child([0])):b.negative_groups.forEach(function(b,c){0===c&&this.extendNodeMap(b.get_child([0]),a.get_child([0]))},this))},this):(k.invert(),d.addend.is_group("sub")?this.updateNodeMap(d.addend.get_child([0]),k.get_child([0])):d.negative_groups.forEach(function(a,b){0===b&&this.updateNodeMap(a.get_child([0]),k.get_child([0]))},this))}},a.prototype.mapOldTargetFactorsToNewFactors=function(a,b){a.factors.forEach(function(a,c){this.updateNodeMap(a.get_mapping_to(Wa.factoring.bypass_negatives(b[c].children[1])))},this)},a.prototype.cleanupTermsInCoefficientsSum=function(a){for(var b=a.sum_of_coefficients,c=0;c<b.children.length;c++){var d=b.get_child([c,1]);d.is_group("product")&&d.children.forEach(function(a){var b=a.get_child([1]);b.is_group("fraction")&&this.cleanup(b)},this),this.cleanup(d)}for(var c=0;c<b.children.length;c++){var d=b.get_child([c]);x.handle(d,!0),this.cleanup(d)}},a.prototype.cleanupTermsInProductOfCoefficentsSumAndVariables=function(a){for(var b=a.product,c=0;c<b.children.length;c++)this.cleanup(b.children[c].children[1]);for(var c=0;c<b.children.length;c++)this.cleanup(b.children[c])},new a}(),fa.prototype.move_actions.push(Wa.actions.FactorCommonTermsAction),Wa.actions.FlipTermAction=function(){var a=function(a){p.call(this,"FlipTermAction","flip a term into a denominator"),this.priority=0,this.triggerType="drag",this.settings={delay:1500,on_release:!0,side:"below",reset_y:!0,margin:{y1:.1,y2:-.25}},a&&(this.nodes=a.nodes,this.target=a.target)};return Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(a){return this.matchSource(a)?this.bindActionForEachTarget(a,a):[]},a.prototype.matchSource=function(a){if(1!==a.length)return!1;var b=a[0];return b.is_group("exponent","degree")?b=b.get_term():b.is_group("mul","div","add","sub")&&(b=b.children[1]),!b.is_group("equals","param")&&!G.is_inequality(b)},a.prototype.transform=function(a){this.addTouchedNodes(this.nodes);var b=this.getNewTreeNode(this.target);b.is_group("exponent","degree")&&(b=b.get_term()),b.is_group("mul","div","add","sub")&&(b=b.children[1]);var c=this.getTransformFunction(b);return this.replaceWithFlippedFraction(b,c.bind(this)),"function"==typeof a&&a(this),this},a.prototype.getTransformFunction=function(a){var b;return b=a.is_group("power")?this.flipPower:a.is_group("fraction")?this.flipFraction:E.is_equal_to(a,1,-1)?this.flipIdentity:this.flipTerm},a.prototype.replaceWithFlippedFraction=function(a,b){var c=a.get_parent(1),d=a.remove(),e=new J;e.append(new K(new E(1)));var f=b(a),g=new K(f,"div");e.append(g),this.setNodesToReselectAfterAction(g),c.insert(d,e),this.cleanup(g.children[1]),x.handle(e)},a.prototype.flipIdentity=function(a){return a},a.prototype.flipPower=function(a){return this.flipExponent(a.get_child([1])),a},a.prototype.flipExponent=function(a){var b=a.get_child([0]);x.areHidden(b)&&(b=b.children[1]),b.is_group("product")&&(b=b.get_child([0,1])),this.makeTermNegative(b),x.handle(a.children[0],!0),E.is_equal_to(a.get_term(),1)&&a.remove()},a.prototype.makeTermNegative=function(a){if(a.is_group("sum"))a.children.forEach(function(a){a.invert()});else if(a.is_group("sign"))a.replace_with(a.get_child([1]));else{var b=a.get_parent(1),c=a.remove(),d=new Q(a);b.insert(c,d)}},a.prototype.flipFraction=function(a){var b=a.get_top(),c=a.get_bottom();return Va.remove_range(b),Va.remove_range(c),c.forEach(function(b){b.invert(),a.append(b)}),b.forEach(function(b){b.invert(),a.append(b)}),a},a.prototype.flipTerm=function(a){var b=this.convertToEquivalentPowerForm(a);return this.flipPower(b)},a.prototype.convertToEquivalentPowerForm=function(a){var b=new I(a,new E(1));return b},new a}(),fa.prototype.move_actions.push(Wa.actions.FlipTermAction),Wa.actions.FlipTermAcrossFractionAction=function(){var a=function(a){p.call(this,"FlipTermAcrossFractionAction","flip a term into a denominator"),this.priority=1,this.triggerType="drag",this.settings={delay:1500,reset_y:!0,target_group:!0,group_side:"around"},a&&(this.nodes=a.nodes,this.target=a.target,this.settings.side=a.side)};return Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(a){var b=this.matchSource(a);if(!b)return[];var c=this.getTargets(b);return this.adjustTargetBoxes(this.bindActionForEachTarget(a,c,!0))},a.prototype.matchSource=function(a){if(!Va.is_range(a))return!1;var b=a[0];return!(!b.is_group("mul","div")||!b.get_parent(1).is_group("fraction"))&&(b=b.get_child([1]),{nodes:a,frac:a[0].get_parent(1)})},a.prototype.getTargets=function(a){return a.nodes[0].is_group("mul")?a.frac.get_bottom():a.frac.get_top()},a.prototype.adjustTargetBoxes=function(a){return a.forEach(function(a){a.target.is_group("div")?a.settings.margin={y1:.3}:a.settings.margin={y2:.3}},this),a},a.prototype.transform=function(a){this.addTouchedNodes(this.nodes);var b=this.getNewTreeNode(this.nodes),c=this.getNewTreeNode(this.target),d=b[0].get_parent(1);if(Va.remove_range(b),b[0].is_group("div")){var e=d.get_top();1===e.length&&1===E.get_value(e[0].get_child([1]))&&e[0].remove()}b.forEach(function(a){var b=a.get_child([1]),c=Wa.actions.FlipTermAction.getTransformFunction(b).bind(Wa.actions.FlipTermAction);b.remove(),b=c(b),a.append(b),a.invert()},this);var f=c.get_idx()===-1?0:c.get_idx()+("right-of"===this.settings.side?1:0);d.insert_range(f,b);var g=!1;return b.forEach(function(a){g=g||this.cleanup_cascade(a.children[1])},this),g||this.cleanup_cascade(d),"function"==typeof a&&a(this),this},new a}(),fa.prototype.move_actions.push(Wa.actions.FlipTermAcrossFractionAction),
Wa.actions.FractionExtendAction=function(){var a=function(a){p.call(this,"FractionExtendAction","extend fraction"),this.priority=0,this.triggerType="hold",this.settings={asynchronous:!0},this.latex=null,a&&(this.actor=a.actor)};Wa.inherit(p,a),a.prototype.toJSON=function(){var a=p.prototype.toJSON.call(this);return this.latex&&(a.term=this.latex),a},a.prototype.match=function(a){return!(!Wa.ui||!Wa.ui.Keyboard)&&a.is_group("fraction")},a.prototype.transform=function(b){function c(c){try{e=this.newTree.parse(c,!0),this.latex=c}catch(a){return console.log(a),void f.warning("Could not parse expression.")}return a.acceptTerm(e)?(this.extendFraction(this.getNewTreeNode(this.actor),e),this.endKeyboardInteraction(f),void b(this)):void f.warning("Can't extend the fraction with this expression.")}function d(){this.endKeyboardInteraction(f),b(!1)}var e;if(this.latex)return e=this.newTree.parse(this.latex,!0),this.extendFraction(this.getNewTreeNode(this.actor),e),"function"==typeof b&&b(this),this;var f=Wa.ui.Keyboard();f.caption("Enter a term with which to multiply the numerator and denominator of this fraction.").latex("").on("done."+this.name,c.bind(this)).on("cancel."+this.name,d.bind(this)).visible(!0)},a.acceptTerm=function(a){return!(a.is_group("brackets")&&a.get_child([1]).is_group("tuple")||a.is_group("equals"))},a.prototype.extendFraction=function(a,b){a.append(new K(b,"mul")),a.append(new K(b.clone(),"div")),this.cleanup(a)},a.prototype.endKeyboardInteraction=function(a){return a.visible(!1),a.on("done."+this.name,null).on("cancel."+this.name,null),!1};var b=new a;return J.prototype.add_action_handler(b),b}(),Wa.actions.SplitNumeratorAction=function(){var a=function(a){p.call(this,"SplitNumeratorAction","split numerator into new fractions with same denominators"),this.priority=0,this.triggerType="drag",this.settings={},a&&(this.nodes=a.nodes,this.target=a.target,this.settings.side=Array.isArray(this.target)?"around":a.side,this.settings.target_is_left="left-of"===a.side,this.settings.offset={x:this.settings.target_is_left?-10:10,y:0})};return Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(a){if(0===a.length)return[];var b=a[0];return b.parent&&b.parent.parent&&b.parent.parent.parent&&b.parent.parent.parent.parent&&(b.is_group("add")||b.is_group("sub"))&&b.parent.parent.parent.is_group("mul")&&b.parent.parent.parent.parent.is_group("fraction")?b.parent.parent.parent.parent.get_top().length>1?[]:this.match(a,b.parent.parent.parent.parent)?[this.bindAction(a,"left-of"),this.bindAction(a,"right-of")]:[]:[]},a.prototype.bindAction=function(a,b){var c=a[0].get_root(),d=[];return this.fractionIsPartOfProduct(a)&&(d=this.getSiblingsOfFraction(a,b)),this.createBoundAction(c,{nodes:a,target:d.length>0?d:a[0].parent.parent.parent.parent,side:b})},a.prototype.fractionIsPartOfProduct=function(a){var b=a[0].parent;return b.parent&&b.parent.is_group("sum")},a.prototype.getSiblingsOfFraction=function(a,b){var c=a[0].parent,d=c.parent,e=d.parent;return"left-of"===b?e.children.slice(0,e.children.indexOf(d)):e.children.slice(e.children.indexOf(d)+1)},a.prototype.match=function(a,b){return 0!==a.length&&(a[0]&&(a[0].is_group("add")||a[0].is_group("sub"))&&a[0].parent.parent.parent.parent===b&&b.is_group("fraction"))},a.prototype.transform=function(a){var b=this.getNewTreeNode(this.nodes);this.addTouchedNodes(this.nodes[0].parent.parent.parent.parent);var c=this.nodes[0].parent.parent.parent.parent.get_bottom(),d=this.nodes[0].parent.parent.parent.parent.children[1],e=b[0].parent.parent.parent.parent;Va.remove_range(b);var f=v.prototype.createGroup();e.replace_with(f),f.append(new v(e));var g=e.get_bottom(),h=new J;h.invert();var i=v.prototype.createGroup();i.append_range(b),h.insert(0,new K(i));for(var j=0;j<g.length;j++){var k=Va.clone(g[j]);h.append(k),this.extendNodeMap(c[j].get_mapping_to(k))}this.extendNodeMap(d,h.children[1]);var l=new v(h),m=this.settings.target_is_left;f.insert(m?0:1,l);var n=this.rearrangeSumIfNumeratorIsASingleTerm(f,0),o=this.rearrangeSumIfNumeratorIsASingleTerm(f,1);if(m&&!n||!m&&!o)for(var j=0;j<b.length;j++)this.updateNodeMap(b[j],l);var p=e.get_top(),q=h.get_top();return 1===p.length&&this.cleanup(p[0]),1===q.length&&this.cleanup(q[0]),this.cleanup(f.parent),x.handle(f),"function"!=typeof a||void a(this)},a.prototype.rearrangeSumIfNumeratorIsASingleTerm=function(a,b){var c=a.children[b],d=c.children[1];if(1===d.children[0].children[1].children[1].children.length){var e=d.children[0].children[1].children[1],f=e.children[0],g=f.children[1],h=e.parent.parent;return e.parent.remove(),f.remove(),g.remove(),e.remove(),d.remove(),c.remove(),a.insert(b,f),f.append(d),h.append(g),!0}return!1},new a}(),fa.prototype.move_actions.push(Wa.actions.SplitNumeratorAction),Wa.actions.DivideRationalNumbersAction=function(){function a(a,b,c){c.updateNodeMap(a,b),c.updateNodeMap(a.children[0],b.children[0]),!a.children[1].is_group("sign")&&b.children[1].is_group("sign")?c.updateNodeMap(a.children[1].get_mapping_to(b.children[1].children[1])):c.updateNodeMap(a.children[1].get_mapping_to(b.children[1]))}var b=function(a){p.call(this,"DivideRationalNumbersAction","division of numbers"),this.triggerType="drag",this.priority=2,this.settings={delay:400,side:"inside"},a&&(this.nodes=a.nodes,this.target=a.target)};return Wa.inherit(p,b),b.prototype.getAllAvailableActions=function(a){if(1!==a.length)return[];var b=a[0].parent.match("{n: ±\\NUM} / {d: ±\\NUM}");return b&&(this.isRational(b.n)||this.isRational(b.d))?a[0]!==b.d.parent?[]:this.createBoundAction(a[0].get_root(),{nodes:a,target:b.n.parent}):[]},b.prototype.isRational=function(a){return E.get_value(a)!==(0|E.get_value(a))},b.prototype.transform=function(b){this.old_dragged_term=this.nodes[0],this.old_target_term=this.target,this.addTouchedNodes(this.old_dragged_term),this.addTouchedNodes(this.old_target_term);var c=this.getNewTreeNode(this.old_dragged_term),d=this.getNewTreeNode(this.old_target_term),e=c.children[1],f=d.children[1],g=c.parent,h=E.get_value(f)/E.get_value(e);d.is_group("div")&&(h=1/h);var i=new K(new E(h),d.value);a(this.old_dragged_term,i,this),a(this.old_target_term,i,this);var j=d.remove();return g.insert(j,i),c.remove(),this.cleanup(g),"function"==typeof b&&b(this),this},new b}(),fa.prototype.move_actions.push(Wa.actions.DivideRationalNumbersAction),Wa.actions.IndexIdentityAction=function(){var a=function(a){p.call(this,"IndexIdentityAction","an index of 1 leaves the base unchanged"),this.priority=0,this.triggerType="tap",a&&(this.actor=a.actor)};Wa.inherit(p,a),a.prototype.match=function(a){return!(!a.is_group("power")||!E.is_equal_to(a.children[1].children[0],1))||!(!a.is_group("radical")||!E.is_equal_to(a.children[0].children[0],1))},a.prototype.transform=function(a){this.addTouchedNodes(this.actor);var b=this.actor.is_group("power")?this.actor.children[1]:this.actor.children[0],c=this.getNewTreeNode(b),d=c.parent,e=d.is_group("power")?d.children[0]:d.get_radicand();return d.replace_with(e),x.handle(e,!0),this.updateNodeMap(b.parent,e),this.updateNodeMap(b,e),this.updateNodeMap(b.children[0],e),"function"!=typeof a||void a(this)};var b=new a;return I.prototype.add_action_handler(b),D.prototype.add_action_handler(b),b}(),Wa.actions.IndexInvertAction=function(){var a=function(a){p.call(this,"IndexInvertAction","invert an index across an equation"),this.triggerType="drag",this.settings={side:"around",extend_extreme_target_boxes:!0},a&&(this.nodes=a.nodes,this.target=a.target)};return Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(a){var b=this.matchSource(a);if(!b)return[];var c=this.getTargets(b);return this.bindActionForEachTarget(a,c)},a.prototype.matchSource=function(a){return 1===a.length&&(!!a[0].is_group("exponent","degree")&&(0!==E.get_value(a[0].children[0])&&(!(!a[0].parent.parent||!a[0].parent.parent.is_group("equals"))&&{nodes:a[0],idx_of_index_group:a[0].parent.get_idx(),equation:a[0].get_parent(2)})))},a.prototype.getTargets=function(a){return[a.equation.children[0===a.idx_of_index_group?2:0]]},a.prototype.transform=function(a){this.addTouchedNodes(this.nodes[0].get_root());var b=this.getSourceAndTarget(),c=this.getNewTreeNode(b.source),d=c.parent,e=this.getNewTreeNode(b.target);c.remove();var f=this.termIsEven(c.get_term()),g=this.wrapTermInIndexGroup(e,c,f);return this.updateNodeMap(b.source,g),this.cleanup(d),"function"!=typeof a||void a(this)},a.prototype.termIsEven=function(a){var b=fa.evalExpression(a);return Number.isNaN(b)?Ua?Ua.eval(Wa.termsToAlgebriteString(a)).toString()%2===0:null:b%2===0},a.prototype.wrapTermInIndexGroup=function(a,b,c){var d,e=a.parent,f=a.remove(),g=b.get_term();g.remove();var h;return b.is_group("exponent")&&Number.isInteger(E.get_value(g))&&E.get_value(g)>1?(d=new D(a,g),h=d.get_degree()):(d=new I(a,g),b.is_group("exponent")&&J.convert_to_reciprocal(g),x.handle(d.children[1].children[0],!0),h=d.children[1]),c&&(d=new Q(d,!0)),e.insert(f,d),h},new a}(),fa.prototype.move_actions.push(Wa.actions.IndexInvertAction),Wa.actions.IndexFormConversionAction=function(){var a=function(a){p.call(this,"IndexFormConversionAction","convert a power or radical to its other representation"),this.priority=0,this.triggerType="drag",this.settings={delay:1500,on_release:!0,reset_y:!0},a&&(this.nodes=a.nodes,this.target=a.target,this.settings.side=this.target.is_group("radical")?"right-of":"left-of",this.settings.margin=this.target.is_group("radical")?{x2:-.4,y2:.7,y1:-.4}:{x1:-.4,y2:.5,y1:-.2})};return Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(a){return this.matchSource(a)?this.bindActionForEachTarget(a,[a[0].parent]):[]},a.prototype.matchSource=function(a){return 1===a.length&&(a[0].is_group("degree")||a[0].is_group("exponent"))},a.prototype.transform=function(a){this.addTouchedNodes(this.target);var b=this.getNewTreeNode(this.nodes)[0],c=b.parent,d=c.is_group("radical")?c.get_radicand():c.children[0],e=c.parent,f=c.remove();d.remove(),b.remove();var g=b.get_term();g.remove();var h=c.is_group("radical")?new M(g):new F(g);g=J.convert_to_reciprocal(g),x.handle(h.children[0],!0);var i=c.is_group("radical")?new I(d,h):new D(d,h);return e.insert(f,i),this.updateNodeMap(this.nodes[0],h),this.updateNodeMap(this.nodes[0].parent,i),"function"==typeof a&&a(this),this},new a}(),fa.prototype.move_actions.push(Wa.actions.IndexFormConversionAction),Wa.actions.IndexSimplifyAction=function(){var a=function(a){p.call(this,"IndexSimplifyAction","when the inverse index forms are nested and have the same index, they cancel"),this.settings={},this.interactionType="tap",a&&(this.actor=a.actor)};Wa.inherit(p,a),a.prototype.match=function(a){if(!a.is_group("power"))return!1;var b=a.children[0];if(!b.is_group("brackets")||!b.children[1].is_group("radical"))return!1;var c=b.children[1].get_degree_term(),d=a.get_exponent_term();return c.to_ascii()===d.to_ascii()},a.prototype.match=function(a){var b,c;if(a.is_group("power")){var d=a.children[0];if(!d.is_group("brackets")||!d.children[1].is_group("radical"))return!1;b=d.children[1].get_degree_term(),c=a.get_exponent_term()}else if(a.is_group("radical")){var e=a.get_radicand();if(!e.is_group("power"))return!1;b=a.get_degree_term(),c=e.get_exponent_term()}return b&&c&&b.to_ascii()===c.to_ascii()},a.prototype.isGreaterOrEqualsZero=function(a){var b=fa.evalExpression(a);return Number.isNaN(b)?Ua?(b=Ua.run(Wa.termsToAlgebriteString(a)+" >= 0"),"1"===b||"0"!==b&&null):null:b>=0},a.prototype.transform=function(a){this.addTouchedNodes(this.actor);var b=this.getNewTreeNode(this.actor),c=b.is_group("power")?b.get_child([0,1]):b.get_radicand(),d=c.is_group("power")?c.children[0]:c.get_radicand(),e=E.get_value(b.is_group("power")?b.get_exponent_term():b.get_degree_term());if(e%2===0){b.replace_with(d);var f=d.parent,g=d.remove(),h=new y(d);f.insert(g,h)}else if(e%2===1)b.replace_with(d);else if(d.select_first(function(a){return L.is_var(a)}))b.replace_with(d),this.settings.restraint=d.to_ascii()+" must be ≥ 0.";else{var i=this.isGreaterOrEqualsZero(d);(i||null===i)&&b.replace_with(d),i===!1&&(this.settings.restraint=d.to_ascii()+" can't be < 0."),null===i&&(this.settings.restraint=d.to_ascii()+" must be ≥ 0.")}return x.handle(d,!0),"function"!=typeof a||void a(this)};var b=new a;return D.prototype.add_action_handler(b),I.prototype.add_action_handler(b),b}(),function(){var a=function(a){p.call(this,"CommutativeGroupCleanup","group cleanup action"),a&&(this.group=a.actor)};Wa.inherit(p,a),Wa.actions.CommutativeGroupCleanup=a,a.prototype.match=function(a){return a.is_group()&&(!a.has_children()||1===a.children.length)},a.prototype.doInPlace=function(a){this.initNodeMap();var b=this.getNewTreeNode(this.group);if(0===b.children.length)Va.remove(b);else if(1===b.children.length){var c=b.children[0],d=this.group.children[0],e=c.children[1];this.updateNodeMap(d.children[0],e),this.updateNodeMap(d,e),this.updateNodeMap(d.parent,e),Va.replace(c.parent,e),e.parent.parent&&x.handle(e.parent,!0),x.handle(e,!0)}return"function"!=typeof a?this:void a(this)},B.prototype.cleanupAction=new a,z.prototype.cleanupAction=new a}(),Wa.actions.SignDoubleNegAction=function(){var a=function(a){p.call(this,"SignDoubleNegAction","--x=x"),this.priority=0,this.triggerType="tap",a&&(this.actor=a.actor)};return Wa.inherit(p,a),a.prototype.match=function(a){return!(!a.is_group("sign")||!a.children[1].is_group("sign"))||!(!a.is_group("sign")||!a.parent.is_group("sign"))},a.prototype.transform=function(a){var b=this.getNewTreeNode(this.actor);return b.children[1].is_group("sign")?(this.addTouchedNodes(this.actor.children[0]),this.addTouchedNodes(this.actor.children[1].children[0]),Va.replace(b,b.children[1].children[1])):b.parent.is_group("sign")&&(this.addTouchedNodes(this.actor.parent.children[0]),this.addTouchedNodes(this.actor.children[0]),Va.replace(b.parent,b.children[1])),"function"!=typeof a||void a(this)},Q.prototype.add_action_handler(new a),new a}(),function(){var a=function(a){p.call(this,"SignZeroAction","-0=0"),this.priority=0,this.triggerType="tap",a&&(this.actor=a.actor)};Wa.inherit(p,a),a.prototype.match=function(a){return a.children[1]instanceof E&&0===a.children[1].value},a.prototype.transform=function(a){var b=this.getNewTreeNode(this.actor),c=b.children[1];return this.addTouchedNodes(this.actor),this.updateNodeMap(this.actor.get_mapping_to(c)),Va.replace(b,c),"function"!=typeof a?this:void a(this)},Q.prototype.add_action_handler(new a)}(),Wa.actions.MoveSignIntoBracketsAction=function(){var a=function(a){p.call(this,"MoveSignIntoBracketsAction","move sign into brackets"),this.priority=0,this.triggerType="tap",a&&(this.actor=a.actor)};return Wa.inherit(p,a),a.prototype.match=function(a){if(!a.is_group("sign"))return!1;if(!a.children[1].is_group("brackets"))return!1;var b=a.children[1].children[1];return b.is_group("product","sum")},a.prototype.transform=function(a){this.addTouchedNodes(this.actor);var b=this.getNewTreeNode(this.actor),c=b.children[1],d=c.children[1],e=b.parent,f=b.remove();return c.remove(),d.remove(),d.is_group("product")?this.applySignToProductFraction(d,b):this.applySignToSum(d,b),e.insert(f,d),this.cleanup(d),x.handle(d),this.cleanup(e),"function"!=typeof a||void a(this)},a.prototype.applySignToProductFraction=function(a,b){var c=a.children[0].children[1];c.remove(),b.append(c),a.children[0].append(b),c.is_group("sign")&&(this.followup=Wa.actions.SignDoubleNegAction.createBoundAction(this.newTree,{actor:b}))},a.prototype.applySignToSum=function(a,b){a.children.forEach(function(a){a.invert()})},Q.prototype.add_action_handler(new a),new a}(),function(){var a=function(a){p.call(this,"CalculatePowerAction","calculate a power"),this.priority=0,this.triggerType="tap",a&&(this.actor=a.actor)};Wa.inherit(p,a),a.prototype.match=function(a){var b=a;if(b.is_group("power")||(b=a.parent),!b.is_group("power"))return!1;var c=b.children[0],d=b.get_exponent_term();return c.is_group("brackets")&&(c=c.children[1]),!!E.is_num(c)&&(!(!E.is_num(d)||E.is_equal_to(d,0))&&!(Math.round(E.get_value(d))!==E.get_value(d)&&E.get_value(c)<0))},a.prototype.transform=function(a){var b=this.getNewTreeNode(this.actor),c=b;c.is_group("power")||(c=c.parent);var d=c.children[0],e=c.children[1].children[0];this.addTouchedNodes(this.getOldTreeNode(c)),d.is_group("brackets")&&(d=d.children[1]),e.is_group("brackets")&&(e=e.children[1]);var f=new E(Math.pow(E.get_value(d),E.get_value(e)));return this.updateNodeMap(this.actor.parent.get_mapping_to(f)),Va.replace(c,f),"function"!=typeof a||void a(this)},M.prototype.add_action_handler(new a),I.prototype.add_action_handler(new a)}(),function(){var a=function(a){p.call(this,"PowerCleanup","power cleanup action"),a&&(this.actor=a.actor)};Wa.inherit(p,a),a.prototype.match=function(b){return!!a.powerWithoutExponent(b)},a.powerWithoutExponent=function(a){return!(!a.is_group("power")||1!==a.children.length)},a.prototype.doInPlace=function(b){this.initNodeMap();var c=this.getNewTreeNode(this.actor),d=c.parent;this.actor.parent;if(a.powerWithoutExponent(c)){var e=c.children[0],f=(this.getOldTreeNode(e),Va.remove(c));this.updateNodeMap(this.actor,d),d.insert(f,e)}return"function"!=typeof b?this:void b(this)},I.prototype.cleanupAction=new a}(),function(){var a=function(a){p.call(this,"xToZeroAction","x^0=1"),this.priority=0,this.triggerType="tap",a&&(this.actor=a.actor)};Wa.inherit(p,a),a.prototype.match=function(a){return a.children[0]instanceof E&&0===a.children[0].value&&"0"!==a.ls.to_ascii()},a.prototype.transform=function(a){var b=this.getNewTreeNode(this.actor);this.addTouchedNodes(this.actor.parent);var c=new E(1);return this.updateNodeMap(this.actor.parent.get_mapping_to(c)),Va.replace(b.parent,c),"function"!=typeof a||void a(this)},M.prototype.add_action_handler(new a)}(),Wa.actions.CollectExponentsForFactoring=function(){var a=function(a){p.call(this,"CollectExponentsForFactoring","collect exponents"),this.settings={makes_no_changes:!0,side:"inside"},a&&(this.nodes=a.nodes,this.target=a.target)};return Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(a){var b=a[0].get_root(),c=this;try{var d=this.analyzeNodeStructure(a);if(0===d.length)return[];for(var e=d[0].prod,f=[],g=0;g<e.children.length;g++)try{var h=e.get_child([g,1,1]),i=this.getTargetRangesInExponent(h,d);i.forEach(function(d){f.push(c.createBoundAction(b,{nodes:a,target:d[0].is_group("product")?[d[0].parent.parent]:d}))})}catch(a){if("invalid path"!==a)throw a}return f}catch(a){if("invalid path"!==a&&"wrong structure"!==a)throw a}return[]},a.prototype.transform=function(a){var b=this.getNewTreeNode(this.nodes[0]),c=this.getNewTreeNode(this.target);return this.updateNodeMap(this.nodes[0],[b].concat(c)),"function"!=typeof a||void a(this)},a.prototype.analyzeNodeStructure=function(a){var b=fa.groupNodeRanges(a);if(0===b.length)return[];for(var c=b.map(function(a){if(1===a.length&&a[0].is_group("exponent")){var b=a[0].children[0];return x.areHidden(b)&&(b=b.children[1]),{range:a,exp:a[0],prod:a[0].get_parent(3),ascii:b.to_ascii()}}if(!a.every(function(a){return a.is_group("mul","div")}))throw"wrong structure";return{range:a,exp:a[0].get_parent(3),prod:a[0].get_parent(6),ascii:fa.rangeToAsciiNoLeadingOp(a,!0)}}),d=0;d<c.length;d++){var e=c[d];if(e.ascii!==c[0].ascii)return[];if(!e.exp.is_group("exponent"))return[];if(!e.prod.is_group("fraction","product")||e.prod!==c[0].prod)return[];for(var f=d+1;f<c.length;f++)if(e.exp===c[f].exp)return[]}return c},a.prototype.getTargetRangesInExponent=function(a,b){var c=a.get_root();if(!a.is_group("exponent"))return[];for(var d=b[0].ascii,e=0;e<b.length;e++)if(b[e].exp===a)return[];var f=c.getRanges(d,null,a.children);return 0===f.length?[]:(f=f.filter(function(b){var c=b[0];return c.parent===a||c.parent.is_group("brackets")&&c.ls.hidden&&c.get_parent(2)===a||c.is_group("mul","div")&&c.get_parent(3)===a||c.parent.is_group("mul")&&c.get_parent(4)===a}),f.map(function(a){return 1===a.length&&a[0].parent.is_group("exponent","mul")?[a[0].parent]:a}))},new a}(),fa.prototype.move_actions.push(Wa.actions.CollectExponentsForFactoring),Wa.actions.FactorPowerAction=function(){var a=function(a){p.call(this,"FactorPowerAction","factor power"),this.interactionType="drag",this.settings={side:"outside",reset_y:!0},a&&(this.nodes=a.nodes,this.target=a.target,a.margin&&(this.settings.margin=a.margin))};return Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(a){var b,c=this.getEncompassingRange(a);if(this.thereIsALonePower(a)){if(this.transformationWouldLeaveExponentOfOne(a))return[];b=this.bindActionForLonePowerCases(a,c.length-1)}else{if(!(c.length>0))return[];b=this.bindActionForMultiplePowerCases(a,c)}return b},a.prototype.transform=function(a){if(Array.isArray(this.target))for(var b=0;b<this.target.length;b++)this.addTouchedNodes(this.target[b]);else this.addTouchedNodes(this.target);var c,d=fa.groupNodeRanges(this.nodes),e=this.getNewTreeNode(this.nodes),f=fa.groupNodeRanges(e);return c=this.thereIsOneRange(f)?this.factorFromALonePower(e):this.factorFromMultiplePowers(f),this.mapOldRangesToNewRange(d,c),"function"!=typeof a||void a(this)},a.prototype.factorFromALonePower=function(a){var b=this.extractRangeFromExponent(a);return this.wrapTermInPower(b,a)},a.prototype.factorFromMultiplePowers=function(a){var b,c=this.getParentGroupOfPowers(a[0][0]);return b=this.productFractionHasUnaffectedTerms(c,a)?this.performTransformationWithUnaffectedTerms(a,c):this.performTransformationWithoutUnaffectedTerms(a,c)},a.prototype.productFractionHasUnaffectedTerms=function(a,b){return a.is_group("product")?a.children.length>b.length:a.children.length-1>b.length},a.prototype.performTransformationWithoutUnaffectedTerms=function(a,b){for(var c=0;c<a.length;c++)this.extractRangeFromExponent(a[c]);return this.wrapTermInPower(b,a[0])},a.prototype.performTransformationWithUnaffectedTerms=function(a,b){var c,d=this.getAffectedTerms(a),e=this.getIDXForFactoredStructure(d),f=this.putAffectedTermsIntoASeparateProduct(d);if(f.is_group("product"))b.insert(e,new K(f,b.is_group("fraction")&&e>b.get_top().length?"div":"mul"));else{var g=b.parent,h=b.remove(),i=K.prototype.createGroup();i.append(new K(b)),i.append(new K(f)),g.insert(h,i),this.cleanup(b),this.cleanup(i.children[0])}for(var j=0;j<a.length;j++)this.extractRangeFromExponent(a[j]);return c=this.wrapTermInPower(f,a[0])},a.prototype.getIDXForFactoredStructure=function(a){for(var b,c=0;c<a.length;c++){var d=a[c],e=d.parent.children.indexOf(d);b||0===b?e<b&&(b=e):b=e}return b},a.prototype.putAffectedTermsIntoASeparateProduct=function(a){var b=K.prototype.createGroup();a.forEach(function(a){a.remove()}),a.every(function(a){return a.is_group("div")})&&a.forEach(function(a){a.invert()});for(var c=0;c<a.length;c++)b.append(a[c]);return b},a.prototype.mapOldRangesToNewRange=function(a,b){for(var c=0;c<a.length;c++)for(var d=a[c],e=0;e<d.length;e++)d[e].is_group("exponent")?this.updateNodeMap(d[e].get_mapping_to(b)):d[e].is_group("mul")&&(b.children[0].is_group("brackets")&&b.children[0].children[1].is_group("product")?this.updateNodeMap(d[e].get_mapping_to(b.children[0].children[1].children[e])):(this.updateNodeMap(d[e],b),this.newTree!==this.oldTree&&this.updateNodeMap(d[e].children[1],b.children[0])))},a.prototype.extractRangeFromExponent=function(a){if(a[0].is_group("exponent")){var b=a[0].parent.parent,c=a[0].parent,d=c.children[0],e=a[0],f=c.remove();return d.remove(),e.remove(),b.insert(f,d),d}var c=a[0].get_parent(4),e=c.children[1],g=e.children[0],h=g.children[1];return Va.remove_range(a),this.cleanup(h),c},a.prototype.wrapTermInPower=function(a,b){var c,d,e;a.parent.is_group("brackets")?(c=a.parent,d=c.parent,e=c.remove()):(d=a.parent,e=a.remove(),c=new x(a));var f,g;if(b[0].is_group("exponent"))f=b[0];else if(b[0].is_group("mul")&&1===b.length)f=b[0].children[1],f.remove(),f=new M(f);else{g=K.prototype.createGroup();for(var h=0;h<b.length;h++)g.append(b[h]);f=new M(g)}var i=new I(c,f);return c.is_group("brackets")&&(c.simplify=!0),d.insert(e,i),x.handle(i),g&&this.cleanup(g),f},a.prototype.getParentGroupOfPowers=function(a){return a.is_group("exponent")?a.parent.parent.parent:a.parent.parent.parent.parent.parent.parent},a.prototype.getAffectedTerms=function(a){for(var b=[],c=0;c<a.length;c++)b.push(this.getParentMulFromExponentTerm(a[c][0]));return b},a.prototype.getParentMulFromExponentTerm=function(a){return a.is_group("exponent")?a.parent.parent:a.parent.parent.parent.parent.parent},a.prototype.thereIsOneRange=function(a){return 1===a.length},a.prototype.thereIsALonePower=function(a){return 1===a.length&&a[0].is_group("exponent")||this.allNodesAreMulsWithinSameProduct(a)},a.prototype.transformationWouldLeaveExponentOfOne=function(a){if(!a[0].is_group("mul","div"))return!1;var b=a[0].parent;if(b.is_group("product")&&a.length+1===b.children.length){for(var c,d=0;d<b.children.length;d++){var e=b.children[d];if(a.indexOf(e)===-1){c=e;break}}if(1===E.get_value(e.children[1]))return!0}else if(b.is_group("fraction")&&a.every(function(a){return a.is_group("div")})){var f=b.get_top();if(1===f.length&&1===E.get_value(f[0].children[1]))return!0}return!1},a.prototype.allNodesAreMulsWithinSameProduct=function(a){for(var b,c=0;c<a.length;c++){var d=a[c];if(!d.is_group("mul","div"))return!1;if(b){if(d.parent!==b)return!1}else b=d.parent}return!0},a.prototype.bindActionForLonePowerCases=function(a,b){var c,d={all:-.5};try{var e=a[0];if(e.is_group("exponent")){var f=e.get_parent(2);if(!f.is_group("brackets")||f.parent.is_group("power"))return[];c=this.createBoundAction(e.get_root(),{nodes:a,target:f})}else{if(!e.is_group("mul","div"))return[];var g=e.get_parent(2),h=g.get_parent(1),i=h.get_parent(1),j=i.get_parent(1);if(!g.is_group("brackets")||!h.is_group("exponent")||!i.is_group("power"))return[];var k;if(j.is_group("brackets","mul","div"))if(j.is_group("brackets")&&!j.parent.is_group("power"))k=j;else if(j.is_group("mul","div")&&b>0)d.all=-1.5,k=j.parent;else{if(!(j.is_group("mul","div")&&b<=0))return[];k=i}else k=i;c=this.createBoundAction(e.get_root(),{nodes:a,target:k,margin:d?d:null})}}catch(a){if("invalid path"===a)return[];throw a}return[c]},a.prototype.bindActionForMultiplePowerCases=function(a,b){var c;if(0===b.length)return[];var d=this.getBestTarget(b);return c=[this.createBoundAction(a[0].get_root(),{nodes:a,target:d})]},a.prototype.getEncompassingRange=function(a){a[0].get_root();try{var b=this.analyzeNodeStructure(a);if(0===b.length)return[];for(var c=b[0].prod,d=[],e=0;e<c.children.length;e++)try{var f=c.get_child([e,1,1]),g=this.getTargetRangesInExponent(f,b);g.forEach(function(a){d=d.concat(a)})}catch(a){if("invalid path"!==a)throw a}return Va.nodes_to_range(d)}catch(a){if("invalid path"!==a&&"wrong structure"!==a)throw a}return[]},a.prototype.analyzeNodeStructure=function(a){var b=fa.groupNodeRanges(a);if(0===b.length)return[];for(var c=b.map(function(a){if(1===a.length&&a[0].is_group("exponent")){var b=a[0].children[0];return{range:a,exp:a[0],prod:a[0].get_parent(3),ascii:x.areHidden(b)?b.children[1].to_ascii():b.to_ascii()}}if(!a.every(function(a){return a.is_group("mul","div")}))throw"wrong structure";return{range:a,exp:a[0].get_parent(3),prod:a[0].get_parent(6),ascii:fa.rangeToAsciiNoLeadingOp(a,!0)}}),d=0;d<c.length;d++){var e=c[d];if(e.ascii!==c[0].ascii)return[];if(!e.exp.is_group("exponent"))return[];if(!e.prod.is_group("fraction","product")||e.prod!==c[0].prod)return[];for(var f=d+1;f<c.length;f++)if(e.exp===c[f].exp)return[]}return c},a.prototype.getTargetRangesInExponent=function(a,b){var c=a.get_root();if(!a.is_group("exponent"))return[];var d=b[0].ascii,e=c.getRanges(d,null,a.children);return 0===e.length?[]:(e=e.filter(function(b){var c=b[0];return c.parent===a||c.parent.is_group("brackets")&&c.ls.hidden&&c.get_parent(2)===a||c.is_group("mul","div")&&c.get_parent(3)===a||c.parent.is_group("mul","div")&&c.get_parent(4)===a}),e.map(function(a){if(1===a.length){if(a[0].is_group("fraction")&&x.areHidden(a[0].parent)&&a[0].get_parent(2).is_group("exponent"))return[a[0].get_parent(2)];if(a[0].parent.is_group("exponent","mul"))return[a[0].parent]}return a}))},a.prototype.getBestTarget=function(a){var b,c=a[0].parent;if(c.is_group("product")&&c.children.length>a.length||c.is_group("fraction")&&c.children.length-1>a.length)b=a;else{var d=a[0].parent.parent;b=d.is_group("brackets")&&!x.areHidden(d)?d:a[0].parent}return b},new a}(),fa.prototype.move_actions.push(Wa.actions.FactorPowerAction),Wa.actions.DistributePowerAction=function(){var a=function(a){p.call(this,"DistributePowerAction","distribute power"),this.triggerType="drag",this.settings={side:"inside",reset_x:!0,reset_y:!0},a&&(this.nodes=a.nodes,this.target=a.target)};return Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(a){var b,c,d,e=a[0].get_root();try{if(this.nodesAreASingleExponent(a))d=a[0],c=d.parent,b=c.children[0];else{if(!this.nodesAreAllMulDivs(a)||!this.nodesAreAConsecutiveRange(a))return[];d=a[0].get_parent(3),c=d.get_parent(1),b=c.children[0]}}catch(a){if("invalid path"!==a)throw a;return[]}if(!d.is_group("exponent")||!c.is_group("power")||!b.is_group("brackets"))return[];var b=b.children[1];return!b.is_group()||b.is_group("power")||b.is_group("brackets")||b.is_group("product")||b.is_group("fraction")?[this.createBoundAction(e,{nodes:a,target:b})]:[]},a.prototype.transform=function(a){var b=this.getNewTreeNode(this.nodes[0].is_group("exponent")?this.nodes[0]:this.nodes[0].parent.parent.parent),c=this.getNewTreeNode(this.nodes),d=this.getNewTreeNode(this.target),e=b.parent,f=e.parent;this.addTouchedNodes(this.getOldTreeNode(e)),Va.remove_range(c);var g;if(d.is_group("product")||d.is_group("fraction")?(g=d.get_top().concat(d.get_bottom()),this.applyPowersToMulDivs(g,c)):(g=[this.applyPowerToSingleTerm(d,c)],d=g[0]),e.children[1])this.cleanup(e.children[1].children[0].children[1]),x.handle(e.children[1].children[0],!0);else{var h=e.remove(),i=new x(d);f.insert(h,i),i.simplify=!0}return"function"!=typeof a||void a(this)},a.prototype.nodesAreASingleExponent=function(a){return 1===a.length&&a[0].is_group("exponent")},a.prototype.nodesAreAllMulDivs=function(a){for(var b=0;b<a.length;b++)if(!a[b].is_group("mul","div"))return!1;return!0},a.prototype.nodesAreAConsecutiveRange=function(a){if(1===a.length)return!0;for(var b=a[0],c=1;c<a.length;c++){if(b.rs!==a[c]||b!==a[c].ls)return!1;b=a[c]}return!0},a.prototype.applyPowersToMulDivs=function(a,b){for(var c=0;c<a.length;c++){var d=a[c].children[1];this.applyPowerToSingleTerm(d,b)}},a.prototype.applyPowerToSingleTerm=function(a,b){var c;return c=a.is_group("power")?this.applyPowerToPower(a,b):this.applyPowerToNonPower(a,b)},a.prototype.applyPowerToPower=function(a,b){var c=a,d=Va.clone(b),e=this.extendPowerWithSelectedExponentTerms(c,d);return this.extendNodeMap(this.nodes[0],e),c},a.prototype.applyPowerToNonPower=function(a,b){var c,d;c=a.parent,d=a.remove();var e;if(b[0].is_group("exponent"))e=Va.clone(b[0]);else{var f=K.prototype.createGroup(),g=Va.clone(b);this.appendAllContentsToProduct(f,g),e=new M(f)}var h=new I(a,e);return c.insert(d,h),f&&(this.cleanup(f),x.handle(e.children[0],!0)),this.mapDraggedExponentTermsToNewExponent(this.nodes,h.children[1]),h},a.prototype.mapDraggedExponentTermsToNewExponent=function(a,b){for(var c=0;c<a.length;c++)a[c].is_group("exponent")?this.extendNodeMap(a[c].get_mapping_to(b)):b.children[0].is_group("brackets")&&b.children[0].children[1].is_group("product")?this.extendNodeMap(a[c].get_mapping_to(b.children[0].children[1].children[c])):(this.extendNodeMap(a[c],b),this.extendNodeMap(a[c].children[1].get_mapping_to(b.children[0])))},a.prototype.takeContentsOfBrackets=function(a){return a.is_group("brackets")&&(a=a.children[1],a.remove()),a},a.prototype.extendPowerWithSelectedExponentTerms=function(a,b){var c=a.children[1],d=K.prototype.createGroup(),e=this.getContentMulsFromExponent(c),f=b[0].is_group("exponent")?this.getContentMulsFromExponent(b[0]):b;return this.appendAllContentsToProduct(d,e),this.appendAllContentsToProduct(d,f),
c.append(d),this.cleanup(d),x.handle(d,!0),this.mapDraggedExponentTermsToNewExponentTerms(this.nodes,c,f),f},a.prototype.appendAllContentsToProduct=function(a,b){for(var c=0;c<b.length;c++)a.append(b[c])},a.prototype.mapDraggedExponentTermsToNewExponentTerms=function(a,b,c){if(a[0].is_group("mul"))for(var d=0;d<a.length;d++)this.extendNodeMap(a[d].get_mapping_to(c[d]));else if(a[0].is_group("exponent")){var e=a[0].children[0];if(e.is_group("brackets")&&e.children[1].is_group("product"))for(var d=0;d<e.children[1].children.length;d++){var f=e.children[1].children[d];this.extendNodeMap(a[0],c[d]),this.extendNodeMap(f.get_mapping_to(c[d]))}else e.is_group("brackets")&&!c[0].children[1].is_group("brackets")?this.extendNodeMap(e.children[1].get_mapping_to(c[0].children[1])):this.extendNodeMap(e.get_mapping_to(c[0].children[1]))}},a.prototype.getContentMulsFromExponent=function(a){var b=a.children[0];if(x.areHidden(b)&&b.children[1].is_group("product")){var c=b.children[1].children.slice();return Va.remove_range(b.children[1].children),b.remove(),c}if(x.areHidden(b)){var d=b.children[1];return d.remove(),b.remove(),[new K(d)]}return b.remove(),[new K(b)]},new a}(),fa.prototype.move_actions.push(Wa.actions.DistributePowerAction),Wa.actions.combineStackedExponentsUpAction=function(){var a=function(a){p.call(this,"combineStackedExponentsUpAction","combine stacked exponents up"),this.interactionType="drag",this.settings={side:"around",reset_y:!0},a&&(this.nodes=a.nodes,this.target=a.target)};return Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(a){if(a.length<1)return[];if(!this.validStructure(a))return[];var b=this.getBaseOfOuterPowerFromInnerExponentTerm(a),c=b.parent.children[1],d=[this.createBoundAction(a[0].get_root(),{nodes:a,target:c})];return d},a.prototype.transform=function(a){var b=this.getNewTreeNode(this.nodes),c=this.getNewTreeNode(this.target),d=c.parent.children[0];this.addTouchedNodes(this.target.parent),this.extractSelectedExponentTermsFromInnerPower(b);var e=this.extendOuterExponentWithSelectedExponentTerms(d,b);return this.mapSelectedExponentsTermsToNewExponentTerms(this.nodes,e),d.simplify=!0,"function"!=typeof a||void a(this)},a.prototype.validStructure=function(a){return this.nodesAreASingleExponent(a)?this.termsBelongToAPowerWithinAPower(a):!(!this.nodesAreAllMulDivs(a)||!this.nodesAreAConsecutiveRange(a))&&this.termsBelongToAPowerWithinAPower(a)},a.prototype.nodesAreASingleExponent=function(a){return 1===a.length&&a[0].is_group("exponent")},a.prototype.nodesAreAllMulDivs=function(a){for(var b=0;b<a.length;b++)if(!a[b].is_group("mul","div"))return!1;return!0},a.prototype.nodesAreAConsecutiveRange=function(a){if(1===a.length)return!0;for(var b=a[0],c=1;c<a.length;c++){if(b.rs!==a[c]||b!==a[c].ls)return!1;b=a[c]}return!0},a.prototype.termsBelongToAPowerWithinAPower=function(a){try{var b,c,d,e;if(a[0].is_group("exponent")){if(b=a[0],c=b.get_parent(1),d=c.get_parent(1),e=d.get_parent(1),!c.is_group("power")||!d.is_group("brackets")||!e.is_group("power"))return!1}else if(b=a[0].get_parent(3),c=b.get_parent(1),d=c.get_parent(1),e=d.get_parent(1),!(b.is_group("exponent")&&c.is_group("power")&&d.is_group("brackets")&&e.is_group("power")))return!1}catch(a){if("invalid path"!==a)throw a;return!1}return!0},a.prototype.getBaseOfOuterPowerFromInnerExponentTerm=function(a){return a[0].is_group("exponent")?a[0].get_parent(2):a[0].get_parent(5)},a.prototype.extractSelectedExponentTermsFromInnerPower=function(a){if(a[0].is_group("exponent")){var b=a[0].parent,c=a[0],d=b.children[0],e=b.parent,f=b.remove();d.remove(),c.remove(),e.insert(f,d)}else{var g=a[0].parent;g.parent;Va.remove_range(a),this.cleanup(g)}},a.prototype.extendOuterExponentWithSelectedExponentTerms=function(a,b){var c=a.parent,d=c.children[1],e=K.prototype.createGroup(),f=this.getContentMulsFromExponent(d),g=b[0].is_group("exponent")?this.getContentMulsFromExponent(b[0]):b;if(g.some(function(a){return a.is_group("mul")})&&g.some(function(a){return a.is_group("div")})){var h=K.prototype.createGroup();this.appendAllContentsToProduct(h,g),g=[new K(h)]}return this.appendAllContentsToProduct(e,f),this.appendAllContentsToProduct(e,g),d.append(e),this.cleanup(e),x.handle(e),g},a.prototype.appendAllContentsToProduct=function(a,b){for(var c=0;c<b.length;c++)a.append(b[c])},a.prototype.getContentMulsFromExponent=function(a){var b=a.children[0];if(x.areHidden(b)&&b.children[1].is_group("product","fraction")){var c=b.get_child([1]),d=c.get_top().concat(c.get_bottom());return Va.remove_range(b.children[1].children),b.remove(),d}if(x.areHidden(b)){var e=b.children[1];return e.remove(),b.remove(),[new K(e)]}return b.remove(),[new K(b)]},a.prototype.mapSelectedExponentsTermsToNewExponentTerms=function(a,b){for(var c=0;c<a.length;c++)for(var d=0;d<b.length;d++)0===d?this.updateNodeMap(a[c],b[d]):this.extendNodeMap(a[c],b[d])},new a}(),fa.prototype.move_actions.push(Wa.actions.combineStackedExponentsUpAction),Wa.actions.PowerFactorAndCombineStackedExponentsAction=function(){var a=function(a){p.call(this,"PowerFactorAndCombineStackedExponentsAction","factor power and combine stacked exponent up"),this.triggerType="drag",this.settings={side:"inside"},a&&(this.nodes=a.nodes,this.target=a.target)};return Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(a){if(a.length<2)return[];var b=Wa.actions.FactorPowerAction.getAllAvailableActions(a);if(0===b.length)return[];var c=b[0];if(Array.isArray(c.target))return[];if(!c.target.is_group("brackets"))return[];if(!this.nodesAccountForEveryTermInProduct(c.target.children[1],a))return[];if(!c.target.parent.is_group("power"))return[];var d=c.target.parent.children[1],e=this.createBoundAction(a[0].get_root(),{nodes:a,target:d});return[e]},a.prototype.nodesAccountForEveryTermInProduct=function(a,b){for(var c=[],d=0;d<b.length;d++){for(var e=b[d].parent;!e.is_group("power")&&!fa.is_top_most(e);)e=e.parent;c.every(function(a){return a!==e})&&c.push(e)}return c.length===a.get_top().concat(a.get_bottom()).length},a.prototype.doInPlace=function(a){this.initNodeMap();var b=this.target.parent;this.addTouchedNodes(b);var c=this.getNewTreeNode(this.nodes),d=Wa.actions.FactorPowerAction.getAllAvailableActions(c)[0];d.doInPlace(),this.compose(d);var e=d.mapNodes(c),f=Wa.actions.combineStackedExponentsUpAction.getAllAvailableActions(e)[0];return f.doInPlace(),this.compose(f),b=this.mapNodes(b)[0],x.handle(b.children[0],!0),this.removeDeletedNodesFromNodeMap(),"function"!=typeof a||void a(this)},new a}(),fa.prototype.move_actions.push(Wa.actions.PowerFactorAndCombineStackedExponentsAction),function(){var a=function(a){p.call(this,"polynomialExpansionAction","polynomial expansion"),this.priority=0,this.triggerType="dbltap",a&&(this.actor=a.actor)};Wa.inherit(p,a),a.prototype.match=function(a){if(!a.is_group("exponent"))return!1;if(!a.children[0]||!E.is_num(a.children[0]))return!1;if(2!==E.get_value(a.children[0])&&3!==E.get_value(a.children[0]))return!1;var b=a.parent,c=b.children[0];return!!c.is_group("brackets")&&!!c.children[1].is_group("sum")},a.prototype.transform=function(a){var b=this.getNewTreeNode(this.actor);this.addTouchedNodes(this.actor);var c=b.parent,d=this.analyzeStructure(b),e=this.formAddendsForExpandedPolynomial(d);return e.sort(function(a,b){return a.firstOrder===b.firstOrder&&a.degreeOfFirstOrder>=b.degreeOfFirstOrder?0:a.firstOrder===b.firstOrder&&a.degreeOfFirstOrder<b.degreeOfFirstOrder?1:a.firstOrder<b.firstOrder?-1:a.firstOrder>b.firstOrder?1:void 0}),this.replacePowerWithExpandedPolynomialSum(c,e),"function"!=typeof a||void a(this)},a.prototype.analyzeStructure=function(a){var b={},c=a.parent,d=c.children[0],e=d.children[1];return b.degree=E.get_value(a.children[0]),b.terms=e.children.slice(),b},a.prototype.formAddendsForExpandedPolynomial=function(a){var b;return 2===a.degree?b=this.formAddendsForDegreeOfTwo(a.terms):3===a.degree&&(b=this.formAddendsForDegreeOfThree(a.terms)),b},a.prototype.formAddendsForDegreeOfTwo=function(a){for(var b=[],c=0;c<a.length;c++){var d=a[c].children[1],e=Va.clone(d);this.extendNodeMap(this.getOldTreeNode(d).get_mapping_to(e));var f={};f.addend=new v(new I(e,new E(2))),f.firstOrder=c,f.degreeOfFirstOrder=2,b.push(f)}for(var c=0;c<a.length-1;c++)for(var g=c+1;g<a.length;g++){var h=K.prototype.createGroup();h.append(new K(new E(2)));var i=0,j=a[c].children[1],k=Va.clone(j);this.extendNodeMap(this.getOldTreeNode(j).get_mapping_to(k)),a[c].is_group("sub")&&(i=(i+1)%2);var l=a[g].children[1],m=Va.clone(l);this.extendNodeMap(this.getOldTreeNode(l).get_mapping_to(m)),a[g].is_group("sub")&&(i=(i+1)%2),1!==E.get_value(k)&&h.append(new K(k)),1!==E.get_value(m)&&h.append(new K(m));var f={};f.addend=new v(h,i?"sub":"add"),f.firstOrder=c,f.degreeOfFirstOrder=1,b.push(f)}return b},a.prototype.formAddendsForDegreeOfThree=function(a){for(var b=[],c=0;c<a.length;c++){var d=a[c].children[1],e=Va.clone(d);this.extendNodeMap(this.getOldTreeNode(d).get_mapping_to(e));var f={};f.addend=new v(new I(e,new E(3)),a[c].value),f.firstOrder=c,f.degreeOfFirstOrder=3,b.push(f)}for(var c=0;c<a.length-1;c++)for(var g=c+1;g<a.length;g++){var h=a[c].children[1],i=a[g].children[1],j=Va.clone(h),k=Va.clone(i);this.extendNodeMap(this.getOldTreeNode(h).get_mapping_to(j)),this.extendNodeMap(this.getOldTreeNode(i).get_mapping_to(k));var l=K.prototype.createGroup();l.append(new K(new E(3))),l.append(new K(new I(j,new E(2)))),1!==E.get_value(k)&&l.append(new K(k));var m={};m.addend=new v(l,i.parent.value),m.firstOrder=c,m.degreeOfFirstOrder=2,b.push(m);var n=Va.clone(h),o=Va.clone(i);this.extendNodeMap(this.getOldTreeNode(h).get_mapping_to(n)),this.extendNodeMap(this.getOldTreeNode(i).get_mapping_to(o));var p=K.prototype.createGroup();p.append(new K(new E(3))),1!==E.get_value(n)&&p.append(new K(n)),p.append(new K(new I(o,new E(2))));var q={};q.addend=new v(p,h.parent.value),q.firstOrder=c,q.degreeOfFirstOrder=1,b.push(q)}for(var c=0;c<a.length-2;c++)for(var g=c+1;g<a.length-1;g++)for(var r=g+1;r<a.length;r++){var h=a[c].children[1],i=a[g].children[1],s=a[r].children[1],t=Va.clone(h),u=Va.clone(i),w=Va.clone(s);this.extendNodeMap(this.getOldTreeNode(h).get_mapping_to(t)),this.extendNodeMap(this.getOldTreeNode(i).get_mapping_to(u)),this.extendNodeMap(this.getOldTreeNode(s).get_mapping_to(w));var x=K.prototype.createGroup();x.append(new K(new E(6))),1!==E.get_value(t)&&x.append(new K(t)),1!==E.get_value(u)&&x.append(new K(u)),1!==E.get_value(w)&&x.append(new K(w));var y=0;a[c].is_group("sub")&&(y=(y+1)%2),a[g].is_group("sub")&&(y=(y+1)%2),a[r].is_group("sub")&&(y=(y+1)%2);var f={};f.addend=new v(x,y?"sub":"add"),f.firstOrder=c,f.degreeOfFirstOrder=1,b.push(f)}return b},a.prototype.replacePowerWithExpandedPolynomialSum=function(a,b){for(var c=a.parent,d=a.remove(),e=v.prototype.createGroup(),f=0;f<b.length;f++)e.append(b[f].addend);c.insert(d,e),this.applyPowers(b),this.cleanupAddends(b),x.handle(e,!0),this.cleanup_cascade(e.parent)},a.prototype.applyPowers=function(a){for(var b=0;b<a.length;b++){var c=a[b].addend?a[b].addend.children[1]:a[b].children[1];c.is_group("power")?this.applyPower(a[b].addend?a[b].addend:a[b]):c.is_group("product")&&this.applyPowers(c.children.slice())}},a.prototype.applyPower=function(a){var b=a.children[1],c=(b.children[0],b.children[1]),d=Wa.actions.DistributePowerAction.getAllAvailableActions([c]);if(d.length>0&&(d[0].doInPlace(),this.compose(d[0],!1),a.children[1].is_group("brackets"))){var e=a.children[1].children[1];e.remove(),a.children[1].remove(),a.append(e)}for(var f=d[0]?d[0].mapNodes(c):[c],g=0;g<f.length;g++){var h=f[g].getBestMatchingAction();if(h&&"polynomial expansion"!==h.name){var i=h.createBoundAction(this.newTree,{actor:f[g]});i.doInPlace(),this.compose(i,!1)}}},a.prototype.cleanupAddends=function(a){for(var b=0;b<a.length;b++)if(a[b].addend.children[1].is_group("product"))for(var c=a[b].addend.children[1].children.slice(),d=0;d<c.length;d++)this.cleanup(c[d])},M.prototype.add_action_handler(new a)}(),Wa.actions.LogarithmExtractExponentOfArgumentAction=function(){var a=function(a){p.call(this,"LogarithmExtractExponentOfArgumentAction","move the exponent of the argument outside of the logarithm"),this.priority=1,this.triggerType="drag",this.settings={target_group:!0,group_side:"outside",reset_y:!0},a&&(this.nodes=a.nodes,this.target=a.target,this.settings.side=a.side)};return Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(a){var b=this.matchSource(a);if(!b)return[];var c=this.getTargets(b);return this.bindActionForEachTarget(a,c,!0)},a.prototype.matchSource=function(a){if(1!==a.length)return!1;var b=a[0];if(!b.is_group("exponent","degree"))return!1;var c=b.get_parent(2);return!!c.is_group("param")&&(c=c.get_parent(3),!!N.Logs.is_log_func(c)&&{nodes:a,tuple:b.get_parent(3)})},a.prototype.getTargets=function(a){return[a.tuple]},a.prototype.transform=function(a){this.addTouchedNodes(this.target.parent);var b=this.getNewTreeNode(this.nodes),c=b[0].parent,d=b[0].get_parent(5),e=d.parent,f=d.remove();Va.remove_range(b);var g=b[0].children[0],h=!1;x.areHidden(g)&&J.is_fraction_with_identity_numerator(g.children[1])?(g=g.children[1].get_bottom(),Va.remove_range(g),b[0].is_group("degree")&&g.forEach(function(a){a.invert()}),h=!0):x.areHidden(g)&&g.children[1].is_group("product")&&(g=g.children[1].children.slice(),Va.remove_range(g),b[0].is_group("degree")&&g.forEach(function(a){a.invert()}),h=!0);var i=new J;i.append(new K(d));var j=h?g:[new K(g,b[0].is_group("degree")?"div":"mul")];return j[0].is_group("div")?j.forEach(i.append.bind(i)):i.insert_range("left-of"===this.settings.side?0:1,j),e.insert(f,i),h||x.handle(j[0].children[1],!0),this.updateNodeMap(this.nodes[0],j),this.cleanup(c),this.cleanup_cascade(e),x.handle(d.get_arg(),!0),"function"==typeof a&&a(this),this},new a}(),fa.prototype.move_actions.push(Wa.actions.LogarithmExtractExponentOfArgumentAction),Wa.actions.LogarithmEvaluateAction=function(){var a=function(a){p.call(this,"LogarithmEvaluateAction","move the exponent of the argument outside of the logarithm"),this.priority=1,this.triggerType="tap",this.settings={},a&&(this.actor=a.actor)};return Wa.inherit(p,a),a.prototype.match=function(a){if(!N.Logs.is_log_func(a))return!1;var b=N.Logs.get_log_base(a),c=a.get_arg();return!!c.is_leaf_node&&(N.Logs.within_domain(c)&&N.Logs.within_domain(b))},a.prototype.transform=function(a){this.addTouchedNodes(this.actor);var b=this.getNewTreeNode(this.actor),c=new E(N.Logs.evaluate(b));return Va.replace(b,c),this.actor.map_to_group(this,c),"function"==typeof a&&a(this),this},N.prototype.add_action_handler(new a),new a}(),Wa.actions.LogarithmEvaluateSameArgAsBaseAction=function(){var a=function(a){p.call(this,"LogarithmEvaluateSameArgAsBaseAction","move the exponent of the argument outside of the logarithm"),this.priority=1,this.triggerType="tap",this.settings={},a&&(this.actor=a.actor)};return Wa.inherit(p,a),a.prototype.match=function(a){if(!N.Logs.is_log_func(a))return!1;var b=N.Logs.get_log_base(a),c=a.get_arg();return b.to_ascii()===c.to_ascii()},a.prototype.transform=function(a){this.addTouchedNodes(this.actor);var b=this.getNewTreeNode(this.actor),c=new E(1);return Va.replace(b,c),this.actor.map_to_group(this,c),"function"==typeof a&&a(this),this},N.prototype.add_action_handler(new a),new a}(),Wa.actions.LogarithmInvertAction=function(){var a=function(a){p.call(this,"LogarithmInvertAction","move the exponent of the argument outside of the logarithm"),this.priority=1,this.triggerType="drag",this.settings={side:"around",reset_y:!0},a&&(this.nodes=a.nodes,this.target=a.target)};return Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(a){var b=this.matchSource(a);if(!b)return[];var c=this.getTargets(b);return this.bindActionForEachTarget(a,c)},a.prototype.matchSource=function(a){if(1!==a.length)return!1;var b=a[0];if(!b.parent||!N.Logs.is_log_func(b.parent.parent)||N.Logs.get_log_base(b.parent.parent)!==b)return!1;var c=b.get_parent(3);return!!c.is_group("equals")&&{nodes:a,func:b.get_parent(2)}},a.prototype.getTargets=function(a){var b=a.func.parent,c=0===a.func.get_idx()?2:0;return[b.children[c]]},a.prototype.transform=function(a){this.addTouchedNodes(this.target.parent);var b=this.getNewTreeNode(this.nodes)[0],c=this.getNewTreeNode(this.target),d=b.get_parent(2),e=d.get_arg(),f=c.parent;d.replace_with(e);var g=c.remove(),h=new I(b,c);return f.insert(g,h),this.setNodesToReselectAfterAction(h),"function"==typeof a&&a(this),this},new a}(),fa.prototype.move_actions.push(Wa.actions.LogarithmInvertAction),Wa.actions.LogSimplifyAction=function(){var a=function(a){p.call(this,"LogSimplifyAction","simplify a log with a power as the argument"),this.priority=0,this.triggerType="tap",this.settings={},a&&(this.actor=a.actor)};return Wa.inherit(p,a),a.prototype.match=function(a){if(!N.Logs.is_log_func(a))return!1;var b=N.Logs.get_log_base(a),c=a.get_arg();return!!c.is_group("power")&&b.to_ascii()===c.children[0].to_ascii()},a.prototype.transform=function(a){this.addTouchedNodes(this.actor);var b=this.getNewTreeNode(this.actor),c=b.get_arg().get_exponent_term();return b.replace_with(c),x.handle(c),this.cleanup_cascade(c.parent),"function"==typeof a&&a(this),this},N.prototype.add_action_handler(new a),new a}(),Wa.actions.LogSimplifyPowerAction=function(){var a=function(a){p.call(this,"LogSimplifyPowerAction","simplify a power with a log exponent"),this.priority=0,this.triggerType="tap",this.settings={},a&&(this.actor=a.actor)};return Wa.inherit(p,a),a.prototype.match=function(a){if(!N.Logs.is_log_func(a))return!1;if(!a.parent.is_group("exponent"))return!1;var b=a.get_parent(2).children[0],c=N.Logs.get_log_base(a);return c.to_ascii()===b.to_ascii()},a.prototype.transform=function(a){this.addTouchedNodes(this.actor);var b=this.getNewTreeNode(this.actor),c=b.get_arg(),d=b.get_parent(2);return d.replace_with(c),x.handle(c),this.cleanup_cascade(c.parent),"function"==typeof a&&a(this),this},N.prototype.add_action_handler(new a),new a}(),Wa.actions.LogarithmSplitAction=function(){var a=function(a){p.call(this,"LogarithmSplitAction","turn a log into a sum of logs"),this.priority=1,this.triggerType="drag",this.settings={target_group:!0,group_side:"outside"},a&&(this.nodes=a.nodes,this.target=a.target,this.settings.side=a.side)};return Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(a){var b=this.matchSource(a);if(!b)return[];var c=this.getTargets(b);return this.bindActionForEachTarget(a,c,!0)},a.prototype.matchSource=function(a){if(!Va.is_range(a))return!1;var b=a[0];if(!b.is_group("mul","div"))return!1;var c=b.get_parent(2);return!!c.is_group("param")&&(c=c.get_parent(3),!!N.Logs.is_log_func(c)&&{nodes:a,tuple:b.get_parent(3)})},a.prototype.getTargets=function(a){return[a.tuple]},a.prototype.transform=function(a){this.addTouchedNodes(this.target.parent);var b=this.getNewTreeNode(this.nodes),c=b[0].parent,d=b[0].get_parent(5),e=d.parent,f=d.remove();Va.remove_range(b);var g=d.clone(!1);g.get_arg().remove();var h=!1,i=new J;1===b.length&&J.is_fraction_with_identity_numerator(b[0].children[1])&&(b=b[0].children[1].get_bottom(),Va.remove_range(b)),b.forEach(function(a){a.is_group("div")&&(h=!0,a.invert()),i.append(a)},this),g.get_child([1,1,0]).append(i);var j=new u;j.append(new v(d));var k=new v(g,h?"sub":"add");return j.insert("left-of"===this.settings.side?0:1,k),e.insert(f,j),this.nodes[0].get_parent(5).map_to_func(this,g),this.setNodesToReselectAfterAction(k),this.cleanup(i),this.cleanup(c),this.cleanup_cascade(e),"function"==typeof a&&a(this),this},new a}(),fa.prototype.move_actions.push(Wa.actions.LogarithmSplitAction),function(){var a=function(a){p.call(this,"MulDivCleanup","muldiv cleanup action"),a&&(this.actor=a.actor)};Wa.inherit(p,a),a.prototype.match=function(b){return!!a.hasProductChild(b)||!(!b.parent.cleanupAction||!b.parent.cleanupAction.match(b.parent))},a.hasProductChild=function(a){return(a.is_group("mul")||a.is_group("div"))&&a.children[1]&&a.children[1].is_group("product")},a.prototype.doInPlace=function(b){this.initNodeMap();var c=this.getNewTreeNode(this.actor),d=c.parent;this.actor.parent;if(a.hasProductChild(c)){var e=c.children[1],f=this.getOldTreeNode(e),g=Va.remove(c);this.updateNodeMap(this.actor,d),this.updateNodeMap(f,e.children),this.actor.is_group("div")&&e.children.forEach(function(a){a.invert()}),d.insert_range(g,e.children)}return this.cleanup(d),"function"!=typeof b?this:void b(this)},K.prototype.cleanupAction=new a}(),Wa.actions.MultiplyNumbersAction=function(){var a=function(a){p.call(this,"MultiplyNumbersAction","Multiply numbers"),this.triggerType="tap",this.settings={is_join_action:!0,delay:250,side:"inside",margin:{x:.1}},a&&(a.nodes?(this.triggerType="drag",this.nodes=a.nodes,this.target=a.target):this.actor=a.actor)};return Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(a){if(a.length>1)return[];if(!a[0].is_group("mul","div"))return[];if(!E.is_num(a[0].children[1]))return[];var b=this.getOtherNumberMulsInProduct(a[0]);return this.bindActionForEachTarget(a,b)},a.prototype.getOtherNumberMulsInProduct=function(a){var b=a.parent,c=b.filter(function(c){return c!==a&&c.is_group(a.value)&&E.is_num(c.children[1])&&c.parent===b});return c},a.prototype.match=function(a){if(!a.ls)return!1;if(a.ls.value!=a.value)return!1;var b=a.ls.children[1],c=a.children[1];return!(!E.is_num(b)||!E.is_num(c))},a.prototype.transform=function(a){"drag"===this.triggerType?(this.sourceMul=this.nodes[0],this.targetMul=this.target):(this.sourceMul=this.actor,this.targetMul=this.actor.ls),this.addTouchedNodes(this.sourceMul),this.addTouchedNodes(this.targetMul);var b=this.getNewTreeNode(this.sourceMul),c=this.getNewTreeNode(this.targetMul),d=b.parent,e=c.children[1],f=b.children[1],g=E.get_value(e)*E.get_value(f),h=new K(new E(g),b.value);this.updateNodeMap(this.sourceMul,h),this.updateNodeMap(this.sourceMul.children[0],h.children[0]),!this.sourceMul.children[1].is_group("sign")&&h.children[1].is_group("sign")?this.updateNodeMap(this.sourceMul.children[1].get_mapping_to(h.children[1].children[1])):this.updateNodeMap(this.sourceMul.children[1].get_mapping_to(h.children[1])),this.updateNodeMap(this.targetMul,h),this.updateNodeMap(this.targetMul.children[0],h.children[0]),!this.targetMul.children[1].is_group("sign")&&h.children[1].is_group("sign")?this.updateNodeMap(this.targetMul.children[1].get_mapping_to(h.children[1].children[1])):this.updateNodeMap(this.targetMul.children[1].get_mapping_to(h.children[1]));var i=c.remove();return d.insert(i,h),b.remove(),this.cleanup(d),"function"==typeof a&&a(this),this},K.prototype.add_action_handler(new a),new a}(),fa.prototype.move_actions.push(Wa.actions.MultiplyNumbersAction),Wa.actions.MultiplyPowersAction=function(){var a=function(a){p.call(this,"MultiplyPowersAction","Multiply powers"),this.triggerType="tap",this.settings={delay:250,side:"inside",margin:{x:.1}},a&&("drag"===a.triggerType?(this.triggerType=a.triggerType,this.nodes=a.nodes,this.target=a.target):this.actor=a.actor)};return Wa.inherit(p,a),a.prototype.areLikeTerms=function(a,b){var c=a.is_group("power")?a.children[0].to_ascii():a.to_ascii(),d=b.is_group("power")?b.children[0].to_ascii():b.to_ascii();return c===d},a.prototype.match=function(a,b){return a.is_group("power")&&(a=a.parent),arguments.length<2&&(b=a.ls),!!b&&(!(!a.is_group("mul","div")||!b.is_group("mul","div"))&&this.areLikeTerms(a.children[1],b.children[1]))},a.prototype.getSiblings=function(a){return a.parent.children.filter(function(b){return b!==a&&b.value===a.value})},a.prototype.getAllAvailableActions=function(a){var b=[];if(1!==a.length)return b;var c=a[0];if(!c.is_group("mul","div"))return b;for(var d=this.getSiblings(c),e=c.get_root(),f=0;f<d.length;f++)this.match(c,d[f])&&b.push(this.createBoundAction(e,{nodes:a,target:d[f],triggerType:"drag"}));return b},a.prototype.transform=function(a){var b=this.nodes&&this.nodes[0]||this.actor;b.is_group("power")&&(b=b.parent);var c=this.target||b.ls;this.addTouchedNodes(b),this.addTouchedNodes(c);var d=this.analyzeStructure(b);b=this.getNewTreeNode(b),c=this.getNewTreeNode(c);var e=this.performProductOfPowersProperty(b,c);if(this.mapOldSourceStructureToTarget(d,c),c=c.children[1],this.cleanup(b.parent),this.simplify_exponent&&this.shouldSimplifyExponent(c)){var f=this.getExtendablesFromExponent(c).children[1];this.followup=Wa.actions.AddSubNumbersAction.createBoundAction(this.newTree,{actor:f.children[1]})}else this.simplify_exponent=!1,this.setNodesToReselectAfterAction(e);return"function"!=typeof a||void a(this)},a.prototype.analyzeStructure=function(a){var b={};b.muldiv=a;var c=a.children[1];return c.is_group("power")?(b.base=c.children[0],b.exponent=c.children[1]):(b.base=c,b.exponent=null),b},a.prototype.performProductOfPowersProperty=function(a,b){var c=a.children[1],d=b.children[1];c.is_group("power")||(c=this.reinterpretTermAsPowerWithExponentOfOne(c),this.simplify_exponent=!0),d.is_group("power")||(d=this.reinterpretTermAsPowerWithExponentOfOne(d),this.simplify_exponent=!0);var e=a.parent.children.indexOf(a)<b.parent.children.indexOf(b),f=this.extendTargetPowerWithSourcePower(d,c,e);return a.remove(),f},a.prototype.reinterpretTermAsPowerWithExponentOfOne=function(a){var b=a.parent,c=a.remove(),d=new I(a,new E(1));return b.insert(c,d),d},a.prototype.extendTargetPowerWithSourcePower=function(a,b,c){var d=this.getExtendablesFromExponent(b,!0),e=this.getExtendablesFromExponent(a,!1),f=this.combineTermsIntoSum(e,d,c);return f},a.prototype.getExtendablesFromExponent=function(a,b){var c=a.children[1],d=c.children[0];return x.areHidden(d)&&(d=d.children[1]),b&&d.remove(),d},a.prototype.combineTermsIntoSum=function(a,b,c){var d=[],e=a.parent,f=a.remove(),g=v.prototype.createGroup(),h=new v(b),i=new v(a);return b.is_group("sum")?d=b.children.slice():d.push(h),g.append(i),g.insert(c?0:1,h),e.insert(f,g),x.handle(g),this.cleanup(i),this.cleanup(h),d},a.prototype.mapOldSourceStructureToTarget=function(a,b){this.updateNodeMap(a.muldiv,b),this.updateNodeMap(a.muldiv.children[0],b.children[0]);var c=b.children[1].children[0];if(a.base.is_group("brackets")&&c.is_group("brackets"))this.updateNodeMap(a.base.get_mapping_to(c));else{var d=a.base.is_group("brackets")?a.base.children[1]:a.base,e=c.is_group("brackets")?c.children[1]:c;this.updateNodeMap(d.get_mapping_to(e))}if(a.exponent){var f=b.children[1].children[1];this.updateNodeMap(a.exponent,f)}},a.prototype.shouldSimplifyExponent=function(a){var b=this.getExtendablesFromExponent(a);return b.is_group("brackets")&&(b=b.children[1]),2===b.children.length&&b.children.every(function(a){return E.is_num(a.children[1])})},new a}(),K.prototype.add_action_handler(Wa.actions.MultiplyPowersAction),I.prototype.add_action_handler(Wa.actions.MultiplyPowersAction),fa.prototype.move_actions.push(Wa.actions.MultiplyPowersAction),Wa.actions.NegationAction=function(){var a=function(a){p.call(this,"NegationAction","negation"),this.priority=3,this.triggerType="tap",this.settings={side:"inside",delay:300},a&&(a.actor?this.actor=a.actor:(this.triggerType="drag",this.priority=0,this.nodes=a.nodes,this.target=a.target))};Wa.inherit(p,a),a.prototype.isNegativeElement=function(a){return a&&a.is_group("mul","div")&&E.is_num(a.children[1])&&E.get_value(a.children[1])===-1},a.prototype.getAllAvailableActions=function(a){if(1!==a.length)return[];var b=a[0],c=[];if(this.isNegativeElement(b)){b.parent.children.indexOf(b);c=b.parent.children.filter(function(a){return a!==b&&a.is_group("mul","div")})}else c=b.parent.children.filter(this.isNegativeElement.bind(this));var d=b.get_root();return c.map(function(b){return this.createBoundAction(d,{nodes:a,target:b})},this)},a.prototype.match=function(a){if(a.is_group("mul"))return this.isNegativeElement(a.ls)||this.isNegativeElement(a);var b=J.matchSource(a);return!!b&&(this.isNegativeElement(b.mul)||this.isNegativeElement(b.div))},a.prototype.transform=function(a){var b;b=this.actor&&this.actor.is_group("mul")||this.nodes&&this.nodes[0].is_group("mul")?this.getSourceAndTarget():J.getSourceAndTarget.call(this),this.addTouchedNodes(b.source),this.addTouchedNodes(b.target);var c,d;E.is_equal_to(b.source.children[1],-1)?(d=this.getNewTreeNode(b.source),c=this.getNewTreeNode(b.target)):(c=this.getNewTreeNode(b.source),d=this.getNewTreeNode(b.target));var e=c.children[1],f=this.getOldTreeNode(d),g=f.children[1],h=this.getOldTreeNode(c);if(Va.remove(d),e.is_group("sign")&&e.children[1]&&!e.children[1].is_group("sign")){var i=e.children[1];this.updateNodeMap(h.children[1].children[0],i),this.updateNodeMap(g,i),this.updateNodeMap(g.children[0],i),this.updateNodeMap(g.children[1],i),e.replace_with(i)}else{var j=new Q;j.append(new t("-")),this.updateNodeMap(g,j),this.updateNodeMap(g.children[0],j.children[0]),this.updateNodeMap(g.children[1],e),e.remove(),j.append(e),c.append(j)}return this.updateNodeMap(f,c),this.updateNodeMap(f.children[0],c.children[0]),this.cleanup(c),"function"==typeof a&&a(this),this};var b=new a;return J.prototype.add_action_handler(b),K.prototype.add_action_handler(b),b}(),fa.prototype.move_actions.push(Wa.actions.NegationAction),Wa.actions.MulDivLogarithmsAction=function(){var a=function(a){p.call(this,"MulDivLogarithmsAction","muliply or divide a logarithm by a number"),this.priority=1,this.triggerType="tap",this.settings={target_group:!0,group_side:"around",delay:300,reset_y:!0},a&&(a.nodes?(this.triggerType="drag",this.nodes=a.nodes,this.target=a.target,this.settings.side=a.side):this.actor=a.actor)};return Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(a){var b=this.matchSource(a);if(!b)return[];var c=this.getTargets(b);return this.bindActionsForEachTarget(a,c)},a.prototype.matchSource=function(a){return!!a[0].is_group("mul","div")&&(1===a.length?{nodes:a,only_match_logarithms:!N.Logs.is_log_func(a[0].children[1]),do_not_cross_frac:!(N.Logs.is_log_func(a[0].children[1])&&a[0].is_group("mul")||!N.Logs.is_log_func(a[0].children[1])&&a[0].is_group("div")),group:a[0].parent}:!!Va.is_range(a)&&{nodes:a,only_match_logarithms:!0,do_not_cross_frac:a[0].is_group("mul"),group:a[0].parent})},a.prototype.getTargets=function(a){var b=a.nodes[0].is_group("mul")?a.group.get_top():a.group.get_bottom();b=b.concat(a.do_not_cross_frac?[]:a.nodes[0].is_group("mul")?a.group.get_bottom():a.group.get_top());var c=b.filter(function(b){return a.nodes.indexOf(b)===-1&&(!a.only_match_logarithms||N.Logs.is_log_func(b.children[1]))},this);return c},a.prototype.bindActionsForEachTarget=function(a,b){var c=[];return b.forEach(function(b){var d=N.Logs.is_log_func(b.children[1])?b.children[1].children[1]:b.children[1];c=c.concat(this.bindActionForEachTarget(a,[d],!0))},this),c},a.prototype.match=function(a){if(!a.ls||a.ls instanceof t)return!1;if(!a.is_group("mul","div")||a.ls.value!==a.value)return!1;var b=a.ls.children[1],c=a.children[1];return N.Logs.is_log_func(b)||N.Logs.is_log_func(c)},a.prototype.transform=function(a){var b=this.getSourceAndTarget(!0);this.addTouchedNodes(b.source),this.addTouchedNodes(b.target);var c,d,e;if(b.source[0].is_group("fraction"))c=this.getNewTreeNode(b.source[0]),d=c.get_bottom(),e=c.get_top()[0];else for(d=this.getNewTreeNode(b.source),e=this.getNewTreeNode(b.target),c=d[0].parent;!e.is_group("mul","div");)e=e.parent;var f,g,h;d.length>1||N.Logs.is_log_func(e.children[1])?(f=d,g=e,h=!1):(f=[e],g=d[0],h=!0);var i=f.map(this.getOldTreeNode.bind(this));Va.remove_range(f),f[0].is_group("div")&&f[0].value===g.value&&f.forEach(function(a){a.invert()});var j=g.children[1].get_arg(),k=j.parent,l=j.remove(),m=new I;m.append(j),x.handle(j);var n=new J;n.append_range(f);var o=new M(n);return m.append(o),k.insert(l,m),x.handle(g.children[1].children[1]),i.forEach(function(a){a.map_group_and_sym(this,g,!0)},this),this.setNodesToReselectAfterAction(h?g:o),this.cleanup(n),this.cleanup(c),"function"==typeof a&&a(this),this},J.prototype.add_action_handler(new a),K.prototype.add_action_handler(new a),new a}(),fa.prototype.move_actions.push(Wa.actions.MulDivLogarithmsAction),
Wa.actions.MultiplyFractionsAction=function(){var a=function(a){p.call(this,"MultiplyFractionsAction","multiply fractions"),this.priority=1,this.triggerType="tap",this.settings={delay:250,side:"inside",margin:{x:.1}},a&&("drag"===a.triggerType?(this.triggerType=a.triggerType,this.nodes=a.nodes,this.target=a.target):this.actor=a.actor)};return Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(a){if(1!==a.length)return[];var b=a[0];if(!b.parent.is_group("product","fraction"))return[];if(!b.children[1].is_group("fraction"))return[];var c=b.parent.children.filter(this.match2.bind(this,b)),d=b.get_root(),e=this;return c.map(function(b){return e.createBoundAction(d,{nodes:a,target:b,triggerType:"drag"})})},a.prototype.match=function(a){return this.match2(a.ls,a)},a.prototype.match2=function(a,b){if(!a||!b||a===b)return!1;if(a.value!==b.value)return!1;var c=a.parent;if(b.parent!==c)return!1;var d=a.children[1],e=b.children[1];return!(!d.is_group("fraction")||!e.is_group("fraction"))&&!!c.is_group("fraction","product")},a.prototype.transform=function(a){"drag"===this.triggerType?(this.sourceMul=this.nodes[0],this.targetMul=this.target):(this.sourceMul=this.actor,this.targetMul=this.actor.ls),this.addTouchedNodes(this.sourceMul),this.addTouchedNodes(this.targetMul);var b,c,d,e=this.getNewTreeNode(this.sourceMul),f=this.getNewTreeNode(this.targetMul),g=e.parent;e.parent.children.indexOf(e)<f.parent.children.indexOf(f)?(b=e,c=f,d=0):(b=f,c=e,d=1);var h=g,i=b.children[1],j=c.children[1],k=this.sourceMul.children[1];this.updateNodeMap(k.get_fraction_bar(),i.get_fraction_bar()),this.updateNodeMap(this.sourceMul,b),this.updateNodeMap(this.sourceMul.children[0],b.children[0]),Va.remove(c);for(var l=j.get_top(),m=j.get_bottom(),n=0;n<l.length;n++)i.append(l[n]);for(var n=0;n<m.length;n++)i.append(m[n]);for(var n=0;n<i.children.length;n++){var o=i.children[n];o.has_children()&&x.handle(o.children[1])}return this.cleanup(h),"function"==typeof a&&a(this),this},K.prototype.add_action_handler(new a),new a}(),fa.prototype.move_actions.push(Wa.actions.MultiplyFractionsAction),Wa.actions.MulDivInvertAction=function(){var a=function(a){p.call(this,"MulDivInvertAction","invert multipliers across an inequality"),this.priority=0,this.triggerType="drag",this.settings={side:"around",extend_extreme_target_boxes:!0},a&&(this.nodes=a.nodes,this.target=a.target)};return Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(a){var b=this.matchSource(a);if(!b)return[];var c=this.getTargets(b);return this.bindActionForEachTarget(a,c)},a.prototype.matchSource=function(a){if(!Va.is_range(a))return!1;var b=a[0],c=b.get_parent(1);return c.is_group("product","fraction")&&(c.get_parent(1).is_group("equals")||G.is_inequality(c.get_parent(1)))?{nodes:a,side:c.get_idx(),group:c.get_parent(1)}:c.is_group("fraction")&&c.get_parent(1).is_group("sign")&&(c.get_parent(2).is_group("equals")||G.is_inequality(c.get_parent(2)))?{nodes:a,side:c.get_parent(1).get_idx(),group:c.get_parent(2)}:(c.is_group("product","fraction")&&c.get_parent(1).is_group("add","sub")||c.is_group("fraction")&&c.get_parent(1).is_group("mul"))&&(c.get_parent(3).is_group("equals")||G.is_inequality(c.get_parent(3)))?{nodes:a,side:c.get_parent(2).get_idx(),group:c.get_parent(3)}:c.is_group("fraction")&&c.get_parent(1).is_group("mul")&&c.get_parent(3).is_group("add","sub")&&(c.get_parent(5).is_group("equals")||G.is_inequality(c.get_parent(5)))?{nodes:a,side:c.get_parent(4).get_idx(),group:c.get_parent(5)}:!!(c.is_group("fraction")&&c.parent&&c.parent.is_group("mul")&&(c.parent.parent.parent.is_group("equals")||G.is_inequality(c.parent.parent.parent)))&&{nodes:a,frac:c,side:c.get_parent(2).get_idx(),group:c.get_parent(3)}},a.prototype.getTargets=function(a){return[a.group.get_child([a.side?0:2])]},a.prototype.transform=function(a){var b=this.getNewTreeNode(this.nodes),c=this.analyzeStructureOfEquation(b);return G.is_inequality(c.otherSideOfEquation.get_parent(1))&&this.invertInequality(c.modifiers,c.otherSideOfEquation.get_parent(1)),this.invertModifiers(c.modifiers),this.modifyAnyOtherTermsOnOriginSide(c.modifiers,c.originChanges),this.removeModifiersFromOriginSide(c.modifiers),this.modifyTargetSide(c.oldModifiers,c.modifiers,c.otherSideOfEquation,c.oldOtherSideOfEquation),"function"==typeof a&&a(this),this},a.prototype.analyzeStructureOfEquation=function(a){var b=this,c={},d=a[0].get_root().children[0],e=a[0].get_path(),f=e[1]?0:2;return c.modifiers=a,c.oldModifiers=a.map(b.getOldTreeNode.bind(b)),c.originChanges=this.getOtherTermsFromSide(d.children[e[1]],a,e),c.otherSideOfEquation=d.children[f],c.oldOtherSideOfEquation=this.getOldTreeNode(c.otherSideOfEquation),c},a.prototype.getOtherTermsFromSide=function(a,b,c){return a===b[0]||b[0].is_group("div")&&b[0].parent===a?[]:a.children.slice().filter(function(a){var b=a.get_path();return b[2]!==c[2]})},a.prototype.invertInequality=function(a,b){var c=fa.evalExpression(a),d=fa.to_ascii(a),e=Wa.termsToAlgebriteString(a);if(Number.isNaN(c)&&"undefined"!=typeof Ua)try{console.log(e),c=Number(Ua.eval(e).toString())}catch(a){console.log("Algebrite could not parse",e)}isNaN(c)?this.settings.restraint="The terms "+d+" must simplify to a positive number.":c<0&&b.invert()},a.prototype.invertModifiers=function(a){for(var b=[],c=0;c<a.length;c++){var d=a[c];d.is_group("mul")&&d.children[1].is_group("fraction")?J.convert_to_reciprocal(d.children[1]):!d.invert||d.is_group("product","fraction")||this.isIdentityMul(d)||d.invert(),b.push(d)}return b},a.prototype.isIdentityMul=function(a){return a.is_group("mul")&&(1===E.get_value(a.children[1])||E.get_value(a.children[1])===-1)},a.prototype.modifyAnyOtherTermsOnOriginSide=function(a,b){if(0!==b.length){var c=b[0].parent;if(a[0].is_group("mul","div")&&c.is_group("sum"))for(var d=0;d<b.length;d++){var e=b[d].children[1],f=this.removeRedundantTerms(e,a);f.length>0&&(e=b[d].children[1],this.insertModifiersIntoTerm(e,f))}}},a.prototype.removeRedundantTerms=function(a,b){var c=b.slice();if(a.is_group("product","fraction")){for(var d=0;d<a.children.length;){for(var e=a.children[d],f=0;f<c.length;){if(this.invertModifiers([Va.clone(c[f])])[0].to_ascii()===e.to_ascii()){this.extendNodeMap(this.getOldTreeNode(e).get_mapping_to(c[f])),e.remove(),c.splice(f,1);break}d++,f++}if(0===c.length)break}this.cleanup(a)}return c},a.prototype.insertModifiersIntoTerm=function(a,b){this.termIsAProductContainingAFraction(a)&&b[0].is_group("div")?this.insertModifierDivsAsNewFractionIntoProduct(a,b):a.is_group("product","fraction")?this.insertModifiersIntoProductFraction(a,b):this.replaceTermWithProductContainingModifiedTerm(a,b)},a.prototype.termIsAProductContainingAFraction=function(a){return!!a.is_group("product")&&a.children.some(function(a){return a.children[1].is_group("fraction")})},a.prototype.insertModifierDivsAsNewFractionIntoProduct=function(a,b){var c=this,d=K.prototype.createGroup();d.append(new K(new E(1))),b.forEach(function(a){var b=Va.clone(a);b.dragging=!1,b.selected=!1,c.extendNodeMap(c.getOldTreeNode(a).get_mapping_to(b)),d.append(b)}),a.append(new K(d))},a.prototype.insertModifiersIntoProductFraction=function(a,b){var c=this;b.forEach(function(b){var d=Va.clone(b);d.dragging=!1,d.selected=!1,c.extendNodeMap(c.getOldTreeNode(b).get_mapping_to(d)),a.append(d)})},a.prototype.replaceTermWithProductContainingModifiedTerm=function(a,b){var c=this,d=K.prototype.createGroup(),e=a.parent,f=a.remove();d.append(new K(a)),b.forEach(function(a){var b=Va.clone(a);b.dragging=!1,b.selected=!1,c.extendNodeMap(c.getOldTreeNode(a).get_mapping_to(b)),d.append(b)}),e.insert(f,d)},a.prototype.removeModifiersFromOriginSide=function(a){var b=a[0].get_root().get_child(a[0].get_path().slice(0,2));if(this.modifierIsTheOnlyTermOnOriginSide(a,b))this.removeModifierAndReplaceWithZero(a);else if(a[0].is_group("div")||a[0].is_group("mul")&&a[0].parent.is_group("fraction")){var c=a[0].parent,d=c.parent;Va.remove_range(a);var e=c.get_top(),f=this.cleanup(c);f&&1===e.length&&d.is_group("product","mul")&&(d.simplify=!0),this.cleanup(d)}else{var d=a[0].parent;Va.remove_range(a),this.cleanup(d)}},a.prototype.modifierIsTheOnlyTermOnOriginSide=function(a,b){return a[0]===b},a.prototype.removeModifierAndReplaceWithZero=function(a){var b=a[0].parent,c=a[0].remove();b.insert(c,new E(0))},a.prototype.modifyTargetSide=function(a,b,c,d){if(1===b.length&&!b[0].is_group("mul","div")&&!b[0].is_group("add","sub"))if(b[0].is_group("sign")){var e=b[0].children[1];e.remove(),b[0]=new v(e),this.updateNodeMap(a[0],b[0]),this.updateNodeMap(a[0].children[0],b[0].children[0])}else if(b[0].is_group("sum")){var e=b[0];e.children.forEach(function(a){a.invert()}),b[0]=new v(e)}else{var e=b[0];b[0]=new v(e,"sub")}var f=c.parent,g=c.remove();if(!c.is_group("product","fraction")&&b[0].is_group("mul","div")){var h=K.prototype.createGroup(),i=new K(c);h.append(i);for(var j=0;j<b.length;j++)h.append(b[j]);f.insert(g,h),this.cleanup(h.children[0]),h.children[0].simplify=!0}else if(!c.is_group("sum")&&b[0].is_group("add","sub","sum")){var k,l=v.prototype.createGroup();c.is_group("sign")?(k=new v(c),this.extendNodeMap(d,k),this.extendNodeMap(d.children[0],k.children[0])):k=new v(c),l.append(k);for(var j=0;j<b.length;j++)l.append(b[j]);if(f.insert(g,l),this.cleanup(l.children[0]),b[0].children[1].is_group("sum")){var m=b[0].children[1].children.slice();this.cleanup(b[0]),b=m}l.children[0].simplify=!0}else{for(var n=c,j=0;j<b.length;j++)n.append(b[j]);f.insert(g,n),1===b.length&&b[0].children[1].is_group("sum")&&(b=b[0].children[1].children.slice(),this.cleanup(n.children[n.children.length-1]))}this.setNodesToReselectAfterAction(b)},new a}(),fa.prototype.move_actions.push(Wa.actions.MulDivInvertAction),Wa.actions.MulDivRadicalsAction=function(){var a=function(a){p.call(this,"MulDivRadicalsAction","muliply or divide a radicals"),this.triggerType="tap",this.priority=0,this.settings={target_group:!0,group_side:"around",delay:300,reset_y:!0},a&&(a.nodes?(this.triggerType="drag",this.priority=1,this.nodes=a.nodes,this.target=a.target,this.settings.side=a.side):this.actor=a.actor)};Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(a){var b=this.matchSource(a);if(!b)return[];var c=this.getTargets(b);return this.bindActionsForEachTarget(a,c)},a.prototype.matchSource=function(a){return 1===a.length&&(!(!a[0].is_group("mul","div")||!a[0].children[1].is_group("radical"))&&{nodes:a,degree_val:a[0].children[1].children[0].to_ascii(),group:a[0].parent})},a.prototype.getTargets=function(a){var b=a.group.get_top().concat(a.group.get_bottom()),c=b.filter(function(b){return a.nodes.indexOf(b)===-1&&b.children[1].is_group("radical")&&b.children[1].children[0].to_ascii()===a.degree_val},this);return c},a.prototype.bindActionsForEachTarget=function(a,b){var c=[];return b.forEach(function(b){var d=b.children[1].get_radicand();c=c.concat(this.bindActionForEachTarget(a,[d],!0))},this),c},a.prototype.match=function(a){if(!a.ls||a.ls instanceof t)return!1;if(!a.is_group("mul","div")||a.ls.value!==a.value)return!1;var b=a.ls.children[1],c=a.children[1];return b.is_group("radical")&&c.is_group("radical")&&b.children[0].to_ascii()===c.children[0].to_ascii()},a.prototype.transform=function(a){var b=this.getSourceAndTarget();this.addTouchedNodes(b.source),this.addTouchedNodes(b.target);for(var c=this.getNewTreeNode(b.source),d=this.getNewTreeNode(b.target),e=c.parent,f=this.getOldTreeNode(c);!d.is_group("mul","div");)d=d.parent;if(d.is_group("div")&&c.is_group("mul")){var g=d;d=c,c=g}var h=c.children[1].get_radicand(),i=d.children[1].get_radicand();c.remove(),i.remove();var j=new J;return j.append(new K(i)),j.insert("left-of"===this.settings.side?0:1,new K(h,d.value===c.value?"mul":c.value),!0),d.children[1].set_radicand(j),f.map_group_and_sym(this,d,!0),f.children[1].map_to_radical(this,d.children[1],!0),this.cleanup(i.parent),this.cleanup(h.parent),this.cleanup(j),this.cleanup(e),"function"==typeof a&&a(this),this};var b=new a;return J.prototype.add_action_handler(b),K.prototype.add_action_handler(b),b}(),fa.prototype.move_actions.push(Wa.actions.MulDivRadicalsAction),Wa.actions.AddFractionsAction=function(){var a=function(a){p.call(this,"AddFractionsAction","add fractions"),this.priority=1,this.triggerType="tap",this.settings={delay:250,side:"inside",margin:{x:.1}},a&&("drag"===a.triggerType?(this.triggerType=a.triggerType,this.nodes=a.nodes,this.target=a.target):this.actor=a.actor)};return Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(a){if(1!==a.length)return[];var b=a[0];if(!b.parent.is_group("sum"))return[];if(!b.children[1].is_group("fraction"))return[];var c=b.parent.children.filter(this.match2.bind(this,b)),d=b.get_root(),e=this;return c.map(function(b){return e.createBoundAction(d,{nodes:a,target:b,triggerType:"drag"})})},a.prototype.match=function(a){return this.match2(a.ls,a)},a.prototype.match2=function(a,b){if(!a||!b||a===b)return!1;if(!a.parent.is_group("sum"))return!1;if(a.parent!==b.parent)return!1;var c=a.children[1],d=b.children[1];if(!c.is_group("fraction")||!d.is_group("fraction"))return!1;var e=function(a){return a.to_ascii()},f=c.get_bottom(),g=d.get_bottom();return f.map(e).join("")===g.map(e).join("")},a.prototype.transform=function(a){"drag"===this.triggerType?(this.sourceAddend=this.nodes[0],this.targetAddend=this.target):(this.sourceAddend=this.actor,this.targetAddend=this.actor.ls),this.addTouchedNodes(this.sourceAddend),this.addTouchedNodes(this.targetAddend);var b=this.getNewTreeNode(this.sourceAddend),c=this.getNewTreeNode(this.targetAddend),d=b.parent;if(b.parent.children.indexOf(b)<c.parent.children.indexOf(c)){var e=c;c=b,b=e}var f=this.getOldTreeNode(c),g=this.getOldTreeNode(b),h=c.children[1],i=b.children[1];this.mapOldFractionPartsToFraction(g.children[1],h);var j=Va.remove(c);Va.remove(b),Va.remove(h),Va.remove(i),c=this.putNumeratorTermsIntoAddSubAndMapFromOldAddSub(h.get_top(),f),b=this.putNumeratorTermsIntoAddSubAndMapFromOldAddSub(i.get_top(),g);var k=this.putAddendsIntoNewSumAndMakeNumeratorTerm(c,b);h.append(k);var l=new v(h);return Va.insert(d,j,l),this.updateNodeMap(this.sourceAddend,l),this.updateNodeMap(this.targetAddend,l),this.cleanup(c),this.cleanup(b),this.cleanup(d),Wa.options.actions.simplify_sum_in_numerator_after_adding_fractions&&this.numeratorSumContainsTwoNumbers(h.get_top()[0].children[1].children[1])&&this.simplifyNumeratorAsFollowup(h),"function"!=typeof a||void a(this)},a.prototype.mapOldFractionPartsToFraction=function(a,b){this.updateNodeMap(a.get_fraction_bar(),b.get_fraction_bar());for(var c=a.get_bottom(),d=b.get_bottom(),e=0;e<c.length;e++)this.updateNodeMap(c[e].get_mapping_to(d[e]))},a.prototype.putNumeratorTermsIntoAddSubAndMapFromOldAddSub=function(a,b){Va.remove_range(a);var c;if(1==a.length)c=new v(a[0].children[1],b.value);else{var d=new J;Va.insert_range(d,0,a),c=new v(d,b.value)}return x.handle(c.children[1],!0),this.updateNodeMap(b,c),this.updateNodeMap(b.children[0],c.children[0]),c},a.prototype.putAddendsIntoNewSumAndMakeNumeratorTerm=function(a,b){var c=v.prototype.createGroup();c.append(a),c.append(b);var d=new K;return Va.append(d,new t("*")),Va.append(d,c),x.handle(c),d},a.prototype.numeratorSumContainsTwoNumbers=function(a){return 2===a.children.length&&a.children.every(function(a){return E.is_num(a.children[1])})},a.prototype.simplifyNumeratorAsFollowup=function(a){var b=a.get_top()[0].children[1].children[1];this.followup=Wa.actions.AddSubNumbersAction.createBoundAction(this.newTree,{actor:b.children[1]})},v.prototype.add_action_handler(new a),new a}(),fa.prototype.move_actions.push(Wa.actions.AddFractionsAction),Wa.actions.FractionAbsorbTermAction=function(){var a=function(a){p.call(this,"FractionAbsorbTermAction","associative property of multiplication--move into fraction"),this.priority=0,this.triggerType="drag",this.settings={delay:250,side:"around",margin:{x:.1}},a&&(this.nodes=a.nodes,this.target=a.target)};return Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(a){var b=this.matchSource(a);if(!b)return[];var c=this.getTargets(b);return this.bindActionForEachTarget(a,c)},a.prototype.matchSource=function(a){return 1===a.length&&a[0].is_group("mul","div")&&a[0].children[1].is_group("fraction")&&{nodes:a,group:a[0].parent,fraction:a[0].children[1]}},a.prototype.getTargets=function(a){var b=a.nodes[0].is_group("mul")?a.group.get_top():a.group.get_bottom(),c=b.filter(function(b){return!b.children[1].is_group("fraction")&&a.nodes[0]!==b},this);return c},a.prototype.transform=function(a){this.addTouchedNodes(this.nodes),this.addTouchedNodes(this.target);var b=this.getNewTreeNode(this.nodes[0]),c=this.getNewTreeNode(this.target),d=c.get_idx()<b.get_idx(),e=b.children[1];c.remove(),c.is_group("div")&&c.invert();var f=e.get_top();return 1===f.length&&E.is_equal_to(f[0].children[1],1)&&(f[0].simplify=!0),e.insert(d?0:e.get_top().length,c),this.cleanup_cascade(b.parent),"function"!=typeof a||void a(this)},new a}(),fa.prototype.move_actions.push(Wa.actions.FractionAbsorbTermAction),Wa.actions.FractionCancelTermsAction=function(){var a=function(a){p.call(this,"FractionCancelTermsAction","cancel numbers in a fraction"),this.triggerType="tap",this.priority=0,this.settings={delay:400,side:"inside",reset_x:!0,reset_y:!0},a&&(a.nodes?(this.priority=2,this.triggerType="drag",this.nodes=a.nodes,this.target=a.target):this.actor=a.actor)};Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(b){return a.getAllAvailableActions.call(this,b)},a.getAllAvailableActions=function(b){if(1!==b.length)return[];if(!b.every(function(a){return a.is_group("mul","div")}))return[];var c=Wa.canceling.find_top_level_group_for_canceling(b);if(!c)return[];var d=a.findOtherContendersInStructure(b,c);if(0===d.length)return[];d=d.filter(function(a){var c=this.getBoundTransformation(b[0],a);return!!c},this);var e=b[0].get_root();return d.map(function(a){return this.createBoundAction(e,{nodes:b,target:a})},this)},a.findOtherContendersInStructure=function(a,b){var c,d=a[0].is_group("mul")?"div":"mul";return c=b.filter(function(c){return c.is_group(d)&&(c.parent===b||c.parent.parent.parent===b)&&!Wa.canceling.node_is_ancestor_of_nodes(c,a)})},a.prototype.match=function(b){return a.match.call(this,b)},a.match=function(a){if(!Wa.options.actions.tap_to_cancel)return!1;var b=J.matchSource(a);if(!b)return!1;var c=this.getBoundTransformation(b.mul,b.div);return!!c},a.prototype.transform=function(b){a.transform.call(this,b)},a.transform=function(b){var c=J.getSourceAndTarget.call(this);this.oldSourceOp=c.source,this.addTouchedNodes(c.source),this.addTouchedNodes(c.target);var d=this.getNewTreeNode(c.source),e=this.getNewTreeNode(c.target),f=Wa.canceling.find_top_level_group_for_canceling([d]);return a.performCancel.call(this,d,e),a.cleanStructure.call(this,f),"function"!=typeof b||void b(this)},a.performCancel=function(a,b){var c=this.getBoundTransformation(a,b);if(!c)throw"Failed to find canceling transformation in transform function.";c()},a.cleanStructure=function(a){var b=!1;a.is_group("product")&&a.children.forEach(function(a){a.children[1].is_group("fraction")&&(b=this.cleanup_cascade(a.children[1]))},this),b||this.cleanup_cascade(a)},a.prototype.getBoundTransformation=function(a,b){var c=this,d=a.is_group("mul")?a:b,e=b.is_group("div")?b:a,f=E.is_num(d.children[1]),g=E.is_num(e.children[1]),h=f&&!this.numberContainsDecimalTerm(d.children[1]),i=g&&!this.numberContainsDecimalTerm(e.children[1]);return(!g||0!==E.get_value(e.children[1])&&E.get_value(e.children[1])!==-0)&&(d.children[1].to_ascii()===e.children[1].to_ascii()?function(){c.cancelTerms(d,e)}:i&&E.get_value(e.children[1])===-1?function(){c.applyNegativeToMulNum(d,e)}:this.termIsNegativeXOfX(d.children[1],e.children[1])?function(){c.cancelTermsAndReplaceMulDiv1NumWithNegativeOne(d,e)}:this.termIsNegativeXOfX(e.children[1],d.children[1])?function(){c.cancelTermsAndReplaceMulDiv1NumWithNegativeOne(e,d)}:h&&i&&Wa.factoring.numbers_are_multiples(d.get_child([1]),e.get_child([1]))?function(){c.factorizeTerms(d,e)}:!!this.bothTermsAreNegative(d,e)&&function(){c.extractSigns(d,e)})},a.prototype.cancelTerms=function(a,b){this.setNodesToReselectAfterAction(a.parent),a.remove(),b.remove()},a.prototype.applyNegativeToMulNum=function(a,b){if(this.updateNodeMap(this.getOldTreeNode(b),a),a.children[1].is_group("sign"))a.children[1].replace_with(a.children[1].children[1]);else{var c=b.children[1];c.remove(),c.children[1].remove();var d=a.children[1];d.remove(),a.append(c),c.append(d)}b.remove()},a.prototype.termIsNegativeXOfX=function(a,b){return a.is_group("sign")&&a.children[1].to_ascii()===b.to_ascii()},a.prototype.cancelTermsAndReplaceMulDiv1NumWithNegativeOne=function(a,b){var c=a.children[1].children[1],d=b.children[1],e=new E(1);this.updateNodeMap(this.getOldTreeNode(b),a),this.updateNodeMap(this.getOldTreeNode(d).get_mapping_to(e)),this.updateNodeMap(this.getOldTreeNode(c).get_mapping_to(e)),c.replace_with(e),b.remove()},a.prototype.factorizeTerms=function(a,b){var c=a.get_root(),d=c.numeric_value(a.children[1]),e=c.numeric_value(b.children[1]);if(!d||!e)return!1;var f=this.getOldTreeNode(a),g=this.getOldTreeNode(b),h=this.relativePositionOfMulWithRespectToDiv(a,b);if(Wa.factoring.val1_is_a_multiple_of_val2(d,e)){var i="left"===h?this.splitIntoFactors(a,f,Math.floor(d/e),e)[1]:this.splitIntoFactors(a,f,e,Math.floor(d/e))[0];this.oldSourceOp.is_group("mul")&&this.setNodesToReselectAfterAction(i),Wa.options.actions.cancel_common_terms_after_finding_gcf&&(this.oldSourceOp.is_group("mul")?this.followup=Wa.actions.FractionCancelTermsAction.createBoundAction(this.newTree,{nodes:[i],target:b}):this.followup=Wa.actions.FractionCancelTermsAction.createBoundAction(this.newTree,{nodes:[b],target:i}))}else if(Wa.factoring.val1_is_a_multiple_of_val2(e,d)){var i="left"===h?this.splitIntoFactors(b,g,d,Math.floor(e/d))[0]:this.splitIntoFactors(b,g,Math.floor(e/d),d)[1];this.oldSourceOp.is_group("div")&&this.setNodesToReselectAfterAction(i),Wa.options.actions.cancel_common_terms_after_finding_gcf&&(this.oldSourceOp.is_group("div")?this.followup=Wa.actions.FractionCancelTermsAction.createBoundAction(this.newTree,{nodes:[i],target:a}):this.followup=Wa.actions.FractionCancelTermsAction.createBoundAction(this.newTree,{nodes:[a],target:i}))}else{var j,k,l=Wa.factoring.get_gcf(d,e);switch(h){case"left":j=this.splitIntoFactors(a,f,Math.floor(d/l),l)[1],k=this.splitIntoFactors(b,g,l,Math.floor(e/l))[0];break;case"same":j=this.splitIntoFactors(a,f,Math.floor(d/l),l)[1],k=this.splitIntoFactors(b,g,Math.floor(e/l),l)[1];break;case"right":j=this.splitIntoFactors(a,f,l,Math.floor(d/l))[0],k=this.splitIntoFactors(b,g,Math.floor(e/l),l)[1]}var m;m=this.target.is_group("mul")?k:j,this.setNodesToReselectAfterAction(m),Wa.options.actions.cancel_common_terms_after_finding_gcf&&(this.followup=Wa.actions.FractionCancelTermsAction.createBoundAction(this.newTree,{nodes:[k],target:j}))}},a.prototype.relativePositionOfMulWithRespectToDiv=function(a,b){if(a.parent===b.parent){var c=a.parent.get_top(),d=a.parent.get_bottom();return this.positionComparison(c.indexOf(a),d.indexOf(b))}var e,f;e=a.parent.is_group("product")?a:a.parent.parent,f=b.parent.parent;var g=e.parent;return this.positionComparison(g.children.indexOf(e),g.children.indexOf(f))},a.prototype.positionComparison=function(a,b){var c=a-b;return c<0?"left":0===c?"same":"right"},a.prototype.splitIntoFactors=function(a,b,c,d){var e=new K(isNaN(c)?Va.clone(a.children[1].children[1]):new E(c),a.value),f=new K(isNaN(d)?Va.clone(a.children[1].children[1]):new E(d),a.value);this.updateNodeMap(b.get_mapping_to(e)),this.extendNodeMap(b.get_mapping_to(f));var g=a.remove();return a.parent.insert(g,f),a.parent.insert(g,e),[e,f]},a.prototype.bothTermsAreNegative=function(a,b){return a.children[1].is_group("sign")&&b.children[1].is_group("sign")},a.prototype.extractSigns=function(a,b){var c=a.get_root(),d=this.getOldTreeNode(a),e=this.getOldTreeNode(b),f=this.splitIntoFactors(a,d,c.numeric_value(a.children[1])/-1,-1)[1],g=this.splitIntoFactors(b,e,c.numeric_value(b.children[1])/-1,-1)[1];this.oldSourceOp.is_group("mul")?this.setNodesToReselectAfterAction(f):this.setNodesToReselectAfterAction(g),Wa.options.actions.cancel_common_terms_after_finding_gcf&&(this.followup=Wa.actions.FractionCancelTermsAction.createBoundAction(this.newTree,{nodes:[f],target:g}))},a.prototype.numberContainsDecimalTerm=function(a){return E.get_value(a)!==Math.floor(E.get_value(a))};var b=new a;return J.prototype.add_action_handler(b),K.prototype.add_action_handler(b),b}(),fa.prototype.move_actions.push(Wa.actions.FractionCancelTermsAction),Wa.actions.FractionCancelPowersAction=function(){var a=function(a){p.call(this,"FractionCancelPowersAction","cancel powers in a fraction"),this.triggerType="tap",this.priority=0,this.settings={delay:400,side:"inside",reset_x:!0,reset_y:!0},a&&(a.nodes?(this.priority=2,this.triggerType="drag",this.nodes=a.nodes,this.target=a.target):this.actor=a.actor)};Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(a){return Wa.options.actions.cancel_powers?Wa.actions.FractionCancelTermsAction.getAllAvailableActions.call(this,a):[]},a.prototype.match=function(a){return!!Wa.options.actions.cancel_powers&&Wa.actions.FractionCancelTermsAction.match.call(this,a)},a.prototype.transform=function(a){Wa.actions.FractionCancelTermsAction.transform.call(this,a)},a.prototype.getBoundTransformation=function(a,b){var c=this,d=a.is_group("mul")?a:b,e=b.is_group("div")?b:a,f=d.get_child([1]),g=e.get_child([1]);return!(!f.is_group("power")&&!g.is_group("power"))&&(I.haveSameBase(f,g)?function(){c.factorizePowers(d,e)}:void 0)},a.prototype.factorizePowers=function(a,b){var c=this.oldSourceOp.is_group("mul")?a:b,d=this.oldSourceOp.is_group("mul")?b:a,e=c.children[1],f=d.children[1],g=this.getOldTreeNode(c),h=this.getOldBase(e),i=(this.getOldExponentTermFromPower(f),this.getOldExponentTermFromPower(e));this.sourceIsLeftOfTarget(c,d);e.is_group("power")||(e=this.reinterpretTermAsPower(e)),f.is_group("power")||(f=this.reinterpretTermAsPower(f));var j=e.get_child([1,0]),k=f.get_child([1,0]);j.is_group("brackets")&&(j=j.children[1]),k.is_group("brackets")&&(k=k.children[1]),c.remove(),this.convertTargetExponentIntoSum(k,i,j),this.updateNodeMap(g,d),this.updateNodeMap(h.get_mapping_to(f.get_child([0]))),this.setNodesToReselectAfterAction(d)},a.prototype.sourceIsLeftOfTarget=function(a,b){if(a.parent===b.parent)return!0;var c,d;c=a.parent.is_group("product")?a:a.parent.parent,d=b.parent.is_group("product")?b:b.parent.parent;var e=c.parent;return e.children.indexOf(c)<=e.children.indexOf(d)},a.prototype.getOldBase=function(a){return a.is_group("power")?this.getOldTreeNode(a.get_child([0])):this.getOldTreeNode(a)},a.prototype.getOldExponentTermFromPower=function(a){if(!a.is_group("power"))return null;var b=this.getOldTreeNode(a),c=b.get_child([1,0]);return c.is_group("brackets")&&(c=c.get_child([1])),c},a.prototype.reinterpretTermAsPower=function(a){var b=a.parent,c=a.remove(),d=M.prototype.createGroup();return d.append(a),d.append(new M(new E(1))),this.updateNodeMap(a,d),b.insert(c,d),d},a.prototype.convertTargetExponentIntoSum=function(a,b,c){var d=a.parent,e=a.remove(),f=v.prototype.createGroup();if(d.insert(e,f),f.append(new v(a)),f.append(new v(c,"sub")),this.applyInnerAction("AddSubCombineSigns",{actor:f.children[0]}),this.applyInnerAction("AddSubCombineSigns",{actor:f.children[1]}),this.cleanup(f.get_child([1])),this.cleanup(f.get_child([0])),x.handle(f),b&&b.is_group("sum"))for(var g=0;g<b.children.length;g++)this.extendNodeMap(b.children[b.children.length-g-1].get_mapping_to(f.children[f.children.length-g-1]));else b&&this.extendNodeMap(b.get_mapping_to(f.children[f.children.length-1].children[1]));Wa.options.actions.simplify_sum_after_canceling_powers&&2===f.children.length&&Wa.actions.AddSubNumbersAction.getAllAvailableActions([f.children[1]]).length>0&&(this.followup=Wa.actions.AddSubNumbersAction.createBoundAction(this.newTree,{nodes:[f.children[1]],target:f.children[0]})),d.is_group("exponent")&&(d.simplify=!0)};var b=new a;return J.prototype.add_action_handler(b),K.prototype.add_action_handler(b),b}(),fa.prototype.move_actions.push(Wa.actions.FractionCancelPowersAction),Wa.actions.FractionCancelRangeAction=function(){var a=function(a){p.call(this,"FractionCancelRangeAction","cancel a range of terms in a fraction"),this.triggerType="tap",this.priority=2,this.settings={delay:400,side:"inside",reset_x:!0,reset_y:!0},a&&(a.nodes?(this.triggerType="drag",this.nodes=a.nodes,this.target=a.target):this.actor=a.actor)};Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(a){var b=this.matchSource(a);if(!b)return[];var c=this.getTargets(b);return this.bindActionForEachTarget(a,c)},a.prototype.matchSource=function(a){if(!Va.is_range(a))return!1;if(!a[0].is_group("mul","div"))return!1;if(1===a.length&&!this.operatorContainsCommutativeGroup(a[0]))return!1;var b=Wa.canceling.find_top_level_group_for_canceling(a);return!!b&&{nodes:a,match_sub_permutation:1===a.length,match_type:a[0].is_group("mul")?"div":"mul",top_level_group:b}},a.prototype.getTargets=function(a){return Va.filterRange(function(b){return b.length===a.nodes.length&&b.every(function(b){return b.is_group(a.match_type)})&&a.nodes.every(function(a){return!Wa.canceling.node_is_ancestor_of_nodes(a,b)})&&(a.match_sub_permutation&&this.operatorContainsCommutativeGroup(b[0])&&Wa.factoring.operator_ranges_are_permutations(a.nodes[0].get_child([1,1]).children,b[0].get_child([1,1]).children)||!a.match_sub_permutation&&Wa.factoring.operator_ranges_are_permutations(a.nodes,b))}.bind(this),a.top_level_group)},a.prototype.operatorContainsCommutativeGroup=function(a){return a.children[1].is_group("brackets")&&a.children[1].children[1].is_group()&&a.children[1].children[1].children[0].commutative},a.prototype.transform=function(a){var b=this.getSourceAndTarget(!0);this.addTouchedNodes(b.source),this.addTouchedNodes(b.target);var c=this.getNewTreeNode(b.source),d=this.getNewTreeNode(b.target),e=Wa.canceling.find_top_level_group_for_canceling(c);return Va.remove_range(c),Va.remove_range(d),Wa.canceling.nodes_are_in_a_fraction_within_a_product(c[0])&&1===c[0].parent.children.length&&c[0].get_parent(2).remove(),this.setNodesToReselectAfterAction(e),this.cleanStructure(e),"function"!=typeof a||void a(this)},a.prototype.cleanStructure=function(a){var b=!1;a.is_group("product")&&a.children.forEach(function(a){a.children[1].is_group("fraction")&&(b=this.cleanup_cascade(a.children[1]))},this),b||this.cleanup_cascade(a)};var b=new a;return b}(),fa.prototype.move_actions.push(Wa.actions.FractionCancelRangeAction),Wa.actions.FractionMagSimplificationAction=function(){var a=function(a){p.call(this,"FractionMagSimplificationAction","cancel numerator and denominator"),this.priority=0,this.triggerType="tap",a&&(this.actor=a.actor)};return Wa.inherit(p,a),a.prototype.match=function(a){var b=J.matchSource(a);if(!b)return!1;if(b.fraction.get_top().length>1)return!1;var c=E.get_value(b.mul.children[1]),d=E.get_value(b.div.children[1]);return!isNaN(c)&&!isNaN(d)&&0!==d&&(!Wa.options.actions.only_integer_division||d<=c&&c%d===0||0===c)},J.matchSource=function(a){return!a.is_group("mul")&&(a.is_group("div")&&(a=a.parent),!!a.is_group("fraction")&&(1===a.get_bottom().length&&{fraction:a,mul:a.get_top()[0],div:a.get_bottom()[0]}))},a.prototype.transform=function(a){var b=this.getNewTreeNode(this.actor),c=b.parent;this.addTouchedNodes(this.actor);var d=b.get_top(),e=b.get_bottom();d=d[0],e=e[0];var f=E.get_value(d.children[1])/E.get_value(e.children[1]),g=new E(f);d.children[1]instanceof Q||e.children[1]instanceof Q?(this.updateNodeMap(this.actor.children[0].children[1].get_mapping_to(g)),this.updateNodeMap(this.actor.children[2].children[1].get_mapping_to(g))):this.updateNodeMap(this.actor.get_mapping_to(g));var h=b.remove();return c.insert(h,g),c.parent&&x.handle(c,!0),"function"!=typeof a||void a(this)},J.prototype.add_action_handler(new a),
new a}(),Wa.actions.ReorderSumInFractionDenominatorAction=function(){var a=function(a){p.call(this,"ReorderSumInFractionDenominatorAction","reorder sum in a fraction's denominator"),this.priority=2,this.triggerType="dbltap",a&&(this.actor=a.actor)};return Wa.inherit(p,a),a.prototype.match=function(a){if(!a)return!1;if(!a.is_group("add","sub"))return!1;if(!a.ls)return!1;var b=a.ls;return!(!b.children[1].is_group("fraction")||!a.children[1].is_group("fraction"))&&this.denominatorsHaveMatchingSums(b.children[1],a.children[1])},a.prototype.denominatorsHaveMatchingSums=function(a,b){var c=a.get_bottom(),d=b.get_bottom();if(1!==c.length||1!==d.length)return!1;if(!x.areHidden(c[0].children[1])||!c[0].children[1].children[1].is_group("sum"))return!1;if(!x.areHidden(d[0].children[1])||!d[0].children[1].children[1].is_group("sum"))return!1;var e=c[0].children[1].children[1],f=d[0].children[1].children[1];if(e.to_ascii()===f.to_ascii())return!1;var g=function(a){return a.to_ascii()};return Wa.array.isPermutation(e.children.map(g),f.children.map(g))},a.prototype.transform=function(a){this.addTouchedNodes(this.actor),this.addTouchedNodes(this.actor.ls);var b=this.getNewTreeNode(this.actor.ls).children[1],c=this.getNewTreeNode(this.actor).children[1];return this.sortDenominatorsToMatch(b,c),"function"!=typeof a||void a(this)},a.prototype.sortDenominatorsToMatch=function(a,b){for(var c=a.get_bottom()[0].children[1].children[1],d=b.get_bottom()[0].children[1].children[1],e=c.children.slice(),f=d.children.slice(),g=0;g<e.length;g++)if(e[g].to_ascii()!==f[g].to_ascii())for(var h=g;h<f.length;h++)if(e[g].to_ascii()===f[h].to_ascii()){var i=f[h];i.remove(),d.insert(g,i),f=d.children.slice()}},v.prototype.add_action_handler(new a),new a}(),Wa.actions.CrossMultiplyFractionsAction=function(){var a=function(a){p.call(this,"CrossMultiplyFractionsAction","cross multiply fractions"),this.priority=1,this.triggerType="dbltap",a&&(this.actor=a.actor)};return Wa.inherit(p,a),a.prototype.match=function(a){if(!a)return!1;if(!a.is_group("add","sub"))return!1;if(!a.ls)return!1;var b=a.ls;return b.children[1].is_group("fraction")&&a.children[1].is_group("fraction")},a.prototype.transform=function(a){this.addTouchedNodes(this.actor),this.addTouchedNodes(this.actor.ls);var b=this.getNewTreeNode(this.actor.ls).children[1],c=this.getNewTreeNode(this.actor).children[1],d=this.getUncommonDenominatorFactors(b,c),e=this.getUncommonDenominatorFactors(this.actor.ls.children[1],this.actor.children[1]);if(d.leftUncommonFactors.forEach(Va.remove),d.rightUncommonFactors.forEach(Va.remove),this.sortDenominatorsToMatch(b,c),d.leftUncommonFactors.length>0){var f=this.extendFractionWithFactors(b,d.leftUncommonFactors),g=this.extendFractionWithFactors(c,d.leftUncommonFactors,!0,!0);this.mapOldFactorsToNewFactors(e.leftUncommonFactors,f,g)}if(d.rightUncommonFactors.length>0){var h=this.extendFractionWithFactors(b,d.rightUncommonFactors,!0),i=this.extendFractionWithFactors(c,d.rightUncommonFactors);this.mapOldFactorsToNewFactors(e.rightUncommonFactors,h,i)}return"function"!=typeof a||void a(this)},a.prototype.getUncommonDenominatorFactors=function(a,b){for(var c=a.get_bottom().slice(),d=b.get_bottom().slice(),e=0;e<c.length;){for(var f=c[e],g=!1,h=0;h<d.length;h++){var i=d[h];if(f.to_ascii()===i.to_ascii()){d.splice(h,1),g=!0;break}}g?c.splice(e,1):e++}return{leftUncommonFactors:c,rightUncommonFactors:d}},a.prototype.sortDenominatorsToMatch=function(a,b){for(var c=a.get_bottom().slice(),d=b.get_bottom().slice(),e=0;e<c.length;e++)if(c[e].to_ascii()!==d[e].to_ascii())for(var f=e;f<d.length;f++)if(c[e].to_ascii()===d[f].to_ascii()){var g=d[f];g.remove(),b.insert(b.get_top().length+e+1,g),d=b.get_bottom().slice();break}},a.prototype.extendFractionWithFactors=function(a,b,c,d){var e=[];return c&&1===a.get_top().length&&E.is_num(a.children[0].children[1])&&1===E.get_value(a.children[0].children[1])&&a.children[0].remove(),b.forEach(function(f){var g=[],h=f.clone();g.push(h),a.append(h),c&&(h=f.clone(),h.invert(),g.push(h),d?a.insert(b.indexOf(f),h):a.append(h)),e.push(g)}),e},a.prototype.mapOldFactorsToNewFactors=function(a,b,c){for(var d=0;d<a.length;d++)for(var e=a[d],f=b[d].concat(c[d]),g=0;g<f.length;g++)this.extendNodeMap(e.get_mapping_to(f[g]))},v.prototype.add_action_handler(new a),new a}(),function(){var a=function(a){p.call(this,"ProductFractionCleanup","product-fraction cleanup action"),a&&(this.actor=a.actor)};Wa.inherit(p,a),a.prototype.match=function(a){var b=a.get_top().length,c=a.get_bottom().length;return 0===b&&0===c||("product"===a.value&&c>0||("fraction"===a.value&&0===c||("fraction"===a.value&&0===b||1===b&&0===c)))},a.prototype.doInPlace=function(a){this.initNodeMap();var b,c,d=this.getNewTreeNode(this.actor),e=this.actor,f=d.get_top().length,g=d.get_bottom().length;if(0===f&&0===g){var h=new E(1);b=Va.get_mapping_between(this.actor,h),this.updateNodeMap(b),Va.replace(d,h),h.parent.is_group("brackets")&&x.handle(h.parent,!0),c=!0}if(!c&&"product"===e.value&&g>0&&d.invert(),c||"fraction"!==e.value||0!==g||d.invert(),"fraction"===e.value&&0===f&&(e.children[0]instanceof t||Va.insert(d,0,new t("//")),Va.insert(d,0,new K(new E(1)))),1===f&&0===g){var i=d.get_top()[0].children[1];if(this.updateNodeMap(e,i),this.updateNodeMap(e.children[0],i),this.updateNodeMap(e.children[0].children[0],i),Va.replace(d,i),i.parent.is_group("brackets"))x.handle(i.parent,!0);else{if(i.is_group("brackets"))var j=i.children[1];var k=x.handle(i,!0);j&&"removed"===k&&(this.updateNodeMap(e,j),this.updateNodeMap(e.children[0],j),this.updateNodeMap(e.children[0].children[0],j))}}return"function"!=typeof a?this:void a(this)},J.prototype.cleanupAction=new a}(),function(){var a=function(a){p.call(this,"RadicalCleanup","power cleanup action"),a&&(this.actor=a.actor)};Wa.inherit(p,a),a.prototype.match=function(a){return a.is_group("radical")&&a.children.length<4},a.prototype.doInPlace=function(a){this.initNodeMap();var b=this.getNewTreeNode(this.actor),c=b.parent;this.actor.parent;if(b.is_group("radical")&&b.children.length<4){var d=b.children[2],e=(this.getOldTreeNode(d),Va.remove(b));this.updateNodeMap(this.actor,c),c.insert(e,d)}return"function"!=typeof a?this:void a(this)},D.prototype.cleanupAction=new a}(),Wa.actions.RootEvaluateAction=function(){var a=function(a){p.call(this,"RootEvaluateAction","evaluate a root"),this.priority=0,this.triggerType="tap",a&&(this.actor=a.actor)};Wa.inherit(p,a),a.prototype.match=function(a){if(!a.is_group("radical"))return!1;var b=a.get_degree().get_term(),c=a.get_radicand();return E.is_inequal_to(c,"gte",0)&&E.is_num(b)&&0!==E.get_value(b)||E.is_inequal_to(c,"lt",0)&&E.is_inequal_to(b,"gt",0)&&E.get_value(b)%2===1},a.prototype.transform=function(a){this.addTouchedNodes(this.actor);var b=this.getNewTreeNode(this.actor),c=Math.pow(Math.abs(E.get_value(b.get_radicand())),1/E.get_value(b.get_degree().get_term())),d=new E(c);if(this.updateNodeMap(this.actor.get_mapping_to(d)),Va.replace(b,d),E.get_value(b.get_radicand())<0){var e=d.parent,f=d.remove(),g=new Q(d);e.insert(f,g)}return"function"!=typeof a||void a(this)};var b=new a;return D.prototype.add_action_handler(b),b}(),D.prototype.add_action_handler(Wa.actions.RootEvaluateAction),Wa.actions.RadicalExtractExponentAction=function(){var a=function(a){p.call(this,"RadicalExtractExponentAction","factor power"),this.interactionType="drag",this.settings={side:"outside",reset_x:!0,reset_y:!0},a&&(this.nodes=a.nodes,this.target=a.target)};return Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(a){var b=this.matchSource(a);if(!b)return[];var c=this.getTargets(b);return this.bindActionForEachTarget(a,c)},a.prototype.matchSource=function(a){return 1===a.length&&(!(!a[0].is_group("exponent")||!a[0].get_parent(2).is_group("radical"))&&{nodes:a,power:a[0].parent})},a.prototype.getTargets=function(a){return[a.power]},a.prototype.transform=function(a){this.addTouchedNodes(this.target.parent);var b=this.getNewTreeNode(this.nodes)[0],c=b.parent,d=c.parent,e=d.parent,f=c.children[0];c.replace_with(f),x.handle(f);var g=d.remove();return b.remove(),e.insert(g,new I(d,b)),"function"!=typeof a||void a(this)},new a}(),fa.prototype.move_actions.push(Wa.actions.RadicalExtractExponentAction),Wa.actions.RadicalInsertExponentAction=function(){var a=function(a){p.call(this,"RadicalInsertExponentAction","factor power"),this.interactionType="drag",this.settings={side:"inside",reset_x:!0,reset_y:!0},a&&(this.nodes=a.nodes,this.target=a.target)};return Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(a){var b=this.matchSource(a);if(!b)return[];var c=this.getTargets(b);return this.bindActionForEachTarget(a,c)},a.prototype.matchSource=function(a){if(!Va.is_range(a))return!1;if(!(a[0].is_group("exponent")||a[0].is_group("mul","div")&&x.areHidden(a[0].get_parent(2))&&a[0].get_parent(3).is_group("exponent")))return!1;var b=a[0].parent.is_group("power")?a[0].parent:a[0].get_parent(4);return!(!b.children[0].is_group("brackets")||!b.children[0].children[1].is_group("radical"))&&{nodes:a,radical:b.get_child([0,1])}},a.prototype.getTargets=function(a){return[a.radical]},a.prototype.transform=function(a){this.addTouchedNodes(this.target.parent);var b=this.getNewTreeNode(this.nodes),c=b[0].is_group("exponent")?b[0]:b[0].get_parent(3),d=c.parent,e=d.get_child([0,1]),f=e.get_radicand();d.parent;if(b[0]===c){d.replace_with(e),f.remove();var g=new I(f,c);e.set_radicand(g)}else{Va.remove_range(b);var h=new J;h.append_range(b);var i=new M(h);f.remove();var g=new I(f,i);e.set_radicand(g),this.cleanup_cascade(c.get_child([0,1])),E.is_equal_to(c.children[0],1)&&(c.remove(),this.cleanup(d)),this.cleanup_cascade(b[0].parent)}return"function"!=typeof a||void a(this)},new a}(),fa.prototype.move_actions.push(Wa.actions.RadicalInsertExponentAction),Wa.actions.RadicalSplitAction=function(){var a=function(a){p.call(this,"RadicalSplitAction","turn a radical that has a product radicand into a product of radicals"),this.priority=1,this.triggerType="drag",this.settings={target_group:!0,group_side:"outside"},a&&(this.nodes=a.nodes,this.target=a.target,this.settings.side=a.side)};return Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(a){var b=this.matchSource(a);if(!b)return[];var c=this.getTargets(b);return this.bindActionForEachTarget(a,c,!0)},a.prototype.matchSource=function(a){if(!Va.is_range(a))return!1;var b=a[0];if(!b.is_group("mul","div"))return!1;var c=b.get_parent(2);return!!c.is_group("radical")&&{nodes:a,radicand:b.parent}},a.prototype.getTargets=function(a){return[a.radicand]},a.prototype.transform=function(a){this.addTouchedNodes(this.target.parent);var b=this.getNewTreeNode(this.nodes),c=b[0].parent,d=c.parent,e=d.parent,f=d.remove();Va.remove_range(b);var g=d.clone(!1);g.set_radicand(null);var h=!1,i=new J;1===b.length&&J.is_fraction_with_identity_numerator(b[0].children[1])&&(b=b[0].children[1].get_bottom(),Va.remove_range(b)),b.forEach(function(a){a.is_group("div")&&(h=!0,a.invert()),i.append(a)},this),g.set_radicand(i);var j=new J;j.append(new K(d));var k=new K(g,h?"div":"mul");return j.insert("left-of"===this.settings.side?0:1,k),e.insert(f,j),this.nodes[0].get_parent(2).map_to_radical(this,g),this.setNodesToReselectAfterAction(k),this.cleanup(c),this.cleanup(i),this.cleanup(j),this.cleanup_cascade(e),"function"==typeof a&&a(this),this},new a}(),fa.prototype.move_actions.push(Wa.actions.RadicalSplitAction),Wa.actions.ScaleTupleAction=function(){var a=function(a){p.call(this,"ScaleTupleAction","multiply a tuple by a number"),this.priority=1,this.triggerType="tap",this.settings={delay:300,side:"inside",margin:{x:.1},reset_x:!0,reset_y:!0},a&&("drag"===a.triggerType?(this.triggerType=a.triggerType,this.nodes=a.nodes,this.target=a.target):this.actor=a.actor)};return Wa.inherit(p,a),a.prototype.isTupleMul=function(a){return a&&a.is_group("mul")&&a.children[1].is_group("brackets")&&a.children[1].children[1].is_group("tuple")},a.prototype.getAllAvailableActions=function(a){if(!a.every(this.isScalarMul.bind(this)))return[];var b=this,c=a[0].parent.children.filter(this.isTupleMul.bind(this)),d=a[0].get_root();return c.map(function(c){return b.createBoundAction(d,{nodes:a,target:c,triggerType:"drag"})})},a.prototype.getTupleFactorsInSum=function(a){var b=this;re;var c=sum.children.filter(function(a){return a!==n&&b.isTupleAddend(a,len)});return c},a.prototype.isScalarMul=function(a){return a&&a.is_group("mul","div")&&!a.select_first(function(a){return a.is_group("tuple")})},a.prototype.extract=function(a){return!!a&&(this.isTupleMul(a)&&this.isScalarMul(a.ls)?{scalars:[a.ls],tuple:a}:!(!this.isTupleMul(a.ls)||!this.isScalarMul(a))&&{scalars:[a],tuple:a.ls})},a.prototype.match=function(a){if(a.is_group("fraction")){var b=a.get_top(),c=a.get_bottom();if(1===b.length&&this.isTupleMul(b[0])&&c.every(this.isScalarMul))return!0}else if(a.is_group("mul","div"))return!!this.extract(a);return!1},a.prototype.getTupleAndScalars=function(){var a={};if("tap"===this.triggerType){this.addTouchedNodes(this.actor);var b=this.getNewTreeNode(this.actor);if(this.actor.is_group("fraction"))a.parent_product=b,a.tuple=b.get_child([0,1,1]),a.scalar_muldivs=b.get_bottom();else{var c=this.extract(b);a.scalars_were_on_the_left=c.scalars[0].get_idx()<c.tuple.get_idx(),a.parent_product=b.parent,a.tuple=c.tuple.get_child([1,1]),a.scalar_muldivs=c.scalars}}else{this.addTouchedNodes(this.nodes),this.addTouchedNodes(this.target);var d=this.getNewTreeNode(this.nodes),e=this.getNewTreeNode(this.target);a.scalars_were_on_the_left=d[0].get_idx()<e.get_idx(),a.parent_product=d[0].parent,a.scalar_muldivs=d,a.tuple=e.get_child([1,1])}return a},a.prototype.transform=function(a){for(var b=this.getTupleAndScalars(),c=b.scalars_were_on_the_left,d=b.parent_product,e=b.scalar_muldivs,f=b.tuple,g=0;g<f.children.length;g++)this.scale_parameter(c,f.children[g],e);Va.remove_range(e),this.cleanup(d);for(var g=0;g<f.children.length;g++)this.cleanup_nested_products(f.children[g].children[1]);return"function"==typeof a&&a(this),this},a.prototype.scale_parameter=function(a,b,c){var d=b.children[1],e=d.is_group("fraction")?d:new J,f=Va.clone(c);this.extendNodeMap(Va.get_mapping_between(this.nodes||this.getOldTreeNode(c),f)),d.remove(),e.is_group("product")?(e.append(new K(d)),e.insert_range(a?0:1,f)):a?f.forEach(function(a){a.is_group("div")?e.insert_into_denominator(0,a):e.insert(0,a)}):f.forEach(function(a){e.append(a)}),e.simplify=!0,b.append(e)},a.prototype.cleanup_nested_products=function(a){for(var b=0;b<a.children.length;b++)this.cleanup(a.children[b])},K.prototype.add_action_handler(new a),J.prototype.add_action_handler(new a),new a}(),fa.prototype.move_actions.push(Wa.actions.ScaleTupleAction),Wa.actions.SplitExponentsAction=function(){var a=function(a){p.call(this,"SplitExponentsAction","split exponents"),this.triggerType="drag",this.settings={},a&&(this.nodes=a.nodes,this.target=a.target,this.settings.side=a.side)};return Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(a){if(!this.match(a[0]))return[];if(a.length===a[0].parent.children.length)return[];var b=a[0].get_root(),c=a[0].parent.parent.parent.parent;return[this.createBoundAction(b,{nodes:a,target:c,side:"left-of"}),this.createBoundAction(b,{nodes:a,target:c,side:"right-of"})]},a.prototype.match=function(a){try{var b=(a.is_group("add")||a.is_group("sub"))&&a.parent.parent.parent.is_group("exponent");return b}catch(a){return!1}},a.prototype.transform=function(a){this.addTouchedNodes(this.target);var b,c=this.getNewTreeNode(this.nodes),d=this.getNewTreeNode(this.target);b=0===c[0].parent.children.indexOf(this.nodes[0])?c[0].parent.children[c.length].children[0]:c[0].parent.children[0].children[0];var e=d,f=e.parent,g=e.remove();this.extractNodesFromPowerExponentSum(c);var h=this.createSplittedOffPower(c),i=this.placePowersIntoProduct(e,h),j=this.nodes[0].children[0];this.extendNodeMap(j,h.parent.children[0]),this.extendNodeMap(b,e.parent.children[0]);for(var k=0;k<this.nodes.length;k++)this.updateNodeMap(this.nodes[k],h.parent);return(f.is_group("mul")||f.is_group("div"))&&this.extendNodeMap(this.getOldTreeNode(f.children[0]),h.parent.children[0]),f.insert(g,i),this.cleanup(i.children[0].children[1].children[1].children[0].children[1]),this.cleanup(i.children[1].children[1].children[1].children[0].children[1]),x.handle(i.children[0].children[1].children[1].children[0],!0),x.handle(i.children[1].children[1].children[1].children[0],!0),this.cleanup(f),h.children[1].simplify=!0,"function"!=typeof a||void a(this)},a.prototype.extractNodesFromPowerExponentSum=function(a){Va.remove_range(a)},a.prototype.createSplittedOffPower=function(a){var b=this.target.children[0],c=M.prototype.createGroup(),d=Va.clone(b);this.extendNodeMap(b,d),c.append(d);var e=v.prototype.createGroup();e.append_range(a);var f=new M(e);return c.append(f),c},a.prototype.placePowersIntoProduct=function(a,b){var c=K.prototype.createGroup(),d=this.settings.side;c.append(new K(a));var e=new K(b);return"left-of"===d?c.insert(0,e):c.append(e),c},new a}(),fa.prototype.move_actions.push(Wa.actions.SplitExponentsAction),Wa.actions.SplitNumberAction=function(){var a=function(a){p.call(this,"SplitNumberAction","n => (n-1) + 1"),this.priority=0,this.triggerType="split",a&&(this.actor=a.actor)};return Wa.inherit(p,a),a.prototype.match=function(a){return a instanceof E&&a.value>1},a.prototype.transform=function(a){var b=this.getNewTreeNode(this.actor);this.addTouchedNodes(this.actor);var c=b.parent,d=b.remove();b.value--;var e=v.prototype.createGroup();return e.append(new v(b)),e.append(new v(new E(1))),this.resultNodes=e.children.slice(),this.updateNodeMap(this.actor.get_mapping_to(e)),c.insert(d,e),x.handle(e),this.cleanup(c),"function"==typeof a&&a(this),!0},new a}(),Wa.actions.SplitProductAction=function(){var a=function(a){p.call(this,"SplitProductAction","n*x => (n-1)*x + x"),this.priority=1,this.triggerType="split",a&&(this.actor=a.actor,"priority"in a&&(this.priority=a.priority))};return Wa.inherit(p,a),a.prototype.match=function(a){return a.is_group("mul")&&a.children[1]instanceof E&&a.children[1].value>1&&a.rs},a.prototype.transform=function(a){var b=this.getNewTreeNode(this.actor),c=b.parent,d=b.children[1];this.addTouchedNodes(this.actor),d.value--;var e,f=c.children.slice(c.children.indexOf(b)),g=this.getOldTreeNode(f),h=Va.remove_range(f),i=v.prototype.createGroup(),j=K.prototype.createGroup(),k=K.prototype.createGroup();1===d.value?(b.remove(),f=f.slice(1),j.insert_range(0,f),e=Va.clone(f),k.insert_range(0,e),this.extendNodeMap(Va.get_mapping_between(g.slice(1),e))):(j.insert_range(0,f),e=Va.clone(f),k.insert_range(0,e),k.children[0].remove(),this.extendNodeMap(Va.get_mapping_between(g,e))),i.append(new v(j)),i.append(new v(k));var l=new K(i);c.insert(h,l),this.cleanup(j),this.cleanup(k);var m=c.parent;return this.cleanup(c)&&this.cleanup(m),"function"==typeof a&&a(this),!0},a.prototype.mapIndex=function(){return map={},function(a){return map[a]}},new a}(),Wa.actions.SplitPowerAction=function(){var a=function(a){p.call(this,"SplitPowerAction","x^n => x^(n-1) * x"),this.priority=2,this.triggerType="split",a&&(this.actor=a.actor,"priority"in a&&(this.priority=a.priority))};return Wa.inherit(p,a),a.prototype.match=function(a){return a.is_group("exponent")&&a.children[0]instanceof E&&a.children[0].value>=1},a.prototype.transform=function(a){var b=this.getNewTreeNode(this.actor),c=b.parent,d=c.parent;this.addTouchedNodes(this.actor);var e=c.remove(),f=K.prototype.createGroup();f.append(new K(c));var g=Va.clone(c.children[0]);this.extendNodeMap(this.actor.parent.children[0].get_mapping_to(g)),f.append(new K(g));var h=b.children[0];if(h.value--,this.extendNodeMap(this.actor.children[0],g.parent),1===h.value){var i=c.children[0];c.remove(),f.children[0].append(i),this.extendNodeMap(this.actor.children[0],i.parent)}else 0===h.value&&f.children[0].remove();return this.resultNodes=f.children.slice(),d.insert(e,f),this.cleanup(d),"function"==typeof a&&a(this),!0},new a}(),Wa.actions.SplitPowerSumAction=function(){var a=function(a){p.call(this,"SplitPowerSumAction","x^(n1+n2+...+nm) => x^(n1+n2+...) * x^(nm)"),this.priority=3,this.triggerType="split",a&&(this.actor=a.actor)};return Wa.inherit(p,a),a.prototype.match=function(a){return a.is_group("exponent")&&(a.children[0].is_group("brackets")&&a.children[0].children[1].is_group("sum")||a.children[0].is_group("sum"))},a.prototype.transform=function(a){var b=this.getNewTreeNode(this.actor),c=b.parent,d=c.parent,e=b.children[0];e.is_group("brackets")&&(e=e.children[1]);var f=e.children[e.children.length-1],g=this.getOldTreeNode(f.children[0]);this.addTouchedNodes(this.actor.parent);var h=c.remove(),i=K.prototype.createGroup();i.append(new K(c));var j=Va.clone(c);i.append(new K(j)),j.children[1].children[0].remove(),f.remove();var k=f.createGroup();return k.append(f),j.children[1].append(k),d.insert(h,i),g.parent.is_group("add")?this.updateNodeMap(g,i.children[1].children[0]):this.extendNodeMap(g,i.children[1].children[0]),this.cleanup(f.parent),this.cleanup(e),this.cleanup(d),"function"==typeof a&&a(this),!0},new a}(),Wa.actions.DistributeIntoBracketsAction=function(){var a=function(a){p.call(this,"DistributeIntoBracketsAction","distribute"),this.triggerType="drag",this.settings={side:"around",reset_x:!0,reset_y:!0,delay:300},this.priority=2,a&&(this.nodes=a.nodes,this.target=a.target)};return Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(a){function b(b){b.children[1]&&b.children[1].is_group("brackets")&&(f=b.children[1].children[1],e.match(a,f,"around")&&c.push(e.createBoundAction(d,{nodes:a,target:f})))}var c=[];if(0===a.length)return c;var d=a[0].get_root();if(!a[0].is_group("mul")&&!a[0].is_group("div"))return[];for(var e=this,f=a[0];f=f.ls;)b(f);for(f=a[a.length-1];f=f.rs;)b(f);return c},a.prototype.match=function(a,b,c){if(0===a.length)return!1;if("("===b.value||")"===b.value)return!1;var d=b.parent;if(!d.parent)return!1;var e=d.parent.value;if("mul"!==e&&"div"!==e)return!1;for(var f=0;f<a.length;f++)if(a[f].value!==e)return!1;return d.parent.parent===a[0].parent&&(!!d.is_group("brackets")&&(!!d.children[1].is_group("sum")&&(!!a[0].commutative&&(("left-of"!==c||d.ls!==a[a.length-1])&&("right-of"!==c||d.rs!==a[0])))))},a.prototype.transform=function(a){var b,c=this.getNewTreeNode(this.nodes),d=this.getNewTreeNode(this.target),e=this.target.parent.children[0],f=this.target.parent.children[2],g=d.parent;c[c.length-1].rs&&c[c.length-1].rs.children[1]&&c[c.length-1].rs.children[1]===g&&(b="left"),c[0].ls&&c[0].ls.children[1]===g&&(b="right");var h=g.parent.parent,i=g.children[1];Va.remove_range(c),this.distributeIntoSum(i,c,b),h.cleanupAction&&this.cleanup(h);var j=i.parent;if(!j.is_group("brackets")||j.is_group("brackets")&&j.parent.is_group("mul","div")&&j.parent.parent.is_group("fraction")&&(j.parent.is_group("mul")?1===j.parent.parent.get_top().length:1===j.parent.parent.get_bottom().length)){var k=i.remove(),l=new x(i);Va.insert(j,k,l),this.updateNodeMap(e.parent,l),this.updateNodeMap(e,l.children[0]),this.updateNodeMap(f,l.children[2]),l.simplify=!0}return"function"!=typeof a||void a(this)},a.prototype.distributeIntoSum=function(a,b,c){function d(a){return a.some(function(a){return a.is_group("mul")&&E.is_num(a.children[1])})}function e(a){return a.children.some(function(a){return a.is_group("mul")&&E.is_num(a.children[1])&&0===E.get_value(a.children[1])})}function f(a){return!a.some(function(a){return a.is_group("mul")&&0===E.get_value(a.children[1])})}for(var g=a.children.length,h=function(a){a.is_group("div")&&a.invert()},i=0;i<g;i++){var j,k,l=a.children[i].children[1];l.remove(),l.is_group("product")?j=l:(j=new J,j.append(new K(l))),k="left"===c&&0===i||"right"===c&&i===g-1?b:Va.clone(b),k.forEach(h),this.extendNodeMap(Va.get_mapping_between(this.nodes,k));var m="left"===c?1:j.children.length-1;j.children[m]&&(j.children[m].simplify=!0);var n="left"===c?0:j.children.length;j.insert_range(n,k),a.children[i].append(j),f(b)&&(d(b)||e(j))&&(j.children.forEach(function(a){a.simplify=!1}),j.simplify=!0)}},new a}(),fa.prototype.move_actions.push(Wa.actions.DistributeIntoBracketsAction),Wa.actions.FactorOutOfBracketsAction=function(){var a=function(a){p.call(this,"FactorOutOfBracketsAction","factor out"),this.priority=0,this.triggerType="drag",this.settings={},a&&(this.nodes=a.nodes,this.target=a.target,this.settings.side=a.side)};return Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(a){if(0===a.length)return[];for(var b=[],c=a[0];c.parent&&!c.is_group("brackets");)c=c.parent;return this.match(a)&&(b.push(this.bindLeftSideAction(c,a)),b.push(this.bindRightSideAction(c,a))),b},a.prototype.nodesAreAllAddends=function(a,b){return!!a.is_group("sum")&&a.children.length===b.length},a.prototype.bindLeftSideAction=function(a,b){var c=b[0].get_root();return this.createBoundAction(c,{nodes:b,target:a.children[0],side:"left-of"})},a.prototype.bindRightSideAction=function(a,b){var c=b[0].get_root();return this.createBoundAction(c,{nodes:b,target:a.children[2],side:"right-of"})},a.prototype.getContainingBrackets=function(a){try{for(var b=null,c=0;c<a.length;c++){var d=a[c][0],e=d.is_group("mul")?d.get_parent(4):d.get_parent(3);if(!e||!e.is_group("brackets")||x.areHidden(e))return null;if(b){if(b!==e)return null}else b=e}return b}catch(a){return null}},a.prototype.match=function(a,b){var c=fa.groupNodeRanges(a),d=this.getContainingBrackets(c);if(!d)return!1;if(b&&d.children[0]!==b&&d.children[2]!==b)return!1;if(!this.nodesAreAllAddends(d.children[1],c))return!1;var e=c[0].length;c.forEach(function(a){if(a.length!==e)return!1});for(var f=0;f<e;f++){var g;g="mul"===c[0][f].value?c[0][f].children[1].to_ascii():c[0][f].to_ascii();for(var h=0;h<c.length;h++){var i;if(i="mul"===c[h][f].value?c[h][f].children[1].to_ascii():c[h][f].to_ascii(),i!==g)return!1}}var j=Va.get_cca(a);return j.is_group("sum")&&j.parent===d},a.prototype.transform=function(a){var b=this.getNewTreeNode(this.nodes),c=this.findBracketGroup(b),d=fa.groupNodeRanges(b),e=d.map(this.getOldTreeNode.bind(this));this.removeRangesFromSum(d);var f=this.factor(c,d,e);if(f.is_group("brackets")&&x.is_optional(f)){var g=f.parent;x.handle(f,!0),f=g}return f.cleanupAction&&this.cleanup(f),"function"!=typeof a||void a(this)},a.prototype.findBracketGroup=function(a){var b=a[0];if(b&&b.parent&&b.parent.parent&&b.parent.parent.is_group("sum")&&b.parent.parent.parent&&b.parent.parent.parent.is_group("brackets"))return b.parent.parent.parent;if(b&&b.parent&&b.parent.is_group("product")&&b.parent.parent&&b.parent.parent.parent&&b.parent.parent.parent.is_group("sum")&&b.parent.parent.parent.parent&&b.parent.parent.parent.parent.is_group("brackets"))return b.parent.parent.parent.parent;throw"Attempting to factor from invalid structure."},a.prototype.removeRangesFromSum=function(a){for(var b=0;b<a.length;b++){var c=a[b],d=a[b][0].parent;if(c.length===d.children.length){var e=d.parent;d.remove(),Va.remove_range(c),e.append(new E(1)),this.cleanup(e)}else"add"===d.value||"sub"===d.value&&1===c.length?(c[0].remove(),d.append(new E(1))):(Va.remove_range(a[b]),this.cleanup(d))}},a.prototype.factor=function(a,b,c){return this.replaceBracketGroupWithFactoredProduct(a,b,c)},a.prototype.replaceBracketGroupWithFactoredProduct=function(a,b,c){var d,e=K.prototype.createGroup(),f=a.parent,g=a.remove(),h=this.settings.side;if("left-of"===h){d=b[0],1===d.length&&"mul"!==d[0].value&&(d=[new K(d[0])]),e.append_range(d),e.append(new K(a));for(var i=0;i<c.length;i++)1!==c[i].length||c[i][0].is_group("mul")?this.updateNodeMap(Va.get_mapping_between(c[i],d)):this.updateNodeMap(c[i][0],d[0])}else{d=b[b.length-1],1===d.length&&"mul"!==d[0].value&&(d=[new K(d[0])]),e.append(new K(a)),e.append_range(d);for(var i=0;i<c.length;i++)1!==c[i].length||c[i][0].is_group("mul")?this.updateNodeMap(Va.get_mapping_between(c[i],d)):this.updateNodeMap(c[i][0],d[0])}return Va.insert(f,g,e),f},a.prototype.mapIndex=function(){return function(){}},new a}(),fa.prototype.move_actions.push(Wa.actions.FactorOutOfBracketsAction),Wa.actions.SubstitutionAction=function(){function a(a){return 1===a.length&&(a[0].hidden||a[0].is_group("tuple"))?"":a.map(function(a){return a.to_ascii()}).join("")}function b(a){return a.is_group()&&a.commutative&&a.associative}function c(a){if(0===a.length)return"";if(1===a.length&&(a[0].hidden||a[0].is_group("tuple")))return"";var c=a.map(function(a){return a.to_ascii()}).join("");return 1===a.length?c:b(a[0])?c.substring(a[0].children[0].to_ascii().length):c}function d(a){if(1!==a.length)return"";if(!a[0].is_group("fraction"))return"";var b=a[0].to_ascii();return"("===b.slice(0,1)&&")"===b.slice(b.length-1,b.length)&&(b=b.substr(1,b.length-2)),b}function e(a){if(a.length<2)return"";if(!a[0].is_group("div"))return"";var b=a.map(function(a){return a.to_ascii()}).join("").replace(/\//g,"*").substr(1);return b}function f(a){return a[0]&&a[0].parent&&!a[0].parent.is_group("exponent")&&a.length===a[0].parent.children.length}function g(a){return a.parent}function h(b){return function(h){return 0!==h.length&&(!!h[0].parent&&((!g(h[0].parent)||!f(h))&&(a(h)===b||c(h)===b||d(h)===b||e(h)===b)))}}var i=function(a){p.call(this,"SubstitutionAction","substitution"),this.settings={layout_hint:"same-line"},a&&(this.nodes=a.nodes,this.target=a.target)};return Wa.inherit(p,i),i.prototype.rebind=function(a,b,c){if(this.nodes[0]===c)this.nodes[0]=a;else{if(this.oldTree!==c)throw"wrong old tree during rebinding an action!";var d=new p;d.node_map=b,this.oldTree=a,this.target=d.mapNodes(this.target)}},i.prototype.getAllAvailableActions=function(a,b){for(var c=this.findAllMatches(a,b),d=[],e=0;e<c.length;e++){var f=Wa.actions.SubstitutionAction.createBoundAction(b,{nodes:[a],target:c[e]});d.push(f)}return d},i.prototype.match=function(a,b){if(0===b.length||b[0].fixed)return!1;if(a.parent||(a=a.children[0]),!a.is_group("equals"))return!1;var c=a.children[0].to_ascii(),d=h(c);return d(b)},i.prototype.rematch=function(){if(!(this.nodes&&this.nodes.length>0&&this.target&&this.target.length>0))return!1;var a=[];return this.target.forEach(function(b){var c=this.getAllAvailableActions(this.nodes[0],b.get_root());c.forEach(function(b){a=a.concat(b.target)})},this),this.target.every(function(b){return a.indexOf(b)!==-1})},i.prototype.findAllMatches=function(a,b){if(a.parent||(a=a.children[0]),!a.is_group("equals"))return[];b.parent||(b=b.children[0]);var c=a.children[0].to_ascii(),d=b.filterRange(h(c));return d=d.filter(function(a){return a.length>0&&!a[0].fixed})},i.prototype.transform=function(a){for(var b=this,c=this.nodes[0].children[0].children[0].to_ascii(),d=this.nodes[0].children[0].children[2],e=fa.groupNodes(this.target,function(a){return!h(c)(a)}),f=e.map(function(a){return a.map(b.getNewTreeNode.bind(b))}),g=0;g<e.length;g++){var i=f[g],j=i[0].parent,k=Va.remove_range(i),l=Va.clone(d);i.length>1&&(l=new i[0].constructor(l),l.is_group("mul")&&i[0].is_group("div")&&l.invert()),this.sourceIsASignGroupOrHasALeadingNegativeCoefficient(this.nodes[0])&&i[0].is_group("sub")&&(l=new v(l)),j.insert(k,l),e[g].forEach(function(a){this.updateNodeMap(a,l),this.updateNodeMap(d,l),this.updateNodeMap(Va.get_leaf_nodes(a),Va.get_leaf_nodes(l)),this.updateNodeMap(Va.get_leaf_nodes(d),Va.get_leaf_nodes(l))},this);var m=this.applyInnerAction("AddSubCombineSigns",{actor:l});m||"AlgebraModel"===j.type||(m=this.applyInnerAction("AddSubCombineSigns",{actor:j}),!m&&j.parent.parent&&(m=this.applyInnerAction("AddSubCombineSigns",{actor:j.parent.parent})),m||this.applyInnerAction("SignDoubleNegAction",{actor:j}));var n=this.cleanup(l);n||x.handle(l),this.cleanup(j)}return"function"==typeof a&&a(this),!0},i.prototype.sourceIsASignGroupOrHasALeadingNegativeCoefficient=function(a){var b=a.children[0].children[0];return!!b.is_group("sign")||!(!b.is_group("product")||!b.children[0].children[1].is_group("sign"))},new i}(),ub=function(){var a=function(a){p.call(this,"TriggerFactoringAction","general factoring"),
this.priority=0,this.triggerType="drag",this.settings={side:"around"},a&&(this.DLOfSum=a.dl,this.viewOfSum=a.view,this.target=a.sum,this.callback=a.callback)};Wa.inherit(p,a),a.prototype.match=function(a,c){return b(a,c)},a.prototype.transform=function(){this.callback(this.viewOfSum,this.target,this.DLOfSum)};var b=function(a,b){var c;c=d(a,b),c=e(c,a);for(var f=[],g=0;g<c.length;g++)if(0===c[g].length)return!1;for(var g=0;g<c.length;g++)c[g]&&f.push(c[g][c[g].length-1]);for(var g=0;g<f.length;g++)Array.isArray(f[g])||"add"===f[g].parent.value||"sub"===f[g].parent.value||(f[g]=f[g].parent);return f.length===a.children.length&&f},c=function(a,b){var c=[];return a.for_each(function(a){var d=a.to_ascii();if("*"===d.slice(0,1)&&(d=d.substr(1)),a.hidden||d!==b){for(var e=[a];d.length<b.length&&a.commutative&&a.rs;)a=a.rs,d+=a.to_ascii(),e.push(a);d===b&&c.push(e)}else c.push(a)}),c},d=function(a,b){for(var d=[],e=0;e<a.children.length;e++){var f=a.children[e],g=f.children[1];d.push(c(g,b.to_ascii()))}return d},e=function(a,b){for(var c=function(a){return a.parent&&("add"===a.parent.value||"sub"===a.parent.value)&&a.parent.parent&&a.parent.parent==b},d=function(a){return a.parent&&"mul"===a.parent.value&&a.parent.parent&&a.parent.parent.is_group("product")&&a.parent.parent.parent&&a.parent.parent.parent.parent&&a.parent.parent.parent.parent==b},e=function(a){return"mul"===a.value&&a.parent&&a.parent.is_group("product")&&a.parent.parent&&a.parent.parent.parent&&a.parent.parent.parent==b},f=function(a){var b=!0;if(!Array.isArray(a))return c(a)||d(a);for(var f=0;f<a.length;f++)e(a[f])||(b=!1);return b},g=0;g<a.length;g++)a[g]=a[g].filter(f);return a};return new a}(),Wa.actions.showRoundedAction=function(){var a=function(a){p.call(this,"showRoundedAction","show rounded"),this.priority=1,this.triggerType="hold",a&&(this.actor=a.actor)};return Wa.inherit(p,a),a.prototype.match=function(a){return!!a.is_group("num")&&(null===a.precision||a.decimal_count()>a.precision)},a.prototype.transform=function(a){var b=this.getNewTreeNode(this.actor);return null===b.precision?b.precision=2:b.precision=null,"function"==typeof a&&a(this),this},new a}(),Wa.actions.EvalTrigAction=function(){var a=function(a){p.call(this,"EvalTrigAction","evaluate trig functions"),this.priority=0,this.triggerType="tap",this.settings={},a&&(this.actor=a.actor,this.settings.angleType=a.angleType||"rad")};return Wa.inherit(p,a),a.prototype.match=function(a){return!!N.Trig.is_trig_func(a)&&(a.children[1]&&a.children[1].is_group("brackets")&&a.children[1].children[1].is_group("tuple")&&E.is_num(a.children[1].children[1].children[0].children[1]))},a.prototype.transform=function(a){var b=this.getNewTreeNode(this.actor);this.addTouchedNodes(this.actor);var c=N.Trig.evaluate(b);if(!Number.isNaN(c)&&c!==1/0&&c!==-(1/0)){var d=new E(c);Va.replace(b,d),this.updateNodeMap(this.actor,d)}return"function"==typeof a&&a(this),this},N.prototype.add_action_handler(new a),new a}(),Wa.actions.DragSplitNegativesAction=function(){var a=function(a){p.call(this,"DragSplitNegativesAction","drag a negative sign to the left to extract a negative 1"),this.priority=1,this.triggerType="drag",this.settings={delay:1e3,side:"left-of"},a&&(this.nodes=a.nodes,this.target=a.target)};return Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(a){return 1!==a.length?[]:a[0]instanceof t&&"-"===a[0].to_ascii()?1===E.get_value(a[0].parent.children[1])?[]:this.bindActionForEachTarget(a,a):[]},a.prototype.transform=function(a){this.addTouchedNodes(this.target.parent);var b=this.getNewTreeNode(this.target.parent),c=b.parent,d=b.remove(),e=K.prototype.createGroup(),f=b.children[1];f.remove();var g=new E(-1);this.extendNodeMap(this.target.parent,g),this.updateNodeMap(this.target,g.children[0]);var h=new K(g);e.append(h),e.append(new K(f));var i=b.is_group("sub")?new v(e):e;return c.insert(d,i),this.cleanup_cascade(c),this.setNodesToReselectAfterAction(h),"function"==typeof a&&a(this),this},new a}(),fa.prototype.move_actions.push(Wa.actions.DragSplitNegativesAction),Wa.actions.DragNegativeSymReselectGroupAction=function(){var a=function(a){p.call(this,"DragNegativeSymReselectGroupAction","drag a negative sign to the left to extract a negative 1"),this.priority=2,this.triggerType="drag",this.settings={makes_no_changes:!0,update_node_positions:!0,side:"outside",margin:{y1:.4,y2:.4}},a&&(this.nodes=a.nodes,this.target=a.target)};return Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(a){if(1!==a.length)return[];var b=a[0];if(!b.is_group("sym")||"-"!==b.value)return[];var c=b.get_root(),d=this.createBoundAction(c,{nodes:[b],target:b});return b.rs&&1===b.rs.value&&(d.settings.side="inside"),[d]},a.prototype.transform=function(a){return this.addTouchedNodes(this.target.parent),this.setNodesToReselectAfterAction(this.target.parent),"function"==typeof a&&a(this),this},new a}(),fa.prototype.move_actions.push(Wa.actions.DragNegativeSymReselectGroupAction),Wa.actions.AssociateIdentityIntoDenominatorAction=function(){var a=function(a){p.call(this,"AssociateIdentityIntoDenominatorAction","associative property of multiplication--move into fraction"),this.priority=2,this.triggerType="drag",this.settings={},a&&(this.nodes=a.nodes,this.target=a.target,this.settings.side=a.side,a.margin&&(this.settings.margin=a.margin))};return Wa.inherit(p,a),a.prototype.getAllAvailableActions=function(a){if(!a.length)return[];var b=[];if(!Va.is_range(a))return[];var c=a[0].value;if("mul"!==c&&"div"!==c)return[];if(!a.every(function(a){return a.is_group(c)&&(E.get_value(a.children[1])===-1||1===E.get_value(a.children[1]))}))return[];var d=a[0].parent,e=a[0].parent.children.indexOf(a[0]),f=a[0].parent.children.indexOf(a[a.length-1]);return d.children.forEach(function(d,g){(g<e||g>f)&&d.value===c&&d.children[1].is_group("fraction")&&(b=b.concat(this.bindActionForEachTarget(a,d.get_child([1]).get_bottom(),!0)))},this),b},a.prototype.transform=function(a){this.nodes.forEach(function(a){this.addTouchedNodes(a)},this),this.addTouchedNodes(this.target.parent);var b=this.getNewTreeNode(this.nodes),c=this.getNewTreeNode(this.target),d=c.parent,e=d.children.indexOf(c);return"right-of"===this.settings.side&&e++,Va.remove_range(b),b.forEach(function(a){a.is_group("mul")&&a.invert()}),d.insert_range(e,b),this.cleanup(d),this.cleanup(d.parent),"function"!=typeof a||void a(this)},new a}(),fa.prototype.move_actions.push(Wa.actions.AssociateIdentityIntoDenominatorAction),Wa.rules=Wa.rules||{},Wa.rules.identity_element=function(a,b){a.prototype.identity_element=b;var c=b.to_ascii()+" is the identity element of "+a.prototype.value,d=b.to_ascii(),e=function(a){p.call(this,"IdAction",c),this.triggerType="tap",this.priority=0,this.settings={delay:250,margin:{x:.1},side:"inside"},a&&("drag"===a.triggerType?(this.triggerType=a.triggerType,this.nodes=a.nodes,this.target=a.target):this.actor=a.actor)};Wa.inherit(p,e),e.prototype.isIdentityElement=function(b){return b instanceof a&&b.children[1].to_ascii()==d},e.prototype.match=function(b,c){return arguments.length<2&&(c=b.ls||b.rs),"//"===c.value&&(c=c.ls),!(b instanceof a&&E.is_num(b.children[1])&&c instanceof a&&E.is_num(c.children[1]))&&((!b.get_parent(1).is_group("fraction")||!(this.isIdentityElement(b)&&b.is_group("mul")&&c.is_group("div")||this.isIdentityElement(c)&&c.is_group("mul")&&b.is_group("div")))&&(this.isIdentityElement(b)||this.isIdentityElement(c)))},e.prototype.getSiblings=function(b){return b.parent.children.filter(function(c){return c!==b&&c instanceof a})},e.prototype.getAllAvailableActions=function(b){var c=[];if(1!==b.length)return c;var d=b[0];if(!(d instanceof a))return c;for(var e=this.getSiblings(d),f=d.get_root(),g=0;g<e.length;g++)this.match(d,e[g])&&c.push(this.createBoundAction(f,{nodes:b,target:e[g],triggerType:"drag"}));return c},e.prototype.transform=function(a){var b=this.nodes&&this.nodes[0]||this.actor,c=this.target||this.actor&&(this.actor.ls||this.actor.rs);this.addTouchedNodes(b),this.addTouchedNodes(c);var d,e;this.isIdentityElement(b)?(d=b,e=c):(d=c,e=b),e=this.getNewTreeNode(e),this.setNodesToReselectAfterAction(e),d=this.getNewTreeNode(d),d.remove();e.parent.get_path(),this.cleanup_cascade(e.parent);return"function"!=typeof a||void a(this)},Wa.actions.IdAction=new e,a.prototype.add_action_handler(new e),fa.prototype.move_actions.push(Wa.actions.IdAction)},Wa.rules=Wa.rules||{},Wa.rules.zero_element=function(a,b){a.prototype.zero_element=b;var c=b.to_ascii(),d=c+" is the zero element of "+a.prototype.value,e=function(a){p.call(this,"ZeroAction",d),this.triggerType="tap",this.priority=5,this.settings={delay:250,margin:{x:.1},side:"inside"},a&&("drag"===a.triggerType?(this.triggerType=a.triggerType,this.nodes=a.nodes,this.target=a.target,this.priority=1):this.actor=a.actor)};Wa.inherit(p,e),e.prototype.isZeroElement=function(b){return b instanceof a&&b.children[1].to_ascii()==c},e.prototype.match=function(a,b){return arguments.length<2&&(b=a.ls),("mul"===a.value||a.value===b.value)&&(this.isZeroElement(a)||this.isZeroElement(b))},e.prototype.getSiblings=function(b){return b.parent.children.filter(function(c){return c!==b&&c instanceof a})},e.prototype.getAllAvailableActions=function(b){var c=[];if(1!==b.length)return c;var d=b[0];if(!(d instanceof a))return c;for(var e=this.getSiblings(d),f=d.get_root(),g=0;g<e.length;g++)this.match(d,e[g])&&c.push(this.createBoundAction(f,{nodes:b,target:e[g],triggerType:"drag"}));return c},e.prototype.transform=function(a){var b=this.nodes&&this.nodes[0]||this.actor,c=this.target||this.actor&&(this.actor.ls||this.actor.rs);this.addTouchedNodes(b),this.addTouchedNodes(c);var d,e;this.isZeroElement(b)?(d=b,e=c):(d=c,e=b);var f=d.get_parent(1);if(d=this.getNewTreeNode(d),"tap"===this.triggerType){var g=f.get_top().concat(f.get_bottom()).map(this.getNewTreeNode.bind(this));g.forEach(function(a){a!==d&&a.remove()})}else this.getNewTreeNode(e).remove();return(this.actor&&!this.isZeroElement(this.actor)||this.nodes&&!this.isZeroElement(this.nodes[0]))&&this.setNodesToReselectAfterAction(d.children[1]),this.cleanup_cascade(d.parent),"function"!=typeof a||void a(this)},Wa.actions.ZeroAction=new e,a.prototype.add_action_handler(new e),fa.prototype.move_actions.push(Wa.actions.ZeroAction)},Wa.rules=Wa.rules||{},Wa.rules.init_all=function(){Wa.rules.identity_element(v,new E(0)),Wa.rules.identity_element(K,new E(1)),Wa.rules.zero_element(K,new E(0)),Wa.rules.identity_element(A,new w("T")),Wa.rules.zero_element(A,new w("F")),Wa.rules.identity_element(C,new w("F")),Wa.rules.zero_element(C,new w("T"))},Wa.rules.init_all(),ja.prototype.set_style=function(a){for(var b=0;b<a.length;b++){var c=a[b],d=fa.is_top_most(c)||!c.size?this.view.options.font_size:c.size,e=c.parent.color||(this.view.interactive()?this.view.options.color:this.view.options.inactive_color);this.set_color_and_size(c,d,e)}},ja.prototype.set_color_and_size=function(a,b,c){a.size=b,a.bigger&&(a.size*=1.5),a.smaller&&(a.size*=.67),a.color=a.selected?this.view.options.selection_color:c,a.children.forEach(function(b,c){a.is_group("fraction")?this.set_color_and_size(b,a.size*this.view.options.fraction_size_factor,a.color):a.is_group("power")&&b.is_group("exponent")?this.set_color_and_size(b,a.size*this.view.options.exp_size_factor,a.color):a.is_group("radical")&&b.is_group("degree")?this.set_color_and_size(b,a.size*this.view.options.exp_size_factor*.75,a.color):a.is_leaf_node&&a.has_subscript()&&1===c?this.set_color_and_size(b,a.size*this.view.options.subscript_size_factor,a.color):this.set_color_and_size(b,a.size,a.color)},this)},ja.prototype.set_position=function(a,b){for(var c=this.view.options.font_baseline_shift,d=(this.view.options.font_ascent,this.view.options.font_descent,0);d<a.length;d++)this.rel_pos(a[d],a,b,c);for(var d=0;d<a.length;d++){var e=a[d];if(fa.is_top_most(e)){var f,g;switch(this.v_align){case"alphabetic":g=0;break;case"top":g=e.ascent-e.rel_y;break;case"center":g=-e.descent+e.height/2;break;case"bottom":g=-e.descent-e.rel_y}switch(this.h_align){case"left":f=e.width;break;case"center":f=e.width/2;break;case"equals":if(f=e.width/2,e.is_group("equals","lte","gte","lt","gt")){var h=e.children[1],i=h.rel_x+h.sel_box.x+h.sel_box.width;f=-i}break;case"right":f=0}this.abs_pos(e,f,g,f,g)}else this.abs_pos(e,e.parent.x||0,e.parent.y||0,e.parent.x0||0,e.parent.y0||0)}},ja.prototype.position_horizontally=function(a){for(var b=a[0].parent,c=0,d=0,e=0,f=0,g=0,h=a.length,i=a[0].hidden?0:a[0].lmar||0,j=a[h-1].hidden?0:a[h-1].rmar||0,k=0;k<a.length;k++){var l=a[k];c+=l.hidden||l.hide_after_drop?0:l.width,f+=l.hidden?0:l.width,d=Math.max(d,l.hidden?0:l.ascent-l.rel_y),e=Math.max(e,l.hidden?0:l.descent+l.rel_y)}g=d+e,fa.is_top_most(b)&&i&&(c-=i);for(var m=-c,k=0;k<a.length;k++){var l=a[k],n=0===k?0:l.lmar||0,o=0===k?l.width-(l.lmar||0):l.width,p=0===k?0:Math.min(a[k-1].rmar||0,n);c-=p,l.rel_x+=m+l.width+n-p,(l.hidden||l.hide_after_drop)&&(l.rel_x-=o-p),m+=l.hidden||l.hide_after_drop?0:o-p}return fa.is_top_most(b)&&0!==m&&a.forEach(function(a){a.rel_x-=m}),{width:c,height:g,ascent:d,descent:e,sel_box:{x:-c-i,width:c,y:-d,height:g},lmar:i,rmar:j}},ja.prototype.rel_pos=function(a,b,c,d){if(!a.has_children()){var e=this.view.options;a.baseline_shift=d*a.size;var f=0,g=0,h=a.value+a.parent.value,i=a.value;if(h in e.char_metrics?("lmar"in e.char_metrics[h]&&(f=e.char_metrics[h].lmar),"rmar"in e.char_metrics[h]&&(g=e.char_metrics[h].rmar)):i in e.char_metrics&&("lmar"in e.char_metrics[i]&&(f=e.char_metrics[i].lmar),"rmar"in e.char_metrics[i]&&(g=e.char_metrics[i].rmar)),a.lmar=f*a.size,a.rmar=g*a.size,c){var j=a.to_string(),k=this.view.fontloader.width(j,a.size,this.view.get_font(a));a.width=k+a.lmar+a.rmar,a.ascent=e.font_ascent*a.size,a.descent=e.font_descent*a.size,j in e.char_metrics&&("ascent"in e.char_metrics[j]&&(a.ascent=e.char_metrics[j].ascent*a.size),"descent"in e.char_metrics[j]&&(a.descent=e.char_metrics[j].descent*a.size)),a.height=a.ascent+a.descent,a.sel_box={x:-a.lmar,width:a.width,y:-a.ascent,height:a.height}}return void(b.indexOf(a)!==-1?(a.rel_x||0===a.rel_x||(a.rel_x=-a.width),a.rel_y||0===a.rel_y||(a.rel_y=0)):(a.rel_x=-a.width,a.rel_y=0))}b.indexOf(a)==-1||fa.is_top_most(a)?(a.rel_x=0,a.rel_y=0):(a.rel_x=a.rel_x||0,a.rel_y=a.rel_y||0);for(var l=0;l<a.children.length;l++)this.rel_pos(a.children[l],b,c,d);if(a.is_group("fraction")){for(var m=[],n=[],o=null,p=a.children[0];p;)"mul"==p.value?m.push(p):"div"==p.value?n.push(p):o=p,p=p.rs;var q=this.position_horizontally(m),r=this.position_horizontally(n),s=-d*a.size;o.height=a.size*this.view.options.div_bar_height,o.width=Math.max(q.width,r.width)+a.size/8,o.ascent=o.height/2,o.descent=o.height/2,o.rel_y=s,o.rel_x=.1*a.size,o.sel_box={x:-.1*a.size,width:o.width+.2*a.size,y:-a.size/4,height:a.size/2},a.width=o.width+.2*a.size,a.ascent=q.height+o.height/2-s,a.descent=r.height+o.height/2+s,a.height=a.ascent+a.descent,a.rel_y=0,a.rel_x=-a.width,a.sel_box={x:0,width:a.width,y:-a.ascent,height:a.height};for(var l=0;l<m.length;l++)m[l].rel_y+=-q.descent-o.height/2+s,m[l].rel_x+=.5*(a.width+q.width);for(var l=0;l<n.length;l++)n[l].rel_y+=r.ascent+o.height/2+s,n[l].rel_x+=.5*(a.width+r.width)}else if(a.is_group("radical")){var t=a.children[3],u=this.position_horizontally([t]),v=[a.children[0],a.children[1],a.children[3]],w=this.position_horizontally(v),x=v[1],y=t.height/x.height;x.rel_y-=t.ascent-x.ascent*y,this.scaleNode(x,y+.1);var z=v[0];z.rel_y-=.6*x.ascent-x.rel_y,z.rel_x+=x.width/3,x.sel_box={x:-x.lmar,width:x.width,y:-x.ascent,height:x.height},Wa.extend(x,x.sel_box);var o=a.children[2];o.height=a.size*this.view.options.div_bar_height,o.width=u.width,o.ascent=o.height/2,o.descent=o.height/2,o.rel_y=-(x.ascent-o.height/2)+x.rel_y,o.rel_x=x.rel_x+x.width-o.height/2,o.sel_box={x:0,width:o.width,y:-o.height/2,height:o.height},Wa.extend(o,o.sel_box),w.ascent=x.ascent-x.rel_y+o.ascent,w.descent=x.descent+x.rel_y,w.height=w.ascent+w.descent,w.y-=o.ascent,Wa.extend(a,w)}else{if(a.is_group("power")){var A=a.children[0],B=a.children[1];B.rel_y-=.7*A.ascent,a.children[0].is_group("func")&&(a.children[1].rel_x-=a.children[0].children[1].width,a.children[0].children[1].rel_x+=a.children[1].width)}if(a.is_leaf_node&&a.has_subscript()){var A=a.children[0],C=a.children[1];C.rel_y+=.7*A.descent}if(Wa.extend(a,this.position_horizontally(a.children)),a.is_group("brackets","abs-val")){var D=this.view.options.brackets_size_factor-1,E=a.height/a.children[0].height+D,F=a.children[0],G=a.children[2];F.rel_y+=F.ascent*(E-D/2)-a.ascent,this.scaleNode(F,E),G.rel_y+=G.ascent*(E-D/2)-a.ascent,this.scaleNode(G,E),a.ascent=F.ascent-F.rel_y,a.descent=F.descent+F.rel_y,a.height=a.ascent+a.descent,a.sel_box.y=-a.ascent,a.sel_box.height=a.height}}},ja.prototype.scaleNode=function(a,b){a.scale_y=b,a.ascent*=b,a.descent*=b,a.height*=b,a.sel_box.y=-a.ascent,a.sel_box.height=a.height},ja.prototype.abs_pos=function(a,b,c,d,e){a.x=a.rel_x+b,a.y=a.rel_y+c,a.x0=a.rel_x+d,a.y0=a.rel_y+e,a.children.forEach(function(b){this.abs_pos(b,a.x,a.y,a.x0,a.y0)},this)},Wa.AlgebraView=ka,Wa.preloadFonts=function(a){Wa.AlgebraView.fontloader?Wa.AlgebraView.fontloader.add_fonts(a):Wa.AlgebraView.fontloader=new T(a)},ka.prototype.bindToModel=function(a,b){if(this.model&&(this.model.events.on("change."+this.id,null),this.model.events.on("scrubbability-changed."+this.id,null),this.model.events.on("end-of-interaction."+this.id,null)),this.model=a,this.model.events.on("change."+this.id,this.onChange.bind(this)),this.model.events.on("end-of-interaction."+this.id,this.onEOI.bind(this)),b&&this.main){var c=[];this.main.selectAll("g.math").each(function(a){var d=b[a.id];a.deleted||!d||1!==d.length||d[0].has_children()||c.indexOf(d[0])!==-1||(d3.select(this).datum(d[0]),c.push(d[0]))}),c=[],this.main.selectAll("g.math_shadow").each(function(a){var d=b[a.id];a.deleted||!d||1!==d.length||d[0].has_children()||c.indexOf(d[0])!==-1||(d3.select(this).datum(d[0]),c.push(d[0]))})}var d=this;this.model.events.on("scrubbability-changed."+this.id,function(){d.update_existing("normal",!0)})},ka.fontPresets={Kalam:{normal_font:{family:"Kalam"},italic_font:{family:"Kalam"},font_baseline_shift:.4,font_ascent:.9,font_descent:.2,slanted_div_bar:!0,div_bar_height:1/15,char_metrics:{"√":{ascent:.66},"(":{ascent:.95},")":{ascent:.95},"+":{lmar:1/6,rmar:1/6},"-sub":{lmar:1/6,rmar:1/6},"±addsub":{lmar:1/6,rmar:1/6},"=":{lmar:1/3,rmar:1/3},"<":{lmar:1/3,rmar:1/3},">":{lmar:1/3,rmar:1/3},"≤":{lmar:1/3,rmar:1/3},"≥":{lmar:1/3,rmar:1/3},",":{lmar:0,rmar:1/3}}},"Crimson Text":{normal_font:{family:"Crimson Text"},italic_font:{family:"Crimson Text Italics"},font_baseline_shift:.24,font_ascent:.73,font_descent:.18,slanted_div_bar:!1,div_bar_height:1/16,char_metrics:{}}},ka.defaultOptions={font_size:80,auto_update:!0,color:"#333",selection_color:"#4682b4",inverse_selection_color:"#957946",show_drag_indicator:!0,inactive_color:"#676965",hold_area_feedback:!0,fraction_size_factor:.7,exp_size_factor:.7,brackets_size_factor:1.2,subscript_size_factor:.5,smooshed_nodes_shrink_factor:.5,debug_lines:!1,debug_draw:!1,dur:300,dur_dragging:300,easing_fn:"cubic-in-out",pos:[0,0],mode:"transform",modes:["edit","inspect"],v_align:"alphabetic",h_align:"center",background_color:"none",bg_visible:!1,shadow_filter:null,border_color:"none",shadow_color:"none",border_radius:0,padding:{left:0,right:0,top:0,bottom:0},interactive:!0,event_receiver:null,font_preset:"Kalam",wiggle_dur:200,wiggle_deg:10,wiggle_random_delay:100,show_node_targets:!0,shadow_node_stroke:"#888",shadow_node_stroke_width:.75,shadow_node_fill:"white",enable_drag_to_join:!0,visualize_scrubbable_nodes:!0,rubber_band_selection:!0,hide_mouse_cursor:!0,hold_time:1500,replace_value_on:!0,fixed:!1},ka.prototype.setMode=function(a){return a?!this.options.modes.every(function(b){return b!==a})&&(this.mode=a,!0):this.mode},ka.prototype.onChange=function(a){a.old_model!==a.new_model?(this.bindToModel(a.new_model,a.node_map),this.options.auto_update&&this.update_all(!0)):this.options.auto_update&&this.update_all(a.no_anim),a.no_anim&&this.onEOI()},ka.prototype.onEOI=function(a){this.main.selectAll("g.math").filter(function(a){return a.deleted}).remove(),this.main.selectAll("g.math_shadow").filter(function(a){return a.shadow_deleted}).remove()},ka.prototype.callAfterAnimation=function(a){this.is_animating?this.afterAnimationCallbacks.push(a):a()},ka.prototype.animationFinished=function(){this.is_animating=Math.max(0,this.is_animating-1),this.is_animating>0||(this.afterAnimationCallbacks.forEach(function(a){a()}),this.afterAnimationCallbacks=[])},ka.prototype.initializeOptions=function(a){a=a||{};var b=a.font_preset||ka.defaultOptions.font_preset,c=b?ka.fontPresets[b]:{},d=Wa.object.merged(c,ka.defaultOptions);if(d.pos=d.pos.slice(),d.padding=Wa.extend({},d.padding),d.normal_font=Wa.extend({},d.normal_font),d.italic_font=Wa.extend({},d.italic_font),this.options=Wa.extend(d,a),a.padding){var e=a.padding;"number"==typeof e?this.options.padding={left:e,right:e,top:e,bottom:e}:Wa.extend(this.options.padding,e)}},ka.prototype.init=function(a){this.main=this.svg.append("g").attr("id",this.options.id).attr("class","main").attr("transform","translate("+this.options.pos+")"),this.shadow_rect=this.main.append("rect").attr({rx:this.options.border_radius,ry:this.options.border_radius}).style("fill","none").attr("filter",this.options.shadow_filter).style("stroke",this.options.shadow_color).style("visibility",this.options.shadow_filter?"visible":"hidden"),this.border_rect=this.main.append("rect").attr({rx:this.options.border_radius,ry:this.options.border_radius}).style("fill",this.options.background_color).style("stroke",this.options.border_color).style("visibility",this.options.bg_visible?"visible":"hidden"),this.options.event_receiver?this.event_receiver=d3.select(this.options.event_receiver):(this.event_receiver=this.main,this.event_receiver.style("pointer-events","all")),this.options.debug_lines&&(this.main.append("line").attr("x1",-1e3).attr("x2",1e3).attr("stroke-width","0.5").attr("stroke","lightblue"),this.main.append("line").attr("y1",-1e3).attr("y2",1e3).attr("stroke-width","0.5").attr("stroke","lightblue")),this.renderer=new ja(this,this.options.h_align,this.options.v_align),this.options.fixed||(this.interaction_handler=new ba(this,this.options.interactive),this.main.classed("interactive",this.options.interactive),this.interaction_handler.setMode(this.mode));var b=[this.options.normal_font,this.options.italic_font];ka.fontloader?(this.fontloader=ka.fontloader,this.fontloader.add_fonts(b)):(ka.fontloader=T(b,2e3),this.fontloader=ka.fontloader);var c=this;this.fontloader.on_fonts_loaded(function(){c.update_all(!0),a&&a()})},ka.prototype.interactive=function(a){return 0===arguments.length?!this.options.fixed&&this.options.interactive:(this.options.interactive=a,this.options.fixed||(this.interaction_handler.set_interactive(a),this.main.classed("interactive",this.options.interactive)),this)},ka.prototype.wiggle=function(a,b){Array.isArray(a)||(a=[a]);for(var c=[],d=0;d<a.length;d++){var e=a[d].split(":"),f=1===e.length?this.model.getRanges(e[0]):this.model.getRanges(e[0],Number(e[1])-1);f&&(c=c.concat(f))}var g=Wa.array.flatten(c);0!==g.length&&(this.wiggleNodes(g,b),this.options.fixed||this.interaction_handler.events.on("touch."+this.id,this.wiggleNodes.bind(this,null,!1)))},ka.prototype.wiggleNodes=function(a,b){function c(a){d3.select(this).transition().duration(f.wiggle_dur).attrTween("transform",g(f.wiggle_deg,-f.wiggle_deg)).transition().duration(f.wiggle_dur).attrTween("transform",g(-f.wiggle_deg,f.wiggle_deg)).each("end",c)}arguments.length<2&&(b=!0),a||(a=this.model.children),Array.isArray(a)||(a=[a]);var d=[];a.forEach(function(a){a.has_children()?d=d.concat(a.get_leaf_nodes()):d.push(a)});var e=this.node_sel.filter(function(a){return d.indexOf(a)!==-1}).select("g.offset"),f=this.options,g=function(a,b,c){var d=d3.interpolate(a,b);return function(a){var b=ka.getCenter(a);return function(a){return"rotate("+d(a)+" "+b+")"}}};b?e.transition().delay(function(){return Math.random()*f.wiggle_random_delay}).duration(f.wiggle_dur/2).attrTween("transform",g(0,f.wiggle_deg)).each("end",c):e.interrupt().transition().attr("transform",null)},ka.getCenter=function(a){var b=a.sel_box;return[b.x+b.width/2,.24*-a.size]},ka.prototype.reposition=function(a){var b=this;b.renderer.set_position(b.model.children,!0),b.update_existing()},ka.prototype.getSmooshedNodesSelection=function(a){var b=this.main.selectAll("g.math_smooshed").data(Va.get_leaf_nodes(a),function(a){return a.id});return b},ka.prototype.enterSmooshed=function(a){var b=this,c=this.getSmooshedNodesSelection(a),d=c.enter().insert("g","g").classed("math_smooshed",!0).attr("transform",function(a){return"translate("+a.x+","+a.y+")"}).style("opacity",.6);d.append("g").classed("offset",!0),d.select("g.offset").append("rect").style("visibility",this.options.debug_draw?"visible":"hidden").style("stroke","black").style("fill","none").classed("selector",!0);var e=d.filter(function(a){return"//"===a.value}).select("g.offset");e.append("line").style("stroke-linecap","round").call(la,this.options.slanted_div_bar,"normal").attr("x2",function(a){return a.width*b.options.smooshed_nodes_shrink_factor+"px"}).style("stroke",function(a){return b.options.selection_color}).style("opacity",function(a){return 1});d.select("g.offset").append("text").style("font-family",function(a){return b.get_font(a).family}).style("font-weight",function(a){return b.get_font(a).weight}).style("font-style",function(a){return b.get_font(a).style}).style("font-size",function(a){return a.size+"px"}).style("fill",function(a){return b.options.selection_color}).style("opacity",function(a){return a.hidden?1e-5:1}).text(function(a){return a.to_string()}),d.select("text").transition().duration(this.options.dur).ease(this.options.easing_fn).style("font-size",function(a){return a.size*b.options.smooshed_nodes_shrink_factor+"px"})},ka.prototype.updateSmooshed=function(a){var b=this.getSmooshedNodesSelection(a);b.transition().duration(this.options.dur_dragging).ease("circle-out").attr("transform",function(a){return"translate("+a.x+","+a.y+")"})},ka.prototype.exitSmooshed=function(){this.main.selectAll("g.math_smooshed").remove()},ka.prototype.update_all=function(a){var b=this.options.dur;a&&(this.options.dur=0),this.renderer.set_style(this.model.children),this.renderer.set_position(this.model.children,!0),this.enter_and_exit("normal"),this.update_existing("normal"),this.events.updated({type:"updated",source:this,sender_id:this.id}),this.is_animating++,setTimeout(this.animationFinished.bind(this),this.options.dur),this.options.dur=b},ka.prototype.enter_and_exit=function(a){var b;if("normal"===a)b=this.getNormalNodesSelection();else{if("shadow"!==a)throw"No node type specified for node visualization -- AlgebraView.js/enter_and_exit";b=this.getShadowNodesSelection()}b.length>0&&(this._enter(b,a),b.selectAll("g.math text").on("hold",function(a){var b=a.datum();if(Wa.actions.splitNumberWithKeyboardAction.match(b)){var c=Wa.actions.splitNumberWithKeyboardAction.createBoundAction(b.get_root(),{actor:b});b.get_root().performAction(c,null,!0)}}),this._exit(b,a))},ka.prototype.getNormalNodesSelection=function(){var a=this.main.selectAll("g.math").data(Va.get_leaf_nodes(this.model.children),function(a){return a.id});return a},ka.prototype.getShadowNodesSelection=function(){if(!this.options.show_node_targets)return[];var a=this.model.filter(function(a){return a.dragging}),b=Va.filter(function(a){return!a.has_children()},a),c=this.main.selectAll("g.math_shadow").data(b,function(a){return a.id});return c},ka.prototype._enter=function(a,b){var c,d=this;c="normal"===b?a.enter().append("g").classed("math",!0).attr("id",function(a){return a.id}).attr("transform",function(a){return"translate("+a.x+","+a.y+")"}):a.enter().insert("g","g.math").classed("math_shadow",!0).attr("transform",function(a){return"translate("+a.x0+","+a.y0+")"}).each(function(a){a.shadow_deleted=!1}),c.append("g").classed("offset",!0),c.select("g.offset").append("rect").attr("visibility","hidden").style("stroke","black").style("fill","none").classed("selector",!0);var e=c.filter(function(a){return"//"===a.value}).select("g.offset"),f=(e.append("line").style("stroke-linecap","round").call(la,this.options.slanted_div_bar,b).style("opacity",function(a){return"normal"===b?a.smooshing||!a.no_anim||a.hidden?1e-5:1:a.hidden||a.hide_after_drop?0:1}),c.select("g.offset").append("text").style("font-family",function(a){return d.get_font(a).family}).style("font-weight",function(a){return d.get_font(a).weight}).style("font-style",function(a){return d.get_font(a).style}).style("font-size",function(a){return a.size+"px"}).style("transform",function(a){return a.scale_y?"scaleY("+a.scale_y+")":""}).style("pointer-events","none"));return"normal"===b?(f.style("stroke","none").style("fill",function(a){return a.color}).style("opacity",function(a){return a.smooshing||!a.no_anim||a.hidden?1e-5:1}).text(function(a){return a.to_string()}),this.options.debug_draw&&this.debugDraw(c),a.each(function(a){return a.no_anim=!1})):f.style("stroke",d.options.shadow_node_stroke).style("stroke-width",d.options.shadow_node_stroke_width).style("fill",d.options.shadow_node_fill).style("opacity",function(a){return a.hidden||a.hide_after_drop?0:1}),c},ka.prototype._exit=function(a,b){var c=this,d=a.exit().each(function(a){"normal"===b?a.deleted=!0:a.shadow_deleted=!0}).transition().ease("linear").duration(function(a){return a.no_anim?0:c.options.dur}).attr("transform",function(a){return"translate("+(a.x0||0)+","+(a.y0||0)+")"});d.select("*").style("opacity",1e-5),d.each("end",function(){this.style.display="none"}),"normal"===b&&(this.node_sel=a)},ka.prototype.update_existing=function(a,b){var c=this.svg.selectAll("normal"===a?"g.math":"g.math_shadow").filter(function(b){return"normal"===a?!b.deleted:!b.shadow_deleted}),d=c.transition().duration(b?0:this.options.dur).ease(this.options.easing_fn);"normal"===a?d.attr("transform",function(a){return"translate("+(a.x||0)+","+(a.y||0)+")"}):d.attr("transform",function(a){return"translate("+(a.x0||0)+","+(a.y0||0)+")"});var e=c.select("text").transition().duration(0).text(function(a){return a.to_string()}).style("transform",function(a){return a.scale_y?"scaleY("+a.scale_y+")":""}).transition().duration(b?0:this.options.dur).ease("linear").style("font-size",function(a){return a.size+"px"});"normal"===a?e.style("fill",function(a){return a.color}).style("opacity",function(a){return a.smooshing||a.hidden?1e-5:1}):e.style("opacity",function(a){return a.hidden||a.hide_after_drop?0:1});var f="normal"===a?c.select("line"):c.filter(function(a){return"//"===a.value}).select("line");if(f.transition().duration(b?0:this.options.dur).ease("linear").call(la,this.options.slanted_div_bar,a).style("opacity",function(b){return"normal"===a?b.smooshing||b.hidden?1e-5:1:b.hidden||b.hide_after_drop?0:1}),"normal"===a){if(this.options.visualize_scrubbable_nodes&&"inspect"===this.mode){c.each(function(a){var b=d3.select(this),c=b.selectAll(".scrub");0!==c.size()||!E.is_num(a)||a.fixed||a.locked||(b.append("path").attr({class:"scrub",d:"M-.5,0 L.5,0 L0,-.7 Z"}),b.append("path").attr({class:"scrub",d:"M-.5,0 L.5,0 L0,.7 Z"}),c=b.selectAll(".scrub"),c.style({fill:a.color,"stroke-linejoin":"round",stroke:a.color,"stroke-width":"0.3px",opacity:.5})),c.style("visibility",a.locked?"hidden":"visible"),c.attr("transform",function(a,b){return 0===b?"translate("+[a.sel_box.x+a.sel_box.width/2,-a.ascent]+")scale("+a.size/5+")":"translate("+[a.sel_box.x+a.sel_box.width/2,a.descent]+")scale("+a.size/5+")"})})}else c.selectAll(".scrub").remove();c.select("rect").attr("x",function(a){return a.sel_box?a.sel_box.x:0}).attr("y",function(a){return a.sel_box?a.sel_box.y:0}).attr("width",function(a){return a.hidden||!a.sel_box?0:a.sel_box.width}).attr("height",function(a){return a.hidden||!a.sel_box?0:a.sel_box.height}),this.update_background()}
return!0},ka.prototype.update_background=function(a){var b=this.model.children[0],c=this.getBBox();b&&!b.dragging&&(this.border_rect.attr({rx:this.options.border_radius,ry:this.options.border_radius}).style("fill",this.options.background_color).style("stroke",this.options.border_color).attr(c),this.shadow_rect.transition().duration(a?0:this.options.dur).attr(c))},ka.prototype.set_background_visible=function(a){this.options.bg_visible=!!a,this.border_rect.style("visibility",a?"visible":"hidden")},ka.prototype.getBBox=function(a){a=a||{};var b=this.model.children[0];if(!b||!b.sel_box)return{x:0,y:0,width:0,height:0};var c={},d=this.options.padding;return c.x=b.sel_box.x+(b.dragging?b.x0:b.x)-(a.no_padding?0:d.left),c.y=b.sel_box.y+(b.dragging?b.y0:b.y)-(a.no_padding?0:d.top),c.width=b.sel_box.width+(a.no_padding?0:d.left+d.right),c.height=b.sel_box.height+(a.no_padding?0:d.top+d.bottom),c},ka.prototype.update_positions=function(a){this.node_sel.filter(function(b){return a.indexOf(b)!==-1}).transition().duration(this.options.dur_dragging).ease("circle-out").attr("transform",function(a){return"translate("+(a.x||0)+","+(a.y||0)+")"})},ka.prototype.update_style=function(a){this.node_sel.select("text").style("transform",function(a){return a.scale_y?"scaleY("+a.scale_y+")":""}).transition().duration(a?0:this.options.dur).ease("linear").style("font-size",function(a){return a.size+"px"}).style("fill",function(a){return a.color}).style("opacity",function(a){return a.hidden?1e-5:a.hide_after_drop?.4:1}),this.node_sel.select("line").transition().duration(a?0:this.options.dur).ease("linear").call(la,this.options.slanted_div_bar).style("opacity",function(a){return a.hidden?1e-5:a.hide_after_drop?.4:1})},ka.prototype.force_refresh=function(){var a=this.svg.node();a.style.display="none",a.style.display="block"},ka.prototype.get_utf8=function(a){var b={"-":"−","*":"·","/":""};return a.value in b?b[a.value]:"number"==typeof a.value&&a.value<0?b["-"]+Math.abs(a.value):a.value},ka.prototype.get_font=function(a){return a&&a.is_group&&a.is_group("var")?this.options.italic_font:this.options.normal_font},ka.prototype.get_width=function(a){return this.fontloader.width(a.to_string(),a.size,get_font(a))},ka.prototype.debugDraw=function(a){var b=this;a.select("g.offset").append("rect").style("stroke","orange").style("opacity",function(a){return a.hidden?.3:1}).style("fill","none").filter(function(a){return a.sel_box}).attr({x:function(a){return a.sel_box.x},width:function(a){return a.sel_box.width},y:function(a){return a.descent-.5},height:1}),a.select("g.offset").append("rect").style("stroke","green").style("opacity",function(a){return a.hidden?.3:1}).style("fill","none").filter(function(a){return a.sel_box}).attr({x:function(a){return a.sel_box.x},width:function(a){return a.sel_box.width},y:function(a){return-a.ascent-.5},height:1}),a.select("g.offset").append("rect").style("stroke","blue").style("opacity",function(a){return a.hidden?.3:1}).style("fill","none").filter(function(a){return a.sel_box}).attr({x:function(a){return a.sel_box.x},width:function(a){return a.sel_box.width},y:function(a){return-a.size*b.options.font_baseline_shift-.5},height:1})},Wa.CanvasElementClass=ma,Wa.ui.CanvasElement=ma,ma.defaultOptions={visualized:!0,pos:{x:"center",y:"center"},min_size:{width:30,height:50},size:{width:10,height:10},active:!1,mode:"edit",modes:["edit","arrange"],resizable:{x:!0,y:!0},draggable:!0,send_events:!0,dont_log_events:!1,graphics_caching:!0,delete_btn_size:20,delete_btn_color:"silver",resize_tab_size:25,resize_tab_color:"#c6c6c6",dur:300,easing_fn:"cubic-in-out",edit_mode_drag_box_width:20,show_bg:!0,bg_edit_style:{"background-color":"transparent","box-shadow":"none","border-radius":"2px"},bg_edit_active_style:{"background-color":"rgba(255,255,255,0.9)","box-shadow":"none"},bg_edit_dragging_style:{"background-color":"rgba(255,255,255,0.9)","box-shadow":"0 3px 6px rgba(0,0,0,0.23)"},bg_arrange_style:{"background-color":"rgba(255,255,255,0.9)","box-shadow":"0 3px 6px rgba(0,0,0,0.23)"},bg_arrange_active_style:{"background-color":"rgba(255,255,255,0.9)","box-shadow":"0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23)"},bg_arrange_dragging_style:{"background-color":"rgba(255,255,255,0.9)","box-shadow":"0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23)"}},ma.prototype.emitEvent=function(a,b){var c={type:a,source:this,time:Date.now()};b&&(c=Wa.extend(c,b)),this.events[a](c)},ma.prototype.initCanvasElementOptions=function(a){a=a||{};var b=Wa.deepCopy(ma.defaultOptions);this.options=Wa.object.extendExisting(b,a),delete this.options.id},ma.prototype.initElement=function(a){if(this.options.visualized)return 0===arguments.length?this.containing_group.node():(this.containing_group=d3.select(a),this.container_size=this.getContainerSize(),this.element_div?this.containing_group.node().appendChild(this.element_div.node()):this.element_div=this.containing_group.append("div").classed("canvas-element",!0).attr("id",this.id).datum(this).on("mouseenter."+this.id,this.mouseHovering.bind(this,!0)).on("mouseleave."+this.id,this.mouseHovering.bind(this,!1)).style("pointer-events","all").style("position","absolute"),this.delete_grp&&this.delete_grp.selectAll("rect").style("fill",this.options.delete_btn_color),this)},ma.prototype.initCanvasElementProperties=function(){this.mode=this.options.mode,this.active=this.options.active,this.options.visualized&&(this.size=Wa.extend({},this.options.size),this.pos=this.alignmentToPosition(this.options.pos),this.translateElement(this.pos),this.element_div.style("height",this.size.height+"px").style("width",this.size.width+"px"),this.updateBGStyle())},ma.prototype.setMode=function(a,b){if(this.options.visualized)return a?a!==this.mode&&(this.options.modes.every(function(b){return b!==a})&&this.setMode("edit"),this.exitMode(a),this.enterMode(a),this.mode=a,this.updateBGStyle(),!b):this.mode},ma.prototype.exitMode=function(a){this.exitSubTypeMode(a),"arrange"===this.mode&&this.exitArrangeMode(),"arrange"!==this.mode&&"arrange"===a&&this.exitEditMode()},ma.prototype.exitSubTypeMode=function(){},ma.prototype.enterMode=function(a,b){this.options.visualized&&("arrange"===a?this.enterArrangeMode():this.enterEditMode(),this.enterSubTypeMode(a))},ma.prototype.enterSubTypeMode=function(a){},ma.prototype.enterEditMode=function(){if(this.edit_mtouch?this.edit_mtouch.connected(!0):(this.edit_mtouch=Wa.mtouch_events(),this.edit_mtouch.origin(function(a){return[a.pos.x,a.pos.y]}).on("touch."+this.id,this.touch.bind(this,null)).on("drag."+this.id,this.drag.bind(this,null)).on("release."+this.id,this.release.bind(this,null))),!this.edit_move_div&&this.options.draggable){var a=this.options.edit_mode_drag_box_width<0,b=(a?-1:1)*this.options.edit_mode_drag_box_width;this.edit_move_div=this.element_div.append("div").style({position:"absolute",left:a?-b+"px":0,top:0,bottom:0,width:b+"px"}).style("cursor",this.options.draggable?"move":null).call(this.edit_mtouch)}else this.edit_move_div&&this.edit_move_div.style("display",null)},ma.prototype.exitEditMode=function(){this.edit_mtouch&&this.edit_mtouch.connected(!1),this.edit_move_div&&this.edit_move_div.style("display","none")},ma.prototype.enterArrangeMode=function(){this.initMoveControls(),this.initDeleteControls(),this.initResizeControls()},ma.prototype.initMoveControls=function(){this.arrange_mtouch||(this.arrange_mtouch=Wa.mtouch_events().origin(function(a){return[a.pos.x,a.pos.y]}).on("touch."+this.id,this.touch.bind(this,null)).on("drag."+this.id,this.drag.bind(this,null)).on("release."+this.id,this.release.bind(this,null))),this.arrange_mode_div||(this.arrange_mode_div=this.element_div.append("div").classed("canvas-element-arrange-pane",!0).datum(this).style({position:"absolute",left:0,right:0,top:0,bottom:0}).style("pointer-events","all").style("cursor",this.options.draggable?"move":null).call(this.arrange_mtouch))},ma.prototype.initDeleteControls=function(){var a=this;if(this.delete_mtouch||(this.delete_mtouch=Wa.mtouch_events().on("release",function(){this.contains(d3.event.sourceEvent.target)&&(a.emitEvent("start-of-interaction"),a.canvas_model.removeElement(a),a.emitEvent("end-of-interaction"))})),!this.delete_grp){var b=this.options.delete_btn_size,c=5;this.delete_grp=this.element_div.append("svg").style({position:"absolute",width:b+2*c+"px",height:b+2*c+"px",right:-c+2+"px",top:-c+2+"px"}).call(this.delete_mtouch),this.delete_icon=this.delete_grp.append("g").style("mouse-events","all").on("mouseenter",function(){d3.select(this).selectAll("rect").style("fill","red")}).on("mouseleave",function(){d3.select(this).selectAll("rect").style("fill",a.options.delete_btn_color)}).attr("transform","translate("+[b/2+c,b/2+c]+")rotate(45)"),this.delete_icon.append("circle").attr({r:b/2+c}).style("opacity",0),this.delete_icon.append("rect").attr({width:b,height:b/3.5,x:-b/2,y:-b/7}).style("fill",this.options.delete_btn_color).style("stroke","none"),this.delete_icon.append("rect").attr({width:b/3.5,height:b,x:-b/7,y:-b/2}).style("fill",this.options.delete_btn_color).style("stroke","none")}},ma.prototype.initResizeControls=function(){var a=this;if((this.options.resizable.x||this.options.resizable.y)&&(this.resize_mtouch||(this.resize_mtouch=Wa.mtouch_events().origin(function(){return[a.size.width,a.size.height]}).on("touch."+this.id+"_resize",function(){a.emitEvent("start-of-interaction",{size:Wa.deepCopy(a.size)})}).on("drag."+this.id+"_resize",function(){a.resize({width:d3.event.x,height:d3.event.y})}).on("release."+this.id+"_resize",function(){a.emitEvent("end-of-interaction",{size:Wa.deepCopy(a.size)})})),!this.resize_grp)){var b,c=5;b=this.options.resizable.x&&this.options.resizable.y?"nwse-resize":this.options.resizable.x?"ew-resize":"ns-resize";var d=this.options.resize_tab_size;this.resize_grp=this.element_div.append("svg").style({position:"absolute",width:d+2*c+"px",height:d+2*c+"px",right:-c+"px",bottom:-c+"px"}).call(this.resize_mtouch),this.resize_icon=this.resize_grp.append("g").style("mouse-events","all").attr("transform","translate("+[d+c,d+c]+")").style("cursor",b),this.resize_icon.append("circle").attr({r:d/2+5,cx:-d/3,cy:-d/3}).style("opacity",0),this.resize_icon.append("path").attr("d","M"+[-d,0]+"L"+[0,0]+"L"+[0,-d]+"Z").style("fill",this.options.resize_tab_color).style("stroke","none")}},ma.prototype.exitArrangeMode=function(){this.arrange_mode_div&&(this.arrange_mode_div.remove(),delete this.arrange_mode_div),this.arrange_mtouch&&(this.arrange_mtouch.connected(!1),delete this.arrange_mtouch),this.delete_grp&&(this.delete_grp.remove(),delete this.delete_grp),this.delete_mtouch&&(this.delete_mtouch.connected(!1),delete this.delete_mtouch),this.resize_grp&&(this.resize_grp.remove(),delete this.resize_grp),this.resize_mtouch&&(this.resize_mtouch.connected(!1),delete this.resize_mtouch)},ma.prototype.getContainerSize=function(){return this.canvas_model?this.canvas_model.size():this.containing_group.node().getBoundingClientRect()},ma.prototype.touch=function(a){this.emitEvent("start-of-interaction",{pos:Wa.deepCopy(this.pos)});a||d3.event;this.container_size=this.getContainerSize(),this.setDragging(!0),"arrange"!==this.mode&&this.setActive(!0)},ma.prototype.drag=function(a){var b=a||d3.event;this.options.draggable&&(this.hovering||(b.x=Math.max(0,Math.min(this.container_size.width-this.size.width,b.x)),b.y=Math.max(0,Math.min(this.container_size.height-this.size.height,b.y))),this.translateElement(b))},ma.prototype.release=function(a){this.setDragging(!1);a||d3.event;this.emitEvent("end-of-interaction",{pos:Wa.deepCopy(this.pos)})},ma.prototype.setDragging=function(a){this.dragging!==a&&(this.dragging=a,this.updateBGStyle())},ma.prototype.resize=function(a){if(this.options.resizable.x||!this.options.resizable.y){var b=Math.max(this.options.min_size.width,a.width),c=Math.max(this.options.min_size.height,a.height);b=Math.min(b,b-(a.width+this.pos.x-this.container_size.width)),c=Math.min(c,c-(a.height+this.pos.y-this.container_size.height)),this.options.resizable.x||(b=this.size.width),this.options.resizable.y||(c=this.size.height),this.resizeElement({width:b,height:c})}},ma.prototype.resizeElement=function(a){this.size.width===a.width&&this.size.height===a.height||(this.size.width=a.width,this.size.height=a.height,this.element_div.style("width",this.size.width+"px").style("height",this.size.height+"px"),this.subTypeResize(),this.events.resize({type:"resize",size:{width:this.size.width,height:this.size.height}}))},ma.prototype.subTypeResize=function(){},ma.prototype.initPosition=function(a){this.pos=this.alignmentToPosition(this.options.pos),this.translateElement(this.pos,a)},ma.prototype.alignmentToPosition=function(a){var b=a.x,c=a.y;return"center"===b?b=this.container_size.width/2-this.size.width/2:"left"===b?b=0:"right"===b&&(b=this.container_size.width-this.size.width),"center"===c?c=this.container_size.height/2-this.size.height/2:"top"===c?c=0:"bottom"===c&&(c=this.container_size.height-this.size.height),{x:b,y:c}},ma.prototype.translateElement=function(a,b){if(this.options.visualized){this.pos.x=a.x,this.pos.y=a.y;var c=this.options.graphics_caching?"translate3d("+[Math.round(this.pos.x)+"px",Math.round(this.pos.y)+"px",0]+")":"translate("+[Math.round(this.pos.x)+"px",Math.round(this.pos.y)+"px"]+")",d=this.element_div;b&&(d=d.transition().duration(this.options.dur).ease(this.options.easing_fn)),d.style("transform",c),this.options.graphics_caching&&d.style("-webkit-transform",c),this.events.move({type:"move",animated:b,pos:{x:this.pos.x,y:this.pos.y}})}},ma.prototype.moveElement=function(a,b){var c={x:this.pos.x+a.x,y:this.pos.y+a.y};this.translateElement(c,b)},ma.prototype.mouseHovering=function(a){this.canvas_model?this.canvas_model.setActive(this,a):this.setActive(a)},ma.prototype.setActive=function(a){this.active!==a&&(this.active=a,this.updateBGStyle(),"arrange"!==this.mode&&this.setSubTypeActive(),this.emitEvent("active",{active:a}))},ma.prototype.setSubTypeActive=function(){},ma.prototype.updateBGStyle=function(){if(this.options.show_bg){var a=["bg"];a.push("arrange"!==this.mode?"edit":"arrange"),this.dragging?a.push("dragging"):this.active&&a.push("active"),a.push("style"),this.element_div.style("visibility",null).style(this.options[a.join("_")])}},ma.prototype.removeElement=function(){this.element_div.remove()},ma.prototype.getBBox=function(){return{x:this.pos.x,y:this.pos.y,width:this.size.width,height:this.size.height}},ma.prototype.overlapsWithRegion=function(a){Wa.HitTester.overlaps({x:this.pos.x,y:this.pos.y,width:this.size.width,height:this.size.height},a)},ma.prototype.hitTest=function(a){return a.x>=this.pos.x&&a.x<=this.pos.x+this.size.width&&a.y>=this.pos.y&&a.y<=this.pos.y+this.size.height},ma.prototype.getDistanceTo=function(a){var b=this.size.width/2,c=this.size.height/2,d=Math.max(Math.abs(this.pos.x+b-a.x)-b,0),e=Math.max(Math.abs(this.pos.y+c-a.y)-c,0);return d*d+e*e},Wa.DerivationRow=na;na.prototype.createHandle=function(){if(this.view&&!this.dl.options.no_handles){this.mtouch=this.setupInteractionListeners();var a=this.getHandlePos(),b=this.el.selectAll(".handle").data([this,this]);b.enter().append("circle").classed("handle",!0).style({cursor:"pointer"}).call(this.mtouch).attr("transform","translate("+a+")").attr({fill:"white",stroke:this.handle_color?this.handle_color:this.dl.options.handle_stroke_color,"stroke-width":2,r:10}).attr({"pointer-events":"all"}),this.handle=b,this.setHandleVisibility()}};na.prototype.takeHandle=function(a){this.dl.options.no_handles||(this.handle=a,this.handle.data([this,this]),this.handle_color=this.dl.options.handle_stroke_color,this.handle.style({stroke:this.handle_color}),this.handle.call(this.setupInteractionListeners()),this.bindViewToInteractionHandlerListeners())},na.prototype.setHandleColor=function(a){this.handle_color=a,this.handle&&this.handle.style("stroke",a)},na.prototype.removeHandle=function(){this.view&&(this.mtouch&&(this.mtouch.connected(!1),delete this.mtouch),this.handle&&(this.handle.remove(),delete this.handle))},na.prototype.getHandlePos=function(){if(!this.view)return[0,0];var a=this.view.getBBox({no_padding:!0}),b="left"===this.dl.options.handle_pos?a.x-20:a.x+a.width+25;return[b,a.y+a.height/2]},na.prototype.updateHandlePos=function(a){if(this.view&&!this.dl.options.no_handles){var b=this.getHandlePos();this.handle&&this.handle.transition().ease(this.view.options.easing_fn).duration(a?0:this.view.options.dur).attr("transform","translate("+b+")")}},na.prototype.createView=function(a,b){var c=this,d=c?this.dl.alignment_correction.insert("g","g.dl-line#"+c.model.id):this.dl.alignment_correction.append("g");d.classed("dl-line",!0).attr("id",this.model.id).attr("transform","translate("+(a.pos||[0,0])+")").datum(this),this.el=d,a.pos=[0,0],a.border_color="none",a.background_color=this.dl.options.row_background_color,this.dl.options.standalone&&(a.event_receiver=this.dl.svg.node()),a.derivation_list=this.dl,this.setView(new ka(this.model,d,a));var e=this;this.view.init(function(){e.bindViewToInteractionHandlerListeners(),e.createHandle(),b&&b(e.dl)})},na.prototype.setView=function(a){this.view&&this.view.events.on("updated."+this.id,null),this.view=a,this.view&&this.view.events.on("updated."+this.id,this.updateDimensionAfterInteraction.bind(this))},na.prototype.listenToInteractionHandlerEvents=function(){var a=this;a.view.interaction_handler.events.on("inspect_node."+a.id,function(b){a.dl.events.inspect_node({type:"inspect",node:b.node,dl:a.dl,row:a.idx})}),a.view.interaction_handler.events.on("drag_start."+a.dl.id,a.dl.setActiveDLComponent.bind(a.dl,"AV")),a.view.interaction_handler.events.on("drag_end."+a.dl.id,a.dl.setActiveDLComponent.bind(a.dl,"none")),a.view.interaction_handler.events.on("touch."+a.dl.id,function(){a.dl.delete_mode?a.dl.canvas_model.removeElement(a.dl):(a.dl.updateBGStyle(),a.dl.updateHandleVisibilities())})},na.prototype.bindViewToInteractionHandlerListeners=function(){var a=this;this.view.interaction_handler.events.on("inspect_node."+this.id,function(b){a.dl.events.inspect_node({type:"inspect",node:b.node,dl:a.dl,row:a.idx})}),this.view.interaction_handler.events.on("drag_start."+this.dl.id,this.dl.setActiveDLComponent.bind(this.dl,"AV")),this.view.interaction_handler.events.on("drag_end."+this.dl.id,this.dl.setActiveDLComponent.bind(this.dl,"none")),this.view.interaction_handler.events.on("touch."+this.dl.id,function(){a.dl.delete_mode?a.dl.canvas_model.removeElement(a.dl):(a.dl.updateBGStyle(),a.dl.updateHandleVisibilities())})},na.prototype.updateDims=function(){if(this.view){var a=this.view.getBBox({no_padding:!0});a.y-=this.padding.top,a.height+=this.padding.top+this.padding.bottom,a.x-=this.padding.left,a.width+=this.padding.left+this.padding.right;var b=this.dims.x!==a.x||this.dims.y!==a.y||this.dims.width!==a.width||this.dims.height!==a.height;return b&&(this.dims=a),b}},na.prototype.updateDimensionAfterInteraction=function(a){this.updateDims()&&(this.dl.updateDims()?this.updateHandlePos(a):(this.updateBackground(a),this.updateHandlePos(a)))},na.prototype.updateBackground=function(a){if(this.view&&this.dims){var b=this.dims.x-this.dl.dims.x+this.padding.left-this.dl.options.padding.left,c=this.dl.dims.x+this.dl.dims.width-this.dims.x-this.dims.width+this.padding.right-this.dl.options.padding.right;this.view.options.padding={left:b,right:c,top:this.padding.top,bottom:this.padding.bottom},this.view.update_background(a)}},na.prototype.showBackground=function(a){this.view&&(this.view.options.border_color=a?this.dl.options.row_border_color:"none",this.updateBackground(),this.view.set_background_visible(!0))},na.prototype.hideBackground=function(){this.view&&this.view.set_background_visible(!1)},na.prototype.setHandleVisibility=function(a){if(this.view&&!this.dl.options.no_handles&&this&&this.handle){arguments.length<1&&(a=!0);var b=(this.dl.rows,this.dl.options.hide_handles),c=this;this.handle.each(function(d,e){return b||!a||"AV"===c.dl.active_dl_component||!c.dl.active&&c.dl.canvas_model&&"mouse"===c.dl.canvas_model.inputMode()?void d3.select(this).attr("visibility","hidden"):void(c.atLeastOneNotCutHiddenRowAbove()?(d3.select(this).attr({visibility:"visible",cx:3-6*e}),c.representHiddenHandleColor()):(d3.select(this).attr({visibility:0===e?"visible":"hidden",cx:0}),c.revertHandleColor()))})}},na.prototype.atLeastOneNotCutHiddenRowAbove=function(){for(var a=this.dl.rows,b=this.idx-1;b>=0;b--)if(!a[b].hidden||!a[b].cut)return!!a[b].hidden;return!1},na.prototype.representHiddenHandleColor=function(){var a;this.handle_color===this.dl.options.handle_stroke_color&&(a=this.coloredHandleHiddenBeneath())&&"pack"===this.dl.curr_row_operation&&(this.setHandleColor(a),this.is_displaying_hidden_handle_color=!0)},na.prototype.revertHandleColor=function(){this.is_displaying_hidden_handle_color&&(this.setHandleColor(this.dl.options.handle_stroke_color),delete this.is_displaying_hidden_handle_color)},na.prototype.coloredHandleHiddenBeneath=function(){for(var a=this.dl.rows,b=this.idx-1;b>=0;b--)if(!a[b].hidden||!a[b].cut){if(a[b].hidden&&a[b].handle_color!==this.dl.options.handle_stroke_color)return a[b].handle_color;if(!a[b].hidden)return!1}return!1},na.prototype.hide=function(){this.view&&!this.hidden&&(this.hidden=!0,this.view&&(this.view.options.auto_update=!1),this.dl.options.collapsed_mode||this.dl.updateDims(),this.el.attr("display","none"),this.dl.rows[this.idx+1]&&this.dl.rows[this.idx+1].setHandleVisibility())},na.prototype.unhide=function(){this.view&&this.hidden&&(this.dl.singleLineMode(!1),this.hidden=!1,this.view&&(this.view.options.auto_update=!0,this.view.update_all(!0)),this.dl.updateDims(),this.el.attr("display",null),this.dl.rows[this.idx+1]&&this.dl.updateHandleVisibilities(),this.dl.rows[this.idx].updateHandlePos(!0))},na.prototype.deactivate=function(){this.view&&(this.view.interactive(!1),this.model.for_each(function(a){a.dragging=!1,a.selected=!1}),this.view.update_all())},na.prototype.remove=function(){for(var a=this.idx+1;a<this.dl.rows.length;a++)this.dl.rows[a].idx--;this.dl.rows.splice(this.idx,1),this.removeHandle(),this.view&&this.el.remove(),this.model.events.on("end-of-interaction."+this.dl.id,null),this.model.events.on("change."+this.dl.id,null),this.model.events.on("create."+this.dl.id,null)},na.prototype.removeInteractionListeners=function(){this.mtouch&&this.mtouch.on("drag",null).on("touch",null).on("tap",null).on("release",null)},na.prototype.setupInteractionListeners=function(){var a=this;return this.mtouch?(this.removeInteractionListeners(),this.mtouch.connected(!1)):this.mtouch=Wa.mtouch_events(),this.mtouch.origin(function(b){return[a.dl.pos.x+b.pos[0],a.dl.pos.y+b.pos[1]]}).on("drag",this.drag.bind(this)).on("touch",this.touch.bind(this)).on("tap",this.tap.bind(this)).on("release",this.dragend.bind(this)),this.mtouch},na.prototype.touch=function(a){this.dl.atStartOfInteraction({type:"start-of-interaction",source:{type:"DerivationRow",id:this.dl.id,row:this.idx,model:this.model,packState:this.dl.rows.map(function(a){return!!a.hidden})},time:Date.now()});var b=a.row||0===a.row?this.dl.rows[a.row]:a;this.dl.options.send_events&&isNaN(a.row)&&this.dl.row_events.touch(new na.touchEvent(d3.event,b.idx,this.dl.id)),this.dl.setActiveDLComponent("row"),this.dl.curr_row_operation="undecided",this.dl.canvas_svg_dims=this.dl.getContainerDimensions();for(var c=0;c<this.dl.rows.length;c++)this.dl.rows[c].showBackground(c===b.idx);b.handle.attr({fill:"whitesmoke"})},na.prototype.tap=function(a){var b=a.row||0===a.row?this.dl.rows[a.row]:a;this.dl.options.send_events&&isNaN(a.row)&&this.dl.row_events.tap(new na.tapEvent(d3.event,b.idx,this.dl.id));var c=this;if(Wa.actions.editLineAction.match(b.model)){var d=Wa.actions.editLineAction.createBoundAction(b.model,{actor:b.model});b.model.performAction(d,function(){c.updateDimensionAfterInteraction()},!0),this.dl.afterEndOfInteraction({type:"end-of-interaction",source:{type:"DerivationRow",id:this.dl.id},time:Date.now()})}},na.prototype.createLinkVis=function(){this.link=this.el.append("g");var a=this.getHandlePos();this.lpos=[a[0],a[1]],this.link.append("line").attr({x1:this.lpos[0],y1:this.lpos[1],x2:this.lpos[0],y2:this.lpos[1]}).style("stroke",this.handle_color?this.handle_color:this.dl.options.handle_stroke_color).style("stroke-width",2).style("stroke-linecap","round"),this.link.append("circle").attr({cx:this.lpos[0],cy:this.lpos[1],r:10}).style("fill","white").style("stroke",this.handle_color?this.handle_color:this.dl.options.handle_stroke_color).style("stroke-width",2),this.link.append("circle").attr("id","cursor").attr({cx:this.lpos[0],cy:this.lpos[1],r:10}).style("fill","white").style("stroke",this.handle_color?this.handle_color:this.dl.options.handle_stroke_color).style("stroke-width",2)},na.prototype.drag=function(a){var b,c,d,e,f,g,h,i;this.sub_handler=this.view.interaction_handler.handlers.row,a.row||0===a.row?(b=a,c=this.dl.rows[b.row]):(b=d3.event,c=a),d=b.x,e=b.dx,f=b.y,g=b.dy,h=Math.abs(b.finger.dist_x),i=Math.abs(b.finger.dist_y),this.dl.options.send_events&&isNaN(b.row)&&this.dl.row_events.drag(new na.dragEvent(b,c.idx,this.dl.id));var j=Math.sqrt(h*h+i*i);if(j>=10&&"link"!==this.dl.curr_row_operation&&"pack"!==this.dl.curr_row_operation&&(i/j>=.85&&0!==c.idx?this.dl.curr_row_operation="pack":(this.dl.curr_row_operation="link",this.createLinkVis(),this.subable=this.sub_handler.check(b,this.model),this.subable&&this.sub_handler.start(this.getHandlePos()),this.macro=Wa.actions.ApplyMacroAction.derivationApplicableAsMacro(this.dl)&&0===this.idx)),"pack"===this.dl.curr_row_operation)this.dl.handlePackArranging(c,f,g);else if("link"===this.dl.curr_row_operation){var e=b.finger.dx,g=b.finger.dy;this.lpos[0]=this.lpos[0]+e,this.lpos[1]=this.lpos[1]+g,this.link.select("line").attr({x2:this.lpos[0],y2:this.lpos[1]}),this.link.select("#cursor").attr({cx:this.lpos[0],cy:this.lpos[1]});var k={x:this.dl.pos.x-this.dl.dims.x+this.pos[0]+this.lpos[0],y:this.dl.pos.y-this.dl.dims.y+this.pos[1]+this.lpos[1]},l=Wa.find(this.dl.canvas_model.elements(),function(a){return a.hitTest(k)}),m=l?l.type:null;if(this.subable){this.sub=this.sub_handler.update(b);var n="ggb-element"===m||"ggb-panel"===m;this.sub_handler.enableSubstitution(!n)}}},na.prototype.dragend=function(a){var b=a.row||0===a.row?this.dl.rows[a.row]:a;if(this.dl.options.send_events&&isNaN(a.row)&&this.dl.row_events.release(new na.releaseEvent(d3.event,b.idx,this.dl.id)),this.releaseRow(b),"link"===this.dl.curr_row_operation){var c={x:this.dl.pos.x-this.dl.dims.x+this.pos[0]+this.lpos[0],y:this.dl.pos.y-this.dl.dims.y+this.pos[1]+this.lpos[1]},d=Wa.find(this.dl.canvas_model.elements(),function(a){return a.hitTest(c)}),e=d?d.type:null;if("ggb-element"===e&&(d=d.ggbPanel,e="ggb-panel"),"ggb-panel"===e)d.dropDLRow(this);else if("derivation"===e&&this.macro&&this.endingPosIsInLastRowHandle(c,d)){var f=[this.dl.rows[0].model,this.dl.getLastModel()],g=d.getLastModel(),h=Wa.actions.ApplyMacroAction.getAllAvailableActions(f,g);if(h.length>0){var i=h[0];i.bindMacroDerivation(this.dl),g.performAction(i)}}else if("derivation"!==e&&!this.sub&&this.dl.options.cloning_on){this.cloneLine(b,c.x,c.y);var j={},k=this.clone.getLastRow().view.getBBox({no_padding:!0});j.x="left"===this.dl.options.handle_pos?c.x-20:c.x-k.width-60,j.y=c.y-k.height/2-10,this.clone.translateElement(j),this.clone.setActiveDLComponent("none"),this.clone=null}this.subable&&this.sub_handler.end(),this.link.remove(),this.link=null,this.lpos=null,this.subable=!1,this.sub=!1}this.dl.curr_row_operation="none",this.dl.afterEndOfInteraction({type:"end-of-interaction",source:{type:"DerivationRow",id:this.dl.id,row:this.idx,model:this.model,packState:this.dl.rows.map(function(a){return!!a.hidden})},time:Date.now()})},na.prototype.releaseRow=function(a){this.dl.setActiveDLComponent("none");for(var b=0;b<this.dl.rows.length;b++)this.dl.rows[b].hideBackground();if(this.dl.options.no_handles||a.handle.attr({fill:"white"}),this.dl.draginfo=null,a.idx>0){var c=this.dl.getFinalVerticalPos(a)-a.pos[1],d=this.dl.getVisibleAbove(a);d&&c>0&&c>.5*d.dims.height&&d.hide(),this.dl.layoutRows()}this.dl.updateBGStyle(),this.dl.updateHandleVisibilities()},na.prototype.cloneLine=function(a,b,c){var d=Wa.extend({},this.dl.options);Wa.extend(d,this.dl.av_options),Wa.extend(d,this.dl.am_options),d.pos={x:b,y:c},d.eq=a.model.to_ascii(),d.id=Wa.uid(),this.dl.options.send_events&&this.dl.events.clone(new na.cloneEvent(this.dl.id,d)),this.clone=this.dl.canvas_model.createDL(d),this.dl.hovering&&(this.clone.pos={x:b,y:c},this.clone.element_group.transition().duration(0).attr("transform","translate("+[this.clone.pos.x,this.clone.pos.y]+")"),this.clone.toggleHover(!1)),this.clone.setActiveDLComponent("DL"),this.dl.curr_row_operation="clone";var e=new ga(a.model,this.clone.rows[0].model,Wa.actions.CloneAction.createBoundAction(a.model,{}),!0);Wa.LinkCoordinator.addLink(e)},na.prototype.handleCloneDrag=function(a,b,c){this.clone.drag(d3.event);var d=this.dl.pos.x+a.pos[0]-this.clone.pos.x,e=this.dl.pos.y+a.pos[1]-this.clone.pos.y;this.clone_dist=Math.sqrt(d*d+e*e)},na.prototype.endingPosIsInLastRowHandle=function(a,b){var c=(b.getLastRow(),b.pos),d=b.getLastRow().pos,e=(b.getLastRow().view.getBBox({no_padding:!0}),b.getLastRow().getHandlePos()),f={x:c.x-b.dims.x+d[0]+e[0],y:c.y-b.dims.y+d[1]+e[1]};return Math.abs(a.x-f.x)<20&&Math.abs(a.y-f.y)<20},Wa.inherit(ma,oa),Wa.DerivationList=oa,oa.defaultOptions={eq:"",dont_init_eq:!1,pos:{x:"center",y:"center"},debug_lines:!1,visualize_derivations:"none",visualize_derivations_method:"all",embedded:!0,border_radius:0,v_align:"center",h_align:"equals",row_padding:{left:10,right:45,top:7,bottom:3},padding:{left:20,right:5,top:5,bottom:5},edit_mode_drag_box_width:30,handle_pos:"right",handle_stroke_color:"#ddd",row_border_color:"#ddd",row_background_color:"white",font_size:50,collapsed_mode:!0,draggable:!0,no_history:!1,no_handles:!1,hide_handles:!1,break_off_dist:50,wiggle:[],auto_resize_container:!1,keep_in_container:!0,cloning_on:!0,replace_value_on:!0,hoverable:!1,auto_collapse_repeated_actions:!0,auto_simplify_distributions:!0,auto_simplify_vector_additions:!0,auto_simplify_variables:!0,modes:["edit","inspect","arrange"],send_events:!0,mappings_color:"rgb(194, 219, 179)",mappings_active_stroke:"steelblue",mappings_rect_radius:6,mappings_joint_width:16,mappings_joint_length:8,mappings_line_thickness:6,row_transition_dur:250,resizable:{x:!1,y:!1},action_blacklist:[],graphics_caching:!1,svg_no_overflow:!1,svg_overflow_margin:500},oa.prototype.toJSON=function(){return Wa.extend(Wa.deepCopy(this.options),{id:this.id,type:"DerivationList",pos:this.pos})},oa.createFixedSingleLineDL=function(a,b,c){return b=b||{},b.keep_in_container=!1,b.draggable=!1,b.no_handles=!0,b.collapsed_mode=!0,b.show_bg=!1,b.h_align="h_align"in b?b.h_align:"center",new oa(null,a,b,c)},oa.prototype.startUpdateSequence=function(){this.options.visualized&&this.update_sequence++},oa.prototype.isInUpdateSequence=function(){if(this.options.visualized)return this.update_sequence>0},oa.prototype.finishUpdateSequence=function(){if(this.options.visualized&&(this.update_sequence--,0===this.update_sequence&&this.updateDims(),this.update_sequence<0))throw"called finishUpdateSequence before startUpdateSequence"},oa.prototype.initDerivationListOptions=function(a){a=a||{};var b=Wa.deepCopy(oa.defaultOptions);a.standalone&&(b.show_bg=!1);var c=Wa.object.extendExisting(b,a);"hide_handles"in a||!a.no_history||(c.hide_handles=!c.draggable),Wa.extend(this.options,c);var d=Wa.object.merged(oa.defaultOptions,a);this.aview_options=Wa.object.extendChanged({},d,Wa.AlgebraView.defaultOptions),this.amodel_options=Wa.object.extendChanged({},d,Wa.AlgebraModel.defaultOptions)},oa.prototype.initDerivationListProperties=function(){this.rows=[],this.hovering=!1,this.active_dl_component="none",this.curr_row_operation="none",this.clone=null,this.dims={}},oa.prototype.initDerivationList=function(a){var b=this;this.options.visualized&&(this.svg=this.element_div.insert("svg","*"),
this.options.svg_no_overflow?this.svg.style({"pointer-events":"none",overflow:"hidden",position:"absolute",left:-this.options.svg_overflow_margin+"px",top:-this.options.svg_overflow_margin+"px",width:"calc(100% + "+2*this.options.svg_overflow_margin+"px)",height:"calc(100% + "+2*this.options.svg_overflow_margin+"px)"}):this.svg.style({overflow:"visible",position:"absolute",left:0,right:0,top:0,bottom:0,width:"100%",height:"100%"}),this.alignment_correction=this.svg.append("g")),this.options.eq.length>0&&!this.options.dont_init_eq?this.addLineFromExpressions(this.options.eq.split("\\\\"),function(){b.initPosition(),b.options.visualized&&b.startWiggle(b.options.wiggle),a&&a(b)}):a&&a(this)},oa.prototype.applyViewAlignment=function(){this.translateElement({x:this.pos.x,y:this.pos.y+this.dims.y})},oa.prototype.addLineFromExpressions=function(a,b){if(a.length<1)return void(b&&b(this));for(var c=0;c<a.length;c++)this.addLineFromExpression(a[c],c===a.length-1?b:null)},oa.prototype.addLineFromExpression=function(a,b){this.rows.length>0&&this.rows[this.rows.length-1].deactivate(),this.addRowFromAscii(a,b)},oa.prototype.inputModeChanged=function(a){this.rows.forEach(function(a){return a.setHandleVisibility()})},oa.prototype.startWiggle=function(a){var b=this.getLastView();b.wiggle(a,!0)},oa.prototype.setExpression=function(a,b,c){this.getLastModel().parseAndSet(a,b,c)},oa.prototype.exitSubTypeMode=function(){"inspect"===this.mode&&this.draw_mappings_for_nodes([])},oa.prototype.enterSubTypeMode=function(a){this.rows&&this.rows.forEach(function(b,c){b.view&&(b.view.interaction_handler.setMode(a),b.view.update_existing("normal"))},this)},oa.prototype.singleLineMode=function(a){if(0===arguments.length)return this.options.collapsed_mode;if(a&&!this.options.collapsed_mode){for(var b=!1,c=0;c<this.rows.length-1;c++)this.rows[c].hidden||(b=!0,this.rows[c].hide());b&&this.layoutRows()}return this.options.collapsed_mode=a,this},oa.prototype.getLastRow=function(){return this.rows[this.rows.length-1]},oa.prototype.getRowByModel=function(a){for(var b=0;b<this.rows.length;b++)if(this.rows[b].model===a)return this.rows[b];return null},oa.prototype.getLastModel=function(){return this.getLastRow().model},oa.prototype.getLastView=function(){return this.getLastRow().view},oa.prototype.onChange=function(a){var b=this.getRowByModel(a.old_model);b&&(a.new_model!==a.old_model&&(this.removeModelEventListeners(a.old_model),this.addModelEventListeners(a.new_model),b.model=a.new_model),setTimeout(function(){for(var a=!1,b=1;b<this.rows.length;b++){var c=this.rows[b];c.action.broken&&(a=!0),!!c.model.broken!==a&&(c.model.broken=a,c.model.for_each(function(b){b.color=a?"#E0A8A8":c.view.options.color}),c.hidden||c.view.update_existing("normal"))}}.bind(this),1),this.events.change(Wa.extend(new oa.ChangeEvent(this.id,b.model,b.idx),a)))},oa.prototype.onCreate=function(a){var b=this;this.startUpdateSequence();try{var c=(this.getLastView(),this.getLastRow()),d=(c.el,c.handle,a.action.oldTree);if(d.for_each(function(a){a.dragging=!1,a.selected=!1}),d.hide_nodes(),a.action.new_derivation&&this.canvas_model){var e={dont_init_eq:!0,eq:a.action.newTree.to_ascii(),pos:{x:-1e3,y:-1e3}};this.canvas_model.createElement("derivation",e,"math-action",function(c){c.addRowFromModel(a.action.newTree,null,function(){b.canvas_model.moveToFreeSpace(c,!1,b)||c.translateElement({x:10,y:10},!1)})})}else{var f=this.addRowFromAction(a.action);this.events.added_line(Wa.extend({senderDL_id:this.id,row:c.idx},a)),this.options.visualized&&c.hide(),this.events.change(new oa.ChangeEvent(this.id,f.model))}Wa.LinkCoordinator.addLink(new ga(a.action.oldTree,a.action.newTree,a.action)),"SubstitutionAction"!==a.action.name&&"EquationCombineAction"!==a.action.name||Wa.LinkCoordinator.addLink(new ga(a.action.nodes[0],a.action.newTree,a.action))}finally{this.finishUpdateSequence()}},oa.prototype.onRestraint=function(a){if(this.options.visualized){var b=this.pos.x+this.size.width,c=this.pos.y+this.getLastRow().pos[1];this.canvas_model.createElement("textbox",{text:a,dont_log_events:!0,pos:{x:b,y:c},undeditable:!0,resizable:{x:!1,y:!1},use_toolbar:!1,select_text_on_create:!1}),console.log(a)}},oa.prototype.shouldCutRow=function(a){return!!this.rowIsPartOfAContinuousCommutingSequence(a)},oa.prototype.rowIsPartOfAContinuousCommutingSequence=function(a){var b=this.rows[a.idx+1];if(!b)return!1;var c=a.action,d=b.action;if(!c||!d)return!1;if("CommuteAction"!==c.name||"CommuteAction"!==d.name)return!1;for(var e=0;e<c.nodes.length;e++){var f=c.nodes[e],g=d.nodes[e];if(!g)return!1;var h=c.mapNodes(f);if(h.length>1)return!1;if(h[0]!==g)return!1}return!0},oa.prototype.addRowFromAction=function(a){var b=a.newTree;if(this.options.visualized){var c=this.getLastView();c.bindToModel(b,a.initial_node_map)}var d=this.getLastRow();d.removeInteractionListeners();var e=this.createRow(b,a,d.el);return e.setView(d.view),this.options.visualized&&(e.takeHandle(d.handle),d.handle=null,c.update_all(),this.shouldCutRow(d)&&this.firstRowInSequence?(d.setView(null),d.hidden=!0,d.el=null,d.cut=!0):d.createView(Wa.object.merged(c.options,{interactive:!1,pos:d.pos.slice()}))),this.rowBeforeCurrActionSeq||(this.rowBeforeCurrActionSeq=d),this.firstRowInSequence||(this.firstRowInSequence=e),e},oa.prototype.createRow=function(a,b,c){var d=this.getLastRow(),e={model:a,action:b,view:null,el:c,handle:null,dims:d?Wa.extend({},d.dims):null,row_idx:this.rows.length,pos:d?d.pos.slice():[0,0],padding:this.options.row_padding},f=new na(this,e);return c&&(c.datum(f),c.attr("id",a.id)),this.addModelEventListeners(a),this.rows.push(f),f},oa.prototype.addModelEventListeners=function(a){a.events.on("start-of-interaction."+this.id,this.atStartOfInteraction.bind(this)),a.events.on("end-of-interaction."+this.id,this.afterEndOfInteraction.bind(this)),a.events.on("change."+this.id,this.onChange.bind(this)),a.events.on("mistake."+this.id,this.events.mistake),a.events.on("create."+this.id,this.onCreate.bind(this)),a.events.on("restraint."+this.id,this.onRestraint.bind(this))},oa.prototype.removeModelEventListeners=function(a){a.events.on("start-of-interaction."+this.id,null),a.events.on("end-of-interaction."+this.id,null),a.events.on("node-changed."+this.id,null),a.events.on("create."+this.id,null),a.events.on("mistake."+this.id,null),a.events.on("change."+this.id,null),a.events.on("restraint."+this.id,null)},oa.prototype.atStartOfInteraction=function(a){a&&a.source&&("AlgebraModel"===a.source.type&&this.startUpdateSequence(),this.events["start-of-interaction"](a))},oa.prototype.afterEndOfInteraction=function(a){if(a&&a.source)if("DerivationRow"===a.source.type)this.events["end-of-interaction"](a);else if("AlgebraModel"===a.source.type){this.isInUpdateSequence()&&this.finishUpdateSequence();var b=a.source,c=this.getRowByModel(b),d=c.view.interaction_handler.mode;if(this.canvas_model?this.canvas_model.setActive(this,!0):this.setActive(!0),"inspect"===d)c.updateDimensionAfterInteraction(),this.events["end-of-interaction"](Wa.extend(a,{row:c.idx}));else if("edit"===d){if(b!==this.getLastModel())return;if(this.events["end-of-interaction"](a),this.rowBeforeCurrActionSeq)if(this.rowBeforeCurrActionSeq.model.stringify()===this.getLastModel().stringify()){for(var e=(this.rows.length,0);this.getLastRow()!==this.rowBeforeCurrActionSeq;)this.undo(),e++;this.events.auto_undo({undos:e})}else{var c=this.rowBeforeCurrActionSeq,f=this.shouldHideRow(c);this.getLastView().callAfterAnimation(function(){this.startUpdateSequence(),f||c.unhide(),this.layoutRows(),this.finishUpdateSequence()}.bind(this))}this.rowBeforeCurrActionSeq=null,this.firstRowInSequence=null}}},oa.prototype.addRowFromModel=function(a,b,c){var d=this.getLastRow();d&&d.deactivate();var e=this.createRow(a,b),f=d?d.pos.slice():[0,0],g=this;return this.options.visualized&&e.createView(Wa.object.merged(this.aview_options,{pos:f}),function(){g.events.added_line({type:"create",senderDL_id:g.id,action:b&&"string"!=typeof b?b:{name:"row added from model",newTree:a},row:e.idx}),g.layoutRows(),c&&c(g)}),e},oa.prototype.addRowFromAscii=function(a,b){return this.addRowFromModel(new fa(a,this.amodel_options),null,b)},oa.prototype.getRowByView=function(a){return this.rows.filter(function(b){return b.view===a})[0]},oa.prototype.updateAllRowBackgroundsAndHandles=function(a){for(var b=0;b<this.rows.length;b++){var c=this.rows[b];c.updateBackground(a),c.updateHandlePos(a)}},oa.prototype.shouldHideRow=function(a){var b=this.rows[a.idx+1];if(b&&b.action&&b.action.settings.layout_hint){if("same-line"===b.action.settings.layout_hint)return!0;if("new-line"===b.action.settings.layout_hint)return!1}if(this.options.collapsed_mode)return!0;if(this.options.auto_collapse_repeated_actions&&b&&a.action&&b.action&&a.action.name===b.action.name)return!0;if(this.canvas_model){var c=this.rows[this.rows.length-1],d={x:this.pos.x,y:this.pos.y+a.pos[1]+a.dims.height+this.options.padding.top,width:this.dims.width,height:c.dims.height};return!this.canvas_model.isInFreeVisibleSpace(d,this)}return!1},oa.prototype.getFinalVerticalPos=function(a,b,c){c=c||0;for(var d=this.rows[c].pos[1],e=c+1;e<=a.idx;e++)this.rows[e-1].hidden&&!b||(d+=this.getVerticalAdvance(this.rows[e]));return d},oa.prototype.isAboveFinalVerticalPos=function(a){return a.pos[1]<this.getFinalVerticalPos(a)},oa.prototype.getUpmostPullableRow=function(a){var b;if(this.rows.length<2)return this.rows[0];if(this.isAboveFinalVerticalPos(this.rows[1]))b=0;else for(b=a.idx;b>=0&&(!this.rows[b].hidden||!this.rows[b].el)&&this.isAboveFinalVerticalPos(this.rows[b]);b--);return b===a.idx?null:this.rows[b+1]},oa.prototype.getHiddenAbove=function(a){var b=a.idx-1;if(this.rows[0].hidden)return this.rows[0];for(;b>=0&&(!this.rows[b].hidden||!this.rows[b].el||!this.rows[b].el);)b--;return b===-1?null:this.rows[b]},oa.prototype.getVisibleAbove=function(a){for(var b=a.idx-1;b>=0&&this.rows[b].hidden;)b--;return b===-1?null:this.rows[b]},oa.prototype.getVisibleRowOn=function(a){for(var b=a.idx,c=this.rows.length;b<c&&this.rows[b].hidden;)b++;return b===c?null:this.rows[b]},oa.prototype.getDistanceFromHome=function(a){var b=a.pos[0]-a.drag_pos[0],c=a.pos[1]-a.drag_pos[1];return Math.sqrt(b*b+c*c)},oa.prototype.toggleHover=function(a){if(0===arguments.length&&(a=!0),this.hovering){this.hovering=!1,this.updateBGStyle(),this.remove();var b=this.svgg.node(),c=this.original_container;delete this.original_container;c.node().appendChild(b);if(this.unhoverRemove.remove(),this.svg=c,a){var d=-1*d3.select("#wikiMainSvg").node().getBoundingClientRect().top,e=-1*d3.select("#wikiMainSvg").node().getBoundingClientRect().left;this.pos[1]+=d,this.pos[0]+=e}var f=[this.pos[0],this.pos[1]];this.svgg.attr("transform","translate("+f+")"),this.svgDims=this.getContainerDimensions(),this.moveIntoContainer()}else{if(0==this.options.hoverable)return;this.hovering=!0,this.updateBGStyle(),this.remove();var b=this.svgg.node(),g=d3.select("#hovering"),h=g.select("g"),i=h.append("g");this.unhoverRemove=i,this.original_container=this.svg,this.svg=h;i.node().appendChild(b);if(a){var d=d3.select("#wikiMainSvg").node().getBoundingClientRect().top,e=d3.select("#wikiMainSvg").node().getBoundingClientRect().left;this.pos[1]+=d,this.pos[0]+=e}var f=[this.pos[0],this.pos[1]];this.svgg.attr("transform","translate("+f+")")}this.layoutRows()},oa.prototype.setLastHandleVisibility=function(a){this.getLastRow().setHandleVisibility(a)},oa.prototype.updateHandleVisibilities=function(){for(var a=0;a<this.rows.length;a++)this.rows[a].setHandleVisibility()},oa.prototype.countVisibleRows=function(){for(var a=0,b=0;b<this.rows.length;b++)this.rows[b].hidden||a++;return a},oa.prototype.updateDims=function(){if(!this.isInUpdateSequence()){var a=1/0,b=1/0,c=-(1/0),d=-(1/0);this.rows.forEach(function(e){e.hidden||(a=Math.min(a,e.dims.x+e.pos[0]),b=Math.min(b,e.dims.y+e.pos[1]),c=Math.max(c,e.dims.x+e.dims.width+e.pos[0]),d=Math.max(d,e.dims.y+e.dims.height+e.pos[1]))},this),a-=this.options.padding.left,c+=this.options.padding.right,b-=this.options.padding.top,d+=this.options.padding.bottom;var e=a-this.dims.x,f=b-this.dims.y,g=this.dims.x!==a||this.dims.width!==c-a,h=this.dims.y!==b||this.dims.height!==d-b;return(g||h)&&(this.dims={x:a,y:b,width:c-a,height:d-b},this.dimsHaveChanged(e,f,g)),g||h}},oa.prototype.dimsHaveChanged=function(a,b,c){var d=[-this.dims.x+(this.options.svg_no_overflow?this.options.svg_overflow_margin:0),-this.dims.y+(this.options.svg_no_overflow?this.options.svg_overflow_margin:0)];this.alignment_correction.attr("transform","translate("+d+")"),(Math.abs(a)>.5||Math.abs(b)>.5)&&this.translateElement({x:this.pos.x+a,y:this.pos.y+b}),this.resizeElement(this.dims),c&&this.rows.forEach(function(a){a.updateBackground()})},oa.prototype.handlePackArranging=function(a,b,c){var d,e=this.rows[this.rows.length-1];if(c>0)if(this.isAboveFinalVerticalPos(a))d=this.getUpmostPullableRow(a);else{if(d=this.getHiddenAbove(a),!d)return;d.unhide(),this.events.pack_state(new na.stateEvent(this)),d=this.rows[d.idx+1]}else{if(d=this.getVisibleAbove(a),!d)return;a.pos[1]<=d.pos[1]?(d.hide(),this.events.pack_state(new na.stateEvent(this)),1===this.countVisibleRows()&&this.singleLineMode(!0)):d=this.rows[d.idx+1]}for(var f=d.idx;f<=e.idx;f++){var g=this.rows[f];g.pos[1]=Math.min(this.getFinalVerticalPos(g),g.pos[1]+c),g.pos[1]=Math.max(f>a.idx?this.getFinalVerticalPos(g,!1,a.idx):0,g.pos[1]),g.el&&(g.el.attr("transform","translate("+g.pos+")"),this.events.pack_state(new na.stateEvent(this)))}this.updateDims()},oa.prototype.setActiveDLComponent=function(a){this.active_dl_component!==a&&(this.active_dl_component=a,"none"!==this.active_dl_component&&(this.canvas_model?this.canvas_model.setActive(this):this.setActive(!0)),this.options.visualized&&(this.updateBGStyle(),this.updateHandleVisibilities()))},oa.prototype.setSubTypeActive=function(){this.options.visualized&&this.updateHandleVisibilities()},oa.prototype.updateBGStyle=function(){if(this.options.show_bg){var a=["bg"];a.push("arrange"!==this.mode?"edit":"arrange"),this.dragging?a.push("dragging"):this.active&&"AV"!==this.active_dl_component&&a.push("active"),a.push("style"),this.element_div.attr("visibility",null).style(this.options[a.join("_")])}},oa.prototype.getVerticalAdvance=function(a){if(0===a.idx)return 0;var b=this.options.v_align;return"center"===b?this.rows[a.idx-1].dims.height/2+a.dims.height/2:"top"===b?this.rows[a.idx-1].dims.height:"bottom"===b||"alphabetic"===b?a.dims.height:void 0},oa.prototype.layoutRows=function(){var a=this.rows[0].pos,b=a[0],c=a[1];this.rows[0].idx=0;for(var d=1;d<this.rows.length;d++){var e=this.rows[d];if(e.idx=d,this.rows[d-1].hidden||(c+=this.getVerticalAdvance(e)),!e.dragging){var f=e.pos;f[0]===b&&f[1]===c||(f[0]=b,f[1]=c,f=f,e.showBackground(),e.el&&e.el.transition().duration(this.options.row_transition_dur).attr("transform","translate("+f+")").each("end",function(a){a.hideBackground()}))}}this.element_div.selectAll(".dl-line").sort(function(a,b){return a.idx-b.idx}),this.updateDims()},oa.prototype.updateContainerDimensions=function(){this.svgDims=this.getContainerDimensions()},oa.prototype.getContainerDimensions=function(){return this.canvas_model.size()},oa.prototype.setFontSize=function(a){this.options.font_size=a,this.rows.forEach(function(b){b.cut||(b.view.options.font_size=a,b.view.update_all(!0),b.updateHandlePos(!0))}),this.hideAllNodeMappings(),this.layoutRows()},oa.prototype.undo=function(){if(!(this.rows.length<1)){var a=this.getLastRow();a.remove();for(var b=[],c=this.getLastRow();c.cut;)b.push(c),c.remove(),c=this.getLastRow();var d=Wa.LinkCoordinator.unlinkElement(a.model),e=[];b.forEach(function(a){e.push(Wa.LinkCoordinator.unlinkElement(a.model))});var f=this.getLastRow(),g=this.options.collapsed_mode;return f&&(f.unhide(),f.view.interactive(!0),f.view.update_all()),this.updateDims(),this.singleLineMode(g),this.updateBGStyle(),this.updateHandleVisibilities(),{undone_row:0===b.length?a:[a].concat(b),removed_links:0===e.length?d:[d].concat(e)}}},oa.prototype.redo=function(a){var b=a.undone_row,c=a.removed_links;if(Array.isArray(b)){for(;b.length>1;)this.rows.push(b.pop());b=b[0]}this.addRowFromModel(b.model,b.action);if(this.rows.length>1&&this.options.collapsed_mode&&this.rows[this.rows.length-2].hide(),c.length>0&&Array.isArray(c[0])){for(;c.length>1;)Wa.LinkCoordinator.addLinks(c.pop());c=c[0]}Wa.LinkCoordinator.addLinks(c),this.updateBGStyle(),this.updateHandleVisibilities(),this.layoutRows()},oa.prototype.removeElement=function(){return ma.prototype.removeElement.call(this),Wa.LinkCoordinator.unlinkDL(this)},oa.prototype.forceIntoContainer=function(a){0===arguments.length&&(a=!0);var b={x:Math.max(0,Math.min(this.container_size.width-this.size.width,this.pos.x)),y:Math.max(0,Math.min(this.container_size.height-this.size.height,this.pos.y))};b.x===this.pos[0]&&b.x===this.pos[1]||this.translateElement(b)},oa.prototype.getAllDLs=function(){return this.coordinator?this.coordinator.dls:this.canvas_model?this.canvas_model.dls():[this]},oa.ChangeEvent=function(a,b,c){this.type="change",this.performee=a,this.performee_type="DL",this.time=Date.now(),this.row=c,this.model=b},oa.dragEvent=function(a,b){this.type="Drag",this.performee=a,this.performee_type="DL",this.time=Date.now(),this.x=b.x,this.y=b.y},oa.touchEvent=function(a,b){this.type="Touch",this.performee=a,this.performee_type="DL",this.time=Date.now(),this.fingers=b.fingers.map(function(a){return{pos:[a.pos[0],a.pos[1]]}})},oa.releaseEvent=function(a,b){this.type="Release",this.performee=a,this.performee_type="DL",this.time=Date.now(),b.altKey&&(this.altKey=b.altKey),b.shiftKey&&(this.shiftKey=b.shiftKey),this.fingers=b.fingers.map(function(a){return{pos:[a.pos[0],a.pos[1]]}})},oa.holdEvent=function(a,b){this.type="Hold",this.performee=a,this.performee_type="DL",this.time=Date.now(),this.finger={pos:[b.finger.pos[0],b.finger.pos[1]]}},na.touchEvent=function(a,b,c){this.type="Touch",this.performee=c,this.performee_type="row",this.row=b,this.time=Date.now(),this.fingers=a.fingers.map(function(a){return{pos:[a.pos[0],a.pos[1]]}})},na.tapEvent=function(a,b,c){this.type="Tap",this.performee=c,this.performee_type="row",this.row=b,this.time=Date.now(),this.fingers=a.fingers.map(function(a){return{pos:[a.pos[0],a.pos[1]]}})},na.dragEvent=function(a,b,c){this.type="Drag",this.performee=c,this.performee_type="row",this.row=b,this.time=Date.now(),this.x=a.x,this.dx=a.dx,this.y=a.y,this.dy=a.dy,this.finger={dx:a.finger.dx,dy:a.finger.dy,dist_x:a.finger.dist_x,dist_y:a.finger.dist_y},this.x_offset=Math.abs(a.finger.dist_x),this.y_offset=Math.abs(a.finger.dist_y),this.fingers=a.fingers.map(function(a){return{pos:[a.pos[0],a.pos[1]]}})},na.releaseEvent=function(a,b,c){this.type="Dragend",this.performee=c,this.performee_type="row",this.row=b,this.time=Date.now(),this.fingers=a.fingers.map(function(a){return{pos:[a.pos[0],a.pos[1]]}})},na.cloneEvent=function(a,b){this.type="Clone",this.performee=a,this.performee_type="row",this.eq=b.eq,this.pos=b.pos,this.dl_id=b.id},na.stateEvent=function(a){this.type="packState",this.performee=a.id,this.performee_type="row",this.time=Date.now(),this.packState=a.rows.map(function(a){return!!a.hidden})},oa.prototype.getDragHandler=function(a){return a.interaction_handler.getHandlerByClass(DragHandler)},oa.prototype.handleFactoringGesture=function(a,b,c){if(a.idx===this.rows.length-1){this.curr_drag_handler||(this.curr_drag_handler=this.getDragHandler(a.view));var d=this.curr_drag_handler;if(!a.abs_pos){a.abs_pos={x:a.pos[0]+this.pos[0],y:a.pos[1]+this.pos[1]};var e=this.getFactoringActions(a.model.children[0]);e.length>0&&d.start(a.abs_pos,a.model.children,{reselect_nodes:!1,actions:e,move_nodes:!1})}a.abs_pos.x+=b,a.abs_pos.y+=c,d.isActive()&&d.update({dx:b,dy:c}),this.pos[0]+=b,this.pos[1]+=c,this.hovering||(this.pos=this.keepInContainer(this.pos,a.view.getBBox())),this.svgg.attr("transform","translate("+this.pos+")")}},oa.prototype.getFactoringActions=function(a){var b=function(a){return a.is_group("sum")&&a.parent.is_group("brackets")&&!a.fixed},c=[],d=this;this.getAllDLs().forEach(function(a){if(a!==d){var e=a.getLastRow();c.push({sums:e.model.filter(b),row:e,dl:a})}});for(var e=[],f=0;f<c.length;f++)for(var g=c[f],h=0;h<g.sums.length;h++){var i=g.sums[h];if(TriggerFactoringAction.match(i,a)){var j,k=TriggerFactoringAction.createBoundAction(g.row.model,{dl:g.dl,view:g.row.view,sum:i,callback:this.factoringWasTriggered.bind(this)});j=g.dl.coordinator&&this.coordinator?this.coordinator.getOffset(this,g.dl):[0,0],k.settings||(k.settings={}),k.settings.offset={x:g.dl.pos[0]+g.row.pos[0]-this.pos[0]-this.getLastRow().pos[0]+j[0],y:g.dl.pos[1]+g.row.pos[1]-this.pos[1]-this.getLastRow().pos[1]+j[1]},e.push(k)}}return e},oa.prototype.factoringWasTriggered=function(a,b,c){var d=this.getDragHandler(a),e=vb(b,this.getLastModel().children[0]);d.start(zb(c),e,{reselect_nodes:!1}),this.curr_drag_handler=d,this.curr_target_model=c.getLastModel(),this.svgg.attr("display","none")},vb=function(a,b){var c;c=xb(a,b),c=yb(c,a);for(var d=[],e=0;e<c.length;e++)if(0===c[e].length)return!1;for(var e=0;e<c.length;e++)c[e]&&d.push(c[e][c[e].length-1]);for(var e=0;e<d.length;e++)Array.isArray(d[e])||"add"===d[e].parent.value||"sub"===d[e].parent.value||(d[e]=d[e].parent);if(d.length!==a.children.length)return!1;for(var f=[],e=0;e<d.length;e++)if(Array.isArray(d[e]))for(var g=0;g<d[e].length;g++)f.push(d[e][g]);else f.push(d[e]);return f},wb=function(a,b){var c=[];return a.for_each(function(a){var d=a.to_ascii();if("*"===d.slice(0,1)&&(d=d.substr(1)),a.hidden||d!==b){for(var e=[a];d.length<b.length&&a.commutative&&a.rs;)a=a.rs,d+=a.to_ascii(),e.push(a);d===b&&c.push(e)}else c.push(a)}),c},xb=function(a,b){for(var c=[],d=0;d<a.children.length;d++){var e=a.children[d],f=e.children[1];c.push(wb(f,b.to_ascii()))}return c},yb=function(a,b){for(var c=function(a){return a.parent&&("add"===a.parent.value||"sub"===a.parent.value)&&a.parent.parent&&a.parent.parent==b},d=function(a){return a.parent&&"mul"===a.parent.value&&a.parent.parent&&a.parent.parent.is_group("product")&&a.parent.parent.parent&&a.parent.parent.parent.parent&&a.parent.parent.parent.parent==b},e=function(a){return"mul"===a.value&&a.parent&&a.parent.is_group("product")&&a.parent.parent&&a.parent.parent.parent&&a.parent.parent.parent==b},f=function(a){var b=!0;if(!Array.isArray(a))return c(a)||d(a);for(var f=0;f<a.length;f++)e(a[f])||(b=!1);return b},g=0;g<a.length;g++)a[g]=a[g].filter(f);return a},zb=function(a){var b=a.getLastRow(),c=a.getLastView(),d=c.getBBox(),e=a.pos,f=b.pos,g=[d.x,d.y],h=[e[0]+f[0]+g[0],e[1]+f[1]+g[1]];return h},Ab=function(a,b,c){this.x=a,this.y=b,this.r=c},Ab.prototype.copy=function(){return new Ab(this.x,this.y,this.r)},Ab.prototype.centroid=function(){return new Bb(this.x,this.y)},Ab.prototype.area=function(){return Math.PI*this.r*this.r},Ab.prototype.move_to_origin=function(){this.x=0,this.y=0},Ab.prototype.bounding_box=function(){return{x:this.x-this.r,y:this.y-this.r,width:2*this.r,height:2*this.r}},Ab.prototype.intersect_with_ray=function(a,b){var c=a.sub(this),d=b.x*b.x+b.y*b.y,e=2*c.x*b.x+2*c.y*b.y,f=c.x*c.x+c.y*c.y-this.r*this.r,g=e*e-4*d*f;if(g<0)return[];if(g<Bb.EPS){var h=-e/(2*d);return h<0?[]:[new Bb(a).add(b.scale(h))]}var i=[],j=(-e-Math.sqrt(g))/(2*d),k=(-e+Math.sqrt(g))/(2*d);if(j>k){var l=j;j=k,k=l}return j>=0&&i.push(new Bb(a).add(b.scale(j))),k>=0&&i.push(new Bb(a).add(b.scale(k))),i},Ab.fromSVGCircle=function(a){var b=a.attributes;return b.cx&&b.cy&&b.r?new Ab(Number(b.cx.value),Number(b.cy.value),Number(b.r.value)):null},Ab.fromSVGPath=function(a){"undefined"==typeof exclude_ellipse&&(exclude_ellipse=!0);var b,c,d,e,f=a.lookupNamespaceURI("sodipodi"),g=function(b){var c=a.getAttributeNS(f,b);return null!==c?c:a.getAttribute("sodipodi:"+b)};if("arc"==g("type")&&(b=g("cx"))&&(c=g("cy"))&&(d=g("rx"))&&(e=g("ry"))){var h=g("start"),i=g("end");if(h&&i){var j=Number(i)-Number(h);if(Math.abs(Math.abs(j)-2*Math.PI)>.01&&!(j<0&&j>-.01))return console.log("Warning: this is a circle segment! ||start-end|-2*PI| =",j),null}return d=Number(d),e=Number(e),b=Number(b),c=Number(c),Math.abs(d/e-1)>.05?(console.log("Warning: This is an ellipse! rx",d,"ry",e),null):new Ab(b,c,(d+e)/2)}return null},Ab.prototype.renderInSvg=function(a,b){var c=a.createElementNS("http://www.w3.org/2000/svg","circle");return c.setAttribute("cx",this.x),c.setAttribute("cy",this.y),c.setAttribute("r",this.r),c.style.setProperty("stroke","red"),c.style.setProperty("stroke-width",".5px"),c.style.setProperty("fill","none"),b.appendChild(c),c},Ab.prototype.renderOnCanvas=function(a,b,c){a.beginPath(),a.arc(this.x,this.y,this.r,0,2*Math.PI,!0),b&&a.stroke(),c&&a.fill()},Bb=function(a,b){0==arguments.length?(this.x=0,this.y=0):1==arguments.length?(this.x=a.x,this.y=a.y):(this.x=a,this.y=b)},Bb.norm_angle=function(a){return a%=2*Math.PI,a<-Math.PI?a+=2*Math.PI:a>Math.PI&&(a-=2*Math.PI),a},Bb.prototype.rotate=function(a){return new Bb(this.x*Math.cos(a)-this.y*Math.sin(a),this.y*Math.cos(a)+this.x*Math.sin(a))},Bb.prototype.Rotate=function(a){return this.Set(this.x*Math.cos(a)-this.y*Math.sin(a),this.y*Math.cos(a)+this.x*Math.sin(a))},Bb.prototype.Set=function(a,b){return 1==arguments.length?(this.x=a.x,this.y=a.y):(this.x=a,this.y=b),this},Bb.prototype.dist=function(a){var b=this.x-a.x,c=this.y-a.y;return Math.sqrt(b*b+c*c)},Bb.prototype.dist2=function(a){var b=this.x-a.x,c=this.y-a.y;return b*b+c*c},Bb.len=function(a,b){return Math.sqrt(a*a+b*b)},Bb.prototype.len=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},Bb.prototype.len2=function(){return this.x*this.x+this.y*this.y},Bb.prototype.add=function(a){return new Bb(this.x+a.x,this.y+a.y)},Bb.prototype.Add=function(a){return this.x+=a.x,this.y+=a.y,this},Bb.prototype.sub=function(a){return new Bb(this.x-a.x,this.y-a.y)},Bb.prototype.Sub=function(a){return this.x-=a.x,this.y-=a.y,this},Bb.prototype.mul=function(a){return this.x*a.x+this.y*a.y},Bb.prototype.cross=function(a){return this.x*a.y-this.y*a.x},Bb.prototype.equals=function(a,b){return Math.abs(this.x-a.x)<=b&&Math.abs(this.y-a.y)<=b},Bb.prototype.normalize=function(){var a=1/this.len();return new Bb(this.x*a,this.y*a)},Bb.prototype.Normalize=function(){var a=1/this.len();return this.x*=a,this.y*=a,this},Bb.prototype.get_perpendicular=function(){return new Bb(-this.y,this.x)},Bb.prototype.scale=function(a){return new Bb(this.x*a,this.y*a)},Bb.prototype.Scale=function(a){return this.x*=a,this.y*=a,this},Bb.prototype.toString=function(){return"("+this.x+","+this.y+")"},Bb.prototype.copy=function(){return new Bb(this.x,this.y)},Bb.EPS=1e-6,Bb.get_closest_point_on_segment=function(a,b,c){var d=b.sub(a),e=d.len();if(e<Bb.EPS)return a;var f=d.mul(c.sub(a))/e;return f<0?a:f>d.len()?b:a.add(d.scale(f/e))},Bb.intersect_ray_with_segment=function(a,b,c,d,e,f){if("undefined"==typeof e)var e=new Bb;if("undefined"==typeof f)var f=Bb.EPS;var g=d.sub(c),h=b.cross(g);if(Math.abs(h)>Bb.EPS){var i=c.sub(a).cross(b)/h;if(i<-f||i-1>f)return!1;var j=c.add(g.scale(i));e.x=j.x,e.y=j.y}else{if(b.len2()<Bb.EPS||g.len2()<Bb.EPS)return!1;var k=a.sub(c).mul(g)/g.mul(g);if(c.add(g.scale(k)).dist(a)>Bb.EPS)return!1;k<-f?(e.x=c.x,e.y=c.y):k-1>f?(e.x=d.x,e.y=d.y):(e.x=a.x,e.y=a.y)}return e.sub(a).mul(b)>=0},Bb.intersect_inner_ray_with_rect=function(a,b,c){var d,e=new Bb(c.x,c.y),f=new Bb(c.x+c.width,c.y),g=new Bb(c.x,c.y+c.height),h=new Bb(c.x+c.width,c.y+c.height),i=c.r,j=new Bb;if(Bb.intersect_ray_with_segment(a,b,e,g,j))d=new Bb(0,1);else if(Bb.intersect_ray_with_segment(a,b,f,h,j))d=new Bb(0,-1);else if(Bb.intersect_ray_with_segment(a,b,e,f,j))d=new Bb(-1,0);else{if(!Bb.intersect_ray_with_segment(a,b,g,h,j))return null;d=new Bb(1,0)}if(0===i)return{point:j,tangent:d};var k;return j.x<e.x+i&&j.y<e.y+i?(k=new Ab(e.x+i,e.y+i,i).intersect_with_ray(a,b),j=k[1]||k[0]||j,d=j.sub(new Bb(e.x+i,e.y+i)).get_perpendicular().scale(-1).Normalize()):j.x>f.x-i&&j.y<f.y+i?(k=new Ab(f.x-i,f.y+i,i).intersect_with_ray(a,b),j=k[1]||k[0]||j,d=j.sub(new Bb(f.x-i,f.y+i)).get_perpendicular().scale(-1).Normalize()):j.x<g.x+i&&j.y>g.y-i?(k=new Ab(g.x+i,g.y-i,i).intersect_with_ray(a,b),j=k[1]||k[0]||j,d=j.sub(new Bb(g.x+i,g.y-i)).get_perpendicular().scale(-1).Normalize()):j.x>h.x-i&&j.y>h.y-i&&(k=new Ab(h.x-i,h.y-i,i).intersect_with_ray(a,b),j=k[1]||k[0]||j,d=j.sub(new Bb(h.x-i,h.y-i)).get_perpendicular().scale(-1).Normalize()),{point:j,tangent:d}},oa.prototype.draw_mappings_for_nodes=function(a){if(this.hideAllNodeMappings(),0!==a.length){var b=!a.some(function(a){return a.is_group("sym")});this.draw_forward_mappings(a,b),this.draw_backward_mappings(a,b);var c=this.getRowByModel(a[0].get_root());this.draw_node_backgrounds(a,c,!0)}},oa.prototype.get_combined_action=function(a,b){if(a.idx+1===b.idx)return b.action;for(var c=[],d=a.idx+1;d<=b.idx;d++)c.push(this.rows[d].action);return p.createComposedAction(c)},oa.prototype.get_next_visible_row=function(a){for(var b=a.idx+1;b<this.rows.length;b++)if(!this.rows[b].hidden)return this.rows[b];return null},oa.prototype.get_prev_visible_row=function(a){for(var b=a.idx-1;b>=0;b--)if(!this.rows[b].hidden)return this.rows[b];return null},oa.prototype.draw_forward_mappings=function(a,b){if(0!==a.length){var c=this.getRowByModel(a[0].get_root()),d=this.get_next_visible_row(c);if(d){var e=this.get_combined_action(c,d),f=[];a.forEach(function(a){var c=e.mapNodes([a]);0===c.length?f.push({source_node:a}):c.forEach(function(c){b&&c.is_group("sym")||c.has_children()||f.push({source_node:a,target_node:c})}),a.was_removed=0===c.length}),this.draw_mapping_lines(f,c,d);var g=e.mapNodes(a);b&&(g=g.filter(function(a){return!a.is_group("sym")})),this.draw_forward_mappings(g,b),this.draw_node_backgrounds(g,d)}}},oa.prototype.draw_backward_mappings=function(a,b){if(0!==a.length){var c=this.getRowByModel(a[0].get_root()),d=this.get_prev_visible_row(c);if(d){var e=this.get_combined_action(d,c);a.forEach(function(a){a.was_created=!0});var f=[],g=[];d.model.children[0].for_each(function(c){if(!(c.has_children()||b&&c.is_group("sym"))){var d=e.mapNodes([c]),h=!1;d.forEach(function(b){a.indexOf(b)!==-1&&(f.push({source_node:c,target_node:b}),h=!0,b.was_created=!1)}),h&&g.push(c)}}),this.draw_mapping_lines(f,d,c),this.draw_backward_mappings(g,b),this.draw_node_backgrounds(g,d)}}},oa.prototype.draw_node_backgrounds=function(a,b,c){b.view.main.selectAll(".selector").attr({rx:this.options.mappings_rect_radius,ry:this.options.mappings_rect_radius}).style("fill",this.options.mappings_color).style("stroke",c?this.options.mappings_active_stroke:"none").attr("visibility",function(b){return a.indexOf(b)===-1?"hidden":null})},oa.prototype.hideAllNodeMappings=function(){this.rows.forEach(function(a){a.view&&(a.view.main.selectAll(".selector").attr("visibility","hidden"),a.view.main.selectAll(".mapping_line").attr("visibility","hidden"))})},oa.prototype.draw_mapping_lines=function(a,b,c){var d=c.pos[0]-b.pos[0],e=c.pos[1]-b.pos[1];b.view.main.selectAll(".mapping_line");var f=this.options.mappings_color,g=b.view.main.selectAll(".mapping_line").data(a);g.enter().insert("path",".math"),g.attr("class","mapping_line").call(this.update_organic_path.bind(this),d,e).style("fill",f).style("stroke",f).attr("visibility",function(a){return a.source_node&&a.target_node?a.source_node.hidden||a.target_node.hidden?"hidden":null:"hidden"}),g.exit().remove()},oa.prototype.update_organic_path=function(a,b,c){function d(a){return a.x.toFixed(4)+" "+a.y.toFixed(4)+" "}var e=this.options.mappings_rect_radius,f=this;a.attr("d",function(a){if(!a.target_node||!a.source_node)return"M 0,0";var g=a.source_node.sel_box,h=a.source_node,i=a.target_node.sel_box,j=a.target_node,k={x:g.x+h.x,y:g.y+h.y,width:g.width,height:g.height,r:e},l={x:i.x+j.x+b,y:i.y+j.y+c,width:i.width,height:i.height,r:e},m=f.createConnectorPath(k,l),n=f.createConnectorPath(l,k);return m&&n?"M "+d(m.base1)+"C "+d(m.base1_control)+d(m.joint1_control1)+d(m.joint1)+"L"+d(n.joint2)+"C "+d(n.joint2_control1)+d(n.base2_control)+d(n.base2)+"L "+d(n.base1)+"C "+d(n.base1_control)+d(n.joint1_control1)+d(n.joint1)+"L "+d(m.joint2)+"C "+d(m.joint2_control1)+d(m.base2_control)+d(m.base2)+"Z":"M 0 0";
})},oa.prototype.createConnectorPath=function(a,b){var c=Math.min(this.options.mappings_joint_width,.9*a.width,.9*b.width,.9*a.height,.9*b.height),d=Math.min(c/2,this.options.mappings_line_thickness),e=this.options.mappings_joint_length,f=new Bb(a.x+a.width/2,a.y+a.height/2),g=new Bb(b.x+b.width/2,b.y+b.height/2),h=g.Sub(f),i=[],j=[];if(gb.overlaps(a,b))return null;var k=h.get_perpendicular();k.Normalize().Scale(c/2);var l=Bb.intersect_inner_ray_with_rect(f.add(k),h,a);if(!l)return null;i.push(l.point);var m=l.point.add(l.tangent.scale(c/3));j.push({from:l.point,to:m});var n=Bb.intersect_inner_ray_with_rect(f.sub(k),h,a);if(!n)return null;i.push(n.point);var o=n.point.add(n.tangent.scale(-c/3));j.push({from:n.point,to:o}),k.Normalize().Scale(d/2);var p=Bb.intersect_inner_ray_with_rect(f.add(k),h,a);if(!p)return null;var q=p.point.add(h.normalize().Scale(e)),r=Bb.intersect_inner_ray_with_rect(f.sub(k),h,a);if(!r)return null;var s=r.point.add(h.normalize().Scale(e));i.push(q,s);var t=q.sub(h.normalize().Scale(e/2)),u=q.sub(h.normalize().Scale(-e/2)),v=s.sub(h.normalize().Scale(e/2)),w=s.sub(h.normalize().Scale(-e/2));return j.push({from:q,to:t},{from:q,to:u},{from:s,to:v},{from:s,to:w}),{pts:i,lines:j,base1:l.point,base2:n.point,joint1:q,joint2:s,joint1_control1:t,joint1_control2:u,joint2_control1:v,joint2_control2:w,base1_control:m,base2_control:o}},Wa.ui=Wa.ui||{},Wa.ui.TextBox=function(){var a=function(a,b,c,d){ma.call(this,a,b,c),this.type="textbox",this.events=Wa.extend(this.events,d3.dispatch("font_size","text")),this.initTextBoxOptions(c),this.initTextBoxProperties(),this.initTextBox(),this.initPosition(),d&&d(this)};return Wa.inherit(ma,a),Wa.ui.TextBoxClass=a,a.defaultOptions={default_text:"Edit this text.",min_size:{width:150,height:50},size:{width:200,height:200},padding:20,text_align:"left",resizable:{x:!0,y:!1},uneditable:!1,closable:!1,font_size:20,min_font_size:10,max_font_size:60,use_toolbar:!0,static_bg:!1,select_text_on_create:!0},a.prototype.initTextBoxOptions=function(b){var b=b||{},c=Wa.deepCopy(a.defaultOptions),d=Wa.object.extendExisting(c,b);b.text&&(d.text=b.text),this.options=Wa.extend(this.options,d),this.options.static_bg&&(this.options.bg_edit_style=this.options.bg_arrange_style,this.options.bg_edit_active_style=this.options.bg_arrange_style)},a.prototype.initTextBoxProperties=function(){this.uneditable=this.options.uneditable,this.closable=this.options.closable,this.font_size=this.options.font_size,this.options.text&&(this.text=this.options.text),this.size=this.options.size,this.element_div.style({height:this.size.height+"px",width:this.size.width+"px"})},a.prototype.initTextBox=function(){this.uneditable||this.initToolbar(),this.initTextElement(),this.closable&&this.initCloseButton(),this.update(),this.canvas_model.setActive(this,!0),this.uneditable||("edit"===this.mode&&this.options.select_text_on_create&&this.selectAllText(),this.switchToolbarState("edit"===this.mode&&this.active))},a.prototype.initToolbar=function(){function a(a,b){var d=a.append("button").attr("id",function(a){return a.label}).attr({type:"button",class:"btn btn-default"}).classed("input-xs",!0);d.on("click",b.bind(c)),d.append("span").text(function(a){return a.label}).style("color","#555")}this.toolbar_on_style={display:"inline-block",position:"fixed","margin-top":"-20px",width:"100%"},this.toolbar_off_style={display:"none"},this.toolFadeoutDelay=500,this.font_btns=[{type:"push",label:"-",icon:"glyphicon glyphicon-text-size",flip:"y"},{type:"push",label:"+",icon:"glyphicon glyphicon-text-size"}],this.tools=this.element_div.append("div").attr({class:"btn-toolbar",role:"toolbar"}).style(this.options.use_toolbar?this.toolbar_on_style:this.toolbar_off_style);var b=this.tools.append("div").attr({class:"btn-group"}).classed("pull-right",!0).selectAll("button").data(this.font_btns),c=this;b.enter().call(a,this.onButton)},a.prototype.initTextElement=function(){this.text_element=this.element_div.append("div").classed("gm-no-focus-outline",!0).style({padding:this.options.padding+"px","font-size":this.font_size+"px","text-align":this.options.text_align}).property("innerHTML",this.text||this.options.default_text).attr("contenteditable",this.uneditable?"contenteditable":"").on("input",function(){var a=this.text.slice();this.update(),this.emitEvent("text",{element:{type:"textbox",id:this.id,old_state:a,new_state:this.text}})}.bind(this))},a.prototype.initCloseButton=function(){var a=2.5*this.options.font_size,b=(this.size.width-a)/2;this.button=this.element_div.append("svg").style({position:"absolute",left:b,width:a+2+"px",height:a+2+"px"}),this.button_grp=this.button.append("g"),this.button_grp.append("circle").attr({r:a/2,cx:a/2+1,cy:a/2+1}).style({stroke:"#ddd","stroke-width":1,fill:"white"}),this.button_grp.append("text").text("OK").attr({x:"50%",y:"50%","text-anchor":"middle","alignment-baseline":"central"}).style({fill:"#ddd","font-size":this.options.font_size,"pointer-events":"none"}),this.button.on("click",this.fade.bind(this,null))},a.prototype.selectAllText=function(){if(window.getSelection){var a=window.getSelection();a.removeAllRanges();var b=document.createRange();b.selectNodeContents(this.text_element.node()),a.addRange(b)}else if(document.selection){var c=document.body.createTextRange();c.moveToElementText(this.text_element.node()),c.select()}},a.prototype.setSubTypeActive=function(){this.switchToolbarState(this.active)},a.prototype.switchToolbarState=function(a,b){if(this.tools&&this.options.use_toolbar)if(b=!0,a&&this.toolFadeoutTimer)clearTimeout(this.toolFadeoutTimer),this.toolFadeoutTimer=null;else if(a)this.turnOnToolbar();else{if(this.dragging)return;b?this.turnOffToolbar():this.toolFadeoutTimer=setTimeout(function(){this.turnOffToolbar()}.bind(this),this.toolFadeoutDelay)}},a.prototype.turnOnToolbar=function(){this.tools.style(this.toolbar_on_style)},a.prototype.turnOffToolbar=function(){this.tools.style(this.toolbar_off_style),this.toolFadeoutTimer=null},a.prototype.onButton=function(a){"+"===a.label?this.increaseTextSize():"-"===a.label&&this.decreaseTextSize()},a.prototype.changeFontSize=function(a){var b=this.font_size;this.font_size=Math.max(this.options.min_font_size,Math.min(a,this.options.max_font_size)),this.font_size!==b&&(this.text_element.style("font-size",this.font_size+"px"),this.emitEvent("font_size",{element:{type:"textbox",id:this.id,old_state:b,new_state:this.font_size}}),this.update())},a.prototype.increaseTextSize=function(){var a;a=this.font_size<12?1:this.font_size<28?2:this.font_size<36?8:12,this.changeFontSize(this.font_size+a)},a.prototype.decreaseTextSize=function(){var a;a=this.font_size<=12?1:this.font_size<=28?2:this.font_size<=36?8:12,this.changeFontSize(this.font_size-a)},a.prototype.setText=function(a){this.text_element.node().innerHTML=a,this.update()},a.prototype.update=function(){this.text=this.text_element.node().innerHTML,this.size.height=this.text_element.node().offsetHeight,this.closable&&(this.size.height+=3*this.options.font_size),this.element_div.style({height:this.size.height+"px",width:this.size.width+"px"}),this.closable&&this.button.attr("transform","translate("+[this.size.width/2,this.size.height-3*this.options.font_size]+")")},a.prototype.subTypeResize=function(){this.update()},a.prototype.unselect=function(){window.getSelection().removeAllRanges(),this.text_element.node().blur()},a.prototype.fade=function(a){var b=750;this.element_div.transition().duration(b).style("opacity",0).each("end",function(){this.canvas_model.removeElement(this),a&&a()}.bind(this))},a.prototype.cancelFade=function(){this.element_group.transition().duration(0).style("opacity",1)},a.prototype.toJSON=function(){var a={id:this.id,type:"TextBox",pos:this.pos,size:this.size,uneditable:this.uneditable,closable:this.closable,font_size:this.font_size};return this.text!==this.options.default_text&&(a.text=this.text),a},a}(),Wa.ui=Wa.ui||{},Wa.ui.Multichoice=function(){var a=function(a,b,c,d){ma.call(this,a,b,c),this.type="multichoice",this.events=Wa.extend(this.events,d3.dispatch("select")),this.logger=null,this.choice_els=null,this.selected={},this.initOptions(c),this.init()};return Wa.inherit(ma,a),a.defaultOptions={choices:["A","B","C"],multichoice:!1,alignment:"horizontal",font_size:20,btn_radius:20,btn_margin:20,resizable:{x:!1,y:!1}},a.prototype.initOptions=function(b){var c=Wa.deepCopy(a.defaultOptions),b=Wa.object.extendExisting(c,b||{});this.options=Wa.extend(this.options,b)},a.prototype.init=function(){var a=this;this.options.choices.forEach(function(b){a.selected[b]=!1});var b=this.options.btn_radius,c=this.options.btn_margin,d=0,e="vertical"==a.options.alignment,f=this.element_div.append("div").style("position","absolute").style("left","0px").style("top","0px");this.choice_els=f.selectAll(".choice").data(this.options.choices),this.choice_els.enter().append("div").classed("choice",!0).style("position","absolute").each(function(f,g){var h=d3.select(this),i=[(2*b+c)*g+b+c,b+c];e?i.reverse():i[1]+=c+a.options.font_size,h.style("left",i[0]+"px").style("top",i[1]+"px");var j=h.append("p").style("position","absolute").style("margin","0px").style("font-size",a.options.font_size+"px").style("text-align",e?"left":"center").style("white-space","nowrap").style("pointer-events","none").html(f);setTimeout(function(){var a=$(j.node()).innerWidth(),f=$(j.node()).innerHeight();j.style("left",(e?b+c:-a/2)+"px").style("top",(e?-b:-(b+c+f/1.2))+"px"),e&&(j.style("height",2*b+"px").style("line-height",2*b+"px"),a>d&&(d=a))},100);h.append("div").style("position","absolute").style("left",-b+"px").style("top",-b+"px").style("width",2*b+"px").style("height",2*b+"px").style("background-color","white").style("border","2px solid gainsboro").style("border-radius",(a.options.multichoice?0:50)+"%").on("click",function(){if(!a.options.multichoice){if(a.selected[f])return;a.choice_els.each(function(b){b!=f&&(d3.select(this).select(".selected").transition().duration(200).style("background-color","white"),a.selected[b]=!1)})}a.selected[f]=!a.selected[f],h.select(".selected").transition().duration(200).style("background-color",a.selected[f]?"#84bd43":"white"),a.events.select(f),a.logger&&a.logger.logCustomInteraction("choice",{choice:f,value:a.selected[f]})}),h.append("div").classed("selected",!0).style("position","absolute").style("left",-b+4+"px").style("top",-b+4+"px").style("width",2*b-8+"px").style("height",2*b-8+"px").style("background-color","white").style("border-radius",(a.options.multichoice?0:50)+"%").style("pointer-events","none")}),setTimeout(function(){var g=(2*b+c)*a.options.choices.length+c,h=2*b+3*c;e?(g+=h,h=g-h,g=g-h+d):h+=a.options.font_size,f.style("width",g+"px").style("height",h+"px"),a.resizeElement({width:g,height:h})},100)},a.prototype.setLogger=function(a){this.logger=a},a}(),Wa.ui=Wa.ui||{},Wa.ui.GraphEq=function(){var a=function(a,b,c){ma.call(this,a,b,c),this.vals=Wa.object.extendExisting({a:"A",b:"B",c:"C"},c.vals||{}),this.form=0,this.views=[],this.align=null,this.evts=null,this.trans={},this.gestures=[],this.dx=null,this.init()};return Wa.inherit(ma,a),a.prototype.init=function(){var a=this,b=this.element_div.append("svg").style("position","absolute").style("left","0px").style("top","0px").style("overflow","visible"),c=b.node().getBoundingClientRect(),d=b.append("g"),e=this.vals.a+"x+"+this.vals.b+"y="+this.vals.c,f=new Wa.AlgebraModel(e),g={h_align:"left",v_align:"top"};this.views.push(new Wa.AlgebraView(f,d,g)),this.views[0].init(function(){var e="y=-{"+a.vals.a+"/"+a.vals.b+"}x+"+a.vals.c+"/"+a.vals.b,f=new Wa.AlgebraModel(e);a.views.push(new Wa.AlgebraView(f,d,g)),a.views[1].init(function(){function e(a){var b=Wa.Tree.get_child([0,1],a.model),c=d3.select("#"+b.id);return d3.transform(c.attr("transform")).translate.slice()}function f(a,b){var c=Wa.Tree.get_child(a,b.model);return d3.select("#"+c.id)}function g(a,b){function d(a){var b=a.select("rect").node(),d=b.getBoundingClientRect(),e={left:d.left-c.left,top:d.top-c.top,width:d.width,height:d.height};return e.right=e.left+e.width,e.bottom=e.top+e.height,{el:a,box:e,pos:d3.transform(a.attr("transform")).translate,sel:!1}}return[d(a),d(b)]}function h(b){var c=a.gestures[a.form].source[0],d=a.gestures[a.form].target[0],e=(b-c)/(d-c);return e<0&&(e=0),e>1&&(e=1),e}function i(a,b,c){var d=[b[0]+(c[0]-b[0])/2,b[1]+4*(c[1]-b[1])],e=[];b[1]==d[1]&&(d[1]-=100);for(var f=0;f<2;f++)e.push(Math.pow(1-a,2)*b[f]+2*(1-a)*a*d[f]+Math.pow(a,2)*c[f]);return e}function j(b){Object.keys(a.trans).forEach(function(c){if("y"!=c){var d=a.trans[c][a.form],e=a.trans[c][1-a.form],f=d.pos.slice(),g=e.pos.slice();g[0]+=0==a.form?a.align[0]:-a.align[0],g[1]+=0==a.form?a.align[1]:-a.align[1];var h=0==a.form?i(b,f,g):i(1-b,g,f),j=1+b*(e.box.width/d.box.width-1);d.el.attr("transform","translate("+h.join(",")+") scale("+j+")")}});var c=[[0,2,0,1,0,1,0],[0,2,0,1,0,1,1,1],[0,2,0,1,1,0],[0,2,1,0],[0,2,1,1,1]];c.forEach(function(c){var d=Wa.Tree.get_child(c,a.views[1].model),e=d3.select("#"+d.id);e.style("opacity",0==a.form?b:1-b)});var d=Wa.Tree.get_child([0,0,1,0],a.views[0].model),e=d3.select("#"+d.id);e.style("opacity",0==a.form?1-b:b)}var k=e(a.views[0]),l=e(a.views[1]);a.align=[k[0]-l[0],k[1]-l[1]],a.views[1].main.attr("transform","translate("+a.align.join(",")+")");var m=d.node().getBBox(),n=m.width+60,o=m.height;a.resizeElement({width:n,height:o}),b.attr("width",n+"px").attr("height",o+"px"),d.attr("transform","translate("+[-m.x,-m.y].join(",")+")"),a.evts=b.append("rect").attr("x",0).attr("y",0).attr("width",n).attr("height",o).attr("fill","none");var p=a.views[0],q=a.views[1],r=[[0,0,0,1,0,1],[0,2,0,1,0,1,1,0,1]];a.vals.a<0&&(a.trans.a_sign=g(f(r[0].concat(0),p),f(r[1].concat(0),q)),r.forEach(function(a){return a.push(1)})),a.trans.a=g(f(r[0],p),f(r[1],q)),a.trans.x=g(f([0,0,0,1,1,1],p),f([0,2,0,1,1,1],q));var s=[[0,0,1,1,0,1],[0,2,0,1,0,1,1,2,1],[0,2,1,1,2,1]];if(a.vals.b<0){var t=f(s[0].concat(0),p),u=d3.select(p.main.node().appendChild(t.node().cloneNode(!0)));u.attr("id",t.attr("id")+"_clone").select("text").style("opacity",1),a.trans.b1_sign=g(t,f(s[1].concat(0),q)),a.trans.b2_sign=g(u,f(s[2].concat(0),q)),s.forEach(function(a){return a.push(1)})}var v=f(s[0],p),w=d3.select(p.main.node().appendChild(v.node().cloneNode(!0)));w.attr("id",v.attr("id")+"_clone").select("text").style("opacity",1),a.trans.b1=g(v,f(s[1],q)),a.trans.b2=g(w,f(s[2],q)),a.trans.y=g(f([0,0,1,1,1,1],p),f([0,0],q));var x=[[0,2],[0,2,1,1,0,1]];a.vals.c<0&&(a.trans.c_sign=g(f(x[0].concat(0),p),f(x[1].concat(0),q)),x.forEach(function(a){return a.push(1)})),a.trans.c=g(f(x[0],p),f(x[1],q));var y=a.trans.a[0].box,z=a.trans.c[0].box;a.gestures.push({source:[y.left+y.width,y.top+y.height/2],target:[z.left+z.width,z.top+z.height/2]});var A=a.trans.x[1].box,B=a.trans.y[1].box;a.gestures.push({source:[A.left,A.top+A.height/2],target:[B.left,B.top+B.height/2]}),a.views[1].main.selectAll(".math").style("opacity",0);var C=Wa.mtouch_events().frame(a.evts.node()).on("touch",function(){d3.event.fingers.forEach(function(b){var c=b.pos[0],d=b.pos[1],e=b.id;["a","x","b1","b2","y"].forEach(function(b){var f=a.trans[b][a.form],g=f.box;c>g.left&&c<g.right&&d>g.top&&d<g.bottom&&(f.sel=e)})})}).on("drag",function(){d3.event.fingers.forEach(function(b){var c=b.id,d=[];if(d=0==a.form?[a.trans.a[0].sel,a.trans.x[0].sel]:[a.trans.a[1].sel,a.trans.b1[1].sel,a.trans.x[1].sel],d.indexOf(c)>-1){a.dx||(a.dx=a.gestures[a.form].source[0]),a.dx+=b.dx;var e=h(a.dx);j(e)}})}).on("release",function(){if(a.dx){var b=d3.event.finger,c=b.id;a.dx+=b.dx;var d=h(a.dx);["a","x","b1","b2","y"].forEach(function(b){var e=a.trans[b][a.form];if(e.sel==c){var f=setInterval(function(){d>.5?d+=.01:d-=.01,d>1&&(d=1,clearInterval(f),a.dx=null),d<0&&(d=0,clearInterval(f),a.dx=null),j(d),1==d&&(a.form=1-a.form,a.views[0].main.selectAll(".math").style("opacity",0==a.form?1:0),a.views[1].main.selectAll(".math").style("opacity",0==a.form?0:1),Object.keys(a.trans).forEach(function(b){var c=a.trans[b][1-a.form],d=c.pos.slice();c.el.attr("transform","translate("+d.join(",")+") scale(1)")}))},2);e.sel=!1}})}});a.evts.call(C)})})},a}(),Wa.ui=Wa.ui||{},Wa.ui.Table=function(){var a=function(a,b,c,d){c=Wa.object.merged(Wa.ui.GeoGebraCanvasElement.defaultOptions,c),ma.call(this,a,b,c),this.type="table",this.table_el=null,this.columns_row=null,this.columns_el=null,this.column_width=80,this.column_labels=c.column_labels||["x","y"],this.inputs_row=null,this.inputs_el=null,this.edit_el=null,this.remove_el=null,this.rows=[],this.rows_el=null,this.row_height=40,this.active_row=null,this.active_x=null,this.active_y=null,this.sel_y0=null,this.sel_y1=null,this.selected=null,this.dx_el=null,this.dy_el=null,this.slope_el=null,this.keyboard=null,this.target_row=null,this.target_col=null,this.graph=null,this.show=!1,this.show_el=null,this.slope=null,this.intercept=null,this.x=function(a){return(a-this.intercept)/this.slope},this.y=function(a){return this.slope*a+this.intercept},this.x_pos=0,this.y_pos=this.column_width,this.rows_addable=!0,this.initOptions(c),this.init(d)};return Wa.inherit(ma,a),a.defaultOptions={type:"Table",margin:0,font_size:20,font_weight:"bold",resizable:{x:!1,y:!1},edit_mode_drag_box_width:-20},a.prototype.initOptions=function(b){b=b||{};var c=Wa.deepCopy(a.defaultOptions),d=Wa.object.extendExisting(c,b);this.options=Wa.extend(this.options,d)},a.prototype.getColumn=function(){return this.x_pos<=this.y_pos?"x":"y"},a.prototype.init=function(a){function b(a){var b=c.columns_row[a+"_el"],d=a+"_pos",e=Wa.mtouch_events().frame(b.node()).on("touch",function(){c.setActiveRow(),c.setColIndex(a)}).on("drag",function(){c[d]+=d3.event.dx,c[d]=Math.min(c.column_width,Math.max(0,c[d])),c.dragCol(a)}).on("release",function(){c[d]=c[d]<c.column_width/2?0:c.column_width,c["xy_pos".replace(a,"")]=c.column_width-c[d];var b=250;c.dragCol("x",b),c.dragCol("y",b),setTimeout(function(){c.setColIndex(),c.setInputs(),c.sortRows()},b)});b.call(e)}var c=this;this.table_el=this.element_div.append("div").classed("table",!0).style("box-sizing","content-box").style("border","1px solid silver"),this.columns_el=this.table_el.append("div").classed("table-columns",!0).style("position","relative"),this.columns_row=new Wa.ui.TableRow(this,this.columns_el,this.column_labels[0],this.column_labels[1],0),this.columns_row.row_el.selectAll(".table-cell").style("background-color","gainsboro").style("cursor","move").style("cursor","grabbing"),this.columns_row.row_el.selectAll(".table-input").style("background-color","gainsboro").style("pointer-events","none"),b("x"),b("y"),this.rows_el=this.table_el.append("div").classed("table-rows",!0).style("position","relative");var d=Wa.mtouch_events().frame(this.rows_el.node()).on("touch",function(){c.sel_y0=d3.event.fingers[0].pos0[1],c.sel_y1=c.sel_y0}).on("drag",function(){if(!c.inputs_row.is_selected){if(c.active_row){if(c.active_row.is_editable)return;c.setActiveRow()}if(c.sel_y1+=d3.event.dy,Math.abs(c.sel_y1-c.sel_y0)>10){var a=function(a){var b=a.toString();return b.length>4&&(b=b.substring(0,4)+"..."),b},b=function(a){var b=0;return b+=6*(a.match(/\./g)||[]).length,b+=10*a.match(/[0-9]/g).length};c.selected=[];var d=c.rows[c.rows.length-1],e=null,f=c.rows[0],g=null;c.rows.forEach(function(a){var b=c.row_height*a.idx,h=b+c.row_height;b<=c.sel_y0&&h>=c.sel_y0||b<=c.sel_y1&&h>=c.sel_y1||b>=c.sel_y0&&h<=c.sel_y1||b>=c.sel_y1&&h<=c.sel_y0?(c.selected.push(a),a.idx<=d.idx&&(d=a,e=b),a.idx>=f.idx&&(f=a,g=h),a.setSelected(!0)):a.setSelected(!1)});var h=c.x_pos<c.y_pos,i=g-e,j=f.x-d.x,k=f.y-d.y,l=j/k,m=a(j),n=a(k),o=a(l),p=Math.max(b(m),b(n));c.dx_el.style("left",(h?-30-p:2*c.column_width+10)+"px").style("width",20+b(m)+"px").style("text-align",h?"left":"right"),c.dx_el.select("span").html(m),c.dx_el.select(".bracket.bar").style("left",(h?14+p:4)+"px"),c.dy_el.style("left",(h?2*c.column_width+10:-30-p)+"px").style("width",20+b(n)+"px").style("text-align",h?"right":"left"),c.dy_el.select("span").html(n),c.dy_el.select(".bracket.bar").style("left",(h?4:14+p)+"px"),c.rows_el.selectAll(".range").style("top",e+"px").style("height",i+"px").style("line-height",i+"px").style("display","block"),c.slope_el.select(".top.fraction").html(n),c.slope_el.select(".btm.fraction").html(m),c.slope_el.selectAll(".fraction").style("width",10+p+"px"),c.slope_el.selectAll(".eq").filter(function(a,b){return 1==b}).style("left",90+p+"px"),c.slope_el.select(".val").html(o).style("left",110+p+"px"),c.slope_el.style("display","block"),c.selected.length>0&&c.graph&&(c.show_el.style("display","block"),c.toggleGraphElements(c.show))}}}).on("release",function(){c.sel_y0=null,c.sel_y1=null});this.rows_el.call(d),this.dx_el=this.rows_el.append("div").classed("range",!0),this.dy_el=this.rows_el.append("div").classed("range",!0);var e=this.rows_el.selectAll(".range").style("position","absolute").style("width","30px").style("display","none");e.append("span"),e.append("div").classed("bracket bar",!0).style("top","0px").style("width","2px").style("height","100%");var f=e.selectAll(".bracket.bar");f.append("div").classed("bracket end",!0).style("top","0px"),f.append("div").classed("bracket end",!0).style("bottom","0px"),this.rows_el.selectAll(".bracket").style("position","absolute").style("background-color","black"),this.rows_el.selectAll(".bracket.end").style("left","-4px").style("width","10px").style("height","2px"),this.slope_el=this.table_el.append("div").classed("slope",!0).style("left",2*this.column_width+this.options.margin+30+"px").style("top",this.options.margin+"px").style("text-align","center").style("display","none"),this.slope_el.append("div").classed("slope top formula",!0).html("y<sub>2</sub> - y<sub>1</sub>"),this.slope_el.append("div").classed("slope bar formula",!0),this.slope_el.append("div").classed("slope btm formula",!0).html("x<sub>2</sub> - x<sub>1</sub>"),this.slope_el.append("div").classed("slope eq",!0).style("left","60px"),this.slope_el.append("div").classed("slope top fraction",!0),this.slope_el.append("div").classed("slope bar fraction",!0),this.slope_el.append("div").classed("slope btm fraction",!0),this.slope_el.append("div").classed("slope eq",!0),this.slope_el.append("div").classed("slope val",!0).style("top","14px").style("width","20px"),this.table_el.selectAll(".slope").style("position","absolute"),this.slope_el.selectAll(".top").style("top","0px"),this.slope_el.selectAll(".bar").style("top","28px").style("height","2px").style("background-color","black"),this.slope_el.selectAll(".btm").style("top","28px"),this.slope_el.selectAll(".eq").style("top","14px").style("width","20px").html("="),this.slope_el.selectAll(".formula").style("left","0px").style("width","60px"),this.slope_el.selectAll(".fraction").style("text-align","center").style("left","80px"),this.edit_el=this.rows_el.append("i").classed("table-button",!0).classed("glyphicon glyphicon-pencil",!0).style("position","absolute").style("cursor","pointer").style("background-color","white").style("border","1px solid silver").style("border-radius","5px").style("text-align","center").style("display","none").on("click",function(){c.active_row.setEditable(!0)}),this.remove_el=this.rows_el.append("i").classed("table-button",!0).classed("glyphicon glyphicon-trash",!0).style("position","absolute").style("cursor","pointer").style("background-color","white").style("border","1px solid silver").style("border-radius","5px").style("text-align","center").style("display","none").on("click",function(){c.active_row.row_el.remove();var a=c.active_row.idx;c.rows.splice(a,1),c.rows.forEach(function(b){b.idx>a&&(b.idx--,b.update())}),c.update(),c.setActiveRow(),c.setInputs(),c.sortRows(),1==c.rows.length&&(c.slope=null,c.intercept=null,c.graph&&c.setGraphLine())}),this.inputs_el=this.table_el.append("div").classed("table-inputs",!0).style("position","relative"),this.inputs_row=new Wa.ui.TableRow(this,this.inputs_el,0,this.y(0),0),this.inputs_row.row_el.selectAll(".table-input").style("color","silver"),this.inputs_row.setEditable(!0),this.inputs_row.events.on("focus",function(a){(c.active_row||c.selected)&&c.setActiveRow(),c.keyboard.visible()||(c.inputs_row.is_selected=!0,c.active_x=c.inputs_row.x,c.active_y=c.inputs_row.y),c.target_row&&c.target_row.setEditing(c.target_col,!1),c.inputs_row.setEditing(a,!0),c.target_row=c.inputs_row,c.target_col=a,c.connectAndShowKeyboard("")}).on("input",function(a){if(c.slope){var b=c.inputs_row;"x"==a?b.y=c.y(b.x):b.x=c.x(b.y),b.update()}}),this.setInputs(),this.keyboard=Wa.ui.Keyboard(),this.update(),a&&a(this)},a.prototype.connectAndShowKeyboard=function(a){this.keyboard.visible()&&this.keyboard.visible(!1),this.keyboard.latex(a).visible(!0),this.keyboard.on("change."+this.id,function(a){this.target_row[this.target_col+"_in"].html(a),this.target_row.readInput(this.target_col)}.bind(this)),this.keyboard.on("done."+this.id,function(){!this.inputs_row.is_selected||this.slope||this.hasInputs()?(this.inputs_row.is_selected&&(this.addRow(this.inputs_row.x,this.inputs_row.y),this.setActiveRow(),this.setInputs()),this.active_row&&this.active_row.is_editable&&(this.active_x=this.active_row.x,this.active_y=this.active_row.y,this.setActiveRow(),this.setInputs(),this.sortRows()),this.target_row.setEditing(this.target_col,!1),this.target_row=null,this.target_col=null,this.keyboard.visible(!1),this.disconnectKeyboard()):(this.target_row.setEditing(this.target_col,!1),this.target_col="xy".replace(this.target_col,""),this.target_row.setEditing(this.target_col,!0),this.connectAndShowKeyboard(""))}.bind(this)),this.keyboard.on("cancel."+this.id,function(){this.setActiveRow(),this.target_row.setEditing(this.target_col,!1),this.disconnectKeyboard()}.bind(this))},a.prototype.unselect=function(){this.setActiveRow()},a.prototype.disconnectKeyboard=function(){this.keyboard.visible(!1),this.keyboard.on("change."+this.id,null).on("done."+this.id,null).on("cancel."+this.id,null)},a.prototype.update=function(){var a=2*this.column_width,b=this.row_height*this.rows.length,c=b+this.row_height*(this.rows_addable?2:1),d=2*this.options.margin;this.resizeElement({width:a+d,height:c+d}),this.table_el.style("width",a+"px").style("height",c+"px").style("margin",this.options.margin+"px").style("font-size",this.options.font_size+"px").style("font-weight",this.options.font_weight),this.columns_el.style("width",a+"px").style("height",this.row_height+"px"),this.inputs_el.style("width",a+"px").style("height",this.row_height+"px").style("display",this.rows_addable?"block":"none"),this.edit_el.style("left",a+10+"px"),this.remove_el.style("left",a+15+this.row_height+"px"),this.graph&&this.show_el.style("left",-this.row_height-10+"px"),d3.selectAll(".table-button").style("width",this.row_height+"px").style("height",this.row_height+"px").style("font-size",this.row_height-15+"px").style("line-height",this.row_height+"px"),this.rows_el.style("width",a+"px").style("height",b+"px")},a.prototype.setInputs=function(){this.inputs_row.x_in.html(""),this.inputs_row.y_in.html("")},a.prototype.hasInputs=function(){return""!=this.inputs_row.x_in.html()&&""!=this.inputs_row.y_in.html()},a.prototype.setRowsAddable=function(a){this.rows_addable=a,this.update()},a.prototype.setButtonMode=function(a){this.edit_el.style("display","selected"==a?"block":"none"),this.remove_el.style("display","selected"==a?"block":"none")},a.prototype.setColIndex=function(a){this.columns_row.setColIndex(a),this.inputs_row.setColIndex(a),this.rows.forEach(function(b){b.setColIndex(a)})},a.prototype.dragCol=function(a,b){b=b||0,this.columns_row.dragCol(a,b),this.inputs_row.dragCol(a,b),this.rows.forEach(function(c){c.dragCol(a,b)})},a.prototype.setColOrder=function(a){var b=this;a.forEach(function(a,c){b[a+"_pos"]=c*b.column_width,b.dragCol(a)})},a.prototype.addRow=function(a,b){for(var c=0;c<this.rows.length;c++){var d=this.rows[c];if(d.x==a&&d.y==b)return void[".table-cell",".table-input"].forEach(function(a){d.row_el.selectAll(a).transition(150).style("background-color","gainsboro").delay(150).transition(200).style("background-color","white")})}var d=new Wa.ui.TableRow(this,this.rows_el,a,b,this.rows.length),e=this;if(d.events.on("click",function(){e.active_row!=d&&e.setActiveRow(d)}).on("focus",function(a){e.active_row==d&&(e.target_row&&e.target_row.setEditing(e.target_col,!1),d.setEditing(a,!0),e.target_row=d,e.target_col=a,e.connectAndShowKeyboard(d[a].toString()))}).on("input",function(a){e.slope&&("x"==a?d.y=e.y(d.x):d.x=e.x(d.y),d.update())}),this.rows.push(d),this.setInputs(),this.update(),this.sortRows(),!this.slope&&2==this.rows.length){var f=this.rows[1].y-this.rows[0].y,g=this.rows[1].x-this.rows[0].x;this.slope=f/g,this.intercept=this.rows[0].y-this.slope*this.rows[0].x,this.graph&&this.setGraphLine()}},a.prototype.sortRows=function(){var a=this.getColumn(),b=0;this.rows.sort(function(b,c){return b[a]-c[a]}),this.rows.every(function(a,b){return a.idx===b})||this.rows.forEach(function(a,c){a.idx=c,a.dragRow(400,40*b),b++})},a.prototype.setActiveRow=function(a){if(this.inputs_row.is_selected?(this.inputs_row.x=this.active_x,this.inputs_row.y=this.active_y,this.inputs_row.setSelected(!1),this.inputs_row.update()):this.active_row?(this.active_row.x=this.active_x,this.active_row.y=this.active_y,this.active_row.setSelected(!1),this.active_row.setEditable(!1),this.active_row.update()):this.selected&&(this.selected.forEach(function(a){a.setSelected(!1)}),this.selected=null,this.rows_el.selectAll(".range").style("display","none"),this.slope_el.style("display","none")),a){a.setSelected(!0);var b=this.row_height*a.idx+"px";this.edit_el.style("top",b),this.remove_el.style("top",b)}this.setButtonMode(a?"selected":null),this.active_row=a||null,this.active_x=a?a.x:null,this.active_y=a?a.y:null,this.setInputs(),this.graph&&(this.show_el.style("display",a?"block":"none"),this.show&&this.toggleGraphElements(!!a))},a.prototype.setGraph=function(a){var b=this;this.graph=a,this.setGraphLine(),this.graph.ggbApplet.setVisible("a",!1),this.graph.ggbApplet.setLabelVisible("g",!0),this.graph.ggbApplet.setLabelStyle("g",2),this.graph.ggbApplet.setLabelVisible("h",!0),this.graph.ggbApplet.setLabelStyle("h",2),this.graph.ggbApplet.evalCommand("p=false"),this.graph.ggbApplet.evalCommand("r=false"),this.show_el=a.element_div.append("i").classed("table-button",!0).classed("glyphicon glyphicon-eye-open",!0).style("position","absolute").style("top","0px").style("cursor","pointer").style("background-color","white").style("border","1px solid silver").style("border-radius","5px").style("text-align","center").style("display","none");var c=Wa.mtouch_events().frame(this.show_el.node()).on("tap",function(){b.show=!b.show,b.show_el.transition().style("background-color",b.show?"gold":"white"),b.toggleGraphElements(b.show)});this.show_el.call(c),this.update()},a.prototype.setGraphLine=function(){this.graph.ggbApplet.evalCommand("m="+(this.slope?this.slope:"false")),this.graph.ggbApplet.evalCommand("b="+(this.intercept?this.intercept:"false"))},a.prototype.toggleGraphElements=function(a){if(this.graph.ggbApplet.setVisible("a",a),this.active_row)this.graph.ggbApplet.evalCommand("G=("+this.active_row.x+","+this.active_row.y+")"),this.graph.ggbApplet.evalCommand("p="+a),this.graph.ggbApplet.evalCommand("r=false");else if(this.selected){var b=this.selected[this.selected.length-1],c=this.selected[0];this.selected.forEach(function(a){a.idx<=b.idx&&(b=a),a.idx>=c.idx&&(c=a)}),this.graph.ggbApplet.evalCommand("A=("+b.x+","+b.y+")"),this.graph.ggbApplet.evalCommand("B=("+c.x+","+c.y+")"),this.graph.ggbApplet.evalCommand("r="+a),this.graph.ggbApplet.evalCommand("p=false")}},a}(),Wa.ui=Wa.ui||{},Wa.ui.TableRow=function(){var a=function(a,b,c,d,e){this.table=a,this.container=b,this.events=d3.dispatch("click","focus","input"),this.row_el=null,this.idx=e,this.x=c,this.x_el=null,this.x_in=null,this.y=d,this.y_el=null,this.y_in=null,this.is_selected=!1,this.is_editable=!1,this.init()};return a.prototype.init=function(){function a(a){b[a+"_el"]=b.row_el.append("div").classed("table-cell",!0).style("position","absolute").style("top","0px").style("box-sizing","border-box").style("border","1px solid silver").style("background-color","white").on("click",function(){
b.events.click()}),b[a+"_in"]=b[a+"_el"].append("span").classed("table-input",!0).style("position","absolute").style("left","4px").style("top","4px").style("text-align","center").style("overflow","hidden").on("click",function(){b.is_editable&&b.events.focus(a)})}this.row_el=this.container.append("div").classed("table-row",!0).style("position","absolute").style("left","0px");var b=this;a("x"),a("y"),this.setEditable(!1),this.update()},a.prototype.update=function(){function a(a){c.dragCol(a,0),c[a+"_el"].style("width",b.column_width+"px").style("height",b.row_height+"px");var d=c[a].toString();d.length>4&&(d=d.substring(0,4)+"..."),c[a+"_in"].html(d).style("width",b.column_width-10+"px").style("height",b.row_height-10+"px").style("line-height",b.row_height-10+"px")}var b=this.table,c=this;this.dragRow(0,0),this.row_el.style("width",2*b.column_width+"px").style("height",b.row_height+"px"),a("x"),a("y")},a.prototype.setSelected=function(a){this.row_el.selectAll(".table-cell").style("background-color",a?"gainsboro":"white"),this.row_el.selectAll(".table-input").style("background-color",a&&!this.is_editable?"gainsboro":"white"),this.is_selected=a},a.prototype.setEditable=function(a){var b=this.table.row_height-10;this.row_el.selectAll(".table-input").style("border",a?"1px solid silver":"none").style("line-height",a?b-1+"px":b+"px").style("background-color",!a&&this.is_selected?"gainsboro":"white"),this.is_editable=a},a.prototype.setEditing=function(a,b){this[a+"_in"].style("border",b?"1px solid dodgerblue":this.is_editable?"1px solid silver":"none")},a.prototype.setColIndex=function(a){this.x_el.style("z-index","x"==a?1:0),this.y_el.style("z-index","y"==a?1:0)},a.prototype.dragCol=function(a,b){this[a+"_el"].transition().duration(b).style("left",this.table[a+"_pos"]+"px")},a.prototype.dragRow=function(a,b){0===a?this.row_el.style("top",this.table.row_height*this.idx+"px"):this.row_el.style("opacity",.75).transition().delay(b).duration(a).style("top",this.table.row_height*this.idx+"px").each("end",function(){d3.select(this).style("opacity",1)})},a.prototype.readInput=function(a){var b=parseFloat(this[a+"_in"].html());isNaN(b)||(this[a]=b,this.events.input(a))},a}(),Wa.CanvasEventRecorder=pa,pa.prototype.startRecording=function(){this.event_log.initial_event_count=this.event_log.events.length,this.setupListeners()},pa.prototype.adjustTimeOfNextEvent=function(a){this.ajust_time_of_next_event=a},pa.prototype.createAndRecordCanvas=function(a,b){if(arguments.length<2)throw"(CanvasEventRecorder) Please provide instantiation arguments for the canvas.";this.container=a,this.canvas=new Wa.ui.CanvasFactory(a,b),Wa.extend(this.event_log,{version:Wa.version,options:b,events:[],ccontrollerID:this.canvas.controller.id}),this.startRecording()},pa.prototype.setUserOptions=function(a,b){this.event_log||(this.event_log={}),this.event_log.userOptions||(this.event_log.userOptions={}),this.event_log.userOptions[a]=b},pa.prototype.extendClassesWithUserOptions=function(){var a=this.event_log.userOptions;if(a)for(key in a)Wa.extend(Wa[key].defaultOptions,a[key])},pa.prototype.initProgressBar=function(){return this.canvas.container.style("position","relative"),this.canvas.container.append("div").style({position:"absolute",bottom:0,width:"0%",background:"steelblue",height:"5px",opacity:.5})},pa.prototype.replay=function(a,b){var c=this,d=this;if(this.canvas||this.init(),this.event_log.events.length>0){var e,f,g,h,i;!function(){var j=function(){g=f[h].time,d3.timer(k,a||0)},k=function(a){for(e.style("width",Math.min(100,(a+d.time_skip)/i*100).toFixed(4)+"%");d.ignore_custom_events_during_playback&&"custom-event"===f[h].type||f[h].time-g<a+d.time_skip;)if(h=d.evaluateEvent(f,h),h===f.length)return d.canvas.controller.disableKeyboard(!1),b&&b(),e.transition().remove(),!0};e=c.initProgressBar(),c.canvas.controller.disableKeyboard(!0),f=c.event_log.events,g=f[0].time,h=0,c.time_skip=0,i=f[f.length-1].time-g,setTimeout(j,10)}()}else this.canvas.controller.disableKeyboard(!1),b&&b()},pa.prototype.init=function(){this.canvas&&(this.canvas.tools.remove(),this.canvas.svg.remove(),this.canvas=null),this.canvas=new Wa.ui.CanvasFactory(this.container,this.event_log.options),this.extendClassesWithUserOptions(),this.canvas.controller.id=this.event_log.ccontrollerID,this.event_log.initial_event_count=this.event_log.events.length},pa.prototype.addEvent=function(a){if(this.ajust_time_of_next_event){this.ajust_time_of_next_event=!1;var b=this.event_log.events[this.event_log.events.length-1];b?this.event_dt=-a.time+b.time:this.event_dt=-a.time}a.time+=this.event_dt,a.selection&&delete a.selection,a.target&&delete a.target,this.event_log.events.push(a)},pa.prototype.evaluateEvent=function(a,b){return"custom-event"===a[b].type?++b:this.eventIsAnInteraction(a[b])?this.performInteraction(a,b):"create"===a[b].type||"remove"===a[b].type||"graphElementCreate"===a[b].type||"graphElementRemove"===a[b].type?this.performCheckpoint(a,b):++b},pa.prototype.eventIsAnInteraction=function(a){return a.performee},pa.prototype.performInteraction=function(a,b){var c=this.getPerformeeFn(a[b].performee_type);return c(a,b)},pa.prototype.getPerformeeFn=function(a){if("Toolbar"===a)return this.simulateInteractionOnToolbar.bind(this);if("CanvasController"===a)return this.simulateInteractionOnCanvasController.bind(this);if("CanvasModelView"===a)return this.simulateModeSwitch.bind(this);if("DL"===a||"row"===a)return this.simulateInteractionOnDL.bind(this);if("graph"===a)return this.simulateInteractionOnGraph.bind(this);if("AM"===a)return this.simulateInteractionOnAlgebraModel.bind(this);throw"(CanvasEventRecorder) Performee type of event does not match recognized object type."},pa.prototype.simulateInteractionOnToolbar=function(a,b){return this.canvas.onButton(a[b].button),++b},pa.prototype.simulateInteractionOnCanvasController=function(a,b){var c=a[b];if("keyboard"===c.type){for(var d=b,e=a[d];d<a.length&&"enteredTerm"!==e.type;)d++,e=a[d];d!==a.length&&(this.time_skip+=e.time-c.time)}else if("enteredTerm"===c.type)this.canvas.model.createDL(Wa.deepCopy(c.options));else if("enteredGraph"===c.type);else if("fontSize"===c.type)this.canvas.controller.set_font_size(c.font_size);else{var f=this.getObjectByID(c.performee);f[""+c.subType+"_"+c.type](c)}return++b},pa.prototype.simulateInteractionOnDL=function(a,b){var c=a[b],d=this.getObjectByID(c.performee);return"Clone"!==c.type&&"packState"!==c.type&&("row"===c.performee_type?d.rows[c.row][""+c.type.toLowerCase()](c):d[""+c.type.toLowerCase()](c)),++b},pa.prototype.simulateInteractionOnGraph=function(a,b){var c=a[b],d=this.getObjectByID(c.performee);if("zoom"===c.type)d.replayZoom(c);else if("moveTouch"===c.type)d.deleteMove();else if("resize"===c.type)"touch"===c.resize_type?d.resize_touch(c):"drag"===c.resize_type?d.resize(c):"release"===c.resize_type&&d.resize_release(c);else if("mouseLocation"===c.type)"in-main"===c.location?d.showMove():"out-main"===c.location?d.hideMove():d.withinGrid(c);else if("linkStart"===c.type||"linkDrag"===c.type||"linkEnd"===c.type){var e=d.getGeomByID(c.object);"linkStart"===c.type?e.startLinking(c):"linkDrag"===c.type?e.linking(c):"linkEnd"===c.type&&e.endLinking(c)}else d[""+c.type](c);return++b},pa.prototype.simulateInteractionOnAlgebraModel=function(a,b){var c=a[b],d=this.getObjectByID(c.performee);return d.rows[c.row].view.interaction_handler["on_"+c.type](c),++b};pa.prototype.simulateModeSwitch=function(a,b){var c=a[b],d=this.getObjectByID(c.performee);return d.switchMode(),++b};pa.prototype.performCheckpoint=function(a,b){var c=this.getCheckpointFn(a[b].type);return c(a,b)},pa.prototype.getCheckpointFn=function(a){if("create"===a)return this.checkCreation.bind(this);if("action"===a)return this.checkAction.bind(this);if("undone"===a)return this.checkUndo.bind(this);if("redone"===a)return this.checkRedo.bind(this);if("newPosition"===a)return this.checkPosition.bind(this);if("packState"===a)return this.checkPacking.bind(this);if("remove"===a)return this.checkDeletion.bind(this);if("graphElementCreate"===a||"graphElementRemove"===a)return this.checkGraphContents.bind(this);if("graphElementChange"===a)return this.checkGraphElementAttributes.bind(this);if("mode"===a)return this.checkMode.bind(this);throw"(CanvasEventRecorder) That checkpoint is not recognized."},pa.prototype.checkCreation=function(a,b){var c=a[b],d=this.canvas.model.getElementsOfType(c.object_type);if(!d)throw"(CanvasEventRecorder) Unknown object type";var e=d.filter(function(a){return!a.is_accounted_for});if(1!==e.length)throw"(CanvasEventRecorder) Could not identify new object to set ID";return e[0].is_accounted_for=!0,e[0].id=c.object_id,"link"===a[b].object_type&&this.checkExistenceOfLinkedObjects(e[0]),++b},pa.prototype.originOfDL=function(a,b){return!("enteredTerm"!==a.type||!a.dl_id||a.dl_id!==b.id)||!("Clone"!==a.type||!a.dl_id||a.dl_id!==b.id)},pa.prototype.getUnidentifiedGraph=function(){var a=this.canvas.model.graphs();return a[a.length-1]},pa.prototype.checkExistenceOfLinkedObjects=function(a){this.getObjectByID(a.a().id),this.getObjectByID(a.b().id)},pa.prototype.checkAction=function(a,b){var c=a[b],d=this.getObjectByID(c.dl_id);return setTimeout(function(){var a=d.getLastRow();if(a.model.to_ascii()!==c.newTree||a.action.name!==c.action&&"(DL) row added from model (only redo)"!==c.action)throw"FF to next keyframe."},c.delay?c.delay:0),++b},pa.prototype.checkUndo=function(a,b){var c=a[b];if("create_dl"===c.actionType)return this.checkDeletion(a,b);if("math"===c.actionType){var d=this.getObjectByID(c.id);if(d.rows.length!==c.numberOfRows||d.getLastModel().to_ascii()!==c.lastExpression)throw"FF to next keyframe."}return++b},pa.prototype.checkRedo=function(a,b){var c=a[b];if("create_dl"===c.actionType)try{this.getObjectByID(c.id)}catch(a){throw"(CanvasEventRecorder) Object on the canvas with that id was not found"===a?"FF to next keyframe.":a}else if("math"===c.actionType){var d=this.getObjectByID(c.id);if(d.rows.length!==c.numberOfRows||d.getLastModel().to_ascii()!==c.lastExpression)throw"FF to next keyframe."}return++b},pa.prototype.checkPosition=function(a,b){var c=a[b],d=this.getObjectByID(c.id);if("DL"===c.object_type){if(d.pos[0]!==c.pos[0]||d.pos[1]!==c.pos[1])throw"FF to next keyframe."}else if("graph"===c.object_type){if(d.pos.x!==c.pos.x||d.pos.y!==c.pos.y)throw"FF to next keyframe.";if(d.size.width!==c.size.width||d.size.height!==c.size.height)throw"FF to next keyframe."}return++b},pa.prototype.checkPacking=function(a,b){var c=a[b],d=this.getObjectByID(c.id);if(c.packState.length!==d.rows.length)throw"FF to next keyframe.";for(var e=0;e<d.rows.length;e++)if(d.rows[e].hidden!==c.packState)throw"FF to next keyframe.";return++b},pa.prototype.checkDeletion=function(a,b){var c,d=a[b];try{c=this.getObjectByID(d.id)}catch(c){if("(CanvasEventRecorder) Object on the canvas with that id was not found"===c){if("dl"===d.object_type||"graph"===d.object_type){for(var e=b+1,f=a[e];f&&f.performee&&f.performee===d.object_id||f&&f.object_id&&f.object_id===d.object_id;)f=a[++e];return e}return++b}throw c}throw"FF to next keyframe."},pa.prototype.checkGraphContents=function(a,b){var c=a[b],d=this.getObjectByID(c.graph_id);if("graphElementCreate"===c.type)return d.geoms[d.geoms.length-1].id=c.object_id,++b;if("graphElementRemove"===c.type){for(var e=0;e<d.geoms.length;e++)if(d.geoms[e].id===c.object_id)throw"FF to next keyframe.";return++b}},pa.prototype.checkGraphElementAttributes=function(a,b){for(var c,d=a[b],e=this.getObjectByID(d.graph_id),f=d.object_id,g=0;g<e.geoms.length;g++){var h=e.geoms[g];h.id===f&&(c=h)}if("point"===c.type){if(c.pos.x!==d.point_a.x||c.pos.y!==d.point_a.y)throw"FF to next keyframe."}else if("point-slope"===c.type){if(c.point.pos.x!==d.point_a.x||c.point.pos.y!==d.point_a.y||c.slope!==d.slope)throw"FF to next keyframe."}else if("point-point"===c.type){if(c.point_a.pos.x!==d.point_a.x||c.point_a.pos.y!==d.point_a.y||c.point_b.pos.x!==d.point_b.x||c.point_b.pos.y!==d.point_b.y)throw"FF to next keyframe."}else if("slope-intercept"===c.type&&(c.intercept.pos.x!==d.point_a.x||c.intercept.pos.y!==d.point_a.y||c.slope!==d.slope))throw"FF to next keyframe.";return++b},pa.prototype.checkMode=function(a,b){var c=a[b];if(this.canvas.model.mode()!==c.mode)throw"FF to next keyframe.";return++b},pa.prototype.getObjectByID=function(a){var b=this.canvas.model,c=b.dls().concat(b.graphs()).concat(b.links());c.push(this.canvas.controller);for(var d=0;d<c.length;d++)if(c[d].id===a)return c[d];throw"(CanvasEventRecorder) Object on the canvas with that id was not found"},pa.prototype.getRowIDXByInteractionHandlerID=function(a,b){for(var c=0;c<a.rows.length;c++)if(a.rows[c].view.interaction_handler.uid===b)return c;throw"(CanvasEventRecorder) Interaction-handler with that ID not found in derivation list."},pa.prototype.setupListeners=function(){this.registerToolbarListeners(this.canvasToolbarListener.bind(this)),this.registerCanvasModelListeners(this.canvasModelViewListener.bind(this)),this.registerCanvasControllerListeners(this.canvasControllerListener.bind(this)),self=this,this.canvas.model.dls().forEach(function(a){self.setupListenersOnDL(a)}),this.canvas.model.graphs().forEach(function(a){self.setupListenersOnGraph(a)}),this.canvas.model.links().forEach(function(a){self.setupListenersOnLink(a)})},pa.prototype.canvasToolbarListener=function(a){a=Wa.extend(a,{type:"button",performee:this.canvas.id,performee_type:"Toolbar"}),this.addEvent(a)},pa.prototype.canvasModelViewListener=function(a){"mode"===a.type?this.modeChangeDetected(a):"create"===a.type?this.objectCreationDetected(a):"remove"===a.type&&this.objectDeletionDetected(a)},pa.prototype.canvasControllerListener=function(a){"undone"===a.type||"redone"===a.type?this.undoRedoDetected(a):this.addEvent(a)},pa.prototype.registerToolbarListeners=function(a){this.canvas.events.on("button."+this.id,a)},pa.prototype.registerCanvasModelListeners=function(a){this.canvas.model.on("create."+this.id,a).on("remove."+this.id,a).on("mode."+this.id,a)},pa.prototype.registerCanvasControllerListeners=function(a){this.canvas.controller.on("undone."+this.id,a).on("redone."+this.id,a).on("hold."+this.id,a).on("touch."+this.id,a).on("drag."+this.id,a).on("release."+this.id,a).on("font_size."+this.id,a).on("keyboard."+this.id,a).on("entered_term."+this.id,a)},pa.prototype.modeChangeDetected=function(a){var b={};b.type="mode",b.mode=a.mode,b.time=Date.now(),this.addEvent(b)},pa.prototype.objectCreationDetected=function(a){if("dl"===a.target_type||"graph"===a.target_type||"link"===a.target_type){"dl"===a.target_type?this.setupListenersOnDL(a.target):"graph"===a.target_type?this.setupListenersOnGraph(a.target):"link"===a.target_type&&this.setupListenersOnLink(a.target),console.log(a);var b={};b.type="create",b.time=Date.now(),b.object_id=a.target.id,b.object_type=a.target_type,"dl"!==a.target_type&&"graph"!==a.target_type||(b.object_options=Wa.deepCopy(a.target.options)),this.addEvent(b)}},pa.prototype.objectDeletionDetected=function(a){var b={};b.type="remove",b.time=Date.now(),b.object_id=a.target.id,b.object_type=a.target_type,this.addEvent(b)},pa.prototype.undoRedoDetected=function(a){var b={};b.type=a.type,b.time=Date.now(),"create_dl"===a.action.type?(b.actionType=a.action.type,b.object_id=a.action.dl.id):"math"===a.action.type&&(b.actionType=a.action.type,b.object_id=a.action.dl.id,b.lastExpression=a.action.dl.getLastModel().to_ascii(),b.numberOfRows=a.action.dl.rows.length),this.addEvent(b)},pa.prototype.setupListenersOnDL=function(a){var b=this.DLTransformListener.bind(this);this.registerListenersOnDLTransformEvents(a,b);var c=this.DLRowListener.bind(this);this.registerListenersOnDLRowEvents(a,c),this.setupListenersOnInteractionHandlers(a)},pa.prototype.DLTransformListener=function(a){this.addEvent(a)},pa.prototype.DLRowListener=function(a){if("packState"===a.type){var b={};b.type=a.type,b.time=a.time,b.object_id=a.performee,b.object_type="row",b.packState=a.packState,this.addEvent(b)}else this.addEvent(a)},pa.prototype.registerListenersOnDLTransformEvents=function(a,b){a.dl_events.on("drag",b).on("touch",b).on("release",b).on("hold",b)},pa.prototype.registerListenersOnDLRowEvents=function(a,b){a.row_events.on("drag",b).on("touch",b).on("tap",b).on("release",b).on("clone",b).on("pack_state",b)},pa.prototype.setupListenersOnInteractionHandlers=function(a){for(var b=this,c=function(c){c=Wa.extend(c,{performee_type:"AM",performee:a.id,row:b.getRowIDXByInteractionHandlerID(a,c.performee)}),b.addEvent(c)},d=0;d<a.rows.length;d++)this.registerListenersOnInteractionHandler(a.rows[d].view,c);a.events.on("added_line",function(d){if(1!==a.rows.length){b.logAction(d);var e=a.rows[a.rows.length-2].view;b.registerListenersOnInteractionHandler(e,c);var f=a.getLastView();b.registerListenersOnInteractionHandler(f,c)}})},pa.prototype.registerListenersOnInteractionHandler=function(a,b){a.interaction_handler.events.on("touch",b).on("release",b).on("drag_start",b).on("drag",b).on("drag_end",b).on("tap",b).on("keydown",b).on("keyup",b)},pa.prototype.setupListenersOnGraph=function(a){var b=this.graphListener.bind(this);this.registerListenersOnGraph(a,b)},pa.prototype.graphListener=function(a){if("graphElementCreate"===a.type||"graphElementRemove"===a.type){var b={};b.type=a.type,b.time=a.time,b.object_id=a.performee,b.object_type=a.performee_type,b.graph_id=a.graph_id,a=b}else if("graphElementChange"===a.type){var b={};b.type=a.type,b.time=a.time,b.object_id=a.performee,b.graph_id=a.graph_id;var c,d,e,f=a.performee_object;"point"===f.type&&f.line&&(f=f.line,b.id=f.id),"point"===f.type?c=Wa.deepCopy(f.pos):"point-slope"===f.type?(c=Wa.deepCopy(f.point.pos),e=f.slope):"point-point"===f.type?(c=Wa.deepCopy(f.point_a.pos),d=Wa.deepCopy(f.point_b.pos)):"slope-intercept"===f.type&&(c=Wa.deepCopy(f.intercept.pos),e=f.slope),b.point_a=c,b.point_b=d,b.slope=e,a=b}else if("linkStart"===a.type||"linkDrag"===a.type||"linkEnd"===a.type){var g={};g.type=a.type,g.time=a.time,g.performee=a.graph_id,g.performee_type="graph",g.object=a.performee,g.object_type=a.performee_type,g.finger=a.finger,a=g}this.addEvent(a)},pa.prototype.registerListenersOnGraph=function(a,b){a.events.on("move_touch",b).on("move",b).on("touch",b).on("drag",b).on("hold",b).on("release",b).on("zoom",b).on("resize",b).on("create_geom",b).on("remove_geom",b).on("geom_attr",b).on("mouse_location",b).on("link_start",b).on("link_drag",b).on("link_end",b)},pa.prototype.setupListenersOnLink=function(a){},pa.prototype.logAction=function(a){this.addEvent({type:"action",action:a.action.name,dl_id:a.senderDL_id,newTree:a.action.newTree.to_ascii(),delay:a.action.delay,time:Date.now()})},pa.prototype.clearEventLogRetainSimpleObjects=function(){var a=this.getSimpleObjectsFromCanvas();this.event_log.events=[];for(var b=0;b<a.length;b++){var c=a[b],d=c instanceof DerivationList?"dl":"graph";this.addEvent({type:"create",time:-1,performee_type:d,performee:c.id,object_options:c.options})}},pa.prototype.captureInitialState=function(){this.event_log.options.initialState=this.canvas.serialize(),this.event_log.events=[]},pa.prototype.remove=function(){this.canvasComponents&&(this.canvasComponents.svg.remove(),this.canvasComponents=null)},Wa.DLLogger=qa,qa.prototype.initListeners=function(){this.registerDLListeners(this.dl);var a=this.dl.rows.length;this.dl.rows.forEach(function(b,c){0!==c&&c!==a-1||this.registerInteractionHandlerListeners(b.view.interaction_handler),this.registerAMListeners(b.model)},this)},qa.prototype.registerDLListeners=function(a){a.events.on("added_line."+this.id,function(){2===a.rows.length&&this.registerInteractionHandlerListeners(a.rows[0].view.interaction_handler),this.registerAMListeners(a.getLastModel())}.bind(this)).on("auto_undo."+this.id,function(b){this.registerInteractionHandlerListeners(a.getLastView().interaction_handler),this.registerAMListeners(a.getLastModel()),this.on_auto_undo(b)}.bind(this))},qa.prototype.registerAMListeners=function(a){a.events.on("create."+this.id,this.on_change.bind(this)).on("change."+this.id,this.on_change.bind(this)).on("end-of-interaction."+this.id,this.on_end_of_interaction.bind(this)).on("start-of-interaction."+this.id,this.on_start_of_interaction.bind(this))},qa.prototype.registerInteractionHandlerListeners=function(a){a.events.on("touch."+this.id,this.on_touch.bind(this,a)).on("release."+this.id,this.on_release.bind(this,a)).on("tap."+this.id,this.on_tap.bind(this,a)).on("dbltap."+this.id,this.on_tap.bind(this,a)).on("hold."+this.id,this.on_tap.bind(this,a)).on("keydown."+this.id,this.on_keydown.bind(this,a)).on("keyup."+this.id,this.on_keyup.bind(this,a)).on("node_selection."+this.id,this.on_node_selection.bind(this,a)),this.log_mouse_trajectories&&a.events.on("drag_start."+this.id,this.on_drag_start.bind(this,a)).on("drag."+this.id,this.on_drag.bind(this,a)).on("drag_end."+this.id,this.on_drag_end.bind(this,a))},qa.prototype.log=function(a){this.events.push(a)},qa.prototype.extendWithNodeData=function(a,b,c,d){if(c||(c=[]),Array.isArray(c)||(c=[c]),this.extendWithSelectorData(a,b,c),0!==c.length){var e=gb.getBoundingBox(c);a[b+"x"]=e.x,a[b+"y"]=e.y,a[b+"width"]=e.width,a[b+"height"]=e.height}},qa.prototype.getSelectorString=function(a,b){if(Array.isArray(a)){if(0===a.length)return""}else a=[a];return b?a[0].get_root().getSelectorOfNodes(a).join(";"):a.map(function(a){return a.to_ascii()}).join(";")},qa.prototype.extendWithSelectorData=function(a,b,c){a[b+"ascii"]=this.getSelectorString(c,!0)},qa.prototype.extendWithFirstLogData=function(a,b,c){this.extendWithLogData(a,this.events[0],b,c)},qa.prototype.extendWithPreviousLogData=function(a,b,c){this.extendWithLogData(a,this.events[this.events.length-1],b,c)},qa.prototype.extendWithLogData=function(a,b,c,d){if(!(b&&c+"x"in b))throw"(DLLogger) Source log argument does not exist or does not contain expected data.";void 0===d&&(d=c),a[d+"x"]=b[c+"x"],a[d+"y"]=b[c+"y"],a[d+"width"]=b[c+"width"],a[d+"height"]=b[c+"height"],a[d+"ascii"]=b[c+"ascii"],b[d+"idx"]&&(a[d+"idx"]=b[c+"idx"])},qa.prototype.extendWithDuration=function(a){for(var b=this.events.length-1;b>=0;b--){var c=this.events[b];if("math"===c.type||0===b)return void(a.dur=a.time-c.time)}},qa.prototype.on_change=function(a){this.interaction&&"ignore"!==this.interaction&&(a.action?this.on_action(a):this.dl.rows[0].model===a.new_model&&this.on_scrub(a))},qa.prototype.create_dl=function(a){var b=a.el_id,c=a.new_state,d={type:"event",subtype:"create",el_type:"derivation",el_id:b,new_state:c,time:Date.now()};this.log(d)},qa.prototype.on_action=function(a){var b=this.dl.getRowByModel(a.action.newTree),c={time:Date.now(),type:"event",subtype:"math",action:a.action.name,row_id:b?b.idx:-1,method:a.action.getOrInferTriggerType()};"SubstitutionAction"!==a.action.name&&"EquationCombineAction"!==a.action.name||(c.source_ascii=a.action.nodes[0].to_ascii(),c.source_id=a.action.nodes[0].id),this.extendWithNodeData(c,"expr_",a.action.new_derivation?a.action.oldTree.children[0]:a.action.newTree.children[0]),a.action.target&&(this.extendWithSelectorData(c,"target_",a.action.target),c.target_side=a.action.settings.side),this.events.length&&this.extendWithDuration(c),this.interaction.method||(this.interaction.method=c.method),this.interaction.new_state=c.expr_ascii,this.log(c),a.dl&&this.create_dl({time:c.time,action:a.action.name,el_id:a.dl,new_state:a.action.newTree.to_ascii()})},qa.prototype.on_scrub=function(a){this.scrubbed_in_this_interaction=!0,this.interaction.subtype="scrub",this.interaction.method="drag"},qa.prototype.on_start_of_interaction=function(a){return this.interaction?void console.warn("Start of interaction received before prior interaction ended."):(this.interaction={time:Date.now(),type:"interaction",subtype:"rewrite",el_type:"derivation",el_id:this.dl.id,el_subtype:"row",el_subid:this.dl.getRowByModel(a.model).idx,old_state:a.model.to_ascii()},void this.logStartOfInterationEvent(a.time,this.dl.getRowByModel(a.model)))},qa.prototype.on_end_of_interaction=function(a){return this.interaction&&"ignore"!==this.interaction?(this.scrubbed_in_this_interaction&&(this.logScrubEvent(),this.initListeners()),("edit"===this.dl.mode&&!this.isEmptySelectionInteraction()||"inspect"===this.dl.mode&&this.scrubbed_in_this_interaction)&&(this.interaction.dur=this.events[this.events.length-1].time-this.interaction.time,this.interaction_logger.logInteractionWithEvents(this.interaction,this.events,qa.compressDragEvents)),void this.clearData()):(this.interaction||console.warn("End of interaction received without prior start of interaction."),void this.clearData())},qa.prototype.on_auto_undo=function(a){this.interaction&&"ignore"!==this.interaction&&this.log({time:Date.now(),type:"event",subtype:"auto-undo",row_id:this.dl.rows.length-1})},qa.prototype.isEmptySelectionInteraction=function(){return!this.events.some(function(a){return"node_selection"===a.subtype||"math"===a.subtype})},qa.compressDragEvents=function(a){var b=a.filter(function(a){return"drag"===a.subtype});if(0===b.length)return a;for(var c,d={type:"event",subtype:"trajectory",dts:[],xs:[],ys:[],wi_int_ids:[],sel_ascii:[]},e=a[0].time,f=0;f<b.length;f++){var g=b[f];d.dts.push(g.time-e),d.xs.push(g.x),d.ys.push(g.y),d.wi_int_ids.push(g.within_interaction_id),d.sel_ascii.push(g.sel_ascii!==c?g.sel_ascii:void 0),e=g.time,c=g.sel_ascii}return d.interaction_id=a[0].interaction_id,d.trial_id=a[0].trial_id,a=a.filter(function(a){return"drag"!==a.subtype}),a.push(d),a},qa.decompressAndSortEvents=function(a){a.sort(function(a,b){return(a.within_interaction_id||-1)-(b.within_interaction_id||-1)});var b;if("trajectory"===a[0].subtype)b=0;else{if(!a[1]||"trajectory"!==a[1].subtype)return a;b=1}for(var c=a.splice(b,1)[0],d=a[0].time,e=0;e<c.dts.length;e++){var f={time:c.dts[e]+d,x:c.xs[e],y:c.ys[e],trial_id:c.trial_id,interaction_id:c.interaction_id,within_interaction_id:c.wi_int_ids[e],type:"event",subtype:"drag"};c.sel_ascii&&c.sel_ascii[e]&&(f.sel_ascii=c.sel_ascii[e]),a.push(f),d+=c.dts[e]}return a.sort(function(a,b){return(a.within_interaction_id||-1)-(b.within_interaction_id||-1)}),a},qa.prototype.clearData=function(){this.scrubbed_in_this_interaction=!1,this.interaction=null,this.events=[]},qa.prototype.logScrubEvent=function(){var a={time:Date.now(),type:"event",subtype:"scrub",method:"drag",dur:this.events[this.events.length-1].time-this.events[0].time};this.extendWithNodeData(a,"expr_",this.dl.rows[0].model.children[0]),this.interaction.new_state=a.expr_ascii,this.log(a)},qa.prototype.logStartOfInterationEvent=function(a,b){var c={time:a,type:"event",subtype:"start-interaction",row_id:b.idx};this.extendWithNodeData(c,"expr_",b.model.children[0]),this.extendWithNodeData(c,"sel_",b.view.interaction_handler.selected_nodes),this.log(c)},qa.prototype.on_touch=function(a,b){if(this.interaction&&"ignore"!==this.interaction){var c={time:b.time,type:"event",subtype:"touch",x:b.finger.pos[0],y:b.finger.pos[1],touch_id:b.finger.id};this.extendWithNodeData(c,"sym_",b.target,!0),this.log(c)}},qa.prototype.on_release=function(a,b){this.interaction&&"ignore"!==this.interaction&&this.log({time:b.time,type:"event",subtype:"release",x:b.finger.pos[0],y:b.finger.pos[1],touch_id:b.finger.id})},qa.prototype.on_drag_start=function(a,b){if(this.interaction&&"ignore"!==this.interaction)if(0===b.selection.length)this.interaction="ignore";else{var c={time:b.time,type:"event",subtype:"drag",x:Math.round(b.pos0[0]),y:Math.round(b.pos0[1]),sel_ascii:this.getSelectorString(b.selection[0],!1)};this.log(c)}},qa.prototype.on_drag=function(a,b){if(this.interaction&&"ignore"!==this.interaction){var c={time:b.time,type:"event",subtype:"drag",x:Math.round(b.pos[0]),y:Math.round(b.pos[1]),sel_ascii:this.getSelectorString(b.selection[0],!1)};this.log(c)}},qa.prototype.on_drag_end=function(a,b){},qa.prototype.on_node_selection=function(a,b){if(this.interaction&&"ignore"!==this.interaction){var c={time:b.time,type:"event",subtype:"node_selection"};this.extendWithNodeData(c,"sel_",b.selection,!0),this.log(c)}},qa.prototype.on_tap=function(a,b){this.interaction&&"ignore"!==this.interaction&&this.log({time:b.time,type:"event",subtype:b.type,x:b.finger.pos[0],y:b.finger.pos[1]})},qa.prototype.on_keydown=function(a,b){this.interaction&&"ignore"!==this.interaction&&this.log({time:b.time,type:"event",subtype:"keydown",key_code:b.keyCode})},qa.prototype.on_keyup=function(a,b){this.interaction&&"ignore"!==this.interaction&&this.log({time:b.time,type:"event",subtype:"keyup",key_code:b.keyCode})},Wa.DLLogger=qa,Wa.CanvasLogger=ra,ra.prototype.startOfInteractionDetected=function(a){this.data_logger.listening&&(a.source&&a.source.options&&a.source.options.dont_log_events||(this.containsPendingEvents(this.interactionSequence)&&this.submitCurrentSequence(),this.addEvent(a)))},ra.prototype.endOfInteractionDetected=function(a){this.data_logger.listening&&(a.source&&a.source.options&&a.source.options.dont_log_events||(this.addEvent(a),this.interactionSequence[0].source&&this.interactionSequence[0].source.type!==this.interactionSequence[this.interactionSequence.length-1].source.type||this.submitCurrentSequence()))},ra.prototype.addEvent=function(a){this.data_logger.listening&&(a.source&&a.source.options&&a.source.options.dont_log_events||(a.time=Date.now(),a.date=(new Date).toString(),a.source&&a.source.model&&a.source.model.to_ascii&&(a.source.model=a.source.model.to_ascii()),this.interactionSequence.push(a)))},ra.prototype.submitCurrentSequence=function(){var a=this.summarizeInteractionSequence(this.interactionSequence);a.forEach(function(a){this.data_logger.logInteraction(a)},this),this.interactionSequence=[]},ra.prototype.summarizeInteractionSequence=function(a){try{return this.isNullSequence(a)?[]:this.isMoveSequence(a)?this.summarizeMoveSequence(a):this.isResizeSequence(a)?this.summarizeResizeSequence(a):this.isCreateSequence(a)?this.summarizeCreateSequence(a):this.isCreateDuringActionSequence(a)?this.summarizeCreateDuringActionSequence(a):this.isGeometryCreateSequence(a)?this.summarizeGeometryCreateSequence(a):this.isDeleteSequence(a)?this.summarizeDeleteSequence(a):this.isGeometryDeleteSequence(a)?this.summarizeGeometryDeleteSequence(a):this.isDrawSequence(a)?this.summarizeDrawSequence(a):this.isEraseSequence(a)?this.summarizeEraseSequence(a):this.isNodeInspectSequence(a)?this.summarizeNodeInspectSequence(a):this.isGraphScrubSequence(a)?this.summarizeGraphScrubSequence(a):this.isPackSequence(a)?this.summarizePackSequence(a):this.isLinkSequence(a)?this.summarizeLinkSequence(a):this.isCloneSequence(a)?this.summarizeCloneSequence(a):this.isGraphPanSequence(a)?this.summarizeGraphPanSequence(a):this.isButtonSequence(a)?this.summarizeButtonSequence(a):this.isGraphZoomSequence(a)?this.summarizeGraphZoomSequence(a):this.isFontSizeSequence(a)?this.summarizeFontSizeSequence(a):this.isTextEditSequence(a)?this.summarizeTextEditSequence(a):(console.warn("(CanvasLogger) Interaction did not match any defined interaction types."),this.interactionSequence=[],[])}catch(a){return console.warn("(CanvasLogger) Error when summarizing interaction sequence:",a),this.interactionSequence=[],[]}},ra.prototype.containsPendingEvents=function(a){return!!a.length},ra.prototype.isDifferentInteraction=function(a,b){if(!a.length)return!1;var c=!1;return b.element.id&&(c=c||a.some(function(a){return!a.element||!a.element.id||a.element.id!==b.element.id})),b.type&&(c=c||a.some(function(a){return!a.type||a.type!==b.type})),c},ra.prototype.setupListeners=function(a){this.registerToolbarListeners(a,this.canvasToolbarListener.bind(this)),this.registerCanvasModelViewListeners(a.model,this.canvasModelViewListener.bind(this)),this.registerCanvasControllerListeners(a.controller,this.canvasControllerListener.bind(this))},ra.prototype.registerToolbarListeners=function(a,b){a.events.on("button."+this.session_id,b)},ra.prototype.canvasToolbarListener=function(a){this.containsPendingEvents(this.interactionSequence)&&this.submitCurrentSequence(),a.type="toolbar_button_press",
this.addEvent(a),this.submitCurrentSequence()},ra.prototype.registerCanvasModelViewListeners=function(a,b){var c=this;a.on("create."+this.session_id,b).on("remove."+this.session_id,b);var d=a.dls();d.forEach(function(a){c.setupListenersOnDL(a)});var e=a.graphs();e.forEach(function(a){c.setupListenersOnGraph(a)})},ra.prototype.canvasModelViewListener=function(a){"create"===a.type&&this.objectCreationDetected(a),"remove"===a.type&&this.objectDeletionDetected(a)},ra.prototype.registerCanvasControllerListeners=function(a,b){a.on("start-of-interaction."+this.session_id,b).on("end-of-interaction."+this.session_id,b)},ra.prototype.canvasControllerListener=function(a){a.length&&(a=a[0]),"start-of-interaction"===a.type&&this.startOfInteractionDetected(a),"end-of-interaction"===a.type&&this.endOfInteractionDetected(a)},ra.prototype.objectCreationDetected=function(a){if(!(a.target&&a.target.options&&a.target.options.dont_log_events)&&"link"!==a.target_type){"derivation"===a.target_type&&this.setupListenersOnDL(a.target),"graph"===a.target_type&&this.setupListenersOnGraph(a.target),"textbox"===a.target_type&&this.setupListenersOnTextBox(a.target);var b={};b.type="GM_object_created_or_added",b.method=a.method,b.element={type:a.target_type,id:a.target.id},a.target.pos&&(b.element.pos={x:a.target.pos.x,y:a.target.pos.y}),a.target.size&&(b.element.size={x:a.target.size.width,y:a.target.size.height}),"derivation"===a.target_type&&(b.element.new_state=a.target.options.eq),"textbox"===a.target_type&&a.target.text!==a.target.options.default_text&&(b.element.new_state=a.target.text),"image"===a.target_type&&a.target.options.url&&(b.element.new_state=a.target.options.url),this.addEvent(b),1===this.interactionSequence.length&&this.submitCurrentSequence()}},ra.prototype.objectDeletionDetected=function(a){if(!(a.target&&a.target.options&&a.target.options.dont_log_events)){var b={};b.type="GM_object_removed",b.element={type:a.target_type,id:a.target.id,options:a.target.options?Wa.deepCopy(a.target.options):null},this.addEvent(b),1===this.interactionSequence.length&&(this.interactionSequence=[])}},ra.prototype.setupListenersOnDL=function(a){this.registerListenersOnEvents(a.events,this.DLListener.bind(this)),this.dlLoggers.push(new qa(this.data_logger,a))},ra.prototype.registerListenersOnEvents=function(a,b){a.on("inspect_node."+this.session_id,b).on("pack_state."+this.session_id,b)},ra.prototype.DLListener=function(a){a.length&&(a=a[0]),"inspect"===a.type&&this.nodeInspectionDetected(a),"packState"===a.type&&this.packStateDetected(a)},ra.prototype.nodeInspectionDetected=function(a){var b={};b.type="node_inspected",b.element={type:"derivation",id:a.dl.id},b.inspection={row:a.row,model:a.dl.rows[a.row].model.to_ascii(),sel:a.node.get_root().getSelectorOfNodes([a.node]).join(";")},this.addEvent(b)},ra.prototype.packStateDetected=function(a){var b={};b.type="derivation_list_pack_state_changed",b.element={type:"derivation",id:a.performee},b.state=a.packState,this.addEvent(b)},ra.prototype.setupListenersOnGraph=function(a){this.registerListenersOnGraph(a,this.graphListener.bind(this))},ra.prototype.registerListenersOnGraph=function(a,b){a.events.on("create_geom."+this.session_id,b).on("remove_geom."+this.session_id,b).on("geom_attr."+this.session_id,b).on("zoom."+this.session_id,b)},ra.prototype.graphListener=function(a){"graphElementCreate"!==a.type&&"graphElementChange"!==a.type||this.graphElementDetected(a),"graphElementRemove"===a.type&&this.graphElementDeletionDetected(a),"zoom"===a.type&&this.graphPanZoomDetected(a)},ra.prototype.graphElementDetected=function(a){var b={};b.type="graphElementCreate"===a.type?"graph_element_created":"graph_element_changed",b.element={type:"graph",id:a.graph_id};var c=a.performee_object.summarize();delete c.id,delete c.type,b.graph_element={type:a.performee_type||a.performee_object.type,id:a.performee,attr:c},this.addEvent(b)},ra.prototype.graphElementDeletionDetected=function(a){var b={};b.type="graph_element_removed",b.element={type:"graph",id:a.graph_id},b.graph_element={type:a.performee_type,id:a.performee,attr:a.performee_object},this.addEvent(b)},ra.prototype.graphPanZoomDetected=function(a){var b={};b.type="graph_pan_zoom",b.element={type:"graph",id:a.performee,new_state:{pan:a.translate,zoom:a.scale}},this.isDifferentInteraction(this.interactionSequence,b)&&this.submitCurrentSequence(),this.addEvent(b)},ra.prototype.setupListenersOnTextBox=function(a){this.registerListenersOnTextBox(a,this.textboxListener.bind(this))},ra.prototype.registerListenersOnTextBox=function(a,b){a.events.on("text."+this.session_id,b).on("font_size."+this.session_id,b)},ra.prototype.textboxListener=function(a){("text"===a.type&&this.isDifferentInteraction(this.interactionSequence,a)||"font_size"===a.type&&this.containsPendingEvents(this.interactionSequence))&&this.submitCurrentSequence(),this.addEvent(a),"font_size"===a.type&&this.submitCurrentSequence()},ra.prototype.isNullSequence=function(a){return!!a.every(function(a){return"start-of-interaction"===a.type&&"CanvasController"===a.source.type||"end-of-interaction"===a.type})||(!!a.every(function(a){return"start-of-interaction"===a.type&&"AlgebraModel"===a.source.type||"end-of-interaction"===a.type})||(!!a.every(function(a){return"start-of-interaction"===a.type&&"DerivationRow"===a.source.type||"end-of-interaction"===a.type})||(!(!a.every(function(a){return"start-of-interaction"===a.type&&("derivation"===a.source.type||"Graph"===a.source.type||"textbox"===a.source.type)||"end-of-interaction"===a.type})||!this.startAndEndPositionsAreTheSame(a)&&!this.startAndEndSizesAreTheSame(a))||(!!a.every(function(a){return"start-of-interaction"===a.type&&"Graph"===a.source.type&&"touch"===a.subSource||"end-of-interaction"===a.type})||!(!a.every(function(a){return"start-of-interaction"===a.type&&"DerivationRow"===a.source.type||"GM_object_created_or_added"===a.type&&"textbox"===a.element.type||"end-of-interaction"===a.type})||!a.some(function(a){return"start-of-interaction"===a.type}))))))},ra.prototype.startAndEndPositionsAreTheSame=function(a){var b=a[0],c=a[a.length-1];if(!b.pos||!c.pos)return!1;var d=Array.isArray(b.pos)?b.pos:[b.pos.x,b.pos.y],e=Array.isArray(c.pos)?c.pos:[c.pos.x,c.pos.y];return d[0]===e[0]&&d[1]===e[1]},ra.prototype.startAndEndSizesAreTheSame=function(a){var b=a[0],c=a[a.length-1];return!(!b.size||!c.size)&&(b.size.width===c.size.width&&c.size.height===c.size.height)},ra.prototype.isCreateSequence=function(a){return a.every(function(a){return"start-of-interaction"===a.type&&"CanvasController"===a.source.type||"GM_object_created_or_added"===a.type&&"path"!==a.element.type||"end-of-interaction"===a.type})},ra.prototype.isCreateDuringActionSequence=function(a){return a.some(function(a){return"start-of-interaction"===a.type&&"AlgebraModel"===a.source.type})&&a.some(function(a){return"GM_object_created_or_added"===a.type&&"path"!==a.element.type})},ra.prototype.isGeometryCreateSequence=function(a){return a.every(function(a){return"start-of-interaction"===a.type&&"Graph"===a.source.type||"graph_element_created"===a.type||"graph_element_changed"===a.type||"end-of-interaction"===a.type})&&a.some(function(a){return"graph_element_created"===a.type})},ra.prototype.isDeleteSequence=function(a){return a.every(function(a){return"start-of-interaction"===a.type||"GM_object_removed"===a.type&&"path"!==a.element.type||"node_inspected"===a.type||"end-of-interaction"===a.type})&&a.some(function(a){return"GM_object_removed"===a.type})},ra.prototype.isGeometryDeleteSequence=function(a){return a.every(function(a){return"start-of-interaction"===a.type&&"Graph"===a.source.type||"graph_element_removed"===a.type||"graph_element_changed"===a.type||"end-of-interaction"===a.type})&&a.some(function(a){return"graph_element_removed"===a.type})},ra.prototype.isDrawSequence=function(a){return a.every(function(a){return"start-of-interaction"===a.type&&"CanvasController"===a.source.type||"GM_object_created_or_added"===a.type&&"path"===a.element.type||"end-of-interaction"===a.type})},ra.prototype.isEraseSequence=function(a){return a.every(function(a){return"start-of-interaction"===a.type&&"CanvasController"===a.source.type||"GM_object_created_or_added"===a.type||"GM_object_removed"===a.type&&"path"===a.element.type||"end-of-interaction"===a.type})},ra.prototype.isNodeInspectSequence=function(a){return a.every(function(a){return"start-of-interaction"===a.type&&"AlgebraModel"===a.source.type||"node_inspected"===a.type||"end-of-interaction"===a.type})},ra.prototype.isGraphScrubSequence=function(a){return a.every(function(a){return"start-of-interaction"===a.type&&"Graph"===a.source.type||"model_changed"===a.type&&"number_scrub"===a.change.type||"graph_element_changed"===a.type||"end-of-interaction"===a.type})},ra.prototype.isMoveSequence=function(a){return a.every(function(a){return"start-of-interaction"===a.type&&("derivation"===a.source.type||"Graph"===a.source.type||"textbox"===a.source.type||"image"===a.source.type)&&a.pos||"end-of-interaction"===a.type})},ra.prototype.isResizeSequence=function(a){return a.every(function(a){return"start-of-interaction"===a.type&&("textbox"===a.source.type||"image"===a.source.type)&&a.size||"end-of-interaction"===a.type})},ra.prototype.isPackSequence=function(a){return a.every(function(a){return"start-of-interaction"===a.type||"derivation_list_pack_state_changed"===a.type||"end-of-interaction"===a.type})},ra.prototype.isLinkSequence=function(a){return a.every(function(a){return"start-of-interaction"===a.type&&"Graph"===a.source.type||"GM_object_created_or_added"===a.type&&"derivation"===a.element.type||"end-of-interaction"===a.type})||a.every(function(a){return"start-of-interaction"===a.type&&"DerivationRow"===a.source.type||"graph_element_created"===a.type||"end-of-interaction"===a.type})},ra.prototype.isCloneSequence=function(a){return a.every(function(a){return"start-of-interaction"===a.type&&"DerivationRow"===a.source.type||"GM_object_created_or_added"===a.type||"end-of-interaction"===a.type})},ra.prototype.isGraphPanSequence=function(a){return a.every(function(a){return"start-of-interaction"===a.type||"graph_pan_zoom"===a.type||"end-of-interaction"===a.type})&&a.some(function(a){return"start-of-interaction"===a.type})},ra.prototype.isButtonSequence=function(a){return a.every(function(a){return"toolbar_button_press"===a.type})||a.some(function(a){return"toolbar_button_press"===a.type&&("undo"===a.button.label||"redo"===a.button.label)})},ra.prototype.isGraphZoomSequence=function(a){return a.every(function(a){return"graph_pan_zoom"===a.type})},ra.prototype.isFontSizeSequence=function(a){return a.every(function(a){return"font_size"===a.type})},ra.prototype.isTextEditSequence=function(a){return a.every(function(a){return"text"===a.type})},ra.prototype.fillSummaryWithTimeAndCanvasId=function(a,b,c){a.time=b.time,a.dur=c.time-b.time},ra.prototype.summarizeCreateSequence=function(a){for(var b=a[0],c=a[a.length-1],d=[],e=1;e<a.length-1;e++){var f=a[e],g={type:"interaction",subtype:"create",el_id:f.element.id,el_type:f.element.type,method:f.method,pos:f.pos,size:f.size};f.element.new_state&&(g.new_state=f.element.new_state),this.fillSummaryWithTimeAndCanvasId(g,b,c),d.push(g)}return d},ra.prototype.summarizeCreateDuringActionSequence=function(a){var b=this.summarizeCreateSequence(a.filter(function(b,c){return 0===c||c===a.length-1||"GM_object_created_or_added"===b.type})),c=this.dlLoggers.find(function(b){return b.dl.getLastModel()===a[0].source});return c?(b.forEach(function(a){return c.create_dl(a)}),[]):[]},ra.prototype.summarizeGeometryCreateSequence=function(a){var b={type:"interaction",subtype:"create"},c=a[0],d=a[a.length-1];this.fillSummaryWithTimeAndCanvasId(b,c,d);var e=a.filter(function(a){return"graph_element_created"===a.type});e=e[e.length-1];var f=a.filter(function(a){return"graph_element_changed"===a.type});return f.length&&(e=f[0]),b.targets=[{type:"graph",id:e.element.id,subtype:e.graph_element.type,subid:e.graph_element.id,new_state:e.graph_element.attr}],"point"===b.targets[0].subtype?b.method="hold":b.method="hold-drag",[b]},ra.prototype.summarizeDeleteSequence=function(a){var b=a[0],c=a[a.length-1],d=Wa.find(a,function(a){return"GM_object_removed"===a.type}),e={type:"interaction",subtype:"delete",method:"tap",el_id:d.element.id,el_type:d.element.type};return this.fillSummaryWithTimeAndCanvasId(e,b,c),[e]},ra.prototype.summarizeGeometryDeleteSequence=function(a){var b={type:"graph",subtype:"delete",method:"tap"},c=a[1],d=(a[a.length-1],a[0]);return this.fillSummaryWithTimeAndCanvasId(b,d,c),delete d.graph_element.attr.id,delete d.graph_element.attr.type,b.element={type:d.element.type,id:d.element.id,subtype:d.graph_element.type,subid:d.graph_element.id,old_state:d.graph_element.attr},[b]},ra.prototype.summarizeDrawSequence=function(a){var b={type:"interaction",subtype:"draw",method:"drag"},c=a[0],d=a[a.length-1];return this.fillSummaryWithTimeAndCanvasId(b,c,d),b.el_id=a[1].element.id,b.el_type=a[1].element.type,[b]},ra.prototype.summarizeEraseSequence=function(a){var b={type:"interaction",subtype:"erase",method:"drag"},c=a[0],d=a[a.length-1];return this.fillSummaryWithTimeAndCanvasId(b,c,d),[b]},ra.prototype.summarizeNodeInspectSequence=function(a){var b=a[0],c=a[a.length-1],d=a[1],e={type:"interaction",subtype:"inspect",method:"tap",el_id:d.element.id,el_type:"derivation",el_subid:d.inspection.row,el_subtype:"row",sel_ascii:d.inspection.sel};return this.fillSummaryWithTimeAndCanvasId(e,b,c),[e]},ra.prototype.summarizeGraphScrubSequence=function(a){var b={type:"graph",subtype:"scrub",method:"drag"},c=a[0],d=a[a.length-1];this.fillSummaryWithTimeAndCanvasId(b,c,d);var e=a.filter(function(a){return"graph_element_changed"===a.type})[0],f=c.source.selection;return delete f.id,delete f.type,b.element={type:"graph",id:e.element.id,subtype:e.graph_element.type,subid:e.graph_element.id,old_state:c.source.selection,new_state:e.graph_element.attr},[b]},ra.prototype.summarizeMoveSequence=function(a){var b=a[0],c=a[a.length-1],d={type:"interaction",subtype:"move",method:"drag",el_id:b.source.id,el_type:b.source.type,old_state:JSON.stringify(b.pos),new_state:JSON.stringify(c.pos)};return this.fillSummaryWithTimeAndCanvasId(d,b,c),[d]},ra.prototype.summarizeResizeSequence=function(a){var b=a[0],c=a[a.length-1],d={type:"interaction",subtype:"resize",method:"drag",el_id:b.source.id,el_type:b.source.type,old_state:JSON.stringify(b.size),new_state:JSON.stringify(c.size)};return this.fillSummaryWithTimeAndCanvasId(d,b,c),[d]},ra.prototype.summarizePackSequence=function(a){var b={type:"interaction",subtype:"pack-dl",method:"drag"},c=a[0],d=a[a.length-1];this.fillSummaryWithTimeAndCanvasId(b,c,d);var e=a[a.length-2];return b.element={type:"derivation",id:e.element.id,subtype:"dl-row",subid:c.source.row,old_state:c.source.packState,new_state:d.source.packState},[b]},ra.prototype.summarizeLinkSequence=function(a){var b={type:"interaction",subtype:"link",method:"drag"},c=a[0],d=a[a.length-1];this.fillSummaryWithTimeAndCanvasId(b,c,d);var e=a[1];return"DerivationRow"===c.source.type?(b.element={type:"derivation",id:c.source.id,subtype:"dl-row",subid:c.source.row,sel:c.source.model},b.targets=[{type:"graph",id:e.element.id,subtype:e.graph_element.type,subid:e.graph_element.id,new_state:e.graph_element.attr}]):(b.element={type:"graph",id:c.source.id,subtype:c.source.selection.type,subid:c.source.selection.id},b.targets=[{type:"derivation",id:e.element.id,new_state:e.element.new_state}]),[b]},ra.prototype.summarizeCloneSequence=function(a){var b=a[0],c=a[a.length-1],d=a[1],e={type:"interaction",subtype:"clone",method:"drag",el_id:b.source.id,el_type:"derivation",el_subid:b.source.row,el_subtype:"row",target_id:d.element.id,target_type:d.element.type,new_state:d.element.new_state,pos:d.element.pos};return this.fillSummaryWithTimeAndCanvasId(e,b,c),[e]},ra.prototype.summarizeGraphPanSequence=function(a){var b={type:"graph",subtype:"pan",method:"drag"},c=a[0],d=a[a.length-1];this.fillSummaryWithTimeAndCanvasId(b,c,d);var e=a[1],f=a[a.length-2];return b.element={type:"graph",id:c.source.id,old_state:{pan:e.element.new_state.pan,zoom:e.element.new_state.zoom},new_state:{pan:f.element.new_state.pan,zoom:f.element.new_state.zoom}},[b]},ra.prototype.summarizeGraphZoomSequence=function(a){var b={type:"graph",subtype:"zoom",method:"scroll"},c=a[0],d=a[a.length-1];return this.fillSummaryWithTimeAndCanvasId(b,c,d),b.element={type:"graph",id:c.element.id,old_state:{pan:c.element.new_state.pan,zoom:c.element.new_state.zoom},new_state:{pan:d.element.new_state.pan,zoom:d.element.new_state.zoom}},[b]},ra.prototype.summarizeButtonSequence=function(a){var b={type:"interaction",method:"toolbar"},c=a.filter(function(a){return"toolbar_button_press"===a.type})[0];switch(b.time=c.time,b.dur=0,c.button.label){case"undo":b.subtype="undo";break;case"redo":b.subtype="redo";break;case"clear all":b.subtype="clear_all";break;case"larger":case"smaller":b.subtype="font_size",b.old_state=c.old_state.font_size,b.new_state=c.button.font_size;break;case"save":b.subtype="save";break;case"load":b.subtype="load";break;default:b.subtype="mode_change",b.old_state=c.old_state.mode,b.new_state=c.button.label}return[b]},ra.prototype.summarizeFontSizeSequence=function(a){return[{type:"interaction",subtype:"font_size",method:"toolbar",time:a[0].time,dur:0,el_type:a[0].element.type,el_id:a[0].element.id,old_state:JSON.stringify(a[0].element.old_state),new_state:JSON.stringify(a[0].element.new_state)}]},ra.prototype.summarizeTextEditSequence=function(a){var b=a[0],c=a[a.length-1],d={type:"interaction",subtype:"edit",method:"keyboard",el_type:"textbox",el_id:b.element.id,old_state:b.element.old_state,new_state:c.element.new_state};return this.fillSummaryWithTimeAndCanvasId(d,b,c),[d]},Wa.inherit(ma,sa),Wa.ui.GeoGebraCanvasElement=sa,sa.defaultOptions={type:"GeoGebraCanvasElement",resizable:{x:!0,y:!0},min_size:{width:300,height:300},edit_mode_drag_box_width:-20,ggb_params:{showMenuBar:!1,showAlgebraInput:!1,showToolBar:!0,showResetIcon:!1,enableLabelDrags:!1,enableShiftDragZoom:!1,enableRightClick:!0,errorDialogsActive:!1,useBrowserForJS:!0,preventFocus:!1,language:"en"},ggb_base64:"UEsDBBQACAgIAPloRUkAAAAAAAAAAAAAAAAXAAAAZ2VvZ2VicmFfZGVmYXVsdHMyZC54bWztml9z4jYQwJ97n0Ljp/YhYBsMJBNyw91Mp5nJ5TJN5qavwl6MGllyJTmYfPrKkrFNEihnaJLL5QV5Zf397Wq1kjn9mCcU3YGQhLOx43VcBwELeURYPHYyNTsaOR/PPpzGwGOYCoxmXCRYjZ2gKFnV01LHHx4XeSiX5ITxS5yATHEI1+EcEnzBQ6xM0blS6Um3u1gsOqtGO1zE3ThWnVxGDtIDYnLslA8nurm1SoueKe67rtf968uFbf6IMKkwC8FBerARzHBGldSPQCEBppBapjB2Uk6YchDFU6Bj56qQ0K8zAfCbg8pKmoHrnH345VTO+QLx6d8Q6jwlMqjqGaFblNGvP3PKBRJjR089Nr/TseMHgYMwTee4yDFFKV6CQHeYVjk4Uzw0tU3uDFMJq7K6ny88AvumX5ZnJDEMkVSQ6nE6SKYAkXmy89MPqe7I6K7RXsi5iCTKx84lvnTQskzvbWqKGDLX5L7sMmjmqiWFxshPuyXU3fBGkAKLdKE1xl4rxoORgVwkU5v8yJB7h4L8lTXR+q3Qen5g2Jr03YQbdM/ZnxDrMTcZ994ZH5TxugX3f0IHbIpYhrL4HTshT1IK+QHBU8JqiBdGqKD7++967osgd1sjL3BYeGpOwlsGUocdfqPd4uEPEunNq+jP1IF/2JqSiNYRCYnaDl5CXEgVy+uVXONvtyH+bPh5pmjR1zlTOvTUlPTY5KPJ3AKkN7ryV3YjMJNFyGrLrCBu1tQsY6bRy29YVOwzHb/M9GijpsLabQEbnVTHD15aa/9NZTuR/d32qzLh77fPzQAFXm5b/MHbIvejLv473Savl/23Uqz01HvfI3fR0xOhDBYKJMFsO/+QMxJWMD9bqaLff2P0W4UfJAZmzVQilLuml6Vrit+75f1N7hl56Zm3957NNvX1UAXJ0cTWmNiCE98mPZv0bRJUSNrFPEaZqVZ8w/E9WE/9dkGPF/SMTgPvoVI73rtaD6LWZ3C2LEtANJb75UquzCOwC163l8GaMndY3itL2Kx3SUmkjSQhWg1HOhBLcF6cqxCeSk4zBdehAGD1vaU1zAWJ1Lw4Lem+ZiQvDMK+mHNB7jlT1eRRYdYTai44m5bcxj4eWmMxvX1jOsxiWq+0iZVq9vYWyRR6eMB8SiVNmm4Jc9DxRz1vFPTcoTc8DkaDHeF6o9Zw11yJhbDL7uC5Gw1of1fyXQr3yz5E2LgndDdZgTsa+oNBf+AHx8dDb9AfHj7S/73KqGxj8BIbcWMBPYfD7rWL83c+Pg7ahfy+29/g74av+PiYcrqMGzZ1tZIrHENrUm1841uKHrYjXLu+u6oyaojes0F8pUH1lqtPHmayvvu0UkVu9MaOFjjLCSVYLB/3dMBLDQV5HdzfGKHxEfUVIt08FQ06rod2bqXG10o7mRnR3BhOdAXbCWGfcHgbC65d/OMA8yBTf8U+aco5BVy79U8rufEt8lEIvwnQ7sHa/7bewjmEt1Oer8We270KkfUKuDBC4xvhEytgn5D0qDSFaVyHA4H9oGjSBzfKxfOLO6I2e9Fun7qOHjmnbuNvH93VX0vO/gVQSwcIGNrQjpgEAADhIgAAUEsDBBQACAgIAPloRUkAAAAAAAAAAAAAAAAXAAAAZ2VvZ2VicmFfZGVmYXVsdHMzZC54bWztlslu2zAQhs/NUxC8R6sVx4GVwEgPLZAELXLplZbGMluJVEgqlvNqfYc+U7nIiuw4AWKkaIv2wuEyw+X7yZGmF21VonsQknKW4tALMAKW8ZyyIsWNWhyf4ovzo2kBvIC5IGjBRUVUihPj2cfplheNJ6YPtZKeMX5DKpA1yeA2W0JFrnhGlHVdKlWf+f5qtfI2k3pcFH5RKK+VOUZ6Q0ymuKuc6em2glaxdY+CIPS/XF+56Y8pk4qwDDDSm81hQZpSSV2FEipgCql1DSkmLZWxXqIkcyhTPDPN9xh1/imOwyDG50fvpnLJV4jPv0Kme5VooI+xDd/46OFLXnKBRIr1uQtbzm1JynpJTM06lmQNAt2Tsu8hjeKZjbW9C1JK2PjqVa55Dm5k1PkzWll8SCqotUwYyRogtzV3NL1qrReysg3nowxu1boEpJY0+8ZAarTRIMhUPtA8B6O+i4E75kKkKVNcE6HFVIJmeg1XB33mH9+N+9TvED+BnTXiHjIiFEhK2AD7pRnY5X7yr3N/ASRnNBvw+8g0f6kRmY1Zylsok+AglFGSWJhhNN7F6YV/I1B9kWkBTN9BxYXUeSmwq6wD6/4QdNmuDW17HdrRh9B123i9VUFbNHMRM+c4i5yJnRk5k/RIdl8PreqSZlS9rLE+MoOBxp9se+uN6Ix3kLCTidU1CidWV2t7ZZO3UjbjXOQStQ6mQ2zLVT/lgpivSrdKf6f26Roc9lBqXq6XkAvOHjkOuh5Rxh3KQy7Va/GHSWz5J+GTZzX63c/qeZR3Dcltwu/O9nnTHkIMD0s0wWh/1vbGb3Ybf0W22JsrTKdLCGtnHqJ+wtemDzQ7cWbszKkzk47C82LJRiz0n9a+b203tK3b6I/V7Y2/D+FheYSB6lncmPoQXvI/c+zA8wf/2/7mn/78J1BLBwiOET9GtAIAAFoMAABQSwMEFAAICAgA+WhFSQAAAAAAAAAAAAAAABYAAABnZW9nZWJyYV9qYXZhc2NyaXB0LmpzSyvNSy7JzM9TSE9P8s/zzMss0dBUqK4FAFBLBwjWN725GQAAABcAAABQSwMEFAAICAgA+WhFSQAAAAAAAAAAAAAAAAwAAABnZW9nZWJyYS54bWy1V19v2zYQf24/xUHPjk1Sov4Udoq2wIACWVEs3TDsTZYYmYgsGSJtJ0M//O5ISZaTpmuazTFD8ni8u9/dkUcv395taziozui2WQV8zgJQTdGWuqlWwd7eXKTB28vXy0q1lVp3Ody03Ta3q0AS57gPZ3ORZETT5SpIyzLjaRJepEqwiyhNoot1UmQXRciLcs3YTSKRE+6MftO0n/KtMru8UNfFRm3zq7bIrRO6sXb3ZrE4Ho/zQf287apFVa3nd6YMAE1vzCroB29Q3NmmY+jYBWN88eevV178hW6MzZtCBUCw9vry9avlUTdle4SjLu1mFcQMjdsoXW0QZ0STBTHtEOxOFVYflMGtk6nDbLe7wLHlDa2/8iOoRzgBlPqgS9WtAjYPH3wCaDutGtvz8l7nYpC2PGh19GJp5DRGLEswBtroda1WwU1eG0Slm5sOPYoGdXucGntfq3XeDfOTPXzm/pBF/616oN4RuMZCNotkOksYm0nZu2CiW3IRgG3b2olm8BU4SIYNeAYziBOkCOASIqSkSEkgJJrkEYRALDyEKMI+IjKPaU3ifsmAcySDYCAECA4ixKmUIGOQCW0UyBtnThjDRtxoDraQaGGIzdHCCJugEQqSXgwaIcPYjSRxo3wpyHxHDFOIMlREBJlwCNEGnCcMUGJI4rkDETGgL4eIxIsERAooD3GTZCa+E5V+fgpLT3gQlyEq8jwqbEYNE3Q25uU0Ic5DghFgiG1GHfcdmRvHfol5Ggt9J3wX+U56nshvjzyrR8sizxOFL4U5gAyfAzKdgOQEAoNC1rsuBLKbO/upi/pp7Kcu1RhnPTWlfxlN0Cdx6gYvxBT+FCY+0eqP6XOUjrmSpT+u8mU5OsIU34Ip5BMwX+jdQSmXE6Woy31de6QyfBbOR1fkT2iMz07hS+7nn1DORfoMjU97OEp/WGXCvnnr+J73/fei8H/44aV30+iHf1G5XAx1edn7AMyGePtTbNXWkFfCbKyQMdWwvkwmAhIJSTwpljMql7E8VUyql+lZxZTppGxizYyJmLgajJqo6PkSKqKhis76Ovr1UR3FshedKh8aSKLoTu1LH2oX0+In8KJEo6lmYCWnOxMEihSANTOmfU/UxQB2rdGjdzeq3o1+d47UzW5ve+f19GJbDo60LbLntXsD9hvKtrh9P/q736JyY6dy8QF1eqb5B9XZK+7Vss7XqsbH7jVlA8Ahr+nUOg03bWNhyD0ROHHuwbhU+6LWpc6bPzD6w+vs0367Vh24YUsonRDaDsPL0t3Qw8syDCPPUrRtV17fG0wWuPtLdbhZZDKAez/mcTTPph989Jkip8yOsvMVlH7/5JLTpQ7XylrEayC/U2bwb9XRqen9RpOP5n1bn0i7Vjf2Q76z+879MMDj1RGKd01VK+c6F1Z8YRe36/bu2teG2Mv6cr9To1PX1Ye2bjvAYyckgqz6fu17x0OWjVzM8TDH0csgoeM6z4TjcP3a944Lo+pN65HyASYbtGgDfn52aF1G0HN932h7NUysLm5PQInfx3tw4blI/h+JXC4epNryVnWNqn3aNBjIfbs3Pmt9qJwde6M+53bzril/UxWeuc853XwWRXvWk8WlKvQWN3p677mcovo7muqppao6NSD0Z9D7tT8sYHadykuzUcqO3vVJPWU7if6la7cfm8MXTKEHpi8XA76lKTq9o0yFNV7Mt+qUjKU2OV7s5XQfOsMgqoJuGHSsJacGkO/tpu3cT6/cEoU0TFndke5/W17+A1BLBwgbJvAVKgUAAAwPAABQSwECFAAUAAgICAD5aEVJGNrQjpgEAADhIgAAFwAAAAAAAAAAAAAAAAAAAAAAZ2VvZ2VicmFfZGVmYXVsdHMyZC54bWxQSwECFAAUAAgICAD5aEVJjhE/RrQCAABaDAAAFwAAAAAAAAAAAAAAAADdBAAAZ2VvZ2VicmFfZGVmYXVsdHMzZC54bWxQSwECFAAUAAgICAD5aEVJ1je9uRkAAAAXAAAAFgAAAAAAAAAAAAAAAADWBwAAZ2VvZ2VicmFfamF2YXNjcmlwdC5qc1BLAQIUABQACAgIAPloRUkbJvAVKgUAAAwPAAAMAAAAAAAAAAAAAAAAADMIAABnZW9nZWJyYS54bWxQSwUGAAAAAAQABAAIAQAAlw0AAAAA",ggb_views:{is3D:0,AV:0,SV:0,CV:0,EV2:0,CP:0,PC:0,DA:0,FI:0,PV:0,macro:0}},sa.prototype.initOptions=function(a){a=a||{};var b=Wa.deepCopy(sa.defaultOptions),c=Wa.object.extendExisting(b,a);this.options=Wa.extend(this.options,c)},sa.prototype.init=function(a){this.div=this.element_div.append("div").attr("id","ggbApplet"+this.id);var b=function(){var a=Wa.object.merged(this.options.ggb_params,{width:this.size.width,height:this.size.height,id:this.id});this.options.ggb_base64&&(a.ggbBase64=this.options.ggb_base64),this.ggbLoader=new GGBApplet(a,"5.0",this.options.ggb_views),this.ggbLoader.inject("ggbApplet"+this.id)},c=window.ggbOnInit;window.ggbOnInit=function(b){return b!==this.id?void c(b):(this.options.ggbBase64&&this.ggbApplet.setBase64(this.options.ggbBase64),this.ggbApplet=this.ggbLoader.getAppletObject(),this.ggbApplet.registerUpdateListener(this.events.ggb_update.bind(this)),this.ggbApplet.registerAddListener(this.events.ggb_add.bind(this)),this.ggbApplet.registerRemoveListener(this.events.ggb_remove.bind(this)),this.ggbApplet.registerRenameListener(this.events.ggb_rename.bind(this)),this.ggbApplet.registerClickListener(this.events.ggb_click.bind(this)),setTimeout(function(){this.div.selectAll("*").style("box-sizing","content-box","important"),this.subTypeResize(),a&&a(this)}.bind(this),1),this.events.ggb_init(this),void(app=this.ggbApplet))}.bind(this),window.GGBApplet?b.call(this):Wa.loadScripts(["https://tube.geogebra.org/scripts/deployggb.js"],b.bind(this))},sa.prototype.subTypeResize=function(){this.ggbApplet.setWidth(this.size.width),this.ggbApplet.setHeight(this.size.height)},sa.prototype.toJSON=function(){return{type:"GeoGebraCanvasElement",id:this.id,pos:Wa.deepCopy(this.pos),size:Wa.deepCopy(this.size),ggb_base64:this.ggbApplet.getBase64()}},ta.prototype.onAMeoi=function(a){this.onGGBChange(this.ggb_obj.name)},ta.prototype.onAMChange=function(a){if(a.old_model!==this.model)throw"wrong old_model";a.new_model!==a.old_model&&(this.model.events.on("change."+this.id,null),this.model.events.on("end-of-interaction."+this.id,null),this.model=a.new_model,this.model.events.on("change."+this.id,this.onAMChange.bind(this)),this.model.events.on("end-of-interaction."+this.id,this.onAMeoi.bind(this)));var b=this.ggb_obj.name;a.sender!==b&&(this.dont_update=!0,this.ggb_obj.movable||this.ggb_panel.ggbApplet.setFixed(b,!1),this.handleAMPointChange()||(this.ggb_obj.movable||this.ggb_panel.ggbApplet.setFixed(b,!1),this.ggb_panel.ggbApplet.evalCommand(b+": "+a.new_model.to_ascii())),this.ggb_obj.movable&&this.model.options.locked&&this.ggb_panel.ggbApplet.setFixed(b,!0),this.dont_update=!1)},ta.prototype.handleAMPointChange=function(){if("point"!==this.ggb_obj.type)return!1;var a=this.ggb_obj.name,b=this.ggb_panel.matchPoint(this.model);if(b){var c=b.x.get_signed_value(),d=b.y.get_signed_value();this.ggb_panel.ggbApplet.setCoords(a,c,d)}else this.model.children[0].is_group("equals")?this.ggb_panel.ggbApplet.evalCommand(this.model.to_ascii()):this.ggb_panel.ggbApplet.evalCommand(a+": "+this.model.to_ascii());return!0},ta.prototype.onGGBChange=function(a){if(!this.dont_update&&a===this.ggb_obj.name){var b=this.ggb_obj.value_str.substring(this.ggb_obj.value_str.indexOf(":")+1);if("point"===this.ggb_obj.type){var c=this.ggb_panel.matchPoint(this.model);if(!c)return;var d=this.ggb_panel.matchPointString(b);this.model.numeric_value(c.x,+d[1],a),this.model.numeric_value(c.y,+d[2],a)}else if("segment"===this.ggb_obj.type){var c=this.ggb_panel.matchSegment(this.model);this.model.numeric_value(c.val,+this.ggb_obj.value,a)}else this.model.replace_with(b,a)}},ta.prototype.unlink=function(){this.model.events.on("change."+this.id,null),this.model.events.on("end-of-interaction."+this.id,null)},ta.prototype.toJSON=function(){return{type:"GM_GGB_Link",id:this.id,ggb_obj_name:this.ggb_obj.name,row_idx:this.row.idx,dl_id:this.row.dl.id,ggb_panel_id:this.ggb_panel.id}},ta.fromJSON=function(a,b,c){var d=c.elements().find(function(b){return b.id===a.dl_id}),e=d.rows[a.row_idx],f=b.getGGBObject(a.ggb_obj_name);return new ta(f,e,b)},ua.prototype.onAMChange=function(a){if(a.old_model!==this.model)throw"wrong old_model";if(a.new_model!==a.old_model&&(this.model.events.on("change."+this.id,null),this.model=a.new_model,this.model.events.on("change."+this.id,this.onAMChange.bind(this))),a.sender!==this.id){var b=a.old_model_ascii||a.old_model.to_ascii(),c=this.ggb_panel.matchSILine(new fa(b)),d=this.ggb_panel.matchSILine(this.model),e=this.ggb_2nd.x,f=this.ggb_2nd.y,g=d.m_val;if(c.b_val!==d.b_val)f=g*e+d.b_val,this.ggb_panel.ggbApplet.setCoords(this.ggb_ic.name,0,d.b_val),this.ggb_panel.ggbApplet.setCoords(this.ggb_2nd.name,e,f);else{var h=f-d.b_val,i=Math.sqrt(e*e+h*h),j=Math.atan2(e>=0?g:-g,e>0?1:-1);e=i*Math.cos(j),f=i*Math.sin(j)+d.b_val,this.ggb_panel.ggbApplet.setCoords(this.ggb_2nd.name,e,f)}}},ua.prototype.onGGBChange=function(a){if(!this.dont_update)if(a===this.ggb_ic.name){var b=this.ggb_panel.matchSILine(this.model);b.b_node||(this.model.replace_with("y="+(b.m_node?b.m_val:"")+"x+0",this.id),b=this.ggb_panel.matchSILine(this.model)),this.model.numeric_value(b.b_node,this.ggb_ic.y,this.id),this.dont_update=!0,this.ggb_panel.ggbApplet.setCoords(this.ggb_2nd.name,this.ggb_2nd.x,this.ggb_ic.y+b.m_val*(this.ggb_2nd.x-this.ggb_ic.x)),this.dont_update=!1}else if(a===this.ggb_2nd.name){var b=this.ggb_panel.matchSILine(this.model);b.m_node||(b.b_node?this.model.replace_with("y=1x"+(b.b_val<0?"-":"+")+b.b_val,this.id):this.model.replace_with("y=1x",this.id),b=this.ggb_panel.matchSILine(this.model)),this.model.numeric_value(b.m_node,(this.ggb_2nd.y-this.ggb_ic.y)/(this.ggb_2nd.x-this.ggb_ic.x),this.id)}},ua.prototype.unlink=function(){this.model.events.on("change."+this.id,null),this.model.events.on("end-of-interaction."+this.id,null)},ua.prototype.toJSON=function(){return{type:"GM_GGB_SI_Line_Link",id:this.id,ggb_ic_name:this.ggb_ic.name,ggb_2nd_name:this.ggb_2nd.name,ggb_obj_name:this.ggb_obj.name,row_idx:this.row.idx,dl_id:this.row.dl.id,ggb_panel_id:this.ggb_panel.id}},ua.fromJSON=function(a,b,c){var d=c.elements().find(function(b){return b.id===a.dl_id}),e=d.rows[a.row_idx],f=b.getGGBObject(a.ggb_obj_name),g=b.getGGBObject(a.ggb_2nd_name),h=b.getGGBObject(a.ggb_ic_name);return new ua(h,g,f,e,b)},Cb={},Va.Node.prototype.toJSON=function(){return{id:this.id,value:this.value,type:"Expression",name:this.name,bp:this.bp,associative:this.associative,commutative:this.commutative,vertical_notation:this.vertical_notation,selected:this.selected,dragging:this.dragging,fixed:this.fixed,locked:this.locked,hidden:this.hidden,simplify:this.simplify,precision:this.precision,deleted:this.deleted,ls:this.ls&&this.ls.id,rs:this.rs&&this.rs.id,parent:this.parent&&this.parent.id,children:this.children}},Wa.AlgebraModel.prototype.toJSON=function(){var a=Wa.object.extendChanged({},this.options,fa.defaultOptions);return a.parser===fa.getDefaultParser()&&(a.parser=void 0),{id:this.id,type:"AlgebraModel",options:a,ascii:this.to_ascii()}},Wa.Action.prototype.toJSON=function(){var a={id:this.id,name:this.name,type:"Action",priority:this.priority,oldTree:this.oldTree.id,newTree:this.newTree.id,triggerType:this.triggerType,settings:this.settings};if(this.nodes&&("SubstitutionAction"===this.name||"EquationCombineAction"===this.name?a.nodes=this.nodes[0].id:a.nodes=this.nodes[0].get_root().getSelectorOfNodes(this.nodes).join(";")),this.target){var b=Array.isArray(this.target)?this.target[0].get_root():this.target.get_root();a.target=b.getSelectorOfNodes(this.target).join(";"),Array.isArray(this.target)&&1===this.target.length&&(a.target_is_array=!0)}return this.actor&&(a.actor=this.actor.get_root().getSelectorOfNodes(this.actor)[0]),a},Wa.LinkCoordinatorClass.prototype.toJSON=function(){return{id:this.id,type:"LinkCoordinator",links:this.links,auto_update_scrubbability:this.auto_update_scrubbability}},Wa.AlgebraModelLink.prototype.toJSON=function(){return{id:this.id,type:"AlgebraModelLink",source:this.source.id,target:this.target.id,action:this.action}},Wa.DerivationRow.prototype.toJSON=function(){return{id:this.id,type:"DerivationRow",dl:this.dl.id,action:this.action&&this.action.id,model:this.model,row_idx:this.idx}},Wa.DerivationList.prototype.toJSON=function(){var a=Wa.object.extendChanged({},this.options,oa.defaultOptions);return Wa.object.extendDifferent(a,this.aview_options,oa.defaultOptions),Wa.object.extendDifferent(a,this.amodel_options,oa.defaultOptions),a.canvas_model&&(a.canvas_model=this.canvas_model.id),a.id=this.id,delete a.eq,delete a.pos,{type:"DerivationList",rows:this.rows,options:a,pos:this.pos,pack_state:this.rows.map(function(a){return!!a.hidden})}},Wa.ui.Table.prototype.toJSON=function(){return{id:this.id,type:"Table",rows:this.rows.map(function(a){
return{x:a.x,y:a.y}}),pos:this.pos,graph:this.graph?this.graph.id:null}},Wa.loadFromJSON=function(a,b,c){return b||(b={}),JSON.parse(a,function(a,d){return d&&d.type in Cb?Cb[d.type](d,b,c):d})},Cb={},Cb.Expression=function(a,b){var c=new Wa.expressions[a.name];for(var d in a)c[d]=a[d];return b[c.id]=c,c},Cb.Action=function(a,b){var c=new Wa.actions[a.name].constructor;for(var d in a)c[d]=a[d];return Db(c,b),b[c.id]=c,c},Db=function(a,b){a.oldTree&&(a.oldTree=b[a.oldTree]),a.newTree&&(a.newTree=b[a.newTree]),"SubstitutionAction"===a.name||"EquationCombineAction"===a.name?(a.target=a.oldTree.getNodesFromSelector(a.target),"EquationCombineAction"===a.name&&(a.target=a.target[0]),a.nodes=[b[a.nodes]]):(a.nodes&&(a.nodes=a.oldTree.getNodesFromSelector(a.nodes)),a.actor&&(a.actor=a.oldTree.getNodesFromSelector(a.actor)[0]),a.target&&(a.target=a.oldTree.getNodesFromSelector(a.target),a.target_is_array||1!==a.target.length||(a.target=a.target[0])))},Cb.AlgebraModel=function(a,b){a.options.parser&&(a.options.parser=AlgebraParser(a.options.parser));var c=new fa(a.ascii,a.options);return c.id=a.id,b[c.id]=c,c},Cb.AlgebraModelLink=function(a,b){var c=new ga(b[a.source],b[a.target],a.action,a.id);return c.id=a.id,c},Cb.LinkCoordinator=function(a,b){var c=new Wa.LinkCoordinatorClass;return c.id=a.id,c.links=a.links,c.auto_update_scrubbability=a.auto_update_scrubbability,c.updateAll(),c},Cb.DerivationRow=function(a,b){var c=new na(a.dl,a);return c},Cb.DerivationList=function(a,b,c){function d(){f.rows.forEach(function(b,c){a.pack_state[c]&&b.hide()})}var e=a.options.eq;delete a.options.eq;var f;return f=c?c.createDL(a.options,null,"load"):new Wa.DerivationList(null,null,Wa.object.merged(a.options,{visualized:!1})),a.options.eq=e,a.rows.forEach(function(b,c){f.addRowFromModel(b.model,b.action,function(){c===a.rows.length-1&&(d(),f.layoutRows())})}),f.translateElement(a.pos),f},Cb.Path=function(a,b,c){return c.createPath(a,"load")},Cb.TextBox=function(a,b,c){var d=c.createTextBox(a,null,"load");return d.unselect(),d},Cb.CanvasImage=function(a,b,c){return c.createImage(a)},Cb.GeoGebraCanvasElement=function(a,b,c){var d=c.createElement("ggb-element",a);return d.id=a.id,b[d.id]=d,d},Cb.Table=function(a,b,c){var d=c.createElement("table",{pos:a.pos});return d.id=a.id,a.rows.forEach(function(a){d.addRow(a.x,a.y)}),d.graph=a.graph,d},e(ma,wa),wa.defaultOptions={type:"GeoGebraPanel",size:{width:100,height:500},resizable:{x:!1,y:!1},font_size:15,bg_edit_style:{border:"1px solid silver","background-color":"#eee"},bg_edit_active_style:{"background-color":"#eee"},bg_arrange_style:{"background-color":"#eee"},bg_arrange_active_style:{"background-color":"#eee"},show_definitions:!1,draggable:!1,links:[]},wa.prototype.initOptions=function(a){a=a||{};var b=_a.deepCopy(wa.defaultOptions),c=_a.extendExisting(b,a);this.options=ab(this.options,c)},wa.prototype.init=function(){this.div=this.element_div.append("div").style({height:"100%",padding:"5px","overflow-y":"auto","overflow-x":"hidden"}).classed("ggb-panel",!0),this.ggbElement.events.on("move."+this.id,this.moveAttached.bind(this)),this.ggbElement.events.on("resize."+this.id,this.resizeAttached.bind(this)),this.ggbElement.events.on("ggb_add."+this.id,this.ggbAddListener.bind(this)),this.ggbElement.events.on("ggb_update."+this.id,this.ggbUpdateListener.bind(this)),this.ggbElement.events.on("ggb_remove."+this.id,this.ggbRemoveListener.bind(this)),this.ggbElement.events.on("ggb_rename."+this.id,this.ggbRenameListener.bind(this)),this.ggbElement.events.on("ggb_click."+this.id,this.ggbClickListener.bind(this)),this.ggbElement.ggbApplet?this.on_ggb_load():this.ggbElement.events.on("ggb_init",this.on_ggb_load.bind(this))},wa.prototype.on_ggb_load=function(){this.ggbApplet=this.ggbElement.ggbApplet,this.updateAllGGBObjects(),this.update(),this.options.links&&this.loadLinks(this.options.links)};wa.prototype.moveAttached=function(a){this.translateElement({x:a.pos.x+this.ggbElement.size.width-1,y:a.pos.y},a.animated)};wa.prototype.resizeAttached=function(a){this.translateElement({x:this.ggbElement.pos.x+a.size.width-1,y:this.ggbElement.pos.y}),this.resizeElement({width:this.size.width,height:a.size.height})},wa.prototype.ggbUpdateListener=function(a){this.updateGGBObject(a),this.options.show_definitions&&this.update()},wa.prototype.ggbClickListener=function(a){},wa.prototype.setGGBHighlight=function(a,b){var c=this.getGGBObject(a);if(c&&c.highlighted!==b){if(b)c.color=this.ggbApplet.getColor(a),this.ggbApplet.setColor(a,255,0,0);else{var d=d3.rgb(c.color);this.ggbApplet.setColor(a,d.r,d.g,d.b)}c.highlighted=b}},wa.prototype.setCanvasHighlight=function(a,b){this.setCanvasHighlightByLink(a,b)},wa.prototype.setCanvasHighlightByName=function(a,b){this.canvas_model.dls().forEach(function(c){c.rows.forEach(function(c){var d=!1;c.model.for_each(function(c){c.is_group("var")&&!c.fixed&&c.value===a&&(c.selected!==b&&(d=!0),c.selected=b)}),d&&(c.view.renderer.set_style(c.view.model.children),c.view.update_style(!0))})})},wa.prototype.setCanvasHighlightByLink=function(a,b){this.links.forEach(function(c){if(c.ggb_obj&&c.ggb_obj.name===a){var d=c.row.dl.getVisibleRowOn(c.row);d.model.children[0].selected=b,d.view.renderer.set_style(d.view.model.children),d.view.update_style(!0)}})},wa.prototype.ggbAddListener=function(a){this.updateGGBObject(a),this.update()},wa.prototype.ggbRemoveListener=function(a){var b=g(this.ggb_objs,function(b){return a===b.name});b!==-1&&(this.ggb_objs.splice(b,1),this.update(),b=g(this.links,function(b){return a===b.ggb_obj.name}),b!==-1&&(this.links[b].unlink(),this.links.splice(b,1)))},wa.prototype.ggbRenameListener=function(a,b){var c=g(this.ggb_objs,function(b){return a===b.name});c===-1?(this.updateGGBObject(b),this.update()):(this.ggb_objs[c].name=b,this.renameVariableOnCanvas(a,b),this.update())},wa.prototype.renameVariableOnCanvas=function(a,b){var c=b.split("_");this.canvas_model.dls().forEach(function(b){b.rows.forEach(function(b){var d=!1;b.model.for_each(function(b){b.is_group("var")&&!b.fixed&&b.value===a&&(d=!0,b.set_value(c[0],c[1]))}),d&&b.view.update_all()})})},wa.prototype.createLink=function(a,b){this.links.push(new ta(a,b,this))},wa.prototype.updateGGBObject=function(a){var b=this.getGGBObject(a);b||(b={name:a,type:this.ggbApplet.getObjectType(a),idx:this.ggbApplet.getObjectNumber(a)},this.ggb_objs.push(b),"point"===b.type&&this.ggbApplet.setLabelVisible(a,!0)),b.def_str=this.ggbApplet.getDefinitionString(a),b.independent=this.ggbApplet.isIndependent(a),b.movable=this.ggbApplet.isMoveable(a),b.visible=this.ggbApplet.getVisible(a),"point"===b.type&&(b.x=this.ggbApplet.getXcoord(a),b.y=this.ggbApplet.getYcoord(a)),b.cmd_str=this.ggbApplet.getCommandString(a);var c=!1,d=this.ggbApplet.getValueString(a);Object.is(d,b.value_str)||(b.value_str=d,c=!0);try{var e=this.ggbApplet.getValue(a);Object.is(e,b.value)||(b.value=e,c=!0)}catch(a){}return c&&this.dont_update!==a&&this.links.forEach(function(b){b.onGGBChange(a)}),b},wa.prototype.updateAllGGBObjects=function(){var a=this.ggbApplet.getAllObjectNames();a.forEach(this.updateGGBObject.bind(this))},wa.prototype.getGGBObject=function(a){return f(this.ggb_objs,function(b){return b.name===a})},wa.prototype.nestByType=function(a){return d3.nest().key(function(a){return a.type}).sortKeys(d3.ascending).sortValues(function(a,b){return a.idx-b.idx}).entries(a)},wa.prototype.dropDLRow=function(a){var b;if(b=this.matchSILine(a.model)){var c=this.ggbApplet.evalCommandGetLabels("Point[yAxis]");this.ggbApplet.setCoords(c,0,b.b_val);var d=this.ggbApplet.evalCommandGetLabels("(1,"+(b.b_val+b.m_val)+")"),e=this.ggbApplet.evalCommandGetLabels("Line["+[c,d]+"]");this.links.push(new ua(this.getGGBObject(c),this.getGGBObject(d),this.getGGBObject(e),a,this))}else{var f=this.ggbApplet.evalCommandGetLabels(a.model.to_ascii());if(!f)return;this.ggbApplet.setLabelVisible(f,!0),a.model.options.locked&&(this.ggbApplet.setFixed(f,!0),this.ggbApplet.setColor(f,68,68,68),this.ggbApplet.setPointSize(f,3)),this.createLink(this.getGGBObject(f),a)}},wa.prototype.matchSILine=function(a){var b=a.match("y=±{m:\\NUM}*{x:x}±{?b:\\NUM}","y={?x:x}±{?b:\\NUM}");return b?{m_val:b.m?b.m.get_signed_value():b.x?1:0,b_val:b.b?b.b.get_signed_value():0,m_node:b.m,b_node:b.b}:(b=a.match("y=-x±{?b:\\NUM}"),!!b&&{m_val:-1,b_val:b.b?b.b.get_signed_value():0,b_node:b.b})},wa.prototype.matchSegment=function(a){return a.match("\\VAR = ±{val:\\NUM}")},wa.prototype.matchPoint=function(a){return a.match("\\VAR = (±{x:\\NUM},±{y:\\NUM})","(±{x:\\NUM},±{y:\\NUM})")},wa.prototype.matchPointString=function(a){return this.__pt_rx||(this.__pt_rx=new RegExp(".*= ?\\(([^(),]*),([^(),]*)\\)")),a.match(this.__pt_rx)},wa.prototype.dropGGBObject=function(a){var b=a.value_str.substring(a.value_str.indexOf(":")+1),c=this.canvas_model,d=this,e=c.createDL({eq:b,pos:{x:-1e3,y:"top"}},function(a){c.moveToFreeSpace(a)||a.translateElement({x:d.size.width+d.pos.x,y:d.pos.y})});e.getLastModel().setLocked(!a.movable),this.createLink(a,e.getLastRow())},wa.prototype.update=function(){var a=this,b=this.div.selectAll("div.type").data(this.nestByType(this.ggb_objs)),c=b.enter().append("div").classed("type",!0);c.append("p"),b.exit().remove(),b.select("p").text(function(a){return a.key+"s"});var d=b.selectAll("p.object").data(function(a){return a.values});d.enter().append("p").classed("object",!0).style("cursor","pointer").on("click",function(b){a.dropGGBObject(b),a.setGGBHighlight(b.name,!0),a.setCanvasHighlight(b.name,!0)}).on("mouseenter",function(b){a.setGGBHighlight(b.name,!0),a.setCanvasHighlight(b.name,!0)}).on("mouseleave",function(b){a.setGGBHighlight(b.name,!1),a.setCanvasHighlight(b.name,!1)}),d.exit().remove(),d.text(function(b){return a.show_definitions?b.value_str:b.name})},wa.prototype.toJSON=function(){return{type:"GeoGebraPanel",id:this.id,pos:this.pos,size:this.size,ggbElement:this.ggbElement.id,links:this.links}},va("GeoGebraPanel",function(a,b,c){return a.ggbElement=b[a.ggbElement],c.createElement("ggb-panel",a)}),wa.prototype.loadLinks=function(a){var b=this,c={GM_GGB_Link:ta,GM_GGB_SI_Line_Link:ua};a.forEach(function(a){var d=c[a.type];if(!d)throw"Unknown link type "+a.type;b.links.push(d.fromJSON(a,b,b.canvas_model))})},Wa.CanvasSaver=function(){var a={};return a.serialize=function(a){var b={};b.save_id=Wa.uid(),b.version=Wa.version,b.options=Wa.object.extendChanged({},a.options,Wa.ui.CanvasFactory.defaultOptions),b.options.mode_btns&&(b.options.mode_btns=b.options.mode_btns.filter(function(a){return"mode"===a.group}),b.options.mode_btns.forEach(function(a,b){0===b?a.state=!0:a.state=!1})),b.linkCoordinator=Wa.LinkCoordinator;var c=a.model.elements(),d=a.model.paths();return b.objects=c,b.paths=d,b},a.save=function(b){var c=a.serialize(b);localStorage.setItem("GM_save",JSON.stringify(c))},a.share=function(b,c,d){var e=a.serialize(c),f=[];e.objects.forEach(function(a){void 0!==a.imageData&&(a.save_id=Wa.uid(),f.push(JSON.stringify(a)),a.imageData=a.save_id)});var g=b+"_img_files";f.forEach(function(a){var b=new XMLHttpRequest;b.open("POST",g),b.setRequestHeader("Content-Type","application/json"),b.send(a)});var h=JSON.stringify(e);if(console.log("File size:",(h.length/1e3).toFixed(1),"KB"),h.length>2e6)return console.warn("(CanvasSaver) The data attempting to save is too large."),void(d&&d({reason:"File size too big ("+(h.length/1e6).toFixed(1)+" MB)."}));var i=new XMLHttpRequest;d&&(i.onreadystatechange=function(){4===this.readyState&&(200===this.status||301===this.status||302===this.status?d(null,save_file.save_id):d({reason:"Network or server error ("+i.status+").",status:i.status,statusText:i.statusText}))}),i.open("POST",b+"_save_files"),i.setRequestHeader("Content-Type","application/json"),i.send(h)},a.loadSaveFile=function(b,c,d,e){var f=new XMLHttpRequest,g=c+"_save_files/"+d,h=c+"_img_files/";f.onreadystatechange=function(){if(4===f.readyState&&200===f.status){for(var c=JSON.parse(f.responseText)[0],d=[],g=c.objects,i=g.length-1;i>=0;i--)void 0!==g[i].imageData&&(d.push(g[i]),g.splice(i,1));var j=a.load(b,c,e);d.length>0&&a.loadAllImages(j,d,h)}},f.open("get",g,!0),f.setRequestHeader("Content-Type","application/json"),f.send()},a.loadImage=function(a,b,c){var d=new XMLHttpRequest;d.onerror=function(){console.log("failed to load image.  Request:"),console.log(d)},d.onreadystatechange=function(){if(4===d.readyState&&200===d.status){var c=d.responseURL.lastIndexOf("/"),e=(d.responseURL.substring(c+1,d.responseURL.length),JSON.parse(d.responseText));if("undefined"!=typeof e[0]){b.imageData=e[0].imageData;var f={};Wa.loadFromJSON(JSON.stringify(b),f,a.model)}}};var e=b.save_id,f=c+e;d.open("get",f,!0),d.setRequestHeader("Content-Type","application/json"),d.send()},a.loadAllImages=function(b,c,d){for(var e in c)a.loadImage(b,c[e],d)},a.load=function(b,c,d){if(c||(c=a.loadLocalSaveFile()),!c)return void console.warn("(CanvasSaver) Attempted to load non-existant save.");var e=a.ensureBackwardsCompatibility(c),f=Wa.DerivationList.defaultOptions.row_transition_dur;Wa.DerivationList.defaultOptions.row_transition_dur=0;var g=Wa.extend(e.options,d),h=new Wa.ui.CanvasFactory(b,g);h.logger.listen(!1);var i={};Wa.loadFromJSON(JSON.stringify(e.objects),i,h.model),Wa.loadFromJSON(JSON.stringify(e.paths),i,h.model),Wa.LinkCoordinator=Wa.loadFromJSON(JSON.stringify(e.linkCoordinator),i),this.resolveActionIDsToObjects(h,i),this.initializeNodeMappings(),h.logger.listen(!0),Wa.DerivationList.defaultOptions.row_transition_dur=f,h.model.dls().forEach(function(a){a.options.row_transition_dur=f}),h.logger.canvas_logger.dlLoggers.forEach(function(a){a.initListeners()});var j=h.model.elements(),k=[],l=[];return j.forEach(function(a){"table"==a.type&&k.push(a),"ggb-element"==a.type&&l.push(a)}),k.forEach(function(a){a.graph&&l.forEach(function(b){a.graph==b.id&&(b.ggbApplet?a.setGraph(b):b.events.on("ggb_init",function(){a.setGraph(b)}))})}),h},a.ensureBackwardsCompatibility=function(a){var b={},c={options:1,linkCoordinator:1,objects:1,paths:1};for(var d in a)d in c&&"string"===a[d]?b[d]=JSON.parse(a[d]):b[d]=a[d];return b},a.loadLocalSaveFile=function(){return JSON.parse(localStorage.getItem("GM_save"))},a.makeID2ObjMap=function(a){for(var b={},c=a.model.dls(),d=0;d<c.length;d++)for(var e=c[d].rows,f=0;f<e.length;f++){var g=e[f];g.action&&(b[g.action.id]=g.action),g.model.for_each(function(a){b[a.id]=a})}return JSON.stringify(b)},a.loadDefaultOptions=function(a){var b=JSON.parse(a);for(var c in b)c+"Class"in Wa.ui?Wa.ui[c+"Class"].defaultOptions=b[c]:c in Wa&&(Wa[c].defaultOptions=b[c])},a.resolveActionIDsToObjects=function(a,b){a.model.dls().forEach(function(a){a.rows.forEach(function(a){a.action&&(a.action=b[a.action])})})},a.initializeNodeMappings=function(){Wa.LinkCoordinator.groups.forEach(function(a){0===a.deps&&a.nodes.forEach(function(a){if(a instanceof Wa.AlgebraModel){var b=a.children[0].get_mapping_to(a.children[0]);a.events.change(new Wa.AlgebraModel.ChangeEvent({model:a,no_anim:!0,node_map:b}))}})})},a.saveFileSizeIsTooBig=function(a){var b=JSON.stringify(a),c=Wa.byteLength(b);return c>5e5},a}(),Wa.DataLogger=xa,xa.console_logs=!1,xa.interaction_id=1,xa.prototype.setTrialInfo=function(a){a.id!==this.trial_id&&(xa.interaction_id=1),this.trial_id=a.id},xa.prototype.listen=function(a){this.listening=!!a},xa.prototype.logInteractionWithEvents=function(a,b,c){this.trial_id||this.createMissingTrial(),a.trial_id=this.trial_id,a.interaction_id=xa.interaction_id,a.canvas_id=this.canvas.id,b.forEach(function(a,b){a.trial_id=this.trial_id,a.interaction_id=xa.interaction_id,a.within_interaction_id=b+1},this),c&&(b=c(b)),xa.console_logs&&console.log(a,b),this.listening&&(this.emitReleventSummaryEvents([a]),Wa.ServerComm.postInteractions([a].concat(b))),xa.interaction_id++},xa.prototype.logInteraction=function(a){this.trial_id||this.createMissingTrial(),a.trial_id=this.trial_id,a.interaction_id=xa.interaction_id++,a.canvas_id=this.canvas.id,xa.console_logs&&console.log(a),this.listening&&(this.emitReleventSummaryEvents([a]),Wa.ServerComm.postInteractions([a]))},xa.prototype.logCustomInteraction=function(a,b){this.trial_id||this.createMissingTrial();var c={trial_id:this.trial_id,interaction_id:xa.interaction_id++,canvas_id:this.canvas.id,type:"custom",subtype:a,time:Date.now()};Wa.extend(c,b),xa.console_logs&&console.log(c),Wa.ServerComm.postInteractions([c])},xa.prototype.createMissingTrial=function(){console.warn("Should start a trial before logging data! Auto-created a trial."),Wa.TrialLogger.startTrial(),Wa.TrialLogger.postTrial()},xa.prototype.emitReleventSummaryEvents=function(a){var b=a.filter(function(a){return"interaction"===a.type});b.length>0&&this.events.interaction(b)},xa.prototype.simulateStartOfInteraction=function(a,b){var c={type:"start-of-interaction",source:a,time:Date.now()};b&&(c=Wa.extend(c,b)),this.canvas_logger.startOfInteractionDetected(c)},xa.prototype.simulateEndOfInteraction=function(a,b){var c={type:"end-of-interaction",source:a,time:Date.now()};b&&(c=Wa.extend(c,b)),this.canvas_logger.endOfInteractionDetected(c)},Wa.GMEventRecorder=ya,ya.prototype.showPreview=function(){var a=Wa.extend({},this.event_log.options);a.interactive=!1,this.dl&&this.dl.removeElement(),this.dl=new Wa.DerivationList(null,this.div.node(),a)},ya.prototype.replay=function(a,b,c){function d(){f.event_log.events.length>0&&d3.timer(e,a||0)}function e(a){if(f.stop_timer)return!0;for(var c=f.dl.getLastView();g[i].time-h<a;){var d=g[i];if(d.action&&d.followup&&g[i+1]&&d.followup===g[i+1].action&&(i++,d=g[i]),d.action?c.model.to_ascii()!==d.newTree&&(f.triggerDelayedAction(c,d.action)&&c.model.to_ascii()===d.newTree?console.info("Triggered delayed action."):(console.warn(d,"Replay out of synch, forcing correct state. Expected: "+d.newTree+"; Actual: "+c.model.to_ascii()),f.abortCurrentStateAndResetInteraction(c,d.newTree))):("touch"!==d.type||d.finger||(d.finger=d.fingers[d.fingers.length-1]),c.interaction_handler["on_"+d.type](d),"keyup"===d.type&&f.updateKey(d.keyCode,!1),"keydown"===d.type&&f.updateKey(d.keyCode,!0)),i++,i===g.length)return b(),!0}}this.event_log.gm_options&&Wa.object.extend(Wa.options.actions,this.event_log.gm_options);var f=this;if(!this.event_log)return void console.warn("set the event log before replaying!");var g=this.event_log.events;if(g.length>0)var h=c?c:g[0].time,i=0;this.stop_timer=!1,this.dl&&this.dl.removeElement(),this.dl=new Wa.DerivationList(null,this.div.node(),this.event_log.options,d)},ya.prototype.triggerDelayedAction=function(a,b){var c=a.interaction_handler.active_handler;if(!(c&&c instanceof Wa.DragHandler))return!1;for(var d=0;d<c.actions.length;d++){var e=c.actions[d];return e.name===b&&(!!e.timeoutID&&(c.clearActionTimeout(e),c.performAction(e),!0))}return!1},ya.prototype.abortCurrentStateAndResetInteraction=function(a,b){a.model.parseAndSet(b),a.interaction_handler.abort_interaction(),a.bindToModel(a.model),a.enter_and_exit("normal"),a.enter_and_exit("shadow")},ya.prototype.updateKey=function(a,b){console.log(a);var c=this.div.select("#key"+a);0===c.size()&&(c=this.div.append("span").attr("id","key"+a).classed("key-vis",!0).style("opacity",1e-5).style({position:"absolute",bottom:"5px",right:"10px",padding:"1px 7px",border:"2px solid steelblue","border-radius":"10px",color:"steelblue",background:"white"}).text({32:"space",16:"shift"}[a]||"")),b?c.style("opacity",1):c.transition().duration(750).style("opacity",1e-5)},ya.prototype.stop_animation=function(){this.stop_timer=!0},ya.prototype.createAndRecordDL=function(a,b){var c=new Wa.DerivationList(null,a,b);this.recordDL(c)},ya.prototype.recordDL=function(a){this.event_log={options:Wa.object.extendChanged({},a.options,Wa.DerivationList.defaultOptions),gm_options:Wa.options.actions,events:[]},this.dl=a;var b=this.dl.getLastView(),c=this.log.bind(this);this.registerListeners(b,c);var d=this;return a.options.no_history?a.getLastModel().events.on("change",d.logAction.bind(this)):a.events.on("added_line",function(e){d.logAction(e),a.getLastView()!==b&&(b=a.getLastView(),d.registerListeners(b,c))}),this.event_log},ya.prototype.liveReplay=function(a,b){this.other_dl=new Wa.DerivationList(null,a,b)},ya.prototype.log=function(a){this.event_log.events.push(a),this.other_dl&&this.other_dl.getLastView().interaction_handler["on_"+a.type](a)},ya.prototype.logAction=function(a){a&&this.event_log.events.push({type:"action",action:a.action.name,followup:!!a.action.followup&&a.action.followup.name,newTree:a.action.newTree.to_ascii(),time:Date.now()})},ya.prototype.registerListeners=function(a,b){a.interaction_handler.events.on("touch",b).on("release",b).on("drag_start",b).on("drag",b).on("drag_end",b).on("tap",b).on("dbltap",b).on("keydown",b).on("keyup",b)},Wa.EventRecorder=ya,Wa.ServerComm=new za,Wa.setupLogging=function(a){a||(a={}),Wa.ServerComm.setExperimentID(a.experiment_id),Wa.ServerComm.setEnabled("enabled"in a?a.enabled:"auto"),a.server&&Wa.ServerComm.setServerUrl(a.server),Wa.ServerComm.log_to_console=a.log_to_console},za.prototype.setExperimentID=function(a){if("string"!=typeof a)throw"Invalid experiment ID.";if(!a.match(/^\w+$/))throw"Invalid experiment ID.";this.trial_collection=a+"_trials",this.data_collection=a+"_data",Wa.TrialLogger.experiment_id=a},za.prototype.setServerUrl=function(a){this.server_url=a},za.prototype.setEnabled=function(a){a?"auto"===a?this.posting=!window||!window.gmath_log_ga||gmath_log_ga.enabled():this.posting=!0:this.posting=!1,console.info("interaction logging is",this.posting?"on":"off")},za.prototype.postTrial=function(a){this.postToServer(this.trial_collection,a)},za.prototype.postInteractions=function(a){this.postToServer(this.data_collection,a)},za.prototype.postToServer=function(a,b){if(this.log_to_console&&console.log("logging",b),this.posting){var c=JSON.stringify(b);if(this.dataIsTooBig(c))return void console.warn("Data chunk size is too big: not saved.");var d=new XMLHttpRequest;d.open("POST",this.server_url+"/log/"+a),d.setRequestHeader("Content-Type","application/json"),d.onreadystatechange=function(){4==d.readyState&&200==d.status,4==d.readyState&&200!==d.status},d.send(c)}},za.prototype.dataIsTooBig=function(a){var b=Wa.byteLength(a);return b>5e4},Wa.svg_play_button=Aa,Wa.TrialLogger=new Ba,Ba.prototype.addTrial=function(a,b){var c={id:Wa.uid(),idx:a||0,gm_version:Wa.version,gm_ui_version:Wa.ui.version,gm_ui_gm_version:Wa.ui.gm_version,experiment_id:this.experiment_id,time:Date.now()};return Wa.extend(c,b),this.active_trials.push(c),c},Ba.prototype.startTrial=function(a,b){this.trial&&this.endTrial();var c=this.addTrial(a,b);this.trial=c,this.events.start_trial(c)},Ba.prototype.setCustomFields=function(a){Wa.extend(this.trial,a)},Ba.prototype.endTrial=function(a){this.trial.duration=Date.now()-this.trial.time,a&&this.setCustomFields(a),this.events.end_trial(this.trial),this.postTrial(this.trial),Wa.array.remove(this.active_trials,this.trial),this.trial=null},Ba.prototype.resumeTrial=function(a){this.trial=Wa.find(this.active_trials,function(b){return b.id===a}),this.events.start_trial(this.trial)},Ba.prototype.postTrial=function(){Wa.ServerComm&&Wa.ServerComm.postTrial(this.trial)},Ba.prototype.postAllTrials=function(){Wa.ServerComm&&Wa.ServerComm.postTrial(this.active_trials),this.active_trials=[]},Eb={},Wa.Timeline=Eb,Eb.entryTypes={},Eb.entry=function(a,b){a=a[0];for(var c in Eb.entryTypes){var d=Eb.entryTypes[c];if(d.prototype.match(a))return new d(a,b)}return null},Fb=function(a){this.type=a},Fb.prototype.match=function(a){return this.type===a.subtype},Gb=function(a,b){Fb.call(this,a.subtype),this.summary=a,this.object=b.getElementByID(this.summary.el_id)},Wa.inherit(Fb,Gb),Gb.prototype.type="rewrite",Eb.entryTypes.AlgebraEntry=Gb,Gb.prototype.undo=function(a){for(this.rows=[],this.packState=this.object.rows.map(function(a){return!!a.hidden});this.object.getLastRow().idx!==this.summary.el_subid;)this.rows.push(this.object.undo())},Gb.prototype.redo=function(a){for(var b=this.rows.length-1;b>=0;b--)this.object.redo(this.rows[b]);for(var b=0;b<this.object.rows.length;b++){var c=this.object.rows[b];this.packState[b]&&!c.hidden?c.hide():!this.packState[b]&&c.hidden&&c.unhide()}this.object.layoutRows()},Hb=function(a,b){Fb.call(this,a.subtype),this.summary=a,this.objects=[],this.objects.push(b.getElementByID(this.summary.el_id))},Wa.inherit(Fb,Hb),Hb.prototype.type="create",Eb.entryTypes.CreateEntry=Hb,Hb.prototype.match=function(a){return this.type===a.subtype&&("derivation"===a.el_type||"textbox"===a.el_type||"image"===a.el_type)},Hb.prototype.undo=function(a){for(var b=0;b<this.objects.length;b++)a.removeElement(this.objects[b])},Hb.prototype.redo=function(a){for(var b=0;b<this.objects.length;b++)a.addElement(this.objects[b])},Ib=function(a,b){Fb.call(this,a.subtype),this.summary=a,this.object=b.getDeletedElementByID(this.summary.el_id)},Wa.inherit(Fb,Ib),Ib.prototype.type="delete",Eb.entryTypes.Entry=Ib,Ib.prototype.match=function(a){return this.type===a.subtype&&("derivation"===a.el_type||"textbox"===a.el_type||"image"===a.el_type)},Ib.prototype.undo=function(a){a.addElement(this.object)},Ib.prototype.redo=function(a){a.removeElement(this.object)},Jb=function(a,b){Fb.call(this,a.subtype),this.summary=a,this.object=b.getElementByID(this.summary.el_id)},Wa.inherit(Fb,Jb),Jb.prototype.type="draw",Eb.entryTypes.DrawEntry=Jb,Jb.prototype.undo=function(a){a.removePath(this.object)},Jb.prototype.redo=function(a){a.addPath(this.object)},Kb=function(a){Fb.call(this,a.subtype),this.summary=a},Wa.inherit(Fb,Kb),Kb.prototype.type="erase",Eb.entryTypes.EraseEntry=Kb,Kb.prototype.undo=function(a){return this.modification?(this.modification.removed.forEach(function(b){a.addPath(b)}),this.modification.added.forEach(function(b){a.removePath(b)}),void this.modification.modified.forEach(function(b){b.path.points=b.points_before,a.updatePath(b.path)})):void console.warn("erase modification was not set")},Kb.prototype.redo=function(a){this.modification.removed.forEach(function(b){a.removePath(b)}),this.modification.modified.forEach(function(b){b.path.points=b.points_after,a.updatePath(b.path)}),this.modification.added.forEach(function(b){a.addPath(b)})},Lb=function(a,b){Fb.call(this,a.subtype),this.summary=a,this.object=b.getElementByID(this.summary.el_id)},Wa.inherit(Fb,Lb),Lb.prototype.type="move",Eb.entryTypes.MoveEntry=Lb,Lb.prototype.match=function(a){return this.type===a.subtype&&("derivation"===a.el_type||"textbox"===a.el_type||"image"===a.el_type)},Lb.prototype.undo=function(a){this.object.translateElement(JSON.parse(this.summary.old_state))},Lb.prototype.redo=function(a){this.object.translateElement(JSON.parse(this.summary.new_state))},Mb=function(a,b){Fb.call(this,a.subtype),this.summary=a,this.object=b.getElementByID(this.summary.el_id)},Wa.inherit(Fb,Mb),Mb.prototype.type="pack",Eb.entryTypes.PackEntry=Mb,Mb.prototype.match=function(a){return this.type===a.subtype&&!this.startingAndEndingPackStateAreTheSame(a)},Mb.prototype.startingAndEndingPackStateAreTheSame=function(a){for(var b=a.old_state,c=a.new_state,d=0;d<b.length;d++)if(b[d]!==c[d])return!1;return!0},Mb.prototype.undo=function(a){for(var b=this.object.rows,c=this.summary.old_state,d=0;d<b.length;d++)b[d].hidden&&!c[d]?b[d].unhide():!b[d].hidden&&c[d]&&b[d].hide();this.object.layoutRows()},Mb.prototype.redo=function(a){for(var b=this.object.rows,c=this.summary.new_state,d=0;d<b.length;d++)b[d].hidden&&!c[d]?b[d].unhide():!b[d].hidden&&c[d]&&b[d].hide();this.object.layoutRows()},Nb=function(a,b){Fb.call(this,a.subtype),this.summary=a,this.object=b.getElementByID(this.summary.target_id)},Wa.inherit(Fb,Nb),Nb.prototype.type="clone",Eb.entryTypes.CloneEntry=Nb,Nb.prototype.undo=function(a){this.links=a.removeElement(this.object)},Nb.prototype.redo=function(a){a.addDL(this.object),Wa.LinkCoordinator.addLinks(this.links)},Ob=function(a,b){Fb.call(this,a.subtype),this.summary=a,this.object=b.getElementByID(this.summary.el_id)},Wa.inherit(Fb,Ob),Ob.prototype.type="scrub",Eb.entryTypes.ScrubEntry=Ob,Ob.prototype.undo=function(a){var b=this.object.rows[0].model;b.replace_with(new Wa.AlgebraModel(this.summary.old_state,b.options));this.object.rows[0].updateDimensionAfterInteraction(),this.object.updateDims(),this.object.rows[0].view.update_existing()},Ob.prototype.redo=function(a){var b=this.object.rows[0].model;b.replace_with(new Wa.AlgebraModel(this.summary.new_state,b.options));this.object.rows[0].updateDimensionAfterInteraction(),this.object.updateDims(),this.object.rows[0].view.update_existing()},Pb=function(a,b){Fb.call(this,a.subtype),this.summary=a,this.textbox=b.getElementByID(this.summary.el_id)},Wa.inherit(Fb,Pb),Pb.prototype.type="edit",Eb.entryTypes.TextEditEntry=Pb,Pb.prototype.match=function(a){return this.type===a.subtype&&"textbox"===a.el_type},Pb.prototype.undo=function(a){this.textbox.setText(this.summary.old_state)},Pb.prototype.redo=function(a){this.textbox.setText(this.summary.new_state)},Qb=function(a,b){Fb.call(this,a.subtype),this.summary=a,this.canvasElement=b.getElementByID(this.summary.el_id)},Wa.inherit(Fb,Qb),Qb.prototype.type="resize",Eb.entryTypes.ResizeEntry=Qb,Qb.prototype.match=function(a){return this.type===a.subtype},Qb.prototype.undo=function(a){this.canvasElement.resizeElement(JSON.parse(this.summary.old_state))},Qb.prototype.redo=function(a){this.canvasElement.resizeElement(JSON.parse(this.summary.new_state))},Rb=function(a){return Math.sqrt(a[0]*a[0]+a[1]*a[1])},Sb=1e-6,Tb=function(a,b,c){var d=[b[0]-a[0],b[1]-a[1]],e=Rb(d);if(e<Sb)return a;var f=[c[0]-a[0],c[1]-a[1]],g=(d[0]*f[0]+d[1]*f[1])/e;return g<0?a:g>e?b:[a[0]+d[0]*g/e,a[1]+d[1]*g/e]},Wa.ui=Wa.ui||{},Wa.ui.CanvasController=function(){var a=function(a){function b(a){var b=a||d3.event;27===b.keyCode&&(P?T.cancelInsertElementOnNextClick():(p.setActive(),p.setActive(null,!1)))}function c(a){"arrange"===a.mode&&p.setActive(null),"draw"===a.mode||"erase"===a.mode?(p.foreground_event_layer_visible(!0),p.setActive(null)):p.foreground_event_layer_visible(!1)}function d(a,b){a.call(b),b.frame(a.node())}function e(){if("hold"===N)var a=Wa.mtouch_events().on("touch",fa.bind(this,null)).on("hold",ga.bind(this,null)).on("drag",ha.bind(this,null)).on("tap",function(){p.setActive(null)}).on("release",ia.bind(this,null)).hold_max_dist(5).hold_time(500).call(F);else if("tap"===N)var a=Wa.mtouch_events().on("tap",function(){M&&(K.visible?ia():(ga(),K.element.attr("pointer-events","none")))}).hold_max_dist(5).hold_time(500).call(F);return a}function f(){var a=Wa.mtouch_events().on("touch",ja.bind(this,null)).on("drag",ka.bind(this,null)).on("release",la.bind(this,null)).hold_max_dist(5).hold_time(500);return a}function g(a){r.pop(),s--}function h(){var a=d3.event;a.preventDefault();var b=d3.mouse(this),c=i(a.dataTransfer)||j(a.dataTransfer);if(c)if("http"===c.slice(0,4)){var d={drop_evt:a,pos:{x:b[0],y:b[1]}};p.createImage(d,"drag-n-drop")}else{c=c.replace(/\\end{alignat}/g,""),c=c.replace(/\&\\\,/g,""),c=c.replace(/\\\,/g,""),c=c.replace(/\&/g,""),c=c.replace(/\\begin{alignat}{[0-9]*}/g,""),c=c.replace(/\\\;/g,""),c=c.replace(/[.,\s\\]+$/,"");var e=c.split("\\\\");if(0===c.length)return;try{n["start-of-interaction"]({type:"start-of-interaction",source:{type:"CanvasController",id:o},time:Date.now()}),p.createDLs(e,{pos:{x:b[0],y:b[1]}},null,"drag-n-drop"),n["end-of-interaction"]({type:"end-of-interaction",source:{type:"CanvasController",id:o},time:Date.now()})}catch(c){console.log("Could not parse equation!",c);var d={drop_evt:a,pos:{x:b[0],y:b[1]}};p.createImage(d,"drag-n-drop")}}else{console.log("could not parse drop data",a);var d={drop_evt:a,pos:{x:b[0],y:b[1]}};p.createImage(d,"drag-n-drop")}}function i(a){var b=a.getData("text/html"),c=document.createElement("div"),d=d3.select(c).html(b).select("img");return 1===d.size()?d.attr("alt"):null}function j(a){return a.getData("text/plain")}var k,l,m,n=d3.dispatch("scroll","start_hwr","stop_hwr","undone","redone","hold","touch","drag","release","font_size","keyboard","entered_term","start-of-interaction","end-of-interaction","undoable-action"),o=Wa.uid(),p=a,q=null,r=[],s=-1,t=null,u=!1,v=null,w=!1,x=!0,y=1500,z=null,A=p.paths().length,B=2,C=50,D=null,E="black",F=null,G=0,H=null,I=null,J=!1,K=null,L=!0,M=!0,N="hold",O=["derivation","textbox","graph"],P=null,Q=800,R=!1,S=!0,T=function i(){
return a.on("create."+o,function(a){"derivation"!==a.target_type&&"graph"!==a.target_type&&"textbox"!==a.target_type&&"image"!==a.target_type||(a.target.events.on("start-of-interaction."+o,function(a){p.setActive(),n["start-of-interaction"](a)}),a.target.events.on("end-of-interaction."+o,function(a){n["end-of-interaction"](a)}),"derivation"===a.target_type&&a.target.events.on("auto_undo."+o,function(a){setTimeout(function(){g(a)},1)}))}),F=Z().allow_rotate(!1).allow_scale(!1).one_finger_drag(!1).on("transform",function(){p.scroll(-d3.event.transform.translate[1])}),M&&!K&&p.container()&&(K=new Wa.ui.holdUI(i,p)),d(a.background_event_layer(),e()),d(a.foreground_event_layer(),f()),a.on("mode."+o,c),d3.select(document).on("keydown."+o,b.bind(this,null)),window.addEventListener("beforeunload",function(a){if(S&&R){var b="You have not saved your work. Are you sure you want to leave the page?";return(a||window.event).returnValue=b,b}}),L&&"undefined"!=typeof Wa.ui.Keyboard&&"undefined"!=typeof $&&(v=Wa.ui.Keyboard(),v.width(Q).position("center")()),p.container().on("dragover",function(){d3.event.preventDefault()}).on("drop",h),this};T.askConfirmationOnClosing=function(a){return 0===arguments.length?S:(S=a,this)},T.insertElementOnNextClick=function(a,b,c){T.simulateStartOfInteraction(),p.foreground_event_layer_visible(!0),P={type:a,options:b||{},callback:c},p.foreground_event_layer().style("cursor","copy");var d={derivation:"math expression",textbox:"text",ggb:"graph"}[a]||"object";p.showNotice("Click where you want to insert the "+d+".",!0)},T.cancelInsertElementOnNextClick=function(a){P&&(P=null,"draw"!==p.getMode()&&"erase"!==p.getMode()&&p.foreground_event_layer_visible(!1),p.foreground_event_layer().style("cursor","auto"),p.hideNotice(),a&&T.simulateEndOfInteraction())};var U=function(a){var b=!1;switch(P.options.pos=a,P.type){case"derivation":P.options.eq?(p.createDL(P.options),b=!0):T.inputDL([a.x,a.y],"toolbar");break;case"textbox":p.createTextBox(P.options),b=!0;break;case"graph":p.createGraph({pos:a}),b=!0;break;case"ggb":V(a),b=!0;break;case"ggb-table":W(a),b=!0;break;case"table":p.createElement("table",{pos:a}),b=!0;break;default:console.warn("unknown element type",P.type)}P.callback&&P.callback(a),T.cancelInsertElementOnNextClick(b)},V=function(a){var b=600,c=400,d=p.createElement("ggb-element",{pos:{x:a.x-b/2,y:a.y-c/2},size:{width:b,height:c}});p.createElement("ggb-panel",{ggbElement:d,pos:{x:a.x+b/2,y:a.y-c/2},size:{width:75,height:c},min_size:{width:75,height:50}})},W=function(a){var b=600,c=600,d=p.createElement("ggb-element",{pos:{x:a.x-b/2,y:a.y-c/2},size:{width:b,height:c},ggb_params:{showMenuBar:!1,showAlgebraInput:!1,showToolBar:!0,customToolBar:"0|40",showResetIcon:!1,enableLabelDrags:!1,enableShiftDragZoom:!1,enableRightClick:!1,errorDialogsActive:!1,useBrowserForJS:!0,preventFocus:!1,language:"en"},ggb_base64:"UEsDBBQACAgIALyC9kgAAAAAAAAAAAAAAAAWAAAAZ2VvZ2VicmFfamF2YXNjcmlwdC5qc0srzUsuyczPU0hPT/LP88zLLNHQVKiu5QIAUEsHCEXM3l0aAAAAGAAAAFBLAwQUAAgICAC8gvZIAAAAAAAAAAAAAAAAFwAAAGdlb2dlYnJhX2RlZmF1bHRzMmQueG1s7ZpLb9s4EIDP219B6NQ9xJZky3aCOEVaYLEB0nSxCYq90tJY5oYitSIVy/n1S5F6OX7UVtzEbXMxOfTw9c1wSFE6/5BFFD1AIghnY8vp2BYC5vOAsHBspXJ6MrI+XLw7D4GHMEkwmvIkwnJseblmVU9JHdfr5WUoE+SM8RscgYixD7f+DCJ8zX0stepMyvis253P552y0Q5Pwm4Yyk4mAgupATExtorMmWpuqdK8p9Vd23a6/3y+Ns2fECYkZj5YSA02gClOqRQqCxQiYBLJRQxja5oyPx/FzVecWIjiCdCxxVJKLVTUGVsDz7p499u5mPE54pN/wVdlMkmh0tdCN9dRf3/ilCcoGVuu3beQQqYITPQvpvEMq1xn6BltiheQoAdM8791CU4l93UDunSKqYBSV3X1mQdg/ukX+oxEmiISEmJlLQuJGCDQOTND1XGsOtLWq9o77xYYVoBQImQ1sWstVCCcnr1KwrS5HYWtQTj2UxQnuXdp7UlYc/M8ra7TSZEWFfL8K6NT7REGt3JBAckZ8e8ZCOWcbqNSnvmTBAHk68fUiTlh8pY8FmPwmqW6KV184mw3TszpIuSsov1XKVcmGhoLtRnivv7teD1tJ89ZcXDntY20HWFOZ4mhKaghOi8G0d4QIuxjJqictoFPSej9NAH4vRkq1kSKPXE01/3LAnHWr3uf8yQQKBtbN/jGQosifTTpHsvcbgE4gBiY8jS5RNlpRXkw0pjzZGKSHxtz71CYvzRDqeO2guu4ZvvS6ZsbL/G9Yn9DSJY2LKf3RvnAlJe9uP9LBmKtYiiK/Hds+TyKKWQHRE+5n4r6rGykCvzo+TvgUR0I8p4yQglOFqs97X1S2vYA0jicXS8fzNyfjukOrtzmGAr/sSXnJ8r3iU/kdvQCwlyqaN6Wcm2AdgeOX88APJU07+uKSUgE6DsGsTKZe4D4TlX+wu4SzER+k2J0SoybbbXLxYXbbm/dHPvdV3/6/jaQjTCevxEemeseMuomeLFt2be7ATtidj/qsn9QbfJ6wX8txMpS627o3iy1xlJrDog4kSAIZtstICGrd8g7LTRuPY4S/+bJ+JwRvxrcJyNV0+kf5Wxe+uoWSAjMrDuBUGYX70QWtpkTeixLMqcoWThFyWOR0e2oISckQ5dlvctS/dItM70y0y8zXgNcu0OdNnGsfLsR358EjX67U90xXwD/xKZ+gV1GMQ9r618ZqXHraOLClKgBMhypCqZHwj5i/z5MeMqCleEcJoo4rx9FNmNjaQRJI57elHKFzjPk1DDS8o6hnNAuEdT51kwFJYHCEhHl0yfq5B7hLL/dQHgiOE0l3PoJAKtfvRo7zEkgZ/nTtXbErHTtIp2SLIdiVGc8IY+cycqPUG7XS6rf2jZN2Wb5PbVIPuHn2gSzkNaudmmk2h7mjlcrPb34WW+mJmG7ADzouKOeM/J69tAZnnqjwY7AndEBgR/spewBo/deTuAWfSR+42bf3uQZ9mjoDgb9geudng6dQX/4bE+ZcE4B18+PH0u58UZgZfluCnC7G+A7npP8Gfj3E54tedR+D9F/VAX15xCvcypshJaXOCn0dn2O7ja+LemW369c/A9QSwcILVCearIEAABGIwAAUEsDBBQACAgIALyC9kgAAAAAAAAAAAAAAAAXAAAAZ2VvZ2VicmFfZGVmYXVsdHMzZC54bWztl8lu2zAQhs/NUxC8R6uVDVYCIz20QBK0yKVXmhrLbCVSIelFebW+Q5+pFEU6yuIUNVy0BXIxh8PhkPp+ciSPL9Z1hZYgFRM8x3EQYQScioLxMscLPTs8wRfnB+MSRAlTSdBMyJroHGdd5Gae6QVJlnY+tFbsjIsbUoNqCIVbOoeaXAlKtA2da92cheFqtQp80kDIMixLHaxVgZHZEFc5dsaZSfdo0iq14UkUxeGX66s+/SHjShNOASOz2QJmZFFpZUyooAaukW4byHFTEQ6pWaMiU6hy/Mn232PkZuQ4NXnx+cG7sZqLFRLTr0CNV8sFbCbZTtjFmOFLUQmJZI5PTzEyxJLYtFPXkqqZkxxHQdbHV6QFiZbEJIl6D1loQW0K652RSoGPNYtdiwL6kVHvpULIQqF1l9Swbl1779pV39rQGek0dKsFscvKONzqtgKk54x+46BUtxeHxxkfWFFAdxi6OePQIXwGkwrO6ADmR67NcTC8jMyILuQShlzjbDeuSZZZsHFybMFGA6zxvrASzmp7PJHS0HRPjlQDUFhrw8acntZei2G+l4AmrwF9NwZWAl8aAEIqc10id+3ayKvpPevY6xw7z70zbB6zZcnWaOLnTXz4JPFG6o2RN7LBEYE73u9ddb85ZnVTMcr067qTNVMD2Sdd99EViqN0J6kjK3T0TOboP5X5Cd2GSFMTjWTUrNHbYJ76x/dfXLPuJlEiNShG+AD8ZTfwlPzRG/ntKBtRtXMopOAPb4CB64Fj6l4Cu8j+u+zjLLX0s/gZ/tHfxr8d5d2CFPYku2f77PtDiPFuFT8abTmOx3t7j/6psh1tL9v9kK/MrTfukz1VdDQ58saxN068cbq5zdslVQs5M99rL5UaN/RY3dE/q+6eq028W7XhoDcsbjp7CC97qy9P4IWDr/bQ/zM4/wlQSwcIDmF7u7sCAACgDAAAUEsDBBQACAgIALyC9kgAAAAAAAAAAAAAAAAMAAAAZ2VvZ2VicmEueG1s3Vptc9s2Ev6c/goMP92LJQEgQYoZKR3biXuZSZvMOe3c3De+QBJjimRJypY7/fG3C4AUJdmKaTs5ubZpkCCwwD7PYncBafLjepmSa1lWSZ5NLTakFpFZlMdJNp9aq3o2GFs/vvlhMpf5XIZlQGZ5uQzqqSWwZdsPnoZc2FiXxFPLphELPEcOZOi5AycM/YEfRs5gFvoeE44nZjPbImRdJa+z/JdgKasiiORltJDL4EMeBbUSuqjr4vVodHNzM2yGH+blfDSfh8N1FVsEpp5VU8vcvAZxW51ubNWcU8pG//n5gxY/SLKqDrJIWgTVWiVvfng1uUmyOL8hN0lcL6aW7/kWWchkvgA9PZ9ZZISNClC2kFGdXMsKunYelc71srBUsyDD96/0HUlbdSwSJ9dJLMupBWBRh/uU+sy3qXCY7VkkLxOZ1aZxM+ioETe5TuSNlot3akiH+tDvOqmSMJVTaxakFaiVZLMSIIUZlSt4rOrbVIZB2TxvJsRO1C80Sf6QKA3Y00hMrbHDTmzhn3iUnghB9Ww6QwvGLVLneaokU/InYURQuAjzyQlxPajhhAniQM0YajxiY51gDrEJNmE2cRwoHaxmLr4T0F9QwhhUE04J54Qzwm14FIIIlwgPO3Jo6/pKGIULW8N04LKxzrbhUnW2AxfHOxAktBiYhLBddSewNcgXHKevKu0xcXwYCCuEx4gNc4BnjxKQaKN4ppRwKME/RhwUzz3CxwTkgd4omfIDpJjnDSumYoeWhhTRJYUBGXi5cCm2dkhxtikBBijodoIF0wVO13X1K6rrqK0LrgtHF0K3cXR3RzfV2lJHt3Hsp6rZKGn3UXLcUZKhEkAKzl4VNsF5MzV/LBzz6OpHZWqUUVM7xn8+PgAm7ljdPFEn+1E6sc6oepX2GbQZ0nfHDx/yaTbaqsnvUpOLe9R8IrrNoEx0BoWx1J+69oa0e+m55yEfMaK7tQqf4p4fMbhH73QBumSmPATJs01qMmoC1sRMiFQLbGvsu5bLCqdo+23scNG7mwDi8U4AOcEQ4opNFMEYMt6KImLcCSUQR1ys9FRcgjEwEOiwwp0mspyY2PLnXmyBUOBsogFMDUWhnzHhAEbn3YDAwXlw4qEfheiGfoRwEMkJxBEX+90TKyxS5FXS4rqQadESoiBMsmJVG9hMfbSMGwjrHJoHqcqLTIc4j67OdpCWQVU399AIMopN4qIzjK285tUkDUKZQvp3iUZAyHWQoh0r+bM8q0ljANxS4lQKNZGrKE3iJMh+A9abdOWX1TKUJVG3OeqohGB30uZa6LPaXIvaukmU52V8eVuBkZD1f2UJnR0PctPuD8B3q1/ZXAz9zg9IrKIArdvxt174Y+x03zs9tLy+lHUN6lckWMuqQW5e4vIyJODD++osTzdVRZ5k9XlQ1KtSZc7gIEtU6jSbp1IhqTiGFDS6CvP1pXaerpb1+baQLcbh/DxP85LA4uNCQANThrpUbXBmbSuq2lDVwshAoe175nPVQpWhLlUrIFlPzWjKGjVpM0pSEf28ZVHKQDCfXWVJ/aF5qJPoaqMottf0NxBui2TPJHIy2rG8yZUsM5lqK8qAyFW+qrQRa6rUPFaV/BTUi9Ms/recwwL8FKD7q0G0brqZcSyjZAkddb1BLkBWf4Wp6tpYzkvZaKgXpMbVrB1SFaUM4mohZd2iq22822wj+qLMl++z689gQjtTn4wa/SZVVCYFWioJwT9fyY0xxkkVgHePu/0AjAq0itDdALA1gmqRYFUv8lLtTYIaa3Apr2G2Fe7rNC1kai3BjazB2wzU+pzIVC5hq0JqZbfZainLJGpJXKptEEx7ZTQb4L5QL32gkOThF/A2m/iue20Qh/f32DYJ0mIR4PbJuJI0uEX/0oFPSfs5j83QrAEVOFSag0sptDUVUmo7rM3qIwWIU4u3g7ZR9W5YQgMLfwAq4S4q/K8ICgQkg8ktmZK/Lck/yPrv5J8kbCSiz9FxaBsuXd/K2MNly00YkOQ1bnkeDA99IDzd9VmRNfhyPNa4NYcjf4A9t9RtPGi9AF8FO/VKZdYtenjzrySOZdbCLn/PdJdKezZAK02ipN6FNsqXyyCLSabysk8YX6xNUhBQhEnrvqqbmlMtxHTdA1kFqRbF032Ut61vH2ZwInGiTQa6fTS9yn0OGNeRS5Umcj2UiY+zWSVrBH6sYWeHaHqAFbO7rLhLMPBpq6EGzpD6imPWTFJhhuFajyq6tTvO+6nsnfVh76z3GvmLkseGtnA0e8Cjy78BfR9LiJLzPAvSD+imtnk8A2zY1FqfQmqzR2l0mNItrxd9bT32iwaPdncDZvwdNf5OI/xsDi9ZPsThHcT89BDmcQ/M42PFXLmkI4T89k7IZQ/I5bFATg3kgzauK+9/TKCfHQJ91gP02fGCrp32d0b9fYZ7PcBhB3B5CPDzPvH5/EGI35fD4qnIXBehLp4T+69mOfajwuR9oM4Ogfq2D6hvjxjUrycfz4tqdCgGvuuD6rujQ7WT022SkO8BanwI1Is+oF4cHaibXc63wfRSzrF+B9FzjejbPTTnh9GsjLQGrvm32+80x6x949xmrzOwtbW6dzLB95wGUMHHW/kePXikIA7HQEA1xR1Sa9Wg9P6Z55WUBZ40f8w+l0FW4Rc5tg87+1L7TlN7sUftoh+1i29HbTeB6bONPbCMaJupu57ofoDgvVgi32oiz/aITPoRmXwfIp8lE21oNKFGbbk8n/nO+AB9dkMfPyr+jI893ePvSz/+vrxA/nRUA/rGQ5ty7+WR9+6+xXfVj7yrF0SeyZU78W/wclffxX2rL+1HYPqCCNQ7yC5/x7/8HnYI/1OfJP+nZ6Ks2KfsKYfwXz1nx88KH/MxiT02uzIxZIJ1k59nOXXfhjrM81QGWQtmsfsJ6ubM6v92sGW+zkFmyVrGdxvhYaXKl6nUqPt1AvUtIPMF7Tf/A1BLBwiaLk/eqggAAFEuAABQSwECFAAUAAgICAC8gvZIRczeXRoAAAAYAAAAFgAAAAAAAAAAAAAAAAAAAAAAZ2VvZ2VicmFfamF2YXNjcmlwdC5qc1BLAQIUABQACAgIALyC9kgtUJ5qsgQAAEYjAAAXAAAAAAAAAAAAAAAAAF4AAABnZW9nZWJyYV9kZWZhdWx0czJkLnhtbFBLAQIUABQACAgIALyC9kgOYXu7uwIAAKAMAAAXAAAAAAAAAAAAAAAAAFUFAABnZW9nZWJyYV9kZWZhdWx0czNkLnhtbFBLAQIUABQACAgIALyC9kiaLk/eqggAAFEuAAAMAAAAAAAAAAAAAAAAAFUIAABnZW9nZWJyYS54bWxQSwUGAAAAAAQABAAIAQAAOREAAAAA"});d.events.on("ggb_init",function(){d.ggbApplet.setCoordSystem(-10,10,-10,10),p.elements().forEach(function(a){"table"==a.type&&a.setGraph(d)})})};T.id=o,T.logger=function(a){q=a,q.events.on("interaction."+o,this.addInteractionSummaryToTimeline.bind(this))},T.model=function(){if(0===arguments.length)return p},T.use_keyboard=function(a){return 0===arguments.length?L:(L=a,this)},T.keyboard_max_width=function(a){return 0===arguments.length?Q:(Q=a,this)},T.use_hold_menu=function(a){return 0===arguments.length?M:(Array.isArray(a)&&T.hold_menu_options(a.filter(function(a){return O.indexOf(a)!==-1})),M=!!Array.isArray(a)||a,M&&!K&&p.container()&&(K=new Wa.ui.holdUI(T,p)),this)},T.hold_menu_options=function(a){return 0===arguments.length?O:void(O=a)},T.color=function(a){return 0===arguments.length?E:(E=a,this)},T.markerRadius=function(a){return 0===arguments.length?B:(B=a,this)},T.eraserRadius=function(a){return 0===arguments.length?C:(C=a,this)},T.hwr_delay=function(a){return 0===arguments.length?y:(y=a,this)},T.hwr=function(a){return arguments.length?x===a?T:(x=a,A=p.paths.length,x||T.cancelHWR(),T):x},T.drawing=function(a){return arguments.length?(k=a,this):k},T.scheduleHWR=function(){z||(z=setTimeout(T.performHWR,y),n.start_hwr())},T.cancelHWR=function(a){a||(A=p.paths.length),z&&(clearTimeout(z),z=null,n.stop_hwr())},T.performHWR=function(){if(z=null,n.stop_hwr(),!(A>p.paths().length-1)){var a=p.paths().slice(A),b=!1,c=[];gm_hwr_request(a,function(d,e){d&&console.log(d);var f=a[0].points[0];try{b=p.createDL({pos:{x:f[0],y:f[1]},eq:e})}catch(a){return}for(var g=function(a){try{p.removePath(a),c.push(a)}catch(a){return}},h=0;h<a.length;h++)g(a[h]);A=p.paths().length}),A=p.paths().length}},T.font_smaller=function(){var a=parseInt(oa.defaultOptions.font_size);a/1.2>12&&this.set_font_size(a/1.2)},T.font_larger=function(){var a=parseInt(oa.defaultOptions.font_size);1.2*a<160&&this.set_font_size(1.2*a)},T.set_font_size=function(a){oa.defaultOptions.font_size=a,p.dls().forEach(function(b){b.setFontSize(a)}),n.font_size(new ca(a))};var X=function(a){return p.createPath({points:[[a[0],a[1]-G]],color:"draw"===p.setMode()?E:"white",width:"draw"===p.setMode()?2*B:2*C})},Y=function(a){this.type="hold",this.subType=a.subType,this.performee=o,this.performee_type="CanvasController",this.time=Date.now(),this.finger={pos:[a.finger.pos[0],a.finger.pos[1]]},this.fingers=a.fingers.map(function(a){return{pos:[a.pos[0],a.pos[1]]}})},_=function(a){this.type="touch",this.subType=a.subType,this.performee=o,this.performee_type="CanvasController",this.time=Date.now(),this.finger={pos:[a.finger.pos[0],a.finger.pos[1]],pos0:[a.finger.pos0[0],a.finger.pos0[1]]},this.fingers=a.fingers.map(function(a){return{pos:[a.pos[0],a.pos[1]]}})},aa=function(a){this.type="drag",this.subType=a.subType,this.performee=o,this.performee_type="CanvasController",this.time=Date.now(),this.finger={pos:[a.finger.pos[0],a.finger.pos[1]]},this.fingers=a.fingers.map(function(a){return{pos:[a.pos[0],a.pos[1]]}})},ba=function(a){this.type="release",this.subType=a.subType,this.performee=o,this.performee_type="CanvasController",this.time=Date.now(),this.finger={pos:[a.finger.pos[0],a.finger.pos[1]]},this.fingers=a.fingers.map(function(a){return{pos:[a.pos[0],a.pos[1]]}})},ca=function(a){this.type="fontSize",this.performee=o,this.performee_type="CanvasController",this.time=Date.now(),this.font_size=a},da=function(a){this.type="enteredTerm",this.performee=o,this.performee_type="CanvasController",this.time=Date.now(),this.eq=a.eq,this.dl_id=a.id,this.options=Wa.deepCopy(a)},ea=function(){this.type="keyboard",this.performee=o,this.performee_type="CanvasController",this.time=Date.now()},fa=function(a){if(M&&!J){var b=a||d3.event;!a&&d3.event&&(n["start-of-interaction"]({type:"start-of-interaction",source:{type:"CanvasController",id:o},time:Date.now()}),n.touch(new _(Wa.extend(d3.event,{subType:"menu"})))),b.fingers.length>1&&(J=!0)}};T.menu_touch=fa;var ga=function(a){if(!(!M||J||L&&v.visible())){var b=a||d3.event;!a&&d3.event&&n.hold(new Y(Wa.extend(d3.event,{subType:"menu"}))),p.setActive(),l=b.finger.pos.slice(),K.setPos(b.finger.pos_client.slice()),K.setVisible(!0)}};T.menu_hold=ga;var ha=function(a){if(!J&&M&&K.visible){var b=a||d3.event;!a&&d3.event&&n.drag(new aa(Wa.extend(d3.event,{subType:"menu"}))),K.visible&&K.highlight(b.finger.pos_client.slice())}};T.menu_drag=ha;var ia=function(a){var b=a||d3.event;return!a&&d3.event&&n.release(new ba(Wa.extend(d3.event,{subType:"menu"}))),J?void(0===b.fingers.length&&(J=!1)):(K&&K.visible&&(K.performAction(b.finger.pos_client.slice(),l),K.setVisible(!1)),void(a||!d3.event||v&&v.visible()||n["end-of-interaction"]({type:"end-of-interaction",source:{type:"CanvasController",id:o},time:Date.now()})))};T.menu_release=ia;var ja=function(a){if(!P&&!H){var b=a||d3.event;if(!a&&d3.event&&(n["start-of-interaction"]({type:"start-of-interaction",source:{type:"CanvasController",id:o},time:Date.now()}),n.touch(new _(Wa.extend(d3.event,{subType:"draw"})))),b.fingers.length>1&&(J=!0),k&&!J){console.log(H);var c=b.finger.pos0.slice();c[1]-=G,T.cancelHWR(!0),H=X(b.finger.pos0),"erase"===p.setMode()&&(D=p.paths_container().append("circle").attr({cx:c[0],cy:c[1],r:C}).style({stroke:"silver",fill:"white"}))}}};T.draw_touch=ja;var ka=function(a){if(!P){var b=a||d3.event;if(!a&&d3.event&&n.drag(new aa(Wa.extend(d3.event,{subType:"draw"}))),H&&!J&&k){var c=b.finger.pos.slice();c[1]-=G,H.points.push(c),p.updatePath(H),"erase"===p.setMode()&&D.attr({cx:c[0],cy:c[1]})}}};T.draw_drag=ka;var la=function(a){var b=a||d3.event;return P?void U({x:b.finger.pos[0],y:b.finger.pos[1]}):J?void(0===b.fingers.length&&(J=!1)):void(!H||b.fingers.length>0||("draw"===p.setMode()?!x||v&&v.visible()||T.scheduleHWR():"erase"===p.setMode()&&(D.remove(),ma()),H=null,!a&&d3.event&&(n.release(new ba(Wa.extend(d3.event,{subType:"draw"}))),n["end-of-interaction"]({type:"end-of-interaction",source:{type:"CanvasController",id:o},time:Date.now()}))))};T.draw_release=la;var ma=function(){var a=p.paths().slice(),b=a[a.length-1],c=[],d=[],e=[];a.forEach(function(a,f){if(a!==b){var g=C+a.width/2,h=Ca([a.points],b.points,g);if(0===h.length)d.push(a),p.removePath(a);else{e.push({path:a,points_before:a.points.slice(),points_after:h[0].slice()}),a.points=h[0],p.updatePath(a);for(var i=1;i<h.length;i++){var j=p.createPath({points:h[i],color:a.color,width:a.width,oid:a.id});c.push(j)}}}}),p.removePath(b),m={removed:d,modified:e,added:c}};T.addInteractionSummaryToTimeline=function(a){R=!0,1===a.length&&"save"===a[0].subtype&&(R=!1);var b=Eb.entry(a,p);b&&("erase"===b.type&&(b.modification=m,m=null),s++,r[s]=b,r.length=s+1,n["undoable-action"](b.type))},T.reset=function(){q.listen(!1),p.reset(),r=[],s=-1,t=null,u=!1,F.transform({translate:[0,0]}),H=null,I=null,J=!1,R=!1,q.listen(!0)},T.undo=function(){if(s===-1)return!1;q.listen(!1);var a=r[s];return s--,a.undo(p,this),q.listen(!0),!0},T.redo=function(){if(r.length<=s+1)return!1;q.listen(!1),s++;var a=r[s];return a.redo(p,this),q.listen(!0),!0},T.clearInteractionTimeline=function(){s=-1,r=[]},T.clear_undo_queue=function(){throw"(CanvasController) Deprecated method `clear_undo_queue` called."},T.inputDL=function(a,b){w||(n.keyboard(new ea),T.cancelHWR(!0),I={pos:{x:a[0],y:a[1]-G},v_align:"center",h_align:"equals"},v.caption(null).latex("").on("done",function(a){na(a,b)}).on("cancel",pa).visible(!0))};var na=function(a,b){if(I){if(""===a)return void v.visible(!1);I.eq=a,I.id=Wa.uid(),n.entered_term(new da(I));var c;try{c=p.createDL(I,null,b),I=null}catch(a){return console.log(a),void v.warning("Could not parse expression.")}v.visible(!1),n["end-of-interaction"]({type:"end-of-interaction",source:{type:"CanvasController",id:o},time:Date.now()})}},pa=function(){v.visible(!1),n["end-of-interaction"]({type:"end-of-interaction",source:{type:"CanvasController",id:o},time:Date.now()})};return T.disableKeyboard=function(a){w=a},T.simulateStartOfInteraction=function(){n["start-of-interaction"]({type:"start-of-interaction",source:{type:"CanvasController",id:o},time:Date.now()})},T.simulateEndOfInteraction=function(){n["end-of-interaction"]({type:"end-of-interaction",source:{type:"CanvasController",id:o},time:Date.now()})},d3.rebind(T,n,"on")};return a}(),Wa.IdentificationModal=Oa,Oa.prototype.resetTimer=function(){this.showGlassPane(!1),this.timer_id&&clearTimeout(this.timer_id),this.timer_id=setTimeout(this.showGlassPane.bind(this,!0),this.max_idle_time)},Oa.prototype.showGlassPane=function(a){this.glass_pane.style("display",a?null:"none")},Oa.prototype.init=function(){this.glass_pane&&this.glass_pane.remove(),this.glass_pane=d3.select("body").append("div").style({position:"fixed",top:0,right:0,bottom:0,left:0,"z-index":1e4,display:"none"}).call(V().on("touch",this.show.bind(this))),this.modal&&this.modal.remove(),this.modal=d3.select("body").append("div").attr("class","modal fade").attr("tabindex",-1).attr("role","dialog");var a=this.modal.append("div").attr("class","modal-dialog modal-sm").attr("role","document").append("div").attr("class","modal-content"),b=a.append("div").classed("modal-header",!0);b.append("h4").classed("modal-title",!0).text("Please tell us who you are!");var c=a.append("div").classed("modal-body",!0),d=c.append("div");this.type_div=d.append("div").classed("form-group",!0).style("margin-bottom",0),this.type_div.append("label").attr({for:"user-id",class:"control-label"}).text("I'm a...");var e={width:"40%",height:"60px"},f=this.type_div.append("div");f.append("button").attr({type:"button",class:"btn btn-default"}).style(e).text("Student").on("click",this.on_choice.bind(this,"student")),f.append("button").attr({type:"button",class:"btn btn-default"}).style(e).style("float","right").text("Tutor").on("click",this.show_id_input.bind(this,!0)),this.id_div=d.append("div").classed("form-group",!0),this.id_div.append("label").attr({for:"user-id",class:"control-label"}).text("My initials & day of birth");var g=this.id_div.append("div").classed("input-group",!0);g.append("input").attr({type:"text",class:"form-control",id:"user-id"}).attr({placeholder:"EM28"}).on("keyup",function(){13===d3.event.keyCode&&(d3.event.preventDefault(),this.on_choice("tutor"))}.bind(this)),g.append("span").classed("input-group-btn",!0).append("button").attr({type:"button",class:"btn btn-default"}).text("OK").on("click",this.on_choice.bind(this,"tutor")),$(this.modal.node()).modal({backdrop:"static",keyboard:!1,show:!1})},Oa.prototype.show_id_input=function(a){this.type_div.style("display",a?"none":null),this.id_div.style("display",a?null:"none"),a&&this.modal.select("#user-id").node().focus()},Oa.prototype.reset=function(){this.modal.select("#user-id").node().value=null,this.show_id_input(!1),this.showGlassPane(!1)},Oa.prototype.on_choice=function(a){var b=this.modal.select("#user-id").node().value,c=!("tutor"!==a||b&&/^[a-zA-Z]{2,3}[0-9]{1,2}$/.test(b));this.id_div.classed("has-error",c),c||(this.events.identified({type:a,id:b}),$(this.modal.node()).modal("hide"),this.resetTimer())},Oa.prototype.show=function(){this.reset(),$(this.modal.node()).modal("show")},Ub=void 0,Vb=void 0,Wb=void 0,Xb={derivation:{label:"Math Expression",value:"derivation",icon:"imgs/menu-icons/sqrt-x.png"},homework:{label:"Homework Problem",value:"homework",class:"glyphicon glyphicon-book",cond:function(a){return a.options.homework_btn}},textbox:{label:"Text",value:"textbox",icon:"imgs/menu-icons/text.png"},ggb:{label:"Graph",value:"ggb",icon:"imgs/menu-icons/geogebra.svg"},table:{label:"Table",value:"table",icon:null},"ggb-table":{label:"Table-Graph",value:"ggb-table",icon:"imgs/menu-icons/geogebra.svg"}},Wa.ui=Wa.ui||{},Wa.ui.resource_path="../shared/",a("insertCanvas",Yb=function(a,b){return new Zb(a,b)}),a("CanvasFactory",Zb=function a(b,c,d){this.id=Wa.uid(),this.container=d3.select(b),c=c||{},this.options=Wa.object.merged(Wa.deepCopy(c.minimal?a.minimalOptions:a.defaultOptions),c),window&&window.gmath_log_ga&&this.options.disable_ga_tracking&&gmath_log_ga.enabled(!1);var e;if(this.options.parse_url_options){e=Wa.getURLParameter("options");try{e&&(e=JSON.parse(e))}catch(a){console.error("Error parsing url options: ",a)}}if(e&&Wa.extend(this.options,e),this.events=d3.dispatch("button"),this.model=Wa.ui.CanvasModelView(),this.controller=Wa.ui.CanvasController(this.model).drawing(this.options.drawing).hwr(this.options.hwr).use_keyboard(this.options.use_keyboard).use_hold_menu(this.options.use_hold_menu).keyboard_max_width(this.options.keyboard_max_width).askConfirmationOnClosing(this.options.ask_confirmation_on_closing),this.init(),this.options.overflow_visible&&(this.scroll_div.style("overflow","visible"),this.content_div.style("overflow","visible")),d&&this.options.savefile_server){this.remove();var f=this.getOptionsForFileLoading();e&&Wa.extend(f,e),Wa.CanvasSaver.loadSaveFile(this.container.node(),this.options.savefile_server+"/api/saves/gm_canvas",d,f)}this.logger=new xa(this,this.options.log_mouse_trajectories),this.controller.logger(this.logger),!this.options.parse_url_query_params||d&&this.options.savefile_server||this.parseURLQueryParams(),this.setupInputModeListeners()}),Wa.ui.CanvasFactory=Zb,Zb.prototype.setupInputModeListeners=function(){var a=this;d3.select("body").on("mousedown",function(){return a.model.inputMode("mouse")}),d3.select("body").on("touchstart",function(){return a.model.inputMode("touch")})},Zb.prototype.saveToJSON=function(){return JSON.stringify(Wa.CanvasSaver.serialize(this))},Zb.prototype.loadFromJSON=function(a){var b=JSON.parse(a);this.remove(),Wa.CanvasSaver.load(this.container.node(),b,this.getOptionsForFileLoading())},Zb.prototype.init=function(){this.outer_div=this.container.append("div").classed("flex-container-columns",this.options.use_toolbar).style({width:this.options.width,height:this.options.height}),this.options.toolbar_container=this.options.toolbar_container?d3.select(this.options.toolbar_container):this.outer_div,this.options.use_toolbar?(this.initToolbar(),this.scroll_div="top"===this.options.toolbar_pos?this.outer_div.append("div"):this.outer_div.insert("div","div.btn-toolbar"),this.scroll_div.classed("gm-canvas",!0).style("width",this.options.width).style("flex",1).style("-webkit-flex",1).style("position","relative").style("overflow-y",this.options.vertical_scroll?"scroll":"hidden")):(this.scroll_div=this.outer_div,this.scroll_div.classed("gm-canvas",!0).style("position","relative")),this.content_div=this.scroll_div.append("div").style("width","100%").style("min-height",this.options.vertical_scroll?"200%":"100%").style("position","absolute").call(this.model),this.controller(),this.options.vertical_scroll&&(this.scroll_div.on("scroll",this.adjustCanvasSize.bind(this)),this.adjustCanvasSize(!0)),this.options.identification_interval!==!1&&(this.id_modal=new Oa(this.options.identification_interval),this.id_modal.events.on("identified",this.onUserIdentification.bind(this)),this.controller.on("start-of-interaction",this.id_modal.resetTimer.bind(this.id_modal)))},Zb.prototype.onUserIdentification=function(a){this.logger.logCustomInteraction("user-id",{user_id:a.id,user_type:a.type})},Zb.prototype.initToolbar=function(){var a=this;if(this.tools=this.options.toolbar_container.append("div").attr({class:"btn-toolbar",role:"toolbar"}).style(this.options.toolbar_on_style),this.options.minimal&&this.tools.on("mouseenter",function(){a.toolFadeoutTimer&&clearTimeout(a.toolFadeoutTimer)}).on("mouseleave",this.switchToolbarState.bind(this)),this.options.drawing&&this.options.mode_btns.splice(3,0,{type:"radio",group:"draw",state:!1,label:"draw",icon:"glyphicon glyphicon-pencil"},{type:"radio",group:"draw",state:!1,label:"erase",icon:"glyphicon glyphicon-erase"}),this.options.mode_btns&&this.appendButtonGroup(this.options.mode_btns,this.onButton),this.options.reset_btn&&this.appendButtonGroup([this.options.reset_btn],this.onButton),this.options.undo_btn||this.options.redo_btn){var b=[];this.options.undo_btn&&b.push(this.options.undo_btn),this.options.redo_btn&&b.push(this.options.redo_btn),this.appendButtonGroup(b,this.onButton)}if(this.options.font_smaller_btn&&this.options.font_larger_btn){var c=[];c.push(this.options.font_smaller_btn),c.push(this.options.font_larger_btn),this.appendButtonGroup(c,this.onButton)}this.options.feedback&&this.options.feedback_btn&&this.appendButtonGroup([this.options.feedback_btn],this.onButton),this.options.insert_btn&&Pa(this,Wa.ui.resource_path,this.options.insert_menu_items),this.options.homework_btn&&Wa.ui.addHomeworkButton(this),this.options.formula_btn&&Wa.ui.addMacroButton(this);var d=[];if(this.options.saving_and_loading&&(this.options.save_btn&&d.push(this.options.save_btn),this.options.load_btn&&d.push(this.options.load_btn)),this.options.share_btn&&d.push(this.options.share_btn),d.length&&this.appendButtonGroup(d,this.onButton),this.options.help_btn&&Wa.ui.addHelpButton(this),this.options.minimal){this.tools.classed("btn-toolbar-minimal",!0);var e=this.tools.append("div").attr("class","btn-group pull-right").style({"line-height":"26px","margin-left":"40px"});e.append("span").text("powered by").style({"font-style":"italic","font-family":"sans-serif",color:"#909090","font-weight":300,"font-size":"13px"});var f=e.append("a").style({"text-decoration":"none"}).attr({href:"http://graspablemath.com",target:"_blank"});f.append("img").attr({alt:"GM",src:this.options.logo_src}).style({"vertical-align":"-0.3em",height:"1.7em","margin-left":"0.8em","margin-right":"0.2em","font-size":"13px"})}this.options.minimal&&this.options.static_toolbar&&this.switchToolbarState(!0)},Zb.prototype.showHint=function(a,b,c){var d=this.model;if(c||(c={}),!(d.dls().length>0)||this.options.always_show_initial_hint){var e={pos:{x:-1e3,y:-1e3},size:{width:c.width||220,height:0},text:a,closable:!0,uneditable:!0,static_bg:!0,text_align:"center",dont_log_events:!0,font_size:c.font_size||16,resizable:!1},f=d.createTextBox(e,function(a){var b=d.viewport();a.translateElement({x:c.x||b.x+b.width/2-a.size.width/2,y:c.y||b.y+b.height/2-a.size.height/2})});b&&d.on("create.gm-inital-hint",function(){d.textboxes().indexOf(f)>=0&&f.fade(),d.on("create.gm-initial-hint",null)})}},Zb.prototype.parseURLQueryParams=function(){var a=Wa.getURLParameter("eq");if(a){a=a.split(";"),this.controller.simulateStartOfInteraction();for(var b=0;b<a.length;b++)this.model.createDL({eq:a[b],pos:{x:200+350*b,y:100}},null,"URL");this.controller.simulateEndOfInteraction()}},Zb.prototype.adjustCanvasSize=function(a){var b=this.scroll_div.node().getBoundingClientRect().height,c=this.content_div.node().getBoundingClientRect().height,d=this.scroll_div.property("scrollTop");if(this.scroll_top||(this.scroll_top=d),a){var e=Math.round(c/b);this.content_div.style("height",b*e+"px")}if(d>this.scroll_top){if(c-d<b){var e=Math.round(c/b)+1;this.content_div.style("height",b*e+"px")}}else if(d<this.scroll_top&&c-d>=2*b&&this.noObjectsHiddenBelowView(d)){var e=Math.round(c/b)-1;this.content_div.style("height",b*e+"px")}this.scroll_top=d},Zb.prototype.noObjectsHiddenBelowView=function(a){var b=[];if(b=this.model.dls().concat(this.model.graphs()).concat(this.model.textboxes()).concat(this.model.paths()),0===b.length)return!0;for(var c=0;c<b.length;c++){var d=b[c];if(d.pos){if(Array.isArray(d.pos)&&d.pos[1]>a)return!1;if(d.pos.y>a)return!1}else if(d.points&&d.points[0][1]>a)return!1}return!0},Zb.prototype.switchToolbarState=function(a,b){var c=this;a?c.turnOnToolbar():b?c.turnOffToolbar():c.toolFadeoutTimer=setTimeout(function(){c.turnOffToolbar()},c.options.toolFadeoutDelay)},Zb.prototype.turnOnToolbar=function(){this.toolFadeoutTimer&&(clearTimeout(this.toolFadeoutTimer),this.toolFadeoutTimer=null),this.tools.style(this.options.toolbar_on_style),this.toolbarOn=!0},Zb.prototype.turnOffToolbar=function(){this.toolFadeoutTimer&&(clearTimeout(this.toolFadeoutTimer),this.toolFadeoutTimer=null),this.tools.style(this.options.toolbar_off_style),this.toolbarOn=!1},Zb.prototype.resize=function(a){this.options.width=a.width,this.options.height=a.height,this.scroll_div.style({width:this.options.width,height:this.options.height}),this.tools&&this.tools.style({width:this.options.width})},Zb.prototype.onButton=function(a){this.id_modal&&this.id_modal.resetTimer();var b={mode:"inspect"===this.model.setMode()?"scrub":this.model.setMode(),font_size:oa.defaultOptions.font_size};this.updateButton(a),"clear all"===a.label&&(this.logger.canvas_logger.containsPendingEvents(this.logger.canvas_logger.interactionSequence)&&this.logger.canvas_logger.submitCurrentSequence(),window&&window.gmath_log_ga&&gmath_log_ga.trackEvent(this.options.gm_app_name,"button press","reset",1),confirm("Really clear the canvas?")&&this.controller.reset()),"undo"===a.label&&(this.logger.canvas_logger.containsPendingEvents(this.logger.canvas_logger.interactionSequence)&&this.logger.canvas_logger.submitCurrentSequence(),this.controller.undo(),window&&window.gmath_log_ga&&gmath_log_ga.trackEvent(this.options.gm_app_name,"button press","undo",1)),"redo"===a.label&&(this.logger.canvas_logger.containsPendingEvents(this.logger.canvas_logger.interactionSequence)&&this.logger.canvas_logger.submitCurrentSequence(),window&&window.gmath_log_ga&&gmath_log_ga.trackEvent(this.options.gm_app_name,"button press","redo",1),this.controller.redo()),"HWR"===a.label&&(window&&window.gmath_log_ga&&gmath_log_ga.trackEvent(this.options.gm_app_name,"button press","hwr",1),this.controller.hwr(a.state)),"transform"===a.label&&(window&&window.gmath_log_ga&&gmath_log_ga.trackEvent(this.options.gm_app_name,"button press","transform",1),this.model.setMode("edit")),"scrub"===a.label&&(window&&window.gmath_log_ga&&gmath_log_ga.trackEvent(this.options.gm_app_name,"button press","scrub",1),this.model.setMode("inspect")),"arrange"===a.label&&(window&&window.gmath_log_ga&&gmath_log_ga.trackEvent(this.options.gm_app_name,"button press","arrange",1),this.model.setMode("arrange")),"draw"===a.label&&(window&&window.gmath_log_ga&&gmath_log_ga.trackEvent(this.options.gm_app_name,"button press","draw",1),this.model.setMode("draw")),"erase"===a.label&&(window&&window.gmath_log_ga&&gmath_log_ga.trackEvent(this.options.gm_app_name,"button press","erase",1),this.model.setMode("erase")),"help"===a.label&&(window&&window.gmath_log_ga&&gmath_log_ga.trackEvent(this.options.gm_app_name,"button press","help",1),this.help()),"feedback"===a.label&&(window&&window.gmath_log_ga&&gmath_log_ga.trackEvent(this.options.gm_app_name,"button press","feedback",1),this.sendFeedback()),"fullscreen"===a.label&&a.state===!0&&(window&&window.gmath_log_ga&&gmath_log_ga.trackEvent(this.options.gm_app_name,"button press","start fullscreen",1),this.launchFullScreen()),"fullscreen"===a.label&&a.state===!1&&(window&&window.gmath_log_ga&&gmath_log_ga.trackEvent(this.options.gm_app_name,"button press","stop fullscreen",1),this.cancelFullScreen()),
"HWR"===a.label&&a.state===!0||this.options.hwr!==!0||(window&&window.gmath_log_ga&&gmath_log_ga.trackEvent(this.options.gm_app_name,"button press","cancel HWR",1),this.controller.cancelHWR()),"larger"===a.label&&(window&&window.gmath_log_ga&&gmath_log_ga.trackEvent(this.options.gm_app_name,"button press","font larger",1),this.controller.font_larger()),"smaller"===a.label&&(window&&window.gmath_log_ga&&gmath_log_ga.trackEvent(this.options.gm_app_name,"button press","font smaller",1),this.controller.font_smaller()),"save"===a.label&&(Wa.CanvasSaver.save(this),window&&window.gmath_log_ga&&gmath_log_ga.trackEvent(this.options.gm_app_name,"button press","save",1)),"load"===a.label&&(this.remove(),Wa.CanvasSaver.load(this.container.node(),null,this.getOptionsForFileLoading()),window&&window.gmath_log_ga&&gmath_log_ga.trackEvent(this.options.gm_app_name,"button press","load",1)),"share"!==a.label||this.publishing||(this.publishConfirmation(),window&&window.gmath_log_ga&&gmath_log_ga.trackEvent(this.options.gm_app_name,"button press","share",1));var c={button:{label:a.label,state:a.state,type:a.type},old_state:b,time:Date.now()};"larger"!==c.button.label&&"smaller"!==c.button.label||(c.button.font_size=oa.defaultOptions.font_size),this.events.button(c)},Zb.prototype.getOptionsForFileLoading=function(){return{parse_url_query_params:!1,disable_ga_tracking:this.options.disable_ga_tracking,gm_app_name:this.options.gm_app_name,savefile_server:this.options.savefile_server,log_mouse_trajectories:this.options.log_mouse_trajectories}},Zb.prototype.showSaveError=function(a){var b=d3.select("#publish-share-panel"),c=b.select("div");c.classed("alert-danger",!0),b.classed("panel-default",!1).classed("panel-danger",!0);var d=this;c.selectAll("p").remove(),c.append("p").html("Sorry, we could not share the canvas.</br>Reason: "+a),a.indexOf("too big")===-1?c.append("p").text("Please save your work locally and try again later. Make sure you are connected to the internet!"):c.append("p").text("We currently don't support uploading this much data. Please save your work locally instead."),c.append("button").property("type","button").classed("btn btn-default",!0).text("Ok").on("click",function(){b.remove(),d.publishing=!1})},Zb.prototype.publishConfirmation=function(){this.publishing=!0;var a=this,b=this.scroll_div.append("div").classed("panel panel-default",!0).attr("id","publish-share-panel").style({width:"500px",position:"absolute",right:"20px",top:"20px"}),c=b.append("div").classed("panel-body",!0);c.append("h3").text("Share your math!"),c.append("p").text('Click the "Publish" button to save your work on the Graspable Math server.  We\'ll give you a key so you or anyone else can get a copy.'),c.append("button").property("type","button").classed("btn btn-default",!0).classed("pull-right",!0).text("Cancel").on("click",function(){b.remove(),a.publishing=!1}),c.append("button").property("type","button").classed("btn btn-primary",!0).text("Publish").on("click",function(){c.remove(),c=b.append("div").classed("panel-body",!0),c.append("p").text("Working..."),Wa.CanvasSaver.share(a.options.savefile_server+"/api/saves/gm_canvas",a,function(b,c){b?a.showSaveError(b.reason):a.noSaveError(c)})})},Zb.prototype.noSaveError=function(a){function b(){var a=$("#toEmail").val(),b=/\S+@\S+\.\S+/.test(a);if(h.classed("has-error",!b),b){d.select("#send_btn").text("Sending...").attr("disabled",!0).style("pointer-events","none");var c={};c.toEmail=a;var e="Here is your link:\n\r";e+=f,e+="\n\r Keep this link for yourself or share it with others. It will always point to the canvas as it is right now. Click the share button again if you want to create a new link to an updated version.To embed the saved GM canvas into your own webpage, put the following snippet into the body of your html file.  \n\r",e+=g,c.subject="Graspable Math Save Link",c.body=e;var i=new XMLHttpRequest;i.onreadystatechange=function(){4===i.readyState&&200===i.status&&d.select("#send_btn").text("Sent.")},i.open("POST","https://graspablemath.com:7011/send_email_to",!0),i.setRequestHeader("Content-Type","application/json"),i.send(JSON.stringify(c))}}var c=d3.select("#publish-share-panel"),d=c.select("div"),e=this;d.selectAll("p").remove(),d.append("h3").text("Here is your link:");var f=location.origin+location.pathname+"?load="+a;d.append("div").classed("share_link",!0).append("input").attr({type:"text"}).on("click",function(){this.select(),this.setSelectionRange(0,this.value.length)}).on("input",function(){this.value=f,this.select(),this.setSelectionRange(0,this.value.length)}).node().value=f,d.append("p").text("Keep this link for yourself or share it with others. It will always point to the canvas as it is right now. Click the share button again if you want to create a new link to an updated version."),d.append("p").text("To embed the saved GM canvas into your own webpage, put the following snippet into the body of your html file.");var g='<script type="text/javascript">url = parent.document.URL; document.write(\'<iframe style="border: none" src=\\\''+f+'&options={"saving_and_loading": false, "drawing": false, "formula_btn": false, "vertical_scroll": false}&parent_url=\'+url+\'\\\' width=100% height=500px></iframe>\');</script>';d.append("div").classed("share_link",!0).append("input").attr({type:"text"}).on("click",function(){this.select(),this.setSelectionRange(0,this.value.length)}).on("input",function(){this.value=g,this.select(),this.setSelectionRange(0,this.value.length)}).node().value=g,d.append("div").classed("emailTo"),d.append("p").text("Enter your email address and we'll email you the share link!");var h=d.append("div").classed("input-group",!0);h.append("input").attr({type:"email",class:"form-control",id:"toEmail"}).attr({placeholder:"your@email.com"}),h.append("span").classed("input-group-btn",!0).append("button").attr({type:"button",class:"btn btn-default",id:"send_btn"}).text("Send Email!").on("click",b),d.append("hr"),d.append("button").property("type","button").classed("btn btn-primary",!0).text("Done").on("click",function(){c.remove(),e.publishing=!1})},Zb.prototype.launchFullScreen=function(a){a=a||document.body,a.requestFullscreen?a.requestFullscreen():a.mozRequestFullScreen?a.mozRequestFullScreen():a.webkitRequestFullscreen?a.webkitRequestFullscreen():a.msRequestFullscreen&&a.msRequestFullscreen()},Zb.prototype.help=function(){var a=window.open("http://graspablemath.com/unstable/tutorial/index.html","_blank");a.focus()},Zb.prototype.sendFeedback=function(){var a=window.open("mailto:contact@graspablemath.com","_blank");a.focus()},Zb.prototype.cancelFullScreen=function(){document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen()},Zb.prototype.updateButton=function(a){this.tools&&this.tools.select("button#"+a.label).datum(a).each(function(a){if("toggle"===a.type)a.state=!a.state,d3.select(this).classed("active",a.state);else if("radio"===a.type){var b=this;d3.select(this.parentNode).selectAll("button").each(function(a){a.state=b===this}).classed("active",function(a){return a.state})}})},Zb.prototype.appendButtonElement=function(a,b){var c=this,d=a.append("button").attr("id",function(a){return a.label}).attr({type:"button",class:"btn btn-default"}).classed("btn-xs","xs"===c.options.btn_size).classed("btn-sm","sm"===c.options.btn_size).classed("active",function(a){return a.state}).style("min-width","4em");if(d.filter(function(a){return"dropdown"===a.type}).classed("toggle-dropdown",!0).attr("data-toggle","dropdown").attr("aria-haspopup","true").attr("aria-expanded","false"),b&&d.call(Wa.mtouch_events().on("touch",b.bind(this))),this.options.display_icons){var e=d.filter(function(a){return a.icon});e.append("i").attr("class",function(a){return a.icon}).style({color:"#555","font-size":"1.2em","line-height":"1.7em"}).style("padding-left",function(a){return"dropdown"===a.type?"0.25em":null}).style("transform",function(a){return"x"===a.flip?"rotateX(180deg)":"y"===a.flip?"rotateY(180deg)":"xy"===a.flip?"rotateZ(180deg)":null});var f=e.filter(function(a){return"dropdown"===a.type});f.append("span").html("&nbsp;"),f.append("span").classed("caret",!0),e.append("br")}if(this.options.display_labels&&(d.append("span").text(function(a){return a.label}).style("color","#555"),!this.options.display_icons)){var f=d.filter(function(a){return"dropdown"===a.type});f.append("span").html("&nbsp;"),f.append("span").classed("caret",!0)}},Zb.prototype.appendButtonGroup=function(a,b,c){if(!this.tools)throw"Can't add buttons if toolbar is disabled.";var d=c?this.tools.insert("div","*"):this.tools.append("div");d.attr({class:"btn-group",role:a[0].group}).classed("pull-right",a[0].pull_right);var e=d.selectAll("button").data(a);if(e.enter().call(this.appendButtonElement.bind(this),b),1===a.length&&"dropdown"===a[0].type){var f=a[0].html_fn(d.node(),a[0]);d3.select(f).attr("aria-labelledby",a[0].label).classed("dropdown-menu",!0)}return d},Zb.prototype.remove=function(){this.tools&&this.tools.remove(),this.outer_div.remove()},Zb.minimalOptions={width:"100%",height:"100%",vertical_scroll:!1,toolbar_pos:"top",static_toolbar:!0,undo_btn:{type:"push",label:"undo",icon:"glyphicon glyphicon-chevron-left"},redo_btn:{type:"push",label:"redo",icon:"glyphicon glyphicon-chevron-right"},use_keyboard:!1,use_hold_menu:!1,drawing:!1,display_icons:!0,display_labels:!1,btn_size:"xs",toolbar_on_style:{display:"inline-block",position:"absolute","margin-top":"-35px",padding:"5px","padding-right":"10px",background:"rgba(255, 255, 255, 0.901961)","border-radius":"3px"},toolbar_off_style:{display:"none"},toolFadeoutDelay:500,logo_src:"../shared/imgs/gm-logo.png",overflow_visible:!0,keyboard_max_width:800,ask_confirmation_on_closing:!1,identification_interval:!1};Zb.defaultOptions={width:"100%",height:"100%",vertical_scroll:!0,parse_url_query_params:!1,parse_url_options:!0,toolbar_pos:"top",undo_btn:{type:"push",label:"undo",icon:"glyphicon glyphicon-chevron-left"},redo_btn:{type:"push",label:"redo",icon:"glyphicon glyphicon-chevron-right"},reset_btn:{type:"push",label:"clear all",icon:"glyphicon glyphicon-refresh"},font_smaller_btn:{type:"push",label:"smaller",icon:"glyphicon glyphicon-text-size",flip:"y"},font_larger_btn:{type:"push",label:"larger",icon:"glyphicon glyphicon-text-size"},formula_btn:!1,help_btn:{type:"push",label:"help",pull_right:!0,icon:"glyphicon glyphicon-question-sign"},hwr_btn:{type:"toggle",label:"HWR",pull_right:!0,state:!0,icon:"glyphicon glyphicon-font"},fullscreen_btn:{type:"toggle",label:"fullscreen",pull_right:!0,state:!1,icon:"glyphicon glyphicon-resize-full"},homework_btn:!1,hwr:!1,feedback_btn:{type:"push",label:"feedback",pull_right:!0,icon:"glyphicon glyphicon-envelope"},feedback:!1,disable_ga_tracking:!1,gm_app_name:"canvas factory",use_keyboard:!0,use_hold_menu:!0,drawing:!0,display_icons:!0,display_labels:!0,btn_size:"sm",mode_btns:[{type:"radio",group:"mode",state:!0,label:"transform",icon:"glyphicon glyphicon-random"},{type:"radio",group:"mode",state:!1,label:"scrub",icon:"glyphicon glyphicon-wrench"},{type:"radio",group:"mode",state:!1,label:"arrange",icon:"glyphicon glyphicon-move"}],use_toolbar:!0,toolbar_on_style:{"margin-bottom":"10px"},toolbar_off_style:{display:"none"},toolFadeoutDelay:0,save_btn:{type:"push",label:"save",pull_right:!0,icon:"glyphicon glyphicon-save"},load_btn:{type:"push",label:"load",pull_right:!0,icon:"glyphicon glyphicon-open"},formulas_btn:!0,insert_btn:!0,insert_menu_items:{derivation:!0,homework:!0,textbox:!0,ggb:!0},savefile_server:"http://127.0.0.1:7010",share_btn:{type:"push",label:"share",pull_right:!0,icon:"glyphicon glyphicon-send"},saving_and_loading:!1,log_mouse_trajectories:!1,keyboard_max_width:800,ask_confirmation_on_closing:!0,identification_interval:!1};Wa.ui=Wa.ui||{},Wa.ui.CanvasImage=function(){var a=function(a,b,c,d){Wa.ui.CanvasElement.call(this,a,b,c),this.type="image",this.initCanvasImageOptions(c),this.initCanvasImageProperties(c),this.initCanvasImage(),this.initPosition(),d&&this.callback(this)};return Wa.inherit(Wa.ui.CanvasElement,a),Wa.ui.CanvasImageClass=a,a.defaultOptions={min_size:{width:50},size:{width:200}},a.prototype.initCanvasImageOptions=function(b){var b=b||{},c=Wa.deepCopy(a.defaultOptions),d=Wa.object.extendExisting(c,b);b.image_data&&(d.image_data=b.image_data),b.drop_evt&&(d.drop_evt=b.drop_evt,d.url=this.tryGetUrl(b.drop_evt)),b.url&&(d.url=b.url),this.options=Wa.extend(this.options,d)},a.prototype.initCanvasImageProperties=function(a){this.size=this.options.size},a.prototype.initCanvasImage=function(){this.options.image_data||this.options.url?this.loadImage():this.getDataFromFile(this.options.drop_evt)},a.prototype.tryGetUrl=function(a){if(a){if("string"==typeof a)return a;if(void 0!==a.dataTransfer){var b=a.dataTransfer.getData("text/plain");if("http"===b.slice(0,4))return b;var c=a.dataTransfer.getData("text/html"),d=$("<div>").append(c),e=$(d).find("img").attr("src");if("undefined"!=typeof e)return e}return null}},a.prototype.getDataFromFile=function(a){if("undefined"==typeof this.options.image_data&&null!==a&&"undefined"!=typeof a.dataTransfer){var b=new FileReader;b.onload=function(a){this.canvas_image.options.image_data=a.target.result,this.canvas_image.loadImage()},b.onerror=function(a){console.error("error: "+a.target.error)},b.canvas_image=this,b.readAsDataURL(a.dataTransfer.files[0])}},a.prototype.loadImage=function(){this.image_for_aspect_ratio=new Image,this.image_for_aspect_ratio.src=this.options.url||this.options.image_data,this.image=document.createElementNS("http://www.w3.org/2000/svg","image"),this.image.addEventListener("load",this.waitForAspectRatio())},a.prototype.waitForAspectRatio=function(){var a=this;if(this.image_for_aspect_ratio.complete)this.imageLoaded();else{var b,c;!function(){var d=function a(){if(c.image_for_aspect_ratio.complete)c.imageLoaded();else{setTimeout(a,100)}};b=setTimeout(d,100),c=a}()}},a.prototype.imageLoaded=function(){this.aspect_ratio=this.image_for_aspect_ratio.height/this.image_for_aspect_ratio.width;var a=this.size.width*this.aspect_ratio;if(this.options.min_size.height=this.options.min_size.width*this.aspect_ratio,!isNaN(this.aspect_ratio)){var b=null===this.options.url?this.options.image_data:this.options.url;this.image=this.element_div.append("img").property("src",b).attr({width:this.size.width-4,height:a-4}).style({"pointer-events":"none"}),this.resizeElement({width:this.size.width,height:a})}},a.prototype.resize=function(a){var b=Math.max(this.options.min_size.width,a.width);b=Math.min(b,b-(a.width+this.pos.x-this.container_size.width)),h=b*this.aspect_ratio,this.resizeElement({width:b,height:h})},a.prototype.subTypeResize=function(a){this.image.attr({width:this.size.width-4,height:this.size.height-4})},a.prototype.toJSON=function(){var a={type:"CanvasImage",id:this.id,pos:Wa.deepCopy(this.pos),size:Wa.deepCopy(this.size),url:this.options.url||this.options.image_data};return a},a}(),Wa.ui=Wa.ui||{},Wa.ui.CanvasModelView=function(){var a=function(){function a(a){a.dl.draw_mappings_for_nodes([a.node])}function b(a){if("canvas-element"===a)return Wa.CanvasElementClass;if("image"===a)return Wa.ui.CanvasImage;if("textbox"===a)return Wa.ui.TextBox;if("graph"===a)return Wa.ui.Graph;if("derivation"===a)return Wa.DerivationList;if("ggb-panel"===a)return wa;if("ggb-element"===a)return sa;if("table"===a)return Wa.ui.Table;if("multichoice"===a)return Wa.ui.Multichoice;if("graph-eq"===a)return Wa.ui.GraphEq;throw'unkown element type "'+a+'"'}var c,d,e,f,g,h,i=d3.dispatch("create","update","remove","reset","mode","input_mode"),j=Wa.uid(),k=null,l=[],m=[],n=[],o=[],p=["edit","inspect","arrange","draw","erase"],q=0,r="mouse",s=function a(b){return k=b,d=k.append("div").style({position:"absolute",left:0,right:0,top:0,bottom:0}),f=d.append("div").style({position:"absolute",left:0,right:0,top:0,bottom:0}),c=d.append("svg").classed("gm-canvas-svg",!0).style({position:"absolute",width:"100%",height:"100%"}).style("pointer-events","none"),e=c.append("g").attr("id","g_paths"),g=k.append("div").style({position:"absolute",left:0,right:0,top:0,bottom:0}).style({display:"none","pointer-events":"all"}),h=k.append("div").attr("id","notification_el").style({height:"40px","font-size":"16px","line-height":"40px","background-color":"#ddd",color:"#777","text-align":"center",display:"none",position:"fixed"}).on("click",function(){d3.event.stopPropagation()}),h.append("span"),h.append("span").classed("x-btn",!0).html("×&nbsp;&nbsp;&nbsp;").style({float:"right",cursor:"pointer"}).on("click",a.hideNotice.bind(this)),this};s.showNotice=function(a,b){h.select("span").text(a),h.select(".x-btn").style("display",b?null:"hidden"),h.style({display:null,width:k.node().scrollWidth+"px"}),setTimeout(function(){k.on("click."+j,s.hideNotice)},0)},s.hideNotice=function(){h.style("display","none"),k.on("click."+j,null)},s.reset=function(){for(var a=l.length-1;a>=0;a--)this.removeElement(l[a]);for(var a=m.length-1;a>=0;a--)this.removePath(m[a]);o=[],this.scroll(0)},s.setActive=function(a,b){arguments.length<2&&(b=!0),a&&a.setActive(b),l.forEach(function(b){b!==a&&(b.setActive(!1),a||"table"!==b.type&&"textbox"!==b.type||b.unselect())})},s.inputMode=function(a){if(0===arguments.length)return r;if(r!==a)return r=a,i.input_mode({type:"input_mode",mode:r}),this},s.focusOnDL=function(a){a.events.on("end-of-interaction."+this.id,a.initPosition.bind(a,!0))},s.createDL=function(b,c,d){function e(b){if(l.indexOf(b)===-1){b.setMode(p[q]),b.events.on("inspect_node",a),l.push(b),d3.selectAll(".derivation-list").data(s.dls());var c={type:"create",target_type:"derivation",target:b};d&&(c.method=d),i.create(c)}}var f=new oa(s,this.getContainer("derivation").node(),b,function(a){e(a),c&&c(a)});return e(f),f},s.getContainer=function(a){if("canvas-element"===a)return d;if("image"===a)return d;if("textbox"===a)return d;if("graph"===a)return g_graphs;if("derivation"===a)return d;if("ggb-panel"===a)return d;if("ggb-element"===a)return d;if("table"===a)return d;if("multichoice"===a)return d;if("graph-eq"===a)return d;throw'unkown element type "'+a+'"'},s.createElement=function(a,c,d,e){function f(b){l.indexOf(b)===-1&&(b.setMode(p[q]),l.push(b),i.create({type:"create",target_type:a,target:b,method:d}))}var g=s.getContainer(a),h=b(a),j=new h(s,g.node(),c,function(a){f(a),e&&e(a)});return f(j),j},s.createImage=function(a,b){var c=new Wa.ui.CanvasImage(s,this.getContainer("image").node(),a);return l.push(c),i.create({type:"create",target_type:"image",target:c,method:b}),c},s.createTextBox=function(a,b,c){return s.createElement("textbox",a,c,b)},s.addElement=function(a){if(a in l)throw"element is already part of this canvas";return t(o,a),a.canvas_model=s,a.initElement(s.getContainer(a.type).node()),a.setMode(p[q]),l.push(a),i.create({type:"create",target_type:a.type,target:a}),s},s.addDL=function(b){if(t(o,b),l.indexOf(b)!==-1)throw"dl is already in this model";return b.canvas_model=s,b.initElement(this.getContainer("derivation").node()),b.setMode(p[q]),b.events.on("inspect_node",a),s.setActive(b),l.push(b),d3.selectAll(".derivation-list").data(s.dls()),i.create({type:"create",target_type:"derivation",target:b}),b},s.addImage=function(a){t(o,a),a.canvas_model=s,a.initElement(this.getContainer("image").node()),a.setMode(p[q]),l.push(a),i.create({type:"create",target_type:"image",target:a})},s.addTextBox=function(a){return t(o,image),a.canvas_model=s,a.initElement(this.getContainer(a).node()),a.setMode(p[q]),l.push(a),i.create({type:"create",target_type:"textbox",target:a}),a},s.createDLs=function(a,b,c,d){function e(g){if(f===a.length)c&&c();else{g&&(b.pos[1]+=g.dims.height);var h=Wa.deepCopy(b);h.eq=a[f++],s.createDL(h,e,d)}}var f=0;e()},s.isInFreeVisibleSpace=function(a,b){var c=this.viewport();return!(a.y<c.y||a.y+a.height>c.y+c.height)&&0===this.getIntersectingElements(a,b).length},s.getIntersectingElements=function(a,b){return l.filter(function(c){return b!==c&&Wa.HitTester.overlaps(a,c.getBBox())})},s.getClosestElement=function(a){var b=arguments.length<=1||void 0===arguments[1]?null:arguments[1],c=arguments.length<=2||void 0===arguments[2]?1/0:arguments[2],d=b?l.filter(b):l;if(0===d.length)return null;var e=d.map(function(b){return{el:b,dist:b.getDistanceTo(a)}}).sort(function(a,b){return a.dist-b.dist})[0];return e.dist<=c?e.el:void 0},s.moveToFreeSpace=function(a){var b=!(arguments.length<=1||void 0===arguments[1])&&arguments[1],c=arguments.length<=2||void 0===arguments[2]?null:arguments[2],d=a.getBBox(),e=this.viewport(),f={x:e.x,y:e.y,width:d.width,height:d.height};for(c&&(f.x=c.pos.x,f.y=c.pos.y+c.size.height+e.height/20);f.y+f.height<e.y+e.height;){for(;f.x+f.width<e.x+e.width;){var g=this.getIntersectingElements(f,a);if(0===g.length)return a.translateElement(f,b),!0;var h=d3.max(g,function(a){return a.pos.x+a.size.width});f.x=h+1}f.x=e.x,f.y=f.y+e.height/20}return!1},s.createPath=function(a,b){var c=new Wa.ui.Path(e.node(),a);m.push(c);var d={type:"create",target_type:"path",target:c};return b&&(d.method=b),i.create(d),c},s.removePath=function(a){t(m,a),a.remove(),i.remove({type:"remove",target_type:"path",target:a})},s.addPath=function(a){if(m.indexOf(a)!==-1)throw"path is already in this model";return a.setContainer(e),a.init(),m.push(a),i.create({type:"create",target_type:"path",target:a}),a},s.updatePath=function(a){a.update(),i.update({target_type:"path",target:a})},s.createGraph=function(a){a.view=s;var b=new Wa.ui.Graph(g_graphs.node(),a);return n.push(b),i.create({type:"create",target_type:"graph",target:b}),b},s.removeGraph=function(a){t(n,a),a.remove(),i.remove({type:"remove",target_type:"graph",target:a})},s.removeElement=function(a){t(l,a),o.push(a);var b=a.removeElement();return i.remove({type:"remove",target_type:a.type,target:a}),b};var t=function(a,b){if(0===a.length)return!1;var c=a.indexOf(b);return c!==-1&&(a.splice(c,1),!0)};return s.elements=function(){return l},s.dls=function(){return s.getElementsOfType("derivation")},s.graphs=function(){return n},s.textboxes=function(){return s.getElementsOfType("textbox")},s.images=function(){return s.getElementsOfType("image")},s.getElementsOfType=function(a){return l.filter(function(b){return b.type===a})},s.getElementByID=function(a){for(var b=0;b<l.length;b++)if(l[b].id===a)return l[b];for(var b=0;b<m.length;b++)if(m[b].id===a)return m[b]},s.getDeletedElementByID=function(a){for(var b=0;b<o.length;b++)if(o[b].id===a)return o[b]},s.paths=function(a){if(!arguments.length)return m;for(var b=0;b<m.length;b++)m[b].remove();m=a.slice();for(var b=0;b<m.length;b++)m[b].setContainer(e),m[b].init();i.reset({target_type:"path",target:m.slice()})},s.scroll=function(a){return 0===arguments.length?k.node().parentNode.scrollTop:(k.node().parentNode.scrollTop=a,this)},s.container=function(){return k},s.background_event_layer=function(a){return f},s.foreground_event_layer=function(a){return g},s.foreground_event_layer_visible=function(a){return arguments.length?void g.style("display",a?null:"none"):g.style("display")},s.paths_container=function(a){return arguments.length?(e=a,this):e},s.size=function(){var a=k.node();return{width:a.clientWidth,height:a.clientHeight}},s.viewport=function(){var a=k.node().parentNode;return{x:0,width:a.clientWidth,y:a.scrollTop,height:a.clientHeight}},s.getMode=function(){return p[q]},s.setMode=function(a){return 0===arguments.length?p[q]:(q=p.indexOf(a),l.forEach(function(b){b.setMode(a)}),i.mode({type:"mode",mode:a}),this)},d3.rebind(s,i,"on")};return a}(),Wa.ui.addHelpButton=function(){function a(a){f=a,f.appendButtonGroup([{type:"dropdown",label:"help",data_toggle:"dropdown",pull_right:!0,icon:"glyphicon glyphicon-question-sign",html_fn:b}])}function b(a,b){var e={width:240,row_height:40},f=c(a,e);return d(f,e),f.node()}function c(a,b){var c=22,d=d3.select(a).append("div").style("width",b.width+c+"px").style("padding","5px").on("click",function(){d3.event.stopPropagation()});return d}function d(a,b){var c=a.append("div").classed("panel",!0).style("width",b.width+2+"px").style("height",b.row_height*e.length+2+"px").style("margin","5px").style("border","1px solid silver"),d=c.selectAll(".link").data(e);d.enter().append("div").classed("link",!0).html(function(a){return a.title}).style("width",b.width+"px").style("height",b.row_height+"px").style("padding-left","5px").style("line-height",b.row_height+"px").style("font-weight","bold").style("text-decoration","none").style("color","steelblue").style("background-color",function(a,b){return b%2==0?"whitesmoke":"white"}).style("cursor","pointer").on("click",function(a){var b=window.open(a.url,"_blank");b?b.focus():alert("Please allow popups for Graspable Math.")})}var e=[{title:"Math Gesture Tutorials",url:"https://graspablemath.com/mac/tutorial/index.html"},{title:"Homework Videos",url:"https://www.youtube.com/channel/UCgj6gNKkDgAMUtTcY70OJ2Q"},{title:"Live GM Chat",url:"https://gitter.im/graspablemath/Lobby"}],f=null;return a}(),Wa.ui=Wa.ui||{},Wa.ui.holdUI=function(){var a=function(a,b){this.container=d3.select("body"),this.controller=a,this.view=b,this.element=null,this.pos=[0,0],this.visible=!1,this.buttons=[],this.button_els=null,this.colors=d3.scale.category10(),this.button_rads=null,this.inner_radius=20,this.outer_radius=80,this.init()};return a.prototype.setPos=function(a){this.pos=a,this.element.style({left:a[0]-this.outer_radius+"px",top:a[1]-this.outer_radius+"px"})},a.prototype.setVisible=function(a){if(this.visible=a,this.element.style("display",a?null:"none"),this.visible){var b=this.g.node().getBBox();this.element.style({width:b.width,height:b.height})}},a.prototype.init=function(){var a=this,b={stroke:"black","stroke-width":1,"stroke-linecap":"round",fill:"none"};Wa.array.includes(this.controller.hold_menu_options(),"derivation")&&this.buttons.push({action:function(b){a.controller.inputDL(b,"holdUI")},icon:function a(b){var a=b.append("g").attr("transform","translate(0,10)").append("g"),c=new Wa.AlgebraModel("f_x",{}),d=new Wa.AlgebraView(c,a,{font_size:"35",inactive_color:"black",interactive:!1});return d.init(),a},color:a.colors(0)}),Wa.array.includes(this.controller.hold_menu_options(),"graph")&&this.buttons.push({action:function(b){var c=600,d=400,e=a.view.createElement("ggb-element",{pos:{x:b[0]-c/2,y:b[1]-d/2},size:{width:c,height:d}});a.view.createElement("ggb-panel",{ggbElement:e,pos:{x:b[0]+c/2,y:b[1]-d/2},size:{width:75,height:d},min_size:{width:75,height:50}})},icon:function a(c){var a=c.append("g").attr("transform","translate(2,0)").style("cursor","pointer"),d=a.append("g").style("opacity",.5).style("shape-rendering","crispedges");return d.append("line").attr({x1:-15,y1:0,x2:15,y2:0}).style(b),d.append("line").attr({x1:0,y1:-15,x2:0,y2:15}).style(b),d.append("rect").attr({x:-15,y:-15,width:30,height:30}).style(b),a.append("line").attr({x1:-15,y1:8,x2:15,y2:-8}).style(b).style("stroke-width",1.5),a},color:a.colors(1)}),Wa.array.includes(this.controller.hold_menu_options(),"textbox")&&this.buttons.push({action:function(b){var c={pos:{x:b[0],y:b[1]}};a.view.createTextBox(c)},icon:function a(c){var a=c.append("g"),d=a.append("g").style("opacity",.5);return d.append("text").text("Aa").attr({x:0,y:10}).style("text-anchor","middle").style("font-size","30px").style(b).style("stroke","none").style("fill","black").style("pointer-events","none"),a},color:a.colors(2)}),this.button_rads=2*Math.PI/this.buttons.length;var c=this.button_rads,d=this.inner_radius,e=this.outer_radius;this.element=this.container.append("svg").style("overflow","visible").style("display","none").style("position","absolute"),this.g=this.element.append("g").attr("transform","translate("+this.outer_radius+","+this.outer_radius+")");var f=this.element.append("defs"),g=f.append("filter").attr("id","dropShadow_holdUI");g.append("feGaussianBlur").attr("in","SourceAlpha").attr("stdDeviation",3),g.append("feOffset").attr("dx",0).attr("dy",4).attr("result","offsetblur"),g.append("feComponentTransfer").append("feFuncA").attr("type","linear").attr("slope",.25);var h=g.append("feMerge");h.append("feMergeNode"),h.append("feMergeNode").attr("in","SourceGraphic"),this.element.attr("filter","url(#dropShadow_holdUI)"),this.button_els=this.g.selectAll(".holdUI").data(this.buttons),this.button_els.enter().append("g").classed("holdUI",!0).append("path").attr("d",function(a,b){var f=Math.cos(c*b)*d,g=-Math.sin(c*b)*d,h=Math.cos(c*b)*e,i=-Math.sin(c*b)*e,j=Math.cos(c*(b+1))*e,k=-Math.sin(c*(b+1))*e,l=Math.cos(c*(b+1))*d,m=-Math.sin(c*(b+1))*d;return"M"+f+","+g+"L"+h+","+i+"A"+e+","+e+" 0 0,0 "+j+","+k+"L"+l+","+m+"A"+d+","+d+" 0 0,1 "+f+","+g+"Z"}).style("fill",function(a){return a.color}).style("opacity",.8).style("cursor","pointer"),this.button_els.each(function(a,b){var f=d3.select(this),g=a.icon(f);g.attr("transform",function(){var a=Math.cos(c*(b+.5))*(d+(e-d)/2),f=-Math.sin(c*(b+.5))*(d+(e-d)/2);return"translate("+a+", "+f+")"})})},a.prototype.detectHit=function(a){var b=this,c=this.button_rads,d=this.inner_radius,e=this.outer_radius,f=-1;return this.button_els.each(function(g,h){var i=Math.sqrt(Math.pow(a[0]-b.pos[0],2)+Math.pow(a[1]-b.pos[1],2)),j=Math.atan2(-a[1]+b.pos[1],a[0]-b.pos[0]);j<0&&(j+=2*Math.PI),i>d&&i<e&&j>c*h&&j<c*(h+1)&&(f=h)}),f},a.prototype.highlight=function(a){var b=this.detectHit(a);this.button_els.each(function(a,c){var d=d3.select(this).select("path");b===c?d.transition().duration(30).style("fill",d3.rgb(a.color).brighter(.6)):d.transition().duration(30).style("fill",a.color)})},a.prototype.performAction=function(a,b){var c=this.detectHit(a);this.button_els.each(function(a,d){d===c&&a.action(b)})},a}(),Wa.ui.addHomeworkButton=function(){function a(a){for(var b=0;b<h.length;b++)for(var c=h[b],d=0;d<c.subchapters.length;d++){var e=c.subchapters[d];if(e.problems.indexOf(a)!==-1)return{chapter:c,subchapter:e}}return null}function b(a){i=a,i.appendButtonGroup([{type:"dropdown",label:"problems",data_toggle:"dropdown",pull_right:!0,icon:"glyphicon glyphicon-book",html_fn:c}])}function c(a,b){q=a;var c={col1:380,row1:40,col2:580,height:360},f=d(q,c);return e(f,c),$(q).on("shown.bs.dropdown",function(){j()}),$(q).on("hide.bs.dropdown",function(){k()}),f.node()}function d(a,b){var c=22,d=d3.select(a).append("div").style("width",b.col1+b.col2+c+"px").style("padding","5px").on("click",function(){d3.event.stopPropagation()});return d.append("p").text("click on a problem, then on the canvas").style("color","gray").style("font-style","italic").style("text-align","center"),d}function e(a,b){function c(a){s.style("background-color",function(b,c){return b==a?"#e7f5fe":c%2==0?"whitesmoke":"white"}),o.selectAll(".problem").remove();var c=o.selectAll(".problem").data(a.problems),d=c.enter().append("div").classed("problem",!0).style("position","relative").style("width",b.col2+"px").style("background-color",function(a,b){return 0==a.parts.length?"#e6e6e6":b%2==0?"whitesmoke":"white"}).style({"-webkit-user-select":"none","-moz-user-select":"none","-ms-user-select":"none"}).style("cursor",function(a){return 0==a.parts.length?"default":"pointer"}).each(function(a,c){a.alignment||(a.alignment=m);var d=d3.select(this),e=0,f=0,g=0,h=0,j=d.append("div").style("position","relative").style("width",b.col2+"px").style("pointer-events","none"),k=(j.append("p").html(a.num).style("left","5px").style("width","30px").style("text-align","right"),j.append("p").html(a.text).style("left","45px").style("width",b.col2-18-90+"px"));j.selectAll("p").style("position","absolute").style("margin","0px").style("top","15px").style("font-weight","bold").style("color","lightskyblue").style("pointer-events","none");var o=parseFloat(k.style("height"))+15;0==a.parts.length&&(o+=15),j.style("height",o+"px"),f+=o,"row"==a.alignment&&(d=d.append("div").style("position","absolute").style("left","50%").style("transform","translateX(-50%)"));var p=d.selectAll(".part").data(a.parts);
p.enter().append("div").classed("part","true").style("position","relative").style("pointer-events","none").each(function(c){var d=d3.select(this),j=0,k=0;if("derivation"==c.type){var m=d.append("svg").style("pointer-events","none"),o=new Wa.AlgebraModel(c.options.eq),p={font_size:20,v_align:"center",fixed:!0},q=new Wa.AlgebraView(o,m,p);q.init(function(){var c=q.getBBox();k=c.height+30,"row"==a.alignment?(j=c.width+80,e+=j,m.style("position","absolute").style("top","50%").style("transform","translateY(-50%)")):"column"==a.alignment&&(j=b.col2-18),d.style("width",j+"px"),m.style("width",j+"px").style("height",k+"px"),q.main.attr("transform","translate("+[j/2,k/2].join(",")+")")})}else if("textbox"==c.type){var r=d.append("p").html(c.options.text).style("margin","0px").style("pointer-events","none");"row"==a.alignment?(j=r.node().clientWidth+40,e+=j,r.style("position","absolute").style("top","50%").style("transform","translateY(-50%)").style("text-align","center")):"column"==a.alignment&&(j=b.col2-18-90,r.style("position","absolute").style("left","45px").style("top",a.text?"10px":"0px")),d.style("width",j+"px"),r.style("width",j+"px"),k=r.node().clientHeight,c.options.size={width:j,height:k},c.options.font_size=parseFloat(r.style("font-size")),k+=20}else if("ggb-element"==c.type){var s=d.append("div").style("position","absolute").style("left","50%").style("top","50%").style("transform","translate(-50%, -50%)").style("width",n.width+"px").style("height",n.height+"px").style("border","1px solid black").style("overflow","hidden"),t=c.options;t.pos={x:0,y:0},t.size=n;new Wa.ui.GeoGebraCanvasElement(i.model,s.node(),c.options,function(a){a.element_div.style("pointer-events","none"),a.ggbApplet.setCoordSystem(t.xmin,t.xmax,t.ymin,t.ymax),a.ggbApplet.setAxisSteps(1,1,1,1),t.points.forEach(function(b,c){var d=String.fromCharCode(97+c).toUpperCase();a.ggbApplet.evalCommand(d+"=("+b.x+","+b.y+")"),a.ggbApplet.setColor(d,135,206,250),b.label&&(a.ggbApplet.setCaption(d,b.label),a.ggbApplet.setLabelStyle(d,3),a.ggbApplet.setLabelVisible(d,!0))}),t.lines.forEach(function(b,c){var d=String.fromCharCode(97+c);a.ggbApplet.evalCommand(d+":"+b.eq),a.ggbApplet.setColor(d,135,206,250),b.label&&(a.ggbApplet.setCaption(d,b.label),a.ggbApplet.setLabelStyle(d,3),a.ggbApplet.setLabelVisible(d,!0))})});"row"==a.alignment?(j=n.width+40,e+=j):"column"==a.alignment&&(j=b.col2-18),d.style("width",j+"px"),k=n.height+40}if("row"==a.alignment?(k>g&&(g=k),d.style("display","inline-block").style("height","100%")):"column"==a.alignment&&(f+=k,d.style("height",k+"px")),c.label){var u=d.append("p").html(l(h)).style("position","absolute").style("color","lightskyblue").style("pointer-events","none");"row"==a.alignment?u.style("top","50%").style("transform","translateY(-50%)"):"column"==a.alignment&&u.style("left","5px").style("top","10px").style("width","30px").style("text-align","right"),h++}});"row"==a.alignment?(d.style("width",e+"px").style("height",g+"px"),f+=g,d3.select(d.node().parentNode).style("height",f+"px")):"column"==a.alignment&&d.style("height",f+"px")}).on("click",function(a,b){0!=a.parts.length&&(d.filter(function(b){return b==a}).transition().duration(150).style("background-color","#e7f5fe").transition().duration(150).style("background-color",b%2==0?"whitesmoke":"white").each("end",f),g(a))})}var d=a.append("div").style("width",b.col1+b.col2+2+"px").style("height",b.height+2+"px").style("margin","5px").style("border","1px solid silver"),e=d.append("div").classed("panel",!0).style("width",b.col1+"px"),o=d.append("div").classed("panel",!0).style("width",b.col2+"px");a.selectAll(".panel").style("height",b.height+"px").style("border","none").style("margin","0px").style("display","inline-block").style("overflow-y","scroll").style("overflow-x","hidden");var p=e.selectAll(".chapter").data(h),q=p.enter().append("div").classed("chapter",!0);q.append("div").style("width",b.col1+"px").style("height",b.row1+"px").style("background-color","#e6e6e6").style({"-webkit-user-select":"none","-moz-user-select":"none","-ms-user-select":"none"}).style("overflow","hidden").style("padding-left","5px").style("line-height",b.row1+"px").append("p").html(function(a){return a.title}).style("font-weight","bold").style("pointer-events","none");var r=p.selectAll(".subchapter").data(function(a){return a.subchapters}),s=r.enter().append("div").classed("subchapter",!0);s.append("div").style("width",b.col1+"px").style("height",b.row1+"px").style({"-webkit-user-select":"none","-moz-user-select":"none","-ms-user-select":"none"}).style("overflow","hidden").style("padding-left","5px").style("line-height",b.row1+"px").style("cursor","pointer").on("click",c).append("p").html(function(a){return a.title}).style("pointer-events","none"),j=function(){c(h[0].subchapters[0])},k=function(){o.selectAll(".problem").remove()}}function f(){$("body").trigger("click")}function g(b){function c(){function a(c){if(b.parts.length>c){var d=function(d){"row"==b.alignment?e+=d.size.width+20:"column"==b.alignment&&(f+=d.size.height+20),a(c+1),"ggb-element"==b.parts[c].type&&(d.element_div.style("pointer-events","none").style("border","1px solid black").style("overflow","hidden"),d.ggbApplet.setCoordSystem(g.xmin,g.xmax,g.ymin,g.ymax),d.ggbApplet.setAxisSteps(1,1,1,1),g.points.forEach(function(a,b){var c=String.fromCharCode(97+b).toUpperCase();d.ggbApplet.evalCommand(c+"=("+a.x+","+a.y+")"),d.ggbApplet.setColor(c,135,206,250),a.label&&(d.ggbApplet.setCaption(c,a.label),d.ggbApplet.setLabelStyle(c,3),d.ggbApplet.setLabelVisible(c,!0))}),g.lines.forEach(function(a,b){var c=String.fromCharCode(97+b);d.ggbApplet.evalCommand(c+":"+a.eq),d.ggbApplet.setColor(c,135,206,250),a.label&&(d.ggbApplet.setCaption(c,a.label),d.ggbApplet.setLabelStyle(c,3),d.ggbApplet.setLabelVisible(c,!0))}))};i.controller.simulateEndOfInteraction();var g=b.parts[c].options;switch(g.pos={x:e,y:f},g.v_align="top",b.parts[c].type){case"derivation":i.model.createDL(b.parts[c].options,d,"homework-menu");break;case"textbox":i.model.createTextBox(b.parts[c].options,d,"homework-menu");break;case"ggb-element":g.size=o,i.model.createElement("ggb-element",b.parts[c].options,"homework-menu",d)}i.controller.simulateEndOfInteraction()}}i.model.setActive(),i.controller.simulateStartOfInteraction(),a(0)}var d=a(b);i.logger.logCustomInteraction("homework-menu",{action:"select",problem:b.num,chapter:d.chapter.title,subchapter:d.subchapter.title});var e=20,f=0;i.model.elements().forEach(function(a){var b=a.pos.y+a.size.height;b>f&&(f=b)}),f+=20,b.text?i.model.createTextBox({pos:{x:e,y:f},size:{width:472},text:b.text},function(a){f+=a.size.height+20,c()}):c()}var h=[{title:"Chapter 1 Fundamental Concepts of Algebra",subchapters:[{title:"1.1 Real Numbers",problems:[{num:1,text:"If <i>x</i> < 0 and <i>y</i> > 0, determine the sign of the real number.",alignment:"row",parts:[{type:"derivation",options:{eq:"xy"},label:!0},{type:"derivation",options:{eq:"x^2y"},label:!0},{type:"derivation",options:{eq:"x/y+x"},label:!0},{type:"derivation",options:{eq:"y-x"},label:!0}]},{num:"3, 5",text:"We're not yet supporting these problems. Please see p. 13 in the textbook.",alignment:null,parts:[]},{num:7,text:"Express the statement as an inequality.",alignment:"column",parts:[{type:"textbox",options:{text:"<i>x</i> is negative."},label:!0},{type:"textbox",options:{text:"<i>y</i> is nonnegative."},label:!0},{type:"textbox",options:{text:"<i>q</i> is less than or equal to <i>π</i>."},label:!0},{type:"textbox",options:{text:"<i>d</i> is between 4 and 2."},label:!0},{type:"textbox",options:{text:"<i>t</i> is not less than 5."},label:!0}]},{num:9,text:"Rewrite the number without using the absolute value symbol, and simplify the result.",alignment:"row",parts:[{type:"derivation",options:{eq:"|-3-2|"},label:!0},{type:"derivation",options:{eq:"|-5|-|2|"},label:!0},{type:"derivation",options:{eq:"|7|+|-4|"},label:!0}]},{num:11,text:"Rewrite the number without using the absolute value symbol, and simplify the result.",alignment:"row",parts:[{type:"derivation",options:{eq:"(-5)*|3-6|"},label:!0},{type:"derivation",options:{eq:"|-6|/(-2)"},label:!0},{type:"derivation",options:{eq:"|-7|+|4|"},label:!0}]},{num:13,text:"Rewrite the number without using the absolute value symbol, and simplify the result.",alignment:"row",parts:[{type:"derivation",options:{eq:"|4-π|"},label:!0},{type:"derivation",options:{eq:"|π-4|"},label:!0},{type:"derivation",options:{eq:"|sqrt2-1.5|"},label:!0}]},{num:15,text:"We're not yet supporting this problem. Please see p. 14 in the textbook.",alignment:null,parts:[]},{num:19,text:"The two given numbers are coordinates of points <i>A</i> and <i>B</i>, respectively, on a coordinate line. Express the indicated statement as an inequality involving the absolute value symbol.",alignment:"row",parts:[{type:"derivation",options:{eq:"x"},label:!1},{type:"derivation",options:{eq:"7"},label:!1},{type:"textbox",options:{text:"<i>d</i>(<i>A</i>, <i>B</i>) is less than 5"},label:!1}]},{num:23,text:"The two given numbers are coordinates of points <i>A</i> and <i>B</i>, respectively, on a coordinate line. Express the indicated statement as an inequality involving the absolute value symbol.",alignment:"row",parts:[{type:"derivation",options:{eq:"4"},label:!1},{type:"derivation",options:{eq:"x"},label:!1},{type:"textbox",options:{text:"<i>d</i>(<i>A</i>, <i>B</i>) is not greater than 3"},label:!1}]},{num:25,text:"Rewrite the expression without using absolute the value symbol, and simplify the result.",alignment:"row",parts:[{type:"derivation",options:{eq:"|3+x|"},label:!1},{type:"textbox",options:{text:"if <i>x</i> < -3"},label:!1}]},{num:27,text:"Rewrite the expression without using the absolute value symbol, and simplify the result.",alignment:"row",parts:[{type:"derivation",options:{eq:"|2-x|"},label:!1},{type:"textbox",options:{text:"if <i>x</i> < 2"},label:!1}]},{num:29,text:"Rewrite the expression without using the absolute value symbol, and simplify the result.",alignment:"row",parts:[{type:"derivation",options:{eq:"|a-b|"},label:!1},{type:"textbox",options:{text:"if <i>a</i> < b"},label:!1}]},{num:31,text:"Rewrite the expression without using the absolute value symbol, and simplify the result.",alignment:"row",parts:[{type:"derivation",options:{eq:"|x^2+4|"},label:!1}]},{num:"33-53",text:"We're not yet supporting these problems. Please see p. 14 in the textbook.",alignment:null,parts:[]},{num:57,text:"Avogadro's number",alignment:null,parts:[{type:"textbox",options:{text:"The number of hydrogen atoms in a mole is Avogadro's number, 6.02 x 10<sup>23</sup>. If one mole of the gas has a mass of 1.01 grams, estimate the mass of a hydrogen atom."},label:!1}]},{num:59,text:"Frames in a movie film",alignment:null,parts:[{type:"textbox",options:{text:"One of the longest movies ever made is a 1970 British film that runs for 48 hours. Assuming that the film speed is 24 frames per second, approximate the total number of frames in this film. Express your answer in scientific form."},label:!1}]},{num:61,text:"Tornado pressure",alignment:"column",parts:[{type:"textbox",options:{text:"When a tornado passes near a building, there is a rapid drop in the outdoor pressure and the indoor pressure does not have time to change. The resulting difference is capable of causing an outward pressure of 1.4 lb/in<sup>2</sup> on the walls and ceiling of the building."},label:!1},{type:"textbox",options:{text:"Calculate the force in pounds exerted on 1 square foot of a wall."},label:!0},{type:"textbox",options:{text:"Estimate the tons of force exerted on a wall that is 8 feet high and 40 feet wide."},label:!0}]}]},{title:"1.2 Exponents and Radicals",problems:[{num:3,text:"Express the number in the form <i>a</i>/<i>b</i>, where <i>a</i> and <i>b</i> are integers.",alignment:null,parts:[{type:"derivation",options:{eq:"2^-3/3^-2"},label:!1}]},{num:5,text:"Express the number in the form <i>a</i>/<i>b</i>, where <i>a</i> and <i>b</i> are integers.",alignment:null,parts:[{type:"derivation",options:{eq:"-2^4+3^-1"},label:!1}]},{num:7,text:"Express the number in the form <i>a</i>/<i>b</i>, where <i>a</i> and <i>b</i> are integers.",alignment:null,parts:[{type:"derivation",options:{eq:"16^(-3/4)"},label:!1}]},{num:9,text:"Express the number in the form <i>a</i>/<i>b</i>, where <i>a</i> and <i>b</i> are integers.",alignment:null,parts:[{type:"derivation",options:{eq:"(-0.008)^(2/3)"},label:!1}]},{num:13,text:"Simplify.",alignment:null,parts:[{type:"derivation",options:{eq:"((2x^3)(3x^2))/(x^2)^3"},label:!1}]},{num:15,text:"Simplify.",alignment:null,parts:[{type:"derivation",options:{eq:"(1/6a^5)(-3a^2)(4a^7)"},label:!1}]},{num:21,text:"Simplify.",alignment:null,parts:[{type:"derivation",options:{eq:"(8x^4y^-3)(1/2x^-5y^2)"},label:!1}]},{num:25,text:"Simplify.",alignment:null,parts:[{type:"derivation",options:{eq:"(3y^3)^4(4y^2)^-3"},label:!1}]},{num:29,text:"Simplify.",alignment:null,parts:[{type:"derivation",options:{eq:"(5x^2y^-3)(4x^-5y^4)"},label:!1}]},{num:31,text:"Simplify.",alignment:null,parts:[{type:"derivation",options:{eq:"((3x^5y^4)/(x^0y^-3))^2"},label:!1}]},{num:35,text:"Simplify.",alignment:null,parts:[{type:"derivation",options:{eq:"(3x^(5/6))(8x^(2/3))"},label:!1}]},{num:39,text:"Simplify.",alignment:null,parts:[{type:"derivation",options:{eq:"(8x^(-2/3))x^(1/6)"},label:!1}]},{num:41,text:"Simplify.",alignment:null,parts:[{type:"derivation",options:{eq:"((-8x^3)/y^-6)^(2/3)"},label:!1}]},{num:43,text:"Simplify.",alignment:null,parts:[{type:"derivation",options:{eq:"(x^6/(9y^-4))^(-1/2)"},label:!1}]},{num:45,text:"Simplify.",alignment:null,parts:[{type:"derivation",options:{eq:"(x^6y^3)^(-1/3)/(x^4y^2)^(-1/2)"},label:!1}]},{num:49,text:"Rewrite the expression using rational exponents.",alignment:null,parts:[{type:"derivation",options:{eq:"sqrt[3]{(a+b)^2}"},label:!1}]},{num:51,text:"Rewrite the expression using rational exponents.",alignment:null,parts:[{type:"derivation",options:{eq:"sqrt{x^2+y^2}"},label:!1}]},{num:53,text:"Rewrite the expression using a radical.",alignment:"row",parts:[{type:"derivation",options:{eq:"4x^(2/3)"},label:!0},{type:"derivation",options:{eq:"(4x)^(3/2)"},label:!0}]},{num:55,text:"Rewrite the expression using a radical.",alignment:"row",parts:[{type:"derivation",options:{eq:"8-y^(1/3)"},label:!0},{type:"derivation",options:{eq:"(8-y)^(1/3)"},label:!0}]},{num:65,text:"Simplify the expression, and rationalize the denominator when appropriate.",alignment:null,parts:[{type:"derivation",options:{eq:"sqrt[3]{8a^6b^-3}"},label:!1}]},{num:67,text:"Simplify the expression, and rationalize the denominator when appropriate.",alignment:null,parts:[{type:"derivation",options:{eq:"sqrt{(3x)/(2y^3)}"},label:!1}]},{num:69,text:"Simplify the expression, and rationalize the denominator when appropriate.",alignment:null,parts:[{type:"derivation",options:{eq:"sqrt[3]{(2x^4y^4)/(9x)}"},label:!1}]},{num:71,text:"Simplify the expression, and rationalize the denominator when appropriate.",alignment:null,parts:[{type:"derivation",options:{eq:"sqrt[4]{(5x^8y^3)/(27x^2)}"},label:!1}]},{num:73,text:"Simplify the expression, and rationalize the denominator when appropriate.",alignment:null,parts:[{type:"derivation",options:{eq:"sqrt[5]{(5x^7y^2)/(8x^3)}"},label:!1}]},{num:77,text:"Simplify the expression, and rationalize the denominator when appropriate.",alignment:null,parts:[{type:"derivation",options:{eq:"sqrt[5]{(8x^3)/y^4}*sqrt[5]{(4x^4)/y^2}"},label:!1}]},{num:79,text:"Simplify the expression, and rationalize the denominator when appropriate.",alignment:null,parts:[{type:"derivation",options:{eq:"sqrt[3]{3t^4v^2}*sqrt[3]{-9t^-1v^4}"},label:!1}]},{num:81,text:"Simplify the expression, assuming <i>x</i> and <i>y</i> may be negative.",alignment:null,parts:[{type:"derivation",options:{eq:"sqrt{x^6y^4}"},label:!1}]},{num:83,text:"Simplify the expression, assuming <i>x</i> and <i>y</i> may be negative.",alignment:null,parts:[{type:"derivation",options:{eq:"sqrt[4]{x^8(y-1)^12}"},label:!1}]},{num:"85-93",text:"We're not yet supporting these problems. Please see p. 26 in the textbook.",alignment:null,parts:[]},{num:95,text:"Savings account",alignment:null,parts:[{type:"textbox",options:{text:"One of the oldest banks in the United States is the Bank of America, founded in 1812. If $200 had been deposited at that time into an account that paid 4% annual interest, then 180 years later the amount would have grown to 200(1.04)<sup>180</sup> dollars. Approximate this amount to the nearest cent."},label:!1}]},{num:"97-99",text:"We're not yet supporting this problem. Please see p. 26 in the textbook.",alignment:null,parts:[]}]},{title:"1.3 Algebraic Expressions",problems:[{num:3,text:"Express as a polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"(4x^3+5x-3)-(3x^3+2x^2+5x-7)"},label:!1}]},{num:9,text:"Express as a polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"(2u+3)(u-4)+4u(u-2)"},label:!1}]},{num:11,text:"Express as a polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"(3x+5)(2x^2+9x-5)"},label:!1}]},{num:13,text:"Express as a polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"(t^2+2t-5)(3t^2-t+2)"},label:!1}]},{num:15,text:"Express as a polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"(x+1)(2x^2-2)(x^3+5)"},label:!1}]},{num:19,text:"Express as a polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"(3u^3v^4-2u^5v^2+(u^2v^2)^2)/(u^3v^2)"},label:!1}]},{num:25,text:"Express as a polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"(x^2+9)(x^2-4)"},label:!1}]},{num:29,text:"Express as a polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"(x^2-3y^2)^2"},label:!1}]},{num:37,text:"Express as a polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"(x-2y)^3"},label:!1}]},{num:39,text:"Express as a polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"(2x+3y)^3"},label:!1}]},{num:43,text:"Express as a polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"(2x+y-3z)^2"},label:!1}]},{num:51,text:"Factor the polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"15x^3y^5-25x^4y^2+10x^6y^4"},label:!1}]},{num:57,text:"Factor the polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"6x^2+7x-20"},label:!1}]},{num:65,text:"Factor the polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"45x^2+38xy+8y^2"},label:!1}]},{num:69,text:"Factor the polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"z^4-64w^2"},label:!1}]},{num:73,text:"Factor the polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"x^2+25"},label:!1}]},{num:77,text:"Factor the polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"64x^3+27"},label:!1}]},{num:79,text:"Factor the polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"64x^3-y^6"},label:!1}]},{num:81,text:"Factor the polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"343x^3+y^9"},label:!1}]},{num:83,text:"Factor the polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"125-27x^3"},label:!1}]},{num:85,text:"Factor the polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"2ax-6bx+ay-3by"},label:!1}]},{num:87,text:"Factor the polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"3x^3+3x^2-27x-27"},label:!1}]},{num:89,text:"Factor the polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"x^4+2x^3-x-2"},label:!1}]},{num:91,text:"Factor the polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"a^3-a^2b+ab^2-b^3"},label:!1}]},{num:93,text:"Factor the polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"a^6-b^6"},label:!1}]},{num:95,text:"Factor the polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"x^2+4x+4-9y^2"},label:!1}]},{num:97,text:"Factor the polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"y^2-x^2+8y+16"},label:!1}]},{num:99,text:"Factor the polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"y^6+7y^3-8"},label:!1}]},{num:101,text:"Factor the polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"x^16-1"},label:!1}]}]},{title:"1.4 Fractional Expressions",problems:[{num:3,text:"Write the expression as a simplified rational number.",alignment:null,parts:[{type:"derivation",options:{eq:"5/24-3/20"},label:!1}]},{num:13,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"(5a^2+12a+4)/(a^4-16)/(25a^2+20a+4)/(a^2-2a)"},label:!1}]},{num:21,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"(3t)/(t+2)+(5t)/(t-2)-40/(t^2-4)"},label:!1}]},{num:25,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"(2x)/(x+2)-8/(x^2+2x)+3/x"},label:!1}]},{num:31,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"((2x+1)/(x^2+4x+4))-((6x)/(x^2-4))+3/(x-2)"},label:!1}]},{num:33,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"(b/a-a/b)/(1/a-1/b)"},label:!1}]},{num:35,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"(x/y^2-y/x^2)/(1/y^2-1/x^2)"},label:!1}]},{num:37,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"(y^-1+x^-1)/(xy)^-1"},label:!1}]},{num:39,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"(5/(x+1)+(2x)/(x+3))/(x/(x+1)+7/(x+3))"},label:!1}]},{num:41,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"(3/(x-1)-3/(a-1))/(x-a)"},label:!1}]},{num:43,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"((x+h)^2-3(x+h)-(x^2-3x))/h"},label:!1}]},{num:45,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"(1/(x+h)^3-1/x^3)/h"},label:!1}]},{num:47,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"(4/(3x+3h-1)-4/(3x-1))/h"},label:!1}]},{num:51,text:"Rationalize the denominator.",alignment:null,parts:[{type:"derivation",options:{eq:"(81x^2-16y^2)/(3sqrtx-2sqrty)"},label:!1}]},{num:55,text:"Rationalize the numerator.",alignment:null,parts:[{type:"derivation",options:{eq:"(sqrta-sqrtb)/(a^2-b^2)"},label:!1}]},{num:57,text:"Rationalize the numerator.",alignment:null,parts:[{type:"derivation",options:{eq:"(sqrt{2(x+h)+1}-sqrt{2x+1})/h"},label:!1}]},{num:63,text:"Express as a sum of terms of the form <i>ax<sup>r</sup></i>, where <i>r</i> is a rational number.",alignment:null,parts:[{type:"derivation",options:{eq:"(x^2+2)^2/x^5"},label:!1}]},{num:67,text:"Express as a quotient.",alignment:null,parts:[{type:"derivation",options:{eq:"x^(-1/2)-x^(3/2)"},label:!1}]},{num:69,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"(2x^2-3x+1)(4)(3x+2)^3(3)+(3x+2)^4(4x-3)"},label:!1}]},{num:71,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"(x^2-4)^(1/2)(3)(2x+1)^2(2)+(2x+1)^3(1/2)(x^2-4)^(-1/2)(2x)"},label:!1}]},{num:73,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"(3x+1)^6(1/2)(2x-5)^(-1/2)(2)+(2x-5)^(1/2)(6)(3x+1)^5(3)"},label:!1}]},{num:75,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"((6x+1)^3(27x^2+2)-(9x^3+2x)(3)(6x+1)^2(6))/(6x+1)^6"},label:!1}]},{num:77,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"((x^2+2)^3(2x)-x^2(3)(x^2+2)^2(2x))/[(x^2+2)^3]^2"},label:!1}]},{num:79,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"((x^2+4)^(1/3)(3)-(3x)(1/3)(x^2+4)^(-2/3)(2x))/[(x^2+4)^(1/3)]^2"},label:!1}]},{num:81,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"((4x^2+9)^(1/2)(2)-(2x+3)(1/2)(4x^2+9)^(-1/2)(8x))/[(4x^2+9)^(1/2)]^2"},label:!1}]}]}]},{title:"Chapter 2 Equations and Inequalities",subchapters:[{title:"2.1 Equations",problems:[{num:7,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"1/5x+2=3-2/7x"},label:!1}]},{num:9,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"0.3(3+2x)+1.2x=3.2"},label:!1}]},{num:13,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"(13+2x)/(4x+1)=3/4"},label:!1}]},{num:15,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"8-5/x=2+3/x"},label:!1}]},{num:17,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"(3x-2)^2=(x-5)(9x+4)"},label:!1}]},{num:21,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"(3x+1)/(6x-2)=(2x+5)/(4x-13)"},label:!1}]},{num:23,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"2/5+4/(10x+5)=7/(2x+1)"},label:!1}]},{num:27,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"2-5/(3x-7)=2"},label:!1}]},{num:31,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"7/(y^2-4)-4/(y+2)=5/(y-2)"},label:!1}]},{num:33,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"(x+3)^3-(3x-1)^2=x^3+4"},label:!1}]},{num:35,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"(9x)/(3x-1)=2+3/(3x-1)"},label:!1}]},{num:37,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"1/(x+4)+3/(x-4)=(3x+8)/(x^2-16)"},label:!1}]},{num:39,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"4/(x+2)+1/(x-2)=(5x-6)/(x^2-4)"},label:!1}]},{num:41,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"2/(2x+1)-3/(2x-1)=(-2x+7)/(4x^2-1)"},label:!1}]},{num:43,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"5/(2x+3)+4/(2x-3)=(14x+3)/(4x^2-9)"},label:!1}]},{num:51,text:"For what value of <i>c</i> is the number <i>a</i> a solution of the equation?",alignment:null,parts:[{type:"derivation",options:{eq:"4x+1+2c=5c-3x+6"},label:!1},{type:"derivation",options:{eq:"a=-2"},label:!1}]},{num:55,text:"Determine values for <i>a</i> and <i>b</i> such that <sup>5</sup>&frasl;<sub>3</sub> is a solution of the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"ax+b=0"},label:!1}]},{num:57,text:"Determine which equation is not equivalent to the equation preceding it.",alignment:null,parts:[{type:"derivation",options:{eq:"x^2-x-2=x^2-4"},label:!1},{type:"derivation",options:{eq:"(x+1)(x-2)=(x+2)(x-2)"},label:!1},{type:"derivation",options:{eq:"x+1=x+2"},label:!1},{type:"derivation",options:{eq:"1=2"},label:!1}]},{num:59,text:"Solve the formula for the specified variable.",alignment:"row",parts:[{type:"derivation",options:{eq:"EK+L=D-TK"},label:!1},{type:"textbox",options:{text:"for <i>K</i>"},label:!1}]},{num:61,text:"Solve the formula for the specified variable.",alignment:"row",parts:[{type:"derivation",options:{eq:"M=(Q+1)/Q"},label:!1},{type:"textbox",options:{text:"for <i>Q</i>"},label:!1}]},{num:67,text:"The formula occurs in the indicated application. Solve for the specified variable.",alignment:"row",parts:[{type:"derivation",options:{eq:"F=g(mM)/d^2"},label:!1},{type:"textbox",options:{text:"for <i>m</i> (Newton's law of gravitation)"},label:!1}]},{num:69,text:"The formula occurs in the indicated application. Solve for the specified variable.",alignment:"row",parts:[{type:"derivation",options:{eq:"P=2l+2w"},label:!1},{type:"textbox",options:{text:"for <i>w</i> (perimeter of a rectangle)"},label:!1}]},{num:71,text:"The formula occurs in the indicated application. Solve for the specified variable.",alignment:"row",parts:[{type:"derivation",options:{eq:"A=1/2(b_1+b_2)h"},label:!1},{type:"textbox",options:{text:"for <i>b</i><sub>1</sub> (area of a trapezoid)"},label:!1}]},{num:73,text:"The formula occurs in the indicated application. Solve for the specified variable.",alignment:"row",parts:[{type:"derivation",options:{eq:"S=p/(q+p(1-q))"},label:!1},{type:"textbox",options:{text:"for <i>q</i> (Amdahl's law for supercomputers)"},label:!1}]},{num:75,text:"The formula occurs in the indicated application. Solve for the specified variable.",alignment:"row",parts:[{type:"derivation",options:{eq:"1/f=1/p+1/q"},label:!1},{type:"textbox",options:{text:"for <i>q</i> (lens equation)"},label:!1}]}]},{title:"2.2 Applied Problems",problems:[{num:1,text:"Test scores",alignment:null,parts:[{type:"textbox",options:{text:"A student in an algebra course has test scores of 75, 82, 71, and 84. What score on the next test will raise the student's average to 80?"},label:!1}]},{num:2,text:"Final class average",alignment:null,parts:[{type:"textbox",options:{text:"Before the final exam, a student has test scores of 72, 80, 65, 78, and 60. If the final exam counts as one-third of the final grade, what score must the student receive in order to have a final average of 76?"},label:!1}]},{num:3,text:"Gross pay",alignment:null,parts:[{type:"textbox",options:{text:"A worker’s take-home pay is $492, after deductions totaling 40% of the gross pay have been subtracted. What is the gross pay?"},label:!1}]},{num:4,text:"Cost of dining out",alignment:null,parts:[{type:"textbox",options:{text:"A couple does not wish to spend more than $70 for dinner at a restaurant. If a sales tax of 6% is added to the bill and they plan to tip 15% after the tax has been added, what is the most they can spend for the meal?"},label:!1}]},{num:5,text:"Intelligence quotient",alignment:"column",parts:[{type:"textbox",options:{text:"A person's intelligence quotient (IQ) is determined by multiplying the quotient of his or her mental age and chonological age by 100."},label:!1},{type:"textbox",options:{text:"Find the IQ of a 12-year-old child whose mental age is 15."},label:!0},{type:"textbox",options:{text:"Find the mental age of a person 15 years old whose IQ is 140."},label:!0}]},{num:7,text:"Cost of insulation",alignment:null,parts:[{type:"textbox",options:{text:"The cost of installing insulation in a particular two-bedroom home is $2400. Present monthly heating costs average $200, but the insulation is expected to reduce heating costs by 10%. How many months will it take to recover the cost of the insulation?"},label:!1}]},{num:9,text:"Savings accounts",alignment:null,parts:[{type:"textbox",options:{text:"An algebra student has won $100,000 in a lottery and wishes to deposit it in savings accounts in two financial institutions. One account pays 8% simple interest, but deposits are insured only to $50,000. The second account pays 6.4% simple interest, and deposits are insured up to $100,000. Determine whether the money can be deposited so that it is fully insured and earns annual interest of $7500."},label:!1}]},{num:11,text:"Movie attendance",alignment:null,parts:[{type:"textbox",options:{text:"Six hundred people attended the premiere of a motion picture. Adult tickets cost $9, and children were admitted for $6. If box office receipts totaled $4800, how many children attended the premiere?"},label:!1}]},{num:13,text:"Preparing a glucose solution",alignment:null,parts:[{type:"textbox",options:{text:"In a certain medical test designed to measure carbohydrate tolerance, an adult drinks 7 ounces of a 30% glucose solution. When the test is administered to a child, the glucose concentration must be decreased to 20%. How much 30% glucose solution and how much water should be used to prepare 7 ounces of 20% glucose solution?"},label:!1}]},{num:15,text:"Preparing an alloy",alignment:null,parts:[{type:"textbox",options:{text:"British sterling silver is a copper-silver alloy that is 7.5% copper by weight. How many grams of pure copper and how many grams of British sterling silver should be used to prepare 200 grams of a copper-silver alloy that is 10% copper by weight?"},label:!1}]},{num:17,text:"Walking rates",alignment:"column",parts:[{type:"textbox",
options:{text:"Two children, who are 224 meters apart, start walking toward each other at the same instant at rates of 1.5 m/sec and 2 m/sec, respectively (see the figure on p. 71)."},label:!1},{type:"textbox",options:{text:"When will they meet?"},label:!0},{type:"textbox",options:{text:"How far will each have walked?"},label:!0}]},{num:19,text:"Snowplow speed",alignment:null,parts:[{type:"textbox",options:{text:"At 6 A.M. a snowplow, traveling at a constant speed, begins to clear a highway leading out of town. At 8 A.M. an automobile begins traveling the highway at a speed of 30 and reaches the plow 30 minutes later. Find the speed of the snowplow."},label:!1}]},{num:21,text:"Rowing rate",alignment:"column",parts:[{type:"textbox",options:{text:"A boy can row a boat at a constant rate of 5 mi/hr in still water, as indicated in the figure (p. 71). He rows upstream for 15 minutes and then rows downstream, returning to his starting point in another 12 minutes."},label:!1},{type:"textbox",options:{text:"Find the rate of the current."},label:!0},{type:"textbox",options:{text:"Find the total distance traveled."},label:!0}]},{num:23,text:"Distance to a target",alignment:null,parts:[{type:"textbox",options:{text:"A bullet is fired horizontally at a target, and the sound of its impact is heard 1.5 seconds later. If the speed of the bullet is 3300 ft/sec and the speed of sound is 1100 ft/sec, how far away is the target?"},label:!1}]},{num:25,text:"Fencing a region",alignment:null,parts:[{type:"textbox",options:{text:"A farmer plans to use 180 feet of fencing to enclose a rectangular region, using part of a straight river bank instead of fencing as one side of the rectangle, as shown in the figure on the next page (p. 72). Find the area of the region if the length of the side parallel to the river bank is"},label:!1},{type:"textbox",options:{text:"twice the length of an adjacent side."},label:!0},{type:"textbox",options:{text:"one-half the length of an adjacent side."},label:!0},{type:"textbox",options:{text:"the same as the length of an adjacent side."},label:!0}]},{num:29,text:"Constructing a silo",alignment:null,parts:[{type:"textbox",options:{text:"A large grain silo is to be constructed in the shape of a circular cylinder with a hemisphere attached to the top (see the figure on p. 72). The diameter of the silo is to be 30 feet, but the height is yet to be determined. Find the height <i>h</i> of the silo that will result in a capacity of 11,250<i>π</i> ft<sup>3</i>."},label:!1}]},{num:31,text:"Lawn mowing rates",alignment:null,parts:[{type:"textbox",options:{text:"It takes a boy 90 minutes to mow the lawn, but his sister can mow it in 60 minutes. How long would it take them to mow the lawn if they worked together, using two lawn mowers?"},label:!1}]},{num:33,text:"Delivering newspapers",alignment:null,parts:[{type:"textbox",options:{text:"It takes a girl 45 minutes to deliver the newspapers on her route; however, if her brother helps, it takes them only 20 minutes. How long would it take her brother to deliver the newspapers by himself?"},label:!1}]},{num:35,text:"Grade point average (GPA)",alignment:null,parts:[{type:"textbox",options:{text:"A college student has finished 48 credit hours with a GPA of 2.75. To get into the program she wishes to enter, she must have a GPA of 3.2. How many additional credit hours of 4.0 work will raise her GPA to 3.2?"},label:!1}]},{num:37,text:"Air temperature",alignment:"column",parts:[{type:"textbox",options:{text:"Below the cloud base, the air temperature <i>T</i> (in °F) at height <i>h</i> (in feet) can be approximated by the equation <i>T</i> = <i>T</i><sub>0</sub> - (<sup>5.5</sup>&frasl;<sub>1000</sub>)<i>h</i>, where <i>T</i><sub>0</sub> is the temperature at ground level."},label:!1},{type:"textbox",options:{text:"Determine the air temperature at a height of 1 mile if the ground temperature is 70°F."},label:!0},{type:"textbox",options:{text:"At what altitude is the temperature freezing?"},label:!0}]},{num:39,text:"A cloud's temperature",alignment:null,parts:[{type:"textbox",options:{text:"The temperature <i>T</i> within a cloud at height <i>h</i> (in feet) above the cloud base can be approximated using the equation <i>T</i> = <i>B</i> - (<sup>3</sup>&frasl;<sub>1000</sub>)<i>h</i>, where <i>B</i> is the temperature of the cloud at its base. Determine the temperature at 10,000 feet in a cloud with a base temperature of 55°F and a base height of 4000 feet. <b>Note:</b> For an interesting application involving the three preceding exercises, see Exercise 6 in the Discussion Exercises at the end of the chapter."},label:!1}]}]},{title:"2.3 Quadratic Equations",problems:[{num:9,text:"Solve the equation by factoring.",alignment:null,parts:[{type:"derivation",options:{eq:"12x^2+60x+75=0"},label:!1}]},{num:13,text:"Solve the equation by factoring.",alignment:null,parts:[{type:"derivation",options:{eq:"(5x)/(x-3)+4/(x+3)=90/(x^2-9)"},label:!1}]},{num:15,text:"Determine whether the two equations are equivalent.",alignment:"row",parts:[{type:"derivation",options:{eq:"x^2=16"},label:!0},{type:"derivation",options:{eq:"x=4"},label:!1},{type:"derivation",options:{eq:"x=sqrt9"},label:!0},{type:"derivation",options:{eq:"x=3"},label:!1}]},{num:21,text:"Solve the equation by using the special quadratic equation on page 75.",alignment:null,parts:[{type:"derivation",options:{eq:"(x-3)^2=17"},label:!1}]},{num:23,text:"Solve the equation by using the special quadratic equation on page 75.",alignment:null,parts:[{type:"derivation",options:{eq:"4(x+2)^2=11"},label:!1}]},{num:25,text:"Determine the value or values of <i>d</i> that complete the square for the expression.",alignment:"column",parts:[{type:"derivation",options:{eq:"x^2+9x+d"},label:!0},{type:"derivation",options:{eq:"x^2-8x+d"},label:!0},{type:"derivation",options:{eq:"x^2+dx+36"},label:!0},{type:"derivation",options:{eq:"x^2+dx+49/4"},label:!0}]},{num:29,text:"Solve by completing the square. (<i>Note:</i> See the discussion after Example 5 for help in solving Exercises 29 and 30.)",alignment:null,parts:[{type:"derivation",options:{eq:"4x^2-12x-11=0"},label:!1}]},{num:37,text:"Solve by using the quadratic formula.",alignment:null,parts:[{type:"derivation",options:{eq:"3/2z^2-4z-1=0"},label:!1}]},{num:39,text:"Solve by using the quadratic formula.",alignment:null,parts:[{type:"derivation",options:{eq:"5/(w^2)-10/w+2=0"},label:!1}]},{num:41,text:"Solve by using the quadratic formula.",alignment:null,parts:[{type:"derivation",options:{eq:"4x^2+81=36x"},label:!1}]},{num:43,text:"Solve by using the quadratic formula.",alignment:null,parts:[{type:"derivation",options:{eq:"(5x)/(x^2+9)=-1"},label:!1}]},{num:45,text:"Use the quadratic formula to factor the expressions.",alignment:null,parts:[{type:"derivation",options:{eq:"x^2+x-30"},label:!1}]},{num:47,text:"Use the quadratic formula to factor the expressions.",alignment:null,parts:[{type:"derivation",options:{eq:"12x^2-16x-3"},label:!1}]},{num:49,text:"Use the quadratic formula to solve the equation for (a) <i>x</i> in terms of <i>y</i> and (b) <i>y</i> in terms of <i>x</i>.",alignment:null,parts:[{type:"derivation",options:{eq:"4x^2-4xy+1-y^2=0"},label:!1}]},{num:51,text:"Solve for the specified variable.",alignment:"row",parts:[{type:"derivation",options:{eq:"K=1/2mv^2"},label:!1},{type:"textbox",options:{text:"for <i>v</i> (kinetic energy)"},label:!1}]},{num:53,text:"Solve for the specified variable.",alignment:"row",parts:[{type:"derivation",options:{eq:"A=2πr(r+h)"},label:!1},{type:"textbox",options:{text:"for <i>r</i> (surface area of a closed cylinder)"},label:!1}]},{num:59,text:"Baseball toss",alignment:null,parts:[{type:"textbox",options:{text:"A baseball is thrown straight upward with an initial speed of 64 ft/sec. The number of feet <i>s</i> above the ground after <i>t</i> seconds is given by the equation <i>s</i> = -16<i>t</i><sup>2</sup> + 64<i>t</i>."},label:!1},{type:"textbox",options:{text:"When will the baseball be 48 feet above the ground?"},label:!0},{type:"textbox",options:{text:"When will it hit the ground?"},label:!0}]},{num:60,text:"Breaking distance",alignment:"column",parts:[{type:"textbox",options:{text:"The distance that a car travels between the time the driver makes the decision to hit the brakes and the time the car actually stops is called the braking distance. For a certain car traveling <i>v</i> mi/hr, the braking distance <i>d</i> (in feet) is given by <i>d</i> = <i>v</i> + (<i>v</i><sup>2</sup>/20)."},label:!1},{type:"textbox",options:{text:"Find the braking distance when <i>v</i> is 55 mi/hr."},label:!0},{type:"textbox",options:{text:"If a driver decides to brake 120 feet from a stop sign, how fast can the car be going and still stop by the time it reaches the sign?"},label:!0}]},{num:65,text:"Fencing a garden",alignment:null,parts:[{type:"textbox",options:{text:"A square vegetable garden is to be tilled and then enclosed with a fence. If the fence costs $1 per foot and the cost of preparing the soil is $0.50 per ft<sup>2</sup>, determine the size of the garden that can be enclosed for $120."},label:!1}]},{num:66,text:"Fencing a region",alignment:null,parts:[{type:"textbox",options:{text:"A farmer plans to enclose a rectangular region, using part of his barn for one side and fencing for the other three sides. If the side parallel to the barn is to be twice the length of an adjacent side, and the area of the region is to be 128 ft<sup>2</sup>, how many feet of fencing should be purchased?"},label:!1}]},{num:69,text:"Distance between airplanes",alignment:"column",parts:[{type:"textbox",options:{text:"An airplane flying north at 200 mi/hr passed over a point on the ground at 2:00 P.M. Another airplane at the same altitude passed over the point at 2:30 P.M., flying east at 400 mi/hr (see the figure on p. 86)."},label:!1},{type:"textbox",options:{text:"If <i>t</i> denotes the time in hours after 2:30 P.M., express the distance <i>d</i> between the airplanes in terms of <i>t</i>."},label:!0},{type:"textbox",options:{text:"At what time after 2:30 P.M. were the airplanes 500 miles apart?"},label:!0}]},{num:70,text:"Two-way radio range",alignment:null,parts:[{type:"textbox",options:{text:"Two surveyors with two-way radios leave the same point at 9:00 A.M., one walking due south at 4 mi/hr and the other due west at 3 mi/hr. How long can they communicate with one another if each radio has a maximum range of 2 miles?"},label:!1}]},{num:71,text:"Constructing a pizza box",alignment:null,parts:[{type:"textbox",options:{text:"A pizza box with a square base is to be made from a rectangular sheet of cardboard by cutting six 1-inch squares from the corners and the middle sections and folding up the sides (see the figure on p. 86). If the area of the base is to be 144 in<sup>2</sup>, what size piece of cardboard should be used?"},label:!1}]}]},{title:"2.4 Complex Numbers",problems:[{num:3,text:"Write the expression in the form <i>a</i> + <i>bi</i>, where <i>a</i> and <i>b</i> are real numbers.",alignment:null,parts:[{type:"derivation",options:{eq:"(7-6i)-(-11-3i)"},label:!1}]},{num:7,text:"Write the expression in the form <i>a</i> + <i>bi</i>, where <i>a</i> and <i>b</i> are real numbers.",alignment:null,parts:[{type:"derivation",options:{eq:"(1-3i)(2+5i)"},label:!1}]},{num:9,text:"Write the expression in the form <i>a</i> + <i>bi</i>, where <i>a</i> and <i>b</i> are real numbers.",alignment:null,parts:[{type:"derivation",options:{eq:"(5-2i)^2"},label:!1}]},{num:17,text:"Write the expression in the form <i>a</i> + <i>bi</i>, where <i>a</i> and <i>b</i> are real numbers.",alignment:"row",parts:[{type:"derivation",options:{eq:"i^73"},label:!0},{type:"derivation",options:{eq:"i^-46"},label:!0},{type:"derivation",options:{eq:"i^66"},label:!0},{type:"derivation",options:{eq:"i^-55"},label:!0}]},{num:19,text:"Write the expression in the form <i>a</i> + <i>bi</i>, where <i>a</i> and <i>b</i> are real numbers.",alignment:null,parts:[{type:"derivation",options:{eq:"3/(2+4i)"},label:!1}]},{num:21,text:"Write the expression in the form <i>a</i> + <i>bi</i>, where <i>a</i> and <i>b</i> are real numbers.",alignment:null,parts:[{type:"derivation",options:{eq:"(1-7i)/(6-2i)"},label:!1}]},{num:23,text:"Write the expression in the form <i>a</i> + <i>bi</i>, where <i>a</i> and <i>b</i> are real numbers.",alignment:null,parts:[{type:"derivation",options:{eq:"(-4+6i)/(2+7i)"},label:!1}]},{num:25,text:"Write the expression in the form <i>a</i> + <i>bi</i>, where <i>a</i> and <i>b</i> are real numbers.",alignment:null,parts:[{type:"derivation",options:{eq:"(4-2i)/(-5i)"},label:!1}]},{num:27,text:"Write the expression in the form <i>a</i> + <i>bi</i>, where <i>a</i> and <i>b</i> are real numbers.",alignment:null,parts:[{type:"derivation",options:{eq:"(2+5i)^3"},label:!1}]},{num:29,text:"Write the expression in the form <i>a</i> + <i>bi</i>, where <i>a</i> and <i>b</i> are real numbers.",alignment:null,parts:[{type:"derivation",options:{eq:"(2-sqrt-4)(3-sqrt-16)"},label:!1}]},{num:31,text:"Write the expression in the form <i>a</i> + <i>bi</i>, where <i>a</i> and <i>b</i> are real numbers.",alignment:null,parts:[{type:"derivation",options:{eq:"(4+sqrt-81)/(7-sqrt-64)"},label:!1}]},{num:35,text:"Find the values of <i>x</i> and <i>y</i>, where <i>x</i> and <i>y</i> are real numbers.",alignment:null,parts:[{type:"derivation",options:{eq:"4+(x+2y)i=x+2i"},label:!1}]},{num:37,text:"Find the values of <i>x</i> and <i>y</i>, where <i>x</i> and <i>y</i> are real numbers.",alignment:null,parts:[{type:"derivation",options:{eq:"(2x-y)-16i=10+4yi"},label:!1}]},{num:39,text:"Find the solutions of the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"x^2-6x+13=0"},label:!1}]},{num:41,text:"Find the solutions of the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"x^2+4x+13=0"},label:!1}]},{num:43,text:"Find the solutions of the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"x^2-5x+20=0"},label:!1}]},{num:45,text:"Find the solutions of the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"4x^2+x+3=0"},label:!1}]},{num:47,text:"Find the solutions of the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"x^3+125=0"},label:!1}]},{num:48,text:"Find the solutions of the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"x^3-27=0"},label:!1}]},{num:49,text:"Find the solutions of the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"27x^3=(x+5)^3"},label:!1}]},{num:50,text:"Find the solutions of the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"16x^4=(x-4)^4"},label:!1}]},{num:51,text:"Find the solutions of the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"x^4=256"},label:!1}]},{num:53,text:"Find the solutions of the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"4x^4+25x^2+36=0"},label:!1}]},{num:54,text:"Find the solutions of the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"27x^4+21x^2+4=0"},label:!1}]},{num:55,text:"Find the solutions of the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"x^3+3x^2+4x=0"},label:!1}]},{num:57,text:"This problem is currently unavailable. Please see p. 94 in the textbook.",alignment:null,parts:[]}]},{title:"2.5 Other Types of Equations",problems:[{num:3,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"|3x-2|+3=7"},label:!1}]},{num:5,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"3*|x+1|-2=-11"},label:!1}]},{num:8,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"3x^3-4x^2-27x+36=0"},label:!1}]},{num:9,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"4x^4+10x^3=6x^2+15x"},label:!1}]},{num:11,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"y^(3/2)=5y"},label:!1}]},{num:17,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"sqrt[5]{2x^2+1}-2=0"},label:!1}]},{num:19,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"sqrt{7-x}=x-5"},label:!1}]},{num:21,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"3sqrt{2x-3}+2sqrt{7-x}=11"},label:!1}]},{num:23,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"x=4+sqrt{4x-19}"},label:!1}]},{num:25,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"x+sqrt{5x+19}=-1"},label:!1}]},{num:27,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"sqrt{7-2x}-sqrt{5+x}=sqrt{4+3x}"},label:!1}]},{num:29,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"sqrt{11+8x}+1=sqrt{9+4x}"},label:!1}]},{num:33,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"sqrt{1+4sqrtx}=sqrtx+1"},label:!1}]},{num:37,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"5y^4-7y^2+1=0"},label:!1}]},{num:39,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"36x^-4-13x^-2+1=0"},label:!1}]},{num:41,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"3x^(2/3)+4x^(1/3)-4=0"},label:!1}]},{num:43,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"6w+7w^(1/2)-20=0"},label:!1}]},{num:44,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"8t-22t^(1/2)-21=0"},label:!1}]},{num:45,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"2x^(-2/3)-7x^(-1/3)-15=0"},label:!1}]},{num:49,text:"Solve the equation.",alignment:"row",parts:[{type:"derivation",options:{eq:"sqrt[3]{x}=2sqrt[4]{x}"},label:!1},{type:"textbox",options:{text:"(<i>Hint:</i> Raise both sides to the least common multiple of 3 and 4.)"},label:!1}]},{num:51,text:"Find the real solutions of the equation.",alignment:"column",parts:[{type:"derivation",options:{eq:"x^(5/3)=32"},label:!0},{type:"derivation",options:{eq:"x^(4/3)=16"},label:!0},{type:"derivation",options:{eq:"x^(2/3)=-36"},label:!0},{type:"derivation",options:{eq:"x^(3/4)=125"},label:!0},{type:"derivation",options:{eq:"x^(3/2)=-27"},label:!0}]},{num:53,text:"Solve for the specified variable.",alignment:"row",parts:[{type:"derivation",options:{eq:"T=2πsqrt{l/g}"},label:!1},{type:"textbox",options:{text:"for <i>l</i> (period of a pendulum)"},label:!1}]},{num:55,text:"Solve for the specified variable.",alignment:"row",parts:[{type:"derivation",options:{eq:"S=πrsqrt{r^2+h^2}"},label:!1},{type:"textbox",options:{text:"for <i>h</i> (surface area of a cone)"},label:!1}]},{num:57,text:"Ladder height",alignment:null,parts:[{type:"textbox",options:{text:"The recommended distance <i>d</i> that a ladder should be placed away from a vertical wall is 25% of its length <i>L</i>. Approximate the height <i>h</i> that can be reached by relating <i>h</i> as a percentage of <i>L</i> (see figure on p. 101)."},label:!1}]},{num:59,text:"Windmill power",alignment:null,parts:[{type:"textbox",options:{text:"The power <i>P</i> (in watts) generated by a windmill that has efficiency <i>E</i> is given by the formula <i>P</i> = 0.31<i>ED</i><sup>2</sup><i>V</i><sup>3</sup>, where <i>D</i> is the diameter (in feet) of the windmill blades and <i>V</i> is the wind velocity (in ft/sec). Approximate the wind velocity necessary to generate 10,000 watts if <i>E</i> = 42% and <i>D</i> = 10."},label:!1}]},{num:61,text:"The effect of price on demand",alignment:null,parts:[{type:"textbox",options:{text:"The demand for a commodity usually depends on its price. If other factors do not affect the demand, then the quantity <i>Q</i> purchased at price <i>P</i> (in cents) is given by <i>Q</i> = <i>kP</i><sup>-<i>c</i></sup>, where <i>k</i> and <i>c</i> are positive constants. If <i>k</i> = 10<sup>5</sup> and <i>c</i> = <sup>1</sup>&frasl;<sub>2</sub>, find the price that will result in the purchase of 5000 items."},label:!1}]},{num:62,text:"The urban heat island",alignment:null,parts:[{type:"textbox",options:{text:"Urban areas have higher average air temperatures than rural areas, as a result of the presence of buildings, asphalt, and concrete. This phenomenon has become known as the <i>urban heat island</i>. The temperature difference <i>T</i> (in °C) between urban and rural areas near Montreal, with a population <i>P</i> between 1000 and 1,000,000, can be described the by the formula <i>T</i> = 0.25<i>P</i><sup><sup>1</sup>&frasl;<sub>4</sub></sup>/√<i>v</i>, where <i>v</i> is the average wind speed (in mi/hr) and <i>v</i> ≥ 1. If <i>T</i> = 3 and <i>v</i> = 5, find <i>P</i>."},label:!1}]},{num:67,text:"Installing a power line",alignment:null,parts:[{type:"textbox",options:{text:"A power line is to be installed across a river that is 1 mile wide to a town that is 5 miles downstream (see the figure on p. 102). It costs $7500 per mile to lay the cable underwater and $6000 per mile to lay it overland. Determine how the cable should be installed if $35,000 has been allocated for this project."},label:!1}]}]},{title:"2.6 Inequalities",problems:[{num:3,text:"Express the inequality as an interval, and sketch its graph.",alignment:null,parts:[{type:"derivation",options:{eq:"x<-2"},label:!1}]},{num:5,text:"Express the inequality as an interval, and sketch its graph.",alignment:null,parts:[{type:"derivation",options:{eq:"x≥4"},label:!1}]},{num:"7-19",text:"We're not yet supporting these problems. Please see pp. 109 and 110 in the textbook.",alignment:null,parts:[]},{num:27,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"9+1/3x≥4-1/2x"},label:!1}]},{num:"31-35",text:"We're not yet supporting these problems. Please see p. 110 in the textbook.",alignment:null,parts:[]},{num:39,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"(x-4)^2>x(x+12)"},label:!1}]},{num:41,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"4/(3x+2)≥0"},label:!1}]},{num:43,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"-2/(4-3x)>0"},label:!1}]},{num:45,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"2/((1-x)^2)>0"},label:!1}]},{num:47,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"|x|<3"},label:!1}]},{num:49,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"|x|≥5"},label:!1}]},{num:53,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"|x+2|+0.1≥0.2"},label:!1}]},{num:57,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"-1/3*|6-5x|+2≥1"},label:!1}]},{num:59,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"|7x+2|>-2"},label:!1}]},{num:63,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"|(2-3x)/5|≥2"},label:!1}]},{num:65,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"3/|5-2x|<2"},label:!1}]},{num:"67-77",text:"We're not yet supporting these problems. Please see p. 110 in the textbook.",alignment:null,parts:[]},{num:80,text:"Electrical resistance",alignment:null,parts:[{type:"textbox",options:{text:"If two resistors <i>R</i><sub>1</sub> and <i>R</i><sub>2</sub> are connected in parallel in an electrical circuit, the net resistance <i>R</i> is given by<p style='text-align:center; margin: 10px;'><sup>1</sup>&frasl;<sub><i>R</i></sub> = <sup>1</sup>&frasl;<sub><i>R</i><sub>1</sub></sub> + <sup>1</sup>&frasl;<sub><i>R</i><sub>2</sub></sub>.</p>If <i>R</i><sub>1</sub> = 10 ohms, what values of <i>R</i><sub>2</sub> will result in a net resistance of less than 5 ohms?"},label:!1}]},{num:85,text:"Decreasing height",alignment:"column",parts:[{type:"textbox",options:{text:"A person's height will typically decrease by 0.024 inch each year after age 30."},label:!1},{type:"textbox",options:{text:"If a woman was 5 feet 9 inches tall at age 30, predict her height at age 70."},label:!0},{type:"textbox",options:{text:"A 50-year-old man is 5 feet 6 inches tall. Determine an inequality for the range of heights (in inches) that this man will experience between the ages of 30 and 70."},label:!0}]}]},{title:"2.7 More on Inequalities",problems:[{num:7,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"x^2-2x-5>3"},label:!1}]},{num:9,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"x(2x+3)≥5"},label:!1}]},{num:11,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"6x-8>x^2"},label:!1}]},{num:17,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"16x^2≥9x"},label:!1}]},{num:19,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"x^4+5x^2≥36"},label:!1}]},{num:21,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"x^3+2x^2-4x-8≥0"},label:!1}]},{num:23,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"(x^2(x+2))/((x+2)(x+1))≤0"},label:!1}]},{num:25,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"(x^2-x)/(x^2+2x)≤0"},label:!1}]},{num:27,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"(x-2)/(x^2-3x-10)≥0"},label:!1}]},{num:29,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"(-3x)/(x^2-9)>0"},label:!1}]},{num:31,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"(x+1)/(2x-3)>2"},label:!1}]},{num:33,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"1/(x-2)≥3/(x+1)"},label:!1}]},{num:35,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"4/(3x-2)≤2/(x+1)"},label:!1}]},{num:37,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"x/(3x-5)≤2/(x-1)"},label:!1}]},{num:39,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"x^3>x"},label:!1}]},{num:41,text:"As a particle moves along a straight path, its speed <i>v</i> (in cm/sec) at time <i>t</i> (in seconds) is given by the equation. For what subintervals of the given time interval [<i>a</i>, <i>b</i>] will its speed be at least <i>k</i> cm/sec?",alignment:"row",parts:[{type:"derivation",options:{eq:"v=t^3-3t^2-4t+20"},label:!1},{type:"derivation",options:{eq:"[0,5]"},label:!1},{type:"derivation",options:{eq:"k=8"},label:!1}]},{num:43,text:"Vertical leap record",alignment:null,parts:[{type:"textbox",options:{text:"<i>Guinness Book of World Records</i> reports that German shepherds can make vertical leaps of over 10 feet when scaling walls. If the distance <i>s</i> (in feet) off the ground after <i>t</i> seconds is given by the equation <i>s</i> = -16<i>t</i><sup>2</sup> + 24<i>t</i> + 1, for how many seconds is the dog more than 9 feet off the ground?"},label:!1}]},{num:44,text:"Height of a projected object",alignment:null,parts:[{type:"textbox",options:{text:"If an object is projected vertically upward from ground level with an initial velocity of 320 ft/sec, then its distance <i>s</i> above the ground after <i>t</i> seconds is given by <i>s</i> = -16<i>t</i><sup>2</sup> + 320<i>t</i>. For what values of <i>t</i> will the object be more than 1536 feet above the ground?"},label:!1}]},{num:45,text:"Braking distance",alignment:null,parts:[{type:"textbox",options:{text:"The braking distance <i>d</i> (in feet) of a certain car traveling <i>v</i> mi/hr is given by the equation <i>d</i> = <i>v</i> + (<i>v</i><sup>2</sup>/20). Determine the velocities that result in braking distances of less than 75 feet."},label:!1}]},{num:49,text:"Weight in space",alignment:null,parts:[{type:"textbox",options:{text:"After an astronaut is launched into space, the astronaut's weight decreases until a state of weightlessness is achieved. The weight of a 125-pound astronaut at an altitude of <i>x</i> kilometers above sea level is given by<p style='text-align:center; margin: 10px;'><i>W</i> = 125(<sup>6400</sup>&frasl;<sub>6400 + <i>x</i></sub>)<sup>2</sup>.</p>At what altitudes is the astronaut's weight less than 5 pounds?"},label:!1}]},{num:51,text:"Aircraft's landing speed",alignment:null,parts:[{type:"textbox",options:{text:"In the design of certain small turbo-prop aircraft, the landing speed <i>V</i> (in ft/sec) is determined by the formula <i>W</i> = 0.00334<i>V</i><sup>2</sup><i>S</i>, where <i>W</i> is the gross weight (in pounds) of the aircraft and <i>S</i> is the surface area (in ft<sup>2</sup>) of the wings. If the gross weight of the aircraft is between 7500 pounds and 10,000 pounds and <i>S</i> = 210 ft<sup>2</sup>, determine the range of the landing speeds in miles per hour."},label:!1}]}]}]},{title:"Chapter 3 Functions and Graphs",subchapters:[{title:"3.1 Rectangular Coordinate Systems",problems:[{num:3,text:null,alignment:null,parts:[{type:"textbox",options:{text:"Plot the points <i>A</i> (0, 0), <i>B</i> (1, 1), <i>C</i> (3, 3), <i>D</i> (-1, -1), and <i>E</i> (-2, -2). Describe the set of all points of the form (<i>a</i>, <i>a</i>), where <i>a</i> is a real number."},label:!1}]},{num:7,text:"Describe the set of all points <i>P</i> (<i>x</i>, <i>y</i>) in a coordinate plane that satisfy the given condition.",alignment:"column",parts:[{type:"derivation",options:{eq:"x=-2"},label:!0},{type:"derivation",options:{eq:"y=3"},label:!0},{type:"derivation",options:{eq:"x≥0"},label:!0},{type:"derivation",options:{eq:"xy>0"},label:!0},{type:"derivation",options:{eq:"y<0"},label:!0},{type:"derivation",options:{eq:"x=0"},label:!0}]},{num:9,text:"(a) Find the distance <i>d</i> (<i>A</i>, <i>B</i>) between <i>A</i> and <i>B</i>. (b) Find the midpoint of the segment <i>AB</i>.",alignment:"row",parts:[{type:"textbox",options:{text:"<i>A</i> (4, -3)"},label:!1},{type:"textbox",options:{text:"<i>B</i> (6, 2)"},label:!1}]},{num:11,text:"(a) Find the distance <i>d</i> (<i>A</i>, <i>B</i>) between <i>A</i> and <i>B</i>. (b) Find the midpoint of the segment <i>AB</i>.",
alignment:"row",parts:[{type:"textbox",options:{text:"<i>A</i> (-5, 0)"},label:!1},{type:"textbox",options:{text:"<i>B</i> (-2, -2)"},label:!1}]},{num:13,text:"(a) Find the distance <i>d</i> (<i>A</i>, <i>B</i>) between <i>A</i> and <i>B</i>. (b) Find the midpoint of the segment <i>AB</i>.",alignment:"row",parts:[{type:"textbox",options:{text:"<i>A</i> (7, -3)"},label:!1},{type:"textbox",options:{text:"<i>B</i> (3, -3)"},label:!1}]},{num:15,text:"We're not yet supporting this problem.",alignment:null,parts:[]},{num:19,text:null,alignment:null,parts:[{type:"textbox",options:{text:"Given <i>A</i> (-3, 8), find the coordinates of the point <i>B</i> such that <i>C</i> (5, -10) is the midpoint of segment <i>AB</i>."},label:!1}]},{num:21,text:"Prove that <i>C</i> is on the perpendicular bisector of segment <i>AB</i>.",alignment:"row",parts:[{type:"textbox",options:{text:"<i>A</i> (-4, -3)"},label:!1},{type:"textbox",options:{text:"<i>B</i> (6, 1)"},label:!1},{type:"textbox",options:{text:"<i>C</i> (5, -11)"},label:!1}]},{num:23,text:"Find a formula that expresses the fact that an arbitrary point <i>P</i> (<i>x</i>, <i>y</i>) is on the perpendicular bisector <i>l</i> of segment <i>AB</i>.",alignment:"row",parts:[{type:"textbox",options:{text:"<i>A</i> (-4, -3)"},label:!1},{type:"textbox",options:{text:"<i>B</i> (6, 1)"},label:!1}]},{num:25,text:null,alignment:null,parts:[{type:"textbox",options:{text:"Find a formula that expresses the fact that <i>P</i> (<i>x</i>, <i>y</i>) is a distance 5 from the origin. Describe the set of all such points."},label:!1}]},{num:26,text:null,alignment:null,parts:[{type:"textbox",options:{text:"Find a formula that states that <i>P</i> (<i>x</i>, <i>y</i>) is a distance <i>r</i> > 0 from a fixed point <i>C</i> (<i>h</i>, <i>k</i>). Describe the set of all such points."},label:!1}]},{num:27,text:null,alignment:null,parts:[{type:"textbox",options:{text:"Find all points on the <i>y</i>-axis that are a distance 6 from <i>P</i> (5, 3)."},label:!1}]},{num:29,text:null,alignment:null,parts:[{type:"textbox",options:{text:"Find the point with coordinates of the form (2<i>a</i>, <i>a</i>) that is in the third quadrant and is a distance 5 from <i>P</i> (1, 3)."},label:!1}]},{num:31,text:null,alignment:null,parts:[{type:"textbox",options:{text:"For what values of <i>a</i> is the distance between <i>P</i> (<i>a</i>, 3) and <i>Q</i> (5, 2<i>a</i>) greater than √26?"},label:!1}]},{num:33,text:null,alignment:null,parts:[{type:"textbox",options:{text:"Prove that the midpoint of the hypotenuse of any right triangle is equidistant from the vertices. (<i>Hint:</i> Label the vertices of the triangle <i>O</i> (0,0), <i>A</i> (</i>a</i>, 0), and <i>B</i> (0, <i>b</i>).)"},label:!1}]}]},{title:"3.2 Graphs of Equations",problems:[{num:1,text:"Sketch the graph of the equation, and label the <i>x</i>- and <i>y</i>-intercepts.",alignment:null,parts:[{type:"derivation",options:{eq:"y=2x-3"},label:!1}]},{num:3,text:"Sketch the graph of the equation, and label the <i>x</i>- and <i>y</i>-intercepts.",alignment:null,parts:[{type:"derivation",options:{eq:"y=-x+1"},label:!1}]},{num:5,text:"Sketch the graph of the equation, and label the <i>x</i>- and <i>y</i>-intercepts.",alignment:null,parts:[{type:"derivation",options:{eq:"y=-4x^2"},label:!1}]},{num:7,text:"Sketch the graph of the equation, and label the <i>x</i>- and <i>y</i>-intercepts.",alignment:null,parts:[{type:"derivation",options:{eq:"y=2x^2-1"},label:!1}]},{num:9,text:"Sketch the graph of the equation, and label the <i>x</i>- and <i>y</i>-intercepts.",alignment:null,parts:[{type:"derivation",options:{eq:"x=1/4y^2"},label:!1}]},{num:11,text:"Sketch the graph of the equation, and label the <i>x</i>- and <i>y</i>-intercepts.",alignment:null,parts:[{type:"derivation",options:{eq:"x=-y^2+3"},label:!1}]},{num:13,text:"Sketch the graph of the equation, and label the <i>x</i>- and <i>y</i>-intercepts.",alignment:null,parts:[{type:"derivation",options:{eq:"y=-1/2x^3"},label:!1}]},{num:15,text:"Sketch the graph of the equation, and label the <i>x</i>- and <i>y</i>-intercepts.",alignment:null,parts:[{type:"derivation",options:{eq:"y=x^3-8"},label:!1}]},{num:17,text:"Sketch the graph of the equation, and label the <i>x</i>- and <i>y</i>-intercepts.",alignment:null,parts:[{type:"derivation",options:{eq:"y=sqrtx"},label:!1}]},{num:19,text:"Sketch the graph of the equation, and label the <i>x</i>- and <i>y</i>-intercepts.",alignment:null,parts:[{type:"derivation",options:{eq:"y=sqrtx-4"},label:!1}]},{num:20,text:"Sketch the graph of the equation, and label the <i>x</i>- and <i>y</i>-intercepts.",alignment:null,parts:[{type:"derivation",options:{eq:"y=sqrt{x-4}"},label:!1}]},{num:21,text:"Use tests for symmetry to determine which graphs in the indicated exercises are symmetric with respect to (a) the <i>y</i>-axis, (b) the <i>x</i>-axis, and (c) the origin.",alignment:null,parts:[{type:"textbox",options:{text:"The odd-numbered exercises in 1-20"},label:!1}]},{num:23,text:"Sketch the graph of the circle or semicircle.",alignment:null,parts:[{type:"derivation",options:{eq:"x^2+y^2=11"},label:!1}]},{num:25,text:"Sketch the graph of the circle or semicircle.",alignment:null,parts:[{type:"derivation",options:{eq:"(x+3)^2+(y-2)^2=9"},label:!1}]},{num:27,text:"Sketch the graph of the circle or semicircle.",alignment:null,parts:[{type:"derivation",options:{eq:"(x+3)^2+y^2=16"},label:!1}]},{num:31,text:"Sketch the graph of the circle or semicircle.",alignment:null,parts:[{type:"derivation",options:{eq:"y=-sqrt{16-x^2}"},label:!1}]},{num:33,text:"Sketch the graph of the circle or semicircle.",alignment:null,parts:[{type:"derivation",options:{eq:"x=sqrt{9-y^2}"},label:!1}]},{num:35,text:"Find an equation of the circle that satisfies the stated conditions.",alignment:null,parts:[{type:"textbox",options:{text:"Center <i>C</i> (2, -3), radius 5"},label:!1}]},{num:37,text:"Find an equation of the circle that satisfies the stated conditions.",alignment:null,parts:[{type:"textbox",options:{text:"Center <i>C</i> (<sup>1</sup>&frasl;<sub>4</sub>, 0), radius 3&radic;2"},label:!1}]},{num:39,text:"Find an equation of the circle that satisfies the stated conditions.",alignment:null,parts:[{type:"textbox",options:{text:"Center <i>C</i> (-4, 6), passing through <i>P</i> (1, 2)"},label:!1}]},{num:41,text:"Find an equation of the circle that satisfies the stated conditions.",alignment:null,parts:[{type:"textbox",options:{text:"Center <i>C</i> (-3, 6), tangent to the <i>y</i>-axis"},label:!1}]},{num:43,text:"Find an equation of the circle that satisfies the stated conditions.",alignment:null,parts:[{type:"textbox",options:{text:"Tangent to both axes, center in the second quadrant, radius 4"},label:!1}]},{num:45,text:"Find an equation of the circle that satisfies the stated conditions.",alignment:null,parts:[{type:"textbox",options:{text:"Endpoints of a diameter <i>A</i> (4, -3) and <i>B</i> (-2, 7)"},label:!1}]},{num:47,text:"Find the center and radius of the circle with the given equation.",alignment:null,parts:[{type:"derivation",options:{eq:"x^2+y^2-4x+6y-36-0"},label:!1}]},{num:49,text:"Find the center and radius of the circle with the given equation.",alignment:null,parts:[{type:"derivation",options:{eq:"x^2+y^2+4y-117=0"},label:!1}]},{num:51,text:"Find the center and radius of the circle with the given equation.",alignment:null,parts:[{type:"derivation",options:{eq:"2x^2+2y^2-12x+4y-15=0"},label:!1}]},{num:53,text:"Find the center and radius of the circle with the given equation.",alignment:null,parts:[{type:"derivation",options:{eq:"x^2+y^2+4x-2y+5=0"},label:!1}]},{num:55,text:"Find the center and radius of the circle with the given equation.",alignment:null,parts:[{type:"derivation",options:{eq:"x^2+y^2-2x-8y+19=0"},label:!1}]},{num:57,text:"Find equations for the upper half, lower half, right half, and left half of the circle.",alignment:null,parts:[{type:"derivation",options:{eq:"x^2+y^2=36"},label:!1}]},{num:59,text:"Find equations for the upper half, lower half, right half, and left half of the circle.",alignment:null,parts:[{type:"derivation",options:{eq:"(x-2)^2+(y+1)^2=49"},label:!1}]},{num:65,text:"Determine whether the point <i>P</i> is inside, outside, or on the circle with center <i>C</i> and radius <i>r</i>.",alignment:null,parts:[{type:"textbox",options:{text:"<i>P</i> (2, 3), <i>C</i> (4, 6), <i>r</i> = 4"},label:!0},{type:"textbox",options:{text:"<i>P</i> (4, 2), <i>C</i> (1, -2), <i>r</i> = 5"},label:!0},{type:"textbox",options:{text:"<i>P</i> (-3, 5), <i>C</i> (2, 1), <i>r</i> = 6"},label:!0}]},{num:67,text:"For the given circle, find (a) the <i>x</i>-intercepts and (b) the <i>y</i>-intercepts.",alignment:null,parts:[{type:"derivation",options:{eq:"x^2+y^2-4x-6y+4=0"},label:!1}]}]},{title:"3.3 Lines",problems:[{num:3,text:"Sketch the line through <i>A</i> and <i>B</i>, and find its slope <i>m</i>.",alignment:null,parts:[{type:"textbox",options:{text:"<i>A</i> (2, 5), <i>B</i> (-7, 5)"},label:!1}]},{num:13,text:"Sketch the graph of <i>y</i> = <i>mx</i> for the given values of <i>m</i>.",alignment:null,parts:[{type:"textbox",options:{text:"<i>m</i> = 3, -2, <sup>2</sup>&frasl;<sub>3</sub>, -<sup>1</sup>&frasl;<sub>4</sub>"},label:!1}]},{num:15,text:"Sketch the graph of the line through <i>P</i> for each value of <i>m</i>.",alignment:null,parts:[{type:"textbox",options:{text:"<i>P</i> (3, 1); <i>m</i> = <sup>1</sup>&frasl;<sub>2</sub>, -1, -<sup>1</sup>&frasl;<sub>5</sub>"},label:!1}]},{num:19,text:"Sketch the graphs of the lines on the same coordinate plane.",alignment:"row",parts:[{type:"derivation",options:{eq:"y=x+3"},label:!1},{type:"derivation",options:{eq:"y=x+1"},label:!1},{type:"derivation",options:{eq:"y=-x+1"},label:!1}]},{num:21,text:"Find a general form of an equation of the line through the point <i>A</i> that satisfies the given condition.",alignment:"column",parts:[{type:"textbox",options:{text:"<i>A</i> (5, -2)"},label:!1},{type:"textbox",options:{text:"parallel to the <i>y</i>-axis"},label:!0},{type:"textbox",options:{text:"perpendicular to the <i>y</i>-axis"},label:!0}]},{num:23,text:"Find a general form of an equation of the line through the point <i>A</i> that satisfies the given condition.",alignment:"row",parts:[{type:"textbox",options:{text:"<i>A</i> (5, -3)"},label:!1},{type:"textbox",options:{text:"slope -4"},label:!1}]},{num:25,text:"Find a general form of an equation of the line through the point <i>A</i> that satisfies the given condition.",alignment:"row",parts:[{type:"textbox",options:{text:"<i>A</i> (4, 0)"},label:!1},{type:"textbox",options:{text:"slope -3"},label:!1}]},{num:27,text:"Find a general form of an equation of the line through the point <i>A</i> that satisfies the given condition.",alignment:"row",parts:[{type:"textbox",options:{text:"<i>A</i> (4, -5)"},label:!1},{type:"textbox",options:{text:"through <i>B</i> (-3, 6)"},label:!1}]},{num:29,text:"Find a general form of an equation of the line through the point <i>A</i> that satisfies the given condition.",alignment:"row",parts:[{type:"textbox",options:{text:"<i>A</i> (2, -4)"},label:!1},{type:"textbox",options:{text:"parallel to the line 5<i>x</i> - 2<i>y</i> = 4"},label:!1}]},{num:31,text:"Find a general form of an equation of the line through the point <i>A</i> that satisfies the given condition.",alignment:"row",parts:[{type:"textbox",options:{text:"<i>A</i> (7, -3)"},label:!1},{type:"textbox",options:{text:"perpendicular to the line 2<i>x</i> - 5<i>y</i> = 8"},label:!1}]},{num:33,text:"Find the slope-intercept form of the line that satisfies the given conditions.",alignment:"row",parts:[{type:"textbox",options:{text:"<i>x</i>-intercept 4"},label:!1},{type:"textbox",options:{text:"<i>y</i>-intercept -3"},label:!1}]},{num:35,text:"Find the slope-intercept form of the line that satisfies the given conditions.",alignment:null,parts:[{type:"textbox",options:{text:"Through <i>A</i> (5, 2) and <i>B</i> (-1, 4)"},label:!1}]},{num:37,text:"Find a general form of an equation for the perpendicular bisector of the segment <i>AB</i>.",alignment:"row",parts:[{type:"textbox",options:{text:"<i>A</i> (3, -1)"},label:!1},{type:"textbox",options:{text:"<i>B</i> (-2, 6)"},label:!1}]},{num:39,text:"Find an equation for the line that bisects the given quadrants.",alignment:null,parts:[{type:"textbox",options:{text:"II and IV"},label:!1}]},{num:41,text:"Use the slope-intercept form to find the slope and <i>y</i>-intercept of the given line, and sketch its graph.",alignment:null,parts:[{type:"derivation",options:{eq:"2x=15-3y"},label:!1}]},{num:43,text:"Use the slope-intercept form to find the slope and <i>y</i>-intercept of the given line, and sketch its graph.",alignment:null,parts:[{type:"derivation",options:{eq:"4x-3y=9"},label:!1}]},{num:45,text:"We're not yet supporting this problem.",alignment:null,parts:[]},{num:51,text:"Fetal growth",alignment:null,parts:[{type:"textbox",options:{text:"The growth of a fetus more than 12 weeks old can be approximated by the formula <i>L</i> = 1.53<i>t</i> - 6.7, where <i>L</i> is the length (in centimeters) and <i>t</i> is the age (in weeks). Prenatal length can be determined by ultrasound. Approximate the age of a fetus whose length is 28 centimeters."},label:!1}]},{num:54,text:"Growth of a blue whale",alignment:"column",parts:[{type:"textbox",options:{text:"Newborn blue whales are approximately 24 feet long and weigh 3 tons. Young whales are nursed for 7 months, and by the time of weaning they often are 53 feet long and weigh 23 tons. Let <i>L</i> and <i>W</i> denote the length (in feet) and the weight (in tons), respectively, of a whale that is <i>t</i> months of age."},label:!1},{type:"textbox",options:{text:"If <i>L</i> and <i>t</i> are linearly related, express <i>L</i> in terms of <i>t</i>."},label:!0},{type:"textbox",options:{text:"What is the daily increase in the length of a young whale? (Use 1 month = 30 days.)"},label:!0},{type:"textbox",options:{text:"If <i>W</i> and <i>t</i> are linearly related, express <i>W</i> in terms of <i>t</i>."},label:!0},{type:"textbox",options:{text:"What is the daily increase in the weight of a young whale?"},label:!0}]},{num:57,text:"Childhood weight",alignment:"column",parts:[{type:"textbox",options:{text:"A baby weighs 10 pounds at birth, and three years later the child's weight is 30 pounds. Assume that childhood weight <i>W</i> (in pounds) is linearly related to age <i>t</i> (in years)."},label:!1},{type:"textbox",options:{text:"Express <i>W</i> in terms of <i>t</i>."},label:!0},{type:"textbox",options:{text:"What is <i>W</i> on the child's sixth birthday?"},label:!0},{type:"textbox",options:{text:"At what age will the child weigh 70 pounds?"},label:!0},{type:"textbox",options:{text:"Sketch, on a <i>tW</i>-plane, a graph that shows the relationship between <i>W</i> and <i>t</i> for 0 ≤ <i>t</i> ≤ 12."},label:!0}]},{num:61,text:"Urban heat island",alignment:"column",parts:[{type:"textbox",options:{text:"The urban heat island phenomenon has been observed in Tokyo. The average temperature was 13.5°C in 1915, and since then has risen 0.032°C per year."},label:!1},{type:"textbox",options:{text:"Assuming that temperature <i>T</i> (in °C) is linearly related to time <i>t</i> (in years) and that <i>t</i> = 0 corresponds to 1915, express <i>T</i> in terms of <i>t</i>."},label:!0},{type:"textbox",options:{text:"Predict the average temperature in the year 2010."},label:!0}]},{num:67,text:"Vertical wind shear",alignment:null,parts:[{type:"textbox",options:{text:"Vertical wind shear occurs when wind speed varies at different heights above the ground. Wind shear is of great importance to pilots during takeoffs and landings. If the wind speed is <i>v</i><sub>1</sub> at height <i>h</i><sub>1</sub> and <i>v</i><sub>2</sub> at height <i>h</i><sub>2</sub>, then the average wind shear <i>s</i> is given by the slope formula<p style='text-align:center; margin:10px'><i>s</i> = <sup><i>v</i><sub>2</sub> - <i>v</i><sub>1</sub></sup>&frasl;<sub><i>h</i><sub>2</sub> - <i>h</i><sub>1</sub></sub>.</p>If the wind speed at ground level is 22 mi/hr and <i>s</i> has been determined to be 0.07, find the wind speed 185 feet above the ground."},label:!1}]},{num:69,text:"The given points were found using empirical methods. Determine whether they lie on the same line <i>y</i> = <i>ax</i> + <i>b</i>, and if so, find the values of <i>a</i> and <i>b</i>.",alignment:"column",parts:[{type:"textbox",options:{text:"<i>A</i> (-1.3, -1.3598)"},label:!1},{type:"textbox",options:{text:"<i>B</i> (-0.55, -1.11905)"},label:!1},{type:"textbox",options:{text:"<i>C</i> (1.2, -0.5573)"},label:!1},{type:"textbox",options:{text:"<i>D</i> (3.25, 0.10075)"},label:!1}]}]}]}],i=null,j=null,k=null,l=function(a){return String.fromCharCode(97+a)},m="column",n={width:200,height:200},o={width:400,height:400},p=0,q=null;return h.forEach(function(a){a.subchapters.forEach(function(a){a.problems.forEach(function(a){a.parts.forEach(function(a){"textbox"==a.type&&(a.options.uneditable=!0),"ggb-element"==a.type&&(a.options.ggb_params={showToolbar:!1,borderColor:"#FFFFFF"})}),p++})})}),console.log("# of textbook problems: "+p),b}(),Wa.ui=Wa.ui||{},Wa.ui.Keyboard=function(){var a=null,b=function(){var a=function(){function a(a){if(a.alts){var c=d3.event.finger.dist_x,d=d3.event.finger.dist_y;if(!(c*c+d*d<36)){var e=[];d3.select("#"+a.id+"-content").selectAll("div").each(function(a){var b=d3.mouse(this),c=b[0]-i/2,d=b[1]-j/2;e.push({el:this,dist:Math.sqrt(c*c+d*d)})}),0!==e.length&&(e.sort(function(a,b){return a.dist-b.dist}),b(e[0].el,e[0].dist<100))}}}function b(a,b){d3.select(a.parentNode).selectAll("div").each(function(c){d3.select(this).style("background",this===a&&b?"silver":"none")}),p=b?d3.select(a).datum():null}function c(a){t[a](q.latex())}function d(a){function b(a){return' style="width:'+i*a+"px; height: "+j+'px" '}var c=a.selectAll(".key").data(l).enter().append("div").classed("key",!0).call(o);c.filter(function(a){return"backspace"==a.type}).classed("backspace-key",!0).append("svg").style({width:"100%",height:"100%"}).append("path"),c.filter(function(a){return"arrow"==a.type}).classed("arrow-key",!0).append("svg").style({width:"100%",height:"100%"}).append("path"),c.filter(function(a){return a.name}).classed("normal-key",!0).append("span").classed("keylabel",!0),c.filter(function(a){return a.alts}).append("span").classed("dots",!0),d3.select("html").on("click.gm-keyboard",function(){var a=d3.event;$("[data-original-title]").each(function(){$(this).is(a.target)||0!==$(this).has(a.target).length||0!==$(".popover").has(a.target).length||$(this).popover("hide")})}),c.filter(function(a){return a.alts}).attr("id",function(a){return a.id}).each(function(a){a.alts=a.alts.map(function(b){return"object"!=typeof b&&(b={name:b}),b.parent_key=a,b}),$(this).popover({html:!0,content:function(){return"<div id="+a.id+"-content"+b(a.alts.length)+"></div>"},title:function(){return null},trigger:"manual",placement:"top"}),$(this).on("show.bs.popover",function(){$(this).data("bs.popover").tip().css({maxWidth:"none"}).css({borderRadius:0}),d3.select(this).datum().popover_visible=!0}),$(this).on("hide.bs.popover",function(){d3.select(this).datum().popover_visible=!1}),$(this).on("shown.bs.popover",function(){var b=d3.select("#"+a.id+"-content").selectAll("div").data(a.alts).enter();b.append("div").classed("alt-key",!0).style({display:"inline-block",width:i+"px",height:j+"px","line-height":j+"px","text-align":"center"}).call(_,!0).text(function(a){return a.name||a}).on("click",function(a){$(this).popover("hide"),e(a)}.bind(this))})})}function e(a){if(a.cmd)q.cmd(a.cmd),q.focus();else{var b=a.val||a.name||a;C&&(b=b.toUpperCase()),q.typedText(b),a.tab&&q.keystroke("Tab")}c("change")}var f,g,h,i,j,k,l,m,n,o,p,q,r="m -5.708,-15.7 20.344,0 c 3.669696,0 6.624,2.954304 6.624,6.624 l 0,17.752 c 0,3.669696 -2.954304,6.624 -6.624,6.624 l -20.488,0 -15.408,-15.48 zM -2.18,-6.948 11.716,6.948M -2.18,6.948 11.716,-6.948",s="M 13.7,16.5 -13.7,16.5 0,-16.5 z",t=d3.dispatch("done","cancel","change"),u="",v=!1,w=null,x=null,y=null,z=null,A="darkorange",B=900,C=!1,D="center",E=null,F=!0,G=MathQuill.getInterface(2),H="123",I={spaceBehavesLikeTab:!0,restrictMismatchedBrackets:!0},J=function(){return o=Wa.mtouch_events().on("touch",T).on("release",W).on("drag",a).on("hold",X).hold_time(500),P(),U(H),""!=u&&q.write(u),this};J.layout=function(a){return 0==arguments.length?H:(H=a,w&&U(H),this)},J.width=function(a){return 0==arguments.length?B:(B=a,w&&R(),this)},J.latex=function(a){return 0==arguments.length?(f&&(u=q.latex()),u):(u=a,f&&q.latex(a),this)},J.visible=function(a){return 0==arguments.length?v:v==a?this:(v=a,w?(v?(w.style("display","block"),q.focus(),F&&J.scale_to_fit(),"simple"===H&&U("simple")):w.style("display","none"),this):this)},J.scale_to_fit=function(){if(w){var a=document.body.getBoundingClientRect().width;if(a<B){var b=a/B;w.style("transform","scale("+b+")").style("-webkit-transform","scale("+b+")").style("transform-origin",D+" bottom").style("-webkit-transform-origin",D+" bottom")}else w.style("transform",null).style("-webkit-transform",null)}},J.position=function(a){return 0==arguments.length?D:D==a?this:(D=a,w?(w.call(aa,D),this):this)},J.caption=function(a,b){return 0===arguments.length?E:(E=a,y?(E?(z.text(a),y.style("display",null)):y.style("display","none"),z.style("color",b?b:null),this):this)},J.warning=function(a){return J.caption(a,A)};var K=function(){var a=[],b=[];l.forEach(function(c){b.push(c.row),a.push(c.col)}),m=Math.max.apply(null,a),n=Math.max.apply(null,b),i=130,k=10,j=100;var c=(m+1)*i+m*k+2*k+2*k,d=(n+1)*j+k+k*(n-1)+2*k+2*k,e=B/c;i*=e,j*=e,k*=e,h=d*e+1},L=function(a){l=[],l.keyboard="simple",l.formula={type:"formula",col:2,row:0,cols:6},l.push({name:"Cancel",type:"event",event:"cancel",col:0,row:0,cols:2}),l.push({type:"backspace",col:8,row:0}),l.push({name:"Done",type:"event",event:"done",col:9,row:0,cols:2}),l.push({name:"7",type:"key",col:0,row:1}),l.push({name:"8",type:"key",col:1,row:1}),l.push({name:"9",type:"key",col:2,row:1}),l.push({name:"4",type:"key",col:0,row:2}),l.push({name:"5",type:"key",col:1,row:2}),l.push({name:"6",type:"key",col:2,row:2}),l.push({name:"1",type:"key",col:0,row:3}),l.push({name:"2",type:"key",col:1,row:3}),l.push({name:"3",type:"key",col:2,row:3}),l.push({name:"=",type:"key",col:3,row:1}),l.push({name:".",type:"key",col:3,row:2}),l.push({name:"0",type:"key",col:3,row:3}),l.push({name:"+",type:"key",col:4.5,row:1}),l.push({name:"−",type:"key",val:"-",col:5.5,row:1}),l.push({name:"*",type:"key",col:4.5,row:2,dy:"0.3em"}),l.push({name:"÷",type:"key",val:"/",col:5.5,row:2}),l.push({name:"(",type:"key",col:4.5,row:3}),l.push({name:")",type:"key",col:5.5,row:3}),a&&a.forEach(function(a,b){l.push({name:a,type:"key",col:b%4+7,row:1+Math.floor(b/4)})}),l.push({type:"arrow",dir:"left",col:9,row:3,cols:1,rows:1}),l.push({type:"arrow",dir:"right",col:10,row:3,cols:1,rows:1})},M=function(){l=[],l.keyboard="num",l.formula={type:"formula",col:2,row:0,cols:6},l.push({name:"Cancel",type:"event",event:"cancel",col:0,row:0,cols:2}),l.push({type:"backspace",col:8,row:0}),l.push({name:"Done",type:"event",event:"done",col:9,row:0,cols:2}),l.push({name:"7",type:"key",col:0,row:1}),l.push({name:"8",type:"key",col:1,row:1}),l.push({name:"9",type:"key",col:2,row:1}),l.push({name:"4",type:"key",col:0,row:2}),l.push({name:"5",type:"key",col:1,row:2}),l.push({name:"6",type:"key",col:2,row:2}),l.push({name:"1",type:"key",col:0,row:3}),l.push({name:"2",type:"key",col:1,row:3}),l.push({name:"3",type:"key",col:2,row:3}),l.push({name:"0",type:"key",col:0,row:4}),l.push({name:".",type:"key",col:1,row:4}),l.push({name:"=",alts:["<",">","=","≤","≥"],type:"key",col:2,row:4,id:"equal-key"}),l.push({name:"÷",type:"key",val:"/",col:3,row:1}),l.push({name:"*",type:"key",val:"*",col:3,row:2,dy:"0.3em"}),l.push({name:"−",type:"key",val:"-",col:3,row:3}),l.push({name:"+",alts:["+","±"],type:"key",col:3,row:4,id:"plus-key"}),l.push({name:"x",type:"key",col:4.5,row:1}),l.push({name:"y",type:"key",col:5.5,row:1}),l.push({name:"(",type:"key",col:4.5,row:2}),l.push({name:")",type:"key",col:5.5,row:2}),l.push({name:",",type:"key",col:4.5,row:3}),l.push({name:"_",html:"x<sub>n</sub>",type:"key",col:5.5,row:3}),l.push({name:"e",type:"key",col:4.5,row:4}),l.push({name:"i",type:"key",col:5.5,row:4}),l.push({name:"^2",val:"^2",tab:!0,html:"a<sup>2</sup>",dy:"0.1em",type:"key",col:7,row:1}),l.push({name:"^3",val:"^3",tab:!0,html:"a<sup>3</sup>",dy:"0.1em",type:"key",col:8,row:1}),l.push({name:"^n ",val:"^",html:"a<sup>n</sup>",dy:"0.1em",type:"key",col:9,row:1}),l.push({name:"√",type:"key",col:7,row:2}),l.push({name:"n√",cmd:"\\nthroot",html:"<sup>n</sup>√",dy:"0em",type:"key",col:8,row:2}),l.push({name:"log",type:"key",col:7,row:3}),l.push({name:"ln",type:"key",col:8,row:3}),l.push({name:"abc",type:"load_layout",col:11,row:0}),l.push({name:"αβγ",type:"load_layout",col:11,row:1}),l.push({type:"arrow",dir:"left",col:9,row:4,cols:1,rows:1}),l.push({type:"arrow",dir:"up",col:10,row:3,cols:1,rows:1}),l.push({type:"arrow",dir:"down",col:10,row:4,cols:1,rows:1}),l.push({type:"arrow",dir:"right",col:11,row:4,cols:1,rows:1})},N=function(){l=[],l.keyboard="alpha",l.formula={type:"formula",col:2,row:0,cols:6},l.push({name:"Cancel",type:"event",event:"cancel",col:0,row:0,cols:2}),l.push({type:"backspace",col:8,row:0}),l.push({name:"Done",type:"event",event:"done",col:9,row:0,cols:2}),l.push({name:"1",type:"key",col:0,row:1}),l.push({name:"2",type:"key",col:1,row:1}),l.push({name:"3",type:"key",col:2,row:1}),l.push({name:"4",type:"key",col:3,row:1}),l.push({name:"5",type:"key",col:4,row:1}),l.push({name:"6",type:"key",col:5,row:1}),l.push({name:"7",type:"key",col:6,row:1}),l.push({name:"8",type:"key",col:7,row:1}),l.push({name:"9",type:"key",col:8,row:1}),l.push({name:"0",type:"key",col:9,row:1}),l.push({name:"q",type:"key",col:0,row:2}),l.push({name:"w",type:"key",col:1,row:2}),l.push({name:"e",type:"key",col:2,row:2}),l.push({name:"r",type:"key",col:3,row:2}),l.push({name:"t",type:"key",col:4,row:2}),l.push({name:"y",type:"key",col:5,row:2}),l.push({name:"u",type:"key",col:6,row:2}),l.push({name:"i",type:"key",col:7,row:2}),l.push({name:"o",type:"key",col:8,row:2}),l.push({name:"p",type:"key",col:9,row:2}),l.push({name:"a",type:"key",col:.3,row:3}),l.push({name:"s",type:"key",col:1.3,row:3}),l.push({name:"d",type:"key",col:2.3,row:3}),l.push({name:"f",type:"key",col:3.3,row:3}),l.push({name:"g",type:"key",col:4.3,row:3}),l.push({name:"h",type:"key",col:5.3,row:3}),l.push({name:"j",type:"key",col:6.3,row:3}),l.push({name:"k",type:"key",col:7.3,row:3}),l.push({name:"l",type:"key",col:8.3,row:3}),l.push({name:"z",type:"key",col:.6,row:4}),l.push({name:"x",type:"key",col:1.6,row:4}),l.push({name:"c",type:"key",col:2.6,row:4}),l.push({name:"v",type:"key",col:3.6,row:4}),l.push({name:"b",type:"key",col:4.6,row:4}),l.push({name:"n",type:"key",col:5.6,row:4}),l.push({name:"m",type:"key",col:6.6,row:4}),l.push({name:"123",type:"load_layout",col:11,row:0}),l.push({name:"÷",type:"key",val:"/",col:10,row:1}),l.push({name:"*",type:"key",val:"*",col:11,row:1,dy:"0.3em"}),l.push({name:"−",type:"key",val:"-",col:10,row:2}),l.push({name:"+",alts:["+","±"],type:"key",col:11,row:2,id:"plus-key"}),l.push({name:"(",type:"key",col:10,cols:1,row:3}),l.push({name:")",type:"key",col:11,cols:1,row:3}),l.push({name:"^n ",val:"^",html:"a<sup>n</sup>",dy:"0.1em",type:"key",col:10,row:4}),l.push({name:"√",alts:["√",{name:"ⁿ√",cmd:"\\nthroot"}],type:"key",col:11,row:4,id:"root-key"}),l.push({name:"=",alts:["<",">","=","≤","≥"],type:"key",col:9,row:4,id:"equal-key"}),l.push({name:"_",html:"x<sub>n</sub>",type:"key",col:8,row:4}),l.push({name:"⇧",type:"shift",col:0,row:4,cols:.6})},O=function(){l=[],l.keyboard="alpha",l.formula={type:"formula",col:2,row:0,cols:6},l.push({name:"Cancel",type:"event",event:"cancel",col:0,row:0,cols:2}),l.push({type:"backspace",col:8,row:0}),l.push({name:"Done",type:"event",event:"done",col:9,row:0,cols:2}),l.push({name:"1",type:"key",col:0,row:1}),l.push({name:"2",type:"key",col:1,row:1}),l.push({name:"3",type:"key",col:2,row:1}),l.push({name:"4",type:"key",col:3,row:1}),l.push({name:"5",type:"key",col:4,row:1}),l.push({name:"6",type:"key",col:5,row:1}),l.push({name:"7",type:"key",col:6,row:1}),l.push({name:"8",type:"key",col:7,row:1}),l.push({name:"9",type:"key",col:8,row:1}),l.push({name:"0",type:"key",col:9,row:1}),l.push({name:"ς",type:"key",col:1,row:2}),l.push({name:"ε",type:"key",col:2,row:2}),l.push({name:"ρ",type:"key",col:3,row:2}),l.push({name:"τ",type:"key",col:4,row:2}),l.push({name:"υ",type:"key",col:5,row:2}),l.push({name:"θ",type:"key",col:6,row:2}),l.push({name:"ι",type:"key",col:7,row:2}),l.push({name:"ο",type:"key",col:8,row:2}),l.push({name:"π",type:"key",col:9,row:2}),l.push({name:"α",type:"key",col:.3,row:3}),l.push({name:"σ",type:"key",col:1.3,row:3}),l.push({name:"δ",type:"key",col:2.3,row:3}),l.push({name:"φ",type:"key",col:3.3,row:3}),l.push({name:"γ",type:"key",col:4.3,row:3}),l.push({name:"η",type:"key",col:5.3,row:3}),l.push({name:"ξ",type:"key",col:6.3,row:3}),l.push({name:"κ",type:"key",col:7.3,row:3}),l.push({name:"λ",type:"key",col:8.3,row:3}),l.push({name:"ζ",type:"key",col:.6,row:4}),l.push({name:"χ",type:"key",col:1.6,row:4}),l.push({name:"ψ",type:"key",col:2.6,row:4}),l.push({name:"ω",type:"key",col:3.6,row:4}),l.push({name:"β",type:"key",col:4.6,row:4}),l.push({name:"ν",type:"key",col:5.6,row:4}),l.push({name:"μ",type:"key",col:6.6,row:4}),l.push({name:"123",type:"load_layout",col:11,row:0}),l.push({name:"÷",type:"key",val:"/",col:10,row:1}),l.push({name:"*",type:"key",val:"*",col:11,row:1,dy:"0.3em"}),l.push({name:"−",type:"key",val:"-",col:10,row:2}),l.push({name:"+",alts:["+","±"],type:"key",col:11,row:2,id:"plus-key"}),l.push({name:"(",type:"key",col:10,cols:1,row:3}),l.push({name:")",type:"key",col:11,cols:1,row:3}),l.push({name:"^n ",val:"^",html:"a<sup>n</sup>",dy:"0.1em",type:"key",col:10,row:4}),l.push({name:"√",alts:["√",{name:"ⁿ√",cmd:"\\nthroot"}],type:"key",col:11,row:4,id:"root-key"}),l.push({name:"=",alts:["<",">","=","≤","≥"],type:"key",col:9,row:4,id:"equal-key"}),l.push({name:"_",html:"x<sub>n</sub>",type:"key",col:8,row:4}),l.push({name:"⇧",type:"shift",col:0,row:4,cols:.6})},P=function(){w=d3.select("body").append("div").style({position:"fixed",bottom:0,"z-index":1e4}).style("display",v?"block":"none"),y=w.append("div").attr("id","caption"),z=y.append("span").text(E),y.append("span").text("x").style({position:"absolute",right:"5px",top:"-3px",color:"silver",cursor:"pointer"}).on("click",function(){J.caption(!1)}),x=w.append("div").classed("keyboard",!0),f=x.append("div").attr("id","formula").append("div").attr("id","mq_div").append("span").attr("id","mq_span"),q=G.MathField(f.node(),I),g=$(f.node()).find("textarea"),v&&q.focus(),d3.select(g[0]).on("keyup",function(){13===d3.event.keyCode?c("done"):27===d3.event.keyCode?c("cancel"):setTimeout(function(){c("change")},1)}),S()},Q=function(){x.selectAll(".key").remove(),x.select("#formula").datum(l.formula),d(x)},R=function(){K(),w.call(aa,D),x.style("height",h+"px").style("width",B+"px").style({bottom:0,background:"#DDD",padding:0,"text-align":"center",border:"1px solid silver","border-radius":1.5*k+"px "+1.5*k+"px 0 0","border-bottom":"none"}).select("#formula").style("border",k+"px solid #DDD").style("border-radius",k+"px").call(Y,k).select("#mq_div").style("border-radius",k+"px").style("width",function(a){return(a.cols||1)*i+((a.cols||1)-1)*k+"px"}).call(_).select("#mq_span").style("box-shadow","none").style("-webkit-box-shadow","none").style("-moz-box-shadow","none").style("margin-top",k).style("font-size",j/2+j/10+"px").style("padding-top",3*k-2+"px").style("padding-bottom",2*k+"px").style("border","none").style("min-height",function(a){return(a.rows||1)*j+((a.rows||1)-1)*k-5*k+"px"}).style("width","100%"),x.selectAll(".key").call(Y).call(Z).call(_),x.selectAll(".backspace-key path").attr("d",r).style("stroke","black").style("stroke-width","1.2").style("fill","none").attr("transform","translate("+i/2+","+j/2+")scale("+.12*k+")"),
x.selectAll(".arrow-key path").attr("d",s).style("stroke","black").style("stroke-linejoin","round").style("stroke-width",3).style("fill","none").attr("transform",function(a){var b={left:-90,up:0,right:90,down:180}[a.dir];return"translate("+i/2+","+j/2+")scale("+.06*k+")rotate("+b+")"}),x.selectAll(".normal-key span.keylabel").text(function(a){return a.name}).style("line-height",j+"px").filter(function(a){return a.dy||a.html}).style("display","inline-block").style("margin-top",function(a){return a.dy}).filter(function(a){return a.html}).html(function(a){return a.html}),x.selectAll(".normal-key span.dots").text("…").style({position:"absolute",bottom:"2px",right:"5px","font-size":"0.6em","font-family":'"Helvetica Neue", Arial, Helvetica, sans-serif',"font-weight":400,color:"silver"}),y.style({position:"relative",background:"rgb(244, 244, 244)",padding:"12px","padding-bottom":"8px",border:"1px solid silver","border-radius":"7.6px 7.6px 0 0","border-bottom":"none",width:4*i+3*k+"px","margin-left":8*i+10*k+"px","font-family":"HelveticaNeue-Light",color:"#666","font-size":"17px","text-align":"center",display:E?null:"none"})},S=function(){/iPhone|iPod|iPad|Android|BlackBerry/.test(navigator.userAgent)&&x.select(".textarea textarea").attr("readonly","readonly")},T=function(a){if($("[data-original-title]").each(function(){$(this).popover("hide")}),d3.select(this).style("background","gray"),"formula"!==a.type)if(q.focus(),"load_layout"===a.type)U(a.name);else if("shift"===a.type)V(a);else if("key"!==a.type||a.alts){if("backspace"===a.type)g.trigger($.Event("keydown",{which:8})),c("change");else if("event"===a.type)c(a.event);else if("arrow"===a.type){var b={left:37,up:38,right:39,down:40}[a.dir];g.trigger($.Event("keydown",{which:b})),c("change")}}else e(a)},U=function(a){if(C=!1,"αβγ"===a)O();else if("123"===a)M();else if("abc"===a)N();else if("simple"===a){var b=J.latex().replace(/[^a-zA-z]/g,""),c=b.split("").filter(function(a,b,c){return c.indexOf(a)===b});L(c)}Q(),R()},V=function(a){C=!C,x.selectAll(".key span.keylabel").text(function(a){return"key"===a.type?C?a.name.toUpperCase():a.name.toLowerCase():a.name})},W=function(a){p?($(this).popover("hide"),e(p)):"key"===a.type&&a.alts&&!a.popover_visible&&e(a),p=null,"shift"===a.type&&C||d3.select(this).style("background","key"==a.type||"formula"==a.type?"white":"silver")},X=function(a){("backspace"===a.type||a.alts)&&(a.alts&&($("#"+a.id).popover("toggle"),a.popover_visible=!0),"backspace"===a.type&&(q.latex(""),q.focus()))},Y=function(a,b){b=b||0,a.style("position","absolute").style("left",function(a){return a.col*(i+k)+2*k-b+"px"}).style("bottom",function(a){return(n-a.row)*(j+k)+(0==a.row,0)+2*k-b+"px"})},Z=function(a,b,c){b=b||0,c=c||0,a.style("width",function(a){return(a.cols||1)*i+((a.cols||1)-1)*k-2*b+"px"}).style("height",function(a){return(a.rows||1)*j+((a.rows||1)-1)*k-2*c+"px"})},_=function(a,b){a.style("border-radius",k+"px").style("font-size",j/2+"px").style("background",function(a){return b?null:"key"==a.type||"formula"==a.type?"white":"silver"}).style("box-shadow",b?null:"#888 0px 1px 0px").style("font-family","'HelveticaNeue-UltraLight', 'Helvetica Neue UltraLight', 'Helvetica Neue', Arial, Helvetica, sans-serif").style("font-weight",100).style("border","none").style("padding",0).style("-webkit-user-select","none").style("-khtml-user-select","none").style("-moz-user-select","none").style("-ms-user-select","none").style("user-select","none").style("cursor","pointer")},aa=function(a,b){"center"===b?(a.style("margin-left",-B/2+"px"),a.style("left","50%"),a.style("right",null)):"left"===b?(a.style("margin-left",0),a.style("left",0),a.style("right",null)):"right"===b?(a.style("margin-left",0),a.style("left",null),a.style("right",0)):(a.style("margin-left",-B/2+"px"),a.style("left",b),a.style("right",null))};return d3.rebind(J,t,"on")};return a};return function(){return a||(a=b()())}}(),Wa.ui.addMacroButton=function(){function a(a){p=a,p.appendButtonGroup([{type:"dropdown",label:"formulas",data_toggle:"dropdown",pull_right:!0,icon:"glyphicon glyphicon-book",html_fn:b}])}function b(a,b){c(r);var f={cols:2,mar:5,w:200,h:180},g=d(a,f),h=e(g,f);return $(a).on("shown.bs.dropdown",function(){n()}),$(a).on("hide.bs.dropdown",function(){m(null,h)}),g.node()}function c(a){a.forEach(function(a){a.dl=new Wa.DerivationList(null,null,{eq:a.math.replace("=>","\\\\"),visualized:!1})})}function d(a,b){var c=d3.select(a).append("div");return c.on("click",function(){d3.event.stopPropagation()}),c.style("width",b.cols*b.w+2*b.cols*b.mar+2*b.mar+2+"px"),c.style("padding",b.mar+"px"),c.append("p").text("click to apply or drag to copy a formula").style({color:"gray","font-style":"italic","text-align":"center"}),c}function e(a,b){var c=a.selectAll(".formulas").data(r),d=c.enter().append("div").style({width:b.w+"px",height:b.h+"px",margin:b.mar+"px",display:"inline-block","vertical-align":"top",border:"1px solid silver","border-radius":"2px",padding:"5px","text-align":"center",position:"relative",cursor:"pointer"}).on("mousedown",function(a){f(a,c),h(a)}).on("click",function(a){g(a,c),h(a)});return d.append("h2").text(function(a){return a.title}).style({"font-size":"1em",margin:"5px 0 10px 0"}),d.append("p").style("margin-bottom","0px").append(function(a){var b=document.createElement("div");return a.expression1_container=d3.select(b),b}),d.append("div").style("clear","both"),d.append("p").style("margin-bottom","0px").append(function(a){var b=document.createElement("div");return a.expression2_container=d3.select(b),b}),d.append("div").style({position:"absolute",top:0,bottom:0,left:0,right:0}),c}function f(a,b){i(a,b),a.allow_copy=!0,k(a,b)}function g(a,b){a.allow_copy=!1}function h(a){a.selected?l(a):j()}function i(a,b){r.forEach(function(b){b.selected=!(!a||b!==a)&&!a.selected,b.allow_copy=b===a}),b.style("background",function(a){return a.selected?"#FFDF00":null})}function j(a){a||(a=[]),p.model.dls().forEach(function(a){a.getLastRow().view.interaction_handler.highlight_nodes([])}),a.forEach(function(a){a.getLastView().interaction_handler.highlight_nodes(a.getLastModel().children)})}function k(a,b){if("none"===p.model.foreground_event_layer_visible()){p.model.foreground_event_layer_visible(!0);var c=p.model.foreground_event_layer();q||(q=Wa.mtouch_events().frame(c.node()).on("tap",function(){var c={x:d3.event.finger.pos[0],y:d3.event.finger.pos[1]};a.actions.forEach(function(a){a.target_dl.hitTest(c)&&a.target_row.model.performAction(a.action)}),m(a,b)}),c.call(q))}}function l(a){a.actions=[];var b=[a.dl.rows[0].model,a.dl.getLastModel()];p.model.dls().forEach(function(c){var d=c.getLastRow(),e=Wa.actions.ApplyMacroAction.getAllAvailableActions(b,d.model);a.actions=a.actions.concat(e.map(function(a){return{action:a,target_dl:c,target_row:d}}))}),j(a.actions.map(function(a){return a.target_dl}))}function m(a,b){p.model.foreground_event_layer_visible()&&(p.model.foreground_event_layer().on("click.macro-menu",null),p.model.foreground_event_layer_visible(!1)),i(a,b),j()}function n(){r.forEach(function(a){a.initialized||(o(a.expression1_container,a.dl.rows[0].model.to_ascii()),o(a.expression2_container,a.dl.getLastModel().to_ascii())),a.initialized=!0})}function o(a,b,c){var d=32,e=a.append("svg").style("width","100%").style("overflow","visible").style("margin-left","0.5em").style("display","inline-block").style("visibility","hidden"),f=new Wa.AlgebraModel(b),g=new Wa.AlgebraView(f,e,{interactive:!1,inactive_color:"#000000",font_size:d,v_align:"alphabetic",h_align:"left"}),h=function(){var b=g.getBBox();e.style("height",b.height).style("width",b.width),g.main.attr("transform","translate("+[0,b.height]+")"),c?a.style("margin-bottom",b.height-f.children[0].ascent+"px"):e.style("margin-bottom",b.height-f.children[0].ascent+"px")};g.init(function(){h();var a=g.getBBox();setTimeout(function(){var b=e.node().parentNode.clientWidth,c=a.width;c>.9*b&&(g.options.font_size*=.9*b/c,g.update_all(!0),h()),e.style("visibility",null)},1)})}var p,q,r=[{title:"Quadratic Formula",math:"ax^2+bx+c=0  =>  x=(-b±sqrt{b^2-4*a*c})/(2*a)"}];return a}(),$b=function(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")},_b=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),ac=function(){function a(b){var c=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];$b(this,a),this.container=d3.select(b),this.element=null,this.id=c.id||Wa.uid(),this.oid=c.oid,this.points=c.points||[],this.color=c.color||"black",this.width=c.width||1,this.type=c.type,this.init()}return _b(a,[{key:"toJSON",value:function(){return{id:this.id,type:"Path",points:this.points,color:this.color,width:this.width}}},{key:"init",value:function(){var a=null;return this.oid&&(a="#"+this.oid),this.element=this.container.insert("path",a).attr("id",this.id).style("fill","none").style("stroke-linecap","round").style("stroke-linejoin","round"),this.update()}},{key:"update",value:function(){return this.element.attr("d",a.line(this.points)+(1===this.points.length?"Z":"")).style("stroke",this.color).style("stroke-width",this.width),this}},{key:"remove",value:function(){return this.element.remove(),this}},{key:"setContainer",value:function(a){return 0===arguments.length?this.container:(this.container=a,this)}},{key:"renderOnto",value:function(a){var b=this.element,c=this.container;this.container=a,this.element=a.select("#"+this.id),this.element.empty()?this.init():this.update(),this.container=c,this.element=b}}]),a}(),ac.line="undefined"==typeof d3||"undefined"==typeof d3.svg?null:d3.svg.line(),Wa.ui=Wa.ui||{},Wa.ui.Path=ac,Wa.ui=Wa.ui||{},Wa.ui.TutorialPair=function(){var a=function(a,b){this.events=d3.dispatch("done","retry","next"),this.id=Wa.uid(),this.title=b.title,this.text=b.text,"gestureData"in b&&(this.gesture_data=b.gestureData,this.gesture_data.options.show_drag_indicator=!1,this.gesture_data.options.show_bg=!1),this.initial_expressions=function(a,b){return a?b?[a].concat(b.map(function(a){return a.expression})):[a]:[]}.call(this,b.eq,b.extraExamples),this.correct_answers=function(a,b){return a?b?[a.map(this.parsedAscii)].concat(b.map(function(a){return a.correctAnswers.map(this.parsedAscii)},this)):[a.map(this.parsedAscii)]:[]}.call(this,b.correctAnswers,b.extraExamples),this.current_example=0,this.start_wiggle=b.startWiggle,this.encourage=!0,this.container=d3.select(a),this.dl_div=null,this.dl=null,this.play_btn=Wa.svg_play_button(),this.player=null,this.practice_problem=b.practice_problem,this.allow_restart_after_done=!("allow_restart_after_done"in b)||b.allow_restart_after_done,this.answered=!1,this.log_mouse_trajectories=b.log_mouse_trajectories,this.task_name=b.task_name,this.init()};return a.prototype.parsedAscii=function(a){return new Wa.AlgebraModel(a).to_ascii()},a.prototype.replay=function(){this.play_btn.hidden(!0),this.player.replay(500,function(){setTimeout(function(){this.play_btn.hidden(!1),this.answered||(this.encourage&&(this.dl_div.append("span").text("Try it!").classed("tryit",!0),this.start_wiggle&&this.dl.startWiggle(this.start_wiggle)),this.dl_div.on("mousedown",function(){var a=new Date;this.startTime=a.getTime(),this.dl_div.select("span.tryit").remove(),this.dl_div.on("mousedown",null)}.bind(this)))}.bind(this),1e3)}.bind(this))},a.prototype.init=function(){this.container.append("h2").text(this.title),this.container.append("p").attr("class","tutorial-instructions").text(this.text);var a=this.container.append("div").classed("tutorial",!0),b=a.append("div").classed("choice",!0).classed("large-choice",this.practice_problem);this.gesture_data.options.pos={x:"center",y:"center"},this.gesture_data.options.hold_time=1e6,this.gesture_data.options.draggable=!1,this.gesture_data.options.collapsed_mode=!0,this.gesture_data.options.no_history=!1,this.gesture_data.options.no_handles=!0,this.gesture_data.options.edit_mode_drag_box_width="0px",this.gesture_data.options.row_padding={left:0,right:0,top:7,bottom:3},this.gesture_data.options.padding={left:0,right:0,top:0,bottom:0},this.gesture_data.options.replace_value_on=!1;var c=b.append("div").style({position:"absolute",left:0,right:0,top:0,bottom:0});if(this.player=new Wa.EventRecorder(this.gesture_data,c.node()),this.player.showPreview(),b.append("div").classed("animation",!0).call(this.play_btn.on("click",this.replay.bind(this))),this.initial_expressions.length){this.dl_div=a.append("div").classed("choice",!0).classed("large-choice",this.practice_problem);var d=new Wa.ui.CanvasFactory(this.dl_div.node(),{vertical_scroll:!1,use_toolbar:!1,use_keyboard:!1,use_hold_menu:!1,svg_height:"100%",log_mouse_trajectories:this.log_mouse_trajectories,ask_confirmation_on_closing:!1,overflow_visible:!0});this.logger=d.logger,this.model=d.model,this.setDLToExpression(this.initial_expressions[this.current_example]),this.startTime=-1}},a.prototype.chainTransition=function(a,b){if(a.node().__transition__&&a.id&&a.node().__transition__[a.id]){var c=a.node().__transition__[a.id];console.log("extra delay",c.delay+c.duration),b+=c.delay+c.duration}return a.transition().delay(b)},a.prototype.neutralTransition=function(a,b,c,d){a.selectAll("button").remove(),a.select("span.feedback").remove();var e=this.chainTransition(a,b).duration(c||500);return d?e.styleTween("background",function(){return d3.interpolate(d,"#EEEEEE")}):e.style("background","#eee"),e},a.prototype.wrongTransition=function(a,b,c,d){var e=d3.select(a.node());e.append("span").attr("class","feedback").style({opacity:1e-5}).text("✗");var f=this.chainTransition(a,b).duration(c||500);return d?f.styleTween("background",function(){return d3.interpolate(d,"#E0A8A8")}):f.style("background","#E0A8A8"),f.select(".feedback").style("opacity",1),f},a.prototype.correctTransition=function(a,b,c,d){var e=d3.select(a.node());e.append("span").attr("class","feedback").style({opacity:1e-5}).text("✓"),this.initDoItAgainBtn(e),this.initial_expressions.length>1&&this.initTryAnotherBtn(e);var f=this.chainTransition(a,b).duration(c||500);return d?f.styleTween("background",function(){return d3.interpolate(d,"#A8E0B3")}):f.style("background","#A8E0B3"),f.select(".feedback").style("opacity",1),f.selectAll("button").style("opacity",1),f},a.prototype.initDoItAgainBtn=function(a){a.append("button").text("do it again").style({top:"10px",opacity:1e-5}).on("click",function(){this.logger.logCustomInteraction("tutorial-reset",{task_name:this.task_name,eq_start:this.dl.rows[0].model.to_ascii(),eq_end:this.dl.getLastModel().to_ascii()}),this.allow_restart_after_done&&this.retry()}.bind(this))},a.prototype.initTryAnotherBtn=function(a){a.append("button").text("try another").style({top:"62px",opacity:1e-5}).on("click",function(){this.logger.logCustomInteraction("tutorial-alternative-example",{task_name:this.task_name,eq_start:this.dl.rows[0].model.to_ascii()}),this.initial_expressions.length>1?this.loadNextExample():this.retry()}.bind(this))},a.prototype.checkAnswer=function(){var a=400;setTimeout(function(){this.dl.getLastView().interactive(!1);var a=this.dl.getLastModel().to_ascii(),b=new Date,c=-1,d=-1;if(this.startTime!==-1&&(c=b.getTime()-this.startTime),this.parsedAscii(this.initial_expressions[this.current_example])===this.dl.getLastModel().to_ascii())this.dl.getLastView().interactive(!0),d="initial state";else if(this.answerIsCorrect(a)){if(d="correct",this.answered=!0,this.logger.logCustomInteraction("tutorial-success",{task_name:this.task_name,eq_start:this.dl.rows[0].model.to_ascii(),eq_end:this.dl.getLastModel().to_ascii()}),2===this.dl_div.selectAll("div").size())return;this.correctTransition(this.dl_div,200,null,"#EEEEEE").each("end",this.events.done)}else this.practice_problem?(d="intermediate state",this.dl.getLastView().interactive(!0)):(d="wrong",this.logger.logCustomInteraction("tutorial-fail",{task_name:this.task_name,eq_start:this.dl.rows[0].model.to_ascii(),eq_end:this.dl.getLastModel().to_ascii()}),this.wrongTransition(this.dl_div,200,null,"#EEEEEE").transition().duration(500).each("end",this.retry.bind(this)),this.encourage=!0);window&&window.gmath_log_ga&&gmath_log_ga.trackEvent("tutorial",d,this.eq,c)}.bind(this),a)},a.prototype.answerIsCorrect=function(a){return this.correct_answers[this.current_example].indexOf(a)!==-1},a.prototype.loadNextExample=function(){this.dl.rows[0].model.to_ascii();this.neutralTransition(this.dl_div,0,1).each("end",function(){this.current_example++,this.current_example===this.initial_expressions.length&&(this.current_example=0),this.setDLToExpression(this.initial_expressions[this.current_example]),0===this.current_example?this.encourage=!0:this.encourage=!1,this.events.next()}.bind(this))},a.prototype.retry=function(){this.neutralTransition(this.dl_div,0,1).each("end",function(){this.setDLToExpression(this.initial_expressions[this.current_example]),this.events.retry()}.bind(this)),this.answered=!1,this.encourage=!0},a.prototype.setDLToExpression=function(a){var b=Wa.deepCopy(this.gesture_data.options);b.eq=a,b.inactive_color=Wa.AlgebraView.defaultOptions.inactive_color,b.color=Wa.AlgebraView.defaultOptions.color,b.h_align="center",b.edit_mode_drag_box_width="0px",b.show_drag_indicator=Wa.AlgebraView.defaultOptions.show_drag_indicator,this.logger.listen(!1),this.dl&&this.model.removeElement(this.dl),this.dl=this.model.createDL(b),this.logger.listen(!0),this.dl.getLastRow().view.interaction_handler.events.on("touch",function(){this.encourage=!1}.bind(this)),this.dl.getLastView().interactive(!0),this.dl.events.on("end-of-interaction."+this.id,this.checkAnswer.bind(this))},a.prototype.stop=function(){this.player.stop_animation()},a}(),Wa.gmifyPage=function(a,b){b=b||{},coordinator=new DLCoordinator;var c=a?d3.select(a):d3.select("body"),d=c.size()>0&&c.classed("gmify-canvas")?c:c.selectAll(".gmify-canvas");d.each(function(){var a=d3.select(this),b=a.text().split(";");try{b.forEach(Wa.AlgebraModel.getDefaultParser().parse),a.classed("gmify-canvas",!1).classed("gmified-canvas",!0),a.classed("bootstrap-styles",!0),a.select("*").remove();var c=new Wa.ui.CanvasFactory(this,{height:"500px"});Ta(a);var d={pos:["auto",20],v_align:"top"};c.model.createDLs(b,d)}catch(a){console.log('could not parse "'+b+'". Error:',a)}}),d=c.size()>0&&c.classed("gmify-minimal")?c:c.selectAll(".gmify-minimal"),d.each(function(){var a=d3.select(this),b=a.text();try{Wa.AlgebraModel.getDefaultParser().parse(b),a.classed("gmify-minimal",!1).classed("gmified-minimal",!0),a.classed("bootstrap-styles",!0),a.select("*").remove(),a.text("");var c=a.insert("svg").style({overflow:"visible",display:"block",width:"100%"});Wa.DerivationList.createFixedSingleLineDL(c.node(),{eq:b})}catch(a){console.log('could not parse "'+b+'". Error:',a)}}),d=c.size()>0&&c.classed("gmify")?c:c.selectAll(".gmify"),d.each(function(a,c){var d=d3.select(this),e=d.text();try{Wa.AlgebraModel.getDefaultParser().parse(e),d.classed("gmify",!1).classed("gmified",!0),d.classed("bootstrap-styles",!0),d.select("*").remove(),d.text("");var f=d.insert("div").style({overflow:"visible",display:"block","margin-top":"30px"}),g=new Wa.ui.CanvasFactory(f.node(),{minimal:!0,logo_src:b.logo_src}),h=g.model.createDL({eq:e,pos:{x:0,y:0},cloning_on:!1,normal_font:{family:"Kalam"},italic_font:{family:"Kalam"},font_baseline_shift:.4,font_ascent:.9,font_descent:.2,slanted_div_bar:!0,div_bar_height:1/14,font_size:"45",row_border_color:"#ddd",handle_stroke_color:"#d8d8d8",keep_in_container:!0});Ta(d),coordinator.subscribeToCanvasModel(g.model),coordinator.addDL(h),g.model.focusOnDL(h),g.controller.clearInteractionTimeline()}catch(a){console.log('could not parse "'+e+'". Error:',a)}})},Wa.Tree=Va,Wa.session_id=Wa.uid(),a("version",bc="0.12.2"),a("expressions",cc=Wa.expressions),a("ui",dc=Wa.ui),a("options",ec=Wa.options),a("mtouch_defaults",fc=Wa.mtouch_defaults),a("mtouch_events",gc=Wa.mtouch_events),a("d3_eventDispatch",hc=Wa.d3_eventDispatch),a("transform_behavior",ic=Wa.transform_behavior),a("Timeline",jc=Wa.Timeline),a("CanvasElementClass",kc=Wa.CanvasElementClass),a("tokenize",lc=Wa.tokenize),a("AlgebraParser",mc=Wa.AlgebraParser),a("AlgebraRegExp",nc=Wa.AlgebraRegExp),a("AlgebraModel",oc=Wa.AlgebraModel),a("FontLoader",pc=Wa.FontLoader),a("ChangeNumberHandler",qc=Wa.ChangeNumberHandler),a("HitTester",rc=Wa.HitTester),a("Reselector",sc=Wa.Reselector),a("DragHandler",tc=Wa.DragHandler),a("AlgebraView",uc=Wa.AlgebraView),a("preloadFonts",vc=Wa.preloadFonts),a("AlgebraModelLink",wc=Wa.AlgebraModelLink),a("LinkCoordinatorClass",xc=Wa.LinkCoordinatorClass),a("LinkCoordinator",yc=Wa.LinkCoordinator),a("actions",zc=Wa.actions),a("Action",Ac=Wa.Action),a("factoring",Bc=Wa.factoring),a("canceling",Cc=Wa.canceling),a("rules",Dc=Wa.rules),a("DerivationRow",Ec=Wa.DerivationRow),a("DerivationList",Fc=Wa.DerivationList),a("CanvasEventRecorder",Gc=Wa.CanvasEventRecorder),a("DLLogger",Hc=Wa.DLLogger),a("CanvasLogger",Ic=Wa.CanvasLogger),a("CanvasSaver",Jc=Wa.CanvasSaver),a("DataLogger",Kc=Wa.DataLogger),a("GMEventRecorder",Lc=Wa.GMEventRecorder),a("EventRecorder",Mc=Wa.EventRecorder),a("loadFromJSON",Nc=Wa.loadFromJSON),a("ServerComm",Oc=Wa.ServerComm),a("setupLogging",Pc=Wa.setupLogging),a("svg_play_button",Qc=Wa.svg_play_button),a("TrialLogger",Rc=Wa.TrialLogger),a("IdentificationModal",Sc=Wa.IdentificationModal),a("gmifyPage",Tc=Wa.gmifyPage),a("session_id",Uc=Wa.session_id),a("Algebrite",Ua),a("version",bc),a("expressions",cc),a("ui",dc),a("options",ec),a("mtouch_defaults",fc),a("mtouch_events",gc),a("d3_eventDispatch",hc),a("transform_behavior",ic),a("Timeline",jc),a("CanvasElementClass",kc),a("tokenize",lc),a("AlgebraParser",mc),a("AlgebraRegExp",nc),a("AlgebraModel",oc),a("FontLoader",pc),a("ChangeNumberHandler",qc),a("HitTester",rc),a("Reselector",sc),a("DragHandler",tc),a("AlgebraView",uc),a("preloadFonts",vc),a("AlgebraModelLink",wc),a("LinkCoordinatorClass",xc),a("LinkCoordinator",yc),a("actions",zc),a("Action",Ac),a("factoring",Bc),a("canceling",Cc),a("rules",Dc),a("DerivationRow",Ec),a("DerivationList",Fc),a("CanvasEventRecorder",Gc),a("DLLogger",Hc),a("CanvasLogger",Ic),a("CanvasSaver",Jc),a("DataLogger",Kc),a("GMEventRecorder",Lc),a("EventRecorder",Mc),a("loadFromJSON",Nc),a("ServerComm",Oc),a("setupLogging",Pc),a("svg_play_button",Qc),a("TrialLogger",Rc),a("IdentificationModal",Sc),a("gmifyPage",Tc),a("Tree",Va),a("session_id",Uc),a("reduceProduct",ha),a("CanvasFactory",Zb),a("insertCanvas",Yb),a("uid",d),a("inherit",e),a("object",_a),a("extend",ab),a("deepCopy",bb),a("deepEquals",cb),a("find",f),a("findIndex",g),a("array",db),a("getURLParameter",i),a("byteLength",j),a("termsToAlgebriteString",k),a("loadScripts",l)}}}),function(a){if("undefined"!=typeof document){var b=document,c="appendChild",d="styleSheet",e=b.createElement("style");e.type="text/css",b.getElementsByTagName("head")[0][c](e),e[d]?e[d].cssText=a:e[c](b.createTextNode(a))}}('@font-face{font-family:Symbola;src:url(jspm_packages/npm/mathquill@0.10.1-a/build/font/Symbola.eot);src:local("Symbola Regular"),local("Symbola"),url(jspm_packages/npm/mathquill@0.10.1-a/build/font/Symbola.woff2) format("woff2"),url(jspm_packages/npm/mathquill@0.10.1-a/build/font/Symbola.woff) format("woff"),url(jspm_packages/npm/mathquill@0.10.1-a/build/font/Symbola.ttf) format("truetype"),url(jspm_packages/npm/mathquill@0.10.1-a/build/font/Symbola.otf) format("opentype"),url(jspm_packages/npm/mathquill@0.10.1-a/build/font/Symbola.svg#Symbola) format("svg")}.mq-editable-field{display:-moz-inline-box;display:inline-block}.mq-editable-field .mq-cursor{border-left:1px solid #000;margin-left:-1px;position:relative;z-index:1;padding:0;display:-moz-inline-box;display:inline-block}.mq-editable-field .mq-cursor.mq-blink{visibility:hidden}.mq-editable-field,.mq-math-mode .mq-editable-field{border:1px solid gray}.mq-editable-field.mq-focused,.mq-math-mode .mq-editable-field.mq-focused{-webkit-box-shadow:#8bd 0 0 1px 2px,inset #6ae 0 0 2px 0;-moz-box-shadow:#8bd 0 0 1px 2px,inset #6ae 0 0 2px 0;box-shadow:#8bd 0 0 1px 2px,inset #6ae 0 0 2px 0;border-color:#709AC0;border-radius:1px}.mq-math-mode .mq-editable-field{margin:1px}.mq-editable-field .mq-latex-command-input{color:inherit;font-family:"Courier New",monospace;border:1px solid gray;padding-right:1px;margin-right:1px;margin-left:2px}.mq-editable-field .mq-latex-command-input.mq-empty{background:0 0}.mq-editable-field .mq-latex-command-input.mq-hasCursor{border-color:ActiveBorder}.mq-editable-field .mq-cursor:only-child:after,.mq-editable-field .mq-textarea+.mq-cursor:last-child:after,.mq-editable-field.mq-empty:after,.mq-editable-field.mq-text-mode:after,.mq-math-mode .mq-empty:after{visibility:hidden;content:\'c\'}.mq-editable-field .mq-text-mode .mq-cursor:only-child:after{content:\'\'}.mq-editable-field.mq-text-mode{overflow-x:auto;overflow-y:hidden}.mq-math-mode .mq-root-block,.mq-root-block{display:-moz-inline-box;display:inline-block;width:100%;padding:2px;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;white-space:nowrap;overflow:hidden;vertical-align:middle}.mq-math-mode{font-variant:normal;font-weight:400;font-style:normal;font-size:115%;line-height:1;display:-moz-inline-box;display:inline-block}.mq-math-mode .mq-non-leaf,.mq-math-mode .mq-scaled{display:-moz-inline-box;display:inline-block}.mq-math-mode .mq-nonSymbola,.mq-math-mode .mq-text-mode,.mq-math-mode var{font-family:"Times New Roman",Symbola,serif;line-height:.9}.mq-math-mode *{font-size:inherit;line-height:inherit;margin:0;padding:0;border-color:#000;-webkit-user-select:none;-moz-user-select:none;user-select:none;box-sizing:border-box}.mq-math-mode .mq-empty{background:#ccc}.mq-math-mode .mq-empty.mq-root-block,.mq-math-mode.mq-empty{background:0 0}.mq-math-mode .mq-text-mode{display:inline-block}.mq-math-mode .mq-text-mode.mq-hasCursor{box-shadow:inset #a9a9a9 0 .1em .2em;padding:0 .1em;margin:0 -.1em;min-width:1ex}.mq-math-mode .mq-font{font:1em "Times New Roman",Symbola,serif}.mq-math-mode .mq-font *{font-family:inherit;font-style:inherit}.mq-math-mode b,.mq-math-mode b.mq-font{font-weight:bolder}.mq-math-mode i,.mq-math-mode i.mq-font,.mq-math-mode var{font-style:italic}.mq-math-mode var.mq-f{margin-right:.2em;margin-left:.1em}.mq-math-mode .mq-roman var.mq-f{margin:0}.mq-math-mode big{font-size:200%}.mq-math-mode .mq-int>big{display:inline-block;-webkit-transform:scaleX(.7);-moz-transform:scaleX(.7);-ms-transform:scaleX(.7);-o-transform:scaleX(.7);transform:scaleX(.7);vertical-align:-.16em}.mq-math-mode .mq-int>.mq-supsub{font-size:80%;vertical-align:-1.1em;padding-right:.2em}.mq-math-mode .mq-int>.mq-supsub>.mq-sup>.mq-sup-inner{vertical-align:1.3em}.mq-math-mode .mq-int>.mq-supsub>.mq-sub{margin-left:-.35em}.mq-math-mode .mq-roman{font-style:normal}.mq-math-mode .mq-sans-serif{font-family:sans-serif,Symbola,serif}.mq-math-mode .mq-monospace{font-family:monospace,Symbola,serif}.mq-math-mode .mq-overline{border-top:1px solid #000;margin-top:1px}.mq-math-mode .mq-underline{border-bottom:1px solid #000;margin-bottom:1px}.mq-math-mode .mq-binary-operator{padding:0 .2em;display:-moz-inline-box;display:inline-block}.mq-math-mode .mq-supsub{text-align:left;font-size:90%;vertical-align:-.5em}.mq-math-mode .mq-supsub.mq-sup-only{vertical-align:.5em}.mq-math-mode .mq-supsub.mq-sup-only .mq-sup{display:inline-block;vertical-align:text-bottom}.mq-math-mode .mq-array>span,.mq-math-mode .mq-supsub .mq-sup{display:block}.mq-math-mode .mq-supsub .mq-sub{display:block;float:left}.mq-math-mode .mq-supsub .mq-binary-operator{padding:0 .1em}.mq-math-mode .mq-supsub .mq-fraction{font-size:70%}.mq-math-mode sup.mq-nthroot{font-size:80%;vertical-align:.8em;margin-right:-.6em;margin-left:.2em;min-width:.5em}.mq-math-mode .mq-paren{padding:0 .1em;vertical-align:top;-webkit-transform-origin:center .06em;-moz-transform-origin:center .06em;-ms-transform-origin:center .06em;-o-transform-origin:center .06em;transform-origin:center .06em}.mq-math-mode .mq-paren.mq-ghost{color:silver}.mq-math-mode .mq-paren+span{margin-top:.1em;margin-bottom:.1em}.mq-math-mode .mq-array{vertical-align:middle;text-align:center}.mq-math-mode .mq-operator-name{font-family:Symbola,"Times New Roman",serif;line-height:.9;font-style:normal}.mq-math-mode var.mq-operator-name.mq-first{padding-left:.2em}.mq-math-mode .mq-supsub.mq-after-operator-name,.mq-math-mode var.mq-operator-name.mq-last{padding-right:.2em}.mq-math-mode .mq-fraction{font-size:90%;text-align:center;vertical-align:-.4em;padding:0 .2em}.mq-math-mode .mq-fraction,.mq-math-mode .mq-large-operator,.mq-math-mode x:-moz-any-link{display:-moz-groupbox}.mq-math-mode .mq-fraction,.mq-math-mode .mq-large-operator,.mq-math-mode x:-moz-any-link,.mq-math-mode x:default{display:inline-block}.mq-math-mode .mq-denominator,.mq-math-mode .mq-large-operator .mq-from,.mq-math-mode .mq-large-operator .mq-to,.mq-math-mode .mq-large-operator big,.mq-math-mode .mq-numerator,.mq-math-mode .mq-vector-prefix,.mq-math-mode .mq-vector-stem{display:block}.mq-math-mode .mq-numerator{padding:0 .1em}.mq-math-mode .mq-denominator{border-top:1px solid;float:right;width:100%;padding:.1em}.mq-math-mode .mq-sqrt-prefix{padding-top:0;position:relative;top:.1em;vertical-align:top;-webkit-transform-origin:top;-moz-transform-origin:top;-ms-transform-origin:top;-o-transform-origin:top;transform-origin:top}.mq-math-mode .mq-sqrt-stem{border-top:1px solid;margin-top:1px;padding-left:.15em;padding-right:.2em;margin-right:.1em;padding-top:1px}.mq-math-mode .mq-vector-prefix{text-align:center;line-height:.25em;margin-bottom:-.1em;font-size:.75em}.mq-math-mode .mq-large-operator{vertical-align:-.2em;padding:.2em;text-align:center}.mq-math-mode .mq-large-operator .mq-from,.mq-math-mode .mq-large-operator .mq-to{font-size:80%}.mq-math-mode .mq-large-operator .mq-from{float:right;width:100%}.mq-math-mode,.mq-math-mode .mq-editable-field{cursor:text;font-family:Symbola,"Times New Roman",serif}.mq-math-mode .mq-overarrow{border-top:1px solid #000;margin-top:1px;padding-top:.2em}.mq-math-mode .mq-overarrow:before{display:block;position:relative;top:-.34em;font-size:.5em;line-height:0;content:\'\\27A4\';text-align:right}.mq-math-mode .mq-overarrow.mq-arrow-left:before{-moz-transform:scaleX(-1);-o-transform:scaleX(-1);-webkit-transform:scaleX(-1);transform:scaleX(-1);filter:FlipH;-ms-filter:"FlipH"}.mq-editable-field .mq-selection,.mq-editable-field .mq-selection .mq-non-leaf,.mq-editable-field .mq-selection .mq-scaled,.mq-math-mode .mq-selection,.mq-math-mode .mq-selection .mq-non-leaf,.mq-math-mode .mq-selection .mq-scaled{background:Highlight!important;color:HighlightText;border-color:HighlightText}.mq-editable-field .mq-selection .mq-matrixed,.mq-math-mode .mq-selection .mq-matrixed{background:#39F!important}.mq-editable-field .mq-selection .mq-matrixed-container,.mq-math-mode .mq-selection .mq-matrixed-container{filter:chroma(color=\'#3399FF\')!important}.mq-editable-field .mq-selection.mq-blur,.mq-editable-field .mq-selection.mq-blur .mq-matrixed,.mq-editable-field .mq-selection.mq-blur .mq-non-leaf,.mq-editable-field .mq-selection.mq-blur .mq-scaled,.mq-math-mode .mq-selection.mq-blur,.mq-math-mode .mq-selection.mq-blur .mq-matrixed,.mq-math-mode .mq-selection.mq-blur .mq-non-leaf,.mq-math-mode .mq-selection.mq-blur .mq-scaled{background:#D4D4D4!important;color:#000;border-color:#000}.mq-editable-field .mq-selection.mq-blur .mq-matrixed-container,.mq-math-mode .mq-selection.mq-blur .mq-matrixed-container{filter:chroma(color=\'#D4D4D4\')!important}.mq-editable-field .mq-textarea,.mq-math-mode .mq-textarea{position:relative;-webkit-user-select:text;-moz-user-select:text;user-select:text}.mq-editable-field .mq-selectable,.mq-editable-field .mq-textarea *,.mq-math-mode .mq-selectable,.mq-math-mode .mq-textarea *{-webkit-user-select:text;-moz-user-select:text;user-select:text;position:absolute;clip:rect(1em 1em 1em 1em);-webkit-transform:scale(0);-moz-transform:scale(0);-ms-transform:scale(0);-o-transform:scale(0);transform:scale(0);resize:none;width:1px;height:1px}.mq-math-mode .mq-matrixed{background:#fff;display:-moz-inline-box;display:inline-block}.mq-math-mode .mq-matrixed-container{filter:chroma(color=\'white\');margin-top:-.1em}');
})(function(a){"function"==typeof define&&define.amd?define([],a):"object"==typeof module&&module.exports&&"function"==typeof require?module.exports=a():gmath=a()});