/// Copyright Erik Weitnauer 2015.
gmath.ui.version="0.2.0";gmath.ui.gm_version="0.7.0";gmath.ui=gmath.ui||{};gmath.ui.Path=function(){var t=function(t,e){this.container=d3.select(t);this.element=null;e=e||{};this.id=e.id||gmath.uid();this.oid=e.oid;this.points=e.points||[];this.color=e.color||"black";this.width=e.width||1;this.type=e.type;this.init()};t.prototype.toJSON=function(){return{id:this.id,type:"Path",points:this.points,color:this.color,width:this.width}};t.line=typeof d3==="undefined"||typeof d3.svg==="undefined"?null:d3.svg.line();t.prototype.init=function(){var t=null;if(this.oid)t="#"+this.oid;this.element=this.container.insert("path",t).attr("id",this.id).style("fill","none").style("stroke-linecap","round").style("stroke-linejoin","round");return this.update()};t.prototype.update=function(){this.element.attr("d",t.line(this.points)+(this.points.length===1?"Z":"")).style("stroke",this.color).style("stroke-width",this.width);return this};t.prototype.remove=function(){this.element.remove();return this};t.prototype.setContainer=function(t){if(arguments.length===0)return this.container;this.container=t;return this};t.prototype.renderOnto=function(t){var e=this.element,n=this.container;this.container=t;this.element=t.select("#"+this.id);if(this.element.empty())this.init();else this.update();this.container=n;this.element=e};return t}();gm_erase_paths=function(){function t(t,e,n){n=n||20;var i=[];var r=function(t){var r=e[0][0];var o=e[0][1];var a=0;var l=0;if(t.length===1){if(!s(t[0][0],t[0][1],r,o,n)){i.push(t);return}}var p;while(a<t.length-1){var h=t[a];var d=t[a+1];var f=s(h[0],h[1],r,o,n);var y=s(d[0],d[1],r,o,n);if(f&&y){a++;l=a}else if(f&&!y){var m=u(h[0],h[1],d[0],d[1],r,o,n);if(m){t[a]=m;l=a}else{a++}}else if(!f&&y){var m=u(d[0],d[1],h[0],h[1],r,o,n);if(m){p=t.slice(l,a+1);p.push(m);i.push(p)}a++;l=a}else{var g=c(h[0],h[1],d[0],d[1],r,o,n);if(g){p=t.slice(l,a+1);if(p[p.length-1][0]!==g[0][0]||p[p.length-1][1]!==g[0][1]){p.push(g[0])}if(p.length>1)i.push(p);t[a]=g[1];if(t[a+1]&&t[a+1][0]==g[1][0]&&t[a+1][1]==g[1][1])a++;l=a}else{a++}}}if(l!==a){p=t.slice(l,t.length);if(p){i.push(p)}}};var a=function(t,r){if(t.path){n=n+t.width/2;var t=t.path}var o=e[r];var a=e[r+1];var r=0;var s=0;if(t.length===1){var l=p(t[0][0],t[0][1],o[0],o[1],a[0],a[1],n);if(l.indexOf(1)===-1){i.push(t);return}}var h;while(r<t.length-1){var u=t[r];var c=t[r+1];var l=p(u[0],u[1],o[0],o[1],a[0],a[1],n);var d=p(c[0],c[1],o[0],o[1],a[0],a[1],n);if(l.indexOf(1)!==-1&&d.indexOf(1)!==-1){r++;s=r}else if(l.indexOf(1)!==-1&&d.indexOf(1)===-1){var m=f(u[0],u[1],l,c[0],c[1],o[0],o[1],a[0],a[1],n);if(m){t[r]=m;s=r}else{r++}}else if(l.indexOf(1)===-1&&d.indexOf(1)!==-1){var m=f(c[0],c[1],d,u[0],u[1],o[0],o[1],a[0],a[1],n);if(m){h=t.slice(s,r+1);h.push(m);i.push(h);r++;s=r}else{r++}}else{var g=y(u[0],u[1],c[0],c[1],o[0],o[1],a[0],a[1],n);if(g){h=t.slice(s,r+1);if(h[h.length-1][0]!==g[0][0]||h[h.length-1][1]!==g[0][1]){h.push(g[0])}if(h.length>1)i.push(h);t[r]=g[1];if(t[r+1]&&t[r+1][0]==g[1][0]&&t[r+1][1]==g[1][1])r++;s=r}else{r++}}}if(s!==r){h=t.slice(s,t.length);if(h){i.push(h)}}};e=o({path:e});if(e.length===1){for(var l=0;l<t.length;l++){r(t[l])}t=i}else{for(var h=0;h<e.length-1;h++){for(var l=0;l<t.length;l++){a(t[l],h)}t=i;i=[]}}for(var d=0;d<t.length;d++){for(var m=0;m<t[d].length;m++){t[d][m][0]=Math.round(t[d][m][0]);t[d][m][1]=Math.round(t[d][m][1])}}return t}function e(t){if(t.path){var t=t.path}document.write("[");for(var e=0;e<t.length-1;e++){document.write("["+t[e][0]+","+t[e][1]+"],")}document.write("["+t[e][0]+","+t[e][1]+"]");document.write("]")}function n(t){document.write("[");for(var n=0;n<t.length-1;n++){e(t[n]);document.write(",<br />")}e(t[n]);document.write("]")}function i(t,e){if(t.path){var t=t.path}var n="";n+="[";for(var i=0;i<t.length-1;i++){n+="["+t[i][0]+","+t[i][1]+"],"}n+="["+t[i][0]+","+t[i][1]+"]";n+="]";if(e){console.log(n)}else{return n}}function r(t){log="";log+="[";for(var e=0;e<t.length-1;e++){log+=i(t[e],0);log+=","}log+=i(t[e],0);log+="]";console.log(log)}function o(t){if(t.path){var t=t.path}var e=[];if(t.length===1){e=t}else{pClean=0;while(pClean<t.length-1){if(t[pClean][0]!==t[pClean+1][0]||t[pClean][1]!==t[pClean+1][1]){e.push(t[pClean])}pClean++}if(t.length!==0&&e.length===0){e.push(t[0])}if(t[t.length-1][0]!==t[e.length-1][0]||t[t.length-1][1]!==t[e.length-1][1]){e.push(t[pClean])}}return e}function a(t,e,n,i){return Math.sqrt(Math.pow(n-t,2)+Math.pow(i-e,2))}function s(t,e,n,i,r){var o=a(t,e,n,i);if(o<r)return 1;else return 0}function l(t,e,n,i,r,o,a){var s=[r-n,o-i];var l=[t-n,e-i];var p=[-s[1],s[0]];var h=Math.sqrt(Math.pow(p[0],2)+Math.pow(p[1],2));var u=[p[0]/h,p[1]/h];var c=Math.sqrt(Math.pow(s[0],2)+Math.pow(s[1],2));var d=[s[0]/c,s[1]/c];var f=l[0]*d[0]+l[1]*d[1];if(f<=0||f>=c)return 0;var y=l[0]*u[0]+l[1]*u[1];if(y>=a||y<=-a)return 0;return 1}function p(t,e,n,i,r,o,a){var p=[];p.push(s(t,e,n,i,a));p.push(s(t,e,r,o,a));p.push(l(t,e,n,i,r,o,a));return p}function h(t,e,n,i,r){var o=[n-t,i-e];var a=[-o[1],o[0]];var s=Math.sqrt(Math.pow(a[0],2)+Math.pow(a[1],2));var l=[a[0]/s,a[1]/s];var p=[t+r*l[0],e+r*l[1]];var h=[t-r*l[0],e-r*l[1]];var u=[n-r*l[0],i-r*l[1]];var c=[n+r*l[0],i+r*l[1]];return[p,h,u,c]}function u(t,e,n,i,r,o,a){var s=[r-t,o-e];var l=[n-t,i-e];var p=Math.sqrt(Math.pow(l[0],2)+Math.pow(l[1],2));var h=[l[0]/p,l[1]/p];var u=s[0]*h[0]+s[1]*h[1];var c=[t+u*h[0],e+u*h[1]];var d=Math.sqrt(Math.pow(r-c[0],2)+Math.pow(o-c[1],2));var f;if(d===0){f=a}else{var f=Math.sqrt(Math.pow(a,2)-Math.pow(d,2))}var y=[t+u*h[0]+f*h[0],e+u*h[1]+f*h[1]];if(y[0]===t&&y[1]===e)return null;return y}function c(t,e,n,i,r,o,a){var s=[r-t,o-e];var l=[n-t,i-e];var p=[-l[1],l[0]];var h=Math.sqrt(Math.pow(p[0],2)+Math.pow(p[1],2));var u=[p[0]/h,p[1]/h];var c=s[0]*u[0]+s[1]*u[1];var d=v([t,e],[n,i],[r,o]);var f=m([d[0]-r,d[1]-o]);if(f>=a)return null;var y=Math.sqrt(Math.pow(a,2)-Math.pow(c,2));var g=[r-c*u[0],o-c*u[1]];var _=Math.sqrt(Math.pow(l[0],2)+Math.pow(l[1],2));var b=[l[0]/_,l[1]/_];var w=[[g[0]-b[0]*y,g[1]-b[1]*y],[g[0]+b[0]*y,g[1]+b[1]*y]];if(w[0][0]===t&&w[0][1]===e)return null;return w}function d(t,e,n,i,r,o,a,s){var l,p,h,u;l=n-t;p=i-e;h=a-r;u=s-o;var c,d;if(-h*p+l*u===0)return null;c=(-p*(t-r)+l*(e-o))/(-h*p+l*u);d=(h*(e-o)-u*(t-r))/(-h*p+l*u);if(c>=0&&c<=1&&d>=0&&d<=1){var f=t+d*l;var y=e+d*p;return[f,y]}return null}function f(t,e,n,i,r,o,s,l,p,f){var y=h(o,s,l,p,f);var m=[];if(n[0]&&!n[1]){m.push(u(t,e,i,r,o,s,f));m.push(d(t,e,i,r,y[0][0],y[0][1],y[3][0],y[3][1]));m.push(d(t,e,i,r,y[1][0],y[1][1],y[2][0],y[2][1]));var g=c(t,e,i,r,l,p,f);if(g)m.push(g[0],g[1])}else if(!n[0]&&n[1]){m.push(u(t,e,i,r,l,p,f));m.push(d(t,e,i,r,y[0][0],y[0][1],y[3][0],y[3][1]));m.push(d(t,e,i,r,y[1][0],y[1][1],y[2][0],y[2][1]));var g=c(t,e,i,r,o,s,f);if(g)m.push(g[0],g[1])}else if(n[0]&&n[1]){m.push(u(t,e,i,r,o,s,f));m.push(d(t,e,i,r,y[0][0],y[0][1],y[3][0],y[3][1]));m.push(d(t,e,i,r,y[1][0],y[1][1],y[2][0],y[2][1]));m.push(u(t,e,i,r,l,p,f))}else{var g=c(t,e,i,r,l,p,f);var v=c(t,e,i,r,o,s,f);if(g)m.push(g[0],g[1]);if(v)m.push(v[0],v[1]);m.push(d(t,e,i,r,y[0][0],y[0][1],y[3][0],y[3][1]));m.push(d(t,e,i,r,y[1][0],y[1][1],y[2][0],y[2][1]))}var _=[t,e];for(var b=0;b<m.length;b++){if(m[b]){if(a(m[b][0],m[b][1],i,r)<a(_[0],_[1],i,r)){_=m[b]}}}if(_[0]===t&&_[1]===e)return null;return _}function y(t,e,n,i,r,o,s,l,p){var u=h(r,o,s,l,p);var f=[];var y=c(t,e,n,i,r,o,p);if(y)f.push(y[0],y[1]);y=c(t,e,n,i,s,l,p);if(y)f.push(y[0],y[1]);f.push(d(t,e,n,i,u[0][0],u[0][1],u[3][0],u[3][1]));f.push(d(t,e,n,i,u[1][0],u[1][1],u[2][0],u[2][1]));var m=[n,i];var g=[t,e];for(var v=0;v<f.length;v++){if(f[v]){if(a(f[v][0],f[v][1],t,e)<a(m[0],m[1],t,e)){m=f[v]}}}for(var _=0;_<f.length;_++){if(f[_]){if(a(f[_][0],f[_][1],n,i)<a(g[0],g[1],n,i)){g=f[_]}}}if(m[0]===n&&m[1]===i||g[0]===t&&g[1]===e)return null;else return[m,g]}var m=function(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1])};var g=1e-6;var v=function(t,e,n){var i=[e[0]-t[0],e[1]-t[1]],r=m(i);if(r<g)return t;var o=[n[0]-t[0],n[1]-t[1]];var a=(i[0]*o[0]+i[1]*o[1])/r;if(a<0)return t;if(a>r)return e;return[t[0]+i[0]*a/r,t[1]+i[1]*a/r]};if(typeof exports!="undefined"){exports.erase=t}return t}();gm_hwr_request=function(){var t=function(t){var e={type:"stroke",x:[],y:[]};t.points.forEach(function(t){e.x.push(t[0]);e.y.push(t[1])});return e};var e=function(e,n){url="http://dlandy.psych.indiana.edu:7031/server.js";var i={components:e.map(t),resultTypes:["LATEX"]};var r={apiKey:"c26d2755-1fda-4033-b136-4af042f3f9db",equationInput:JSON.stringify(i)};var o=$.post(url,r.equationInput);o.done(function(t){var e=t.replace(/\\/g,"\\\\");e=JSON.parse(e);n(null,e.JSON)})};return e}();gmath.ui=gmath.ui||{};gmath.ui.holdUI=function(){var t=function(t,e){this.container=d3.select("body");this.controller=t;this.view=e;this.element=null;this.pos=[0,0];this.visible=false;this.buttons=[];this.button_els=null;this.colors=d3.scale.category10();this.button_rads=null;this.inner_radius=20;this.outer_radius=80;this.init()};t.prototype.setPos=function(t){this.pos=t;this.element.style({left:t[0]+"px",top:t[1]+"px"})};t.prototype.setVisible=function(t){this.visible=t;this.element.style("display",t?null:"none")};t.prototype.init=function(){var t=this,e={stroke:"black","stroke-width":1,"stroke-linecap":"round",fill:"none"};if(gmath.array.includes(this.controller.hold_menu_options(),"derivation")){this.buttons.push({action:function(e){t.controller.inputDL(e)},icon:function(t){var e=t.append("g").attr("transform","translate(0,10)").append("g");var n=new gmath.AlgebraModel("f_x",{});var i=new gmath.AlgebraView(n,e,{font_size:"35",inactive_color:"black",interactive:false});i.init();return e},color:t.colors(0)})}if(gmath.array.includes(this.controller.hold_menu_options(),"graph")){this.buttons.push({action:function(e){var n={pos:{x:e[0],y:e[1]}};t.view.createGraph(n)},icon:function(t){var n=t.append("g").attr("transform","translate(2,0)").style("cursor","pointer");var i=n.append("g").style("opacity",.5).style("shape-rendering","crispedges");i.append("line").attr({x1:-15,y1:0,x2:15,y2:0}).style(e);i.append("line").attr({x1:0,y1:-15,x2:0,y2:15}).style(e);i.append("rect").attr({x:-15,y:-15,width:30,height:30}).style(e);n.append("line").attr({x1:-15,y1:8,x2:15,y2:-8}).style(e).style("stroke-width",1.5);return n},color:t.colors(1)})}if(gmath.array.includes(this.controller.hold_menu_options(),"textbox")){this.buttons.push({action:function(e){var n={pos:{x:e[0],y:e[1]}};t.view.createTextBox(n)},icon:function(t){var n=t.append("g");var i=n.append("g").style("opacity",.5);i.append("text").text("Aa").attr({x:0,y:10}).style("text-anchor","middle").style("font-size","30px").style(e).style("fill","black").style("pointer-events","none");return n},color:t.colors(2)})}this.button_rads=Math.PI*2/this.buttons.length;var n=this.button_rads,i=this.inner_radius,r=this.outer_radius;this.element=this.container.append("svg").style("overflow","visible").style("display","none").style("position","absolute");this.g=this.element.append("g");var o=this.element.append("defs"),a=o.append("filter").attr("id","dropShadow_holdUI");a.append("feGaussianBlur").attr("in","SourceAlpha").attr("stdDeviation",3);a.append("feOffset").attr("dx",0).attr("dy",4).attr("result","offsetblur");a.append("feComponentTransfer").append("feFuncA").attr("type","linear").attr("slope",.25);var s=a.append("feMerge");s.append("feMergeNode");s.append("feMergeNode").attr("in","SourceGraphic");this.element.attr("filter","url(#dropShadow_holdUI)");this.button_els=this.g.selectAll(".holdUI").data(this.buttons);this.button_els.enter().append("g").classed("holdUI",true).append("path").attr("d",function(t,e){var o=Math.cos(n*e)*i,a=-Math.sin(n*e)*i,s=Math.cos(n*e)*r,l=-Math.sin(n*e)*r,p=Math.cos(n*(e+1))*r,h=-Math.sin(n*(e+1))*r,u=Math.cos(n*(e+1))*i,c=-Math.sin(n*(e+1))*i;return"M"+o+","+a+"L"+s+","+l+"A"+r+","+r+" 0 0,0 "+p+","+h+"L"+u+","+c+"A"+i+","+i+" 0 0,1 "+o+","+a+"Z"}).style("fill",function(t){return t.color}).style("opacity",.8).style("cursor","pointer");this.button_els.each(function(t,e){var o=d3.select(this),a=t.icon(o);a.attr("transform",function(){var t=Math.cos(n*(e+.5))*(i+(r-i)/2),o=-Math.sin(n*(e+.5))*(i+(r-i)/2);return"translate("+t+", "+o+")"})})};t.prototype.detectHit=function(t){var e=this,n=this.button_rads,i=this.inner_radius,r=this.outer_radius,o=-1;this.button_els.each(function(a,s){var l=Math.sqrt(Math.pow(t[0]-e.pos[0],2)+Math.pow(t[1]-e.pos[1],2)),p=Math.atan2(-t[1]+e.pos[1],t[0]-e.pos[0]);if(p<0)p+=Math.PI*2;if(l>i&&l<r&&p>n*s&&p<n*(s+1))o=s});return o};t.prototype.highlight=function(t){var e=this.detectHit(t);this.button_els.each(function(t,n){var i=d3.select(this).select("path");if(e===n)i.transition().duration(30).style("fill",d3.rgb(t.color).brighter(.6));else i.transition().duration(30).style("fill",t.color)})};t.prototype.performAction=function(t,e){var n=this.detectHit(t);this.button_els.each(function(t,i){if(i===n)t.action(e)})};return t}();gmath.ui=gmath.ui||{};gmath.ui.CanvasController=function(){var t=function(t){var e=d3.dispatch("scroll","start_hwr","stop_hwr","undone","redone","hold","touch","drag","release","font_size","keyboard","entered_term","start-of-interaction","end-of-interaction");var n=gmath.uid(),i=t,r=null,o=[],a=-1,s=null,l=false,p=null,h=false,u=true,c,d=1500,f=null,y=i.paths().length,m=2,g=50,v=null,_="black",b=null,w=null,x=0,k=null,E=null,T=false,C=null,D=false,M=true,z=true,A=["derivation","textbox","graph"];var S=function(){t.on("create."+n,function(t){if(t.target_type==="derivation"||t.target_type==="graph"||t.target_type==="textbox"||t.target_type==="image"){t.target.events.on("start-of-interaction."+n,function(t){L();e["start-of-interaction"](t)});t.target.events.on("end-of-interaction."+n,function(t){e["end-of-interaction"](t)})}});if(z&&!C&&i.container()){C=new gmath.ui.holdUI(S,i)}G(t.background_event_layer(),N());G(t.foreground_event_layer(),W());t.on("mode."+n,function(t){L();if(t.mode==="draw"||t.mode==="erase"){i.display_foreground_event_layer(true);i.setActive(null)}else{i.display_foreground_event_layer(false)}});if(M&&typeof gmath.ui.Keyboard!=="undefined"&&typeof $!=="undefined"){p=gmath.ui.Keyboard();p.width(800).position("center").on("done",tt).on("cancel",et)()}i.container().on("dragover",function(){d3.event.preventDefault()}).on("drop",nt);return this};function L(){window.getSelection().removeAllRanges()}S.id=n;S.reporter=function(t){r=t;r.events.on("summary."+n,this.addInteractionSummaryToTimeline.bind(this))};S.model=function(){if(arguments.length===0)return i};S.use_keyboard=function(t){if(arguments.length===0)return M;M=t;return this};S.use_hold_menu=function(t){if(arguments.length===0)return z;if(Array.isArray(t)){S.hold_menu_options(t.filter(function(t){return A.indexOf(t)!==-1}))}z=Array.isArray(t)?true:t;if(z&&!C&&i.container()){C=new gmath.ui.holdUI(S,i)}return this};S.hold_menu_options=function(t){if(arguments.length===0)return A;A=t};S.color=function(t){if(arguments.length===0)return _;_=t;return this};S.markerRadius=function(t){if(arguments.length===0)return m;m=t;return this};S.eraserRadius=function(t){if(arguments.length===0)return g;g=t;return this};S.hwr_delay=function(t){if(arguments.length===0)return d;d=t;return this};S.tx_behavior=function(){return w};S.hwr=function(t){if(!arguments.length)return u;if(u===t)return S;u=t;y=i.paths.length;if(!u)S.cancelHWR();return S};S.drawing=function(t){if(!arguments.length)return c;c=t;return this};S.scheduleHWR=function(){if(!f){f=setTimeout(S.performHWR,d);e.start_hwr()}};S.cancelHWR=function(t){if(!t)y=i.paths.length;if(f){clearTimeout(f);f=null;e.stop_hwr()}};S.performHWR=function(){f=null;e.stop_hwr();if(y>i.paths().length-1)return;var t=i.paths().slice(y),n=false,r=[];gm_hwr_request(t,function(e,o){if(e)console.log(e);var a=t[0].points[0];try{n=i.createDL({pos:a,eq:o})}catch(s){return}var l=function(t){try{i.removePath(t);r.push(t)}catch(e){return}};for(var p=0;p<t.length;p++){l(t[p])}y=i.paths().length});y=i.paths().length};S.scroll=function(t){if(arguments.length===0)return x;x=Math.min(0,t);w.transform({translate:[0,x]});i.paths_container().attr("transform","translate(0,"+x+")");i.dls_container().attr("transform","translate(0,"+x+")");e.scroll(x);return this};S.font_smaller=function(){var t=parseInt(DerivationList.defaultOptions.font_size);if(t/1.2>12)this.set_font_size(t/1.2)};S.font_larger=function(){var t=parseInt(DerivationList.defaultOptions.font_size);if(t*1.2<160)this.set_font_size(t*1.2)};S.set_font_size=function(t){DerivationList.defaultOptions.font_size=t;i.dls().forEach(function(e){e.options.font_size=t;e.rows.forEach(function(e){e.view.options.font_size=t;e.view.update_all(true);e.updateHandlePos(true)});e.hideAllNodeMappings();e.layoutRows()});e.font_size(new F(t))};var q=function(t){return i.createPath({points:[[t[0],t[1]-x]],color:i.setMode()==="draw"?_:"white",width:i.setMode()==="draw"?2*m:2*g})};var I=function(t){this.type="hold";this.subType=t.subType;this.performee=n;this.performee_type="CanvasController";this.time=Date.now();this.finger={pos:[t.finger.pos[0],t.finger.pos[1]]};this.fingers=t.fingers.map(function(t){return{pos:[t.pos[0],t.pos[1]]}})};var P=function(t){this.type="touch";this.subType=t.subType;this.performee=n;this.performee_type="CanvasController";this.time=Date.now();this.finger={pos:[t.finger.pos[0],t.finger.pos[1]],pos0:[t.finger.pos0[0],t.finger.pos0[1]]};this.fingers=t.fingers.map(function(t){return{pos:[t.pos[0],t.pos[1]]}})};var B=function(t){this.type="drag";this.subType=t.subType;this.performee=n;this.performee_type="CanvasController";this.time=Date.now();this.finger={pos:[t.finger.pos[0],t.finger.pos[1]]};this.fingers=t.fingers.map(function(t){return{pos:[t.pos[0],t.pos[1]]}})};var O=function(t){this.type="release";this.subType=t.subType;this.performee=n;this.performee_type="CanvasController";this.time=Date.now();this.finger={pos:[t.finger.pos[0],t.finger.pos[1]]};this.fingers=t.fingers.map(function(t){return{pos:[t.pos[0],t.pos[1]]}})};var F=function(t){this.type="fontSize";this.performee=n;this.performee_type="CanvasController";this.time=Date.now();this.font_size=t};var R=function(t){this.type="enteredTerm";this.performee=n;this.performee_type="CanvasController";this.time=Date.now();this.eq=t.eq;this.dl_id=t.id;this.options=gmath.deepCopy(t)};var j=function(t){this.type="enteredGraph";this.performee=n;this.performee_type="CanvasController";this.time=Date.now();this.graph_id=t};var H=function(){this.type="keyboard";this.performee=n;this.performee_type="CanvasController";this.time=Date.now()};function G(t,e){t.call(e);e.frame(t.node())}function N(){var t=transform_behavior().allow_rotate(false).allow_scale(false).one_finger_drag(false).on("transform",function(){scroll(d3.event.transform.translate[1])});var e=mtouch_events().on("touch",U.bind(this,null)).on("hold",V.bind(this,null)).on("drag",K.bind(this,null)).on("tap",function(){i.setActive(null)}).on("release",J.bind(this,null)).hold_max_dist(5).hold_time(500).call(t);return e}function W(){var t=transform_behavior().allow_rotate(false).allow_scale(false).one_finger_drag(false).on("transform",function(){scroll(d3.event.transform.translate[1])});var e=mtouch_events().on("touch",Z.bind(this,null)).on("drag",Q.bind(this,null)).on("release",X.bind(this,null)).hold_max_dist(5).hold_time(500).call(t);return e}var U=function(t){if(!z||T)return;var i=t||d3.event;if(!t&&d3.event){L();e["start-of-interaction"]({type:"start-of-interaction",source:{type:"CanvasController",id:n},time:Date.now()});e.touch(new P(gmath.extend(d3.event,{subType:"menu"})))}if(i.fingers.length>1){T=true}};S.menu_touch=U;var V=function(t){if(!z||T||M&&p.visible())return;var n=t||d3.event;if(!t&&d3.event){e.hold(new I(gmath.extend(d3.event,{subType:"menu"})))}menu_pos=n.finger.pos.slice();C.setPos(n.finger.pos_client.slice());C.setVisible(true)};S.menu_hold=V;var K=function(t){if(!z||T)return;var n=t||d3.event;if(!t&&d3.event){e.drag(new B(gmath.extend(d3.event,{subType:"menu"})))}if(C.visible){C.highlight(n.finger.pos_client.slice())}};S.menu_drag=K;var J=function(t){var i=t||d3.event;if(!t&&d3.event){e.release(new O(gmath.extend(d3.event,{subType:"menu"})))}if(T){if(i.fingers.length===0)T=false;return}if(C&&C.visible){C.performAction(i.finger.pos_client.slice(),menu_pos);C.setVisible(false)}if(!t&&d3.event&&(!p||!p.visible())){e["end-of-interaction"]({type:"end-of-interaction",source:{type:"CanvasController",id:n},time:Date.now()})}};S.menu_release=J;var Z=function(t){var r=t||d3.event;if(!t&&d3.event){e["start-of-interaction"]({type:"start-of-interaction",source:{type:"CanvasController",id:n},time:Date.now()});e.touch(new P(gmath.extend(d3.event,{subType:"draw"})))}if(r.fingers.length>1){T=true}if(!c||T)return;var o=r.finger.pos0.slice();o[1]-=x;S.cancelHWR(true);k=q(r.finger.pos0);if(i.setMode()==="erase"){v=i.paths_container().append("circle").attr({cx:o[0],cy:o[1],r:g}).style({stroke:"silver",fill:"white"})}};S.draw_touch=Z;var Q=function(t){var n=t||d3.event;if(!t&&d3.event){e.drag(new B(gmath.extend(d3.event,{subType:"draw"})))}if(!k||T||!c)return;var r=n.finger.pos.slice();r[1]-=x;k.points.push(r);i.updatePath(k);if(i.setMode()==="erase")v.attr({cx:r[0],cy:r[1]})};S.draw_drag=Q;var X=function(t){var r=t||d3.event;if(!t&&d3.event){e.release(new O(gmath.extend(d3.event,{subType:"draw"})))}if(T){if(r.fingers.length===0)T=false;return}if(!k)return;if(i.setMode()==="draw"){if(u&&(!p||!p.visible()))S.scheduleHWR()}else if(i.setMode()==="erase"){v.remove();Y()}k=null;if(!t&&d3.event){e["end-of-interaction"]({type:"end-of-interaction",source:{type:"CanvasController",id:n},time:Date.now()})}};S.draw_release=X;var Y=function(){var t=i.paths().slice(),e=t[t.length-1],n=[],r=[],o=[];t.forEach(function(t,a){if(t===e)return;var s=g+t.width/2;var l=gm_erase_paths([t.points],e.points,s);if(l.length===0){r.push(t);i.removePath(t)}else{o.push({path:t,points_before:t.points.slice(),points_after:l[0].slice()});t.points=l[0];i.updatePath(t);for(var p=1;p<l.length;p++){var h=i.createPath({points:l[p],color:t.color,width:t.width,oid:t.id});n.push(h)}}});i.removePath(e);eraseModification={removed:r,modified:o,added:n}};S.addInteractionSummaryToTimeline=function(t){var e=Timeline.entry(t,i);if(e){if(e.type==="erase"){e.modification=eraseModification;eraseModification=null}a++;o[a]=e;o.length=a+1}};S.undo=function(){if(a===-1)return false;r.setListening(false);var t=o[a];a--;t.undo(i,this);r.setListening(true);return true};S.redo=function(){if(o.length<=a+1)return false;r.setListening(false);a++;var t=o[a];t.redo(i,this);r.setListening(true);return true};S.clearInteractionTimeline=function(){a=-1;o=[]};S.clear_undo_queue=function(){throw"(CanvasController) Deprecated method `clear_undo_queue` called."};S.inputDL=function(t){if(h)return;e.keyboard(new H);S.cancelHWR(true);E={pos:{x:t[0],y:t[1]-x},v_align:"center",h_align:"equals"};p.caption(null).latex("").visible(true)};var tt=function(t){if(!E)return;if(t===""){p.visible(false);return}E.eq=t;E.id=gmath.uid();e.entered_term(new R(E));var r;var o=false;try{r=i.createDL(E);E=null}catch(a){console.log(a);p.warning("Could not parse expression.");return}p.visible(false);e["end-of-interaction"]({type:"end-of-interaction",source:{type:"CanvasController",id:n},time:Date.now()})};var et=function(){p.visible(false);e["end-of-interaction"]({type:"end-of-interaction",source:{type:"CanvasController",id:n},time:Date.now()})};S.disableKeyboard=function(t){h=t};S.simulateStartOfInteraction=function(){e["start-of-interaction"]({type:"start-of-interaction",source:{type:"CanvasController",id:n},time:Date.now()})};S.simulateEndOfInteraction=function(){e["end-of-interaction"]({type:"end-of-interaction",source:{type:"CanvasController",id:n},time:Date.now()})};function nt(){var t=d3.event;t.preventDefault();var r=d3.mouse(this);var o=it(t.dataTransfer)||rt(t.dataTransfer);if(!o){console.log("could not parse drop data",t);var a={drop_evt:t,pos:{x:r[0],y:r[1]}};var s=i.createImage(a,"drag-n-drop");return}if(o.slice(0,4)==="http"){var a={drop_evt:t,pos:{x:r[0],y:r[1]}};var s=i.createImage(a,"drag-n-drop")}else{o=o.replace(/\\end{alignat}/g,"");o=o.replace(/\&\\\,/g,"");o=o.replace(/\\\,/g,"");o=o.replace(/\&/g,"");o=o.replace(/\\begin{alignat}{[0-9]*}/g,"");o=o.replace(/\\\;/g,"");o=o.replace(/[.,\s\\]+$/,"");var l=o.split("\\\\");if(o.length===0)return;try{e["start-of-interaction"]({type:"start-of-interaction",source:{type:"CanvasController",id:n},time:Date.now()});i.createDLs(l,{pos:r,collapsed_mode:l.length>1},null,"drag-n-drop");e["end-of-interaction"]({type:"end-of-interaction",source:{type:"CanvasController",id:n},time:Date.now()})}catch(p){console.log("Could not parse equation!",p);var a={drop_evt:t,pos:{x:r[0],y:r[1]}};var s=i.createImage(a,"drag-n-drop")}}}function it(t){var e=t.getData("text/html");var n=document.createElement("div");var i=d3.select(n).html(e).select("img");return i.size()===1?i.attr("alt"):null}function rt(t){return t.getData("text/plain")}return d3.rebind(S,e,"on")};return t}();gmath.ui=gmath.ui||{};gmath.ui.CanvasModelView=function(){var t=function(){var t=d3.dispatch("create","update","remove","reset","mode"),e=null,n,i,r,o,a,s,l,p,h,u=[],c=[],d=[],f=[],y=["edit","inspect","arrange","draw","erase"],m=0;function g(t){t.dl.draw_mappings_for_nodes([t.node])}var v=function(t){e=t;i=e.append("div").style({position:"absolute",left:0,right:0,top:0,bottom:0}).style({overflow:"hidden"});p=i.append("div").style({position:"absolute",left:0,right:0,top:0,bottom:0});n=i.append("svg").style({position:"absolute",width:"100%",height:"100%"}).style("pointer-events","none");a=n.append("g").attr("id","g_graphs");o=n.append("g").attr("id","g_paths");g_imgs=n.append("g").attr("id","g_imgs");s=n.append("g").attr("id","g_textboxes");r=n.append("g").attr("id","g_dls");h=e.append("div").style({position:"absolute",left:0,right:0,top:0,bottom:0}).style({display:"none","pointer-events":"all"});return this};v.setActive=function(t,e){if(arguments.length<2)e=true;if(t)t.setActive(e);u.forEach(function(e){if(e!==t){e.setActive(false);if(e.type==="textbox")e.text_element.node().blur()}})};v.focusOnDL=function(t){t.events.on("end-of-interaction."+this.id,t.initPosition.bind(t,true))};v.createDL=function(e,n,i){var r=new DerivationList(v,this.getContainer("derivation").node(),e,function(t){if(n)setTimeout(n.bind(null,t),1)});r.setMode(y[m]);r.events.on("inspect_node",g);u.push(r);d3.selectAll(".derivation-list").data(v.dls());var o={type:"create",target_type:"derivation",target:r};if(i)o.method=i;t.create(o);return r};function _(t){if(t==="canvas-element")return gmath.CanvasElementClass;if(t==="image")return gmath.ui.CanvasImage;if(t==="textbox")return gmath.ui.CanvasTextBox;if(t==="graph")return gmath.ui.Graph;if(t==="derivation")return gmath.DerivationList;if(t==="ggb-panel")return gmath.ui.GeoGebraPanel;if(t==="ggb-element")return gmath.ui.GeoGebraCanvasElement;throw'unkown element type "'+t+'"'}v.getContainer=function(t){if(t==="canvas-element")return i;if(t==="image")return i;if(t==="textbox")return i;if(t==="graph")return a;if(t==="derivation")return i;if(t==="ggb-panel")return i;if(t==="ggb-element")return i;throw'unkown element type "'+t+'"'};v.createElement=function(e,n,i,r){var o=v.getContainer(e);var a=_(e);var s=new a(v,o.node(),n,function(){if(r)setTimeout(r.bind(null,s),1)});u.push(s);t.create({type:"create",target_type:e,target:s,method:i});return s};v.createImage=function(e,n){var i=new gmath.ui.CanvasImage(v,this.getContainer("image").node(),e);u.push(i);t.create({type:"create",target_type:"image",target:i,method:n});return i};v.createTextBox=function(e,n,i){var r=new gmath.ui.TextBox(v,this.getContainer("textbox").node(),e,n);u.push(r);t.create({type:"create",target_type:"textbox",target:r,method:i});return r};v.addElement=function(e){if(e in u)throw"element is already part of this canvas";b(f,e);e.canvas_model=v;e.initElement(v.getContainer(e.type).node());e.setMode(y[m]);u.push(e);t.create({type:"create",target_type:e.type,target:e});return v};v.addDL=function(e){b(f,e);if(u.indexOf(e)!==-1)throw"dl is already in this model";e.canvas_model=v;e.initElement(r.node());e.setMode(y[m]);e.events.on("inspect_node",g);v.setActive(e);u.push(e);d3.selectAll(".derivation-list").data(v.dls());t.create({type:"create",target_type:"derivation",target:e});return e};v.addImage=function(e){b(f,e);e.canvas_model=v;e.initElement(g_imgs.node());e.setMode(y[m]);u.push(e);t.create({type:"create",target_type:"image",target:e})};v.addTextBox=function(e){b(f,image);e.canvas_model=v;e.initElement(s.node());e.setMode(y[m]);u.push(e);t.create({type:"create",target_type:"textbox",target:e});return e};v.createDLs=function(t,e,n,i){var r=0;o();function o(a){if(r===t.length){if(n)n()}else{if(a)e.pos[1]+=a.dims.height;var s=gmath.deepCopy(e);s.eq=t[r++];v.createDL(s,o,i)}}};v.isInFreeVisibleSpace=function(t,e){var n=this.viewport();if(t.y<n.y||t.y+t.height>n.y+n.height)return false;return this.getIntersectingElements(t,e).length===0};v.getIntersectingElements=function(t,e){return u.filter(function(n){if(e===n)return false;return gmath.HitTester.overlaps(t,n.getBBox())})};v.moveToFreeSpace=function(t,e){var n=t.getBBox(),i=this.viewport(),r={x:i.x,y:i.y,width:n.width,height:n.height},o;while(r.y+r.height<i.y+i.height){while(r.x+r.width<i.x+i.width){o=this.getIntersectingElements(r,t);if(o.length===0){t.translateElement(r,e);return true}else{var a=d3.max(o,function(t){return t.pos.x+t.size.width});r.x=a+1}}r.x=i.x;r.y=r.y+i.height/20}return false};v.createPath=function(e,n){var i=new gmath.ui.Path(o.node(),e);c.push(i);var r={type:"create",target_type:"path",target:i};if(n)r.method=n;t.create(r);return i};v.removePath=function(e){b(c,e);e.remove();t.remove({type:"remove",target_type:"path",target:e})};v.addPath=function(e){if(c.indexOf(e)!==-1)throw"path is already in this model";e.setContainer(o);e.init();c.push(e);t.create({type:"create",target_type:"path",target:e});return e};v.updatePath=function(e){e.update();t.update({target_type:"path",target:e})};v.createGraph=function(e){e.view=v;var n=new gmath.ui.Graph(a.node(),e);d.push(n);t.create({type:"create",target_type:"graph",target:n});return n};v.removeGraph=function(e){b(d,e);e.remove();t.remove({type:"remove",target_type:"graph",target:e})};v.removeElement=function(e){b(u,e);f.push(e);var n=e.removeElement();t.remove({type:"remove",target_type:e.type,target:e});return n};var b=function(t,e){if(t.length===0)return false;var n=t.indexOf(e);if(n===-1)return false;t.splice(n,1);return true};v.elements=function(){return u};v.dls=function(){return v.getElementsOfType("derivation")};v.graphs=function(){return d};v.textboxes=function(){return v.getElementsOfType("textbox")};v.images=function(){return v.getElementsOfType("image")};v.getElementsOfType=function(t){return u.filter(function(e){return e.type===t})};v.getElementByID=function(t){for(var e=0;e<u.length;e++)if(u[e].id===t)return u[e];for(var e=0;e<c.length;e++)if(c[e].id===t)return c[e]};v.getDeletedElementByID=function(t){for(var e=0;e<f.length;e++)if(f[e].id===t)return f[e]};v.paths=function(e){if(!arguments.length)return c;for(var n=0;n<c.length;n++)c[n].remove();c=e.slice();for(var n=0;n<c.length;n++){c[n].setContainer(o);c[n].init()}t.reset({target_type:"path",target:c.slice()})};v.container=function(){return e};v.background_event_layer=function(t){return p};v.foreground_event_layer=function(t){return h};v.display_foreground_event_layer=function(t){if(!arguments.length||t)h.style({display:null});else h.style({display:"none"})};v.dls_container=function(t){if(!arguments.length)return r;r=t;return this};v.paths_container=function(t){if(!arguments.length)return o;o=t;return this};v.graphs_container=function(t){if(!arguments.length)return a;a=t;return this};v.textboxes_container=function(t){if(!arguments.length)return s;s=t;return this};v.size=function(){var t=e.node().getBoundingClientRect();return{width:t.width-0,height:t.height}};v.viewport=function(){var t=e.node().parentNode;return{x:0,width:t.clientWidth,y:t.scrollTop,
height:t.clientHeight}};v.setMode=function(e){if(arguments.length===0)return y[m];m=y.indexOf(e);u.forEach(function(t){t.setMode(e)});t.mode({type:"mode",mode:e});return this};return d3.rebind(v,t,"on")};return t}();gmath.ui=gmath.ui||{};gmath.ui.CanvasFactory=function(){var t=function(e,n,i){this.id=gmath.uid();this.container=d3.select(e);n=n||{};this.options=gmath.object.merged(gmath.deepCopy(!n.minimal?t.defaultOptions:t.minimalOptions),n);if(gmath.log_ga)gmath.log_ga.enabled(this.options.ga_tracking);this.events=d3.dispatch("button");this.model=gmath.ui.CanvasModelView();this.controller=gmath.ui.CanvasController(this.model).drawing(this.options.drawing).hwr(this.options.hwr).use_keyboard(this.options.use_keyboard).use_hold_menu(this.options.use_hold_menu);this.init();if(this.options.overflow_visible){this.scroll_div.style("overflow","visible");this.content_div.style("overflow","visible")}if(i&&this.options.loads_url){this.remove();gmath.CanvasSaver.loadSaveFile(this.container.node(),this.options.loads_url,i)}else if(this.options.parse_url_query_params){this.parseURLQueryParams()}this.reporter=new CanvasEventReporter(this,this.options.reporter_options);this.controller.reporter(this.reporter)};gmath.ui.CanvasFactoryClass=t;t.prototype.serialize=function(){return JSON.stringify(this.model.dls().concat(this.model.graphs()))};t.prototype.init=function(){this.outer_div=this.container.append("div").style({width:this.options.width,height:this.options.height});this.options.toolbar_container=this.options.toolbar_container?d3.select(this.options.toolbar_container):this.outer_div;var t=this;this.tools=this.options.toolbar_container.append("div").attr({"class":"btn-toolbar",role:"toolbar"}).style(this.options.use_toolbar?this.options.toolbar_on_style:this.options.toolbar_off_style);if(this.options.minimal)this.tools.on("mouseenter",function(){if(t.toolFadeoutTimer)clearTimeout(t.toolFadeoutTimer)}).on("mouseleave",this.switchToolbarState.bind(this));if(this.options.drawing){this.options.mode_btns.splice(3,0,{type:"radio",group:"draw",state:false,label:"draw",icon:"glyphicon glyphicon-pencil"},{type:"radio",group:"draw",state:false,label:"erase",icon:"glyphicon glyphicon-erase"})}if(this.options.mode_btns)this.appendButtonGroup(this.options.mode_btns,this.onButton);if(this.options.reset_btn)this.appendButtonGroup([this.options.reset_btn],this.onButton);if(this.options.undo_btn||this.options.redo_btn){var e=[];if(this.options.undo_btn)e.push(this.options.undo_btn);if(this.options.redo_btn)e.push(this.options.redo_btn);this.appendButtonGroup(e,this.onButton)}if(this.options.font_smaller_btn&&this.options.font_larger_btn){var n=[];n.push(this.options.font_smaller_btn);n.push(this.options.font_larger_btn);this.appendButtonGroup(n,this.onButton)}if(this.options.help_btn){if(this.options.minimal)this.options.help_btn.pull_right=false;var i=[];i.push(this.options.help_btn);this.appendButtonGroup(i,this.onButton)}if(this.options.saving_and_loading){if(this.options.save_btn&&this.options.load_btn&&this.options.share_btn)this.appendButtonGroup([this.options.save_btn,this.options.load_btn,this.options.share_btn],this.onButton);else if(this.options.save_btn&&this.options.load_btn)this.appendButtonGroup([this.options.save_btn,this.options.load_btn],this.onButton)}if(this.options.feedback&&this.options.feedback_btn){this.appendButtonGroup([this.options.feedback_btn],this.onButton)}if(this.options.minimal){this.tools.classed("btn-toolbar-minimal",true);var r=this.tools.append("div").attr("class","btn-group pull-right").style({"line-height":"26px","margin-left":"40px"});r.append("span").text("powered by").style({"font-style":"italic","font-family":"sans-serif",color:"#909090","font-weight":300,"font-size":"13px"});var o=r.append("a").style({"text-decoration":"none"}).attr({href:"http://graspablemath.com",target:"_blank"});o.append("img").attr({alt:"GM",src:this.options.logo_src}).style({"vertical-align":"-0.3em",height:"1.7em","margin-left":"0.8em","margin-right":"0.2em","font-size":"13px"})}var a=this.tools.node().getBoundingClientRect().height;if(a===0&&this.options.use_toolbar)a={xs:46,sm:64}[this.options.btn_size]||72;this.scroll_div=this.options.toolbar_pos==="top"?this.outer_div.append("div"):this.outer_div.insert("div","div.btn-toolbar");this.scroll_div.classed("gm-canvas",true).style("width",this.options.width).style("height","calc("+this.options.height+" - "+(a+10)+"px)").style("overflow-y",this.options.vertical_scroll?"scroll":"hidden");this.content_div=this.scroll_div.append("div").style("height",this.options.vertical_scroll?"200%":"100%").style("position","relative").call(this.model);this.controller();if(this.options.vertical_scroll)this.scroll_div.on("scroll",this.adjustCanvasSize.bind(this));if(this.options.minimal&&this.options.static_toolbar)this.switchToolbarState(true)};t.prototype.showHint=function(t,e){var n=this.model;if(n.dls().length>0&&!this.options.always_show_initial_hint)return;var i={pos:{x:-1e3,y:-1e3},size:{width:220,height:0},text:t,closable:true,uneditable:true,static_bg:true,text_align:"center",dont_log_events:true,font_size:16,resizable:false};var r=n.createTextBox(i,function(t){var e=n.viewport();t.translateElement({x:e.x+e.width/2-t.size.width/2,y:e.y+e.height/2-t.size.height/2})});if(e){n.on("create.gm-inital-hint",function(){if(n.textboxes().indexOf(r)>=0)r.fade();n.on("create.gm-initial-hint",null)})}};t.prototype.parseURLQueryParams=function(){var t=gmath.getURLParameter("eq");if(t){t=t.split(";");this.controller.simulateStartOfInteraction();for(var e=0;e<t.length;e++){this.model.createDL({eq:t[e],pos:{x:200+350*e,y:100}},null,"URL")}this.controller.simulateEndOfInteraction()}};t.prototype.adjustCanvasSize=function(){var t=this.scroll_div.node().getBoundingClientRect().height;var e=this.content_div.node().getBoundingClientRect().height;var n=this.scroll_div.property("scrollTop");if(!this.scroll_top)this.scroll_top=n;if(n>this.scroll_top){if(e-n<t){var i=Math.round(e/t)+1;this.content_div.style("height",t*i+"px")}}else if(n<this.scroll_top){if(e-n>=2*t&&this.noObjectsHiddenBelowView(n)){var i=Math.round(e/t)-1;this.content_div.style("height",t*i+"px")}}this.scroll_top=n};t.prototype.noObjectsHiddenBelowView=function(t){var e=[];e=this.model.dls().concat(this.model.graphs()).concat(this.model.textboxes()).concat(this.model.paths());if(e.length===0)return true;for(var n=0;n<e.length;n++){var i=e[n];if(i.pos){if(Array.isArray(i.pos)&&i.pos[1]>t)return false;else if(i.pos.y>t)return false}else if(i.points&&i.points[0][1]>t)return false}return true};t.prototype.switchToolbarState=function(t,e){if(!this.options.use_toolbar)return;var n=this;if(t){n.turnOnToolbar()}else{if(e)n.turnOffToolbar();else{n.toolFadeoutTimer=setTimeout(function(){n.turnOffToolbar()},n.options.toolFadeoutDelay)}}};t.prototype.turnOnToolbar=function(){if(this.toolFadeoutTimer){clearTimeout(this.toolFadeoutTimer);this.toolFadeoutTimer=null}this.tools.style(this.options.toolbar_on_style);this.toolbarOn=true};t.prototype.turnOffToolbar=function(){if(this.toolFadeoutTimer){clearTimeout(this.toolFadeoutTimer);this.toolFadeoutTimer=null}this.tools.style(this.options.toolbar_off_style);this.toolbarOn=false};t.prototype.resize=function(t){this.options.width=t.width;this.options.height=t.height;this.scroll_div.style({width:this.options.width,height:this.options.height});this.tools.style({width:this.options.width})};t.prototype.onButton=function(t){var e={mode:this.model.setMode()==="inspect"?"scrub":this.model.setMode(),font_size:DerivationList.defaultOptions.font_size};this.updateButton(t);if(t.label==="reset"){if(this.reporter.containsPendingEvents(this.reporter.interactionSequence)){this.reporter.submitCurrentSequence()}if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","reset",1);while(this.controller.undo()){}}if(t.label==="undo"){if(this.reporter.containsPendingEvents(this.reporter.interactionSequence)){this.reporter.submitCurrentSequence()}this.controller.undo();if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","undo",1)}if(t.label==="redo"){if(this.reporter.containsPendingEvents(this.reporter.interactionSequence)){this.reporter.submitCurrentSequence()}if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","redo",1);this.controller.redo()}if(t.label==="HWR"){if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","hwr",1);this.controller.hwr(t.state)}if(t.label==="transform"){if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","transform",1);this.model.setMode("edit")}if(t.label==="scrub"){if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","scrub",1);this.model.setMode("inspect")}if(t.label==="arrange"){if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","arrange",1);this.model.setMode("arrange")}if(t.label==="draw"){if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","draw",1);this.model.setMode("draw")}if(t.label==="erase"){if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","erase",1);this.model.setMode("erase")}if(t.label==="help"){if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","help",1);this.help()}if(t.label==="feedback"){if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","feedback",1);this.sendFeedback()}if(t.label==="fullscreen"&&t.state===true){if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","start fullscreen",1);this.launchFullScreen()}if(t.label==="fullscreen"&&t.state===false){if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","stop fullscreen",1);this.cancelFullScreen()}if(!(t.label==="HWR"&&t.state===true)&&this.options.hwr===true){if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","cancel HWR",1);this.controller.cancelHWR()}if(t.label==="larger"){if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","font larger",1);this.controller.font_larger()}if(t.label==="smaller"){if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","font smaller",1);this.controller.font_smaller()}if(t.label==="save"){gmath.CanvasSaver.save(this);if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","save",1)}if(t.label==="load"){this.remove();gmath.CanvasSaver.load(this.outer_div.node());if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","load",1)}if(t.label==="share"&&!this.publishing){this.publishConfirmation();if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","publish",1)}var n={button:{label:t.label,state:t.state,type:t.type},old_state:e,time:Date.now()};if(n.button.label==="larger"||n.button.label==="smaller")n.button.font_size=DerivationList.defaultOptions.font_size;this.events.button(n)};t.prototype.showSaveError=function(t){var e=d3.select("#publish-share-panel"),n=e.select("div");n.classed("alert-danger",true);e.classed("panel-default",false).classed("panel-danger",true);var i=this;n.selectAll("p").remove();n.append("p").html("Sorry, we could not share the canvas.</br>Reason: "+t);if(t.indexOf("too big")===-1){n.append("p").text("Please save your work locally and try again later. Make sure you are connected to the internet!")}else{n.append("p").text("We currently don't support uploading this much data. Please save your work locally instead.")}n.append("button").property("type","button").classed("btn btn-default",true).text("Ok").on("click",function(){e.remove();i.publishing=false})};t.prototype.publishConfirmation=function(){this.publishing=true;var t=this;var e=this.scroll_div.append("div").classed("panel panel-default",true).attr("id","publish-share-panel").style({width:"500px",position:"absolute",right:"20px",top:"20px"});var n=e.append("div").classed("panel-body",true);n.append("h3").text("Share your math!");n.append("p").text('Click the "Publish" button to save your work on the Graspable Math server.'+"  We'll give you a key so you or anyone else can get a copy.");n.append("button").property("type","button").classed("btn btn-default",true).classed("pull-right",true).text("Cancel").on("click",function(){e.remove();t.publishing=false});n.append("button").property("type","button").classed("btn btn-primary",true).text("Publish").on("click",function(){n.remove();n=e.append("div").classed("panel-body",true);n.append("p").text("Working...");gmath.CanvasSaver.share(t.options.saves_url,t,function(e,n){if(e)t.showSaveError(e.reason);else t.noSaveError(n)})})};t.prototype.noSaveError=function(t){var e=d3.select("#publish-share-panel"),n=e.select("div");var i=this;n.selectAll("p").remove();n.append("h3").text("Here is your link:");n.append("div").classed("share_link",true).append("input").attr({type:"text"}).on("click",function(){this.select();this.setSelectionRange(0,this.value.length)}).on("input",function(){this.value=location.origin+location.pathname+"?load="+t;this.select();this.setSelectionRange(0,this.value.length)}).node().value=location.origin+location.pathname+"?load="+t;n.append("p").text("Keep this link for yourself or share it with others. It will always "+"point to the canvas as it is right now. Click the share button again if you "+"want to create a new link to an updated version.");n.append("button").property("type","button").classed("btn btn-primary",true).text("Done").on("click",function(){e.remove();i.publishing=false})};t.prototype.launchFullScreen=function(t){t=t||document.body;if(t.requestFullscreen)t.requestFullscreen();else if(t.mozRequestFullScreen)t.mozRequestFullScreen();else if(t.webkitRequestFullscreen)t.webkitRequestFullscreen();else if(t.msRequestFullscreen)t.msRequestFullscreen()};t.prototype.help=function(){var t=window.open("http://graspablemath.com/unstable/tutorial/index.html","_blank");t.focus()};t.prototype.sendFeedback=function(){var t=window.open("mailto:contact@graspablemath.com","_blank");t.focus()};t.prototype.cancelFullScreen=function(){if(document.exitFullscreen)document.exitFullscreen();else if(document.mozCancelFullScreen)document.mozCancelFullScreen();else if(document.webkitExitFullscreen)document.webkitExitFullscreen();else if(document.msExitFullscreen)document.msExitFullscreen()};t.prototype.updateButton=function(t){this.tools.select("button#"+t.label).datum(t).each(function(t){if(t.type==="toggle"){t.state=!t.state;d3.select(this).classed("active",t.state)}else if(t.type==="radio"){var e=this;d3.select(this.parentNode).selectAll("button").each(function(t){t.state=e===this}).classed("active",function(t){return t.state})}})};t.prototype.appendButtonElement=function(t,e){var n=this;var i=t.append("button").attr("id",function(t){return t.label}).attr({type:"button","class":"btn btn-default"}).classed("btn-xs",n.options.btn_size==="xs").classed("btn-sm",n.options.btn_size==="sm").classed("active",function(t){return t.state}).style("min-width","4em");if(e)i.call(mtouch_events().on("touch",e.bind(this)));if(this.options.display_icons){var r=i.filter(function(t){return t.icon});r.append("i").attr("class",function(t){return t.icon}).style({color:"#555","font-size":"1.2em","line-height":"1.7em"}).style("transform",function(t){return t.flip==="x"?"rotateX(180deg)":t.flip==="y"?"rotateY(180deg)":t.flip==="xy"?"rotateZ(180deg)":null});r.append("br")}if(this.options.display_labels){i.append("span").text(function(t){return t.label}).style("color","#555")}};t.prototype.appendButtonGroup=function(t,e){var n=this.tools.append("div").attr({"class":"btn-group",role:t[0].group}).classed("pull-right",t[0].pull_right).selectAll("button").data(t);n.enter().call(this.appendButtonElement.bind(this),e);return n};t.prototype.remove=function(){this.tools.remove();this.scroll_div.remove()};t.minimalOptions={width:"100%",height:"100%",vertical_scroll:false,toolbar_pos:"top",static_toolbar:true,undo_btn:{type:"push",label:"undo",icon:"glyphicon glyphicon-chevron-left"},redo_btn:{type:"push",label:"redo",icon:"glyphicon glyphicon-chevron-right"},use_keyboard:false,use_hold_menu:false,drawing:false,display_icons:true,display_labels:false,btn_size:"xs",toolbar_on_style:{display:"inline-block",position:"absolute","margin-top":"-35px",padding:"5px","padding-right":"10px",background:"rgba(255, 255, 255, 0.901961)","border-radius":"3px"},toolbar_off_style:{display:"none"},toolFadeoutDelay:500,logo_src:"../shared/imgs/gm-logo.png",overflow_visible:true};t.defaultOptions={width:"100%",height:"100%",vertical_scroll:true,parse_url_query_params:false,toolbar_pos:"top",undo_btn:{type:"push",label:"undo",icon:"glyphicon glyphicon-chevron-left"},redo_btn:{type:"push",label:"redo",icon:"glyphicon glyphicon-chevron-right"},font_smaller_btn:{type:"push",label:"smaller",icon:"glyphicon glyphicon-text-size",flip:"y"},font_larger_btn:{type:"push",label:"larger",icon:"glyphicon glyphicon-text-size"},help_btn:{type:"push",label:"help",pull_right:true,icon:"glyphicon glyphicon-question-sign"},hwr_btn:{type:"toggle",label:"HWR",pull_right:true,state:true,icon:"glyphicon glyphicon-font"},fullscreen_btn:{type:"toggle",label:"fullscreen",pull_right:true,state:false,icon:"glyphicon glyphicon-resize-full"},hwr:false,feedback_btn:{type:"push",label:"feedback",pull_right:true,icon:"glyphicon glyphicon-envelope"},feedback:false,ga_tracking:true,gm_app_name:"canvas factory",use_keyboard:true,use_hold_menu:true,drawing:true,display_icons:true,display_labels:true,btn_size:"sm",mode_btns:[{type:"radio",group:"mode",state:true,label:"transform",icon:"glyphicon glyphicon-random"},{type:"radio",group:"mode",state:false,label:"scrub",icon:"glyphicon glyphicon-wrench"},{type:"radio",group:"mode",state:false,label:"arrange",icon:"glyphicon glyphicon-move"}],use_toolbar:true,toolbar_on_style:{"margin-bottom":"10px"},toolbar_off_style:{display:"none"},toolFadeoutDelay:0,save_btn:{type:"push",label:"save",pull_right:true,icon:"glyphicon glyphicon-save"},load_btn:{type:"push",label:"load",pull_right:true,icon:"glyphicon glyphicon-open"},saves_url:"http://127.0.0.1:7010/saves/test",loads_url:"http://127.0.0.1:7010/api/saves/test",share_btn:{type:"push",label:"share",pull_right:true,icon:"glyphicon glyphicon-send"},saving_and_loading:true};return t}();gmath.ui=gmath.ui||{};gmath.ui.CanvasImage=function(){var t=function(t,e,n,i){CanvasElement.call(this,t,e,n);this.type="image";this.initCanvasImageOptions(n);this.initCanvasImageProperties(n);this.initCanvasImage();this.initPosition();this.initMode();if(i)this.callback()};gmath.inherit(CanvasElement,t);gmath.ui.CanvasImageClass=t;t.defaultOptions={min_size:{width:50},size:{width:200}};t.prototype.initCanvasImageOptions=function(e){var e=e||{};var n=gmath.deepCopy(t.defaultOptions);var i=gmath.object.extendExisting(n,e);if(e.image_data)i.image_data=e.image_data;if(e.drop_evt){i.drop_evt=e.drop_evt;i.url=this.tryGetUrl(e.drop_evt)}if(e.url)i.url=e.url;this.options=gmath.extend(this.options,i)};t.prototype.initCanvasImageProperties=function(t){this.size=this.options.size};t.prototype.initCanvasImage=function(){if(this.options.image_data||this.options.url)this.loadImage();else this.getDataFromFile(this.options.drop_evt)};t.prototype.tryGetUrl=function(t){if(!t)return;if(typeof t==="string")return t;if(t.dataTransfer!==undefined){var e=t.dataTransfer.getData("text/plain");if(e.slice(0,4)==="http"){return e}else{var n=t.dataTransfer.getData("text/html");var i=$("<div>").append(n);var r=$(i).find("img").attr("src");if(typeof r!=="undefined")return r}}return null};t.prototype.getDataFromFile=function(t){if(typeof this.options.image_data!=="undefined")return;if(t===null)return;if(typeof t.dataTransfer==="undefined")return;var e=new FileReader;e.onload=function(t){this.canvas_image.options.image_data=t.target.result;this.canvas_image.loadImage()};e.onerror=function(t){console.error("error: "+t.target.error)};e.canvas_image=this;e.readAsDataURL(t.dataTransfer.files[0])};t.prototype.loadImage=function(){this.image_for_aspect_ratio=new Image;this.image_for_aspect_ratio.src=this.options.url||this.options.image_data;this.image=document.createElementNS("http://www.w3.org/2000/svg","image");this.image.addEventListener("load",this.waitForAspectRatio())};t.prototype.waitForAspectRatio=function(){if(this.image_for_aspect_ratio.complete){this.imageLoaded()}else{var t=setTimeout(n,100);var e=this;function n(){if(e.image_for_aspect_ratio.complete){e.imageLoaded()}else{var t=setTimeout(n,100)}}}};t.prototype.imageLoaded=function(){this.aspect_ratio=this.image_for_aspect_ratio.height/this.image_for_aspect_ratio.width;var t=this.size.width*this.aspect_ratio;this.options.min_size.height=this.options.min_size.width*this.aspect_ratio;if(isNaN(this.aspect_ratio))return;var e=this.options.url===null?this.options.image_data:this.options.url;this.image=this.element_div.append("img").property("src",e).attr({width:this.size.width-4,height:t-4}).style({"pointer-events":"none"});this.resizeElement({width:this.size.width,height:t})};t.prototype.resize=function(t){var e=t||d3.event;e.x=Math.max(e.x,this.options.min_size.width);e.y=this.size.width*this.aspect_ratio;this.resizeElement({width:e.x,height:e.y})};t.prototype.subTypeResize=function(t){this.image.attr({width:this.size.width-4,height:this.size.height-4})};t.prototype.toJSON=function(){var t={type:"CanvasImage",id:this.id,pos:gmath.deepCopy(this.pos),size:gmath.deepCopy(this.size),url:this.options.url||this.options.image_data};return t};return t}();gmath.ui=gmath.ui||{};gmath.ui.Keyboard=function(){var t=null;var e=function(){var t=function(){var t="m -5.708,-15.7 20.344,0 c 3.669696,0 6.624,2.954304 6.624,6.624 l 0,17.752 c 0,3.669696 -2.954304,6.624 -6.624,6.624 l -20.488,0 -15.408,-15.48 zM -2.18,-6.948 11.716,6.948M -2.18,6.948 11.716,-6.948";var e="M 13.7,16.5 -13.7,16.5 0,-16.5 z";var n=d3.dispatch("done","cancel","change"),i="",r=false,o,a,s=null,l=null,p=null,h=null,u="darkorange",c=900,d,f,y,m,g,v,_,b=false,w,x="center",k=null;var E=function(){D();w=mtouch_events().on("touch",P).on("release",F).on("hold",R).hold_time(750);S();q();if(i!="")o.mathquill("write",i);return this};function T(t){n[t](o.mathquill("latex"))}E.width=function(t){if(arguments.length==0)return c;c=t;if(s)q();return this};E.latex=function(t){if(arguments.length==0){if(o)i=o.mathquill("latex");return i}else{i=t;if(o)o.mathquill("latex",t);return this}};E.visible=function(t){if(arguments.length==0)return r;if(r==t)return this;r=t;if(!s)return this;if(r){s.style("display","block");a.focus()}else s.style("display","none");return this};E.position=function(t){if(arguments.length==0)return x;if(x==t)return this;x=t;if(!s)return this;s.call(N,x);return this};E.caption=function(t,e){if(arguments.length===0)return k;k=t;if(!p)return this;if(!k)p.style("display","none");else{h.text(t);p.style("display",null)}if(e){h.style("color",e)}return this};E.warning=function(t){return E.caption(t,u)};var C=function(){var t=[],e=[];g.forEach(function(n){e.push(n.row);t.push(n.col)});v=Math.max.apply(null,t);_=Math.max.apply(null,e);var n=(v+1)*130+v*10+2*10+2*10,i=(_+1)*110+10+10*(_-1)+2*10+2*10,r=c/n;f=130*r;m=10*r;y=110*r;d=i*r};var D=function(){g=[];g.keyboard="num";g.formula={type:"formula",col:2,row:0,cols:6};g.push({name:"Cancel",type:"event",event:"cancel",col:0,row:0,cols:2});g.push({type:"backspace",col:8,row:0});g.push({name:"Done",type:"event",event:"done",col:9,row:0,cols:2});g.push({name:"7",type:"key",col:0,row:1});g.push({name:"8",type:"key",col:1,row:1});g.push({name:"9",type:"key",col:2,row:1});g.push({name:"4",type:"key",col:0,row:2});g.push({name:"5",type:"key",col:1,row:2});g.push({name:"6",type:"key",col:2,row:2});g.push({name:"1",type:"key",col:0,row:3});g.push({name:"2",type:"key",col:1,row:3});g.push({name:"3",type:"key",col:2,row:3});g.push({name:"0",type:"key",col:3,row:3});g.push({name:"1a",type:"next_kbd",col:11,row:0});g.push({type:"arrow",dir:"left",col:9,row:3,cols:1,rows:.5});g.push({type:"arrow",dir:"up",col:10,row:2.5,cols:1,rows:.5});g.push({type:"arrow",dir:"down",col:10,row:3,cols:1,rows:.5});g.push({type:"arrow",dir:"right",col:11,row:3,cols:1,rows:.5});g.push({name:"+",type:"key",col:4.5,row:1});g.push({name:"",type:"key",val:"-",col:5.5,row:1});g.push({name:"*",type:"key",val:"*",col:4.5,row:2,dy:"0.3em"});g.push({name:"",type:"key",val:"/",col:5.5,row:2});g.push({name:"(",type:"key",col:4.5,row:3});g.push({name:")",type:"key",col:5.5,row:3});g.push({name:"^",type:"key",col:8,row:1});g.push({name:"=",type:"key",col:8,row:3});g.push({name:",",type:"key",col:7,row:1});g.push({name:".",type:"key",col:3,row:2});g.push({name:"x",type:"key",col:7,row:2});g.push({name:"y",type:"key",col:8,row:2});g.push({name:"_",type:"key",col:7,row:3})};var M=function(){g=[];g.keyboard="alpha";g.formula={type:"formula",col:2,row:0,cols:6};g.push({name:"Cancel",type:"event",event:"cancel",col:0,row:0,cols:2});g.push({type:"backspace",col:8,row:0});g.push({name:"Done",type:"event",event:"done",col:9,row:0,cols:2});g.push({name:"q",type:"key",col:0,row:1});g.push({name:"w",type:"key",col:1,row:1});g.push({name:"e",type:"key",col:2,row:1});g.push({name:"r",type:"key",col:3,row:1});g.push({name:"t",type:"key",col:4,row:1});g.push({name:"y",type:"key",col:5,row:1});g.push({name:"u",type:"key",col:6,row:1});g.push({name:"i",type:"key",col:7,row:1});g.push({name:"o",type:"key",col:8,row:1});g.push({name:"p",type:"key",col:9,row:1});g.push({name:"a",type:"key",col:.3,row:2});g.push({name:"s",type:"key",col:1.3,row:2});g.push({name:"d",type:"key",col:2.3,row:2});g.push({name:"f",type:"key",col:3.3,row:2});g.push({name:"g",type:"key",col:4.3,row:2});g.push({name:"h",type:"key",col:5.3,row:2});g.push({name:"j",type:"key",col:6.3,row:2});g.push({name:"k",type:"key",col:7.3,row:2});g.push({name:"l",type:"key",col:8.3,row:2});g.push({name:"z",type:"key",col:.6,row:3});g.push({name:"x",type:"key",col:1.6,row:3});g.push({name:"c",type:"key",col:2.6,row:3});g.push({name:"v",type:"key",col:3.6,row:3});g.push({name:"b",type:"key",col:4.6,row:3});g.push({name:"n",type:"key",col:5.6,row:3});g.push({name:"m",type:"key",col:6.6,row:3});g.push({name:"^",type:"key",col:9.3,row:2,cols:.6});g.push({name:"1a",type:"next_kbd",col:11,row:0});g.push({name:"+",type:"key",col:10,row:1});g.push({name:"-",type:"key",col:11,row:1});g.push({name:"*",type:"key",col:10,row:2,val:"*",dy:"0.3em"});g.push({name:"/",type:"key",col:11,row:2});g.push({name:"=",type:"key",col:11,row:3});g.push({name:"(",type:"key",col:9,row:3});g.push({name:")",type:"key",col:10,row:3});g.push({name:"_",type:"key",col:0,row:3,cols:.6});g.push({name:"shift",type:"shift",col:7.6,row:3,cols:1.25})};var z=function(){g=[];g.keyboard="function";g.formula={type:"formula",col:2,row:0,cols:6};g.push({name:"Cancel",type:"event",event:"cancel",col:0,row:0,cols:2});g.push({type:"backspace",col:8,row:0});g.push({name:"Done",type:"event",event:"done",col:9,row:0,cols:2});g.push({name:"",type:"key",col:0,row:1});g.push({name:"",type:"key",col:1,row:1});g.push({name:"",type:"key",col:2,row:1});g.push({name:"",type:"key",col:3,row:1});g.push({name:"",type:"key",col:4,row:1});g.push({name:"",type:"key",col:5,row:1});g.push({name:"",type:"key",col:6,row:1});g.push({name:"",type:"key",col:7,row:1});g.push({name:"",type:"key",col:8,row:1});g.push({name:"",type:"key",col:0,row:2});g.push({name:"",type:"key",col:1,row:2});g.push({name:"",type:"key",col:2,row:2});g.push({name:"",type:"key",col:3,row:2});g.push({name:"shift",type:"shift",col:9,row:1,cols:1.5});g.push({name:"",type:"key",val:"-",col:5,row:2});g.push({name:"",type:"key",val:"/",col:6,row:2});g.push({name:"",type:"key",col:7,row:2});g.push({type:"arrow",dir:"left",col:8,row:2,cols:1,rows:.5});g.push({type:"arrow",dir:"up",col:9,row:1.5,cols:1,rows:.5});g.push({type:"arrow",dir:"down",col:9,row:2,cols:1,rows:.5});g.push({type:"arrow",dir:"right",col:10,row:2,cols:1,rows:.5});g.push({name:"1a",type:"next_kbd",col:11,row:0})};var A=function(){g=[];g.keyboard="greek";g.formula={type:"formula",col:2,row:0,cols:6};g.push({name:"Cancel",type:"event",event:"cancel",col:0,row:0,cols:2});g.push({type:"backspace",col:8,row:0});g.push({name:"Done",type:"event",event:"done",col:9,row:0,cols:2});g.push({name:"",type:"key",col:0,row:1});g.push({name:"",type:"key",col:1,row:1});g.push({name:"",type:"key",col:2,row:1});g.push({name:"",type:"key",col:3,row:1});g.push({name:"",type:"key",col:4,row:1});g.push({name:"",type:"key",col:5,row:1});g.push({name:"",type:"key",col:6,row:1});g.push({name:"",type:"key",col:7,row:1});g.push({name:"",type:"key",col:8,row:1});g.push({name:"",type:"key",col:0,row:2});g.push({name:"",type:"key",col:1,row:2});g.push({name:"",type:"key",col:2,row:2});g.push({name:"",type:"key",col:3,row:2});g.push({name:"",type:"key",col:4,row:2});g.push({name:"",type:"key",col:5,row:2});g.push({name:"",type:"key",col:6,row:2});g.push({name:"",type:"key",col:7,row:2});g.push({name:"",type:"key",col:0,row:3});g.push({name:"",type:"key",col:1,row:3});g.push({name:"",type:"key",col:2,row:3});g.push({name:"",type:"key",col:3,row:3});g.push({name:"",type:"key",col:4,row:3});g.push({name:"",type:"key",col:5,row:3});g.push({name:"",type:"key",col:6,row:3});g.push({name:"shift",type:"shift",col:7,row:3,cols:1.5});g.push({name:"+",type:"key",col:9,row:1});g.push({name:"-",type:"key",col:10,row:1});g.push({name:"*",type:"key",col:9,row:2,val:"*",dy:"0.3em"});g.push({name:"/",type:"key",col:10,row:2});g.push({name:"=",type:"key",col:11,row:3});g.push({name:"^",type:"key",col:8,row:2});g.push({name:"(",type:"key",col:9,row:3});g.push({name:")",type:"key",col:10,row:3});g.push({name:"1a",type:"next_kbd",col:11,row:0})};var S=function(){s=d3.select("body").append("div").style({position:"fixed",bottom:0,"z-index":1e4}).style("display",r?"block":"none");p=s.append("div").attr("id","caption");h=p.append("span").text(k);p.append("span").text("x").style({position:"absolute",right:"5px",top:"-3px",color:"silver",cursor:"pointer"}).on("click",function(){E.caption(false)});l=s.append("div").classed("keyboard",true);o=l.append("div").attr("id","formula").datum(g.formula).append("div").attr("id","mq_div").append("span").attr("id","mq_span");o=$(o.node()).mathquill("editable");a=o.find("textarea");if(r)a.focus();d3.select(a[0]).on("keyup",function(){if(d3.event.keyCode===13)T("done")});I();var t=l.selectAll(".key").data(g).enter().append("div").classed("key",true).call(w);t.filter(function(t){return t.type=="backspace"}).classed("backspace-key",true).append("svg").append("path");t.filter(function(t){return t.type=="arrow"}).classed("arrow-key",true).append("svg").append("path");t.filter(function(t){return t.name}).classed("normal-key",true).append("span")};var L=function(){l.selectAll(".key").remove();l.select("#formula").datum(g.formula);var t=l.selectAll(".key").data(g).enter().append("div").classed("key",true).call(w);t.filter(function(t){return t.type=="backspace"}).classed("backspace-key",true).append("svg").append("path");t.filter(function(t){return t.type=="arrow"}).classed("arrow-key",true).append("svg").append("path");t.filter(function(t){return t.name}).classed("normal-key",true).append("span")};var q=function(){C();s.call(N,x);l.style("height",d+"px").style("width",c+"px").style({bottom:0,background:"#DDD",padding:0,"text-align":"center",border:"1px solid silver","border-radius":m*1.5+"px "+m*1.5+"px 0 0","border-bottom":"none"}).select("#formula").style("border",m+"px solid #DDD").style("border-radius",m+"px").call(j,m).select("#mq_div").style("border-radius",m+"px").style("width",function(t){return(t.cols||1)*f+((t.cols||1)-1)*m+"px"}).call(G).select("#mq_span").style("box-shadow","none").style("-webkit-box-shadow","none").style("-moz-box-shadow","none").style("margin-top",m).style("font-size",y/2+y/10+"px").style("padding-top",3*m-2+"px").style("padding-bottom",2*m+"px").style("border","none").style("min-height",function(t){
return(t.rows||1)*y+((t.rows||1)-1)*m-5*m+"px"}).style("width","100%");l.selectAll(".key").call(j).call(H).call(G);l.selectAll(".backspace-key path").attr("d",t).style("stroke","black").style("stroke-width","1.2").style("fill","none").attr("transform","translate("+f/2+","+y/2+")scale("+.12*m+")");l.selectAll(".arrow-key path").attr("d",e).style("stroke","black").style("stroke-linejoin","round").style("stroke-width",3).style("fill","none").attr("transform",function(t){var e={left:-90,up:0,right:90,down:180}[t.dir];return"translate("+f/2+","+y/4+")scale("+.05*m+")rotate("+e+")"});l.selectAll(".normal-key span").text(function(t){return t.name}).style("line-height",y+"px").filter(function(t){return t.dy}).style("display","inline-block").style("margin-top",function(t){return t.dy});p.style({position:"relative",background:"rgb(244, 244, 244)",padding:"12px","padding-bottom":"8px",border:"1px solid silver","border-radius":"7.6px 7.6px 0 0","border-bottom":"none",width:4*f+3*m+"px","margin-left":8*f+10*m+"px","font-family":"HelveticaNeue-Light",color:"#666","font-size":"17px","text-align":"center",display:k?null:"none"})};var I=function(){if(/iPhone|iPod|iPad|Android|BlackBerry/.test(navigator.userAgent))l.select(".textarea textarea").attr("readonly","readonly")};var P=function(t){d3.select(this).style("background","gray");if(t.type==="formula")return;a.focus();if(t.type==="next_kbd"){B()}else if(t.type==="shift"){O(t)}else if(t.type==="key"){var e=t.val||t.name;if(b)e=e.toUpperCase();var n=e.charCodeAt(0);a.val(e);if(n!==46)a.trigger($.Event("keydown",{which:n}));a.trigger($.Event("keypress",{which:n}));T("change")}else if(t.type==="backspace"){a.trigger($.Event("keydown",{which:8}));T("change")}else if(t.type==="event"){T(t.event)}else if(t.type==="arrow"){var n={left:37,up:38,right:39,down:40}[t.dir];a.trigger($.Event("keydown",{which:n}));T("change")}};var B=function(){b=false;if(g.keyboard==="num"){M()}else if(g.keyboard==="alpha"){A()}else if(g.keyboard==="greek"){D()}L();q()};var O=function(t){b=!b;l.selectAll(".key span").text(function(t){if(t.type==="key"){if(b)return t.name.toUpperCase();else return t.name.toLowerCase()}else{return t.name}})};var F=function(t){if(t.type!=="shift"||!b)d3.select(this).style("background",t.type=="key"||t.type=="formula"?"white":"silver")};var R=function(t){if(t.type!=="backspace")return;o.mathquill("latex","");a.focus()};var j=function(t,e){e=e||0;t.style("position","absolute").style("left",function(t){return t.col*(f+m)+2*m-e+"px"}).style("bottom",function(t){return(_-t.row)*(y+m)+(t.row==0?0:0)+2*m-e+"px"})};var H=function(t,e,n){e=e||0;n=n||0;t.style("width",function(t){return(t.cols||1)*f+((t.cols||1)-1)*m-2*e+"px"}).style("height",function(t){return(t.rows||1)*y+((t.rows||1)-1)*m-2*n+"px"})};var G=function(t){t.style("border-radius",m+"px").style("font-size",y/2+"px").style("background",function(t){return t.type=="key"||t.type=="formula"?"white":"silver"}).style("box-shadow","#888 0px 1px 0px").style("font-family","'HelveticaNeue-UltraLight', 'Helvetica Neue UltraLight', 'Helvetica Neue', Arial, Helvetica, sans-serif").style("font-weight",100).style("border","none").style("padding",0).style("-webkit-user-select","none").style("-khtml-user-select","none").style("-moz-user-select","none").style("-ms-user-select","none").style("user-select","none").style("cursor","pointer")};var N=function(t,e){if(e==="center"){t.style("margin-left",-c/2+"px");t.style("left","50%");t.style("right",null)}else if(e==="left"){t.style("margin-left",0);t.style("left",0);t.style("right",null)}else if(e==="right"){t.style("margin-left",0);t.style("left",null);t.style("right",0)}else{t.style("margin-left",-c/2+"px");t.style("left",e);t.style("right",null)}};return d3.rebind(E,n,"on")};return t};return function(){return t||(t=e()())}}();gmath.ui=gmath.ui||{};gmath.ui.TutorialPair=function(){var t=function(t,e){this.events=d3.dispatch("done","retry","next");this.id=gmath.uid();this.title=e.title;this.text=e.text;if("gestureData"in e){this.gesture_data=e.gestureData;this.gesture_data.options.show_bg=false}this.initial_expressions=function n(t,e){if(!t)return[];if(!e)return[t];return[t].concat(e.map(function(t){return t.expression}))}.call(this,e.eq,e.extraExamples);this.correct_answers=function i(t,e){if(!t)return[];if(!e)return[t.map(this.parsedAscii)];return[t.map(this.parsedAscii)].concat(e.map(function(t){return t.correctAnswers.map(this.parsedAscii)},this))}.call(this,e.correctAnswers,e.extraExamples);this.current_example=0;this.start_wiggle=e.startWiggle;this.encourage=true;this.container=d3.select(t);this.dl_div=null;this.dl=null;this.play_btn=gmath.svg_play_button();this.player=null;this.practice_problem=e.practice_problem;this.allow_restart_after_done="allow_restart_after_done"in e?e.allow_restart_after_done:true;this.answered=false;this.reporter_options=e.reporter_options;this.task_name=e.task_name;this.init()};t.prototype.parsedAscii=function(t){return new gmath.AlgebraModel(t).to_ascii()};t.prototype.replay=function(){this.play_btn.hidden(true);this.player.replay(500,function t(){setTimeout(function t(){this.play_btn.hidden(false);if(!this.answered){if(this.encourage){this.dl_div.append("span").text("Try it!").classed("tryit",true);if(this.start_wiggle)this.dl.startWiggle(this.start_wiggle)}this.dl_div.on("mousedown",function t(){var t=new Date;this.startTime=t.getTime();this.dl_div.select("span.tryit").remove();this.dl_div.on("mousedown",null)}.bind(this))}}.bind(this),1e3)}.bind(this))};t.prototype.init=function(){this.container.append("h2").text(this.title);this.container.append("p").attr("class","tutorial-instructions").text(this.text);var t=this.container.append("div").classed("tutorial",true);var e=t.append("div").attr("id","ex").classed("choice",true).classed("large-choice",this.practice_problem).append("svg").classed("animation",true);this.gesture_data.options.pos={x:"center",y:"center"};this.gesture_data.options.hold_time=1e6;this.gesture_data.options.draggable=false;this.gesture_data.options.collapsed_mode=true;this.gesture_data.options.no_history=false;this.gesture_data.options.no_handles=true;this.gesture_data.options.row_padding={left:0,right:0,top:7,bottom:3};this.gesture_data.options.padding={left:0,right:0,top:0,bottom:0};this.gesture_data.options.replace_value_on=false;this.player=new gmath.EventRecorder(this.gesture_data,e.append("g").node());this.player.showPreview();e.call(this.play_btn.on("click",this.replay.bind(this)));if(this.initial_expressions.length){this.dl_div=t.append("div").classed("choice",true).classed("large-choice",this.practice_problem);var n=new gmath.ui.CanvasFactory(this.dl_div.node(),{vertical_scroll:false,use_toolbar:false,use_keyboard:false,use_hold_menu:false,svg_height:"100%",reporter_options:this.reporter_options,overflow_visible:true});this.reporter=n.reporter;this.model=n.model;this.setDLToExpression(this.initial_expressions[this.current_example]);this.startTime=-1}};t.prototype.chainTransition=function(t,e){if(t.node().__transition__&&t.id&&t.node().__transition__[t.id]){var n=t.node().__transition__[t.id];console.log("extra delay",n.delay+n.duration);e+=n.delay+n.duration}return t.transition().delay(e)};t.prototype.neutralTransition=function(t,e,n,i){t.selectAll("button").remove();t.select("span").remove();var r=this.chainTransition(t,e).duration(n||500);if(i)r.styleTween("background",function(){return d3.interpolate(i,"#EEEEEE")});else r.style("background","#eee");return r};t.prototype.wrongTransition=function(t,e,n,i){var r=d3.select(t.node());r.append("span").attr("class","feedback").style({opacity:1e-5}).text("");var o=this.chainTransition(t,e).duration(n||500);if(i)o.styleTween("background",function(){return d3.interpolate(i,"#E0A8A8")});else o.style("background","#E0A8A8");o.select(".feedback").style("opacity",1);return o};t.prototype.correctTransition=function(t,e,n,i){var r=d3.select(t.node());r.append("span").attr("class","feedback").style({opacity:1e-5}).text("");this.initDoItAgainBtn(r);if(this.initial_expressions.length>1)this.initTryAnotherBtn(r);var o=this.chainTransition(t,e).duration(n||500);if(i)o.styleTween("background",function(){return d3.interpolate(i,"#A8E0B3")});else o.style("background","#A8E0B3");o.select(".feedback").style("opacity",1);o.selectAll("button").style("opacity",1);return o};t.prototype.initDoItAgainBtn=function(t){t.append("button").text("do it again").style({top:"10px",opacity:1e-5}).on("click",function e(){this.reporter.submitCustomSummary({type:"tutorial-reset",task_name:this.task_name,eq_start:this.dl.rows[0].model.to_ascii(),eq_end:this.dl.getLastModel().to_ascii()});if(this.allow_restart_after_done)this.retry()}.bind(this))};t.prototype.initTryAnotherBtn=function(t){t.append("button").text("try another").style({top:"62px",opacity:1e-5}).on("click",function e(){this.reporter.submitCustomSummary({type:"tutorial-alternative-example",task_name:this.task_name,eq_start:this.dl.rows[0].model.to_ascii()});if(this.initial_expressions.length>1)this.loadNextExample();else this.retry()}.bind(this))};t.prototype.checkAnswer=function(){var t=400;setTimeout(function e(){this.dl.getLastView().interactive(false);var t=this.dl.getLastModel().to_ascii();var e=new Date;var n=-1;var i=-1;if(this.startTime!==-1)n=e.getTime()-this.startTime;if(this.parsedAscii(this.initial_expressions[this.current_example])===this.dl.getLastModel().to_ascii()){this.dl.getLastView().interactive(true);i="initial state"}else if(this.answerIsCorrect(t)){i="correct";this.answered=true;this.reporter.submitCustomSummary({type:"tutorial-success",task_name:this.task_name,eq_start:this.dl.rows[0].model.to_ascii(),eq_end:this.dl.getLastModel().to_ascii()});if(this.dl_div.selectAll("div").size()===2)return;this.correctTransition(this.dl_div,200,null,"#EEEEEE").each("end",this.events.done)}else if(!this.practice_problem){i="wrong";this.reporter.submitCustomSummary({type:"tutorial-fail",task_name:this.task_name,eq_start:this.dl.rows[0].model.to_ascii(),eq_end:this.dl.getLastModel().to_ascii()});this.wrongTransition(this.dl_div,200,null,"#EEEEEE").transition().duration(500).each("end",this.retry.bind(this));this.encourage=true}else{i="intermediate state";this.dl.getLastView().interactive(true)}if(gmath.log_ga)gmath.log_ga.trackEvent("tutorial",i,this.eq,n)}.bind(this),t)};t.prototype.answerIsCorrect=function(t){return this.correct_answers[this.current_example].indexOf(t)!==-1};t.prototype.loadNextExample=function(){var t=this.dl.rows[0].model.to_ascii();this.neutralTransition(this.dl_div,0,1).each("end",function e(){this.current_example++;if(this.current_example===this.initial_expressions.length)this.current_example=0;this.setDLToExpression(this.initial_expressions[this.current_example]);if(this.current_example===0)this.encourage=true;else this.encourage=false;this.events.next()}.bind(this))};t.prototype.retry=function(){this.neutralTransition(this.dl_div,0,1).each("end",function t(){this.setDLToExpression(this.initial_expressions[this.current_example]);this.events.retry()}.bind(this));this.answered=false;this.encourage=true};t.prototype.setDLToExpression=function(t){var e=gmath.deepCopy(this.gesture_data.options);e.eq=t;e.inactive_color=gmath.AlgebraView.defaultOptions.inactive_color;e.color=gmath.AlgebraView.defaultOptions.color;e.h_align="center";this.reporter.setListening(false);if(this.dl)this.model.removeElement(this.dl);this.dl=this.model.createDL(e);this.model.focusOnDL(this.dl);this.reporter.setListening(true);this.dl.getLastRow().view.interaction_handler.events.on("touch",function(){this.encourage=false}.bind(this));this.dl.getLastView().interactive(true);this.dl.events.on("end-of-interaction."+this.id,this.checkAnswer.bind(this))};t.prototype.stop=function(){this.player.stop_animation()};return t}();var Timeline={};Timeline.entryTypes={};Timeline.entry=function(t,e){t=t[0];for(var n in Timeline.entryTypes){var i=Timeline.entryTypes[n];if(i.prototype.match(t))return new i(t,e)}return null};var EntryType=function(t){this.type=t};EntryType.prototype.match=function(t){return this.type===t.type};var AlgebraEntry=function(t,e){EntryType.call(this,t.type);this.summary=t;this.object=e.getElementByID(this.summary.element.id)};gmath.inherit(EntryType,AlgebraEntry);AlgebraEntry.prototype.type="algebra";Timeline.entryTypes.AlgebraEntry=AlgebraEntry;AlgebraEntry.prototype.match=function(t){return this.type===t.type&&!t.targets};AlgebraEntry.prototype.undo=function(t){this.rows=[];this.packState=this.object.rows.map(function(t){return t.hidden?true:false});while(this.object.getLastRow().idx!==this.summary.element.subid){this.rows.push(this.object.undo())}};AlgebraEntry.prototype.redo=function(t){for(var e=this.rows.length-1;e>=0;e--){this.object.redo(this.rows[e])}for(var e=0;e<this.object.rows.length;e++){var n=this.object.rows[e];if(this.packState[e]&&!n.hidden)n.hide();else if(!this.packState[e]&&n.hidden)n.unhide()}this.object.layoutRows()};var SubstituteEntry=function(t,e){EntryType.call(this,t.type);this.summary=t;this.objects=[];for(var n=0;n<this.summary.targets.length;n++){this.objects.push({dl:e.getElementByID(this.summary.targets[n].id)})}};gmath.inherit(EntryType,SubstituteEntry);SubstituteEntry.prototype.type="algebra";Timeline.entryTypes.SubstituteEntry=SubstituteEntry;SubstituteEntry.prototype.match=function(t){return this.type===t.type&&t.targets};SubstituteEntry.prototype.undo=function(t){for(var e=0;e<this.objects.length;e++){var n=this.objects[e];n.rows=[];n.packState=n.dl.rows.map(function(t){return t.hidden?true:false});while(n.dl.getLastRow().idx!==this.summary.targets[e].subid){n.rows.push(n.dl.undo())}}};SubstituteEntry.prototype.redo=function(t){for(var e=0;e<this.objects.length;e++){var n=this.objects[e];for(var i=n.rows.length-1;i>=0;i--){n.dl.redo(n.rows[i])}for(var i=0;i<n.dl.rows.length;i++){var r=n.dl.rows[i];if(n.packState[i]&&!r.hidden)r.hide();else if(!n.packState[i]&&r.hidden)r.unhide()}n.dl.layoutRows()}};var CreateEntry=function(t,e){EntryType.call(this,t.type);this.summary=t;this.objects=[];for(var n=0;n<this.summary.targets.length;n++){this.objects.push(e.getElementByID(this.summary.targets[n].id))}};gmath.inherit(EntryType,CreateEntry);CreateEntry.prototype.type="create";Timeline.entryTypes.CreateEntry=CreateEntry;CreateEntry.prototype.match=function(t){return this.type===t.type&&t.targets.every(function(t){return t.type==="derivation"||t.type==="textbox"||t.type==="image"})};CreateEntry.prototype.undo=function(t){for(var e=0;e<this.objects.length;e++){t.removeElement(this.objects[e])}};CreateEntry.prototype.redo=function(t){for(var e=0;e<this.objects.length;e++){t.addElement(this.objects[e])}};var DeleteEntry=function(t,e){EntryType.call(this,t.type);this.summary=t;this.object=e.getDeletedElementByID(this.summary.element.id)};gmath.inherit(EntryType,DeleteEntry);DeleteEntry.prototype.type="delete";Timeline.entryTypes.Entry=DeleteEntry;DeleteEntry.prototype.match=function(t){return this.type===t.type&&(t.element.type==="derivation"||t.element.type==="textbox"||t.element.type==="image")};DeleteEntry.prototype.undo=function(t){t.addElement(this.object)};DeleteEntry.prototype.redo=function(t){t.removeElement(this.object)};var DrawEntry=function(t,e){EntryType.call(this,t.type);this.summary=t;this.object=e.getElementByID(this.summary.targets[0].id)};gmath.inherit(EntryType,DrawEntry);DrawEntry.prototype.type="draw";Timeline.entryTypes.DrawEntry=DrawEntry;DrawEntry.prototype.undo=function(t){t.removePath(this.object)};DrawEntry.prototype.redo=function(t){t.addPath(this.object)};var EraseEntry=function(t){EntryType.call(this,t.type);this.summary=t};gmath.inherit(EntryType,EraseEntry);EraseEntry.prototype.type="erase";Timeline.entryTypes.EraseEntry=EraseEntry;EraseEntry.prototype.match=function(t){return this.type===t.type};EraseEntry.prototype.undo=function(t){if(!this.modification){console.warn("erase modification was not set");return}this.modification.removed.forEach(function(e){t.addPath(e)});this.modification.added.forEach(function(e){t.removePath(e)});this.modification.modified.forEach(function(e){e.path.points=e.points_before;t.updatePath(e.path)})};EraseEntry.prototype.redo=function(t){this.modification.removed.forEach(function(e){t.removePath(e)});this.modification.modified.forEach(function(e){e.path.points=e.points_after;t.updatePath(e.path)});this.modification.added.forEach(function(e){t.addPath(e)})};var MoveEntry=function(t,e){EntryType.call(this,t.type);this.summary=t;this.object=e.getElementByID(this.summary.element.id)};gmath.inherit(EntryType,MoveEntry);MoveEntry.prototype.type="move";Timeline.entryTypes.MoveEntry=MoveEntry;MoveEntry.prototype.match=function(t){return this.type===t.type&&(t.element.type==="derivation"||t.element.type==="textbox"||t.element.type==="image")};MoveEntry.prototype.undo=function(t){this.object.translateElement(this.summary.element.old_state)};MoveEntry.prototype.redo=function(t){this.object.translateElement(this.summary.element.new_state)};var FontSizeEntry=function(t,e){EntryType.call(this,t.type);this.summary=t;if(this.summary.element.type==="textbox")this.textbox=e.getElementByID(this.summary.element.id)};gmath.inherit(EntryType,FontSizeEntry);FontSizeEntry.prototype.type="font_size";Timeline.entryTypes.FontSizeEntry=FontSizeEntry;FontSizeEntry.prototype.undo=function(t,e){var n=this.summary.element.new_state,i=this.summary.element.old_state;if(this.summary.element.type=="textbox"){if(n>i)this.textbox.decreaseTextSize();else this.textbox.increaseTextSize()}else{if(n>i)e.font_smaller();else e.font_larger()}};FontSizeEntry.prototype.redo=function(t,e){var n=this.summary.element.new_state,i=this.summary.element.old_state;if(this.summary.element.type==="textbox"){if(n>i)this.textbox.increaseTextSize();else this.textbox.decreaseTextSize()}else{if(n>i)e.font_larger();else e.font_smaller()}};var PackEntry=function(t,e){EntryType.call(this,t.type);this.summary=t;this.object=e.getElementByID(this.summary.element.id)};gmath.inherit(EntryType,PackEntry);PackEntry.prototype.type="pack";Timeline.entryTypes.PackEntry=PackEntry;PackEntry.prototype.match=function(t){return this.type===t.type&&!this.startingAndEndingPackStateAreTheSame(t)};PackEntry.prototype.startingAndEndingPackStateAreTheSame=function(t){var e=t.element.old_state,n=t.element.new_state;for(var i=0;i<e.length;i++){if(e[i]!==n[i])return false}return true};PackEntry.prototype.undo=function(t){var e=this.object.rows,n=this.summary.element.old_state;for(var i=0;i<e.length;i++){if(e[i].hidden&&!n[i])e[i].unhide();else if(!e[i].hidden&&n[i])e[i].hide()}this.object.layoutRows()};PackEntry.prototype.redo=function(t){var e=this.object.rows,n=this.summary.element.new_state;for(var i=0;i<e.length;i++){if(e[i].hidden&&!n[i])e[i].unhide();else if(!e[i].hidden&&n[i])e[i].hide()}this.object.layoutRows()};var CloneEntry=function(t,e){EntryType.call(this,t.type);this.summary=t;this.object=e.getElementByID(this.summary.targets[0].id)};gmath.inherit(EntryType,CloneEntry);CloneEntry.prototype.type="clone";Timeline.entryTypes.CloneEntry=CloneEntry;CloneEntry.prototype.match=function(t){return this.type===t.type};CloneEntry.prototype.undo=function(t){this.links=t.removeElement(this.object)};CloneEntry.prototype.redo=function(t){t.addDL(this.object);gmath.LinkCoordinator.addLinks(this.links)};var ScrubEntry=function(t,e){EntryType.call(this,t.type);this.summary=t;this.object=e.getElementByID(this.summary.element.id)};gmath.inherit(EntryType,ScrubEntry);ScrubEntry.prototype.type="scrub";Timeline.entryTypes.ScrubEntry=ScrubEntry;ScrubEntry.prototype.match=function(t){return this.type===t.type};ScrubEntry.prototype.undo=function(t){var e=this.object.rows[0].model;var n=e.replace_with(new gmath.AlgebraModel(this.summary.element.old_state,e.options));this.object.rows[0].updateDimensionAfterInteraction();this.object.updateRowDimensions();this.object.rows[0].view.update_existing()};ScrubEntry.prototype.redo=function(t){var e=this.object.rows[0].model;var n=e.replace_with(new gmath.AlgebraModel(this.summary.element.new_state,e.options));this.object.rows[0].updateDimensionAfterInteraction();this.object.updateRowDimensions();this.object.rows[0].view.update_existing()};var TextEditEntry=function(t,e){EntryType.call(this,t.type);this.summary=t;this.textbox=e.getElementByID(this.summary.element.id)};gmath.inherit(EntryType,TextEditEntry);TextEditEntry.prototype.type="text";Timeline.entryTypes.TextEditEntry=TextEditEntry;TextEditEntry.prototype.undo=function(t){this.textbox.text_el.node().innerHTML=this.summary.element.old_state;this.textbox.update()};TextEditEntry.prototype.redo=function(t){this.textbox.text_el.node().innerHTML=this.summary.element.new_state;this.textbox.update()};var ResizeEntry=function(t,e){EntryType.call(this,t.type);this.summary=t;this.canvasElement=e.getElementByID(this.summary.element.id)};gmath.inherit(EntryType,ResizeEntry);ResizeEntry.prototype.type="resize";Timeline.entryTypes.ResizeEntry=ResizeEntry;ResizeEntry.prototype.match=function(t){return this.type===t.type};ResizeEntry.prototype.undo=function(t){this.canvasElement.resizeElement(this.summary.element.old_state)};ResizeEntry.prototype.redo=function(t){this.canvasElement.resizeElement(this.summary.element.new_state)};gmath.gmifyPage=function(t,e){e=e||{};coordinator=new DLCoordinator;var n=t?d3.select(t):d3.select("body");var i=n.size()>0&&n.classed("gmify-canvas")?n:n.selectAll(".gmify-canvas");i.each(function(){var t=d3.select(this);var e=t.text().split(";");try{e.forEach(gmath.AlgebraModel.getDefaultParser().parse);t.classed("gmify-canvas",false).classed("gmified-canvas",true);t.classed("bootstrap-styles",true);t.select("*").remove();var n=new gmath.ui.CanvasFactory(this,{height:"500px"});fixAggressiveAssistmentsStyles(t);var i={pos:["auto",20],v_align:"top"};n.model.createDLs(e,i)}catch(r){console.log('could not parse "'+e+'". Error:',r)}});i=n.size()>0&&n.classed("gmify-minimal")?n:n.selectAll(".gmify-minimal");i.each(function(){var t=d3.select(this);var e=t.text();try{gmath.AlgebraModel.getDefaultParser().parse(e);t.classed("gmify-minimal",false).classed("gmified-minimal",true);t.classed("bootstrap-styles",true);t.select("*").remove();t.text("");var n=t.insert("svg").style({overflow:"visible",display:"block",width:"100%"});gmath.DerivationList.createFixedSingleLineDL(n.node(),{eq:e})}catch(i){console.log('could not parse "'+e+'". Error:',i)}});i=n.size()>0&&n.classed("gmify")?n:n.selectAll(".gmify");i.each(function(t,n){var i=d3.select(this),r=i.text();try{gmath.AlgebraModel.getDefaultParser().parse(r);i.classed("gmify",false).classed("gmified",true);i.classed("bootstrap-styles",true);i.select("*").remove();i.text("");var o=i.insert("div").style({overflow:"visible",display:"block","margin-top":"30px"});var a=new gmath.ui.CanvasFactory(o.node(),{minimal:true,logo_src:e.logo_src}),s=a.model.createDL({eq:r,pos:{x:0,y:0},cloning_on:false,normal_font:{family:"Kalam"},italic_font:{family:"Kalam"},font_baseline_shift:.4,font_ascent:.9,font_descent:.2,slanted_div_bar:true,div_bar_height:1/14,font_size:"45",row_border_color:"#ddd",handle_stroke_color:"#d8d8d8",keep_in_container:true});fixAggressiveAssistmentsStyles(i);coordinator.subscribeToCanvasModel(a.model);coordinator.addDL(s);a.model.focusOnDL(s);a.controller.clearInteractionTimeline()}catch(l){console.log('could not parse "'+r+'". Error:',l)}})};fixAggressiveAssistmentsStyles=function(t){t.selectAll(".btn-toolbar button span").style("font-size","12px");t.selectAll(".btn-toolbar button br").style("font-size","12px")};
