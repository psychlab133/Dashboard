!function(a){function b(a,b,e){return 4===arguments.length?c.apply(this,arguments):void d(a,{declarative:!0,deps:b,declare:e})}function c(a,b,c,e){d(a,{declarative:!1,deps:b,executingRequire:c,execute:e})}function d(a,b){b.name=a,a in o||(o[a]=b),b.normalizedDeps=b.deps}function e(a,b){if(b[a.groupIndex]=b[a.groupIndex]||[],-1==p.call(b[a.groupIndex],a)){b[a.groupIndex].push(a);for(var c=0,d=a.normalizedDeps.length;d>c;c++){var f=a.normalizedDeps[c],g=o[f];if(g&&!g.evaluated){var h=a.groupIndex+(g.declarative!=a.declarative);if(void 0===g.groupIndex||g.groupIndex<h){if(void 0!==g.groupIndex&&(b[g.groupIndex].splice(p.call(b[g.groupIndex],g),1),0==b[g.groupIndex].length))throw new TypeError("Mixed dependency cycle detected");g.groupIndex=h}e(g,b)}}}}function f(a){var b=o[a];b.groupIndex=0;var c=[];e(b,c);for(var d=!!b.declarative==c.length%2,f=c.length-1;f>=0;f--){for(var g=c[f],i=0;i<g.length;i++){var k=g[i];d?h(k):j(k)}d=!d}}function g(a){return s[a]||(s[a]={name:a,dependencies:[],exports:{},importers:[]})}function h(b){if(!b.module){var c=b.module=g(b.name),d=b.module.exports,e=b.declare.call(a,function(a,b){if(c.locked=!0,"object"==typeof a)for(var e in a)d[e]=a[e];else d[a]=b;for(var f=0,g=c.importers.length;g>f;f++){var h=c.importers[f];if(!h.locked)for(var i=0;i<h.dependencies.length;++i)h.dependencies[i]===c&&h.setters[i](d)}return c.locked=!1,b},{id:b.name});c.setters=e.setters,c.execute=e.execute;for(var f=0,i=b.normalizedDeps.length;i>f;f++){var j,k=b.normalizedDeps[f],l=o[k],m=s[k];m?j=m.exports:l&&!l.declarative?j=l.esModule:l?(h(l),m=l.module,j=m.exports):j=n(k),m&&m.importers?(m.importers.push(c),c.dependencies.push(m)):c.dependencies.push(null),c.setters[f]&&c.setters[f](j)}}}function i(a){var b,c=o[a];if(c)c.declarative?m(a,[]):c.evaluated||j(c),b=c.module.exports;else if(!(b=n(a)))throw new Error("Unable to load dependency "+a+".");return(!c||c.declarative)&&b&&b.__useDefault?b.default:b}function j(b){if(!b.module){var c={},d=b.module={exports:c,id:b.name};if(!b.executingRequire)for(var e=0,f=b.normalizedDeps.length;f>e;e++){var g=b.normalizedDeps[e],h=o[g];h&&j(h)}b.evaluated=!0;var l=b.execute.call(a,function(a){for(var c=0,d=b.deps.length;d>c;c++)if(b.deps[c]==a)return i(b.normalizedDeps[c]);throw new TypeError("Module "+a+" not declared as a dependency.")},c,d);l&&(d.exports=l),c=d.exports,c&&c.__esModule?b.esModule=c:b.esModule=k(c)}}function k(b){var c={};if(("object"==typeof b||"function"==typeof b)&&b!==a)if(q)for(var d in b)"default"!==d&&l(c,b,d);else{var e=b&&b.hasOwnProperty;for(var d in b)"default"===d||e&&!b.hasOwnProperty(d)||(c[d]=b[d])}return c.default=b,r(c,"__useDefault",{value:!0}),c}function l(a,b,c){try{var d;(d=Object.getOwnPropertyDescriptor(b,c))&&r(a,c,d)}catch(d){return a[c]=b[c],!1}}function m(b,c){var d=o[b];if(d&&!d.evaluated&&d.declarative){c.push(b);for(var e=0,f=d.normalizedDeps.length;f>e;e++){var g=d.normalizedDeps[e];-1==p.call(c,g)&&(o[g]?m(g,c):n(g))}d.evaluated||(d.evaluated=!0,d.module.execute.call(a))}}function n(a){if(u[a])return u[a];if("@node/"==a.substr(0,6))return u[a]=k(t(a.substr(6)));var b=o[a];if(!b)throw"Module "+a+" not present.";return f(a),m(a,[]),o[a]=void 0,b.declarative&&r(b.module.exports,"__esModule",{value:!0}),u[a]=b.declarative?b.module.exports:b.esModule}var o={},p=Array.prototype.indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(this[b]===a)return b;return-1},q=!0;try{Object.getOwnPropertyDescriptor({a:0},"a")}catch(a){q=!1}var r;!function(){try{Object.defineProperty({},"a",{})&&(r=Object.defineProperty)}catch(a){r=function(a,b,c){try{a[b]=c.value||c.get.call(a)}catch(a){}}}}();var s={},t="undefined"!=typeof System&&System._nodeRequire||"undefined"!=typeof require&&require.resolve&&"undefined"!=typeof process&&require,u={"@empty":{}};return function(a,d,e,f){return function(g){g(function(g){for(var h={_nodeRequire:t,register:b,registerDynamic:c,get:n,set:function(a,b){u[a]=b},newModule:function(a){return a}},i=0;i<d.length;i++)!function(a,b){b&&b.__esModule?u[a]=b:u[a]=k(b)}(d[i],arguments[i]);f(h);var j=n(a[0]);if(a.length>1)for(var i=1;i<a.length;i++)n(a[i]);return e?j.default:j})}}}("undefined"!=typeof self?self:global)(["1"],[],!1,function(a){var b=(this.require,this.exports,this.module);!function(b){function c(a,b){for(var c=a.split(".");c.length;)b=b[c.shift()];return b}function d(a){if("string"==typeof a)return c(a,b);if(!(a instanceof Array))throw new Error("Global exports must be a string or array.");for(var d={},e=!0,f=0;f<a.length;f++){var g=c(a[f],b);e&&(d.default=g,e=!1),d[a[f].split(".").pop()]=g}return d}function e(a){if(Object.keys)Object.keys(b).forEach(a);else for(var c in b)i.call(b,c)&&a(c)}function f(a){e(function(c){if(-1==j.call(k,c)){try{var d=b[c]}catch(a){k.push(c)}a(c,d)}})}var g,h=a,i=Object.prototype.hasOwnProperty,j=Array.prototype.indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(this[b]===a)return b;return-1},k=["_g","sessionStorage","localStorage","clipboardData","frames","frameElement","external","mozAnimationStartTime","webkitStorageInfo","webkitIndexedDB","mozInnerScreenY","mozInnerScreenX"];h.set("@@global-helpers",h.newModule({prepareGlobal:function(a,c,e){var h=b.define;b.define=void 0;var i;if(e){i={};for(var j in e)i[j]=b[j],b[j]=e[j]}return c||(g={},f(function(a,b){g[a]=b})),function(){var a;if(c)a=d(c);else{a={};var e,j;f(function(b,c){g[b]!==c&&void 0!==c&&(a[b]=c,void 0!==e?j||e===c||(j=!0):e=c)}),a=j?a:e}if(i)for(var k in i)b[k]=i[k];return b.define=h,a}}}))}("undefined"!=typeof self?self:global),a.registerDynamic("2",["3","4","5","6"],!0,function(a,b,c){"use strict";var d=(a("6"),this||self,a("3")),e=a("4")(5),f="find",g=!0;return f in[]&&Array(1)[f](function(){g=!1}),d(d.P+d.F*g,"Array",{find:function(a){return e(this,a,arguments.length>1?arguments[1]:void 0)}}),a("5")(f),c.exports}),a.registerDynamic("7",["2","8","6"],!0,function(a,b,c){a("6"),this||self;return a("2"),c.exports=a("8").Array.find,c.exports}),a.registerDynamic("9",["a","6"],!0,function(a,b,c){var d=(a("6"),this||self,a("a"));return c.exports=Object("z").propertyIsEnumerable(0)?Object:function(a){return"String"==d(a)?a.split(""):Object(a)},c.exports}),a.registerDynamic("b",["6"],!0,function(a,b,c){a("6"),this||self;return c.exports=function(a){if(void 0==a)throw TypeError("Can't call method on  "+a);return a},c.exports}),a.registerDynamic("c",["b","6"],!0,function(a,b,c){var d=(a("6"),this||self,a("b"));return c.exports=function(a){return Object(d(a))},c.exports}),a.registerDynamic("d",["6"],!0,function(a,b,c){var d=(a("6"),this||self,Math.ceil),e=Math.floor;return c.exports=function(a){return isNaN(a=+a)?0:(a>0?e:d)(a)},c.exports}),a.registerDynamic("e",["d","6"],!0,function(a,b,c){var d=(a("6"),this||self,a("d")),e=Math.min;return c.exports=function(a){return a>0?e(d(a),9007199254740991):0},c.exports}),a.registerDynamic("a",["6"],!0,function(a,b,c){var d=(a("6"),this||self,{}.toString);return c.exports=function(a){return d.call(a).slice(8,-1)},c.exports}),a.registerDynamic("f",["a","6"],!0,function(a,b,c){var d=(a("6"),this||self,a("a"));return c.exports=Array.isArray||function(a){return"Array"==d(a)},c.exports}),a.registerDynamic("10",["11","f","12","6"],!0,function(a,b,c){var d=(a("6"),this||self,a("11")),e=a("f"),f=a("12")("species");return c.exports=function(a){var b;return e(a)&&(b=a.constructor,"function"!=typeof b||b!==Array&&!e(b.prototype)||(b=void 0),d(b)&&null===(b=b[f])&&(b=void 0)),void 0===b?Array:b},c.exports}),a.registerDynamic("13",["10","6"],!0,function(a,b,c){var d=(a("6"),this||self,a("10"));return c.exports=function(a,b){return new(d(a))(b)},c.exports}),a.registerDynamic("4",["14","9","c","e","13","6"],!0,function(a,b,c){var d=(a("6"),this||self,a("14")),e=a("9"),f=a("c"),g=a("e"),h=a("13");return c.exports=function(a,b){var c=1==a,i=2==a,j=3==a,k=4==a,l=6==a,m=5==a||l,n=b||h;return function(b,h,o){for(var p,q,r=f(b),s=e(r),t=d(h,o,3),u=g(s.length),v=0,w=c?n(b,u):i?n(b,0):void 0;u>v;v++)if((m||v in s)&&(p=s[v],q=t(p,v,r),a))if(c)w[v]=q;else if(q)switch(a){case 3:return!0;case 5:return p;case 6:return v;case 2:w.push(p)}else if(k)return!1;return l?-1:j||k?k:w}},c.exports}),a.registerDynamic("15",["16","6"],!0,function(a,b,c){var d=(a("6"),this||self),d=a("16"),e="__core-js_shared__",f=d[e]||(d[e]={});return c.exports=function(a){return f[a]||(f[a]={})},c.exports}),a.registerDynamic("12",["15","17","16","6"],!0,function(a,b,c){var d=(a("6"),this||self,a("15")("wks")),e=a("17"),f=a("16").Symbol,g="function"==typeof f;return(c.exports=function(a){return d[a]||(d[a]=g&&f[a]||(g?f:e)("Symbol."+a))}).store=d,c.exports}),a.registerDynamic("5",["12","18","6"],!0,function(a,b,c){var d=(a("6"),this||self,a("12")("unscopables")),e=Array.prototype;return void 0==e[d]&&a("18")(e,d,{}),c.exports=function(a){e[d][a]=!0},c.exports}),a.registerDynamic("19",["3","4","5","6"],!0,function(a,b,c){"use strict";var d=(a("6"),this||self,a("3")),e=a("4")(6),f="findIndex",g=!0;return f in[]&&Array(1)[f](function(){g=!1}),d(d.P+d.F*g,"Array",{findIndex:function(a){return e(this,a,arguments.length>1?arguments[1]:void 0)}}),a("5")(f),c.exports}),a.registerDynamic("1a",["19","8","6"],!0,function(a,b,c){a("6"),this||self;return a("19"),c.exports=a("8").Array.findIndex,c.exports}),a.registerDynamic("1b",["11","6"],!0,function(a,b,c){var d=(a("6"),this||self,a("11"));return c.exports=function(a){if(!d(a))throw TypeError(a+" is not an object!");return a},c.exports}),a.registerDynamic("16",["6"],!0,function(a,b,c){var d=(a("6"),this||self),d=c.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();return"number"==typeof __g&&(__g=d),c.exports}),a.registerDynamic("1c",["11","16","6"],!0,function(a,b,c){var d=(a("6"),this||self,a("11")),e=a("16").document,f=d(e)&&d(e.createElement);return c.exports=function(a){return f?e.createElement(a):{}},c.exports}),a.registerDynamic("1d",["1e","1f","1c","6"],!0,function(a,b,c){a("6"),this||self;return c.exports=!a("1e")&&!a("1f")(function(){return 7!=Object.defineProperty(a("1c")("div"),"a",{get:function(){return 7}}).a}),c.exports}),a.registerDynamic("20",["11","6"],!0,function(a,b,c){var d=(a("6"),this||self,a("11"));return c.exports=function(a,b){if(!d(a))return a;var c,e;if(b&&"function"==typeof(c=a.toString)&&!d(e=c.call(a)))return e;if("function"==typeof(c=a.valueOf)&&!d(e=c.call(a)))return e;if(!b&&"function"==typeof(c=a.toString)&&!d(e=c.call(a)))return e;throw TypeError("Can't convert object to primitive value")},c.exports}),a.registerDynamic("21",["1b","1d","20","1e","6"],!0,function(a,b,c){var d=(a("6"),this||self,a("1b")),e=a("1d"),f=a("20"),g=Object.defineProperty;return b.f=a("1e")?Object.defineProperty:function(a,b,c){if(d(a),b=f(b,!0),d(c),e)try{return g(a,b,c)}catch(a){}if("get"in c||"set"in c)throw TypeError("Accessors not supported!");return"value"in c&&(a[b]=c.value),a},c.exports}),a.registerDynamic("22",["6"],!0,function(a,b,c){a("6"),this||self;return c.exports=function(a,b){return{enumerable:!(1&a),configurable:!(2&a),writable:!(4&a),value:b}},c.exports}),a.registerDynamic("1f",["6"],!0,function(a,b,c){a("6"),this||self;return c.exports=function(a){try{return!!a()}catch(a){return!0}},c.exports}),a.registerDynamic("1e",["1f","6"],!0,function(a,b,c){a("6"),this||self;return c.exports=!a("1f")(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a}),c.exports}),a.registerDynamic("18",["21","22","1e","6"],!0,function(a,b,c){var d=(a("6"),this||self,a("21")),e=a("22");return c.exports=a("1e")?function(a,b,c){return d.f(a,b,e(1,c))}:function(a,b,c){return a[b]=c,a},c.exports}),a.registerDynamic("23",["6"],!0,function(a,b,c){var d=(a("6"),this||self,{}.hasOwnProperty);return c.exports=function(a,b){return d.call(a,b)},c.exports}),a.registerDynamic("17",["6"],!0,function(a,b,c){var d=(a("6"),this||self,0),e=Math.random();return c.exports=function(a){return"Symbol(".concat(void 0===a?"":a,")_",(++d+e).toString(36))},c.exports}),a.registerDynamic("24",["16","18","23","17","8","6"],!0,function(a,b,c){var d=(a("6"),this||self),d=a("16"),e=a("18"),f=a("23"),g=a("17")("src"),h="toString",i=Function[h],j=(""+i).split(h);return a("8").inspectSource=function(a){return i.call(a)},(c.exports=function(a,b,c,h){var i="function"==typeof c;i&&(f(c,"name")||e(c,"name",b)),a[b]!==c&&(i&&(f(c,g)||e(c,g,a[b]?""+a[b]:j.join(String(b)))),a===d?a[b]=c:h?a[b]?a[b]=c:e(a,b,c):(delete a[b],e(a,b,c)))})(Function.prototype,h,function(){return"function"==typeof this&&this[g]||i.call(this)}),c.exports}),a.registerDynamic("25",["6"],!0,function(a,b,c){a("6"),this||self;return c.exports=function(a){if("function"!=typeof a)throw TypeError(a+" is not a function!");return a},c.exports}),a.registerDynamic("14",["25","6"],!0,function(a,b,c){var d=(a("6"),this||self,a("25"));return c.exports=function(a,b,c){if(d(a),void 0===b)return a;switch(c){case 1:return function(c){return a.call(b,c)};case 2:return function(c,d){return a.call(b,c,d)};case 3:return function(c,d,e){return a.call(b,c,d,e)}}return function(){return a.apply(b,arguments)}},c.exports}),a.registerDynamic("3",["16","8","18","24","14","6"],!0,function(a,b,c){var d=(a("6"),this||self),d=a("16"),e=a("8"),f=a("18"),g=a("24"),h=a("14"),i="prototype",j=function(a,b,c){var k,l,m,n,o=a&j.F,p=a&j.G,q=a&j.S,r=a&j.P,s=a&j.B,t=p?d:q?d[b]||(d[b]={}):(d[b]||{})[i],u=p?e:e[b]||(e[b]={}),v=u[i]||(u[i]={});p&&(c=b);for(k in c)l=!o&&t&&void 0!==t[k],m=(l?t:c)[k],n=s&&l?h(m,d):r&&"function"==typeof m?h(Function.call,m):m,t&&g(t,k,m,a&j.U),u[k]!=m&&f(u,k,n),r&&v[k]!=m&&(v[k]=m)};return d.core=e,j.F=1,j.G=2,j.S=4,j.P=8,j.B=16,j.W=32,j.U=64,j.R=128,c.exports=j,c.exports}),a.registerDynamic("11",["6"],!0,function(a,b,c){a("6"),this||self;return c.exports=function(a){return"object"==typeof a?null!==a:"function"==typeof a},c.exports}),a.registerDynamic("26",["11","6"],!0,function(a,b,c){var d=(a("6"),this||self,a("11")),e=Math.floor;return c.exports=function(a){return!d(a)&&isFinite(a)&&e(a)===a},c.exports}),a.registerDynamic("27",["3","26","6"],!0,function(a,b,c){var d=(a("6"),this||self,a("3"));return d(d.S,"Number",{isInteger:a("26")}),c.exports}),a.registerDynamic("8",["6"],!0,function(a,b,c){var d=(a("6"),this||self,c.exports={version:"2.5.1"});return"number"==typeof __e&&(__e=d),c.exports}),a.registerDynamic("@system-env",[],!1,function(){return{production:!0,browser:!0,node:!1,dev:!1,default:!0}}),a.registerDynamic("6",["@system-env"],!0,function(a,b,c){function d(){l=!1,h.length?k=h.concat(k):m=-1,k.length&&e()}function e(){if(!l){var a=setTimeout(d);l=!0;for(var b=k.length;b;){for(h=k,k=[];++m<b;)h&&h[m].run();m=-1,b=k.length}h=null,l=!1,clearTimeout(a)}}function f(a,b){this.fun=a,this.array=b}function g(){}var h,i=(this||self,a("@system-env").production),j=c.exports={},k=[],l=!1,m=-1;return j.nextTick=function(a){var b=new Array(arguments.length-1);if(arguments.length>1)for(var c=1;c<arguments.length;c++)b[c-1]=arguments[c];k.push(new f(a,b)),1!==k.length||l||setTimeout(e,0)},f.prototype.run=function(){this.fun.apply(null,this.array)},j.title="browser",j.browser=!0,j.env={NODE_ENV:i?"production":"development"},j.argv=[],j.version="",j.versions={},j.on=g,j.addListener=g,j.once=g,j.off=g,j.removeListener=g,j.removeAllListeners=g,j.emit=g,j.binding=function(a){throw new Error("process.binding is not supported")},j.cwd=function(){return"/"},j.chdir=function(a){throw new Error("process.chdir is not supported")},j.umask=function(){return 0},c.exports}),a.registerDynamic("28",["27","8","6"],!0,function(a,b,c){a("6"),this||self;return a("27"),c.exports=a("8").Number.isInteger,c.exports}),a.registerDynamic("29",[],!0,function(a,b,c){var d,e=(this||self,function(a){"use strict";function b(a,c){return void 0===a?b[0]:void 0!==c?10==+c?R(a):aa(a,c):R(a)}function c(a,b){this.value=a,this.sign=b,this.isSmall=!1}function d(a){this.value=a,this.sign=a<0,this.isSmall=!0}function f(a){return-U<a&&a<U}function g(a){return a<1e7?[a]:a<1e14?[a%1e7,Math.floor(a/1e7)]:[a%1e7,Math.floor(a/1e7)%1e7,Math.floor(a/1e14)]}function h(a){i(a);var b=a.length;if(b<4&&C(a,V)<0)switch(b){case 0:return 0;case 1:return a[0];case 2:return a[0]+a[1]*S;default:return a[0]+(a[1]+a[2]*S)*S}return a}function i(a){for(var b=a.length;0===a[--b];);a.length=b+1}function j(a){for(var b=new Array(a),c=-1;++c<a;)b[c]=0;return b}function k(a){return a>0?Math.floor(a):Math.ceil(a)}function l(a,b){var c,d,e=a.length,f=b.length,g=new Array(e),h=0,i=S;for(d=0;d<f;d++)c=a[d]+b[d]+h,h=c>=i?1:0,g[d]=c-h*i;for(;d<e;)c=a[d]+h,h=c===i?1:0,g[d++]=c-h*i;return h>0&&g.push(h),g}function m(a,b){return a.length>=b.length?l(a,b):l(b,a)}function n(a,b){var c,d,e=a.length,f=new Array(e),g=S;for(d=0;d<e;d++)c=a[d]-g+b,b=Math.floor(c/g),f[d]=c-b*g,b+=1;for(;b>0;)f[d++]=b%g,b=Math.floor(b/g);return f}function o(a,b){var c,d,e=a.length,f=b.length,g=new Array(e),h=0,j=S;for(c=0;c<f;c++)d=a[c]-h-b[c],d<0?(d+=j,h=1):h=0,g[c]=d;for(c=f;c<e;c++){if(!((d=a[c]-h)<0)){g[c++]=d;break}d+=j,g[c]=d}for(;c<e;c++)g[c]=a[c];return i(g),g}function p(a,b,e){var f;return C(a,b)>=0?f=o(a,b):(f=o(b,a),e=!e),f=h(f),"number"==typeof f?(e&&(f=-f),new d(f)):new c(f,e)}function q(a,b,e){var f,g,i=a.length,j=new Array(i),k=-b,l=S;for(f=0;f<i;f++)g=a[f]+k,k=Math.floor(g/l),g%=l,j[f]=g<0?g+l:g;return j=h(j),"number"==typeof j?(e&&(j=-j),new d(j)):new c(j,e)}function r(a,b){var c,d,e,f,g,h=a.length,k=b.length,l=h+k,m=j(l),n=S;for(e=0;e<h;++e){f=a[e];for(var o=0;o<k;++o)g=b[o],c=f*g+m[e+o],d=Math.floor(c/n),m[e+o]=c-d*n,m[e+o+1]+=d}return i(m),m}function s(a,b){var c,d,e=a.length,f=new Array(e),g=S,h=0;for(d=0;d<e;d++)c=a[d]*b+h,h=Math.floor(c/g),f[d]=c-h*g;for(;h>0;)f[d++]=h%g,h=Math.floor(h/g);return f}function t(a,b){for(var c=[];b-- >0;)c.push(0);return c.concat(a)}function u(a,b){var c=Math.max(a.length,b.length);if(c<=30)return r(a,b);c=Math.ceil(c/2);var d=a.slice(c),e=a.slice(0,c),f=b.slice(c),g=b.slice(0,c),h=u(e,g),j=u(d,f),k=u(m(e,d),m(g,f)),l=m(m(h,t(o(o(k,h),j),c)),t(j,2*c));return i(l),l}function v(a,b){return-.012*a-.012*b+15e-6*a*b>0}function w(a,b,d){return a<S?new c(s(b,a),d):new c(r(b,g(a)),d)}function x(a){var b,c,d,e,f,g=a.length,h=j(g+g),k=S;for(d=0;d<g;d++){e=a[d];for(var l=0;l<g;l++)f=a[l],b=e*f+h[d+l],c=Math.floor(b/k),h[d+l]=b-c*k,h[d+l+1]+=c}return i(h),h}function y(a,b){var c,d,e,f,g,i,k,l=a.length,m=b.length,n=S,o=j(b.length),p=b[m-1],q=Math.ceil(n/(2*p)),r=s(a,q),t=s(b,q);for(r.length<=l&&r.push(0),t.push(0),p=t[m-1],d=l-m;d>=0;d--){for(c=n-1,r[d+m]!==p&&(c=Math.floor((r[d+m]*n+r[d+m-1])/p)),e=0,f=0,i=t.length,g=0;g<i;g++)e+=c*t[g],k=Math.floor(e/n),f+=r[d+g]-(e-k*n),e=k,f<0?(r[d+g]=f+n,f=-1):(r[d+g]=f,f=0);for(;0!==f;){for(c-=1,e=0,g=0;g<i;g++)e+=r[d+g]-n+t[g],e<0?(r[d+g]=e+n,e=0):(r[d+g]=e,e=1);f+=e}o[d]=c}return r=A(r,q)[0],[h(o),h(r)]}function z(a,b){for(var c,d,e,f,g,j=a.length,k=b.length,l=[],m=[],n=S;j;)if(m.unshift(a[--j]),i(m),C(m,b)<0)l.push(0);else{d=m.length,e=m[d-1]*n+m[d-2],f=b[k-1]*n+b[k-2],d>k&&(e=(e+1)*n),c=Math.ceil(e/f);do{if(g=s(b,c),C(g,m)<=0)break;c--}while(c);l.push(c),m=o(m,g)}return l.reverse(),[h(l),h(m)]}function A(a,b){var c,d,e,f,g=a.length,h=j(g),i=S;for(e=0,c=g-1;c>=0;--c)f=e*i+a[c],d=k(f/b),e=f-d*b,h[c]=0|d;return[h,0|e]}function B(a,e){var f,i,j=R(e),l=a.value,m=j.value;if(0===m)throw new Error("Cannot divide by zero");if(a.isSmall)return j.isSmall?[new d(k(l/m)),new d(l%m)]:[b[0],a];if(j.isSmall){if(1===m)return[a,b[0]];if(-1==m)return[a.negate(),b[0]];var n=Math.abs(m);if(n<S){f=A(l,n),i=h(f[0]);var o=f[1];return a.sign&&(o=-o),"number"==typeof i?(a.sign!==j.sign&&(i=-i),[new d(i),new d(o)]):[new c(i,a.sign!==j.sign),new d(o)]}m=g(n)}var p=C(l,m);if(-1===p)return[b[0],a];if(0===p)return[b[a.sign===j.sign?1:-1],b[0]];f=l.length+m.length<=200?y(l,m):z(l,m),i=f[0];var q=a.sign!==j.sign,r=f[1],s=a.sign;return"number"==typeof i?(q&&(i=-i),i=new d(i)):i=new c(i,q),"number"==typeof r?(s&&(r=-r),r=new d(r)):r=new c(r,s),[i,r]}function C(a,b){if(a.length!==b.length)return a.length>b.length?1:-1;for(var c=a.length-1;c>=0;c--)if(a[c]!==b[c])return a[c]>b[c]?1:-1;return 0}function D(a){var b=a.abs();return!b.isUnit()&&(!!(b.equals(2)||b.equals(3)||b.equals(5))||!(b.isEven()||b.isDivisibleBy(3)||b.isDivisibleBy(5))&&(!!b.lesser(25)||void 0))}function E(a){return("number"==typeof a||"string"==typeof a)&&+Math.abs(a)<=S||a instanceof c&&a.value.length<=1}function F(a,b,c){b=R(b);for(var d=a.isNegative(),f=b.isNegative(),g=d?a.not():a,h=f?b.not():b,i=0,j=0,k=null,l=null,m=[];!g.isZero()||!h.isZero();)k=B(g,Z),i=k[1].toJSNumber(),d&&(i=Z-1-i),l=B(h,Z),j=l[1].toJSNumber(),f&&(j=Z-1-j),g=k[0],h=l[0],m.push(c(i,j));for(var n=e(0!==c(d?1:0,f?1:0)?-1:0),o=m.length-1;o>=0;o-=1)n=n.multiply(Z).add(e(m[o]));return n}function G(a){var b=a.value,c="number"==typeof b?b|$:b[0]+b[1]*S|_;return c&-c}function H(a,b){return a=R(a),b=R(b),a.greater(b)?a:b}function I(a,b){return a=R(a),b=R(b),a.lesser(b)?a:b}function J(a,c){if(a=R(a).abs(),c=R(c).abs(),a.equals(c))return a;if(a.isZero())return c;if(c.isZero())return a;for(var d,e,f=b[1];a.isEven()&&c.isEven();)d=Math.min(G(a),G(c)),a=a.divide(d),c=c.divide(d),f=f.multiply(d);for(;a.isEven();)a=a.divide(G(a));do{for(;c.isEven();)c=c.divide(G(c));a.greater(c)&&(e=c,c=a,a=e),c=c.subtract(a)}while(!c.isZero());return f.isUnit()?a:a.multiply(f)}function K(a,b){return a=R(a).abs(),b=R(b).abs(),a.divide(J(a,b)).multiply(b)}function L(a,b){a=R(a),b=R(b);var e=I(a,b),f=H(a,b),g=f.subtract(e).add(1);if(g.isSmall)return e.add(Math.floor(Math.random()*g));for(var i=g.value.length-1,j=[],l=!0,m=i;m>=0;m--){var n=l?g.value[m]:S,o=k(Math.random()*n);j.unshift(o),o<n&&(l=!1)}return j=h(j),e.add("number"==typeof j?new d(j):new c(j,!1))}function M(a,c,d){var e,f=b[0],g=b[1];for(e=a.length-1;e>=0;e--)f=f.add(a[e].times(g)),g=g.times(c);return d?f.negate():f}function N(a){var b=a.value;return"number"==typeof b&&(b=[b]),1===b.length&&b[0]<=35?"0123456789abcdefghijklmnopqrstuvwxyz".charAt(b[0]):"<"+b+">"}function O(a,b){if(b=e(b),b.isZero()){if(a.isZero())return"0";throw new Error("Cannot convert nonzero numbers to base 0.")}if(b.equals(-1))return a.isZero()?"0":a.isNegative()?new Array(1-a).join("10"):"1"+new Array(+a).join("01");var c="";if(a.isNegative()&&b.isPositive()&&(c="-",a=a.abs()),b.equals(1))return a.isZero()?"0":c+new Array(+a+1).join(1);for(var d,f=[],g=a;g.isNegative()||g.compareAbs(b)>=0;){d=g.divmod(b),g=d.quotient;var h=d.remainder;h.isNegative()&&(h=b.minus(h).abs(),g=g.next()),f.push(N(h))}return f.push(N(g)),c+f.reverse().join("")}function P(a){if(f(+a)){var b=+a;if(b===k(b))return new d(b);throw"Invalid integer: "+a}var e="-"===a[0];e&&(a=a.slice(1));var g=a.split(/e/i);if(g.length>2)throw new Error("Invalid integer: "+g.join("e"));if(2===g.length){var h=g[1];if("+"===h[0]&&(h=h.slice(1)),(h=+h)!==k(h)||!f(h))throw new Error("Invalid integer: "+h+" is not a valid exponent.");var j=g[0],l=j.indexOf(".");if(l>=0&&(h-=j.length-l-1,j=j.slice(0,l)+j.slice(l+1)),h<0)throw new Error("Cannot include negative exponent part for integers");j+=new Array(h+1).join("0"),a=j}if(!/^([0-9][0-9]*)$/.test(a))throw new Error("Invalid integer: "+a);for(var m=[],n=a.length,o=T,p=n-o;n>0;)m.push(+a.slice(p,n)),p-=o,p<0&&(p=0),n-=o;return i(m),new c(m,e)}function Q(a){if(f(a)){if(a!==k(a))throw new Error(a+" is not an integer.");return new d(a)}return P(a.toString())}function R(a){return"number"==typeof a?Q(a):"string"==typeof a?P(a):a}var S=1e7,T=7,U=9007199254740992,V=g(U),W=Math.log(U);c.prototype=Object.create(b.prototype),d.prototype=Object.create(b.prototype),c.prototype.add=function(a){var b=R(a);if(this.sign!==b.sign)return this.subtract(b.negate());var d=this.value,e=b.value;return b.isSmall?new c(n(d,Math.abs(e)),this.sign):new c(m(d,e),this.sign)},c.prototype.plus=c.prototype.add,d.prototype.add=function(a){var b=R(a),e=this.value;if(e<0!==b.sign)return this.subtract(b.negate());var h=b.value;if(b.isSmall){if(f(e+h))return new d(e+h);h=g(Math.abs(h))}return new c(n(h,Math.abs(e)),e<0)},d.prototype.plus=d.prototype.add,c.prototype.subtract=function(a){var b=R(a);if(this.sign!==b.sign)return this.add(b.negate());var c=this.value,d=b.value;return b.isSmall?q(c,Math.abs(d),this.sign):p(c,d,this.sign)},c.prototype.minus=c.prototype.subtract,d.prototype.subtract=function(a){var b=R(a),c=this.value;if(c<0!==b.sign)return this.add(b.negate());var e=b.value;return b.isSmall?new d(c-e):q(e,Math.abs(c),c>=0)},d.prototype.minus=d.prototype.subtract,c.prototype.negate=function(){return new c(this.value,!this.sign)},d.prototype.negate=function(){var a=this.sign,b=new d(-this.value);return b.sign=!a,b},c.prototype.abs=function(){return new c(this.value,!1)},d.prototype.abs=function(){return new d(Math.abs(this.value))},c.prototype.multiply=function(a){var d,e=R(a),f=this.value,h=e.value,i=this.sign!==e.sign;if(e.isSmall){if(0===h)return b[0];if(1===h)return this;if(-1===h)return this.negate();if((d=Math.abs(h))<S)return new c(s(f,d),i);h=g(d)}return v(f.length,h.length)?new c(u(f,h),i):new c(r(f,h),i)},c.prototype.times=c.prototype.multiply,d.prototype._multiplyBySmall=function(a){return f(a.value*this.value)?new d(a.value*this.value):w(Math.abs(a.value),g(Math.abs(this.value)),this.sign!==a.sign)},c.prototype._multiplyBySmall=function(a){return 0===a.value?b[0]:1===a.value?this:-1===a.value?this.negate():w(Math.abs(a.value),this.value,this.sign!==a.sign)},d.prototype.multiply=function(a){return R(a)._multiplyBySmall(this)},d.prototype.times=d.prototype.multiply,c.prototype.square=function(){return new c(x(this.value),!1)},d.prototype.square=function(){var a=this.value*this.value;return f(a)?new d(a):new c(x(g(Math.abs(this.value))),!1)},c.prototype.divmod=function(a){var b=B(this,a);return{quotient:b[0],remainder:b[1]}},d.prototype.divmod=c.prototype.divmod,c.prototype.divide=function(a){return B(this,a)[0]},d.prototype.over=d.prototype.divide=c.prototype.over=c.prototype.divide,c.prototype.mod=function(a){return B(this,a)[1]},d.prototype.remainder=d.prototype.mod=c.prototype.remainder=c.prototype.mod,c.prototype.pow=function(a){var c,e,g,h=R(a),i=this.value,j=h.value;if(0===j)return b[1];if(0===i)return b[0];if(1===i)return b[1];if(-1===i)return h.isEven()?b[1]:b[-1];if(h.sign)return b[0];if(!h.isSmall)throw new Error("The exponent "+h.toString()+" is too large.");if(this.isSmall&&f(c=Math.pow(i,j)))return new d(k(c));for(e=this,g=b[1];;){if(!0&j&&(g=g.times(e),--j),0===j)break;j/=2,e=e.square()}return g},d.prototype.pow=c.prototype.pow,c.prototype.modPow=function(a,c){if(a=R(a),c=R(c),c.isZero())throw new Error("Cannot take modPow with modulus 0");for(var d=b[1],e=this.mod(c);a.isPositive();){if(e.isZero())return b[0];a.isOdd()&&(d=d.multiply(e).mod(c)),a=a.divide(2),e=e.square().mod(c)}return d},d.prototype.modPow=c.prototype.modPow,c.prototype.compareAbs=function(a){var b=R(a),c=this.value,d=b.value;return b.isSmall?1:C(c,d)},d.prototype.compareAbs=function(a){var b=R(a),c=Math.abs(this.value),d=b.value;return b.isSmall?(d=Math.abs(d),c===d?0:c>d?1:-1):-1},c.prototype.compare=function(a){if(a===1/0)return-1;if(a===-1/0)return 1;var b=R(a),c=this.value,d=b.value;return this.sign!==b.sign?b.sign?1:-1:b.isSmall?this.sign?-1:1:C(c,d)*(this.sign?-1:1)},c.prototype.compareTo=c.prototype.compare,d.prototype.compare=function(a){if(a===1/0)return-1;if(a===-1/0)return 1;var b=R(a),c=this.value,d=b.value;return b.isSmall?c==d?0:c>d?1:-1:c<0!==b.sign?c<0?-1:1:c<0?1:-1},d.prototype.compareTo=d.prototype.compare,c.prototype.equals=function(a){return 0===this.compare(a)},d.prototype.eq=d.prototype.equals=c.prototype.eq=c.prototype.equals,c.prototype.notEquals=function(a){return 0!==this.compare(a)},d.prototype.neq=d.prototype.notEquals=c.prototype.neq=c.prototype.notEquals,c.prototype.greater=function(a){return this.compare(a)>0},d.prototype.gt=d.prototype.greater=c.prototype.gt=c.prototype.greater,c.prototype.lesser=function(a){return this.compare(a)<0},d.prototype.lt=d.prototype.lesser=c.prototype.lt=c.prototype.lesser,c.prototype.greaterOrEquals=function(a){return this.compare(a)>=0},d.prototype.geq=d.prototype.greaterOrEquals=c.prototype.geq=c.prototype.greaterOrEquals,c.prototype.lesserOrEquals=function(a){return this.compare(a)<=0},d.prototype.leq=d.prototype.lesserOrEquals=c.prototype.leq=c.prototype.lesserOrEquals,c.prototype.isEven=function(){return 0==(1&this.value[0])},d.prototype.isEven=function(){return 0==(1&this.value)},c.prototype.isOdd=function(){return 1==(1&this.value[0])},d.prototype.isOdd=function(){return 1==(1&this.value)},c.prototype.isPositive=function(){return!this.sign},d.prototype.isPositive=function(){return this.value>0},c.prototype.isNegative=function(){return this.sign},d.prototype.isNegative=function(){return this.value<0},c.prototype.isUnit=function(){return!1},d.prototype.isUnit=function(){return 1===Math.abs(this.value)},c.prototype.isZero=function(){return!1},d.prototype.isZero=function(){return 0===this.value},c.prototype.isDivisibleBy=function(a){var c=R(a),d=c.value;return 0!==d&&(1===d||(2===d?this.isEven():this.mod(c).equals(b[0])))},d.prototype.isDivisibleBy=c.prototype.isDivisibleBy,c.prototype.isPrime=function(){var c=D(this);if(c!==a)return c;for(var d,f,g,h,i=this.abs(),j=i.prev(),k=[2,3,5,7,11,13,17,19],l=j;l.isEven();)l=l.divide(2);for(g=0;g<k.length;g++)if(h=e(k[g]).modPow(l,i),!h.equals(b[1])&&!h.equals(j)){for(f=!0,d=l;f&&d.lesser(j);d=d.multiply(2))h=h.square().mod(i),h.equals(j)&&(f=!1);if(f)return!1}return!0},d.prototype.isPrime=c.prototype.isPrime,c.prototype.isProbablePrime=function(b){var c=D(this);if(c!==a)return c;for(var d=this.abs(),f=b===a?5:b,g=0;g<f;g++){if(!e.randBetween(2,d.minus(2)).modPow(d.prev(),d).isUnit())return!1}return!0},d.prototype.isProbablePrime=c.prototype.isProbablePrime,c.prototype.modInv=function(a){for(var b,c,d,f=e.zero,g=e.one,h=R(a),i=this.abs();!i.equals(e.zero);)b=h.divide(i),c=f,d=h,f=g,h=i,g=c.subtract(b.multiply(g)),i=d.subtract(b.multiply(i));if(!h.equals(1))throw new Error(this.toString()+" and "+a.toString()+" are not co-prime");return-1===f.compare(0)&&(f=f.add(a)),this.isNegative()?f.negate():f},d.prototype.modInv=c.prototype.modInv,c.prototype.next=function(){var a=this.value;return this.sign?q(a,1,this.sign):new c(n(a,1),this.sign)},d.prototype.next=function(){var a=this.value;return a+1<U?new d(a+1):new c(V,!1)},c.prototype.prev=function(){var a=this.value;return this.sign?new c(n(a,1),!0):q(a,1,this.sign)},d.prototype.prev=function(){var a=this.value;return a-1>-U?new d(a-1):new c(V,!0)};for(var X=[1];2*X[X.length-1]<=S;)X.push(2*X[X.length-1]);var Y=X.length,Z=X[Y-1];c.prototype.shiftLeft=function(a){if(!E(a))throw new Error(String(a)+" is too large for shifting.");if((a=+a)<0)return this.shiftRight(-a);for(var b=this;a>=Y;)b=b.multiply(Z),a-=Y-1;return b.multiply(X[a])},d.prototype.shiftLeft=c.prototype.shiftLeft,c.prototype.shiftRight=function(a){var b;if(!E(a))throw new Error(String(a)+" is too large for shifting.");if((a=+a)<0)return this.shiftLeft(-a);for(var c=this;a>=Y;){if(c.isZero())return c;b=B(c,Z),c=b[1].isNegative()?b[0].prev():b[0],a-=Y-1}return b=B(c,X[a]),b[1].isNegative()?b[0].prev():b[0]},d.prototype.shiftRight=c.prototype.shiftRight,c.prototype.not=function(){return this.negate().prev()},d.prototype.not=c.prototype.not,c.prototype.and=function(a){return F(this,a,function(a,b){return a&b})},d.prototype.and=c.prototype.and,c.prototype.or=function(a){return F(this,a,function(a,b){return a|b})},d.prototype.or=c.prototype.or,c.prototype.xor=function(a){return F(this,a,function(a,b){return a^b})},d.prototype.xor=c.prototype.xor;var $=1<<30,_=(S&-S)*(S&-S)|$,aa=function(a,b){for(var c,e=a.length,f=Math.abs(b),c=0;c<e;c++){var g=a[c].toLowerCase();if("-"!==g&&/[a-z0-9]/.test(g)){if(/[0-9]/.test(g)&&+g>=f){if("1"===g&&1===f)continue;throw new Error(g+" is not a valid digit in base "+b+".")}if(g.charCodeAt(0)-87>=f)throw new Error(g+" is not a valid digit in base "+b+".")}}if(2<=b&&b<=36&&e<=W/Math.log(b)){var h=parseInt(a,b);if(isNaN(h))throw new Error(g+" is not a valid digit in base "+b+".");return new d(parseInt(a,b))}b=R(b);var i=[],j="-"===a[0];for(c=j?1:0;c<a.length;c++){var g=a[c].toLowerCase(),k=g.charCodeAt(0);if(48<=k&&k<=57)i.push(R(g));else if(97<=k&&k<=122)i.push(R(g.charCodeAt(0)-87));else{if("<"!==g)throw new Error(g+" is not a valid character");var l=c;do{c++}while(">"!==a[c]);i.push(R(a.slice(l+1,c)))}}return M(i,b,j)};c.prototype.toString=function(b){if(b===a&&(b=10),10!==b)return O(this,b);for(var c,d=this.value,e=d.length,f=String(d[--e]),g="0000000";--e>=0;)c=String(d[e]),f+=g.slice(c.length)+c;return(this.sign?"-":"")+f},d.prototype.toString=function(b){return b===a&&(b=10),10!=b?O(this,b):String(this.value)},c.prototype.toJSON=d.prototype.toJSON=function(){return this.toString()},c.prototype.valueOf=function(){return+this.toString()},c.prototype.toJSNumber=c.prototype.valueOf,d.prototype.valueOf=function(){return this.value},d.prototype.toJSNumber=d.prototype.valueOf;for(var ba=0;ba<1e3;ba++)b[ba]=new d(ba),ba>0&&(b[-ba]=new d(-ba));return b.one=b[1],b.zero=b[0],b.minusOne=b[-1],b.max=H,b.min=I,b.gcd=J,b.lcm=K,b.isInstance=function(a){return a instanceof c||a instanceof d},b.randBetween=L,b.fromArray=function(a,b,c){return M(a.map(R),R(b||10),c)},b}());return void 0!==c&&c.hasOwnProperty("exports")&&(c.exports=e),"function"==typeof d&&d.amd&&d("big-integer",[],function(){return e}),c.exports}),a.registerDynamic("2a",["29"],!0,function(a,b,c){this||self;return function(){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,$,_,aa,ba,ca,da,ea,fa,ga,ha,ia,ja,ka,la,ma,na,oa,pa,qa,ra,sa,ta,ua,va,wa,xa,ya,za,Aa,Ba,Ca,Da,Ea,Fa,Ga,Ha,Ia,Ja,Ka,La,Ma,Na,Oa,Pa,Qa,Ra,Sa,Ta,Ua,Va,Wa,Xa,Ya,Za,$a,_a,ab,bb,cb,db,eb,fb,gb,hb,ib,jb,kb,lb,mb,nb,ob,pb,qb,rb,sb,tb,ub,vb,wb,xb,yb,zb,Ab,Bb,Cb,Db,Eb,Fb,Gb,Hb,Ib,Jb,Kb,Lb,Mb,Nb,Ob,Pb,Qb,Rb,Sb,Tb,Ub,Vb,Wb,Xb,Yb,Zb,$b,_b,ac,bc,cc,dc,ec,fc,gc,hc,ic,jc,kc,lc,mc,nc,oc,pc,qc,rc,sc,tc,uc,vc,wc,xc,yc,zc,Ac,Bc,Cc,Dc,Ec,Fc,Gc,Hc,Ic,Jc,Kc,Lc,Mc,Nc,Oc,Pc,Qc,Rc,Sc,Tc,Uc,Vc,Wc,Xc,Yc,Zc,$c,_c,ad,bd,cd,dd,ed,fd,gd,hd,id,jd,kd,ld,md,nd,od,pd,qd,rd,sd,td,ud,vd,wd,xd,yd,zd,Ad,Bd,Cd,Dd,Ed,Fd,Gd,Hd,Id,Jd,Kd,Ld,Md,Nd,Od,Pd,Qd,Rd,Sd,Td,Ud,Vd,Wd,Xd,Yd,Zd,$d,_d,ae,be,ce,de,ee,fe,ge,he,ie,je,ke,le,me,ne,oe,pe,qe,re,se,te,ue,ve,we,xe,ye,ze,Ae,Be,Ce,De,Ee,Fe,Ge,He,Ie,Je,Ke,Le,Me,Ne,Oe,Pe,Qe,Re,Se,Te,Ue,Ve,We,Xe,Ye,Ze,$e,_e,af,bf,cf,df,ef,ff,gf,hf,jf,kf,lf,mf,nf,of,pf,qf,rf,sf,tf,uf,vf,wf,xf,yf,zf,Af,Bf,Cf,Df,Ef,Ff,Gf,Hf,If,Jf,Kf,Lf,Mf,Nf,Of,Pf,Qf,Rf,Sf,Tf,Uf,Vf,Wf,Xf,Yf,Zf,$f,_f,ag,bg,cg,dg,eg,fg,gg,hg,ig,jg,kg,lg,mg,ng,og,pg,qg,rg,sg,tg,ug,vg,wg,xg,yg,zg,Ag,Bg,Cg,Dg,Eg,Fg,Gg,Hg,Ig,Jg,Kg,Lg,Mg,Ng,Og,Pg,Qg,Rg,Sg,Tg,Ug,Vg,Wg,Xg,Yg,Zg,$g,_g,ah,bh,ch,dh,eh,fh,gh,hh,ih,jh,kh,lh,mh,nh,oh,ph,qh,rh,sh,th,uh,vh,wh,xh,yh,zh,Ah,Bh,Ch,Dh,Eh,Fh,Gh,Hh,Ih,Jh,Kh,Lh,Mh,Nh,Oh,Ph,Qh,Rh,Sh,Th,Uh,Vh,Wh,Xh,Yh,Zh,$h,_h,ai,bi,ci,di,ei,fi,gi,hi,ii,ji,ki,li,mi,ni,oi,pi,qi,ri,si,ti,ui,vi,wi,xi,yi,zi,Ai,Bi,Ci,Di,Ei,Fi,Gi,Hi,Ii,Ji,Ki,Li,Mi,Ni,Oi,Pi,Qi,Ri,Si,Ti,Ui,Vi,Wi,Xi,Yi,Zi,$i,_i,aj,bj,cj,dj,ej,fj,gj,hj,ij,jj,kj,lj,mj,nj,oj,pj,qj,rj,sj,tj,uj,vj,wj,xj,yj,zj,Aj,Bj,Cj,Dj,Ej,Fj,Gj,Hj,Ij,Jj,Kj,Lj,Mj,Nj,Oj,Pj,Qj,Rj,Sj,Tj,Uj,Vj,Wj,Xj,Yj,Zj,$j,_j,ak,bk,ck,dk,ek,fk,gk,hk,ik,jk,kk,lk,mk,nk,ok,pk,qk,rk,sk,tk,uk,vk,wk,xk,yk,zk,Ak,Bk,Ck,Dk,Ek,Fk,Gk,Hk,Ik,Jk,Kk,Lk,Mk,Nk,Ok,Pk,Qk,Rk,Sk,Tk,Uk,Vk,Wk,Xk,Yk,Zk,$k,_k,al,bl,cl,dl,el,fl,gl,hl,il,jl,kl,ll,ml,nl,ol,pl,ql,rl,sl,tl,ul,vl,wl,xl,yl,zl,Al,Bl,Cl,Dl,El,Fl,Gl,Hl,Il,Jl,Kl,Ll,Ml,Nl,Ol,Pl,Ql,Rl,Sl,Tl,Ul,Vl,Wl,Xl,Yl,Zl,$l,_l,am,bm,cm,dm,em,fm,gm,hm,im,jm,km,lm,mm,nm,om,pm,qm,rm,sm,tm,um,vm,wm,xm,ym,zm,Am,Bm,Cm,Dm,Em,Fm,Gm,Hm,Im,Jm,Km,Lm,Mm,Nm,Om,Pm,Qm,Rm,Sm,Tm,Um,Vm,Wm,Xm,Ym,Zm,$m,_m,an,bn,cn,dn,en,fn,gn,hn,kn,ln,mn,nn,on,pn,qn,rn,sn,tn,un,vn,wn,xn,zn,An,Bn,Cn,Dn,En,Fn,Gn,Hn,In,Jn,Kn,Ln,Mn,Nn,On,Pn,Qn,Rn,Sn,Tn,Un,Vn,Wn,Xn,Yn,Zn,$n,_n,ao,bo,co,eo,fo,go,ho,io,jo,ko,lo,mo,no,oo,po,qo,ro,so,to,uo,vo,wo,xo,yo,zo,Ao,Bo,Co,Do,Eo,Fo,Go,Ho,Io,Jo,Ko,Lo,Mo,No,Oo,Po,Qo,Ro,So,To,Uo,Vo,Wo,Xo,Yo,Zo,$o,_o,ap,bp,cp,dp,ep,fp,gp,hp,ip,jp,kp,lp,mp,np,op,pp,qp,rp,sp,tp,up,vp,wp,xp,yp,zp,Ap,Bp,Cp,Dp,Ep,Fp,Gp,Hp,Ip,Jp,Kp,Lp,Mp,Np,Op,Pp,Qp,Rp,Sp,Tp,Up,Vp,Wp,Xp,Yp,Zp,$p,_p,aq,bq,cq,dq,eq,fq,gq=[].slice;for(Nf=a("29"),1,Gd=1e3,R=!1,Sd=!1,In=function(){function a(){}return a.prototype.a=null,a.prototype.b=null,a}(),Xe=function(){function a(){this.cons={},this.cons.car=null,this.cons.cdr=null,this.q=new In}return a.prototype.cons=null,a.prototype.printname="",a.prototype.str="",a.prototype.tensor=null,a.prototype.q=null,a.prototype.d=0,a.prototype.k=0,a.prototype.tag=0,a.prototype.toString=function(){return Mg(this)},a}(),Ji="",M=0,Hd=1,da=2,je=3,De=4,me=5,dh=0,d=dh++,e=dh++,f=dh++,g=dh++,h=dh++,i=dh++,j=dh++,k=dh++,l=dh++,m=dh++,n=dh++,o=dh++,r=dh++,s=dh++,t=dh++,u=dh++,C=dh++,D=dh++,E=dh++,F=dh++,G=dh++,H=dh++,I=dh++,J=dh++,K=dh++,L=dh++,N=dh++,O=dh++,P=dh++,S=dh++,T=dh++,U=dh++,V=dh++,W=dh++,X=dh++,Z=dh++,$=dh++,_=dh++,aa=dh++,ba=dh++,ca=dh++,ea=dh++,ga=dh++,ia=dh++,ja=dh++,ka=dh++,pa=dh++,qa=dh++,ra=dh++,sa=dh++,ta=dh++,ua=dh++,va=dh++,Kc=dh++,Lc=dh++,Mc=dh++,Nc=dh++,Oc=dh++,Pc=dh++,Qc=dh++,Sc=dh++,Tc=dh++,Uc=dh++,Vc=dh++,Wc=dh++,Xc=dh++,Yc=dh++,Zc=dh++,$c=dh++,_c=dh++,cd=dh++,dd=dh++,ed=dh++,gd=dh++,hd=dh++,id=dh++,jd=dh++,ld=dh++,sd=dh++,ud=dh++,yd=dh++,zd=dh++,Id=dh++,Jd=dh++,Kd=dh++,Ld=dh++,Md=dh++,Od=dh++,Pd=dh++,Qd=dh++,Rd=dh++,Td=dh++,Ud=dh++,Vd=dh++,Wd=dh++,Xd=dh++,Yd=dh++,_e=dh++,Zd=dh++,_d=dh++,ae=dh++,ce=dh++,de=dh++,ee=dh++,be=dh++,he=dh++,ie=dh++,ke=dh++,le=dh++,Ae=dh++,Be=dh++,Ce=dh++,Ee=dh++,Fe=dh++,Ge=dh++,He=dh++,Ie=dh++,Je=dh++,Me=dh++,Ye=dh++,af=dh++,xd=dh++,p=dh++,q=dh++,fd=dh++,Le=dh++,Ne=dh++,$e=dh++,fa=dh++,pd=dh++,qd=dh++,rd=dh++,$d=dh++,Nd=dh++,ne=dh++,oe=dh++,pe=dh++,qe=dh++,re=dh++,se=dh++,te=dh++,ue=dh++,ve=dh++,we=dh++,xe=dh++,ye=dh++,ze=dh++,w=dh++,x=dh++,y=dh++,z=dh++,A=dh++,B=dh++,dh++,ha=$e,Ke=1e5,1e4,100001,nd=1e4,md=24,cp=function(){function a(){this.dim=function(){var a,b,c;for(c=[],a=0,b=md;0<=b?a<=b:a>=b;0<=b?a++:a--)c.push(0);return c}(),this.elem=[]}return a.prototype.ndim=0,a.prototype.dim=null,a.prototype.nelem=0,a.prototype.elem=null,a}(),Oh=function(){function a(){}return a.prototype.h=0,a.prototype.w=0,a.prototype.n=0,a.prototype.a=[],a}(),function(){function a(){}return a.prototype.ascent=0,a.prototype.descent=0,a.prototype.width=0,a}(),kp=0,Ti=0,0,0,0,tp=0,Wm=function(){var a,b,c,d;for(d=[2],b=3;d.length<nd;){for(c=0,a=Math.sqrt(b);c<d.length&&d[c]<=a;){if(b%d[c]==0){c=-1;break}c++}-1!==c&&d.push(b),b+=2}return d[nd]=0,d}(),Ki=0,Zh=0,0,np=0,"","",_o=[],Uf=[],Hf=[],Oo=[],yj=0,vm=null,wm=null,xm=null,ym=null,zm=null,Am=null,Bm=null,Cm=null,Dm=null,Em=null,fq=null,sm=null,Zj=null,_o=[],"",0,fp=0,null,Zo=function(a){return _o[a]},uk=function(a){return a.k===M},_k=function(a){return a.k===Hd},xk=function(a){return a.k===da},Qk=function(a){return _k(a)||xk(a)},bl=function(a){return a.k===je},el=function(a){if(null!=a)return a.k===De},cl=function(a){return a.k===me},Hk=function(a){return cl(a)&&$o(a)<xd},jg=function(a){return uk(a)?a.cons.car:Zo(xd)},tg=function(a){return uk(a)?a.cons.cdr:Zo(xd)},$f=function(a){return jg(jg(a))},ig=function(a){return jg(tg(a))},mg=function(a){return tg(jg(a))},sg=function(a){return tg(tg(a))},Zf=function(a){return jg(jg(tg(a)))},hg=function(a){return jg(tg(tg(a)))},bg=function(a){return jg(tg(jg(a)))},lg=function(a){return tg(jg(tg(a)))},og=function(a){return tg(tg(jg(a)))},rg=function(a){return tg(tg(tg(a)))},Yf=function(a){return jg(jg(tg(tg(a))))},ag=function(a){return jg(tg(jg(tg(a))))},eg=function(a){return jg(tg(tg(jg(a))))},kg=function(a){return tg(jg(tg(tg(a))))},gg=function(a){return jg(tg(tg(tg(a))))},qg=function(a){return tg(tg(tg(tg(a))))},fg=function(a){return jg(tg(tg(tg(tg(a)))))},_f=function(a){return jg(tg(jg(tg(tg(a)))))},ng=function(a){return tg(tg(jg(tg(tg(a)))))},dg=function(a){return jg(tg(tg(jg(tg(a)))))},pg=function(a){return tg(tg(tg(jg(tg(tg(a))))))},cg=function(a){return jg(tg(tg(jg(tg(tg(a))))))},qk=function(a){return jg(a)===Zo(e)},Kk=function(a){return jg(a)===Zo(ud)},Zk=function(a){return jg(a)===Zo(Pd)},Ak=function(a){return jg(a)===Zo(Lc)},td=function(a){return a.isPositive()?1:a.isZero()?0:-1},function(a){return a.toString().length},vd=function(a){return a.isZero()},od=function(a,b){return a.equals(b)},c=void 0!==b&&null!==b?b:this,c.isadd=qk,c.ismultiply=Kk,c.ispower=Zk,c.isfactorial=Ak,c.car=jg,c.cdr=tg,c.caar=$f,c.cadr=ig,c.cdar=mg,c.cddr=sg,c.caadr=Zf,c.caddr=hg,c.cadar=bg,c.cdadr=lg,c.cddar=og,c.cdddr=rg,c.caaddr=Yf,c.cadadr=ag,c.caddar=eg,c.cdaddr=kg,c.cadddr=gg,c.cddddr=qg,c.caddddr=fg,c.cadaddr=_f,c.cddaddr=ng,c.caddadr=dg,c.cdddaddr=pg,c.caddaddr=cg,c.symbol=Zo,c.iscons=uk,c.isrational=_k,c.isdouble=xk,c.isnum=Qk,c.isstr=bl,c.istensor=el,c.issymbol=cl,c.iskeyword=Hk,c.CONS=M,c.NUM=Hd,c.DOUBLE=da,c.STR=je,c.TENSOR=De,c.SYM=me,ya=function(){return qn(ig(wm)),wa(),of()},of=function(){var a;if(a=0,Zn(),wm=Nm(),el(wm))return pf(),void Sn();if(Qk(wm))return qn(wm),Mk(wm)&&$l(),void Sn();if(tk(wm))return qn(wm),qn(wm),Ug(),Rl(),vn(1,2),Rm(),void Sn();if(jg(wm)===Zo(Pd)&&Nk(hg(wm)))return qn(wm),Mn(),of(),Mn(),void Sn();if(jg(wm)===Zo(ud)){for(a=kp,wm=tg(wm);uk(wm);)qn(jg(wm)),of(),wm=tg(wm);return Sl(kp-a),void Sn()}return(Nk(wm)||jg(wm)===Zo(e)&&Nk(ig(wm)))&&(qn(wm),$l(),wm=Nm()),wn(d),qn(wm),pl(2),Sn()},pf=function(){return 1!==wm.tensor.ndim&&To("abs(tensor) with tensor rank > 1"),qn(wm),qn(wm),Ug(),ck(),vn(1,2),Rm(),Do(),wa()},xj=0,za=function(){var a;for(a=kp,wm=tg(wm);uk(wm);)qn(jg(wm)),wa(),xm=Nm(),zn(xm),wm=tg(wm);return vf(kp-a)},Po=0,vf=function(a){var b,c,d,f,g,h,i,j,k;if(Po++,f=0,d=kp-a,d,R&&console.log("stack before adding terms #"+Po),R)for(f=g=0,h=kp;0<=h?g<h:g>h;f=0<=h?++g:--g)Xm(Oo[f]);for(f=b=0;b<10&&!(a<2)&&(xj=0,k=Oo.slice(d,d+a),k.sort(Ig),Oo=Oo.slice(0,d).concat(k).concat(Oo.slice(d+a)),0!==xj);f=++b)a=Og(d,a);switch(kp=d+a,a){case 0:un(0);break;case 1:break;default:pl(a),wm=Nm(),wn(e),qn(wm),Vg()}if(R&&console.log("stack after adding terms #"+Po),R){for(j=[],f=c=0,i=kp;0<=i?c<i:c>i;f=0<=i?++c:--c)j.push(Xm(Oo[f]));return j}},Jg=0,Ig=function(a,b){var c,d,e,f;if(Jg++,c=0,Qk(a)&&Qk(b))return xj=1,0;if(el(a)&&el(b)){if(a.tensor.ndim<b.tensor.ndim)return-1;if(a.tensor.ndim>b.tensor.ndim)return 1;for(c=d=0,e=a.tensor.ndim;0<=e?d<e:d>e;c=0<=e?++d:--d){if(a.tensor.dim[c]<b.tensor.dim[c])return-1;if(a.tensor.dim[c]>b.tensor.dim[c])return 1}return xj=1,0}return jg(a)===Zo(ud)&&(a=tg(a),Qk(jg(a))&&(a=tg(a),tg(a)===Zo(xd)&&(a=jg(a)))),jg(b)===Zo(ud)&&(b=tg(b),Qk(jg(b))&&(b=tg(b),tg(b)===Zo(xd)&&(b=jg(b)))),f=Hg(a,b),0===f&&(xj=1),f},Og=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t;for(g=0;g<b-1;)if(xg(),ym=Oo[a+g],zm=Oo[a+g+1],el(ym)&&el(zm)){if(qn(ym),qn(zm),dp(),(wm=Nm())!==Zo(xd)){for(Oo[a+g]=wm,h=i=j=g+1,k=b-1;j<=k?i<k:i>k;h=j<=k?++i:--i)Oo[a+h]=Oo[a+h+1];b--,g--}g++}else if(el(ym)||el(zm))g++;else if(Qk(ym)&&Qk(zm)){if(qn(ym),qn(zm),uf(),wm=Nm(),fl(wm)){for(h=c=l=g,m=b-2;l<=m?c<m:c>m;h=l<=m?++c:--c)Oo[a+h]=Oo[a+h+2];b-=2}else{for(Oo[a+g]=wm,h=d=n=g+1,o=b-1;n<=o?d<o:d>o;h=n<=o?++d:--d)Oo[a+h]=Oo[a+h+1];b--}g--,g++}else if(Qk(ym)||Qk(zm))g++;else if(wm=sm,xm=sm,t=0,jg(ym)===Zo(ud)&&(ym=tg(ym),t=1,Qk(jg(ym))&&(wm=jg(ym),ym=tg(ym),tg(ym)===Zo(xd)&&(ym=jg(ym),t=0))),jg(zm)===Zo(ud)&&(zm=tg(zm),Qk(jg(zm))&&(xm=jg(zm),zm=tg(zm),tg(zm)===Zo(xd)&&(zm=jg(zm)))),Fi(ym,zm))if(qn(wm),qn(xm),uf(),wm=Nm(),fl(wm)){for(h=e=p=g,q=b-2;p<=q?e<q:e>q;h=p<=q?++e:--e)Oo[a+h]=Oo[a+h+2];b-=2,g--,g++}else{for(qn(wm),t?(qn(Zo(ud)),qn(ym),Vg()):qn(ym),Rl(),Oo[a+g]=Nm(),h=f=r=g+1,s=b-1;r<=s?f<s:f>s;h=r<=s?++f:--f)Oo[a+h]=Oo[a+h+1];b--,g--,g++}else g++;return b},zn=function(a){var b;if(jg(a)===Zo(e)){for(a=tg(a),b=[];uk(a);)qn(jg(a)),b.push(a=tg(a));return b}if(!fl(a))return qn(a)},sf=function(){var a;return Zn(),xm=Nm(),wm=Nm(),a=kp,zn(wm),zn(xm),vf(kp-a),Sn()},tf=function(a){var b,c,d,e,f;for(c=0,Zn(),f=kp-a,b=kp,c=d=0,e=a;0<=e?d<e:d>e;c=0<=e?++d:--d)zn(Oo[f+c]);return vf(kp-b),wm=Nm(),kp-=a,qn(wm),Sn()},Xo=function(){return $l(),sf()},Aa=function(){return qn(ig(wm)),wa(),wf()},wf=function(){var a,b,c,d,e,f,g;for(b=0,c=0,d=0,Zn(),wm=Nm(),el(wm)&&2===wm.tensor.ndim&&wm.tensor.dim[0]===wm.tensor.dim[1]?1:To("adj: square matrix expected"),d=wm.tensor.dim[0],xm=xf(d*d),xm.tensor.ndim=2,xm.tensor.dim[0]=d,xm.tensor.dim[1]=d,b=e=0,f=d;0<=f?e<f:e>f;b=0<=f?++e:--e)for(c=a=0,g=d;0<=g?a<g:a>g;c=0<=g?++a:--a)Lg(wm,d,b,c),xm.tensor.elem[d*c+b]=Nm();return qn(xm),Sn()},Ca=function(){return qn(ig(wm)),wa(),Af()},Af=function(){var a,b;if(0,a=0,Zn(),wm=Nm(),jg(wm)===Zo(O))return qn(ig(wm)),void Sn();if(xk(wm))return b=0,a=Math.acos(wm.d),b&&To("arccos function argument is not in the interval [-1,1]"),rn(a),void Sn();if(Sk(wm))return vn(1,4),wn(Nd),Rl(),void Sn();if(Jk(wm))return vn(3,4),wn(Nd),Rl(),void Sn();if(!_k(wm))return wn(h),qn(wm),pl(2),void Sn();switch(qn(wm),un(2),Rl(),Qm()){case-2:wn(Nd);break;case-1:vn(2,3),wn(Nd),Rl();break;case 0:vn(1,2),wn(Nd),Rl();break;case 1:vn(1,3),wn(Nd),Rl();break;case 2:qn(fq);break;default:wn(h),qn(wm),pl(2)}return Sn()},Da=function(){return qn(ig(wm)),wa(),Bf()},Bf=function(){var a;return a=0,Zn(),wm=Nm(),jg(wm)===Zo(P)?(qn(ig(wm)),void Sn()):xk(wm)?(a=wm.d,a<1&&To("arccosh function argument is less than 1.0"),a=Math.log(a+Math.sqrt(a*a-1)),rn(a),void Sn()):Tk(wm)?(qn(fq),void Sn()):(wn(i),qn(wm),pl(2),Sn())},Ea=function(){return qn(ig(wm)),wa(),Cf()},Cf=function(){var a,b;if(0,a=0,Zn(),wm=Nm(),jg(wm)===Zo(de))return qn(ig(wm)),void Sn();if(xk(wm))return b=0,a=Math.asin(wm.d),b&&To("arcsin function argument is not in the interval [-1,1]"),rn(a),void Sn();if(Sk(wm))return vn(1,4),wn(Nd),Rl(),void Sn();if(Jk(wm))return vn(-1,4),wn(Nd),Rl(),void Sn();if(!_k(wm))return wn(j),qn(wm),pl(2),void Sn();switch(qn(wm),un(2),Rl(),Qm()){case-2:vn(-1,2),wn(Nd),Rl();break;case-1:vn(-1,6),wn(Nd),Rl();break;case 0:qn(fq);break;case 1:vn(1,6),wn(Nd),Rl();break;case 2:vn(1,2),wn(Nd),Rl();break;default:wn(j),qn(wm),pl(2)}return Sn()},Fa=function(){return qn(ig(wm)),wa(),Df()},Df=function(){var a;return a=0,Zn(),wm=Nm(),jg(wm)===Zo(ee)?(qn(ig(wm)),void Sn()):xk(wm)?(a=wm.d,a=Math.log(a+Math.sqrt(a*a+1)),rn(a),void Sn()):fl(wm)?(qn(fq),void Sn()):(wn(k),qn(wm),pl(2),Sn())},Ga=function(){return qn(ig(wm)),wa(),Ef()},Ef=function(){var a,b;return a=0,Zn(),wm=Nm(),jg(wm)===Zo(Ae)?(qn(ig(wm)),void Sn()):xk(wm)?(b=0,a=Math.atan(wm.d),b&&To("arctan function error"),rn(a),void Sn()):fl(wm)?(qn(fq),void Sn()):Lk(wm)?(qn(wm),$l(),Ef(),$l(),void Sn()):Rc(wm,Zo(de))&&Rc(wm,Zo(O))&&(qn(wm),pm(),xm=Nm(),qn(wm),Eh(),ym=Nm(),jg(xm)===Zo(de)&&jg(ym)===Zo(O)&&Fi(ig(xm),ig(ym)))?(qn(ig(xm)),void Sn()):jg(wm)===Zo(Pd)&&Gi(ig(wm),3)&&Hi(hg(wm),-1,2)?(vn(1,6),qn(Zo(Nd)),Rl(),void Sn()):Gi(wm,1)?(vn(1,4),qn(Zo(Nd)),Rl(),void Sn()):jg(wm)===Zo(Pd)&&Gi(ig(wm),3)&&Hi(hg(wm),1,2)?(vn(1,3),qn(Zo(Nd)),Rl(),void Sn()):(wn(l),qn(wm),pl(2),Sn())},Ha=function(){return qn(ig(wm)),wa(),Ff()},Ff=function(){var a;return a=0,Zn(),wm=Nm(),jg(wm)===Zo(Be)?(qn(ig(wm)),void Sn()):xk(wm)?(a=wm.d,(a<-1||a>1)&&To("arctanh function argument is not in the interval [-1,1]"),a=Math.log((1+a)/(1-a))/2,rn(a),void Sn()):fl(wm)?(qn(fq),void Sn()):(wn(m),qn(wm),pl(2),Sn())},Ia=function(){return qn(ig(wm)),wa(),Gf()},Gf=function(){return Zn(),wm=Nm(),qn(wm),pm(),Dp(),qn(wm),Eh(),Dp(),Xo(),Sn()},Dp=function(){if(Zn(),wm=Nm(),Mk(wm))qn(Zo(Nd)),$l();else if(jg(wm)===Zo(Pd)&&Gi(ig(wm),-1))qn(Zo(Nd)),qn(hg(wm)),Rl();else if(jg(wm)===Zo(Pd)&&ig(wm)===Zo(ha))qn(hg(wm)),Yj();else if(jg(wm)===Zo(ud))for(un(0),wm=tg(wm);uk(wm);)qn(jg(wm)),Gf(),sf(),wm=tg(wm);else jg(wm)===Zo(e)?(qn(wm),Nn(),wm=Nm(),qn(wm),Ln(),xm=Nm(),qn(wm),Yj(),ym=Nm(),fl(xm)?(qn(Zo(Nd)),Lk(ym)&&$l()):(qn(ym),qn(xm),Ph(),Ef(),Lk(xm)&&(wn(Nd),Lk(ym)?Xo():sf()))):un(0);return Sn()},If=function(){var a,b,c,d,e,f;if(a=0,b=0,c=0,d=0,e=0,f=0,Ti++,Zn(),wm=Nm(),b=Uk(wm,Zo(ve)),c=Uk(wm,Zo(we)),d=Uk(wm,Zo(xe)),e=Uk(wm,Zo(ye)),f=Uk(wm,Zo(ze)),1===b&&0===c&&0===d&&0===e&&0===f)xm=Zo(ve),Jf();else if(0===b&&1===c&&0===d&&0===e&&0===f)xm=Zo(we),Jf();else if(0===b&&0===c&&1===d&&0===e&&0===f)xm=Zo(xe),Jf();else if(0===b&&0===c&&0===d&&1===e&&0===f)xm=Zo(ye),Jf();else if(0===b&&0===c&&0===d&&0===e&&1===f)xm=Zo(ze),Jf();else if(uk(wm)){for(a=kp,qn(jg(wm)),wm=tg(wm);uk(wm);)qn(jg(wm)),If(),wm=tg(wm);pl(kp-a)}else qn(wm);return Sn(),Ti--},Mm=function(){var a;if(a=0,Zn(),xm=Nm(),wm=Nm(),Uk(wm,xm))Jf();else if(uk(wm)){for(a=kp,qn(jg(wm)),wm=tg(wm);uk(wm);)qn(jg(wm)),qn(xm),Mm(),wm=tg(wm);pl(kp-a)}else qn(wm);return Sn()},Jf=function(){var a,b,c,d,f,g;for(b=0,c=0,d=0,f=0,a=kp,qn(wm),qn(xm),d=Kg(),b=kp,c=g=d-1;g>=0;c=g+=-1)wm=Oo[a+c],Kf(c);return f=kp-b,f>1&&(pl(f),qn(Zo(e)),Yo(),Vg()),wm=Nm(),kp-=d,qn(wm)},Kf=function(a){var b,c;if(b=0,c=0,!fl(wm)){if(0!==a){if(b=kp,jg(wm)===Zo(ud))for(wm=tg(wm);uk(wm);)qn(jg(wm)),wm=tg(wm);else Gi(wm,1)||qn(wm);return 1===a?qn(xm):(qn(Zo(Pd)),qn(xm),un(a),pl(3)),c=kp-b,c>1?(pl(c),qn(Zo(ud)),Yo(),Vg()):void 0}if(jg(wm)===Zo(e))for(wm=tg(wm);uk(wm);)qn(jg(wm)),wm=tg(wm);else qn(wm)}},Ja=function(){return qn(ig(wm)),wa(),qn(hg(wm)),wa(),Lf()},Lf=function(){return Zn(),Ep(),Sn()},Ep=function(){var a,b;return a=0,b=0,xm=Nm(),wm=Nm(),qn(xm),b=Qm(),xk(wm)&&2147483648!==b?(a=jn(b,wm.d),void rn(a)):fl(wm)&&fl(xm)?void un(1):fl(wm)&&2147483648!==b?void un(0):xm.k===Hd&&od(xm.q.b,2)?od(xm.q.a,1)?(un(2),wn(Nd),Ph(),qn(wm),Ph(),vn(1,2),Rm(),qn(wm),Jo(),void Rl()):od(xm.q.a,-1)?(un(2),wn(Nd),Ph(),qn(wm),Ph(),vn(1,2),Rm(),qn(wm),$g(),void Rl()):(un(td(xm.q.a)),ym=Nm(),un(2),qn(wm),Ph(),qn(xm),qn(ym),Xo(),Rl(),qn(wm),qn(xm),qn(ym),Xo(),Lf(),Rl(),qn(wm),qn(xm),un(2),qn(ym),Rl(),Xo(),Lf(),void Xo()):Nk(wm)?(qn(wm),$l(),qn(xm),Rm(),qn(wm),qn(xm),$l(),Rm(),Rl(),wn(r),qn(wm),$l(),qn(xm),pl(3),void Rl()):Nk(xm)?(un(-1),qn(xm),Rm(),wn(r),qn(wm),qn(xm),$l(),pl(3),void Rl()):(qn(Zo(r)),qn(wm),qn(xm),pl(3))},Ka=function(){return qn(ig(wm)),wa(),qn(hg(wm)),wa(),Mf()},Mf=function(){return Zn(),Fp(),Sn()},Fp=function(){var a,b;return a=0,b=0,xm=Nm(),wm=Nm(),qn(xm),b=Qm(),xk(wm)&&2147483648!==b?(a=yn(b,wm.d),void rn(a)):Nk(xm)?(un(-1),qn(xm),Rm(),wn(s),qn(wm),qn(xm),$l(),pl(3),void Rl()):(wn(s),qn(wm),qn(xm),void pl(3))},2,1e3,0,[],El=function(a){return Nf(a)},qo=function(a,b){if(a.isPositive()){if(b<0)return a.multiply(Nf(-1))}else if(b>0)return a.multiply(Nf(-1));return a},wl=function(a,b){if(a.isPositive()){if(b.isNegative())return a.multiply(Nf(-1))}else if(b.isPositive())return a.multiply(Nf(-1));return a},vl=function(a){return a.isNegative()?a.multiply(Nf(-1)):a},uf=function(){var a,b,c;return a=1,b=1,_k(Oo[kp-1])&&_k(Oo[kp-2])?void Bn():(Zn(),xm=Nm(),wm=Nm(),a=xk(wm)?wm.d:Yg(wm),b=xk(xm)?xm.d:Yg(xm),c=a+b,rn(c),Sn())},function(){var a,b;return a=0,b=0,_k(Oo[kp-1])&&_k(Oo[kp-2])?void qsub():(Zn(),xm=Nm(),wm=Nm(),a=xk(wm)?wm.d:Yg(wm),b=xk(xm)?xm.d:Yg(xm),rn(a-b),Sn())},Yl=function(){var a,b;return a=0,b=0,_k(Oo[kp-1])&&_k(Oo[kp-2])?void Dn():(Zn(),xm=Nm(),wm=Nm(),a=xk(wm)?wm.d:Yg(wm),b=xk(xm)?xm.d:Yg(xm),rn(a*b),Sn())},Qh=function(){var a,b;return a=0,b=0,_k(Oo[kp-1])&&_k(Oo[kp-2])?void Cn():(Zn(),xm=Nm(),wm=Nm(),fl(xm)&&To("divide by zero"),a=xk(wm)?wm.d:Yg(wm),b=xk(xm)?xm.d:Yg(xm),rn(a/b),Sn())},lk=function(){var a,b;return Zn(),wm=Nm(),fl(wm)&&To("divide by zero"),xk(wm)?(rn(1/wm.d),void Sn()):(a=Nf(wm.q.a),b=Nf(wm.q.b),b=wl(b,a),a=qo(a,1),wm=new Xe,wm.k=Hd,wm.q.a=b,wm.q.b=a,qn(wm),Sn())},Qg=function(a,b){var c,d;return 0,c=Gl(a.q.a,b.q.b),d=Gl(a.q.b,b.q.a),yl(c,d)},Pg=function(a,b){var c,d;return c=0,d=0,_k(a)&&_k(b)?Qg(a,b):(c=xk(a)?a.d:Yg(a),d=xk(b)?b.d:Yg(b),c<d?-1:c>d?1:0)},am=function(){if(Zn(),wm=Nm(),fl(wm))return qn(wm),void Sn();switch(wm.k){case Hd:xm=new Xe,xm.k=Hd,xm.q.a=Nf(wm.q.a.multiply(Nf.minusOne)),xm.q.b=Nf(wm.q.b),qn(xm);break;case da:rn(-wm.d);break;default:To("bug caught in mp_negate_number")}return Sn()},Tf=function(){var a;return Zn(),wm=Nm(),a=zl(wm.q.a,wm.q.b),wm=new Xe,wm.k=Hd,wm.q.a=a,wm.q.b=Nf(1),qn(wm),Sn()},Ll=function(){return Zn(),wm=Nm(),wm.k!==Hd?(qn(sm),void Sn()):(xm=new Xe,xm.k=Hd,xm.q.a=Nf(wm.q.a),xm.q.b=Nf(1),qn(xm),Sn())},Kl=function(){return Zn(),wm=Nm(),wm.k!==Hd?(qn(sm),void Sn()):(xm=new Xe,xm.k=Hd,xm.q.a=Nf(wm.q.b),xm.q.b=Nf(1),qn(xm),Sn())},Qf=function(a){var b,c,d;return Zn(),wm=Nm(),b=Ml(wm.q.a,Math.abs(a)),c=Ml(wm.q.b,Math.abs(a)),a<0&&(d=b,b=c,c=d,b=wl(b,c),c=qo(c,1)),wm=new Xe,wm.k=Hd,wm.q.a=b,wm.q.b=c,qn(wm),Sn()},function(a){return a.toJSNumber()},Yg=function(a){var b;return a.q,b=a.q.a.divmod(a.q.b),b.quotient+b.remainder/a.q.b.toJSNumber()},un=function(a){return R&&console.log("pushing integer "+a),Zn(),wm=new Xe,wm.k=Hd,wm.q.a=Nf(a),wm.q.b=Nf(1),qn(wm),Sn()},rn=function(a){return Zn(),wm=new Xe,wm.k=da,wm.d=a,qn(wm),Sn()},vn=function(a,b){var c;return c=new Xe,c.k=Hd,c.q.a=Nf(a),c.q.b=Nf(b),qn(c)},Qm=function(){var a;switch(a=0,Zn(),wm=Nm(),wm.k){case Hd:a=Fk(wm)&&wm.q.a.isSmall?wm.q.a.toJSNumber():2147483648;break;case da:a=Math.floor(wm.q.a);break;default:a=2147483648}return Sn(),a},function(a,b){var c;return c="",c=""+Vh(a.d),fn(1===b&&"-"===c?c+1:c)},Sf=function(a){var b,c,d;return Zn(),c=0,d=a[c],"+"!==d&&"-"!==d||c++,b=Nf(a.substring(c)),wm=new Xe,wm.k=Hd,wm.q.a=b,wm.q.b=Nf(1),qn(wm),"-"===d&&$l(),Sn()},Rf=function(a){return rn(parseFloat(a))},en=function(a,b){var c,d;switch(!1,null==b&&(!0,b=""),d="","",a.k){case Hd:c=a.q.a.toString(),"-"===c[0]&&(c=c.substring(1)),b+=c,Vo+=c,Ck(a)&&(b+="/",Vo+="/",d=a.q.b.toString(),b+=d,Vo+=d);break;case da:c=""+Vh(a.d),"-"===c[0]&&(c=c.substring(1)),b+=c,Vo+=c}return b},Hj=function(){return Zn(),xm=Nm(),wm=Nm(),ym=new Xe,ym.k=Hd,ym.q.a=Cl(wm.q.a,xm.q.a),ym.q.b=Cl(wm.q.b,xm.q.b),ym.q.a=qo(ym.q.a,1),qn(ym),Sn()},Om=function(){var a;switch(a=0,Zn(),wm=Nm(),wm.k){case Hd:a=Yg(wm);break;case da:a=wm.d;break;default:a=0}return Sn(),a},Pf=function(){var a;return a=0,a=Yg(Nm()),rn(a)},Of=function(a){return Zn(),wm=new Xe,wm.k=Hd,wm.q.a=ef(a),wm.q.b=Nf(1),qn(wm),Sn()},ef=function(a){var b,c,d,e,f,g;if(d=0,0===a||1===a)return b=Nf(1);if(b=Nf(2),c=Nf(0),3<=a)for(d=e=3,f=a;3<=f?e<=f:e>=f;d=3<=f?++e:--e)c=Nf(d),g=Gl(b,c),b=g;return b},xl=[1,2,4,8,16,32,64,128,256,512,1024,2048,4096,8192,16384,32768,65536,131072,262144,524288,1048576,2097152,4194304,8388608,16777216,33554432,67108864,134217728,268435456,536870912,1073741824,2147483648],function(a,b){return console.log("not implemented yet"),a[b/32]|=xl[b%32]},function(a,b){return console.log("not implemented yet"),a[b/32]&=~xl[b%32]},function(a){return a=a.shiftRight()},Ma=function(){return qn(ig(wm)),wa(),qn(hg(wm)),wa(),Vf()},Vf=function(){return Zn(),vp(),Sn()},vp=function(){return xm=Nm(),wm=Nm(),0===v()?void qn(fq):(qn(wm),kj(),qn(xm),kj(),Ph(),qn(wm),qn(xm),Xo(),kj(),Ph())},v=function(){return Qk(wm)&&nl(wm,fq)?0:Qk(xm)&&nl(xm,fq)?0:Qk(wm)&&Qk(xm)&&nl(wm,xm)?0:1},Na=function(){return qn(ig(wm)),wa(),ug()},ug=function(){return Zn(),Gp(),Sn()},Gp=function(){var a;return a=0,wm=Nm(),Qk(wm)?xk(wm)?(a=Math.ceil(wm.d),void rn(a)):Fk(wm)?void qn(wm):(ym=new Xe,ym.k=Hd,ym.q.a=zl(wm.q.a,wm.q.b),ym.q.b=El(1),qn(ym),Mk(wm)?1:(un(1),sf())):(wn(C),qn(wm),void pl(2))},Pa=function(){return qn(ig(wm)),wa(),qn(hg(wm)),wa(),zg()},zg=function(){return Zn(),xm=Nm(),wm=Nm(),0===Ag()?(un(0),void Sn()):(qn(wm),kj(),qn(xm),kj(),Ph(),qn(wm),qn(xm),Xo(),kj(),Ph(),Sn())},Ag=function(){return Qk(wm)&&nl(wm,fq)?0:Qk(xm)&&nl(xm,fq)?0:Qk(wm)&&Qk(xm)&&nl(wm,xm)?0:1},Qa=function(){return qn(ig(wm)),wa(),Bg(),wa()},Bg=function(){var a,b,c,d;if(b=0,a=0,Zn(),wm=Nm(),jg(wm)===Zo(O))return qn(ig(wm)),Ui(),void Sn();if(jg(wm)===Zo(de))return qn(ig(wm)),Xi(),void Sn();if(jg(wm)===Zo(Ae))return wm=ig(wm),qn(Zj),qn(wm),Rl(),Vi(),xm=Nm(),qn(Zj),qn(wm),Rl(),$l(),Vi(),ym=Nm(),qn(ym),qn(xm),Xo(),qn(Zj),Rl(),qn(xm),qn(ym),sf(),Ph(),void Sn();if(jg(wm)===Zo(P))return wm=ig(wm),qn(wm),Vi(),qn(wm),$l(),Vi(),sf(),vn(1,2),Rl(),void Sn();if(jg(wm)===Zo(ee))return wm=ig(wm),qn(wm),Vi(),qn(wm),$l(),Vi(),Xo(),vn(1,2),Rl(),void Sn();if(jg(wm)===Zo(Be))return wm=ig(wm),qn(wm),un(2),Rl(),Vi(),wm=Nm(),qn(wm),un(1),Xo(),qn(wm),un(1),sf(),Ph(),void Sn();if(uk(wm)){for(a=kp;uk(wm);)qn(jg(wm)),Bg(),wm=tg(wm);return pl(kp-a),void Sn()}if(wm.k===De){for(qn(wm),Zg(),wm=Nm(),b=c=0,d=wm.tensor.nelem;0<=d?c<d:c>d;b=0<=d?++c:--c)qn(wm.tensor.elem[b]),Bg(),wm.tensor.elem[b]=Nm();return qn(wm),void Sn()}return qn(wm),Sn()},Ra=function(){return 0===fp&&Dg(),Cg(),Bh(),qn(Zo(xd))},function(){return Yn("clear")},Sa=function(){return qn(ig(wm)),wa(),Eg()},Eg=function(){return Zn(),wm=Nm(),qn(wm),ul(),un(-1),qn(wm),Gf(),qn(Zo(Nd)),Ph(),Rm(),Rl(),Sn()},Ta=function(){return qn(ig(wm)),wa(),qn(hg(wm)),wa(),qn(gg(wm)),wa(),ym=Nm(),xm=Nm(),wm=Nm(),ym===Zo(xd)&&(ym=xm,xm=Zo(xe)),qn(wm),qn(xm),qn(ym),Rm(),Ph(),qn(xm),pj()},Kg=function(){var a,b;for(Zn(),xm=Nm(),wm=Nm(),a=kp;;){if(qn(wm),qn(xm),qn(fq),Wo(),wa(),ym=Nm(),qn(ym),qn(wm),qn(ym),Xo(),wm=Nm(),Fi(wm,fq))return b=kp-a,Sn(),b;qn(wm),qn(xm),Ph(),wm=Nm()}},Ua=function(){var a,b,c;return a=0,b=0,c=0,qn(ig(wm)),wa(),xm=Nm(),el(xm)&&2===xm.tensor.ndim&&xm.tensor.dim[0]===xm.tensor.dim[1]?1:To("cofactor: 1st arg: square matrix expected"),c=xm.tensor.dim[0],qn(hg(wm)),wa(),a=Qm(),(a<1||a>c)&&To("cofactor: 2nd arg: row index expected"),qn(gg(wm)),wa(),b=Qm(),(b<1||b>c)&&To("cofactor: 3rd arg: column index expected"),Lg(xm,c,a-1,b-1)},Lg=function(a,b,c,d){var e,f,g,h,i,j;for(f=0,g=0,f=h=0,i=b;0<=i?h<i:h>i;f=0<=i?++h:--h)for(g=e=0,j=b;0<=j?e<j:e>j;g=0<=j?++e:--e)f!==c&&g!==d&&qn(a.tensor.elem[b*f+g]);if(Kh(b-1),(c+d)%2)return $l()},Va=function(){return qn(ig(wm)),wa(),Q()},Q=function(){var a;return a=0,a=Ti,Zn(),Hp(),Sn(),Ti=a},Hp=function(){if(Ti=0,wm=Nm(),jg(wm)!==Zo(e))return void qn(wm);for(ym=tg(wm),qn(jg(ym)),ym=tg(ym);uk(ym);)qn(jg(ym)),Cj(),ym=tg(ym);for(kk(),xm=Nm(),qn(fq),ym=tg(wm);uk(ym);)qn(xm),qn(jg(ym)),Rl(),sf(),ym=tg(ym);return Pp(),qn(xm),Ph()},Wa=function(){return qn(ig(wm)),wa(),wm=Nm(),qn(wm),Rc(wm,Zj)?Ug():(Km(),Ug(),Eg())},Ug=function(){return qn(Zj),qn(Zj),$l(),Wo(),wa()},Wg=0,Vg=function(){var a;return Wg++,R&&console.log("cons tos: "+kp+" # "+Wg),a=new Xe,a.k=M,a.cons.cdr=Nm(),a===a.cons.cdr&&console.log("something wrong p == its cdr"),a.cons.car=Nm(),qn(a)},Ya=function(){return qn(ig(wm)),wa(),sg(wm)===Zo(xd)?(un(1),un(2)):(qn(hg(wm)),wa(),qn(gg(wm)),wa()),Xg()},Xg=function(){return Zn(),Ip(),Sn()},Ip=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A;if(k=0,l=0,m=0,n=0,o=0,p=0,q=0,r=0,s=0,h=[],i=[],ym=Nm(),xm=Nm(),wm=Nm(),!el(wm))return fl(wm)||To("contract: tensor expected, 1st arg is not a tensor"),void qn(fq);for(qn(xm),o=Qm(),qn(ym),p=Qm(),r=wm.tensor.ndim,(o<1||o>r||p<1||p>r||o===p||wm.tensor.dim[o-1]!==wm.tensor.dim[p-1])&&To("contract: index out of range"),o--,p--,q=wm.tensor.dim[o],s=1,l=t=0,u=r;0<=u?t<u:t>u;l=0<=u?++t:--t)l!==o&&l!==p&&(s*=wm.tensor.dim[l]);for(xm=xf(s),xm.tensor.ndim=r-2,m=0,l=b=0,v=r;0<=v?b<v:b>v;l=0<=v?++b:--b)l!==o&&l!==p&&(xm.tensor.dim[m++]=wm.tensor.dim[l]);for(a=wm.tensor.elem,j=xm.tensor.elem,l=c=0,w=r;0<=w?c<w:c>w;l=0<=w?++c:--c)h[l]=0,i[l]=wm.tensor.dim[l];for(l=d=0,x=s;0<=x?d<x:d>x;l=0<=x?++d:--d){for(qn(fq),m=e=0,y=q;0<=y?e<y:e>y;m=0<=y?++e:--e){for(h[o]=m,h[p]=m,k=0,n=f=0,z=r;0<=z?f<z:f>z;n=0<=z?++f:--f)k=k*i[n]+h[n];qn(a[k]),sf()}for(j[l]=Nm(),m=g=A=r-1;A<=0?g<=0:g>=0;m=A<=0?++g:--g)if(m!==o&&m!==p){if(++h[m]<i[m])break;h[m]=0}}return qn(1===s?j[0]:xm)},Za=function(){return qn(ig(wm)),wa(),$g()},$g=function(){return Zn(),wm=Nm(),jg(wm)===Zo(e)?ah():_g(),Sn()},ah=function(){for(xm=tg(wm);uk(xm);){if(zm=jg(xm),Pk(zm))return qn(wm),qn(zm),Xo(),ym=Nm(),qn(ym),$g(),qn(zm),$g(),Rl(),qn(ym),Jo(),qn(zm),Jo(),Rl(),void Xo();xm=tg(xm)}return _g()},_g=function(){var a,b;if(jg(wm)===Zo(h))return void qn(ig(wm));if(xk(wm))return a=Math.cos(wm.d),Math.abs(a)<1e-10&&(a=0),void rn(a);if(Lk(wm)&&(qn(wm),$l(),wm=Nm()),jg(wm)===Zo(l))return un(1),qn(ig(wm)),un(2),Rm(),sf(),vn(-1,2),void Rm();if(qn(wm),un(180),Rl(),wn(Nd),Ph(),(b=Qm())<0||2147483648===b)return qn(Zo(O)),qn(wm),void pl(2);switch(b%360){case 90:case 270:return un(0);case 60:case 300:return vn(1,2);case 120:case 240:return vn(-1,2);case 45:case 315:return vn(1,2),un(2),vn(1,2),Rm(),Rl();case 135:case 225:return vn(-1,2),un(2),vn(1,2),Rm(),Rl();case 30:case 330:return vn(1,2),un(3),vn(1,2),Rm(),Rl();case 150:case 210:return vn(-1,2),un(3),vn(1,2),Rm(),Rl();case 0:return un(1);case 180:return un(-1);default:return qn(Zo(O)),qn(wm),pl(2)}},$a=function(){return qn(ig(wm)),wa(),wp()},wp=function(){return Zn(),Jp(),Sn()},Jp=function(){var a;return a=0,wm=Nm(),jg(wm)===Zo(i)?void qn(ig(wm)):xk(wm)?(a=Math.cosh(wm.d),Math.abs(a)<1e-10&&(a=0),void rn(a)):fl(wm)?void qn(sm):(wn(P),qn(wm),pl(2))},_a=function(){var a;return a=kp,qn(Zo(xd)),qn(ig(wm)),wa(),qn(hg(wm)),wa(),wm=Nm(),wm===Zo(xd)?Uj():qn(wm),xh(),pl(kp-a)},xh=function(){if(Zn(),xm=Nm(),wm=Nm(),0===Rc(wm,xm))return qn(wm),void Sn();if(qk(wm))return zh(),void Sn();if(jg(wm)===Zo(ud))return yh(),void Sn();for(ym=tg(wm);uk(ym);)qn(jg(ym)),qn(xm),xh(),ym=tg(ym);return Sn()},zh=function(){var a;for(a=0,ym=tg(wm);uk(ym);)Rc(jg(ym),xm)&&(qn(jg(ym)),qn(xm),xh()),ym=tg(ym);for(a=kp,ym=tg(wm);uk(ym);)0===Rc(jg(ym),xm)&&qn(jg(ym)),ym=tg(ym);if(kp-a)return tf(kp-a),ym=Nm(),qn(ym),qn(ym),$l()},yh=function(){var a;for(a=0,ym=tg(wm);uk(ym);)Rc(jg(ym),xm)&&(qn(jg(ym)),qn(xm),xh()),ym=tg(ym);for(a=kp,ym=tg(wm);uk(ym);)0===Rc(jg(ym),xm)&&qn(jg(ym)),ym=tg(ym);if(kp-a)return Sl(kp-a)},Ah=function(){return ym=Zf(wm),zm=lg(wm),Am=hg(wm),cl(ym)||To("function name?"),jg(Am)===Zo(ra)&&(qn(ig(Am)),wa(),Am=Nm()),so(ym,Am,zm),wn(xd)},ab=function(){for(qn(ig(wm)),wa(),xm=Nm(),wm=sg(wm);uk(wm);)qn(jg(wm)),wm=tg(wm),wa(),ym=Nm(),qn(jg(wm)),wm=tg(wm),wa(),zm=Nm(),qn(jg(wm)),wm=tg(wm),wa(),Am=Nm(),qn(xm),qn(ym),fk(),xm=Nm(),qn(xm),qn(ym),qn(Am),Wo(),wa(),qn(xm),qn(ym),qn(zm),Wo(),wa(),Xo(),xm=Nm();return qn(xm)},bb=function(){return qn(ig(wm)),wa(),qn(hg(wm)),wa(),wm=Nm(),wm===Zo(xd)?Uj():qn(wm),Dh()},Dh=function(){return Zn(),xm=Nm(),wm=Nm(),ym=fq,Kp(wm),qn(ym),Sn()},Kp=function(a){var b;if(Fi(a,xm)){if(fl(ym))return ym=sm}else if(jg(a)===Zo(Pd)){if(Fi(ig(a),xm)&&Qk(hg(a))&&nl(ym,hg(a)))return ym=hg(a)}else if(uk(a)){for(a=tg(a),b=[];uk(a);)Kp(jg(a)),b.push(a=tg(a));return b}},cb=function(){return qn(ig(wm)),wa(),Eh()},Eh=function(){var a;if(a=0,Zn(),wm=Nm(),jg(wm)===Zo(e)&&(qn(wm),Jn(),wm=Nm()),jg(wm)===Zo(ud)){for(a=kp,wm=tg(wm);uk(wm);)qn(jg(wm)),Eh(),wm=tg(wm);Sl(kp-a)}else _k(wm)?(qn(wm),Kl()):jg(wm)===Zo(Pd)&&Nk(hg(wm))?(qn(wm),Mn()):qn(sm);return Sn()},db=function(){var a,b,c,d,e;for(0,wm=tg(wm),qn(jg(wm)),wa(),wm=tg(wm),qn(jg(wm)),wa(),xm=Nm(),xm===Zo(xd)?(Uj(),qn(Zo(xd))):Qk(xm)?(Uj(),qn(xm)):(qn(xm),wm=tg(wm),qn(jg(wm)),wa()),Am=Nm(),zm=Nm(),ym=Nm();;){if(Qk(Am)?(qn(Am),2147483648===(b=Qm())&&To("nth derivative: check n")):b=1,qn(ym),b>=0)for(c=0,d=b;0<=d?c<d:c>d;0<=d?++c:--c)qn(zm),Hh();else for(b=-b,a=0,e=b;0<=e?a<e:a>e;0<=e?++a:--a)qn(zm),fk();if(ym=Nm(),Am===Zo(xd))break;if(Qk(Am)){if(wm=tg(wm),qn(jg(wm)),wa(),(Am=Nm())===Zo(xd))break;Qk(Am)?1:(zm=Am,wm=tg(wm),qn(jg(wm)),wa(),Am=Nm())}else zm=Am,wm=tg(wm),qn(jg(wm)),wa(),Am=Nm()}return qn(ym)},Hh=function(){return Zn(),xm=Nm(),wm=Nm(),Qk(xm)&&To("undefined function"),el(wm)?el(xm)?ih():hh():el(xm)?gh():eh(),Sn()},eh=function(){return cl(xm)?fh():(qn(wm),qn(xm),qn(Zo($d)),Wo(),qn(Zo($d)),Hh(),qn(Zo($d)),qn(xm),Wo())},fh=function(){return Fi(wm,xm)?void qn(sm):uk(wm)?qk(wm)?void bi():jg(wm)===Zo(ud)?void Yh():jg(wm)===Zo(Pd)?void Xh():jg(wm)===Zo(W)?void wh():jg(wm)===Zo(jd)?void Uh():jg(wm)===Zo(de)?void _h():jg(wm)===Zo(O)?void uh():jg(wm)===Zo(Ae)?void ci():jg(wm)===Zo(j)?void mh():jg(wm)===Zo(h)?void kh():jg(wm)===Zo(l)?void oh():jg(wm)===Zo(ee)?void ai():jg(wm)===Zo(P)?void vh():jg(wm)===Zo(Be)?void di():jg(wm)===Zo(k)?void nh():jg(wm)===Zo(i)?void lh():jg(wm)===Zo(m)?void ph():jg(wm)===Zo(d)?void jh():jg(wm)===Zo(ae)?void $h():jg(wm)===Zo(Uc)?void Mh():jg(wm)===Zo(pa)?void Fh():jg(wm)===Zo(qa)?void Gh():jg(wm)===Zo(r)?void(fl(hg(wm))?qh():rh()):jg(wm)===Zo(s)?void(fl(hg(wm))?sh():th()):jg(wm)===Zo(Zc)&&hg(wm)===xm?void Ih():Lh():void qn(fq)},bi=function(){var a;for(a=kp,wm=tg(wm);uk(wm);)qn(jg(wm)),qn(xm),Hh(),wm=tg(wm);return tf(kp-a)},Yh=function(){var a,b,c,d,e,f,g;for(b=0,c=0,d=0,d=ml(wm)-1,b=e=0,f=d;0<=f?e<f:e>f;b=0<=f?++e:--e){for(ym=tg(wm),c=a=0,g=d;0<=g?a<g:a>g;c=0<=g?++a:--a)qn(jg(ym)),b===c&&(qn(xm),Hh()),ym=tg(ym);Sl(d)}return tf(d)},Xh=function(){return qn(hg(wm)),qn(ig(wm)),Ph(),qn(ig(wm)),qn(xm),Hh(),Rl(),qn(ig(wm)),ql(),qn(hg(wm)),qn(xm),Hh(),Rl(),sf(),qn(wm),Rl()},Uh=function(){return qn(ig(wm)),qn(xm),Hh(),qn(ig(wm)),Ph()},wh=function(){return qn(ig(wm)),qn(xm),Hh(),ym=Nm(),jg(ym)===Zo(W)?(wn(W),wn(W),qn(ig(ym)),nl(hg(ym),hg(wm))?(qn(hg(ym)),pl(3),qn(hg(wm))):(qn(hg(wm)),pl(3),qn(hg(ym))),pl(3)):(qn(ym),qn(hg(wm)),Hh())},Lh=function(){return ym=tg(wm),ym===Zo(xd)||Rc(ym,xm)?(wn(W),qn(wm),qn(xm),pl(3)):qn(fq)},_h=function(){return qn(ig(wm)),qn(xm),Hh(),qn(ig(wm)),$g(),Rl()},uh=function(){return qn(ig(wm)),qn(xm),Hh(),qn(ig(wm)),Jo(),Rl(),$l()},ci=function(){return qn(ig(wm)),qn(xm),Hh(),qn(ig(wm)),$g(),un(-2),Rm(),Rl()},mh=function(){return qn(ig(wm)),qn(xm),Hh(),un(1),qn(ig(wm)),un(2),Rm(),Xo(),vn(-1,2),Rm(),Rl()},kh=function(){return qn(ig(wm)),qn(xm),Hh(),un(1),qn(ig(wm)),un(2),Rm(),Xo(),vn(-1,2),Rm(),Rl(),$l()},oh=function(){return qn(ig(wm)),qn(xm),Hh(),un(1),qn(ig(wm)),un(2),Rm(),sf(),kk(),Rl(),Do()},ai=function(){return qn(ig(wm)),qn(xm),Hh(),qn(ig(wm)),wp(),Rl()},vh=function(){return qn(ig(wm)),qn(xm),Hh(),qn(ig(wm)),Cp(),Rl()},di=function(){return qn(ig(wm)),qn(xm),Hh(),qn(ig(wm)),wp(),un(-2),Rm(),Rl()},nh=function(){return qn(ig(wm)),qn(xm),Hh(),qn(ig(wm)),un(2),Rm(),un(1),sf(),vn(-1,2),Rm(),Rl()},lh=function(){return qn(ig(wm)),qn(xm),Hh(),qn(ig(wm)),un(2),Rm(),un(-1),sf(),vn(-1,2),Rm(),Rl()},ph=function(){return qn(ig(wm)),qn(xm),Hh(),un(1),qn(ig(wm)),un(2),Rm(),Xo(),kk(),Rl()},jh=function(){return qn(ig(wm)),qn(xm),Hh(),qn(ig(wm)),xo(),Rl()},$h=function(){return qn(ig(wm)),qn(xm),Hh(),qn(ig(wm)),Nh(),Rl(),un(2),Rl()},Mh=function(){return qn(ig(wm)),qn(xm),Hh(),un(2),qn(hg(wm)),Rl(),Rl(),qn(ig(wm)),qn(hg(wm)),un(-1),sf(),Wj(),Rl()},Fh=function(){return qn(ig(wm)),un(2),Rm(),un(-1),Rl(),Vi(),wn(Nd),vn(-1,2),Rm(),Rl(),un(2),Rl(),qn(ig(wm)),qn(xm),Hh(),Rl()},Gh=function(){return qn(ig(wm)),un(2),Rm(),un(-1),Rl(),Vi(),wn(Nd),vn(-1,2),Rm(),Rl(),un(-2),Rl(),qn(ig(wm)),qn(xm),Hh(),Rl()},qh=function(){return qn(ig(wm)),qn(xm),Hh(),qn(ig(wm)),un(1),Lf(),Rl(),un(-1),Rl()},rh=function(){return qn(ig(wm)),qn(xm),Hh(),qn(ig(wm)),qn(hg(wm)),un(-1),sf(),Lf(),qn(hg(wm)),un(-1),Rl(),qn(ig(wm)),Ph(),qn(ig(wm)),qn(hg(wm)),Lf(),Rl(),sf(),Rl()},sh=function(){return qn(ig(wm)),qn(xm),Hh(),qn(ig(wm)),un(1),Lf(),Rl(),un(-1),Rl()},th=function(){return qn(ig(wm)),qn(xm),Hh(),qn(ig(wm)),qn(hg(wm)),un(-1),sf(),Mf(),qn(hg(wm)),un(-1),Rl(),qn(ig(wm)),Ph(),qn(ig(wm)),qn(hg(wm)),Mf(),Rl(),sf(),Rl()},Ih=function(){return qn(ig(wm))},Y=function(){return el(wm)?2!==wm.tensor.ndim?0:wm.tensor.dim[0]!==wm.tensor.dim[1]?0:1:0},Jh=function(){var a,b,c,d,e,f,g;if(c=0,d=0,Zn(),wm=Nm(),0===Y())return wn(X),qn(wm),pl(2),void Sn();for(d=wm.tensor.nelem,a=wm.tensor.elem,c=e=0,f=d;(0<=f?e<f:e>f)&&Qk(a[c]);c=0<=f?++e:--e);if(c===d)Lp();else{for(c=b=0,g=wm.tensor.nelem;0<=g?b<g:b>g;c=0<=g?++b:--b)qn(wm.tensor.elem[c]);Kh(wm.tensor.dim[0])}return Sn()},Kh=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o;for(e=0,f=0,g=0,h=0,j=0,m=0,n=0,o=0,b=[],e=kp-a*a,f=i=0,k=a;0<=k?i<k:i>k;f=0<=k?++i:--i)b[f]=f,b[f+a]=0,b[f+a+a]=1;for(n=1,qn(fq);;){for(un(1===n?1:-1),f=c=0,l=a;0<=l?c<l:c>l;f=0<=l?++c:--c)h=a*b[f]+f,qn(Oo[e+h]),Rl();for(sf(),g=a-1,m=0,d=!1;;)if((j=b[a+g]+b[a+a+g])<0)b[a+a+g]=-b[a+a+g],g--;else{if(j!==g+1)break;if(0===g){d=!0;break}m++,b[a+a+g]=-b[a+a+g],g--}if(d)break;o=b[g-b[a+g]+m],b[g-b[a+g]+m]=b[g-j+m],b[g-j+m]=o,b[a+g]=j,n=-n}return Oo[e]=Oo[kp-1],kp=e+1},function(){return Zn(),wm=Nm(),0===Y()?(wn(X),qn(wm),pl(2),void Sn()):(Lp(),Sn())},Lp=function(){var a,b,c,d;for(a=0,b=0,b=wm.tensor.dim[0],a=c=0,d=b*b;0<=d?c<d:c>d;a=0<=d?++c:--c)qn(wm.tensor.elem[a]);return sl(b),kp-=b*b,qn(wm)},kd=function(a,b,c,d){return Oo[a+b*c+d]},po=function(a,b,c,d,e){return Oo[a+b*c+d]=e},sl=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s;for(f=0,g=0,h=0,i=0,g=kp-a*a,wm=sm,f=j=0,k=a-1;0<=k?j<k:j>k;f=0<=k?++j:--j){if(Fi(kd(g,a,f,f),fq)){for(h=b=l=f+1,m=a;(l<=m?b<m:b>m)&&Fi(kd(g,a,h,f),fq);h=l<=m?++b:--b);if(h===a){wm=fq;break}for(i=c=n=f,o=a;n<=o?c<o:c>o;i=n<=o?++c:--c)xm=kd(g,a,f,i),po(g,a,f,i,kd(g,a,h,i)),po(g,a,h,i,xm);qn(wm),$l(),wm=Nm()}for(qn(wm),qn(kd(g,a,f,f)),Rl(),wm=Nm(),h=d=p=f+1,q=a;p<=q?d<q:d>q;h=p<=q?++d:--d)for(qn(kd(g,a,h,f)),qn(kd(g,a,f,f)),Ph(),$l(),xm=Nm(),po(g,a,h,f,fq),i=e=r=f+1,s=a;r<=s?e<s:e>s;i=r<=s?++e:--e)qn(kd(g,a,f,i)),qn(xm),Rl(),qn(kd(g,a,h,i)),sf(),po(g,a,h,i,Nm())}return qn(wm),qn(kd(g,a,a-1,a-1)),Rl(),wm=Nm()},gb=function(){return qn(ig(wm)),wa(),Nh()},Nh=function(){return Zn(),xp(),Sn()},xp=function(){return wm=Nm(),xk(wm)?0===wm.d?void un(1):void un(0):_k(wm)?vd(Gl(wm.q.a,wm.q.b))?void un(1):void un(0):jg(wm)===Zo(Pd)?(wn($),qn(ig(wm)),void pl(2)):Nk(wm)?(wn($),qn(wm),$l(),void pl(2)):((Nk(wm)||jg(wm)===Zo(e)&&Nk(ig(wm)))&&(qn(wm),$l(),wm=Nm()),wn($),qn(wm),pl(2))},Rh=function(){var a,b,c,d,e,f;for(b=0,a=0,c=0,Zn(),a=kp-1,Sh(),c=kp-a,f=Oo.slice(a,a+c),f.sort(Hg),Oo=Oo.slice(0,a).concat(f).concat(Oo.slice(a+c)),wm=xf(c),wm.tensor.ndim=1,wm.tensor.dim[0]=c,b=d=0,e=c;0<=e?d<e:d>e;b=0<=e?++d:--d)wm.tensor.elem[b]=Oo[a+b];return kp=a,qn(wm),Sn()},Sh=function(){var a,b,c,d,f,g;if(a=0,b=0,c=0,d=0,Zn(),wm=Nm(),a=kp,Qk(wm))qn(wm),ij();else if(jg(wm)===Zo(e))qn(wm),df();else if(jg(wm)===Zo(ud))for(wm=tg(wm),Qk(jg(wm))&&(qn(jg(wm)),ij(),wm=tg(wm));uk(wm);)xm=jg(wm),jg(xm)===Zo(Pd)?(qn(ig(xm)),qn(hg(xm))):(qn(xm),qn(sm)),wm=tg(wm);else jg(wm)===Zo(Pd)?(qn(ig(wm)),qn(hg(wm))):(qn(wm),qn(sm));for(c=kp,qn(sm),Kj(a,c),d=kp-c,b=f=0,g=d;0<=g?f<g:f>g;b=0<=g?++f:--f)Oo[a+b]=Oo[c+b];return kp=a+d,Sn()},Kj=function(a,b){var c,d,e,f;if(c=0,d=0,Zn(),wm=Nm(),a===b)return qn(wm),void Sn();if(xm=Oo[a+0],ym=Oo[a+1],qn(ym),2147483648!==(c=Qm()))for(d=e=0,f=Math.abs(c);0<=f?e<=f:e>=f;d=0<=f?++e:--e)qn(wm),qn(xm),un(zo(c)*d),Rm(),Rl(),Kj(a+2,b);return Sn()},df=function(){for(Zn(),wm=Nm(),ym=tg(wm),qn(jg(ym)),ym=tg(ym);uk(ym);)qn(jg(ym)),Cj(),ym=tg(ym);if(xm=Nm(),Tk(xm))return qn(wm),qn(sm),void Sn();if(Qk(xm))qn(xm),ij();else if(jg(xm)===Zo(ud))for(ym=tg(xm),Qk(jg(ym))?(qn(jg(ym)),ij()):(qn(jg(ym)),qn(sm)),ym=tg(ym);uk(ym);)qn(jg(ym)),qn(sm),ym=tg(ym);else qn(xm),qn(sm);for(qn(xm),kk(),xm=Nm(),qn(fq),ym=tg(wm);uk(ym);)qn(xm),qn(jg(ym)),Rl(),sf(),ym=tg(ym);return qn(sm),Sn()},Wh=function(){var a,b,c,d,e,f;return a=0,b=0,c=0,d=0,e=0,f=0,d=Om(),c=Om(),0===c&&d<0&&To("divide by zero"),c>=0||d%1==0?(e=Math.pow(c,d),void rn(e)):(e=Math.pow(Math.abs(c),d),f=Math.PI*d,d%.5==0?(a=0,b=Math.sin(f)):(a=Math.cos(f),b=Math.sin(f)),rn(a*e),rn(b*e),qn(Zj),Rl(),sf())},la=0,na=[],oa=[],kb=function(){return 0===ma()&&To("eigen: argument is not a square matrix"),fi(ia),wm=sp("D"),ro(wm,xm),wm=sp("Q"),ro(wm,ym),qn(Zo(xd))},lb=function(){return 0===ma()?(wn(ja),qn(wm),void pl(2)):(fi(ja),qn(xm))},mb=function(){return 0===ma()?(wn(ka),qn(wm),void pl(2)):(fi(ka),qn(ym))},ma=function(){var a,b,c,d,e,f,g,h,i,j,k;if(d=0,e=0,qn(ig(wm)),wa(),Rp(),wa(),wm=Nm(),!el(wm))return 0;for(2===wm.tensor.ndim&&wm.tensor.dim[0]===wm.tensor.dim[1]||To("eigen: argument is not a square matrix"),la=wm.tensor.dim[0],d=f=0,g=la;0<=g?f<g:f>g;d=0<=g?++f:--f)for(e=a=0,h=la;0<=h?a<h:a>h;e=0<=h?++a:--a)xk(wm.tensor.elem[la*d+e])||To("eigen: matrix is not numerical");for(d=b=0,i=la-1;0<=i?b<i:b>i;d=0<=i?++b:--b)for(e=c=j=d+1,k=la;j<=k?c<k:c>k;e=j<=k?++c:--c)Math.abs(wm.tensor.elem[la*d+e].d-wm.tensor.elem[la*e+d].d)>1e-10&&To("eigen: matrix is not symmetrical");return 1},fi=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y;for(k=0,l=0,k=m=0,n=la*la;0<=n?m<n:m>n;k=0<=n?++m:--m)na[k]=0;for(k=b=0,o=la*la;0<=o?b<o:b>o;k=0<=o?++b:--b)oa[k]=0;for(k=c=0,q=la;0<=q?c<q:c>q;k=0<=q?++c:--c)for(na[la*k+k]=wm.tensor.elem[la*k+k].d,l=d=r=k+1,s=la;r<=s?d<s:d>s;l=r<=s?++d:--d)na[la*k+l]=wm.tensor.elem[la*k+l].d,na[la*l+k]=wm.tensor.elem[la*k+l].d;for(k=e=0,t=la;0<=t?e<t:e>t;k=0<=t?++e:--e)for(oa[la*k+k]=1,l=f=u=k+1,v=la;u<=v?f<v:f>v;l=u<=v?++f:--f)oa[la*k+l]=0,oa[la*l+k]=0;for(k=g=0;g<100&&0!==Ro();k=++g);if(100===k&&printstr("\nnote: eigen did not converge\n"),a===ia||a===ja)for(qn(wm),Zg(),xm=Nm(),k=h=0,w=la;0<=w?h<w:h>w;k=0<=w?++h:--h)for(l=i=0,x=la;0<=x?i<x:i>x;l=0<=x?++i:--i)rn(na[la*k+l]),xm.tensor.elem[la*k+l]=Nm();if(a===ia||a===ka){for(qn(wm),Zg(),ym=Nm(),y=[],k=j=0,p=la;0<=p?j<p:j>p;k=0<=p?++j:--j)y.push(function(){var a,b,c;for(c=[],l=a=0,b=la;0<=b?a<b:a>b;l=0<=b?++a:--a)rn(oa[la*k+l]),c.push(ym.tensor.elem[la*k+l]=Nm());return c}());return y}},Ro=function(){var a,b,c,d,e,f,g,h;for(c=0,d=0,b=0,c=e=0,f=la-1;0<=f?e<f:e>f;c=0<=f?++e:--e)for(d=a=g=c+1,h=la;g<=h?a<h:a>h;d=g<=h?++a:--a)0!==na[la*c+d]&&(So(c,d),b++);return b},So=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o;for(g=0,n=0,o=0,e=0,f=0,l=0,m=0,o=.5*(na[la*a+a]-na[la*b+b])/na[la*a+b],n=1/(Math.abs(o)+Math.sqrt(o*o+1)),o<0&&(n=-n),e=1/Math.sqrt(n*n+1),l=n*e,g=h=0,i=la;0<=i?h<i:h>i;g=0<=i?++h:--h)f=na[la*a+g],m=na[la*b+g],na[la*a+g]=e*f+l*m,na[la*b+g]=e*m-l*f;for(g=c=0,j=la;0<=j?c<j:c>j;g=0<=j?++c:--c)f=na[la*g+a],m=na[la*g+b],na[la*g+a]=e*f+l*m,na[la*g+b]=e*m-l*f;for(g=d=0,k=la;0<=k?d<k:d>k;g=0<=k?++d:--d)f=oa[la*a+g],m=oa[la*b+g],oa[la*a+g]=e*f+l*m,oa[la*b+g]=e*m-l*f;return na[la*a+b]=0,na[la*b+a]=0},nb=function(){return qn(ig(wm)),wa(),yp()},yp=function(){return Zn(),Np(),Sn()},Np=function(){var a;return a=0,wm=Nm(),xk(wm)?(a=1-Ii(wm.d),void rn(a)):Nk(wm)?(wn(pa),qn(wm),$l(),pl(2),void $l()):(wn(pa),qn(wm),void pl(2))},ob=function(){return qn(ig(wm)),wa(),zp()},zp=function(){return Zn(),Op(),Sn()},Op=function(){var a;if(a=0,wm=Nm(),xk(wm))return a=Ii(wm.d),void rn(a);wn(qa),qn(wm),pl(2)},Ii=function(a){var b,c,d;return c=0,d=0,b=0,d=Math.abs(a),c=1/(1+.5*d),b=c*Math.exp(-d*d-1.26551223+c*(1.00002368+c*(.37409196+c*(.09678418+c*(c*(.27886807+c*(c*(1.48851587+c*(.17087277*c-.82215223))-1.13520398))-.18628806))))),a>=0?b:2-b},wa=function(){switch(xg(),Zn(),wm=Nm(),wm.k){case M:Xa();break;case Hd:case da:case je:qn(wm);break;case De:yc();break;case me:uc();break;default:To("atom?")}return Sn()},uc=function(){return Hk(wm)?(qn(wm),qn(Zo(fd)),pl(2),void wa()):(xm=Mj(wm),qn(xm),wm!==xm?wa():void 0)},Xa=function(){switch(cl(jg(wm))||To("cons?"),$o(jg(wm))){case d:return ya();case e:return za();case f:return Aa();case g:return Ba();case h:return Ca();case i:return Da();case j:return Ea();case k:return Fa();case l:return Ga();case m:return Ha();case n:return Ia();case o:return Eval_atomize();case r:return Ja();case s:return Ka();case t:return La();case u:return Ma();case C:return Na();case D:return Oa();case E:return Pa();case F:return Qa();case G:return Ra();case H:return Sa();case I:return Ta();case J:return Ua();case K:return Va();case L:return Wa();case N:return Ya();case O:return Za();case P:return $a();case S:return _a();case U:return bb();case T:return ab();case V:return cb();case W:return db();case X:return eb();case Z:return fb();case $:return gb();case _:return Eval_display();case aa:return hb();case ba:return ib();case ca:return Gb();case ea:return Eval_draw();case ga:return jb();case ia:return kb();case ja:return lb();case ka:return mb();case pa:return nb();case qa:return ob();case ra:return xa();case sa:return pb();case ta:return qb();case ua:return rb();case va:return sb();case Kc:return tb();case Lc:return ub();case Mc:return vb();case Nc:return wb();case Oc:return xb();case Pc:return yb();case Qc:return zb();case Sc:return Ab();case Tc:return Bb();case Uc:return Cb();case Vc:return Db();case Wc:return Eb();case Xc:return Fb();case Yc:return Gb();case Zc:return Hb();case $c:return Ib();case _c:return Jb();case cd:return Kb();case dd:return Lb();case ed:return Mb();case gd:return Nb();case hd:return Ob();case id:return Pb();case jd:return Qb();case ld:return Rb();case sd:return Sb();case ud:return Tb();case yd:return Ub();case zd:return Vb();case Id:return Wb();case Jd:return Xb();case Kd:return Yb();case Ld:return Zb();case Md:return $b();case Od:return _b();case Pd:return ac();case Qd:return cc();case Rd:return Eval_display();case Td:return dc();case Ud:return ec();case Vd:return fc();case Wd:return gc();case Xd:return hc();case Yd:return ic();case _e:return jc();case Zd:return kc();case _d:return lc();case ae:return mc();case ce:return oc();case de:return pc();case ee:return qc();case be:return nc();case he:return rc();case ie:return sc();case ke:return tc();case le:return Eval_sum();case Ae:return vc();case Be:return wc();case Ce:return xc();case Ee:return zc();case Fe:return Ac();case Ge:return Bc();case He:return Cc();case Ie:return Dc();case Je:return Ec();case Me:return Fc();case Ye:return Gc();case af:return Ic();default:return Hc()}},La=function(){return qn(Mj(ig(wm)))},Oa=function(){return qn(ig(wm)),bc(),wm=Nm(),fl(wm)&&To("check(arg): arg is zero"),qn(Zo(xd))},eb=function(){return qn(ig(wm)),wa(),Jh()},fb=function(){var a;return qn(ig(wm)),wa(),xm=Nm(),uk(sg(wm))?(qn(hg(wm)),wa(),a=Qm()):a=1,el(xm)?a<1||a>xm.tensor.ndim?qn(wm):un(xm.tensor.dim[a-1]):un(1)},hb=function(){return qn(ig(wm)),wa(),Rh()},ib=function(){var a;for(qn(jg(wm)),wm=tg(wm),a=[];uk(wm);)Nm(),qn(jg(wm)),wa(),a.push(wm=tg(wm));return a},jb=function(){return qn(ig(wm)),wa(),qn(hg(wm)),wa(),qn(gg(wm)),wa(),dsolve()},xa=function(){for(qn(ig(wm)),wa(),wm=sg(wm);uk(wm);)qn(jg(wm)),wa(),qn(ig(wm)),wa(),Wo(),wm=sg(wm);return wa()},pb=function(){return qn(ig(wm)),wa(),Vi()},ub=function(){return qn(ig(wm)),wa(),kj()},vb=function(){var a;for(wm=tg(wm),qn(jg(wm)),wa(),wm=tg(wm),qn(jg(wm)),wa(),lj(),wm=tg(wm),a=[];uk(wm);)qn(jg(wm)),wa(),lj(),a.push(wm=tg(wm));return a},Cb=function(){return qn(ig(wm)),wa(),qn(hg(wm)),wa(),Wj()},Db=function(){return qn(ig(wm)),wa(),Xj()},Fb=function(){var a;for(a=kp,wm=tg(wm);uk(wm);)qn(jg(wm)),wa(),wm=tg(wm);return $j(kp-a)},Ib=function(){return qn(ig(wm)),wa(),jk()},Jb=function(){return qn(ig(wm)),wa(),mk()},Kb=function(){var a;return qn(ig(wm)),wa(),wm=Nm(),_k(wm)?void qn(Fk(wm)?sm:fq):xk(wm)?(a=Math.floor(wm.d),void qn(a===wm.d?sm:fq)):(wn(cd),qn(wm),pl(2))},Tb=function(){var a;for(qn(ig(wm)),wa(),wm=sg(wm),a=[];uk(wm);)qn(jg(wm)),wa(),Rl(),a.push(wm=tg(wm));return a},Wb=function(){return qn(ig(wm)),wa(),wm=Nm(),un(wm.k===Hd||wm.k===da?1:0)},Yb=function(){var a;for(a=kp,wn(Kd),wm=tg(wm);uk(wm);)qn(jg(wm)),wa(),wm=tg(wm);return pl(kp-a)},function(){for(wm=tg(wm);uk(wm);)qn(jg(wm)),wa(),Gi(Mj(Zo(Ne)),1)?on(Nm()):Oh(Nm()),wm=tg(wm);return qn(Zo(xd))},ec=function(){return qn(ig(wm))},gc=function(){return qn(ig(wm)),wa(),wm=Nm(),el(wm)?un(wm.tensor.ndim):qn(fq)},uo=function(){var a;for(zm=ag(wm),cl(zm)||To("indexed assignment: error in symbol"),a=kp,qn(hg(wm)),wa(),xm=lg(wm);uk(xm);)qn(jg(xm)),wa(),xm=tg(xm);return to(kp-a),ym=Nm(),ro(zm,ym),qn(Zo(xd))},lc=function(){return Zf(wm)===Zo(Xc)?void uo():uk(ig(wm))?void Ah():(cl(ig(wm))||To("symbol assignment: error in symbol"),qn(hg(wm)),wa(),xm=Nm(),ro(ig(wm),xm),qn(Zo(xd)))},rc=function(){return qn(ig(wm)),wa(),vn(1,2),Rm()},sc=function(){return To("user stop")},tc=function(){return qn(gg(wm)),wa(),qn(hg(wm)),wa(),qn(ig(wm)),wa(),Wo(),wa()},Gc=function(){var a,b,c,d;if(a=0,b=0,qn(ig(wm)),wa(),(b=Qm())<2)return void qn(wm);for(wm=xf(b*b),wm.tensor.ndim=2,wm.tensor.dim[0]=b,wm.tensor.dim[1]=b,a=c=0,d=b;0<=d?c<d:c>d;a=0<=d?++c:--c)wm.tensor.elem[b*a+a]=sm;return wm.tensor.nelem!==wm.tensor.elem.length&&console.log("something wrong in tensor dimensions"),qn(wm)},function(){var a;return a=Ti,Ti=0,wa(),Ti=a},bc=function(){return Zn(),wm=Nm(),jg(wm)===Zo(_d)?Ac():(qn(wm),wa()),Sn()},qb=function(){return qn(ig(wm)),wa(),qn(hg(wm)),wa(),xm=Nm(),xm===Zo(xd)?Uj():qn(xm),Mi()},Mi=function(){if(Zn(),Em=Nm(),Am=Nm(),el(Am))return Si(),void Sn();if(jg(Am)===Zo(e)){for(un(0),wm=tg(Am);uk(wm);)qn(jg(wm)),qn(Em),Mi(),sf(),wm=tg(wm);return void Sn()}return qn(Am),pm(),ym=Nm(),qn(Am),Eh(),xm=Nm(),Qn(),qn(ym),qn(xm),qn(Em),!isone(ym)&&!isone(xm)||Uk(xm,Em)&&!isone(xm)?(Th(),Cm=Nm(),qn(ym),qn(xm),qn(Cm),Rl(),Xo(),ym=Nm(),fl(ym)?(qn(Cm),void Sn()):(qn(xm),qn(Em),lj(),xm=Nm(),Qi(),Pi(),Ni(),el(zm)?(qn(zm),jk(),qn(ym),ck(),qn(xm),ck()):(qn(ym),qn(zm),Ph(),qn(xm),Rl()),qn(Cm),sf(),Sn())):(Nm(),Nm(),Nm(),qn(Am),void Sn())},Si=function(){var a,b,c;for(a=0,qn(Am),Zg(),Am=Nm(),a=b=0,c=Am.tensor.nelem;0<=c?b<c:b>c;a=0<=c?++b:--b)qn(Am.tensor.elem[a]),qn(Em),Mi(),Am.tensor.elem[a]=Nm();return qn(Am)},Qn=function(){var a,b,c,d,e,f,g;for(a=0,b=0,c=0,d=0,e=0,a=kp,mj(xm),mj(ym),e=kp-a,c=0,b=f=0,g=e;0<=g?f<g:f>g;b=0<=g?++f:--f)wm=Oo[a+b],jg(wm)===Zo(Pd)&&ig(wm)===Em&&(qn(hg(wm)),2147483648!==(d=Qm())&&d<c&&(c=d));if(kp=a,0!==c)return qn(xm),qn(Em),un(-c),Rm(),Rl(),xm=Nm(),qn(ym),qn(Em),un(-c),Rm(),Rl(),ym=Nm()},Qi=function(){var a,b,c,d,e,f,g,h,i;if(c=0,d=0,e=0,f=0,c=kp,jg(xm)===Zo(ud))for(wm=tg(xm);uk(wm);)Am=jg(wm),Ri(),wm=tg(wm);else Am=xm,Ri();if(1===(f=kp-c))return void(zm=Nm());for(zm=xf(f*f),zm.tensor.ndim=2,zm.tensor.dim[0]=f,zm.tensor.dim[1]=f,a=c,d=g=0,h=f;0<=h?g<h:g>h;d=0<=h?++g:--g)for(e=b=0,i=f;0<=i?b<i:b>i;e=0<=i?++b:--b)qn(Oo[a+e]),qn(Em),un(d),Rm(),Ph(),qn(Em),pj(),zm.tensor.elem[f*d+e]=Nm();return kp-=f},Ri=function(){var a,b,c,d,e,f,g;if(a=0,b=0,c=0,d=0,Rc(Am,Em)){for(op(),jg(Am)===Zo(Pd)?(qn(hg(Am)),d=Qm(),Bm=ig(Am)):(d=1,Bm=Am),qn(Bm),qn(Em),Dh(),a=Qm(),g=[],b=e=0,f=d;0<=f?e<f:e>f;b=0<=f?++e:--e)g.push(function(){var d,e,f;for(f=[],c=d=0,e=a;0<=e?d<e:d>e;c=0<=e?++d:--d)qn(Dm),qn(Bm),un(b),Rm(),Rl(),qn(Em),un(c),Rm(),f.push(Rl());return f}());return g}},op=function(){var a;if(a=0,jg(xm)===Zo(ud)){for(a=kp,vm=tg(xm);uk(vm);)Fi(jg(vm),Am)||(qn(jg(vm)),wa()),vm=tg(vm);Sl(kp-a)}else un(1);return Dm=Nm()},Pi=function(){var a,b,c,d;if(a=0,b=0,el(zm)){for(b=zm.tensor.dim[0],Dm=xf(b),Dm.tensor.ndim=1,Dm.tensor.dim[0]=b,a=c=0,d=b;0<=d?c<d:c>d;a=0<=d?++c:--c)qn(ym),qn(Em),un(a),Rm(),Ph(),qn(Em),pj(),Dm.tensor.elem[a]=Nm();return ym=Dm}},Ni=function(){var a,b,c,d,e;if(a=0,b=0,c=0,!el(zm))return qn(xm),Mn(),void(xm=Nm());if(a=kp,jg(xm)===Zo(ud))for(Dm=tg(xm);uk(Dm);)Am=jg(Dm),Oi(),Dm=tg(Dm);else Am=xm,Oi();for(c=kp-a,Dm=xf(c),Dm.tensor.ndim=1,Dm.tensor.dim[0]=c,b=d=0,e=c;0<=e?d<e:d>e;b=0<=e?++d:--d)Dm.tensor.elem[b]=Oo[a+b];return kp=a,xm=Dm},Oi=function(){var a,b,c,d,e,f,g;if(a=0,b=0,c=0,d=1,Rc(Am,Em)){for(jg(Am)===Zo(Pd)&&(qn(hg(Am)),d=Qm(),Am=ig(Am)),qn(Am),qn(Em),Dh(),a=Qm(),g=[],b=e=f=d;f<=0?e<0:e>0;b=f<=0?++e:--e)g.push(function(){var d,e,f;for(f=[],c=d=0,e=a;0<=e?d<e:d>e;c=0<=e?++d:--d)qn(Am),un(b),Rm(),Mn(),qn(Em),un(c),Rm(),f.push(Rl());return f}());return g}},rb=function(){return qn(ig(wm)),wa(),Ui()},Ui=function(){return Zn(),wm=Nm(),qn(Zj),qn(wm),Rl(),Vi(),vn(1,2),Rl(),qn(Zj),$l(),qn(wm),Rl(),Vi(),vn(1,2),Rl(),sf(),Sn()},sb=function(){return qn(ig(wm)),wa(),Xi()},Xi=function(){return Zn(),wm=Nm(),qn(Zj),qn(wm),Rl(),Vi(),qn(Zj),Ph(),vn(1,2),Rl(),qn(Zj),$l(),qn(wm),Rl(),Vi(),qn(Zj),Ph(),vn(1,2),Rl(),Xo(),Sn()},tb=function(){var a;for(qn(ig(wm)),wa(),qn(hg(wm)),wa(),xm=Nm(),xm===Zo(xd)?Uj():qn(xm),dj(),wm=rg(wm),a=[];uk(wm);)qn(jg(wm)),wa(),fj(),a.push(wm=tg(wm));return a},fj=function(){var a,b;if(Zn(),xm=Nm(),wm=Nm(),a=kp,jg(wm)===Zo(ud))for(wm=tg(wm);uk(wm);)qn(jg(wm)),qn(xm),jj(),wm=tg(wm);else qn(wm),qn(xm),jj();return b=kp-a,b>1&&Tl(b),Sn()},jj=function(){if(Zn(),lj(),wm=Nm(),jg(wm)===Zo(ud))for(wm=tg(wm);uk(wm);)qn(jg(wm)),wm=tg(wm);else qn(wm);return Sn()},dj=function(){return Zn(),xm=Nm(),wm=Nm(),Fk(wm)?(qn(wm),hj()):(qn(wm),qn(xm),lj()),Sn()},ij=function(){var a,b,c,d,e,f;for(c=0,Zn(),d=Qm(),2147483648===d&&To("number too big to factor"),d<0&&(d=-d),c=e=0,f=nd;(0<=f?e<f:e>f)&&!((a=Wm[c])>d/a);c=0<=f?++e:--e){for(b=0;d%a==0;)d/=a,b++;b&&(un(a),un(b))}return d>1&&(un(d),un(1)),Sn()},kj=function(){var a;return a=0,Zn(),wm=Nm(),qn(wm),(a=Qm())<0||2147483648===a?(wn(Lc),qn(wm),pl(2),void Sn()):(Of(a),Sn())},Io=function(){var a;if(a=0,Zn(),a=Ti,Ti=0,wm=Nm(),jg(wm)===Zo(e)){for(qn(fq),wm=tg(wm);uk(wm);)qn(jg(wm)),Io(),sf(),wm=tg(wm);return Ti=a,void Sn()}return jg(wm)===Zo(ud)?(vo(),Ti=a,void Sn()):(qn(wm),Ti=a,Sn())},vo=function(){var a,b,c,d,e,f,g,h,i,j,k;for(c=0,d=0,e=0,k=kp,wm=tg(wm),e=0;uk(wm);)qn(jg(wm)),wm=tg(wm),e++;for(c=f=0,g=e-1;0<=g?f<g:f>g;c=0<=g?++f:--f)if(Oo[k+c]!==Zo(xd))for(d=a=h=c+1,i=e;h<=i?a<i:a>i;d=h<=i?++a:--a)Oo[k+d]!==Zo(xd)&&wo(k,c,d);for(qn(sm),c=b=0,j=e;0<=j?b<j:b>j;c=0<=j?++b:--b)Oo[k+c]!==Zo(xd)&&(qn(Oo[k+c]),Rl());return wm=Nm(),kp-=e,qn(wm)},wo=function(a,b,c){var d,e,f,g;if(d=0,e=0,wm=Oo[a+b],xm=Oo[a+c],Zk(wm)?(ym=hg(wm),wm=ig(wm)):ym=sm,Zk(xm)?(zm=hg(xm),xm=ig(xm)):zm=sm,Ak(wm)&&Ak(xm)){if(qn(ym),qn(zm),sf(),Pp(),0!==(e=Qm()))return;if(qn(ig(wm)),qn(ig(xm)),Xo(),Pp(),0===(e=Qm())||2147483648===e)return;for(e<0&&(e=-e,Am=wm,wm=xm,xm=Am,Am=ym,ym=zm,zm=Am),qn(sm),d=f=1,g=e;1<=g?f<=g:f>=g;d=1<=g?++f:--f)qn(ig(xm)),un(d),sf(),qn(ym),Rm(),Rl();return Oo[a+b]=Nm(),Oo[a+c]=Zo(xd)}},Lm=0,nj=0,lj=function(){return Zn(),xm=Nm(),wm=Nm(),Rc(wm,xm)&&Uk(wm,xm)&&cl(xm)?(qn(wm),qn(xm),Qp(),Sn()):(qn(wm),void Sn())},Qp=function(){var a,b,c,d;for(a=0,b=0,Zn(),xm=Nm(),wm=Nm(),a=kp,Bk(wm)&&To("floating point numbers in polynomial"),Lm=kp,qn(wm),qn(xm),nj=Kg()-1,Kn(a);nj>0;){if(fl(Oo[Lm+0]))un(1),zm=Nm(),un(0),Am=Nm();else if(0===Nj()){tp&&printf("no factor found\n");break}for(qn(zm),qn(xm),Rl(),qn(Am),sf(),Dm=Nm(),tp&&(printf("success\nFACTOR="),print(Dm),printf("\n")),qn(Cm),qn(Dm),Xl(),Cm=Nm(),Mp();nj&&fl(Oo[Lm+nj]);)nj--}for(qn(fq),b=c=0,d=nj;0<=d?c<=d:c>=d;b=0<=d?++c:--c)qn(Oo[Lm+b]),qn(xm),un(b),Rm(),Rl(),sf();return wm=Nm(),tp&&(printf("POLY="),print(wm),printf("\n")),nj>0&&Nk(Oo[Lm+nj])&&(qn(wm),$l(),wm=Nm(),qn(Cm),_l(),Cm=Nm()),qn(Cm),qn(wm),Xl(),Cm=Nm(),tp&&(printf("RESULT="),print(Cm),printf("\n")),Oo[a]=Cm,kp=a+1,Sn()},Kn=function(a){var b,c,d,e,f,g,h;for(c=0,Cm=sm,c=d=e=a,f=kp;e<=f?d<f:d>f;c=e<=f?++d:--d)qn(Oo[c]),Eh(),qn(Cm),jl(),Cm=Nm();for(c=b=g=a,h=kp;g<=h?b<h:b>h;c=g<=h?++b:--b)qn(Cm),qn(Oo[c]),Rl(),Oo[c]=Nm();if(qn(Cm),Mn(),Cm=Nm(),R)return console.log("rationalize_coefficients result")},Nj=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r;if(h=0,0,g=0,a=0,f=0,i=0,j=0,tp){for(qn(fq),h=k=0,l=nj;0<=l?k<=l:k>=l;h=0<=l?++k:--k)qn(Oo[Lm+h]),qn(xm),un(h),Rm(),Rl(),sf();wm=Nm(),printf("POLY="),print(wm),printf("\n")}if(g=kp,f=kp,qn(Oo[Lm+nj]),Sh(),j=kp-f,a=kp,qn(Oo[Lm+0]),Sh(),i=kp-a,tp){for(printf("divisors of base term"),h=b=0,m=i;0<=m?b<m:b>m;h=0<=m?++b:--b)printf(", "),print(Oo[a+h]);for(printf("\n"),printf("divisors of leading term"),h=c=0,n=j;0<=n?c<n:c>n;h=0<=n?++c:--c)printf(", "),print(Oo[f+h]);printf("\n")}for(q=d=0,o=j;0<=o?d<o:d>o;q=0<=o?++d:--d)for(r=e=0,p=i;0<=p?e<p:e>p;r=0<=p?++e:--e){if(zm=Oo[f+q],Am=Oo[a+r],qn(Am),qn(zm),Ph(),$l(),ym=Nm(),Jc(),tp&&(printf("try A="),print(zm),printf(", B="),print(Am),printf(", root "),print(xm),printf("=-B/A="),print(ym),printf(", POLY("),print(ym),printf(")="),print(Bm),printf("\n")),fl(Bm))return kp=g,R&&console.log("get_factor returning 1"),1;if(qn(Am),$l(),Am=Nm(),qn(ym),$l(),ym=Nm(),Jc(),tp&&(printf("try A="),print(zm),printf(", B="),print(Am),printf(", root "),print(xm),printf("=-B/A="),print(ym),printf(", POLY("),print(ym),printf(")="),print(Bm),printf("\n")),fl(Bm))return kp=g,R&&console.log("get_factor returning 1"),1}return kp=g,R&&console.log("get_factor returning 0"),0},Mp=function(){var a,b,c;for(a=0,Bm=fq,a=b=c=nj;c<=0?b<0:b>0;a=c<=0?++b:--b)qn(Oo[Lm+a]),Oo[Lm+a]=Bm,qn(zm),Ph(),Bm=Nm(),qn(Oo[Lm+a-1]),qn(Bm),qn(Am),Rl(),Xo(),Oo[Lm+a-1]=Nm();if(Oo[Lm+0]=Bm,R)return console.log("yydivpoly Q:")},Jc=function(){var a,b,c;for(a=0,qn(fq),a=b=c=nj;c<=0?b<=0:b>=0;a=c<=0?++b:--b)qn(ym),Rl(),qn(Oo[Lm+a]),R&&(console.log("Evalpoly top of stack:"),Xm(Oo[kp-a])),sf();return Bm=Nm()},mj=function(a){var b;if(b=kp,jg(a)===Zo(e))for(a=tg(a);uk(a);)xn(jg(a)),a=tg(a);else xn(a);return kp-b},xn=function(a){var b;if(jg(a)===Zo(ud)){for(a=tg(a),b=[];uk(a);)qn(jg(a)),b.push(a=tg(a));return b}return qn(a)},wb=function(){var a;for(wm=tg(wm),qn(jg(wm)),wa(),wm=tg(wm),a=[];uk(wm);)qn(jg(wm)),wa(),pj(),a.push(wm=tg(wm));return a},pj=function(){return Zn(),xm=Nm(),wm=Nm(),qj(),Sn()},qj=function(){return jg(wm)===Zo(e)?rj():el(wm)?sj():Rc(wm,xm)?un(0):qn(wm)},rj=function(){var a;for(un(0),wm=tg(wm),a=[];uk(wm);)qn(jg(wm)),qn(xm),pj(),sf(),a.push(wm=tg(wm));return a},sj=function(){var a,b,c,d,e,f;for(b=0,c=0,c=wm.tensor.nelem,ym=xf(c),ym.tensor.ndim=wm.tensor.ndim,b=d=0,e=wm.tensor.ndim;0<=e?d<e:d>e;b=0<=e?++d:--d)ym.tensor.dim[b]=wm.tensor.dim[b];for(b=a=0,f=c;0<=f?a<f:a>f;b=0<=f?++a:--a)qn(wm.tensor.elem[b]),qn(xm),pj(),ym.tensor.elem[b]=Nm();return qn(ym)},xb=function(){return qn(ig(wm)),wa(),Rp(),wa()},Rp=function(){var a,b,c,d;if(b=0,a=0,Zn(),wm=Nm(),uk(wm)){for(a=kp;uk(wm);)qn(jg(wm)),Rp(),wm=tg(wm);pl(kp-a)}else if(wm.k===De){for(qn(wm),Zg(),wm=Nm(),b=c=0,d=wm.tensor.nelem;0<=d?c<d:c>d;b=0<=d?++c:--c)qn(wm.tensor.elem[b]),Rp(),wm.tensor.elem[b]=Nm();qn(wm)}else wm.k===Hd?(qn(wm),Pf()):wm===Zo(Nd)?rn(Math.PI):wm===Zo(ha)?rn(Math.E):qn(wm);return Sn()},yb=function(){return qn(ig(wm)),wa(),Ap()},Ap=function(){return Zn(),Sp(),Sn()},Sp=function(){var a;return a=0,wm=Nm(),Qk(wm)?xk(wm)?(a=Math.floor(wm.d),void rn(a)):Fk(wm)?void qn(wm):(ym=new Xe,ym.k=Hd,ym.q.a=zl(wm.q.a,wm.q.b),ym.q.b=El(1),qn(ym),Mk(wm)?(un(-1),sf()):void 0):(wn(Pc),qn(wm),void pl(2))},zb=function(){var a,b,c,d,e,f;for(a=0,b=0,c=0,Bm=ig(wm),cl(Bm)||To("for: 1st arg?"),qn(hg(wm)),wa(),b=Qm(),2147483648===b&&To("for: 2nd arg?"),qn(gg(wm)),wa(),c=Qm(),2147483648===c&&To("for: 3rd arg?"),wm=qg(wm),zm=Mj(Bm),ym=Lj(Bm),a=d=e=b,f=c;e<=f?d<=f:d>=f;a=e<=f?++d:--d)for(un(a),Am=Nm(),ro(Bm,Am),xm=wm;uk(xm);)qn(jg(xm)),wa(),Nm(),xm=tg(xm);return so(Bm,zm,ym),wn(xd)},Ab=function(){return qn(ig(wm)),wa(),zj()},zj=function(){return Zn(),Bj(),Sn()},Bj=function(){return wm=Nm(),_k(wm)&&od(wm.q.a,1)&&od(wm.q.b,2)?(wn(Nd),vn(1,2),void Rm()):_k(wm)&&od(wm.q.a,3)&&od(wm.q.b,2)?(wn(Nd),vn(1,2),Rm(),vn(1,2),void Rl()):Nk(wm)?(wn(Nd),un(-1),Rl(),wn(Nd),qn(wm),Rl(),Jo(),qn(wm),Rl(),qn(wm),$l(),zj(),Rl(),void Ph()):jg(wm)===Zo(e)?void Aj():(wn(Sc),qn(wm),void pl(2))},Aj=function(){return ym=tg(wm),_k(jg(ym))&&od(jg(ym).q.a,1)&&od(jg(ym).q.b,1)?(qn(ig(ym)),qn(ig(ym)),zj(),Rl()):_k(jg(ym))&&od(jg(ym).q.a,-1)&&od(jg(ym).q.b,1)?(qn(ig(ym)),zj(),qn(ig(ym)),un(-1),sf(),Ph()):(wn(Sc),qn(wm),pl(2),void 0)},Bb=function(){var a;for(wm=tg(wm),qn(jg(wm)),wa(),wm=tg(wm),a=[];uk(wm);)qn(jg(wm)),wa(),Cj(),a.push(wm=tg(wm));return a},Cj=function(){var a;return a=Ti,Zn(),Gj(),Sn(),Ti=a},Gj=function(){return Ti=1,xm=Nm(),wm=Nm(),Fi(wm,xm)?void qn(wm):_k(wm)&&_k(xm)?(qn(wm),qn(xm),void Hj()):jg(wm)===Zo(e)&&jg(xm)===Zo(e)?void Ej():(jg(wm)===Zo(e)&&(Dj(wm),wm=Nm()),jg(xm)===Zo(e)&&(Dj(xm),xm=Nm()),jg(wm)===Zo(ud)&&jg(xm)===Zo(ud)?void Jj():jg(wm)===Zo(ud)?void Ij():jg(xm)===Zo(ud)?void Fj():(jg(wm)===Zo(Pd)?(ym=hg(wm),wm=ig(wm)):ym=sm,jg(xm)===Zo(Pd)?(zm=hg(xm),xm=ig(xm)):zm=sm,Fi(wm,xm)?Qk(ym)&&Qk(zm)?(qn(wm),qn(nl(ym,zm)?ym:zm),void Rm()):(qn(ym),qn(zm),Ph(),Am=Nm(),Qk(Am)?(qn(wm),Am=jg(ym)===Zo(ud)&&Qk(ig(ym))?ig(ym):sm,Bm=jg(zm)===Zo(ud)&&Qk(ig(zm))?ig(zm):sm,qn(nl(Am,Bm)?ym:zm),void Rm()):(qn(ym),qn(zm),Xo(),Am=Nm(),Qk(Am)?(qn(wm),qn(Mk(Am)?ym:zm),Rm()):void qn(sm))):void qn(sm)))},Ej=function(){if(ml(wm)!==ml(xm))return void qn(sm);for(ym=tg(wm),qn(jg(ym)),ym=tg(ym);uk(ym);)qn(jg(ym)),Cj(),ym=tg(ym);for(ym=Nm(),zm=tg(xm),qn(jg(zm)),zm=tg(zm);uk(zm);)qn(jg(zm)),Cj(),zm=tg(zm);return zm=Nm(),qn(wm),qn(ym),Ph(),Am=Nm(),qn(xm),qn(zm),Ph(),Bm=Nm(),Fi(Am,Bm)?(qn(Am),qn(ym),qn(zm),Cj(),Rl()):qn(sm)},Dj=function(a){var b;for(a=tg(a),qn(jg(a)),a=tg(a),b=[];uk(a);)qn(jg(a)),Cj(),b.push(a=tg(a));return b},Jj=function(){var a;for(qn(sm),ym=tg(wm),a=[];uk(ym);){for(zm=tg(xm);uk(zm);)qn(jg(ym)),qn(jg(zm)),Cj(),Rl(),zm=tg(zm);a.push(ym=tg(ym))}return a},Ij=function(){var a;for(qn(sm),ym=tg(wm),a=[];uk(ym);)qn(jg(ym)),qn(xm),Cj(),Rl(),a.push(ym=tg(ym));return a},Fj=function(){var a;for(qn(sm),zm=tg(xm),a=[];uk(zm);)qn(wm),qn(jg(zm)),Cj(),Rl(),a.push(zm=tg(zm));return a},Uj=function(){var a;return a=Nm(),qn(a),wn(Rc(a,Zo(xe))?xe:Rc(a,Zo(ye))?ye:Rc(a,Zo(ze))?ze:Rc(a,Zo(we))?we:Rc(a,Zo(ve))?ve:xe)},Wj=function(){return Zn(),Tp(),Sn()},Tp=function(){var a;return a=0,xm=Nm(),wm=Nm(),qn(xm),a=Qm(),a<0||2147483648===a?(wn(Uc),qn(wm),qn(xm),void pl(3)):cl(wm)?Up(a):(ym=wm,wm=Zo($d),Up(a),wm=ym,qn(Zo($d)),qn(wm),Wo(),wa())},Up=function(a){var b,c,d,e;for(b=0,un(1),un(0),zm=Nm(),e=[],b=c=0,d=a;0<=d?c<d:c>d;b=0<=d?++c:--c)Am=zm,zm=Nm(),qn(wm),qn(zm),Rl(),un(b),qn(Am),Rl(),Xo(),un(2),e.push(Rl());return e},Xj=function(){var a,b,c,d,e,f,g;if(b=0,c=0,d=0,Zn(),xm=Nm(),qn(xm),(d=Qm())<2)return wn(Vc),qn(xm),pl(2),void Sn();for(An(d,d),wm=Nm(),b=e=0,f=d;0<=f?e<f:e>f;b=0<=f?++e:--e)for(c=a=0,g=d;0<=g?a<g:a>g;c=0<=g?++a:--a)un(b+c+1),kk(),wm.tensor.elem[b*d+c]=Nm();return qn(wm),Sn()},Eb=function(){return qn(ig(wm)),wa(),Yj()},Yj=function(){return Zn(),Nn(),wm=Nm(),qn(wm),qn(wm),Ug(),Xo(),un(2),Ph(),qn(Zj),Ph(),Sn()},$j=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u;if(f=0,g=0,h=0,i=0,j=0,u=0,Zn(),t=kp-a,wm=Oo[t],!el(wm))return kp-=a,qn(wm),void Sn();for(i=wm.tensor.ndim,h=a-1,h>i&&To("too many indices for tensor"),g=0,f=k=0,l=h;0<=l?k<l:k>l;f=0<=l?++k:--k)qn(Oo[t+f+1]),u=Qm(),(u<1||u>wm.tensor.dim[f])&&To("index out of range"),g=g*wm.tensor.dim[f]+u-1;if(i===h)return kp-=a,qn(wm.tensor.elem[g]),void Sn();for(f=b=m=h,n=i;m<=n?b<n:b>n;f=m<=n?++b:--b)g=g*wm.tensor.dim[f]+0;for(j=1,f=c=o=h,p=i;o<=p?c<p:c>p;f=o<=p?++c:--c)j*=wm.tensor.dim[f];for(xm=xf(j),xm.tensor.ndim=i-h,f=d=q=h,r=i;q<=r?d<r:d>r;f=q<=r?++d:--d)xm.tensor.dim[f-h]=wm.tensor.dim[f];for(f=e=0,s=j;0<=s?e<s:e>s;f=0<=s?++e:--e)xm.tensor.elem[f]=wm.tensor.elem[g+f];return wm.tensor.nelem!==wm.tensor.elem.length&&console.log("something wrong in tensor dimensions"),xm.tensor.nelem!==xm.tensor.elem.length&&console.log("something wrong in tensor dimensions"),kp-=a,qn(xm),Sn()},to=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t;for(g=0,h=0,i=0,j=0,t=0,Zn(),a<3&&To("error in indexed assign"),s=kp-a,xm=Oo[s],wm=Oo[s+1],el(wm)||To("error in indexed assign"),j=wm.tensor.ndim,i=a-2,i>j&&To("error in indexed assign"),h=0,g=k=0,l=i;0<=l?k<l:k>l;g=0<=l?++k:--k)qn(Oo[s+g+2]),t=Qm(),(t<1||t>wm.tensor.dim[g])&&To("error in indexed assign\n"),h=h*wm.tensor.dim[g]+t-1;for(g=b=m=i,n=j;m<=n?b<n:b>n;g=m<=n?++b:--b)h=h*wm.tensor.dim[g]+0;for(ym=xf(wm.tensor.nelem),ym.tensor.ndim=wm.tensor.ndim,g=c=0,o=wm.tensor.ndim;0<=o?c<o:c>o;g=0<=o?++c:--c)ym.tensor.dim[g]=wm.tensor.dim[g];for(g=d=0,p=wm.tensor.nelem;0<=p?d<p:d>p;g=0<=p?++d:--d)ym.tensor.elem[g]=wm.tensor.elem[g];if(wm.tensor.nelem!==wm.tensor.elem.length&&console.log("something wrong in tensor dimensions"),ym.tensor.nelem!==ym.tensor.elem.length&&console.log("something wrong in tensor dimensions"),wm=ym,j===i)return el(xm)&&To("error in indexed assign"),wm.tensor.elem[h]=xm,wm.tensor.nelem!==wm.tensor.elem.length&&console.log("something wrong in tensor dimensions"),kp-=a,qn(wm),void Sn();for(el(xm)||To("error in indexed assign"),j-i!==xm.tensor.ndim&&To("error in indexed assign"),g=e=0,q=xm.tensor.ndim;0<=q?e<q:e>q;g=0<=q?++e:--e)wm.tensor.dim[i+g]!==xm.tensor.dim[g]&&To("error in indexed assign");for(g=f=0,r=xm.tensor.nelem;0<=r?f<r:f>r;g=0<=r?++f:--f)wm.tensor.elem[h+g]=xm.tensor.elem[g];return wm.tensor.nelem!==wm.tensor.elem.length&&console.log("something wrong in tensor dimensions"),xm.tensor.nelem!==xm.tensor.elem.length&&console.log("something wrong in tensor dimensions"),kp-=a,qn(wm),Sn()},Gb=function(){var a;for(wm=tg(wm),qn(jg(wm)),wa(),wm=tg(wm),a=[];uk(wm);)qn(jg(wm)),wa(),ck(),a.push(wm=tg(wm));return a},ck=function(){return Zn(),xm=Nm(),wm=Nm(),el(wm)&&el(xm)?dk():(qn(wm),qn(xm),el(wm)?ep():el(xm)?$n():Rl()),Sn()},dk=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x;for(l=0,o=wm.tensor.dim[wm.tensor.ndim-1],o!==xm.tensor.dim[0]&&To("inner: tensor dimension check"),p=wm.tensor.ndim+xm.tensor.ndim-2,p>md&&To("inner: rank of result exceeds maximum"),a=wm.tensor.elem,i=xm.tensor.elem,h=1,l=q=0,r=wm.tensor.ndim-1;0<=r?q<r:q>r;l=0<=r?++q:--q)h*=wm.tensor.dim[l];for(j=1,l=b=1,s=xm.tensor.ndim;1<=s?b<s:b>s;l=1<=s?++b:--b)j*=xm.tensor.dim[l];for(ym=xf(h*j),k=ym.tensor.elem,l=c=0,t=h;0<=t?c<t:c>t;l=0<=t?++c:--c)for(m=d=0,u=o;0<=u?d<u:d>u;m=0<=u?++d:--d)if(!fl(a[l*o+m]))for(n=e=0,v=j;0<=v?e<v:e>v;n=0<=v?++e:--e)qn(a[l*o+m]),qn(i[m*j+n]),Rl(),qn(k[l*j+n]),sf(),k[l*j+n]=Nm();if(0===p)return qn(ym.tensor.elem[0]);for(ym.tensor.ndim=p,m=0,l=f=0,w=wm.tensor.ndim-1;0<=w?f<w:f>w;l=0<=w?++f:--f)ym.tensor.dim[l]=wm.tensor.dim[l];for(m=wm.tensor.ndim-1,l=g=0,x=xm.tensor.ndim-1;0<=x?g<x:g>x;l=0<=x?++g:--g)ym.tensor.dim[m+l]=xm.tensor.dim[l+1];return qn(ym)},gl=["f(a,a*x)","f(1/x,log(x))","f(x^a,x^(a+1)/(a+1))","f(exp(a*x),1/a*exp(a*x))","f(exp(a*x+b),1/a*exp(a*x+b))","f(x*exp(a*x^2),exp(a*x^2)/(2*a))","f(x*exp(a*x^2+b),exp(a*x^2+b)/(2*a))","f(log(a*x),x*log(a*x)-x)","f(a^x,a^x/log(a),or(not(number(a)),a>0))","f(1/(a+x^2),1/sqrt(a)*arctan(x/sqrt(a)),or(not(number(a)),a>0))","f(1/(a-x^2),1/sqrt(a)*arctanh(x/sqrt(a)))","f(1/sqrt(a-x^2),arcsin(x/(sqrt(a))))","f(1/sqrt(a+x^2),log(x+sqrt(a+x^2)))","f(1/(a+b*x),1/b*log(a+b*x))","f(1/(a+b*x)^2,-1/(b*(a+b*x)))","f(1/(a+b*x)^3,-1/(2*b)*1/(a+b*x)^2)","f(x/(a+b*x),x/b-a*log(a+b*x)/b/b)","f(x/(a+b*x)^2,1/b^2*(log(a+b*x)+a/(a+b*x)))","f(x^2/(a+b*x),1/b^2*(1/2*(a+b*x)^2-2*a*(a+b*x)+a^2*log(a+b*x)))","f(x^2/(a+b*x)^2,1/b^3*(a+b*x-2*a*log(a+b*x)-a^2/(a+b*x)))","f(x^2/(a+b*x)^3,1/b^3*(log(a+b*x)+2*a/(a+b*x)-1/2*a^2/(a+b*x)^2))","f(1/x*1/(a+b*x),-1/a*log((a+b*x)/x))","f(1/x*1/(a+b*x)^2,1/a*1/(a+b*x)-1/a^2*log((a+b*x)/x))","f(1/x*1/(a+b*x)^3,1/a^3*(1/2*((2*a+b*x)/(a+b*x))^2+log(x/(a+b*x))))","f(1/x^2*1/(a+b*x),-1/(a*x)+b/a^2*log((a+b*x)/x))","f(1/x^3*1/(a+b*x),(2*b*x-a)/(2*a^2*x^2)+b^2/a^3*log(x/(a+b*x)))","f(1/x^2*1/(a+b*x)^2,-(a+2*b*x)/(a^2*x*(a+b*x))+2*b/a^3*log((a+b*x)/x))","f(1/(a+b*x^2),1/sqrt(a*b)*arctan(x*sqrt(a*b)/a),or(not(number(a*b)),a*b>0))","f(1/(a+b*x^2),1/(2*sqrt(-a*b))*log((a+x*sqrt(-a*b))/(a-x*sqrt(-a*b))),or(not(number(a*b)),a*b<0))","f(x/(a+b*x^2),1/2*1/b*log(a+b*x^2))","f(x^2/(a+b*x^2),x/b-a/b*integral(1/(a+b*x^2),x))","f(1/(a+b*x^2)^2,x/(2*a*(a+b*x^2))+1/2*1/a*integral(1/(a+b*x^2),x))","f(1/x*1/(a+b*x^2),1/2*1/a*log(x^2/(a+b*x^2)))","f(1/x^2*1/(a+b*x^2),-1/(a*x)-b/a*integral(1/(a+b*x^2),x))","f(1/(a+b*x^3),1/3*1/a*(a/b)^(1/3)*(1/2*log(((a/b)^(1/3)+x)^3/(a+b*x^3))+sqrt(3)*arctan((2*x-(a/b)^(1/3))*(a/b)^(-1/3)/sqrt(3))))","f(x^2/(a+b*x^3),1/3*1/b*log(a+b*x^3))","f(1/(a+b*x^4),1/2*1/a*(a/b/4)^(1/4)*(1/2*log((x^2+2*(a/b/4)^(1/4)*x+2*(a/b/4)^(1/2))/(x^2-2*(a/b/4)^(1/4)*x+2*(a/b/4)^(1/2)))+arctan(2*(a/b/4)^(1/4)*x/(2*(a/b/4)^(1/2)-x^2))),or(not(number(a*b)),a*b>0))","f(1/(a+b*x^4),1/2*(-a/b)^(1/4)/a*(1/2*log((x+(-a/b)^(1/4))/(x-(-a/b)^(1/4)))+arctan(x*(-a/b)^(-1/4))),or(not(number(a*b)),a*b<0))","f(x/(a+b*x^4),1/2*sqrt(b/a)/b*arctan(x^2*sqrt(b/a)),or(not(number(a*b)),a*b>0))","f(x/(a+b*x^4),1/4*sqrt(-b/a)/b*log((x^2-sqrt(-a/b))/(x^2+sqrt(-a/b))),or(not(number(a*b)),a*b<0))","f(x^2/(a+b*x^4),1/4*1/b*(a/b/4)^(-1/4)*(1/2*log((x^2-2*(a/b/4)^(1/4)*x+2*sqrt(a/b/4))/(x^2+2*(a/b/4)^(1/4)*x+2*sqrt(a/b/4)))+arctan(2*(a/b/4)^(1/4)*x/(2*sqrt(a/b/4)-x^2))),or(not(number(a*b)),a*b>0))","f(x^2/(a+b*x^4),1/4*1/b*(-a/b)^(-1/4)*(log((x-(-a/b)^(1/4))/(x+(-a/b)^(1/4)))+2*arctan(x*(-a/b)^(-1/4))),or(not(number(a*b)),a*b<0))","f(x^3/(a+b*x^4),1/4*1/b*log(a+b*x^4))","f(sqrt(a+b*x),2/3*1/b*sqrt((a+b*x)^3))","f(x*sqrt(a+b*x),-2*(2*a-3*b*x)*sqrt((a+b*x)^3)/15/b^2)","f(x^2*sqrt(a+b*x),2*(8*a^2-12*a*b*x+15*b^2*x^2)*sqrt((a+b*x)^3)/105/b^3)","f(sqrt(a+b*x)/x,2*sqrt(a+b*x)+a*integral(1/x*1/sqrt(a+b*x),x))","f(sqrt(a+b*x)/x^2,-sqrt(a+b*x)/x+b/2*integral(1/x*1/sqrt(a+b*x),x))","f(1/sqrt(a+b*x),2*sqrt(a+b*x)/b)","f(x/sqrt(a+b*x),-2/3*(2*a-b*x)*sqrt(a+b*x)/b^2)","f(x^2/sqrt(a+b*x),2/15*(8*a^2-4*a*b*x+3*b^2*x^2)*sqrt(a+b*x)/b^3)","f(1/x*1/sqrt(a+b*x),1/sqrt(a)*log((sqrt(a+b*x)-sqrt(a))/(sqrt(a+b*x)+sqrt(a))),or(not(number(a)),a>0))","f(1/x*1/sqrt(a+b*x),2/sqrt(-a)*arctan(sqrt(-(a+b*x)/a)),or(not(number(a)),a<0))","f(1/x^2*1/sqrt(a+b*x),-sqrt(a+b*x)/a/x-1/2*b/a*integral(1/x*1/sqrt(a+b*x),x))","f(sqrt(x^2+a),1/2*(x*sqrt(x^2+a)+a*log(x+sqrt(x^2+a))))","f(1/sqrt(x^2+a),log(x+sqrt(x^2+a)))","f(1/x*1/sqrt(x^2+a),arcsec(x/sqrt(-a))/sqrt(-a),or(not(number(a)),a<0))","f(1/x*1/sqrt(x^2+a),-1/sqrt(a)*log((sqrt(a)+sqrt(x^2+a))/x),or(not(number(a)),a>0))","f(sqrt(x^2+a)/x,sqrt(x^2+a)-sqrt(a)*log((sqrt(a)+sqrt(x^2+a))/x),or(not(number(a)),a>0))","f(sqrt(x^2+a)/x,sqrt(x^2+a)-sqrt(-a)*arcsec(x/sqrt(-a)),or(not(number(a)),a<0))","f(x/sqrt(x^2+a),sqrt(x^2+a))","f(x*sqrt(x^2+a),1/3*sqrt((x^2+a)^3))","f(sqrt(a+x^6+3*a^(1/3)*x^4+3*a^(2/3)*x^2),1/4*(x*sqrt((x^2+a^(1/3))^3)+3/2*a^(1/3)*x*sqrt(x^2+a^(1/3))+3/2*a^(2/3)*log(x+sqrt(x^2+a^(1/3)))))","f(sqrt(-a+x^6-3*a^(1/3)*x^4+3*a^(2/3)*x^2),1/4*(x*sqrt((x^2-a^(1/3))^3)-3/2*a^(1/3)*x*sqrt(x^2-a^(1/3))+3/2*a^(2/3)*log(x+sqrt(x^2-a^(1/3)))))","f(1/sqrt(a+x^6+3*a^(1/3)*x^4+3*a^(2/3)*x^2),x/a^(1/3)/sqrt(x^2+a^(1/3)))","f(x/sqrt(a+x^6+3*a^(1/3)*x^4+3*a^(2/3)*x^2),-1/sqrt(x^2+a^(1/3)))","f(x*sqrt(a+x^6+3*a^(1/3)*x^4+3*a^(2/3)*x^2),1/5*sqrt((x^2+a^(1/3))^5))","f(x^2*sqrt(x^2+a),1/4*x*sqrt((x^2+a)^3)-1/8*a*x*sqrt(x^2+a)-1/8*a^2*log(x+sqrt(x^2+a)))","f(x^3*sqrt(x^2+a),(1/5*x^2-2/15*a)*sqrt((x^2+a)^3),and(number(a),a>0))","f(x^3*sqrt(x^2+a),sqrt((x^2+a)^5)/5-a*sqrt((x^2+a)^3)/3,and(number(a),a<0))","f(x^2/sqrt(x^2+a),1/2*x*sqrt(x^2+a)-1/2*a*log(x+sqrt(x^2+a)))","f(x^3/sqrt(x^2+a),1/3*sqrt((x^2+a)^3)-a*sqrt(x^2+a))","f(1/x^2*1/sqrt(x^2+a),-sqrt(x^2+a)/a/x)","f(1/x^3*1/sqrt(x^2+a),-1/2*sqrt(x^2+a)/a/x^2+1/2*log((sqrt(a)+sqrt(x^2+a))/x)/a^(3/2),or(not(number(a)),a>0))","f(1/x^3*1/sqrt(x^2-a),1/2*sqrt(x^2-a)/a/x^2+1/2*1/(a^(3/2))*arcsec(x/(a^(1/2))),or(not(number(a)),a>0))","f(x^2*sqrt(a+x^6+3*a^(1/3)*x^4+3*a^(2/3)*x^2),1/6*x*sqrt((x^2+a^(1/3))^5)-1/24*a^(1/3)*x*sqrt((x^2+a^(1/3))^3)-1/16*a^(2/3)*x*sqrt(x^2+a^(1/3))-1/16*a*log(x+sqrt(x^2+a^(1/3))),or(not(number(a)),a>0))","f(x^2*sqrt(-a-3*a^(1/3)*x^4+3*a^(2/3)*x^2+x^6),1/6*x*sqrt((x^2-a^(1/3))^5)+1/24*a^(1/3)*x*sqrt((x^2-a^(1/3))^3)-1/16*a^(2/3)*x*sqrt(x^2-a^(1/3))+1/16*a*log(x+sqrt(x^2-a^(1/3))),or(not(number(a)),a>0))","f(x^3*sqrt(a+x^6+3*a^(1/3)*x^4+3*a^(2/3)*x^2),1/7*sqrt((x^2+a^(1/3))^7)-1/5*a^(1/3)*sqrt((x^2+a^(1/3))^5),or(not(number(a)),a>0))","f(x^3*sqrt(-a-3*a^(1/3)*x^4+3*a^(2/3)*x^2+x^6),1/7*sqrt((x^2-a^(1/3))^7)+1/5*a^(1/3)*sqrt((x^2-a^(1/3))^5),or(not(number(a)),a>0))","f(1/(x-a)/sqrt(x^2-a^2),-sqrt(x^2-a^2)/a/(x-a))","f(1/(x+a)/sqrt(x^2-a^2),sqrt(x^2-a^2)/a/(x+a))","f(sqrt(a-x^2),1/2*(x*sqrt(a-x^2)+a*arcsin(x/sqrt(abs(a)))))","f(1/x*1/sqrt(a-x^2),-1/sqrt(a)*log((sqrt(a)+sqrt(a-x^2))/x),or(not(number(a)),a>0))","f(sqrt(a-x^2)/x,sqrt(a-x^2)-sqrt(a)*log((sqrt(a)+sqrt(a-x^2))/x),or(not(number(a)),a>0))","f(x/sqrt(a-x^2),-sqrt(a-x^2))","f(x*sqrt(a-x^2),-1/3*sqrt((a-x^2)^3))","f(x^2*sqrt(a-x^2),-x/4*sqrt((a-x^2)^3)+1/8*a*(x*sqrt(a-x^2)+a*arcsin(x/sqrt(a))),or(not(number(a)),a>0))","f(x^3*sqrt(a-x^2),(-1/5*x^2-2/15*a)*sqrt((a-x^2)^3),or(not(number(a)),a>0))","f(x^2/sqrt(a-x^2),-x/2*sqrt(a-x^2)+a/2*arcsin(x/sqrt(a)),or(not(number(a)),a>0))","f(1/x^2*1/sqrt(a-x^2),-sqrt(a-x^2)/a/x,or(not(number(a)),a>0))","f(sqrt(a-x^2)/x^2,-sqrt(a-x^2)/x-arcsin(x/sqrt(a)),or(not(number(a)),a>0))","f(sqrt(a-x^2)/x^3,-1/2*sqrt(a-x^2)/x^2+1/2*log((sqrt(a)+sqrt(a-x^2))/x)/sqrt(a),or(not(number(a)),a>0))","f(sqrt(a-x^2)/x^4,-1/3*sqrt((a-x^2)^3)/a/x^3,or(not(number(a)),a>0))","f(sqrt(a*x^2+b),x*sqrt(a*x^2+b)/2+b*log(x*sqrt(a)+sqrt(a*x^2+b))/2/sqrt(a),and(number(a),a>0))","f(sqrt(a*x^2+b),x*sqrt(a*x^2+b)/2+b*arcsin(x*sqrt(-a/b))/2/sqrt(-a),and(number(a),a<0))","f(sin(a*x),-cos(a*x)/a)","f(cos(a*x),sin(a*x)/a)","f(tan(a*x),-log(cos(a*x))/a)","f(1/tan(a*x),log(sin(a*x))/a)","f(1/cos(a*x),log(tan(pi/4+a*x/2))/a)","f(1/sin(a*x),log(tan(a*x/2))/a)","f(sin(a*x)^2,x/2-sin(2*a*x)/(4*a))","f(sin(a*x)^3,-cos(a*x)*(sin(a*x)^2+2)/(3*a))","f(sin(a*x)^4,3/8*x-sin(2*a*x)/(4*a)+sin(4*a*x)/(32*a))","f(cos(a*x)^2,x/2+sin(2*a*x)/(4*a))","f(cos(a*x)^3,sin(a*x)*(cos(a*x)^2+2)/(3*a))","f(cos(a*x)^4,3/8*x+sin(2*a*x)/(4*a)+sin(4*a*x)/(32*a))","f(1/sin(a*x)^2,-1/(a*tan(a*x)))","f(1/cos(a*x)^2,tan(a*x)/a)","f(sin(a*x)*cos(a*x),sin(a*x)^2/(2*a))","f(sin(a*x)^2*cos(a*x)^2,-sin(4*a*x)/(32*a)+x/8)","f(sin(a*x)/cos(a*x)^2,1/(a*cos(a*x)))","f(sin(a*x)^2/cos(a*x),(log(tan(pi/4+a*x/2))-sin(a*x))/a)","f(cos(a*x)/sin(a*x)^2,-1/(a*sin(a*x)))","f(1/(sin(a*x)*cos(a*x)),log(tan(a*x))/a)","f(1/(sin(a*x)*cos(a*x)^2),(1/cos(a*x)+log(tan(a*x/2)))/a)","f(1/(sin(a*x)^2*cos(a*x)),(log(tan(pi/4+a*x/2))-1/sin(a*x))/a)","f(1/(sin(a*x)^2*cos(a*x)^2),-2/(a*tan(2*a*x)))","f(sin(a+b*x),-cos(a+b*x)/b)","f(cos(a+b*x),sin(a+b*x)/b)","f(1/(b+b*sin(a*x)),-tan(pi/4-a*x/2)/a/b)","f(1/(b-b*sin(a*x)),tan(pi/4+a*x/2)/a/b)","f(1/(b+b*cos(a*x)),tan(a*x/2)/a/b)","f(1/(b-b*cos(a*x)),-1/tan(a*x/2)/a/b)","f(1/(a+b*sin(x)),1/sqrt(b^2-a^2)*log((a*tan(x/2)+b-sqrt(b^2-a^2))/(a*tan(x/2)+b+sqrt(b^2-a^2))),b^2-a^2)","f(1/(a+b*cos(x)),1/sqrt(b^2-a^2)*log((sqrt(b^2-a^2)*tan(x/2)+a+b)/(sqrt(b^2-a^2)*tan(x/2)-a-b)),b^2-a^2)","f(x*sin(a*x),sin(a*x)/a^2-x*cos(a*x)/a)","f(x^2*sin(a*x),2*x*sin(a*x)/a^2-(a^2*x^2-2)*cos(a*x)/a^3)","f(x*cos(a*x),cos(a*x)/a^2+x*sin(a*x)/a)","f(x^2*cos(a*x),2*x*cos(a*x)/a^2+(a^2*x^2-2)*sin(a*x)/a^3)","f(arcsin(a*x),x*arcsin(a*x)+sqrt(1-a^2*x^2)/a)","f(arccos(a*x),x*arccos(a*x)-sqrt(1-a^2*x^2)/a)","f(arctan(a*x),x*arctan(a*x)-1/2*log(1+a^2*x^2)/a)","f(log(a*x),x*log(a*x)-x)","f(x*log(a*x),x^2*log(a*x)/2-x^2/4)","f(x^2*log(a*x),x^3*log(a*x)/3-1/9*x^3)","f(log(x)^2,x*log(x)^2-2*x*log(x)+2*x)","f(1/x*1/(a+log(x)),log(a+log(x)))","f(log(a*x+b),(a*x+b)*log(a*x+b)/a-x)","f(log(a*x+b)/x^2,a/b*log(x)-(a*x+b)*log(a*x+b)/b/x)","f(sinh(x),cosh(x))","f(cosh(x),sinh(x))","f(tanh(x),log(cosh(x)))","f(x*sinh(x),x*cosh(x)-sinh(x))","f(x*cosh(x),x*sinh(x)-cosh(x))","f(sinh(x)^2,sinh(2*x)/4-x/2)","f(tanh(x)^2,x-tanh(x))","f(cosh(x)^2,sinh(2*x)/4+x/2)","f(x^3*exp(a*x^2),exp(a*x^2)*(x^2/a-1/(a^2))/2)","f(x^3*exp(a*x^2+b),exp(a*x^2)*exp(b)*(x^2/a-1/(a^2))/2)","f(exp(a*x^2),-i*sqrt(pi)*erf(i*sqrt(a)*x)/sqrt(a)/2)","f(erf(a*x),x*erf(a*x)+exp(-a^2*x^2)/a/sqrt(pi))","f(x^2*(1-x^2)^(3/2),(x*sqrt(1-x^2)*(-8*x^4+14*x^2-3)+3*arcsin(x))/48)","f(x^2*(1-x^2)^(5/2),(x*sqrt(1-x^2)*(48*x^6-136*x^4+118*x^2-15)+15*arcsin(x))/384)","f(x^4*(1-x^2)^(3/2),(-x*sqrt(1-x^2)*(16*x^6-24*x^4+2*x^2+3)+3*arcsin(x))/128)","f(x*exp(a*x),exp(a*x)*(a*x-1)/(a^2))","f(x*exp(a*x+b),exp(a*x+b)*(a*x-1)/(a^2))","f(x^2*exp(a*x),exp(a*x)*(a^2*x^2-2*a*x+2)/(a^3))","f(x^2*exp(a*x+b),exp(a*x+b)*(a^2*x^2-2*a*x+2)/(a^3))","f(x^3*exp(a*x),exp(a*x)*x^3/a-3/a*integral(x^2*exp(a*x),x))","f(x^3*exp(a*x+b),exp(a*x+b)*x^3/a-3/a*integral(x^2*exp(a*x+b),x))",0],Hb=function(){var a,b,c,d,e;for(0,b=0,wm=tg(wm),qn(jg(wm)),wa(),wm=tg(wm),qn(jg(wm)),wa(),xm=Nm(),xm===Zo(xd)?(Uj(),qn(Zo(xd))):Qk(xm)?(Uj(),qn(xm)):(qn(xm),wm=tg(wm),qn(jg(wm)),wa()),Am=Nm(),zm=Nm(),ym=Nm();;){if(Qk(Am)?(qn(Am),2147483648===(b=Qm())&&To("nth integral: check n")):b=1,qn(ym),b>=0)for(c=0,d=b;0<=d?c<d:c>d;0<=d?++c:--c)qn(zm),fk();else for(b=-b,a=0,e=b;0<=e?a<e:a>e;0<=e?++a:--a)qn(zm),Hh();if(ym=Nm(),Am===Zo(xd))break;if(Qk(Am)){if(wm=tg(wm),qn(jg(wm)),wa(),(Am=Nm())===Zo(xd))break;Qk(Am)?1:(zm=Am,wm=tg(wm),qn(jg(wm)),wa(),Am=Nm())}else zm=Am,wm=tg(wm),qn(jg(wm)),wa(),Am=Nm()}return qn(ym)},fk=function(){return Zn(),xm=Nm(),wm=Nm(),jg(wm)===Zo(e)?ik():jg(wm)===Zo(ud)?hk():gk(),wm=Nm(),Rc(wm,Zo(Zc))&&To("integral: sorry, could not find a solution"),qn(wm),Do(),wa(),Sn()},ik=function(){var a;for(wm=tg(wm),qn(jg(wm)),qn(xm),fk(),wm=tg(wm),a=[];uk(wm);)qn(jg(wm)),qn(xm),fk(),sf(),a.push(wm=tg(wm));return a},hk=function(){return qn(wm),qn(xm),Jm(),wm=Nm(),gk(),Rl()},gk=function(){return qn(wm),qn(xm),lp(gl),ym=Nm(),ym===Zo(xd)?(wn(Zc),qn(wm),qn(xm),pl(3)):qn(ym)},ad=function(){return el(wm)?2!==wm.tensor.ndim?0:wm.tensor.dim[0]!==wm.tensor.dim[1]?0:1:0},jk=function(){var a,b,c,d,e;if(b=0,c=0,Zn(),wm=Nm(),0===ad())return wn($c),qn(wm),pl(2),void Sn();for(c=wm.tensor.nelem,a=wm.tensor.elem,b=d=0,e=c;(0<=e?d<e:d>e)&&Qk(a[b]);b=0<=e?++d:--d);return b===c?Vp():(qn(wm),wf(),qn(wm),Jh(),xm=Nm(),fl(xm)&&To("inverse of singular matrix"),qn(xm),Ph()),Sn()},mk=function(){return Zn(),wm=Nm(),0===ad()?(wn(_c),qn(wm),pl(2),void Sn()):(Vp(),Sn())},Vp=function(){var a,b,c,d,e,f,g,h,i,j,k,l;for(d=0,e=0,f=0,g=0,g=wm.tensor.dim[0],d=kp,e=h=0,i=g;0<=i?h<i:h>i;e=0<=i?++h:--h)for(f=a=0,j=g;0<=j?a<j:a>j;f=0<=j?++a:--a)qn(e===f?sm:fq);for(e=b=0,k=g*g;0<=k?b<k:b>k;e=0<=k?++b:--b)qn(wm.tensor.elem[e]);for(bd(g),wm=xf(g*g),wm.tensor.ndim=2,wm.tensor.dim[0]=g,wm.tensor.dim[1]=g,e=c=0,l=g*g;0<=l?c<l:c>l;e=0<=l?++c:--c)wm.tensor.elem[e]=Oo[d+e];return kp-=2*g*g,qn(wm)},bd=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p;for(b=0,f=0,g=0,h=0,p=0,b=kp-a*a,p=b-a*a,o=[],f=i=0,j=a;0<=j?i<j:i>j;f=0<=j?++i:--i){if(Fi(Oo[b+a*f+f],fq)){for(g=c=k=f+1,l=a;(k<=l?c<l:c>l)&&Fi(Oo[b+a*g+f],fq);g=k<=l?++c:--c);for(g===a&&To("inverse of singular matrix"),h=d=0,m=a;0<=m?d<m:d>m;h=0<=m?++d:--d)xm=Oo[b+a*f+h],Oo[b+a*f+h]=Oo[b+a*g+h],Oo[b+a*g+h]=xm,xm=Oo[p+a*f+h],Oo[p+a*f+h]=Oo[p+a*g+h],Oo[p+a*g+h]=xm}for(xm=Oo[b+a*f+f],h=e=0,n=a;0<=n?e<n:e>n;h=0<=n?++e:--e)h>f&&(qn(Oo[b+a*f+h]),qn(xm),Ph(),Oo[b+a*f+h]=Nm()),qn(Oo[p+a*f+h]),qn(xm),Ph(),Oo[p+a*f+h]=Nm();o.push(function(){var c,d,e;for(e=[],g=c=0,d=a;0<=d?c<d:c>d;g=0<=d?++c:--c)g!==f&&(xm=Oo[b+a*g+f],e.push(function(){var c,d,e;for(e=[],h=c=0,d=a;0<=d?c<d:c>d;h=0<=d?++c:--c)h>f&&(qn(Oo[b+a*g+h]),qn(Oo[b+a*f+h]),qn(xm),Rl(),Xo(),Oo[b+a*g+h]=Nm()),qn(Oo[p+a*g+h]),qn(Oo[p+a*f+h]),qn(xm),Rl(),Xo(),e.push(Oo[p+a*g+h]=Nm());return e}()));return e}())}return o},fl=function(a){var b,c,d;switch(b=0,a.k){case Hd:if(vd(a.q.a))return 1;break;case da:if(0===a.d)return 1;break;case De:for(b=c=0,d=a.tensor.nelem;0<=d?c<d:c>d;b=0<=d?++c:--c)if(!fl(a.tensor.elem[b]))return 0;return 1}return 0},Mk=function(a){switch(a.k){case Hd:if(-1===td(a.q.a))return 1;break;case da:if(a.d<0)return 1}return 0},Tk=function(a){switch(a.k){case Hd:if(od(a.q.a,1)&&od(a.q.b,1))return 1;break;case da:if(1===a.d)return 1}return 0},Ik=function(a){switch(a.k){case Hd:if(od(a.q.a,-1)&&od(a.q.b,1))return 1;break;case da:if(-1===a.d)return 1}return 0},Fk=function(a){return a.k===Hd&&od(a.q.b,1)?1:0},Ok=function(a){return _k(a)&&od(a.q.b,1)&&1===td(a.q.a)?1:0},Yk=function(a){return Fk(a)&&1===td(a.q.a)?1:0},Uk=function(a,b){return Rc(a,b)?Vk(a,b):0},Vk=function(a,b){if(jg(a)===Zo(e)){for(a=tg(a);uk(a);){if(!Xk(jg(a),b))return 0;a=tg(a)}return 1}return Xk(a,b)},Xk=function(a,b){if(jg(a)===Zo(ud)){for(a=tg(a);uk(a);){if(!Wk(jg(a),b))return 0;a=tg(a)}return 1}return Wk(a,b)},Wk=function(a,b){return Fi(a,b)?1:jg(a)===Zo(Pd)&&Fi(ig(a),b)?Yk(hg(a))?1:0:Rc(a,b)?0:1},Nk=function(a){return Mk(a)?1:jg(a)===Zo(ud)&&Mk(ig(a))?1:0},Dk=function(a){return jg(a)===Zo(ud)&&3===ml(a)&&Qk(ig(a))&&Fi(hg(a),Zj)||Fi(a,Zj)?1:0},tk=function(a){return jg(a)===Zo(e)&&3===ml(a)&&Qk(ig(a))&&Dk(hg(a))||Dk(a)?1:0},yk=function(a){return Fk(a)&&a.q.a.isEven()?1:0},Lk=function(a){return jg(a)===Zo(e)&&Nk(ig(a))?1:Nk(a)?1:0},dl=function(a){if(cl(a))return 1;for(;uk(a);){if(dl(jg(a)))return 1;a=tg(a)}return 0},Gk=function(a){return Fk(a)||jg(a)===Zo(Pd)&&Fk(ig(a))&&Fk(hg(a))?1:0},Rk=function(a){return jg(a)===Zo(Pd)&&Ik(hg(a))?1:0},Ck=function(a){return a.k!==Hd||od(a.q.b,1)?0:1},Gi=function(a,b){switch(a.k){case Hd:if(od(a.q.a,b)&&od(a.q.b,1))return 1;break;case da:if(a.d===b)return 1}return 0},Hi=function(a,b,c){switch(a.k){case Hd:if(od(a.q.a,b)&&od(a.q.b,c))return 1;break;case da:if(a.d===b/c)return 1}return 0},Sk=function(a){return jg(a)===Zo(Pd)&&Gi(ig(a),2)&&Hi(hg(a),-1,2)?1:0},Jk=function(a){return jg(a)===Zo(ud)&&Gi(ig(a),-1)&&Sk(hg(a))&&3===ml(a)?1:0},Bk=function(a){if(a.k===da)return 1;for(;uk(a);){if(Bk(jg(a)))return 1;a=tg(a)}return 0},Ek=function(a){return Fi(a,Zj)?1:0},$k=function(a){var b,c;if(c=0,b=0,jg(a)!==Zo(ud))return 0;if(Fi(ig(a),Zj))return hg(a)!==Zo(Nd)?0:3!==ml(a)?0:2;if(!Qk(ig(a)))return 0;if(!Fi(hg(a),Zj))return 0;if(gg(a)!==Zo(Nd))return 0;if(4!==ml(a))return 0;if(qn(ig(a)),un(2),Rl(),2147483648===(c=Qm()))return 0;switch(c<1&&(b=1,c=-c),c%4){case 0:c=1;break;case 1:c=b?4:3;break;case 2:c=2;break;case 3:c=b?3:4}return c},Pk=function(a){var b;return b=0,a===Zo(Nd)?2:jg(a)===Zo(ud)&&Qk(ig(a))&&hg(a)===Zo(Nd)&&3===ml(a)?(0,qn(ig(a)),un(2),Rl(),2147483648===(b=Qm())?0:b=b<0?4- -b%4:1+(b-1)%4):0},c.iszero=fl,c.isnegativenumber=Mk,c.isplusone=Tk,c.isminusone=Ik,c.isinteger=Fk,c.isnonnegativeinteger=Ok,c.isposint=Yk,c.isnegativeterm=Nk,c.isimaginarynumber=Dk,c.iscomplexnumber=tk,c.iseveninteger=yk,c.isnegative=Lk,c.issymbolic=dl,c.isintegerfactor=Gk,c.isoneover=Rk,c.isfraction=Ck,c.isoneoversqrttwo=Sk,c.isminusoneoversqrttwo=Jk,c.isfloating=Bk,c.isimaginaryunit=Ek,c.isquarterturn=$k,c.isnpi=Pk,Lb=function(){return qn(ig(wm)),wa(),wm=Nm(),un(Ok(wm)&&Nl(wm.q.a)?1:0)},Mb=function(){return qn(ig(wm)),wa(),qn(hg(wm)),wa(),qn(gg(wm)),wa(),xm=Nm(),xm===Zo(xd)?un(0):qn(xm),hl()},hl=function(){var a;return a=0,Zn(),ym=Nm(),xm=Nm(),wm=Nm(),qn(xm),(a=Qm())<0||2147483648===a?(wn(ed),qn(wm),qn(xm),qn(ym),pl(4),void Sn()):(cl(wm)?il(a):(zm=wm,wm=Zo($d),il(a),wm=zm,qn(Zo($d)),qn(wm),Wo(),wa()),Sn())},il=function(a){var b,c,d,e;for(b=0,un(1),un(0),Bm=Nm(),e=[],b=c=0,d=a;0<=d?c<d:c>d;b=0<=d?++c:--c)Am=Bm,Bm=Nm(),un(2*b+1),qn(wm),Xo(),qn(ym),sf(),qn(Bm),Rl(),un(b),qn(ym),sf(),qn(Am),Rl(),Xo(),un(b+1),e.push(Ph());return e},Nb=function(){var a;for(wm=tg(wm),qn(jg(wm)),wa(),wm=tg(wm),a=[];uk(wm);)qn(jg(wm)),wa(),jl(),a.push(wm=tg(wm));return a},jl=function(){var a;return a=0,a=Ti,Zn(),Wp(),Sn(),Ti=a},Wp=function(){return Ti=1,xm=Nm(),wm=Nm(),qn(wm),qn(xm),Cj(),qn(wm),Ph(),qn(xm),Ph(),kk()},Ob=function(){return qn(ig(wm)),wa(),qn(hg(wm)),wa(),wm=Nm(),wm===Zo(xd)?Uj():qn(wm),kl()},kl=function(){return Zn(),xm=Nm(),wm=Nm(),qn(wm),qn(xm),Dh(),ym=Nm(),qn(wm),qn(xm),qn(ym),Rm(),Ph(),qn(xm),pj(),Sn()},Pb=function(){return qn(ig(wm)),wa(),qn(hg(wm)),wa(),qn(gg(wm)),wa(),xm=Nm(),xm===Zo(xd)?un(0):qn(xm),ll()},ll=function(){return Zn(),jf(),Sn()},jf=function(){var a,b;return a=0,b=0,ym=Nm(),xm=Nm(),wm=Nm(),qn(xm),b=Qm(),qn(ym),a=Qm(),b<0||2147483648===b||a<0||2147483648===a?(wn(id),qn(wm),qn(xm),qn(ym),void pl(4)):(cl(wm)?kf(b,a):(zm=wm,wm=Zo($d),kf(b,a),wm=zm,qn(Zo($d)),qn(wm),Wo(),wa()),lf(a))},kf=function(a,b){var c,d,e,f,g,h;for(d=0,un(1),un(0),Bm=Nm(),d=e=0,f=a;0<=f?e<f:e>f;d=0<=f?++e:--e)Am=Bm,Bm=Nm(),un(2*d+1),qn(wm),Rl(),qn(Bm),Rl(),un(d),qn(Am),Rl(),Xo(),un(d+1),Ph();for(h=[],d=c=0,g=b;0<=g?c<g:c>g;d=0<=g?++c:--c)qn(wm),h.push(Hh());return h},lf=function(a){if(0!==a)return jg(wm)===Zo(O)?(qn(ig(wm)),Jo(),No()):jg(wm)===Zo(de)?(qn(ig(wm)),$g(),No()):(un(1),qn(wm),No(),Xo()),un(a),vn(1,2),Rl(),Rm(),Rl(),a%2?$l():void 0},pl=function(a){var b,c,d;for(0,qn(Zo(xd)),d=[],b=0,c=a;0<=c?b<c:b>c;0<=c?++b:--b)d.push(Vg());return d},Qb=function(){return qn(ig(wm)),wa(),ql()},ql=function(){return Zn(),Xp(),Sn()},Xp=function(){var a;if(a=0,(wm=Nm())===Zo(ha))return void un(1);if(Gi(wm,1))return void un(0);if(Mk(wm))return qn(wm),$l(),ql(),qn(Zj),wn(Nd),Rl(),void sf();if(xk(wm))return a=Math.log(wm.d),void rn(a);if(Ck(wm))return qn(wm),pm(),ql(),qn(wm),Eh(),ql(),void Xo();if(jg(wm)===Zo(Pd))return qn(hg(wm)),qn(ig(wm)),ql(),void Rl();if(jg(wm)!==Zo(ud))return wn(jd),qn(wm),pl(2);for(un(0),wm=tg(wm);uk(wm);)qn(jg(wm)),ql(),sf(),wm=tg(wm)},tl=function(a,b){return a.add(b)},Pl=function(a,b){return a.subtract(b)},function(a,b){return a.add(b)},function(a,b){return a.subtract(b)},function(a,b){return a.compareAbs(b)},Rb=function(){return qn(ig(wm)),wa(),ul()},ul=function(){return Zn(),wm=Nm(),qn(wm),pm(),Yp(),qn(wm),Eh(),Yp(),Ph(),Sn()},Yp=function(){if(Zn(),wm=Nm(),Mk(wm))qn(wm),$l();else if(jg(wm)===Zo(Pd)&&Gi(ig(wm),-1))un(1);else if(jg(wm)===Zo(Pd)&&ig(wm)===Zo(ha))qn(hg(wm)),Ln(),Vi();else if(jg(wm)===Zo(ud))for(un(1),wm=tg(wm);uk(wm);)qn(jg(wm)),ul(),Rl(),wm=tg(wm);else jg(wm)===Zo(e)?(qn(wm),Nn(),wm=Nm(),qn(wm),Ln(),un(2),Rm(),qn(wm),Yj(),un(2),Rm(),sf(),vn(1,2),Rm(),Ho()):qn(wm);return Sn()},Cl=function(a,b){return Nf.gcd(a,b)},bm=function(a){return Zn(),wm=new Xe,wm.k=je,wm.str=a,qn(wm),Sn()},function(){return To("out of memory")},An=function(a,b){return qn(xf(a*b)),Oo[kp-1].tensor.ndim=2,Oo[kp-1].tensor.dim[0]=a,Oo[kp-1].tensor.dim[1]=b},function(a){var b,c,d;for(An(a,a),b=0,b=c=0,d=a;0<=d?c<d:c>d;b=0<=d?++c:--c)Oo[kp-1].tensor.elem[b*a+b]=sm;Oo[kp-1].tensor.nelem!==Oo[kp-1].tensor.elem.length&&console.log("something wrong in tensor dimensions")},function(a){var b;for(b=[];uk(a);)qn(jg(a)),b.push(a=tg(a));return b},function(){return Zn(),wm=Nm(),qn(wm),on(wm),Sn()},function(){return print_lisp(Oo[kp-2]),print_lisp(Oo[kp-1])},Fi=function(a,b){return 0===Hg(a,b)?1:0},nl=function(a,b){return Hg(a,b)<0?1:0},zo=function(a){return a<0?-1:a>0?1:0},Hg=function(a,b){var c;if(c=0,a===b)return 0;if(a===Zo(xd))return-1;if(b===Zo(xd))return 1;if(Qk(a)&&Qk(b))return zo(Pg(a,b));if(Qk(a))return-1;if(Qk(b))return 1;if(bl(a)&&bl(b))return zo(Uo(a.str,b.str));if(bl(a))return-1;if(bl(b))return 1;if(cl(a)&&cl(b))return zo(Uo(Pj(a),Pj(b)));if(cl(a))return-1;if(cl(b))return 1;if(el(a)&&el(b))return Rg(a,b);if(el(a))return-1;if(el(b))return 1;for(;uk(a)&&uk(b);){if(0!==(c=Hg(jg(a),jg(b))))return c;a=tg(a),b=tg(b)}return uk(b)?-1:uk(a)?1:0},ml=function(a){var b;for(b=0;uk(a);)a=tg(a),b++;return b},function(a){return Zn(),wm=Zo(xd),xm=Zo(xd),qp(a),xm!==Zo(xd)&&(wm=Zo(xd)),a=wm,Sn(),a},qp=function(a){if(bl(a))return void(wm===Zo(xd)?wm=a:a!==wm&&(xm=a));for(;uk(a);){if(qp(jg(a)),xm!==Zo(xd))return;a=tg(a)}},function(){return vn(1,2),Rm()},Pp=function(){var a;return a=Ti,Ti=1,wa(),Ti=a},Vi=function(){return wn(ha),Yo(),Rm()},No=function(){return un(2),Rm()},Mo=function(a){var b,c;return b=kp-a,c=Oo.slice(b,b+a),c.sort(Hg),Oo=Oo.slice(0,b).concat(c).concat(Oo.slice(b+a))},c.equal=Fi,c.length=ml,Gl=function(a,b){return a.multiply(b)},zl=function(a,b){return a.divide(b)},Fl=function(a,b){return a.mod(b)},Al=function(a,b){var c;return c=a.divmod(b),[c.quotient,c.remainder]},Sb=function(){return qn(ig(wm)),wa(),qn(hg(wm)),wa(),Hl()},Hl=function(){var a;return a=0,Zn(),xm=Nm(),wm=Nm(),fl(xm)&&To("mod function: divide by zero"),Qk(wm)&&Qk(xm)?(xk(wm)&&(qn(wm),a=Qm(),2147483648===a&&To("mod function: cannot convert float value to integer"),un(a),wm=Nm()),xk(xm)&&(qn(xm),a=Qm(),2147483648===a&&To("mod function: cannot convert float value to integer"),un(a),xm=Nm()),Fk(wm)&&Fk(xm)||To("mod function: integer arguments expected"),ym=new Xe,ym.k=Hd,ym.q.a=Fl(wm.q.a,xm.q.a),ym.q.b=El(1),qn(ym),Sn()):(wn(sd),qn(wm),qn(xm),pl(3),void Sn())},Ml=function(a,b){return a.pow(b)},Nl=function(a){return a.isProbablePrime()},Ol=function(a,b){var c,d,e,f,g,h,i;for(a=a.abs(),c=0,d=0,e=0,0===b&&To("root index is zero"),e=0;a.shiftRight(e)>0;)e++;if(0===e)return El(0);for(e=Math.floor((e-1)/b),d=Math.floor(e/32+1),h=Nf(d),c=f=0,g=d;0<=g?f<g:f>g;c=0<=g?++f:--f)h=h.and(Nf(1).shiftLeft(c).not());for(;e>=0;){switch(h=h.or(Nf(1).shiftLeft(e)),i=Ml(h,b),yl(i,a)){case 0:return h;case 1:h=h.and(Nf(1).shiftLeft(e).not())}e--}return 0},Rl=function(){return Ki&&To("escape key stop"),Qk(Oo[kp-2])&&Qk(Oo[kp-1])?Yl():(Zn(),Zp(),Sn())},Zp=function(){var a,b,c,d,e,f;if(a=0,b=0,c=0,xm=Nm(),wm=Nm(),a=kp,fl(wm)||fl(xm))return void qn(fq);if(Ti&&qk(wm))for(wm=tg(wm),qn(fq);uk(wm);)qn(jg(wm)),qn(xm),Rl(),sf(),wm=tg(wm);else if(Ti&&qk(xm))for(xm=tg(xm),qn(fq);uk(xm);)qn(wm),qn(jg(xm)),Rl(),sf(),xm=tg(xm);else{if(!el(wm)&&el(xm))return qn(wm),qn(xm),void $n();if(el(wm)&&!el(xm))return qn(wm),qn(xm),void ep();for(jg(wm)===Zo(ud)?wm=tg(wm):(qn(wm),pl(1),wm=Nm()),jg(xm)===Zo(ud)?xm=tg(xm):(qn(xm),pl(1),xm=Nm()),Qk(jg(wm))&&Qk(jg(xm))?(qn(jg(wm)),qn(jg(xm)),Yl(),wm=tg(wm),xm=tg(xm)):Qk(jg(wm))?(qn(jg(wm)),wm=tg(wm)):Qk(jg(xm))?(qn(jg(xm)),xm=tg(xm)):qn(sm),Hm(),Im();uk(wm)&&uk(xm);)if($f(wm)!==Zo(Kd)||$f(xm)!==Zo(Kd))switch(Hg(ym,zm)){case-1:qn(jg(wm)),wm=tg(wm),Hm();break;case 1:qn(jg(xm)),xm=tg(xm),Im();break;case 0:Ng(a),wm=tg(wm),xm=tg(xm),Hm(),Im();break;default:To("internal error 2")}else wn(Kd),qn(mg(wm)),qn(mg(xm)),append(),Vg(),wm=tg(wm),xm=tg(xm),Hm(),Im();for(;uk(wm);)qn(jg(wm)),wm=tg(wm);for(;uk(xm);)qn(jg(xm)),xm=tg(xm);if(mf(a),Ti)for(b=d=e=a,f=kp;e<=f?d<f:d>f;b=e<=f?++d:--d)if(qk(Oo[b]))return void Sl(kp-a);if(1!==(c=kp-a))return _k(Oo[a])&&Gi(Oo[a],1)?void(2===c?(Cm=Nm(),Nm(),qn(Cm)):(Oo[a]=Zo(ud),pl(c))):(pl(c),Cm=Nm(),wn(ud),qn(Cm),Vg())}},Hm=function(){if(ym=jg(wm),Am=sm,jg(ym)===Zo(Pd))return Am=hg(ym),ym=ig(ym)},Im=function(){if(zm=jg(xm),Bm=sm,jg(zm)===Zo(Pd))return Bm=hg(zm),zm=ig(zm)},Ng=function(a){return qn(zm),qn(Am),qn(Bm),sf(),Rm(),Cm=Nm(),Qk(Cm)?(qn(Oo[a]),qn(Cm),Yl(),Oo[a]=Nm()):jg(Cm)===Zo(ud)&&Qk(ig(Cm))&&rg(Cm)===Zo(xd)?(qn(Oo[a]),qn(ig(Cm)),Yl(),Oo[a]=Nm(),qn(hg(Cm))):qn(Cm)},Tj=[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,1,-6,-7,-8,-3,-4,-5,13,14,15,-16,9,10,11,-12],[0,0,6,-1,-11,10,-2,-15,14,12,-5,4,-9,16,-8,7,-13],[0,0,7,11,-1,-9,15,-2,-13,5,12,-3,-10,8,16,-6,-14],[0,0,8,-10,9,-1,-14,13,-2,-4,3,12,-11,-7,6,16,-15],[0,0,3,2,15,-14,1,11,-10,16,-8,7,13,12,-5,4,9],[0,0,4,-15,2,13,-11,1,9,8,16,-6,14,5,12,-3,10],[0,0,5,14,-13,2,10,-9,1,-7,6,16,15,-4,3,12,11],[0,0,13,12,-5,4,16,-8,7,-1,-11,10,-3,-2,-15,14,-6],[0,0,14,5,12,-3,8,16,-6,11,-1,-9,-4,15,-2,-13,-7],[0,0,15,-4,3,12,-7,6,16,-10,9,-1,-5,-14,13,-2,-8],[0,0,16,-9,-10,-11,-13,-14,-15,-3,-4,-5,1,-6,-7,-8,2],[0,0,9,-16,8,-7,-12,5,-4,-2,-15,14,6,-1,-11,10,3],[0,0,10,-8,-16,6,-5,-12,3,15,-2,-13,7,11,-1,-9,4],[0,0,11,7,-6,-16,4,-3,-12,-14,13,-2,8,-10,9,-1,5],[0,0,12,13,14,15,9,10,11,-6,-7,-8,-2,-3,-4,-5,-1]],function(a){var b;if(b=Tj[Math.floor(wm.gamma)][Math.floor(xm.gamma)],b<0&&(b=-b,qn(Oo[a]),$l(),Oo[a]=Nm()),b>1)return qn(_gamma[b])},Xl=function(){var a;return a=Ti,Ti=0,Rl(),Ti=a},Sl=function(a){var b,c,d,e;if(c=0,1!==a){if(0===a)return void qn(sm);for(b=kp-a,qn(Oo[b]),c=d=1,e=a;1<=e?d<e:d>e;c=1<=e?++d:--d)qn(Oo[b+c]),Rl();return Oo[b]=Nm(),kp=b+1}},Tl=function(a){var b;return b=Ti,Ti=0,Sl(a),Ti=b},Ph=function(){return Qk(Oo[kp-2])&&Qk(Oo[kp-1])?Qh():(kk(),Rl())},kk=function(){return Qk(Oo[kp-1])?lk():(un(-1),Rm())},Mn=function(){return Qk(Oo[kp-1])?lk():(un(-1),Rm())},$l=function(){return Qk(Oo[kp-1])?am():(un(-1),Rl())},function(){var a;return a=Ti,Ti=1,$l(),Ti=a},_l=function(){var a;return a=Ti,Ti=0,$l(),Ti=a},mf=function(a){var b,c,d,e,f,g,h,i,j,k;if(d=0,!(Tk(Oo[a])||Ik(Oo[a])||xk(Oo[a]))){for(d=e=f=a+1,g=kp;(f<=g?e<g:e>g)&&!gf(Oo[d]);d=f<=g?++e:--e);if(d!==kp){for(Zn(),qn(Oo[a]),Ll(),wm=Nm(),d=b=h=a+1,i=kp;(h<=i?b<i:b>i)&&(!Tk(wm)&&!Ik(wm));d=h<=i?++b:--b)gf(Oo[d])&&(ym=ig(Oo[d]),zm=hg(Oo[d]),Mk(zm)&&(qn(wm),qn(ym),Ph(),Am=Nm(),Fk(Am)&&(wm=Am,wn(Pd),qn(ym),qn(sm),qn(zm),sf(),pl(3),Oo[d]=Nm())));for(qn(Oo[a]),Kl(),xm=Nm(),d=c=j=a+1,k=kp;(j<=k?c<k:c>k)&&!Tk(xm);d=j<=k?++c:--c)gf(Oo[d])&&(ym=ig(Oo[d]),zm=hg(Oo[d]),Mk(zm)||(qn(xm),qn(ym),Ph(),Am=Nm(),Fk(Am)&&(xm=Am,wn(Pd),qn(ym),qn(zm),qn(sm),Xo(),pl(3),Oo[d]=Nm())));return qn(wm),qn(xm),Ph(),Oo[a]=Nm(),Sn()}}},gf=function(a){return jg(a)===Zo(Pd)&&Qk(ig(a))&&Qk(hg(a))&&!Ik(ig(a))?1:0},Ed=101,Bd=1e-6,Cd=1e-9,Ad=function(a){return Math.sqrt(a.r*a.r+a.i*a.i)},0,Dd=function(){return 4*Math.random()-2},qm=function(){function a(){}return a.prototype.r=0,a.prototype.i=0,a}(),fm=new qm,gm=new qm,mm=new qm,nm=new qm,km=new qm,lm=new qm,jm=new qm,im=new qm,hm=[],ak=rm=0,On=Ed;0<=On?rm<On:rm>On;ak=0<=On?++rm:--rm)hm[ak]=new qm;for(Vb=function(){var a,b,c,d,e,f,g,h,i;for(d=0,e=0,f=0,g=0,qn(ig(wm)),wa(),qn(hg(wm)),wa(),xm=Nm(),xm===Zo(xd)?Uj():qn(xm),xm=Nm(),wm=Nm(),Uk(wm,xm)||To("nroots: polynomial?"),d=kp,qn(wm),qn(xm),g=Kg(),g>Ed&&To("nroots: degree?"),e=a=0,h=g;0<=h?a<h:a>h;e=0<=h?++a:--a)qn(Oo[d+e]),Ln(),Rp(),wa(),wm=Nm(),qn(Oo[d+e]),Yj(),Rp(),wa(),xm=Nm(),xk(wm)&&xk(xm)||To("nroots: coefficients?"),hm[e].r=wm.d,hm[e].i=xm.d;for(kp=d,Il(g),f=b=g;b>1;f=b+=-1)tj(f),Math.abs(fm.r)<Bd&&(fm.r=0),Math.abs(fm.i)<Bd&&(fm.i=0),rn(fm.r),rn(fm.i),qn(Zj),Rl(),sf(),Fd(f);if((g=kp-d)>1){for(Mo(g),wm=xf(g),wm.tensor.ndim=1,wm.tensor.dim[0]=g,e=c=0,i=g;0<=i?c<i:c>i;e=0<=i?++c:--c)wm.tensor.elem[e]=Oo[d+e];return kp=d,qn(wm)}},Il=function(a){var b,c,d,e;for(c=0,e=0,nm.r=hm[a-1].r,nm.i=hm[a-1].i,e=nm.r*nm.r+nm.i*nm.i,c=b=0,d=a-1;0<=d?b<d:b>d;c=0<=d?++b:--b)hm[c].r=(hm[c].r*nm.r+hm[c].i*nm.i)/e,hm[c].i=(hm[c].i*nm.r-hm[c].r*nm.i)/e;return hm[a-1].r=1,hm[a-1].i=0},tj=function(a){var b,c,d,e;if(0,0,e=0,Ad(hm[0])<Bd)return fm.r=0,void(fm.i=0);for(b=0;b<100;++b)for(fm.r=Dd(),fm.i=Dd(),Tg(a),gm.r=fm.r,gm.i=fm.i,lm.r=km.r,lm.i=km.i,fm.r=Dd(),fm.i=Dd(),c=0;c<1e3;++c){if(Tg(a),d=Ad(km),R&&console.log("nrabs: "+d),d<Cd)return;if(Ad(km)<Ad(lm)&&(mm.r=fm.r,mm.i=fm.i,fm.r=gm.r,fm.i=gm.i,gm.r=mm.r,gm.i=mm.i,mm.r=km.r,mm.i=km.i,km.r=lm.r,km.i=lm.i,lm.r=mm.r,lm.i=mm.i),jm.r=gm.r-fm.r,jm.i=gm.i-fm.i,im.r=lm.r-km.r,im.i=lm.i-km.i,0===(e=im.r*im.r+im.i*im.i))break;nm.r=(jm.r*im.r+jm.i*im.i)/e,nm.i=(jm.i*im.r-jm.r*im.i)/e,fm.r=gm.r-(nm.r*lm.r-nm.i*lm.i),fm.i=gm.i-(nm.r*lm.i+nm.i*lm.r)}return To("nroots: convergence error")},Tg=function(a){var b,c,d,e,f;for(c=0,f=0,mm.r=fm.r,mm.i=fm.i,km.r=hm[0].r+hm[1].r*mm.r-hm[1].i*mm.i,km.i=hm[0].i+hm[1].r*mm.i+hm[1].i*mm.r,e=[],c=b=2,d=a;2<=d?b<d:b>d;c=2<=d?++b:--b)f=fm.r*mm.r-fm.i*mm.i,mm.i=fm.r*mm.i+fm.i*mm.r,mm.r=f,km.r+=hm[c].r*mm.r-hm[c].i*mm.i,e.push(km.i+=hm[c].r*mm.i+hm[c].i*mm.r);return e},Fd=function(a){var b,c,d,e,f,g;for(d=0,d=b=e=a-1;e<=0?b<0:b>0;d=e<=0?++b:--b)hm[d-1].r+=hm[d].r*fm.r-hm[d].i*fm.i,hm[d-1].i+=hm[d].i*fm.r+hm[d].r*fm.i;for(Ad(hm[0])>Bd&&To("nroots: residual error"),g=[],d=c=0,f=a-1;0<=f?c<f:c>f;d=0<=f?++c:--c)hm[d].r=hm[d+1].r,g.push(hm[d].i=hm[d+1].i);return g},Xb=function(){return qn(ig(wm)),wa(),pm()},pm=function(){var a;if(a=0,Zn(),wm=Nm(),jg(wm)===Zo(e)&&(qn(wm),Jn(),wm=Nm()),jg(wm)===Zo(ud)){for(a=kp,wm=tg(wm);uk(wm);)qn(jg(wm)),pm(),wm=tg(wm);Sl(kp-a)}else _k(wm)?(qn(wm),Ll()):qn(jg(wm)===Zo(Pd)&&Nk(hg(wm))?sm:wm);return Sn()},$b=function(){var a;for(wm=tg(wm),qn(jg(wm)),wa(),wm=tg(wm),a=[];uk(wm);)qn(jg(wm)),wa(),um(),a.push(wm=tg(wm));return a},um=function(){return Zn(),xm=Nm(),wm=Nm(),el(wm)&&el(xm)?$p():(qn(wm),qn(xm),el(wm)?ep():el(xm)?$n():Rl()),Sn()},$p=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m;for(e=0,f=0,g=0,h=0,i=0,h=wm.tensor.ndim+xm.tensor.ndim,h>md&&To("outer: rank of result exceeds maximum"),i=wm.tensor.nelem*xm.tensor.nelem,ym=xf(i),ym.tensor.ndim=h,e=a=0,j=wm.tensor.ndim;0<=j?a<j:a>j;e=0<=j?++a:--a)ym.tensor.dim[e]=wm.tensor.dim[e];for(f=e,e=b=0,k=xm.tensor.ndim;0<=k?b<k:b>k;e=0<=k?++b:--b)ym.tensor.dim[f+e]=xm.tensor.dim[e];for(g=0,e=c=0,l=wm.tensor.nelem;0<=l?c<l:c>l;e=0<=l?++c:--c)for(f=d=0,m=xm.tensor.nelem;0<=m?d<m:d>m;f=0<=m?++d:--d)qn(wm.tensor.elem[e]),qn(xm.tensor.elem[f]),Rl(),ym.tensor.elem[g++]=Nm();return qn(ym)},Jm=function(){for(Zn(),xm=Nm(),wm=Nm(),un(1),ym=Nm(),zm=ym,wm=tg(wm);uk(wm);)Rc(jg(wm),xm)?(qn(zm),qn(jg(wm)),Rl(),zm=Nm()):(qn(ym),qn(jg(wm)),Rl(),ym=Nm()),wm=tg(wm);return qn(ym),qn(zm),Sn()},_b=function(){return qn(ig(wm)),wa(),Km()},Km=function(){return Zn(),wm=Nm(),qn(wm),ul(),qn(Zj),qn(wm),Gf(),Rl(),Vi(),Rl(),Sn()},Zl=0,hj=function(){var a;return a=0,Zn(),wm=Nm(),Gi(wm,0)||Gi(wm,1)||Gi(wm,-1)?(qn(wm),void Sn()):(Zl=wm.q.a,a=kp,ej(),kp-a>1&&(pl(kp-a),wn(ud),Yo(),Vg()),Sn())},ej=function(){var a,b;for(b=0,Zl.isNegative()&&(Zl=qo(Zl,1),un(-1)),b=a=0;a<1e4;b=++a)if(pp(b),0===Zl.compare(1))return;return gj()},pp=function(a){var b,c,d,e,f;for(b=0,c=El(Wm[a]),b=0;;){if(0===Zl.compare(1))return void(b&&sn(c,b));if(f=Al(Zl,c),d=f[0],e=f[1],!e.isZero())break;b++,Zl=d}if(b&&sn(c,b),-1===yl(d,c))return sn(Zl,1),Zl=El(1)},gj=function(){var a,b,c,d,e,f,g;for(c=0,d=0,a=El(1),f=El(5),g=El(2),c=1,d=1;;){if(Nl(Zl))return sn(Zl,1),0;for(;;){if(Ki&&To("esc"),e=Pl(g,f),e=qo(e,1),b=Cl(e,Zl),!od(b,1)){if(sn(b,1),0===yl(b,Zl))return-1;e=zl(Zl,b),Zl=e,e=Fl(f,Zl),f=e,e=Fl(g,Zl),g=e;break}0==--c&&(g=f,d*=2,c=d),e=Gl(f,f),f=tl(e,a),e=Fl(f,Zl),f=e}}},sn=function(a,b){if(wm=new Xe,wm.k=Hd,wm.q.a=a,wm.q.b=El(1),qn(wm),b>1)return wn(Pd),Yo(),wm=new Xe,wm.k=Hd,wm.q.a=El(b),wm.q.b=El(1),qn(wm),pl(3)},ac=function(){return qn(ig(wm)),wa(),qn(hg(wm)),wa(),Rm()},Rm=function(){return Zn(),_p(),Sn()},_p=function(){var a;if(a=0,xm=Nm(),wm=Nm(),_k(wm)&&_k(xm))return qn(wm),qn(xm),void En();if(Qk(wm)&&Qk(xm))return qn(wm),qn(xm),void Wh();if(el(wm))return void Um();if(wm===Zo(ha)&&jg(xm)===Zo(jd))return void qn(ig(xm));if(wm===Zo(ha)&&xk(xm))return void rn(Math.exp(xm.d));if(Fi(wm,sm)||fl(xm))return void qn(sm);if(Fi(xm,sm))return void qn(wm);if(jg(wm)!==Zo(ud)){if(jg(wm)===Zo(Pd))return qn(ig(wm)),qn(hg(wm)),qn(xm),Rl(),void Rm();if(Ti&&qk(wm)&&Qk(xm)&&(qn(xm),(a=Qm())>1&&2147483648!==a))return void Tm(a);if(1===np&&jg(wm)===Zo(de)&&yk(xm))return un(1),qn(ig(wm)),$g(),un(2),Rm(),Xo(),qn(xm),vn(1,2),Rl(),void Rm();if(2===np&&jg(wm)===Zo(O)&&yk(xm))return un(1),qn(ig(wm)),Jo(),un(2),Rm(),Xo(),qn(xm),vn(1,2),Rl(),void Rm();if(tk(wm)){if(Fk(xm))return qn(wm),Ug(),ym=Nm(),qn(ym),qn(ym),qn(wm),Rl(),Ph(),qn(xm),$l(),void Rm();if(Qk(xm))return qn(wm),ul(),qn(xm),Rm(),un(-1),qn(wm),Gf(),qn(xm),Rl(),qn(Zo(Nd)),Ph(),Rm(),void Rl()}if(!Fo())return wn(Pd),qn(wm),qn(xm),pl(3)}else for(wm=tg(wm),qn(jg(wm)),qn(xm),Rm(),wm=tg(wm);uk(wm);)qn(jg(wm)),qn(xm),Rm(),Rl(),wm=tg(wm)},Tm=function(a){var b,c,d,e,f,g,h,i,j,k;for(b=[],f=0,g=0,h=0,h=ml(wm)-1,tn(h*(a+1)),wm=tg(wm),f=c=0,i=h;0<=i?c<i:c>i;f=0<=i?++c:--c){for(g=d=0,j=a;0<=j?d<=j:d>=j;g=0<=j?++d:--d)qn(jg(wm)),un(g),Rm(),Oo[yj+f*(a+1)+g]=Nm();wm=tg(wm)}for(un(a),kj(),wm=Nm(),f=e=0,k=h;0<=k?e<k:e>k;f=0<=k?++e:--e)b[f]=0;return qn(fq),Ql(h,a,b,0,a),Pm(h*(a+1))},Ql=function(a,b,c,d,e){var f,g,h,i,j,k,l;i=0;{if(!(d<a-1)){for(c[d]=e,qn(wm),i=g=0,k=a;0<=k?g<k:g>k;i=0<=k?++g:--g)un(c[i]),kj(),Ph();for(i=h=0,l=a;0<=l?h<l:h>l;i=0<=l?++h:--h)qn(Oo[yj+i*(b+1)+c[i]]),Rl();return sf()}for(i=f=0,j=e;0<=j?f<=j:f>=j;i=0<=j?++f:--f)c[d]=i,Ql(a,b,c,d+1,e-i)}},Fo=function(){var a;switch(a=0,a=$k(xm)){case 0:1;break;case 1:return un(1),1;case 2:return un(-1),1;case 3:return qn(Zj),1;case 4:return qn(Zj),$l(),1}if(jg(xm)===Zo(e)){for(ym=tg(xm);uk(ym)&&!(a=$k(jg(ym)));)ym=tg(ym);switch(a){case 0:return 0;case 1:un(1);break;case 2:un(-1);break;case 3:qn(Zj);break;case 4:qn(Zj),$l()}return qn(xm),qn(jg(ym)),Xo(),Vi(),Rl(),1}return 0},cc=function(){return qn(ig(wm)),wa(),Vm()},Vm=function(){var a;return a=0,a=Qm(),(a<1||a>nd)&&To("prime: Argument out of range."),a=Wm[a-1],un(a)},Sm="^",Vo="",fn=function(a){return Vo+=a},Zm=function(a){return Vo+=a},Mg=function(a){return Vo="",_m(a),Vo},on=function(a){return Vo="",_m(a),console.log(Vo)},$m=function(a,b){return Zn(),wm=ig(a),xm=hg(a),1!==b||Ik(xm)||Zm("("),Ck(wm)||jg(wm)===Zo(e)||jg(wm)===Zo(ud)||jg(wm)===Zo(Pd)||nl(wm,fq)?(Zm("("),_m(wm),Zm(")")):_m(wm),Ik(xm)?void Sn():(0===fp?fn(Sm):Zm("^"),qn(xm),$l(),xm=Nm(),Ck(xm)||jg(xm)===Zo(e)||jg(xm)===Zo(ud)||jg(xm)===Zo(Pd)?(Zm("("),_m(xm),Zm(")")):_m(xm),1===b&&Zm(")"),Sn())},Ym=function(a){var b,c;for(xj=0,c=0,b=0,Zn(),c=0,b=0,wm=tg(a),xm=jg(wm),_k(xm)?(qn(xm),Ll(),of(),ym=Nm(),qn(xm),Kl(),zm=Nm(),Tk(ym)||c++,Tk(zm)||b++,wm=tg(wm)):(ym=sm,zm=sm);uk(wm);)xm=jg(wm),nk(xm)?b++:c++,wm=tg(wm);if(0===c)Zm("1");else for(xj=0,wm=tg(a),_k(jg(wm))&&(wm=tg(wm)),Tk(ym)||(an(ym),xj=1);uk(wm);)xm=jg(wm),nk(xm)?1:(xj&&dn(),an(xm),xj=1),wm=tg(wm);for(fn(0===fp?" / ":"/"),b>1&&Zm("("),xj=0,wm=tg(a),_k(jg(wm))&&(wm=tg(wm)),Tk(zm)||(an(zm),xj=1);uk(wm);)xm=jg(wm),nk(xm)&&(xj&&dn(),$m(xm,b),xj=1),wm=tg(wm);return b>1&&Zm(")"),Sn()},_m=function(a){var b;if(qk(a)){for(a=tg(a),"-"===Ao(jg(a))&&fn("-"),ln(jg(a)),a=tg(a),b=[];uk(a);)fn("+"===Ao(jg(a))?0===fp?" + ":"+":0===fp?" - ":"-"),ln(jg(a)),b.push(a=tg(a));return b}return"-"===Ao(a)&&fn("-"),ln(a)},Ao=function(a){return jg(a)===Zo(ud)&&Qk(ig(a))&&nl(ig(a),fq)?"-":Qk(a)&&nl(a,fq)?"-":"+"},ln=function(a){var b;if(jg(a)===Zo(ud)&&zf(a))return void Ym(a);if(jg(a)===Zo(ud)){for(a=tg(a),Ik(jg(a))&&(a=tg(a)),an(jg(a)),a=tg(a),b=[];uk(a);)dn(),an(jg(a)),b.push(a=tg(a));return b}return an(a)},gn=function(a){return Zm("("),_m(a),Zm(")")},bn=function(a){return a=ig(a),jg(a)===Zo(e)||jg(a)===Zo(ud)||jg(a)===Zo(Pd)||jg(a)===Zo(Lc)?gn(a):_m(a),Zm("!")},hn=function(a){return kn(a,0,0)},kn=function(a,b,c){var d,e,f;for(e=0,fn("("),e=d=0,f=a.tensor.dim[b];0<=f?d<f:d>f;e=0<=f?++d:--d)b+1===a.tensor.ndim?(_m(a.tensor.elem[c]),c++):c=kn(a,b+1,c),e+1<a.tensor.dim[b]&&fn(0===fp?",":",");return fn(")"),c},an=function(a){if(Qk(a))return void en(a);if(bl(a))return fn('"'),fn(a.str),void fn('"');if(el(a))return void hn(a);if(qk(a)||jg(a)===Zo(ud))return fn("("),_m(a),void fn(")");if(jg(a)===Zo(Pd))return ig(a)===Zo(ha)?(fn("exp("),_m(hg(a)),void fn(")")):Ik(hg(a))?(fn(0===fp?"1 / ":"1/"),void(uk(ig(a))?(fn("("),_m(ig(a)),fn(")")):_m(ig(a)))):(qk(ig(a))||Zf(a)===Zo(ud)||Zf(a)===Zo(Pd)||Mk(ig(a))?(fn("("),_m(ig(a)),fn(")")):Qk(ig(a))&&(nl(ig(a),fq)||Ck(ig(a)))?(fn("("),an(ig(a)),fn(")")):an(ig(a)),fn(0===fp?Sm:"^"),void(uk(hg(a))||Ck(hg(a))||Qk(hg(a))&&nl(hg(a),fq)?(fn("("),_m(hg(a)),fn(")")):an(hg(a))));if(jg(a)===Zo(Xc)&&cl(ig(a)))return void print_index_function(a);if(jg(a)===Zo(Lc))return void bn(a);if(uk(a)){if(an(jg(a)),a=tg(a),fn("("),uk(a))for(_m(jg(a)),a=tg(a);uk(a);)fn(0===fp?",":","),_m(jg(a)),a=tg(a);return void fn(")")}return a===Zo(W)?Zm("d"):fn(a===Zo(ha)?"exp(1)":a===Zo(Nd)?"pi":Pj(a))},Xm=function(a,b){var c;switch(c=!1,null==b&&(c=!0,b=""),a.k){case M:for(b+="(",b=Xm(jg(a),b),a===tg(a)&&console.log("oh no recursive!"),a=tg(a);uk(a);)b+=" ",b=Xm(jg(a),b),(a=tg(a))===tg(a)&&console.log("oh no recursive!");a!==Zo(xd)&&(b+=" . ",b=Xm(a,b)),b+=")";break;case je:b+=a.str;break;case Hd:case da:b=en(a,b);break;case me:b+=Pj(a);break;default:b+="<tensor>"}return c?console.log(b):b},dn=function(){return fn(0===fp?" ":"*")},nk=function(a){return jg(a)===Zo(Pd)&&ig(a)!==Zo(ha)&&Nk(hg(a))?1:0},zf=function(a){var b;for(a=tg(a);uk(a);){if(b=jg(a),nk(b))return 1;a=tg(a)}return 0},dc=function(){var a,b,c,d,e,f;for(b=0,c=0,d=0,Bm=ig(wm),cl(Bm)||To("product: 1st arg?"),qn(hg(wm)),wa(),c=Qm(),2147483648===c&&To("product: 2nd arg?"),qn(gg(wm)),wa(),d=Qm(),2147483648===d&&To("product: 3rd arg?"),wm=fg(wm),zm=Mj(Bm),ym=Lj(Bm),un(1),b=a=e=c,f=d;e<=f?a<=f:a>=f;b=e<=f?++a:--a)un(b),Am=Nm(),ro(Bm,Am),qn(wm),wa(),Rl();return so(Bm,zm,ym)},Bn=function(){var a,b,c,d,e;return Zn(),xm=Nm(),wm=Nm(),b=Gl(wm.q.a,xm.q.b),d=Gl(wm.q.b,xm.q.a),a=tl(b,d),vd(a)?(qn(fq),void Sn()):(c=Gl(wm.q.b,xm.q.b),e=Cl(a,c),e=wl(e,c),wm=new Xe,wm.k=Hd,wm.q.a=zl(a,e),wm.q.b=zl(c,e),qn(wm),Sn())},Cn=function(){var a,b,c;return Zn(),xm=Nm(),wm=Nm(),vd(xm.q.a)&&To("divide by zero"),vd(wm.q.a)?(qn(fq),void Sn()):(a=Gl(wm.q.a,xm.q.b),b=Gl(wm.q.b,xm.q.a),c=Cl(a,b),c=wl(c,b),wm=new Xe,wm.k=Hd,wm.q.a=zl(a,c),wm.q.b=zl(b,c),qn(wm),Sn())},Dn=function(){var a,b,c;return Zn(),xm=Nm(),wm=Nm(),vd(wm.q.a)||vd(xm.q.a)?(qn(fq),void Sn()):(a=Gl(wm.q.a,xm.q.a),b=Gl(wm.q.b,xm.q.b),c=Cl(a,b),c=wl(c,b),wm=new Xe,wm.k=Hd,wm.q.a=zl(a,c),wm.q.b=zl(b,c),qn(wm),Sn())},En=function(){return Zn(),Fn(),Sn()},Fn=function(){var a,b,c,d,e,f;return c=0,xm=Nm(),wm=Nm(),Tk(wm)||fl(xm)?void un(1):fl(wm)?(Mk(xm)&&To("divide by zero"),void qn(fq)):Tk(xm)?void qn(wm):Fk(xm)?(qn(xm),2147483648===(c=Qm())?(wn(Pd),qn(wm),qn(xm),void pl(3)):(e=Ml(wm.q.a,Math.abs(c)),f=Ml(wm.q.b,Math.abs(c)),c<0&&(d=e,e=f,f=d,e=wl(e,f),f=vl(f)),ym=new Xe,ym.k=Hd,ym.q.a=e,ym.q.b=f,void qn(ym))):Ik(wm)?(qn(xm),void em()):Mk(wm)?(qn(wm),$l(),qn(xm),En(),un(-1),qn(xm),En(),void Rl()):Fk(wm)?pk(wm)?(qn(wm),qn(xm),void Gn()):xm.q.a.isSmall&&xm.q.b.isSmall?(a=xm.q.a,b=xm.q.b,0===(e=Ol(wm.q.a,b))?(wn(Pd),qn(wm),qn(xm),void pl(3)):(f=Ml(e,a),ym=new Xe,ym.k=Hd,xm.q.a.isNegative()?(ym.q.a=Nf(1),ym.q.b=f):(ym.q.a=f,ym.q.b=Nf(1)),qn(ym))):(wn(Pd),qn(wm),qn(xm),void pl(3)):(qn(wm),Ll(),qn(xm),En(),qn(wm),Kl(),qn(xm),$l(),En(),void Rl())},em=function(){return Zn(),wm=Nm(),Fk(wm)?(un(wm.q.a.isOdd()?-1:1),void Sn()):(qn(wm),Tf(),xm=Nm(),Mk(wm)&&(qn(xm),un(-1),sf(),xm=Nm()),qn(wm),qn(xm),Xo(),ym=Nm(),wn(Pd),un(-1),qn(ym),pl(3),xm.q.a.isOdd()&&$l(),Sn())},pk=function(a){return a.q.a.isSmall},Gn=function(){var a,b,c,d,e,f;for(c=0,Zn(),xm=Nm(),wm=Nm(),b=kp,qn(wm),ij(),d=kp-b,f=b,c=a=0,e=d;a<e;c=a+=2)qn(Oo[f+c]),qn(Oo[f+c+1]),qn(xm),Rl(),Hn();return Sl(kp-b-d),wm=Nm(),kp=b,qn(wm),Sn()},Hn=function(){var a;return a=0,Zn(),xm=Nm(),wm=Nm(),qn(xm),Tf(),ym=Nm(),qn(xm),qn(ym),Xo(),zm=Nm(),fl(zm)||(wn(Pd),qn(wm),qn(zm),pl(3)),qn(ym),2147483648===(a=Qm())?(wn(Pd),qn(wm),qn(ym),pl(3),void Sn()):0===a?void Sn():(qn(wm),Qf(a),Sn())},fc=function(){return qn(ig(wm)),wa(),qn(hg(wm)),wa(),qn(gg(wm)),wa(),wm=Nm(),wm===Zo(xd)&&(wm=Zo(xe)),qn(wm),Th()},Th=function(){var a,b,c,d,e,f,g,h,i;for(d=0,e=0,f=0,g=0,i=0,Zn(),ym=Nm(),xm=Nm(),wm=Nm(),d=kp,b=kp,qn(wm),qn(ym),f=Kg()-1,c=kp,qn(xm),qn(ym),g=Kg()-1,i=f-g,un(0),Am=Nm();i>=0;){for(qn(Oo[b+f]),qn(Oo[c+g]),Ph(),zm=Nm(),e=a=0,h=g;0<=h?a<=h:a>=h;e=0<=h?++a:--a)qn(Oo[b+i+e]),qn(Oo[c+e]),qn(zm),Rl(),Xo(),Oo[b+i+e]=Nm();qn(Am),qn(zm),qn(ym),un(i),Rm(),Rl(),sf(),Am=Nm(),f--,i--}return kp=d,qn(Am),Sn()},R=0,hc=function(){return qn(ig(wm)),wa(),Jn()},Jn=function(){var a;return a=Ti,Zn(),aq(),Sn(),Ti=a},aq=function(){if(wm=Nm(),el(wm))return void nf();if(Ti=0,jg(wm)!==Zo(e))return void qn(wm);for(R&&(printf("rationalize: this is the input expr:\n"),on(wm)),qn(sm),Ul(wm),xm=Nm(),R&&(printf("rationalize: this is the common denominator:\n"),on(xm)),qn(fq),ym=tg(wm);uk(ym);)qn(xm),qn(jg(ym)),Rl(),sf(),ym=tg(ym);return R&&(printf("rationalize: original expr times common denominator:\n"),on(Oo[kp-1])),Q(),R&&(printf("rationalize: after factoring:\n"),on(Oo[kp-1])),qn(xm),Ph(),R?(printf("rationalize: after dividing by common denom. (and we're done):\n"),on(Oo[kp-1])):void 0},Ul=function(a){var b;if(jg(a)===Zo(e)){for(a=tg(a),b=[];uk(a);)Wl(jg(a)),b.push(a=tg(a));return b}return Wl(a)},Wl=function(a){var b;if(jg(a)===Zo(ud)){for(a=tg(a),b=[];uk(a);)Vl(jg(a)),b.push(a=tg(a));return b}return Vl(a)},Vl=function(a){if(jg(a)===Zo(Pd))return qn(a),a=hg(a),Mk(a)?(kk(),void hf()):jg(a)===Zo(ud)&&Mk(ig(a))?(kk(),void hf()):Nm()},nf=function(){var a,b,c,d;if(b=0,qn(wm),wa(),wm=Nm(),!el(wm))return void qn(wm);for(c=wm.tensor.nelem,b=a=0,d=c;0<=d?a<d:a>d;b=0<=d?++a:--a)qn(wm.tensor.elem[b]),Jn(),wm.tensor.elem[b]=Nm();return wm.tensor.nelem!==wm.tensor.elem.length&&console.log("something wrong in tensor dimensions"),qn(wm)},hf=function(){return Zn(),wm=Nm(),xm=Nm(),qn(wm),qn(xm),Rl(),qn(wm),qn(xm),Cj(),Ph(),Sn()},ic=function(){return qn(ig(wm)),wa(),Ln()},Ln=function(){return Zn(),Nn(),wm=Nm(),qn(wm),qn(wm),Ug(),sf(),un(2),Ph(),Sn()},jc=function(){return qn(ig(wm)),wa(),Nn()},Nn=function(){if(Zn(),wm=Nm(),jg(wm)===Zo(e))for(un(0),wm=tg(wm);uk(wm);)qn(jg(wm)),Nn(),sf(),wm=tg(wm);else qn(wm),ul(),qn(wm),Gf(),wm=Nm(),qn(wm),$g(),qn(Zj),qn(wm),Jo(),Rl(),sf(),Rl();return Sn()},kc=function(){return xm=ig(wm),jg(xm)===Zo(_d)||jg(xm)===Zo(Fe)?(qn(ig(xm)),wa(),qn(hg(xm)),wa(),Xo()):(qn(xm),wa(),xm=Nm(),jg(xm)===Zo(_d)||jg(xm)===Zo(Fe)?(qn(ig(xm)),wa(),qn(hg(xm)),wa(),Xo()):qn(xm)),qn(hg(wm)),wa(),xm=Nm(),xm===Zo(xd)?Uj():qn(xm),xm=Nm(),wm=Nm(),Uk(wm,xm)||To("roots: 1st argument is not a polynomial"),qn(wm),qn(xm),Vn()},Vj=function(){var a,b,c,d;for(Lm=kp,qn(wm),qn(xm),d=Kg(),c=!1,kp,b=a=d;a>0;b=a+=-1)if(tk(Oo[kp-b])){c=!0;break}return kp-=d,c},Vn=function(){var a,b,c,d,e;if(b=0,c=0,d=0,b=kp-2,Wn(),d=kp-b,0===d&&To("roots: the polynomial is not factorable, try nroots"),1!==d){for(Mo(d),Zn(),wm=xf(d),wm.tensor.ndim=1,wm.tensor.dim[0]=d,c=a=0,e=d;0<=e?a<e:a>e;c=0<=e?++a:--a)wm.tensor.elem[c]=Oo[b+c];return kp=b,qn(wm),Sn()}},Wn=function(){if(Zn(),xm=Nm(),wm=Nm(),qn(wm),qn(xm),Vj()?(Nm(),Nm()):(lj(),wm=Nm()),jg(wm)===Zo(ud))for(wm=tg(wm);uk(wm);)qn(jg(wm)),qn(xm),Xn(),wm=tg(wm);else qn(wm),qn(xm),Xn();return Sn()},Xn=function(){return Zn(),xm=Nm(),wm=Nm(),jg(wm)===Zo(Pd)&&Uk(ig(wm),xm)&&Yk(hg(wm))?(qn(ig(wm)),qn(xm),Dl()):Uk(wm,xm)&&(qn(wm),qn(xm),Dl()),Sn()},Dl=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I;if(F=0,Zn(),xm=Nm(),wm=Nm(),qn(wm),qn(xm),2===(F=Kg()))return ym=Nm(),zm=Nm(),qn(zm),qn(ym),Ph(),$l(),void Sn();if(3===F)return ym=Nm(),zm=Nm(),Am=Nm(),qn(zm),qn(zm),Rl(),un(4),qn(ym),Rl(),qn(Am),Rl(),Xo(),vn(1,2),Rm(),Bm=Nm(),qn(Bm),qn(zm),Xo(),qn(ym),Ph(),vn(1,2),Rl(),qn(Bm),qn(zm),sf(),$l(),qn(ym),Ph(),vn(1,2),Rl(),void Sn();if(4===F){if(ym=Nm(),zm=Nm(),Am=Nm(),Bm=Nm(),qn(Am),qn(Am),Rl(),v=Nm(),qn(v),qn(Am),Rl(),w=Nm(),qn(zm),qn(zm),Rl(),s=Nm(),qn(s),qn(zm),Rl(),u=Nm(),qn(u),qn(Bm),un(-4),Rl(),Rl(),A=Nm(),qn(u),un(2),Rl(),d=Nm(),un(3),qn(ym),Rl(),e=Nm(),qn(e),un(9),Rl(),qn(ym),Rl(),qn(Bm),Rl(),c=Nm(),qn(c),qn(Bm),Rl(),$l(),y=Nm(),qn(e),un(2),Rl(),Nm(),qn(ym),qn(Am),Rl(),r=Nm(),qn(r),qn(zm),Rl(),q=Nm(),qn(r),un(3),Rl(),g=Nm(),un(-4),qn(ym),qn(w),Rl(),Rl(),z=Nm(),qn(q),un(9),Rl(),$l(),B=Nm(),qn(B),qn(Bm),un(-2),Rl(),Rl(),b=Nm(),qn(s),qn(g),Xo(),m=Nm(),qn(s),qn(v),Rl(),t=Nm(),qn(m),un(3),Rm(),un(4),Rl(),h=Nm(),qn(m),Do(),wa(),Rp(),wa(),of(),n=Nm(),qn(b),qn(A),qn(t),qn(z),qn(y),sf(),sf(),sf(),sf(),Do(),wa(),Rp(),wa(),of(),x=Nm(),qn(d),qn(B),qn(c),sf(),sf(),o=Nm(),qn(o),un(2),Rm(),qn(h),Xo(),vn(1,2),Rm(),p=Nm(),qn(zm),$l(),qn(e),Ph(),C=Nm(),fl(x))return fl(n)?(qn(C),void Sn()):(qn(ym),qn(Bm),un(9),Rl(),Rl(),qn(zm),qn(Am),Rl(),Xo(),qn(m),un(2),Rl(),Ph(),I=Nm(),qn(I),qn(I),qn(q),un(4),Rl(),qn(ym),qn(ym),qn(Bm),un(9),Rl(),Rl(),Rl(),$l(),qn(u),$l(),sf(),sf(),qn(ym),qn(m),Rl(),Ph(),void Sn());for(a=!1,D=!1;!a;)qn(p),D&&$l(),qn(o),sf(),vn(1,2),Rl(),vn(1,3),Rm(),j=Nm(),qn(j),Do(),wa(),Rp(),wa(),of(),l=Nm(),fl(l)?D=!0:a=!0;return qn(j),qn(e),Rl(),f=Nm(),qn(f),un(2),Rl(),i=Nm(),qn(Zj),un(3),vn(1,2),Rm(),Rl(),E=Nm(),un(1),qn(E),sf(),H=Nm(),un(1),qn(E),Xo(),G=Nm(),qn(j),qn(e),Ph(),k=Nm(),qn(C),qn(k),$l(),qn(m),qn(f),Ph(),$l(),sf(),sf(),Do(),qn(C),qn(k),qn(H),Rl(),un(2),Ph(),qn(G),qn(m),Rl(),qn(i),Ph(),sf(),sf(),Do(),qn(C),qn(k),qn(G),Rl(),un(2),Ph(),qn(H),qn(m),Rl(),qn(i),Ph(),sf(),sf(),Do(),void Sn()}return kp-=F,Sn()},Se=1001,Oe=1002,We=1003,Qe=1004,Ue=1006,Ve=1007,Re=1008,Te=1009,Pe=1010,gp="",cm=0,Bl=0,ek=0,jo=0,ip=0,hp=0,oo="",_n=function(a){return R&&console.log("#### scanning "+a),oo=a,Bl=0,Ti++,ek=0,jo=0,Oj(),""===gp?(qn(Zo(xd)),Ti--,0):(io(),Ti--,ip-ek)},fo=function(a){return oo=a,Bl=1,Ti++,ek=0,jo=0,Oj(),""===gp?(qn(Zo(xd)),Ti--,0):(io(),Ti--,ip-ek)},io=function(){if(ho(),"="===gp)return Oj(),wn(_d),Yo(),ho(),pl(3)},ho=function(){switch(bo(),gp){case Pe:return wn(Fe),Yo(),Oj(),bo(),pl(3);case Te:return wn(Ie),Yo(),Oj(),bo(),pl(3);case Re:return wn(Ge),Yo(),Oj(),bo(),pl(3);case"<":return wn(Je),Yo(),Oj(),bo(),pl(3);case">":return wn(He),Yo(),Oj(),bo(),pl(3)}},bo=function(){var a;switch(a=kp,gp){case"+":Oj(),no();break;case"-":Oj(),no(),$l();break;default:no()}for(;0===cm&&("+"===gp||"-"===gp);)"+"===gp?(Oj(),no()):(Oj(),no(),$l());if(kp-a>1)return pl(kp-a),wn(e),Yo(),Vg()},ok=function(){switch(gp){case"*":case"/":return 1;case"(":case We:case Qe:case Se:case Oe:case Ve:return cm?(jo=ip,0):1}return 0},no=function(){var a;for(a=kp,go(),kp>a&&_k(Oo[kp-1])&&Gi(Oo[kp-1],1)&&Nm();ok();)"*"===gp?(Oj(),go()):"/"===gp?(Oj(),go(),kk()):go(),kp>a+1&&Qk(Oo[kp-2])&&Qk(Oo[kp-1])&&Rl(),kp>a&&_k(Oo[kp-1])&&Gi(Oo[kp-1],1)&&Nm();return a===kp?un(1):kp-a>1?(pl(kp-a),wn(ud),Yo(),Vg()):void 0},go=function(){if(co(),"^"===gp)return Oj(),wn(Pd),Yo(),go(),pl(3)},co=function(){var a,b;if(a=kp,"("===gp?lo():gp===We?mo():gp===Qe?eo():gp===Se?(Sf(hp),Oj()):gp===Oe?(Rf(hp),Oj()):gp===Ve?ko():ao("syntax error"),"["===gp){for(Oj(),wn(Xc),Yo(),bo();","===gp;)Oj(),bo();"]"!==gp&&ao("] expected"),Oj(),pl(kp-a)}for(b=[];"!"===gp;)Oj(),wn(Lc),Yo(),b.push(pl(2));return b},mo=function(){if(gp!==We&&ao("symbol expected"),Bl&&1===hp.length)switch(hp[0]){case"a":qn(Zo(pd));break;case"b":qn(Zo(qd));break;case"x":qn(Zo(rd));break;default:qn(sp(hp))}else qn(sp(hp));return Oj()},ko=function(){return bm(hp),Oj()},eo=function(){var a,b;if(a=1,b=new Xe,b=sp(hp),qn(b),Oj(),Oj(),")"!==gp)for(io(),a++;","===gp;)Oj(),io(),a++;return")"!==gp&&ao(") expected"),Oj(),pl(a)},lo=function(){var a;if(a=0,"("!==gp&&ao("( expected"),Oj(),io(),","===gp){for(a=1;","===gp;)Oj(),io(),a++;Xf(a)}return")"!==gp&&ao(") expected"),Oj()},ao=function(a){for(Ji="";ek!==jo&&("\n"!==oo[ek]&&"\r"!==oo[ek]||ek+1!==jo);)Ji+=oo[ek++];for(Ji+=" ? ";oo[ek]&&"\n"!==oo[ek]&&"\r"!==oo[ek];)Ji+=oo[ek++];return Ji+="\n",To(a)},Xf=function(a){var b,c,d;for(c=0,Zn(),xm=xf(a),xm.tensor.ndim=1,xm.tensor.dim[0]=a,c=b=0,d=a;0<=d?b<d:b>d;c=0<=d?++b:--b)xm.tensor.elem[c]=Oo[kp-a+c];return xm.tensor.nelem!==xm.tensor.elem.length&&console.log("something wrong in tensor dimensions"),kp-=a,qn(xm),Sn()},Oj=function(){for(cm=0;;){if(Rj(),gp!==Ue)break;cm=1}if(R)return console.log("get_next_token token: "+gp)},Rj=function(){for(;al(oo[jo]);){if("\n"===oo[jo]||"\r"===oo[jo])return gp=Ue,void jo++;jo++}if(ip=jo,jo===oo.length)return void(gp="");if(wk(oo[jo])||"."===oo[jo]){for(;wk(oo[jo]);)jo++;if("."===oo[jo]){for(jo++;wk(oo[jo]);)jo++;if("e"===oo[jo]&&("+"===oo[jo+1]||"-"===oo[jo+1]||wk(oo[jo+1])))for(jo+=2;wk(oo[jo]);)jo++;gp=Oe}else gp=Se;return void rp(ip,jo)}if(sk(oo[jo])){for(;rk(oo[jo]);)jo++;return gp="("===oo[jo]?Qe:We,void rp(ip,jo)}if('"'===oo[jo]){for(jo++;'"'!==oo[jo];)jo!==oo.length&&"\n"!==oo[jo]&&"\r"!==oo[jo]||ao("runaway string"),jo++;return jo++,gp=Ve,void rp(ip+1,jo-1)}if("#"===oo[jo]||"-"===oo[jo]&&"-"===oo[jo+1]){for(;oo[jo]&&"\n"!==oo[jo]&&"\r"!==oo[jo];)jo++;return oo[jo]&&jo++,void(gp=Ue)}return"="===oo[jo]&&"="===oo[jo+1]?(jo+=2,void(gp=Pe)):"<"===oo[jo]&&"="===oo[jo+1]?(jo+=2,void(gp=Te)):">"===oo[jo]&&"="===oo[jo+1]?(jo+=2,void(gp=Re)):gp=oo[jo++]},rp=function(a,b){return hp=oo.substring(a,b)},c.scan=_n,mc=function(){return qn(ig(wm)),wa(),xo()},xo=function(){return Zn(),bq(),Sn()},bq=function(){return wm=Nm(),xk(wm)?wm.d>0?void un(1):0===wm.d?void un(1):void un(-1):_k(wm)?-1===td(Gl(wm.q.a,wm.q.b))?void un(-1):vd(Gl(wm.q.a,wm.q.b))?void un(0):void un(1):tk(wm)?(un(-1),qn(wm),of(),Rm(),qn(wm),void Rl()):Nk(wm)?(wn(ae),qn(wm),$l(),pl(2),un(-1),void Rl()):(wn(ae),qn(wm),pl(2))},nc=function(){return qn(ig(wm)),wa(),yo()},yo=function(){var a,b,c,d,e,f,g,h;for(e=0,f=0,0,c=[],d=[],e=a=0,g=md;0<=g?a<g:a>g;e=0<=g?++a:--a)c[e]=0,d[e]=0;if(Zn(),wm=Nm(),!el(wm))return fl(wm)||To("transpose: tensor expected, 1st arg is not a tensor"),qn(fq),void Sn();for(f=wm.tensor.ndim,xm=xf(f),xm.tensor.ndim=1,xm.tensor.dim[0]=f,e=b=0,h=f;0<=h?b<h:b>h;e=0<=h?++b:--b)un(wm.tensor.dim[e]),xm.tensor.elem[e]=Nm();return qn(xm),Sn()},function(){return qn(ig(wm)),wa(),Bo()},Bo=function(){var a;if(a=0,Zn(),wm=Nm(),jg(wm)===Zo(e)){for(a=kp,wm=tg(wm);wm!==Zo(xd);)qn(jg(wm)),Co(),wm=tg(wm);tf(kp-a)}else qn(wm),Co();return Sn()},Co=function(){var a;if(a=0,Zn(),wm=Nm(),jg(wm)!==Zo(ud))return qn(wm),void Sn();for(a=kp,wm=tg(wm);wm!==Zo(xd);)qn(jg(wm)),wm=tg(wm);for(;cq(a);)1;return Tl(kp-a),Sn()},cq=function(a){var b,c,d,e,f,g,h,i;for(d=0,e=0,d=b=f=a,g=kp;f<=g?b<g:b>g;d=f<=g?++b:--b)for(wm=Oo[d],e=c=h=a,i=kp;h<=i?c<i:c>i;e=h<=i?++c:--c)if(d!==e){if(xm=Oo[e],jg(wm)===Zo(Lc)&&jg(xm)===Zo(Pd)&&Ik(hg(xm))&&Fi(ig(wm),ig(xm)))return qn(ig(wm)),qn(sm),Xo(),kj(),Oo[d]=Nm(),Oo[e]=sm,1;if(jg(xm)===Zo(Pd)&&Ik(hg(xm))&&Zf(xm)===Zo(Lc)&&Fi(wm,ag(xm)))return qn(wm),un(-1),sf(),kj(),Mn(),Oo[d]=Nm(),Oo[e]=sm,1;if(jg(xm)===Zo(Lc)&&(qn(wm),qn(ig(xm)),Xo(),ym=Nm(),Tk(ym)))return qn(wm),kj(),Oo[d]=Nm(),Oo[e]=sm,1;if(jg(wm)===Zo(Pd)&&Ik(hg(wm))&&jg(xm)===Zo(Pd)&&Ik(hg(xm))&&Zf(xm)===Zo(Lc)&&(qn(ig(wm)),qn(ig(ig(xm))),Xo(),ym=Nm(),Tk(ym)))return qn(ig(wm)),kj(),Mn(),Oo[d]=Nm(),Oo[e]=sm,1;if(jg(wm)===Zo(Lc)&&jg(xm)===Zo(Pd)&&Ik(hg(xm))&&Zf(xm)===Zo(Lc)){if(qn(ig(wm)),qn(ig(ig(xm))),Xo(),ym=Nm(),Tk(ym))return Oo[d]=ig(wm),Oo[e]=sm,1;if(Ik(ym))return qn(ig(ig(xm))),Mn(),Oo[d]=Nm(),Oo[e]=sm,1;if(Gi(ym,2))return Oo[d]=ig(wm),qn(ig(wm)),un(-1),sf(),Oo[e]=Nm(),1;if(Gi(ym,-2))return qn(ig(ig(xm))),Mn(),Oo[d]=Nm(),qn(ig(ig(xm))),un(-1),sf(),Mn(),Oo[e]=Nm(),1}}return 0},oc=function(){return qn(ig(wm)),wa(),Do()},Do=function(){return Zn(),Eo(),Sn()},Eo=function(){return wm=Nm(),el(wm)?void Go():(Rc(wm,Zo(Lc))&&(qn(wm),Bo(),xm=Nm(),qn(wm),Jn(),Bo(),ym=Nm(),wm=bh(xm)<bh(ym)?xm:ym),Yi(),Zi(),$i(),_i(),aj(),bj(),qn(wm))},Go=function(){var a,b,c,d,e;for(c=0,xm=xf(wm.tensor.nelem),xm.tensor.ndim=wm.tensor.ndim,c=a=0,d=wm.tensor.ndim;0<=d?a<d:a>d;c=0<=d?++a:--a)xm.tensor.dim[c]=wm.tensor.dim[c];for(c=b=0,e=wm.tensor.nelem;0<=e?b<e:b>e;c=0<=e?++b:--b)qn(wm.tensor.elem[c]),Do(),xm.tensor.elem[c]=Nm();return xm.tensor.nelem!==xm.tensor.elem.length&&console.log("something wrong in tensor dimensions"),fl(xm)&&(xm=fq),qn(xm)},bh=function(a){var b;if(uk(a))for(b=0;uk(a);)b+=bh(jg(a))+1,a=tg(a);else b=1;return b},Yi=function(){if(jg(wm)===Zo(e))return qn(wm),Jn(),xm=Nm(),bh(xm)<bh(wm)?wm=xm:void 0},Zi=function(){if(jg(wm)===Zo(e))return qn(wm),Q(),xm=Nm(),bh(xm)<=bh(wm)?wm=xm:void 0},$i=function(){if(qn(wm),Jn(),$l(),Jn(),$l(),Jn(),xm=Nm(),bh(xm)<bh(wm))return wm=xm},_i=function(){if(!fl(wm))return qn(wm),Jn(),kk(),Jn(),kk(),Jn(),xm=Nm(),bh(xm)<bh(wm)?wm=xm:void 0},Ho=function(){return Zn(),wm=Nm(),aj(),qn(wm),Sn()},aj=function(){if(0!==Rc(wm,Zo(de))||0!==Rc(wm,Zo(O)))return xm=wm,np=1,qn(xm),wa(),ym=Nm(),np=2,qn(xm),wa(),zm=Nm(),np=0,(bh(zm)<bh(ym)||om(zm)<om(ym))&&(ym=zm),bh(ym)<bh(wm)||om(ym)<om(wm)?wm=ym:void 0},bj=function(){if(jg(wm)===Zo(e)){for(un(0),xm=tg(wm);uk(xm);)qn(jg(xm)),Do(),sf(),xm=tg(xm);return xm=Nm(),bh(xm)<bh(wm)?wm=xm:void 0}},om=function(a){return jg(a)!==Zo(e)?1:ml(a)-1},pc=function(){return qn(ig(wm)),wa(),Jo()},Jo=function(){return Zn(),wm=Nm(),jg(wm)===Zo(e)?Lo():Ko(),Sn()},Lo=function(){for(xm=tg(wm);uk(xm);){if(zm=jg(xm),Pk(zm))return qn(wm),qn(zm),Xo(),ym=Nm(),qn(ym),Jo(),qn(zm),$g(),Rl(),qn(ym),$g(),qn(zm),Jo(),Rl(),void sf();xm=tg(xm)}return Ko()},Ko=function(){var a,b;if(jg(wm)===Zo(j))return void qn(ig(wm));if(xk(wm))return a=Math.sin(wm.d),Math.abs(a)<1e-10&&(a=0),void rn(a);if(Lk(wm))return qn(wm),$l(),Jo(),void $l();if(jg(wm)===Zo(l))return qn(ig(wm)),un(1),qn(ig(wm)),un(2),Rm(),sf(),vn(-1,2),Rm(),void Rl();if(qn(wm),un(180),Rl(),wn(Nd),Ph(),(b=Qm())<0||2147483648===b)return qn(Zo(de)),qn(wm),void pl(2);switch(b%360){case 0:case 180:return un(0);case 30:case 150:return vn(1,2);case 210:case 330:return vn(-1,2);case 45:case 135:return vn(1,2),un(2),vn(1,2),Rm(),Rl();case 225:case 315:return vn(-1,2),un(2),vn(1,2),Rm(),Rl();case 60:case 120:return vn(1,2),un(3),vn(1,2),Rm(),Rl();case 240:case 300:return vn(-1,2),un(3),vn(1,2),Rm(),Rl();case 90:return un(1);case 270:return un(-1);default:return qn(Zo(de)),qn(wm),pl(2)}},qc=function(){return qn(ig(wm)),wa(),Cp()},Cp=function(){return Zn(),dq(),Sn()},dq=function(){var a;return a=0,wm=Nm(),jg(wm)===Zo(k)?void qn(ig(wm)):xk(wm)?(a=Math.sinh(wm.d),Math.abs(a)<1e-10&&(a=0),void rn(a)):fl(wm)?void qn(fq):(wn(ee),qn(wm),pl(2))},Wo=function(){var a,b,c,d,e;if(c=0,Zn(),ym=Nm(),(xm=Nm())===Zo(xd)||ym===Zo(xd))return void Sn();if(wm=Nm(),el(wm)){for(zm=xf(wm.tensor.nelem),zm.tensor.ndim=wm.tensor.ndim,c=a=0,d=wm.tensor.ndim;0<=d?a<d:a>d;c=0<=d?++a:--a)zm.tensor.dim[c]=wm.tensor.dim[c];for(c=b=0,e=wm.tensor.nelem;0<=e?b<e:b>e;c=0<=e?++b:--b)qn(wm.tensor.elem[c]),qn(xm),qn(ym),Wo(),zm.tensor.elem[c]=Nm(),zm.tensor.nelem!==zm.tensor.elem.length&&console.log("something wrong in tensor dimensions");qn(zm)}else Fi(wm,xm)?qn(ym):uk(wm)?(qn(jg(wm)),qn(xm),qn(ym),Wo(),qn(tg(wm)),qn(xm),qn(ym),Wo(),Vg()):qn(wm);return Sn()},vc=function(){return qn(ig(wm)),wa(),ap()},ap=function(){return Zn(),eq(),Sn()},eq=function(){var a,b;if(b=0,a=0,wm=Nm(),jg(wm)===Zo(l))return void qn(ig(wm));if(xk(wm))return a=Math.tan(wm.d),Math.abs(a)<1e-10&&(a=0),void rn(a);if(Lk(wm))return qn(wm),$l(),ap(),void $l();if(qn(wm),un(180),Rl(),wn(Nd),Ph(),(b=Qm())<0||2147483648===b)return qn(Zo(Ae)),qn(wm),void pl(2);switch(b%360){case 0:case 180:return un(0);case 30:case 210:return vn(1,3),un(3),vn(1,2),Rm(),Rl();case 150:case 330:return vn(-1,3),un(3),vn(1,2),Rm(),Rl();case 45:case 225:return un(1);case 135:case 315:return un(-1);case 60:case 240:return un(3),vn(1,2),Rm();case 120:case 300:return un(3),vn(1,2),Rm(),$l();default:return qn(Zo(Ae)),qn(wm),pl(2)}},wc=function(){var a;return a=0,qn(ig(wm)),wa(),wm=Nm(),jg(wm)===Zo(m)?void qn(ig(wm)):xk(wm)?(a=Math.tanh(wm.d),Math.abs(a)<1e-10&&(a=0),void rn(a)):fl(wm)?void qn(fq):(wn(Be),qn(wm),pl(2))},xc=function(){return wm=tg(wm),qn(jg(wm)),wa(),wm=tg(wm),qn(jg(wm)),wa(),xm=Nm(),xm===Zo(xd)?Uj():qn(xm),wm=tg(wm),qn(jg(wm)),wa(),xm=Nm(),xm===Zo(xd)?un(24):qn(xm),wm=tg(wm),qn(jg(wm)),wa(),xm=Nm(),xm===Zo(xd)?un(0):qn(xm),bp()},bp=function(){var a,b,c,d;if(b=0,c=0,Zn(),zm=Nm(),ym=Nm(),xm=Nm(),wm=Nm(),qn(ym),2147483648===(c=Qm()))return wn(Ce),qn(wm),qn(xm),qn(ym),qn(zm),pl(5),void Sn();for(qn(wm),qn(xm),qn(zm),Wo(),wa(),un(1),Am=Nm(),b=a=1,d=c;(1<=d?a<=d:a>=d)&&(qn(wm),qn(xm),Hh(),wm=Nm(),!fl(wm));b=1<=d?++a:--a)qn(Am),qn(xm),qn(zm),Xo(),Rl(),Am=Nm(),qn(wm),qn(xm),qn(zm),Wo(),wa(),qn(Am),Rl(),un(b),kj(),Ph(),sf();return Sn()},yc=function(){var a,b,c,d,e,f,g,h,i;for(e=0,f=0,g=0,wm.tensor.nelem!==wm.tensor.elem.length&&console.log("something wrong in tensor dimensions"),g=wm.tensor.nelem,f=wm.tensor.ndim,xm=xf(g),xm.tensor.ndim=f,e=b=0,h=f;0<=h?b<h:b>h;e=0<=h?++b:--b)xm.tensor.dim[e]=wm.tensor.dim[e];for(a=wm.tensor.elem,d=xm.tensor.elem,xm.tensor.nelem!==xm.tensor.elem.length&&console.log("something wrong in tensor dimensions"),e=c=0,i=g;0<=i?c<i:c>i;e=0<=i?++c:--c)qn(a[e]),wa(),d[e]=Nm();return wm.tensor.nelem!==wm.tensor.elem.length&&console.log("something wrong in tensor dimensions"),xm.tensor.nelem!==xm.tensor.elem.length&&console.log("something wrong in tensor dimensions"),qn(xm),pn()},dp=function(){var a,b,c,d,e,f,g,h,i,j,k,l;if(g=0,h=0,i=0,Zn(),xm=Nm(),wm=Nm(),(h=wm.tensor.ndim)!==xm.tensor.ndim)return qn(Zo(xd)),void Sn();for(g=b=0,j=h;0<=j?b<j:b>j;g=0<=j?++b:--b)if(wm.tensor.dim[g]!==xm.tensor.dim[g])return qn(Zo(xd)),void Sn();for(i=wm.tensor.nelem,ym=xf(i),ym.tensor.ndim=h,g=c=0,k=h;0<=k?c<k:c>k;g=0<=k?++c:--c)ym.tensor.dim[g]=wm.tensor.dim[g];for(a=wm.tensor.elem,e=xm.tensor.elem,f=ym.tensor.elem,g=d=0,l=i;0<=l?d<l:d>l;g=0<=l?++d:--d)qn(a[g]),qn(e[g]),sf(),f[g]=Nm();return qn(ym),Sn()},ep=function(){var a,b,c,d,e,f,g,h,i;for(e=0,f=0,g=0,Zn(),xm=Nm(),wm=Nm(),f=wm.tensor.ndim,g=wm.tensor.nelem,ym=xf(g),ym.tensor.ndim=f,e=b=0,h=f;0<=h?b<h:b>h;e=0<=h?++b:--b)ym.tensor.dim[e]=wm.tensor.dim[e];for(a=wm.tensor.elem,d=ym.tensor.elem,e=c=0,i=g;0<=i?c<i:c>i;e=0<=i?++c:--c)qn(a[e]),qn(xm),Rl(),d[e]=Nm();return qn(ym),Sn()},$n=function(){var a,b,c,d,e,f,g,h,i;for(e=0,f=0,g=0,Zn(),xm=Nm(),wm=Nm(),f=xm.tensor.ndim,g=xm.tensor.nelem,ym=xf(g),ym.tensor.ndim=f,e=b=0,h=f;0<=h?b<h:b>h;e=0<=h?++b:--b)ym.tensor.dim[e]=xm.tensor.dim[e];for(a=xm.tensor.elem,d=ym.tensor.elem,e=c=0,i=g;0<=i?c<i:c>i;e=0<=i?++c:--c)qn(wm),qn(a[e]),Rl(),d[e]=Nm();return qn(ym),Sn()},function(a){return el(a)&&2===a.tensor.ndim&&a.tensor.dim[0]===a.tensor.dim[1]?1:0},ih=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m;if(g=0,h=0,i=0,j=0,i=wm.tensor.ndim,j=wm.tensor.nelem,i+1>=md)return wn(W),qn(wm),qn(xm),void pl(3);for(ym=xf(j*xm.tensor.nelem),ym.tensor.ndim=i+1,g=b=0,k=i;0<=k?b<k:b>k;g=0<=k?++b:--b)ym.tensor.dim[g]=wm.tensor.dim[g];for(ym.tensor.dim[i]=xm.tensor.dim[0],a=wm.tensor.elem,e=xm.tensor.elem,f=ym.tensor.elem,g=c=0,l=j;0<=l?c<l:c>l;g=0<=l?++c:--c)for(h=d=0,m=xm.tensor.nelem;0<=m?d<m:d>m;h=0<=m?++d:--d)qn(a[g]),qn(e[h]),Hh(),f[g*xm.tensor.nelem+h]=Nm();return qn(ym)},gh=function(){var a,b,c,d,e;for(ym=xf(xm.tensor.nelem),ym.tensor.ndim=1,ym.tensor.dim[0]=xm.tensor.dim[0],a=xm.tensor.elem,c=ym.tensor.elem,d=b=0,e=xm.tensor.nelem;0<=e?b<e:b>e;d=0<=e?++b:--b)qn(wm),qn(a[d]),Hh(),c[d]=Nm();return qn(ym)},hh=function(){var a,b,c,d,e,f,g;for(e=0,ym=xf(wm.tensor.nelem),ym.tensor.ndim=wm.tensor.ndim,e=b=0,f=wm.tensor.ndim;0<=f?b<f:b>f;e=0<=f?++b:--b)ym.tensor.dim[e]=wm.tensor.dim[e];for(a=wm.tensor.elem,d=ym.tensor.elem,e=c=0,g=wm.tensor.nelem;0<=g?c<g:c>g;e=0<=g?++c:--c)qn(a[e]),qn(xm),Hh(),d[e]=Nm();return qn(ym)},Rg=function(a,b){var c,d,e,f,g;if(e=0,a.tensor.ndim<b.tensor.ndim)return-1;if(a.tensor.ndim>b.tensor.ndim)return 1;for(e=c=0,f=a.tensor.ndim;0<=f?c<f:c>f;e=0<=f?++c:--c){if(a.tensor.dim[e]<b.tensor.dim[e])return-1;if(a.tensor.dim[e]>b.tensor.dim[e])return 1}for(e=d=0,g=a.tensor.nelem;0<=g?d<g:d>g;e=0<=g?++d:--d)if(!Fi(a.tensor.elem[e],b.tensor.elem[e]))return nl(a.tensor.elem[e],b.tensor.elem[e])?-1:1;return 0},Um=function(){var a,b,c,d,e,f,g,h;if(c=0,d=0,e=0,d=wm.tensor.ndim-1,wm.tensor.dim[0]!==wm.tensor.dim[d])return wn(Pd),qn(wm),qn(xm),void pl(3);if(qn(xm),2147483648===(e=Qm()))return wn(Pd),qn(wm),qn(xm),void pl(3);if(0===e){for(2!==wm.tensor.ndim&&To("power(tensor,0) with tensor rank not equal to 2"),e=wm.tensor.dim[0],wm=xf(e*e),wm.tensor.ndim=2,wm.tensor.dim[0]=e,wm.tensor.dim[1]=e,c=a=0,f=e;0<=f?a<f:a>f;c=0<=f?++a:--a)wm.tensor.elem[e*c+c]=sm;return wm.tensor.nelem!==wm.tensor.elem.length&&console.log("something wrong in tensor dimensions"),void qn(wm)}for(e<0&&(e=-e,qn(wm),jk(),wm=Nm()),qn(wm),h=[],c=b=1,g=e;(1<=g?b<g:b>g)&&(qn(wm),ck(),!fl(Oo[kp-1]));c=1<=g?++b:--b)h.push(void 0);return h},Zg=function(){var a,b,c,d,e;for(c=0,Zn(),wm=Nm(),xm=xf(wm.tensor.nelem),xm.tensor.ndim=wm.tensor.ndim,c=a=0,d=wm.tensor.ndim;0<=d?a<d:a>d;c=0<=d?++a:--a)xm.tensor.dim[c]=wm.tensor.dim[c];for(c=b=0,e=wm.tensor.nelem;0<=e?b<e:b>e;c=0<=e?++b:--b)xm.tensor.elem[c]=wm.tensor.elem[c];return wm.tensor.nelem!==wm.tensor.elem.length&&console.log("something wrong in tensor dimensions"),xm.tensor.nelem!==xm.tensor.elem.length&&console.log("something wrong in tensor dimensions"),qn(xm),Sn()},pn=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o;if(f=0,g=0,h=0,j=0,i=0,Zn(),wm=Nm(),!el(wm))return qn(wm),void Sn();for(xm=wm.tensor.elem[0],f=a=1,k=wm.tensor.nelem;1<=k?a<k:a>k;f=1<=k?++a:--a)Sg(xm,wm.tensor.elem[f])||To("Cannot promote tensor due to inconsistent tensor components.");if(!el(xm))return qn(wm),void Sn();for(i=wm.tensor.ndim+xm.tensor.ndim,i>md&&To("tensor rank > 24"),j=wm.tensor.nelem*xm.tensor.nelem,ym=xf(j),ym.tensor.ndim=i,f=b=0,l=wm.tensor.ndim;0<=l?b<l:b>l;f=0<=l?++b:--b)ym.tensor.dim[f]=wm.tensor.dim[f];for(g=c=0,m=xm.tensor.ndim;0<=m?c<m:c>m;g=0<=m?++c:--c)ym.tensor.dim[f+g]=xm.tensor.dim[g];for(h=0,f=d=0,n=wm.tensor.nelem;0<=n?d<n:d>n;f=0<=n?++d:--d)for(xm=wm.tensor.elem[f],g=e=0,o=xm.tensor.nelem;0<=o?e<o:e>o;g=0<=o?++e:--e)ym.tensor.elem[h++]=xm.tensor.elem[g];return xm.tensor.nelem!==xm.tensor.elem.length&&console.log("something wrong in tensor dimensions"),ym.tensor.nelem!==ym.tensor.elem.length&&console.log("something wrong in tensor dimensions"),qn(ym),Sn()},Sg=function(a,b){var c,d,e;if(!el(a)&&!el(b))return 1;if(!el(a)||!el(b))return 0;if(a.tensor.ndim!==b.tensor.ndim)return 0;for(d=c=0,e=a.tensor.ndim;0<=e?c<e:c>e;d=0<=e?++c:--c)if(a.tensor.dim[d]!==b.tensor.dim[d])return 0;return 1},zc=function(){for(wm=tg(wm);uk(wm);){if(tg(wm)===Zo(xd))return qn(jg(wm)),void wa();if(qn(jg(wm)),bc(),xm=Nm(),!fl(xm))return qn(ig(wm)),void wa();wm=sg(wm)}return un(0)},Ac=function(){return qn(ig(wm)),wa(),qn(hg(wm)),wa(),Xo(),wm=Nm(),un(fl(wm)?1:0)},Bc=function(){return un(Gg()>=0?1:0)},Cc=function(){return un(Gg()>0?1:0)},Dc=function(){return un(Gg()<=0?1:0)},Ec=function(){return un(Gg()<0?1:0)},Ub=function(){return qn(ig(wm)),bc(),wm=Nm(),un(fl(wm)?1:0)},Ba=function(){for(wm=tg(wm);uk(wm);){if(qn(jg(wm)),bc(),xm=Nm(),fl(xm))return void un(0);wm=tg(wm)}return un(1)},Zb=function(){for(wm=tg(wm);uk(wm);){if(qn(jg(wm)),bc(),xm=Nm(),!fl(xm))return void un(1);wm=tg(wm)}return un(0)},Gg=function(){var a;if(a=0,qn(ig(wm)),wa(),qn(hg(wm)),wa(),Xo(),wm=Nm(),wm.k!==Hd&&wm.k!==da&&(qn(wm),Rp(),wa(),wm=Nm()),fl(wm))return 0;switch(wm.k){case Hd:a=-1===td(wm.q.a)?-1:1;break;case da:a=wm.d<0?-1:1;break;default:To("relational operator: cannot determine due to non-numerical comparison"),a=0}return a},lp=function(a){var b,c,d,e;for(d=0,Zn(),zm=Nm(),ym=Nm(),qn(Mj(Zo(pd))),qn(Mj(Zo(qd))),qn(Mj(Zo(rd))),ro(Zo(rd),zm),d=kp,un(1),qn(ym),qn(zm),Mm(),qn(zm),xh(),b=0,e=a.length;b<e&&(c=a[b],R&&console.log("scanning table entry "+c),!c||(fo(c),wm=Nm(),Am=ig(wm),Bm=hg(wm),Cm=rg(wm),!cj(d)));b++);return kp=d,c?(qn(Bm),wa(),wm=Nm()):wm=Zo(xd),ro(Zo(rd),Nm()),ro(Zo(qd),Nm()),ro(Zo(pd),Nm()),qn(wm),Sn()},cj=function(a){var b,c,d,e,f,g,h,i;for(d=0,e=0,d=b=f=a,g=kp;f<=g?b<g:b>g;d=f<=g?++b:--b)for(ro(Zo(pd),Oo[d]),e=c=h=a,i=kp;h<=i?c<i:c>i;e=h<=i?++c:--c){for(ro(Zo(qd),Oo[e]),wm=Cm;uk(wm)&&(qn(jg(wm)),wa(),xm=Nm(),!fl(xm));)wm=tg(wm);if(!uk(wm)&&(qn(ym),qn(Am),wa(),Xo(),wm=Nm(),fl(wm)))return 1}return 0},Fc=function(){return qn(ig(wm)),wa(),sg(wm)===Zo(xd)?(un(1),un(2)):(qn(hg(wm)),wa(),qn(gg(wm)),wa()),mp()},mp=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x;for(k=0,l=0,m=0,n=0,o=0,p=0,q=0,x=0,h=[],i=[],k=b=0,r=md;0<=r?b<r:b>r;k=0<=r?++b:--b)h[k]=0,i[k]=0;if(Zn(),ym=Nm(),xm=Nm(),wm=Nm(),!el(wm))return fl(wm)||To("transpose: tensor expected, 1st arg is not a tensor"),qn(fq),void Sn();if(p=wm.tensor.ndim,q=wm.tensor.nelem,1===p)return qn(wm),void Sn();for(qn(xm),n=Qm(),qn(ym),o=Qm(),(n<1||n>p||o<1||o>p)&&To("transpose: index out of range"),n--,o--,xm=xf(q),xm.tensor.ndim=p,k=c=0,s=p;0<=s?c<s:c>s;k=0<=s?++c:--c)xm.tensor.dim[k]=wm.tensor.dim[k];for(xm.tensor.dim[n]=wm.tensor.dim[o],xm.tensor.dim[o]=wm.tensor.dim[n],a=wm.tensor.elem,j=xm.tensor.elem,k=d=0,t=p;0<=t?d<t:d>t;k=0<=t?++d:--d)h[k]=0,i[k]=wm.tensor.dim[k];for(k=e=0,u=q;0<=u?e<u:e>u;k=0<=u?++e:--e){for(x=h[n],h[n]=h[o],h[o]=x,x=i[n],i[n]=i[o],i[o]=x,m=0,l=f=0,v=p;0<=v?f<v:f>v;l=0<=v?++f:--f)m=m*i[l]+h[l];for(x=h[n],h[n]=h[o],h[o]=x,x=i[n],i[n]=i[o],i[o]=x,j[m]=a[k],l=g=w=p-1;(w<=0?g<=0:g>=0)&&!(++h[l]<i[l]);l=w<=0?++g:--g)h[l]=0}return qn(xm),Sn()},Hc=function(){var a;if(jg(wm)===Zo(qe)&&Lj(Zo(qe))===Zo(xd))return void db();if(ym=Mj(jg(wm)),zm=Lj(jg(wm)),Am=tg(wm),ym===jg(wm)){for(a=kp,qn(ym),wm=Am;uk(wm);)qn(jg(wm)),wa(),wm=tg(wm);return void pl(kp-a)}for(wm=zm,xm=Am,a=kp;uk(wm)&&uk(xm);)qn(jg(wm)),qn(jg(xm)),wa(),wm=tg(wm),xm=tg(xm);return pl(kp-a),Bm=Nm(),qn(ym),uk(Bm)&&(qn(Bm),Tn()),wa()},Tn=function(){var a,b;if(b=0,Zn(),xm=Nm(),wm=Nm(),el(wm))return b=Un(),Sn(),b;if(uk(wm)){for(a=kp,qn(jg(wm)),wm=tg(wm);uk(wm);)qn(jg(wm)),qn(xm),b+=Tn(),wm=tg(wm);return pl(kp-a),Sn(),b}if(!cl(wm))return qn(wm),Sn(),0;for(ym=xm;uk(ym);){if(wm===jg(ym))return qn(ig(ym)),Sn(),1;ym=sg(ym)}return ym=Mj(wm),qn(ym),wm!==ym&&(qn(xm),0===(b=Tn())&&(Nm(),qn(wm))),Sn(),b},Un=function(){var a,b,c,d;for(c=0,b=0,qn(wm),Zg(),wm=Nm(),b=a=0,d=wm.tensor.nelem;0<=d?a<d:a>d;b=0<=d?++a:--a)qn(wm.tensor.elem[b]),qn(xm),c+=Tn(),wm.tensor.elem[b]=Nm();return wm.tensor.nelem!==wm.tensor.elem.length&&console.log("something wrong in tensor dimensions"),qn(wm),c},Ic=function(){var a,b,c,d,e,f,g,h;for(c=0,d=[],e=0,f=0,c=a=0,g=md;0<=g?a<g:a>g;c=0<=g?++a:--a)d[c]=0;for(e=1,f=0,xm=tg(wm);uk(xm);){if(qn(jg(xm)),wa(),(c=Qm())<2)return void qn(fq);e*=c,d[f++]=c,xm=tg(xm)}if(0===f)return void qn(fq);for(wm=xf(e),wm.tensor.ndim=f,c=b=0,h=f;0<=h?b<h:b>h;c=0<=h?++b:--b)wm.tensor.dim[c]=d[c];return qn(wm)},yf=0,xf=function(a){var b,c,d,e;for(c=0,d=new Xe,d.k=De,d.tensor=new cp,d.tensor.nelem=a,c=b=0,e=a;0<=e?b<e:b>e;c=0<=e?++b:--b)d.tensor.elem[c]=fq;return d.tensor.allocatedId=yf,yf++,d.tensor.nelem!==d.tensor.elem.length&&console.log("something wrong in tensor dimensions"),d},Ze=1e4,Sj=function(){function a(){}return a.prototype.c=0,a.prototype.x=0,a.prototype.y=0,a}(),wg=[],vg=qf=0,Pn=Ze;0<=Pn?qf<Pn:qf>Pn;vg=0<=Pn?++qf:--qf)wg[vg]=new Sj;for(Bp=0,ol=0,Ei=0,Wi=0,0,nn=function(a,b){return null==b&&(!0,b=""),b+=a},mn=function(a,b){return nn(a,b)},Oh=function(a){var b,c;return 0,c=0,0,Zn(),Bp=0,ol=0,Ei=0,Ci(a),b=Qj(0,Bp),b[0],c=b[1],b[2],c>100?(on(a),void Sn()):(cn(),Sn())},Ci=function(a){return jg(a)===Zo(_d)?(ki(ig(a)),cf(" = "),void ki(hg(a))):el(a)?zi(a):ki(a)},up=function(a){if(ol>0)return 0;if(Ck(a))return 1;if(jg(a)!==Zo(ud))return 0;if(Ck(ig(a)))return 1;for(;uk(a);){if(vk(jg(a)))return 1;a=tg(a)}return 0},ki=function(a){if(Wi++,jg(a)===Zo(e))for(a=tg(a),ff(jg(a))&&(bf("-"),up(jg(a))&&bf(" ")),Bi(jg(a)),a=tg(a);uk(a);)ff(jg(a))?(bf(" "),bf("-"),bf(" ")):(bf(" "),bf("+"),bf(" ")),Bi(jg(a)),a=tg(a);else ff(a)&&(bf("-"),up(a)&&bf(" ")),Bi(a);return Wi--},Di=function(a){var b;if(jg(a)===Zo(e)){for(a=tg(a),Bi(jg(a)),a=tg(a),b=[];uk(a);)ff(jg(a))?(bf(" "),bf("-"),bf(" ")):(bf(" "),bf("+"),bf(" ")),Bi(jg(a)),b.push(a=tg(a));return b}return Bi(a)},ff=function(a){return Mk(a)?1:jg(a)===Zo(ud)&&Mk(ig(a))?1:0},Bi=function(a){var b;return jg(a)===Zo(ud)?(b=ch(a),b&&0===ol?oi(a,b):ri(a,b)):li(a)},vk=function(a){return jg(a)===Zo(Pd)&&ig(a)!==Zo(ha)&&ff(hg(a))?1:0},ch=function(a){var b;for(bh=0,a=tg(a);uk(a);)b=jg(a),vk(b)&&bh++,a=tg(a);return bh},ri=function(a,b){var c;if(0===b){for(a=tg(a),(Tk(jg(a))||Ik(jg(a)))&&(a=tg(a)),li(jg(a)),a=tg(a),c=[];uk(a);)bf(" "),li(jg(a)),c.push(a=tg(a));return c}return ti(a),bf("/"),b>1||Ck(ig(a))?(bf("("),ji(a),bf(")")):ji(a)},oi=function(a,b){var c,d,e,f;for(bh=0,c=0,d=0,e=0,f=0,Zn(),ym=sm,zm=sm,_k(ig(a))&&(qn(ig(a)),Ll(),of(),ym=Nm(),qn(ig(a)),Kl(),zm=Nm()),xk(ig(a))&&(qn(ig(a)),of(),ym=Nm()),e=Tk(ym)?0:1,wm=tg(a),Qk(jg(wm))&&(wm=tg(wm));uk(wm);)xm=jg(wm),vk(xm)?1:e++,wm=tg(wm);for(f=Ei,c=Bp,bh=0,Tk(ym)||(si(ym,0),bh++),wm=tg(a),Qk(jg(wm))&&(wm=tg(wm));uk(wm);)xm=jg(wm),vk(xm)?1:(bh>0&&bf(" "),1===e?ki(xm):li(xm),bh++),wm=tg(wm);for(0===bh&&bf("1"),d=Bp,bh=0,Tk(zm)||(si(zm,0),bh++,b++),wm=tg(a),_k(jg(wm))&&(wm=tg(wm));uk(wm);)xm=jg(wm),vk(xm)&&(bh>0&&bf(" "),ii(xm,b),bh++),wm=tg(wm);return vj(f,c,d),Sn()},ti=function(a){var b;for(int(b),Zn(),wm=sm,a=tg(a),_k(jg(a))?(qn(jg(a)),Ll(),of(),wm=Nm(),a=tg(a)):xk(jg(a))&&(qn(jg(a)),of(),wm=Nm(),a=tg(a)),b=0,Tk(wm)||(si(wm,0),b++);uk(a);)vk(jg(a))?1:(b>0&&bf(" "),li(jg(a)),b++),a=tg(a);return 0===b&&bf("1"),Sn()},ji=function(a){var b;for(int(b),Zn(),b=0,a=tg(a),Ck(jg(a))&&(qn(jg(a)),Kl(),wm=Nm(),si(wm,0),b++,a=tg(a));uk(a);)vk(jg(a))&&(b>0&&bf(" "),ii(jg(a),0),b++),a=tg(a);return Sn()},li=function(a){return el(a)?void ni(a):xk(a)?void si(a,0):jg(a)===Zo(e)||jg(a)===Zo(ud)?void xi(a):jg(a)===Zo(Pd)?void vi(a):uk(a)?void pi(a):Qk(a)?void(0===ol?ui(a):si(a,0)):cl(a)?void yi(a):void(bl(a)&&wi(a))},ui=function(a){var b,c,d;return b=0,c=0,d=0,Zn(),qn(a),Ll(),of(),ym=Nm(),qn(a),Kl(),zm=Nm(),Tk(zm)?(si(ym,0),void Sn()):(d=Ei,b=Bp,si(ym,0),c=Bp,si(zm,0),vj(d,b,c),Sn())},zk=function(a){return uk(a)&&jg(a)!==Zo(e)&&jg(a)!==Zo(ud)&&jg(a)!==Zo(Pd)?1:cl(a)?1:Ck(a)?0:Mk(a)?0:Qk(a)?1:0},vi=function(a){var b,c,d;return b=0,c=0,d=0,ig(a)===Zo(ha)?(cf("exp("),ki(hg(a)),void bf(")")):ol>0?void(Ik(hg(a))?(bf("1"),bf("/"),zk(ig(a))?li(ig(a)):xi(ig(a))):(zk(ig(a))?li(ig(a)):xi(ig(a)),bf("^"),zk(hg(a))?li(hg(a)):xi(hg(a)))):ff(hg(a))?(d=Ei,b=Bp,bf("1"),c=Bp,ii(a,1),void vj(d,b,c)):(b=Bp,zk(ig(a))?li(ig(a)):xi(ig(a)),c=Bp,ol++,ki(hg(a)),ol--,wj(b,c))},ii=function(a,b){var c,d;return c=0,d=0,Ik(hg(a))?void(1===b?ki(ig(a)):li(ig(a))):(c=Bp,zk(ig(a))?li(ig(a)):xi(ig(a)),d=Bp,ol++,Di(hg(a)),ol--,wj(c,d))},pi=function(a){if(jg(a)===Zo(Xc)&&cl(ig(a)))return void qi(a);if(jg(a)===Zo(Lc))return void mi(a);if(jg(a)===Zo(W)?bf("d"):yi(jg(a)),bf("("),a=tg(a),uk(a))for(ki(jg(a)),a=tg(a);uk(a);)bf(","),ki(jg(a)),a=tg(a);return bf(")")},qi=function(a){if(a=tg(a),$f(a)===Zo(e)||$f(a)===Zo(ud)||$f(a)===Zo(Pd)||$f(a)===Zo(Lc)?xi(jg(a)):ki(jg(a)),bf("["),a=tg(a),uk(a))for(ki(jg(a)),a=tg(a);uk(a);)bf(","),ki(jg(a)),a=tg(a);return bf("]")},mi=function(a){return a=ig(a),jg(a)===Zo(e)||jg(a)===Zo(ud)||jg(a)===Zo(Pd)||jg(a)===Zo(Lc)?xi(a):ki(a),bf("!")},xi=function(a){return bf("("),ki(a),bf(")")},yi=function(a){var b,c,d,e,f;if(c=0,a===Zo(ha))return void cf("exp(1)");for(d=Pj(a),f=[],c=b=0,e=d.length;0<=e?b<e:b>e;c=0<=e?++b:--b)f.push(bf(d[c]));return f},wi=function(a){var b,c,d,e;for(c=0,d=a.str,bf('"'),c=b=0,e=d.length;0<=e?b<e:b>e;c=0<=e?++b:--b)bf(d[c]);return bf('"')},vj=function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q;for(e=0,f=0,0,l=0,o=0,g=0,m=0,p=0,0,n=0,q=0,h=Qj(b,c),g=h[0],m=h[1],p=h[2],i=Qj(c,Bp),i[0],n=i[1],q=i[2],e=n>m?(n-m)/2:0,e++,o=p+g-1,f=-o-1,Jl(b,c,e,f),e=n>m?-m:(m-n)/2-m,e++,f=1-q,Jl(c,Bp,e,f),l=n>m?n:m,l+=2,Ei=a,k=[],d=0,j=l;0<=j?d<j:d>j;0<=j?++d:--d)k.push(bf("-"));return k},wj=function(a,b){var c,d,e,f,g,h;return c=0,0,0,g=0,d=0,0,h=0,e=Qj(a,b),e[0],e[1],g=e[2],f=Qj(b,Bp),d=f[0],f[1],h=f[2],c=-h-d+1,c+=g-1,Jl(b,Bp,0,c)},Jl=function(a,b,c,d){var e,f,g,h,i;for(f=0,i=[],f=e=g=a,h=b;g<=h?e<h:e>h;f=g<=h?++e:--e)wg[f].x+=c,i.push(wg[f].y+=d);return i},Qj=function(a,b){var c,d,e,f,g,h,i,j,k,l,m;for(e=0,h=wg[a].x,f=wg[a].x,i=wg[a].y,g=wg[a].y,e=c=j=a+1,k=b;j<=k?c<k:c>k;e=j<=k?++c:--c)wg[e].x<h&&(h=wg[e].x),wg[e].x>f&&(f=wg[e].x),wg[e].y<i&&(i=wg[e].y),wg[e].y>g&&(g=wg[e].y);return d=g-i+1,l=f-h+1,m=i,[d,l,m]},function(a){return bf(a)},bf=function(a){if(Bp!==Ze)return wg[Bp],wg[Bp].c=a,wg[Bp].x=Ei,wg[Bp].y=0,Bp++,Ei++},cf=function(a){var b,c,d,e;for(c=0,e=[],c=b=0,d=a.length;0<=d?b<d:b>d;c=0<=d?++b:--b)e.push(bf(a[c]));return e},si=function(a,b){var c,d,e,f,g,h,i,j,k,l;switch(l="",f=0,a.k){case Hd:for(l=a.q.a.toString(),"-"===l[0]&&0===b&&(l=l.substring(1)),f=c=0,g=l.length;0<=g?c<g:c>g;f=0<=g?++c:--c)bf(l[f]);if("1"===(l=a.q.b.toString()))break;for(bf("/"),j=[],f=d=0,h=l.length;0<=h?d<h:d>h;f=0<=h?++d:--d)j.push(bf(l[f]));return j;case da:for(l=Vh(a.d),"-"===l[0]&&0===b&&(l=l.substring(1)),k=[],f=e=0,i=l.length;0<=i?e<i:e>i;f=0<=i?++e:--e)k.push(bf(l[f]));return k}},Fg=function(a,b){return a.y<b.y?-1:a.y>b.y?1:a.x<b.x?-1:a.x>b.x?1:0},cn=function(){var a,b,c,d,e,f,g;for(c=0,a="",e=wg.slice(0,Bp),e.sort(Fg),wg=[].concat(e).concat(wg.slice(Bp)),f=0,g=wg[0].y,c=b=0,d=Bp;0<=d?b<d:b>d;c=0<=d?++b:--b){for(;wg[c].y>g;)a=mn("\n",a),f=0,g++;for(;wg[c].x>f;)a=nn(" ",a),f++;a=nn(wg[c].c,a),f++}if(Sd)return console.log(a)},Wf="",function(){return Bp=0,ol=0,Ei=0,ki(Nm()),oj(),Wf},oj=function(){var a,b,c,d,e,f,g,h;for(f=Wf,d=0,b=0,e=wg.slice(0,Bp),e.sort(Fg),wg=[].concat(e).concat(wg.slice(Bp)),g=0,h=wg[0].y,b=a=0,c=Bp;0<=c?a<c:a>c;b=0<=c?++a:--a){for(;wg[b].y>h;)f[d++]="\n",g=0,h++;for(;wg[b].x>g;)f[d++]=" ",g++;f[d++]=wg[b].c,g++}return f[d++]="\n"},wd=100,tm=function(){function a(){}return a.prototype.x=0,a.prototype.y=0,a.prototype.h=0,a.prototype.w=0,a.prototype.index=0,a.prototype.count=0,a}(),hi=[],gi=rf=0;rf<1e4;gi=++rf)hi[gi]=new tm;fe=3,ge=1,zi=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x;if(l=0,m=0,o=0,n=0,w=0,x=0,k=0,v=0,g=0,h=0,i=0,j=0,u=0,f=0,a.tensor.ndim>2)return void ni(a);if(o=a.tensor.dim[0],n=2===a.tensor.ndim?a.tensor.dim[1]:1,(m=o*n)>wd)return void ni(a);for(w=Ei,l=b=0,p=m;0<=p?b<p:b>p;l=0<=p?++b:--b)hi[l].index=Bp,hi[l].x=Ei,ki(a.tensor.elem[l]),hi[l].count=Bp-hi[l].index,q=Qj(hi[l].index,Bp),hi[l].h=q[0],hi[l].w=q[1],hi[l].y=q[2];for(i=0,j=0,l=c=0,r=m;0<=r?c<r:c>r;l=0<=r?++c:--c)hi[l].h>i&&(i=hi[l].h),hi[l].w>j&&(j=hi[l].w);for(k=o*i+(o-1)*ge,v=n*j+(n-1)*fe,x=-k/2,u=d=0,s=o;0<=s?d<s:d>s;u=0<=s?++d:--d)for(f=e=0,t=n;0<=t?e<t:e>t;f=0<=t?++e:--e)l=u*n+f,g=w-hi[l].x,h=x-hi[l].y,Jl(hi[l].index,hi[l].index+hi[l].count,g,h),g=0,f>0&&(g=f*(j+fe)),h=0,u>0&&(h=u*(i+ge)),g+=(j-hi[l].w)/2,h+=(i-hi[l].h)/2,Jl(hi[l].index,hi[l].index+hi[l].count,g,h);return Ei=w+v},ni=function(a){return Ai(a,0,0)},Ai=function(a,b,c){var d,e,f;for(e=0,bf("("),e=d=0,f=a.tensor.dim[b];0<=f?d<f:d>f;e=0<=f?++d:--d)b+1===a.tensor.ndim?(ki(a.tensor.elem[c]),c+=1):c=Ai(a,b+1,c),e+1<a.tensor.dim[b]&&bf(",");return bf(")"),c},Rc=function(a,b){var c,d,e;if(d=0,Fi(a,b))return 1;if(el(a)){for(d=c=0,e=a.tensor.nelem;0<=e?c<e:c>e;d=0<=e?++c:--c)if(Rc(a.tensor.elem[d],b))return 1;return 0}for(;uk(a);){if(Rc(jg(a),b))return 1;a=tg(a)}return 0},c.Find=Rc,_j=function(){var a,b,c,v,M;if(c=0,xj=0,kp=0,Ki=0,Zh=0,yj=Ke,!xj){for(xj=1,c=a=0,v=Gd;0<=v?a<v:a>v;c=0<=v?++a:--a)_o[c]=new Xe;for(c=b=0,M=Gd;0<=M?b<M:b>M;c=0<=M?++b:--b)_o[c].k=me,Uf[c]=_o[c],Hf[c]=Zo(xd);return vm=Zo(xd),wm=Zo(xd),xm=Zo(xd),ym=Zo(xd),zm=Zo(xd),Am=Zo(xd),Bm=Zo(xd),Cm=Zo(xd),Dm=Zo(xd),Em=Zo(xd),Qo("abs",d),Qo("add",e),Qo("adj",f),Qo("and",g),Qo("arccos",h),Qo("arccosh",i),Qo("arcsin",j),Qo("arcsinh",k),Qo("arctan",l),Qo("arctanh",m),Qo("arg",n),Qo("atomize",o),Qo("besselj",r),Qo("bessely",s),Qo("binding",t),Qo("binomial",u),Qo("ceiling",C),Qo("check",D),Qo("choose",E),Qo("circexp",F),Qo("clear",G),Qo("clock",H),Qo("coeff",I),Qo("cofactor",J),Qo("condense",K),Qo("conj",L),Qo("contract",N),Qo("cos",O),Qo("cosh",P),Qo("decomp",S),Qo("defint",T),Qo("deg",U),Qo("denominator",V),Qo("det",X),Qo("derivative",W),Qo("dim",Z),Qo("dirac",$),Qo("display",_),Qo("divisors",aa),Qo("do",ba),Qo("dot",ca),Qo("draw",ea),Qo("dsolve",ga),Qo("erf",pa),Qo("erfc",qa),Qo("eigen",ia),Qo("eigenval",ja),Qo("eigenvec",ka),Qo("eval",ra),Qo("exp",sa),Qo("expand",ta),Qo("expcos",ua),Qo("expsin",va),Qo("factor",Kc),Qo("factorial",Lc),Qo("factorpoly",Mc),Qo("filter",Nc),Qo("float",Oc),Qo("floor",Pc),Qo("for",Qc),Qo("Gamma",Sc),Qo("gcd",Tc),Qo("hermite",Uc),Qo("hilbert",Vc),Qo("imag",Wc),Qo("component",Xc),Qo("inner",Yc),Qo("integral",Zc),Qo("inv",$c),Qo("invg",_c),Qo("isinteger",cd),Qo("isprime",dd),Qo("laguerre",ed),Qo("lcm",gd),Qo("leading",hd),Qo("legendre",id),Qo("log",jd),Qo("mag",ld),Qo("mod",sd),Qo("multiply",ud),Qo("not",yd),Qo("nroots",zd),Qo("number",Id),Qo("numerator",Jd),Qo("operator",Kd),Qo("or",Ld),Qo("outer",Md),Qo("polar",Od),Qo("power",Pd),Qo("prime",Qd),Qo("print",Rd),Qo("product",Td),Qo("quote",Ud),Qo("quotient",Vd),Qo("rank",Wd),Qo("rationalize",Xd),Qo("real",Yd),Qo("rect",_e),Qo("roots",Zd),Qo("equals",_d),Qo("sgn",ae),Qo("simplify",ce),Qo("sin",de),Qo("sinh",ee),Qo("shape",be),Qo("sqrt",he),Qo("stop",ie),Qo("subst",ke),Qo("sum",le),Qo("tan",Ae),Qo("tanh",Be),Qo("taylor",Ce),Qo("test",Ee),Qo("testeq",Fe),Qo("testge",Ge),Qo("testgt",He),Qo("testle",Ie),Qo("testlt",Je),Qo("transpose",Me),Qo("unit",Ye),Qo("zero",af),Qo("nil",xd),Qo("autoexpand",p),Qo("bake",q),Qo("last",fd),Qo("trace",Le),Qo("tty",Ne),Qo("~",$e),Qo("$DRAWX",fa),Qo("$METAA",pd),Qo("$METAB",qd),Qo("$METAX",rd),Qo("$SECRETX",$d),Qo("pi",Nd),Qo("a",ne),Qo("b",oe),Qo("c",pe),Qo("d",qe),Qo("i",re),Qo("j",se),Qo("n",te),Qo("r",ue),Qo("s",ve),Qo("t",we),Qo("x",xe),Qo("y",ye),Qo("z",ze),Qo("$C1",w),Qo("$C2",x),Qo("$C3",y),Qo("$C4",z),Qo("$C5",A),Qo("$C6",B),un(0),fq=Nm(),un(1),sm=Nm(),wn(Pd),R&&Xm(Oo[kp-1]),un(-1),R&&Xm(Oo[kp-1]),vn(1,2),R&&Xm(Oo[kp-1]),pl(3),R&&Xm(Oo[kp-1]),Zj=Nm(),Bh()}},Ch=["e=exp(1)","i=sqrt(-1)","autoexpand=1","trange=(-pi,pi)","xrange=(-10,10)","yrange=(-10,10)","last=0","trace=0","tty=0","cross(u,v)=(u[2]*v[3]-u[3]*v[2],u[3]*v[1]-u[1]*v[3],u[1]*v[2]-u[2]*v[1])","curl(v)=(d(v[3],y)-d(v[2],z),d(v[1],z)-d(v[3],x),d(v[2],x)-d(v[1],y))","div(v)=d(v[1],x)+d(v[2],y)+d(v[3],z)","ln(x)=log(x)"],Bh=function(){var a,b,c,d,e;for(e=[],c=a=0,d=Ch.length;0<=d?a<d:a>d;c=0<=d?++a:--a)b=Ch[c],_n(b),R&&(console.log("... evaling "+b),console.log("top of stack:"),Xm(Oo[kp-1])),wa(),e.push(Nm());return e},yl=function(a,b){return a.compare(b)},Uo=function(a,b){return a===b?0:a>b?1:-1},Vh=function(a){return parseFloat(a.toPrecision(6))},Dg=function(){},al=function(a){return null!=a&&(" "===a||"\t"===a||"\n"===a||"\v"===a||"\f"===a||"\r"===a)},wk=function(a){return null!=a&&/^\d+$/.test(a)},sk=function(a){return null!=a&&-1===a.search(/[^A-Za-z]/)},rk=function(a){return null!=a&&(sk(a)||wk(a))},To=function(a){var b;throw Ji+="Stop: ",Ji+=a,b=Ji,Ji="",kp=0,new Error(b)},bk=!1,Yn=function(a){var b,c,d,e,f;if("selftest"===(a=a))return void selftest();for(bk||(bk=!0,_j()),0,f=0,e=0,b="";;){try{Ji="",yg(),f=_n(a.substring(e)),wm=Nm(),yg()}catch(a){d=a,Sd&&console.log(d),b+=d.message,_j();break}if(0===f)break;e+=f,qn(wm);try{if(jp(),xm=Nm(),yg(),xm===Zo(xd))continue;if(bl(xm)){console.log(xm.str),console.log("\n");continue}c=Mg(xm),b+=c,Sd&&(console.log("printline"),console.log(c)),Sd&&(console.log("display:"),Oh(xm)),b+="\n"}catch(a){d=a,c=d.message,Sd&&console.log(c),b+=c,b+="\n",_j()}}return"\n"===b[b.length-1]&&(b=b.substring(0,b.length-1)),b},yg=function(){if(0!==kp&&To("stack error"),yj!==Ke)return To("frame error")},jp=function(){return R&&console.log("#### top level eval"),Zn(),np=0,wm=Zo(p),Ti=fl(Mj(wm))?0:1,wm=Nm(),qn(wm),wa(),(xm=Nm())===Zo(xd)?(qn(xm),void Sn()):(ro(Zo(fd),xm),fl(Mj(Zo(q)))||(qn(xm),If(),xm=Nm()),wm!==Zo(re)&&wm!==Zo(se)||!Ek(xm)?Ek(Mj(Zo(se)))?(qn(xm),qn(Zj),wn(se),Wo(),xm=Nm()):Ek(Mj(Zo(re)))&&(qn(xm),qn(Zj),wn(re),Wo(),xm=Nm()):0,qn(xm),Sn())},xg=function(){if(Ki)return To("esc key")},(void 0!==b&&null!==b?b:this).run=Yn,kp=0,dm=0,qn=function(a){return a.isZero,a===Zo(xd)&&(dm++,R&&console.log("pushing symbol(NIL) #"+dm)),kp>=yj&&To("stack overflow"),Oo[kp++]=a},Nm=function(){return 0===kp&&To("stack underflow"),Oo[kp-1],Oo[--kp]},tn=function(a){var b,c,d,e;for(c=0,yj-=a,yj<kp&&To("frame overflow, circular reference?"),e=[],c=b=0,d=a;0<=d?b<d:b>d;c=0<=d?++b:--b)e.push(Oo[yj+c]=Zo(xd));return e},Pm=function(a){if((yj+=a)>Ke)return To("frame underflow")},Zn=function(){return yj-=10,yj<kp&&To("frame overflow, circular reference?"),Oo[yj+0]=vm,Oo[yj+1]=wm,Oo[yj+2]=xm,Oo[yj+3]=ym,Oo[yj+4]=zm,Oo[yj+5]=Am,Oo[yj+6]=Bm,Oo[yj+7]=Cm,Oo[yj+8]=Dm,Oo[yj+9]=Em},Sn=function(){return yj>Ke-10&&To("frame underflow"),vm=Oo[yj+0],wm=Oo[yj+1],xm=Oo[yj+2],ym=Oo[yj+3],zm=Oo[yj+4],Am=Oo[yj+5],Bm=Oo[yj+6],Cm=Oo[yj+7],Dm=Oo[yj+8],Em=Oo[yj+9],yj+=10},Yo=function(){var a,b;return a=Nm(),b=Nm(),qn(a),qn(b)},ei=function(){var a;return a=Nm(),qn(a),qn(a)},c.dupl=ei,c.swap=Yo,c.restore=Sn,c.save=Zn,c.push=qn,c.pop=Nm,Qo=function(a,b){var c;return c=_o[b],c.printname=a},sp=function(a){var b,c,d,e;for(c=0,c=b=0,e=Gd;(0<=e?b<e:b>e)&&""!==_o[c].printname;c=0<=e?++b:--b)if(a===_o[c].printname)return _o[c];return c===Gd&&To("symbol table overflow"),d=_o[c],d.printname=a,d},Pj=function(a){return a.k!==me&&To("symbol error"),a.printname},ro=function(a,b){var c;return a.k!==me&&To("symbol error"),c=_o.indexOf(a),-1!==_o.indexOf(a,c+1)&&console.log("ops, more than one element!"),R&&console.log("lookup >> set_binding lookup "+c),Uf[c]=b,Hf[c]=Zo(xd)},Mj=function(a){var b;return a.k!==me&&To("symbol error"),b=_o.indexOf(a),-1!==_o.indexOf(a,b+1)&&console.log("ops, more than one element!"),R&&console.log("lookup >> get_binding lookup "+b),Uf[b]},so=function(a,b,c){var d;return a.k!==me&&To("symbol error"),d=_o.indexOf(a),-1!==_o.indexOf(a,d+1)&&console.log("ops, more than one element!"),R&&console.log("lookup >> set_binding_and_arglist lookup "+d),Uf[d]=b,Hf[d]=c},Lj=function(a){var b;return a.k!==me&&To("symbol error"),b=_o.indexOf(a),-1!==_o.indexOf(a,b+1)&&console.log("ops, more than one element!"),R&&console.log("lookup >> get_arglist lookup "+b),Hf[b]},rl=0,$o=function(a){var b;return rl++,a.k!==me&&To("symbol error"),b=_o.indexOf(a),-1!==_o.indexOf(a,b+1)&&console.log("ops, more than one element!"),R&&console.log("lookup >> symnum lookup "+b+" lookup # "+rl),b},wn=function(a){return qn(_o[a])},Cg=function(){var a,b,c,d;for(b=0,d=[],b=a=0,c=Gd;0<=c?a<c:a>c;b=0<=c?++a:--a)Uf[b]=_o[b],d.push(Hf[b]=Zo(xd));return d},c.get_binding=Mj,c.set_binding=ro,c.usr_symbol=sp,bk||(bk=!0,_j()),c.init=_j,Gm=function(a){return"string"==typeof a?_n(a):"number"==typeof a?a%1==0?un(a):rn(a):a instanceof Xe?qn(a):(console.warn("unknown argument type",a),qn(Zo(xd)))},Fm=function(a){var b,c;try{Gm(a),b=Nm(),yg()}catch(a){throw c=a,Rn(),c}return b},Li=function(){var a,b,c,d,e,f,g,h;for(g=arguments[0],c=2<=arguments.length?gq.call(arguments,1):[],e=Mj(sp(g)),yg(),qn(e),a=0,f=c.length;a<f;a++)b=c[a],Gm(b);pl(1+c.length),wm=Nm(),qn(wm);try{uj(),h=Nm(),yg()}catch(a){throw d=a,Rn(),d}return h},Rn=function(){return kp=0,Ki=0,Zh=0,yj=Ke},uj=function(){return Zn(),np=0,wm=Zo(p),Ti=fl(Mj(wm))?0:1,wm=Nm(),qn(wm),wa(),(xm=Nm())===Zo(xd)?(qn(xm),void Sn()):(fl(Mj(Zo(q)))||(qn(xm),If(),xm=Nm()),qn(xm),Sn())},c.exec=Li,c.parse=Fm,function(){var a,b,d,e,f;for(b=["abs","add","adj","and","arccos","arccosh","arcsin","arcsinh","arctan","arctanh","arg","atomize","besselj","bessely","binding","binomial","ceiling","check","choose","circexp","clear","clock","coeff","cofactor","condense","conj","contract","cos","cosh","decomp","defint","deg","denominator","det","derivative","dim","dirac","display","divisors","do","dot","draw","dsolve","erf","erfc","eigen","eigenval","eigenvec","eval","exp","expand","expcos","expsin","factor","factorial","factorpoly","filter","float","floor","for","Gamma","gcd","hermite","hilbert","imag","component","inner","integral","inv","invg","isinteger","isprime","laguerre","lcm","leading","legendre","log","mag","mod","multiply","not","nroots","number","numerator","operator","or","outer","polar","power","prime","print","product","quote","quotient","rank","rationalize","real","rect","roots","equals","sgn","simplify","sin","sinh","sqrt","stop","subst","sum","tan","tanh","taylor","test","testeq","testge","testgt","testle","testlt","transpose","unit","zero"],f=[],a=0,e=b.length;a<e;a++)d=b[a],f.push(c[d]=Li.bind(this,d))}()}.call(this),c.exports}),a.registerDynamic("2b",[],!0,function(a,b,c){var d=(this||self,{version:"1.3.5"});return void 0!==b&&(b.Tree=d),d.parse=function(a){var b,c=new d.Node,e=c.append(new d.Node);for(e.value="",b=0;b<a.length;b++){var f=a[b];if("["==f)e=e.append(new d.Node),e.value="";else if("]"==f){if((e=e.parent)===c)throw"parse error"}else","==f?(e=e.parent.append(new d.Node),e.value=""):e.value+=f}for(b=0;b<c.children.length;b++)c.children[b].parent=null;return 1===c.children.length?c.children[0]:c.children},d.stringify=function(a){var b=function(a){var c="";return"value"in a&&(c+=a.value),a.children&&a.children[0]&&(c+="["+a.children.map(b).join(",")+"]"),c};return Array.isArray(a)||(a=[a]),a.map(b).join(",")},function(){function a(){var a=0,d=Math.random()*b;return e[a++]=f[d&c],e[a++]=f[d>>>4&c],e[a++]=f[d>>>8&c],e[a++]=f[d>>>12&c],e[a++]=f[d>>>16&c],e[a++]=f[d>>>20&c],e[a++]=f[d>>>24&c],e[a++]=f[d>>>28&c],d=Math.random()*b,e[a++]=f[d&c],e[a++]=f[d>>>4&c],e[a++]=f[d>>>8&c],e[a++]=f[d>>>12&c],e[a++]=f[d>>>16&c],e[a++]=f[d>>>20&c],e[a++]=f[d>>>24&c],e[a++]=f[d>>>28&c],"_"+e.join("")}var b=4294967296,c=15,e=[],f=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];d.uid=a}(),d.clone=function(a,b,c){var e=function(a){var f,g=new a.constructor;if(c)for(f=0;f<c.length;f++)g[c[f]]=a[c[f]];else for(var h in a)"_"!==h[0]&&(g[h]=a[h]);if(delete g.ls,delete g.rs,delete g.parent,a.id&&!b&&(g.id=d.uid()),a.children){for(g.children=[],f=0;f<a.children.length;f++)g.children.push(e(a.children[f])),g.children[f].parent=g;for(f=0;f<a.children.length;f++)g.children[f].ls=g.children[f-1],g.children[f].rs=g.children[f+1]}return g};if(!Array.isArray(a))return e(a);var f=a.map(e);if(a.length>1)for(var g=0;g<a.length;g++)g>0&&a[g].ls===a[g-1]&&(f[g].ls=f[g-1]),g<a.length-1&&a[g].rs===a[g+1]&&(f[g].rs=f[g+1]);return f},d.get_mapping_between=function(a,b){function c(a,b){if(a.id in d)throw"duplicate id in source tree";if(d[a.id]=[b],a.children.length!==b.children.length)if(a.has_children()){if(b.has_children())throw"tree structures don't match";a.for_each(function(a){d[a.id]=[b]})}else d[a.id]=b.select_all();else for(var e=0;e<a.children.length;e++)c(a.children[e],b.children[e])}var d={};if(Array.isArray(a)){if(a.length!==b.length)throw"tree structures don't match";for(var e=0;e<a.length;e++)c(a[e],b[e])}else c(a,b);return d},d.get_1to1_mapping_between=function(a,b,c){function d(a,b){if(c&&a.id in e)throw"duplicate id in source tree";if(e[a.id]=[b],c&&a.children.length!==b.children.length)throw"tree structures don't match";for(var f=a.children.length,g=b.children.length,h=0;h<f;h++)h<g?d(a.children[h],b.children[h]):a.children[h].for_each(function(a){e[a.id]=[]})}var e={};if(arguments.length<3&&(c=!0),Array.isArray(a)){if(c&&a.length!==b.length)throw"tree structures don't match";for(var f=a.length,g=b.length,h=0;h<f;h++)h<g?d(a[h],b[h]):a[h].for_each(function(a){e[a.id]=[]})}else d(a,b);return e},d.nodes_to_range=function(a){var b=a.length;if(0===b)return[];if(1===b)return[a[0]];for(var c=a[0];c.parent;)c=c.parent;for(var e=a.map(function(a){return d.get_path(a)}),f=function(a){for(var b=e[0][a],c=0;c<e.length;c++){if(e[c].length<=a+1)return!1;if(e[c][a]!==b)return!1}return!0},g=0;f(g);)g++;var h,i=d.get_child(e[0].slice(0,g),c),j=-1,k=i.children.length;for(h=0;h<b;h++){var l=d.get_child(e[h].slice(0,g+1),c),m=i.children.indexOf(l);m>j&&(j=m),m<k&&(k=m)}var n=[];for(h=k;h<=j;h++)n.push(i.children[h]);return n},d.insert=function(a,b,c){return c.ls=a.children[b-1],a.children[b-1]&&(a.children[b-1].rs=c),c.rs=a.children[b],a.children[b]&&(a.children[b].ls=c),c.parent=a,a.children.splice(b,0,c),c},d.insert_range=function(a,b,c){var d=c.length;if(0!==d){c[0].ls=a.children[b-1],a.children[b-1]&&(a.children[b-1].rs=c[0]),c[d-1].rs=a.children[b],a.children[b]&&(a.children[b].ls=c[d-1]);for(var e=0;e<d;e++)c[e].parent=a;return a.children=a.children.slice(0,b).concat(c,a.children.slice(b)),c}},d.append_range=function(a,b){var c=b.length;if(0!==c){var d=a.children[a.children.length-1];d&&(d.rs=b[0]),b[0].ls=d,b[c-1].rs=null;for(var e=0;e<c;e++)b[e].parent=a;return a.children=a.children.concat(b),b}},d.filterRange=function(a,b,c){for(var d=[],e=Array.isArray(b)?b:[b],f=function(b,e){for(var g=[],h=b[e],i=e;i<b.length;i++)if(g.push(b[i]),a(g)&&(d.push(g.slice()),c))return i-e;if(h.children)for(var i=0;i<h.children.length;i++)i+=f(h.children,i);return 0},g=0;g<e.length;g++)g+=f(e,g);return d},d.append=function(a,b){var c=a.children[a.children.length-1];return c&&(c.rs=b),b.ls=c,b.rs=null,b.parent=a,a.children.push(b),b},d.remove=function(a){var b,c=a.parent.children;return b=c.indexOf(a),c[b-1]&&(c[b-1].rs=a.rs),c[b+1]&&(c[b+1].ls=a.ls),c.splice(b,1),a.parent=null,b},d.remove_range=function(a){var b=a.length;if(0!==b){var c=a[0].parent.children,d=c.indexOf(a[0]);c[d-1]&&(c[d-1].rs=a[b-1].rs),c[d+b]&&(c[d+b].ls=a[0].ls),c.splice(d,b);for(var e=0;e<a.length;e++)a[e].parent=null;return d}},d.replace=function(a,b){b.parent&&d.remove(b);var c=a.parent,e=d.remove(a);return d.insert(c,e,b)},d.switch_siblings=function(a,b){if(a.parent!=b.parent)throw"Called switch_siblings on nodes that are no siblings!";var c=a.parent,d=c.children.indexOf(a),e=c.children.indexOf(b);c.children[d]=b,c.children[e]=a;var f;a.rs==b?(a.ls&&(a.ls.rs=b),b.rs&&(b.rs.ls=a),a.rs=b.rs,b.ls=a.ls,a.ls=b,b.rs=a):a.ls==b?(a.rs&&(a.rs.ls=b),b.ls&&(b.ls.rs=a),a.ls=b.ls,b.rs=a.rs,a.rs=b,b.ls=a):(a.ls&&(a.ls.rs=b),a.rs&&(a.rs.ls=b),b.ls&&(b.ls.rs=a),b.rs&&(b.rs.ls=a),f=a.ls,a.ls=b.ls,b.ls=f,f=a.rs,a.rs=b.rs,b.rs=f)},d.validate=function(a){var b=function(a,c){if(a.parent!=c)throw"wrong parent information";if(a.children)for(var d=0;d<a.children.length;d++){var e=a.children[d];if(e.ls!=a.children[d-1])throw"wrong ls information";if(e.rs!=a.children[d+1])throw"wrong rs information";b(e,a)}};Array.isArray(a)||(a=[a]);for(var c=0;c<a.length;c++)b(a[c],null)},d.get_idx=function(a){return a.parent?a.parent.children.indexOf(a):-1},d.get_child=function(a,b){for(var c=0;c<a.length;c++){if(!b.children||b.children.length<=a[c])return null;b=b.children[a[c]]}return b},d.get_parent=function(a,b){for(var c=0;c<a;c++){if(!b.parent)return null;b=b.parent}return b},d.get_path=function(a){for(var b=[];a.parent;)b.unshift(a.parent.children.indexOf(a)),a=a.parent;return b},d.for_each=function(a,b){for(var c=Array.isArray(b)?b:[b],d=function(b){if(a(b),b.children)for(var c=0;c<b.children.length;c++)d(b.children[c])},e=0;e<c.length;e++)d(c[e])},d.map=function(a,b){for(var c=Array.isArray(b)?b:[b],d=[],e=function(b){if(d.push(a(b)),b.children)for(var c=0;c<b.children.length;c++)e(b.children[c])},f=0;f<c.length;f++)e(c[f]);return d},d.filter=function(a,b){for(var c=[],d=Array.isArray(b)?b:[b],e=function(b){if(a(b)&&c.push(b),b.children)for(var d=0;d<b.children.length;d++)e(b.children[d])},f=0;f<d.length;f++)e(d[f]);return c},d.select_all=function(a){return d.filter(function(){return!0},a)},d.select_first=function(a,b){for(var c=function(b){for(var c=b;;){if(a(c))return c;if(c.children&&c.children[0])c=c.children[0];else{if(c===b)return null;for(;!c.rs;)if((c=c.parent)===b)return null;c=c.rs}}},d=Array.isArray(b)?b:[b],e=0;e<d.length;e++){var f=c(d[e]);if(f)return f}return null},d.get_cca=function(a){for(var b=a.map(function(a){return d.get_path(a)}),c=function(a){for(var c=b[0][a],d=0;d<b.length;d++){if(b[d].length<=a+1)return!1;if(b[d][a]!==c)return!1}return!0},e=0;c(e);)e++;for(var f=b[0].length-e,g=a[0],h=0;h<f;h++)g=g.parent;return g},d.get_leaf_nodes=function(a){return d.filter(function(a){return!(a.children&&a.children.length)},a)},d.is_root=function(a){return!a.parent},d.is_range=function(a){for(var b=1;b<a.length;b++)if(a[b-1].rs!==a[b])return!1;return!0},d.get_root=function(a){for(;a.parent;)a=a.parent;return a},d.get_by_value=function(a,b){return d.filter(function(b){return b.value===a},b)},d.get_by_id=function(a,b){return d.select_first(function(b){return b.id===a},b)},d.Node=function(){this.children=[],this.parent=null,this.ls=null,this.rs=null,this.id=d.uid()},d.Node.prototype.stringify=function(){return d.stringify(this)},d.Node.prototype.clone=function(a,b){return d.clone(this,a,b)},d.Node.prototype.get_mapping_to=function(a){return d.get_mapping_between(this,a)},d.Node.prototype.get_1to1_mapping_to=function(a,b){return d.get_1to1_mapping_between(this,a,b)},d.Node.prototype.insert=function(a,b){return d.insert(this,a,b)},d.Node.prototype.insert_range=function(a,b){return d.insert_range(this,a,b)},d.Node.prototype.append_range=function(a){return d.append_range(this,a)},d.Node.prototype.append=function(a){return d.append(this,a)},d.Node.prototype.remove=function(){return d.remove(this)},d.Node.prototype.remove_range=function(a){return d.remove_range(a)},d.Node.prototype.replace_with=function(a){return d.replace(this,a)},d.Node.prototype.switch_with_sibling=function(a){return d.switch_siblings(this,a)},d.Node.prototype.validate=function(){return d.validate(this)},d.Node.prototype.get_child=function(a){return d.get_child(a,this)},d.Node.prototype.get_parent=function(a){return d.get_parent(a,this)},d.Node.prototype.get_path=function(){return d.get_path(this)},d.Node.prototype.for_each=function(a){return d.for_each(a,this)},d.Node.prototype.map=function(a){return d.map(a,this)},d.Node.prototype.filter=function(a){return d.filter(a,this)},d.Node.prototype.filterRange=function(a,b){return d.filterRange(a,this,b)},d.Node.prototype.select_all=function(){return d.select_all(this)},d.Node.prototype.select_first=function(a){return d.select_first(a,this)},d.Node.prototype.get_leaf_nodes=function(){return d.get_leaf_nodes(this)},d.Node.prototype.is_root=function(){return d.is_root(this)},d.Node.prototype.get_root=function(){return d.get_root(this)},d.Node.prototype.get_by_value=function(a){return d.get_by_value(a,this)},d.Node.prototype.get_by_id=function(a){return d.get_by_id(a,this)},d.Node.prototype.has_children=function(){return this.children&&this.children.length>0},d.Node.prototype.get_idx=function(){return d.get_idx(this)},c.exports}),a.registerDynamic("2c",[],!1,function(b,c,d){return a.get("@@global-helpers").prepareGlobal(d.id,null,null)()}),a.registerDynamic("2d",["2c"],!0,function(a,b,c){this||self;return function(){function a(){}function b(a){var b=a.length-1;return function(){var c=v.call(arguments,0,b),d=v.call(arguments,b);return a.apply(this,c.concat([d]))}}function c(a){return b(function(b,c){"function"!=typeof b&&(b=w(b));var d=function(a){return b.apply(a,[a].concat(c))};return a.call(this,d)})}function d(a){var b=v.call(arguments,1);return function(){return a.apply(this,b)}}function e(a,b){if(!b)throw new Error("prayer failed: "+a)}function f(a){e("a direction was passed",a===y||a===z)}function g(a,b,c){e("a parent is always present",a),e("leftward is properly set up",function(){return b?b[z]===c&&b.parent===a:a.ends[y]===c}()),e("rightward is properly set up",function(){return c?c[y]===b&&c.parent===a:a.ends[z]===b}())}function h(){window.console&&console.warn('You are using the MathQuill API without specifying an interface version, which will fail in v1.0.0. Easiest fix is to do the following before doing anything else:\n\n    MathQuill = MathQuill.getInterface(1);\n    // now MathQuill.MathField() works like it used to\n\nSee also the "`dev` branch (20142015)  v0.10.0 Migration Guide" at\n  https://github.com/mathquill/mathquill/wiki/%60dev%60-branch-(2014%E2%80%932015)-%E2%86%92-v0.10.0-Migration-Guide')}function i(a){return h(),Ka(a)}function j(b){function c(a){if(!a||!a.nodeType)return null;var b=A(a).children(".mq-root-block").attr(s),c=b&&C.byId[b].controller;return c?e[c.KIND_OF_MQ](c):null}function d(a,b){b&&b.handlers&&(b.handlers={fns:b.handlers,APIClasses:e});for(var c in b)if(b.hasOwnProperty(c)){var d=b[c],f=L[c];a[c]=f?f(d):d}}if(!(O<=b&&b<=P))throw"Only interface versions between "+O+" and "+P+" supported. You specified: "+b;var e={};c.L=y,c.R=z,c.config=function(a){return d(K.p,a),this},c.registerEmbed=function(a,b){if(!/^[a-z][a-z0-9]*$/i.test(a))throw"Embed name must start with letter and be only letters and digits";N[a]=b};var f=e.AbstractMathQuill=x(M,function(a){a.init=function(a){this.__controller=a,this.__options=a.options,this.id=a.id,this.data=a.data},a.__mathquillify=function(a){var b=this.__controller,c=b.root,d=b.container;b.createTextarea();var e=d.addClass(a).contents().detach();c.jQ=A('<span class="mq-root-block"/>').attr(s,c.id).appendTo(d),this.latex(e.text()),this.revert=function(){return d.empty().unbind(".mathquill").removeClass("mq-editable-field mq-math-mode mq-text-mode").append(e)}},a.config=function(a){return d(this.__options,a),this},a.el=function(){return this.__controller.container[0]},a.text=function(){return this.__controller.exportText()},a.latex=function(a){return arguments.length>0?(this.__controller.renderLatexMath(a),this.__controller.blurred&&this.__controller.cursor.hide().parent.blur(),this):this.__controller.exportLatex()},a.html=function(){return this.__controller.root.jQ.html().replace(/ mathquill-(?:command|block)-id="?\d+"?/g,"").replace(/<span class="?mq-cursor( mq-blink)?"?>.?<\/span>/i,"").replace(/ mq-hasCursor|mq-hasCursor ?/,"").replace(/ class=(""|(?= |>))/g,"")},a.reflow=function(){return this.__controller.root.postOrder("reflow"),this}});c.prototype=f.prototype,e.EditableField=x(f,function(b,c){b.__mathquillify=function(){return c.__mathquillify.apply(this,arguments),this.__controller.editable=!0,this.__controller.delegateMouseEvents(),this.__controller.editablesTextareaEvents(),this},b.focus=function(){return this.__controller.textarea.focus(),this},b.blur=function(){return this.__controller.textarea.blur(),this},b.write=function(a){return this.__controller.writeLatex(a),this.__controller.scrollHoriz(),this.__controller.blurred&&this.__controller.cursor.hide().parent.blur(),this},b.cmd=function(a){var b=this.__controller.notify(),c=b.cursor;if(/^\\[a-z]+$/i.test(a)){a=a.slice(1);var d=E[a];d&&(a=d(a),c.selection&&a.replaces(c.replaceSelection()),a.createLeftOf(c.show()),this.__controller.scrollHoriz())}else c.parent.write(c,a);return b.blurred&&c.hide().parent.blur(),this},b.select=function(){var a=this.__controller;for(a.notify("move").cursor.insAtRightEnd(a.root);a.cursor[y];)a.selectLeft();return this},b.clearSelection=function(){return this.__controller.cursor.clearSelection(),this},b.moveToDirEnd=function(a){return this.__controller.notify("move").cursor.insAtDirEnd(a,this.__controller.root),this},b.moveToLeftEnd=function(){return this.moveToDirEnd(y)},b.moveToRightEnd=function(){return this.moveToDirEnd(z)},b.keystroke=function(b){for(var b=b.replace(/^\s+|\s+$/g,"").split(/\s+/),c=0;c<b.length;c+=1)this.__controller.keystroke(b[c],{preventDefault:a});return this},b.typedText=function(a){for(var b=0;b<a.length;b+=1)this.__controller.typedText(a.charAt(b));return this},b.dropEmbedded=function(a,b,c){var d=a-A(window).scrollLeft(),e=b-A(window).scrollTop(),f=document.elementFromPoint(d,e);this.__controller.seek(A(f),a,b),Ja().setOptions(c).createLeftOf(this.__controller.cursor)},b.clickAt=function(a,b,c){c=c||document.elementFromPoint(a,b);var d=this.__controller,e=d.root;return q.contains(e.jQ[0],c)||(c=e.jQ[0]),d.seek(A(c),a+pageXOffset,b+pageYOffset),d.blurred&&this.focus(),this},b.ignoreNextMousedown=function(a){return this.__controller.cursor.options.ignoreNextMousedown=a,this}}),c.EditableField=function(){throw"wtf don't call me, I'm 'abstract'"},c.EditableField.prototype=e.EditableField.prototype;for(var g in J)!function(a,d){var f=e[a]=d(e);c[a]=function(d,e){var g=c(d);if(g instanceof f||!d||!d.nodeType)return g;var h=I(f.RootBlock(),A(d),K());return h.KIND_OF_MQ=a,f(h).__mathquillify(e,b)},c[a].prototype=f.prototype}(g,J[g]);return c}function k(a){for(var b="moveOutOf deleteOutOf selectOutOf upOutOf downOutOf".split(" "),c=0;c<b.length;c+=1)!function(b){a[b]=function(a){this.controller.handle(b,a)}}(b[c]);a.reflow=function(){this.controller.handle("reflow"),this.controller.handle("edited"),this.controller.handle("edit")}}function l(a,b,c){return x(_,{ctrlSeq:a,htmlTemplate:"<"+b+" "+c+">&0</"+b+">"})}function m(a){var b=this.parent,c=a;do{if(c[z])return a.insLeftOf(b);c=c.parent.parent}while(c!==b);a.insRightOf(b)}function n(a,b){a.jQadd=function(){b.jQadd.apply(this,arguments),this.delimjQs=this.jQ.children(":first").add(this.jQ.children(":last")),this.contentjQ=this.jQ.children(":eq(1)")},a.reflow=function(){var a=this.contentjQ.outerHeight()/parseFloat(this.contentjQ.css("fontSize"));sa(this.delimjQs,t(1+.2*(a-1),1.2),1.2*a)}}function o(a,b){var b=b||a,c=Ha[a],e=Ha[b];F[a]=d(Ga,y,a,c,b,e),F[c]=d(Ga,z,a,c,b,e)}var p,q=window.jQuery,r="mathquill-command-id",s="mathquill-block-id",t=Math.min,u=Math.max,v=[].slice,w=b(function(a,c){return b(function(b,d){if(a in b)return b[a].apply(b,c.concat(d))})}),x=function(a,b,c){function d(a){return"object"==typeof a}function e(a){return"function"==typeof a}function f(){}return function g(h,i){function j(){var a=new k;return e(a.init)&&a.init.apply(a,arguments),a}function k(){}i===c&&(i=h,h=Object),j.Bare=k;var l,m=f[a]=h[a],n=k[a]=j[a]=j.p=new f;return n.constructor=j,j.extend=function(a){return g(j,a)},(j.open=function(a){if(l={},e(a)?l=a.call(j,n,m,j,h):d(a)&&(l=a),d(l))for(var c in l)b.call(l,c)&&(n[c]=l[c]);return e(n.init)||(n.init=h),j})(i)}}("prototype",{}.hasOwnProperty),y=-1,z=1,A=x(q,function(a){a.insDirOf=function(a,b){return a===y?this.insertBefore(b.first()):this.insertAfter(b.last())},a.insAtDirEnd=function(a,b){return a===y?this.prependTo(b):this.appendTo(b)}}),B=x(function(a){a.parent=0,a[y]=0,a[z]=0,a.init=function(a,b,c){this.parent=a,this[y]=b,this[z]=c},this.copy=function(a){return B(a.parent,a[y],a[z])}}),C=x(function(a){function b(){return d+=1}a[y]=0,a[z]=0,a.parent=0;var d=0;this.byId={},a.init=function(){this.id=b(),C.byId[this.id]=this,this.ends={},this.ends[y]=0,this.ends[z]=0},a.dispose=function(){delete C.byId[this.id]},a.toString=function(){return"{{ MathQuill Node #"+this.id+" }}"},a.jQ=A(),a.jQadd=function(a){return this.jQ=this.jQ.add(a)},a.jQize=function(a){function b(a){if(a.getAttribute){var c=a.getAttribute("mathquill-command-id"),d=a.getAttribute("mathquill-block-id");c&&C.byId[c].jQadd(a),d&&C.byId[d].jQadd(a)}for(a=a.firstChild;a;a=a.nextSibling)b(a)}for(var a=A(a||this.html()),c=0;c<a.length;c+=1)b(a[c]);return a},a.createDir=function(a,b){f(a);var c=this;return c.jQize(),c.jQ.insDirOf(a,b.jQ),b[a]=c.adopt(b.parent,b[y],b[z]),c},a.createLeftOf=function(a){return this.createDir(y,a)},a.selectChildren=function(a,b){return H(a,b)},a.bubble=c(function(a){for(var b=this;b;b=b.parent){if(!1===a(b))break}return this}),a.postOrder=c(function(a){return function b(c){c.eachChild(b),a(c)}(this),this}),a.isEmpty=function(){return 0===this.ends[y]&&0===this.ends[z]},a.children=function(){return D(this.ends[y],this.ends[z])},a.eachChild=function(){var a=this.children();return a.each.apply(a,arguments),this},a.foldChildren=function(a,b){return this.children().fold(a,b)},a.withDirAdopt=function(a,b,c,d){return D(this,this).withDirAdopt(a,b,c,d),this},a.adopt=function(a,b,c){return D(this,this).adopt(a,b,c),this},a.disown=function(){return D(this,this).disown(),this},a.remove=function(){return this.jQ.remove(),this.postOrder("dispose"),this.disown()}}),D=x(function(a){a.init=function(a,b,c){if(c===p&&(c=y),f(c),e("no half-empty fragments",!a==!b),this.ends={},a){e("withDir is passed to Fragment",a instanceof C),e("oppDir is passed to Fragment",b instanceof C),e("withDir and oppDir have the same parent",a.parent===b.parent),this.ends[c]=a,this.ends[-c]=b;var d=this.fold([],function(a,b){return a.push.apply(a,b.jQ.get()),a});this.jQ=this.jQ.add(d)}},a.jQ=A(),a.withDirAdopt=function(a,b,c,d){return a===y?this.adopt(b,c,d):this.adopt(b,d,c)},a.adopt=function(a,b,c){g(a,b,c);var d=this;d.disowned=!1;var e=d.ends[y];if(!e)return this;var f=d.ends[z];return b||(a.ends[y]=e),c?c[y]=f:a.ends[z]=f,d.ends[z][z]=c,d.each(function(c){c[y]=b,c.parent=a,b&&(b[z]=c),b=c}),d},a.disown=function(){var a=this,b=a.ends[y];if(!b||a.disowned)return a;a.disowned=!0;var c=a.ends[z],d=b.parent;return g(d,b[y],b),g(d,c,c[z]),b[y]?b[y][z]=c[z]:d.ends[y]=c[z],c[z]?c[z][y]=b[y]:d.ends[z]=b[y],a},a.remove=function(){return this.jQ.remove(),this.each("postOrder","dispose"),this.disown()},a.each=c(function(a){var b=this,c=b.ends[y];if(!c)return b;for(;c!==b.ends[z][z];c=c[z]){if(!1===a(c))break}return b}),a.fold=function(a,b){return this.each(function(c){a=b.call(this,a,c)}),a}}),E={},F={},G=x(B,function(a){a.init=function(a,b){this.parent=a,this.options=b;var c=this.jQ=this._jQ=A('<span class="mq-cursor">&#8203;</span>');this.blink=function(){c.toggleClass("mq-blink")},this.upDownCache={}},a.show=function(){return this.jQ=this._jQ.removeClass("mq-blink"),"intervalId"in this?clearInterval(this.intervalId):(this[z]?this.selection&&this.selection.ends[y][y]===this[y]?this.jQ.insertBefore(this.selection.jQ):this.jQ.insertBefore(this[z].jQ.first()):this.jQ.appendTo(this.parent.jQ),this.parent.focus()),this.intervalId=setInterval(this.blink,500),this},a.hide=function(){return"intervalId"in this&&clearInterval(this.intervalId),delete this.intervalId,this.jQ.detach(),this.jQ=A(),this},a.withDirInsertAt=function(a,b,c,d){var e=this.parent;this.parent=b,this[a]=c,this[-a]=d,e!==b&&e.blur&&e.blur(this)},a.insDirOf=function(a,b){return f(a),this.jQ.insDirOf(a,b.jQ),this.withDirInsertAt(a,b.parent,b[a],b),this.parent.jQ.addClass("mq-hasCursor"),this},a.insLeftOf=function(a){return this.insDirOf(y,a)},a.insRightOf=function(a){return this.insDirOf(z,a)},a.insAtDirEnd=function(a,b){return f(a),this.jQ.insAtDirEnd(a,b.jQ),this.withDirInsertAt(a,b,0,b.ends[a]),b.focus(),this},a.insAtLeftEnd=function(a){return this.insAtDirEnd(y,a)},a.insAtRightEnd=function(a){return this.insAtDirEnd(z,a)},a.jumpUpDown=function(a,b){var c=this;c.upDownCache[a.id]=B.copy(c);var d=c.upDownCache[b.id];if(d)d[z]?c.insLeftOf(d[z]):c.insAtRightEnd(d.parent);else{var e=c.offset().left;b.seek(e,c)}},a.offset=function(){var a=this,b=a.jQ.removeClass("mq-cursor").offset();return a.jQ.addClass("mq-cursor"),b},a.unwrapGramp=function(){var a=this.parent.parent,b=a.parent,c=a[z],d=this,e=a[y];if(a.disown().eachChild(function(d){d.isEmpty()||(d.children().adopt(b,e,c).each(function(b){b.jQ.insertBefore(a.jQ.first())}),e=d.ends[z])}),!this[z])if(this[y])this[z]=this[y][z];else for(;!this[z];){if(this.parent=this.parent[z],!this.parent){this[z]=a[z],this.parent=b;break}this[z]=this.parent.ends[y]}this[z]?this.insLeftOf(this[z]):this.insAtRightEnd(b),a.jQ.remove(),a[y].siblingDeleted&&a[y].siblingDeleted(d.options,z),a[z].siblingDeleted&&a[z].siblingDeleted(d.options,y)},a.startSelection=function(){for(var a=this.anticursor=B.copy(this),b=a.ancestors={},c=a;c.parent;c=c.parent)b[c.parent.id]=c},a.endSelection=function(){delete this.anticursor},a.select=function(){var a=this.anticursor;if(this[y]===a[y]&&this.parent===a.parent)return!1;for(var b=this;b.parent;b=b.parent)if(b.parent.id in a.ancestors){var c=b.parent;break}e("cursor and anticursor in the same tree",c);var d,f,g=a.ancestors[c.id],h=z;if(b[y]!==g)for(var i=b;i;i=i[z])if(i[z]===g[z]){h=y,d=b,f=g;break}return h===z&&(d=g,f=b),d instanceof B&&(d=d[z]),f instanceof B&&(f=f[y]),this.hide().selection=c.selectChildren(d,f),this.insDirOf(h,this.selection.ends[h]),this.selectionChanged(),!0},a.clearSelection=function(){return this.selection&&(this.selection.clear(),delete this.selection,this.selectionChanged()),this},a.deleteSelection=function(){this.selection&&(this[y]=this.selection.ends[y][y],this[z]=this.selection.ends[z][z],this.selection.remove(),this.selectionChanged(),delete this.selection)},a.replaceSelection=function(){var a=this.selection;return a&&(this[y]=a.ends[y][y],this[z]=a.ends[z][z],delete this.selection),a}}),H=x(D,function(a,b){a.init=function(){b.init.apply(this,arguments),this.jQ=this.jQ.wrapAll('<span class="mq-selection"></span>').parent()},a.adopt=function(){return this.jQ.replaceWith(this.jQ=this.jQ.children()),b.adopt.apply(this,arguments)},a.clear=function(){return this.jQ.replaceWith(this.jQ[0].childNodes),this},a.join=function(a){return this.fold("",function(b,c){return b+c[a]()})}}),I=x(function(a){a.init=function(a,b,c){this.id=a.id,this.data={},this.root=a,this.container=b,this.options=c,a.controller=this,this.cursor=a.cursor=G(a,c)},a.handle=function(a,b){var c=this.options.handlers;if(c&&c.fns[a]){var d=c.APIClasses[this.KIND_OF_MQ](this);b===y||b===z?c.fns[a](b,d):c.fns[a](d)}};var b=[];this.onNotify=function(a){b.push(a)},a.notify=function(){for(var a=0;a<b.length;a+=1)b[a].apply(this.cursor,arguments);return this}}),J={},K=x(),L={},M=x(),N={};i.prototype=M.p,i.interfaceVersion=function(a){if(1!==a)throw"Only interface version 1 supported. You specified: "+a;return h=function(){window.console&&console.warn('You called MathQuill.interfaceVersion(1); to specify the interface version, which will fail in v1.0.0. You can fix this easily by doing this before doing anything else:\n\n    MathQuill = MathQuill.getInterface(1);\n    // now MathQuill.MathField() works like it used to\n\nSee also the "`dev` branch (20142015)  v0.10.0 Migration Guide" at\n  https://github.com/mathquill/mathquill/wiki/%60dev%60-branch-(2014%E2%80%932015)-%E2%86%92-v0.10.0-Migration-Guide')},h(),i},i.getInterface=j;var O=j.MIN=1,P=j.MAX=2;i.noConflict=function(){return window.MathQuill=Q,i};var Q=window.MathQuill;window.MathQuill=i;var R=x(function(a,b,c){function d(a,b){throw a=a?"'"+a+"'":"EOF","Parse Error: "+b+" at "+a}a.init=function(a){this._=a},a.parse=function(a){function b(a,b){return b}return this.skip(h)._(""+a,b,d)},a.or=function(a){e("or is passed a parser",a instanceof c);var b=this;return c(function(c,d,e){function f(b){return a._(c,d,e)}return b._(c,d,f)})},a.then=function(a){var b=this;return c(function(d,f,g){function h(b,d){var h=a instanceof c?a:a(d);return e("a parser is returned",h instanceof c),h._(b,f,g)}return b._(d,h,g)})},a.many=function(){var a=this;return c(function(b,c,d){function e(a,c){return b=a,g.push(c),!0}function f(){return!1}for(var g=[];a._(b,e,f););return c(b,g)})},a.times=function(a,b){arguments.length<2&&(b=a);var d=this;return c(function(c,e,f){function g(a,b){return k.push(b),c=a,!0}function h(a,b){return j=b,c=a,!1}function i(a,b){return!1}for(var j,k=[],l=!0,m=0;m<a;m+=1)if(!(l=d._(c,g,h)))return f(c,j);for(;m<b&&l;m+=1)l=d._(c,g,i);return e(c,k)})},a.result=function(a){return this.then(g(a))},a.atMost=function(a){return this.times(0,a)},a.atLeast=function(a){var b=this;return b.times(a).then(function(a){return b.many().map(function(b){return a.concat(b)})})},a.map=function(a){return this.then(function(b){return g(a(b))})},a.skip=function(a){return this.then(function(b){return a.result(b)})};var f=(this.string=function(a){var b=a.length,d="expected '"+a+"'";return c(function(c,e,f){var g=c.slice(0,b);return g===a?e(c.slice(b),g):f(c,d)})},this.regex=function(a){e("regexp parser is anchored","^"===a.toString().charAt(1));var b="expected "+a;return c(function(c,d,e){var f=a.exec(c);if(f){var g=f[0];return d(c.slice(g.length),g)}return e(c,b)})}),g=c.succeed=function(a){return c(function(b,c){return c(b,a)})},h=(c.fail=function(a){return c(function(b,c,d){return d(b,a)})},c.letter=f(/^[a-z]/i),c.letters=f(/^[a-z]*/i),c.digit=f(/^[0-9]/),c.digits=f(/^[0-9]*/),c.whitespace=f(/^\s+/),c.optWhitespace=f(/^\s*/),c.any=c(function(a,b,c){return a?b(a.slice(1),a.charAt(0)):c(a,"expected any character")}),c.all=c(function(a,b,c){return b("",a)}),c.eof=c(function(a,b,c){return a?c(a,"expected EOF"):b(a,a)}))}),S=function(){function b(a){var b,d=a.which||a.keyCode,e=c[d],f=[];return a.ctrlKey&&f.push("Ctrl"),a.originalEvent&&a.originalEvent.metaKey&&f.push("Meta"),a.altKey&&f.push("Alt"),a.shiftKey&&f.push("Shift"),b=e||String.fromCharCode(d),f.length||e?(f.push(b),f.join("-")):b}var c={8:"Backspace",9:"Tab",10:"Enter",13:"Enter",16:"Shift",17:"Control",18:"Alt",20:"CapsLock",27:"Esc",32:"Spacebar",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",45:"Insert",46:"Del",144:"NumLock"};return function(c,d){function e(a){u=a,clearTimeout(o),o=setTimeout(a)}function f(b){u(),u=a,clearTimeout(o),s.val(b),b&&s[0].select&&s[0].select(),v=!!b}function g(){var a=s[0];return"selectionStart"in a&&a.selectionStart!==a.selectionEnd}function h(){d.keystroke(b(p),p)}function i(b){p=b,r=null,v&&e(function(b){b&&"focusout"===b.type||!s[0].select||s[0].select(),u=a,clearTimeout(o)}),h()}function j(a){p&&r&&h(),r=a,e(k)}function k(){if(!g()){var a=s.val();1===a.length?(s.val(""),d.typedText(a)):a&&s[0].select&&s[0].select()}}function l(){p=r=null}function m(a){s.focus(),e(n)}function n(){var a=s.val();s.val(""),a&&d.paste(a)}var o,p=null,r=null,s=q(c),t=q(d.container||s),u=a;t.bind("keydown keypress input keyup focusout paste",function(a){u(a)});var v=!1;return t.bind({keydown:i,keypress:j,focusout:l,paste:m}),{select:f}}}();I.open(function(a,b){a.exportText=function(){return this.root.foldChildren("",function(a,b){return a+b.text()})}}),I.open(function(a){a.focusBlurEvents=function(){function a(){clearTimeout(c),f.selection&&f.selection.jQ.addClass("mq-blur"),b()}function b(){f.hide().parent.blur(),d.container.removeClass("mq-focused"),A(window).off("blur",a)}var c,d=this,e=d.root,f=d.cursor;d.textarea.focus(function(){d.blurred=!1,clearTimeout(c),d.container.addClass("mq-focused"),f.parent||f.insAtRightEnd(e),f.selection?(f.selection.jQ.removeClass("mq-blur"),d.selectionChanged()):f.show()}).blur(function(){d.blurred=!0,c=setTimeout(function(){e.postOrder("intentionalBlur"),f.clearSelection().endSelection(),b()}),A(window).on("blur",a)}),d.blurred=!0,f.hide().parent.blur()}}),I.open(function(a){a.keystroke=function(a,b){this.cursor.parent.keystroke(a,b,this)}}),C.open(function(a){a.keystroke=function(a,b,c){var d=c.cursor;switch(a){case"Ctrl-Shift-Backspace":case"Ctrl-Backspace":c.ctrlDeleteDir(y);break;case"Shift-Backspace":case"Backspace":c.backspace();break;case"Esc":case"Tab":return void c.escapeDir(z,a,b);case"Shift-Tab":case"Shift-Esc":return void c.escapeDir(y,a,b);case"End":c.notify("move").cursor.insAtRightEnd(d.parent);break;case"Ctrl-End":c.notify("move").cursor.insAtRightEnd(c.root);break;case"Shift-End":for(;d[z];)c.selectRight();break;case"Ctrl-Shift-End":for(;d[z]||d.parent!==c.root;)c.selectRight();break;case"Home":c.notify("move").cursor.insAtLeftEnd(d.parent);break;case"Ctrl-Home":c.notify("move").cursor.insAtLeftEnd(c.root);break;case"Shift-Home":for(;d[y];)c.selectLeft();break;case"Ctrl-Shift-Home":for(;d[y]||d.parent!==c.root;)c.selectLeft();break;case"Left":c.moveLeft();break;case"Shift-Left":c.selectLeft();break;case"Ctrl-Left":break;case"Right":c.moveRight();break;case"Shift-Right":c.selectRight();break;case"Ctrl-Right":break;case"Up":c.moveUp();break;case"Down":c.moveDown();break;case"Shift-Up":if(d[y])for(;d[y];)c.selectLeft();else c.selectLeft();case"Shift-Down":if(d[z])for(;d[z];)c.selectRight();else c.selectRight();case"Ctrl-Up":case"Ctrl-Down":break;case"Ctrl-Shift-Del":case"Ctrl-Del":c.ctrlDeleteDir(z);break;case"Shift-Del":case"Del":c.deleteForward();break;case"Meta-A":case"Ctrl-A":for(c.notify("move").cursor.insAtRightEnd(c.root);d[y];)c.selectLeft();break;default:return}b.preventDefault(),c.scrollHoriz()},a.moveOutOf=a.moveTowards=a.deleteOutOf=a.deleteTowards=a.unselectInto=a.selectOutOf=a.selectTowards=function(){e("overridden or never called on this node")}}),I.open(function(a){function b(a,b){var c=a.notify("upDown").cursor,d=b+"Into",e=b+"OutOf";return c[z][d]?c.insAtLeftEnd(c[z][d]):c[y][d]?c.insAtRightEnd(c[y][d]):c.parent.bubble(function(a){var b=a[e];if(b&&("function"==typeof b&&(b=a[e](c)),b instanceof C&&c.jumpUpDown(a,b),!0!==b))return!1}),a}this.onNotify(function(a){"move"!==a&&"upDown"!==a||this.show().clearSelection()}),a.escapeDir=function(a,b,c){f(a);var d=this.cursor;if(d.parent!==this.root&&c.preventDefault(),d.parent!==this.root)return d.parent.moveOutOf(a,d),this.notify("move")},L.leftRightIntoCmdGoes=function(a){if(a&&"up"!==a&&"down"!==a)throw'"up" or "down" required for leftRightIntoCmdGoes option, got "'+a+'"';return a},a.moveDir=function(a){f(a);var b=this.cursor,c=b.options.leftRightIntoCmdGoes;return b.selection?b.insDirOf(a,b.selection.ends[a]):b[a]?b[a].moveTowards(a,b,c):b.parent.moveOutOf(a,b,c),this.notify("move")},a.moveLeft=function(){return this.moveDir(y)},a.moveRight=function(){return this.moveDir(z)},a.moveUp=function(){return b(this,"up")},a.moveDown=function(){return b(this,"down")},this.onNotify(function(a){"upDown"!==a&&(this.upDownCache={})}),this.onNotify(function(a){"edit"===a&&this.show().deleteSelection()}),a.deleteDir=function(a){f(a);var b=this.cursor,c=b.selection;return this.notify("edit"),c||(b[a]?b[a].deleteTowards(a,b):b.parent.deleteOutOf(a,b)),b[y].siblingDeleted&&b[y].siblingDeleted(b.options,z),b[z].siblingDeleted&&b[z].siblingDeleted(b.options,y),b.parent.bubble("reflow"),this},a.ctrlDeleteDir=function(a){f(a);var b=this.cursor;return!b[y]||b.selection?ctrlr.deleteDir():(this.notify("edit"),D(b.parent.ends[y],b[y]).remove(),b.insAtDirEnd(y,b.parent),b[y].siblingDeleted&&b[y].siblingDeleted(b.options,z),b[z].siblingDeleted&&b[z].siblingDeleted(b.options,y),b.parent.bubble("reflow"),this)},a.backspace=function(){return this.deleteDir(y)},a.deleteForward=function(){return this.deleteDir(z)},this.onNotify(function(a){"select"!==a&&this.endSelection()}),a.selectDir=function(a){var b=this.notify("select").cursor,c=b.selection;f(a),b.anticursor||b.startSelection();var d=b[a];d?c&&c.ends[a]===d&&b.anticursor[-a]!==d?d.unselectInto(a,b):d.selectTowards(a,b):b.parent.selectOutOf(a,b),b.clearSelection(),b.select()||b.show()},a.selectLeft=function(){return this.selectDir(y)},a.selectRight=function(){return this.selectDir(z)}});var T=function(){function a(a){var b=Z();return a.adopt(b,0,0),b}function b(a){for(var b=a[0]||Z(),c=1;c<a.length;c+=1)a[c].children().adopt(b,b.ends[z],0);return b}var c=R.string,d=R.regex,e=R.letter,f=R.any,g=R.optWhitespace,h=R.succeed,i=R.fail,j=e.map(function(a){return fa(a)}),k=d(/^[^${}\\_^]/).map(function(a){return X(a)}),l=d(/^[^\\a-eg-zA-Z]/).or(c("\\").then(d(/^[a-z]+/i).or(d(/^\s+/).result(" ")).or(f))).then(function(a){var b=E[a];return b?b(a).parser():i("unknown command: \\"+a)}),m=l.or(j).or(k),n=c("{").then(function(){return p}).skip(c("}")),o=g.then(n.or(m.map(a))),p=o.many().map(b).skip(g),q=c("[").then(o.then(function(a){return"]"!==a.join("latex")?h(a):i()}).many().map(b).skip(g)).skip(c("]")),r=p;return r.block=o,r.optBlock=q,r}();I.open(function(a,b){a.exportLatex=function(){return this.root.latex().replace(/(\\[a-z]+) (?![a-z])/gi,"$1")},a.writeLatex=function(a){var b=this.notify("edit").cursor,c=R.all,d=R.eof,e=T.skip(d).or(c.result(!1)).parse(a);if(e&&!e.isEmpty()){e.children().adopt(b.parent,b[y],b[z]);e.jQize().insertBefore(b.jQ),b[y]=e.ends[z],e.finalizeInsert(b.options,b),e.ends[z][z].siblingCreated&&e.ends[z][z].siblingCreated(b.options,y),e.ends[y][y].siblingCreated&&e.ends[y][y].siblingCreated(b.options,z),b.parent.bubble("reflow")}return this},a.renderLatexMath=function(a){var b=this.root,c=this.cursor,d=R.all,e=R.eof,f=T.skip(e).or(d.result(!1)).parse(a);b.eachChild("postOrder","dispose"),b.ends[y]=b.ends[z]=0,f&&f.children().adopt(b,0,0);var g=b.jQ;if(f){var h=f.join("html");g.html(h),b.jQize(g.children()),b.finalizeInsert(c.options)}else g.empty();delete c.selection,c.insAtRightEnd(b)},a.renderLatexText=function(a){var b=this.root,c=this.cursor;b.jQ.children().slice(1).remove(),b.eachChild("postOrder","dispose"),b.ends[y]=b.ends[z]=0,delete c.selection,c.show().insAtRightEnd(b);var d=R.regex,e=R.string,f=R.eof,g=R.all,h=e("$").then(T).skip(e("$").or(f)).map(function(a){var b=ba(c);b.createBlocks();var d=b.ends[y];return a.children().adopt(d,0,0),b}),i=e("\\$").result("$"),j=i.or(d(/^[^$]/)).map(X),k=h.or(j).many(),l=k.skip(f).or(g.result(!1)).parse(a);if(l){for(var m=0;m<l.length;m+=1)l[m].adopt(b,b.ends[z],0);b.jQize().appendTo(b.jQ),b.finalizeInsert(c.options)}}}),I.open(function(b){K.p.ignoreNextMousedown=a,b.delegateMouseEvents=function(){var b=this.root.jQ;this.container.bind("mousedown.mathquill",function(c){function d(a){n=A(a.target)}function e(a){j.anticursor||j.startSelection(),i.seek(n,a.pageX,a.pageY).cursor.select(),n=p}function f(a){j.blink=k,j.selection||(i.editable?j.show():l.detach()),g.unbind("mousemove",d),A(a.target.ownerDocument).unbind("mousemove",e).unbind("mouseup",f)}var g=A(c.target).closest(".mq-root-block"),h=C.byId[g.attr(s)||b.attr(s)],i=h.controller,j=i.cursor,k=j.blink,l=i.textareaSpan,m=i.textarea;if(c.preventDefault(),c.target.unselectable=!0,!j.options.ignoreNextMousedown(c)){j.options.ignoreNextMousedown=a;var n;i.blurred&&(i.editable||g.prepend(l),m.focus()),j.blink=a,i.seek(A(c.target),c.pageX,c.pageY).cursor.startSelection(),g.mousemove(d),A(c.target.ownerDocument).mousemove(e).mouseup(f)}})}}),I.open(function(a){a.seek=function(a,b,c){var d=this.notify("select").cursor;if(a){var f=a.attr(s)||a.attr(r);if(!f){var g=a.parent();f=g.attr(s)||g.attr(r)}}var h=f?C.byId[f]:this.root;return e("nodeId is the id of some Node that exists",h),d.clearSelection().show(),h.seek(b,d),this.scrollHoriz(),this}}),I.open(function(a){a.scrollHoriz=function(){var a=this.cursor,b=a.selection,c=this.root.jQ[0].getBoundingClientRect();if(b){var d=b.jQ[0].getBoundingClientRect(),e=d.left-(c.left+20),f=d.right-(c.right-20);if(b.ends[y]===a[z])if(e<0)var g=e;else{if(!(f>0))return;if(d.left-f<c.left+20)var g=e;else var g=f}else if(f>0)var g=f;else{if(!(e<0))return;if(d.right-e>c.right-20)var g=f;else var g=e}}else{var h=a.jQ[0].getBoundingClientRect().left;if(h>c.right-20)var g=h-(c.right-20);else{if(!(h<c.left+20))return;var g=h-(c.left+20)}}this.root.jQ.stop().animate({scrollLeft:"+="+g},100)}}),I.open(function(a){K.p.substituteTextarea=function(){return A("<textarea autocapitalize=off autocomplete=off autocorrect=off spellcheck=false x-palm-disable-ste-all=true />")[0]},a.createTextarea=function(){var a=this.textareaSpan=A('<span class="mq-textarea"></span>'),b=this.options.substituteTextarea();if(!b.nodeType)throw"substituteTextarea() must return a DOM element, got "+b;b=this.textarea=A(b).appendTo(a);var c=this;c.cursor.selectionChanged=function(){c.selectionChanged()},c.container.bind("copy",function(){c.setTextareaSelection()})},a.selectionChanged=function(){var a=this;ua(a.container[0]),a.textareaSelectionTimeout===p&&(a.textareaSelectionTimeout=setTimeout(function(){a.setTextareaSelection()}))},a.setTextareaSelection=function(){this.textareaSelectionTimeout=p;var a="";this.cursor.selection&&(a=this.cursor.selection.join("latex"),this.options.statelessClipboard&&(a="$"+a+"$")),this.selectFn(a)},a.staticMathTextareaEvents=function(){function a(){e.detach(),b.blurred=!0}var b=this,c=(b.root,b.cursor),d=b.textarea,e=b.textareaSpan;this.container.prepend('<span class="mq-selectable">$'+b.exportLatex()+"$</span>"),b.blurred=!0,d.bind("cut paste",!1).focus(function(){b.blurred=!1}).blur(function(){c.selection&&c.selection.clear(),setTimeout(a)}),b.selectFn=function(a){d.val(a),a&&d.select()}},a.editablesTextareaEvents=function(){var a=this,b=(a.root,a.cursor),c=a.textarea,d=a.textareaSpan,e=S(c,this);this.selectFn=function(a){e.select(a)},this.container.prepend(d).on("cut",function(c){b.selection&&setTimeout(function(){a.notify("edit"),b.parent.bubble("reflow")})}),this.focusBlurEvents()},a.typedText=function(a){if("\n"===a)return this.handle("enter");var b=this.notify().cursor;b.parent.write(b,a),this.scrollHoriz()},a.paste=function(a){this.options.statelessClipboard&&(a="$"===a.slice(0,1)&&"$"===a.slice(-1)?a.slice(1,-1):"\\text{"+a+"}"),this.writeLatex(a).cursor.show()}});var U=x(C,function(a,b){a.finalizeInsert=function(a,b){var c=this;c.postOrder("finalizeTree",a),c.postOrder("contactWeld",b),c.postOrder("blur"),c.postOrder("reflow"),c[z].siblingCreated&&c[z].siblingCreated(a,y),c[y].siblingCreated&&c[y].siblingCreated(a,z),c.bubble("reflow")}}),V=x(U,function(a,b){a.init=function(a,c,d){var e=this;b.init.call(e),e.ctrlSeq||(e.ctrlSeq=a),c&&(e.htmlTemplate=c),d&&(e.textTemplate=d)},a.replaces=function(a){a.disown(),this.replacedFragment=a},a.isEmpty=function(){return this.foldChildren(!0,function(a,b){return a&&b.isEmpty()})},a.parser=function(){var a=T.block,b=this;return a.times(b.numBlocks()).map(function(a){b.blocks=a;for(var c=0;c<a.length;c+=1)a[c].adopt(b,b.ends[z],0);return b})},a.createLeftOf=function(a){var c=this,d=c.replacedFragment;c.createBlocks(),b.createLeftOf.call(c,a),d&&(d.adopt(c.ends[y],0,0),d.jQ.appendTo(c.ends[y].jQ)),c.finalizeInsert(a.options),c.placeCursor(a)},a.createBlocks=function(){for(var a=this,b=a.numBlocks(),c=a.blocks=Array(b),d=0;d<b;d+=1){(c[d]=Z()).adopt(a,a.ends[z],0)}},a.placeCursor=function(a){a.insAtRightEnd(this.foldChildren(this.ends[y],function(a,b){return a.isEmpty()?a:b}))},a.moveTowards=function(a,b,c){var d=c&&this[c+"Into"];b.insAtDirEnd(-a,d||this.ends[-a])},a.deleteTowards=function(a,b){this.isEmpty()?b[a]=this.remove()[a]:this.moveTowards(a,b,null)},a.selectTowards=function(a,b){b[-a]=this,b[a]=this[a]},a.selectChildren=function(){return H(this,this)},a.unselectInto=function(a,b){b.insAtDirEnd(-a,b.anticursor.ancestors[this.id])},a.seek=function(a,b){function c(a){var b={};return b[y]=a.jQ.offset().left,b[z]=b[y]+a.jQ.outerWidth(),b}var d=this,e=c(d);if(a<e[y])return b.insLeftOf(d);if(a>e[z])return b.insRightOf(d);var f=e[y];d.eachChild(function(g){var h=c(g);return a<h[y]?(a-f<h[y]-a?g[y]?b.insAtRightEnd(g[y]):b.insLeftOf(d):b.insAtLeftEnd(g),!1):a>h[z]?void(g[z]?f=h[z]:e[z]-a<a-h[z]?b.insRightOf(d):b.insAtRightEnd(g)):(g.seek(a,b),!1)})},a.numBlocks=function(){var a=this.htmlTemplate.match(/&\d+/g);return a?a.length:0},a.html=function(){var a=this,b=a.blocks,c=" mathquill-command-id="+a.id,d=a.htmlTemplate.match(/<[^<>]+>|[^<>]+/g);e("no unmatched angle brackets",d.join("")===this.htmlTemplate);for(var f=0,g=d[0];g;f+=1,g=d[f])if("/>"===g.slice(-2))d[f]=g.slice(0,-2)+c+"/>";else if("<"===g.charAt(0)){e("not an unmatched top-level close tag","/"!==g.charAt(1)),d[f]=g.slice(0,-1)+c+">";var h=1;do{f+=1,g=d[f],e("no missing close tags",g),"</"===g.slice(0,2)?h-=1:"<"===g.charAt(0)&&"/>"!==g.slice(-2)&&(h+=1)}while(h>0)}return d.join("").replace(/>&(\d+)/g,function(a,c){return" mathquill-block-id="+b[c].id+">"+b[c].join("html")})},a.latex=function(){return this.foldChildren(this.ctrlSeq,function(a,b){return a+"{"+(b.latex()||" ")+"}"})},a.textTemplate=[""],a.text=function(){var a=this,b=0;return a.foldChildren(a.textTemplate[b],function(c,d){b+=1;var e=d.text();return c&&"("===a.textTemplate[b]&&"("===e[0]&&")"===e.slice(-1)?c+e.slice(1,-1)+a.textTemplate[b]:c+d.text()+(a.textTemplate[b]||"")})}}),W=x(V,function(b,c){b.init=function(a,b,d){d||(d=a&&a.length>1?a.slice(1):a),c.init.call(this,a,b,[d])},b.parser=function(){return R.succeed(this)},b.numBlocks=function(){return 0},b.replaces=function(a){a.remove()},b.createBlocks=a,b.moveTowards=function(a,b){b.jQ.insDirOf(a,this.jQ),b[-a]=this,b[a]=this[a]},b.deleteTowards=function(a,b){b[a]=this.remove()[a]},b.seek=function(a,b){a-this.jQ.offset().left<this.jQ.outerWidth()/2?b.insLeftOf(this):b.insRightOf(this)},b.latex=function(){return this.ctrlSeq},b.text=function(){return this.textTemplate},b.placeCursor=a,b.isEmpty=function(){return!0}}),X=x(W,function(a,b){a.init=function(a,c){b.init.call(this,a,"<span>"+(c||a)+"</span>")}}),Y=x(W,function(a,b){a.init=function(a,c,d){b.init.call(this,a,'<span class="mq-binary-operator">'+c+"</span>",d)}}),Z=x(U,function(a,b){a.join=function(a){return this.foldChildren("",function(b,c){return b+c[a]()})},a.html=function(){return this.join("html")},a.latex=function(){return this.join("latex")},a.text=function(){return this.ends[y]===this.ends[z]&&0!==this.ends[y]?this.ends[y].text():this.join("text")},a.keystroke=function(a,c,d){return!d.options.spaceBehavesLikeTab||"Spacebar"!==a&&"Shift-Spacebar"!==a?b.keystroke.apply(this,arguments):(c.preventDefault(),void d.escapeDir("Shift-Spacebar"===a?y:z,a,c))},a.moveOutOf=function(a,b,c){c&&this.parent[c+"Into"]||!this[a]?b.insDirOf(a,this.parent):b.insAtDirEnd(-a,this[a])},a.selectOutOf=function(a,b){b.insDirOf(a,this.parent)},a.deleteOutOf=function(a,b){b.unwrapGramp()},a.seek=function(a,b){var c=this.ends[z];if(!c||c.jQ.offset().left+c.jQ.outerWidth()<a)return b.insAtRightEnd(this);if(a<this.ends[y].jQ.offset().left)return b.insAtLeftEnd(this);for(;a<c.jQ.offset().left;)c=c[y];return c.seek(a,b)},a.chToCmd=function(a){var b;return a.match(/^[a-eg-zA-Z]$/)?fa(a):/^\d$/.test(a)?da(a):(b=F[a]||E[a])?b(a):X(a)},a.write=function(a,b){var c=this.chToCmd(b);a.selection&&c.replaces(a.replaceSelection()),c.createLeftOf(a.show())},a.focus=function(){return this.jQ.addClass("mq-hasCursor"),this.jQ.removeClass("mq-empty"),this},a.blur=function(){return this.jQ.removeClass("mq-hasCursor"),this.isEmpty()&&this.jQ.addClass("mq-empty"),this}});J.StaticMath=function(a){return x(a.AbstractMathQuill,function(b,c){this.RootBlock=Z,b.__mathquillify=function(){return c.__mathquillify.call(this,"mq-math-mode"),this.__controller.delegateMouseEvents(),this.__controller.staticMathTextareaEvents(),this},b.init=function(){c.init.apply(this,arguments),this.__controller.root.postOrder("registerInnerField",this.innerFields=[],a.MathField)},b.latex=function(){var b=c.latex.apply(this,arguments);return arguments.length>0&&this.__controller.root.postOrder("registerInnerField",this.innerFields=[],a.MathField),b}})};var $=x(Z,k);J.MathField=function(b){return x(b.EditableField,function(b,c){this.RootBlock=$,b.__mathquillify=function(b,d){return this.config(b),d>1&&(this.__controller.root.reflow=a),c.__mathquillify.call(this,"mq-editable-field mq-math-mode"),delete this.__controller.root.reflow,this}})};var _=x(C,function(a,b){function c(a){a.jQ[0].normalize();var b=a.jQ[0].firstChild;if(b){e("only node in TextBlock span is Text node",3===b.nodeType);var c=aa(b.data);return c.jQadd(b),a.children().disown(),c.adopt(a,0,0)}}a.ctrlSeq="\\text",a.replaces=function(a){a instanceof D?this.replacedText=a.remove().jQ.text():"string"==typeof a&&(this.replacedText=a)},a.jQadd=function(a){b.jQadd.call(this,a),this.ends[y]&&this.ends[y].jQadd(this.jQ[0].firstChild)},a.createLeftOf=function(a){var c=this;if(b.createLeftOf.call(this,a),c[z].siblingCreated&&c[z].siblingCreated(a.options,y),c[y].siblingCreated&&c[y].siblingCreated(a.options,z),c.bubble("reflow"),a.insAtRightEnd(c),c.replacedText)for(var d=0;d<c.replacedText.length;d+=1)c.write(a,c.replacedText.charAt(d))},a.parser=function(){var a=this,b=R.string,c=R.regex;return R.optWhitespace.then(b("{")).then(c(/^[^}]*/)).skip(b("}")).map(function(b){return 0===b.length?D():(aa(b).adopt(a,0,0),a)})},a.textContents=function(){return this.foldChildren("",function(a,b){return a+b.text})},a.text=function(){return'"'+this.textContents()+'"'},a.latex=function(){var a=this.textContents();return 0===a.length?"":"\\text{"+a+"}"},a.html=function(){return'<span class="mq-text-mode" mathquill-command-id='+this.id+">"+this.textContents()+"</span>"},a.moveTowards=function(a,b){b.insAtDirEnd(-a,this)},a.moveOutOf=function(a,b){b.insDirOf(a,this)},a.unselectInto=a.moveTowards,a.selectTowards=V.prototype.selectTowards,a.deleteTowards=V.prototype.deleteTowards,a.selectOutOf=function(a,b){b.insDirOf(a,this)},a.deleteOutOf=function(a,b){this.isEmpty()&&b.insRightOf(this)},a.write=function(a,c){if(a.show().deleteSelection(),"$"!==c)a[y]?a[y].appendText(c):aa(c).createLeftOf(a);else if(this.isEmpty())a.insRightOf(this),X("\\$","$").createLeftOf(a);else if(a[z])if(a[y]){var d=_(),e=this.ends[y];e.disown().jQ.detach(),e.adopt(d,0,0),a.insLeftOf(this),b.createLeftOf.call(d,a)}else a.insLeftOf(this);else a.insRightOf(this)},a.seek=function(a,b){b.hide();var d=c(this),e=this.jQ.width()/this.text.length,f=Math.round((a-this.jQ.offset().left)/e);f<=0?b.insAtLeftEnd(this):f>=d.text.length?b.insAtRightEnd(this):b.insLeftOf(d.splitRight(f));for(var g=a-b.show().offset().left,h=g&&g<0?y:z,i=h;b[h]&&g*i>0;)b[h].moveTowards(h,b),i=g,g=a-b.offset().left;if(h*g<-h*i&&b[-h].moveTowards(-h,b),b.anticursor){if(b.anticursor.parent===this){var j=b[y]&&b[y].text.length;if(this.anticursorPosition===j)b.anticursor=B.copy(b);else{if(this.anticursorPosition<j){var k=b[y].splitRight(this.anticursorPosition);b[y]=k}else var k=b[z].splitRight(this.anticursorPosition-j);b.anticursor=B(this,k[y],k)}}}else this.anticursorPosition=b[y]&&b[y].text.length},a.blur=function(a){Z.prototype.blur.call(this),a&&(""===this.textContents()?(this.remove(),a[y]===this?a[y]=this[y]:a[z]===this&&(a[z]=this[z])):c(this))},a.focus=Z.prototype.focus}),aa=x(C,function(a,b){function c(a,b){return b.charAt(a===y?0:-1+b.length)}a.init=function(a){b.init.call(this),this.text=a},a.jQadd=function(a){this.dom=a,this.jQ=A(a)},a.jQize=function(){return this.jQadd(document.createTextNode(this.text))},a.appendText=function(a){this.text+=a,this.dom.appendData(a)},a.prependText=function(a){this.text=a+this.text,this.dom.insertData(0,a)},a.insTextAtDirEnd=function(a,b){f(b),b===z?this.appendText(a):this.prependText(a)},a.splitRight=function(a){var b=aa(this.text.slice(a)).adopt(this.parent,this,this[z]);return b.jQadd(this.dom.splitText(a)),this.text=this.text.slice(0,a),b},a.moveTowards=function(a,b){f(a);var d=c(-a,this.text),e=this[-a];return e?e.insTextAtDirEnd(d,a):aa(d).createDir(-a,b),this.deleteTowards(a,b)},a.latex=function(){return this.text},a.deleteTowards=function(a,b){this.text.length>1?a===z?(this.dom.deleteData(0,1),this.text=this.text.slice(1)):(this.dom.deleteData(-1+this.text.length,1),this.text=this.text.slice(0,-1)):(this.remove(),this.jQ.remove(),b[a]=this[a])},a.selectTowards=function(a,b){f(a);var d=b.anticursor,e=c(-a,this.text);if(d[a]===this){var g=aa(e).createDir(a,b);d[a]=g,b.insDirOf(a,g)}else{var h=this[-a];if(h)h.insTextAtDirEnd(e,a);else{var g=aa(e).createDir(-a,b);g.jQ.insDirOf(-a,b.selection.jQ)}1===this.text.length&&d[-a]===this&&(d[-a]=this[-a])}return this.deleteTowards(a,b)}});F.$=E.text=E.textnormal=E.textrm=E.textup=E.textmd=_,E.em=E.italic=E.italics=E.emph=E.textit=E.textsl=l("\\textit","i",'class="mq-text-mode"'),E.strong=E.bold=E.textbf=l("\\textbf","b",'class="mq-text-mode"'),E.sf=E.textsf=l("\\textsf","span",'class="mq-sans-serif mq-text-mode"'),E.tt=E.texttt=l("\\texttt","span",'class="mq-monospace mq-text-mode"'),E.textsc=l("\\textsc","span",'style="font-variant:small-caps" class="mq-text-mode"'),E.uppercase=l("\\uppercase","span",'style="text-transform:uppercase" class="mq-text-mode"'),E.lowercase=l("\\lowercase","span",'style="text-transform:lowercase" class="mq-text-mode"');var ba=x(V,function(a,b){a.init=function(a){b.init.call(this,"$"),this.cursor=a},a.htmlTemplate='<span class="mq-math-mode">&0</span>',a.createBlocks=function(){b.createBlocks.call(this),this.ends[y].cursor=this.cursor,this.ends[y].write=function(a,b){"$"!==b?Z.prototype.write.call(this,a,b):this.isEmpty()?(a.insRightOf(this.parent),this.parent.deleteTowards(dir,a),X("\\$","$").createLeftOf(a.show())):a[z]?a[y]?Z.prototype.write.call(this,a,b):a.insLeftOf(this.parent):a.insRightOf(this.parent)}},a.latex=function(){return"$"+this.ends[y].latex()+"$"}}),ca=x($,function(a,b){a.keystroke=function(a){if("Spacebar"!==a&&"Shift-Spacebar"!==a)return b.keystroke.apply(this,arguments)},a.write=function(a,b){if(a.show().deleteSelection(),"$"===b)ba(a).createLeftOf(a);else{var c;"<"===b?c="&lt;":">"===b&&(c="&gt;"),X(b,c).createLeftOf(a)}}});J.TextField=function(a){return x(a.EditableField,function(a,b){this.RootBlock=ca,a.__mathquillify=function(){return b.__mathquillify.call(this,"mq-editable-field mq-text-mode")},a.latex=function(a){return arguments.length>0?(this.__controller.renderLatexText(a),this.__controller.blurred&&this.__controller.cursor.hide().parent.blur(),this):this.__controller.exportLatex()}})},E.notin=E.cong=E.equiv=E.oplus=E.otimes=x(Y,function(a,b){a.init=function(a){b.init.call(this,"\\"+a+" ","&"+a+";")}}),E[""]=E.ne=E.neq=d(Y,"\\ne ","&ne;"),E.ast=E.star=E.loast=E.lowast=d(Y,"\\ast ","&lowast;"),E.therefor=E.therefore=d(Y,"\\therefore ","&there4;"),E.cuz=E.because=d(Y,"\\because ","&#8757;"),E.prop=E.propto=d(Y,"\\propto ","&prop;"),E[""]=E.asymp=E.approx=d(Y,"\\approx ","&asymp;"),E.isin=E.in=d(Y,"\\in ","&isin;"),E.ni=E.contains=d(Y,"\\ni ","&ni;"),E.notni=E.niton=E.notcontains=E.doesnotcontain=d(Y,"\\not\\ni ","&#8716;"),E.sub=E.subset=d(Y,"\\subset ","&sub;"),E.sup=E.supset=E.superset=d(Y,"\\supset ","&sup;"),E.nsub=E.notsub=E.nsubset=E.notsubset=d(Y,"\\not\\subset ","&#8836;"),E.nsup=E.notsup=E.nsupset=E.notsupset=E.nsuperset=E.notsuperset=d(Y,"\\not\\supset ","&#8837;"),E.sube=E.subeq=E.subsete=E.subseteq=d(Y,"\\subseteq ","&sube;"),E.supe=E.supeq=E.supsete=E.supseteq=E.supersete=E.superseteq=d(Y,"\\supseteq ","&supe;"),E.nsube=E.nsubeq=E.notsube=E.notsubeq=E.nsubsete=E.nsubseteq=E.notsubsete=E.notsubseteq=d(Y,"\\not\\subseteq ","&#8840;"),E.nsupe=E.nsupeq=E.notsupe=E.notsupeq=E.nsupsete=E.nsupseteq=E.notsupsete=E.notsupseteq=E.nsupersete=E.nsuperseteq=E.notsupersete=E.notsuperseteq=d(Y,"\\not\\supseteq ","&#8841;"),E.N=E.naturals=E.Naturals=d(X,"\\mathbb{N}","&#8469;"),E.P=E.primes=E.Primes=E.projective=E.Projective=E.probability=E.Probability=d(X,"\\mathbb{P}","&#8473;"),E.Z=E.integers=E.Integers=d(X,"\\mathbb{Z}","&#8484;"),E.Q=E.rationals=E.Rationals=d(X,"\\mathbb{Q}","&#8474;"),E.R=E.reals=E.Reals=d(X,"\\mathbb{R}","&#8477;"),E.C=E.complex=E.Complex=E.complexes=E.Complexes=E.complexplane=E.Complexplane=E.ComplexPlane=d(X,"\\mathbb{C}","&#8450;"),E.H=E.Hamiltonian=E.quaternions=E.Quaternions=d(X,"\\mathbb{H}","&#8461;"),E.quad=E.emsp=d(X,"\\quad ","    "),E.qquad=d(X,"\\qquad ","        "),E.diamond=d(X,"\\diamond ","&#9671;"),E.bigtriangleup=d(X,"\\bigtriangleup ","&#9651;"),E.ominus=d(X,"\\ominus ","&#8854;"),E.uplus=d(X,"\\uplus ","&#8846;"),E.bigtriangledown=d(X,"\\bigtriangledown ","&#9661;"),E.sqcap=d(X,"\\sqcap ","&#8851;"),E.triangleleft=d(X,"\\triangleleft ","&#8882;"),E.sqcup=d(X,"\\sqcup ","&#8852;"),E.triangleright=d(X,"\\triangleright ","&#8883;"),E.odot=E.circledot=d(X,"\\odot ","&#8857;"),E.bigcirc=d(X,"\\bigcirc ","&#9711;"),E.dagger=d(X,"\\dagger ","&#0134;"),E.ddagger=d(X,"\\ddagger ","&#135;"),E.wr=d(X,"\\wr ","&#8768;"),E.amalg=d(X,"\\amalg ","&#8720;"),E.models=d(X,"\\models ","&#8872;"),E.prec=d(X,"\\prec ","&#8826;"),E.succ=d(X,"\\succ ","&#8827;"),E.preceq=d(X,"\\preceq ","&#8828;"),E.succeq=d(X,"\\succeq ","&#8829;"),E.simeq=d(X,"\\simeq ","&#8771;"),E.mid=d(X,"\\mid ","&#8739;"),E.ll=d(X,"\\ll ","&#8810;"),E.gg=d(X,"\\gg ","&#8811;"),E.parallel=d(X,"\\parallel ","&#8741;"),E.nparallel=d(X,"\\nparallel ","&#8742;"),E.bowtie=d(X,"\\bowtie ","&#8904;"),E.sqsubset=d(X,"\\sqsubset ","&#8847;"),E.sqsupset=d(X,"\\sqsupset ","&#8848;"),E.smile=d(X,"\\smile ","&#8995;"),E.sqsubseteq=d(X,"\\sqsubseteq ","&#8849;"),E.sqsupseteq=d(X,"\\sqsupseteq ","&#8850;"),E.doteq=d(X,"\\doteq ","&#8784;"),E.frown=d(X,"\\frown ","&#8994;"),E.vdash=d(X,"\\vdash ","&#8870;"),E.dashv=d(X,"\\dashv ","&#8867;"),E.nless=d(X,"\\nless ","&#8814;"),E.ngtr=d(X,"\\ngtr ","&#8815;"),E.longleftarrow=d(X,"\\longleftarrow ","&#8592;"),E.longrightarrow=d(X,"\\longrightarrow ","&#8594;"),E.Longleftarrow=d(X,"\\Longleftarrow ","&#8656;"),E.Longrightarrow=d(X,"\\Longrightarrow ","&#8658;"),E.longleftrightarrow=d(X,"\\longleftrightarrow ","&#8596;"),E.updownarrow=d(X,"\\updownarrow ","&#8597;"),E.Longleftrightarrow=d(X,"\\Longleftrightarrow ","&#8660;"),E.Updownarrow=d(X,"\\Updownarrow ","&#8661;"),E.mapsto=d(X,"\\mapsto ","&#8614;"),E.nearrow=d(X,"\\nearrow ","&#8599;"),E.hookleftarrow=d(X,"\\hookleftarrow ","&#8617;"),E.hookrightarrow=d(X,"\\hookrightarrow ","&#8618;"),E.searrow=d(X,"\\searrow ","&#8600;"),E.leftharpoonup=d(X,"\\leftharpoonup ","&#8636;"),E.rightharpoonup=d(X,"\\rightharpoonup ","&#8640;"),E.swarrow=d(X,"\\swarrow ","&#8601;"),E.leftharpoondown=d(X,"\\leftharpoondown ","&#8637;"),E.rightharpoondown=d(X,"\\rightharpoondown ","&#8641;"),E.nwarrow=d(X,"\\nwarrow ","&#8598;"),E.ldots=d(X,"\\ldots ","&#8230;"),E.cdots=d(X,"\\cdots ","&#8943;"),E.vdots=d(X,"\\vdots ","&#8942;"),E.ddots=d(X,"\\ddots ","&#8945;"),E.surd=d(X,"\\surd ","&#8730;"),E.triangle=d(X,"\\triangle ","&#9651;"),E.ell=d(X,"\\ell ","&#8467;"),E.top=d(X,"\\top ","&#8868;"),E.flat=d(X,"\\flat ","&#9837;"),E.natural=d(X,"\\natural ","&#9838;"),E.sharp=d(X,"\\sharp ","&#9839;"),E.wp=d(X,"\\wp ","&#8472;"),E.bot=d(X,"\\bot ","&#8869;"),E.clubsuit=d(X,"\\clubsuit ","&#9827;"),E.diamondsuit=d(X,"\\diamondsuit ","&#9826;"),E.heartsuit=d(X,"\\heartsuit ","&#9825;"),E.spadesuit=d(X,"\\spadesuit ","&#9824;"),E.parallelogram=d(X,"\\parallelogram ","&#9649;"),E.square=d(X,"\\square ","&#11036;"),E.oint=d(X,"\\oint ","&#8750;"),E.bigcap=d(X,"\\bigcap ","&#8745;"),E.bigcup=d(X,"\\bigcup ","&#8746;"),E.bigsqcup=d(X,"\\bigsqcup ","&#8852;"),E.bigvee=d(X,"\\bigvee ","&#8744;"),E.bigwedge=d(X,"\\bigwedge ","&#8743;"),E.bigodot=d(X,"\\bigodot ","&#8857;"),E.bigotimes=d(X,"\\bigotimes ","&#8855;"),E.bigoplus=d(X,"\\bigoplus ","&#8853;"),E.biguplus=d(X,"\\biguplus ","&#8846;"),E.lfloor=d(X,"\\lfloor ","&#8970;"),E.rfloor=d(X,"\\rfloor ","&#8971;"),E.lceil=d(X,"\\lceil ","&#8968;"),E.rceil=d(X,"\\rceil ","&#8969;"),E.opencurlybrace=E.lbrace=d(X,"\\lbrace ","{"),E.closecurlybrace=E.rbrace=d(X,"\\rbrace ","}"),E.lbrack=d(X,"["),E.rbrack=d(X,"]"),E.slash=d(X,"/"),E.vert=d(X,"|"),E.perp=E.perpendicular=d(X,"\\perp ","&perp;"),E.nabla=E.del=d(X,"\\nabla ","&nabla;"),E.hbar=d(X,"\\hbar ","&#8463;"),E.AA=E.Angstrom=E.angstrom=d(X,"\\text\\AA ","&#8491;"),E.ring=E.circ=E.circle=d(X,"\\circ ","&#8728;"),E.bull=E.bullet=d(X,"\\bullet ","&bull;"),E.setminus=E.smallsetminus=d(X,"\\setminus ","&#8726;"),E.not=E[""]=E.neg=d(X,"\\neg ","&not;"),E[""]=E.dots=E.ellip=E.hellip=E.ellipsis=E.hellipsis=d(X,"\\dots ","&hellip;"),E.converges=E.darr=E.dnarr=E.dnarrow=E.downarrow=d(X,"\\downarrow ","&darr;"),E.dArr=E.dnArr=E.dnArrow=E.Downarrow=d(X,"\\Downarrow ","&dArr;"),E.diverges=E.uarr=E.uparrow=d(X,"\\uparrow ","&uarr;"),E.uArr=E.Uparrow=d(X,"\\Uparrow ","&uArr;"),E.to=d(Y,"\\to ","&rarr;"),E.rarr=E.rightarrow=d(X,"\\rightarrow ","&rarr;"),E.implies=d(Y,"\\Rightarrow ","&rArr;"),E.rArr=E.Rightarrow=d(X,"\\Rightarrow ","&rArr;"),E.gets=d(Y,"\\gets ","&larr;"),E.larr=E.leftarrow=d(X,"\\leftarrow ","&larr;"),E.impliedby=d(Y,"\\Leftarrow ","&lArr;"),E.lArr=E.Leftarrow=d(X,"\\Leftarrow ","&lArr;"),E.harr=E.lrarr=E.leftrightarrow=d(X,"\\leftrightarrow ","&harr;"),E.iff=d(Y,"\\Leftrightarrow ","&hArr;"),E.hArr=E.lrArr=E.Leftrightarrow=d(X,"\\Leftrightarrow ","&hArr;"),E.Re=E.Real=E.real=d(X,"\\Re ","&real;"),E.Im=E.imag=E.image=E.imagin=E.imaginary=E.Imaginary=d(X,"\\Im ","&image;"),E.part=E.partial=d(X,"\\partial ","&part;"),E.infty=E.infin=E.infinity=d(X,"\\infty ","&infin;"),E.alef=E.alefsym=E.aleph=E.alephsym=d(X,"\\aleph ","&alefsym;"),E.xist=E.xists=E.exist=E.exists=d(X,"\\exists ","&exist;"),E.nexists=E.nexist=d(X,"\\nexists ","&#8708;"),E.and=E.land=E.wedge=d(X,"\\wedge ","&and;"),E.or=E.lor=E.vee=d(X,"\\vee ","&or;"),E.o=E.O=E.empty=E.emptyset=E.oslash=E.Oslash=E.nothing=E.varnothing=d(Y,"\\varnothing ","&empty;"),E.cup=E.union=d(Y,"\\cup ","&cup;"),E.cap=E.intersect=E.intersection=d(Y,"\\cap ","&cap;"),E.deg=E.degree=d(X,"\\degree ","&deg;"),E.ang=E.angle=d(X,"\\angle ","&ang;"),E.measuredangle=d(X,"\\measuredangle ","&#8737;");var da=x(X,function(a,b){a.createLeftOf=function(a){a.options.autoSubscriptNumerals&&a.parent!==a.parent.parent.sub&&(a[y]instanceof ea&&!1!==a[y].isItalic||a[y]instanceof Aa&&a[y][y]instanceof ea&&!1!==a[y][y].isItalic)?(E._().createLeftOf(a),b.createLeftOf.call(this,a),a.insRightOf(a.parent.parent)):b.createLeftOf.call(this,a)}}),ea=x(W,function(a,b){a.init=function(a,c){b.init.call(this,a,"<var>"+(c||a)+"</var>")},a.text=function(){var a=this.ctrlSeq;return!this[y]||this[y]instanceof ea||this[y]instanceof Y||"\\ "===this[y].ctrlSeq||(a="*"+a),!this[z]||this[z]instanceof Y||this[z]instanceof Aa||(a+="*"),a}});K.p.autoCommands={_maxLength:0},L.autoCommands=function(a){if(!/^[a-z]+(?: [a-z]+)*$/i.test(a))throw'"'+a+'" not a space-delimited list of only letters';for(var b=a.split(" "),c={},d=0,e=0;e<b.length;e+=1){var f=b[e];if(f.length<2)throw'autocommand "'+f+'" not minimum length of 2';if(E[f]===ja)throw'"'+f+'" is a built-in operator name';c[f]=1,d=u(d,f.length)}return c._maxLength=d,c};var fa=x(ea,function(a,b){function c(a){return!a||a instanceof Y||a instanceof Ba}a.init=function(a){return b.init.call(this,this.letter=a)},a.createLeftOf=function(a){b.createLeftOf.apply(this,arguments);var c=a.options.autoCommands,d=c._maxLength;if(d>0){for(var e="",f=this,g=0;f instanceof fa&&f.ctrlSeq===f.letter&&g<d;)e=f.letter+e,f=f[y],g+=1;for(;e.length;){if(c.hasOwnProperty(e)){for(var g=1,f=this;g<e.length;g+=1,f=f[y]);return D(f,this).remove(),a[y]=f[y],E[e](e).createLeftOf(a)}e=e.slice(1)}}},a.italicize=function(a){return this.isItalic=a,this.jQ.toggleClass("mq-operator-name",!a),this},a.finalizeTree=a.siblingDeleted=a.siblingCreated=function(a,b){b!==y&&this[z]instanceof fa||this.autoUnItalicize(a)},a.autoUnItalicize=function(a){var b=a.autoOperatorNames;if(0!==b._maxLength){for(var d=this.letter,e=this[y];e instanceof fa;e=e[y])d=e.letter+d;for(var f=this[z];f instanceof fa;f=f[z])d+=f.letter;D(e[z]||this.parent.ends[y],f[y]||this.parent.ends[z]).each(function(a){a.italicize(!0).jQ.removeClass("mq-first mq-last mq-followed-by-supsub"),a.ctrlSeq=a.letter});a:for(var g=0,h=e[z]||this.parent.ends[y];g<d.length;g+=1,h=h[z])for(var i=t(b._maxLength,d.length-g);i>0;i-=1){var j=d.slice(g,g+i);if(b.hasOwnProperty(j)){for(var k=0,l=h;k<i;k+=1,l=l[z]){l.italicize(!1);var m=l}var n=ga.hasOwnProperty(j);if(h.ctrlSeq=(n?"\\":"\\operatorname{")+h.ctrlSeq,m.ctrlSeq+=n?" ":"}",ia.hasOwnProperty(j)&&m[y][y][y].jQ.addClass("mq-last"),c(h[y])||h.jQ.addClass("mq-first"),!c(m[z]))if(m[z]instanceof Aa){var o=m[z],p=o.siblingCreated=o.siblingDeleted=function(){o.jQ.toggleClass("mq-after-operator-name",!(o[z]instanceof Ga))};p()}else m.jQ.toggleClass("mq-last",!(m[z]instanceof Ga));g+=i-1,h=m;continue a}}}}}),ga={},ha=K.p.autoOperatorNames={_maxLength:9},ia={limsup:1,liminf:1,projlim:1,injlim:1};!function(){for(var a="arg deg det dim exp gcd hom inf ker lg lim ln log max min sup limsup liminf injlim projlim Pr".split(" "),b=0;b<a.length;b+=1)ga[a[b]]=ha[a[b]]=1;for(var c="sin cos tan arcsin arccos arctan sinh cosh tanh sec csc cot coth".split(" "),b=0;b<c.length;b+=1)ga[c[b]]=1;for(var d="sin cos tan sec cosec csc cotan cot ctg".split(" "),b=0;b<d.length;b+=1)ha[d[b]]=ha["arc"+d[b]]=ha[d[b]+"h"]=ha["ar"+d[b]+"h"]=ha["arc"+d[b]+"h"]=1;for(var e="gcf hcf lcm proj span".split(" "),b=0;b<e.length;b+=1)ha[e[b]]=1}(),L.autoOperatorNames=function(a){if(!/^[a-z]+(?: [a-z]+)*$/i.test(a))throw'"'+a+'" not a space-delimited list of only letters';for(var b=a.split(" "),c={},d=0,e=0;e<b.length;e+=1){var f=b[e];if(f.length<2)throw'"'+f+'" not minimum length of 2';c[f]=1,d=u(d,f.length)}return c._maxLength=d,c};var ja=x(W,function(a,b){a.init=function(a){this.ctrlSeq=a},a.createLeftOf=function(a){for(var b=this.ctrlSeq,c=0;c<b.length;c+=1)fa(b.charAt(c)).createLeftOf(a)},a.parser=function(){for(var a=this.ctrlSeq,b=Z(),c=0;c<a.length;c+=1)fa(a.charAt(c)).adopt(b,b.ends[z],0);return R.succeed(b.children())}});for(var ka in ha)ha.hasOwnProperty(ka)&&(E[ka]=ja);E.operatorname=x(V,function(b){b.createLeftOf=a,b.numBlocks=function(){return 1},b.parser=function(){return T.block.map(function(a){return a.children()})}}),E.f=x(fa,function(a,b){a.init=function(){W.p.init.call(this,this.letter="f",'<var class="mq-f">f</var>')},a.italicize=function(a){return this.jQ.html("f").toggleClass("mq-f",a),b.italicize.apply(this,arguments)}}),E[" "]=E.space=d(X,"\\ ","&nbsp;"),E["'"]=E.prime=d(X,"'","&prime;"),E.backslash=d(X,"\\backslash ","\\"),F["\\"]||(F["\\"]=E.backslash),E.$=d(X,"\\$","$");var la=x(W,function(a,b){a.init=function(a,c){b.init.call(this,a,'<span class="mq-nonSymbola">'+(c||a)+"</span>")}});E["@"]=la,E["&"]=d(la,"\\&","&amp;"),E["%"]=d(la,"\\%","%"),E.alpha=E.beta=E.gamma=E.delta=E.zeta=E.eta=E.theta=E.iota=E.kappa=E.mu=E.nu=E.xi=E.rho=E.sigma=E.tau=E.chi=E.psi=E.omega=x(ea,function(a,b){a.init=function(a){b.init.call(this,"\\"+a+" ","&"+a+";")}}),E.phi=d(ea,"\\phi ","&#981;"),E.phiv=E.varphi=d(ea,"\\varphi ","&phi;"),E.epsilon=d(ea,"\\epsilon ","&#1013;"),E.epsiv=E.varepsilon=d(ea,"\\varepsilon ","&epsilon;"),E.piv=E.varpi=d(ea,"\\varpi ","&piv;"),E.sigmaf=E.sigmav=E.varsigma=d(ea,"\\varsigma ","&sigmaf;"),E.thetav=E.vartheta=E.thetasym=d(ea,"\\vartheta ","&thetasym;"),E.upsilon=E.upsi=d(ea,"\\upsilon ","&upsilon;"),E.gammad=E.Gammad=E.digamma=d(ea,"\\digamma ","&#989;"),E.kappav=E.varkappa=d(ea,"\\varkappa ","&#1008;"),E.rhov=E.varrho=d(ea,"\\varrho ","&#1009;"),E.pi=E[""]=d(la,"\\pi ","&pi;"),E.lambda=d(la,"\\lambda ","&lambda;"),E.Upsilon=E.Upsi=E.upsih=E.Upsih=d(W,"\\Upsilon ",'<var style="font-family: serif">&upsih;</var>'),E.Gamma=E.Delta=E.Theta=E.Lambda=E.Xi=E.Pi=E.Sigma=E.Phi=E.Psi=E.Omega=E.forall=x(X,function(a,b){a.init=function(a){b.init.call(this,"\\"+a+" ","&"+a+";")}});var ma=x(V,function(a){a.init=function(a){this.latex=a},a.createLeftOf=function(a){var b=T.parse(this.latex);b.children().adopt(a.parent,a[y],a[z]),a[y]=b.ends[z],b.jQize().insertBefore(a.jQ),b.finalizeInsert(a.options,a),b.ends[z][z].siblingCreated&&b.ends[z][z].siblingCreated(a.options,y),b.ends[y][y].siblingCreated&&b.ends[y][y].siblingCreated(a.options,z),a.parent.bubble("reflow")},a.parser=function(){var a=T.parse(this.latex).children();return R.succeed(a)}});E[""]=d(ma,"^1"),E[""]=d(ma,"^2"),E[""]=d(ma,"^3"),E[""]=d(ma,"\\frac14"),E[""]=d(ma,"\\frac12"),E[""]=d(ma,"\\frac34");var na=x(Y,function(a){a.init=X.prototype.init,a.contactWeld=a.siblingCreated=a.siblingDeleted=function(a,b){if(b!==z)return this.jQ[0].className=!this[y]||this[y]instanceof Y||/^[,;:\(\[]$/.test(this[y].ctrlSeq)?"":"mq-binary-operator",this}});E["+"]=d(na,"+","+"),E[""]=E["-"]=d(na,"-","&minus;"),E[""]=E.pm=E.plusmn=E.plusminus=d(na,"\\pm ","&plusmn;"),E.mp=E.mnplus=E.minusplus=d(na,"\\mp ","&#8723;"),F["*"]=E.sdot=E.cdot=d(Y,"\\cdot ","&middot;","*");var oa=x(Y,function(a,b){a.init=function(a,c){this.data=a,this.strict=c;var d=c?"Strict":"";b.init.call(this,a["ctrlSeq"+d],a["html"+d],a["text"+d])},a.swap=function(a){this.strict=a;var b=a?"Strict":"";this.ctrlSeq=this.data["ctrlSeq"+b],this.jQ.html(this.data["html"+b]),this.textTemplate=[this.data["text"+b]]},a.deleteTowards=function(a,c){if(a===y&&!this.strict)return this.swap(!0),void this.bubble("reflow");b.deleteTowards.apply(this,arguments)}}),pa={ctrlSeq:"\\le ",html:"&le;",text:"",ctrlSeqStrict:"<",htmlStrict:"&lt;",textStrict:"<"},qa={ctrlSeq:"\\ge ",html:"&ge;",text:"",ctrlSeqStrict:">",htmlStrict:"&gt;",textStrict:">"};E["<"]=E.lt=d(oa,pa,!0),E[">"]=E.gt=d(oa,qa,!0),E[""]=E.le=E.leq=d(oa,pa,!1),E[""]=E.ge=E.geq=d(oa,qa,!1);var ra=x(Y,function(a,b){a.init=function(){b.init.call(this,"=","=")},a.createLeftOf=function(a){if(a[y]instanceof oa&&a[y].strict)return a[y].swap(!1),void a[y].bubble("reflow");b.createLeftOf.apply(this,arguments)}});E["="]=ra,E[""]=E.times=d(Y,"\\times ","&times;","[x]"),E[""]=E.div=E.divide=E.divides=d(Y,"\\div ","&divide;","[/]"),F["~"]=E.sim=d(Y,"\\sim ","~","~");var sa,ta,ua=a,va=document.createElement("div"),wa=va.style,xa={transform:1,WebkitTransform:1,MozTransform:1,OTransform:1,msTransform:1};for(var ya in xa)if(ya in wa){ta=ya;break}ta?sa=function(a,b,c){a.css(ta,"scale("+b+","+c+")")}:"filter"in wa?(ua=function(a){a.className=a.className},sa=function(a,b,c){function d(){a.css("marginRight",(e.width()-1)*(b-1)/b+"px")}b/=1+(c-1)/2,a.css("fontSize",c+"em"),a.hasClass("mq-matrixed-container")||a.addClass("mq-matrixed-container").wrapInner('<span class="mq-matrixed"></span>');var e=a.children().css("filter","progid:DXImageTransform.Microsoft.Matrix(M11="+b+",SizingMethod='auto expand')");d();var f=setInterval(d);A(window).load(function(){clearTimeout(f),d()})}):sa=function(a,b,c){a.css("fontSize",c+"em")};var za=x(V,function(a,b){a.init=function(a,c,d){b.init.call(this,a,"<"+c+" "+d+">&0</"+c+">")}});E.mathrm=d(za,"\\mathrm","span",'class="mq-roman mq-font"'),E.mathit=d(za,"\\mathit","i",'class="mq-font"'),E.mathbf=d(za,"\\mathbf","b",'class="mq-font"'),E.mathsf=d(za,"\\mathsf","span",'class="mq-sans-serif mq-font"'),E.mathtt=d(za,"\\mathtt","span",'class="mq-monospace mq-font"'),E.underline=d(za,"\\underline","span",'class="mq-non-leaf mq-underline"'),E.overline=E.bar=d(za,"\\overline","span",'class="mq-non-leaf mq-overline"'),E.overrightarrow=d(za,"\\overrightarrow","span",'class="mq-non-leaf mq-overarrow mq-arrow-right"'),E.overleftarrow=d(za,"\\overleftarrow","span",'class="mq-non-leaf mq-overarrow mq-arrow-left"');var Aa=(E.textcolor=x(V,function(a,b){a.setColor=function(a){this.color=a,this.htmlTemplate='<span class="mq-textcolor" style="color:'+a+'">&0</span>'},a.latex=function(){return"\\textcolor{"+this.color+"}{"+this.blocks[0].latex()+"}"},a.parser=function(){var a=this,c=R.optWhitespace,d=R.string,e=R.regex;return c.then(d("{")).then(e(/^[#\w\s.,()%-]*/)).skip(d("}")).then(function(c){return a.setColor(c),b.parser.call(a)})}}),E.class=x(V,function(a,b){a.parser=function(){var a=this,c=R.string,d=R.regex;return R.optWhitespace.then(c("{")).then(d(/^[-\w\s\\\xA0-\xFF]*/)).skip(c("}")).then(function(c){return a.htmlTemplate='<span class="mq-class '+c+'">&0</span>',b.parser.call(a)})}}),x(V,function(a,b){a.ctrlSeq="_{...}^{...}",a.createLeftOf=function(a){if(a[y]||!a.options.supSubsRequireOperand)return b.createLeftOf.apply(this,arguments)},a.contactWeld=function(a){for(var b=y;b;b=b===y&&z)if(this[b]instanceof Aa){for(var c="sub";c;c="sub"===c&&"sup"){var d=this[c],e=this[b][c];if(d){if(e)if(d.isEmpty())var f=B(e,0,e.ends[y]);else{d.jQ.children().insAtDirEnd(-b,e.jQ);var g=d.children().disown(),f=B(e,g.ends[z],e.ends[y]);b===y?g.adopt(e,e.ends[z],0):g.adopt(e,0,e.ends[y])}else this[b].addBlock(d.disown());this.placeCursor=function(a,c){return function(d){d.insAtDirEnd(-b,a||c)}}(e,d)}}this.remove(),a&&a[y]===this&&(b===z&&f?f[y]?a.insRightOf(f[y]):a.insAtLeftEnd(f.parent):a.insRightOf(this[b]));break}},K.p.charsThatBreakOutOfSupSub="",a.finalizeTree=function(){this.ends[y].write=function(a,b){if(a.options.autoSubscriptNumerals&&this===this.parent.sub){if("_"===b)return;var c=this.chToCmd(b);return c instanceof W?a.deleteSelection():a.clearSelection().insRightOf(this.parent),c.createLeftOf(a.show())}a[y]&&!a[z]&&!a.selection&&a.options.charsThatBreakOutOfSupSub.indexOf(b)>-1&&a.insRightOf(this.parent),Z.p.write.apply(this,arguments)}},a.moveTowards=function(a,c,d){c.options.autoSubscriptNumerals&&!this.sup?c.insDirOf(a,this):b.moveTowards.apply(this,arguments)},a.deleteTowards=function(a,c){if(c.options.autoSubscriptNumerals&&this.sub){var d=this.sub.ends[-a];d instanceof W?d.remove():d&&d.deleteTowards(a,c.insAtDirEnd(-a,this.sub)),this.sub.isEmpty()&&(this.sub.deleteOutOf(y,c.insAtLeftEnd(this.sub)),this.sup&&c.insDirOf(-a,this))}else b.deleteTowards.apply(this,arguments)},a.latex=function(){function a(a,b){var c=b&&b.latex();return b?a+(1===c.length?c:"{"+(c||" ")+"}"):""}return a("_",this.sub)+a("^",this.sup)},a.addBlock=function(a){"sub"===this.supsub?(this.sup=this.upInto=this.sub.upOutOf=a,a.adopt(this,this.sub,0).downOutOf=this.sub,a.jQ=A('<span class="mq-sup"/>').append(a.jQ.children()).attr(s,a.id).prependTo(this.jQ)):(this.sub=this.downInto=this.sup.downOutOf=a,a.adopt(this,0,this.sup).upOutOf=this.sup,a.jQ=A('<span class="mq-sub"></span>').append(a.jQ.children()).attr(s,a.id).appendTo(this.jQ.removeClass("mq-sup-only")),this.jQ.append('<span style="display:inline-block;width:0">&#8203;</span>'));for(var b=0;b<2;b+=1)!function(a,b,c,d){a[b].deleteOutOf=function(e,f){if(f.insDirOf(this[e]?-e:e,this.parent),!this.isEmpty()){var g=this.ends[e];this.children().disown().withDirAdopt(e,f.parent,f[e],f[-e]).jQ.insDirOf(-e,f.jQ),f[-e]=g}a.supsub=c,delete a[b],delete a[d+"Into"],a[c][d+"OutOf"]=m,delete a[c].deleteOutOf,"sub"===b&&A(a.jQ.addClass("mq-sup-only")[0].lastChild).remove(),this.remove()}}(this,"sub sup".split(" ")[b],"sup sub".split(" ")[b],"down up".split(" ")[b])}}));E.subscript=E._=x(Aa,function(a,b){a.supsub="sub",a.htmlTemplate='<span class="mq-supsub mq-non-leaf"><span class="mq-sub">&0</span><span style="display:inline-block;width:0">&#8203;</span></span>',a.textTemplate=["_"],a.finalizeTree=function(){this.downInto=this.sub=this.ends[y],this.sub.upOutOf=m,b.finalizeTree.call(this)}}),E.superscript=E.supscript=E["^"]=x(Aa,function(a,b){a.supsub="sup",a.htmlTemplate='<span class="mq-supsub mq-non-leaf mq-sup-only"><span class="mq-sup">&0</span></span>',a.textTemplate=["^"],a.finalizeTree=function(){this.upInto=this.sup=this.ends[z],this.sup.downOutOf=m,b.finalizeTree.call(this)}});var Ba=x(V,function(a,b){a.init=function(a,b){var c='<span class="mq-large-operator mq-non-leaf"><span class="mq-to"><span>&1</span></span><big>'+b+'</big><span class="mq-from"><span>&0</span></span></span>';W.prototype.init.call(this,a,c)},a.createLeftOf=function(a){b.createLeftOf.apply(this,arguments),a.options.sumStartsWithNEquals&&(fa("n").createLeftOf(a),ra().createLeftOf(a))},a.latex=function(){function a(a){return 1===a.length?a:"{"+(a||" ")+"}"}return this.ctrlSeq+"_"+a(this.ends[y].latex())+"^"+a(this.ends[z].latex())},a.parser=function(){for(var a=R.string,b=R.optWhitespace,c=R.succeed,d=T.block,e=this,f=e.blocks=[Z(),Z()],g=0;g<f.length;g+=1)f[g].adopt(e,e.ends[z],0);return b.then(a("_").or(a("^"))).then(function(a){var b=f["_"===a?0:1];return d.then(function(a){return a.children().adopt(b,b.ends[z],0),c(e)})}).many().result(e)},a.finalizeTree=function(){this.downInto=this.ends[y],this.upInto=this.ends[z],this.ends[y].upOutOf=this.ends[z],this.ends[z].downOutOf=this.ends[y]}});E[""]=E.sum=E.summation=d(Ba,"\\sum ","&sum;"),E[""]=E.prod=E.product=d(Ba,"\\prod ","&prod;"),E.coprod=E.coproduct=d(Ba,"\\coprod ","&#8720;"),E[""]=E.int=E.integral=x(Ba,function(a,b){a.init=function(){W.prototype.init.call(this,"\\int ",'<span class="mq-int mq-non-leaf"><big>&int;</big><span class="mq-supsub mq-non-leaf"><span class="mq-sup"><span class="mq-sup-inner">&1</span></span><span class="mq-sub">&0</span><span style="display:inline-block;width:0">&#8203</span></span></span>')},a.createLeftOf=V.p.createLeftOf});var Ca=E.frac=E.dfrac=E.cfrac=E.fraction=x(V,function(a,b){a.ctrlSeq="\\frac",a.htmlTemplate='<span class="mq-fraction mq-non-leaf"><span class="mq-numerator">&0</span><span class="mq-denominator">&1</span><span style="display:inline-block;width:0">&#8203;</span></span>',a.textTemplate=["(",")/(",")"],a.finalizeTree=function(){this.upInto=this.ends[z].upOutOf=this.ends[y],this.downInto=this.ends[y].downOutOf=this.ends[z]}}),Da=E.over=F["/"]=x(Ca,function(b,c){b.createLeftOf=function(b){if(!this.replacedFragment){for(var d=b[y];d&&!(d instanceof Y||d instanceof(E.text||a)||d instanceof Ba||"\\ "===d.ctrlSeq||/^[,;:]$/.test(d.ctrlSeq));)d=d[y];d instanceof Ba&&d[z]instanceof Aa&&(d=d[z],d[z]instanceof Aa&&d[z].ctrlSeq!=d.ctrlSeq&&(d=d[z])),d!==b[y]&&(this.replaces(D(d[z]||b.parent.ends[y],b[y])),b[y]=d)}c.createLeftOf.call(this,b)}}),Ea=E.sqrt=E[""]=x(V,function(a,b){a.ctrlSeq="\\sqrt",a.htmlTemplate='<span class="mq-non-leaf"><span class="mq-scaled mq-sqrt-prefix">&radic;</span><span class="mq-non-leaf mq-sqrt-stem">&0</span></span>',a.textTemplate=["sqrt(",")"],a.parser=function(){return T.optBlock.then(function(a){return T.block.map(function(b){var c=Fa();return c.blocks=[a,b],a.adopt(c,0,0),b.adopt(c,a,0),c})}).or(b.parser.call(this))},a.reflow=function(){var a=this.ends[z].jQ;sa(a.prev(),1,a.innerHeight()/+a.css("fontSize").slice(0,-2)-.1)}}),Fa=(E.vec=x(V,function(a,b){a.ctrlSeq="\\vec",a.htmlTemplate='<span class="mq-non-leaf"><span class="mq-vector-prefix">&rarr;</span><span class="mq-vector-stem">&0</span></span>',a.textTemplate=["vec(",")"]}),E.nthroot=x(Ea,function(a,b){a.htmlTemplate='<sup class="mq-nthroot mq-non-leaf">&0</sup><span class="mq-scaled"><span class="mq-sqrt-prefix mq-scaled">&radic;</span><span class="mq-sqrt-stem mq-non-leaf">&1</span></span>',a.textTemplate=["sqrt[","](",")"],a.latex=function(){return"\\sqrt["+this.ends[y].latex()+"]{"+this.ends[z].latex()+"}"}})),Ga=x(x(V,n),function(b,c){b.init=function(a,b,d,e,f){c.init.call(this,"\\left"+e,p,[b,d]),this.side=a,this.sides={},this.sides[y]={ch:b,ctrlSeq:e},this.sides[z]={ch:d,ctrlSeq:f}},b.numBlocks=function(){return 1},b.html=function(){return this.htmlTemplate='<span class="mq-non-leaf"><span class="mq-scaled mq-paren'+(this.side===z?" mq-ghost":"")+'">'+this.sides[y].ch+'</span><span class="mq-non-leaf">&0</span><span class="mq-scaled mq-paren'+(this.side===y?" mq-ghost":"")+'">'+this.sides[z].ch+"</span></span>",c.html.call(this)},b.latex=function(){return"\\left"+this.sides[y].ctrlSeq+this.ends[y].latex()+"\\right"+this.sides[z].ctrlSeq},b.oppBrack=function(a,b,c){return b instanceof Ga&&b.side&&b.side!==-c&&("|"===this.sides[this.side].ch||b.side===-this.side)&&(!a.restrictMismatchedBrackets||Ha[this.sides[this.side].ch]===b.sides[b.side].ch||{"(":"]","[":")"}[this.sides[y].ch]===b.sides[z].ch)&&b},b.closeOpposing=function(a){a.side=0,a.sides[this.side]=this.sides[this.side],a.delimjQs.eq(this.side===y?0:1).removeClass("mq-ghost").html(this.sides[this.side].ch)},b.createLeftOf=function(a){if(!this.replacedFragment)var b=a.options,d=this.oppBrack(b,a[y],y)||this.oppBrack(b,a[z],z)||this.oppBrack(b,a.parent.parent);if(d){var e=this.side=-d.side;this.closeOpposing(d),d===a.parent.parent&&a[e]&&(D(a[e],a.parent.ends[e],-e).disown().withDirAdopt(-e,d.parent,d,d[e]).jQ.insDirOf(e,d.jQ),d.bubble("reflow"))}else d=this,e=d.side,d.replacedFragment?d.side=0:a[-e]&&(d.replaces(D(a[-e],a.parent.ends[-e],e)),a[-e]=0),c.createLeftOf.call(d,a);e===y?a.insAtLeftEnd(d.ends[y]):a.insRightOf(d)},b.placeCursor=a,b.unwrap=function(){this.ends[y].children().disown().adopt(this.parent,this,this[z]).jQ.insertAfter(this.jQ),this.remove()},b.deleteSide=function(a,b,c){var d=this.parent,e=this[a],f=d.ends[a];if(a===this.side)return this.unwrap(),void(e?c.insDirOf(-a,e):c.insAtDirEnd(a,d));var g=c.options,h=!this.side;if(this.side=-a,this.oppBrack(g,this.ends[y].ends[this.side],a)){this.closeOpposing(this.ends[y].ends[this.side]);var i=this.ends[y].ends[a];this.unwrap(),i.siblingCreated&&i.siblingCreated(c.options,a),e?c.insDirOf(-a,e):c.insAtDirEnd(a,d)}else{if(this.oppBrack(g,this.parent.parent,a))this.parent.parent.closeOpposing(this),this.parent.parent.unwrap();else{if(b&&h)return this.unwrap(),void(e?c.insDirOf(-a,e):c.insAtDirEnd(a,d));this.sides[a]={ch:Ha[this.sides[this.side].ch],ctrlSeq:Ha[this.sides[this.side].ctrlSeq]},this.delimjQs.removeClass("mq-ghost").eq(a===y?0:1).addClass("mq-ghost").html(this.sides[a].ch)}if(e){var i=this.ends[y].ends[a];D(e,f,-a).disown().withDirAdopt(-a,this.ends[y],i,0).jQ.insAtDirEnd(a,this.ends[y].jQ.removeClass("mq-empty")),i.siblingCreated&&i.siblingCreated(c.options,a),c.insDirOf(-a,e)}else b?c.insDirOf(a,this):c.insAtDirEnd(a,this.ends[y])}},b.deleteTowards=function(a,b){this.deleteSide(-a,!1,b)},b.finalizeTree=function(){this.ends[y].deleteOutOf=function(a,b){this.parent.deleteSide(a,!0,b)},this.finalizeTree=this.intentionalBlur=function(){this.delimjQs.eq(this.side===y?1:0).removeClass("mq-ghost"),this.side=0}},b.siblingCreated=function(a,b){b===-this.side&&this.finalizeTree()}}),Ha={"(":")",")":"(","[":"]","]":"[","{":"}","}":"{","\\{":"\\}","\\}":"\\{","&lang;":"&rang;","&rang;":"&lang;","\\langle ":"\\rangle ","\\rangle ":"\\langle ","|":"|"};o("("),o("["),o("{","\\{"),E.langle=d(Ga,y,"&lang;","&rang;","\\langle ","\\rangle "),E.rangle=d(Ga,z,"&lang;","&rang;","\\langle ","\\rangle "),F["|"]=d(Ga,y,"|","|","|","|"),E.left=x(V,function(a){a.parser=function(){var a=R.regex,b=R.string,c=(R.succeed,R.optWhitespace);return c.then(a(/^(?:[([|]|\\\{)/)).then(function(d){var e="\\"===d.charAt(0)?d.slice(1):d;return T.then(function(f){return b("\\right").skip(c).then(a(/^(?:[\])|]|\\\})/)).map(function(a){var b="\\"===a.charAt(0)?a.slice(1):a,c=Ga(0,e,b,d,a);return c.blocks=[f],f.adopt(c,0,0),c})})})}}),E.right=x(V,function(a){a.parser=function(){return R.fail("unmatched \\right")}});var Ia=E.binom=E.binomial=x(x(V,n),function(a,b){a.ctrlSeq="\\binom",a.htmlTemplate='<span class="mq-non-leaf"><span class="mq-paren mq-scaled">(</span><span class="mq-non-leaf"><span class="mq-array mq-non-leaf"><span>&0</span><span>&1</span></span></span><span class="mq-paren mq-scaled">)</span></span>',a.textTemplate=["choose(",",",")"]});E.choose=x(Ia,function(a){a.createLeftOf=Da.prototype.createLeftOf});E.editable=E.MathQuillMathField=x(V,function(a,b){a.ctrlSeq="\\MathQuillMathField",a.htmlTemplate='<span class="mq-editable-field"><span class="mq-root-block">&0</span></span>',a.parser=function(){var a=this,c=R.string,d=R.regex,e=R.succeed;return c("[").then(d(/^[a-z][a-z0-9]*/i)).skip(c("]")).map(function(b){a.name=b}).or(e()).then(b.parser.call(a))},a.finalizeTree=function(){var a=I(this.ends[y],this.jQ,K());a.KIND_OF_MQ="MathField",a.editable=!0,a.createTextarea(),a.editablesTextareaEvents(),a.cursor.insAtRightEnd(a.root),k(a.root)},a.registerInnerField=function(a,b){a.push(a[this.name]=b(this.ends[y].controller))},a.latex=function(){return this.ends[y].latex()},a.text=function(){return this.ends[y].text()}});var Ja=E.embed=x(W,function(a,b){a.setOptions=function(a){function b(){return""}return this.text=a.text||b,this.htmlTemplate=a.htmlString||"",this.latex=a.latex||b,this},a.parser=function(){var a=this;return string=R.string,regex=R.regex,succeed=R.succeed,string("{").then(regex(/^[a-z][a-z0-9]*/i)).skip(string("}")).then(function(b){return string("[").then(regex(/^[-\w\s]*/)).skip(string("]")).or(succeed()).map(function(c){return a.setOptions(N[b](c))})})}}),Ka=(F["\\"]=x(V,function(a,b){a.ctrlSeq="\\",a.replaces=function(a){this._replacedFragment=a.disown(),this.isEmpty=function(){return!1}},a.htmlTemplate='<span class="mq-latex-command-input mq-non-leaf">\\<span>&0</span></span>',a.textTemplate=["\\"],a.createBlocks=function(){b.createBlocks.call(this),this.ends[y].focus=function(){return this.parent.jQ.addClass("mq-hasCursor"),this.isEmpty()&&this.parent.jQ.removeClass("mq-empty"),this},this.ends[y].blur=function(){return this.parent.jQ.removeClass("mq-hasCursor"),this.isEmpty()&&this.parent.jQ.addClass("mq-empty"),this},this.ends[y].write=function(a,b){a.show().deleteSelection(),b.match(/[a-z]/i)?X(b).createLeftOf(a):(this.parent.renderCommand(a),"\\"===b&&this.isEmpty()||this.parent.parent.write(a,b))},this.ends[y].keystroke=function(a,c,d){return"Tab"===a||"Enter"===a||"Spacebar"===a?(this.parent.renderCommand(d.cursor),void c.preventDefault()):b.keystroke.apply(this,arguments)}},a.createLeftOf=function(a){if(b.createLeftOf.call(this,a),this._replacedFragment){var c=this.jQ[0];this.jQ=this._replacedFragment.jQ.addClass("mq-blur").bind("mousedown mousemove",function(a){return A(a.target=c).trigger(a),!1}).insertBefore(this.jQ).add(this.jQ)}},a.latex=function(){return"\\"+this.ends[y].latex()+" "},a.renderCommand=function(a){this.jQ=this.jQ.last(),this.remove(),this[z]?a.insLeftOf(this[z]):a.insAtRightEnd(this.parent);var b=this.ends[y].latex();b||(b=" ");var c=E[b];c?(c=c(b),this._replacedFragment&&c.replaces(this._replacedFragment),c.createLeftOf(a)):(c=_(),c.replaces(b),c.createLeftOf(a),a.insRightOf(c),this._replacedFragment&&this._replacedFragment.remove())}}),j(1));for(var La in Ka)!function(a,b){"function"==typeof b?(i[a]=function(){return h(),b.apply(this,arguments)},i[a].prototype=b.prototype):i[a]=b}(La,Ka[La])}(),c.exports}),a.register("1",["7","28","1a","2a","2b","2d"],function(a,c){"use strict";function d(a,b){var c=b.prototype;b.prototype=Object.create(a.prototype);for(var d in c)b.prototype[d]=c[d];b.prototype.constructor=b,Object.defineProperty(b.prototype,"constructor",{enumerable:!1,value:b})}function e(a,b){for(var c=0;c<a.length;c++)if(b(a[c],c,a))return a[c]}function f(a,b){for(var c=0;c<a.length;c++)if(b(a[c],c,a))return c;return-1}function g(a){var b=RegExp("(&|\\?)"+encodeURIComponent(a)+"=(.+?)(&|$)").exec(location.search);return b?decodeURIComponent(b[2]):null}function h(){var a={};return""===location.search?a:(location.search.substr(1).split("&").forEach(function(b){var c=b.split("=");a[decodeURIComponent(c[0])]=decodeURIComponent(c[1])}),a)}function i(a){for(var b=a.length,c=a.length-1;c>=0;c--){var d=a.charCodeAt(c);d>127&&d<=2047?b++:d>2047&&d<=65535&&(b+=2),d>=56320&&d<=57343&&c--}return b}function j(a){var b=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],c={roots_as_powers:!0,bracketed_negatives:!0,subscripts_as_long_names:!0,var_subscripts_only:!0,rationalize_reals:!0,greek_symbols_to_latex:!0,absval_as_fn:!0,quote_placeholders:!0};return b.eval_to_real&&(c.rationalize_reals=!1,c.integers_as_reals=!0),Array.isArray(a)||(a=[a]),_c.is_range(a)&&a[0].is_group("div","mul")?a.map(function(a){return a.children[1].to_ascii(c)}).join("*"):a.map(function(a){return a.to_ascii(c)}).join("")}function k(a,b){a&&!Array.isArray(a)&&(a=[a]);var c=a.length;a.forEach(function(a,d){var e=document.createElement("script");e.type="text/javascript",b&&d===c-1&&(e.readyState?e.onreadystatechange=function(){"loaded"!=e.readyState&&"complete"!=e.readyState||(e.onreadystatechange=null,b&&b())}:e.onload=function(){b&&b()}),e.src=a,e.async=!1,document.head.appendChild(e)})}function l(){var a={};return"undefined"!=typeof Error&&Error.captureStackTrace&&Error.captureStackTrace(a),a.stack}function m(a){var b=new RegExp("^\\s*([0-9]*\\.?[0-9]+([eE][-+]?[0-9]+)?)"),c=new RegExp("^\\s*\\{(\\??[A-Za-z0-9_]*)\\:"),d=new RegExp("^\\s*(sin|cos|tan|log|ln|sqrt)"),e=new RegExp("^\\s*([a-zA-Z])"),f=new RegExp("^\\s*([--])"),g=new RegExp('^\\s*"([^"]+)"'),h=new RegExp("^\\s*\\\\text{(.*?)}"),i=new RegExp("^\\s*(>=|<=|\\*\\*|[-\\+*/=><();,^\\{\\}\\[\\]\\|_:])"),j=new RegExp("^\\s*(\\\\[^A-Za-z0-9\\s]|\\\\[A-Za-z]+)"),k=new RegExp("^(\\s+)"),l=[],m=0;a&&(m=a.length);for(var n=0;n<m;){var o,p=a.substr(n);if(o=b.exec(p))l.push({type:"number",value:parseFloat(o[1]),from:n+(o[0].length-o[1].length),to:n+o[0].length}),n+=o[0].length;else if(o=c.exec(p))l.push({type:"operator",value:"{",from:n,to:n+1}),l.push({type:"name",value:o[1],from:n+1,to:n+o[1].length+1}),l.push({type:"operator",value:":",from:n+o[0].length-1,to:n+o[0].length}),n+=o[0].length;else if(o=d.exec(p))l.push({type:"operator",value:o[1],from:n+(o[0].length-o[1].length),to:n+o[0].length}),n+=o[0].length;else if(o=e.exec(p))l.push({type:"name",value:o[1],from:n+(o[0].length-o[1].length),to:n+o[0].length}),n+=o[0].length;else if(o=f.exec(p))l.push({type:"name",value:o[1],from:n+(o[0].length-o[1].length),to:n+o[0].length}),n+=o[0].length;else if(o=g.exec(p))l.push({type:"name",value:o[1],from:n+(o[0].length-o[1].length),to:n+o[0].length}),n+=o[0].length;else if(o=h.exec(p)){var q=n+o.index+o[0].indexOf(o[1]);l.push({type:"name",value:o[1],from:q,to:q+o[1].length}),n+=o[0].length}else if(o=i.exec(p))l.push({type:"operator",value:o[1],from:n+(o[0].length-o[1].length),to:n+o[0].length}),n+=o[0].length;else if(o=j.exec(p))l.push({type:"latex",value:o[1],from:n+(o[0].length-o[1].length),to:n+o[0].length}),n+=o[0].length;else{if(!(o=k.exec(p)))throw"can't tokenize '"+p+"'";n+=o[0].length}}return l}function o(a){var b,c,d,e,f={},g=ad.uid(),h=function(a,b){throw b=b||this,b.name="SyntaxError",b.message=a,b},i=function(){this.def={}};i.prototype.find_or_define=function(a){var b=this.def[a.value];return b&&"function"!=typeof b?b:(b=Object.create(f["(name)"]),b.lpb=0,this.def[a.value]=b,b)};var j=function(){if(!b)return!1;for(var a=arguments.length,c=Array(a),d=0;d<a;d++)c[d]=arguments[d];for(var e=0;e<c.length;e++)if(b.id===c[e])return!0;return!1},k=function(a,g){var i,j,k,l;if(a&&b.id!==a){if(g)return;h("Expected '"+a+"'.",b)}return d>=c.length?void(b=f["(end)"]):(k=c[d],d+=1,l=k.value,i=k.type,"name"===i?j=e.find_or_define(k):"operator"===i?(j=f[l])||h("Unknown operator.",k):"latex"===i?(j=f[l])||h("Unknown latex command.",k):"string"===i||"number"===i?(j=f["(number)"],i="number"):h("Unexpected token.",k),b=Object.create(j),b.from=k.from,b.to=k.to,b.value=l,b.type=i,b)},l=function(a,c){var d,e=c||b;for(c||k(),d=e.nud();a<b.lbp;)e=b,k(),d=e.led(d);return d},n={nud:function(){h("Undefined.",this)},led:function(a){h("Missing operator.",this)}},o=function(a,b){var c=f[a];return b=b||0,c?b>c.lbp&&(c.lbp=b):(c=Object.create(n),c.id=c.value=a,c.lbp=b,f[a]=c),c};o("(end)");var p=function(a){if(c=m(a),0==c.length)return null;e=new i,d=0,k();var b=l(0);return k("(end)"),b},q={};q.parse=p,q.parseExpression=l,q.advance=k,q.registerSymbol=o,q.uid=g,q.match_current_token=j,q.symbols=a;for(var r=0;r<a.length;r++){var s=ad.expressions[a[r]];s&&s.registerAtParser&&s.registerAtParser(q)}return q}function p(a,b){this.name=a,this.description=b,this.id=ad.uid(),this.priority=0,this.node_map={},this.initial_node_map={},this.touched_nodes={},this.new_selection=null,this.timeoutID=null,this.settings={},this.is_inner_action}function q(a){this.prototype.name=a,this.prototype.bp=100,ad.expressions[a]=this,this.prototype.get_subscript_helper=function(a,b){if(b&&b.var_subscripts_only&&"var"!==this.name)return"";if(!this.has_subscript())return"";var c=this.get_subscript()[a](b);return c.length>1?"_{"+c+"}":"_"+c},this.prototype.to_string=function(){return""+this.get_base().value+this.get_subscript_helper("to_string")},this.prototype.to_ascii=function(a){var b=this.get_base().value,c=this.get_subscript_helper("to_ascii",a);return c.length>0&&a&&a.subscripts_as_long_names?'"'+b+c+'"':b.toString()+c},this.prototype.to_latex=function(){return this.hidden?"":""+this.get_base().value+this.get_subscript_helper("to_latex")},this.prototype.is_leaf_node=!0,this.prototype.is_group=function(){for(var a=0;a<arguments.length;a++)if(arguments[a]===this.name)return!0;return!1},this.prototype.get_value=function(a){return a?this.value:this.get_base().value},this.prototype.set_value=function(a){this.has_subscript()?(this.get_base().value=a,this.value=this.to_ascii()):this.value=a},this.prototype.get_base=function(){return this.has_children()?this.children[0]:this},this.prototype.set_subscript=function(a,b){if(this.parent&&0===this.get_idx()&&this.parent.has_subscript())throw"Do not set a subscript on the base of a node with a subscript.";this.children[1]&&this.children[1].remove(),this.append(new ad.expressions[this.name](this.value)),this.append(a),this.value=this.to_ascii(),b&&this.fix_subscript(b)},this.prototype.has_subscript=function(){return this.has_children()},this.prototype.get_subscript=function(){return this.has_children()?this.children[1]:null},this.prototype.fix_subscript=function(a){this.children[0].fixed=a,this.children[1].for_each(function(b){b.fixed=a})}}function r(a,b){ad.inherit(sd,this),this.prototype.bp=b.bp||0,this.prototype.associative=b.associative||!1,this.prototype.commutative=b.commutative||!1,this.prototype.has_inverse=b.has_inverse||!1,this.prototype.inverse_group_name=b.inverse_group_name,this.prototype.group_name=b.group_name||b.group_class&&b.group_class.prototype.name,this.prototype.group_class=b.group_class,this.prototype.value=a,this.prototype.name=a,this.prototype.action_handlers=[],this.prototype.vertical_notation=b.vertical_notation||!1,this.prototype.add_action_handler=function(a){-1==this.action_handlers.indexOf(a)&&this.action_handlers.push(a)},this.prototype.getBestMatchingAction=function(a,b){b||(b=[]);for(var c=null,d=0;d<this.action_handlers.length;d++){var e=this.action_handlers[d];try{if(e.name&&-1!==b.indexOf(e.name))continue;if(e.triggerType!==a&&("tap"!==a||e.triggerType))continue;if(!e.match(this))continue;(null===c||e.priority>c.priority)&&(c=e)}catch(a){console.warn("An error occurred when trying to match "+e.name),ad.sendErrorReport("An error occurred when trying to match the operator "+this.name+" on "+this.to_ascii(),_c.stringify(this.get_root()))}}return c},this.prototype.createParentGroup=function(){for(var a=arguments.length,b=Array(a),c=0;c<a;c++)b[c]=arguments[c];return new(Function.prototype.bind.apply(this.group_class,[null].concat(b)))},this.prototype.createSameNode=function(){for(var a=arguments.length,b=Array(a),c=0;c<a;c++)b[c]=arguments[c];return new(Function.prototype.bind.apply(ad.expressions[this.name],[null].concat(b)))},this.prototype.getInverse=function(){return this.inverse&&ad.expressions[this.inverse]},ad.expressions[a]=this}function s(a){_c.Node.call(this,"sym"),this.value=a}function t(){sd.call(this)}function u(a,b){if(sd.call(this),a){switch(b){case"sub":this.value="sub";break;case"addsub":this.value="addsub";break;default:this.value="add"}_c.append(this,new s(u.value2sym[this.value])),_c.append(this,a),w.handle(a)}this.associative="add"==this.value}function v(a){_c.Node.call(this),this.value=1===a||"T"===a||"t"===a||!0===a?"T":"F",this.id=ad.uid()}function w(a,b,c){sd.call(this),a&&(_c.append(this,new s(b||"(")),_c.append(this,a),_c.append(this,new s(c||")")))}function x(){sd.call(this)}function y(a){sd.call(this),a&&(_c.append(this,new s("")),_c.append(this,a),w.handle(a))}function z(){sd.call(this)}function A(a){sd.call(this),a&&(_c.append(this,new s("")),_c.append(this,a),Brackets.handle(a))}function B(a){sd.call(this),a&&(_c.append(this,new s("|")),_c.append(this,a),_c.append(this,new s("|")))}function C(a,b){sd.call(this),this.set_degree(b),this.init_symbols(),this.set_radicand(a)}function D(a){if(_c.Node.call(this),this.max_precision=12,this.scrub_precision=0,"number"!=typeof a&&(a=0),!(a>=0))return new Q(new D(-a));this.value=a}function E(a){sd.call(this),a&&(_c.append(this,a),w.handle(a))}function F(a,b,c){if(sd.call(this),this.value=c,a&&b){if("lte"!==c&&"gte"!==c&&"lt"!==c&&"gt"!==c)throw"(Inequality) Unaccepted mode type.";_c.append(this,a),_c.append(this,new s(F.value2sym[c])),_c.append(this,b)}}function G(a,b){sd.call(this),a&&b&&(_c.append(this,a),_c.append(this,new s("=")),_c.append(this,b))}function H(a,b){sd.call(this),a&&b&&(this.append(a),b.is_group("exponent")?this.append(b):this.append(new N(b)),w.handle(a))}function I(){sd.call(this)}function J(a,b){var c=1===b.length&&b[0].children[1];return b.length>1||c&&c.is_group("fraction")?"("+a+")":c&&c.is_group("brackets")&&c.children[1].is_group("fraction","product")?"{"+a+"}":a}function K(a,b){sd.call(this),this.value="div"==b?"div":"mul",a&&(_c.append(this,new s("mul"==this.value?"*":"/")),_c.append(this,a),w.handle(a)),this.associative="mul"==this.value,this.bp=(this.value,30)}function L(a){_c.Node.call(this),this.value=a}function M(a){_c.Node.call(this),this.value=a}function N(a){sd.call(this),a&&(_c.append(this,a),w.handle(a))}function O(a,b){sd.call(this),_c.append(this,new s(a)),void 0!==b&&this.set_argument(b),this.value=a,this.units=O.units[this.value]}function P(a){sd.call(this),this.value="param",a&&(this.append(new s(",")),this.children[0].fixed=!0,this.append(a)),this.group_class=R,this.group_name="tuple",this.associative=!1,this.commutative=!1}function Q(a,b){sd.call(this),a&&(_c.append(this,new s(b?"":"-")),_c.append(this,a),w.handle(a)),b&&(this.value="plusminus")}function R(){sd.call(this),this.bp=5,this.value="tuple";for(var a=0;a<arguments.length;a++){var b=arguments[a];b instanceof P?this.append(b):this.append(new P(b))}}function S(a,b){this.interaction_handler=b,this.derivation=this.interaction_handler.dl,this.precision=null,this.view=a,this.dy=0,this.dx=0,this.pixels_per_unit=5,this.pixels_per_precision=400,this.node=null,this.value=null,this.value0=null}function T(a,b){void 0===b&&(b=1e3);var c,d={},e=[];d.fonts=[],d.map={},d.finished=!1,d.success=!1,d.div=d3.select("body").append("div").style({position:"absolute",visibility:"hidden",width:"1px",height:"1px",top:0,left:0}),d.on_fonts_loaded=function(a){this.finished?a(this.success):e.push(a)};var f=function(){d.loadSizes();for(var a=0;a<e.length;a++)e[a](this.success);e=[]};d.add_fonts=function(a){var b=!1;a.forEach(function(a){var c=g(a);c?a.id=c.id:(a.id=bd(),d.fonts.push(a),b=!0)}),b&&d.wait_for_fonts()};var g=function(a){for(var b=0;b<d.fonts.length;b++){var c=d.fonts[b];if(c.style===a.style&&c.family===a.family&&c.weight===a.weight)return c}return null};return d.wait_for_fonts=function(){c&&clearInterval(c),this.finished=!1,this.success=!1,this.fonts.unshift({family:"serif"});var a=this.div.selectAll("text.temp").data(this.fonts);a.enter().append("span").classed("temp",!0).style("font-size","100px").style("font-family",function(a){return-1===a.family.indexOf(" ")?a.family+", serif":"'"+a.family+"', serif"}).style("font-style",function(a){return a.style}).style("font-weight",function(a){return a.weight}).text("012abc"),a.exit().remove(),this.fonts.shift();var d=Date.now(),e=this;c=setInterval(function(){var g=[],h=!0;a.each(function(a,b){g[b]=this.getBoundingClientRect().width});for(var i=1;i<g.length;i++)g[i]===g[0]&&(h=!1);var j=Date.now()-d;!h&&j<=b||(e.success=h,e.finished=!0,a.remove(),clearInterval(c),f.call(e))},20)},d.loadSizes=function(a,b){a=a||"abcdefghijklmnopqrstuvwxyzABCDEFGHJKLMNOPQRSTUVWXYZ0123456789()=+-*^,.",b=b||this.fonts;for(var c=[],d=0;d<b.length;d++){this.map[b[d].id]||(this.map[b[d].id]={});for(var e=0;e<a.length;e++){var f={font:b[d],char:a[e],width:0,height:0};this.map[b[d].id][a[e]]=f,c.push(f)}}this.div.selectAll(".hiddenChars").data(c).enter().append("span").style("font-size","100px").style("font-family",function(a){return a.font.family}).style("font-style",function(a){return a.font.style}).style("font-weight",function(a){return a.font.weight}).text(function(a){return a.char}).each(function(a){var b=this.getBoundingClientRect();a.width=b.width,a.height=b.height}).remove()},d.width=function(a,b,c){for(var d=0,e=0;e<a.length;e++)this.map[c.id]&&this.map[c.id][a[e]]||this.loadSizes(a[e],[c]),d+=this.map[c.id][a[e]].width;return d*b/100},d.height=function(a,b,c){for(var d=0,e=0;e<a.length;e++)this.map[c.id]&&this.map[c.id][a[e]]||this.loadSizes(a[e],[c]),d=Math.max(this.map[c.id][a[e]].height,d);return d*b/100},d.add_fonts(a),d}function U(){vd.Rule.call(this,"reselect whole power",1)}function V(){function a(){n=this,a.connected(!0)}function b(){if(h(d3.event)){var a=d3.select(window),b=this,f=arguments;a.on("mousemove.mtouch",function(){d.apply(b,f)}),a.on("mouseup.mtouch",function(){a.on("mousemove.mtouch",null),a.on("mouseup.mtouch",null),e.apply(b,f)}),c.apply(this,arguments)}}function c(){d3.event.preventDefault();for(var b=this,c=l.of(b,arguments),d=g(),e=t?t.apply(this,arguments):null,h=0,i=d.length;h<i;h++){var j=new f(d[h].identifier,c,b,e);o.push(j),p[d[h].identifier]=j,c({type:"touch",finger:j,fingers:o,idx:a.idx})}}function d(){d3.event.preventDefault();for(var a=this,b=l.of(a,arguments),c=g(),d=0,e=o.length;d<e;d++)o[d].changed=!1;for(var f=[],d=0,e=c.length;d<e;d++){var h=p[c[d].identifier];h&&(h.move(b),f.push(h))}b({type:"mdrag",dragged_fingers:f,fingers:o})}function e(){d3.event.preventDefault();for(var a=this,b=l.of(a,arguments),c=g(),d=0,e=c.length;d<e;d++){var f=p[c[d].identifier];f&&(delete p[c[d].identifier],o=d3.values(p),b({type:"release",finger:f,fingers:o}),f.end(b))}}function f(a,b,c,d){this.id=a,this.target=c,this.event=b,this.parent=c.parentNode,this.timeStamp0=d3.event.timeStamp,this.timeStamp=this.timeStamp0,this.hold_timer=setTimeout(this.held.bind(this),z),this.pos=d?d.slice():j(this.id,s),this.pos0=[this.pos[0],this.pos[1]],this.pos_client=j(this.id,"client"),this.dist_x=0,this.dist_y=0,this.dx=0,this.dy=0,this.dt=0,this.changed=!0,this.gesture=null}function g(){return d3.event.changedTouches||[{identifier:r}]}function h(a){return"buttons"in a?1===a.buttons:"which"in a?1===a.which:1===a.button}function i(a,b,c){var d=-1,e=[b,c];return q=q.filter(function(b,c){return a-b.timeStamp<=C&&k(b.pos,e)<=D&&(d=c),b.timeStamp-a<=C&&d!==c}),-1===d&&q.push({timeStamp:a,pos:e}),-1!==d}function j(a,b){if("client"===b){if(a===r)return[d3.event.clientX/E,d3.event.clientY/E];for(var c=0;c<d3.event.touches.length;c++){var d=d3.event.touches[c];if(d.identifier===a)return[d.clientX/E,d.clientY/E]}}else{if(a===r)return X(b,d3.event,E);for(var c=0;c<d3.event.touches.length;c++){var d=d3.event.touches[c];if(d.identifier===a)return X(b,d,E)}}}function k(a,b){return Math.sqrt((a[0]-b[0])*(a[0]-b[0])+(a[1]-b[1])*(a[1]-b[1]))}var l=W(a,"tap","dbltap","hold","drag","mdrag","touch","release"),m=ad.uid(),n=null,o=[],p={},q=[],r="mouse",s="client",t=null,u=!1,v=V.defaultOptions.input_types,w=V.defaultOptions.tap_max_time,x=V.defaultOptions.tap_max_dist,y=x*x,z=V.defaultOptions.hold_time,A=V.defaultOptions.hold_max_dist,B=A*A,C=V.defaultOptions.dbltap_max_delay,D=V.defaultOptions.dbltap_max_dist,E=V.defaultOptions.zoom;return a.connected=function(a){if(0==arguments.length)return u;if(!n)return this;var f="all"===v||"touch"===v,g="all"===v||"mouse"===v;return n.on("touchstart."+m,a&&f?c:null).on("mousedown."+m,a&&g?b:null).on("touchmove."+m,a&&f?d:null).on("touchend."+m,a&&f?e:null).on("touchcancel."+m,a&&f?e:null),u=a,this},a.call=function(b){return b.apply(a,arguments),this},a.input_types=function(b){return 0===arguments.length?v:(v!==b&&(v=b,a.connected(u)),this)},a.frame=function(a){return 0===arguments.length?s:(s=a,this)},a.origin=function(a){return 0===arguments.length?t:(t=a,this)},a.zoom=function(a){return 0===arguments.length?E:(E=a,this)},a.hold_time=function(a){return 0===arguments.length?z:(z=a,this)},a.fingers=function(){return o},a.hold_max_dist=function(a){return 0===arguments.length?A:(A=a,B=A*A,this)},a.dbltap_max_dist=function(a){return 0===arguments.length?D:(D=a,this)},f.prototype.cancel_hold=function(){this.hold_timer&&clearTimeout(this.hold_timer),this.hold_timer=null},f.prototype.held=function(){this.event({type:"hold",finger:this,fingers:o}),this.hold_timer=null},f.prototype.move=function(a){this.changed=!0,this.event=a;var b=j(this.id,"client"),c=d3.event.timeStamp;this.dx=b[0]-this.pos_client[0],this.dy=b[1]-this.pos_client[1],this.pos[0]+=this.dx,this.pos[1]+=this.dy,this.dist_x=this.pos[0]-this.pos0[0],this.dist_y=this.pos[1]-this.pos0[1],this.pos_client=b,this.dt=c-this.timeStamp,this.timeStamp=c,this.dist_x*this.dist_x+this.dist_y*this.dist_y>B&&this.cancel_hold(),this.gesture||a({type:"drag",finger:this,x:this.pos[0],y:this.pos[1],dx:this.dx,dy:this.dy,fingers:o})},f.prototype.end=function(a){d3.event.timeStamp-this.timeStamp0<=w&&this.dist_x*this.dist_x+this.dist_y*this.dist_y<=y&&a(i(d3.event.timeStamp,this.pos[0],this.pos[1])?{type:"dbltap",finger:this,fingers:o}:{type:"tap",finger:this,fingers:o}),this.cancel_hold()},d3.rebind(a,l,"on")}function W(a){var b=d3.dispatch.apply(this,Array.apply(null,arguments).slice(1));return b.of=function(c,d){return function(e){try{var f=e.sourceEvent=d3.event;e.target=a,d3.event=e,b[e.type].apply(c,d)}finally{d3.event=f}}},b}function X(a,b,c){var d=a.ownerSVGElement||a;if(d.createSVGPoint){var e=d.createSVGPoint();if(wd<0&&(window.scrollX||window.scrollY)){d=d3.select("body").append("svg").style({position:"absolute",top:0,left:0,margin:0,padding:0,border:"none"},"important");var f=d[0][0].getScreenCTM();wd=!(f.f||f.e),d.remove()}return wd?(e.x=b.pageX,e.y=b.pageY):(e.x=b.clientX,e.y=b.clientY),e=e.matrixTransform(a.getScreenCTM().inverse()),[e.x/c,e.y/c]}var g=a.getBoundingClientRect();return[(b.clientX-g.left-a.clientLeft)/c,(b.clientY-g.top-a.clientTop)/c]}function Y(){function a(a,b){return Math.sqrt((a[0]-b[0])*(a[0]-b[0])+(a[1]-b[1])*(a[1]-b[1]))}var b,c,d,e,f=W(l,"drag","drag-start","drag-end"),g=[],h=!1,i=10,j=5,k=!0,l=function(){this.on("touch.drag",m).on("mdrag.drag",n).on("release.drag",o)};l.min_single_dist=function(a){return 0===arguments.length?i:(i=a,this)},l.min_double_dist=function(a){return 0===arguments.length?j:(j=a,this)},l.allow_double_drag=function(a){return 0===arguments.length?k:(k=a,this)};var m=function(){2===g.length||k&&1===g.length||(g.push(d3.event.finger),2===g.length?(b=[(g[0].pos[0]+g[1].pos[0])/2,(g[0].pos[1]+g[1].pos[1])/2],c=[b[0],b[1]],e=d=a(g[0].pos,g[1].pos)):(b=[g[0].pos[0],g[0].pos[1]],c=[b[0],b[1]],d=e=0))},n=function(){if(0!==g.length){var k,l=f.of(this,arguments);if(1===g.length){if(!g[0].changed)return;k=[g[0].pos[0],g[0].pos[1]],!h&&a(b,c)>=i&&(h=!0,l({type:"drag-start",fingers:g,pos0:b,pos:c,dist0:d,dist:e}))}else{if(!g[0].changed&&!g[1].changed)return;k=[(g[0].pos[0]+g[1].pos[0])/2,(g[0].pos[1]+g[1].pos[1])/2],e=a(g[0].pos,g[1].pos),!h&&a(b,c)>=j&&(h=!0,l({type:"drag-start",fingers:g,pos0:b,pos:c,dist0:d,dist:e}))}h&&l({type:"drag",fingers:g,pos0:b,pos:k,dist0:d,dist:e,dx:k[0]-c[0],dy:k[1]-c[1]}),c=k}},o=function(){if(0!==g.length){var a=d3.event.finger,d=g.indexOf(a);-1!==d&&(g.splice(d,1),h&&(1===g.length&&(b=[g[0].pos[0],g[0].pos[1]],c=[b[0],b[1]]),0===g.length&&(h=!1,f.of(this,arguments)({type:"drag-end"}))))}};return d3.rebind(l,f,"on")}function Z(){function a(a,b){return Math.sqrt((a[0]-b[0])*(a[0]-b[0])+(a[1]-b[1])*(a[1]-b[1]))}function b(a,b){return[(a[0]+b[0])/2,(a[1]+b[1])/2]}function c(a,b){return Math.atan2(a[1]-b[1],a[0]-b[0])}var d,e,f,g,h,i,j,k,l,m=W(u,"transform","transformend","transformstart"),n=[],o=0,p=0,q=0,r=1,s={scale:!0,translate:!0,rotate:!0},t=!0,u=function(){this.on("touch.transform",v).on("mdrag.transform",w).on("release.transform",x)};u.transform=function(a){return arguments.length?("scale"in a&&(r=a.scale),"rotate"in a&&(q=a.rotate),"translate"in a&&(o=a.translate[0],p=a.translate[1]),u):{scale:r,rotate:q,translate:[o,p]}},u.one_finger_drag=function(a){return arguments.length?(t=a,u):t},u.allow_translate=function(a){return arguments.length?(s.translate=a,u):s.translate},u.allow_scale=function(a){return arguments.length?(s.scale=a,u):s.scale},u.allow_rotate=function(a){return arguments.length?(s.rotate=a,u):s.rotate};var v=function(){2!==n.length&&(n.push(d3.event.finger),1===n.length&&t&&(d=e=[n[0].pos[0],n[0].pos[1]],f=A(e),m.of(this,arguments)({type:"transformstart"})),2===n.length&&(d=e=b(n[0].pos,n[1].pos),g=h=a(n[0].pos,n[1].pos),i=j=c(n[0].pos,n[1].pos),f=A(e),k=r,l=q))},w=function(){if(0!==n.length&&d3.event.dragged_fingers.some(function(a){return a.changed})){if(1===n.length){if(!t)return;s.translate&&(d=[n[0].pos[0],n[0].pos[1]]),B(d,f)}2===n.length&&(s.scale&&(g=a(n[0].pos,n[1].pos)),s.translate&&(d=b(n[0].pos,n[1].pos)),s.rotate&&(i=c(n[0].pos,n[1].pos)),y()),m.of(this,arguments)({type:"transform",fingers:n,transform:{scale:r,rotate:q,translate:[o,p]}})}},x=function(){if(0!==n.length){var a=d3.event.finger,b=n.indexOf(a);-1!==b&&(n.splice(b,1),0===n.length&&m.of(this,arguments)({type:"transformend"}),1===n.length&&(d=e=[n[0].pos[0],n[0].pos[1]],f=A(e)))}},y=function(){s.rotate&&(q=l+(i-j)),s.scale&&(r=k*g/h),(s.translate||s.rotate||s.scale)&&B(d,f)},z=function(a){var b=Math.cos(q),c=Math.sin(q),d=a[0]*b-a[1]*c,e=a[1]*b+a[0]*c;return[d*r+o,e*r+p]},A=function(a){var b=(a[0]-o)/r,c=(a[1]-p)/r,d=Math.cos(-q),e=Math.sin(-q);return[b*d-c*e,c*d+b*e]},B=function(a,b){b=z(b),o+=a[0]-b[0],p+=a[1]-b[1]};return d3.rebind(u,m,"on")}function _(a,b){this.id=ad.uid(),this.view=a,this.interaction_handler=b,this.derivation=a.derivation,this.dx=0,this.dy=0,this.dy0=0,this.finger_delta={x:0,y:0},this.dx_queue=[],this.dy_queue=[],this.x_offset=0,this.nodes=[],this.leaf_nodes=[],this.smooshedNodes=[],this.smooshing=!1,this.rubberband_dir=0,this.bbox=null,this.actions=[],this.on_release_action=null,this.target_areas=null,this.active=!1,this.bestHit=null,this.indicator=this.view.settings.get("show_drag_indicator")?_.Indicator():null}function aa(a){return 1===a.length&&a[0].is_group("add","sub","addsub","mul","div")?[a[0].children[1]]:a}function ba(a,b){return a.x*a.x+a.y*a.y>b*b}function ca(a){if(a.length<2)return a;var b=0;a[0].get_root().for_each(function(a){a.order_num=b++}),a.sort(function(a,b){return a.order_num-b.order_num})}function da(a,b){_c.for_each(function(a){return a.smooshing=!1},a),_c.for_each(function(a){a.smooshing=!0,a.x=a.x0,a.y=a.y0},b)}function ea(a,b){var c=[],d=b.y<0?"up":"down";return a.forEach(function(a){a.settings.shakes||(a.settings.shakes=0),a.settings.current_direction||(a.settings.current_direction="up",a.settings.distance=0),d===a.settings.current_direction?(a.settings.distance+=b.y,Math.abs(a.settings.distance)>100&&(a.settings.shakes++,a.settings.current_direction="up"===d?"down":"up",a.settings.distance=0)):d!==a.settings.current_direction&&(a.settings.distance=0),a.settings.shakes>=4&&c.push(a),a.settings.non_shakes=0}),c}function fa(a){return a.forEach(function(a){a.settings.non_shakes||(a.settings.non_shakes=0),++a.settings.non_shakes>2&&ga(a)}),[]}function ga(a){a.settings.shakes=0,a.settings.current_direction="up",a.settings.distance=0}function ha(a,b,c){this.id=ad.uid(),this.send_events=!0,this.events=d3.dispatch("tap","dbltap","drag_start","drag","drag_end","touch","release","hold","inspect_node","keyup","keydown","node_selection"),this.view=a,this.dl=a.derivation,this.canvas_model=this.dl?this.dl.canvas_model:null,this.recorder=c,this.interactive=b,this.init(),b||this.set_interactive(!1),this.selected_nodes=[],this.handlers={edit:[new ia(this.view,this),new _(this.view,this),new ja(this.view,this),new ka(this.view,this)],inspect:[new S(this.view,this)]},this.active_handler=null,this.active_action=null,this.pending_eoi=null,this.ignore_next_release_event=!1,this.only_synchronous_actions=!1,this.always_visualize_fingers=!1,this.finger_vis=null,this.notice_timer=null}function ia(a,b){this.view=a,this.alm=this.view.model,this.interaction_handler=b,this.initial_nodes=[],this.nodes=[],this.pos0=null,this.pos=null,this.box_el=null}function ja(a){this.view=a,this.alm=this.view.model,this.nodes=[],this.node_ids=[],this.joined=!1,this.unjoined_state=null}function ka(a,b){this.view=a,this.nodes=null,this.splitted=!1,this.new_state=null,this.prevDist=null,this.interaction_handler=b,this.actions=[ad.actions.SplitNumberAction,ad.actions.SplitProductAction,ad.actions.SplitPowerAction,ad.actions.SplitPowerSumAction,ad.actions.RemoveBracketsAction]}function la(a,b){b.forEach(function(b){-1===a.indexOf(b)&&a.push(b)})}function ma(){this.simple_models=[],this.node_map=new Jd;for(var a=0;a<arguments.length;a++){var b=new Id(arguments[a],{parser:ma.getRegExpParser()});this.simple_models=this.simple_models.concat(this.getVariations(b))}}function na(a){a.for_each(function(a){if(a.normalized){delete a.normalized;var b=a.parent;b&&b.is_group("mul","div")&&(!b.ls||"//"===b.ls.value)&&b.parent.parent&&b.parent.parent.is_group("add","sub")&&(a.replace_with(a.children[1]),b.parent.parent.invert()),b&&b.is_group("add","sub")&&(a.replace_with(a.children[1]),b.invert())}})}function oa(a){return!!_c.is_range(a)&&(!!a[0].is_group("mul","div")&&{nodes:a,type:a[0].value})}function pa(a){return sd.get_siblings(a.nodes).filter(function(b){return b.is_group(a.type)&&qa(b)}).map(function(a){return qa(a).get_top()})}function qa(a){for(var b=a.children[1];b.is_group("sign","plusminus");)b=b.children[1];return!!b.is_group("fraction")&&b}function ra(a){for(;a.is_group("sign");)a=a.get_child([1]);return a}function sa(a){var b=a;if(b.get_parent(1).is_group("fraction")&&b.get_parent(2).is_group("mul")&&(b=b.get_parent(2)),!b.is_group("mul","div"))return!1;var c=b.get_parent(1);if(!c.is_group("product","fraction"))return!1;var d=c.get_parent(1);if(!d.is_group("add","sub"))return!1;var e=d.get_parent(1);return!!e.is_group("sum")&&{ancestor_sum:e,addsub_idx:d.get_idx()}}function ta(a,b){return Math.abs(a)>=Math.abs(b)&&1!==Math.abs(b)&&a%b==0}function ua(a,b){if(!Number.isInteger(a)||!Number.isInteger(b))return 1;if(a<0&&(a=-a),b<0&&(b=-b),b>a){var c=a;a=b,b=c}for(;;){if(0==(a%=b))return b;if(0==(b%=a))return a}}function va(a,b){var c=D.get_value(a),d=D.get_value(b);return!(!c||!d)&&(!!ta(c,d)||(!!ta(d,c)||1!==ua(c,d)))}function wa(a,b){var c=!(arguments.length<=2||void 0===arguments[2])&&arguments[2],d=!(arguments.length<=3||void 0===arguments[3])&&arguments[3];if(a.length!==b.length)return!1;if(!a.concat(b).every(function(a){return a.is_group("add","sub","addsub","mul","div")}))return!1;var e=a.map(function(a){return"%"+a.value+"%"+a.children[1].to_ascii()}),f=b.map(function(a){var b=a.value;return"mul"===b&&c?b="div":"div"===b&&c?b="mul":"add"===b&&d?b="sub":"sub"===b&&d&&(b="add"),"%"+b+"%"+a.children[1].to_ascii()});return ad.array.isPermutation(e,f)}function xa(a){return ya(a[0])||za(a[0])||Aa(a[0])}function ya(a){var b=a.parent;return!!(b.is_group("fraction")&&b.parent&&b.parent.is_group("mul")&&b.parent.parent.is_group("product"))&&b.parent.parent}function za(a){var b=a.parent;return!(!b.is_group("product")||!b.children.some(function(a){return a.children[1].is_group("fraction")}))&&b}function Aa(a){var b=a.parent;return b.is_group("fraction")?b:null}function Ba(a,b){return b.every(function(b){for(var c=b;c;){if(c===a)return!0;c=c.parent}return!1})}function Ca(a,b,c,d,e){function f(a){var b=!(arguments.length<=1||void 0===arguments[1])&&arguments[1],d=!(arguments.length<=2||void 0===arguments[2])&&arguments[2],e=arguments.length<=3||void 0===arguments[3]||arguments[3];a.is_group("sign")?(b||(c=!c),f(a.children[1],b,d,e)):a.is_group("brackets")&&w.is_optional(a)?f(a.children[1],b,d,e):a.is_group("fraction","product")&&e?(a.get_top().forEach(function(a){return f(a.children[1],b,!1,!1)}),a.get_bottom().forEach(function(a){return f(a.children[1],b,!0,!1)})):d?b?j.push(a):h.push(a):b?i.push(a):g.push(a)}var g=[],h=[],i=[],j=[];a.forEach(function(a){return f(a)}),b.forEach(function(a){return f(a,!0)});var k=Da(g,h,i,j,e);return c&&(Q.wrapTerm(k),d.forEach(function(a){return e.extendNodeMap(a,k.get_child([0,1,0]))})),k}function Da(a,b,c,d,e){function f(a,b,c){var d=a.is_group("power")?a.children[0]:a,e=a.is_group("power")?b.children[0]:b,f=d.to_ascii(),g=a.is_group("power")?a.get_exponent_term():new D(1),h=a.is_group("power")?b.get_exponent_term():null;c&&(g=Q.invertTerm(g)),f in i||(i[f]={base:d,old_bases:[],exps:[],old_exps:[]}),i[f].exps.push(g),i[f].old_bases.push(e),h&&i[f].old_exps.push(h)}var g=1,h=1,i={};a.forEach(function(a,b){a.is_group("num")?g*=a.value:f(a,c[b],!1)}),b.forEach(function(a,b){a.is_group("num")?h*=a.value:f(a,d[b],!0)});var j=new I;if(g!==h){var k=ua(g,h);g/=k,h/=k,1===h?function(){var a=new D(g);j.append(new K(a)),c.filter(function(a){return a.is_group("num")}).forEach(function(b){return e.extendNodeMap(b,a)}),d.filter(function(a){return a.is_group("num")}).forEach(function(b){return e.extendNodeMap(b,a)})}():function(){var a=new I,b=new D(g),f=new D(h);a.append(new K(b)),a.append(new K(f,"div")),j.append(new K(a)),1!==g?c.filter(function(a){return a.is_group("num")}).forEach(function(a){return e.extendNodeMap(a,b)}):c.filter(function(a){return a.is_group("num")}).forEach(function(a){return e.extendNodeMap(a,f)}),d.filter(function(a){return a.is_group("num")}).forEach(function(a){return e.extendNodeMap(a,f)})}()}var l=new I,m=function(a){o=i[a];var b=void 0;if(1===o.exps.length)b=o.exps[0];else{b=new t,o.exps.forEach(function(a){var c=b.append(new u(a));e&&e.applyInnerAction("AddSubCombineSigns",{actor:c})});for(var c=b.children.length-1;c>=0;c--)p.cleanupInPlace(b.children[c])}var d=b.is_group("sum")?b.children.reduce(function(a,b){return a+D.get_value(b)},0):D.get_value(b),f=void 0;Number.isNaN(d)?(f=new K(new H(o.base,b)),o.old_bases.forEach(function(a){return e.extendNodeMap(a.get_mapping_to(o.base))})):1===d?(f=new K(o.base),o.old_bases.forEach(function(a){return e.extendNodeMap(a.get_mapping_to(o.base))})):0===d?f=null:-1===d?(f=new K(o.base,"div"),o.old_bases.forEach(function(a){return e.extendNodeMap(a.get_mapping_to(o.base))})):d<0?function(){var a=new D(-d);f=new K(new H(o.base,a),"div"),o.old_bases.forEach(function(a){return e.extendNodeMap(a.get_mapping_to(o.base))}),o.old_exps.forEach(function(b){return e.extendNodeMap(b.get_mapping_to(a))})}():function(){var a=new D(d);f=new K(new H(o.base,a)),o.old_bases.forEach(function(a){return e.extendNodeMap(a.get_mapping_to(o.base))}),o.old_exps.forEach(function(b){return e.extendNodeMap(b.get_mapping_to(a))})}(),f&&l.append(f)};for(var n in i){var o;m(n)}return(0===l.children.length&&0===j.children.length||l.children.length>0&&!l.children[0].is_group("mul"))&&l.append(new K(new D(1))),0===j.children.length?l:0===l.children.length?j:(j.append(new K(l)),j)}function Ea(a){return!!_c.is_range(a)&&(!!a[0].commutative&&{nodes:a,type:a[0].name})}function Fa(a){return sd.get_siblings(a.nodes).filter(function(b){return"add-sub"===a.type||b.is_group(a.nodes[0].value)})}function Ga(a){a.forEach(function(a){a.target.get_parent(2).is_group("fraction")?(a.drop_area.margin||(a.drop_area.margin={}),a.target.parent.is_group("mul")?Ha(a.drop_area.margin,"up"):Ha(a.drop_area.margin,"down")):a.target.parent.is_group("add","sub","addsub")&&a.target.get_parent(5)&&a.target.get_parent(5).is_group("fraction")&&(a.drop_area.margin||(a.drop_area.margin={}),a.target.get_parent(4).is_group("mul")?Ha(a.drop_area.margin,"up"):Ha(a.drop_area.margin,"down"))})}function Ha(a,b){"up"===b?(a.y1=-1,a.y2=.1):"down"===b&&(a.y1=.1,a.y2=-1)}function Ia(a,b){var c=!(arguments.length<=2||void 0===arguments[2])&&arguments[2];if(a.is_group("num"))b>=0?a.value=a.value*(c?1/b:b):(a.value=-1*a.value*(c?1/b:b),Q.invertTerm(a));else if(a.is_group("add","sub","addsub","sign"))Ia(a.children[1],b,c);else if(a.is_group("product")){var d=a.children.find(function(a){return D.is_num(a.children[1])});d?Ia(d.children[1],b,c):Ia(a.children[0].children[1],b,c)}else if(a.is_group("fraction")){var e=a.get_top().find(function(a){return D.is_num(a.children[1])}),f=a.get_bottom().find(function(a){return D.is_num(a.children[1])});c?f?Ia(f.children[1],b,!1):e?Ia(e.children[1],b,!0):a.get_bottom().length>0?Ia(a.get_bottom[0].children[1],b,!1):a.append(new K(new D(b),"div")):e?Ia(e.children[1],b,!1):f?Ia(f.children[1],b,!0):a.get_top().length>0?Ia(a.children[0].children[1],b,!1):a.insert(0,new K(new D(b)))}else{var g=a.parent,h=a.remove(),i=new I;i.append(new K(new D(b),c?"div":"mul")),i.append(new K(a)),g.insert(h,i),p.cleanupInPlace(g)}}function Ja(a){if(!a[0].is_group("div"))return!1;var b=a[0].get_parent(2);return b&&b.is_group("sign")&&(b=b.parent),!!(b&&b.parent&&b.parent.is_group("sum"))&&{nodes:a,addend:b,sum:b.parent}}function Ka(a){return a.sum.children.filter(function(b){return b.get_idx()!==a.addend.get_idx()}).map(function(a){return a.children[1].is_group("sign")?a.children[1].children[1]:a.children[1]})}function La(a){var b=Id.groupNodeRanges(a);if(0===b.length)return[];for(var c=[],d=0;d<b.length;d++){var e=b[d];if(1===e.length&&e[0].is_group("exponent")){var f=e[0].children[0];w.areHidden(f)&&(f=f.children[1]);var g=e[0].get_parent(3);if(!g)return[];c.push({range:e,exp:e[0],prod:g,ascii:f.to_ascii()})}else{if(!e.every(function(a){return a.is_group("mul","div")}))return[];var h=e[0].get_parent(3),i=e[0].get_parent(6),j=Id.rangeToAsciiNoLeadingOp(e,!0);if(!h||!i)return[];c.push({range:e,exp:h,prod:i,ascii:j})}}for(var k=0;k<c.length;k++){var l=c[k];if(l.ascii!==c[0].ascii)return[];if(!l.exp.is_group("exponent"))return[];if(!l.prod.is_group("fraction","product")||l.prod!==c[0].prod)return[];for(var m=k+1;m<c.length;m++)if(l.exp===c[m].exp)return[]}return c}function Ma(a){return!(!a||!a.is_group("mul","div"))&&{node:a,is_neg1:-1===D.get_value(a.children[1]),is_pm1:a.children[1].is_group("plusminus")&&1===D.get_value(a.children[1],!0)}}function Na(a){return I.getFactors(a.node.parent).filter(function(b){if(b===a.node)return!1;if(a.is_neg1||a.is_pm1)return!0;var c=Ma(b);return c.is_neg1||c.is_pm1})}function Oa(a){Array.isArray(a)||(a=[a]);var b=Id.evalExpression(a),c=(Id.to_ascii(a),ad.termsToAlgebriteString(a));if(Number.isNaN(b)&&void 0!==$c)try{b=Number($c.eval(c).toString())}catch(a){console.log("Algebrite could not parse",c)}return b}function Pa(a){if(1!==a.length)return!1;if(!a[0].is_group("mul","div")||!a[0].children[1].is_group("radical"))return!1;var b=Oa(a[0].children[1].get_radicand());return{nodes:a,degree_val:a[0].children[1].get_degree_term().to_ascii(),group:a[0].parent,is_negative:!isNaN(b)&&b<0}}function Qa(a){return a.group.get_top().concat(a.group.get_bottom()).filter(function(b){if(-1!==a.nodes.indexOf(b)||!b.children[1].is_group("radical")||b.children[1].get_degree_term().to_ascii()!==a.degree_val)return!1;if(a.is_negative){var c=Oa(b.children[1].get_radicand());if(!isNaN(c)&&c<0)return!1}return!0})}function Ra(a){if(a.length>1)return!1;var b=a[0];return!(!b.is_group("abs-val")||!Ta(b.parent))&&{nodes:a,relation:b.parent,rel_sym:b.parent.children[1]}}function Sa(a){return[a.rel_sym]}function Ta(a){return a.is_group("equals","lt","gt","lte","gte")}function Ua(a){if(!_c.is_range(a))return!1;var b=a[0];if(!b.is_group("mul","div"))return!1;if(!b.parent.parent||!b.parent.parent.parent||!b.get_parent(3).is_group("radical"))return!1;var c=Oa(a),d=Oa(sd.get_siblings(a).filter(function(a){return a.is_group("mul","div")}));return!!(isNaN(c)||c>=0||isNaN(d)||d>=0)&&{nodes:a,radicand:b.parent}}function Va(a){return[a.radicand]}function Wa(a){return!!_c.is_range(a)&&(!!a[0].is_group("mul","div")&&{nodes:a,type:a[0].value})}function Xa(a){return sd.get_siblings(a.nodes).filter(function(b){return b.is_group(a.type)&&b.children[1].is_group("brackets")&&b.get_child([1,1]).is_group("sum")}).map(function(a){return a.get_child([1,1])})}function Ya(a){return a.some(function(a){return a.is_group("mul")&&D.is_num(a.children[1])})}function Za(a){return a.children.some(function(a){return a.is_group("mul")&&D.is_num(a.children[1])&&0===D.get_value(a.children[1])})}function $a(a){return!a.some(function(a){return a.is_group("mul")&&0===D.get_value(a.children[1])})}function _a(a){var b=arguments.length<=1||void 0===arguments[1]?null:arguments[1];if(!_c.is_range(a))return!1;if(a[0].is_group("equals")||F.is_inequality(a[0]))return!1;var c=a.slice();if(1===a.length&&(a[0].is_group("add","sub","addsub","param","mul","div")?c[0]=c[0].children[1]:a[0].is_group("exponent","degree")&&(c[0]=c[0].children[0])),c[0].is_group("placeholder"))return!1;var d=1===a.length&&a[0].is_group("sub")||a[0].parent.is_group("product")&&0===a[0].get_idx&&a[0].parent.parent.is_group("sign","sub"),e=!1,f=c.slice(),g=(a[0].parent.is_group("equals")||F.is_inequality(a[0].parent))&&G.getOppositeSide(a[0]),h=kb(a);return!g||h||kb([g])||b&&!jb(cb(c))(b)||(e=!0,f=[g]),{dragged_nodes:a,nodes:c,substitutes:f,use_equality:e,contains_placeholder:h,is_neg:d}}function ab(a,b){var c=[],d=jb(cb(a.nodes)),e=function(a,b){return a.to_ascii()===b.to_ascii()};a.use_equality&&(c=a.nodes.length>1||a.nodes[0].is_group("sum","product")?b.filterRange(d):b.filter(function(a){return d([a])}).map(function(a){return[a]}));var f=_c.filter(function(a){return a.is_group("var")},a.nodes);return c=c.concat(b.filter(function(b){return!b.fixed&&(a.contains_placeholder?b.is_group("placeholder"):b.is_group("placeholder","var"))&&!f.find(function(a){return e(b,a)})}).map(function(a){return[a]}))}function bb(a,b){var c=jb(cb(a));return b=b||a[0].get_root(),a.length>1||a[0].is_group("sum","product")?b.filterRange(c,!0):b.filter(function(a){return c([a])}).map(function(a){return[a]})}function cb(a){return 1===a.length&&(a[0].hidden||a[0].is_group("tuple"))?"":a.map(function(a){return a.to_ascii()}).join("")}function db(a){return a.is_group()&&a.commutative&&a.associative}function eb(a){if(0===a.length)return"";if(1===a.length&&(a[0].hidden||a[0].is_group("tuple")))return"";var b=a.map(function(a){return a.to_ascii()}).join("");return 1===a.length?b:db(a[0])?b.substring(a[0].children[0].to_ascii().length):b}function fb(a){if(1!==a.length)return"";if(!a[0].is_group("fraction"))return"";var b=a[0].to_ascii();return"("===b.slice(0,1)&&")"===b.slice(b.length-1,b.length)&&(b=b.substr(1,b.length-2)),b}function gb(a){return a.length<2?"":a[0].is_group("div")?a.map(function(a){return a.to_ascii()}).join("").replace(/\//g,"*"):""}function hb(a){return a[0]&&a[0].parent&&!a[0].parent.is_group("exponent")&&a.length===a[0].parent.children.length}function ib(a){return a.parent}function jb(a){return function(b){if(0===b.length)return!1;if(b[0].fixed)return!1;if(!b[0].parent)return!1;if(ib(b[0].parent)&&hb(b))return!1;var c=gb(b);return cb(b)===a||eb(b)===a||fb(b)===a||c===a||c.substr(1)===a}}function kb(a){return _c.select_first(function(a){return a.is_group("placeholder")},a)}function lb(a){var b=a.get_child([1,1]);return b.remove(),new K(b)}function mb(a){var b=a.get_parent(1);return b.get_top().concat(b.get_bottom()).filter(function(b){return b!==a&&b.value===a.value&&b.get_child([1]).is_group("abs-val")})}function nb(a){return arguments.length>0&&(oe=a),oe}function ob(a,b,c,d){this.id=d||ad.uid(),this.source=a,this.target=b,this.action=c,this.action.broken=!1,this.model_before_broken=null,this.source.events.on("change."+this.id,this.onChange.bind(this)),this.target.events.on("change."+this.id,this.onTargetChange.bind(this))}function pb(){var a=arguments.length<=0||void 0===arguments[0]?"x":arguments[0],b=arguments.length<=1||void 0===arguments[1]?"y":arguments[1];return function(c){return"matrix(1, 0, 0, "+(c.scale_y||1)+", "+c[a]+", "+c[b]+")"}}function qb(a,b){a.style("opacity",function(a){return b?a.hidden||a.hide_after_drop?1e-5:1:a.hidden||a.smooshing?1e-5:a.hide_after_drop?.4:1})}function rb(a,b,c){var d=this;a.style("border-radius",function(a){return a.height+"px"}).style("left",0).style("width",function(a){return a.width+"px"}).style("height",function(a){return a.height+"px"}).style("background",function(a){return c?d.settings.get("shadow_node_color"):a.color}).style("box-shadow",c?this.settings.get("shadow_node_shadow"):null).call(qb,c),b&&a.each(function(a){var b=.3*a.height,c=-Math.atan2(b,a.width),d=Math.cos(c),e=Math.sin(c),f="matrix("+d+", "+e+", "+-e+", "+d+", 0, 0)";d3.select(this).style("transform",f).style("-webkit-transform",f)})}function sb(a,b){this.type="derivation-row",this.dl=a,this.id=ad.uid(),this.action=b.action,this.model=b.model,this.handle=null,this.view=null,this.el=b.el,this.padding=b.padding,this.dims=b.dims||{},this.idx=b.row_idx,this.pos=b.pos,this.link=null,this.lpos=null,this.preview=null,this.subable=!0,this.sub=!1,this.error=null}function tb(a,b){var c=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],d=arguments[3];ve.call(this,a,b,c,"Derivation"),this.type="derivation",this.events=cd.extend(this.events,d3.dispatch("added_line","change","inspect_node","clone","pack_state","mistake","auto_undo","undo","redo","removed")),this.row_events=d3.dispatch("drag","touch","tap","dbltap","release"),this.update_sequence=0,this.initDerivationSettings(c),this.initDerivationProperties(),this.initDerivation(d),this.initEventListeners()}function ub(a,b){0==arguments.length?(this.x=0,this.y=0):1==arguments.length?(this.x=a.x,this.y=a.y):(this.x=a,this.y=b)}function vb(a,b,c){this.x=a,this.y=b,this.r=c}function wb(a){if(!a.fixed)return!1;for(var b=a;b.parent&&b.parent.is_leaf_node&&b.parent.has_subscript();)b=b.parent;return a!==b.children[0]}function xb(a,b,c,d,e){var f=[],g=1===a.length?a[0]:p.createComposedAction(a);return b.forEach(function(a){var b=g.mapNodes([a]);0!==b.length||a.traced?b.forEach(function(b){e&&b.is_group("sym")||b.has_children()||wb(b)||yb(f,{source_node:a,source_row:c,target_node:b,target_row:d})}):f.push({source_node:a,source_row:c}),a.was_removed=0===b.length}),f}function yb(a,b){if(b.source_node.traced&&b.target_node.traced){a.find(function(a){return a.source_node===b.source_node&&a.target_node===b.target_node||a.source_node===b.target_node&&a.target_node===b.source_node})||a.push(b)}else a.push(b)}function zb(a){var b=(arguments.length<=1||void 0===arguments[1]||arguments[1],"get"),c=null,d=!0,e=!1,f=null,g=new window.XMLHttpRequest,h={xhr:g,requestType:function(a){return b=a,h},contentType:function(a){return c=a,h},useAuthorization:function(a){return d=a,h},parseResult:function(a){return e=a,h},body:function(a){return f=typeof a===String?a:JSON.stringify(a),h},run:function(){return new Promise(function(h,i){g.onreadystatechange=function(){if(4===g.readyState)if(200===g.status)if(e)try{h(JSON.parse(g.responseText))}catch(a){i(a)}else h(g.responseText);else i(g.responseText)},g.open(b,a),c&&g.setRequestHeader("Content-Type",c),console.log("Contacting",a,"auth settings:",d,De.auth_token),d&&De.auth_token&&g.setRequestHeader("Authorization","Bearer "+De.auth_token),g.send(f)})}};return h}function Ab(a,b){this.id=ad.uid(),a&&a.version!==ad.version&&(console.warn("Incompatible versions!"),console.info("Recorded data gmath version:",a.version),console.info("Current gmath version:",ad.version)),this.event_log=a||{},this.container=b,this.ignore_custom_events_during_playback=!0,this.ajust_time_of_next_event=!0,this.event_dt=0}function Bb(a,b){this.id=ad.uid(),this.interaction_logger=a,this.log_mouse_trajectories=this.interaction_logger.log_mouse_trajectories,this.dl=b,b.rows.length&&this.initListeners(),this.events=[],this.interaction=null,this.scrubbed_in_this_interaction=!1}function Cb(a,b){this.data_logger=a,this.interactionSequence=[],this.dlLoggers=[],this.setupListeners(b)}function Db(a,b){this.id=ad.uid(),this.events=d3.dispatch("interaction"),this.listening=!0,this.log_mouse_trajectories=b,this.trial_id=null,this.canvas_logger=new Cb(this,a),this.canvas=a,ad.TrialLogger.events.on("start_trial."+this.id,this.setTrialInfo.bind(this)),ad.TrialLogger.trial&&this.setTrialInfo(ad.TrialLogger.trial)}function Eb(a,b){this.event_log=a,this.dl=null,this.other_dl=null,this.div=d3.select(b),this.stop_timer=!1}function Fb(a,b,c){c=c||20;var d=[],e=function(a){var e=b[0][0],f=b[0][1],g=0,h=0;if(1===a.length&&!Ib(a[0][0],a[0][1],e,f,c))return void d.push(a);for(var i;g<a.length-1;){var j=a[g],k=a[g+1],l=Ib(j[0],j[1],e,f,c),m=Ib(k[0],k[1],e,f,c);if(l&&m)g++,h=g;else if(l&&!m){var n=Mb(j[0],j[1],k[0],k[1],e,f,c);n?(a[g]=n,h=g):g++}else if(!l&&m){var n=Mb(k[0],k[1],j[0],j[1],e,f,c);n&&(i=a.slice(h,g+1),i.push(n),d.push(i)),g++,h=g}else{var o=Nb(j[0],j[1],k[0],k[1],e,f,c);o?(i=a.slice(h,g+1),i[i.length-1][0]===o[0][0]&&i[i.length-1][1]===o[0][1]||i.push(o[0]),i.length>1&&d.push(i),a[g]=o[1],a[g+1]&&a[g+1][0]==o[1][0]&&a[g+1][1]==o[1][1]&&g++,h=g):g++}}h!==g&&(i=a.slice(h,a.length))&&d.push(i)},f=function(a,e){if(a.path){c+=a.width/2;var a=a.path}var f=b[e],g=b[e+1],e=0,h=0;if(1===a.length){var i=Kb(a[0][0],a[0][1],f[0],f[1],g[0],g[1],c);if(-1===i.indexOf(1))return void d.push(a)}for(var j;e<a.length-1;){var k=a[e],l=a[e+1],i=Kb(k[0],k[1],f[0],f[1],g[0],g[1],c),m=Kb(l[0],l[1],f[0],f[1],g[0],g[1],c);if(-1!==i.indexOf(1)&&-1!==m.indexOf(1))e++,h=e;else if(-1!==i.indexOf(1)&&-1===m.indexOf(1)){var n=Pb(k[0],k[1],i,l[0],l[1],f[0],f[1],g[0],g[1],c);n?(a[e]=n,h=e):e++}else if(-1===i.indexOf(1)&&-1!==m.indexOf(1)){var n=Pb(l[0],l[1],m,k[0],k[1],f[0],f[1],g[0],g[1],c);n?(j=a.slice(h,e+1),j.push(n),d.push(j),e++,h=e):e++}else{var o=Qb(k[0],k[1],l[0],l[1],f[0],f[1],g[0],g[1],c);o?(j=a.slice(h,e+1),j[j.length-1][0]===o[0][0]&&j[j.length-1][1]===o[0][1]||j.push(o[0]),j.length>1&&d.push(j),a[e]=o[1],a[e+1]&&a[e+1][0]==o[1][0]&&a[e+1][1]==o[1][1]&&e++,h=e):e++}}h!==e&&(j=a.slice(h,a.length))&&d.push(j)};if(b=Gb({path:b}),1===b.length){for(var g=0;g<a.length;g++)e(a[g]);a=d}else for(var h=0;h<b.length-1;h++){for(var g=0;g<a.length;g++)f(a[g],h);a=d,d=[]}for(var i=0;i<a.length;i++)for(var j=0;j<a[i].length;j++)a[i][j][0]=Math.round(a[i][j][0]),a[i][j][1]=Math.round(a[i][j][1]);return a}function Gb(a){if(a.path)var a=a.path;var b=[];if(1===a.length)b=a;else{for(var c=0;c<a.length-1;)a[c][0]===a[c+1][0]&&a[c][1]===a[c+1][1]||b.push(a[c]),c++;0!==a.length&&0===b.length&&b.push(a[0]),a[a.length-1][0]===a[b.length-1][0]&&a[a.length-1][1]===a[b.length-1][1]||b.push(a[c])}return b}function Hb(a,b,c,d){return Math.sqrt(Math.pow(c-a,2)+Math.pow(d-b,2))}function Ib(a,b,c,d,e){return Hb(a,b,c,d)<e?1:0}function Jb(a,b,c,d,e,f,g){var h=[e-c,f-d],i=[a-c,b-d],j=[-h[1],h[0]],k=Math.sqrt(Math.pow(j[0],2)+Math.pow(j[1],2)),l=[j[0]/k,j[1]/k],m=Math.sqrt(Math.pow(h[0],2)+Math.pow(h[1],2)),n=[h[0]/m,h[1]/m],o=i[0]*n[0]+i[1]*n[1];if(o<=0||o>=m)return 0;var p=i[0]*l[0]+i[1]*l[1];return p>=g||p<=-g?0:1}function Kb(a,b,c,d,e,f,g){var h=[];return h.push(Ib(a,b,c,d,g)),h.push(Ib(a,b,e,f,g)),h.push(Jb(a,b,c,d,e,f,g)),h}function Lb(a,b,c,d,e){var f=[c-a,d-b],g=[-f[1],f[0]],h=Math.sqrt(Math.pow(g[0],2)+Math.pow(g[1],2)),i=[g[0]/h,g[1]/h];return[[a+e*i[0],b+e*i[1]],[a-e*i[0],b-e*i[1]],[c-e*i[0],d-e*i[1]],[c+e*i[0],d+e*i[1]]]}function Mb(a,b,c,d,e,f,g){var h,i=[e-a,f-b],j=[c-a,d-b],k=Math.sqrt(Math.pow(j[0],2)+Math.pow(j[1],2)),l=[j[0]/k,j[1]/k],m=i[0]*l[0]+i[1]*l[1],n=[a+m*l[0],b+m*l[1]],o=Math.sqrt(Math.pow(e-n[0],2)+Math.pow(f-n[1],2));if(0===o)h=g;else var h=Math.sqrt(Math.pow(g,2)-Math.pow(o,2));var p=[a+m*l[0]+h*l[0],b+m*l[1]+h*l[1]];return p[0]===a&&p[1]===b?null:p}function Nb(a,b,c,d,e,f,g){var h=[e-a,f-b],i=[c-a,d-b],j=[-i[1],i[0]],k=Math.sqrt(Math.pow(j[0],2)+Math.pow(j[1],2)),l=[j[0]/k,j[1]/k],m=h[0]*l[0]+h[1]*l[1],n=Te([a,b],[c,d],[e,f]);if(Re([n[0]-e,n[1]-f])>=g)return null;var o=Math.sqrt(Math.pow(g,2)-Math.pow(m,2)),p=[e-m*l[0],f-m*l[1]],q=Math.sqrt(Math.pow(i[0],2)+Math.pow(i[1],2)),r=[i[0]/q,i[1]/q],s=[[p[0]-r[0]*o,p[1]-r[1]*o],[p[0]+r[0]*o,p[1]+r[1]*o]];return s[0][0]===a&&s[0][1]===b?null:s}function Ob(a,b,c,d,e,f,g,h){var i,j,k,l;i=c-a,j=d-b,k=g-e,l=h-f;var m,n;if(-k*j+i*l==0)return null;if(m=(-j*(a-e)+i*(b-f))/(-k*j+i*l),n=(k*(b-f)-l*(a-e))/(-k*j+i*l),m>=0&&m<=1&&n>=0&&n<=1){return[a+n*i,b+n*j]}return null}function Pb(a,b,c,d,e,f,g,h,i,j){var k=Lb(f,g,h,i,j),l=[];if(c[0]&&!c[1]){l.push(Mb(a,b,d,e,f,g,j)),l.push(Ob(a,b,d,e,k[0][0],k[0][1],k[3][0],k[3][1])),l.push(Ob(a,b,d,e,k[1][0],k[1][1],k[2][0],k[2][1]));var m=Nb(a,b,d,e,h,i,j);m&&l.push(m[0],m[1])}else if(!c[0]&&c[1]){l.push(Mb(a,b,d,e,h,i,j)),l.push(Ob(a,b,d,e,k[0][0],k[0][1],k[3][0],k[3][1])),l.push(Ob(a,b,d,e,k[1][0],k[1][1],k[2][0],k[2][1]));var m=Nb(a,b,d,e,f,g,j);m&&l.push(m[0],m[1])}else if(c[0]&&c[1])l.push(Mb(a,b,d,e,f,g,j)),l.push(Ob(a,b,d,e,k[0][0],k[0][1],k[3][0],k[3][1])),l.push(Ob(a,b,d,e,k[1][0],k[1][1],k[2][0],k[2][1])),l.push(Mb(a,b,d,e,h,i,j));else{var m=Nb(a,b,d,e,h,i,j),n=Nb(a,b,d,e,f,g,j);m&&l.push(m[0],m[1]),n&&l.push(n[0],n[1]),l.push(Ob(a,b,d,e,k[0][0],k[0][1],k[3][0],k[3][1])),l.push(Ob(a,b,d,e,k[1][0],k[1][1],k[2][0],k[2][1]))}for(var o=[a,b],p=0;p<l.length;p++)l[p]&&Hb(l[p][0],l[p][1],d,e)<Hb(o[0],o[1],d,e)&&(o=l[p]);return o[0]===a&&o[1]===b?null:o}function Qb(a,b,c,d,e,f,g,h,i){var j=Lb(e,f,g,h,i),k=[],l=Nb(a,b,c,d,e,f,i);l&&k.push(l[0],l[1]),l=Nb(a,b,c,d,g,h,i),l&&k.push(l[0],l[1]),k.push(Ob(a,b,c,d,j[0][0],j[0][1],j[3][0],j[3][1])),k.push(Ob(a,b,c,d,j[1][0],j[1][1],j[2][0],j[2][1]));for(var m=[c,d],n=[a,b],o=0;o<k.length;o++)k[o]&&Hb(k[o][0],k[o][1],a,b)<Hb(m[0],m[1],a,b)&&(m=k[o]);for(var p=0;p<k.length;p++)k[p]&&Hb(k[p][0],k[p][1],c,d)<Hb(n[0],n[1],c,d)&&(n=k[p]);return m[0]===c&&m[1]===d||n[0]===a&&n[1]===b?null:[m,n]}function Rb(a){function b(a){27===(a||d3.event).keyCode&&(q.setActive(),q.setActive(null,!1),q.clearAllTermTracesExcept())}function c(a){"arrange"===a.tool&&q.setActive(null),"draw"===a.tool||"erase"===a.tool?(q.foreground_event_layer_visible(!0),q.setActive(null)):q.foreground_event_layer_visible(!1),"inspect"!==a.tool&&q.clearAllTermTracesExcept()}function d(a,b){a.call(b),b.frame(a.node())}function e(){if("hold"===N)var a=ad.mtouch_events().on("touch",ca.bind(this,null)).on("hold",da.bind(this,null)).on("drag",ea.bind(this,null)).on("tap",function(){q.clearAllTermTracesExcept(),q.setActive(null)}).on("release",fa.bind(this,null)).hold_max_dist(5).hold_time(500).call(F);else if("tap"===N)var a=ad.mtouch_events().on("tap",function(){M&&(K.visible?fa():(da(),K.element.attr("pointer-events","none")))}).hold_max_dist(5).hold_time(500).call(F);return a}function f(){return ad.mtouch_events().on("touch",ga.bind(this,null)).on("drag",ha.bind(this,null)).on("release",ia.bind(this,null)).hold_max_dist(5).hold_time(500)}function g(){w.caption("").latex("").on("done",null).on("cancel",null).visible(!1)}function h(a,b){var c={drop_evt:a,pos:b};q.createElement("image",c,"drag-n-drop")}function i(a){if("{"!==a[0]||"}"!==a[a.length-1])return a;for(var b=!0,c=0,d=0;d<a.length;d++)"{"===a[d]&&(c+=1),"}"===a[d]&&(c-=1),0===c&&d!==a.length-1&&(b=!1),d===a.length-1&&0!==c&&(b=!1);return b?i(a.substr(1,a.length-2)):a}function j(a){var b=a.getData("text/html"),c=document.createElement("div"),d=d3.select(c).html(b).select("img");return 1===d.size()?d.attr("alt"):null}function k(a){return a.getData("text/plain")}var l,m,n,o=d3.dispatch("scroll","start_hwr","stop_hwr","undone","redone","hold","touch","drag","release","font_size","keyboard","entered_term","start-of-interaction","end-of-interaction","undoable-action"),p=ad.uid(),q=a,r=null,s=[],t=-1,u=null,v=!1,w=null,x=!1,y=!0,z=1500,A=null,B=q.paths().length,C=2,D=50,E="black",F=null,G=0,H={},I=null,J=!1,K=null,L=!0,M=!0,N="hold",O=["derivation","textbox","graph"],P=null,Q=800,R=!1,S=!0,T=function g(){return a.on("create."+p,function(a){"derivation"!==a.target_type&&"graph"!==a.target_type&&"textbox"!==a.target_type&&"image"!==a.target_type||(a.target.events.on("start-of-interaction."+p,function(b){q.setActive(a.target),b.source&&"derivation"===b.source.type&&"inspect"===q.getActiveTool()&&tb.hideTermTraces(q.back_svg(),q.html_container()),o["start-of-interaction"](b)}),a.target.events.on("end-of-interaction."+p,function(a){!a.source||"AlgebraModel"!==a.source.type&&"derivation"!==a.source.type||"inspect"!==q.getActiveTool()||tb.drawTraces(q.getElementsOfType("derivation")),o["end-of-interaction"](a)}),"derivation"===a.target_type&&(a.target.events.on("inspect_node."+p,function(a){a.shiftKey||q.clearAllTermTracesExcept(a.dl)}),a.target.events.on("change."+p,function(a){"inspect"===q.getActiveTool()&&tb.hideTermTraces(q.back_svg(),q.html_container())})))}),F=Z().allow_rotate(!1).allow_scale(!1).one_finger_drag(!1).on("transform",function(){q.scroll(-d3.event.transform.translate[1],!1)}),M&&!K&&q.container()&&(K=new Ve(g,q)),d(a.background_event_layer(),e()),d(a.foreground_event_layer(),f()),a.on("active_tool."+p,c),d3.select(document).on("keydown."+p,b.bind(this,null)),window.addEventListener("beforeunload",function(a){if(S&&R){var b="You have not saved your work. Are you sure you want to leave the page?";return(a||window.event).returnValue=b,b}}),L&&void 0!==ad.ui.Keyboard&&"undefined"!=typeof $&&(w=ad.ui.Keyboard(),w.width(Q).position("center")()),q.container().on("dragover",function(){d3.event.preventDefault()}).on("drop",function(){g.handleDrop()}),this};T.needsSaving=function(a){return 0===arguments.length?R:(R=a,this)},T.askConfirmationOnClosing=function(a){return 0===arguments.length?S:(S=a,this)},T.insertElementFromInsertButton=function(a){w&&w.abort(),T.simulateStartOfInteraction();var b="auto",c={};c.pos=b,c.select_on_create=!0,c.select_text_on_create=!0;var d=!0;switch(a){case"derivation":T.inputDL(b,"toolbar"),d=!1;break;case"textbox":q.createElement("textbox",c);break;case"graph":q.createGraph({pos:b});break;case"ggb":T.insertGGB(b);break;case"ggb-table":U(b);break;case"table":q.createElement("table",{pos:b});break;case"video":q.createElement("video",{pos:b},"toolbar");break;default:console.warn("unknown element type",a)}d&&T.simulateEndOfInteraction()},T.closeKeyboard=function(){w&&w.abort()},T.insertGGB=function(a){var b=600,c=400,d="auto"===a?"auto":{x:"number"==typeof a.x?a.x-b/2:a.x,y:"number"==typeof a.y?a.y-c/2:a.y},e=q.createElement("ggb-element",{pos:d,size:{width:b,height:c}},"toolbar");return q.createElement("ggb-panel",{ggbElement:e},"toolbar"),e};var U=function(a){var b=600,c=600,d="auto"===a?"auto":{x:"number"==typeof a.x?a.x-b/2:a.x,y:"number"==typeof a.y?a.y-c/2:a.y},e=q.createElement("ggb-element",{pos:d,size:{width:b,height:c},ggb_params:{showMenuBar:!1,showAlgebraInput:!1,showToolBar:!0,customToolBar:"0|40",showResetIcon:!1,enableLabelDrags:!1,enableShiftDragZoom:!1,enableRightClick:!1,errorDialogsActive:!1,useBrowserForJS:!0,preventFocus:!1,language:"en"},ggb_base64:"UEsDBBQACAgIALyC9kgAAAAAAAAAAAAAAAAWAAAAZ2VvZ2VicmFfamF2YXNjcmlwdC5qc0srzUsuyczPU0hPT/LP88zLLNHQVKiu5QIAUEsHCEXM3l0aAAAAGAAAAFBLAwQUAAgICAC8gvZIAAAAAAAAAAAAAAAAFwAAAGdlb2dlYnJhX2RlZmF1bHRzMmQueG1s7ZpLb9s4EIDP219B6NQ9xJZky3aCOEVaYLEB0nSxCYq90tJY5oYitSIVy/n1S5F6OX7UVtzEbXMxOfTw9c1wSFE6/5BFFD1AIghnY8vp2BYC5vOAsHBspXJ6MrI+XLw7D4GHMEkwmvIkwnJseblmVU9JHdfr5WUoE+SM8RscgYixD7f+DCJ8zX0stepMyvis253P552y0Q5Pwm4Yyk4mAgupATExtorMmWpuqdK8p9Vd23a6/3y+Ns2fECYkZj5YSA02gClOqRQqCxQiYBLJRQxja5oyPx/FzVecWIjiCdCxxVJKLVTUGVsDz7p499u5mPE54pN/wVdlMkmh0tdCN9dRf3/ilCcoGVuu3beQQqYITPQvpvEMq1xn6BltiheQoAdM8791CU4l93UDunSKqYBSV3X1mQdg/ukX+oxEmiISEmJlLQuJGCDQOTND1XGsOtLWq9o77xYYVoBQImQ1sWstVCCcnr1KwrS5HYWtQTj2UxQnuXdp7UlYc/M8ra7TSZEWFfL8K6NT7REGt3JBAckZ8e8ZCOWcbqNSnvmTBAHk68fUiTlh8pY8FmPwmqW6KV184mw3TszpIuSsov1XKVcmGhoLtRnivv7teD1tJ89ZcXDntY20HWFOZ4mhKaghOi8G0d4QIuxjJqictoFPSej9NAH4vRkq1kSKPXE01/3LAnHWr3uf8yQQKBtbN/jGQosifTTpHsvcbgE4gBiY8jS5RNlpRXkw0pjzZGKSHxtz71CYvzRDqeO2guu4ZvvS6ZsbL/G9Yn9DSJY2LKf3RvnAlJe9uP9LBmKtYiiK/Hds+TyKKWQHRE+5n4r6rGykCvzo+TvgUR0I8p4yQglOFqs97X1S2vYA0jicXS8fzNyfjukOrtzmGAr/sSXnJ8r3iU/kdvQCwlyqaN6Wcm2AdgeOX88APJU07+uKSUgE6DsGsTKZe4D4TlX+wu4SzER+k2J0SoybbbXLxYXbbm/dHPvdV3/6/jaQjTCevxEemeseMuomeLFt2be7ATtidj/qsn9QbfJ6wX8txMpS627o3iy1xlJrDog4kSAIZtstICGrd8g7LTRuPY4S/+bJ+JwRvxrcJyNV0+kf5Wxe+uoWSAjMrDuBUGYX70QWtpkTeixLMqcoWThFyWOR0e2oISckQ5dlvctS/dItM70y0y8zXgNcu0OdNnGsfLsR358EjX67U90xXwD/xKZ+gV1GMQ9r618ZqXHraOLClKgBMhypCqZHwj5i/z5MeMqCleEcJoo4rx9FNmNjaQRJI57elHKFzjPk1DDS8o6hnNAuEdT51kwFJYHCEhHl0yfq5B7hLL/dQHgiOE0l3PoJAKtfvRo7zEkgZ/nTtXbErHTtIp2SLIdiVGc8IY+cycqPUG7XS6rf2jZN2Wb5PbVIPuHn2gSzkNaudmmk2h7mjlcrPb34WW+mJmG7ADzouKOeM/J69tAZnnqjwY7AndEBgR/spewBo/deTuAWfSR+42bf3uQZ9mjoDgb9geudng6dQX/4bE+ZcE4B18+PH0u58UZgZfluCnC7G+A7npP8Gfj3E54tedR+D9F/VAX15xCvcypshJaXOCn0dn2O7ja+LemW369c/A9QSwcILVCearIEAABGIwAAUEsDBBQACAgIALyC9kgAAAAAAAAAAAAAAAAXAAAAZ2VvZ2VicmFfZGVmYXVsdHMzZC54bWztl8lu2zAQhs/NUxC8R6uVDVYCIz20QBK0yKVXmhrLbCVSIelFebW+Q5+pFEU6yuIUNVy0BXIxh8PhkPp+ciSPL9Z1hZYgFRM8x3EQYQScioLxMscLPTs8wRfnB+MSRAlTSdBMyJroHGdd5Gae6QVJlnY+tFbsjIsbUoNqCIVbOoeaXAlKtA2da92cheFqtQp80kDIMixLHaxVgZHZEFc5dsaZSfdo0iq14UkUxeGX66s+/SHjShNOASOz2QJmZFFpZUyooAaukW4byHFTEQ6pWaMiU6hy/Mn232PkZuQ4NXnx+cG7sZqLFRLTr0CNV8sFbCbZTtjFmOFLUQmJZI5PTzEyxJLYtFPXkqqZkxxHQdbHV6QFiZbEJIl6D1loQW0K652RSoGPNYtdiwL6kVHvpULIQqF1l9Swbl1779pV39rQGek0dKsFscvKONzqtgKk54x+46BUtxeHxxkfWFFAdxi6OePQIXwGkwrO6ADmR67NcTC8jMyILuQShlzjbDeuSZZZsHFybMFGA6zxvrASzmp7PJHS0HRPjlQDUFhrw8acntZei2G+l4AmrwF9NwZWAl8aAEIqc10id+3ayKvpPevY6xw7z70zbB6zZcnWaOLnTXz4JPFG6o2RN7LBEYE73u9ddb85ZnVTMcr067qTNVMD2Sdd99EViqN0J6kjK3T0TOboP5X5Cd2GSFMTjWTUrNHbYJ76x/dfXLPuJlEiNShG+AD8ZTfwlPzRG/ntKBtRtXMopOAPb4CB64Fj6l4Cu8j+u+zjLLX0s/gZ/tHfxr8d5d2CFPYku2f77PtDiPFuFT8abTmOx3t7j/6psh1tL9v9kK/MrTfukz1VdDQ58saxN068cbq5zdslVQs5M99rL5UaN/RY3dE/q+6eq028W7XhoDcsbjp7CC97qy9P4IWDr/bQ/zM4/wlQSwcIDmF7u7sCAACgDAAAUEsDBBQACAgIALyC9kgAAAAAAAAAAAAAAAAMAAAAZ2VvZ2VicmEueG1s3Vptc9s2Ev6c/goMP92LJQEgQYoZKR3biXuZSZvMOe3c3De+QBJjimRJypY7/fG3C4AUJdmKaTs5ubZpkCCwwD7PYncBafLjepmSa1lWSZ5NLTakFpFZlMdJNp9aq3o2GFs/vvlhMpf5XIZlQGZ5uQzqqSWwZdsPnoZc2FiXxFPLphELPEcOZOi5AycM/YEfRs5gFvoeE44nZjPbImRdJa+z/JdgKasiiORltJDL4EMeBbUSuqjr4vVodHNzM2yGH+blfDSfh8N1FVsEpp5VU8vcvAZxW51ubNWcU8pG//n5gxY/SLKqDrJIWgTVWiVvfng1uUmyOL8hN0lcL6aW7/kWWchkvgA9PZ9ZZISNClC2kFGdXMsKunYelc71srBUsyDD96/0HUlbdSwSJ9dJLMupBWBRh/uU+sy3qXCY7VkkLxOZ1aZxM+ioETe5TuSNlot3akiH+tDvOqmSMJVTaxakFaiVZLMSIIUZlSt4rOrbVIZB2TxvJsRO1C80Sf6QKA3Y00hMrbHDTmzhn3iUnghB9Ww6QwvGLVLneaokU/InYURQuAjzyQlxPajhhAniQM0YajxiY51gDrEJNmE2cRwoHaxmLr4T0F9QwhhUE04J54Qzwm14FIIIlwgPO3Jo6/pKGIULW8N04LKxzrbhUnW2AxfHOxAktBiYhLBddSewNcgXHKevKu0xcXwYCCuEx4gNc4BnjxKQaKN4ppRwKME/RhwUzz3CxwTkgd4omfIDpJjnDSumYoeWhhTRJYUBGXi5cCm2dkhxtikBBijodoIF0wVO13X1K6rrqK0LrgtHF0K3cXR3RzfV2lJHt3Hsp6rZKGn3UXLcUZKhEkAKzl4VNsF5MzV/LBzz6OpHZWqUUVM7xn8+PgAm7ljdPFEn+1E6sc6oepX2GbQZ0nfHDx/yaTbaqsnvUpOLe9R8IrrNoEx0BoWx1J+69oa0e+m55yEfMaK7tQqf4p4fMbhH73QBumSmPATJs01qMmoC1sRMiFQLbGvsu5bLCqdo+23scNG7mwDi8U4AOcEQ4opNFMEYMt6KImLcCSUQR1ys9FRcgjEwEOiwwp0mspyY2PLnXmyBUOBsogFMDUWhnzHhAEbn3YDAwXlw4qEfheiGfoRwEMkJxBEX+90TKyxS5FXS4rqQadESoiBMsmJVG9hMfbSMGwjrHJoHqcqLTIc4j67OdpCWQVU399AIMopN4qIzjK285tUkDUKZQvp3iUZAyHWQoh0r+bM8q0ljANxS4lQKNZGrKE3iJMh+A9abdOWX1TKUJVG3OeqohGB30uZa6LPaXIvaukmU52V8eVuBkZD1f2UJnR0PctPuD8B3q1/ZXAz9zg9IrKIArdvxt174Y+x03zs9tLy+lHUN6lckWMuqQW5e4vIyJODD++osTzdVRZ5k9XlQ1KtSZc7gIEtU6jSbp1IhqTiGFDS6CvP1pXaerpb1+baQLcbh/DxP85LA4uNCQANThrpUbXBmbSuq2lDVwshAoe175nPVQpWhLlUrIFlPzWjKGjVpM0pSEf28ZVHKQDCfXWVJ/aF5qJPoaqMottf0NxBui2TPJHIy2rG8yZUsM5lqK8qAyFW+qrQRa6rUPFaV/BTUi9Ms/recwwL8FKD7q0G0brqZcSyjZAkddb1BLkBWf4Wp6tpYzkvZaKgXpMbVrB1SFaUM4mohZd2iq22822wj+qLMl++z689gQjtTn4wa/SZVVCYFWioJwT9fyY0xxkkVgHePu/0AjAq0itDdALA1gmqRYFUv8lLtTYIaa3Apr2G2Fe7rNC1kai3BjazB2wzU+pzIVC5hq0JqZbfZainLJGpJXKptEEx7ZTQb4L5QL32gkOThF/A2m/iue20Qh/f32DYJ0mIR4PbJuJI0uEX/0oFPSfs5j83QrAEVOFSag0sptDUVUmo7rM3qIwWIU4u3g7ZR9W5YQgMLfwAq4S4q/K8ICgQkg8ktmZK/Lck/yPrv5J8kbCSiz9FxaBsuXd/K2MNly00YkOQ1bnkeDA99IDzd9VmRNfhyPNa4NYcjf4A9t9RtPGi9AF8FO/VKZdYtenjzrySOZdbCLn/PdJdKezZAK02ipN6FNsqXyyCLSabysk8YX6xNUhBQhEnrvqqbmlMtxHTdA1kFqRbF032Ut61vH2ZwInGiTQa6fTS9yn0OGNeRS5Umcj2UiY+zWSVrBH6sYWeHaHqAFbO7rLhLMPBpq6EGzpD6imPWTFJhhuFajyq6tTvO+6nsnfVh76z3GvmLkseGtnA0e8Cjy78BfR9LiJLzPAvSD+imtnk8A2zY1FqfQmqzR2l0mNItrxd9bT32iwaPdncDZvwdNf5OI/xsDi9ZPsThHcT89BDmcQ/M42PFXLmkI4T89k7IZQ/I5bFATg3kgzauK+9/TKCfHQJ91gP02fGCrp32d0b9fYZ7PcBhB3B5CPDzPvH5/EGI35fD4qnIXBehLp4T+69mOfajwuR9oM4Ogfq2D6hvjxjUrycfz4tqdCgGvuuD6rujQ7WT022SkO8BanwI1Is+oF4cHaibXc63wfRSzrF+B9FzjejbPTTnh9GsjLQGrvm32+80x6x949xmrzOwtbW6dzLB95wGUMHHW/kePXikIA7HQEA1xR1Sa9Wg9P6Z55WUBZ40f8w+l0FW4Rc5tg87+1L7TlN7sUftoh+1i29HbTeB6bONPbCMaJupu57ofoDgvVgi32oiz/aITPoRmXwfIp8lE21oNKFGbbk8n/nO+AB9dkMfPyr+jI893ePvSz/+vrxA/nRUA/rGQ5ty7+WR9+6+xXfVj7yrF0SeyZU78W/wclffxX2rL+1HYPqCCNQ7yC5/x7/8HnYI/1OfJP+nZ6Ks2KfsKYfwXz1nx88KH/MxiT02uzIxZIJ1k59nOXXfhjrM81QGWQtmsfsJ6ubM6v92sGW+zkFmyVrGdxvhYaXKl6nUqPt1AvUtIPMF7Tf/A1BLBwiaLk/eqggAAFEuAABQSwECFAAUAAgICAC8gvZIRczeXRoAAAAYAAAAFgAAAAAAAAAAAAAAAAAAAAAAZ2VvZ2VicmFfamF2YXNjcmlwdC5qc1BLAQIUABQACAgIALyC9kgtUJ5qsgQAAEYjAAAXAAAAAAAAAAAAAAAAAF4AAABnZW9nZWJyYV9kZWZhdWx0czJkLnhtbFBLAQIUABQACAgIALyC9kgOYXu7uwIAAKAMAAAXAAAAAAAAAAAAAAAAAFUFAABnZW9nZWJyYV9kZWZhdWx0czNkLnhtbFBLAQIUABQACAgIALyC9kiaLk/eqggAAFEuAAAMAAAAAAAAAAAAAAAAAFUIAABnZW9nZWJyYS54bWxQSwUGAAAAAAQABAAIAQAAOREAAAAA"});return e.events.on("ggb_init",function(){e.ggbApplet.setCoordSystem(-10,10,-10,10),q.elements().forEach(function(a){"table"==a.type&&a.setGraph(e)})}),e};T.id=p,T.logger=function(a){r=a,r.events.on("interaction."+p,this.addInteractionSummaryToTimeline.bind(this))},T.model=function(){if(0===arguments.length)return q},T.use_keyboard=function(a){return 0===arguments.length?L:(L=a,this)},T.keyboard_max_width=function(a){return 0===arguments.length?Q:(Q=a,this)},T.use_hold_menu=function(a){return 0===arguments.length?M:(Array.isArray(a)&&T.hold_menu_options(a.filter(function(a){return-1!==O.indexOf(a)})),M=!!Array.isArray(a)||a,M&&!K&&q.container()&&(K=new Ve(T,q)),this)},T.hold_menu_options=function(a){if(0===arguments.length)return O;O=a},T.color=function(a){return 0===arguments.length?E:(E=a,this)},T.markerRadius=function(a){return 0===arguments.length?C:(C=a,this)},T.eraserRadius=function(a){return 0===arguments.length?D:(D=a,this)},T.hwr_delay=function(a){return 0===arguments.length?z:(z=a,this)},T.hwr=function(a){return arguments.length?y===a?T:(y=a,B=q.paths.length,y||T.cancelHWR(),T):y},T.drawing=function(a){return arguments.length?(l=a,this):l},T.scheduleHWR=function(){A||(A=setTimeout(T.performHWR,z),o.start_hwr())},T.cancelHWR=function(a){a||(B=q.paths.length),A&&(clearTimeout(A),A=null,o.stop_hwr())},T.performHWR=function(){if(A=null,o.stop_hwr(),!(B>q.paths().length-1)){var a=q.paths().slice(B),b=!1,c=[];gm_hwr_request(a,function(d,e){d&&console.log(d);var f=a[0].points[0];try{b=q.createDL({pos:{x:f[0],y:f[1]},eq:e})}catch(a){return}for(var g=function(a){try{q.removePath(a),c.push(a)}catch(a){return}},h=0;h<a.length;h++)g(a[h]);B=q.paths().length}),B=q.paths().length}},T.font_smaller=function(){var a=parseInt(q.fontSize());a/1.2>24&&this.set_font_size(a/1.2)},T.font_larger=function(){var a=parseInt(q.fontSize());1.2*a<160&&this.set_font_size(1.2*a)},T.set_font_size=function(a){q.fontSize(a),q.dls().forEach(function(a){return a.render(!1)}),"inspect"===q.getActiveTool()&&tb.drawTraces(q.getElementsOfType("derivation")),o.font_size(new _(a))};var V=function(a){this.type="hold",this.subtype=a.subtype,this.performee=p,this.performee_type="CanvasController",this.time=Date.now(),this.finger={pos:[a.finger.pos[0],a.finger.pos[1]]},this.fingers=a.fingers.map(function(a){return{pos:[a.pos[0],a.pos[1]]}})},W=function(a){this.type="touch",this.subtype=a.subtype,this.performee=p,this.performee_type="CanvasController",this.time=Date.now(),this.finger={pos:[a.finger.pos[0],a.finger.pos[1]],pos0:[a.finger.pos0[0],a.finger.pos0[1]]},this.fingers=a.fingers.map(function(a){return{pos:[a.pos[0],a.pos[1]]}})},X=function(a){this.type="drag",this.subtype=a.subtype,this.performee=p,this.performee_type="CanvasController",this.time=Date.now(),this.finger={pos:[a.finger.pos[0],a.finger.pos[1]]},this.fingers=a.fingers.map(function(a){return{pos:[a.pos[0],a.pos[1]]}})},Y=function(a){this.type="release",this.subtype=a.subtype,this.performee=p,this.performee_type="CanvasController",this.time=Date.now(),this.finger={pos:[a.finger.pos[0],a.finger.pos[1]]},this.fingers=a.fingers.map(function(a){return{pos:[a.pos[0],a.pos[1]]}})},_=function(a){this.type="fontSize",this.performee=p,this.performee_type="CanvasController",this.time=Date.now(),this.font_size=a},aa=function(a){this.type="enteredTerm",this.performee=p,this.performee_type="CanvasController",this.time=Date.now(),this.eq=a.eq,this.dl_id=a.id,this.options=ad.deepCopy(a)},ba=function(){this.type="keyboard",this.performee=p,this.performee_type="CanvasController",this.time=Date.now()},ca=function(a){if(M&&!J){var b=a||d3.event;!a&&d3.event&&o["start-of-interaction"]({type:"start-of-interaction",source:{type:"CanvasController",id:p},time:Date.now()}),b.fingers.length>1&&(J=!0)}};T.menu_touch=ca;var da=function(a){if(!(!M||J||L&&w.visible())){var b=a||d3.event;!a&&d3.event&&o.hold(new V(ad.extend(d3.event,{subtype:"menu"}))),q.setActive(),m=b.finger.pos.slice(),K.setPos(b.finger.pos_client.slice()),K.setVisible(!0)}};T.menu_hold=da;var ea=function(a){if(!J&&M&&K.visible){var b=a||d3.event;!a&&d3.event&&o.drag(new X(ad.extend(d3.event,{subtype:"menu"}))),K.visible&&K.highlight(b.finger.pos_client.slice())}};T.menu_drag=ea;var fa=function(a){var b=a||d3.event;if(!a&&d3.event&&o.release(new Y(ad.extend(d3.event,{subtype:"menu"}))),J)return void(0===b.fingers.length&&(J=!1));K&&K.visible&&(K.performAction(b.finger.pos_client.slice(),m),K.setVisible(!1)),a||!d3.event||w&&w.visible()||T.simulateEndOfInteraction()};T.menu_release=fa;var ga=function(a){if(!P&&l){var b=a||d3.event;!a&&d3.event&&(T.simulateStartOfInteraction(),o.touch(new W(ad.extend(d3.event,{subtype:q.getActiveTool()}))));var c=b.finger.pos0.slice();c[1]-=G,T.cancelHWR(!0);var d=[[c[0],c[1]]],e=null;"draw"===q.getActiveTool()?e=q.createPath({points:d,color:E,width:2*C}):"erase"===q.getActiveTool()&&(e=new Ue(q.front_svg().node(),{points:d,color:"white",width:2*D}),e.head=q.front_svg().append("circle").attr({cx:c[0],cy:c[1],r:D}).style({stroke:"silver",fill:"white"})),H[b.finger.id]=e}};T.draw_touch=ga;var ha=function(a){if(!P&&l){var b=a||d3.event;!a&&d3.event&&o.drag(new X(ad.extend(d3.event,{subtype:q.getActiveTool()})));var c=H[b.finger.id],d=b.finger.pos.slice();c&&(d[1]-=G,c.points.push(d),"draw"===q.getActiveTool()?q.updatePath(c):"erase"===q.getActiveTool()&&(c.update(),c.head.attr({cx:d[0],cy:d[1]})))}};T.draw_drag=ha;var ia=function(a){if(!P&&l){var b=a||d3.event;!a&&d3.event&&o.drag(new Y(ad.extend(d3.event,{subtype:q.getActiveTool()}))),"draw"===q.getActiveTool()&&(!y||w&&w.visible()||T.scheduleHWR());var c=H[b.finger.id];"erase"===q.getActiveTool()&&(ja(c),c.head.remove(),c.remove()),delete H[b.finger.id],!a&&d3.event&&o["end-of-interaction"]({type:"end-of-interaction",source:{type:"CanvasController",id:p},time:Date.now()})}};T.draw_release=ia;var ja=function(a){var b=q.paths().slice(),c=[],d=[],e=[];b.forEach(function(b,f){var g=D+b.width/2,h=Fb([b.points],a.points,g);if(0===h.length)d.push(b),q.removePath(b);else{e.push({path:b,points_before:b.points.slice(),points_after:h[0].slice()}),b.points=h[0],q.updatePath(b);for(var i=1;i<h.length;i++){var j=q.createPath({points:h[i],color:b.color,width:b.width,oid:b.id});c.push(j)}}}),n={removed:d,modified:e,added:c}};T.addInteractionSummaryToTimeline=function(a){if(1!==a.length||"rewrite"!==a[0].subtype||a[0].new_state&&a[0].new_state!==a[0].old_state||a[0].created_elements){R=!0,1===a.length&&"save"===a[0].subtype&&(R=!1);var b=Ee.entry(a,q);b&&("erase"===b.type&&(b.modification=n,n=null),t++,s[t]=b,s.length=t+1,o["undoable-action"](b.type))}},T.reset=function(){r.listen(!1),q.reset(),r.canvas_logger.reset(),s=[],t=-1,u=null,v=!1,F.transform({translate:[0,0]}),H={},I=null,J=!1,R=!1,r.listen(!0)},T.undo=function(){if(-1===t)return!1;r.listen(!1);var a=s[t];return t--,a.undo(q,this),tb.hideTermTraces(q.back_svg(),q.html_container()),r.listen(!0),!0},T.redo=function(){return!(s.length<=t+1)&&(r.listen(!1),t++,s[t].redo(q,this),r.listen(!0),!0)},T.clearInteractionTimeline=function(){t=-1,s=[]},T.clear_undo_queue=function(){throw"(CanvasController) Deprecated method `clear_undo_queue` called."};var ka=function(a,b,c){if(I){if(""===a)return void g();if(I.eq=a,I.id=ad.uid(),o.entered_term(new aa(I)),!Id.isParsable(a))return void w.warning("Could not parse expression.",null);var d=void 0;try{d=q.createDL(I,null,b),I=null,c&&c(d)}catch(a){return console.log(a),void w.warning("Could not parse expression.",null)}g(),o["end-of-interaction"]({type:"end-of-interaction",source:{type:"CanvasController",id:p},time:Date.now()})}},la=function(){g(),T.simulateEndOfInteraction()};return T.inputDL=function(a,b,c){x||(o.keyboard(new ba),T.cancelHWR(!0),I={pos:"auto"===a?"auto":{x:a.x,y:"number"==typeof a.y?a.y-G:a.y},v_align:"center",h_align:"equals",select_on_create:"toolbar"===b},w.caption(null).latex("").on("done",function(a){ka(a,b,c)}).on("cancel",la).visible(!0))},T.disableKeyboard=function(a){x=a},T.simulateStartOfInteraction=function(){o["start-of-interaction"]({type:"start-of-interaction",source:{type:"CanvasController",id:p},time:Date.now()})},T.simulateEndOfInteraction=function(){o["end-of-interaction"]({type:"end-of-interaction",source:{type:"CanvasController",id:p},time:Date.now()})},T.handleDrop=function(a){var b=a||d3.event;b.preventDefault&&b.preventDefault();var c=q.container().node(),d=c.getBoundingClientRect(),e=[b.clientX-d.left-c.clientLeft,b.clientY-d.top-c.clientTop],f=b.math_str||j(b.dataTransfer)||k(b.dataTransfer);if(f)if("http"===f.slice(0,4)){var g={drop_evt:f,pos:{x:e[0],y:e[1]}};T.simulateStartOfInteraction(),q.createElement("image",g,"drag-n-drop"),T.simulateEndOfInteraction()}else{var l=function(){for(console.log("dropped",f),f=f.replace(/\\end{aligned}/g,""),f=f.replace(/\\end{alignat}/g,""),f=f.replace(/\\end{alignedat}/g,""),f=f.replace(/\\displaystyle/g,""),f=f.replace(/\\\,/g,""),f=f.replace(/\&/g,""),f=f.replace(/\\begin{aligned}/g,""),f=f.replace(/\\begin{alignat}{[0-9]*}/g,""),f=f.replace(/\\begin{alignedat}{[0-9]*}/g,""),f=f.replace(/\\\;/g,""),f=f.replace(/\\ /g,""),f=f.replace(/\\quad/g,"");;){var a=f.replace(/[.,\s\\]+$/,"");if(a===f){if((a=i(f))===f)break;f=a}else f=a}for(var c=[],d=f.split(/{?\s*\\text{(.*?)}\s*}?/),g="",j=0;j<d.length;j+=2){var k=d[j],l=d[j+1];if(g+=k,l&&"_"===g[g.length-1])g=g.substr(1,g.length-1)+'"'+l+'"';else{var m=g.split("\\\\"),n=!1;m.forEach(function(a){var b=a.replace(/[.,]+$/,""),d=b.split("="),e=d[0];d.forEach(function(a,b){if(!(0===b&&d.length>1)){var f=1===d.length?a:e+"="+a;Id.isParsable(f)?(c.push(f),n=!0):n=!1}})}),g=n?"":m[m.length-1]+'"'+l+'"'}}if(0===c.length)return q.showNotice("We could not parse the math data. It is being displayed as an image.",!0,"warning"),console.log("Could not parse equation!"),h(b.img_url||b,{x:e[0],y:e[1]}),{v:void 0};try{!function(){var a=function a(b,d){b>=c.length||q.createElement("derivation",{eq:c[b],pos:d},"drag-n-drop",function(c){a(b+1,{x:c.pos.x,y:c.pos.y+c.size.height+1})})};T.simulateStartOfInteraction(),a(0,{x:e[0],y:e[1]})}()}catch(a){q.showNotice("We could not parse the math data. It is being displayed as an image.",!0,"warning"),console.log("Could not parse equation!",a),h(b.img_url||b,{x:e[0],y:e[1]})}finally{T.simulateEndOfInteraction()}}();if("object"==typeof l)return l.v}else{console.log("could not parse drop data",b);var g={drop_evt:b.img_url||b,pos:{x:e[0],y:e[1]}};T.simulateStartOfInteraction(),q.createElement("image",g,"drag-n-drop"),T.simulateEndOfInteraction()}},d3.rebind(T,o,"on")}function Sb(a){this.modal=null,this.init(),this.events=d3.dispatch("identified"),this.max_idle_time=a,this.timer_id=null,this.resetTimer(),this.showGlassPane(!0)}function Tb(a,b){this.id=bd(),this.modal=null;var c=b||{};this.video_size={width:c.video_width||"80%",height:c.video_height||"80%"},this.player=null,this.sources=a,this.videoInfo={},this.max_idle_time=c.max_idle_time,this.timer_id=null,this.resetTimer(),this.visible=!1,this.single_video_mode=!1,this.endTimer=null,this.startTimer=null,this.volume=100,this.target_volume=40,this.max_volume=null,this.init(),this.createPlayer(function(){this.player.mute(),this.cueVideoList(this.sources)})}function Ub(a){"homework"===a.value?setTimeout(function(){return $("button#problems").trigger("click")},0):We.controller.insertElementFromInsertButton(a.value)}function Vb(a,b){var c=d3.select(a).append("ul"),d=c.selectAll("li").data(Xe).enter(),e=d.append("li"),f=e.filter(function(a){return a.header}),g=e.filter(function(a){return!a.header});f.classed("dropdown-header",!0).text(function(a){return a.label});var h=g.append("a").attr("href","#").style("padding","10px 20px").on("click",function(a){d3.event.preventDefault(),Ub(a)}),i={"vertical-align":"bottom",position:"relative",height:"1.8em",left:"-0.5em",top:"0.15em"};return h.filter(function(a){return a.icon}).append("img").style(i).style("opacity",.5).attr("src",function(a){return Ye+a.icon}),h.filter(function(a){return!a.icon}).append("span").style(i).style("width","1.8em").style("display","inline-block").style("opacity",.5).attr("class",function(a){return a.class||null}),h.append("span").text(function(a){return a.label}),c.node()}function Wb(a,b){var c=arguments.length<=2||void 0===arguments[2]?null:arguments[2];We=a,Ye=b,Xe=[{label:"select one:",header:!0}];for(var d in Ze)c&&(!c[d]||Ze[d].cond&&!Ze[d].cond(We))||Xe.push(Ze[d]);We.appendButtonGroup([{type:"dropdown",label:"insert",icon:"glyphicon glyphicon-plus-sign",html_fn:Vb}],null,!0)}function Xb(a){window.GGBApplet&&a?a():$e.push(a),_e||(_e=!0,ad.loadScripts(["https://tube.geogebra.org/scripts/deployggb.js"],function(){$e.forEach(function(a){return a()}),$e=[]}))}function Yb(a){function b(a){for(var b=0;b<bf.length;b++)for(var c=bf[b],d=0;d<c.subchapters.length;d++){var e=c.subchapters[d];if(-1!==e.problems.indexOf(a))return{chapter:c,subchapter:e}}return null}function c(){j(bf[0].subchapters[0])}function d(){u.selectAll(".problem").remove()}function e(a){return String.fromCharCode(97+a)}function f(a,b){return q=a,r=g(q),h(r),$(q).on("shown.bs.dropdown",function(){c()}),$(q).on("hide.bs.dropdown",function(){d()}),r.node()}function g(a){var b=22,c=d3.select(a).append("div").style("width",v.col1+v.col2+b+"px").style("padding","5px").on("click",function(){d3.event.stopPropagation()});return c.append("p").text("click on a problem, then on the canvas").style("color","gray").style("font-style","italic").style("text-align","center"),c}function h(a){s=a.append("div").style("width",v.col1+v.col2+2+"px").style("height",v.height+2+"px").style("margin","5px").style("border","1px solid silver"),t=s.append("div").classed("panel",!0).style("width",v.col1+"px"),u=s.append("div").classed("panel",!0).style("width",v.col2+"px"),a.selectAll(".panel").style("height",v.height+"px").style("border","none").style("margin","0px").style("display","inline-block").style("overflow-y","scroll").style("overflow-x","hidden");var b=t.selectAll(".chapter").data(bf);b.enter().append("div").classed("chapter",!0).append("div").style("width",v.col1+"px").style("height",v.row1+"px").style("background-color","#e6e6e6").style({"-webkit-user-select":"none","-moz-user-select":"none","-ms-user-select":"none"}).style("overflow","hidden").style("padding-left","5px").style("line-height",v.row1+"px").append("p").html(function(a){return a.title}).style("font-weight","bold").style("pointer-events","none"),b.selectAll(".subchapter").data(function(a){return a.subchapters}).enter().append("div").classed("subchapter",!0).append("div").style("width",v.col1+"px").style("height",v.row1+"px").style({"-webkit-user-select":"none","-moz-user-select":"none","-ms-user-select":"none"}).style("overflow","hidden").style("padding-left","5px").style("line-height",v.row1+"px").style("cursor","pointer").on("click",j).append("p").html(function(a){return a.title}).style("pointer-events","none")}function i(b){b.video&&(d3.event.stopPropagation(),d3.event.preventDefault(),k(),window&&window.gmath_log_ga&&window.gmath_log_ga.trackEvent("Homework Menu","play video",b.video,"1"),a.video_modal.playSingle(b.video))}function j(b){var c=b.title.split(" ")[0];r.selectAll("div.subchapter").style("background-color",function(a,c){return a==b?"#e7f5fe":c%2==0?"whitesmoke":"white"}),u.selectAll(".problem").remove();var d=u.selectAll(".problem").data(b.problems),f=d.enter().append("div").classed("problem",!0).style("position","relative").style("width",v.col2+"px").style("background-color",function(a,b){return 0==a.parts.length?"#e6e6e6":b%2==0?"whitesmoke":"white"}).style({"-webkit-user-select":"none","-moz-user-select":"none","-ms-user-select":"none"}).style("cursor",function(a){return 0==a.parts.length?"default":"pointer"}).each(function(b,c){b.alignment||(b.alignment=m);var d=d3.select(this),f=0,g=0,h=0,j=0,k=d.append("div").style("position","relative").style("width",v.col2+"px").style("pointer-events","none");b.video&&d.append("div").classed("gm-homework-play-btn",!0).on("click",i).append("span").classed("glyphicon glyphicon-play",!0);var l=(k.append("p").html(b.num).style("left","5px").style("width","30px").style("text-align","right"),k.append("p").html(b.text).style("left","45px").style("width",v.col2-18-90+"px"));k.selectAll("p").style("position","absolute").style("margin","0px").style("top","15px").style("font-weight","bold").style("color","lightskyblue").style("pointer-events","none");var o=parseFloat(l.style("height"))+15;0==b.parts.length&&(o+=15),k.style("height",o+"px"),g+=o,"row"==b.alignment&&(d=d.append("div").style("position","absolute").style("left","50%").style("transform","translateX(-50%)").style("-webkit-transform","translateX(-50%)"));var p=d.selectAll(".part").data(b.parts);p.enter().append("div").classed("part","true").style("position","relative").style("pointer-events","none").each(function(c){var d=d3.select(this),i=0,k=0;if("derivation"==c.type){var l=d.append("div").style("pointer-events","none"),m=new Id(c.options.eq),o={font_size:20,v_align:"center",fixed:!0},p=function(a){var c=a.getBBox();k=c.height+30,"row"==b.alignment?(i=c.width+80,f+=i,l.style({position:"absolute",top:"50%",transform:"translateY(-50%)","-webkit-transform":"translateY(-50%)"})):"column"==b.alignment&&(i=v.col2-18),d.style("width",i+"px"),l.style({width:i+"px",height:k+"px"});var e="translate("+i/2+"px,"+k/2+"px)";a.main.style("transform",e).style("-webkit-transform",e)};new te(m,l.node(),o,p)}else if("textbox"==c.type){var q=d.append("p").html(c.options.text).style("margin","0px").style("pointer-events","none");"row"==b.alignment?(i=q.node().clientWidth+40,f+=i,q.style("position","absolute").style("top","50%").style("transform","translateY(-50%)").style("-webkit-transform","translateY(-50%)").style("text-align","center")):"column"==b.alignment&&(i=v.col2-18-90,q.style("position","absolute").style("left","45px").style("top",b.text?"10px":"0px")),d.style("width",i+"px"),q.style("width",i+"px"),k=q.node().clientHeight,c.options.size={width:i,height:k},c.options.font_size=parseFloat(q.style("font-size")),k+=20}else if("ggb-element"==c.type){var r=d.append("div").style("position","absolute").style("left","50%").style("top","50%").style("transform","translate(-50%, -50%)").style("-webkit-transform","translate(-50%, -50%)").style("width",n.width+"px").style("height",n.height+"px").style("border","1px solid black").style("overflow","hidden"),s=c.options;s.pos={x:0,y:0},s.size=n;new af(a.model,r.node(),c.options,function(a){a.element_div.style("pointer-events","none"),a.ggbApplet.setCoordSystem(s.xmin,s.xmax,s.ymin,s.ymax),a.ggbApplet.setAxisSteps(1,1,1,1),s.points.forEach(function(b,c){var d=String.fromCharCode(97+c).toUpperCase();a.ggbApplet.evalCommand(d+"=("+b.x+","+b.y+")"),a.ggbApplet.setColor(d,135,206,250),b.label&&(a.ggbApplet.setCaption(d,b.label),a.ggbApplet.setLabelStyle(d,3),a.ggbApplet.setLabelVisible(d,!0))}),s.lines.forEach(function(b,c){var d=String.fromCharCode(97+c);a.ggbApplet.evalCommand(d+":"+b.eq),a.ggbApplet.setColor(d,135,206,250),b.label&&(a.ggbApplet.setCaption(d,b.label),a.ggbApplet.setLabelStyle(d,3),a.ggbApplet.setLabelVisible(d,!0))})});"row"==b.alignment?(i=n.width+40,f+=i):"column"==b.alignment&&(i=v.col2-18),d.style("width",i+"px"),k=n.height+40}if("row"==b.alignment?(k>h&&(h=k),d.style("display","inline-block").style("height","100%")):"column"==b.alignment&&(g+=k,d.style("height",k+"px")),c.label){var t=d.append("p").html(e(j)).style("position","absolute").style("color","lightskyblue").style("pointer-events","none");"row"==b.alignment?t.style("top","50%").style("transform","translateY(-50%)").style("-webkit-transform","translateY(-50%)"):"column"==b.alignment&&t.style("left","5px").style("top","10px").style("width","30px").style("text-align","right"),j++}});"row"==b.alignment?(d.style("width",f+"px").style("height",h+"px"),g+=h,d3.select(d.node().parentNode).style("height",g+"px")):"column"==b.alignment&&d.style("height",g+"px")}).on("click",function(a,b){0!=a.parts.length&&(f.filter(function(b){return b==a}).transition().duration(150).style("background-color","#e7f5fe").transition().duration(150).style("background-color",b%2==0?"whitesmoke":"white").each("end",k),l(a,c))})}function k(){$("body").trigger("click")}function l(c,d){function e(){function b(d){if(c.parts.length>d){var e=function(a){"row"==c.alignment?g+=a.size.width+20:"column"==c.alignment&&(h+=a.size.height+20),b(d+1),"ggb-element"==c.parts[d].type&&(a.element_div.style("pointer-events","none").style("border","1px solid black").style("overflow","hidden"),a.ggbApplet.setCoordSystem(f.xmin,f.xmax,f.ymin,f.ymax),a.ggbApplet.setAxisSteps(1,1,1,1),f.points.forEach(function(b,c){var d=String.fromCharCode(97+c).toUpperCase();a.ggbApplet.evalCommand(d+"=("+b.x+","+b.y+")"),a.ggbApplet.setColor(d,135,206,250),b.label&&(a.ggbApplet.setCaption(d,b.label),a.ggbApplet.setLabelStyle(d,3),a.ggbApplet.setLabelVisible(d,!0))}),f.lines.forEach(function(b,c){var d=String.fromCharCode(97+c);a.ggbApplet.evalCommand(d+":"+b.eq),a.ggbApplet.setColor(d,135,206,250),b.label&&(a.ggbApplet.setCaption(d,b.label),a.ggbApplet.setLabelStyle(d,3),a.ggbApplet.setLabelVisible(d,!0))}))};a.controller.simulateEndOfInteraction();var f=c.parts[d].options;switch(f.pos={x:g,y:h},f.v_align="top",c.parts[d].type){case"derivation":a.model.createDL(c.parts[d].options,e,"homework-menu");break;case"textbox":a.model.createElement("textbox",c.parts[d].options,"homework-menu",e);break;case"ggb-element":f.size=o,a.model.createElement("ggb-element",c.parts[d].options,"homework-menu",e)}a.controller.simulateEndOfInteraction()}}a.model.setActive(),a.controller.simulateStartOfInteraction(),b(0)}var f=b(c);a.logger.logCustomInteraction("homework-menu",{action:"select",problem:c.num,chapter:f.chapter.title,subchapter:f.subchapter.title});var g=20,h=0;if(a.model.elements().forEach(function(a){var b=a.pos.y+a.size.height;b>h&&(h=b)}),h+=20,c.text){var i=d+"."+c.num,j=i+" "+c.text;a.model.createElement("textbox",{pos:{x:g,y:h},size:{width:472},text:j},null,function(a){h+=a.size.height+20,e()})}else e()}var m="column",n={width:200,height:200},o={width:400,height:400},p=0,q=null,r=void 0,s=void 0,t=void 0,u=void 0,v={col1:380,row1:40,col2:580,height:360};a.appendButtonGroup([{type:"dropdown",label:"problems",data_toggle:"dropdown",pull_right:!0,icon:"glyphicon glyphicon-book",html_fn:f}]),bf.forEach(function(a){a.subchapters.forEach(function(a){a.problems.forEach(function(a){a.parts.forEach(function(a){"textbox"==a.type&&(a.options.uneditable=!0),"ggb-element"==a.type&&(a.options.ggb_params={showToolbar:!1,borderColor:"#FFFFFF"})}),p++})})})}function Zb(a,b){var c=arguments.length<=2||void 0===arguments[2]||arguments[2];return b.model.getElementsOfType("derivation").map(function(b){var d=b.getLastRow(),e={der_row:d,actions:[]};return a.forEach(function(a){var b=a.from,f=a.to,g=a.from_mapping,h=a.to_mapping,i=c?$b(d.model,b,f,g):$b(d.model,f,b,h);e.actions=e.actions.concat(i)}),e})}function $b(a,b,c,d){var e=[new Id(b),new Id(c)],f=a.getMoveActions(e,[new Ld]);return f.forEach(function(a){return a.settings.mapping=d}),f}function _b(a){a.appendButtonGroup([{type:"dropdown",label:jf,data_toggle:"dropdown",pull_right:!0,icon:"glyphicon glyphicon-book",html_fn:kf.setupMenu.bind(kf,a)}])}function ac(a,b){a.appendButtonGroup([{type:"dropdown",label:"help",data_toggle:"dropdown",pull_right:!0,icon:"glyphicon glyphicon-question-sign",html_fn:gc.bind(null,a,b)}])}function bc(){return mf}function cc(){return+(localStorage.getItem("gm-help-version-shown")||"0")}function dc(a){localStorage.setItem("gm-help-version-shown",a)}function ec(){var a=cc();return mf.some(function(b){return b.version&&b.version>a})}function fc(a){var b=ec();d3.select(a).select(".btn").style("background-color",b?"lightyellow":null)}function gc(a,b,c,d){var e={width:320,row_height:40},f=hc(c,e);return fc(c),ic(a,f,e,c),kc(a,b),lc(0),f.node()}function hc(a,b){return d3.select(a).append("div").style("width",b.width+22+"px").style("padding","5px").on("click",function(){d3.event.stopPropagation()})}function ic(a,b,c,d){var e=cc(),f=b.append("div").classed("panel gm-help",!0).style("width",c.width+2+"px").style("height",c.row_height*mf.length+2+"px").style("margin","5px").style("border","1px solid silver"),g=f.selectAll(".block").data(mf),h=g.enter().append("a").style("background-color",function(a){return a.version>e?"lightyellow":null}).classed("block",!0).attr("href",function(a){return a.external_page?a.src:"#"}).attr("target",function(a){return a.external_page?"_blank":null}).style("width",c.width+"px").style("height",c.row_height+"px").on("click",function(c){window&&window.gmath_log_ga&&gmath_log_ga.trackEvent("gm-canvas-event","help-menu","choice",c.menu_title),c.disabled||(c.version&&c.version>e&&(dc(c.version),e=c.version,fc(d),b.selectAll("a").style("background-color",function(a){return a.version>e?"lightyellow":null})),$("body").trigger("click"),c.external_page||(c.video?(a.video_modal.playSingle(c.video),c.switch_on_sound&&a.video_modal.unMute()):(d3.event.preventDefault(),of=c,of.active_part=0,jc(),lc(0),mc())))});h.filter(function(a){return a.icon}).append("span").attr("class",function(a){return a.icon}).style("margin-left","1em").style("font-size","0.8em"),h.append("span").text(function(a){return a.menu_title})}function jc(){var a=nf.select(".modal-content");a.selectAll("*").remove();var b=a.append("div").classed("modal-header",!0).style("padding-left","25px").style("padding-right","25px");b.append("button").attr("type","button").classed("close",!0).attr("data-dismiss","modal").style("font-size","28px").html("&times;"),b.append("h3").classed("modal-title",!0).attr("id","help-title").style("font-size","20px").html(of.modal_title),a.append("div").classed("modal-body",!0).style("padding-left","35px").style("padding-right","35px").append("iframe").attr("class","help-content").style("border","none").style("display","block").style("width","100%").style("height","400px").on("load",function(){lc(of.active_part)}).attr("src",of.src+"?ver="+lf);var c=a.append("div").classed("modal-footer",!0).style("padding-left","25px").style("padding-right","25px"),d=c.append("div").style("display","flex").style("align-items","center").style("margin","0.5em");d.append("div").style("flex","1 1 0").style("text-align","left").append("a").attr("href","#").attr("id","help-prev-btn").style("visibility","hidden").text("back").on("click",function(a){return lc(of.active_part-1)});for(var e=[],f=0;f<of.parts;f++)e.push(f);d.append("div").style("flex","10 10 0").style("text-align","center").selectAll("span").data(e).enter().append("span").style({width:"15px",height:"15px","border-radius":"50%",cursor:"pointer",margin:"0 10px"}).style("display",function(a){return of.parts>1?"inline-block":"none"}).classed("gm-marker",!0).style("background","silver").on("click",function(a,b){return lc(b)}),d.append("div").style("flex","1 1 0").style("text-align","right").append("button").attr("id","help-next-btn").attr("type","button").classed("btn btn-primary",!0).text("Next").on("click",function(a){of.active_part===of.parts-1?(localStorage.setItem("gm-finished-welcome-help",!0),$("#gm-help-modal").modal("hide")):lc(of.active_part+1)})}function kc(a,b){nf=d3.select("body #gm-help-modal"),0===nf.size()&&(nf=d3.select("body").append("div").attr("id","gm-help-modal").classed("modal fade",!0).attr("role","dialog").style("display","none"),nf.append("div").classed("modal-dialog",!0).style("width","650px").style("max-width","90%").append("div").classed("modal-content",!0),jc(),b&&!localStorage.getItem("gm-finished-welcome-help")&&a.callWhenReady(function(a){return setTimeout(mc,500)}))}function lc(a){of.active_part=a,nf.selectAll(".gm-marker").style("background",function(a,b){return of.active_part===b?"steelblue":"gray"});var b=d3.select(nf.select("iframe.help-content").node().contentDocument.body);b.style("font-size","100%"),b.selectAll(".content").style("display",function(a,b){return of.active_part===b?"block":"none"}).style("text-align","center"),b.style({"font-family":'Lato, "Helvetica Neue", Helvetica, Arial, sans-serif'}),b.selectAll("h3").style({"font-size":"1em"}),nf.select("iframe.help-content").style("visibility",null),nf.select("#help-prev-btn").style("visibility",0===of.active_part?"hidden":null),nf.select("#help-next-btn").text(of.active_part===of.parts-1?"Done":"Next")}function mc(){var a=$("#gm-help-modal");a.modal&&a.modal("show"),window&&window.gmath_log_ga&&gmath_log_ga.trackEvent("gm-canvas-event","help-menu","show",1)}function nc(a,b,c){var d="contact@graspablemath.com",e=De.display_name||"???",f=De.auto_approved,g=!f&&b,h=(g?"Approval request":"Check math sheet")+" from "+e,i=e+" "+(b?"created":"updated")+" a mathsheet.\n\nPlease "+(g?"check and approve":"check")+" it.\n\nInstructions:\n\nCheck if the savefile is okay: https://graspablemath.com/canvas?load="+a+".\n";i+=g?"\nIf so, open robomongo, connect to graspablemath.com, and open a shell for the \"gm-save-files\" database.\n\nThen, run the command\ndb.gm_canvas_save_files.update({ 'meta_data.save_id': '"+a+"' }, { $set: { 'meta_data.approved': true }})\n":"\nIf not, open robomongo, connect to graspablemath.com, and open a shell for the \"gm-save-files\" database.\n\nThen, run the command\ndb.gm_canvas_save_files.update({ 'meta_data.save_id': '"+a+"' }, { $set: { 'meta_data.approved': false }})\n\n";var j={};j.toEmail=d,j.subject=h,j.body=i;var k=new XMLHttpRequest;k.onreadystatechange=function(){4==k.readyState&&(200==k.status?console.log("Sent approval request."):console.log("Error sending approval request:",k.status,k.responseText))},k.open("POST",c.settings.get("email_server")+"/api/send_email_to",!0),k.setRequestHeader("Content-Type","application/json"),De.auth_token&&k.setRequestHeader("Authorization","Bearer "+De.auth_token),k.send(JSON.stringify(j))}function oc(a){a.appendButtonGroup([{type:"dropdown",label:qf,data_toggle:"dropdown",pull_right:!0,icon:"glyphicon glyphicon-save-file",html_fn:rf.setupMenu.bind(rf,a)}])}function pc(a){a.appendButtonGroup([{type:"dropdown",label:tf,data_toggle:"dropdown",pull_right:!0,icon:"glyphicon glyphicon-open-file",html_fn:uf.setupMenu.bind(uf,a)}])}function qc(a){var b=a.insert("div","*").classed("gm-load-append",!0).append("label"),c=b.append("input").attr({type:"checkbox"});return b.append("span").text(" append to current worksheet"),c}function rc(a){var b=6e4,c=60*b,d=24*c,e=30*d,f=365*d,g=Math.abs(a),h=void 0,i=void 0;return g<b?(h=Math.round(g/1e3),i="second"):g<c?(h=Math.round(g/b),i="minute"):g<d?(h=Math.round(g/c),i="hour"):g<e?(h=Math.round(g/d),i="day"):g<f?(h=Math.round(g/e),i="month"):(h=Math.round(g/f),i="year"),0===h?"now":h+" "+i+(h>1?"s":"")+" ago"}function sc(a){a.appendButtonGroup([{type:"dropdown",label:yf,data_toggle:"dropdown",pull_right:!0,icon:"glyphicon glyphicon-send",html_fn:zf.setupMenu.bind(zf,a)}])}function tc(a){var b=!(arguments.length<=1||void 0===arguments[1])&&arguments[1];a.appendButtonGroup([{type:"dropdown",label:"submit",data_toggle:"dropdown",pull_right:!0,icon:"glyphicon glyphicon-sunglasses",html_fn:uc.bind(null,a)}],null,b)}function uc(a,b){var c={width:346,padding:0,margin:0,border:0};Bf=b;var d=vc(Bf,c);return wc(d,c),Bc(a),$(d.node().parentElement).on("hidden.bs.dropdown",Bc.bind(null,a)),d.node()}function vc(a,b){var c=2*(b.padding+b.margin+b.border);return d3.select(a).append("div").attr("id","gm-submit-dropdown").style({width:b.width+c+"px",padding:b.padding+"px"}).on("click",function(){d3.event.stopPropagation()})}function wc(a,b){Af=a.append("div").attr("id","gm-submit-panel").classed("panel",!0).style({margin:b.margin+"px",border:b.border?b.border+"px solid silver":"none"}),b.border||Af.style("box-shadow","none")}function xc(a,b,c){a.meta_data||(a.meta_data={}),a.meta_data.context="gm-sidebar-mathxl",a.meta_data.student_name=b,a.meta_data.classroom_code=c,a.meta_data.problemset_name||(a.meta_data.problemset_name="???"),a.save({},function(a){a?yc("Sorry, we could not save your work. ("+a.reason+")",!0):yc("Your work has been submitted!",!1)})}function yc(a,b){Af.selectAll("*").remove();var c="alert alert-dismissable "+(b?"alert-danger":"alert-success");Af.append("div").attr("class",c).text(a).style("margin-bottom",0).attr("role","alert").append("button").classed("close",!0).html("&times;").on("click",function(){return $(Bf).find("button#submit").trigger("click")})}function zc(a,b){var c=null;return function(){var d=this,e=arguments;clearTimeout(c),c=setTimeout(function(){a.apply(d,e)},b)}}function Ac(a,b,c){var d=new XMLHttpRequest;return d.onreadystatechange=function(){if(4===this.readyState)if(200===this.status||301===this.status||302===this.status){var a;try{a=JSON.parse(d.responseText)}catch(a){return void c(a)}c(null,a.length)}else c("Network or server error ("+d.status+").")},d.open("GET",b.settings.get("savefile_server")+"/api/classrooms/"+encodeURIComponent(a)),d.setRequestHeader("Content-Type","application/json"),user.auth_token&&d.setRequestHeader("Authorization","Bearer "+user.auth_token),d.send(),d}function Bc(a){var b=zc(function(b){Cf&&Cf.abort(),Cf=Ac(b,a,function(a,b){Cf=null,a||!b?(h.classed("has-error",!0),h.classed("has-success",!1),k.attr("disabled",!0),j.text(a||"Code not found.")):(h.classed("has-error",!1),h.classed("has-success",!0),k.attr("disabled",null),j.text("Code found."))})},1e3);Af.selectAll("*").remove();var c=Af.append("div").classed("panel-body",!0),d=c.append("div").classed("form-horizontal",!0).style("margin-top","0.8em"),e=d.append("div").classed("form-group",!0);e.append("label").text("Your name:").attr("for","name-input").attr("class","col-xs-5 control-label");var f=e.append("div").attr("class","col-xs-7").append("input").attr({type:"text",class:"form-control",id:"name-input"}),g=e.append("span").attr({id:"helpBlock",class:"col-xs-7 col-xs-offset-5 help-block"}).text("Name too short.").style("display","none"),h=d.append("div").classed("form-group",!0);h.append("label").text("Classroom code:").attr("for","code-input").attr("class","col-xs-5 control-label");var i=h.append("div").attr("class","col-xs-7").append("input").attr({type:"text",class:"form-control",id:"code-input"}).on("input",function(){k.attr("disabled",!0),h.classed("has-error has-success",!1),j.text("Checking..."),j.style("display",""===this.value?"none":null),""!==this.value&&b(this.value)}),j=h.append("span").attr({id:"helpBlock",class:"col-xs-7 col-xs-offset-5 help-block"}).style("display","none"),k=d.append("div").classed("form-group",!0).style("margin-bottom",0).append("div").attr("class","col-xs-offset-5 col-xs-7").append("button").classed("btn btn-default",!0).text("Submit").attr("disabled",!0).on("click",function(b){var c=f.node().value,d=i.node().value,h=c.length>=3;g.style("display",h?"none":null),e.classed("has-error",!h),h&&xc(a,c,d)})}function Cc(a){var b=bd();if(Df||(d3.select("body").append("div").node().outerHTML=Ec(b),Df=d3.select("#gm-settings-modal")),!Ef){var c=Df.select("#user"+b),d=Df.select("#doc"+b);Ef=[new If(a,c,!0),new Hf(a,d,!1),new Gf(a,d,!1),new Ff(a,c,!0)]}a.appendButtonGroup([{type:"push",label:"settings",pull_right:!0,icon:"glyphicon glyphicon-cog"}],Dc.bind(null,Ef,a))}function Dc(a,b){Df.select("#save-btn").on("click",function(){$(Df.node()).modal("hide"),a.forEach(function(a){return a.writeData()}),b.model.renderAll(),De.saveSettings()}),a.forEach(function(a){return a.render()}),$(Df.node()).modal("show")}function Ec(a){return'\n  <div class="modal fade in" tabindex="-1" role="dialog" id="gm-settings-modal" style="display: none">\n    <div class="modal-dialog" role="document">\n      <div class="modal-content">\n        <div class="modal-header" style="border: none">\n          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true"></span></button>\n          <h4 class="modal-title">Settings</h4>\n        </div>\n        <div id=\'content\'>\n          \x3c!-- Nav tabs --\x3e\n          <ul class="nav nav-tabs" role="tablist">\n            <li role="presentation" class="active"><a href="#user'+a+'" aria-controls="user" role="tab" data-toggle="tab">User</a></li>\n            <li role="presentation"><a href="#doc'+a+'" aria-controls="document" role="tab" data-toggle="tab">Document</a></li>\n          </ul>\n\n          \x3c!-- Tab panes --\x3e\n          <div class="tab-content">\n          <div role="tabpanel" class="tab-pane active" id="user'+a+'"></div>\n          <div role="tabpanel" class="tab-pane" id="doc'+a+'"></div>\n          </div>\n        </div>\n        <div class="modal-footer">\n          <button class="btn btn-default" data-dismiss="modal">Close</button>\n          <button id="save-btn" class="btn btn-primary">Save changes</button>\n        </div>\n      </div>\n    </div>\n  </div>'}function Fc(a,b,c){this.id=bd(),this.type="GM_GGB_Link",this.ggb_obj=a,this.row=b,this.model=b.model,this.ggb_panel=c,this.am_changed=!1,"segment"===a.type&&this.onGGBChange(a.name),this.model.events.on("change."+this.id,this.onAMChange.bind(this)),this.model.events.on("start-of-interaction."+this.id,this.onAMsoi.bind(this)),this.model.events.on("end-of-interaction."+this.id,this.onAMeoi.bind(this))}function Gc(a,b,c,d,e){this.id=bd(),this.type="GM_GGB_SI_Line_Link",this.ggb_ic=a,this.ggb_2nd=b,this.ggb_obj=c,this.model=d.model,this.row=d,this.ggb_panel=e,this.model.events.on("change."+this.id,this.onAMChange.bind(this))}function Hc(a,b){a.style({cursor:"pointer",position:"absolute",top:"-1px",right:b?"-21px":"0",width:"20px","line-height":"1.4em","text-align":"center",border:b?"1px solid silver":"1px solid transparent","border-left":"none",background:b?"#eeeeee":"none","padding-top":"0.2em","padding-left":b?"0.1em":"0",color:"#444444"}),a.text(b?"":"")}function Ic(a,b){a.style({cursor:"pointer",position:"absolute",top:"-2px",left:"-21px",width:"20px","line-height":"1.4em","text-align":"center","padding-top":"0.05em","padding-left":b?"0.1em":"0",color:"#444444","font-size":"1.2em",transform:b?"rotate(180deg)":"rotate(0deg)",transition:"transform 0.5s"}),a.text("")}function Jc(a){var b=a.length;return a.match(/[^aeiou]y$/)?a.substr(0,b-1)+"ies":a.match(/(ch|sh|s|ss|x|z|zz)$/)?a+"es":a+"s"}function Kc(a,b){function c(){var a=window.getComputedStyle(f).display,h=window.getComputedStyle(g).display;Date.now()-e<=d&&("none"!==a||"inline-block"!==h)?setTimeout(c,50):(f.remove(),g.remove(),b())}var d=arguments.length<=2||void 0===arguments[2]?2e3:arguments[2],e=Date.now(),f=d3.select("body").append("div").style({width:0,height:0}).attr("id","gm-canvas-css-finished-loading").node(),g=d3.select("body").append("div").style({width:0,height:0}).classed("btn-group",!0).node();c()}function Lc(a){a.selectAll(".gm-main-toolbar button span").style("font-size","12px"),a.selectAll(".gm-main-toolbar button br").style("font-size","12px")}function Mc(a,b,c){return b||(b={}),JSON.parse(a,function(a,d){if(d&&d.type in Uf){var e=Uf[d.type](d,b,c);return e.id&&(b[e.id]=e),e}return d})}function Nc(){this.posting=!1,this.log_to_console=!1,this.trial_collection=null,this.data_collection=null,this.server_url="https://graspablemath.com:7010"}function Oc(){var a,b,c,d,e,f=d3.dispatch("click"),g=!1,h=function b(c){return a=c,b.init(),b};return h.hidden=function(a){return 0===arguments.length?g:(g=a,d&&d.style("display",g?"none":null),e&&e.attr("opacity",0),this)},h.remove=function(){c&&c.remove()},h.init=function(){b=a.node().getBoundingClientRect(),c=a.append("svg").attr("id","button").attr("width","100%").attr("height","100%").attr("cursor","pointer"),d=c.append("g").style("display",g?"none":null).attr("transform","translate("+[b.width/2,b.height/2]+")"),d.append("rect").attr({x:-b.width/2,y:-b.height/2,width:b.width,height:b.height}).attr({fill:"black",opacity:.1}),d.append("circle").attr({r:"35px"}).attr({fill:"#666",stroke:"white","stroke-width":"4px","fill-opacity":.6}),d.append("circle").attr({r:"37px"}).attr({fill:"none",stroke:"silver","stroke-width":1.5}),d.append("path").attr("d","M0,0 L0,1 L0.8,0.5 Z").attr("transform","scale(40)translate(-0.3,-0.5)").attr("fill","white"),e=c.append("rect").classed("overlay",!0).attr({width:b.width,height:b.height}).attr({fill:"black",opacity:0}).attr("pointer-events","all").on("mouseover",function(){e.attr("opacity",g?0:.1)}).on("mouseout",function(){e.attr("opacity",0)}).on("click",function(){g||f.click()})},d3.rebind(h,f,"on")}function Pc(){this.id=bd(),this.trial=null,this.active_trials=[],this.events=d3.dispatch("start_trial","end_trial"),this.experiment_id=null,De.events.on("login."+this.id,this.onUserEvent.bind(this)),De.events.on("logout."+this.id,this.onUserEvent.bind(this))}function Qc(a,b){var c=a.version||"0.0.0",d=a;if(Tc(b)||console.error("Can't parse target version",b),Tc(c)||console.error("Can't parse data version",c),!Wc(b,c))return d;for(var e=Xf.length-1;e>=0;e--){if(Wc(Xf[e].update_to,b)){d.version=b;break}Xc(c,Xf[e].update_to)&&(console.log("updating data file from",d.version,"to",Xf[e].update_to),d=Xf[e].run(d))}return d}function Rc(a,b){if("EqInvertAndCommuteTermAction"===a.name&&0!==["*","/"].indexOf(a.nodes[0])){var c=Sc(b,a.oldTree);a.name="AddSubInvertAction";var d=!1;if(0===["+","-",""].indexOf(a.target[0])){d=!0;var e=new Id(c.ascii);a.target=e.getSelectorOfNodes(e.getNodesFromSelector(a.target)[0].children[1])}var f=a.settings.side;a.settings="left-of"===f?d?{side:"left-of",target_group:!0,group_side:"around",margin:{y:-.5}}:{side:"left-inside",margin:{y:-.5}}:d?{side:"right-of",target_group:!0,group_side:"around",margin:{y:-.5}}:{side:"right-inside",margin:{y:-.5}},a.settings.extend_extreme_target_boxes=!0,a.settings.delay=100}}function Sc(a,b){for(var c=a.objects.filter(function(a){return"Derivation"===a.type}),d=0;d<c.length;d++)for(var e=c[d],f=0;f<e.rows.length;f++)if(e.rows[f].model.id===b)return e.rows[f].model;return null}function Tc(a){var b=a.match(/^(\d+).(\d+).(\d+)(?:-([^+]*))?(?:\+(.+))?$/);return!!b&&{major:Number(b[1]),minor:Number(b[2]),patch:Number(b[3]),pre:b[4],meta:b[5]}}function Uc(a,b){return a>b?1:a<b?-1:0}function Vc(a,b){var c=Tc(a),d=Tc(b);return c&&d?0!==Uc(c.major,d.major)?Uc(c.major,d.major):0!==Uc(c.minor,d.minor)?Uc(c.minor,d.minor):0!==Uc(c.patch,d.patch)?Uc(c.patch,d.patch):c.pre&&!d.pre?-1:d.pre&&!c.pre?1:c.pre&&d.pre?c.pre.match(/^d+$/)&&d.pre.match(/^d+$/)?Uc(Number(c.pre),Number(d.pre)):Uc(c.pre,d.pre):0:NaN}function Wc(a,b){return Vc(a,b)>0}function Xc(a,b){return Vc(a,b)<0}function Yc(a){var b=0;return a.model.elements().forEach(function(a){var c=a.size.height+a.pos.y;c>b&&(b=c)}),a.model.paths().forEach(function(a){a.points.forEach(function(a){a[1]>b&&(b=a[1])})}),b}function Zc(a){var b=nb().links.filter(function(a){return a.action.source_am}).map(function(a){return a.action.source_am});if(0===b.length)return[];var c=a.model.getElementsOfType("derivation"),d={};return c.forEach(function(a){return a.rows.forEach(function(a){return d[a.model.id]=a.model})}),b.filter(function(a){return!d[a.id]})}var $c,_c,ad,bd,cd,dd,ed,fd,gd,hd,id,jd,kd,ld,md,nd,od,pd,qd,rd,sd,td,ud,vd,wd,xd,yd,zd,Ad,Bd,Cd,Dd,Ed,Fd,Gd,Hd,Id,Jd,Kd,Ld,Md,Nd,Od,Pd,Qd,Rd,Sd,Td,Ud,Vd,Wd,Xd,Yd,Zd,$d,_d,ae,be,ce,de,ee,fe,ge,he,ie,je,ke,le,me,ne,oe,pe,qe,se,te,ue,ve,we,xe,ye,ze,Ae,Be,Ce,De,Ee,Fe,Ge,He,Ie,Je,Ke,Le,Me,Ne,Oe,Pe,Qe,Re,Se,Te,Ue,Ve,We,Xe,Ye,Ze,$e,_e,af,bf,cf,df,ef,ff,gf,hf,jf,kf,lf,mf,nf,of,pf,qf,rf,sf,tf,uf,vf,wf,xf,yf,zf,Af,Bf,Cf,Df,Ef,Ff,Gf,Hf,If,Jf,Kf,Lf,Mf,Nf,Of,Pf,Qf,Rf,Sf,Tf,Uf,Vf,Wf,Xf,Yf,Zf,$f,_f,ag,bg,cg,dg,eg,fg,gg,hg,ig,jg,kg,lg,mg,ng,og,pg,qg,rg,sg,tg,ug,vg,wg,xg,yg,zg,Ag,Bg,Cg,Dg,Eg,Fg,Gg,Hg,Ig,Jg,Kg,Lg,Mg,Ng;return{setters:[function(a){},function(a){},function(a){},function(a){$c=a.default},function(a){_c=a.Tree},function(a){}],execute:function(){ad={expressions:{},ui:{}},a("uid",bd=function(){var a=4294967296,b=15,c=[],d=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];return function(){var e=0,f=Math.random()*a;return c[e++]=d[f&b],c[e++]=d[f>>>4&b],c[e++]=d[f>>>8&b],c[e++]=d[f>>>12&b],c[e++]=d[f>>>16&b],c[e++]=d[f>>>20&b],c[e++]=d[f>>>24&b],c[e++]=d[f>>>28&b],f=Math.random()*a,c[e++]=d[f&b],c[e++]=d[f>>>4&b],c[e++]=d[f>>>8&b],c[e++]=d[f>>>12&b],c[e++]=d[f>>>16&b],c[e++]=d[f>>>20&b],c[e++]=d[f>>>24&b],c[e++]=d[f>>>28&b],"_"+c.join("")}}()),ad.uid=bd,ad.inherit=d,a("object",cd={}),ad.object=cd,cd.extend=function(a,b){if("object"==typeof b&&b)for(var c in b)a[c]=b[c];return a},ad.extend=cd.extend,a("extend",dd=cd.extend),cd.extendExisting=function(a,b){for(var c in a)c in b&&(a[c]=b[c]);return a},a("extendExisting",ed=cd.extendExisting),cd.extendChanged=function(a,b,c){for(var d in b)d in c&&!cd.deepEquals(c[d],b[d])&&(a[d]=b[d]);return a},cd.extendDifferent=function(a,b,c){for(var d in b)d in c&&cd.deepEquals(c[d],b[d])||(a[d]=b[d]);return a},cd.merged=function(a,b){return ad.object.extend(ad.object.extend({},a),b)},cd.deepCopy=function(a){var b=a;if(Array.isArray(a)){b=[];for(var c=0;c<a.length;c++)b[c]=ad.deepCopy(a[c])}else if("object"==typeof a&&a){b={};for(var d in a)a.hasOwnProperty(d)&&(b[d]=ad.deepCopy(a[d]))}return b},ad.deepCopy=cd.deepCopy,a("deepCopy",fd=cd.deepCopy),cd.deepEquals=function(a,b){if(a===b)return!0;if(Array.isArray(a)){if(!Array.isArray(b))return!1;if(a.length!==b.length)return!1;for(var c=0;c<a.length;c++)if(!cd.deepEquals(a[c],b[c]))return!1;return!0}if("object"==typeof a&&a){if(!b)return!1;for(var d in a)if(a.hasOwnProperty(d)){if(!b.hasOwnProperty(d))return!1;if(!cd.deepEquals(a[d],b[d]))return!1}return!0}return!1},ad.deepEquals=cd.deepEquals,a("deepEquals",gd=cd.deepEquals),ad.find=e,ad.findIndex=f,a("array",hd={}),ad.array=hd,hd.containsAll=function(a,b){if(b.length>a.length)return!1;for(var c=0;c<b.length;c++)if(-1===a.indexOf(b[c]))return!1;return!0},hd.remove=function(a,b){var c=a.indexOf(b);return-1===c?[]:a.splice(c,1)},hd.equals=function(a,b){if(a.length!==b.length)return!1;for(var c=0;c<a.length;c++)if(a[c]!==b[c])return!1;return!0},hd.isPermutation=function(a,b){var a=a.slice();if(b.length!==a.length)return!1;for(var c=0;c<b.length;c++){var d=a.indexOf(b[c]);if(-1===d)return!1;a[d]=void 0}return!0},hd.mergedNew=function(a,b){for(var c=a.slice(),d=0;d<b.length;d++)-1===a.indexOf(b[d])&&c.push(b[d]);return c},hd.xor=function(a,b){for(var c=[],d=0;d<a.length;d++)-1===b.indexOf(a[d])&&c.push(a[d]);for(var d=0;d<b.length;d++)-1===a.indexOf(b[d])&&c.push(b[d]);return c},hd.flatten=function(a){for(var b=[],c=0;c<a.length;c++)b=b.concat(a[c]);return b},hd.includes=function(a,b){return-1!==a.indexOf(b)},ad.getURLParameter=g,ad.byteLength=i,ad.termsToAlgebriteString=j,ad.loadScripts=k,id=function(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")},jd=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),a("dont_catch_exceptions",kd=!1),ld={},a("SettingsType",md=function(){function a(b){if(id(this,a),b in ld)throw"SettingsType with name "+b+" already exists.";ld[b]=this,this.name=b,this.defaults=new nd,this.user=new nd,this.user.parent=this.defaults,this.docs={},this.doc=new nd,this.doc.parent=this.user}return jd(a,[{key:"getOrCreateDoc",value:function(a){return this.docs[a]||(this.docs[a]=new nd,this.docs[a].parent=this.user),this.docs[a]}},{key:"get",value:function(a){var b=arguments.length<=1||void 0===arguments[1]?null:arguments[1];return b?this.docs[b].get(a):this.doc.get(a)}}],[{key:"get",value:function(a){return ld[a]}},{key:"getAll",value:function(){return cd.extend({},ld)}},{key:"docSettingsToJSON",value:function(a){var b={};for(var c in ld){var d=ld[c].docs[a];d&&(b[c]=d.getModified())}return b}},{key:"userSettingsToJSON",value:function(){var a={};for(var b in ld){var c=ld[b].user;c&&(a[b]=c.getModified())}return a}}]),a}()),nd=function(){function a(b,c){id(this,a),this.state={},this.setParent(b,c)}return jd(a,[{key:"setParent",value:function(a,b){this.settings_type=a,this.docId=b,a&&(this.parent=b?ld[a].getOrCreateDoc(b):ld[a].user)}},{key:"unsetAll",value:function(){return this.state={},this}},{key:"set",value:function(a,b){return this.state[a]=b,this}},{key:"unset",value:function(a){return delete this.state[a],this}},{key:"setAll",value:function(a){var b=this;return Object.keys(a).forEach(function(c){return b.set(c,a[c])}),this}},{key:"setExisting",value:function(a){var b=this;return Object.keys(a).forEach(function(c){b.has(c)&&b.set(c,a[c])}),this}},{key:"has",value:function(a){return a in this.state||this.parent&&this.parent.has(a)}},{key:"get",value:function(a){return a in this.state?this.state[a]:this.parent&&this.parent.get(a)}},{key:"getModified",value:function(){var a=this,b=arguments.length<=0||void 0===arguments[0]?this.state:arguments[0],c={};return Object.keys(b).forEach(function(d){a.parent&&a.parent.has(d)&&cd.deepEquals(a.parent.get(d),b[d])||(c[d]=b[d])}),c}},{key:"getIfExists",value:function(a,b){return a in this.state?this.state[a]:this.parent?this.parent.getIfExists(a,b):b}},{key:"getAll",value:function(){return cd.extend({},this.state)}},{key:"getAllIncludingDefaults",value:function(){if(!this.parent)return this.state;var a=this.parent.getAllIncludingDefaults();return cd.merged(a,this.state)}}]),a}(),a("MathSettings",od=new md("Math")),od.defaults.setAll({substitution_on:!0,only_integer_division:!1,simplify_sum_in_numerator_after_adding_fractions:!1,second_child_eq_inversion:!1,cancel_powers:!0,tap_to_cancel:!0,factor_after_finding_gcf:!0,cancel_common_terms_after_finding_gcf:!0,simplify_sum_after_canceling_powers:!0,auto_simplify_signs:!0,flip_powers_only:!0,allow_non_equivalent_keyboard_rewrite:!0}),ad.tokenize=m,ad.AlgebraParser=o,ad.actions={},ad.Action=p,p.prototype.toJSON=function(){var a={id:this.id,name:this.name,type:"Action",priority:this.priority,oldTree:this.oldTree.id,newTree:this.newTree.id,triggerType:this.triggerType,settings:this.settings};if(this.nodes&&(this.source_am&&(a.source_am=this.source_am.id),a.nodes=this.nodes[0].get_root().getSelectorOfNodes(this.nodes)),this.target)if("RelationOfAbsValAction"===this.name||"AddSubResolveCasesAction"===this.name)a.target=this.target.id;else{var b=Array.isArray(this.target)?this.target[0].get_root():this.target.get_root();a.target=b.getSelectorOfNodes(this.target),Array.isArray(this.target)&&1===this.target.length&&(a.target_is_array=!0)}return this.actor&&(a.actor=this.actor.get_root().getSelectorOfNodes(this.actor)),a},p.fromJSON=function(a,b){if(a.id in b)return b[a.id];var c=new ad.actions[a.name].constructor;for(var d in a)c[d]=a[d];return c.oldTree&&(c.oldTree=b[c.oldTree]),c.newTree&&(c.newTree=b[c.newTree]),c.source_am&&(c.source_am=b[c.source_am]),c.nodes&&(c.nodes=(c.source_am?c.source_am:c.oldTree).getNodesFromSelector(c.nodes)),c.actor&&(c.actor=c.oldTree.getNodesFromSelector(c.actor)[0]),c.target&&("RelationOfAbsValAction"===c.name||"AddSubResolveCasesAction"===c.name?c.target=b[c.target]:(c.target=c.oldTree.getNodesFromSelector(c.target),c.target_is_array||1!==c.target.length||(c.target=c.target[0]))),c},p.prototype.printMap=function(a){a&&console.log(a);for(var b in this.node_map){var c=this.oldTree.get_by_id(b);console.log(c?c.to_ascii():"?","==>",this.node_map[b].map(function(a){return a.to_ascii()}).join(", "))}},p.prototype.printLeafNodePositions=function(a){var b=arguments.length<=1||void 0===arguments[1]||arguments[1],c=arguments.length<=2||void 0===arguments[2]||arguments[2];a&&console.log(a),b&&this.oldTree&&this.oldTree.printLeafNodePositions("old"),c&&this.newTree&&this.newTree.printLeafNodePositions("new")},p.prototype.printForEachLeafNode=function(a,b,c){b.get_leaf_nodes().forEach(function(b){console.log(a,b.to_ascii(),":",c.call(this,b))},this)},p.prototype.createBoundAction=function(a,b){var c=new this.constructor(b);return b.is_inner_action&&(c.is_inner_action=!0),c.oldTree=a,c.newTree=a,c},p.prototype.bindActionForEachTarget=function(a,b,c){var d=this,e=a[0].get_root();if(c){for(var f=[],g=0;g<b.length;g++){var h=b[g];0!==g&&b[g-1].rs===h||f.push(this.createBoundAction(e,{nodes:a,target:h,side:"left-of"})),f.push(this.createBoundAction(e,{nodes:a,target:h,side:"right-of"}))}return f}return b.map(function(b){return d.createBoundAction(e,{nodes:a,target:b,side:null})})},p.prototype.initSettings=function(a){a&&(this.setActorAndTarget(a),this.setSide(a.side),"drag"===this.triggerType&&(this.setDropArea(a.drop_area),this.setDropAreaHint(a.drop_area_hint),this.setDestinationHints(a.destination_hint)))},p.prototype.setActorAndTarget=function(a){var b=a.nodes,c=a.target,d=a.actor;b?(this.triggerType="drag",this.nodes=b,this.target=c):this.actor=d},p.prototype.setSide=function(a){a&&(this.settings.side=a)},p.prototype.setDropArea=function(){var a=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],b=a.node,c=a.side,d=a.margin,e=a.offset;this.drop_area||(this.drop_area={}),this.drop_area.node=b||this.target,this.drop_area.side=c||this.settings&&this.settings.side||"around",this.drop_area.margin=d||this.settings.margin,this.drop_area.offset=e||this.settings.offset},p.prototype.getDropArea=function(){return this.drop_area?this.drop_area:{node:this.target,side:this.settings.side,margin:this.settings.margin,offset:this.settings.offset}},p.prototype.setDropAreaHint=function(){var a=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],b=a.node,c=a.side,d=a.margin,e=a.offset,f=a.hidden;this.drop_area_hint||(this.drop_area_hint={}),this.drop_area_hint.side=c||this.drop_area.side,b||(b=Array.isArray(this.drop_area.node)||!this.drop_area.node.is_group("addsub","add","sub","mul","div")||"around"!==this.drop_area_hint.side&&"inside"!==this.drop_area_hint.side?this.drop_area.node:this.drop_area.node.children[1]),this.drop_area_hint.node=b,this.drop_area_hint.margin=d,this.drop_area_hint.offset=e,this.drop_area_hint.hidden=f},p.prototype.setDestinationHints=function(a){var b=this;this.destination_hints||(this.destination_hints=[]),a&&Array.isArray(a)?a.forEach(this.addDestinationHint.bind(this)):a&&a.nodes?a.nodes.forEach(function(c){return b.addDestinationHint({node:c,side:a.side,margin:a.margin,offset:a.offset})}):this.addDestinationHint(a)},p.prototype.addDestinationHint=function(){var a=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],b=a.node,c=a.side,d=a.margin,e=a.offset;b||(b=Array.isArray(this.target)||!this.target.is_group("addsub","add","sub","mul","div")||"around"!==this.settings.side&&"inside"!==this.settings.side?this.target:this.target.children[1]),c||(c="left-inside"===this.settings.side?"left-of":"right-inside"===this.settings.side?"right-of":this.settings.side),e||(e=this.settings.offset),this.destination_hints.push({node:b,side:c,margin:d,offset:e})},p.prototype.getSourceAndTarget=function(a){return"drag"===this.triggerType?{source:a?this.nodes:this.nodes[0],target:this.target}:{source:a?[this.actor]:this.actor,target:this.actor.ls||this.actor.rs}},p.prototype.rebind=function(a,b,c){if(this.oldTree!==c)throw"wrong old tree during rebinding an action!";var d=new p;d.node_map=b,this.oldTree=a,this.nodes&&(this.nodes=d.mapNodes(this.nodes)),this.target&&(this.target=Array.isArray(this.target)?[d.mapNodes(this.target)[0]]:d.mapNodes(this.target)[0]),this.actor&&(this.actor=d.mapNodes(this.actor)[0])},p.prototype.createAndRun=function(a,b,c){var d=new this.constructor(b);return d.oldTree=a,d.run(c),d},p.prototype.createAndDoInPlace=function(a,b,c){var d=new this.constructor(b);return b.is_inner_action&&(d.is_inner_action=!0),d.oldTree=a,d.newTree=a,d.doInPlace(c),d},p.prototype.getInverseNodeMap=function(){var a=this,b={};return this.newTree.select_all().forEach(function(c){return b[c.id]=Object.keys(a.node_map).filter(function(b){return a.node_map[b].find(function(a){return a===c})}).map(function(b){return a.oldTree.get_by_id(b)})}),b},p.prototype.initNodeMap=function(){this.is_inner_action||(this.initial_node_map=this.oldTree.children[0].get_mapping_to(this.newTree.children[0])),this.node_map=this.oldTree.children[0].get_mapping_to(this.newTree.children[0])},p.prototype.removeDeletedNodesFromNodeMap=function(){if(this.oldTree!==this.newTree){var a=this.newTree.select_all(),b=function(b){return-1!==a.indexOf(b)};for(var c in this.node_map)this.node_map[c]=this.node_map[c].filter(b)}},p.prototype.updateNodeMap=function(a,b){if(1===arguments.length)ad.extend(this.node_map,a);else{var c=a;if(Array.isArray(c))for(var d=0;d<c.length;d++)this.node_map[c[d].id]=Array.isArray(b)?b:[b];else this.node_map[c.id]=Array.isArray(b)?b:[b]}},p.pushNew=function(a,b){for(var c=0;c<b.length;c++)-1===a.indexOf(b[c])?a.push(b[c]):(a.splice(a.indexOf(b[c]),1),a.push(b[c]))},p.prototype.extendNodeMap=function(a,b){if(2===arguments.length){var c=a,d=Array.isArray(b)?b:[b];return void(c.id in this.node_map?p.pushNew(this.node_map[c.id],d):this.node_map[c.id]=d)}var e=a;for(var f in e)e.hasOwnProperty(f)&&(f in this.node_map?p.pushNew(this.node_map[f],e[f]):this.node_map[f]=e[f])},p.prototype.getNewTreeNode=function(a){return this.is_inner_action?a:this.getCorrespondingNodeFromTree(a,this.newTree)},p.prototype.getOldTreeNode=function(a){return this.is_inner_action?a:this.getCorrespondingNodeFromTree(a,this.oldTree)},p.prototype.getCorrespondingNodeFromTree=function(a,b){var c=function(a){return a.get_root()===b?a:b.get_child(a.get_path())};return Array.isArray(a)?a.map(c):c(a)},p.prototype.getTargetsForHighlighting=function(){return[]},p.prototype.addTouchedNodes=function(a){var b=this;_c.for_each(function(a){b.touched_nodes[a.id]=!0},a)},p.prototype.getOrInferTriggerType=function(){return this.triggerType?this.triggerType:this.actor?"tap":this.nodes?"drag":"unknown"},p.prototype.setNodesToReselectAfterAction=function(a){Array.isArray(a)?this.new_selection=a.slice():this.new_selection=[a]},p.cleanupInPlace=function(a){if(!a.cleanupAction)return!1;if(!a.cleanupAction.match(a))return!1;for(var b=a;b.parent&&"AlgebraModel"!==b.type;)b=b.parent;a.cleanupAction.createAndDoInPlace(b,{actor:a})},p.prototype.cleanup=function(a){if(!a.cleanupAction)return!1;if(!a.cleanupAction.match(a))return!1;var b=a.cleanupAction.createAndDoInPlace(this.newTree,{actor:a,is_inner_action:!0});return this.compose(b,!1),b},p.prototype.cleanup_cascade=function(a){for(var b=!1;;){var c=this.cleanup(a);if(!c)return b;b=!0;var d=c.mapNodes(a);if(0===d.length)return b;a=d[0].parent}},p.prototype.applyInnerAction=function(a,b){var c=arguments.length<=2||void 0===arguments[2]||arguments[2],d=b.tree||b.actor||_c.get_cca(b.nodes[0]),e=d;if("AlgebraModel"!==d.type){var f=new _c.Node;f.children=[d],f.type="AlgebraModel"}var g=dd({is_inner_action:!0},b);delete g.tree;var h=ad.actions[a].createBoundAction(e,g);return!(c&&!h.rematch())&&(h.doInPlace(),this.compose(h),!0)},p.prototype.compose=function(a){var b=arguments.length<=1||void 0===arguments[1]||arguments[1];for(var c in this.node_map){var d=this.node_map[c];this.node_map[c]=a.mapNodes(d);var e=d.filter(function(b){return!a.node_map[b.id]});if(e.length>0&&b&&!a.is_inner_action)throw"Second mapping does not mention all nodes from first mapping.";this.node_map[c]=this.node_map[c].concat(e),a.touched_nodes[c]&&(this.touched_nodes[c]=!0)}this.new_selection&&this.new_selection.some(function(b){return b.id in a.node_map})&&(this.new_selection=a.mapNodes(this.new_selection)),a.is_inner_action||(this.newTree=a.newTree)},p.prototype.run=function(a){return this.newTree=this.oldTree.clone(),this.doInPlace(a)},p.prototype.match=function(){throw"called abstract method Action.match()"},p.prototype.rematch=function(){if(!(this.actor||this.nodes&&this.nodes.length>0&&this.target&&(!Array.isArray(this.target)||this.target.length>0)))return!1;if(this.actor)return this.match(this.actor);if(this.getAllAvailableActions){return this.getAllAvailableActions(this.nodes).some(function(a){return Array.isArray(a.target)?ad.array.equals(a.target,this.target):a.target===this.target},this)}},p.prototype.transform=function(a){throw"called abstract method Action.transform()"},p.prototype.doInPlace=function(a){var b,c=this;try{this.initNodeMap(),b=this.transform(function(b){c.removeDeletedNodesFromNodeMap(),a&&a(b)})}catch(c){if(kd)throw c;console.warn("An error occurred when trying to run "+this.name),a&&a(!1),b=!1;var d=this.nodes||this.actor&&[this.actor],e=d?d.map(function(a){return a.to_ascii()}).join(";"):null,f=Array.isArray(this.target)?this.target:this.target&&[this.target],g=f?f.map(function(a){return a.to_ascii()}).join(";"):null;ad.sendErrorReport("An error occurred when trying to run "+this.name+" with nodes "+e+" and target "+g+" on model "+(this.oldTree&&this.oldTree.to_ascii()),_c.stringify(this.oldTree))}return b},p.prototype.wasNodeTouched=function(a){return this.touched_nodes[a.id]},p.prototype.mapNodes=function(a){var b=[],c=this;return Array.isArray(a)||(a=[a]),a.forEach(function(a){(c.node_map[a.id]||[]).forEach(function(a){-1===b.indexOf(a)&&b.push(a)})}),b},p.prototype.unmapNodes=function(a){var b=[];Array.isArray(a)||(a=[a]);for(var c in this.node_map)ad.array.isPermutation(a,this.node_map[c])&&b.push(this.oldTree.get_by_id(c));return b},p.createComposedAction=function(a,b,c){function d(){function b(c,d,f){return f>=a.length?c:(e.touched_nodes[d]||(e.touched_nodes[d]=c.some(a[f].wasNodeTouched.bind(a[f]))),b(a[f].mapNodes(c),d,f+1))}e.node_map={},e.touched_nodes={};for(var c in a[0].node_map)e.touched_nodes[c]=a[0].touched_nodes[c],e.node_map[c]=b(a[0].node_map[c],c,1)}var e=new p(b,c);return d(),a[0].actor?e.actor=a[0].actor:a[0].nodes&&(e.nodes=a[0].nodes,e.target=a[0].target),e.oldTree=a[0].oldTree,e.newTree=a[a.length-1].newTree,e.new_selection=a[a.length-1].new_selection,e},p.prototype.defineRestrictionExpression=function(a){this.node_map={};var b=this.getOldTreeNode(a),c=this.createRestrictionModel(this.oldTree.clone(),b),d=this.createBoundAction(this.oldTree,{nodes:b,target:c});return d.node_map=this.node_map,this.initNodeMap(),{type:"derivation",model:c,action:d}},p.prototype.endKeyboardInteraction=function(a){a.visible(!1).caption("").latex("").on("done",null).on("change",null).on("cancel",null)},pd=function(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b},qd=function(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)},rd={},rd.registerAtParser=function(a){a.registerSymbol("\\quad").nud=function(){return a.parseExpression(0)}},ad.expressions.latex=rd,sd=function(a,b){_c.Node.call(this),arguments.length>1&&(this.bp=b),arguments.length>0&&(this.value=a)},ad.inherit(_c.Node,sd),sd.prototype.to_ascii=function(a){return this.children.map(function(b){return b.is_group()&&b.commutative&&!b.ls&&b.associative?b.children[1].to_ascii(a):b.to_ascii(a)}).join("")},sd.prototype.to_latex=function(){return this.children.map(function(a){return a.is_group()&&a.commutative&&!a.ls&&a.associative?a.children[1].to_latex():a.to_latex()}).join("")},sd.prototype.is_group=function(a){if(0===arguments.length)return!0;for(var b=0;b<arguments.length;b++)if(this.value===arguments[b])return!0;return!1},sd.prototype.get_last_child=function(){return this.children[this.children.length-1]},sd.get_siblings=function(a){for(var b=Array.isArray(a)?a:[a],c=[],d=b[0];d.ls;)d=d.ls,c.unshift(d);for(d=b[b.length-1];d.rs;)d=d.rs,c.push(d);return c},sd.prototype.is_leaf_node=!1,sd.prototype.has_subscript=function(){return!1},ad.inherit(_c.Node,s),q.call(s,"sym"),s.mappings={"-":"","*":"","/":"","//":""},s.prototype.to_string=function(a){var b=a.sym_map;return""+this.to_string_value_modifier(this.get_base().value,b)+this.get_subscript_helper("to_string")},s.prototype.to_latex=function(){return this.hidden?"":""+this.to_latex_value_modifier(this.get_base().value)+this.get_subscript_helper("to_latex")},s.prototype.to_string_value_modifier=function(a,b){var c=b||s.mappings;return"-"===a&&this.parent&&this.parent.is_group("sign")?"-":a in c?c[a]:a},s.prototype.to_latex_value_modifier=function(a){return"/"===a?"\\cdot ":"*"===a?"\\cdot ":"("===a?"\\left(":")"===a?"\\right)":"["===a?"\\left[":"]"===a?"\\right]":a},r.call(t,"sum",{bp:20}),t.prototype.to_ascii=function(a){return this.children.map(function(b,c){var d=b.children[1],e=!b.is_group("add")||c>0||d.is_group("plusminus","sign"),f=b.to_ascii(a);return"+"!==f[0]||e?f:f.substring(1)}).join("")},u.value2sym={add:"+",sub:"-",addsub:""},r.call(u,"add-sub",{group_class:t,group_name:"sum",bp:20,associative:!0,commutative:!0,has_inverse:!0}),u.prototype.invert=function(){"add"===this.value?this.setValue("sub"):"sub"===this.value&&this.setValue("add")},u.prototype.setValue=function(a){this.value=a,this.children[0].value=u.value2sym[a],this.associative="add"===a},u.prototype.symIsHidden=function(){return this.get_child([0]).hidden},u.prototype.map_group_and_sym=function(a,b,c){var d=c?"updateNodeMap":"extendNodeMap";a[d](this,b),a[d](this.children[0],b.children[0])},u.prototype.to_ascii=function(a){var b=!this.ls&&(this.children[1].is_group("product")||this.children[1].is_group("fraction")&&!this.children[1].children[1].is_group("mul"))&&this.children[1].children[0].children[1].is_group("plusminus","sign");return!this.ls&&this.is_group("sub")&&this.children[1].is_group("product")&&this.get_child([1,0,1]).is_group("fraction")&&(b=!0),this.children[0].to_ascii(a)+this.children[1].to_ascii(a,b)},u.registerAtParser=function(a){function b(b){var d=a.parseExpression(u.prototype.bp);if(b.is_group("sum"))return b.append(new u(d,"addsub")),b;var e=c(b);return e.append(new u(d,"addsub")),e}var c=function(a){var b=u.prototype.createParentGroup(),c=a.is_group("product","fraction")?a.children[0].children[1]:null;return a.had_leading_plus?b.append(new u(a)):a.is_group("sign")&&!a.user_grouped?b.append(new u(a.children[1],"sub")):a.is_group("plusminus")&&!a.user_grouped?b.append(new u(a.children[1],"addsub")):c&&!c.user_grouped&&c.is_group("sign","plusminus")&&!c.had_leading_plus?(c.replace_with(c.children[1]),c.is_group("sign")&&b.append(new u(a,"sub")),c.is_group("plusminus")&&b.append(new u(a,"addsub"))):b.append(new u(a)),b};a.registerSymbol("+",u.prototype.bp).led=function(b){var d=a.parseExpression(u.prototype.bp);if(b.is_group("sum"))return b.append(new u(d,"add")),b;var e=c(b);return e.append(new u(d,"add")),e};var d=a.registerSymbol("-",u.prototype.bp),e=a.registerSymbol("",u.prototype.bp);d.led=function(b){var d=a.parseExpression(u.prototype.bp);if(b.is_group("sum"))return b.append(new u(d,"sub")),b;var e=c(b);return e.append(new u(d,"sub")),e},e.led=d.led,["","\\pm"].forEach(function(c){a.registerSymbol(c,u.prototype.bp).led=b})},ad.expressions.addsub=u,ad.inherit(_c.Node,v),v.prototype.name="bool",v.prototype.to_string=function(){return this.value},v.prototype.to_ascii=v.prototype.to_string,v.prototype.is_group=function(){return!1},v.registerAtParser=function(a){a.registerSymbol("(number)").nud=function(){return new v(this.value)}},ad.expressions=ad.expressions||{},ad.expressions[v.prototype.name]=v,r.call(w,"brackets",{bp:0}),w.prototype.to_latex=function(){return w.areHidden(this)?this.children[1].to_latex():"\\left"+this.children[0].value+this.children[1].to_latex()+"\\right"+this.children[2].value},w.registerAtParser=function(a){var b=a.registerSymbol("[",30);b.nud=function(){var b=a.parseExpression(0);return a.advance("\\right",!0),a.advance("]"),new w(b,"[","]")},b.led=function(b){var c=a.parseExpression(K.prototype.bp,this);return K.createProduct(b,c)},a.registerSymbol("]");var c=a.registerSymbol("(",30);c.nud=function(){var b=a.parseExpression(0);return a.advance("\\right",!0),a.advance(")"),new w(b)},c.led=function(b){var c=a.parseExpression(K.prototype.bp,this);return K.createProduct(b,c)},a.registerSymbol(")");var d=a.registerSymbol("\\left",30);d.nud=function(){if(a.match_current_token("[","(","|"))return a.parseExpression(30);throw this},d.led=function(b){if(a.match_current_token("[","(","|")){var c=a.parseExpression(30);return K.createProduct(b,c)}throw this},a.registerSymbol("\\right");var e=a.registerSymbol("{",30);e.nud=function(){var b=a.parseExpression(0);return b.user_grouped=!0,a.advance("}"),b},e.led=c.led,a.registerSymbol("}")},w.areHidden=function(a){return a&&a.is_group("brackets")&&a.children[0].hidden},w.handle=function(a,b){if(a.is_group("brackets"))return!(!b||!w.is_optional(a))&&(_c.replace(a,a.children[1]),"removed");if(!w.is_optional(a)){var c=a.parent,d=_c.remove(a);return _c.insert(c,d,new w(a)),"added"}return!1},w.is_optional=function(a,b){if(a.is_group("brackets")&&a.children[1].is_group("brackets"))return!0;var c=a.is_group("brackets")?a.children[1]:a,b=b||a.parent;return!(c.is_group("tuple")&&!b.is_group("func"))&&(!!b.is_group("tuple")||(!!c.is_group("abs-val")||(!c.has_children()||(b instanceof Id||(!(!b.has_subscript()||b.get_subscript()!==a)||(!(!b.is_group("sign","plusminus")||!c.is_group("fraction"))||(!b.is_group("func")||!c.is_group("tuple"))&&(!(b.bp>c.bp)&&(!!c.is_group("sign","plusminus")||(b.bp<c.bp||(!(!b.is_group("sign")||!c.is_group("sign"))||(!(!b.associative||!c.is_group(b.group_name))||(!(!c.commutative||!b.is_group(c.group_name))||(!(!c.is_group("mul","div")||!b.is_group("fraction"))||(!!(c.is_group("product")&&b.is_group("div")&&b.parent&&b.parent.is_group("fraction"))||!(!c.is_group("fraction")||!b.is_group("mul","div"))))))))))))))))},r.call(x,"disjunction",{bp:30}),r.call(y,"and",{group_name:"disjunction",group_class:x,bp:30,associative:!0,commutative:!0}),y.registerAtParser=function(a){a.registerSymbol("*",y.prototype.bp).led=function(b){var c=a.parseExpression(y.prototype.bp);if(b.is_group("disjunction"))return b.append(new y(c)),b;var d=y.prototype.createParentGroup();return d.append(new y(b)),d.append(new y(c)),d}},r.call(z,"conjunction",{bp:30}),r.call(A,"or",{group_name:"conjunction",group_class:z,bp:20,associative:!0,commutative:!0}),A.registerAtParser=function(a){a.registerSymbol("+",A.prototype.bp).led=function(b){var c=a.parseExpression(A.prototype.bp);if(b.is_group("conjunction"))return b.append(new A(c)),b;var d=A.prototype.createParentGroup();return d.append(new A(b)),d.append(new A(c)),d}},r.call(B,"abs-val",{bp:0}),B.prototype.to_latex=function(){return"\\left"+this.children[0].value+this.children[1].to_latex()+"\\right"+this.children[2].value},B.prototype.to_ascii=function(a){return a&&a.absval_as_fn?"abs("+this.children[1].to_ascii(a)+")":"|"+this.children[1].to_ascii(a)+"|"},B.registerAtParser=function(a){B.parserSymbol=a.registerSymbol("|",1),B.parserSymbol.nud=function(){var b=a.parseExpression(1);return a.advance("\\right",!0),a.advance("|"),new B(b)},B.parserSymbol.led=function(b){var c=a.parseExpression(K.prototype.bp,this);return K.createProduct(b,c)}},r.call(C,"radical",{bp:50,vertical_notation:!1}),C.prototype.set_degree=function(a){var b;this.has_children()&&this.children[0].is_group("degree")&&this.children[0].remove(),b=a&&a.is_group("degree")?a:new E(a?a:new D(2)),this.insert(0,b)},C.prototype.init_symbols=function(){this.insert(1,new s("")),this.insert(2,new s("//"))},C.prototype.set_radicand=function(a){this.has_children()&&this.children[3]&&this.children[3].remove(),a&&(this.insert(3,a),w.handle(a))},C.prototype.is_square_root=function(){return this.match("sqrt[2]\\ANY")},C.prototype.get_degree=function(){return this.children[0]},C.prototype.get_degree_term=function(){return this.children[0].get_term()},C.prototype.get_radicand=function(){return w.areHidden(this.children[3])?this.children[3].children[1]:this.children[3]},C.prototype.map_to_radical=function(a,b,c){var d=c?a.updateNodeMap.bind(a):a.extendNodeMap.bind(a);d(this,b),d(this.children[0],b.children[0]),d(this.children[1],b.children[1]),d(this.children[2],b.children[2])},C.parsable_syms=["sqrt","\\sqrt",""],C.registerAtParser=function(a){var b=function(){var b=new C,c=a.parseExpression(1/0);if(c.is_group("brackets")&&"["===c.children[0].value){var d=c.children[1];b.set_degree(d);var e=a.parseExpression(1/0);b.set_radicand(e)}else b.set_radicand(c);return b},c=function(b){var c=a.parseExpression(K.prototype.bp,this);return K.createProduct(b,c)};C.parsable_syms.forEach(function(d){var e=a.registerSymbol(d,C.prototype.bp);e.nud=b,e.led=c})},C.prototype.to_ascii=function(a){var b=this.get_radicand();if(a&&a.roots_as_powers){var c=this.get_degree_term().to_ascii(a);return"("+b.to_ascii(a)+")^(1/("+c+"))"}return b.parent.is_group("brackets")&&(b=b.parent),2!==this.get_degree().get_term().value?"sqrt"+this.get_degree().to_ascii(a)+b.to_ascii():b.is_group("brackets")?"sqrt"+b.to_ascii():"sqrt "+b.to_ascii()},C.prototype.to_latex=function(){var a="\\sqrt";return 2!==this.get_degree().get_term().value&&(a+=this.get_degree().to_latex()),a+"{"+this.get_radicand().to_latex()+"}"},ad.inherit(_c.Node,D),q.call(D,"num"),D.is_num=function(a){return arguments.length<=1||void 0===arguments[1]||!arguments[1]?a.is_group("num")||a.is_group("sign","add","sub")&&a.children[1]&&a.children[1].is_group("num"):a.is_group("num")||a.is_group("sign","plusminus","addsub","add","sub")&&a.children[1]&&a.children[1].is_group("num")},D.get_value=function(a){var b=!(arguments.length<=1||void 0===arguments[1])&&arguments[1];return a?a instanceof D?a.get_base().value:a.is_group("sign")&&a.children[1]instanceof D?-a.children[1].get_base().value:b&&a.is_group("plusminus")&&a.children[1]instanceof D?a.children[1].get_base().value:a.is_group("add")&&a.children[1]instanceof D?a.children[1].get_base().value:a.is_group("sub")&&a.children[1]instanceof D?-a.children[1].get_base().value:b&&a.is_group("addsub")&&a.children[1]instanceof D?a.children[1].get_base().value:NaN:NaN},D.is_equal_to=function(a){for(var b=D.get_value(a),c=arguments.length,d=Array(c>1?c-1:0),e=1;e<c;e++)d[e-1]=arguments[e];return!isNaN(b)&&d.some(function(a){return a===b})},D.is_inequal_to=function(a,b,c){var d=D.get_value(a);if(isNaN(d))return!1;if("<"===b||"lt"===b)return d<c;if(">"===b||"gt"===b)return d>c;if("<="===b||"lte"===b)return d<=c;if(">="===b||"gte"===b)return d>=c;throw"(Num:is_inequal_to) Comparator not accepted."},D.prototype.get_signed_value=function(){var a=this.parent;if(!a)return this.get_base().value;var b=this.get_base().value;return a&&a.is_group("sign","sub")?-b:D.is_leading_num_in_sub_product(this)?-b:b},D.is_leading_num_in_sub_product=function(a){var b=a.parent;return!!(a instanceof D&&b.is_group("mul")&&!b.ls&&b.parent.is_group("product")&&b.parent.parent.is_group("sub"))&&b.parent.parent},D.apply_precision=function(a,b){var c=Math.pow(10,b);return Math.round(a*c)/c},D.prototype.decimal_count=function(){var a=this.get_base().to_ascii(),b=a.indexOf(".");return-1===b?0:a.length-b-1},D.prototype.to_string=function(a){var b=a.precision,c=void 0===b?3:b;if(this.value===1/0)return"";var d=this.value;if(this.scrubbingThisNum){var e=Math.pow(10,-this.scrub_precision),f=Math.abs(d%e),g=e-f>e/10&&f>e/10;return d.toFixed(Math.max(0,this.scrub_precision+(g?1:0)))}return D.apply_precision(d,c).toString()},D.prototype.to_ascii=function(a){var b=D.apply_precision(this.get_base().value,this.max_precision),c=this.get_subscript_helper("to_ascii",a),d=void 0;if(a&&a.rationalize_reals)if(Math.round(b)===b)d=b+c;else{var e=b.toString().split(".");d="("+("0"===e[0]?e[1]:e[0]+e[1])+"/1"+Array(e[1].length+1).join("0")+")"}else d=a&&a.integers_as_reals?""+b.toFixed(this.max_precision)+c:""+b+c;return c.length>0&&a&&a.subscripts_as_long_names?'"'+d+'"':d},D.prototype.to_latex=function(){return""+D.apply_precision(this.get_base().value,this.max_precision)+this.get_subscript_helper("to_latex")},D.registerAtParser=function(a){var b=a.registerSymbol("(number)",30);b.nud=function(){return new D(this.value)},b.led=function(b){var c=a.parseExpression(K.prototype.bp,this);return K.createProduct(b,c)}},r.call(E,"degree",{group_class:C,group_name:"radical",bp:51,vertical_notation:!0}),E.prototype.get_term=function(){return w.areHidden(this.children[0])?this.children[0].children[1]:this.children[0]},E.prototype.to_ascii=function(a){return 0===this.children.length?"":"["+this.children[0].to_ascii(a)+"]"},E.prototype.to_latex=function(){return 0===this.children.length?"":"["+this.children[0].to_latex()+"]"},E.hide_rule={name:"hide degree of 2",disabled:!1,apply:function(a){a.parent.is_group("degree")&&D.is_equal_to(a,2)&&(a.hidden=!0)}},F.unicode_syms=["","","<",">"],F.value2sym={lte:"",gte:"",lt:"<",gt:">"},F.sym2Ascii={"":"<=","":">=","<":"<",">":">"},r.call(F,"inequality",{bp:10}),F.prototype.to_ascii=function(a){return this.children.map(function(b,c){return 1===c?F.sym2Ascii[b.to_ascii(a)]:b.to_ascii(a)}).join("")},F.is_inequality=function(a){return a.is_group("lte","gte","lt","gt")},F.prototype.setValue=function(a){this.value=a,this.get_child([1]).value=F.value2sym[this.value]},F.prototype.invert=function(){"lte"===this.value?this.setValue("gte"):"gte"===this.value?this.setValue("lte"):"lt"===this.value?this.setValue("gt"):"gt"===this.value&&this.setValue("lt")},F.registerAtParser=function(a){var b={"<":"lt","\\lt":"lt",">":"gt","\\gt":"gt","<=":"lte","\\le":"lte","":"lte",">=":"gte","\\ge":"gte","":"gte"};for(var c in b)a.registerSymbol(c,F.prototype.bp).led=function(b,c){var d=a.parseExpression(F.prototype.bp);if(F.is_inequality(c)||F.is_inequality(d)||c.is_group("equals")||d.is_group("equals"))throw"More than one comparator in equation.";return new F(c,d,b)}.bind(null,b[c])},r.call(G,"equals",{bp:10}),G.registerAtParser=function(a){a.registerSymbol("=",G.prototype.bp).led=function(b){var c=a.parseExpression(G.prototype.bp);if(b.is_group("equals")||c.is_group("equals")||F.is_inequality(b)||F.is_inequality(c))throw"More than one comparator in equation.";return new G(b,c)}},G.getOppositeSide=function(a){for(var b=a;b.parent&&!b.parent.is_group("equals");)b=b.parent;return b.parent&&b.parent.is_group("equals")?b.parent.children[2-b.get_idx()]:null},r.call(H,"power",{bp:50,vertical_notation:!1}),H.prototype.is_square_root=function(){return this.match("\\ANY^0.5","\\ANY^(1/2)")},H.prototype.get_exponent_term=function(){return this.children[1].get_term()},H.hasEvenExponent=function(a){var b=arguments.length<=1||void 0===arguments[1]||arguments[1];if(!a||!a.is_group("power"))return!1;var c=a.get_exponent_term(),d=void 0;return b?d=D.get_value(c):(d=Id.evalExpression(c),isNaN(d)&&(d=+$c.eval(ad.termsToAlgebriteString(c)).toString())),d%2==0};H.prototype.get_exponent_value=function(){return H.getNumericalValueOfExponent(this)},H.getNumericalValueOfExponent=function(a){return a.is_group("power")||a.is_group("exponent")?(a.is_group("exponent")?a=a.children[0]:a.is_group("power")&&(a=a.get_child([1,0])),w.areHidden(a)&&(a=a.children[1]),D.get_value(a)):1},H.haveSameBase=function(a,b){return a.is_group("power")&&(a=a.children[0]),b.is_group("power")&&(b=b.children[0]),a.to_ascii()===b.to_ascii()},r.call(I,"product",{bp:30,vertical_notation:!1}),I.prototype.invert=function(){var a=this.children.length;if("product"==this.value){this.value="fraction",this.vertical_notation=!0;for(var b=this.children[a-1],c=a-1;b&&"div"==b.value;)b=b.ls,c--;b&&"//"===b.value||_c.insert(this,c+1,new s("//"))}else if(this.value="product",this.vertical_notation=!1,a>0)for(var d=this.children[0];d;)"//"==d.value&&_c.remove(d),d=d.rs},I.prototype.append=function(a){if("product"==this.value&&"div"==a.value)this.invert(),_c.append(this,a);else if("fraction"==this.value&&"mul"==a.value){for(var b=0;b<this.children.length&&"//"!==this.children[b].value;)b++;_c.insert(this,b,a)}else _c.append(this,a);return this},I.prototype.insert=function(a,b,c){if("product"==this.value&&"div"==b.value)this.invert(),_c.append(this,b);else if("fraction"==this.value&&"mul"==b.value){var d=this.get_top().length;a>d&&(a=d),_c.insert(this,a,b)}else if("fraction"==this.value&&"div"==b.value&&c){a+=this.get_top().length+1;var e=this.children.length;a>e&&(a=e),_c.insert(this,a,b)}else _c.insert(this,a,b)},I.prototype.append_range=function(a){a.forEach(function(a){this.append(a)},this)},I.prototype.insert_range=function(a,b,c){"product"==this.value&&"div"==b[0].value?this.append_range(b):b.forEach(function(b){this.insert(a++,b,c)},this)},I.prototype.insert_into_demominator=function(a,b){if(!b.is_group("div"))throw'wrong type of term, expected "div", not "'+b.name+'"';if("product"==this.value)this.invert(),_c.append(this,b);else{for(var c=0;c<this.children.length&&"//"!==this.children[c].value;)c++;c=Math.max(this.children.length,c+1+a),_c.insert(this,c,term)}return this},I.prototype.get_top=function(){for(var a=this.children[0],b=[];a;)"mul"==a.value&&b.push(a),a=a.rs;return b},I.prototype.get_bottom=function(){for(var a=this.children[0],b=[];a;)"div"==a.value&&b.push(a),a=a.rs;return b},I.prototype.get_fraction_bar=function(){for(var a=this.children[0];a;){if("//"==a.value)return a;a=a.rs}return null},I.get_whole_range=function(a){var b=Array.isArray(a)?a:[a];if(b[0].is_group("mul"))return b[0].parent.get_top();if(b[0].is_group("div"))return b[0].parent.get_bottom();throw"(ProductFraction) Incorrect operator type."},I.convert_to_reciprocal=function(a){function b(a){_c.remove_range(a),a.forEach(function(a){a.invert()})}var c=!1;if(a.is_group("sign","plusminus")&&(c=!0,a=a.children[1]),1===D.get_value(a))return c?a.parent:a;var d;if(a.is_group("fraction")&&1===a.get_top().length&&D.is_equal_to(a.get_top()[0].children[1],1)&&1===a.get_bottom().length){var e=a.parent,f=a.remove();d=a.get_bottom()[0].children[1],d.remove(),e.insert(f,d)}else if(a.is_group("fraction")){d=a;var g=a.get_top(),h=a.get_bottom();b(g),b(h),a.append_range(h),1===g.length&&D.is_equal_to(g[0].children[1],1)?a.invert():a.append_range(g)}else if(a.is_group("product")){d=a;var g=a.get_top();b(g),a.invert(),a.append(new K(new D(1))),a.append_range(g)}else{var e=a.parent,i=a.remove(),j=new I;j.invert(),j.append(new K(new D(1))),j.append(new K(a,"div")),e.insert(i,j),d=j}return c?d.parent:d},I.is_fraction=function(a){return a.is_group("fraction")||a.is_group("sign")&&a.children[1].is_group("fraction")},I.is_fraction_with_identity_numerator=function(a){return!(!a.is_group("fraction")||!I.is_lone_fraction_part(a.children[0]))&&D.is_equal_to(a.get_child([0,1]),1)},I.is_lone_fraction_part=function(a){return a.is_group("mul")&&!a.ls&&"//"===a.rs.value||a.is_group("div")&&!a.rs&&"//"===a.ls.value},I.matchSource=function(a){return!a.is_group("mul")&&(a.is_group("div")&&(a=a.parent),!!a.is_group("fraction")&&(1===a.get_bottom().length&&{fraction:a,mul:a.get_top()[0],div:a.get_bottom()[0]}))},I.getFactors=function(a){var b=!(arguments.length<=1||void 0===arguments[1])&&arguments[1],c=[];if(a.is_group("fraction")&&!b){var d=a.get_parent(2);d&&d.is_group("product")&&(a=d)}return a.is_group("fraction")&&(c=a.get_top().concat(a.get_bottom())),a.is_group("product")&&a.children.forEach(function(a){var d=a.children[1];!b&&d.is_group("fraction")?c=c.concat(d.get_top()).concat(d.get_bottom()):c.push(a)}),c},I.getSourceAndTarget=function(a){if("drag"===this.triggerType)return{source:a?this.nodes:this.nodes[0],target:this.target};var b=I.matchSource(this.actor);return{source:b.div,target:b.mul}},I.prototype.group_nodes=function(){for(var a,b=this.children[0],c=[],d=[];b;)"div"==b.value?d.push(b):"mul"==b.value?c.push(b):a=b,b=b.rs;return{top:c,bottom:d,bar:a}},I.prototype.to_latex=function(){for(var a=this.get_top(),b=this.get_bottom(),c=b.length>0?"\\frac{":"",d=0;d<a.length;d++)c+=0==d?a[d].children[1].to_latex():a[d].to_latex();if(b.length>0){c+="}{";for(var d=0;d<b.length;d++)c+=0==d?b[d].children[1].to_latex():b[d].to_latex();c+="}"}return c},I.prototype.to_ascii=function(a,b){for(var c=this.get_top(),d=this.get_bottom(),e=[],f=[],g=0;g<c.length;g++){var h=(0===g?"":"*")+c[g].children[1].to_ascii(a);b&&0===g?e.push("{"+h+"}"):e.push(h)}var i=e.join("");if(0==d.length)return i;for(var g=0;g<d.length;g++)f.push((0==g?"":"*")+d[g].children[1].to_ascii(a));var j=f.join("");return J(i,c)+"/"+J(j,d)},r.call(K,"mul-div",{group_class:I,bp:30,associative:!0,commutative:!0,has_inverse:!0}),K.createProduct=function(a,b){if(a.is_group("product"))return a.append(new K(b)),a;var c=K.prototype.createParentGroup();return c.append(new K(a)),c.append(new K(b)),c},K.registerAtParser=function(a){var b=a.registerSymbol("*",K.prototype.bp);b.led=function(b){var c=a.parseExpression(K.prototype.bp);return K.createProduct(b,c)},a.registerSymbol("\\cdot",K.prototype.bp).led=b.led,a.registerSymbol("\\times",K.prototype.bp).led=b.led,a.registerSymbol("/",K.prototype.bp+1).led=function(b){var c,d=a.parseExpression(K.prototype.bp+1);if(b.is_group("brackets")&&b.children[1].is_group("product","fraction")&&(b.user_grouped||(b=b.children[1],b.children[0].children[1].user_grouped=!0)),b.is_group("product")?c=b:(c=K.prototype.createParentGroup(),c.append(new K(b))),d.is_group("brackets")&&d.children[1].is_group("product","fraction")&&(d.user_grouped||(d=d.children[1])),d.is_group("product"))for(var e=d.children,f=0;f<e.length;f++)e[f].invert(),c.append(e[f]);else c.append(new K(d,"div"));return c};var c=function(){var b,c=a.parseExpression(100),d=a.parseExpression(100);return c.is_group("product")?(b=c,c.children[0].children[1].user_grouped=!0):(b=K.prototype.createParentGroup(),b.append(new K(c))),d.is_group("product")?d.children.forEach(function(a){a.invert(),b.append(a)}):b.append(new K(d,"div")),b};a.registerSymbol("\\frac").nud=c,a.registerSymbol("\\dfrac").nud=c,a.registerSymbol("\\tfrac").nud=c},K.hide_rule={name:"hide multiplication sign between variables",disabled:!1,apply:function(a){if(!(a instanceof s)||"*"!==a.value&&"/"!==a.value)return!1;var b=a.parent;if(!b||!b.is_group("mul")&&!b.is_group("div"))return!1;if(!b.ls||b.ls.value!==b.value||!a.rs)return!1;var c=b.ls.children[1];(a.rs.is_group("var")||a.rs.is_group("power")&&a.rs.children[0].is_group("var"))&&(D.is_num(c)||c.is_group("var")||c.is_group("sign")&&c.children[1].is_group("var"))&&(b.dragging?a.hide_after_drop=!0:a.hidden=!0)}},K.prototype.invert=function(){"mul"==this.value?(this.value="div",this.children[0]&&(this.children[0].value="/"),this.associative=!1,this.bp=30):(this.value="mul",this.children[0]&&(this.children[0].value="*"),this.associative=!0,this.bp=30)},K.groupWithSiblings=function(a){for(var b=!(arguments.length<=1||void 0===arguments[1])&&arguments[1],c=[],d=[],e=a[0],f=a[a.length-1];e.ls&&e.ls.is_group(a[0].value)&&(!b||e.symIsHidden());)c.unshift(e.ls),e=e.ls;for(;f.rs&&f.rs.is_group(a[0].value)&&(!b||f.rs.symIsHidden());)d.push(f.rs),f=f.rs;return c.concat(a).concat(d)},K.prototype.symIsHidden=function(){return this.children[0].hidden||this.children[0].hide_after_drop},K.prototype.map_group_and_sym=function(a,b,c){var d=c?a.updateNodeMap.bind(a):a.extendNodeMap.bind(a);d(this,b),d(this.children[0],b.children[0])},ad.inherit(_c.Node,L),q.call(L,"placeholder"),r.call(L,"placeholder",{bp:L.prototype.bp}),L.prototype.to_string=function(){return""},L.prototype.match=function(a){return"any"===this.value||a.name===this.value},L.prototype.to_ascii=function(a){var b=this;if(""!==this.value)return"\\"+this.value.toUpperCase();var c=function(){var c=0,d=b.get_root();return d instanceof Id?d.select_first(function(a){return""===a.value&&c++,a===b}):c=ad.uid(),"string"==typeof c||c>1?{v:'"'+(b.value+c)+'"'}:{v:a&&a.quote_placeholders?'"'+b.value+'"':b.value}}();return"object"==typeof c?c.v:void 0},L.prototype.to_latex=function(){return""===this.value?"\\dottedsquare":"\\"+this.value.toUpperCase()},L.prototype.is_group=function(){for(var a=0;a<arguments.length;a++)if("placeholder"===arguments[a])return!0;return!1},ad.inherit(_c.Node,M),q.call(M,"var"),M.prototype.to_ascii=function(a){var b=this.to_ascii_value_modifier(this.get_base().value,a),c=this.get_subscript_helper("to_ascii",a);return c.length>0&&a&&a.subscripts_as_long_names?'"'+b+c+'"':b.toString()+c},M.prototype.to_ascii_value_modifier=function(a,b){return b&&b.greek_symbols_to_latex&&M.unicode_to_latex[a]&&(a=M.unicode_to_latex[a]),a.length>1?'"'+a+'"':a},M.prototype.to_latex=function(){if(this.hidden)return"";var a=this.get_base().value;return""+(M.latex_to_unicode[a]?M.latex_to_unicode[a]:a)+this.get_subscript_helper("to_latex")},M.constant_values=["i"],M.constant_value=function(a){return Boolean(~ad.findIndex(M.constant_values,function(b){return b===a}))},M.is_constant=function(a){return Boolean(a instanceof M&&M.constant_value(a.value)||a.is_group("sign")&&M.constant_value(a.children[1].value))},M.is_var=function(a){return a instanceof M||a.is_group("power")&&a.children[0]instanceof M},M.latex_to_unicode={"(name)":"","\\dottedsquare":"","\\alpha":"","\\Alpha":"","\\beta":"","\\Beta":"","\\gamma":"","\\Gamma":"","\\delta":"","\\Delta":"","\\epsilon":"","\\Epsilon":"","\\zeta":"","\\Zeta":"","\\eta":"","\\Eta":"","\\theta":"","\\Theta":"","\\iota":"","\\Iota":"","\\kappa":"","\\Kappa":"","\\lambda":"","\\Lambda":"","\\mu":"","\\Mu":"","\\nu":"","\\Nu":"","\\xi":"","\\Xi":"","\\omicron":"","\\Omicron":"","\\pi":"","\\Pi":"","\\rho":"","\\Rho":"","\\sigma":"","\\Sigma":"","\\varsigma":"","\\tau":"","\\Tau":"","\\upsilon":"","\\Upsilon":"","\\phi":"","\\Phi":"","\\chi":"","\\Chi":"","\\psi":"","\\Psi":"","\\omega":"","\\Omega":""},M.unicode_to_latex=function(a){var b={};for(var c in a)b[a[c]]=c;return b}(M.latex_to_unicode),M.utf8_subscripts=[{char:"",val:0},{char:"",val:1},{char:"",val:2},{char:"",val:3},{char:"",val:4},{char:"",val:5},{char:"",val:6},{char:"",val:7},{char:"",val:8},{char:"",val:9}],M.registerAtParser=function(a){function b(a){return""===a[0]?new L(a[0]):new M(a)}a.registerSymbol("_",100).led=function(b){var c=a.parseExpression(99);if(b.is_leaf_node)b.set_subscript(c,!0);else{var d=b.children[b.children.length-1];if(!d.is_leaf_node)return!1;d.set_subscript(c,!0)}return b},M.utf8_subscripts.forEach(function(b){a.registerSymbol(b.char,100).led=function(a){return!!a.is_leaf_node&&(a.set_subscript(new D(b.val)),a)}});var c=function(){return b("name"===this.type?this.value:M.latex_to_unicode[this.value])},d=function(b){var c=a.parseExpression(K.prototype.bp,this);return K.createProduct(b,c)};for(var e in M.latex_to_unicode){var f=a.registerSymbol(e,30);f.nud=c,f.led=d}},r.call(N,"exponent",{group_class:H,group_name:"power",bp:51,vertical_notation:!0}),N.prototype.get_term=function(){return w.areHidden(this.children[0])?this.children[0].children[1]:this.children[0]},N.prototype.to_ascii=function(a){return 0===this.children.length?"":"^"+this.children[0].to_ascii(a)},N.prototype.to_latex=function(){if(0===this.children.length)return"";var a=this.children[0].to_latex();return a.length<2||this.children[0].is_group("brackets","abs-val")&&!w.areHidden(this.children[0])?"^"+a:"^{"+a+"}"},N.registerAtParser=function(a){a.registerSymbol("^",N.prototype.bp).led=function(b){return new H(b,a.parseExpression(N.prototype.bp-1))},[{char:"",val:0},{char:"",val:1},{char:"",val:2},{char:"",val:3},{char:"",val:4},{char:"",val:5},{char:"",val:6},{char:"",val:7},{char:"",val:8},{char:"",val:9}].forEach(function(b){a.registerSymbol(b.char,N.prototype.bp).led=function(a){return new H(a,new D(b.val))}}),a.registerSymbol("",N.prototype.bp).led=function(a){return new H(a,new M("n"))},a.registerSymbol("\\scriptscriptstyle").nud=function(){return a.parseExpression(N.prototype.bp)}},ad.inherit(sd,O),r.call(O,"func",{bp:60,commutative:!1}),O.units={sin:["rad","deg"],cos:["rad","deg"],tan:["rad","deg"]},O.prototype.is_leaf_node=!1,O.prototype.is_group=function(){if(0===arguments.length)return!0;for(var a=0;a<arguments.length;a++){if("func"===arguments[a])return!0;if(arguments[a]===this.value)return!0}return!1},O.prototype.to_string=function(){return this.value},O.prototype.set_arg=function(a){if(Array.isArray(a))this.append(new w(new R(a)));else if(a.is_group("tuple"))this.append(a),w.handle(this.children[1]);else if(a.is_group("brackets")&&a.children[1].is_group("tuple"))this.append(a);else if(a.is_group("brackets")&&!a.children[1].is_group("tuple")){var b=a,c=b.children[1];b.insert(c.remove(),new R(c)),this.append(b)}else this.append(new R(a)),w.handle(this.children[1])},O.prototype.arg_length=function(){var a=this.children[1];return(a.is_group("tuple")?a:a.children[1]).children.length},O.prototype.get_arg=function(a){var b=this.children[1];return b.get_child(b.is_group("brackets")?[1,a||0,1]:[a||0,1])},O.prototype.map_to_func=function(a,b,c){var d=c?a.updateNodeMap.bind(a):a.extendNodeMap.bind(a);d(this,b),d(this.children[0].get_mapping_to(b.children[0]));var e=this.children[1],f=b.children[1];e.is_group("brackets")&&f.is_group("brackets")&&(d(e,f),d(e.children[0],f.children[0]),d(e.children[2],f.children[2]),e=e.children[1],f=f.children[1]),d(e,f)},O.prototype.map_to_group=function(a,b,c){var d=c?a.updateNodeMap.bind(a):a.extendNodeMap.bind(a),e=[];this.for_each(function(a){e.push(a)},this),e.forEach(function(a){d(a,b)}),d=a.extendNodeMap.bind(a),b.children.forEach(function(a){a.for_each(function(a){e.forEach(function(b){d(b,a)})},this)},this)},O.Trig={},O.Trig.evaluate=function(a){var b=D.get_value(a.get_arg());return Number.isNaN(b)?NaN:("deg"===a.units&&(b*=Math.PI/180),Math[a.value](b))},O.Trig.is_trig_func=function(a){return a&&a.is_group("func")&&("sin"===a.value||"cos"===a.value||"tan"===a.value)},O.Logs={},O.Logs.is_log_func=function(a){return a&&a.is_group("func")&&("log"===a.value||"ln"===a.value)},O.Logs.get_log_base=function(a,b){var c;return a.children[0].has_subscript()&&(c=a.children[0].get_subscript()),c||b||(c=O.Logs.get_implied_subscript(a)),c},O.Logs.get_implied_subscript=function(a){var b=a.children[0].get_value();return"log"===b?new D(10):"ln"===b?new M("e"):null},O.Logs.within_domain=function(a){return D.is_inequal_to(a,"gt",0)||M.is_var(a)&&"e"===a.get_value()},O.Logs.evaluate=function(a){var b=O.Logs.get_log_base(a).get_value(),c=a.get_arg().get_value();return"e"===c&&(c=Math.E),"e"===b&&(b=Math.E),Math.log(c)/Math.log(b)},O.parsable_syms=["sin","cos","tan","\\sin","\\cos","\\tan","log","ln","\\log","\\ln"],O.registerAtParser=function(a){function b(b){if(a.advance("_",!0)){var c=b.children[0].value,d=a.parseExpression(99);("ln"===c&&D.is_num(d)||"ln"===c&&M.is_var(d)&&"e"!==d.value)&&(b.value="log",b.children[0].value="log"),b.children[0].set_subscript(d)}}var c=function(){var c=new O("\\"===this.value[0]?this.value.substr(1):this.value);b(c);var d=a.parseExpression(O.prototype.bp);if(d.is_group("brackets")&&d.children[1].is_group("tuple")&&d.children[1].children.length>1)throw"Supported functions cannot have multiple arguments";return c.set_arg(d),c},d=function(b){var c=a.parseExpression(K.prototype.bp,this);return K.createProduct(b,c)};O.parsable_syms.forEach(function(b){var b=a.registerSymbol(b,O.prototype.bp);b.nud=c,b.led=d})},ad.inherit(sd,P),P.prototype.name="param",P.prototype.bp=5,P.createTuple=function(a,b){if(a.is_group("tuple"))return a.append(new P(b)),a;var c=new R;return c.append(new P(a)),c.append(new P(b)),c},P.prototype.append=function(a){_c.append(this,a),a instanceof s&&(a.fixed=!0)},P.registerAtParser=function(a){var b=a.registerSymbol(",",P.prototype.bp);b.led=function(b){var c=a.parseExpression(P.prototype.bp);return P.createTuple(b,c)},a.registerSymbol("\\,",P.prototype.bp).led=b.led},P.hide_rule={name:"Do not show the first comma in a tuple set.",disabled:!1,apply:function(a){if(!(a instanceof s)||","!==a.value)return!1;var b=a.parent;if(!b||!b.is_group("param"))return!1;b.ls&&b.ls.value===b.value||(a.hidden=!0)}},ad.expressions[P.prototype.name]=P,r.call(Q,"sign",{bp:40,associative:!0,commutative:!1,inverse:"sign"}),Q.registerAtParser=function(a){function b(){return new Q(a.parseExpression(Q.prototype.bp),!0)}a.registerSymbol("+").nud=function(){var b=a.parseExpression(Q.prototype.bp);return b.had_leading_plus=!0,b};var c=a.registerSymbol("-");c.nud=function(){return new Q(a.parseExpression(Q.prototype.bp))},["","\\pm"].forEach(function(c){a.registerSymbol(c).nud=b}),a.registerSymbol("").nud=c.nud},Q.prototype.deconstruct=function(){var a=[];return a.push(this),a},Q.prototype.to_ascii=function(a){var b=this.children[0].to_ascii(a),c=this.children[1].to_ascii(a),d=void 0;return d=!this.children[1].is_group("fraction")||a&&a.bracketed_negatives?b+c:b+"{"+c+"}",a&&a.bracketed_negatives?"("+d+")":d},Q.wrapTerm=function(a){return Q.invertTerm(a,!1)},Q.invertTerm=function(a){var b=arguments.length<=1||void 0===arguments[1]||arguments[1],c=a;c.is_group("product")?c=c.children[0].children[1]:c.is_group("mul","div","add","sub")?c=c.children[1]:c.parent&&c.parent.is_group("sign")&&(c=c.parent);var d=c.parent;if(d){var e=c.remove();if(c.is_group("sign")&&b){var f=c.children[1];return d.insert(e,f),f}return d.insert(e,new Q(c))}if(c.is_group("sign")&&b){var g=c.children[1];return g.remove(),g.ls=null,g.rs=null,g}return new Q(c)},ad.inherit(sd,R),R.prototype.name="tuple",R.is_tuple=function(a){return a instanceof R||a.is_group("brackets")&&a.children[1]instanceof R},R.prototype.to_ascii=function(a){return this.children.map(function(b){return b.ls?b.to_ascii(a):b.children[1].to_ascii(a)}).join("")},R.prototype.to_latex=function(){return this.children.map(function(a){return a.ls?a.to_latex():a.children[1].to_latex()}).join("")},ad.expressions[R.prototype.name]=R,S.prototype.getDefaultPrecision=function(){if(this.derivation)return this.derivation.settings.getIfExists("scrub_precision",1)},S.prototype.check=function(a){if(this.view.model.settings.get("locked"))return!1;var b=a.pos0[1]-a.pos[1];return Math.abs(b)>=10},S.prototype.start=function(a,b){return this.old_anim_dur=this.view.settings.get("dur"),this.view.settings.set("dur",0),this.node=this.process_selection(b),this.node?(this.precision=this.getDefaultPrecision(),this.dy=0,this.dx=0,this.value=this.value0=this.view.model.numeric_value(this.node),[this.node]):[]},S.prototype.update=function(a){if(this.node&&(a.dy||a.dx)){this.dx+=a.dx,this.dy+=a.dy,this.updatePrecision();var b=Math.pow(10,this.precision),c=-this.dy/this.pixels_per_unit/b;c=Math.round(c*b)/b,this.set_value(this.value0+c)}},S.prototype.updatePrecision=function(){var a=Math.round(this.dx/this.pixels_per_precision),b=this.getDefaultPrecision()+a;b!==this.precision&&(this.precision=b,this.dy=0,this.value0=this.value,console.log("precision is",this.precision))},S.prototype.set_value=function(a){if(a!==this.value){this.value=a;var b=this.view.model.numeric_value(this.node,a);b instanceof D?(b.scrubbingThisNum=!0,b.scrub_precision=this.precision):b.is_group("add","sub","sign")&&(b.children[1].scrubbingThisNum=!0,b.children[1].scrub_precision=this.precision),b!==this.node&&(this.node=this.process_selection([b]),this.value=this.value0=this.view.model.numeric_value(this.node),this.interaction_handler.highlight_nodes([this.node]))}},S.prototype.end=function(){this.node&&(this.node instanceof D&&delete this.node.scrubbingThisNum,this.node.is_group("add","sub","sign")&&delete this.node.children[1].scrubbingThisNum,this.view.render()),this.view.settings.set("dur",this.old_anim_dur),this.node=null},S.prototype.process_selection=function(a){var b=function(a){return a.is_group("sign")||a.is_group("add")||a.is_group("sub")};if(0===a.length||a.length>2)return null;if(2===a.length){var c=a[1];return c instanceof D&&b(c)?c.parent:null}var d=a[0];return d instanceof D?b(d.parent)?d.parent:d:b(d)?d:null},ad.ChangeNumberHandler=S,td={Kalam:"Font_Kalam"},new md("Font_Kalam").defaults.setAll({normal_font:{family:"Kalam"},italic_font:{family:"Kalam"},font_dominant_baseline:-.94,font_center:-.62,font_ascent:-.05,font_descent:1.16,slanted_div_bar:!0,div_bar_height:1/12,char_metrics:{"":{ascent:-.32,width:.65},f:{width:.45},"(":{ascent:0},")":{ascent:0},"+add":{lmar:1/6,rmar:1/6},"-sub":{lmar:1/6,rmar:1/6},"addsub":{lmar:1/6,rmar:1/6},"=":{lmar:1/3,rmar:1/3},"<":{lmar:1/3,rmar:1/3},">":{lmar:1/3,rmar:1/3},"":{lmar:1/3,rmar:1/3},"":{lmar:1/3,rmar:1/3},",":{lmar:0,rmar:1/3}}}),ud={},ad.HitTester=ud,ud.draw=function(a){var b=arguments.length<=1||void 0===arguments[1]?[]:arguments[1],c=arguments[2],d=a.selectAll(".gm-target").data(b);d.enter().append("div").classed("gm-area",!0).classed("gm-target",!0),d.style("left",function(a){return a.x+"px"}).style("top",function(a){return a.y+"px"}).style("width",function(a){return a.width+"px"}).style("height",function(a){return a.height+"px"}),d.exit().remove();var e=a.selectAll(".gm-source").data(c?[c]:[]);e.enter().append("div").classed("gm-area",!0).classed("gm-source",!0),e.style("left",function(a){return a.x+"px"}).style("top",function(a){return a.y+"px"}).style("width",function(a){return a.width+"px"}).style("height",function(a){return a.height+"px"}),e.exit().remove()},ud.drawDestinationHints=function(a,b){var c=a.select(".destination-main");if(!b||0===b.destination_hint_boxes.length)return void c.remove();0===c.size()&&(c=a.insert("div",".gm-math").classed("destination-main",!0).style("opacity",.5));var d=b.destination_hint_boxes,e=c.selectAll(".gm-destination").data(d);e.enter().insert("div",".gm-math").classed("gm-area",!0).classed("gm-destination",!0),e.style("left",function(a){return a.x+"px"}).style("top",function(a){return a.y+"px"}).style("width",function(a){return a.width+"px"}).style("height",function(a){return a.height+"px"}),e.exit().remove()},ud.drawDropAreaHints=function(a){var b=arguments.length<=1||void 0===arguments[1]?[]:arguments[1],c=a.select(".drop-area-main");if(0===b.length)return void c.remove();0===c.size()&&(c=a.insert("div",".gm-math").classed("drop-area-main",!0).style("opacity",.15));var d=c.selectAll(".gm-drop").data(b.filter(function(a){return!a.drop_area_hint.hidden&&!a.settings.dummy}));d.enter().append("div").classed("gm-area",!0).classed("gm-drop",!0).style("z-index",function(a){return a.priority}),d.style("left",function(a){return a.drop_area_hint_box.x+"px"}).style("top",function(a){return a.drop_area_hint_box.y+"px"}).style("width",function(a){return a.drop_area_hint_box.width+"px"}).style("height",function(a){return a.drop_area_hint_box.height+"px"}).style("background-color",function(a){return"outside"===a.drop_area_hint.side?"transparent":null}),d.exit().remove()},ud.getBoundingBox=function(a){for(var b=arguments.length<=1||void 0===arguments[1]?1:arguments[1],c=!(arguments.length<=2||void 0===arguments[2])&&arguments[2],d=1/0,e=-1/0,f=1/0,g=-1/0,h=0;h<a.length;h++){var i=a[h];if(i.sel_box&&(!i.hidden||i.smooshing)){var j=c?i.x0||0:i.x,k=c?i.y0||0:i.y;d=Math.min(d,i.sel_box.x+j),e=Math.max(e,i.sel_box.x+j+i.sel_box.width),f=Math.min(f,i.sel_box.y+k),g=Math.max(g,i.sel_box.y+k+i.sel_box.height)}}var l=e-d,m=g-f;return{x:d+l*(1-b)/2,y:f+m*(1-b)/2,width:l*b,height:m*b}},ud.setTargetRegions=function(a,b,c){var d=arguments.length<=3||void 0===arguments[3]||arguments[3];a.forEach(function(a){a.raw_target_box=ud.getRawTargetBox(a.target,a.settings.side);var c=a.getDropArea(),d=ud.getRawTargetBox(c.node,c.side);if(a.settings.target_group){var e=a.target.get_parent(1);if(e.is_group("fraction")&&"around"===a.settings.group_side){var f=ud.getRawTargetBox(e,"around"),g=a.target.is_group("mul")?e.get_top():e.get_bottom();d=ud.getRawTargetBox(g,"around"),d.width=f.width,d.x=f.x}else d=ud.getRawTargetBox(e,a.settings.group_side)}ud.adjustTargetBox(d,c,b),ad.extend(a,d),a.drop_area_hint||a.setDropAreaHint(c),a.drop_area_hint_box=ud.getRawTargetBox(a.drop_area_hint.node,a.drop_area_hint.side),ud.adjustTargetBox(a.drop_area_hint_box,a.drop_area_hint,b),a.destination_hints||a.setDestinationHints(),a.destination_hint_boxes=a.destination_hints.map(function(a){var c=ud.getRawTargetBox(a.node,a.side);return ud.adjustTargetBox(c,a,b),c})}),d&&ud.extendExtremeTargetBoxes(a,c)},ud.getRawTargetBox=function(a,b){var c={};switch(b){case"left-of":c.x=a.sel_box.x+a.x0-.001,c.width=1,c.y=a.sel_box.y+a.y0,c.height=a.sel_box.height;break;case"right-of":c.x=a.sel_box.x+a.x0+a.sel_box.width+.001,c.width=1,c.y=a.sel_box.y+a.y0,c.height=a.sel_box.height;break;case"right-inside":c.x=a.sel_box.x+a.x0+.001,c.width=a.sel_box.width-.001,c.y=a.sel_box.y+a.y0,c.height=a.sel_box.height;break;case"left-inside":c.x=a.sel_box.x+a.x0,c.width=a.sel_box.width-.001,c.y=a.sel_box.y+a.y0,c.height=a.sel_box.height;break;case"below":c.x=a.sel_box.x+a.x0,c.width=a.sel_box.width,c.y=a.sel_box.y+a.y0+a.sel_box.height-.5,c.height=1;break;case"above":c.x=a.sel_box.x+a.x0,c.width=a.sel_box.width,c.y=a.sel_box.y+a.y0-.5,c.height=1;break;default:if(Array.isArray(a)){var d=ud.getBoundingBox(a);c.x=d.x,c.width=d.width,c.y=d.y,c.height=d.height}else c.x=a.sel_box.x+a.x0,c.width=a.sel_box.width,c.y=a.sel_box.y+a.y0,c.height=a.sel_box.height}return c},ud.adjustTargetBox=function(a,b,c){b.offset&&ud.adjustTargetBoxByOffset(a,b.offset),b.margin&&ud.adjustTargetBoxByMargin(a,b.margin,c)},ud.adjustTargetBoxByMargin=function(a,b,c){var d=0,e=0,f=0,g=0;b.all&&(d=e=f=g=b.all),b.x&&(d=e=b.x),b.y&&(f=g=b.y),b.x1&&(d=b.x1),b.y1&&(f=b.y1),b.x2&&(e=b.x2),b.y2&&(g=b.y2),d*=c,f*=c,e*=c,g*=c,a.x+=d,a.width-=e+d,a.y+=f,a.height-=g+f,a.width<=0&&(a.x+=-d>-e?-a.width/2:a.width/2,a.width=1),a.height<=0&&(a.y+=-f>-g?-a.height/2:a.height/2,a.height=1)},ud.adjustTargetBoxByOffset=function(a,b){a.x+=b.x,a.y+=b.y},ud.extendExtremeTargetBoxes=function(a,b){function c(a){return a.x+a.width}function d(a,b){return c(a)<b.x}for(var e=[],f=[],g=0;g<a.length;g++){var h=a[g],i=ud.getComparableBox(h);if(!h.source_am&&(1!==h.nodes.length||"AlgebraModel"!==h.nodes[0].type)){var j=void 0;try{j=ud.getBoundingBox(a[0].nodes,1,!0)}catch(a){throw'An action triggered by drag does not have a set "nodes" array.'}ud.boxIsLeftOrRightOfViewBox(i,b)&&(d(i,j)?0===e.length||e.length>0&&c(i)<c(ud.getComparableBox(e[0]))?e=[h]:e.length>0&&c(ud.getComparableBox(e[0]))===c(i)&&e.push(h):d(j,i)&&(0===f.length||f.length>0&&ud.getComparableBox(f[0]).x<i.x?f=[h]:f.length>0&&ud.getComparableBox(f[0]).x===i.x&&f.push(h)))}}e.filter(function(a){return!a.settings.no_target_box_expansion}).forEach(function(a){"inside"!==a.settings.side&&"outside"!==a.settings.group_side&&(a.x-=100,a.width+=100,a.y-=50,a.height+=100)}),f.filter(function(a){return!a.settings.no_target_box_expansion}).forEach(function(a){"inside"!==a.settings.side&&"outside"!==a.settings.group_side&&(a.width+=100,a.y-=50,a.height+=100)})},ud.getComparableBox=function(a){return"right-inside"===a.settings.side?ud.getRawTargetBox(a.target,"right-of"):"left-inside"===a.settings.side?ud.getRawTargetBox(a.target,"left-of"):a.settings.target_group&&"right-of"===a.settings.side?ud.getRawTargetBox(a.target.parent,"right-of"):a.settings.target_group&&"left-of"===a.settings.side?ud.getRawTargetBox(a.target.parent,"left-of"):a},ud.boxIsLeftOrRightOfViewBox=function(a,b){var c=1;return a.x>b.x+b.width-c||a.x+a.width<b.x+c},ud.getHits=function(a,b){var c=[];return c=c.concat(a.filter(function(a){return(!a.settings.target_group&&"outside"!==a.settings.side||a.settings.target_group&&"outside"!==a.settings.group_side)&&ud.overlaps(a,b)})),c=c.concat(a.filter(function(a){return(!a.settings.target_group&&"outside"===a.settings.side||a.settings.target_group&&"outside"===a.settings.group_side)&&!ud.overlaps(a,b)}))},ud.getBestHit=function(a,b){var c=ud.getHits(a,b);return ud.getHighestPriorityHit(c,b)},ud.getEnclosingRectForSourceLineEndpoint=function(a){return{xmin:a.B.x-2,ymin:a.B.y-2,xmax:a.B.x+2,ymax:a.B.y+2}},ud.overlaps=function(a,b){return(a.x>=b.x&&a.x<=b.x+b.width||a.x+a.width>=b.x&&a.x+a.width<=b.x+b.width||a.x<=b.x&&a.x+a.width>=b.x+b.width)&&(a.y>=b.y&&a.y<=b.y+b.height||a.y+a.height>=b.y&&a.y+a.height<=b.y+b.height||a.y<=b.y&&a.y+a.height>=b.y+b.height)},ud.getHighestPriorityHit=function(a,b){for(var c=null,d=0;d<a.length;d++){var e=a[d];if(c){if("outside"===c.settings.side)c=e;else if(e.priority>c.priority)c=e;else if(e.priority===c.priority){var f=c.settings.target_group||c.drop_area&&c.target!==c.drop_area.node||"left-inside"===c.settings.side||"right-inside"===c.settings.side?c.raw_target_box:c,g=e.settings.target_group||e.drop_area&&e.target!==e.drop_area.node||"left-inside"===e.settings.side||"right-inside"===e.settings.side?e.raw_target_box:e;ud.getCenterDist(g,b)<ud.getCenterDist(f,b)&&(c=e)}}else c=e}return c},ud.getCenterDist=function(a,b){var c=a.x+a.width/2-b.x-b.width/2,d=a.y+a.height/2-b.y-b.height/2;return Math.sqrt(c*c+d*d)},ud.getOverlapArea=function(a,b){var c=Math.max(a.x,b.x)-Math.min(a.x+a.width,b.x+b.width),d=Math.max(a.y,b.y)-Math.min(a.y+a.height,b.y+b.height);return Math.max(0,c)*Math.max(0,d)},vd={},ad.Reselector=vd,vd.rules=[],vd.getNewSelection=function(a){var b=this.getBestRule(a);return!!b&&b.apply(a)},vd.getBestRule=function(a){for(var b=null,c=0;c<this.rules.length;c++){var d=this.rules[c];d.match(a)&&(!b||b.priority<d.priority)&&(b=d)}return b},vd.hasMatchingRule=function(a){for(var b=0;b<this.rules.length;b++)if(rules[b].match(a))return!0;return!1},vd.Rule=function(a,b){this.name=a,this.priority=b||0},vd.Rule.prototype.match=function(a){throw"override match function!"},vd.Rule.prototype.apply=function(a){throw"override apply function!"},ad.inherit(U,vd.Rule),U.prototype.match=function(a){if(1!==a.length)return!1;var b=a[0],c=b.parent;return!!b.is_group("exponent")&&(!!c.parent.is_group("mul","div")&&c.parent.parent.children.some(function(a){if("//"===a.to_ascii())return!1;var b=a.children[1];return b!==c&&ad.actions.MultiplyPowersAction.areLikeTerms(c,b)}))},U.prototype.apply=function(a){return[a[0].parent.parent]},vd.rules.push(new U),V.defaultOptions={zoom:1,input_types:"all",tap_max_time:250,tap_max_dist:10,hold_time:500,hold_max_dist:10,dbltap_max_delay:400,dbltap_max_dist:20},ad.mtouch_defaults=V.defaultOptions,ad.mtouch_events=V,ad.d3_eventDispatch=W,wd=0,"undefined"!=typeof window&&(wd=/WebKit/.test(window.navigator.userAgent)?-1:0),ad.transform_behavior=Z,_.debug_draw=!1,_.prototype.check=function(a,b){var c=a.pos0[0]-a.pos[0],d=a.pos0[1]-a.pos[1];return(1!==a.fingers.length||0!==b.length)&&c*c+d*d>=64},_.prototype.isActive=function(){return this.active},_.prototype.start=function(a,b){var c=this;return!0===this.view.settings.get("hide_mouse_cursor")&&d3.select("html").style("cursor","none"),this.derivation&&this.derivation.setLastHandleVisibility(!1),this.active=!0,this.setDragNodes(_.process_selection(b)),this.rubberband_dir=0,this.center=this.getCenter(this.nodes),this.indicator&&this.indicator.move_to(this.center,!0),this.interaction_handler.events.on("keydown."+this.id,function(a){18!==a.keyCode&&32!==a.keyCode||c.selectNodesOneLevelUp(!0)}),this.view.model.hide_nodes()&&(this.view.renderer.set_style(this.nodes),this.view.update_style()),this.indicator&&this.view.main.call(this.indicator),this.view.enter_and_exit(!1,"shadow"),this.setupActions(),this.derivation&&this.derivation.canvas_model&&this.indicator&&(this.indicator.setOffset(this.getCenterOffset(this.view.input_mode)),this.derivation.canvas_model.on("input_mode."+this.id,function(a){this.indicator.setOffset(this.getCenterOffset(a.mode))}.bind(this))),this.nodes},_.prototype.getCenter=function(a){var b=ud.getBoundingBox(aa(a));return[b.x+b.width/2,b.y+b.height/2]},_.prototype.getCenterOffset=function(a){return"touch"===a?{x:0,y:this.view.settings.get("drag_dy_on_touch")*this.view.model.children[0].size}:{x:0,y:0}},_.prototype.setDragNodes=function(a){this.nodes.forEach(function(a){a.dragging=!1}),this.nodes=a,this.nodes.forEach(function(a){a.dragging=!0}),this.leaf_nodes=_c.filter(function(a){return!a.has_children()},a)},_.prototype.selectNodesOneLevelUp=function(){var a=!(arguments.length<=0||void 0===arguments[0])&&arguments[0];if(this.stopAllTimeouts(),!this.nodes[0].parent.is_root()){this.smooshing&&this.cancelSmooshing();var b=[];return this.nodes[0].is_group("mul","div")?(b=K.groupWithSiblings(this.nodes,!0),b.length===this.nodes.length&&(b=K.groupWithSiblings(this.nodes)),b.length===this.nodes.length&&(b=[this.nodes[0].parent])):this.nodes.forEach(function(c){var d=!a&&c.parent.is_group("param","equals","gt","gte","lt","lte")?c:c.parent;d.is_group("param")&&(d=d.parent),b.push(d)}),this.updateSelection(b)}},_.prototype.onTap=function(a){a&&a.is_group("equals","gt","gte","lt","lte")||this.updateSelection(_c.nodes_to_range(this.nodes.concat([a])))},_.prototype.updateSelection=function(a){var b=_.process_selection(a),c={x:this.nodes[0].x-this.nodes[0].x0,y:this.nodes[0].y-this.nodes[0].y0};this.setDragNodes(b),this.view.model.hide_nodes()&&(this.view.renderer.set_style(this.nodes),this.view.update_style()),this.interaction_handler.highlight_nodes(this.nodes),this.view.renderer.set_position(this.view.model,!1);for(var d=0;d<this.nodes.length;d++){this.nodes[d].for_each(function(a){a.x+=c.x,a.y+=c.y})}return this.view.enter_and_exit(!1,"shadow"),this.view.update_existing(!1,"shadow"),this.view.updateDraggedNodes(this.leaf_nodes),this.setupActions(),this.center=this.getCenter(this.nodes),this.indicator&&this.indicator.move_to(this.center),this.nodes},_.prototype.update=function(a){var b=a.dx,c=a.dy;if(this.dy+=c,this.dx+=b,this.view.settings.get("rubber_band_selection")){var d=3.5*this.view.settings.get("font_size");if(0!==this.dy&&Math.abs(this.dy-this.dy0)>d){var e=this.dy>this.dy0?1:-1;0!==this.rubberband_dir&&e!==this.rubberband_dir||(this.dy0=this.dy,this.rubberband_dir=e,this.selectNodesOneLevelUp())}}this.finger_delta.x+=b,this.finger_delta.y+=c,this.pushToDeltaQueue(b,c),ba(this.finger_delta,3)&&this.bestHit&&this.derivation.settings.get("auto_trigger_actions")&&this.stopAllTimeouts(),this.smooshing?this.smooshedNodes.forEach(function(a){_c.for_each(function(a){a.x+=b,a.y+=c},a)}):_c.for_each(function(a){a.x+=b,a.y+=c},this.nodes),this.bbox.x+=b,this.bbox.y+=c,this.center[0]+=b,this.center[1]+=c,this.updateActions(),this.smooshing?this.view.updateSmooshed(this.smooshedNodes):this.view.updateDraggedNodes(this.leaf_nodes),_.debug_draw&&this.debugDraw(!0)},_.prototype.pushToDeltaQueue=function(a,b){this.dx_queue.push(a),this.dy_queue.push(b),this.dx_queue.length>4&&this.dx_queue.shift(),this.dy_queue.length>4&&this.dy_queue.shift()},_.prototype.reduceDeltaQueues=function(){return{x:this.dx_queue.reduce(function(a,b){return a+b},0),y:this.dy_queue.reduce(function(a,b){return a+b},0)}},_.prototype.setupActions=function(){this.bestHit=null,this.dx_queue=[],this.dy_queue=[],this.finger_delta={x:0,y:0},this.view_box=this.view.getBBox({no_padding:!0});var a=this.nodes.length>0?.1*this.nodes[0].size:.1*this.view.settings.get("font_size");this.smooshing?this.bbox={x:this.center[0]-a,y:this.center[1]-a,width:2*a,height:2*a}:(this.bbox=ud.getBoundingBox(aa(this.nodes),0),this.bbox.x-=a,this.bbox.width=2*a,this.bbox.y-=1.5*a,this.bbox.height=3*a);var b=this.view.model.getMoveActions(this.nodes);this.interaction_handler.only_synchronous_actions?this.shake_actions=[]:this.shake_actions=b.filter(function(a){return"shake"===a.settings.side}),this.actions=b.filter(function(a){return"shake"!==a.settings.side}),this.view.settings.get("enable_drag_to_join")||(this.actions=this.actions.filter(function(a){return!a.settings.is_join_action})),this.interaction_handler.only_synchronous_actions&&(this.actions=this.actions.filter(function(a){return!a.settings.asynchronous})),this.actions=this.actions.concat(this.getSubstitutionActions()),ud.setTargetRegions(this.actions,this.view.settings.get("font_size"),this.view_box),_.debug_draw&&this.debugDraw(!0),this.derivation.settings.get("show_area_hints")&&ud.drawDropAreaHints(this.view.main,this.actions),this.indicator&&(this.indicator.animate(0,0),this.indicator.move_to(this.center))},_.prototype.getSubstitutionActions=function(){var a=this;if(!this.derivation)return[];var b=this.derivation.getRowByView(this.view);b||(b=this.derivation.getLastRow());var c=this.derivation.pos.x-this.derivation.dims.x+b.pos[0],d=this.derivation.pos.y-this.derivation.dims.y+b.pos[1],e=[];return this.derivation.getAllDLs().forEach(function(b){var f=b.getLastRow(),g=f.model;if(g.id!==a.view.model.id){var h=g.getMoveActions(a.nodes,[ad.actions.DirectSubstitutionAction]);h.forEach(function(a){a.target_ih=f.view.interaction_handler,a.settings.offset={x:b.pos.x-b.dims.x+f.pos[0]-c,y:b.pos.y-b.dims.y+f.pos[1]-d}},a),e=e.concat(h)}}),e},_.prototype.updateActions=function(){var a=this.applyShakeToShakeActions();a.length>0&&(this.end(!1),this.interaction_handler.performAction(a[0],!1));var b=this.getBestHit();b?this.handleTargetHit(b):this.handleTargetMiss(),this.indicator&&this.indicator.move_to(this.center)},_.prototype.handleTargetHit=function(a){if(this.derivation.settings.get("auto_trigger_actions")?a.settings.no_delay?this.performAction(a):a.timeoutID||this.applyTimeout(a):!a.settings.makes_no_changes||!a.settings.no_delay&&a.settings.on_release?this.on_release_action=a:this.performAction(a),this.bestHit!==a)if(this.bestHit=a,this.derivation.settings.get("show_area_hints")&&ud.drawDropAreaHints(this.view.main),this.derivation.settings.get("show_dest_hints"))ud.drawDestinationHints(this.view.main,a);else if(a.target_ih)a.target_ih.highlight_nodes(a.getTargetsForHighlighting(),!1,!0);else{var b=a.getTargetsForHighlighting();b.length>0&&this.view.interaction_handler.highlight_nodes(this.nodes.concat(b),!1,!0)}},_.prototype.handleTargetMiss=function(){this.bestHit&&(this.bestHit=null,this.derivation.settings.get("show_area_hints")&&ud.drawDropAreaHints(this.view.main,this.actions),this.derivation.settings.get("show_dest_hints")?ud.drawDestinationHints(this.view.main):this.unhighlightTargetNodes(),this.derivation.settings.get("auto_trigger_actions")?this.stopAllTimeouts():this.on_release_action=null)},_.prototype.getBestHit=function(){var a=!(arguments.length<=0||void 0===arguments[0])&&arguments[0],b=ud.getHits(this.actions,this.bbox);a&&(b=b.filter(function(a){return!a.settings.delay})),this.isTooFarFromAView()&&(b=b.filter(function(a){return a.source_am}));var c=ud.getHighestPriorityHit(b,this.bbox);return c&&c.settings&&c.settings.dummy&&(c=null),c},_.prototype.isTooFarFromAView=function(){if(!this.bbox)return!1;var a=this.bbox.x+this.bbox.width/2,b=this.bbox.y+this.bbox.height/2,c=this.view_box,d=2*this.view.settings.get("font_size");return a<c.x-d||a>c.x+c.width+d||b<c.y-d||b>c.y+c.height+d},_.prototype.performAction=function(a){var b=!(arguments.length<=1||void 0===arguments[1])&&arguments[1];this.derivation.settings.get("auto_trigger_actions")&&this.stopAllTimeouts(),this.derivation.settings.get("show_dest_hints")&&ud.drawDestinationHints(this.view.main),_.debug_draw&&this.debugDraw(!1),this.dy=0,this.dx=0;var c={};_c.for_each(function(a){c[a.id]={x:a.x,y:a.y}},this.nodes);var d=a.oldTree,e=d!==this.view.model;e&&d.startInteraction();var a=a.oldTree.performAction(a);e&&(d.finishInteraction(),d.for_each(function(a){return a.selected=!1}),d.hide_nodes(),this.view.render(!1)),this.derivation&&this.derivation.setLastHandleVisibility(!1);var f=_.getNewSelectionAfterAction(a,this.nodes);if(!b){if(0===f.length)return console.warn("No follow-up nodes selected! Check node_maps of action "+a.name+"!"),void this.interaction_handler.abort_interaction();var g=vd.getNewSelection(f);f=g||f,a.settings.is_join_action&&!g||(a.settings.is_join_action=!1,this.smooshing&&this.cancelSmooshing()),this.interaction_handler.highlight_nodes(f),this.setDragNodes(f),this.correctNodePositions(this.nodes,a,c),this.view.model.hide_nodes(),a.settings.is_join_action&&(this.updateSmooshAnimation(a,c),da(a.nodes,this.nodes)),(a.settings.reset_x||a.settings.reset_y)&&this.resetPositionOfDraggedNodes(a.settings.reset_x,a.settings.reset_y),a.settings.makes_no_changes||this.alignExpressionAroundDraggedNodes(a.settings.is_join_action),this.smooshing||(this.center=this.getCenter(this.nodes)),this.view.enter_and_exit(!1,"shadow"),this.view.update_existing(!0,"both"),this.view.updateDraggedNodes(this.leaf_nodes),this.setupActions()}},_.getNewSelectionAfterAction=function(a,b){var c=a.new_selection?a.new_selection:a.mapNodes(b);return ca(c),_.process_each_selection(c)},_.prototype.updateSmooshAnimation=function(a,b){this.view.hideExitingNodes(),this.addSmooshedNodes(a,b),this.view.enterSmooshed(this.smooshedNodes),this.shrinkNewSmooshedNodes(),this.positionSmooshedNodesInWheel(),this.view.updateSmooshed(this.smooshedNodes,!1)},_.prototype.addSmooshedNodes=function(a,b){var c=this,d=a.nodes[0],e=a.target,f=function(a){var b=_c.clone(a,!1,["id","value","name","bp","associative","commutative","vertical_notation","selected","dragging","locked","fixed","hidden","simplify","deleted","precision","color","size","width","height","x","y","x0","y0","rel_x","rel_y","lmar","rmar","scale_y"]);return b.children[0]&&b.symIsHidden()&&(b.children[0].hidden=!1),b};this.smooshing=!0,0===this.smooshedNodes.length&&function(){var a=f(d),e=b[d.id],g=e?e.x-a.x:0,h=e?e.y-a.y:0,i=c.view.settings.get("selection_color");_c.for_each(function(a){a.x+=g,a.y+=h,a.color=i},a),c.smooshedNodes.push(a)}();var g=f(e),h=b[e.id],i=h?h.x-g.x:0,j=h?h.y-g.y:0,k=this.view.settings.get("color");_c.for_each(function(a){a.x+=i,a.y+=j,a.color=k},g),this.smooshedNodes.push(g)},_.prototype.shrinkNewSmooshedNodes=function(){2===this.smooshedNodes.length?this.smooshedNodes.forEach(this.shrinkSmooshedNodesGroup.bind(this)):this.shrinkSmooshedNodesGroup(this.smooshedNodes[this.smooshedNodes.length-1])},_.prototype.shrinkSmooshedNodesGroup=function(a){a.size=a.size*this.view.settings.get("smooshed_nodes_shrink_factor"),_c.for_each(function(b){b.size=a.size},a),this.view.renderer.set_position(a)},_.prototype.positionSmooshedNodesInWheel=function(){for(var a=this.smooshedNodes.length,b=this.calculatePositionOnCircleForEachGroup(a),c=0;c<this.smooshedNodes.length;c++){var d=this.smooshedNodes[c],e=this.center[0]+d.width/2+b[c][0],f=this.center[1]-d.height/2+b[c][1],g=e-d.x,h=f-d.y;d.for_each(function(a){a.x+=g,a.y+=h})}},_.prototype.calculatePositionOnCircleForEachGroup=function(a){for(var b=this.view.settings.get("font_size"),c=360/a,d=270,e=d,f=[d],g=0;g<a-1;g++)e+=c,e=(e+360)%360,f.push(e);var h=function(a){return a*Math.PI/180};return f.map(function(a){return[b*Math.cos(h(a)),b*Math.sin(h(a))]})},_.prototype.cancelSmooshing=function(){_c.for_each(function(a){return a.smooshing=!1},this.nodes),this.smooshing=!1,this.smooshedNodes=[],this.view.exitSmooshed()},_.prototype.correctNodePositions=function(a,b,c){if(!b.settings.makes_no_changes||b.settings.update_node_positions){var d;_c.select_first(function(c){if(!c.has_children()){var e=b.mapNodes(c);if(1!==e.length||e[0].has_children())return!1;var f=_c.select_first(function(a){return a===e[0]},a);return!!f&&(d={old:c,new:f},!0)}},b.nodes),d&&function(){var b=c[d.old.id].x-d.new.x0,e=c[d.old.id].y-d.new.y0;_c.for_each(function(a){a.x=a.x0+b,a.y=a.y0+e},a)}()}},_.prototype.resetPositionOfDraggedNodes=function(a,b){this.nodes.forEach(function(c){c.for_each(function(c){a&&(c.x=c.x0),b&&(c.y=c.y0)})})},_.prototype.alignExpressionAroundDraggedNodes=function(a){if(!ud.boxIsLeftOrRightOfViewBox(ud.getBoundingBox(this.nodes),this.view_box)){if(a){for(var b=0,c=0;c<this.nodes[0].children.length;c++)b+=this.nodes[0].children[c].sel_box.width;this.x_offset=this.center[0]+b/2-this.nodes[0].x0}else this.x_offset=this.nodes[0].x-this.nodes[0].x0;this.applyHorizontalShiftToRestingNodes(this.x_offset),a?_c.for_each(function(a){a.x0+=this.x_offset,a.x+=this.x_offset}.bind(this),this.nodes):_c.for_each(function(a){a.x0+=this.x_offset}.bind(this),this.nodes)}},_.prototype.applyHorizontalShiftToRestingNodes=function(a){var b=this.view.model.filter(function(a){return!a.dragging});b=b.filter(function(a){for(var b=a;b=b.parent;)if(b.dragging)return!1;return!0}),b.forEach(function(b){b.x+=a,b.x0+=a})},_.prototype.debugDraw=function(a){a?ud.draw(this.view.main,this.actions,this.bbox):ud.draw(this.view.main)},_.prototype.end=function(){var a=arguments.length<=0||void 0===arguments[0]||arguments[0];d3.select("html").style("cursor",null),this.indicator&&this.indicator.remove(),this.interaction_handler.events.on("keydown."+this.id,null),this.unhighlightTargetNodes(),this.cancelSmooshing(),this.setDragNodes([]),this.view.enter_and_exit(!0,"shadow");var b=!0;if(a){var c=this.on_release_action||this.getBestHit(!1);c&&(this.performAction(c,!0),b=c.settings&&c.settings.makes_no_changes)}b&&(this.view.model.hide_nodes(),this.view.render()),this.derivation&&this.derivation.setLastHandleVisibility(!0),this.stopAllTimeouts(),this.actions=[],this.bestHit=null,this.bbox=null,this.active=!1,this.dy=0,this.dy0=0,this.dx=0,_.debug_draw&&this.debugDraw(!1),this.derivation.settings.get("show_area_hints")&&ud.drawDropAreaHints(this.view.main),this.derivation.settings.get("show_dest_hints")&&ud.drawDestinationHints(this.view.main)},_.prototype.applyTimeout=function(a){var b=this.view.settings.get("trigger_delay_factor"),c=this.view.settings.get("trigger_delay_minimum"),d=a.settings.delay?Math.max(a.settings.delay*b,c):null;this.indicator&&this.indicator.animate(1,d),this.finger_delta.x=0,this.finger_delta.y=0,a.timeoutID=setTimeout(function(){a.settings.on_release?(this.on_release_action=a,this.indicator&&this.indicator.fill(),this.finger_delta={x:0,y:0}):this.performAction(a)}.bind(this),Math.max(d,c))},_.prototype.stopAllTimeouts=function(){this.indicator&&this.indicator.animate(0,0),this.on_release_action=null;for(var a=0;a<this.actions.length;a++){var b=this.actions[a];b.timeoutID&&this.clearActionTimeout(b)}},_.prototype.clearActionTimeout=function(a){clearTimeout(a.timeoutID),delete a.timeoutID,delete a.dx,delete a.dy},_.prototype.unhighlightTargetNodes=function(){this.actions.forEach(function(a){a.target_ih&&a.target_ih.highlight_nodes([],!1,!0)})},_.prototype.applyShakeToShakeActions=function(){var a=this.reduceDeltaQueues();if(!ba(a,3))return[];var b=this.view.settings.get("font_size");return Math.abs(this.dx)>2*b||Math.abs(this.dy)>3*b?(this.shake_actions.forEach(ga),[]):Math.abs(a.x)>Math.abs(a.y)?fa(this.shake_actions):ea(this.shake_actions,a)},_.process_each_selection=function(a){if(0===a.length)return[];var b=Id.groupNodeRanges(a),c=[];return b.map(function(a){return _.process_selection(a)}).forEach(function(a){c=ad.array.mergedNew(c,a)}),c},_.process_selection=function(a){var b=a.slice();if(0===b.length)return[];if(_.special_selection(b))return _.special_selection(b);if(b[0].commutative){var c=b[0].parent;if(b.length<c.children.length)return b;b=[c]}for(var d=b[0];!Id.is_top_most(d)&&!d.parent.is_group("equals","gte","lte","gt","lt")&&!d.commutative&&!d.is_group("exponent","degree")&&!d.parent.is_group("param")&&(!d.parent.is_group("radical")||d.parent.children[3]!==d)&&(!d.is_group()||d.is_group("tuple")||1!==d.get_idx()||!d.parent.is_group("brackets")||w.areHidden(d.parent));)d=d.parent;return 1===d.get_idx()&&d.parent&&(d.parent.is_group("equals")||F.is_inequality(d.parent))&&(d=d.parent),[d]},_.special_selection=function(a){if(1!==a.length)return!1;var b=a[0];return!b.fixed&&b.parent.is_leaf_node&&1===b.get_idx()?a:"-"===b.to_ascii()||""===b.to_ascii()?a:"|"===b.to_ascii()&&0===b.get_idx()?a:(D.is_num(b)&&b.parent.is_group("sign")&&(b=b.parent),!!(D.is_equal_to(b,-1)&&b.parent.is_group("brackets")&&b.get_parent(2).is_group("power")&&b.get_parent(2).is_square_root())&&[b])},_.Indicator=function(){var a,b,c,d,e=0,f=0,g=12,h={x:0,y:0},i=!0,j=d3.svg.arc().innerRadius(g-2.5).outerRadius(g).startAngle(0),k=2*Math.PI,l=function(k){a=k.insert("svg","*").style("width","24px").style("height","24px").style("position","absolute").style("left",e-g+h.x+"px").style("top",f-g+h.y+"px").style("display",i?null:"none"),b=a.append("g").attr("transform","translate("+g+","+g+")"),d=b.append("circle").attr("r",g).style({stroke:"none",fill:"orange",opacity:.4}),c=b.append("path").style({fill:"red",stroke:"none",opacity:.5}).datum({endAngle:0}).attr("d",j)};l.setOffset=function(a){h=a},l.remove=function(){a.remove()};var m=function(a){return function(b){var c=d3.interpolate(b.endAngle,a);return function(a){return b.endAngle=c(a),j(b)}}};return l.visible=function(b){if(0===arguments.length)return i;i=b,a&&a.style("display",i?null:"none")},l.move_to=function(b,c){e=b[0],f=b[1],a&&(c?a.style({left:e-g+h.x+"px",top:f-g+h.y+"px"}):a.transition().duration(300).ease("circle-out").style({left:e-g+h.x+"px",top:f-g+h.y+"px"}))},l.animate=function(a,b){var e=0===b?0:150;c.transition().delay(e).duration(Math.max(0,b-e-50)).ease("linear").attrTween("d",m(a*k)),d&&d.style("fill","orange"),c.style("fill","red")},l.fill=function(){c.transition().style("fill","green"),d&&d.transition().style("fill","green")},l},ad.DragHandler=_,ha.prototype.getHandlerByClass=function(a){var b=function(b){return b instanceof a};for(var c in this.handlers){var d=this.handlers[c].filter(b);if(d.length>0)return d[0]}},ha.prototype.start_of_interaction=function(){this.view.model.startInteraction()},ha.prototype.end_of_interaction=function(a){this.pending_eoi&&(clearTimeout(this.pending_eoi),this.pending_eoi=null),this.view.model.finishInteraction(a)};ha.prototype.init=function(){var a=this.view.main.node();this.mtouch=ad.mtouch_events().frame(a).hold_time(this.view.settings.get("hold_time")),this.view.event_receiver.call(this.mtouch),this.mtouch.on("touch",this.on_touch.bind(this,null)).on("release",this.on_release.bind(this,null)).on("tap",this.on_tap.bind(this,null)).on("dbltap",this.on_dbltap.bind(this,null)).on("hold",this.on_hold.bind(this,null));var b=Y().on("drag-start",this.on_drag_start.bind(this,null)).on("drag",this.on_drag.bind(this,null)).on("drag-end",this.on_drag_end.bind(this,null));this.mtouch.call(b),d3.select(document).on("keydown."+this.id,this.on_keydown.bind(this,null)),d3.select(document).on("keyup."+this.id,this.on_keyup.bind(this,null))},ha.prototype.abort_interaction=function(){this.active_handler&&this.active_handler.end(),this.active_handler=null,this.highlight_nodes([])},ha.prototype.modeChanged=function(a){this.interactive||this.mtouch.connected("inspect"===a)},ha.prototype.set_interactive=function(a){this.interactive=!!a,"inspect"===this.view.settings.get("interaction_mode")?this.mtouch.connected(!0):this.mtouch.connected(this.interactive)},ha.prototype.select_new_handler=function(a){for(var b=this.handlers[this.view.settings.get("interaction_mode")]||[],c=0;c<b.length;c++){var d=b[c];if(d.check(a,this.selected_nodes))return this.active_handler=d,void this.highlight_nodes(d.start(a.pos,this.selected_nodes))}},ha.prototype.on_keydown=function(a){function b(){this.highlight_nodes(this.selected_nodes.map(function(a){return this.get_user_selection(null,null,{altKey:!0},a)},this).reduce(function(a,b){return a.concat(b[0])},[])),this.mtouch.fingers().forEach(function(a){a.cancel_hold()})}var c=a||d3.event;if(16===c.keyCode);else if(18===c.keyCode)this.mtouch.fingers().length>0&&this.selected_nodes.length>0&&b.call(this);else if(32===c.keyCode)this.spaceBarDown=!0,this.mtouch.fingers().length>0&&this.selected_nodes.length>0&&(b.call(this),c.preventDefault&&c.preventDefault());else{if(27!==c.keyCode)return;this.active_handler&&!this.active_action&&(this.active_handler.end(),this.active_handler=null,this.end_of_interaction(),this.ignore_next_release_event=!0,this.highlight_nodes([]),c.preventDefault&&c.preventDefault())}this.active_handler&&c.preventDefault&&c.preventDefault(),this.send_events&&!ad.ui.Keyboard().visible()&&this.events.keydown(new Bd("down",c,this.id))},ha.prototype.on_keyup=function(a){var b=a||d3.event;if(16===b.keyCode);else{if(32!==b.keyCode)return;this.spaceBarDown=!1}this.active_handler&&b.preventDefault&&b.preventDefault(),this.send_events&&!ad.ui.Keyboard().visible()&&this.events.keyup(new Bd("up",b,this.id))},ha.prototype.on_tap=function(a){var b=this,c=this.view.settings.get("interaction_mode");if(!this.active_action){var d=this.selectInputEvent(a,d3.event);if(!d.shiftKey||"inspect"===c){var e,f=this.get_closest_node_at(d.finger.pos);if(f&&(e=this.getFirstUnfixedParent(f)),this.active_handler)return void(this.active_handler.onTap&&this.active_handler.onTap(e));if(this.send_events&&this.events.tap(new zd(d,this.id,f,e)),e){"inspect"===c&&(this.highlight_nodes([]),this.events.inspect_node({node:e,shiftKey:d.shiftKey||this.touch_shift}),0===d.fingers.length&&this.end_of_interaction(!0)),"edit"===c&&function(){var a=b.view.model.getBestMatchingBoundAction(e,"tap");b.performAction(a,!1,function(){!a&&b.canvas_model&&b.view.model.getBestMatchingBoundAction(e,"dbltap")&&(b.notice_timer=setTimeout(function(){return b.canvas_model.showNotice("Try to double tap.",!0)},250))})}()}}}},ha.prototype.on_dbltap=function(a){var b=this,c=this.view.settings.get("interaction_mode");if(!this.active_action){var d=this.selectInputEvent(a,d3.event);if(!(this.active_handler||d.shiftKey&&"inspect"!==c)){var e,f=this.get_closest_node_at(d.finger.pos);f&&(e=this.getFirstUnfixedParent(f)),this.send_events&&this.events.tap(new Ad(d,this.id,f,e)),e&&("edit"===c?this.view.model.process_operator(e,function(a){b.end_of_interaction(!a),b.highlight_nodes([]),clearTimeout(b.notice_timer)},"dbltap"):"inspect"===c&&(this.highlight_nodes([]),this.events.inspect_node({node:e,shiftKey:d.shiftKey||this.touch_shift}),this.end_of_interaction(!0)))}}},ha.prototype.on_hold=function(a){var b=this.view.settings.get("interaction_mode");if(!this.active_action){var c=this.selectInputEvent(a,d3.event);if(!this.active_handler&&"edit"===b){this.send_events&&this.events.hold(new Cd(c,this.id));var d=this.get_closest_node_at(c.finger.pos);d&&"edit"===b&&this.performAction(this.view.model.getBestMatchingBoundAction(d,"hold"))}}},ha.prototype.performAction=function(a,b,c){if(!(this.only_synchronous_actions&&a&&a.settings.asynchronous)){this.active_action=a;var d=null;if(a&&a.settings.asynchronous){var e=a.nodes||[a.actor]||[];1===e.length&&"AlgebraModel"===e[0].type&&(e=[e[0].children[0]]),this.highlight_nodes(e,!0,!0),this.canvas_model&&(d=this.canvas_model.scroll(),this.canvas_model.scrollToShowElement(this.dl))}this.view.model.performAction(a,function(a){this.active_action=null,this.end_of_interaction(),this.highlight_nodes([]),null!==a&&this.canvas_model.scroll(a),c&&c()}.bind(this,d),b)}},ha.prototype.getFirstUnfixedParent=function(a){for(;a.fixed&&a.parent&&"AlgebraModel"!==a.parent.type;)a=a.parent;return a},ha.prototype.selectInputEvent=function(a,b){if(a)return a;for(var c=b;c.sourceEvent;)c=c.sourceEvent;return b.shiftKey=c.shiftKey,b.altKey=c.altKey,b},ha.prototype.on_drag_start=function(a){var b=this.view.settings.get("interaction_mode");if(!this.active_action&&(this.interactive||"inspect"===b)){var c=this.selectInputEvent(a,d3.event),d=this.selected_nodes.slice();if(this.active_handler)return void(this.send_events&&this.events.drag_start(new yd(c,this.id,d)));this.selected_nodes.length>1&&this.highlight_nodes(_c.nodes_to_range(this.selected_nodes)),this.select_new_handler(c),this.send_events&&this.events.drag_start(new yd(c,this.id,d,this.selected_nodes))}},ha.prototype.update_fingers=function(a,b){var c=10;if(!this.finger_sel){var d=this.view.main.node();this.finger_sel=d3.select(d).selectAll(".finger");var e=d3.touches(d,[{pageX:0,pageY:0,clientX:0,clientY:0}])[0],f=d3.touches(this.view.main.node(),[{pageX:0,pageY:0,clientX:0,clientY:0}])[0];this.dpos_finger_vis=[f[0]-e[0],f[1]-e[1]],this.finger_vis_start=Date.now()}var g=this.finger_sel.data(a);b||g.enter().append("div").classed("finger",!0).style({border:"2px solid rgba(77,77,77,0.5)","background-color":"rgba(178,202,237,0.5)",width:2*c+5+"px",height:2*c+5+"px","border-radius":"50%",position:"absolute"}).transition().ease("bounce").style({width:2*c+"px",height:2*c+"px"});var h=this.dpos_finger_vis;g.style("transform",function(a){return"translate("+(a.pos[0]-h[0]-c)+"px,"+(a.pos[1]-h[1]-c)+"px)"}),g.style("-webkit-transform",function(a){return"translate("+(a.pos[0]-h[0]-c)+"px,"+(a.pos[1]-h[1]-c)+"px)"});var i=this.finger_vis_start;g.exit().transition().delay(Math.max(0,250-(Date.now()-i))).style("opacity",1e-4).remove(),this.finger_sel=0===g.size()?null:g},ha.prototype.on_drag=function(a){var b=this.view.settings.get("interaction_mode");if(!this.active_action&&(this.interactive||"inspect"===b)){var c=this.selectInputEvent(a,d3.event);this.send_events&&this.events.drag(new Dd(c,this.id,this.selected_nodes)),(a||this.always_visualize_fingers)&&this.update_fingers(c.fingers,!0),this.active_handler||this.select_new_handler(c),this.active_handler&&this.active_handler.update(c)}},ha.prototype.on_drag_end=function(a){this.send_events&&this.events.drag_end(new Ed(this.uid))},ha.prototype.on_touch=function(a){var b=this.view.settings.get("interaction_mode");if(!this.active_action&&(this.interactive||"inspect"===b)){$(window).focus();var c=this.selectInputEvent(a,d3.event);if((a||this.always_visualize_fingers)&&this.update_fingers(c.fingers),this.active_handler)return void(this.send_events&&this.events.touch(new Fd(c,this.id)));"inspect"===b&&"touchstart"===c.sourceEvent.type&&c.sourceEvent.touches.length>1?this.touch_shift=!0:(this.touch_shift&&"touchstart"===c.sourceEvent.type&&c.sourceEvent.touches.length<2||this.touch_shift&&"mousedown"===c.sourceEvent.type)&&delete this.touch_shift;var d,e=this.get_user_selection(c.finger,null,c);"edit"===b&&1===c.fingers.length?(c.shiftKey||this.start_of_interaction(),c.shiftKey?d=ad.array.xor(this.selected_nodes,e):ad.array.containsAll(this.selected_nodes,e)||(d=e)):"edit"===b&&2===c.fingers.length?d=this.get_user_selection(c.fingers[0],c.fingers[1],c):"inspect"===b&&1===c.fingers.length&&(this.start_of_interaction(),ad.array.containsAll(this.selected_nodes,e)||(d=e)),this.send_events&&this.events.touch(new Fd(c,this.id,e,d||this.selected_nodes)),d&&this.highlight_nodes(d)}},ha.prototype.on_release=function(a){var b=this.view.settings.get("interaction_mode");if(this.interactive||"inspect"===b){var c=this.selectInputEvent(a,d3.event);if((a||this.always_visualize_fingers)&&this.update_fingers(c.fingers),this.ignore_next_release_event)return void(this.ignore_next_release_event=!1);if(this.send_events&&this.events.release(new Gd(c,this.id)),0===c.fingers.length){var d=c.shiftKey;this.active_handler&&(this.active_handler instanceof ia&&(d=!0),this.active_handler.end(),this.active_handler=null),this.active_action||d||(this.pending_eoi=setTimeout(function(){this.active_action||(this.pending_eoi=null,this.end_of_interaction(),this.highlight_nodes([]))}.bind(this),1))}}},ha.prototype.get_user_selection=function(a,b,c,d){var e;if(b)e=this.get_nodes_between(a.pos,b.pos);else{var f=d||this.get_closest_node_at(a.pos);if(!f)return[];if(f=this.getFirstUnfixedParent(f),c.altKey||this.spaceBarDown){for(;f.parent.parent&&!f.parent.commutative;)f=f.parent;var g=f.parent.parent;e=g&&g.is_group("fraction")?f.parent.is_group("mul")?g.get_top():g.get_bottom():f.parent.commutative?[f.parent.parent]:"AlgebraModel"===f.parent.type?[f]:[f.parent]}else e=[f]}return _c.nodes_to_range(e)},ha.prototype.highlight_nodes=function(a,b){var c=!(arguments.length<=2||void 0===arguments[2])&&arguments[2];if(!ad.array.equals(this.selected_nodes,a)){this.selected_nodes=a;var d=this.view;_c.for_each(function(a){a.selected=!1},d.model.children);for(var e=0;e<a.length;e++)a[e].selected=!0;d.renderer.set_style(d.model.children),d.update_style(!b),!c&&this.send_events&&this.events.node_selection(new Hd(this.id,a))}},ha.prototype.get_closest_node_at=function(a){var b=a[0],c=a[1],d=_c.get_leaf_nodes(this.view.model).filter(function(a){return a.sel_box&&!a.hidden}).map(function(a){var d=a.x+a.sel_box.x+a.sel_box.width/2-b,e=a.y+a.sel_box.y+a.sel_box.height/2-c,f=Math.abs(d)<=a.sel_box.width/2&&Math.abs(e)<=a.sel_box.height/2,g=d*d+e*e;return{node:a,score:(f?1e6:0)-g}});return d.sort(function(a,b){return b.score-a.score}),d[0].node},ha.prototype.get_nodes_between=function(a,b){var c=0;return _c.get_leaf_nodes(this.view.model).filter(function(d){if(d.hidden||!d.sel_box||"//"==d.value)return!1;var e=[d.x+d.sel_box.x+d.sel_box.width/2,d.y+d.sel_box.y+d.sel_box.height/2],f=xd(a,b,e),g=d.sel_box.width/4+d.sel_box.height/4;return 0==f.len?f.dist<=g+c:f.k>=0&&f.k<=1&&f.dist<=g+c})},xd=function(a,b,c){var d,e,f=.5,g=[b[0]-a[0],b[1]-a[1]],h=Math.sqrt(g[0]*g[0]+g[1]*g[1]);if(h<1e-6)d=a[0]-c[0],e=a[1]-c[1],h=0;else{var d,e,i=[c[0]-a[0],c[1]-a[1]],f=(g[0]*i[0]+g[1]*i[1])/h;f<0?(d=a[0]-c[0],e=a[1]-c[1]):f>h?(d=b[0]-c[0],e=b[1]-c[1]):(d=a[0]+f*g[0]/h-c[0],e=a[1]+f*g[1]/h-c[1])}return{dist:Math.sqrt(d*d+e*e),k:f/h,len:h}},yd=function(a,b,c,d){this.type="drag_start",this.performee=b,this.performee_type="interaction-handler",this.time=Date.now(),this.pos=[a.pos[0],a.pos[1]],this.pos0=[a.pos0[0],a.pos0[1]],this.dist=a.dist,this.dist0=a.dist0,a.altKey&&(this.altKey=a.altKey),a.shiftKey&&(this.shiftKey=a.shiftKey),this.fingers={length:a.fingers.length},this.target=c,this.selection=d},zd=function(a,b,c,d){this.type="tap",this.performee=b,this.performee_type="interaction-handler",this.time=Date.now(),a.altKey&&(this.altKey=a.altKey),a.shiftKey&&(this.shiftKey=a.shiftKey),this.finger={pos:[a.finger.pos[0],a.finger.pos[1]]},this.target=c,this.selection=d},Ad=function(a,b,c,d){this.type="dbltap",this.performee=b,this.performee_type="interaction-handler",this.time=Date.now(),a.altKey&&(this.altKey=a.altKey),a.shiftKey&&(this.shiftKey=a.shiftKey),this.finger={pos:[a.finger.pos[0],a.finger.pos[1]]},this.target=c,this.selection=d},Bd=function(a,b,c){this.type="key"+a,this.performee=c,this.performee_type="interaction-handler",this.time=Date.now(),this.keyCode=b.keyCode},Cd=function(a,b){this.type="hold",this.performee=b,this.performee_type="interaction-handler",this.time=Date.now(),this.finger={pos:[a.finger.pos[0],a.finger.pos[1]]}},Dd=function(a,b,c){this.type="drag",this.performee=b,this.performee_type="interaction-handler",this.time=Date.now(),this.dx=a.dx,this.dy=a.dy,this.dist=a.dist,this.dist0=a.dist0,this.pos=[a.pos[0],a.pos[1]],this.pos0=[a.pos0[0],a.pos0[1]],this.fingers=a.fingers.map(function(a){return{pos:[a.pos[0],a.pos[1]]}}),this.selection=c},Ed=function(a){this.type="drag_end",this.performee=a,this.performee_type="interaction-handler",this.time=Date.now()},Fd=function(a,b,c,d){this.type="touch",this.performee=b,this.performee_type="interaction-handler",this.time=Date.now(),a.altKey&&(this.altKey=a.altKey),a.shiftKey&&(this.shiftKey=a.shiftKey),a.finger&&(this.finger={pos:[a.finger.pos[0],a.finger.pos[1]],id:a.finger.id}),this.fingers=a.fingers.map(function(a){return{pos:[a.pos[0],a.pos[1]]}}),this.target=c,this.selection=d},Gd=function(a,b){this.type="release",this.performee=b,this.performee_type="interaction-handler",this.time=Date.now(),a.altKey&&(this.altKey=a.altKey),a.shiftKey&&(this.shiftKey=a.shiftKey),this.fingers=a.fingers.map(function(a){return{pos:[a.pos[0],a.pos[1]]}}),a.finger&&(this.finger={pos:[a.finger.pos[0],a.finger.pos[1]],id:a.finger.id})},Hd=function(a,b){this.type="node_selection",this.performee=a,this.performee_type="interaction-handler",this.time=Date.now(),this.selection=b},ia.prototype.check=function(a){return a.shiftKey},ia.prototype.start=function(a,b){return this.pos0=a.slice(),this.pos=a.slice(),this.initBox(),this.initial_nodes=b,b},ia.prototype.update=function(a){this.pos[0]+=a.dx,this.pos[1]+=a.dy,this.updateBox();var b=this.getNodesInRect(this.pos0[0],this.pos0[1],this.pos[0],this.pos[1]);ad.array.isPermutation(b,this.nodes)||(this.nodes=b,this.highlight())},ia.prototype.initBox=function(){var a=d3.rgb(this.view.settings.get("selection_color")),b="rgba("+a.r+", "+a.g+", "+a.b+", 0.33)";this.box_el=this.view.main.append("div").style({transform:"translate("+this.pos0[0]+"px,"+this.pos0[1]+"px)","-webkit-transform":"translate("+this.pos0[0]+"px,"+this.pos0[1]+"px)",border:"1px solid "+this.view.settings.get("selection_color"),background:b})},ia.prototype.updateBox=function(){var a="translate("+Math.min(this.pos0[0],this.pos[0])+"px,"+Math.min(this.pos0[1],this.pos[1])+"px)";this.box_el.style({width:Math.abs(this.pos[0]-this.pos0[0])+"px",height:Math.abs(this.pos[1]-this.pos0[1])+"px",transform:a,"-webkit-transform":a})},ia.prototype.getNodesInRect=function(a,b,c,d){var e=Math.min(a,c),f=Math.max(a,c),g=Math.min(b,d),h=Math.max(b,d);return _c.get_leaf_nodes(this.view.model).filter(function(a){return!a.hidden&&a.sel_box&&e<=a.x+a.sel_box.x+a.sel_box.width&&f>=a.x+a.sel_box.x&&g<=a.y+a.sel_box.y+a.sel_box.height&&h>=a.y+a.sel_box.y})},ia.prototype.updatedSelection=function(){return ad.array.mergedNew(this.initial_nodes,this.nodes).filter(ia.nodeIsNotFractionBar)},ia.nodeIsNotFractionBar=function(a){return"//"!==a.value},ia.prototype.highlight=function(){this.interaction_handler.highlight_nodes(this.updatedSelection())},ia.prototype.end=function(){return this.box_el.remove(),this.updatedSelection()},ja.prototype.check=function(a){return a.dist-a.dist0<-15},ja.prototype.start=function(a,b){return this.nodes=this.proccess_selection(b),this.node_ids=this.nodes.map(function(a){return a.id}),this.nodes},ja.prototype.update=function(a){if(this.joined)return void(a.dist>3*a.dist0/4+10&&this.unjoin());if(!(this.nodes.length<1||a.dist>3*a.dist0/4)){var b=this.nodes[0].commutative?1:0;this.unjoined_state=_c.clone(this.alm.children[0],!0),this.unjoined_state.parent=this.alm,this.joined=!0;var c=this;(function a(b){c.alm.process_operator(c.nodes[b],function(){b+1<c.nodes.length?a(b+1):c.nodes=[]})})(b)}},ja.prototype.unjoin=function(){var a=this.alm;this.joined=!1,a.children[0]=this.unjoined_state,a.changed(),this.nodes=this.node_ids.map(function(b){return _c.get_by_id(b,a.children)})},ja.prototype.end=function(){this.nodes=[],this.node_ids=[],this.unjoined_state=null,this.joined=!1},ja.prototype.proccess_selection=function(a){return 2!==a.length?a:a[0].parent.commutative&&a[1].is_group()?a[1].children.slice():a},ad.JoinHandler=ja,ka.prototype.check=function(a){return a.dist-a.dist0>15},ka.prototype.start=function(a,b){return this.prevDist=null,this.nodes=b,this.nodes||[]},ka.prototype.end=function(){this.node=null,this.splitted=!1},ka.prototype.getBestAction=function(a,b,c){var d=c;this.actions.forEach(function(c){d&&c.priority<=d.priority||c.match(b)&&(d=c.createBoundAction(a,{actor:b}))});for(var e=b.children.length-1;e>=0;e--){var f=b.children[e],g=this.getBestAction(a,f,d);g&&(d=g)}return d},ka.prototype.split=function(a,b){for(var c,d=b.length-1;d>=0;d--)c=this.getBestAction(a,b[d],c);return!!c&&(a.performAction(c),_c.nodes_to_range(c.mapNodes(c.actor)))},ka.prototype.update=function(a){if(this.nodes&&!(null!==this.prevDist&&a.dist-this.prevDist<=30)){var b=this.split(this.view.model,this.nodes);b&&(this.prevDist=a.dist,this.nodes=b,this.interaction_handler.highlight_nodes(this.nodes))}},"object"==typeof b&&b.exports&&(b.exports=ka),ad.SplitHandler=ka,_c.Node.prototype.match=function(){return Id.match(this,arguments,!1)},_c.Node.prototype.matchInner=function(){return Id.match(this,arguments,!0)},a("AlgebraModel",Id=function(a){function b(a){var c=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];id(this,b);var d=pd(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return d.type="AlgebraModel",d.id=ad.uid(),d.events=d3.dispatch("create","change","spawn","mistake","start-of-interaction","end-of-interaction","scrubbability-changed","restraint"),d.settings=new nd("AlgebraModel",c.docId),d.settings.setExisting(c),d.hide_rules=[],d.watchedAspects=[],d.parser=d.settings.get("parser")||b.getDefaultParser(),d.init_hide_rules(),d.parseAndSet(a,!0),d.setLocked(d.settings.get("locked")),d}return qd(b,a),jd(b,[{key:"toJSON",value:function(){var a=this.settings.getModified();return a.parser===b.getDefaultParser()&&delete a.parser,{id:this.id,type:"AlgebraModel",settings:a,ascii:this.to_ascii()}}},{key:"clone",value:function(a,c){var d=this.settings.getAll();d.docId=this.settings.docId;var e=new b(null,d);return e.hide_rules=this.hide_rules.slice(),_c.append(e,b.cloneNodes(this.children[0],a,c)),e}},{key:"isTheSameAs",value:function(a){return b.areTheSame(this,a)}},{key:"printLeafNodePositions",value:function(a){var b=function(a){return{x:a.x,y:a.y,x0:a.x0,y0:a.y0}};this.printForEachLeafNode(a,b)}},{key:"printForEachLeafNode",value:function(a,b){this.get_leaf_nodes().forEach(function(c){console.log((a+" "||"")+c.to_ascii()+" :",b(c))})}},{key:"init_hide_rules",value:function(){for(var a=0;a<this.parser.symbols.length;a++){var b=ad.expressions[this.parser.symbols[a]];b.hide_rule&&this.hide_rules.push(b.hide_rule)}}},{key:"parseAndSet",value:function(a,c,d){var e=this.children[0];this.children=[];var f=this.parser.parse(a);if(!f)return!1;_c.append(this,f),c||this.remove_brackets(),this.hide_nodes(),this.setLocked(this.settings.get("locked"));var g=null;try{e&&(g=e.get_mapping_to(this.children[0]))}catch(a){console.log("could not auto-map",e.to_ascii(),"to",this.to_ascii())}finally{return this.events.change(new b.ChangeEvent({model:this,node_map:g,no_anim:!0,sender:d})),!0}}},{key:"replace_with",value:function(a,c){var d,e;a instanceof b?(d=a,d.setLocked(this.settings.get("locked"))):d=new b(a,this.settings.getAll());try{e=this.children[0].get_1to1_mapping_to(d.children[0],!1)}catch(a){console.log("could not auto-map",this.to_ascii(),"to",d.to_ascii())}finally{return this.events.change(new b.ChangeEvent({model:this,new_model:d,node_map:e,no_anim:!0,sender:c})),d}}},{key:"parse",value:function(a,b){var c=this.parser.parse(a);return c?(b||this.remove_brackets([c]),c):null}},{key:"to_ascii",value:function(a){return b.to_ascii(this.children,a)}},{key:"to_latex",value:function(a){return a=a||this.children,Array.isArray(a)||(a=[a]),a.map(function(a){return a.to_latex()}).join("")}},{key:"getRanges",value:function(a,c,d){return b.getRanges(a,c,d||this.children)}},{key:"getNodes",value:function(a,c,d){return b.getNodes(a,c,d||this.children)}},{key:"getNodesStringified",value:function(a,c,d){return b.getNodesStringified(a,c,d||this.children)}},{key:"setLocked",value:function(a){this.settings.set("locked",a),this.for_each(function(b){b.locked=a}),this.events["scrubbability-changed"]({type:"scrubbability-changed"})}},{key:"created",value:function(a,b){this.events.create({type:"create",term:a&&a.newTree&&a.newTree.to_ascii(),action:a,sender_id:b||this.id})}},{key:"startInteraction",value:function(){this.events["start-of-interaction"]({type:"start-of-interaction",source:this,model:this,time:Date.now()})}},{key:"finishInteraction",value:function(a){var c={type:"end-of-interaction",source:this,time:Date.now()};if(a)return void this.events["end-of-interaction"](c);var d=this.children[0].filter(function(a){return a.simplify});if(0===d.length)return void this.events["end-of-interaction"](c);var e=ad.actions.PostInteractionSimplificationAction.createBoundAction(this,{nodes:d,auto_simplify_distributions:this.settings.get("auto_simplify_distributions"),auto_simplify_vector_additions:this.settings.get("auto_simplify_vector_additions"),auto_simplify_variables:this.settings.get("auto_simplify_variables")}),f=this;(this.settings.get("no_history")?e.doInPlace():e.run())&&(f=e.newTree,e.newTree.hide_nodes(),e.newTree===e.oldTree?this.events.change(new b.ChangeEvent({model:this,action:e})):this.created(e)),d.forEach(function(a){a.simplify=!1}),c.source=f,this.events["end-of-interaction"](c)}},{key:"root",value:function(){return this.children[0]}},{key:"is_group",value:function(){return!1}},{key:"numeric_value",value:function(a,c,d){var e,f=this.to_ascii(),g=this.stringify(),h=this.getSelectorOfNodes(a),i=a,j=a.parent;if(a instanceof D&&j&&(j.is_group("sign")||j.is_group("add")||j.is_group("sub"))&&(a=j),e=D.get_value(a),isNaN(e))return NaN;var k=b.get_parent_of_product_with_leading_num(a),l=k&&k.is_group("add")?k:null,m=k&&k.is_group("sub")?k:null;if(m&&(e=-e),arguments.length<2)return e;var n=e>0||0===e&&(a instanceof D||a.is_group("add")),o=c>0||0===c&&(a instanceof D||a.is_group("add")),p=this.children[0].get_mapping_to(this.children[0]);if(n&&!o)if(a.is_group("add"))a.invert(),this.hide_nodes();else if(l)l.invert(),this.hide_nodes();else{var q=_c.remove(a),r=new Q(a);r.children[0].no_anim=!0,_c.insert(j,q,r),r.selected=a.selected,a=r}else if(!n&&o)if(a.is_group("sign")){var s=a.children[1];p[a.children[0].id]=[s],p[a.id]=[s],_c.replace(a,s),a.children[0].no_anim=!0,s.selected=a.selected,a=s}else a.is_group("sub")?(a.invert(),this.hide_nodes()):m&&(m.invert(),this.hide_nodes());else if(this.f_eqls(e,c))return a;return a.is_group()?a.children[1].value=Math.abs(c):a.value=Math.abs(c),p[i.id]=[a],this.events.change(new b.ChangeEvent({model:this,node_map:p,no_anim:!0,old_model_ascii:f,old_model_string:g,sel:h,sender:d})),a}},{key:"f_eqls",value:function(a,b){return Math.abs(a-b)<1e-6}},{key:"remove_brackets",value:function(a){_c.for_each(function(a){a.is_group("fraction")&&a.parent.is_group("brackets")&&w.handle(a.parent,!0)},a||this.children)}},{key:"process_operator",value:function(a,b,c){return this.performAction(this.getBestMatchingBoundAction(a,c),b)}},{key:"getBestMatchingBoundAction",value:function(a,b){var c=a;if(c.fixed)return null;for(;!c.getBestMatchingAction&&c.parent&&(!c.parent.is_group("equals","lt","lte","gt","gte")||1===c.get_idx());)c=c.parent;var d=null;return!c.getBestMatchingAction||!c.parent||"AlgebraModel"===c.parent.type||c.is_group("fraction","power","radical")||c.parent.is_group("equals","lt","lte","gt","gte")&&1!==c.get_idx()||(d=c.getBestMatchingAction(b,this.settings.get("action_blacklist")))||(c=c.parent),w.areHidden(c)&&(c=c.parent,d=null),c.getBestMatchingAction?(d=d||c.getBestMatchingAction(b,this.settings.get("action_blacklist")),d?d.createBoundAction(this,{actor:c}):null):null}},{key:"performAction",value:function(a,c,d,e){var f=[a];if(ad.ui&&ad.ui.Keyboard&&a&&a.settings.asynchronous&&ad.ui.Keyboard().abort(),a&&a.settings&&a.settings.makes_no_changes)return a.doInPlace(),a.elements&&a.elements.length>0&&this.events.spawn(a),c&&c(a),a;void 0===d&&(d=this.settings.get("no_history"));var g=this,h=function(a){if(!a)return g.events.mistake(g),void(c&&c(a));if(d?(g.hide_nodes(),g.events.change(new b.ChangeEvent({model:g,action:a}))):(a.newTree.hide_nodes(),g.created(a)),a.elements&&a.elements.length>0&&g.events.spawn(a),!e&&a.settings.restraint&&g.events.restraint(a.settings.restraint),a.followup){var h=a.newTree.performAction(a.followup,c,d);f=f.concat(h)}else c&&c(a)};return a?(d?a.doInPlace(h):a.run(h),1===f.length?f[0]:p.createComposedAction(f,f[0].name,f[0].description)):(h(),null)}},{key:"hide_nodes",value:function(){return this.hideNodesAction.doInPlace(this)}},{key:"performSplitAction",value:function(a){(new ka).split(this,a||this.children)}},{key:"getMoveActions",value:function(a,b){if(0===a.length)return[];if(a.some(function(a){return a.fixed}))return[];b=b||this.move_actions;for(var c=[],d=0;d<b.length;d++){var e=b[d];try{if(e.name&&-1!==this.settings.get("action_blacklist").indexOf(e.name))continue;c=c.concat(b[d].getAllAvailableActions(a,this))}catch(b){console.warn("An error occurred when trying to match "+e.name),ad.sendErrorReport("An error occurred when trying to match "+(e&&e.name)+" on "+a.map(function(a){return a.to_ascii()}).join(";"),_c.stringify(a[0].get_root()))}}return c}},{key:"make_flat",value:function(){var a=_c.get_leaf_nodes(this),c=new Group("flat",0);c.commutative=!0,a.forEach(function(a){a.hidden||(a.commutative=!0,a.associative=!0,_c.append(c,a))}),this.children=[],_c.append(this,c),this.events.change(new b.ChangeEvent({model:this}))}},{key:"getSelectorOfNodes",value:function(a){Array.isArray(a)||(a=[a]);for(var b=[],c=0;c<a.length;c++){var d=a[c];if(d===this)b.push(this.to_ascii());else{var e=this.getNodes(d.to_ascii()),f=e.indexOf(d);-1===f?b.push(""):0===f?b.push(d.to_ascii()):b.push(d.to_ascii()+":"+f)}}return b.join(";")}},{key:"getNodesFromSelector",value:function(a){var b=this;return a.split(";").map(function(a){var c=a.split(":");return b.getNodes(c[0],+c[1]||0)}).filter(function(a){return a})}}],[{key:"fromJSON",value:function(a,c,d){a.settings.parser&&(a.settings.parser=o(a.settings.parser)),d&&(a.settings.docId=d.docId());var e=new b(a.ascii,a.settings);return e.id=a.id,e}},{key:"getDefaultParser",value:function(){return b.defaultParser||(b.defaultParser=o(["num","var","sym","brackets","sign","add-sub","mul-div","exponent","equals","inequality","param","func","abs-val","radical","degree","latex"])),b.defaultParser}},{key:"cloneNodes",value:function(a){var b=!(arguments.length<=1||void 0===arguments[1])&&arguments[1],c=arguments.length<=2||void 0===arguments[2]?null:arguments[2];return _c.clone(a,b,c||["id","value","name","bp","associative","commutative","vertical_notation","locked","fixed","hidden","simplify","deleted","precision","color","size","width","height","x","y","x0","y0","rel_x","rel_y","lmar","rmar"])}},{key:"isParsable",value:function(a){try{return!!b.getDefaultParser().parse(a)}catch(a){return!1}}},{key:"areTheSame",value:function(a,c){if(!a||!c)return!1;var d=a instanceof b?a.children[0]:b.getDefaultParser().parse(a),e=c instanceof b?c.children[0]:b.getDefaultParser().parse(c);return!(!d||!e)&&d.to_ascii()===e.to_ascii()}},{key:"is_top_most",value:function(a){return!a.parent||a.parent instanceof b}},{key:"to_ascii",value:function(a,b){return Array.isArray(a)||(a=[a]),a.map(function(a){return a.to_ascii(b)}).join("")}},{key:"select_range_by_value",value:function(a,c){return function(d){return!!d[0].parent&&((!d[0].parent.parent||!b.range_contains_all_siblings(d))&&(b.rangeToAscii(d)===a||b.rangeToAsciiNoLeadingOp(d,c)===a||1===d.length&&b.fractionToAscii(d[0])===a))}}},{key:"rangeToAscii",value:function(a){return 1===a.length&&a[0].hidden?"":a.map(function(a){return a.to_ascii()}).join("")}},{key:"isLeadingCommutativeOp",value:function(a){return a.is_group()&&a.commutative&&a.associative}},{key:"rangeToAsciiNoLeadingOp",value:function(a,c){if(0===a.length)return"";if(1===a.length&&a[0].hidden)return"";var d=a.map(function(a){return a.to_ascii()}).join("");return(1!==a.length||c)&&b.isLeadingCommutativeOp(a[0])?d.substring(a[0].children[0].to_ascii().length):d}},{key:"fractionToAscii",value:function(a){if(!a.is_group("fraction"))return"";var b=a.to_ascii();return"("===b.slice(0,1)&&")"===b.slice(b.length-1,b.length)&&(b=b.substr(1,b.length-2)),b}},{key:"range_contains_all_siblings",value:function(a){return a[0]&&a[0].parent&&!a[0].parent.is_group("exponent")&&a.length===a[0].parent.children.length}},{key:"select_node_by_value",value:function(a){return function(b){return"AlgebraModel"!==b.type&&!b.hidden&&!b.fixed&&b.to_ascii()===a}}},{key:"getRanges",value:function(a,c,d){var e=_c.filterRange(b.select_range_by_value(a),d);return"number"==typeof c?e[c]:e}},{key:"getNodes",value:function(a,c,d){var e=_c.filter(b.select_node_by_value(a,!0),d);return"number"==typeof c?e[c]:e}},{key:"select_node_by_stringified_value",value:function(a){return function(b){return!b.is_root()&&!b.hidden&&b.stringify()===a}}},{key:"getNodesStringified",value:function(a,c,d){var e=_c.filter(b.select_node_by_stringified_value(a),d);return"number"==typeof c?e[c]:e}},{key:"ChangeEvent",value:function(a){this.type="change",this.old_model_ascii=a.old_model_ascii,this.old_model_string=a.old_model_string,this.old_model=a.model,this.new_model=a.new_model||a.model,this.node_map=a.node_map||a.action&&a.action.node_map||[],this.action=a.action,this.sel=a.sel,this.no_anim=a.no_anim,this.sender=a.sender}},{key:"get_parent_of_product_with_leading_num",value:function(a){var b=a.parent;return!!(a instanceof D&&b.is_group("mul")&&!b.ls&&b.parent.is_group("product"))&&b.parent.parent}},{key:"get_numeric_value",value:function(a){var c,d=a.parent;if(a instanceof D&&d&&(d.is_group("sign")||d.is_group("add")||d.is_group("sub"))&&(a=d),c=D.get_value(a),isNaN(c))return NaN;var e=b.get_parent_of_product_with_leading_num(a);e&&e.is_group("add");return(e&&e.is_group("sub")?e:null)&&(c=-c),c}},{key:"groupNodeRanges",value:function(a){return b.groupNodes(a,function(a,b){return a[a.length-1].rs===b})}},{key:"groupNodes",value:function(a,b){if(!a.length)return[];var c=[],d=[a[0]];c.push(d);for(var e=1;e<a.length;e++)b(d,a[e])?d.push(a[e]):(d=[a[e]],c.push(d));return c}},{key:"match",value:function(a,c){for(var d=!(arguments.length<=2||void 0===arguments[2])&&arguments[2],e=b.__reg_exp_cache,f=0;f<c.length;f++){var g=c[f];e[g]||(e[g]=new ma(g));var h=d?e[g].matchSubExpressions(a):e[g].match(a);if(h)return h}return!1}},{key:"evalExpression",value:function(a,c){var d=function(a,b){return a+b},e=function(a,b){return a*b},c=c||{};a&&a instanceof b&&(a=a.children[0]);var f=function a(b){return b?D.is_num(b)?D.get_value(b):b.is_group("mul","add","brackets")?a(b.children[1]):b.is_group("sign","sub")?-a(b.children[1]):b.is_group("div")?1/a(b.children[1]):b.is_group("exponent")?a(b.children[0]):"//"===b.value?1:b.is_group("product","fraction")?b.children.map(a).reduce(e,1):b.is_group("sum")?b.children.map(a).reduce(d,0):b.is_group("power")?Math.pow(a(b.children[0]),a(b.children[1])):O.Trig.is_trig_func(b)?O.Trig.evaluate(b):b.is_group("var")&&b.get_value()in c?c[b.get_value()]:NaN:NaN};return Array.isArray(a)?_c.is_range(a)?a[0].get_parent(1).is_group("product","fraction")?a.map(f).reduce(e,1):a[0].get_parent(1).is_group("sum")?a.map(f).reduce(d,0):NaN:NaN:f(a)}}]),b}(_c.Node)),Id.__reg_exp_cache={},Id.prototype.move_actions=[],new md("AlgebraModel").defaults.setAll({hide_mult_op:!0,hide_leading_op:!0,parser:null,no_history:!1,auto_simplify_distributions:!0,auto_simplify_vector_additions:!0,auto_simplify_variables:!0,locked:!1,action_blacklist:[]}),Jd=function(){function a(){var b=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],c=arguments.length<=1||void 0===arguments[1]?null:arguments[1],d=arguments.length<=2||void 0===arguments[2]?null:arguments[2];id(this,a),this._map=b,this.source_model=c,this.target_model=d}return jd(a,[{key:"clone",value:function(){var b={};for(var c in this._map)b[c]=this._map[c].slice();return new a(b,this.source_model,this.target_model)}},{key:"update",value:function(a,b){var c=this;if(1===arguments.length){var d=a;for(var e in d)this._map[e]=d[e]}else{var f=a;b=Array.isArray(b)?b:[b],Array.isArray(f)?f.forEach(function(a){return c._map[a.id]=b}):this._map[f.id]=b}}},{key:"extend",value:function(a,b){var c=this;if(1===arguments.length){var d=a;for(var e in d)e in this._map?la(this._map[e],d[e]):this._map[e]=d[e]}else{var f=Array.isArray(a)?a:[a];b=Array.isArray(b)?b:[b],f.forEach(function(a){a.id in c._map?la(c._map[a.id],b):c._map[a.id]=b})}}},{key:"reset",value:function(){this._map={}}},{key:"map",value:function(a){var b=this;if(!Array.isArray(a))return this._map[a.id];var c=function(){var c=[];return a.forEach(function(a){var d=b._map[a.id];d&&la(c,d)}),{v:c}}();return"object"==typeof c?c.v:void 0}},{key:"unmap",value:function(a){var b=[],c=Array.isArray(a)?a:[a];for(var d in this._map)hd.containsAll(this._map[d],c)&&b.push(this.source_model.get_by_id(d));return b}},{key:"compose",value:function(b){var c=!(arguments.length<=1||void 0===arguments[1])&&arguments[1],d=b instanceof a?b:new a(b);for(var e in this._map){var f=this._map[e];this._map[e]=d.map(f);var g=f.filter(function(a){return!d._map[a.id]});if(g.length>0&&c)throw"Second mapping does not cover all target nodes from first mapping.";this._map[e]=this._map[e].concat(g)}return d.target_model&&(this.target_model=b.target_model),this}},{key:"removeDeletedTargetNodes",value:function(){var a=this.target_model.select_all();for(var b in this._map)this._map[b]=this._map[b].filter(function(b){return-1!==a.indexOf(b)})}},{key:"getInverse",value:function(){var b=this,c={},d=this.target_model.children[0].select_all(),e=Object.keys(this._map);return d.forEach(function(a){c[a.id]=e.filter(function(c){return b._map[c].find(function(b){return b===a})}).map(function(a){return b.source_model.get_by_id(a)})}),new a(c,this.target_model,this.source_model)}},{key:"print",value:function(){var a=arguments.length<=0||void 0===arguments[0]?"Node Map":arguments[0];a&&console.log(a);for(var b in this._map){var c=b;this.source_model&&(c=this.source_model.get_by_id(b),c=c?c.to_ascii():"?"),console.log(c,"==>",this._map[b].map(function(a){return a.to_ascii()}).join(", "))}}}]),a}(),ad.AlgebraRegExp=ma,ma.getRegExpParser=function(){if(!ma.regexpParser){var a=o(Id.getDefaultParser().symbols);a.registerSymbol(":",1).led=function(b){var c=a.parseExpression(0),d="?"===b.value[0];return c.match_name=d?b.value.slice(1):b.value,c.match_optional=d,c},["NUM","VAR","ANY"].forEach(function(b){a.registerSymbol("\\"+b).nud=function(){return new ad.expressions.placeholder(b.toLowerCase())}}),ma.regexpParser=a}return ma.regexpParser},ma.prototype.getVariations=function(a,b){b=b||0;var c=a.select_first(function(a){return a.match_optional});if(!c)return[a];c.match_optional=!1;var d=a.clone(!1,["id","value","name","bp","associative","commutative","vertical_notation","match_name","match_optional"]),e=this.getVariations(d,b+1),f=new p;if(f.newTree=a,c.parent.commutative&&(c=c.parent),c.commutative){var g=c.parent;c.remove(),f.cleanup_cascade(g),e=e.concat(this.getVariations(a,b+1))}else if(0===b)throw"only nodes in commutative groups can be optional";return e},ma.prototype.combineWith=function(a){this.simple_models=this.simple_models.concat(a.simple_models)},ma.prototype.match_node=function(a,b){return!(!a.is_group("sym")||!b.is_group("sym")||""!==b.value||"-"!==a.value&&"+"!==a.value)||(!(!a.is_group("add","sub")||!b.is_group("addsub"))||(!(!a.is_group("sign")||!b.is_group("plusminus"))||a.name===b.name&&a.value===b.value&&a.children.length===b.children.length))},ma.prototype.checkAndSetMatch=function(a,b,c,d){var e=b.match_name;if(e)if(a[e]){if(a[e].to_ascii()!==c.to_ascii())return!1;Array.isArray(a[e])?a[e].push(c):a[e]=[a[e],c]}else a[e]=c;return this.node_map.update(d?c.select_all():c,b),!0},ma.prototype.match_tree=function(a,b,c){if(b.is_group("plusminus")&&!a.is_group("sign","plusminus")){if(!this.checkAndSetMatch(c,b,a,!1))return!1;b=b.children[1]}if(b.is_group("brackets")&&b.children[1].is_group("plusminus")&&!a.is_group("brackets")){if(!this.checkAndSetMatch(c,b,a,!1))return!1;b=b.children[1].children[1]}if(b.is_group("placeholder")){var d=b.match(a);return!!d&&!!this.checkAndSetMatch(c,b,a,!0)}if(!this.checkAndSetMatch(c,b,a,!1))return!1;if(!this.match_node(a,b))return!1;for(var e=0;e<a.children.length;e++){var d=this.match_tree(a.children[e],b.children[e],c);if(!d)return!1}return!0},ma.prototype.matchSubExpressions=function(a){var b=this,c=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],d="AlgebraModel"===a.type?a.children[0]:a;this.node_map.source_model=d.parent;for(var e=(!("match_inner"in c)||c.match_inner),f=[],g=function(){for(var a=b.simple_models[h].children[0],g=a.is_group("sum","product"),i=d.filterRange(function(b){return 1===b.length||e&&g&&b.length===a.children.length&&b.length<b[0].parent.children.length}),j=function(e){var g={},h=i[e];b.node_map=new Jd({},d.parent||d,a.parent);if((1===h.length?b.match_tree(h[0],a,g):h.every(function(c,d){return b.match_tree(c,a.children[d],g)}))&&(f.push({matches:g,nodes:h,node_map:b.node_map}),c.only_first))return{v:{v:f}}},k=0;k<i.length;k++){var l=j(k);if("object"==typeof l)return l.v}if(f.length>0)return{v:f}},h=0;h<this.simple_models.length;h++){var i=g();if("object"==typeof i)return i.v}return[]},ma.prototype.match=function(a){var b=this,c="AlgebraModel"===a.type?a.children:Array.isArray(a)?a:[a];this.node_map.source_model=c[0].get_root();for(var d=function(){var a={},d=b.simple_models[e].children[0];if(b.node_map.target_model=b.simple_models[e],b.node_map.reset(),1===c.length){if(b.match_tree(c[0],d,a))return{v:a}}else if(c.length===d.children.length&&c.every(function(c,e){return b.match_tree(c,d.children[e],a)}))return{v:a}},e=0;e<this.simple_models.length;e++){var f=d();if("object"==typeof f)return f.v}return!1},ad.rules=ad.rules||{},ad.rules.identity_element=function(a,b,c){a.prototype.identity_element=b;var d=b.to_ascii()+" is the identity element of "+a.prototype.value,e=b.to_ascii(),f=function(a){p.call(this,c,d),this.triggerType="tap",this.priority=0,this.settings={delay:250,margin:{x:.1},side:"inside"},a&&("drag"===a.triggerType?(this.triggerType=a.triggerType,this.nodes=a.nodes,this.target=a.target):this.actor=a.actor)};ad.inherit(p,f),f.prototype.isIdentityElement=function(b){return b instanceof a&&b.children[1].to_ascii()==e},f.prototype.match=function(a,b){return arguments.length<2&&(b=a.ls||a.rs),"//"===b.value&&(b=b.ls),(!a.get_parent(1).is_group("fraction")||!(this.isIdentityElement(a)&&a.is_group("mul")&&b.is_group("div")||this.isIdentityElement(b)&&b.is_group("mul")&&a.is_group("div")))&&(this.isIdentityElement(a)||this.isIdentityElement(b))},f.prototype.getSiblings=function(b){return b.parent.children.filter(function(c){return c!==b&&c instanceof a})},f.prototype.getAllAvailableActions=function(b){var c=[];if(1!==b.length)return c;var d=b[0];if(!(d instanceof a))return c;for(var e=this.getSiblings(d),f=d.get_root(),g=0;g<e.length;g++)this.match(d,e[g])&&c.push(this.createBoundAction(f,{nodes:b,target:e[g],triggerType:"drag"}));return c},f.prototype.transform=function(a){var b=this.nodes&&this.nodes[0]||this.actor,c=this.target||this.actor&&(this.actor.ls||this.actor.rs);this.addTouchedNodes(b),this.addTouchedNodes(c);var d,e;this.isIdentityElement(b)?(d=b,e=c):(d=c,e=b),e=this.getNewTreeNode(e),this.setNodesToReselectAfterAction(e),d=this.getNewTreeNode(d),d.remove();e.parent.get_path(),this.cleanup_cascade(e.parent);if("function"!=typeof a)return!0;a(this)};var g=new f;ad.actions[c]=g,a.prototype.add_action_handler(g),Id.prototype.move_actions.push(ad.actions[c])},ad.rules=ad.rules||{},ad.rules.zero_element=function(a,b,c){a.prototype.zero_element=b;var d=b.to_ascii(),e=d+" is the zero element of "+a.prototype.value,f=function(a){p.call(this,c,e),this.triggerType="tap",this.priority=5,this.settings={delay:250,margin:{x:.1},side:"inside"},a&&("drag"===a.triggerType?(this.triggerType=a.triggerType,this.nodes=a.nodes,this.target=a.target,this.priority=1):this.actor=a.actor)};ad.inherit(p,f),f.prototype.isZeroElement=function(b){return b instanceof a&&b.children[1].to_ascii()==d},f.prototype.match=function(a,b){return arguments.length<2&&(b=a.ls),("mul"===a.value||a.value===b.value)&&(this.isZeroElement(a)||this.isZeroElement(b))},f.prototype.getSiblings=function(b){return b.parent.children.filter(function(c){return c!==b&&c instanceof a})},f.prototype.getAllAvailableActions=function(b){var c=[];if(1!==b.length)return c;var d=b[0];if(!(d instanceof a))return c;for(var e=this.getSiblings(d),f=d.get_root(),g=0;g<e.length;g++)this.match(d,e[g])&&c.push(this.createBoundAction(f,{nodes:b,target:e[g],triggerType:"drag"}));return c},f.prototype.transform=function(a){var b=this.nodes&&this.nodes[0]||this.actor,c=this.target||this.actor&&(this.actor.ls||this.actor.rs);this.addTouchedNodes(b),this.addTouchedNodes(c);var d,e;this.isZeroElement(b)?(d=b,e=c):(d=c,e=b);var f=d.get_parent(1);if(d=this.getNewTreeNode(d),"tap"===this.triggerType){f.get_top().concat(f.get_bottom()).map(this.getNewTreeNode.bind(this)).forEach(function(a){a!==d&&a.remove()})}else this.getNewTreeNode(e).remove();if((this.actor&&!this.isZeroElement(this.actor)||this.nodes&&!this.isZeroElement(this.nodes[0]))&&this.setNodesToReselectAfterAction(d.children[1]),this.cleanup_cascade(d.parent),"function"!=typeof a)return!0;a(this)};var g=new f;ad.actions[c]=g,a.prototype.add_action_handler(g),Id.prototype.move_actions.push(ad.actions[c])},ad.rules=ad.rules||{},ad.rules.init_all=function(){ad.rules.identity_element(u,new D(0),"AddSubIdAction"),ad.rules.identity_element(K,new D(1),"MulDivIdAction"),ad.rules.zero_element(K,new D(0),"MulDivZeroAction"),ad.rules.identity_element(y,new v("T"),"TrueIdAction"),ad.rules.zero_element(y,new v("F"),"FalseZeroAction"),ad.rules.identity_element(A,new v("F"),"FalseIdAction"),ad.rules.zero_element(A,new v("T"),"TrueZeroAction")},ad.rules.init_all(),ad.actions.CloneAction=function(){var a=function(){p.call(this,"CloneAction","clone"),this.triggerType="drag"};return ad.inherit(p,a),a.prototype.rematch=function(){return!0},a.prototype.transform=function(a){if("function"!=typeof a)return!0;a(this)},new a}(),ad.actions.AbsValAction=function(){var a=function(a){p.call(this,"AbsValAction","evaluate absolute value"),this.priority=4,this.triggerType="tap",a&&(this.actor=a.actor)};ad.inherit(p,a),a.prototype.match=function(a){return!!a.match("|\\NUM|")||!(!a.is_group("abs-val")||!this.prodFracContainingNumbers(a.get_child([1])))},a.prototype.prodFracContainingNumbers=function(a){return!!a.is_group("product","fraction")&&a.get_top().concat(a.get_bottom()).every(function(a){return D.is_num(a.get_child([1]))})},a.prototype.transform=function(a){var b=this.getNewTreeNode(this.actor);this.addTouchedNodes(this.actor);var c=b.match("|{n:\\NUM}|");if(c){var d=c.n;_c.replace(b,d),this.cleanup(d.parent)}else{var e=b.get_child([1]);_c.replace(b,e),e.get_top().concat(e.get_bottom()).forEach(function(a){var b=a.get_child([1]);b.is_group("sign")&&_c.replace(b,b.get_child([1]))}),this.cleanup(e.parent)}if("function"!=typeof a)return!0;a(this)};var b=new a;return B.prototype.add_action_handler(b),b}(),ad.actions.AbsValDoubleAction=function(){var a=function(a){p.call(this,"AbsValDoubleAction","nested absolute values"),this.priority=4,this.triggerType="tap",a&&(this.actor=a.actor)};ad.inherit(p,a),a.prototype.match=function(a){return a&&a.match("||\\ANY||")},a.prototype.transform=function(a){this.addTouchedNodes(this.actor);var b=this.getNewTreeNode(this.actor),c=b.match("|{n:|\\ANY|}|").n;return _c.replace(b,c),"function"==typeof a&&a(this),!0};var b=new a;return B.prototype.add_action_handler(b),b}(),ad.actions.AbsValNegVarAction=function(){var a=function(a){p.call(this,"AbsValNegVarAction","absolute value of a negative variable"),this.priority=4,this.triggerType="tap",a&&(this.actor=a.actor)};ad.inherit(p,a),a.prototype.match=function(a){return!!a.match("|-\\VAR|")||!(!a.is_group("abs-val")||!this.prodFracContainingNegativeTerms(a.get_child([1])))},a.prototype.prodFracContainingNegativeTerms=function(a){return!!a.is_group("product","fraction")&&a.get_top().concat(a.get_bottom()).some(function(a){return a.get_child([1]).is_group("sign")})},a.prototype.transform=function(a){this.addTouchedNodes(this.actor);var b=this.getNewTreeNode(this.actor),c=b.match("|{neg:-{var:\\VAR}}|");if(c)_c.replace(c.neg,c.var);else{var d=b.get_child([1]);d.get_top().concat(d.get_bottom()).forEach(function(a){var b=a.get_child([1]);b.is_group("sign")&&_c.replace(b,b.get_child([1]))})}if("function"!=typeof a)return!0;a(this)};var b=new a;return B.prototype.add_action_handler(b),b}(),ad.actions.AbsValExtractNumAction=function(){var a=function(a){p.call(this,"AbsValExtractNumAction","pull a number out of an absolute value"),this.priority=4,this.triggerType="drag",this.settings={margin:{}},a&&(this.nodes=a.nodes,this.target=a.target,this.settings.side=a.side,this.settings.margin["right-of"===a.side?"x2":"x1"]=-1)};return ad.inherit(p,a),a.prototype.getAllAvailableActions=function(a){if(!_c.is_range(a))return[];if(!a[0].is_group("mul"))return[];if(!a[0].get_parent(2).is_group("abs-val"))return[];if(!a.every(function(a){return D.is_num(a.get_child([1]))}))return[];var b=a[0].get_root(),c=a[0].get_parent(2);return[this.createBoundAction(b,{nodes:a,target:c,side:"left-of"}),this.createBoundAction(b,{nodes:a,target:c,side:"right-of"})]},a.prototype.transform=function(a){this.addTouchedNodes(this.nodes),this.addTouchedNodes(this.target);var b=this.getNewTreeNode(this.target),c=this.getNewTreeNode(this.nodes),d=c[0].get_parent(1),e=b.get_parent(1),f=b.remove(),g=new I;if(c.forEach(function(a){var b=a.get_child([1]);b.is_group("sign")&&b.replace_with(b.get_child([1]))}),_c.remove_range(c),g.append(new K(b)),"left-of"===this.settings.side?g.insert_range(0,c):g.append_range(c),e.insert(f,g),this.cleanup(d),this.cleanup_cascade(g.get_parent(1)),"function"!=typeof a)return!0;a(this)},new a}(),Id.prototype.move_actions.push(ad.actions.AbsValExtractNumAction),ad.actions.AbsValInsertPosNumAction=function(){var a=function(a){p.call(this,"AbsValInsertPosNumAction","move a range of positive numbers inside an absolute value group"),this.priority=4,this.triggerType="drag",this.settings={margin:{x:-.25}},a&&(this.nodes=a.nodes,this.target=a.target,this.settings.side=a.side)};return ad.inherit(p,a),a.prototype.getAllAvailableActions=function(a){if(!_c.is_range(a))return[];if(!a[0].is_group("mul","div"))return[];if(!a.every(this.isPosNum))return[];var b=this.getOtherAbsValMulDivsInGroup(a[0]);return this.bindActionsForEachTarget(a,b)},a.prototype.isPosNum=function(a){var b=a.children[1];return b&&D.is_num(b)&&D.get_value(b)>=0},a.prototype.isAbsVal=function(a){return a.get_child([1]).is_group("abs-val")},a.prototype.getOtherAbsValMulDivsInGroup=function(a){var b=a.get_parent(1);return b.get_top().concat(b.get_bottom()).filter(function(b){return b.value===a.value&&this.isAbsVal(b)},this)},a.prototype.bindActionsForEachTarget=function(a,b){var c=[];a[0].get_root();return b.forEach(function(b){var d=b.get_child([1,1]);d=d.is_group("product")?d.children.slice():[d],c=c.concat(this.bindActionForEachTarget(a,d,!0))},this),c},a.prototype.transform=function(a){this.addTouchedNodes(this.nodes),this.addTouchedNodes(this.target);var b=this.getNewTreeNode(this.nodes),c=this.getNewTreeNode(this.target),d=b[0].get_parent(1);if(_c.remove_range(b),b[0].is_group("div")&&b.forEach(function(a){a.invert()}),c.is_group("mul")){c.get_parent(1).insert_range(c.get_idx()+("left-of"===this.settings.side?0:1),b)}else{var e=c.get_parent(1),f=c.remove(),g=new I;g.append(new K(c)),g.insert_range("left-of"===this.settings.side?0:1,b),e.insert(f,g)}if(this.cleanup_cascade(d),"function"!=typeof a)return!0;a(this)},new a}(),Id.prototype.move_actions.push(ad.actions.AbsValInsertPosNumAction),ad.actions.AbsValExtractVarAction=function(){var a=function(a){p.call(this,"AbsValExtractVarAction","pull a variable out of an absolute value"),this.priority=4,this.triggerType="drag",this.settings={margin:{}},a&&(this.nodes=a.nodes,this.target=a.target,this.settings.side=a.side,this.settings.margin["right-of"===a.side?"x2":"x1"]=-1)};return ad.inherit(p,a),a.prototype.getAllAvailableActions=function(a){if(!_c.is_range(a))return[];if(!a[0].is_group("mul"))return[];if(!a[0].get_parent(1).is_group("product"))return[];if(!a[0].get_parent(2).is_group("abs-val"))return[];if(!a.some(function(a){return!D.is_num(a.get_child([1]))}))return[];var b=a[0].get_root(),c=a[0].get_parent(2);return[this.createBoundAction(b,{nodes:a,target:c,side:"left-of"}),this.createBoundAction(b,{nodes:a,target:c,side:"right-of"})]},a.prototype.transform=function(a){this.addTouchedNodes(this.nodes),this.addTouchedNodes(this.target);var b=this.getNewTreeNode(this.target),c=this.getNewTreeNode(this.nodes),d=c[0].get_parent(1),e=b.get_parent(1),f=b.remove(),g=new I,h=new B(new I),i=h.get_child([1]),j=new K(h);if(g.append(new K(b)),"left-of"===this.settings.side?g.insert(0,j):g.append(j),_c.remove_range(c),i.append_range(c),e.insert(f,g),this.cleanup(d),this.cleanup(i),this.cleanup_cascade(g.get_parent(1)),this.setNodesToReselectAfterAction(j),"function"!=typeof a)return!0;a(this)},new a}(),Id.prototype.move_actions.push(ad.actions.AbsValExtractVarAction),ad.actions.AbsValFracSplitAction=function(){var a=function(a){p.call(this,"AbsValFracSplitAction","isolating the absolute value to the numerator and denominator"),this.priority=4,this.triggerType="drag",this.settings={},a&&(this.nodes=a.nodes,this.target=a.target,this.settings.side=a.side)};return ad.inherit(p,a),a.prototype.getAllAvailableActions=function(a){if(!_c.is_range(a))return[];var b=a[0].get_parent(1);if(!b.is_group("fraction"))return[];if(a[0].is_group("mul")&&a.length!==b.get_top().length)return[];if(a[0].is_group("div")&&a.length!==b.get_bottom().length)return[];var c=b.get_parent(1);if(!c.is_group("abs-val"))return[];var d=a[0].get_root(),e=a[0].is_group("mul")?"above":"below";return[this.createBoundAction(d,{nodes:a,target:c,side:e})]},a.prototype.transform=function(a){this.addTouchedNodes(this.nodes),this.addTouchedNodes(this.target);var b=this.getNewTreeNode(this.target),c=b.get_child([1]),d=b.get_parent(1),e=b.remove();c.remove();var f=c.get_top();_c.remove_range(f);var g=new I;g.append_range(f);var h=new B(g),i=c.get_bottom();_c.remove_range(i);var j=new I;i.forEach(function(a){a.invert()}),j.append_range(i);var k=new B(j);if(c.append(new K(h)),c.append(new K(k,"div")),d.insert(e,c),this.cleanup(g),this.cleanup(j),this.cleanup_cascade(d),"function"!=typeof a)return!0;a(this)},new a}(),Id.prototype.move_actions.push(ad.actions.AbsValFracSplitAction),ad.actions.AbsValFracJoinAction=function(){var a=function(a){p.call(this,"AbsValFracJoinAction","combining an absolute value numerator and an absolute value denominator into an absolute valued fraction"),this.priority=4,this.triggerType="tap",this.settings={},a&&(this.actor=a.actor)};ad.inherit(p,a),a.prototype.match=function(a){return!!a.is_group("fraction")&&(!(1!==a.get_top().length||!a.get_child([0,1]).is_group("abs-val"))&&!(1!==a.get_bottom().length||!a.get_child([2,1]).is_group("abs-val")))},a.prototype.transform=function(a){this.addTouchedNodes(this.actor);var b=this.getNewTreeNode(this.actor),c=b.get_child([0]),d=c.get_child([1,1]),e=b.get_child([2]),f=e.get_child([1,1]);d.remove(),f.remove(),c.get_child([1]).remove(),e.get_child([1]).remove(),c.append(d),e.append(f);var g=b.get_parent(1),h=b.remove(),i=new B(b);if(g.insert(h,i),this.cleanup(c),this.cleanup(e),this.cleanup_cascade(b),"function"!=typeof a)return!0;a(this)};var b=new a;return I.prototype.add_action_handler(b),b}(),ad.actions.AbsValVarPowerAction=function(){var a=function(a){p.call(this,"AbsValVarPowerAction","real even powers are positive"),this.priority=4,this.triggerType="tap",this.settings={restraint:"The power base must be real."},a&&(this.actor=a.actor)};ad.inherit(p,a),a.prototype.match=function(a){return a.is_group("abs-val")&&a.get_child([1]).is_group("power")&&M.is_var(a.get_child([1,0]))&&this.exponentIsAnEvenNumber(a.get_child([1,1,0]))},a.prototype.exponentIsAnEvenNumber=function(a){return D.is_num(a)&&D.get_value(a)%2==0},a.prototype.transform=function(a){this.addTouchedNodes(this.actor);var b=this.getNewTreeNode(this.actor),c=b.get_child([1]);if(_c.replace(b,c),"function"!=typeof a)return!0;a(this)};var b=new a;return B.prototype.add_action_handler(b),b}(),ad.actions.AbsValReselectGroupAction=function(){var a=function(a){p.call(this,"AbsValReselectGroupAction","drag the left absolute value bar to reselect the whole group"),this.priority=2,this.triggerType="drag",this.settings={makes_no_changes:!0,no_delay:!0,update_node_positions:!0,side:"outside",margin:{y1:.4,y2:.4}},a&&(this.nodes=a.nodes,this.target=a.target)};return ad.inherit(p,a),a.prototype.getAllAvailableActions=function(a){if(1!==a.length)return[];var b=a[0];if(!b.is_group("sym")||"|"!==b.value)return[];var c=b.get_root();return[this.createBoundAction(c,{nodes:[b],target:b})]},a.prototype.transform=function(a){return this.addTouchedNodes(this.target.parent),this.setNodesToReselectAfterAction(this.target.parent),"function"==typeof a&&a(this),this},new a}(),Id.prototype.move_actions.push(ad.actions.AbsValReselectGroupAction),ad.actions.AbsValCreateNegativeAction=function(){var a=function(a){p.call(this,"AbsValCreateNegativeAction","drag the absolute value bar to the left to produce a negative sign"),this.priority=1,this.triggerType="drag",this.settings={delay:1e3,side:"left-of"},a&&(this.nodes=a.nodes,this.target=a.target)};return ad.inherit(p,a),a.prototype.getAllAvailableActions=function(a){return 1!==a.length?[]:a[0]instanceof s&&"|"===a[0].to_ascii()?this.absValTermIsNegative(a[0].get_parent(1).get_child([1]))?[]:this.bindActionForEachTarget(a,a):[]},a.prototype.absValTermIsNegative=function(a){return!!(D.is_num(a)&&D.get_value(a)<0)||(!!a.is_group("sign")||!(!a.is_group("product")||!a.get_child([0,1]).is_group("sign")))},a.prototype.transform=function(a){this.addTouchedNodes(this.target.parent);var b=this.getNewTreeNode(this.target.parent),c=b.get_child([1]);if(c.is_group("product")){var d=c.get_child([0]),e=d.get_child([1]),f=e.remove();d.insert(f,new Q(e))}else c.remove(),b.insert(1,new Q(c));return this.setNodesToReselectAfterAction(b),"function"==typeof a&&a(this),this},new a}(),Id.prototype.move_actions.push(ad.actions.AbsValCreateNegativeAction),Kd=function a(b,c,d){null===b&&(b=Function.prototype);var e=Object.getOwnPropertyDescriptor(b,c);if(void 0===e){var f=Object.getPrototypeOf(b);return null===f?void 0:a(f,c,d)}if("value"in e)return e.value;var g=e.get;if(void 0!==g)return g.call(d)},Ld=function(a){function b(a){id(this,b);var c=pd(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,"ApplyFormulaAction","apply formula"));return c.initSettings(a),a&&a.mapping&&(c.settings.mapping=a.mapping),c}return qd(b,a),jd(b,[{key:"toJSON",value:function(){var a=Kd(b.prototype.__proto__||Object.getPrototypeOf(b.prototype),"toJSON",this).call(this);return a.type="ApplyFormulaAction",a.nodes=this.nodes.map(function(a){return a.to_ascii()}).join(";"),a}},{key:"getAllAvailableActions",value:function(a,b){var c=this;if(2!==a.length)return[];if(a[0].parent||a[1].parent||b.parent)return[];var d=b.clone(),e=new Jd(d.get_1to1_mapping_to(b)),f=this.normalize(d),g=this.normalize(a[0].clone()),h=new ma;return h.simple_models.push(this.turnIntoMatcherModel(g)),h.matchSubExpressions(f).map(function(d){return c.createBoundAction(b,{nodes:a,target:e.map(d.nodes)})})}},{key:"rematch",value:function(){var a=this;return!!(this.target&&this.target.length>0)&&this.getAllAvailableActions(this.nodes,this.target[0].get_root()).some(function(b){return ad.array.equals(b.target,a.target)})}},{key:"rebind",value:function(a,b,c){if(this.oldTree!==c)throw"wrong old tree during rebinding an action!";var d=new Jd(b);this.oldTree=a,this.target=this.target.map(function(a){return d.map(a)[0]})}},{key:"turnIntoMatcherModel",value:function(a,b){return a.for_each(function(a){if(a instanceof M){var c=new ad.expressions.placeholder("any");c.match_name=a.value,a.replace_with(c),b&&b._map[a.id]&&(b._map[c.id]=b._map[a.id],delete b._map[a.id])}}),a}},{key:"autogenerateSelectorMappings",value:function(a,b){var c=[],d=[];a.filter(function(a){return a.is_group("var")}).forEach(function(b){return c.push(a.getSelectorOfNodes([b]))}),b.filter(function(a){return a.is_group("var")}).forEach(function(a){return d.push(b.getSelectorOfNodes([a]))});var e={};return c.forEach(function(a){e[a]=d.filter(function(b){return b.split(":")[0]===a.split(":")[0]}).join(";")}),e}},{key:"setupFormulaNodeMap",value:function(a,b){var c=this.settings.mapping||this.autogenerateSelectorMappings(a,b),d={};for(var e in c){d[a.getNodesFromSelector(e)[0].id]=b.getNodesFromSelector(c[e])}return new Jd(d,a,b)}},{key:"normalize",value:function(a,b){return a.for_each(function(a){if(a.is_group("sub")){var b=a.children[1];b.is_group("product")&&(b=b.get_child([0,1]));var c=b.parent;b.remove();var d=new Q(b);d.normalized=!0,c.append(d),a.invert()}}),a}},{key:"replaceMatches",value:function(a,b,c,d){var e=b.clone().compose(c);return Object.keys(d).map(function(d){a.getNodes(d).forEach(function(a){var d=c.unmap(a);if(0!==d.length){var f=b.unmap(d[0])[0].clone();a.replace_with(f),w.handle(f),d.forEach(function(a){var c=b.unmap(a)[0];e.extend(c.get_1to1_mapping_to(f))})}})}),e.removeDeletedTargetNodes(),e}},{key:"transform",value:function(a){var b=this,c=this.target.map(function(a){return b.getNewTreeNode(a)}),d=new Jd(this.node_map,this.oldTree,this.newTree);c.forEach(function(a){return b.normalize(a)});var e=this.normalize(this.nodes[0].clone()),f=this.nodes[1].clone(),g=this.setupFormulaNodeMap(e,f);this.turnIntoMatcherModel(e,g);var h=new ma;h.simple_models.push(e);var i=h.match(c);if(!i)throw"Didn't match!";var j=h.node_map,k=this.replaceMatches(f,j,g,i),l=c[0].parent,m=Math.min.apply(null,c.map(function(a){return a.get_idx()}));c.forEach(function(a){return a.remove()});var n=f.children[0];return c.length>1&&(n=new c[0].constructor(n),n.is_group("mul")&&c[0].is_group("div")&&n.invert()),l.insert(m,n),d.compose(k),this.updateNodeMap(d._map),l.parent&&"removed"===w.handle(l,!0)&&(l=n.parent||n),this.cleanup(l)||w.handle(n),na(l),"function"==typeof a&&a(this),!0}}],[{key:"fromJSON",value:function(a){for(var b=arguments.length,c=Array(b>1?b-1:0),d=1;d<b;d++)c[d-1]=arguments[d];var e=p.fromJSON.apply(p,[a].concat(c));return e.nodes=a.nodes.split(";").map(function(a){return new Id(a)}),e}}]),b}(p),ad.actions.ApplyFormulaAction=new Ld,ad.actions.PostInteractionSimplificationAction=function(){var a=function(a){p.call(this,"PostInteractionSimplificationAction","simplify terms after interaction"),this.priority=0,this.triggerType="auto",this.settings={simplify_products:!0,simplify_variables:!0,simplify_sums:!0},a&&(this.nodes=a.nodes,"auto_simplify_distributions"in a&&(this.settings.simplify_products=a.auto_simplify_distributions),"auto_simplify_variables"in a&&(this.settings.simplify_variables=a.auto_simplify_variables),"auto_simplify_vector_additions"in a&&(this.settings.simplify_sums=a.auto_simplify_vector_additions))};return ad.inherit(p,a),a.prototype.match=function(a){return!0},a.prototype.rematch=function(){return!0},a.prototype.transform=function(a){this.changed=!1;for(var b=this.getNewTreeNode(this.nodes),c=0;c<b.length;c++){var d=this.mapNodes(this.nodes[c])[0];if(d){var e=d.parent;if(d.is_group("brackets"))w.handle(d,!0)&&(this.changed=!0),this.cleanup_cascade(e)&&(this.changed=!0);else if(this.prodFracContainingAMulZero(d)&&this.settings.simplify_variables){var f=ad.find(d.get_top(),function(a){var b=a.get_child([1]);return D.is_num(b)&&0===D.get_value(b)});if(d.get_top().filter(function(a){return a!==f}).concat(d.get_bottom().filter(function(a){return 0!==D.get_value(a.get_child([1]))})).forEach(function(a){a.remove()}),this.cleanup(d),e.is_group("add","sub")){var g=e.parent;e.remove(),this.cleanup(g)}this.changed=!0}else if(d.is_group("product")&&this.settings.simplify_products||d.is_group("sum")&&this.settings.simplify_sums){var h=this.getNumberOperatorsFromGroup(d);if(h.length>1){var i=d.is_group("product")?ad.actions.MultiplyNumbersAction:ad.actions.AddSubNumbersAction;this.applyOperators(h,i),d.is_group("product")&&this.applyNegatives(e),this.changed=!0}}else if(this.muldiv1(d)||this.addsub0(d)){d.is_group("num")&&(d=e,e=d.parent);var j=e.parent;this.updateNodeMap(this.nodes[c].select_all(),d.ls||d.rs),d.remove(),this.cleanup(e),this.cleanup(j),Id.is_top_most(j)||w.handle(j,!0),this.changed=!0}else if(this.muldivNeg1(d)){var j=e.parent,k=d.children[1];k.remove();var l=k.children[1];this.updateNodeMap(this.nodes[c],d.ls||d.rs),this.updateNodeMap(this.nodes[c].children[1].children[1].get_mapping_to(d.ls||d.rs));var m=d.ls||d.rs;l.remove();var n=m.children[1];n.is_group("sign")?(n.remove(),n=n.children[1],n.remove(),m.append(n)):(n.remove(),k.append(n),m.append(k)),d.remove(),this.cleanup(e),this.cleanup(j),Id.is_top_most(j)||w.handle(j,!0),this.changed=!0}else if(this.exp1(d)){var o=d.parent,p=o.children[0],e=o.parent,q=o.remove();p.remove(),e.insert(q,p),this.changed=!0}this.changed&&this.removeDeletedNodesFromNodeMap()}}return"function"==typeof a&&a(this),this.changed},a.prototype.getNumberOperatorsFromGroup=function(a){for(var b=[],c=0;c<a.children.length;c++){var d=a.children[c];D.is_num(d.children[1])&&b.push(d)}return b},a.prototype.applyOperators=function(a,b){for(var c=a[0],d=a.slice(1),e=0;e<d.length;e++)c=this.runAction(b,c,d[e])},a.prototype.runAction=function(a,b,c){var d=a.createBoundAction(this.newTree,{target:b,nodes:[c],triggerType:"drag"});return d.doInPlace(),this.compose(d,!1),d.mapNodes([b])[0]},a.prototype.applyNegatives=function(a){var b=ad.actions.AddSubCombineSigns;b.match(a)&&this.compose(b.createAndDoInPlace(this.newTree,{actor:a}),!1)},a.prototype.muldiv1=function(a){var b=a.is_group("num")&&a.parent?a.parent:a;return D.is_equal_to(b.children[1],1)&&(b.is_group("div")||b.is_group("mul")&&!(b.parent.is_group("fraction")&&1===b.parent.get_top().length))},a.prototype.muldivNeg1=function(a){return a.is_group("mul","div")&&D.is_num(a.children[1])&&-1===D.get_value(a.children[1])},a.prototype.addsub0=function(a){var b=a.is_group("num")&&a.parent?a.parent:a;return b.is_group("add","sub")&&D.is_num(b.children[1])&&0===D.get_value(b.children[1])},a.prototype.prodFracContainingAMulZero=function(a){return a.is_group("product","fraction")&&a.get_top().some(function(a){var b=a.get_child([1]);return D.is_num(b)&&0===D.get_value(b)})},a.prototype.getSumAncestor=function(a){for(var b=a.parent;b&&!b.is_group("sum");)b=b.parent;return b},a.prototype.exp1=function(a){return a.is_group("exponent")&&D.is_num(a.children[0])&&1===D.get_value(a.children[0])},new a}(),ad.actions.AddSubNumbersAction=function(){function a(a,b){return D.is_num(a.children[1])&&!a.is_group("addsub")&&!(b&&a.is_group("sub")&&a.children[1].is_group("sign"))}var b=function(a){if(p.call(this,"AddSubNumbersAction","add or subtract numbers"),this.priority=6,this.triggerType="tap",this.settings={is_join_action:!0,delay:300,side:"inside"},a){var b={margin:{x1:.1}};this.initSettings(ad.extend(a,{drop_area:b}))}};return ad.inherit(p,b),b.prototype.getAllAvailableActions=function(b,c){var d=arguments.length<=2||void 0===arguments[2]||arguments[2];if(b.length>1)return[];if(!b[0].is_group("add","sub"))return[];if(!a(b[0],d))return[];var e=this.getOtherNumberAddendsInSum(b[0],d);return this.bindActionForEachTarget(b,e)},b.prototype.getOtherNumberAddendsInSum=function(b,c){return b.parent.children.filter(function(d){return d!==b&&a(d,c)})},b.prototype.match=function(b){var c=arguments.length<=1||void 0===arguments[1]||arguments[1];return!!b.parent.is_group("sum")&&(!!b.ls&&(a(b.ls,c)&&a(b,c)))},b.prototype.rematch=function(){var a=this;if(this.actor)return this.match(this.actor,!1);if(this.nodes&&this.nodes.length>0&&this.target){return this.getAllAvailableActions(this.nodes,null,!1).some(function(b){return b.target===a.target})}return!1},b.prototype.transform=function(a){"drag"===this.triggerType?(this.sourceAddend=this.nodes[0],this.targetAddend=this.target):(this.sourceAddend=this.actor,this.targetAddend=this.actor.ls),this.addTouchedNodes(this.sourceAddend),this.addTouchedNodes(this.targetAddend);var b=this.getNewTreeNode(this.sourceAddend),c=this.getNewTreeNode(this.targetAddend),d=b.parent,e=b.children[1],f=c.children[1],g=(b.is_group("sub")?-1:1)*D.get_value(e)+(c.is_group("sub")?-1:1)*D.get_value(f),h=c.is_group("add")&&c.children[1].is_group("sign"),i=new u(new D(g)),j=c.remove();return d.insert(j,i),b.remove(),h||this.applyInnerAction("AddSubCombineSigns",{actor:i}),this.updateNodeMap(this.sourceAddend,i),this.updateNodeMap(this.sourceAddend.children[0],i.children[0]),this.updateNodeMap(this.sourceAddend.children[1].get_mapping_to(i.children[1])),this.updateNodeMap(this.targetAddend,i),this.updateNodeMap(this.targetAddend.children[0],i.children[0]),this.updateNodeMap(this.targetAddend.children[1].get_mapping_to(i.children[1])),this.cleanup(d),"function"==typeof a&&a(this),this},u.prototype.add_action_handler(new b),new b}(),Id.prototype.move_actions.push(ad.actions.AddSubNumbersAction),Md=function(a){function b(a){id(this,b);var c=pd(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,"AssociateIntoFractionAction","associative property of multiplication--move into fraction"));if(c.priority=0,c.triggerType="tap",c.settings={no_target_box_expansion:!0},a){var d={node:a.target?I.get_whole_range(a.target):null,side:"around",margin:{y2:.25,x:-.1}},e={margin:{y2:.1,x:-.1}};c.initSettings(ad.extend(a,{drop_area:d,drop_area_hint:e}))}return c}return qd(b,a),jd(b,[{key:"getAllAvailableActions",value:function(a){var b=this,c=oa(a);if(!c)return[];var d=pa(c);return ad.array.flatten(d.map(function(c){return b.bindActionForEachTarget(a,c,!0)}))}},{key:"match",value:function(a){return!!a.is_group("mul","div")&&(a.ls&&a.ls.value===a.value&&(qa(a)||qa(a.ls)))}},{key:"transform",value:function(a){var b=void 0,c=void 0;if(this.nodes)b=this.nodes,c=this.target;else{this.settings.side=qa(this.actor)?"left-of":"right-of",b="left-of"===this.settings.side?[this.actor.ls]:[this.actor];var d=qa("left-of"===this.settings.side?this.actor:this.actor.ls).get_top();c="left-of"===this.settings.side?d[0]:d[d.length-1]}this.addTouchedNodes(b),this.addTouchedNodes(c);var e=this.getNewTreeNode(b),f=e[0].parent,g=this.getNewTreeNode(c),h=g.parent,i=h.children.indexOf(g);if("right-of"===this.settings.side&&i++,1===h.get_top().length&&1===D.get_value(h.get_child([0,1]))&&(h.get_child([0]).simplify=!0),_c.remove_range(e),e[0].is_group("div")&&e.forEach(function(a){a.invert()}),h.insert_range(i,e),this.cleanup(f),"function"!=typeof a)return!0;a(this)}}]),b}(p),Nd=new Md,ad.actions.AssociateIntoFractionAction=Nd,K.prototype.add_action_handler(Nd),Id.prototype.move_actions.push(Nd),ad.actions.AssociateOutOfFractionAction=function(){var a=function(a){p.call(this,"AssociateOutOfFractionAction","associative property of multiplication--move out of fraction"),this.priority=-2,this.triggerType="drag",this.settings={margin:{y:.5}},a&&(this.setActorAndTarget(a),this.settings.side=Array.isArray(this.target)?"around":a.side,this.settings.target_is_left="left-of"===a.side,this.settings.margin["right-of"===a.side?"x2":"x1"]=-1,this.settings.margin["right-of"===a.side?"x1":"x2"]=.2)};return ad.inherit(p,a),a.prototype.getAllAvailableActions=function(a){if(0===a.length)return[];var b=a[0];return b.is_group("mul")&&b.parent.is_group("fraction")&&this.match(a,b.parent)?[this.bindAction(a,"left-of"),this.bindAction(a,"right-of")]:[]},a.prototype.bindAction=function(a,b){var c=a[0].get_root(),d=[];return this.fractionIsPartOfProduct(a)&&(d=this.getSiblingsOfFraction(a,b)),this.createBoundAction(c,{nodes:a,target:d.length>0?d:a[0].parent,side:b})},a.prototype.fractionIsPartOfProduct=function(a){var b=a[0].parent;return b.parent&&b.parent.is_group("mul")},a.prototype.getSiblingsOfFraction=function(a,b){var c=a[0].parent,d=c.parent,e=d.parent;return"left-of"===b?e.children.slice(0,e.children.indexOf(d)):e.children.slice(e.children.indexOf(d)+1)},a.prototype.match=function(a,b){return 0!==a.length&&(!(!a[0]||a[0].parent!==b||!b.is_group("fraction"))&&((1!==a.length||1!==a[0].children[1].value||1!==b.get_top().length)&&!(!this.allNodesAreMuls(a)||!_c.is_range(a))))},a.prototype.allNodesAreMuls=function(a){for(var b=0;b<a.length;b++)if(!a[b].is_group("mul"))return!1;return!0},a.prototype.transform=function(a){var b=this.getNewTreeNode(this.nodes),c=b[0].parent,d=this.settings.target_is_left;_c.remove_range(b);var e=new I;for(c.replace_with(e),e.append(new K(c)),e.insert_range(d?0:1,b);e.parent.is_group("sign","plusminus");){var f=e.parent;f.replace_with(e);var g=e.get_child([0,1]);g.replace_with(f),f.append(g)}if(this.cleanup(c),this.cleanup(e.parent),"function"!=typeof a)return!0;a(this)},new a}(),Id.prototype.move_actions.push(ad.actions.AssociateOutOfFractionAction),ad.actions.AssociateOutOfDenominatorAction=function(){var a=function(a){p.call(this,"AssociateOutOfDenominatorAction","associative property of division--move out of fraction denominator"),this.priority=-2,this.triggerType="drag",this.settings={delay:100,margin:{y:.5}},a&&(this.setActorAndTarget(a),this.settings.side=a.side,this.settings.margin["right-of"===a.side?"x2":"x1"]=-1,this.settings.margin["right-of"===a.side?"x1":"x2"]=.2)};return ad.inherit(p,a),a.prototype.getAllAvailableActions=function(a){var b=this.matchSource(a);if(!b)return[];var c=this.getTargets(b);return this.bindActionForEachTarget(a,c,!0)},a.prototype.matchSource=function(a){if(!_c.is_range(a)||!a[0].is_group("div"))return!1;var b=a[0].parent;return!(I.is_fraction_with_identity_numerator(b)&&a.length===b.get_bottom().length&&(1!==a.length||!a[0].children[1].is_group("fraction")))&&(!!b.is_group("fraction")&&{nodes:a,fraction:b})},a.prototype.getTargets=function(a){return[a.fraction]},a.prototype.transform=function(a){this.addTouchedNodes(this.nodes[0].parent);var b=this.getNewTreeNode(this.nodes),c=b[0].parent,d=this.getNewTreeNode(this.target),e=I.is_fraction_with_identity_numerator(c)&&1===this.nodes.length;_c.remove_range(b),b.forEach(function(a){a.invert()});var f=this.groupNonFractionRanges(b),g=this.replaceTargetWithProductContainingTargetAndTerms(d,f,this.settings.side);if(f.forEach(function(a){I.convert_to_reciprocal(a.children[1])}),this.cleanup_cascade(c),e){var h=this.mapNodes(this.nodes[0].parent.children[0])[0];h&&(h.simplify=!0)}for(;g.parent.is_group("sign","plusminus");){var i=g.parent;i.replace_with(g);var j=g.get_child([0,1]);j.replace_with(i),i.append(j)}if(this.cleanup(g.parent),this.setNodesToReselectAfterAction(f),"function"!=typeof a)return this;a(this)},a.prototype.groupNonFractionRanges=function(a){if(1===a.length)return a;if(2===a.length&&a.some(function(a){return I.is_fraction(a.children[1])}))return a;for(var b=[],c=[],d=[],e=0;e<a.length;e++){var f=a[e];I.is_fraction(f.children[1])||D.is_equal_to(f.children[1],1,-1)?(d.length&&c.push(d),c.push([f]),d=[]):d.push(f)}d.length&&c.push(d);for(var e=0;e<c.length;e++){var g=c[e];if(g.length>1){var h=new K(new I);g.forEach(function(a){h.children[1].append(a)}),b.push(h)}else b.push(g[0])}return b},a.prototype.replaceTargetWithProductContainingTargetAndTerms=function(a,b,c){var d=new I,e=a.is_group("mul")?a.children[1]:a;return e.replace_with(d),d.append(new K(e)),b.forEach(function(a,b){"right-of"===c?d.append(a):d.insert(b,a)}),d},new a}(),Id.prototype.move_actions.push(ad.actions.AssociateOutOfDenominatorAction),ad.actions.AssociateIntoDenominatorAction=function(){var a=function(a){if(p.call(this,"AssociateIntoDenominatorAction","associative property of denominator--move into denominator"),this.priority=-2,this.triggerType="drag",this.settings={no_target_box_expansion:!0},a){var b={side:"around",margin:{y1:.25,x:-.1}};a.target&&(a.target.parent.is_group("fraction")?b.node=I.get_whole_range(a.target):b.node=a.target);var c={margin:{y1:.1,x:-.1}};this.initSettings(ad.extend(a,{drop_area:b,drop_area_hint:c}))}};return ad.inherit(p,a),a.prototype.getAllAvailableActions=function(a){var b=this.matchSource(a);if(!b)return[];var c=this.getTargets(b);return ad.array.flatten(c.map(function(b){return this.bindActionForEachTarget(a,b,!!b[0].is_group("div"))},this))},a.prototype.matchSource=function(a){if(!a[0].is_group("div"))return!1;var b=a[0].parent,c=b.parent;return c.is_group("sign","plusminus")&&(c=c.parent),!!c.is_group("mul","div")&&{nodes:a,frac:b,op:c,group:c.parent}},a.prototype.getTargets=function(a){for(var b=[],c=0;c<a.group.children.length;c++){var d=a.group.children[c];if(d.value===a.op.value&&d!==a.op){var e=this.operatorContainsFraction(d);e?b.push(e.get_bottom()):b.push([d.children[1]])}}return b},a.prototype.operatorContainsFraction=function(a){var b=a.children[1];return b.is_group("sign","plusminus")&&(b=b.children[1]),!!b.is_group("fraction")&&b},a.prototype.transform=function(a){this.addTouchedNodes(this.nodes),this.addTouchedNodes(this.target);var b=this.settings.side,c=this.getNewTreeNode(this.nodes),d=c[0].parent,e=this.getNewTreeNode(this.target);if(_c.remove_range(c),this.insertDivsInNewLocation(c,e,b),this.cleanupSourceFraction(d),"function"!=typeof a)return this;a(this)},a.prototype.insertDivsInNewLocation=function(a,b,c){b.is_group("div")?this.insertDivRangeIntoDenominator(a,b,c):this.replaceTargetWithFractionContainingTargetAndDivs(a,b)},a.prototype.insertDivRangeIntoDenominator=function(a,b,c){var d=b.parent;d.insert_range(d.children.indexOf(b)+("left-of"===c?0:1),a)},a.prototype.replaceTargetWithFractionContainingTargetAndDivs=function(a,b){var c=(b.parent,new I);b.replace_with(c),c.append(new K(b)),a.forEach(function(a){c.append(a)})},a.prototype.cleanupSourceFraction=function(a){var b=a.parent,c=b.parent;this.cleanup(a),!this.cleanup(b)&&D.is_num(b.children[1])&&1===D.get_value(b.children[1])&&(b.remove(),this.cleanup(c))},new a}(),Id.prototype.move_actions.push(ad.actions.AssociateIntoDenominatorAction),ad.actions.AddSubBracketsAction=function(){var a=function(a){p.call(this,"AddSubBracketsAction","add or subtract a bracketed sum"),this.priority=4,this.triggerType="tap",a&&(this.actor=a.actor)};ad.inherit(p,a),a.prototype.match=function(a){return!(!a.is_group("add")&&!a.is_group("sub"))&&(!!a.children[1].is_group("brackets")&&(a.children[1].children[1].is_group("sum")||w.is_optional(a.children[1])))},a.prototype.transform=function(a){var b=this.getNewTreeNode(this.actor),c=this.actor.children[0];this.addTouchedNodes(this.actor);var d=b.children[1],e=b.children[1].children[1];if(_c.replace(d,e),b.is_group("sub")&&e.is_group("sum")){b.invert();for(var f=[],g=0;g<e.children.length;g++)e.children[g].invert(),f.push(e.children[g].children[0]);this.updateNodeMap(c,f)}if(this.cleanup(b),"function"!=typeof a)return this;a(this)};var b=new a;return u.prototype.add_action_handler(b),b}(),ad.actions.AddSubInverseAction=function(){var a=function(a){p.call(this,"AddSubInverseAction","move the exponent of the argument outside of the logarithm"),this.priority=5,this.triggerType="tap",this.settings={side:"around",is_join_action:!0,delay:300},a&&(a.nodes?(this.triggerType="drag",this.nodes=a.nodes,this.target=a.target):this.actor=a.actor)};ad.inherit(p,a),a.prototype.getAllAvailableActions=function(a){var b=this.matchSource(a);if(!b)return[];var c=this.getTargets(b);return this.bindActionForEachTarget(a,c)},a.prototype.matchSource=function(a){return 1===a.length&&(!!a[0].is_group("add","sub")&&{nodes:a,group:a[0].parent})},a.prototype.getTargets=function(a){return a.group.children.filter(function(b){return b.get_idx()!==a.nodes[0].get_idx()&&this.addendsAreInverses(a.nodes[0],b)},this)},a.prototype.match=function(a){return a.is_group("add","sub")&&a.ls&&this.addendsAreInverses(a,a.ls)},a.prototype.addendsAreInverses=function(a,b){var c=this.getAddendTypeAndTermAscii(a),d=this.getAddendTypeAndTermAscii(b);if(c.ascii!==d.ascii)return!1;var e=c.num_of_signs+d.num_of_signs;return(1===e||3===e)&&!(c.num_of_brackets>2||d.num_of_brackets>2||Math.abs(c.num_of_brackets-d.num_of_brackets)>1)},a.prototype.getAddendTypeAndTermAscii=function(a){for(var b=a.is_group("add")?0:1,c=0,d=a.children[1];d.is_group("sign","brackets");)d.is_group("brackets")?c++:d.is_group("sign")&&b++,d=d.children[1];var e=void 0;return e=d.is_group("product")&&d.get_child([0,1]).is_group("sign")?d.to_ascii().slice(1):d.to_ascii(),{num_of_signs:b,num_of_brackets:c,ascii:e}},a.prototype.transform=function(a){var b=this.getSourceAndTarget();this.addTouchedNodes(b.source),this.addTouchedNodes(b.target);var c=this.getNewTreeNode(b.source),d=this.getNewTreeNode(b.target);c.remove();var e=d.parent,f=d.remove(),g=new D(0),h=new u(g);return h.simplify=!0,e.insert(f,h),this.updateNodeMap(b.source,h),this.updateNodeMap(b.target,h),this.updateNodeMap(b.source.children[0],g),this.updateNodeMap(b.target.children[0],g),this.updateNodeMap(b.source.children[1].get_mapping_to(g)),this.updateNodeMap(b.target.children[1].get_mapping_to(g)),this.cleanup_cascade(e),"function"==typeof a&&a(this),this};var b=new a;return u.prototype.add_action_handler(b),b}(),Id.prototype.move_actions.push(ad.actions.AddSubInverseAction),ad.actions.AddVariablesAction=function(){function a(a){return a.map(function(a){return a.to_ascii()}).join("")}function b(a){return a.is_group()&&a.commutative&&a.associative}function c(a){if(0===a.length)return"";var c=a.map(function(a){return a.to_ascii()}).join("");return 1===a.length?c:b(a[0])?c.substring(a[0].children[0].to_ascii().length):c}function d(a){if(0===a.length)return"";var c=a.map(function(a){return a.to_ascii()}).join("");return b(a[0])?c.substring(a[0].children[0].to_ascii().length):c}function e(a){return a.is_group("product")&&a.children[0].children[1].is_group("sign")?a.children[0].children[1].children[1].to_ascii()+a.children.slice(1).map(function(a){return a.to_ascii()}).join(""):""}function f(a){return a.length===a[0].parent.children.length}function g(a){return a.parent}function h(b){return function(d){return 0!==d.length&&(!!d[0].parent&&((!g(d[0].parent)||!f(d))&&(a(d)===b||c(d)===b)))}}function i(a){return function(b){return!!b.parent&&(!(!b.parent.is_group("add")&&!b.parent.is_group("sub"))&&(b.to_ascii()===a||e(b)===a))}}function j(a){var b=a.parent;return function(c){var d,e;try{if(Array.isArray(c)?(d=_c.get_parent(3,c[0]),e=_c.get_parent(2,c[0])):(d=_c.get_parent(2,c),e=_c.get_parent(1,c)),!b.is_group("sum")||!d.is_group("sum")||b!==d||e===a)return!1}catch(a){if("invalid path"===a)return!1;throw a}return!0}}function k(a){return function(a){if(!Array.isArray(a))return!0;var b=a[0].parent;if(b.children.length!==a.length+1)return!1;for(var c=0;c<b.children.length;c++){var d=b.children[c];if(-1===a.indexOf(d)&&!D.is_num(d.children[1]))return!1}return!0}}var l=function(a){p.call(this,"AddVariablesAction","add variables"),this.priority=1,this.triggerType="tap",this.settings={is_join_action:!0,delay:300,side:"inside"},a&&("drag"===a.triggerType?(this.triggerType=a.triggerType,this.nodes=a.nodes,this.target=a.target):this.actor=a.actor)};return ad.inherit(p,l),l.prototype.getAllAvailableActions=function(b){if(b.length>1)return[];var c=b[0];if(!c.is_group("add","sub"))return[];var e=c.parent,f=this.analyzeAddendStructure(c);if(Array.isArray(f.range)&&f.range.length<1)return[];var g,l=this.prepareRangeForSearch(f.range);return l.length<1?[]:(g=_c.filterRange(h(a(l)),e),g=g.concat(_c.filter(i(d(l)),e)),g=g.filter(j(c)),g=g.filter(k(l)),this.bindActionForEachTarget(b,g))},l.prototype.match=function(b){if(!b.ls)return!1;var c=b;if(!c.is_group("add","sub"))return!1;var e=this.analyzeAddendStructure(c);if(Array.isArray(e.range)&&e.range.length<1)return!1;var f,g=this.prepareRangeForSearch(e.range);return!(g.length<1)&&(f=_c.filterRange(h(a(g)),c.ls),f=f.concat(_c.filter(i(d(g)),c.ls)),1===f.length&&(f=f.filter(j(c)),f=f.filter(k(g)),1===f.length))},l.prototype.prepareRangeForSearch=function(a){return Array.isArray(a)?a:[new K(_c.clone(a))]},l.prototype.analyzeAddendStructure=function(a){var b=a.children[1];return b.is_group("product")?this.analyzeProductStructure(b):D.is_num(b)?{range:[]}:{range:b,coefficientLocation:"none"}},l.prototype.analyzeProductStructure=function(a){var b,c=[a.children[0].children[1],a.children[a.children.length-1].children[1]];if(D.is_num(c[0])&&D.is_num(c[1]))return{range:[]};b=D.is_num(c[0])||D.is_num(c[1])?D.is_num(c[0])?"front":"back":"none";var d,e;"none"===b?(d=0,e=a.children.length):"front"===b?(d=1,e=a.children.length):(d=0,e=a.children.length-1);for(var f=[],g=d;g<e;g++){var h=a.children[g].children[1];if(D.is_num(h))return{range:[]};f.push(h.parent)}return{range:f,coefficientLocation:b}},l.prototype.bindActionForEachTarget=function(a,b){for(var c=[],d=a[0].get_root(),e=0;e<b.length;e++){var f={};f.triggerType="drag",f.nodes=a;var g=b[e];Array.isArray(g)?(f.target=g[0].parent.parent,f.range=g):f.target=g.parent,c.push(this.createBoundAction(d,f))}return c},l.prototype.transform=function(a){"drag"===this.triggerType?(this.sourceAddend=this.nodes[0],this.targetAddend=this.target):(this.sourceAddend=this.actor,this.targetAddend=this.actor.ls),this.addTouchedNodes(this.sourceAddend),this.addTouchedNodes(this.targetAddend);var b=this.analyzeAddendStructure(this.sourceAddend),c=this.analyzeAddendStructure(this.targetAddend);b.addend=this.sourceAddend,c.addend=this.targetAddend;var d=this.getNewTreeNode(this.sourceAddend),e=this.getNewTreeNode(this.targetAddend),f=d.parent,g=d.children[1],h=e.children[1];"none"===b.coefficientLocation&&(g=this.reinterpretTermAsProductWithCoefficientOfOne(g)),"none"===c.coefficientLocation&&(h=this.reinterpretTermAsProductWithCoefficientOfOne(h)),0===e.parent.children.indexOf(e)&&"none"===c.coefficientLocation&&h.children[1].children[1].is_group("sign")&&this.absorbNegativeIntoAddend(e);var i=this.splitProduct(g),j=this.splitProduct(h),k=i.coefficient*(d.is_group("sub")?-1:1)+j.coefficient*(e.is_group("sub")?-1:1),l=K.prototype.createParentGroup();l.append(new K(new D(Math.abs(k)))),l.append_range(i.variables);var m=k<0?new u(l,"sub"):new u(l,"add"),n=e.remove();f.insert(n,m),d.remove();var o={parentOfSum:m.parent.parent,idxOfSum:m.parent.get_idx(),resultingAddend:m,idxOfResultingAddend:m.get_idx(),resultingProduct:l};return 1===Math.abs(k)&&(l.children[0].simplify=!0),l.simplify=!0,this.mapOldStructureToNewStructure(b,o),this.mapOldStructureToNewStructure(c,o),this.cleanup_cascade(m.parent),"function"==typeof a&&a(this),!0},l.prototype.reinterpretTermAsProductWithCoefficientOfOne=function(a){if(a.is_group("product"))return a.insert(0,new K(new D(1))),a;var b=a.parent;a.remove();var c=K.prototype.createParentGroup();return c.append(new K(new D(1))),c.append(new K(a)),b.append(c),c},l.prototype.splitProduct=function(a){var b,c,d=this.findIndexOfCoefficient(a);return 0===d?(b=D.get_value(a.children[d].children[1]),c=_c.clone(a.children.slice(1))):(b=D.get_value(a.children[d].children[1]),c=_c.clone(a.children.slice(0,d))),{coefficient:b,variables:c}},l.prototype.findIndexOfCoefficient=function(a){for(var b=a.children,c=0;c<b.length;c++)if(D.is_num(b[c].children[1]))return c},l.prototype.absorbNegativeIntoAddend=function(a){var b=a.children[1].children[1].children[1],c=b.parent,d=b.remove(),e=b.children[1];e.remove(),c.insert(d,e),a.invert()},l.prototype.mapOldStructureToNewStructure=function(a,b){var c,d=b.parentOfSum.children[b.idxOfSum];if(c=d.is_group("sum")?d.children[b.idxOfResultingAddend]:d,D.is_num(c))this.updateNodeMap(a.addend.get_mapping_to(c));else{this.mapAddendGroup(a.addend,c);var e=this.mapNegatives(a.addend,a.coefficientLocation,c);this.mapCoefficients(a.addend,a.coefficientLocation,c),this.mapVariables(a.range,c,e)}},l.prototype.mapAddendGroup=function(a,b){b.is_group("add","sub")&&(this.updateNodeMap(a,b),this.updateNodeMap(a.children[0],b.children[0]))},l.prototype.mapNegatives=function(a,b,c){if(c.is_group("add","sub","sign","product")){var d,e;a.is_group("sub")&&(d=a.children[0]);var f,g="front"===b||"none"===b&&a.children[1].children[0]?a.children[1].children[0]:a.children[1].children[a.children[1].children.length-1];if(g&&g.children[1]&&g.children[1].is_group("sign")&&(e=g.children[1].children[0],f="none"===b),!(d&&e||!d&&!e)){if(c.is_group("sub")&&e)return void this.updateNodeMap(e,c.children[0]);if(c.is_group("sign"))return d&&this.updateNodeMap(d,c.children[0]),void(e&&this.updateNodeMap(e,c.children[0]));if(c.is_group("add")&&(c=c.children[1]),c.is_group("product")&&c.children[0].children[1].is_group("sign")){var h=c.children[0].children[1].children[0];return d&&this.updateNodeMap(d,h),e&&(this.updateNodeMap(e.parent,h.parent),this.updateNodeMap(e,h)),f}}}},l.prototype.mapCoefficients=function(a,b,c){var d,e,f,g;"none"!==b&&("front"===b?d=a.children[1].children[0]:"back"===b&&(d=a.children[1].children[a.children[1].children.length-1]),e=d.children[1],e.is_group("sign")&&(e=e.children[1]),c.is_group("add","sub")&&(c=c.children[1]),c.is_group("product")&&D.is_num(c.children[0].children[1])&&(f=c.children[0],g=c.children[0].children[1],g.is_group("sign")&&(g=g.children[1]),this.updateNodeMap(d,f),this.updateNodeMap(e,g)))},l.prototype.mapVariables=function(a,b,c){if(b.is_group("add","sub")&&(b=b.children[1]),b.is_group("product")){var d=D.is_num(b.children[0].children[1])?b.children.slice(1):b.children.slice();if(Array.isArray(a))for(var e=0;e<a.length;e++){var f=0===e&&c?a[e].children[1].children[1]:a[e].children[1],g=d[e].children[1].is_group("sign")?d[e].children[1].children[1]:d[e].children[1];this.updateNodeMap(a[e],d[e]),this.updateNodeMap(a[e].children[0],d[e].children[0]),this.updateNodeMap(f.get_mapping_to(g))}else{var g=d[0].children[1].is_group("sign")?d[0].children[1].children[1]:d[0].children[1];this.updateNodeMap(a.get_mapping_to(g))}}else{var f=Array.isArray(a)?a[0]:a;this.updateNodeMap(f.get_mapping_to(b.is_group("sign")?b.children[1]:b))}},l.prototype.reselectNodes=function(a){if(!a.parentOfSum.children[a.idxOfSum].is_group("sum"))if(a.parentOfSum.children[a.idxOfSum].is_group("add","sub"))this.setNodesToReselectAfterAction(a.parentOfSum.children[a.idxOfSum]);else{var b=a.resultingProduct.children;b[0].parent===a.resultingProduct?this.setNodesToReselectAfterAction(a.resultingProduct):this.setNodesToReselectAfterAction(b)}},u.prototype.add_action_handler(new l),new l}(),Id.prototype.move_actions.push(ad.actions.AddVariablesAction),ad.actions.AddSubTupleAction=function(){var a=function(a){p.call(this,"AddSubTupleAction","add or subtract tuples"),this.priority=1,this.triggerType="tap",this.settings={is_join_action:!0,delay:300,side:"inside"},a&&(a.nodes?(this.triggerType="drag",this.nodes=a.nodes,this.target=a.target):this.actor=a.actor)};return ad.inherit(p,a),a.prototype.getAllAvailableActions=function(a){if(1!==a.length)return[];var b=a[0];if(!this.isTupleAddend(b))return[];var c=this.getOtherTupleAddendsInSum(b);return this.bindActionForEachTarget(a,c)},a.prototype.isTupleAddend=function(a,b){return a.is_group("add","sub")&&a.children[1].is_group("brackets")&&a.children[1].children[1].is_group("tuple")&&(!b||a.children[1].children[1].children.length===b)},a.prototype.getTupleAddendLen=function(a){return a.children[1].children[1].children.length},a.prototype.getOtherTupleAddendsInSum=function(a){var b=a.parent,c=a.children[1].children[1].children.length;return b.children.filter(function(b){return b!==a&&this.isTupleAddend(b,c)},this)},a.prototype.match=function(a){return this.isTupleAddend(a)&&a.ls&&this.isTupleAddend(a.ls,this.getTupleAddendLen(a))},a.prototype.transform=function(a){var b,c;"drag"===this.triggerType?(b=this.nodes[0],c=this.target):(b=this.actor.ls,c=this.actor),this.addTouchedNodes(b),this.addTouchedNodes(c);var d=b.get_idx()<c.get_idx(),e=this.getNewTreeNode(b),f=this.getNewTreeNode(c),g=e.parent,h=e.children[1].children[1].children.length,i=f.remove();e.remove();var j=new R,k=new u(j);g.insert(i,k);for(var l=0;l<h;l++){var m=new t;m.simplify=!0;var n=new P(m);j.append(n),this.updateNodeMap(e.get_child([1,1,l]),n),this.updateNodeMap(f.get_child([1,1,l]),n),m.append(new u(e.get_child([1,1,l,1]),e.value)),m.insert(d?1:0,new u(f.get_child([1,1,l,1]),f.value)),this.applyInnerAction("AddSubCombineSigns",{actor:m.children[0]}),this.applyInnerAction("AddSubCombineSigns",{actor:m.children[1]}),this.cleanup(m.children[1]),this.cleanup(m.children[0])}return this.updateNodeMap(b,k),this.updateNodeMap(b.get_child([1]),k.get_child([1])),this.updateNodeMap(b.get_child([1,0]),k.get_child([1,0])),this.updateNodeMap(b.get_child([1,1]),k.get_child([1,1])),this.updateNodeMap(b.get_child([1,2]),k.get_child([1,2])),this.updateNodeMap(c,k),this.updateNodeMap(c.get_child([1]),k.get_child([1])),this.updateNodeMap(c.get_child([1,0]),k.get_child([1,0])),this.updateNodeMap(c.get_child([1,1]),k.get_child([1,1])),this.updateNodeMap(c.get_child([1,2]),k.get_child([1,2])),this.cleanup(g),"function"==typeof a&&a(this),this},u.prototype.add_action_handler(new a),new a}(),Id.prototype.move_actions.push(ad.actions.AddSubTupleAction),ad.actions.AddSubLogarithmsAction=function(){var a=function(a){if(p.call(this,"AddSubLogarithmsAction","add or subtract numbers"),this.priority=1,this.triggerType="tap",this.settings={target_group:!0,group_side:"around",delay:300,reset_y:!0,no_target_box_expansion:!0},a){var b={};a.target&&(b.drop_area_hint={side:"around"},b.destination_hint=[{node:a.target.children[1]}]),this.initSettings(ad.extend(a,b))}};return ad.inherit(p,a),a.prototype.getAllAvailableActions=function(a){var b=this.matchSource(a);if(!b)return[];var c=this.getTargets(b);return this.bindActionsForEachTarget(a,c)},a.prototype.matchSource=function(a){if(1!==a.length)return!1;var b=a[0];if(!b.is_group("add","sub"))return!1;var c=b.children[1];return!!O.Logs.is_log_func(c)&&{nodes:a,base:O.Logs.get_log_base(c),group:b.parent}},a.prototype.getTargets=function(a){var b=a.base.to_ascii();return a.group.children.filter(function(c){return c!==a.nodes[0]&&O.Logs.is_log_func(c.children[1])&&O.Logs.get_log_base(c.children[1]).to_ascii()===b},this)},a.prototype.bindActionsForEachTarget=function(a,b){var c=[];return b.forEach(function(b){var d=b.children[1].children[1];c=c.concat(this.bindActionForEachTarget(a,[d],!0))},this),c},a.prototype.match=function(a){if(!a.is_group("add","sub"))return!1;if(!a.ls)return!1;var b=a.ls.children[1],c=a.children[1];return O.Logs.is_log_func(b)&&O.Logs.is_log_func(c)&&O.Logs.get_log_base(b).to_ascii()==O.Logs.get_log_base(c).to_ascii()},a.prototype.transform=function(a){var b=this.getSourceAndTarget();this.addTouchedNodes(b.source),this.addTouchedNodes(b.target);for(var c=this.getNewTreeNode(b.source),d=this.getNewTreeNode(b.target),e=c.parent;!d.is_group("add","sub");)d=d.parent;c.remove();var f=c.children[1],g=d.children[1],h=f.get_arg(),i=g.get_arg(),j=i.parent,k=i.remove(),l=new I,m=new K(i,d.is_group("sub")?"div":"mul"),n=new K(h,c.is_group("sub")?"div":"mul");return l.append(m),l.insert("left-of"===this.settings.side?0:1,n,!0),j.insert(k,l),w.handle(g.children[1]),d.is_group("sub")&&d.invert(),b.source.map_group_and_sym(this,d,!0),b.source.children[1].map_to_func(this,g,!0),this.setNodesToReselectAfterAction(h.is_group("product")?h.children.slice():n),this.cleanup(m),this.cleanup(n),this.cleanup(l),this.cleanup(e),"function"==typeof a&&a(this),this},u.prototype.add_action_handler(new a),new a}(),Id.prototype.move_actions.push(ad.actions.AddSubLogarithmsAction),ad.actions.AddSubCombineSigns=function(){var a=function(a){p.call(this,"AddSubCombineSigns","combine signs in a sum"),this.triggerType="tap",this.priority=7,a&&(this.actor=a.actor)};return ad.inherit(p,a),a.prototype.match=function(a){return!!this.getInnerTerm(a)},a.prototype.getInnerTerm=function(a){return a.is_group("add","sub","addsub")?a.children[1].is_group("sign","plusminus")?a.children[1]:a.children[1].is_group("product")&&a.get_child([1,0,1]).is_group("sign","plusminus")?a.get_child([1,0,1]):null:null},a.prototype.rematch=function(){return this.actor.is_group("add","sub","addsub")},a.prototype.transform=function(a){var b=this.getNewTreeNode(this.actor),c=this.getInnerTerm(b),d=!1;if(c){var e=this.getOldTreeNode(c);c.is_group("plusminus")?b.setValue("addsub"):c.is_group("sign")&&b.invert(),this.updateNodeMap(e,b),this.updateNodeMap(e.children[0],b.children[0]),c.replace_with(c.children[1]),d=!0}if("function"!=typeof a)return d;a(this)},u.prototype.add_action_handler(new a),new a}(),ad.actions.ConvertAddendToFractionAction=function(){var a=function(a){p.call(this,"ConvertAddendToFractionAction","convert addend to a fraction to allow adding"),this.priority=1,this.triggerType="dbltap",a&&(this.actor=a.actor)};return ad.inherit(p,a),a.prototype.match=function(a){if(!a)return!1;if(!a.is_group("add","sub"))return!1;if(!a.ls)return!1;var b=a.ls.children[1],c=a.children[1];return b.is_group("fraction")&&!c.is_group("fraction")||!b.is_group("fraction")&&c.is_group("fraction")},a.prototype.transform=function(a){this.addTouchedNodes(this.actor),this.addTouchedNodes(this.actor.ls);var b=this.getNewTreeNode(this.actor.ls),c=this.getNewTreeNode(this.actor),d=((b.children[1].is_group("fraction")?b:c).children[1],(b.children[1].is_group("fraction")?c:b).children[1]),e=d.parent;d.remove();var f=K.prototype.createParentGroup();if(f.append(new K(d)),f.append(new K(new D(1),"div")),e.append(f),f.get_bottom()[0].simplify=!0,this.cleanup(f.get_top()[0]),this.followup=ad.actions.CrossMultiplyFractionsAction.createBoundAction(this.newTree,{actor:c}),"function"!=typeof a)return!0;a(this)},u.prototype.add_action_handler(new a),new a}(),ad.actions.AddSubInvertAction=function(){var a=function(a){p.call(this,"AddSubInvertAction","invert addends across an equality or inequality"),this.priority=0,this.triggerType="drag",a&&(this.setActorAndTarget(a),a.settings&&ad.extend(this.settings,a.settings))};return ad.inherit(p,a),a.prototype.getAllAvailableActions=function(a){var b=this.matchSource(a);if(!b)return[];var c=this.getTargets(b);return this.bindActions(a,c,b.side)},a.prototype.matchSource=function(a){return!!_c.is_range(a)&&(a[0].is_group("add","sub","addsub")&&a[0].parent.parent.is_group("equals","lte","gte","lt","gt")?{nodes:a,side:a[0].parent.get_idx(),eq:a[0].get_parent(2)}:!!a[0].parent.is_group("equals","lte","gte","lt","gt")&&{nodes:a,side:a[0].get_idx(),eq:a[0].parent})},a.prototype.getTargets=function(a){var b={};b.sym=a.eq.children[1];var c=a.eq.get_child([a.side?0:2]);return c.is_group("sum")?b.terms=c.children.map(function(a){return a.children[1]}):b.terms=[c],b},a.prototype.bindActions=function(a,b,c){var d=this,e=[],f=a[0].get_root(),g=0===c?{x1:-.5}:{x2:-.5};return e.push(this.createBoundAction(f,{nodes:a,target:b.sym,settings:{side:0===c?"right-of":"left-of",margin:g}})),b.terms.forEach(function(b){var c=b.parent.is_group("add","sub","addsub");e.push(d.createBoundAction(f,{nodes:a,target:b,settings:c?{side:"left-of",target_group:!0,group_side:"around",margin:{y:-.5}}:{side:"left-inside",margin:{y:-.5}}})),e.push(d.createBoundAction(f,{nodes:a,target:b,settings:c?{side:"right-of",target_group:!0,group_side:"around",margin:{y:-.5}}:{side:"right-inside",margin:{y:-.5}}}))}),e},a.prototype.transform=function(a){var b=this.getSourceAndTarget(!0);this.addTouchedNodes(b.source);var c=this.getNewTreeNode(b.source),d=c[0].parent,e=this.getNewTreeNode(b.target),f=this.matchSource(c),g=this.left_of();_c.remove_range(c),d.is_group("sum")||f.eq.insert(f.side,new D(0)),c[0].is_group("sum")&&(c=c[0].children.slice(),this.setNodesToReselectAfterAction(c));var h=void 0,i=void 0;if(e.is_group("sym")&&(e=f.eq.get_child([f.side?0:2]),g=!g,e.is_group("sum")&&(h=e,i=g?e.children[0]:e.children[e.children.length-1])),e.parent.is_group("add","sub","addsub")?(i=e.parent,h=i.parent):(h=new t,f.eq.insert(e.remove(),h),i=h.append(new u(e)),this.applyInnerAction("AddSubCombineSigns",{actor:i})),c[0].is_group("add","sub","addsub"))h.insert_range(i.get_idx()+(g?0:1),c),c.forEach(function(a){a.invert()});else{if(1!==c.length)throw"math transform error";var j=h.insert(i.get_idx()+(g?0:1),new u(c[0],"sub"));this.applyInnerAction("AddSubCombineSigns",{actor:j})}return 0===D.get_value(e)&&(e.parent.simplify=!0),this.cleanup(h.get_child([0])),this.cleanup(f.eq.children[f.side]),"function"==typeof a&&a(this),this},a.prototype.left_of=function(){return!("left-of"!==this.settings.side&&"left-inside"!==this.settings.side)},new a}(),Id.prototype.move_actions.push(ad.actions.AddSubInvertAction),Od=function(a){function b(a){id(this,b);var c=pd(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,"AddSubResolveCasesAction","resolve the cases for a plus-minus"));return c.priority=0,c.triggerType="dbltap",c.elements=[],c.settings={makes_no_changes:!0},a&&(c.settings.positive_case=a.positive_case,c.initSettings(a)),c}return qd(b,a),jd(b,[{key:"match",value:function(a){return a.is_group("plusminus","addsub")}},{key:"rebind",value:function(a,b,c){if(this.oldTree!==c)throw"wrong old tree during rebinding an action!";var d=new p;d.node_map=b,this.oldTree=a,this.actor&&(this.actor=d.mapNodes(this.actor)[0]),this.nodes&&(this.nodes=d.mapNodes(this.nodes))}},{key:"rematch",value:function(){return this.match(this.actor||this.nodes[0])}},{key:"transform",value:function(a){return this.target&&"AlgebraModel"===this.target.type?this.transform_update(a):this.transform_initial(a)}},{key:"transform_initial",value:function(a){var b=this.getSourceAndTarget();this.addTouchedNodes(b.source),this.node_map={};var c=this.transform_case(this.oldTree.clone(),!1),d=this.createBoundAction(this.oldTree,{nodes:[b.source],target:c,positive_case:!1});d.node_map=this.node_map,this.node_map={};var e=this.transform_case(this.oldTree.clone(),!0),f=this.createBoundAction(this.oldTree,{nodes:[b.source],target:e,positive_case:!0});return f.node_map=this.node_map,this.node_map={},this.elements.push({type:"derivation",model:e,action:f}),this.elements.push({type:"textbox",text:"or"}),this.elements.push({type:"derivation",model:c,action:d}),"function"==typeof a&&a(this),!0}},{key:"transform_update",value:function(a){return this.node_map={},this.transform_case(this.newTree,this.settings.positive_case),this.target=this.newTree,"function"==typeof a&&a(this),!0}},{key:"transform_case",value:function(a,b){this.extendNodeMap(this.oldTree.get_mapping_to(a));var c=a.get_child((this.actor||this.nodes[0]).get_path()),d=c.children[1],e=void 0;return c.is_group("addsub")?e=b?new u(d,"add"):new u(d,"sub"):c.is_group("plusminus")&&(e=b?d:new Q(d)),c.replace_with(e),a}}]),b}(p),Pd=new Od,Q.prototype.add_action_handler(Pd),u.prototype.add_action_handler(Pd),ad.actions.AddSubResolveCasesAction=Pd,ad.actions.RemoveBracketsAction=function(){var a=function(a){p.call(this,"RemoveBracketsAction","remove optional brackets"),this.priority=-1,this.triggerType="tap",a&&(this.actor=a.actor)};ad.inherit(p,a),a.prototype.match=function(a){return a.is_group("brackets")&&w.is_optional(a)||a.is_group("mul","div","add","sub")&&a.children[1].is_group("brackets")&&w.is_optional(a.children[1])},a.prototype.transform=function(a){var b=this.actor;b.is_group("brackets")||(b=b.children[1]);var c=this.getNewTreeNode(b);this.addTouchedNodes(b.children[0]),this.addTouchedNodes(b.children[2]);var d=_c.replace(c,c.children[1]);if(this.cleanup(d.parent),"function"!=typeof a)return!0;a(this)};var b=new a;return w.prototype.add_action_handler(b),K.prototype.add_action_handler(b),u.prototype.add_action_handler(b),b}(),ad.actions.DistributePolynomialsAction=function(){var a=function(a){p.call(this,"DistributePolynomialsAction","multiply two sums"),this.priority=1,this.triggerType="dbltap",a&&(this.actor=a.actor)};return ad.inherit(p,a),a.prototype.match=function(a){return!!a.ls&&(!!(a.is_group("mul")&&a.ls.is_group("mul")||a.is_group("div")&&a.ls.is_group("div"))&&(a.ls.children[1].is_group("brackets")||a.children[1].is_group("brackets")))},a.prototype.transform=function(a){var b=this,c=this.getSourceAndTarget(),d=this.getNewTreeNode(c.source),e=this.getNewTreeNode(c.target);this.addTouchedNodes(d),this.addTouchedNodes(e);var f=e.children[1].is_group("brackets")?e.children[1].children[1]:e.children[1],g=d.children[1].is_group("brackets")?d.children[1].children[1]:d.children[1],h=f.is_group("sum")?f.children:[f],i=g.is_group("sum")?g.children:[g],j=this.getFoilPairs(h,i),k=new t;return j.forEach(function(a){var c=b.getFactors(a.term1).concat(b.getFactors(a.term2)),d=b.getFactors(a.old_term1).concat(b.getFactors(a.old_term2)),e=Ca(c,d,a.is_neg,a.old_signs,b);k.append(new u(e))}),d.remove(),e.children[1].remove(),e.append(k),k.children.forEach(function(a){return b.applyInnerAction("AddSubCombineSigns",{actor:a})}),w.handle(k),k.children.forEach(function(a){var c=a.children[1];if(c.is_group("product","fraction")){for(var d=c.children.length-1;d>=0;d--)b.cleanup(c.children[d]);b.cleanup(c)}}),this.cleanup(k),this.cleanup_cascade(e),"function"==typeof a&&a(this),this},a.prototype.getFoilPairs=function(a,b){var c=[];return a.forEach(function(a){b.forEach(function(b){var d=a.is_group("sign","sub")!==b.is_group("sign","sub"),e=[],f=a.is_group("sign","sub","add")?a.children[1].clone():a.clone(),g=b.is_group("sign","sub","add")?b.children[1].clone():b.clone(),h=this.getOldTreeNode(a.is_group("sign","sub","add")?a.children[1]:a),i=this.getOldTreeNode(b.is_group("sign","sub","add")?b.children[1]:b);a.is_group("sign","sub")&&e.push(this.getOldTreeNode(a.children[0])),b.is_group("sign","sub")&&e.push(this.getOldTreeNode(b.children[0])),this.extendNodeMap(h.get_mapping_to(f)),this.extendNodeMap(i.get_mapping_to(g)),c.push({is_neg:d,term1:f,term2:g,old_term1:h,old_term2:i,old_signs:e})},this)},this),c},a.prototype.getFactors=function(a){return a.is_group("product")?a.children.map(function(a){return a.children[1]}):[a]},K.prototype.add_action_handler(new a),new a}(),Qd=function(a){function b(a){id(this,b);var c=pd(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,"CommuteAction","commute terms"));if(c.priority=-1,c.triggerType="drag",a){var d={y:-1};a.priority&&(c.priority=a.priority),a.dummy&&(c.settings.dummy=!0),a.drop_area&&ad.extend(a.drop_area.margin,d),c.initSettings(a)}return c}return qd(b,a),jd(b,[{key:"getAllAvailableActions",value:function(a){var b=Ea(a);if(!b)return[];var c=Fa(b);return this.bindActionsForEachTarget(a,c)}},{key:"bindActionsForEachTarget",value:function(a,b){var c=this,d=[],e=a[0].get_root(),f=a[0],g=a[a.length-1],h=f.ls,i=g.rs,j=b[0],k=b[b.length-1];return b.forEach(function(b){d.push(c.bindTermRightAction(e,a,b.children[1],b===h,b===k&&b.get_idx()>g.get_idx())),b.children[0].hidden||d.push(c.bindOperatorAction(e,a,b.children[0],b===i)),d.push(c.bindTermLeftAction(e,a,b.children[1],b===i,b===j&&b.get_idx()<f.get_idx()))}),Ga(d),d}},{key:"bindOperatorAction",value:function(a,b,c,d){var e={nodes:b,target:c,priority:100},f=.1;return c.parent.is_group("add","sub","addsub")?(e.drop_area={margin:{x:f}},e.drop_area_hint={margin:{x:f}}):e.drop_area_hint={margin:{x:f/2}},d?e.dummy=!0:e.destination_hint={nodes:[c.parent],side:"left-of"},this.createBoundAction(a,e)}},{key:"bindTermLeftAction",value:function(a,b,c,d,e){var f={nodes:b,target:c,side:"left-inside"};return e?(f.drop_area={margin:{x1:-.5}},f.drop_area_hint={node:c.parent,side:"left-of",margin:{x1:-.2,x2:.1}}):f.drop_area_hint={hidden:!0},d?f.dummy=!0:f.destination_hint={nodes:[c.parent],side:"left-of"},this.createBoundAction(a,f)}},{key:"bindTermRightAction",value:function(a,b,c,d,e){var f={nodes:b,target:c,side:"right-inside"};return e?(f.drop_area={margin:{x2:-.5}},f.drop_area_hint={node:c.parent,side:"right-of",margin:{x1:.1,x2:-.2}}):f.drop_area_hint={hidden:!0},d?f.dummy=!0:f.destination_hint={nodes:[c.parent],side:"right-of"},this.createBoundAction(a,f)}},{key:"transform",value:function(a){var b=this.getSourceAndTarget(!0),c=void 0;c=b.target.is_group("sym")?"left-of":"left-inside"===this.settings.side?"left-of":"right-of",b.target=b.target.parent,this.addTouchedNodes(b.source),this.addTouchedNodes(b.target);var d=this.getNewTreeNode(b.source),e=this.getNewTreeNode(b.target),f=e.parent,g=e.get_idx();"right-of"===c&&g++;var h=_c.remove_range(d);if(f.insert_range(h<g?g-d.length:g,d),"function"!=typeof a)return!0;a(this)}}]),b}(p),Rd=new Qd,ad.actions.CommuteAction=Rd,Id.prototype.move_actions.push(Rd),ad.actions.EqInvertAndCommuteTermAction=function(){var a=function(a){if(p.call(this,"EqInvertAndCommuteTermAction","composed action of inverting terms across an equation and commuting"),this.priority=0,this.triggerType="drag",this.settings.margin={y:-1},a){var b=this.getDestinationHints(a);this.initSettings(ad.extend(a,{destination_hint:b}))}};return ad.inherit(p,a),a.prototype.getAllAvailableActions=function(a){var b=a[0].get_root(),c=this.getAndPerformAvailableInversionActionOnClone(b,a);if(!c)return[];var d=this.getAvailableCommuteActionsOnInversionResult(c);if(0===d.length)return[];var e=this.unmapToGetTargets(b,c,d).sort(function(a,b){return a.parent.get_idx()-b.parent.get_idx()});return this.adjustTargets(this.bindActionForEachTarget(a,e,!0))},a.prototype.getAndPerformAvailableInversionActionOnClone=function(a,b){var c=a.clone(),d=[];b.forEach(function(a){d.push(c.get_child(a.get_path()))});var e=ad.actions.MulDivInvertAction.getAllAvailableActions(d);if(0===e.length)return!1;var f=e[0];return c.performAction(f,null,!1,!0),f.newTree!==f.oldTree&&f},a.prototype.getAvailableCommuteActionsOnInversionResult=function(a){var b=[],c=a.nodes;1===c.length&&c[0].is_group("sum")&&(c=c[0].children.slice());for(var d=0;d<c.length;d++){var e=c[d],f=this.getTheNodesOnTheSameSideAsTheTarget(a.mapNodes(e),a.target);b.push(this.getCommutativeTermFromNode(f)[0])}return ad.actions.CommuteAction.getAllAvailableActions(b).filter(function(a){return!a.target.is_group("sym")})},a.prototype.getTheNodesOnTheSameSideAsTheTarget=function(a,b){var c=[],d=b.get_path()[1];return a.forEach(function(a){a.get_path()[1]===d&&c.push(a)}),c},a.prototype.unmapToGetTargets=function(a,b,c){var d=[];c.forEach(function(a){d.push(a.target)});var e=this,f=[];d.forEach(function(a){f.push(e.getCommuteTargetBeforeInversion(a,b))});var g=[];return f.forEach(function(b){g.push(a.get_child(b.get_path()))}),g},a.prototype.getCommuteTargetBeforeInversion=function(a,b){a.is_group("brackets")&&a.parent.is_group("mul")&&(a=a.parent);var c=b.unmapNodes(a);if(1===c.length)return c[0];if(a.is_group("mul")&&a.children[1].is_group("brackets")&&a.children[1].children[1].is_group("sum")){var d=a.children[1];if(c=b.unmapNodes(d),0!==c.length)return c[0];var e=d.children[1];return c=b.unmapNodes(e),c[0]}if(a.is_group("add","sub","mul")){var f=a.children[1];return b.unmapNodes(f)[0]}},a.prototype.getCommutativeTermFromNode=function(a){if(1!==a.length)throw"What's happening here?";return a[0].parent.commutative?[a[0].parent]:a[0].is_group("sum")&&a[0].parent.is_group("brackets")&&a[0].parent.parent&&a[0].parent.parent.commutative?[a[0].parent.parent]:a},a.prototype.adjustTargets=function(a){for(var b=0;b<a.length;b++){var c=a[b];(!c.target.ls&&"left-of"===c.side||(!c.target.rs||c.target.rs instanceof s)&&"right-of"===c.side)&&c.target.parent.is_group("fraction")&&(c.target=c.target.parent),0===b?c.settings.margin.x1=-.5:b===a.length-1&&(c.settings.margin.x2=-.5)}return a.filter(function(b,c){for(var d=a.slice(0,c),e=0;e<d.length;e++)if(d[e].target===b.target&&d[e].settings.side===b.settings.side)return!1;return!0})},a.prototype.getDestinationHints=function(a){for(var b=[],c=a.nodes[0];!c.is_group("add","sub","addsub")&&!Id.is_top_most(c);)c=c.parent;return(c.is_group("add","sub","addsub")?sd.get_siblings(c).map(function(a){return a.children[1]}):[]).forEach(function(a){return b.push({node:a,side:"below",margin:{x:-.2}})}),b.push({node:a.target,side:a.side}),b},a.prototype.doInPlace=function(a){this.initNodeMap();var b=this.settings.side;if(this.target.is_group("fraction")&&this.nodes[0].is_group("div")){var c=this.target.get_top();this.target="left-of"===b?c[0]:c[c.length-1]}var d=this;this.nodes.forEach(function(a){d.addTouchedNodes(a)});var e,f=this.getNewTreeNode(this.nodes),g=this.getNewTreeNode(this.target);e=f[0].is_group("mul","div")?ad.actions.MulDivInvertAction.getAllAvailableActions(f)[0]:ad.actions.AddSubInvertAction.getAllAvailableActions(f)[0],e.doInPlace(),this.compose(e,!1);var h=this.getTheNodesOnTheSameSideAsTheTarget(e.mapNodes(1===f.length&&f[0].is_group("sum")?f[0].children.slice():f),e.mapNodes(g)[0]),g=e.mapNodes(g);1===h.length&&(h=this.getCommutativeTermFromNode(h)),g=this.getCommutativeTermFromNode(g)[0];var i,j=ad.actions.CommuteAction.getAllAvailableActions(h).filter(function(a){return!a.target.is_group("sym")});if("right-of"!==b||this.target.parent.rs)for(var k=0;k<j.length;k++){var l=j[k];if("right-of"===b&&"right-inside"===l.settings.side&&g===l.target.parent){i=l,l.doInPlace(),this.compose(l,!1);break}if("left-of"===b&&"left-inside"===l.settings.side&&g===l.target.parent){i=l,l.doInPlace(),this.compose(l,!1);break}}if(this.setNodesToReselectAfterAction(i?this.getTheNodesOnTheSameSideAsTheTarget(i.mapNodes(h),g):this.getTheNodesOnTheSameSideAsTheTarget(h,g)),this.removeDeletedNodesFromNodeMap(),"function"!=typeof a)return!0;a(this)},new a}(),Id.prototype.move_actions.push(ad.actions.EqInvertAndCommuteTermAction),ad.actions.BreakingBracketsInAction=function(){function a(a){return!!_c.is_range(a)&&(!!a[0].commutative&&{nodes:a,type:a[0].name})}function b(a){var b=a.nodes[0].value;return sd.get_siblings(a.nodes).filter(function(c){return"add-sub"===a.type||c.is_group(b)}).map(function(a){return a.children[1]}).filter(function(b){return!!b.is_group("brackets")&&!(!b.children[1].is_group("brackets","abs-val")&&b.children[1].bp<a.nodes[0].bp)})}var c=function(a){if(p.call(this,"BreakingBracketsInAction","automatic into bracket handling"),this.interactionType="drag",this.settings={no_target_box_expansion:!0},a){var b=[{node:a.target.children[1]}];this.initSettings(ad.extend(a,{destination_hint:b}))}};return ad.inherit(p,c),c.prototype.getAllAvailableActions=function(c){var d=a(c);if(!d)return[];var e=b(d);return this.bindActionsForEachTarget(c,e)},c.prototype.bindActionsForEachTarget=function(a,b){var c=this,d=[],e=a[0].get_root();return b.forEach(function(b){d.push(c.createBoundAction(e,{nodes:a,target:b,side:"left-inside"})),d.push(c.createBoundAction(e,{nodes:a,target:b,side:"right-inside"}))}),d},c.prototype.transform=function(a){var b=this.getNewTreeNode(this.nodes),c=this.getNewTreeNode(this.target),d=this.settings.side;if(_c.remove_range(b),!c.children[1].is_group(b[0].group_name)){var e=c.children[1];c.children[1].remove();var f=b[0].createParentGroup();f.insert(0,b[0].createSameNode(e)),c.insert(1,f)}c.parent.is_group("div")&&c.children[1].is_group("product")&&b.forEach(function(a){return a.invert()}),c.parent.is_group("sub")&&b[0].is_group("add","sub")&&b.forEach(function(a){return a.invert()});var g="left-inside"===d?0:c.children[1].children.length;if(c.children[1].insert_range(g,b),c.parent.parent&&this.cleanup(c.parent.parent),"function"!=typeof a)return!0;a(this)},new c}(),Id.prototype.move_actions.push(ad.actions.BreakingBracketsInAction),ad.actions.BreakingBracketsOutAction=function(){var a=function(a){p.call(this,"BreakingBracketsOutAction","automatic out of bracket handling"),this.interactionType="drag",this.settings.margin={},a&&(this.nodes=a.nodes,this.target=a.target,this.settings.side=a.side,this.settings.margin["right-of"===a.side?"x2":"x1"]=-1.75)};return ad.inherit(p,a),a.prototype.getAllAvailableActions=function(a){if(0===a.length)return[];var b=a[0].get_root(),c=[];if(!_c.is_range(a))return[];var d;return a[0].parent.parent&&a[0].parent.parent.is_group("brackets")?d=a[0].parent.parent:a[0].parent.is_group("brackets")&&(d=a[0].parent),d&&(this.match(a,d,"right-of")&&c.push(this.createBoundAction(b,{nodes:a,target:d,side:"right-of"})),this.match(a,d,"left-of")&&c.push(this.createBoundAction(b,{nodes:a,target:d,side:"left-of"}))),c},a.prototype.match=function(a,b,c){return!(!w.is_optional(b)&&!b.parent.is_group("sub"))&&(a[0].parent===b&&!a[0].is_group("sym")||b===a[0].parent.parent&&(!!a[0].commutative&&(("left-of"!==c||b.ls!==a[a.length-1])&&("right-of"!==c||b.rs!==a[0]))))},a.prototype.transform=function(a){var b=this.getNewTreeNode(this.nodes),c=this.getNewTreeNode(this.target),d=this.settings.side;if(b[0].parent!==c||b[0].is_group("sym")){if(c.parent.group_name!==b[0].group_name){var e=c.replace_with(b[0].createParentGroup());_c.remove_range(b),e.append(b[0].createSameNode(c)),e.insert_range("left-of"===d?0:1,b),c.children[1].children<2&&w.handle(c,!0)}else{_c.remove_range(b);var f=c.parent.get_idx();c.parent.is_group("div")&&b[0].is_group("mul")&&b.forEach(function(a){return a.invert()}),c.parent.is_group("sub")&&b[0].is_group("add","sub")&&b.forEach(function(a){return a.invert()}),c.parent.parent.insert_range("left-of"===d?f:f+1,b)}if(c.children[1].children.length<2){var g=c.replace_with(c.children[1]);this.cleanup(g)}}else c.replace_with(b[0]),w.handle(b[0],!0);if("function"!=typeof a)return!0;a(this)},new a}(),Id.prototype.move_actions.push(ad.actions.BreakingBracketsOutAction),Id.prototype.hideNodesAction=function(){var a=function(a){p.call(this,"HideNodesAction","apply hide rules")};return ad.inherit(p,a),a.prototype.doInPlace=function(b,c){var d=!1;if(b.children.length>0){var e=function(c){var e=c.hidden,f=c.hide_afer_drop;if(c.hidden=!1,c.hide_after_drop=!1,b.settings.get("hide_leading_op")&&c instanceof s&&c.parent&&c.parent.commutative&&(c.parent.associative&&!c.parent.ls||"div"==c.parent.value&&c.parent.ls&&"//"==c.parent.ls.value)&&(c.parent.dragging?c.hide_after_drop=!0:c.hidden=!0),c instanceof s&&c.parent.is_group("fraction")&&I.is_lone_fraction_part(c)&&(c.hidden=!0),("("===c.value||")"===c.value)&&!a.bracketsAreEssentialElementsToExpressionType(c.parent)){var g=c.parent;if(g.parent.vertical_notation||g.parent.parent&&g.parent.parent.vertical_notation){for(var h=g;h.is_group("brackets");)h=h.children[1];!w.is_optional(h,g.parent)&&a.isLoneMulDivInNumeratorOrDenominator(g.parent)&&(c.parent.dragging?c.hide_after_drop=!0:c.hidden=!0)}}"("!==c.value&&")"!==c.value||!c.get_parent(2).is_group("radical")||3!==c.get_parent(1).get_idx()||(c.hidden=!0);for(var i=0;i<b.hide_rules.length&&!c.hidden;i++){var j=b.hide_rules[i];j.disabled||j.apply(c)}d=d||c.hidden!=e||c.hide_after_drop!=f};b.children[0].for_each(e)}if("function"!=typeof c)return d;c(this)},a.isLoneMulDivInNumeratorOrDenominator=function(a){return!(a.ls&&a.ls.is_group(a.value)||a.rs&&a.rs.is_group(a.value))},a.bracketsAreEssentialElementsToExpressionType=function(a){return a.is_group("brackets")&&a.children[1].is_group("tuple")},new a}(),ad.actions.SwitchAction=function(){var a=function(a){p.call(this,"SwitchAction","switch terms in a flat representation"),this.priority=0,this.triggerType="drag",this.settings={side:"around"},a&&(this.node=a.node,this.target=a.target)};return ad.inherit(p,a),a.prototype.getAllAvailableActions=function(a){if(0===a.length)return[];var b,c=a[0].get_root(),d=[],e=a[0].parent.is_group("flat");if(!e)return[];if(!a[0].commutative||!_c.is_range(a))return[];for(b=a[0].ls;b&&"//"!==b.value;b=b.ls)this.match(a[0],b)&&d.push(this.createBoundAction(c,{node:a[0],target:b}));for(b=a[a.length-1].rs;b&&"//"!==b.value;b=b.rs)this.match(a[0],b)&&d.push(this.createBoundAction(c,{node:a[0],target:b}))},a.prototype.match=function(a,b){return!(a.parent!==b.parent||a===b||b instanceof s||a instanceof s)},a.prototype.transform=function(a){var b=tree===this.target.get_root(),c=b?this.node:tree.get_child(this.node.get_path()),d=b?this.target:tree.get_child(this.target.get_path());if(_c.switch_siblings(c,d),"function"!=typeof a)return!0;a(this)},new a}(),Id.prototype.move_actions.push(ad.actions.SwitchAction),ad.actions.flipEquationAction=function(){var a=function(a){p.call(this,"flipEquationAction","flip equation"),this.priority=1,this.triggerType="tap",a&&(this.actor=a.actor)};ad.inherit(p,a),a.prototype.match=function(a){return a.is_group("equals")||F.is_inequality(a)},a.prototype.transform=function(a){var d=this.getNewTreeNode(this.actor);this.addTouchedNodes(b(this.actor)),this.addTouchedNodes(c(this.actor));var e=b(d),f=c(d);return e.remove(),f.remove(),d.insert(0,f),d.insert(2,e),F.is_inequality(d)&&d.invert(),"function"==typeof a&&a(this),this},G.prototype.add_action_handler(new a),F.prototype.add_action_handler(new a);var b=function(a){return a.children[0]},c=function(a){return a.children[2]};return new a}(),ad.actions.ImaginaryAssociateNegOneOutOfSqrtAction=function(){var a=function(a){p.call(this,"ImaginaryAssociateNegOneOutOfSqrtAction","calculate a power of an imaginary number"),this.priority=1,this.triggerType="drag",this.settings={side:"outside"},a&&(this.nodes=a.nodes,this.target=a.target)};return ad.inherit(p,a),a.prototype.getAllAvailableActions=function(a){var b=this.matchSource(a);if(!b)return[];var c=this.getTargets(b);return this.bindActionForEachTarget(a,c)},a.prototype.matchSource=function(a){if(1!==a.length)return!1;var b=a[0];return!!D.is_equal_to(b,-1)&&(!!this.withinSqrt(b.parent)&&{nodes:a,power:b.get_parent(2)})},a.prototype.getTargets=function(a){return[a.nodes[0].parent]},a.prototype.withinSqrt=function(a){return a.is_group("brackets")&&a.parent.is_group("power")&&a.parent.is_square_root()},a.prototype.transform=function(a){this.addTouchedNodes(this.nodes);var b=this.getNewTreeNode(this.nodes)[0],c=b.get_parent(2),d=c.parent,e=this.getOldTreeNode(c),f=c.remove(),g=new M("i");if(d.insert(f,g),this.updateNodeMap(e.get_mapping_to(g)),this.cleanup_cascade(d),"function"!=typeof a)return!0;a(this)},new a}(),Id.prototype.move_actions.push(ad.actions.ImaginaryAssociateNegOneOutOfSqrtAction),ad.actions.ImaginaryAssociateOutOfSqrtAction=function(){var a=function(a){p.call(this,"ImaginaryAssociateOutOfSqrtAction","calculate a power of an imaginary number"),this.priority=1,this.triggerType="drag",this.settings={target_group:!0,group_side:"outside",margin:{x:-.1,y:-.1}},a&&(this.nodes=a.nodes,this.target=a.target,this.settings.side=a.side)};return ad.inherit(p,a),a.prototype.getAllAvailableActions=function(a){var b=this.matchSource(a);if(!b)return[];var c=this.getTargets(b);return this.bindActionForEachTarget(a,c,!0)},a.prototype.matchSource=function(a){if(1!==a.length)return!1;var b=a[0];return!!D.is_equal_to(b.children[1],-1)&&(!(!b.parent.parent||!this.withinSqrt(b.get_parent(2)))&&{nodes:a,group:b.parent,power:b.get_parent(3)})},a.prototype.getTargets=function(a){return[a.group]},a.prototype.withinSqrt=function(a){return a.is_group("brackets")&&a.parent.is_group("power")&&a.parent.is_square_root()},a.prototype.transform=function(a){this.addTouchedNodes(this.nodes);var b=this.getNewTreeNode(this.nodes)[0],c=b.parent,d=c.get_parent(2),e=d.parent,f=d.remove(),g=new I;b.remove();var h=b.children[1],i=new M("i");if(h.replace_with(i),this.updateNodeMap(this.nodes[0].children[1].get_mapping_to(i)),b.is_group("div")&&b.invert(),g.append(new K(d)),g.insert("left-of"===this.settings.side?0:1,b),e.insert(f,g),this.cleanup(c),this.cleanup_cascade(e),"function"!=typeof a)return!0;a(this)},new a}(),Id.prototype.move_actions.push(ad.actions.ImaginaryAssociateOutOfSqrtAction),ad.actions.ImaginaryEvaluateIntegerPowerAction=function(){var a=function(a){p.call(this,"ImaginaryEvaluateIntegerPowerAction","calculate a power of an imaginary number"),this.priority=1,this.triggerType="tap",a&&(this.actor=a.actor)};ad.inherit(p,a),a.prototype.match=function(a){var b=a.get_parent(1);if(!b.is_group("power"))return!1;var c=b.children[0];if(!M.is_constant(c)||"i"!==c.value)return!1;var d=b.get_child([1,0]);d.is_group("brackets")&&d.children[0].hidden&&(d=d.children[1]);var e=D.get_value(d);return!isNaN(e)&&Math.round(e)===e},a.prototype.transform=function(a){this.addTouchedNodes(this.actor.parent);var b=this.getNewTreeNode(this.actor),c=(this.actor.get_parent(1),b.parent),d=c.children[0],e=b.children[0];e.is_group("brackets")&&(e=e.children[1]);var f=D.get_value(e);d.remove();var g=this.getEvaluateBase(d,f);if(c.replace_with(g),"function"!=typeof a)return!0;a(this)},a.prototype.getEvaluateBase=function(a,b){var c,d=b%4;return 0===d?c=new D(1):-3===d||1===d?c=a:-2===d||2===d?c=new D(-1):-1!==d&&3!==d||(c=new Q(a)),c};var b=new a;return N.prototype.add_action_handler(b),b}(),ad.actions.ImaginarySqrtOfNegativeOneAction=function(){var a=function(a){p.call(this,"ImaginarySqrtOfNegativeOneAction","calculate a power of an imaginary number"),this.priority=0,this.triggerType="tap",a&&(this.actor=a.actor)};ad.inherit(p,a),a.prototype.match=function(a){if(a.is_group("radical")&&D.is_equal_to(a.get_radicand(),-1))return!0;var b=a.get_parent(1);if(!b.is_group("power"))return!1;var c=b.children[0];if(!c.is_group("brackets"))return!1;var d=D.get_value(c.children[1]);return!isNaN(d)&&-1===d&&!!D.is_equal_to(b.get_child([1,0]),.5)},a.prototype.transform=function(a){if(this.actor.is_group("radical")){this.addTouchedNodes(this.actor);var b=this.actor,c=this.getNewTreeNode(this.actor),d=c.parent,e=c.remove()}else{this.addTouchedNodes(this.actor.parent);var b=this.actor.parent,f=this.getNewTreeNode(b),d=f.parent,e=f.remove()}var g=new M("i");if(d.insert(e,g),this.cleanup_cascade(d),this.updateNodeMap(b.get_mapping_to(g)),"function"!=typeof a)return!0;a(this)};var b=new a;return C.prototype.add_action_handler(b),N.prototype.add_action_handler(b),b}(),ad.actions.GreatestCommonFactorAction=function(){var a=function(a){p.call(this,"GreatestCommonFactorAction","find the greatest common factor between two terms"),this.priority=0,this.triggerType="drag",this.settings={delay:1e3,side:"inside",reset_x:!0,reset_y:!0},a&&(this.nodes=a.nodes,this.target=a.target)};return ad.inherit(p,a),a.prototype.getAllAvailableActions=function(a){var b=a[0];if(1!==a.length)return[];if(!b.is_group("add","sub","mul","div"))return[];var c,d,e;if(b.is_group("add","sub"))c=b.get_parent(1),d=b.get_idx(),e=!1;else{var f=sa(b);if(!f)return[];c=f.ancestor_sum,d=f.addsub_idx,e=b.is_group("div")}var g=[];c.children.forEach(function(a,b){b!==d&&(g=g.concat(this.getPotentialTargets(a,e)))},this);var h=[];return g.forEach(function(a){this.matchTarget(b,a)&&h.push(a)},this),this.bindActionForEachTarget(a,h)},a.prototype.getPotentialTargets=function(a,b,c){var d=[],e=a.get_child([1]);if(e.is_group("product")&&!c)e.children.forEach(function(a){d=d.concat(this.getPotentialTargets(a,b))},this);else if(e.is_group("fraction")&&!c){var f=b?e.get_bottom():e.get_top();f.forEach(function(a){d=d.concat(this.getPotentialTargets(a,b,!0))},this)}else!c&&b||d.push(a);return d},a.prototype.matchTarget=function(a,b){var c=a.get_child([1]),d=b.get_child([1]),e=c.is_group("sign"),f=d.is_group("sign");return e&&(c=c.get_child([1])),f&&(d=d.get_child([1])),c.to_ascii()!==d.to_ascii()&&(!!this.matchNumberMultiples(c,d)||(!!this.matchPowers(c,d)||!!(e&&f&&this.matchUnidenticalInnerTerms(c,d))))},a.prototype.matchNumberMultiples=function(a,b){return!(!D.is_num(a)||!D.is_num(b))&&(!(!D.get_value(a)||!D.get_value(b))&&!!va(a,b))},a.prototype.matchPowers=function(a,b){return!(!a.is_group("power")&&!b.is_group("power"))&&!!H.haveSameBase(a,b)},a.prototype.matchUnidenticalInnerTerms=function(a,b){return ra(a).to_ascii()!==ra(b).to_ascii()},a.prototype.transform=function(a){this.addTouchedNodes(this.nodes),this.addTouchedNodes(this.target);for(var b=this.nodes[0],c=this.target,d=this.getNewTreeNode(b),e=this.getNewTreeNode(c),f=d;!f.parent.is_group("sum");)f=f.parent;for(var g=e;!g.parent.is_group("sum");)g=g.parent;var h=f.get_idx()>g.get_idx(),i=d.get_child([1]),j=e.get_child([1]),k=i.is_group("sign"),l=j.is_group("sign");k&&(i=i.get_child([1])),l&&(j=j.get_child([1]));var m;if(D.is_num(i)&&D.is_num(j)&&va(i,j))m=this.factorizeNumbers(b,d,c,e,h);else if(this.matchPowers(i,j))m=this.factorizePowers(b,d,c,e,h);else{if(!k||!l)throw"(GreatestCommonFactorAction) There is a case mis-match between the match and transform functions.";m={matching_nodes_factor:this.splitNegativeFromNode(b,d,h),matching_target_factor:this.splitNegativeFromNode(c,e,h)},this.setNodesToReselectAfterAction(m.matching_nodes_factor)}if(od.get("factor_after_finding_gcf")&&(this.followup=ad.actions.FactorCommonTermsAction.createBoundAction(this.newTree,{nodes:[m.matching_nodes_factor],target:[m.matching_target_factor]})),"function"!=typeof a)return!0;a(this)},a.prototype.splitNegativeFromNode=function(a,b,c){var d=a.get_child([1]),e=b.get_child([1]);if(!e.is_group("sign"))throw"Expected term to be 'sign', but was "+e.to_ascii();e=e.replace_with(e.children[1]);var f=e.remove(),g=new I,h=new Q(new D(1)),i=new K(h),j=new K(e);return g.append(j),g.insert(c?0:1,i),b.insert(f,g),this.extendNodeMap(d.children[1].get_mapping_to(e)),this.cleanup_cascade(b),i},a.prototype.factorizeNumbers=function(a,b,c,d,e){var f,g,h=b.get_child([1]),i=d.get_child([1]),j=D.get_value(h),k=D.get_value(i);if(ta(j,k)){var l=j/k,m=k,f=this.splitIntoFactors(a.get_child([1]),h,l,m,e).factor2.parent;this.setNodesToReselectAfterAction(f),g=d}else if(ta(k,j)){var l=k/j,m=j;f=b,g=this.splitIntoFactors(c.get_child([1]),i,l,m,e).factor2.parent}else{var n=ua(j,k);f=this.splitIntoFactors(a.get_child([1]),h,n,j/n,e).factor1.parent,g=this.splitIntoFactors(c.get_child([1]),i,n,k/n,e).factor1.parent,this.setNodesToReselectAfterAction(f)}return{matching_nodes_factor:f,matching_target_factor:g}},a.prototype.splitIntoFactors=function(a,b,c,d,e){var f=b.parent,g=b.remove(),h=new I,i=new D(c),j=new D(d),k=new K(i),l=new K(j);return h.append(l),h.insert(e?0:1,k),f.insert(g,h),this.mapNumber(a,i),this.mapNumber(a,j,!0),this.cleanup_cascade(f),{factor1:i,factor2:j}},a.prototype.mapNumber=function(a,b,c){var d=c?this.extendNodeMap.bind(this):this.updateNodeMap.bind(this);!a.is_group("sign")&&b.is_group("sign")?d(a,b.get_child([1])):a.is_group("sign")&&!b.is_group("sign")?d(a.get_child([1]),b):d(a.get_mapping_to(b))},a.prototype.factorizePowers=function(a,b,c,d,e){var f=b.children[1],g=a.children[1],h=d.children[1],i=c.children[1];f.is_group("sign")&&(f=f.children[1],g=g.children[1]),h.is_group("sign")&&(h=h.children[1],i=i.children[1]);var j,k,l=H.getNumericalValueOfExponent(f),m=H.getNumericalValueOfExponent(h);if(f.is_group("power"))if(h.is_group("power"))l>m?(k=d,j=this.splitPower(g,f,i,h,e),this.setNodesToReselectAfterAction(j)):(j=b,k=this.splitPower(i,h,g,f,e));else{k=d;var j=this.splitOffBase(g,f,e);this.setNodesToReselectAfterAction(j)}else k=this.splitOffBase(i,h,e),j=b;return{matching_nodes_factor:j,matching_target_factor:k}},a.prototype.splitOffBase=function(a,b,c){var d=b.parent.is_group("sign")?b.parent:null;d&&d.replace_with(b);var e=new I;b.replace_with(e);var f=new K(b.children[0].clone());this.extendNodeMap(a.children[0].get_mapping_to(f.children[1])),e.append(new K(b)),e.insert(c?0:1,f);var g=b.get_exponent_term();if(!g.is_group("sum")){var h=g.parent,i=g.remove(),j=new t;j.append(new u(g)),h.insert(i,j),w.handle(j),g=j}var k=new u(new D(1),"sub");if(g.append(k),this.applyInnerAction("AddSubNumbersAction",{actor:k})){var l=g.children[g.children.length-1];0===D.get_value(l)&&(l.remove(),this.cleanup(g))}else this.applyInnerAction("AddSubCombineSigns",{actor:k.ls});return 1===b.get_exponent_value()&&(b=b.replace_with(b.children[0])),d&&(b.replace_with(d),d.append(b)),this.cleanup(e.parent),f},a.prototype.splitPower=function(a,b,c,d,e){var f=b.parent.is_group("sign")?b.parent:null;f&&f.replace_with(b);var g=new I;b.replace_with(g);var h=new K(d.clone());this.extendNodeMap(a.children[0].get_mapping_to(h.children[1].children[0])),this.extendNodeMap(c.children[1].get_mapping_to(h.children[1].children[1])),g.append(new K(b)),g.insert(e?0:1,h);var i=b.get_exponent_term();if(!i.is_group("sum")){var j=i.parent,k=i.remove(),l=new t;l.append(new u(i)),j.insert(k,l),w.handle(l),i=l}var m=d.get_exponent_term(),n=new u(m.clone(),"sub");return this.extendNodeMap(c.get_exponent_term().get_mapping_to(n.children[1])),i.append(n),this.cleanup(n),2===i.children.length&&this.applyInnerAction("AddSubNumbersAction",{actor:n})?this.extendNodeMap(a.children[1].get_mapping_to(h.children[1].children[1])):(this.applyInnerAction("AddSubCombineSigns",{actor:n.ls}),this.applyInnerAction("AddSubCombineSigns",{actor:n})),1===b.get_exponent_value()&&(b=b.replace_with(b.children[0])),f&&(b.replace_with(f),f.append(b)),this.cleanup(g.parent),h},new a}(),Id.prototype.move_actions.push(ad.actions.GreatestCommonFactorAction),ad.actions.FactorCommonTermsAction=function(){function a(a){return 1===a.get_top().length&&0===a.get_bottom().length&&1===D.get_value(a.children[0].children[1])}var b=function(a){p.call(this,"FactorCommonTermsAction","factor out matching term ranges"),this.priority=0,this.triggerType="drag",this.settings={delay:600,side:"inside",reset_x:!0,reset_y:!0},this.initSettings(a)};return ad.inherit(p,b),b.prototype.getAllAvailableActions=function(a){if(a[0].is_group("add","sub")&&1!==a.length)return[];if(a[0].is_group("mul","div")&&!_c.is_range(a))return[];var b,c,d;if(a[0].is_group("add","sub"))b=a[0].get_parent(1),c=a[0].get_idx(),d=!1;else{var e=sa(a[0]);if(!e)return[];b=e.ancestor_sum,c=e.addsub_idx,d=a[0].is_group("div")}var f=this.getAsciiRangeFromNodes(a),g=[];return b.children.forEach(function(a,b){b!==c&&(g=g.concat(this.getMatchingTargetRanges(a,f,d)))},this),this.bindActionForEachRange(a,g)},b.prototype.rematch=function(){var a=this;return!(!this.nodes||!this.target)&&(!!this.getAllAvailableActions(this.nodes).some(function(b){return ad.array.equals(b.target,a.target)})||this.nodes.length>0&&this.target.length>0&&1===this.nodes.length&&D.is_num(this.nodes[0].children[1]))},b.prototype.getAsciiRangeFromNodes=function(a){var b=[];if(1===a.length&&a[0].is_group("add","sub")){for(var c=a[0].get_child([1]);c.is_group("sign");)c=c.get_child([1]);c.is_group("product")?c.children.forEach(function(a){b.push(ra(a.get_child([1])).to_ascii())},this):b.push(c.to_ascii())}else a.forEach(function(a){b.push(ra(a.get_child([1])).to_ascii())},this);return b},b.prototype.bypassNegatives=function(a){for(;a.is_group("sign");)a=a.get_child([1]);return a},b.prototype.getMatchingTargetRanges=function(a,b,c){var d=[],e=a.get_child([1]);return this.rangeAsciisMatch(b,[ra(e).to_ascii()])&&d.push([a]),e.is_group("product")&&(c||(d=d.concat(this.matchRangeOfOperators(e.children,b))),e.children.forEach(function(a){var e=a.get_child([1]);e=ra(e),e.is_group("fraction")&&(d=d.concat(this.getMatchingTargetRangesFromFraction(e,b,c)))},this)),e.is_group("fraction")&&(d=d.concat(this.getMatchingTargetRangesFromFraction(e,b,c))),d},b.prototype.getMatchingTargetRangesFromFraction=function(a,b,c){return c?this.matchRangeOfOperators(a.get_bottom(),b):this.matchRangeOfOperators(a.get_top(),b)},b.prototype.matchRangeOfOperators=function(a,b){var c=[],d=b.length,e=a.map(function(a){return ra(a.get_child([1])).to_ascii()},this);if(a.length===d&&this.rangeAsciisMatch(b,e)&&a[0].get_parent(1).is_group("product"))return[[a[0].get_parent(2)]];for(var f=0;f<a.length-d+1;f++){var g=e.slice(f,f+d);this.rangeAsciisMatch(b,g)&&c.push(a.slice(f,f+d))}return c},b.prototype.rangeAsciisMatch=function(a,b){if(a.length!==b.length)return!1;for(var c=0;c<a.length;c++)if(a[c]!==b[c])return!1;return!0},b.prototype.bindActionForEachRange=function(a,b){var c=a[0].get_root();return b.map(function(b){return this.createBoundAction(c,{nodes:a,target:b})},this)},b.prototype.transform=function(a){this.addTouchedNodes(this.nodes),this.addTouchedNodes(this.target);var b=this.nodes,c=this.target,d=this.analyzeOldStructure(b),e=this.analyzeOldStructure(c),f=this.getNewTreeNode(c),g=this.getNewTreeNode(b);g[0].is_group("add","sub")&&(g=this.insertCoefficientOfOneIntoAddend(g)),f[0].is_group("add","sub")&&(f=this.insertCoefficientOfOneIntoAddend(f));var h=this.analyzeStructure(g),i=this.analyzeStructure(f);h.left_of_target=h.idx_of_addend<i.idx_of_addend;var j=this.stripNegatives(h),k=this.stripNegatives(i);this.nodesProductIsInMidFactoring(h)?(h.addend.remove(),h.sum_of_coefficients=h.left_of_target?h.product.get_child([0,1,1]):h.product.get_child([h.product.children.length-1,1,1])):h=this.reinterpretNodesStructureForFactoring(h),this.reinterpretTargetStructureForMergingWithNodes(i),this.insertTargetCoefficientsIntoCoefficientsSum(i,h),i.sum.insert(h.left_of_target?i.idx_of_addend-1:i.idx_of_addend,h.addend),this.reapplyNegatives(g,d,h,e,i,j,k),this.mapOldTargetFactorsToNewFactors(e,g);var l=[{node:b[0],node_no_neg:ra(b[0].children[1])},{node:c[0],node_no_neg:ra(c[0].children[1])}];if(g.length>1||f.length>1||h.range.length>1||i.range.length>1||l[0].node_no_neg.to_ascii()===l[1].node_no_neg.to_ascii()||function(){l.forEach(function(a){return a.val=Id.get_numeric_value(a.node.children[1])});var a=Math.abs(l[1].val)>Math.abs(l[0].val)?1:0,b=Math.abs(l[1-a].val/l[a].val),c=h.sum_of_coefficients;h.left_of_target?(l[0].addends=c.children.slice(0,c.children.length-1),l[1].addends=[c.children[c.children.length-1]]):(l[0].addends=c.children.slice(1),l[1].addends=[c.children[0]]);var d=h.range[0];d=d.children[1].is_group("product")?d.get_child([1,0,1]):d.children[1].is_group("fraction")?d.get_child([1,1,1]):d.children[1];var e=l[a].val;d.is_group("sign")?d.children[1].value=Math.abs(e):d.value=Math.abs(e),l[1-a].addends.forEach(function(a){return Ia(a,b,g[0].is_group("div"))})}(),this.cleanupTermsInCoefficientsSum(h),this.cleanupTermsInProductOfCoefficentsSumAndVariables(h),this.cleanup_cascade(i.sum),this.setNodesToReselectAfterAction(g[0].children[1]?g:h.range),"function"!=typeof a)return!0;a(this)},b.prototype.analyzeOldStructure=function(a){function b(a){for(;a.is_group("sign");)d.push(a),a=a.get_child([1]);e.push(a)}var c,d=[],e=[];if(a[0].is_group("add","sub")){c=a[0];var f=a[0].get_child([1]);f.is_group("product")?f.children.forEach(function(a){b(a.get_child([1]))}):b(f)}else{for(c=a[0];!c.is_group("add","sub");)c=c.get_parent(1);a.forEach(function(a){b(a.get_child([1]))})}return{addend:c,negative_groups:d,factors:e}},b.prototype.insertCoefficientOfOneIntoAddend=function(a){for(var b=a[0];!b.is_group("add","sub");)b=b.get_parent(1);var c=b.get_child([1]);c.remove();var d=K.prototype.createParentGroup();return d.append(new K(new D(1))),d.append(new K(c)),b.append(d),this.cleanup(d.get_child([1])),d.children.slice(1)},b.prototype.analyzeStructure=function(a){var b={};b.range=a;var c=a[0];if(c.parent.is_group("product"))b.product=c.get_parent(1),b.addend=b.product.get_parent(1);else{if(!c.get_parent(1).is_group("fraction"))throw"Can't identify structure for direct factoring.";b.fraction=c.get_parent(1),b.fraction.get_parent(1).is_group("mul")?(b.product=b.fraction.get_parent(2),b.addend=b.product.get_parent(1)):b.addend=b.fraction.get_parent(1)}return b.sum=b.addend.get_parent(1),b.idx_of_addend=b.sum.children.indexOf(b.addend),b},b.prototype.stripNegatives=function(a){var b=0;return a.addend.is_group("sub")&&(a.addend.invert(),b++),a.range.forEach(function(a){for(var c=0,d=a.get_child([1]);d.is_group("sign");)d=d.get_child([1]),c++;c&&(a.get_child([1]).remove(),d.remove(),a.append(d)),b+=c},this),b},b.prototype.nodesProductIsInMidFactoring=function(a){if(a.fraction)return!1;if(a.addend.is_group("sub"))return!1;var b=a.product.get_child([0,1]),c=a.product.get_last_child().children[1];return(!a.left_of_target||-1===a.range.indexOf(b.parent))&&(!(!a.left_of_target&&-1!==a.range.indexOf(c.parent))&&(!(!(b.is_group("brackets")&&b.children[1].is_group("sum")||!a.left_of_target)||!(c.is_group("brackets")&&c.children[1].is_group("sum")||a.left_of_target))&&a.product.children.length-1===a.range.length))},b.prototype.reinterpretNodesStructureForFactoring=function(a){return a.range.forEach(function(a){a.remove()}),this.rearrangeStructure(a)},b.prototype.rearrangeStructure=function(a){var b=K.prototype.createParentGroup();a.range.forEach(function(a){b.append(a)});var c=new K(b);this.cleanupProductOfCoefficients(a);var d=u.prototype.createParentGroup();a.addend.remove(),a.addend.dragging=!1,a.addend.selected=!1,d.append(a.addend);var e=a.addend.get_idx(),f=new w(d),g=K.prototype.createParentGroup();a.left_of_target?(g.append(new K(f)),g.append(c)):(g.append(c),g.append(new K(f)));var h=new u(g),i={};return i.idx_of_addend=e,i.addend=h,i.product=g,i.sum_of_coefficients=d,i.left_of_target=a.left_of_target,i.range=[c],i},b.prototype.cleanupProductOfCoefficients=function(a){var b,c;a.fraction&&(b=a.fraction.parent,this.cleanup(a.fraction),b.is_group("mul")&&1===D.get_value(b.children[1])&&(b.remove(),c=!0)),a.product&&(b&&!c&&this.cleanup(b),this.cleanup(a.product))},b.prototype.reinterpretTargetStructureForMergingWithNodes=function(b){b.addend.remove(),b.range.forEach(function(a){a.remove()});var c=b.fraction;c&&a(c)&&c.parent.is_group("mul")&&c.parent.remove()},b.prototype.insertTargetCoefficientsIntoCoefficientsSum=function(a,b){b.left_of_target?b.sum_of_coefficients.append(a.addend):b.sum_of_coefficients.insert(0,a.addend)},b.prototype.reapplyNegatives=function(a,b,c,d,e,f,g){if(f%2==1&&g%2==1){var h=a[0],i=h.get_child([1]);i.remove(),i=new Q(i),h.append(i),b.addend.is_group("sub")?this.extendNodeMap(b.addend.get_child([0]),i.get_child([0])):b.negative_groups.forEach(function(a,b){0===b&&this.updateNodeMap(a.get_child([0]),i.get_child([0]))},this),d.addend.is_group("sub")?this.extendNodeMap(d.addend.get_child([0]),i.get_child([0])):d.negative_groups.forEach(function(a,b){0===b&&this.updateNodeMap(a.get_child([0]),i.get_child([0]))},this)}else if(f!==g&&Math.abs(f-g)%2==1){var j=c.left_of_target?c.sum_of_coefficients.children.length-1:0,k=c.sum_of_coefficients.get_child([j]);f>g?c.sum_of_coefficients.children.forEach(function(a,c){c!==j&&(a.invert(),b.addend.is_group("sub")?this.extendNodeMap(b.addend.get_child([0]),a.get_child([0])):b.negative_groups.forEach(function(b,c){0===c&&this.extendNodeMap(b.get_child([0]),a.get_child([0]))},this))},this):(k.invert(),d.addend.is_group("sub")?this.updateNodeMap(d.addend.get_child([0]),k.get_child([0])):d.negative_groups.forEach(function(a,b){0===b&&this.updateNodeMap(a.get_child([0]),k.get_child([0]))},this))}},b.prototype.mapOldTargetFactorsToNewFactors=function(a,b){a.factors.forEach(function(a,c){this.updateNodeMap(a.get_mapping_to(ra(b[c].children[1])))},this)},b.prototype.cleanupTermsInCoefficientsSum=function(a){for(var b=a.sum_of_coefficients,c=0;c<b.children.length;c++){var d=b.get_child([c,1]);d.is_group("product")&&d.children.forEach(function(a){var b=a.get_child([1]);b.is_group("fraction")&&this.cleanup(b)},this),this.cleanup(d)}for(var c=0;c<b.children.length;c++){var d=b.get_child([c]);w.handle(d,!0),this.cleanup(d)}},b.prototype.cleanupTermsInProductOfCoefficentsSumAndVariables=function(a){for(var b=a.product,c=0;c<b.children.length;c++)this.cleanup(b.children[c].children[1]);for(var c=0;c<b.children.length;c++)this.cleanup(b.children[c])},new b}(),Id.prototype.move_actions.push(ad.actions.FactorCommonTermsAction),ad.actions.FlipTermAction=function(){var a=function(a){p.call(this,"FlipTermAction","flip a term into a denominator"),this.priority=0,this.triggerType="drag",this.settings={delay:1500,on_release:!0,side:"below",reset_y:!0,margin:{y1:.1,y2:-.25}},a&&(this.nodes=a.nodes,this.target=a.target)};return ad.inherit(p,a),a.prototype.getAllAvailableActions=function(a){return this.matchSource(a)?this.bindActionForEachTarget(a,a):[]},a.prototype.matchSource=function(a){if(1!==a.length)return!1;var b=a[0];return b.is_group("exponent","degree")?b=b.get_term():b.is_group("mul","div","add","sub")&&(b=b.children[1]),!b.is_group("equals","param")&&!F.is_inequality(b)&&(!od.get("flip_powers_only")||b.is_group("power"))},a.prototype.transform=function(a){this.addTouchedNodes(this.nodes);var b=this.getNewTreeNode(this.target);b.is_group("exponent","degree")&&(b=b.get_term()),b.is_group("mul","div","add","sub")&&(b=b.children[1]);var c=this.getTransformFunction(b);return this.replaceWithFlippedFraction(b,c.bind(this)),"function"==typeof a&&a(this),this},a.prototype.getTransformFunction=function(a){return a.is_group("power")?this.flipPower:a.is_group("radical")?this.flipRadical:a.is_group("fraction")?this.flipFraction:D.is_equal_to(a,1,-1)?this.flipIdentity:a.is_group("plusminus")&&1===D.get_value(a,!0)?this.flipIdentity:this.flipTerm},a.prototype.replaceWithFlippedFraction=function(a,b){var c=a.get_parent(1),d=a.remove(),e=new I;e.append(new K(new D(1)));var f=b(a),g=new K(f,"div");e.append(g),this.setNodesToReselectAfterAction(g),c.insert(d,e),this.cleanup(g.children[1]),w.handle(e)},a.prototype.flipIdentity=function(a){return a},a.prototype.flipPower=function(a){return this.flipExponent(a.get_child([1])),a},a.prototype.flipRadical=function(a){return this.flipExponent(a.get_degree()),a},a.prototype.flipExponent=function(a){var b=a.get_child([0]);w.areHidden(b)&&(b=b.children[1]),b.is_group("product")&&(b=b.get_child([0,1])),this.makeTermNegative(b),w.handle(a.children[0],!0),D.is_equal_to(a.get_term(),1)&&a.remove()},a.prototype.makeTermNegative=function(a){if(a.is_group("sum"))a.children.forEach(function(a){a.invert()});else if(a.is_group("sign"))a.replace_with(a.get_child([1]));else{var b=a.get_parent(1),c=a.remove(),d=new Q(a);b.insert(c,d)}},a.prototype.flipFraction=function(a){var b=a.get_top(),c=a.get_bottom();return _c.remove_range(b),_c.remove_range(c),c.forEach(function(b){b.invert(),a.append(b)}),b.forEach(function(b){b.invert(),a.append(b)}),a},a.prototype.flipTerm=function(a){var b=this.convertToEquivalentPowerForm(a);return this.flipPower(b)},a.prototype.convertToEquivalentPowerForm=function(a){return new H(a,new D(1))},new a}(),Id.prototype.move_actions.push(ad.actions.FlipTermAction),ad.actions.FlipTermAcrossFractionAction=function(){var a=function(a){p.call(this,"FlipTermAcrossFractionAction","flip a term into a denominator"),this.priority=1,this.triggerType="drag",this.settings={delay:1500,reset_y:!0,target_group:!0,group_side:"around"},a&&(this.nodes=a.nodes,this.target=a.target,this.settings.side=a.side)};return ad.inherit(p,a),a.prototype.getAllAvailableActions=function(a){var b=this.matchSource(a);if(!b)return[];var c=this.getTargets(b);return this.adjustTargetBoxes(this.bindActionForEachTarget(a,c,!0))},a.prototype.matchSource=function(a){if(!_c.is_range(a))return!1;var b=a[0];if(!b.is_group("mul","div")||!b.parent.is_group("fraction"))return!1;var c=b.children[1];return!(1===D.get_value(c)&&b.is_group("mul")&&!b.ls&&b.rs&&"//"===b.rs.value)&&{nodes:a,frac:a[0].parent}},a.prototype.getTargets=function(a){return a.nodes[0].is_group("mul")?a.frac.get_bottom():a.frac.get_top()},a.prototype.adjustTargetBoxes=function(a){return a.forEach(function(a){a.target.is_group("div")?a.settings.margin={y1:.3}:a.settings.margin={y2:.3}},this),a},a.prototype.transform=function(a){this.addTouchedNodes(this.nodes);var b=this.getNewTreeNode(this.nodes),c=this.getNewTreeNode(this.target),d=b[0].get_parent(1);if(_c.remove_range(b),b[0].is_group("div")){var e=d.get_top();1===e.length&&1===D.get_value(e[0].get_child([1]))&&e[0].remove()}b.forEach(function(a){var b=a.get_child([1]),c=ad.actions.FlipTermAction.getTransformFunction(b).bind(ad.actions.FlipTermAction);b.remove(),b=c(b),a.append(b),a.invert()},this);var f=-1===c.get_idx()?0:c.get_idx()+("right-of"===this.settings.side?1:0);d.insert_range(f,b);var g=!1;return b.forEach(function(a){g=g||this.cleanup_cascade(a.children[1])},this),g||this.cleanup_cascade(d),"function"==typeof a&&a(this),this},new a}(),Id.prototype.move_actions.push(ad.actions.FlipTermAcrossFractionAction),Sd=function(a){function b(a){id(this,b);var c=pd(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,"FractionMatchExtendAction","associative property of multiplication--move into fraction"));if(c.priority=0,c.triggerType="drag",c.settings={delay:1500,on_release:!1,target_group:!0,no_target_box_expansion:!0},a){var d={side:"around"},e=b.getDestinationHints(a);c.initSettings(ad.extend(a,{drop_area_hint:d,destination_hint:e}))}return c}return qd(b,a),jd(b,[{key:"bindActionForEachTarget",value:function(a,b){var c=this,d=[],e=a[0].get_root();return b.forEach(function(b){d.push(c.createBoundAction(e,{nodes:a,target:b,side:"left-of"})),d.push(c.createBoundAction(e,{nodes:a,target:b,side:"right-of"}))}),d}},{key:"getAllAvailableActions",value:function(a){var b=Ja(a);if(!b)return[];var c=Ka(b);return this.bindActionForEachTarget(a,c,!0)}},{key:"transform",value:function(a){var b=this,c=this.getSourceAndTarget(!0);this.addTouchedNodes(c.source),this.addTouchedNodes(c.target);var d=this.getNewTreeNode(c.source),e=this.getNewTreeNode(c.target),f=d.map(function(a){return new K(a.children[1].clone())}),g=d.map(function(a){return new K(a.children[1].clone(),"div")});c.source.forEach(function(a,c){b.extendNodeMap(a.get_mapping_to(f[c])),b.extendNodeMap(a.get_mapping_to(g[c]))}),this.setNodesToReselectAfterAction(f.concat(g));var h=null;e.is_group("fraction")?h=e:(h=new I,e.replace_with(h),h.append(new K(e)),this.cleanup(h.children[0]));var i=h.get_top(),j=h.get_bottom();if(1===i.length&&D.is_equal_to(i[0].children[1],1)&&i[0].remove(),1===j.length&&D.is_equal_to(j[0].children[1],1)&&j[0].remove(),"left-of"===this.settings.side?(h.insert_range(0,f),h.insert_range(0,g,!0)):(h.append_range(f),h.append_range(g,!0)),"function"!=typeof a)return!0;a(this)}}],[{key:"getDestinationHints",value:function(a){var b=a.target,c=a.side,d="left-of"===c;if(b.is_group("fraction")){var e=b.get_top(),f=b.get_bottom();return[{node:d?e[0]:e[e.length-1],side:c,margin:{y:.1}},{node:d?f[0]:f[f.length-1],side:c,margin:{y:.1}}]}return[{node:b,side:c,margin:{y:.2}},{node:b,side:"around",margin:{y1:1.1,y2:-.7,x:1}}]}}]),b}(p),Td=new Sd,ad.actions.FractionMatchExtendAction=Td,Id.prototype.move_actions.push(Td),ad.actions.SplitNumeratorAction=function(){var a=function(a){p.call(this,"SplitNumeratorAction","split numerator into new fractions with same denominators"),this.priority=-2,this.triggerType="drag",this.settings={margin:{y:.25}},a&&(this.nodes=a.nodes,this.target=a.target,this.settings.side=Array.isArray(this.target)?"around":a.side,this.settings.target_is_left="left-of"===a.side,this.settings.margin["right-of"===a.side?"x2":"x1"]=-1,this.settings.margin["right-of"===a.side?"x1":"x2"]=.2)};return ad.inherit(p,a),a.prototype.getAllAvailableActions=function(a){if(0===a.length)return[];var b=a[0];return b.parent&&b.parent.parent&&b.parent.parent.parent&&b.parent.parent.parent.parent&&b.is_group("add","sub","addsub")&&b.parent.parent.parent.is_group("mul")&&b.parent.parent.parent.parent.is_group("fraction")?b.parent.parent.parent.parent.get_top().length>1?[]:this.match(a,b.parent.parent.parent.parent)?[this.bindAction(a,"left-of"),this.bindAction(a,"right-of")]:[]:[]},a.prototype.bindAction=function(a,b){var c=a[0].get_root(),d=[];return this.fractionIsPartOfProduct(a)&&(d=this.getSiblingsOfFraction(a,b)),this.createBoundAction(c,{nodes:a,target:d.length>0?d:a[0].parent.parent.parent.parent,side:b})},a.prototype.fractionIsPartOfProduct=function(a){var b=a[0].parent;return b.parent&&b.parent.is_group("sum")},a.prototype.getSiblingsOfFraction=function(a,b){var c=a[0].parent,d=c.parent,e=d.parent;return"left-of"===b?e.children.slice(0,e.children.indexOf(d)):e.children.slice(e.children.indexOf(d)+1)},a.prototype.match=function(a,b){return 0!==a.length&&(a[0]&&a[0].is_group("add","sub","addsub")&&a[0].parent.parent.parent.parent===b&&b.is_group("fraction"))},a.prototype.transform=function(a){var b=this.getNewTreeNode(this.nodes);this.addTouchedNodes(this.nodes[0].parent.parent.parent.parent);var c=this.nodes[0].parent.parent.parent.parent.get_bottom(),d=this.nodes[0].parent.parent.parent.parent.children[1],e=b[0].parent.parent.parent.parent;_c.remove_range(b);var f=u.prototype.createParentGroup();e.replace_with(f),f.append(new u(e));var g=e.get_bottom(),h=new I;h.invert();var i=u.prototype.createParentGroup();i.append_range(b),h.insert(0,new K(i));for(var j=0;j<g.length;j++){var k=_c.clone(g[j]);h.append(k),this.extendNodeMap(c[j].get_mapping_to(k))}this.extendNodeMap(d,h.children[1]);var l=new u(h),m=this.settings.target_is_left;f.insert(m?0:1,l);var n=this.rearrangeSumIfNumeratorIsASingleTerm(f,0),o=this.rearrangeSumIfNumeratorIsASingleTerm(f,1);if(m&&!n||!m&&!o)for(var j=0;j<b.length;j++)this.updateNodeMap(b[j],l);var p=e.get_top(),q=h.get_top();if(1===p.length&&this.cleanup(p[0]),1===q.length&&this.cleanup(q[0]),this.cleanup(f.parent),w.handle(f),"function"!=typeof a)return!0;a(this)},a.prototype.rearrangeSumIfNumeratorIsASingleTerm=function(a,b){var c=a.children[b],d=c.children[1];if(1===d.children[0].children[1].children[1].children.length){var e=d.children[0].children[1].children[1],f=e.children[0],g=f.children[1],h=e.parent.parent;return e.parent.remove(),f.remove(),g.remove(),e.remove(),d.remove(),c.remove(),a.insert(b,f),f.append(d),h.append(g),!0}return!1},new a}(),Id.prototype.move_actions.push(ad.actions.SplitNumeratorAction),ad.actions.DivideRationalNumbersAction=function(){function a(a,b,c){c.updateNodeMap(a,b),c.updateNodeMap(a.children[0],b.children[0]),!a.children[1].is_group("sign")&&b.children[1].is_group("sign")?c.updateNodeMap(a.children[1].get_mapping_to(b.children[1].children[1])):c.updateNodeMap(a.children[1].get_mapping_to(b.children[1]))}var b=function(a){p.call(this,"DivideRationalNumbersAction","division of numbers"),this.triggerType="drag",this.priority=2,this.settings={delay:400,side:"inside"},a&&(this.nodes=a.nodes,this.target=a.target)};return ad.inherit(p,b),b.prototype.getAllAvailableActions=function(a){if(1!==a.length)return[];var b=a[0].parent.match("{n: \\NUM} / {d: \\NUM}");return b&&(this.isRational(b.n)||this.isRational(b.d))?a[0]!==b.d.parent?[]:[this.createBoundAction(a[0].get_root(),{nodes:a,target:b.n.parent})]:[]},b.prototype.isRational=function(a){return D.get_value(a)!==(0|D.get_value(a))},b.prototype.transform=function(b){this.old_dragged_term=this.nodes[0],this.old_target_term=this.target,this.addTouchedNodes(this.old_dragged_term),this.addTouchedNodes(this.old_target_term);var c=this.getNewTreeNode(this.old_dragged_term),d=this.getNewTreeNode(this.old_target_term),e=c.children[1],f=d.children[1],g=c.parent,h=D.get_value(f)/D.get_value(e);d.is_group("div")&&(h=1/h);var i=new K(new D(h),d.value);a(this.old_dragged_term,i,this),a(this.old_target_term,i,this);var j=d.remove();return g.insert(j,i),c.remove(),this.cleanup(g),"function"==typeof b&&b(this),this},new b}(),Id.prototype.move_actions.push(ad.actions.DivideRationalNumbersAction),ad.actions.FractionDivideToInteger=function(){var a=function(a){p.call(this,"FractionDivideToInteger","cancel numerator and denominator"),this.priority=1,this.triggerType="tap",a&&(this.actor=a.actor)};ad.inherit(p,a),a.prototype.match=function(a){var b=arguments.length<=1||void 0===arguments[1]||arguments[1],c=I.matchSource(a);if(!c)return!1;if(c.fraction.get_top().length>1)return!1;var d=D.get_value(c.mul.children[1]),e=D.get_value(c.div.children[1]);return!isNaN(d)&&!isNaN(e)&&0!==e&&(!b||e<=d&&d%e==0||0===d)},a.prototype.rematch=function(){return this.match(this.actor,!1)},a.prototype.transform=function(a){var b=I.getSourceAndTarget.call(this);this.addTouchedNodes(b.source.parent);var c=this.getNewTreeNode(b.source),d=this.getNewTreeNode(b.target),e=c.parent,f=e.parent,g=D.get_value(d.children[1])/D.get_value(c.children[1]),h=new D(g);d.children[1]instanceof Q||c.children[1]instanceof Q?(this.updateNodeMap(b.target.children[1].get_mapping_to(h)),this.updateNodeMap(b.source.children[1].get_mapping_to(h))):this.updateNodeMap(b.source.parent.get_mapping_to(h));var i=e.remove();if(f.insert(i,h),f.parent&&w.handle(f,!0),"function"!=typeof a)return!0;a(this)};var b=new a;return I.prototype.add_action_handler(b),K.prototype.add_action_handler(b),b}(),ad.actions.FractionDivideToNonInteger=function(){var a=function(a){p.call(this,"FractionDivideToNonInteger","cancel numerator and denominator"),this.priority=-1,this.triggerType="dbltap",a&&(this.actor=a.actor)};ad.inherit(p,a),a.prototype.match=function(a){if(od.get("only_integer_division"))return!1;var b=I.matchSource(a);if(!b)return!1;if(b.fraction.get_top().length>1)return!1;var c=D.get_value(b.mul.children[1]),d=D.get_value(b.div.children[1]);return!isNaN(c)&&!isNaN(d)&&0!==d&&!(d<=c&&c%d==0||0===c)},a.prototype.transform=function(a){var b=I.getSourceAndTarget.call(this);this.addTouchedNodes(b.source.parent);var c=this.getNewTreeNode(b.source),d=this.getNewTreeNode(b.target),e=c.parent,f=e.parent,g=D.get_value(d.children[1])/D.get_value(c.children[1]),h=new D(g);d.children[1]instanceof Q||c.children[1]instanceof Q?(this.updateNodeMap(b.target.children[1].get_mapping_to(h)),this.updateNodeMap(b.source.children[1].get_mapping_to(h))):this.updateNodeMap(b.source.parent.get_mapping_to(h));var i=e.remove();if(f.insert(i,h),f.parent&&w.handle(f,!0),"function"!=typeof a)return!0;a(this)};var b=new a;return I.prototype.add_action_handler(b),K.prototype.add_action_handler(b),b}(),ad.actions.IndexIdentityAction=function(){var a=function(a){p.call(this,"IndexIdentityAction","an index of 1 leaves the base unchanged"),this.priority=0,this.triggerType="tap",a&&(this.actor=a.actor)};ad.inherit(p,a),a.prototype.match=function(a){return!(!a.is_group("power")||!D.is_equal_to(a.children[1].children[0],1))||!(!a.is_group("radical")||!D.is_equal_to(a.children[0].children[0],1))},a.prototype.transform=function(a){this.addTouchedNodes(this.actor);var b=this.actor.is_group("power")?this.actor.children[1]:this.actor.children[0],c=this.getNewTreeNode(b),d=c.parent,e=d.is_group("power")?d.children[0]:d.get_radicand();if(d.replace_with(e),w.handle(e,!0),this.updateNodeMap(b.parent,e),this.updateNodeMap(b,e),this.updateNodeMap(b.children[0],e),"function"!=typeof a)return!0;a(this)};var b=new a;return H.prototype.add_action_handler(b),C.prototype.add_action_handler(b),b}(),ad.actions.IndexInvertAction=function(){var a=function(a){p.call(this,"IndexInvertAction","invert an index across an equation"),this.triggerType="drag",this.settings.side="around",a&&this.initSettings(a)};return ad.inherit(p,a),a.prototype.getAllAvailableActions=function(a){var b=this.matchSource(a);if(!b)return[];var c=this.getTargets(b);return this.bindActionForEachTarget(a,c)},a.prototype.matchSource=function(a){return 1===a.length&&(!!a[0].is_group("exponent","degree")&&(0!==D.get_value(a[0].children[0])&&(!(!a[0].parent.parent||!a[0].parent.parent.is_group("equals"))&&{nodes:a[0],idx_of_index_group:a[0].parent.get_idx(),equation:a[0].get_parent(2)})))},a.prototype.getTargets=function(a){return[a.equation.children[0===a.idx_of_index_group?2:0]]},a.prototype.transform=function(a){this.addTouchedNodes(this.nodes[0].get_root());var b=this.getSourceAndTarget(),c=this.getNewTreeNode(b.source),d=c.is_group("exponent")?c.parent.children[0]:c.parent.children[3],e=c.parent,f=this.getNewTreeNode(b.target);c.remove();var g=c.is_group("exponent")&&this.termIsEven(c.get_term()),h=this.wrapTermInIndexGroup(f,c,g);if(this.updateNodeMap(b.source,h),w.areHidden(d)&&w.handle(d,!0),this.cleanup(e),"function"!=typeof a)return!0;a(this)},a.prototype.termIsEven=function(a){var b=Id.evalExpression(a);return Number.isNaN(b)?$c?$c.eval(ad.termsToAlgebriteString(a)).toString()%2==0:null:b%2==0},a.prototype.wrapTermInIndexGroup=function(a,b,c){var d,e=a.parent,f=a.remove(),g=b.get_term();g.remove();var h;return b.is_group("exponent")&&Number.isInteger(D.get_value(g))&&D.get_value(g)>1?(d=new C(a,g),h=d.get_degree()):(d=new H(a,g),b.is_group("exponent")&&I.convert_to_reciprocal(g),w.handle(d.children[1].children[0],!0),h=d.children[1]),c&&(d=new Q(d,!0)),e.insert(f,d),h},new a}(),Id.prototype.move_actions.push(ad.actions.IndexInvertAction),ad.actions.IndexFormConversionAction=function(){var a=function(a){p.call(this,"IndexFormConversionAction","convert a power or radical to its other representation"),this.priority=0,this.triggerType="drag",this.settings={delay:1500,on_release:!0,reset_y:!0,no_target_box_expansion:!0},a&&(this.nodes=a.nodes,this.target=a.target,this.settings.side=this.target.is_group("radical")?"right-of":"left-of",this.settings.margin=this.target.is_group("radical")?{x2:-.4,y2:.7,y1:-.4}:{x1:-.4,y2:.5,y1:-.2})};return ad.inherit(p,a),a.prototype.getAllAvailableActions=function(a){return this.matchSource(a)?this.bindActionForEachTarget(a,[a[0].parent]):[]},a.prototype.matchSource=function(a){return 1===a.length&&(a[0].is_group("degree")||a[0].is_group("exponent"))},a.prototype.transform=function(a){this.addTouchedNodes(this.target);var b=this.getNewTreeNode(this.nodes)[0],c=b.parent,d=c.is_group("radical")?c.get_radicand():c.children[0],e=c.parent,f=c.remove();d.remove(),b.remove();var g=b.get_term();g.remove();var h=c.is_group("radical")?new N(g):new E(g);g=I.convert_to_reciprocal(g),w.handle(h.children[0],!0);var i=c.is_group("radical")?new H(d,h):new C(d,h);return e.insert(f,i),this.updateNodeMap(this.nodes[0],h),this.updateNodeMap(this.nodes[0].parent,i),"function"==typeof a&&a(this),this},new a}(),Id.prototype.move_actions.push(ad.actions.IndexFormConversionAction),ad.actions.IndexSimplifyAction=function(){var a=function(a){p.call(this,"IndexSimplifyAction","when the inverse index forms are nested and have the same index, they cancel"),this.settings={},this.interactionType="tap",a&&(this.actor=a.actor)};ad.inherit(p,a),a.prototype.match=function(a){if(!a.is_group("power"))return!1;var b=a.children[0];if(!b.is_group("brackets")||!b.children[1].is_group("radical"))return!1;var c=b.children[1].get_degree_term(),d=a.get_exponent_term();return c.to_ascii()===d.to_ascii()},a.prototype.match=function(a){var b,c;if(a.is_group("power")){var d=a.children[0];if(!d.is_group("brackets")||!d.children[1].is_group("radical"))return!1;b=d.children[1].get_degree_term(),c=a.get_exponent_term()}else if(a.is_group("radical")){var e=a.get_radicand();if(!e.is_group("power"))return!1;b=a.get_degree_term(),c=e.get_exponent_term()}return b&&c&&b.to_ascii()===c.to_ascii()},a.prototype.isGreaterOrEqualsZero=function(a){var b=Id.evalExpression(a);return Number.isNaN(b)?$c?"1"===(b=$c.run(ad.termsToAlgebriteString(a)+" >= 0"))||"0"!==b&&null:null:b>=0},a.prototype.getNumVal=function(a){var b=Id.evalExpression(a);return Number.isNaN(b)?$c?"1"===(b=$c.run(ad.termsToAlgebriteString(a)+" >= 0"))||"0"!==b&&null:null:b>=0},a.prototype.transform=function(a){this.addTouchedNodes(this.actor);var b=this.getNewTreeNode(this.actor),c=b.is_group("power")?b.get_child([0,1]):b.get_radicand(),d=c.is_group("power")?c.children[0]:c.get_radicand(),e=b.is_group("power")?b.get_exponent_term():b.get_degree_term(),f=Id.evalExpression(e),g=(Math.round(f),!isNaN(f));if(c.is_group("radical"))if(f%2==1)b.replace_with(d);else{var h=this.isGreaterOrEqualsZero(d);!1!==h&&b.replace_with(d),null===h&&g&&(this.settings.restraint=d.to_ascii()+"0")}else if(c.is_group("power"))if(f%2==0){b.replace_with(d);var h=this.isGreaterOrEqualsZero(d);if(!h){var i=d.parent,j=d.remove(),k=new B(d);i.insert(j,k)}}else if(f%2==1)b.replace_with(d);else{var h=this.isGreaterOrEqualsZero(d);!1!==h&&b.replace_with(d),null===h&&g&&(this.settings.restraint=d.to_ascii()+"0")}var l=d.is_group("brackets")?d.children[1]:d;if(w.handle(d,!0),this.cleanup(l.parent),"function"!=typeof a)return!0;a(this)};var b=new a;return C.prototype.add_action_handler(b),H.prototype.add_action_handler(b),b}(),ad.actions.SignDoubleNegAction=function(){var a=function(a){p.call(this,"SignDoubleNegAction","--x=x"),this.priority=0,this.triggerType="tap",a&&(this.actor=a.actor)};return ad.inherit(p,a),a.prototype.match=function(a){return!(!a.is_group("sign","plusminus")||!a.children[1].is_group("sign","plusminus"))||!(!a.is_group("sign","plusminus")||!a.parent.is_group("sign","plusminus"))},a.prototype.transform=function(a){var b=(this.getNewTreeNode(this.actor),this.actor.parent.is_group("sign","plusminus")?this.actor.parent:this.actor),c=this.actor.parent.is_group("sign","plusminus")?this.actor:this.actor.children[1],d=this.getNewTreeNode(b),e=this.getNewTreeNode(c),f=e.children[1];if(this.addTouchedNodes(b),this.addTouchedNodes(c),b.is_group("sign")&&c.is_group("sign")?_c.replace(d,f):d.is_group("plusminus")?(_c.replace(e,f),this.updateNodeMap(c,d)):e.is_group("plusminus")&&(_c.replace(d,e),this.updateNodeMap(b,e)),"function"!=typeof a)return!0;a(this)},Q.prototype.add_action_handler(new a),new a}(),Ud=function(a){function b(a){id(this,b);var c=pd(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,"SignInEvenPowerAction","remove a sign inside an even power"));return c.priority=0,c.triggerType="tap",a&&c.initSettings(a),c}return qd(b,a),jd(b,[{key:"match",value:function(a){return a.is_group("sign","plusminus")&&a.parent.is_group("brackets")&&H.hasEvenExponent(a.parent.parent)}},{key:"transform",value:function(a){this.addTouchedNodes(this.actor);var b=this.getNewTreeNode(this.actor),c=b.parent;if(b.replace_with(b.children[1]),w.handle(c,!0),"function"!=typeof a)return!0;a(this)}}]),b}(p),Vd=new Ud,Q.prototype.add_action_handler(Vd),ad.actions.SignInEvenPowerAction=Vd,ad.actions.SignZeroAction=function(){var a=function(a){p.call(this,"SignZeroAction","-0=0"),this.priority=0,this.triggerType="tap",a&&(this.actor=a.actor)};ad.inherit(p,a),a.prototype.match=function(a){return a.children[1]instanceof D&&0===a.children[1].value},a.prototype.transform=function(a){var b=this.getNewTreeNode(this.actor),c=b.children[1];if(this.addTouchedNodes(this.actor),this.updateNodeMap(this.actor.get_mapping_to(c)),_c.replace(b,c),"function"!=typeof a)return this;a(this)};var b=new a;return Q.prototype.add_action_handler(b),b}(),ad.actions.MoveSignIntoBracketsAction=function(){var a=function(a){p.call(this,"MoveSignIntoBracketsAction","move sign into brackets"),this.priority=0,this.triggerType="tap",a&&(this.actor=a.actor)};return ad.inherit(p,a),a.prototype.match=function(a){return!!a.is_group("sign")&&(!!a.children[1].is_group("brackets")&&a.children[1].children[1].is_group("product","sum"))},a.prototype.transform=function(a){this.addTouchedNodes(this.actor);var b=this.getNewTreeNode(this.actor),c=b.children[1],d=c.children[1],e=b.parent,f=b.remove();if(c.remove(),d.remove(),d.is_group("product")?this.applySignToProductFraction(d,b):this.applySignToSum(d,b),e.insert(f,d),this.cleanup(d),w.handle(d),this.cleanup(e),"function"!=typeof a)return!0;a(this)},a.prototype.applySignToProductFraction=function(a,b){var c=a.children[0].children[1];c.remove(),b.append(c),a.children[0].append(b),c.is_group("sign")&&(this.followup=ad.actions.SignDoubleNegAction.createBoundAction(this.newTree,{actor:b}))},a.prototype.applySignToSum=function(a,b){a.children.forEach(function(a){a.invert()})},Q.prototype.add_action_handler(new a),new a}(),Wd=function(a){function b(a){id(this,b);var c=pd(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,"SignInEvenPowerAction","remove redundant  in a product or fraction"));return c.priority=0,c.triggerType="tap",a&&c.initSettings(a),c}return qd(b,a),jd(b,[{key:"match",value:function(a){return a.is_group("plusminus")&&a.parent.is_group("mul","div")&&I.getFactors(a.get_parent(2)).some(function(b){return b.children[1]!==a&&b.children[1].is_group("plusminus")})}},{key:"transform",value:function(a){this.addTouchedNodes(this.actor);var b=this.getNewTreeNode(this.actor),c=b.parent;if(b.replace_with(b.children[1]),w.handle(c,!0),"function"!=typeof a)return!0;a(this)}}]),b}(p),Xd=new Wd,Q.prototype.add_action_handler(Xd),ad.actions.PlusMinusInProductAction=Xd,ad.actions.xToZeroAction=function(){var a=function(a){p.call(this,"xToZeroAction","x^0=1"),this.priority=0,this.triggerType="tap",a&&(this.actor=a.actor)};ad.inherit(p,a),a.prototype.match=function(a){return a.children[0]instanceof D&&0===a.children[0].value&&"0"!==a.ls.to_ascii()},a.prototype.transform=function(a){var b=this.getNewTreeNode(this.actor);this.addTouchedNodes(this.actor.parent);var c=new D(1);if(this.updateNodeMap(this.actor.parent.get_mapping_to(c)),_c.replace(b.parent,c),"function"!=typeof a)return!0;a(this)};var b=new a;return N.prototype.add_action_handler(b),b}(),ad.actions.CollectExponentsForFactoring=function(){var a=function(a){p.call(this,"CollectExponentsForFactoring","collect exponents"),this.settings={makes_no_changes:!0,side:"inside",no_delay:!0},a&&(this.nodes=a.nodes,this.target=a.target)};return ad.inherit(p,a),a.prototype.getAllAvailableActions=function(a){var b=a[0].get_root(),c=this,d=La(a);if(0===d.length)return[];for(var e=d[0].prod,f=[],g=0;g<e.children.length;g++){var h=e.get_child([g,1,1]);if(h){this.getTargetRangesInExponent(h,d).forEach(function(d){f.push(c.createBoundAction(b,{nodes:a,target:d[0].is_group("product")?[d[0].parent.parent]:d}))})}}return f},a.prototype.transform=function(a){var b=this.getNewTreeNode(this.nodes[0]),c=this.getNewTreeNode(this.target);if(this.updateNodeMap(this.nodes[0],[b].concat(c)),"function"!=typeof a)return!0;a(this)},a.prototype.getTargetRangesInExponent=function(a,b){var c=a.get_root();if(!a.is_group("exponent"))return[];for(var d=b[0].ascii,e=0;e<b.length;e++)if(b[e].exp===a)return[];var f=c.getRanges(d,null,a.children);return 0===f.length?[]:(f=f.filter(function(b){var c=b[0];return c.parent===a||c.parent.is_group("brackets")&&c.ls.hidden&&c.get_parent(2)===a||c.is_group("mul","div")&&c.get_parent(3)===a||c.parent.is_group("mul")&&c.get_parent(4)===a}),f.map(function(a){return 1===a.length&&a[0].parent.is_group("exponent","mul")?[a[0].parent]:a}))},new a}(),Id.prototype.move_actions.push(ad.actions.CollectExponentsForFactoring),ad.actions.FactorPowerAction=function(){var a=function(a){if(p.call(this,"FactorPowerAction","factor power"),this.interactionType="drag",this.settings={side:"outside",reset_y:!0},a){var b={},c={};a.margin&&(b.margin=a.margin,c.margin=a.margin);var d=[{side:"right-of",margin:{y2:.6,y1:-.2}}];this.initSettings(ad.extend(a,{drop_area:b,drop_area_hint:c,destination_hint:d}))}};return ad.inherit(p,a),a.prototype.getAllAvailableActions=function(a){var b,c=this.getEncompassingRange(a);if(this.thereIsALonePower(a)){if(this.transformationWouldLeaveExponentOfOne(a))return[];b=this.bindActionForLonePowerCases(a,c.length-1)}else{if(!(c.length>0))return[];b=this.bindActionForMultiplePowerCases(a,c)}return b},a.prototype.transform=function(a){if(Array.isArray(this.target))for(var b=0;b<this.target.length;b++)this.addTouchedNodes(this.target[b]);else this.addTouchedNodes(this.target);var c,d=Id.groupNodeRanges(this.nodes),e=this.getNewTreeNode(this.nodes),f=Id.groupNodeRanges(e);if(c=this.thereIsOneRange(f)?this.factorFromALonePower(e):this.factorFromMultiplePowers(f),this.mapOldRangesToNewRange(d,c),"function"!=typeof a)return!0;a(this)},a.prototype.factorFromALonePower=function(a){var b=this.extractRangeFromExponent(a);return this.wrapTermInPower(b,a)},a.prototype.factorFromMultiplePowers=function(a){var b=this.getParentGroupOfPowers(a[0][0]);return this.productFractionHasUnaffectedTerms(b,a)?this.performTransformationWithUnaffectedTerms(a,b):this.performTransformationWithoutUnaffectedTerms(a,b)},a.prototype.productFractionHasUnaffectedTerms=function(a,b){return a.is_group("product")?a.children.length>b.length:a.children.length-1>b.length},a.prototype.performTransformationWithoutUnaffectedTerms=function(a,b){for(var c=0;c<a.length;c++)this.extractRangeFromExponent(a[c]);return this.wrapTermInPower(b,a[0])},a.prototype.performTransformationWithUnaffectedTerms=function(a,b){var c=this.getAffectedTerms(a),d=this.getIDXForFactoredStructure(c),e=this.putAffectedTermsIntoASeparateProduct(c);if(e.is_group("product"))b.insert(d,new K(e,b.is_group("fraction")&&d>b.get_top().length?"div":"mul"));else{var f=b.parent,g=b.remove(),h=K.prototype.createParentGroup();h.append(new K(b)),h.append(new K(e)),f.insert(g,h),this.cleanup(b),this.cleanup(h.children[0])}for(var i=0;i<a.length;i++)this.extractRangeFromExponent(a[i]);return this.wrapTermInPower(e,a[0])},a.prototype.getIDXForFactoredStructure=function(a){for(var b,c=0;c<a.length;c++){var d=a[c],e=d.parent.children.indexOf(d);b||0===b?e<b&&(b=e):b=e}return b},a.prototype.putAffectedTermsIntoASeparateProduct=function(a){var b=K.prototype.createParentGroup();a.forEach(function(a){a.remove()}),a.every(function(a){return a.is_group("div")})&&a.forEach(function(a){a.invert()});for(var c=0;c<a.length;c++)b.append(a[c]);return b},a.prototype.mapOldRangesToNewRange=function(a,b){for(var c=0;c<a.length;c++)for(var d=a[c],e=0;e<d.length;e++)d[e].is_group("exponent")?this.updateNodeMap(d[e].get_mapping_to(b)):d[e].is_group("mul")&&(b.children[0].is_group("brackets")&&b.children[0].children[1].is_group("product")?this.updateNodeMap(d[e].get_mapping_to(b.children[0].children[1].children[e])):(this.updateNodeMap(d[e],b),this.newTree!==this.oldTree&&this.updateNodeMap(d[e].children[1],b.children[0])))},a.prototype.extractRangeFromExponent=function(a){if(a[0].is_group("exponent")){var b=a[0].parent.parent,c=a[0].parent,d=c.children[0],e=a[0],f=c.remove();return d.remove(),e.remove(),b.insert(f,d),d}var c=a[0].get_parent(4),g=c.get_child([1,0,1]);return _c.remove_range(a),this.cleanup(g),c},a.prototype.wrapTermInPower=function(a,b){var c,d,e;a.parent.is_group("brackets")?(c=a.parent,d=c.parent,e=c.remove()):(d=a.parent,e=a.remove(),c=new w(a));var f,g;if(b[0].is_group("exponent"))f=b[0];else if(b[0].is_group("mul")&&1===b.length)f=b[0].children[1],f.remove(),f=new N(f);else{g=K.prototype.createParentGroup();for(var h=0;h<b.length;h++)g.append(b[h]);f=new N(g)}var i=new H(c,f);return c.is_group("brackets")&&(c.simplify=!0),d.insert(e,i),w.handle(i),g&&this.cleanup(g),f},a.prototype.getParentGroupOfPowers=function(a){return a.is_group("exponent")?a.parent.parent.parent:a.parent.parent.parent.parent.parent.parent},a.prototype.getAffectedTerms=function(a){for(var b=[],c=0;c<a.length;c++)b.push(this.getParentMulFromExponentTerm(a[c][0]));return b},a.prototype.getParentMulFromExponentTerm=function(a){return a.is_group("exponent")?a.parent.parent:a.parent.parent.parent.parent.parent},a.prototype.thereIsOneRange=function(a){return 1===a.length},a.prototype.thereIsALonePower=function(a){return 1===a.length&&a[0].is_group("exponent")||this.allNodesAreMulsWithinSameProduct(a)},a.prototype.transformationWouldLeaveExponentOfOne=function(a){if(!a[0].is_group("mul","div"))return!1;var b=a[0].parent;if(b.is_group("product")&&a.length+1===b.children.length){for(var c=0;c<b.children.length;c++){var d=b.children[c];if(-1===a.indexOf(d)){d;break}}if(1===D.get_value(d.children[1]))return!0}else if(b.is_group("fraction")&&a.every(function(a){return a.is_group("div")})){var e=b.get_top();if(1===e.length&&1===D.get_value(e[0].children[1]))return!0}return!1},a.prototype.allNodesAreMulsWithinSameProduct=function(a){for(var b,c=0;c<a.length;c++){var d=a[c];if(!d.is_group("mul","div"))return!1;if(b){if(d.parent!==b)return!1}else b=d.parent}return!0},a.prototype.bindActionForLonePowerCases=function(a,b){var c,d={all:-.3},e=a[0];if(e.is_group("exponent")){var f=e.get_parent(2);if(!f)return[];if(!f.is_group("brackets")||f.parent.is_group("power","radical"))return[];c=this.createBoundAction(e.get_root(),{nodes:a,target:f})}else{if(!e.is_group("mul","div"))return[];var g=e.get_parent(2),h=g&&g.parent,i=h&&h.parent,j=i&&i.parent;if(!(g&&h&&i&&j))return[];if(!g.is_group("brackets")||!h.is_group("exponent")||!i.is_group("power"))return[];var k;if(j.is_group("brackets","mul","div"))if(j.is_group("brackets")&&!j.parent.is_group("power","radical"))k=j;else if(j.is_group("mul","div")&&b>0)d.all=-1,k=j.parent;else{if(!(j.is_group("mul","div")&&b<=0))return[];k=i}else k=i;c=this.createBoundAction(e.get_root(),{nodes:a,target:k,margin:d||null})}return[c]},a.prototype.bindActionForMultiplePowerCases=function(a,b){if(0===b.length)return[];var c=this.getBestTarget(b);return[this.createBoundAction(a[0].get_root(),{nodes:a,target:c})]},a.prototype.getEncompassingRange=function(a){var b=(a[0].get_root(),La(a));if(0===b.length)return[];for(var c=b[0].prod,d=[],e=0;e<c.children.length;e++){var f=c.get_child([e,1,1]);if(f){this.getTargetRangesInExponent(f,b).forEach(function(a){d=d.concat(a)})}}return _c.nodes_to_range(d)},a.prototype.getTargetRangesInExponent=function(a,b){var c=a.get_root();if(!a.is_group("exponent"))return[];var d=b[0].ascii,e=c.getRanges(d,null,a.children);return 0===e.length?[]:(e=e.filter(function(b){var c=b[0];return c.parent===a||c.parent.is_group("brackets")&&c.ls.hidden&&c.get_parent(2)===a||c.is_group("mul","div")&&c.get_parent(3)===a||c.parent.is_group("mul","div")&&c.get_parent(4)===a}),e.map(function(a){if(1===a.length){if(a[0].is_group("fraction")&&w.areHidden(a[0].parent)&&a[0].get_parent(2).is_group("exponent"))return[a[0].get_parent(2)];if(a[0].parent.is_group("exponent","mul"))return[a[0].parent]}return a}))},a.prototype.getBestTarget=function(a){var b,c=a[0].parent;if(c.is_group("product")&&c.children.length>a.length||c.is_group("fraction")&&c.children.length-1>a.length)b=a;else{var d=a[0].parent.parent;b=d.is_group("brackets")&&!w.areHidden(d)?d:a[0].parent}return b},new a}(),Id.prototype.move_actions.push(ad.actions.FactorPowerAction),ad.actions.DistributePowerAction=function(){var a=function(a){if(p.call(this,"DistributePowerAction","distribute power"),this.triggerType="drag",this.settings={side:"inside",reset_x:!0,reset_y:!0},a){var b=[{side:"right-of",margin:{y2:.5}}];this.initSettings(ad.extend(a,{destination_hint:b}))}};return ad.inherit(p,a),a.prototype.getAllAvailableActions=function(a){var b,c,d,e=a[0].get_root();if(this.nodesAreASingleExponent(a))d=a[0],c=d.parent,b=c.children[0];else{if(!this.nodesAreAllMulDivs(a)||!this.nodesAreAConsecutiveRange(a))return[];if(!(d=a[0].get_parent(3))||!d.parent)return[];c=d.parent,b=c.children[0]}if(!d||!c||!b)return[];if(!d.is_group("exponent")||!c.is_group("power")||!b.is_group("brackets"))return[];var b=b.children[1];return!b.is_group()||b.is_group("power")||b.is_group("brackets")||b.is_group("product")||b.is_group("fraction")?[this.createBoundAction(e,{nodes:a,target:b})]:[]},a.prototype.transform=function(a){var b=this,c=this.getNewTreeNode(this.nodes[0].is_group("exponent")?this.nodes[0]:this.nodes[0].parent.parent.parent),d=this.getNewTreeNode(this.nodes),e=this.getNewTreeNode(this.target),f=c.parent,g=f.parent;this.addTouchedNodes(this.getOldTreeNode(f)),_c.remove_range(d),this.nodes.forEach(function(a){return b.updateNodeMap(a,[])});var h;if(e.is_group("product")||e.is_group("fraction")?(h=e.get_top().concat(e.get_bottom()),this.applyPowersToMulDivs(h,d)):(h=[this.applyPowerToSingleTerm(e,d)],e=h[0]),f.children[1])this.cleanup(f.children[1].children[0].children[1]),w.handle(f.children[1].children[0],!0);else{var i=f.remove(),j=new w(e);g.insert(i,j),j.simplify=!0}if("function"!=typeof a)return!0;a(this)},a.prototype.nodesAreASingleExponent=function(a){return 1===a.length&&a[0].is_group("exponent")},a.prototype.nodesAreAllMulDivs=function(a){for(var b=0;b<a.length;b++)if(!a[b].is_group("mul","div"))return!1;return!0},a.prototype.nodesAreAConsecutiveRange=function(a){if(1===a.length)return!0;for(var b=a[0],c=1;c<a.length;c++){if(b.rs!==a[c]||b!==a[c].ls)return!1;b=a[c]}return!0},a.prototype.applyPowersToMulDivs=function(a,b){for(var c=0;c<a.length;c++){var d=a[c].children[1];this.applyPowerToSingleTerm(d,b)}},a.prototype.applyPowerToSingleTerm=function(a,b){return a.is_group("power")?this.applyPowerToPower(a,b):this.applyPowerToNonPower(a,b)},a.prototype.applyPowerToPower=function(a,b){var c=a,d=_c.clone(b),e=this.extendPowerWithSelectedExponentTerms(c,d);return this.extendNodeMap(this.nodes[0],e),c},a.prototype.applyPowerToNonPower=function(a,b){var c,d;c=a.parent,d=a.remove();var e;if(b[0].is_group("exponent"))e=_c.clone(b[0]);else{var f=K.prototype.createParentGroup(),g=_c.clone(b);this.appendAllContentsToProduct(f,g),e=new N(f)}var h=new H(a,e);return c.insert(d,h),f&&(this.cleanup(f),w.handle(e.children[0],!0)),this.mapDraggedExponentTermsToNewExponent(this.nodes,h.children[1]),h},a.prototype.mapDraggedExponentTermsToNewExponent=function(a,b){for(var c=0;c<a.length;c++)a[c].is_group("exponent")?this.extendNodeMap(a[c].get_mapping_to(b)):b.children[0].is_group("brackets")&&b.children[0].children[1].is_group("product")?this.extendNodeMap(a[c].get_mapping_to(b.children[0].children[1].children[c])):(this.extendNodeMap(a[c],b),this.extendNodeMap(a[c].children[1].get_mapping_to(b.children[0])))},a.prototype.takeContentsOfBrackets=function(a){return a.is_group("brackets")&&(a=a.children[1],a.remove()),a},a.prototype.extendPowerWithSelectedExponentTerms=function(a,b){var c=a.children[1],d=K.prototype.createParentGroup(),e=this.getContentMulsFromExponent(c),f=b[0].is_group("exponent")?this.getContentMulsFromExponent(b[0]):b;return this.appendAllContentsToProduct(d,e),this.appendAllContentsToProduct(d,f),c.append(d),this.cleanup(d),w.handle(d,!0),this.mapDraggedExponentTermsToNewExponentTerms(this.nodes,c,f),f},a.prototype.appendAllContentsToProduct=function(a,b){for(var c=0;c<b.length;c++)a.append(b[c])},a.prototype.mapDraggedExponentTermsToNewExponentTerms=function(a,b,c){if(a[0].is_group("mul"))for(var d=0;d<a.length;d++)this.extendNodeMap(a[d].get_mapping_to(c[d]));else if(a[0].is_group("exponent")){var e=a[0].children[0];if(e.is_group("brackets")&&e.children[1].is_group("product"))for(var d=0;d<e.children[1].children.length;d++){var f=e.children[1].children[d];this.extendNodeMap(a[0],c[d]),this.extendNodeMap(f.get_mapping_to(c[d]))}else e.is_group("brackets")&&!c[0].children[1].is_group("brackets")?this.extendNodeMap(e.children[1].get_mapping_to(c[0].children[1])):this.extendNodeMap(e.get_mapping_to(c[0].children[1]))}},a.prototype.getContentMulsFromExponent=function(a){var b=a.children[0];if(w.areHidden(b)&&b.children[1].is_group("product")){var c=b.children[1].children.slice();return _c.remove_range(b.children[1].children),b.remove(),c}if(w.areHidden(b)){var d=b.children[1];return d.remove(),b.remove(),[new K(d)]}return b.remove(),[new K(b)]},new a}(),Id.prototype.move_actions.push(ad.actions.DistributePowerAction),ad.actions.CombineStackedExponentsUpAction=function(){var a=function(a){p.call(this,"CombineStackedExponentsUpAction","combine stacked exponents up"),this.interactionType="drag",this.settings={side:"around",reset_y:!0},a&&(this.nodes=a.nodes,this.target=a.target)};return ad.inherit(p,a),a.prototype.getAllAvailableActions=function(a){if(a.length<1)return[];if(!this.validStructure(a))return[];var b=this.getBaseOfOuterPowerFromInnerExponentTerm(a);if(!b)return[];var c=b.parent.children[1];return[this.createBoundAction(a[0].get_root(),{nodes:a,target:c})]},a.prototype.transform=function(a){var b=this.getNewTreeNode(this.nodes),c=this.getNewTreeNode(this.target),d=c.parent.children[0];this.addTouchedNodes(this.target.parent),this.extractSelectedExponentTermsFromInnerPower(b);var e=this.extendOuterExponentWithSelectedExponentTerms(d,b);if(this.mapSelectedExponentsTermsToNewExponentTerms(this.nodes,e),d.simplify=!0,"function"!=typeof a)return!0;a(this)},a.prototype.validStructure=function(a){return this.nodesAreASingleExponent(a)?this.termsBelongToAPowerWithinAPower(a):!(!this.nodesAreAllMulDivs(a)||!this.nodesAreAConsecutiveRange(a))&&this.termsBelongToAPowerWithinAPower(a)},a.prototype.nodesAreASingleExponent=function(a){return 1===a.length&&a[0].is_group("exponent")},a.prototype.nodesAreAllMulDivs=function(a){for(var b=0;b<a.length;b++)if(!a[b].is_group("mul","div"))return!1;return!0},a.prototype.nodesAreAConsecutiveRange=function(a){if(1===a.length)return!0;for(var b=a[0],c=1;c<a.length;c++){if(b.rs!==a[c]||b!==a[c].ls)return!1;b=a[c]}return!0},a.prototype.termsBelongToAPowerWithinAPower=function(a){var b,c,d,e;return a[0].is_group("exponent")?(b=a[0],c=b.parent,c&&(d=c.parent),d&&(e=d.parent)):(b=a[0].get_parent(3),b&&(c=b.parent),c&&(d=c.parent),d&&(e=d.parent)),!!(b&&b.is_group("exponent")&&c&&c.is_group("power")&&d&&d.is_group("brackets")&&e&&e.is_group("power"))},a.prototype.getBaseOfOuterPowerFromInnerExponentTerm=function(a){return a[0].is_group("exponent")?a[0].get_parent(2):a[0].get_parent(5)},a.prototype.extractSelectedExponentTermsFromInnerPower=function(a){if(a[0].is_group("exponent")){var b=a[0].parent,c=a[0],d=b.children[0],e=b.parent,f=b.remove();d.remove(),c.remove(),e.insert(f,d)}else{var g=a[0].parent;g.parent;_c.remove_range(a),this.cleanup(g)}},a.prototype.extendOuterExponentWithSelectedExponentTerms=function(a,b){var c=a.parent,d=c.children[1],e=K.prototype.createParentGroup(),f=this.getContentMulsFromExponent(d),g=b[0].is_group("exponent")?this.getContentMulsFromExponent(b[0]):b;if(g.some(function(a){return a.is_group("mul")})&&g.some(function(a){return a.is_group("div")})){var h=K.prototype.createParentGroup();this.appendAllContentsToProduct(h,g),g=[new K(h)]}return this.appendAllContentsToProduct(e,f),this.appendAllContentsToProduct(e,g),d.append(e),this.cleanup(e),w.handle(e),g},a.prototype.appendAllContentsToProduct=function(a,b){for(var c=0;c<b.length;c++)a.append(b[c])},a.prototype.getContentMulsFromExponent=function(a){var b=a.children[0];if(w.areHidden(b)&&b.children[1].is_group("product","fraction")){var c=b.get_child([1]),d=c.get_top().concat(c.get_bottom());return _c.remove_range(b.children[1].children),b.remove(),d}if(w.areHidden(b)){var e=b.children[1];return e.remove(),b.remove(),[new K(e)]}return b.remove(),[new K(b)]},a.prototype.mapSelectedExponentsTermsToNewExponentTerms=function(a,b){for(var c=0;c<a.length;c++)for(var d=0;d<b.length;d++)0===d?this.updateNodeMap(a[c],b[d]):this.extendNodeMap(a[c],b[d])},new a}();Id.prototype.move_actions.push(ad.actions.CombineStackedExponentsUpAction),ad.actions.PowerFactorAndCombineStackedExponentsAction=function(){var a=function(a){p.call(this,"PowerFactorAndCombineStackedExponentsAction","factor power and combine stacked exponent up"),this.triggerType="drag",this.settings={side:"inside"},a&&(this.nodes=a.nodes,this.target=a.target)};return ad.inherit(p,a),a.prototype.getAllAvailableActions=function(a){if(a.length<2)return[];var b=ad.actions.FactorPowerAction.getAllAvailableActions(a);if(0===b.length)return[];var c=b[0];if(Array.isArray(c.target))return[];if(!c.target.is_group("brackets"))return[];if(!this.nodesAccountForEveryTermInProduct(c.target.children[1],a))return[];if(!c.target.parent.is_group("power"))return[];var d=c.target.parent.children[1];return[this.createBoundAction(a[0].get_root(),{nodes:a,target:d})]},a.prototype.nodesAccountForEveryTermInProduct=function(a,b){for(var c=[],d=0;d<b.length;d++){for(var e=b[d].parent;!e.is_group("power")&&!Id.is_top_most(e);)e=e.parent;c.every(function(a){return a!==e})&&c.push(e)}return c.length===a.get_top().concat(a.get_bottom()).length},a.prototype.doInPlace=function(a){this.initNodeMap();var b=this.target.parent;this.addTouchedNodes(b);var c=this.getNewTreeNode(this.nodes),d=ad.actions.FactorPowerAction.getAllAvailableActions(c)[0];d.doInPlace(),this.compose(d,!1);var e=d.mapNodes(c),f=ad.actions.CombineStackedExponentsUpAction.getAllAvailableActions(e)[0];if(f.doInPlace(),this.compose(f,!1),b=this.mapNodes(b)[0],w.handle(b.children[0],!0),this.removeDeletedNodesFromNodeMap(),"function"!=typeof a)return!0;a(this)},new a}(),Id.prototype.move_actions.push(ad.actions.PowerFactorAndCombineStackedExponentsAction),ad.actions.PolynomialExpansionAction=function(){var a=function(a){p.call(this,"PolynomialExpansionAction","polynomial expansion"),this.priority=0,this.triggerType="dbltap",a&&(this.actor=a.actor)};ad.inherit(p,a),a.prototype.match=function(a){if(!a.is_group("exponent"))return!1;if(!a.children[0]||!D.is_num(a.children[0]))return!1;if(2!==D.get_value(a.children[0])&&3!==D.get_value(a.children[0]))return!1;var b=a.parent,c=b.children[0];return!!c.is_group("brackets")&&!!c.children[1].is_group("sum")},a.prototype.transform=function(a){var b=this.getNewTreeNode(this.actor);this.addTouchedNodes(this.actor);var c=b.parent,d=this.analyzeStructure(b),e=this.formAddendsForExpandedPolynomial(d);if(e.sort(function(a,b){return a.firstOrder===b.firstOrder&&a.degreeOfFirstOrder>=b.degreeOfFirstOrder?0:a.firstOrder===b.firstOrder&&a.degreeOfFirstOrder<b.degreeOfFirstOrder?1:a.firstOrder<b.firstOrder?-1:a.firstOrder>b.firstOrder?1:void 0}),this.replacePowerWithExpandedPolynomialSum(c,e),"function"!=typeof a)return!0;a(this)},a.prototype.analyzeStructure=function(a){var b={},c=a.parent,d=c.children[0],e=d.children[1];return b.degree=D.get_value(a.children[0]),b.terms=e.children.slice(),b},a.prototype.formAddendsForExpandedPolynomial=function(a){var b;return 2===a.degree?b=this.formAddendsForDegreeOfTwo(a.terms):3===a.degree&&(b=this.formAddendsForDegreeOfThree(a.terms)),b},a.prototype.formAddendsForDegreeOfTwo=function(a){for(var b=[],c=0;c<a.length;c++){var d=a[c].children[1],e=_c.clone(d);this.extendNodeMap(this.getOldTreeNode(d).get_mapping_to(e));var f={};f.addend=new u(new H(e,new D(2))),f.firstOrder=c,f.degreeOfFirstOrder=2,b.push(f)}for(var c=0;c<a.length-1;c++)for(var g=c+1;g<a.length;g++){var h=K.prototype.createParentGroup();h.append(new K(new D(2)));var i=0,j=a[c].children[1],k=_c.clone(j);this.extendNodeMap(this.getOldTreeNode(j).get_mapping_to(k)),a[c].is_group("sub")&&(i=(i+1)%2);var l=a[g].children[1],m=_c.clone(l);this.extendNodeMap(this.getOldTreeNode(l).get_mapping_to(m)),a[g].is_group("sub")&&(i=(i+1)%2),1!==D.get_value(k)&&h.append(new K(k)),1!==D.get_value(m)&&h.append(new K(m));var f={};f.addend=new u(h,i?"sub":"add"),f.firstOrder=c,f.degreeOfFirstOrder=1,b.push(f)}return b},a.prototype.formAddendsForDegreeOfThree=function(a){for(var b=[],c=0;c<a.length;c++){var d=a[c].children[1],e=_c.clone(d);this.extendNodeMap(this.getOldTreeNode(d).get_mapping_to(e));var f={};f.addend=new u(new H(e,new D(3)),a[c].value),f.firstOrder=c,f.degreeOfFirstOrder=3,b.push(f)}for(var c=0;c<a.length-1;c++)for(var g=c+1;g<a.length;g++){var h=a[c].children[1],i=a[g].children[1],j=_c.clone(h),k=_c.clone(i);this.extendNodeMap(this.getOldTreeNode(h).get_mapping_to(j)),this.extendNodeMap(this.getOldTreeNode(i).get_mapping_to(k));var l=K.prototype.createParentGroup();l.append(new K(new D(3))),l.append(new K(new H(j,new D(2)))),1!==D.get_value(k)&&l.append(new K(k));var m={};m.addend=new u(l,i.parent.value),m.firstOrder=c,m.degreeOfFirstOrder=2,b.push(m);var n=_c.clone(h),o=_c.clone(i);this.extendNodeMap(this.getOldTreeNode(h).get_mapping_to(n)),this.extendNodeMap(this.getOldTreeNode(i).get_mapping_to(o));var p=K.prototype.createParentGroup();p.append(new K(new D(3))),1!==D.get_value(n)&&p.append(new K(n)),p.append(new K(new H(o,new D(2))));var q={};q.addend=new u(p,h.parent.value),q.firstOrder=c,q.degreeOfFirstOrder=1,b.push(q)}for(var c=0;c<a.length-2;c++)for(var g=c+1;g<a.length-1;g++)for(var r=g+1;r<a.length;r++){var h=a[c].children[1],i=a[g].children[1],s=a[r].children[1],t=_c.clone(h),v=_c.clone(i),w=_c.clone(s);this.extendNodeMap(this.getOldTreeNode(h).get_mapping_to(t)),this.extendNodeMap(this.getOldTreeNode(i).get_mapping_to(v)),this.extendNodeMap(this.getOldTreeNode(s).get_mapping_to(w));var x=K.prototype.createParentGroup();x.append(new K(new D(6))),1!==D.get_value(t)&&x.append(new K(t)),1!==D.get_value(v)&&x.append(new K(v)),1!==D.get_value(w)&&x.append(new K(w));var y=0;a[c].is_group("sub")&&(y=(y+1)%2),a[g].is_group("sub")&&(y=(y+1)%2),a[r].is_group("sub")&&(y=(y+1)%2);var f={};f.addend=new u(x,y?"sub":"add"),f.firstOrder=c,f.degreeOfFirstOrder=1,b.push(f)}return b},a.prototype.replacePowerWithExpandedPolynomialSum=function(a,b){for(var c=a.parent,d=a.remove(),e=u.prototype.createParentGroup(),f=0;f<b.length;f++)e.append(b[f].addend);c.insert(d,e),this.applyPowers(b),this.cleanupAddends(b),w.handle(e,!0),this.cleanup_cascade(e.parent)},a.prototype.applyPowers=function(a){for(var b=0;b<a.length;b++){var c=a[b].addend?a[b].addend.children[1]:a[b].children[1];c.is_group("power")?this.applyPower(a[b].addend?a[b].addend:a[b]):c.is_group("product")&&this.applyPowers(c.children.slice())}},a.prototype.applyPower=function(a){var b=a.children[1],c=(b.children[0],b.children[1]),d=ad.actions.DistributePowerAction.getAllAvailableActions([c]);if(d.length>0&&(d[0].doInPlace(),this.compose(d[0],!1),a.children[1].is_group("brackets"))){var e=a.children[1].children[1];e.remove(),a.children[1].remove(),a.append(e)}for(var f=d[0]?d[0].mapNodes(c):[c],g=0;g<f.length;g++){var h=f[g].getBestMatchingAction("tap");if(h&&"polynomial expansion"!==h.name){var i=h.createBoundAction(this.newTree,{actor:f[g]});i.doInPlace(),this.compose(i,!1)}}},a.prototype.cleanupAddends=function(a){for(var b=0;b<a.length;b++)if(a[b].addend.children[1].is_group("product"))for(var c=a[b].addend.children[1].children.slice(),d=0;d<c.length;d++)this.cleanup(c[d])};var b=new a;return N.prototype.add_action_handler(b),b}(),ad.actions.LogarithmExtractExponentOfArgumentAction=function(){var a=function(a){if(p.call(this,"LogarithmExtractExponentOfArgumentAction","move the exponent of the argument outside of the logarithm"),this.priority=1,this.triggerType="drag",this.settings={target_group:!0,group_side:"outside",reset_y:!0},a){var b="left-of"===a.side?{x1:-.5,x2:.1}:{x1:.1,x2:-.5};a.drop_area_hint={node:a.target.parent.parent,margin:b},a.destination_hint={nodes:[a.target.parent.parent]},this.initSettings(a)}};return ad.inherit(p,a),a.prototype.getAllAvailableActions=function(a){var b=this.matchSource(a);if(!b)return[];var c=this.getTargets(b);return this.bindActionForEachTarget(a,c,!0)},a.prototype.matchSource=function(a){if(1!==a.length)return!1;var b=a[0];if(!b.is_group("exponent","degree"))return!1;var c=b.get_parent(2);return!!c.is_group("param")&&(c=c.get_parent(3),!!O.Logs.is_log_func(c)&&{nodes:a,tuple:b.get_parent(3)})},a.prototype.getTargets=function(a){return[a.tuple]},a.prototype.transform=function(a){this.addTouchedNodes(this.target.parent);var b=this.getNewTreeNode(this.nodes),c=b[0].parent,d=b[0].get_parent(5),e=d.parent,f=d.remove();_c.remove_range(b);var g=b[0].children[0],h=!1;w.areHidden(g)&&I.is_fraction_with_identity_numerator(g.children[1])?(g=g.children[1].get_bottom(),_c.remove_range(g),b[0].is_group("degree")&&g.forEach(function(a){a.invert()}),h=!0):w.areHidden(g)&&g.children[1].is_group("product")&&(g=g.children[1].children.slice(),_c.remove_range(g),b[0].is_group("degree")&&g.forEach(function(a){a.invert()}),h=!0);var i=new I;i.append(new K(d));var j=h?g:[new K(g,b[0].is_group("degree")?"div":"mul")];return j[0].is_group("div")?j.forEach(i.append.bind(i)):i.insert_range("left-of"===this.settings.side?0:1,j),e.insert(f,i),h||w.handle(j[0].children[1],!0),this.updateNodeMap(this.nodes[0],j),w.handle(i),this.cleanup(c),this.cleanup_cascade(e),w.handle(d.get_arg(),!0),"function"==typeof a&&a(this),this},new a}(),Id.prototype.move_actions.push(ad.actions.LogarithmExtractExponentOfArgumentAction),ad.actions.LogarithmEvaluateAction=function(){var a=function(a){p.call(this,"LogarithmEvaluateAction","move the exponent of the argument outside of the logarithm"),this.priority=1,this.triggerType="tap",this.settings={},a&&(this.actor=a.actor)};return ad.inherit(p,a),a.prototype.match=function(a){if(!O.Logs.is_log_func(a))return!1;var b=O.Logs.get_log_base(a),c=a.get_arg();return!!c.is_leaf_node&&(O.Logs.within_domain(c)&&O.Logs.within_domain(b))},a.prototype.transform=function(a){this.addTouchedNodes(this.actor);var b=this.getNewTreeNode(this.actor),c=new D(O.Logs.evaluate(b));return _c.replace(b,c),this.actor.map_to_group(this,c),"function"==typeof a&&a(this),this},O.prototype.add_action_handler(new a),new a}(),ad.actions.LogarithmEvaluateSameArgAsBaseAction=function(){var a=function(a){p.call(this,"LogarithmEvaluateSameArgAsBaseAction","move the exponent of the argument outside of the logarithm"),this.priority=1,this.triggerType="tap",this.settings={},a&&(this.actor=a.actor)};return ad.inherit(p,a),a.prototype.match=function(a){if(!O.Logs.is_log_func(a))return!1;var b=O.Logs.get_log_base(a),c=a.get_arg();return b.to_ascii()===c.to_ascii()},a.prototype.transform=function(a){this.addTouchedNodes(this.actor);var b=this.getNewTreeNode(this.actor),c=new D(1);return _c.replace(b,c),this.actor.map_to_group(this,c),"function"==typeof a&&a(this),this},O.prototype.add_action_handler(new a),new a}(),ad.actions.LogarithmInvertAction=function(){var a=function(a){p.call(this,"LogarithmInvertAction","move the base of a logarithm across an equation"),this.priority=1,this.triggerType="drag",this.settings={side:"around",reset_y:!0,margin:{}},a&&(this.nodes=a.nodes,this.target=a.target,this.settings.margin=0===a.nodes[0].get_parent(2).get_idx()?{x1:-.5}:{x2:-.5})};return ad.inherit(p,a),a.prototype.getAllAvailableActions=function(a){var b=this.matchSource(a);if(!b)return[];var c=this.getTargets(b);return this.bindActionForEachTarget(a,c)},a.prototype.matchSource=function(a){if(1!==a.length)return!1;var b=a[0];return!(!b.parent||!O.Logs.is_log_func(b.parent.parent)||O.Logs.get_log_base(b.parent.parent)!==b)&&(!!b.get_parent(3).is_group("equals")&&{nodes:a,func:b.get_parent(2)})},a.prototype.getTargets=function(a){var b=a.func.parent,c=0===a.func.get_idx()?2:0;return[b.children[c]]},a.prototype.transform=function(a){this.addTouchedNodes(this.target.parent);var b=this.getNewTreeNode(this.nodes)[0],c=this.getNewTreeNode(this.target),d=b.get_parent(2),e=d.get_arg(),f=c.parent;d.replace_with(e);var g=c.remove(),h=new H(b,c);return f.insert(g,h),this.setNodesToReselectAfterAction(h),"function"==typeof a&&a(this),this},new a}(),Id.prototype.move_actions.push(ad.actions.LogarithmInvertAction),ad.actions.LogSimplifyAction=function(){var a=function(a){p.call(this,"LogSimplifyAction","simplify a log with a power as the argument"),this.priority=0,this.triggerType="tap",this.settings={},a&&(this.actor=a.actor)};return ad.inherit(p,a),a.prototype.match=function(a){if(!O.Logs.is_log_func(a))return!1;var b=O.Logs.get_log_base(a),c=a.get_arg();return!!c.is_group("power")&&b.to_ascii()===c.children[0].to_ascii()},a.prototype.transform=function(a){this.addTouchedNodes(this.actor);var b=this.getNewTreeNode(this.actor),c=b.get_arg().get_exponent_term();return b.replace_with(c),w.handle(c),this.cleanup_cascade(c.parent),"function"==typeof a&&a(this),this},O.prototype.add_action_handler(new a),new a}(),ad.actions.LogSimplifyPowerAction=function(){var a=function(a){p.call(this,"LogSimplifyPowerAction","simplify a power with a log exponent"),this.priority=0,this.triggerType="tap",this.settings={},a&&(this.actor=a.actor)};return ad.inherit(p,a),a.prototype.match=function(a){if(!O.Logs.is_log_func(a))return!1;if(!a.parent.is_group("exponent"))return!1;var b=a.get_parent(2).children[0];return O.Logs.get_log_base(a).to_ascii()===b.to_ascii()},a.prototype.transform=function(a){this.addTouchedNodes(this.actor);var b=this.getNewTreeNode(this.actor),c=b.get_arg();return b.get_parent(2).replace_with(c),w.handle(c),this.cleanup_cascade(c.parent),"function"==typeof a&&a(this),this},O.prototype.add_action_handler(new a),new a}(),ad.actions.LogarithmSplitAction=function(){var a=function(a){if(p.call(this,"LogarithmSplitAction","turn a log into a sum of logs"),this.priority=1,this.triggerType="drag",this.settings={target_group:!0,group_side:"outside"},a){var b={node:a.target.parent.parent,margin:"left-of"===a.side?{x1:-.5,x2:.1}:{x1:.1,x2:-.5}},c={nodes:[a.target.parent.parent]};this.initSettings(ad.extend(a,{drop_area_hint:b,destination_hint:c}))}};return ad.inherit(p,a),a.prototype.getAllAvailableActions=function(a){var b=this.matchSource(a);if(!b)return[];var c=this.getTargets(b);return this.bindActionForEachTarget(a,c,!0)},a.prototype.matchSource=function(a){if(!_c.is_range(a))return!1;var b=a[0];if(!b.is_group("mul","div"))return!1;var c=b.get_parent(2);return!!c.is_group("param")&&(c=c.get_parent(3),!!O.Logs.is_log_func(c)&&{nodes:a,tuple:b.get_parent(3)})},a.prototype.getTargets=function(a){return[a.tuple]},a.prototype.transform=function(a){this.addTouchedNodes(this.target.parent);var b=this.getNewTreeNode(this.nodes),c=b[0].parent,d=b[0].get_parent(5),e=d.parent,f=d.remove();_c.remove_range(b);var g=d.clone(!1);g.get_arg().remove();var h=!1,i=new I;1===b.length&&I.is_fraction_with_identity_numerator(b[0].children[1])&&(b=b[0].children[1].get_bottom(),_c.remove_range(b)),b.forEach(function(a){a.is_group("div")&&(h=!0,a.invert()),i.append(a)},this),g.get_child([1,1,0]).append(i);var j=new t;j.append(new u(d));var k=new u(g,h?"sub":"add");return j.insert("left-of"===this.settings.side?0:1,k),e.insert(f,j),this.nodes[0].get_parent(5).map_to_func(this,g),w.handle(j),this.setNodesToReselectAfterAction(k),this.cleanup(i),this.cleanup(c),this.cleanup_cascade(e),"function"==typeof a&&a(this),this},new a}(),Id.prototype.move_actions.push(ad.actions.LogarithmSplitAction),ad.actions.MultiplyNumbersAction=function(){var a=function(a){p.call(this,"MultiplyNumbersAction","Multiply numbers"),this.triggerType="tap",this.priority=1,this.settings={is_join_action:!0,delay:250,side:"inside"},a&&this.initSettings(a)};return ad.inherit(p,a),a.prototype.getAllAvailableActions=function(a){if(a.length>1)return[];if(!a[0].is_group("mul","div"))return[];if(!D.is_num(a[0].children[1],!0))return[];var b=this.getOtherNumberMulsInProduct(a[0]);return this.bindActionForEachTarget(a,b)},a.prototype.getOtherNumberMulsInProduct=function(a){var b=a.parent;return b.filter(function(c){return c!==a&&c.is_group(a.value)&&D.is_num(c.children[1],!0)&&c.parent===b})},a.prototype.match=function(a){if(!a.ls)return!1;if(a.ls.value!=a.value)return!1;var b=a.ls.children[1],c=a.children[1];return!(!D.is_num(b,!0)||!D.is_num(c,!0))},a.prototype.transform=function(a){"drag"===this.triggerType?(this.sourceMul=this.nodes[0],this.targetMul=this.target):(this.sourceMul=this.actor,this.targetMul=this.actor.ls),this.addTouchedNodes(this.sourceMul),this.addTouchedNodes(this.targetMul);var b,c=this.getNewTreeNode(this.sourceMul),d=this.getNewTreeNode(this.targetMul),e=c.parent,f=d.children[1],g=c.children[1],h=D.get_value(f,!0)*D.get_value(g,!0),i=f.is_group("plusminus","addsub")||g.is_group("plusminus","addsub");b=i?new K(new Q(new D(Math.abs(h)),!0),c.value):new K(new D(h),c.value),this.updateNodeMap(this.sourceMul,b),this.updateNodeMap(this.sourceMul.children[0],b.children[0]),!this.sourceMul.children[1].is_group("sign","plusminus")&&b.children[1].is_group("sign","plusminus")?this.updateNodeMap(this.sourceMul.children[1].get_mapping_to(b.children[1].children[1])):this.updateNodeMap(this.sourceMul.children[1].get_mapping_to(b.children[1])),this.updateNodeMap(this.targetMul,b),this.updateNodeMap(this.targetMul.children[0],b.children[0]),!this.targetMul.children[1].is_group("sign","plusminus")&&b.children[1].is_group("sign","plusminus")?this.updateNodeMap(this.targetMul.children[1].get_mapping_to(b.children[1].children[1])):this.updateNodeMap(this.targetMul.children[1].get_mapping_to(b.children[1]));var j=d.remove();return e.insert(j,b),c.remove(),this.cleanup(e),"function"==typeof a&&a(this),this},K.prototype.add_action_handler(new a),new a}(),Id.prototype.move_actions.push(ad.actions.MultiplyNumbersAction),ad.actions.MultiplyPowersAction=function(){var a=function(a){p.call(this,"MultiplyPowersAction","Multiply powers"),this.triggerType="tap",this.priority=0,this.settings={delay:250,side:"inside"},a&&("drag"===a.triggerType?(this.triggerType=a.triggerType,this.nodes=a.nodes,this.target=a.target):this.actor=a.actor)};return ad.inherit(p,a),a.prototype.areLikeTerms=function(a,b){return(a.is_group("power")?a.children[0].to_ascii():a.to_ascii())===(b.is_group("power")?b.children[0].to_ascii():b.to_ascii())},a.prototype.match=function(a,b){return a.is_group("power")&&(a=a.parent),arguments.length<2&&(b=a.ls),!!b&&(!(!a.is_group("mul","div")||!b.is_group("mul","div"))&&this.areLikeTerms(a.children[1],b.children[1]))},a.prototype.getSiblings=function(a){return a.parent.children.filter(function(b){return b!==a&&b.value===a.value})},a.prototype.getAllAvailableActions=function(a){var b=[];if(1!==a.length)return b;var c=a[0];if(!c.is_group("mul","div"))return b;for(var d=this.getSiblings(c),e=c.get_root(),f=0;f<d.length;f++)this.match(c,d[f])&&b.push(this.createBoundAction(e,{nodes:a,target:d[f],triggerType:"drag"}));return b},a.prototype.transform=function(a){var b=this.nodes&&this.nodes[0]||this.actor;b.is_group("power")&&(b=b.parent);var c=this.target||b.ls;this.addTouchedNodes(b),this.addTouchedNodes(c);var d=this.analyzeStructure(b);b=this.getNewTreeNode(b);var e=b.parent;c=this.getNewTreeNode(c);var f=this.performProductOfPowersProperty(b,c);if(this.mapOldSourceStructureToTarget(d,c),c=c.children[1],this.cleanup(e),this.simplify_exponent&&this.shouldSimplifyExponent(c)){var g=this.getExtendablesFromExponent(c);this.followup=ad.actions.AddSubNumbersAction.createBoundAction(this.newTree,{actor:g.children[1]})}else this.simplify_exponent=!1,this.setNodesToReselectAfterAction(f);if("function"!=typeof a)return!0;a(this)},a.prototype.analyzeStructure=function(a){var b={};b.muldiv=a;var c=a.children[1];return c.is_group("power")?(b.base=c.children[0],b.exponent=c.children[1]):(b.base=c,b.exponent=null),b},a.prototype.performProductOfPowersProperty=function(a,b){var c=a.children[1],d=b.children[1];c.is_group("power")||(c=this.reinterpretTermAsPowerWithExponentOfOne(c),this.simplify_exponent=!0),d.is_group("power")||(d=this.reinterpretTermAsPowerWithExponentOfOne(d),this.simplify_exponent=!0);var e=a.parent.children.indexOf(a)<b.parent.children.indexOf(b),f=this.extendTargetPowerWithSourcePower(d,c,e);return a.remove(),f},a.prototype.reinterpretTermAsPowerWithExponentOfOne=function(a){var b=a.parent,c=a.remove(),d=new H(a,new D(1));return b.insert(c,d),d},a.prototype.extendTargetPowerWithSourcePower=function(a,b,c){var d=this.getExtendablesFromExponent(b,!0),e=this.getExtendablesFromExponent(a,!1);return this.combineTermsIntoSum(e,d,c)},a.prototype.getExtendablesFromExponent=function(a,b){var c=a.children[1],d=c.children[0];return w.areHidden(d)&&(d=d.children[1]),b&&d.remove(),d.is_group("brackets")?d.children[1]:d},a.prototype.combineTermsIntoSum=function(a,b,c){var d=[],e=a.parent,f=a.remove(),g=u.prototype.createParentGroup(),h=new u(b),i=new u(a);return b.is_group("sum")?d=b.children.slice():d.push(h),g.append(i),g.insert(c?0:1,h),e.insert(f,g),w.handle(g),this.cleanup(i),this.cleanup(h),d},a.prototype.mapOldSourceStructureToTarget=function(a,b){this.updateNodeMap(a.muldiv,b),this.updateNodeMap(a.muldiv.children[0],b.children[0]);var c=b.children[1].children[0];if(a.base.is_group("brackets")&&c.is_group("brackets"))this.updateNodeMap(a.base.get_mapping_to(c));else{var d=a.base.is_group("brackets")?a.base.children[1]:a.base,e=c.is_group("brackets")?c.children[1]:c;this.updateNodeMap(d.get_mapping_to(e))}if(a.exponent){var f=b.children[1].children[1];this.updateNodeMap(a.exponent,f)}},a.prototype.shouldSimplifyExponent=function(a){var b=this.getExtendablesFromExponent(a);return 2===b.children.length&&b.children.every(function(a){return D.is_num(a.children[1])})},new a}(),K.prototype.add_action_handler(ad.actions.MultiplyPowersAction),H.prototype.add_action_handler(ad.actions.MultiplyPowersAction),Id.prototype.move_actions.push(ad.actions.MultiplyPowersAction),Yd=function(a){function b(a){id(this,b);var c=pd(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,"NegationAction","apply a *(-1)"));return c.priority=0,c.triggerType="tap",c.settings={side:"inside",delay:300},a&&(a.nodes&&(c.priority=0),c.initSettings(a)),c}return qd(b,a),jd(b,[{key:"getAllAvailableActions",value:function(a){if(1!==a.length)return[];var b=Ma(a[0]);if(!b)return[];var c=Na(b);return this.bindActionForEachTarget(a,c)}},{key:"match",value:function(a){var b=Ma(a),c=Ma(a.ls);return b.is_neg1||b.is_pm1||c.is_neg1||c.is_pm1}},{key:"transform",value:function(a){var b=this.getSourceAndTarget();this.addTouchedNodes(b.source),this.addTouchedNodes(b.target);var c=Ma(b.source);if(!c.is_neg1&&!c.is_pm1){var d=[b.target,b.source];b.source=d[0],b.target=d[1],c=Ma(b.source)}var e=this.getNewTreeNode(b.source),f=this.getNewTreeNode(b.target);e.remove();var g=f.parent,h=f.children[1];return h.replace_with(e.children[1]),f.children[1].children[1].replace_with(h),this.applyInnerAction("SignDoubleNegAction",{actor:f.children[1]}),this.cleanup(g),"function"==typeof a&&a(this),this}}]),b}(p),Zd=new Yd,K.prototype.add_action_handler(Zd),ad.actions.NegationAction=Zd,Id.prototype.move_actions.push(Zd),ad.actions.MulDivLogarithmsAction=function(){var a=function(a){if(p.call(this,"MulDivLogarithmsAction","muliply or divide a logarithm by a number"),this.priority=1,this.triggerType="tap",this.settings={delay:300,reset_y:!0,no_target_box_expansion:!0},a){var b={};a.target&&(b.destination_hint=[{node:a.target.children[1],side:"right-of",margin:{y2:.5}}]),this.initSettings(ad.extend(a,b))}};return ad.inherit(p,a),a.prototype.getAllAvailableActions=function(a){var b=this.matchSource(a);if(!b)return[];var c=this.getTargets(b);return this.bindActionsForEachTarget(a,c)},a.prototype.matchSource=function(a){return!!a[0].is_group("mul","div")&&(1===a.length?{nodes:a,only_match_logarithms:!O.Logs.is_log_func(a[0].children[1]),do_not_cross_frac:!(O.Logs.is_log_func(a[0].children[1])&&a[0].is_group("mul")||!O.Logs.is_log_func(a[0].children[1])&&a[0].is_group("div")),group:a[0].parent}:!!_c.is_range(a)&&{nodes:a,only_match_logarithms:!0,do_not_cross_frac:a[0].is_group("mul"),group:a[0].parent})},a.prototype.getTargets=function(a){var b=a.nodes[0].is_group("mul")?a.group.get_top():a.group.get_bottom();return b=b.concat(a.do_not_cross_frac?[]:a.nodes[0].is_group("mul")?a.group.get_bottom():a.group.get_top()),b.filter(function(b){return-1===a.nodes.indexOf(b)&&(!a.only_match_logarithms||O.Logs.is_log_func(b.children[1]))},this)},a.prototype.bindActionsForEachTarget=function(a,b){var c=[];return b.forEach(function(b){var d=O.Logs.is_log_func(b.children[1])?b.children[1].children[1]:b.children[1];c=c.concat(this.bindActionForEachTarget(a,[d]))},this),c},a.prototype.match=function(a){if(!a.ls||a.ls instanceof s)return!1;if(!a.is_group("mul","div")||a.ls.value!==a.value)return!1;var b=a.ls.children[1],c=a.children[1];return O.Logs.is_log_func(b)||O.Logs.is_log_func(c)},a.prototype.transform=function(a){var b=this.getSourceAndTarget(!0);this.addTouchedNodes(b.source),this.addTouchedNodes(b.target);var c,d,e;if(b.source[0].is_group("fraction"))c=this.getNewTreeNode(b.source[0]),d=c.get_bottom(),e=c.get_top()[0];else for(d=this.getNewTreeNode(b.source),e=this.getNewTreeNode(b.target),c=d[0].parent;!e.is_group("mul","div");)e=e.parent;var f,g,h;d.length>1||O.Logs.is_log_func(e.children[1])?(f=d,g=e,h=!1):(f=[e],g=d[0],h=!0);var i=f.map(this.getOldTreeNode.bind(this));_c.remove_range(f),f[0].is_group("div")&&f[0].value===g.value&&f.forEach(function(a){a.invert()});var j=g.children[1].get_arg(),k=j.parent,l=j.remove(),m=new H;m.append(j),w.handle(j);var n=new I;n.append_range(f);var o=new N(n);return m.append(o),k.insert(l,m),w.handle(g.children[1].children[1]),i.forEach(function(a){a.map_group_and_sym(this,g,!0)},this),this.setNodesToReselectAfterAction(h?g:o),this.cleanup(n),this.cleanup(c),"function"==typeof a&&a(this),this},I.prototype.add_action_handler(new a),K.prototype.add_action_handler(new a),new a}(),Id.prototype.move_actions.push(ad.actions.MulDivLogarithmsAction),ad.actions.MultiplyFractionsAction=function(){var a=function(a){p.call(this,"MultiplyFractionsAction","multiply fractions"),this.priority=1,this.triggerType="tap",this.settings={delay:250,side:"inside"},a&&(a.nodes?(this.triggerType="drag",this.nodes=a.nodes,this.target=a.target):this.actor=a.actor)};return ad.inherit(p,a),a.prototype.getAllAvailableActions=function(a){if(1!==a.length)return[];var b=a[0];if(!b.parent.is_group("product","fraction"))return[];var c=b.parent.children.filter(this.match2.bind(this,b));return this.bindActionForEachTarget(a,c)},a.prototype.match=function(a){return this.match2(a.ls,a)},a.prototype.match2=function(a,b){if(!a||!b||a===b)return!1;if(a.value!==b.value)return!1;var c=a.children[1],d=b.children[1];return c.is_group("plusminus","sign")&&(c=c.children[1]),d.is_group("plusminus","sign")&&(d=d.children[1]),!(!c.is_group("fraction")||!d.is_group("fraction"))&&!!a.parent.is_group("fraction","product")},a.prototype.transform=function(a){var b=this.getSourceAndTarget();this.sourceMul=b.source,this.targetMul=b.target,this.addTouchedNodes(this.sourceMul),this.addTouchedNodes(this.targetMul);var c=this.getNewTreeNode(this.targetMul),d=this.getNewTreeNode(this.sourceMul),e=c.parent,f=e,g=c.children[1],h=d.children[1];g.is_group("plusminus","sign")&&(g=g.children[1]);var i;h.is_group("plusminus","sign")&&(i=h,h=h.children[1]);var j=this.getOldTreeNode(h);this.updateNodeMap(j.get_fraction_bar(),g.get_fraction_bar()),this.updateNodeMap(this.sourceMul,c),this.updateNodeMap(this.sourceMul.children[0],c.children[0]),_c.remove(d);for(var k=h.get_top(),l=h.get_bottom(),m=0;m<k.length;m++)g.append(k[m]);for(var m=0;m<l.length;m++)g.append(l[m]);for(var m=0;m<g.children.length;m++){var n=g.children[m];n.has_children()&&w.handle(n.children[1])}return i&&(g.replace_with(i),i.children[1].replace_with(g),od.get("auto_simplify_signs")&&this.applyInnerAction("SignDoubleNegAction",{actor:i,tree:i.parent})),this.cleanup(f),"function"==typeof a&&a(this),this},K.prototype.add_action_handler(new a),new a}(),Id.prototype.move_actions.push(ad.actions.MultiplyFractionsAction),ad.actions.MulDivInvertAction=function(){var a=function(a){if(p.call(this,"MulDivInvertAction","invert multipliers across an inequality"),this.priority=0,this.triggerType="drag",a){var b={margin:{y2:-1,x:-.25}},c={margin:{y2:-1}},d=this.getDestinationHints(a);this.initSettings(ad.extend(a,{drop_area:b,drop_area_hint:c,destination_hint:d}))}};return ad.inherit(p,a),a.prototype.getAllAvailableActions=function(a){var b=this.matchSource(a);if(!b)return[];var c=this.getTargets(b);return this.bindActionForEachTarget(a,c)},a.prototype.matchSource=function(a){if(!_c.is_range(a))return!1;var b=a[0],c=b.get_parent(1);return c.is_group("product","fraction")&&(c.get_parent(1).is_group("equals")||F.is_inequality(c.get_parent(1)))?{nodes:a,side:c.get_idx(),group:c.get_parent(1)}:c.is_group("fraction")&&c.get_parent(1).is_group("sign")&&(c.get_parent(2).is_group("equals")||F.is_inequality(c.get_parent(2)))?{nodes:a,side:c.get_parent(1).get_idx(),group:c.get_parent(2)}:(c.is_group("product","fraction")&&c.get_parent(1).is_group("add","sub")||c.is_group("fraction")&&c.get_parent(1).is_group("mul"))&&(c.get_parent(3).is_group("equals")||F.is_inequality(c.get_parent(3)))?{nodes:a,side:c.get_parent(2).get_idx(),group:c.get_parent(3)}:c.is_group("fraction")&&c.get_parent(1).is_group("mul")&&c.get_parent(3).is_group("add","sub")&&(c.get_parent(5).is_group("equals")||F.is_inequality(c.get_parent(5)))?{nodes:a,side:c.get_parent(4).get_idx(),group:c.get_parent(5)}:!!(c.is_group("fraction")&&c.parent&&c.parent.is_group("mul")&&(c.parent.parent.parent.is_group("equals")||F.is_inequality(c.parent.parent.parent)))&&{nodes:a,frac:c,side:c.get_parent(2).get_idx(),group:c.get_parent(3)}},a.prototype.getTargets=function(a){return[a.group.get_child([a.side?0:2])]},a.prototype.getDestinationHintNodes=function(a){for(var b=a.nodes,c=a.target,d=b[0];!d.is_group("add","sub","addsub")&&!Id.is_top_most(d);)d=d.parent;var e=d.is_group("add","sub","addsub")?sd.get_siblings(d).map(function(a){return a.children[1]}):[];return e.push(c),e},a.prototype.getDestinationHints=function(a){for(var b=[],c=a.nodes[0];!c.is_group("add","sub","addsub")&&!Id.is_top_most(c);)c=c.parent;if((c.is_group("add","sub","addsub")?sd.get_siblings(c).map(function(a){return a.children[1]}):[]).forEach(function(a){return b.push({node:a,side:"below",margin:{x:-.2}})}),a.target.is_group("fraction")&&a.nodes[0].is_group("mul")){var d=a.target.get_bottom();b.push({node:d[d.length-1],side:"right-of"})}else if(a.nodes[0].is_group("mul"))b.push({node:a.target,side:"below"});else if(a.nodes[0].is_group("div")){var e=void 0;if(a.target.is_group("fraction")){var f=a.target.get_top();e=f[f.length-1]}else e=a.target.is_group("product")?a.target.get_last_child():a.target;b.push({node:e,side:"right-of"})}return b},a.prototype.transform=function(a){var b=this.getNewTreeNode(this.nodes),c=this.analyzeStructureOfEquation(b);return F.is_inequality(c.otherSideOfEquation.get_parent(1))&&this.invertInequality(c.modifiers,c.otherSideOfEquation.get_parent(1)),this.invertModifiers(c.modifiers),this.modifyAnyOtherTermsOnOriginSide(c.modifiers,c.originChanges),this.removeModifiersFromOriginSide(c.modifiers),this.modifyTargetSide(c.oldModifiers,c.modifiers,c.otherSideOfEquation,c.oldOtherSideOfEquation),"function"==typeof a&&a(this),this},a.prototype.analyzeStructureOfEquation=function(a){var b=this,c={},d=a[0].get_root().children[0],e=a[0].get_path(),f=e[1]?0:2;return c.modifiers=a,c.oldModifiers=a.map(b.getOldTreeNode.bind(b)),c.originChanges=this.getOtherTermsFromSide(d.children[e[1]],a,e),c.otherSideOfEquation=d.children[f],c.oldOtherSideOfEquation=this.getOldTreeNode(c.otherSideOfEquation),c},a.prototype.getOtherTermsFromSide=function(a,b,c){return a===b[0]||b[0].is_group("div")&&b[0].parent===a?[]:a.children.slice().filter(function(a){return a.get_path()[2]!==c[2]})},a.prototype.invertInequality=function(a,b){var c=Id.evalExpression(a),d=Id.to_ascii(a),e=ad.termsToAlgebriteString(a);if(Number.isNaN(c)&&void 0!==$c)try{c=Number($c.eval(e).toString())}catch(a){console.log("Algebrite could not parse",e)}isNaN(c)?this.settings.restraint="The terms "+d+" must simplify to a positive number.":c<0&&b.invert()},a.prototype.invertModifiers=function(a){for(var b=[],c=0;c<a.length;c++){var d=a[c];d.is_group("mul")&&d.children[1].is_group("fraction")?I.convert_to_reciprocal(d.children[1]):!d.invert||d.is_group("product","fraction")||this.isIdentityMul(d)||d.invert(),b.push(d)}return b},a.prototype.isIdentityMul=function(a){return a.is_group("mul")&&(1===D.get_value(a.children[1],!0)||-1===D.get_value(a.children[1]))},a.prototype.modifyAnyOtherTermsOnOriginSide=function(a,b){if(0!==b.length){var c=b[0].parent;if(a[0].is_group("mul","div")&&c.is_group("sum"))for(var d=0;d<b.length;d++){var e=b[d].children[1],f=this.removeRedundantTerms(e,a);f.length>0&&(e=b[d].children[1],this.insertModifiersIntoTerm(e,f))}}},a.prototype.removeRedundantTerms=function(a,b){var c=b.slice();if(a.is_group("product","fraction")){for(var d=0;d<a.children.length;){for(var e=a.children[d],f=0;f<c.length;){if(this.invertModifiers([_c.clone(c[f])])[0].to_ascii()===e.to_ascii()){this.extendNodeMap(this.getOldTreeNode(e).get_mapping_to(c[f])),e.remove(),c.splice(f,1);break}d++,f++}if(0===c.length)break}this.cleanup(a)}return c},a.prototype.insertModifiersIntoTerm=function(a,b){this.termIsAProductContainingAFraction(a)&&b[0].is_group("div")?this.insertModifierDivsAsNewFractionIntoProduct(a,b):a.is_group("product","fraction")?this.insertModifiersIntoProductFraction(a,b):this.replaceTermWithProductContainingModifiedTerm(a,b)},a.prototype.termIsAProductContainingAFraction=function(a){return!!a.is_group("product")&&a.children.some(function(a){return a.children[1].is_group("fraction")})},a.prototype.insertModifierDivsAsNewFractionIntoProduct=function(a,b){var c=this,d=K.prototype.createParentGroup();d.append(new K(new D(1))),b.forEach(function(a){var b=_c.clone(a);b.dragging=!1,b.selected=!1,c.extendNodeMap(c.getOldTreeNode(a).get_mapping_to(b)),d.append(b)}),a.append(new K(d))},a.prototype.insertModifiersIntoProductFraction=function(a,b){var c=this;b.forEach(function(b){var d=_c.clone(b);d.dragging=!1,d.selected=!1,c.extendNodeMap(c.getOldTreeNode(b).get_mapping_to(d)),a.append(d)})},a.prototype.replaceTermWithProductContainingModifiedTerm=function(a,b){var c=this,d=K.prototype.createParentGroup(),e=a.parent,f=a.remove();d.append(new K(a)),b.forEach(function(a){var b=_c.clone(a);b.dragging=!1,b.selected=!1,c.extendNodeMap(c.getOldTreeNode(a).get_mapping_to(b)),d.append(b)}),e.insert(f,d)},a.prototype.removeModifiersFromOriginSide=function(a){var b=a[0].get_root().get_child(a[0].get_path().slice(0,2));if(this.modifierIsTheOnlyTermOnOriginSide(a,b))this.removeModifierAndReplaceWithZero(a);else if(a[0].is_group("div")||a[0].is_group("mul")&&a[0].parent.is_group("fraction")){var c=a[0].parent,d=c.parent;_c.remove_range(a);var e=c.get_top(),f=this.cleanup(c);f&&1===e.length&&d.is_group("product","mul")&&(d.simplify=!0),this.cleanup(d)}else{var d=a[0].parent;_c.remove_range(a),this.cleanup(d)}},a.prototype.modifierIsTheOnlyTermOnOriginSide=function(a,b){return a[0]===b},a.prototype.removeModifierAndReplaceWithZero=function(a){var b=a[0].parent,c=a[0].remove();b.insert(c,new D(0))},a.prototype.modifyTargetSide=function(a,b,c,d){if(1===b.length&&!b[0].is_group("mul","div")&&!b[0].is_group("add","sub"))if(b[0].is_group("sign")){var e=b[0].children[1];e.remove(),b[0]=new u(e),this.updateNodeMap(a[0],b[0]),this.updateNodeMap(a[0].children[0],b[0].children[0])}else if(b[0].is_group("sum")){var e=b[0];e.children.forEach(function(a){a.invert()}),b[0]=new u(e)}else{var e=b[0];b[0]=new u(e,"sub")}var f=c.parent,g=c.remove();if(!c.is_group("product","fraction")&&b[0].is_group("mul","div")){var h=K.prototype.createParentGroup(),i=new K(c);h.append(i);for(var j=0;j<b.length;j++)h.append(b[j]);f.insert(g,h),this.cleanup(h.children[0]),h.children[0].simplify=!0}else if(!c.is_group("sum")&&b[0].is_group("add","sub","sum")){var k,l=u.prototype.createParentGroup();c.is_group("sign")?(k=new u(c),this.extendNodeMap(d,k),this.extendNodeMap(d.children[0],k.children[0])):k=new u(c),l.append(k);for(var j=0;j<b.length;j++)l.append(b[j]);if(f.insert(g,l),this.cleanup(l.children[0]),b[0].children[1].is_group("sum")){var m=b[0].children[1].children.slice();this.cleanup(b[0]),b=m}l.children[0].simplify=!0}else{for(var n=c,j=0;j<b.length;j++)n.append(b[j]);f.insert(g,n),1===b.length&&b[0].children[1].is_group("sum")&&(b=b[0].children[1].children.slice(),this.cleanup(n.children[n.children.length-1]))}this.setNodesToReselectAfterAction(b)},new a}(),Id.prototype.move_actions.push(ad.actions.MulDivInvertAction),$d=function(a){function b(a){id(this,b);var c=pd(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,"MulDivRadicalsAction","muliply or divide a radicals"));if(c.triggerType="tap",c.priority=0,c.settings={target_group:!0,group_side:"around",delay:300,reset_y:!0},c.elements=[],a){var d={};a.target&&(c.priority=1,d.drop_area_hint={side:"around"}),c.initSettings(ad.extend(a,d))}return c}return qd(b,a),jd(b,[{key:"getAllAvailableActions",value:function(a){var b=Pa(a);if(!b)return[];var c=Qa(b);return this.bindActionsForEachTarget(a,c)}},{key:"bindActionsForEachTarget",value:function(a,b){var c=[];return b.forEach(function(b){var d=b.children[1].children[3];c=c.concat(this.bindActionForEachTarget(a,[d],!0))},this),c}},{key:"match",value:function(a){if(!a.ls||a.ls instanceof s)return!1;if(!a.is_group("mul","div")||a.ls.value!==a.value)return!1;var b=a.ls.children[1],c=a.children[1];if(!b.is_group("radical")||!c.is_group("radical")||b.children[0].to_ascii()!==c.children[0].to_ascii())return!1;var d=Oa(b.get_radicand()),e=Oa(c.get_radicand());return isNaN(d)||d>=0||isNaN(e)||e>=0}},{key:"rematch",value:function(){var a=this;return!(!this.target||"AlgebraModel"!==this.target.type)||(this.actor?this.match(this.actor):this.getAllAvailableActions(this.nodes).some(function(b){return b.target===a.target}))}},{key:"rebind",value:function(a,b,c){if(this.oldTree!==c)throw"wrong old tree during rebinding an action!";var d=new p;d.node_map=b,this.oldTree=a,this.nodes&&(this.nodes=d.mapNodes(this.nodes)),this.actor&&(this.actor=d.mapNodes(this.actor)[0]),!this.target||this.target instanceof Id?this.target&&(this.target={type:"AlgebraModel"}):this.target=d.mapNodes(this.target)[0]}},{key:"transform",value:function(a){return this.target&&"AlgebraModel"===this.target.type?this.transformUpdate(a):this.transformInitial(a)}},{key:"transformInitial",value:function(a){var b=this.getSourceAndTarget();this.addTouchedNodes(b.source),this.addTouchedNodes(b.target);for(var c=this.getNewTreeNode(b.source),d=this.getNewTreeNode(b.target),e=c.parent,f=this.getOldTreeNode(c);!d.is_group("mul","div");)d=d.parent;if(d.is_group("div")&&c.is_group("mul")){var g=d;d=c,c=g}var h=c.children[1].get_radicand(),i=d.children[1].get_radicand();isNaN(Oa(h))&&this.elements.push(this.defineRestrictionExpression([h])),isNaN(Oa(i))&&this.elements.push(this.defineRestrictionExpression([i])),c.remove(),i.remove();var j=new I;return j.append(new K(i)),j.insert("left-of"===this.settings.side?0:1,new K(h,d.value===c.value?"mul":c.value),!0),d.children[1].set_radicand(j),f.map_group_and_sym(this,d,!0),f.children[1].map_to_radical(this,d.children[1],!0),this.cleanup(i.parent),this.cleanup(h.parent),this.cleanup(j),this.cleanup(e),"function"==typeof a&&a(this),this}},{key:"transformUpdate",value:function(a){return this.node_map={},this.createRestrictionModel(this.newTree,this.nodes||[this.actor]),this.target=this.newTree,"function"==typeof a&&a(this),!0}},{key:"createRestrictionModel",value:function(a,b){a.children[0].remove();var c=Id.cloneNodes(b)[0],d=new F(c,new D(0),"gte");return a.append(d),a.hide_nodes(),this.updateNodeMap(b[0].get_mapping_to(d.children[0])),a}}]),b}(p),_d=new $d,ad.actions.MulDivRadicalsAction=_d,I.prototype.add_action_handler(_d),K.prototype.add_action_handler(_d),Id.prototype.move_actions.push(_d),ad.actions.AddFractionsAction=function(){var a=function(a){p.call(this,"AddFractionsAction","add fractions"),this.priority=1.1,this.triggerType="tap",this.settings={delay:250,side:"inside"},a&&this.initSettings(a)};return ad.inherit(p,a),a.prototype.getAllAvailableActions=function(a){if(1!==a.length)return[];var b=a[0];if(!b.parent.is_group("sum"))return[];if(!b.children[1].is_group("fraction"))return[];var c=b.parent.children.filter(this.match2.bind(this,b)),d=b.get_root(),e=this;return c.map(function(b){return e.createBoundAction(d,{nodes:a,target:b,triggerType:"drag"})})},a.prototype.match=function(a){return this.match2(a.ls,a)},a.prototype.match2=function(a,b){if(!a||!b||a===b)return!1;if(!a.parent.is_group("sum"))return!1;if(a.parent!==b.parent)return!1;var c=a.children[1],d=b.children[1];if(!c.is_group("fraction")||!d.is_group("fraction"))return!1;var e=function(a){return a.to_ascii()},f=c.get_bottom(),g=d.get_bottom();return f.map(e).join("")===g.map(e).join("")},a.prototype.transform=function(a){var b="drag"===this.triggerType?this.nodes[0]:this.actor,c="drag"===this.triggerType?this.target:this.actor.ls;this.addTouchedNodes(b),this.addTouchedNodes(c);var d=this.getNewTreeNode(b),e=this.getNewTreeNode(c),f=d.get_idx()<e.get_idx(),g=f?b:c,h=f?d:e,i=f?c:b,j=f?e:d,k=j.parent,l=h.children[1],m=j.children[1];this.mapOldFractionPartsToFraction(i.children[1],l),_c.remove(d);var n=_c.remove(e);h=this.putNumeratorTermsIntoAddSubAndMapFromOldAddSub(l.get_top(),g),j=this.putNumeratorTermsIntoAddSubAndMapFromOldAddSub(m.get_top(),i);var o=this.putAddendsIntoNewSumAndMakeNumeratorTerm(h,j);l.append(o);var p=new u(l);if(_c.insert(k,n,p),this.updateNodeMap(b,p),this.updateNodeMap(c,p),this.cleanup(h),this.cleanup(j),this.cleanup(k),od.get("simplify_sum_in_numerator_after_adding_fractions")&&this.numeratorSumContainsTwoNumbers(l.get_top()[0].children[1].children[1])&&this.simplifyNumeratorAsFollowup(l),"function"!=typeof a)return!0;a(this)},a.prototype.mapOldFractionPartsToFraction=function(a,b){this.updateNodeMap(a.get_fraction_bar(),b.get_fraction_bar());for(var c=a.get_bottom(),d=b.get_bottom(),e=0;e<c.length;e++)this.updateNodeMap(c[e].get_mapping_to(d[e]))},a.prototype.putNumeratorTermsIntoAddSubAndMapFromOldAddSub=function(a,b){_c.remove_range(a);var c;if(1==a.length)c=new u(a[0].children[1],b.value);else{var d=new I;_c.insert_range(d,0,a),c=new u(d,b.value)}return w.handle(c.children[1],!0),this.updateNodeMap(b,c),this.updateNodeMap(b.children[0],c.children[0]),c},a.prototype.putAddendsIntoNewSumAndMakeNumeratorTerm=function(a,b){var c=u.prototype.createParentGroup();c.append(a),c.append(b);var d=new K;return _c.append(d,new s("*")),_c.append(d,c),w.handle(c),d},a.prototype.numeratorSumContainsTwoNumbers=function(a){return 2===a.children.length&&a.children.every(function(a){return D.is_num(a.children[1])})},a.prototype.simplifyNumeratorAsFollowup=function(a){var b=a.get_top()[0].children[1].children[1];this.followup=ad.actions.AddSubNumbersAction.createBoundAction(this.newTree,{actor:b.children[1]})},u.prototype.add_action_handler(new a),new a}(),Id.prototype.move_actions.push(ad.actions.AddFractionsAction),ad.actions.FractionAbsorbTermAction=function(){var a=function(a){p.call(this,"FractionAbsorbTermAction","associative property of multiplication--move into fraction"),this.priority=0,this.triggerType="drag",this.settings={delay:250,side:"around"},a&&(this.nodes=a.nodes,this.target=a.target)};return ad.inherit(p,a),a.prototype.getAllAvailableActions=function(a){var b=this.matchSource(a);if(!b)return[];var c=this.getTargets(b);return this.bindActionForEachTarget(a,c)},a.prototype.matchSource=function(a){return 1===a.length&&a[0].is_group("mul","div")&&a[0].children[1].is_group("fraction")&&{nodes:a,group:a[0].parent,fraction:a[0].children[1]}},a.prototype.getTargets=function(a){return(a.nodes[0].is_group("mul")?a.group.get_top():a.group.get_bottom()).filter(function(b){return!b.children[1].is_group("fraction")&&a.nodes[0]!==b},this)},a.prototype.transform=function(a){this.addTouchedNodes(this.nodes),this.addTouchedNodes(this.target);var b=this.getNewTreeNode(this.nodes[0]),c=this.getNewTreeNode(this.target),d=c.get_idx()<b.get_idx(),e=b.children[1];c.remove(),c.is_group("div")&&c.invert();var f=e.get_top();if(1===f.length&&D.is_equal_to(f[0].children[1],1)&&(f[0].simplify=!0),e.insert(d?0:e.get_top().length,c),this.cleanup_cascade(b.parent),"function"!=typeof a)return!0;a(this)},new a}(),Id.prototype.move_actions.push(ad.actions.FractionAbsorbTermAction),ad.actions.FractionCancelTermsAction=function(){var a=function(a){p.call(this,"FractionCancelTermsAction","cancel numbers in a fraction"),this.triggerType="tap",this.priority=0,this.settings={delay:400,side:"inside",reset_x:!0,reset_y:!0,prev_branch:null},a&&(this.initSettings(a),"drag"===this.triggerType&&(this.priority=2,this.drop_area_hint.node=this.target.children[1]))};ad.inherit(p,a),a.prototype.getAllAvailableActions=function(b){return a.getAllAvailableActions.call(this,b)},a.getAllAvailableActions=function(b){if(1!==b.length)return[];if(!b.every(function(a){return a.is_group("mul","div")}))return[];var c=xa(b);if(!c)return[];var d=a.findOtherContendersInStructure(b,c);if(0===d.length)return[];d=d.filter(function(a){return!!this.getBoundTransformation(b[0],a,!0)},this);var e=b[0].get_root();return d.map(function(a){return this.createBoundAction(e,{nodes:b,target:a})},this)},a.prototype.getTargetsForHighlighting=function(){return this.target?[this.target]:[]},a.findOtherContendersInStructure=function(a,b){var c=a[0].is_group("mul")?"div":"mul";return b.filter(function(d){return d.is_group(c)&&(d.parent===b||d.parent.parent.parent===b)&&!Ba(d,a)})},a.prototype.match=function(b){return a.match.call(this,b)},a.match=function(a){if(!od.get("tap_to_cancel"))return!1;var b=I.matchSource(a);return!!b&&!!this.getBoundTransformation(b.mul,b.div,!0)},a.prototype.transform=function(b){a.transform.call(this,b)},a.transform=function(b){var c=I.getSourceAndTarget.call(this);this.oldSourceOp=c.source,this.addTouchedNodes(c.source),this.addTouchedNodes(c.target);var d=this.getNewTreeNode(c.source),e=this.getNewTreeNode(c.target),f=xa([d]);if(a.performCancel.call(this,d,e),a.cleanStructure.call(this,f),"function"!=typeof b)return!0;b(this)},a.performCancel=function(a,b){var c=this.getBoundTransformation(a,b,!1);if(!c)throw"Failed to find canceling transformation in transform function.";c()},a.cleanStructure=function(a){var b=!1;a.is_group("product")&&a.children.forEach(function(a){a.children[1].is_group("fraction")&&(b=this.cleanup_cascade(a.children[1]))},this),b||this.cleanup_cascade(a)},a.prototype.getBoundTransformation=function(a,b,c){var d=this,e=a.is_group("mul")?a:b,f=b.is_group("div")?b:a,g=D.is_num(e.children[1]),h=D.is_num(f.children[1]),i=g&&!this.numberContainsDecimalTerm(e.children[1]),j=h&&!this.numberContainsDecimalTerm(f.children[1]);if(h&&(0===D.get_value(f.children[1])||-0===D.get_value(f.children[1])))return!1;if(this.settings.prev_branch)if("rem-both"===this.settings.prev_branch){if(D.is_num(e.children[1])&&D.is_num(f.children[1]))return function(){d.removeBoth(e,f)}}else if("rem-div"===this.settings.prev_branch){if(D.is_num(f.children[1]))return function(){d.removeDiv(e,f)}}else{if("split-both"===this.settings.prev_branch)return function(){d.splitBoth(e,f)};if("split-mul"===this.settings.prev_branch)return function(){d.splitMul(e,f)};if("split-div"===this.settings.prev_branch)return function(){d.splitDiv(e,f)}}return e.children[1].to_ascii()===f.children[1].to_ascii()?(c||this.settings.prev_branch||(this.settings.prev_branch="rem-both"),function(){d.cancelTerms(e,f)}):j&&1===D.get_value(f.children[1])?(c||this.settings.prev_branch||(this.settings.prev_branch="rem-div"),function(){d.removeDiv(e,f)}):j&&-1===D.get_value(f.children[1])?(c||this.settings.prev_branch||(this.settings.prev_branch="rem-div"),function(){d.applyNegativeToMulNum(e,f)}):this.termIsNegativeXOfX(e.children[1],f.children[1])?(c||this.settings.prev_branch||(this.settings.prev_branch="rem-both"),function(){d.cancelTermsAndReplaceMulDiv1NumWithNegativeOne(e,f)}):this.termIsNegativeXOfX(f.children[1],e.children[1])?(c||this.settings.prev_branch||(this.settings.prev_branch="rem-both"),function(){d.cancelTermsAndReplaceMulDiv1NumWithNegativeOne(f,e)}):i&&j&&va(e.get_child([1]),f.get_child([1]))?function(){d.factorizeTerms(e,f)}:!!this.bothTermsAreNegative(e,f)&&(c||this.settings.prev_branch||(this.settings.prev_branch="split-both"),function(){d.extractSigns(e,f)})},a.prototype.removeBoth=function(a,b){var c=D.get_value(a.children[1])/D.get_value(b.children[1]),d=a.parent;a.remove(),b.remove(),1!==c&&Ia(d,c)},a.prototype.removeDiv=function(a,b){var c=1/D.get_value(b.children[1]),d=a.parent;b.remove(),1!==c&&Ia(d,c)},a.prototype.splitBoth=function(a,b){this.splitMul(a,b),this.splitDiv(a,b)},a.prototype.splitMul=function(a,b){var c=a.parent;a.children[1].is_group("sign")?(c.insert(a.get_idx()+1,new K(new D(-1))),a.children[1].replace_with(a.children[1].children[1])):c.insert(a.get_idx()+1,new K(new D(1)))},a.prototype.splitDiv=function(a,b){var c=b.parent;b.children[1].is_group("sign")?(c.insert(b.get_idx()+1,new K(new D(-1),"div")),b.children[1].replace_with(b.children[1].children[1])):c.insert(b.get_idx()+1,new K(new D(1),"div"))},a.prototype.cancelTerms=function(a,b){this.setNodesToReselectAfterAction(a.parent),a.remove(),b.remove()},a.prototype.applyNegativeToMulNum=function(a,b){if(this.updateNodeMap(this.getOldTreeNode(b),a),a.children[1].is_group("sign"))a.children[1].replace_with(a.children[1].children[1]);else{var c=b.children[1];c.remove(),c.children[1].remove();var d=a.children[1];d.remove(),a.append(c),c.append(d)}b.remove()},a.prototype.termIsNegativeXOfX=function(a,b){return a.is_group("sign")&&a.children[1].to_ascii()===b.to_ascii()},a.prototype.cancelTermsAndReplaceMulDiv1NumWithNegativeOne=function(a,b){var c=a.children[1].children[1],d=b.children[1],e=new D(1);this.updateNodeMap(this.getOldTreeNode(b),a),this.updateNodeMap(this.getOldTreeNode(d).get_mapping_to(e)),this.updateNodeMap(this.getOldTreeNode(c).get_mapping_to(e)),c.replace_with(e),b.remove()},a.prototype.factorizeTerms=function(a,b){var c=a.get_root(),d=c.numeric_value(a.children[1]),e=c.numeric_value(b.children[1]);if(!d||!e)return!1;var f=this.getOldTreeNode(a),g=this.getOldTreeNode(b),h=this.relativePositionOfMulWithRespectToDiv(a,b);if(ta(d,e)){this.settings.prev_branch||(this.settings.prev_branch="split-mul");var i="left"===h?this.splitIntoFactors(a,f,Math.floor(d/e),e)[1]:this.splitIntoFactors(a,f,e,Math.floor(d/e))[0];this.oldSourceOp.is_group("mul")&&this.setNodesToReselectAfterAction(i),od.get("cancel_common_terms_after_finding_gcf")&&(this.oldSourceOp.is_group("mul")?this.followup=ad.actions.FractionCancelTermsAction.createBoundAction(this.newTree,{nodes:[i],target:b}):this.followup=ad.actions.FractionCancelTermsAction.createBoundAction(this.newTree,{nodes:[b],target:i}))}else if(ta(e,d)){this.settings.prev_branch||(this.settings.prev_branch="split-div");var i="left"===h?this.splitIntoFactors(b,g,d,Math.floor(e/d))[0]:this.splitIntoFactors(b,g,Math.floor(e/d),d)[1];this.oldSourceOp.is_group("div")&&this.setNodesToReselectAfterAction(i),od.get("cancel_common_terms_after_finding_gcf")&&(this.oldSourceOp.is_group("div")?this.followup=ad.actions.FractionCancelTermsAction.createBoundAction(this.newTree,{nodes:[i],target:a}):this.followup=ad.actions.FractionCancelTermsAction.createBoundAction(this.newTree,{nodes:[a],target:i}))}else{this.settings.prev_branch||(this.settings.prev_branch="split-both");var j,k,l=ua(d,e);switch(h){case"left":j=this.splitIntoFactors(a,f,Math.floor(d/l),l)[1],k=this.splitIntoFactors(b,g,l,Math.floor(e/l))[0];break;case"same":j=this.splitIntoFactors(a,f,Math.floor(d/l),l)[1],k=this.splitIntoFactors(b,g,Math.floor(e/l),l)[1];break;case"right":j=this.splitIntoFactors(a,f,l,Math.floor(d/l))[0],k=this.splitIntoFactors(b,g,Math.floor(e/l),l)[1]}var m;m=this.target&&this.target.is_group("mul")?k:this.actor&&this.actor.is_group("div")?k:j,this.setNodesToReselectAfterAction(m),od.get("cancel_common_terms_after_finding_gcf")&&(this.followup=ad.actions.FractionCancelTermsAction.createBoundAction(this.newTree,{nodes:[k],target:j}))}},a.prototype.relativePositionOfMulWithRespectToDiv=function(a,b){if(a.parent===b.parent){var c=a.parent.get_top(),d=a.parent.get_bottom();return this.positionComparison(c.indexOf(a),d.indexOf(b))}var e,f;e=a.parent.is_group("product")?a:a.parent.parent,f=b.parent.parent;var g=e.parent;return this.positionComparison(g.children.indexOf(e),g.children.indexOf(f))},a.prototype.positionComparison=function(a,b){var c=a-b;return c<0?"left":0===c?"same":"right"},a.prototype.splitIntoFactors=function(a,b,c,d){var e=new K(isNaN(c)?_c.clone(a.children[1].children[1]):new D(c),a.value),f=new K(isNaN(d)?_c.clone(a.children[1].children[1]):new D(d),a.value);this.updateNodeMap(b.get_mapping_to(e)),this.extendNodeMap(b.get_mapping_to(f));var g=a.parent,h=a.remove();return g.insert(h,f),g.insert(h,e),[e,f]},a.prototype.bothTermsAreNegative=function(a,b){return a.children[1].is_group("sign")&&b.children[1].is_group("sign")},a.prototype.extractSigns=function(a,b){var c=a.get_root(),d=this.getOldTreeNode(a),e=this.getOldTreeNode(b),f=this.splitIntoFactors(a,d,c.numeric_value(a.children[1])/-1,-1)[1],g=this.splitIntoFactors(b,e,c.numeric_value(b.children[1])/-1,-1)[1];this.oldSourceOp.is_group("mul")?this.setNodesToReselectAfterAction(f):this.setNodesToReselectAfterAction(g),od.get("cancel_common_terms_after_finding_gcf")&&(this.followup=ad.actions.FractionCancelTermsAction.createBoundAction(this.newTree,{nodes:[f],target:g}))},a.prototype.numberContainsDecimalTerm=function(a){return D.get_value(a)!==Math.floor(D.get_value(a))};var b=new a;return I.prototype.add_action_handler(b),K.prototype.add_action_handler(b),b}(),Id.prototype.move_actions.push(ad.actions.FractionCancelTermsAction),ad.actions.FractionCancelPowersAction=function(){var a=function(a){p.call(this,"FractionCancelPowersAction","cancel powers in a fraction"),this.triggerType="tap",this.priority=0,this.settings={delay:400,side:"inside",reset_x:!0,reset_y:!0},a&&(a.nodes?(this.priority=2,this.triggerType="drag",this.nodes=a.nodes,this.target=a.target):this.actor=a.actor)};ad.inherit(p,a),a.prototype.getAllAvailableActions=function(a){return od.get("cancel_powers")?ad.actions.FractionCancelTermsAction.getAllAvailableActions.call(this,a):[]},a.prototype.getTargetsForHighlighting=function(){return this.target?[this.target]:[]},a.prototype.match=function(a){return!!od.get("cancel_powers")&&ad.actions.FractionCancelTermsAction.match.call(this,a)},a.prototype.transform=function(a){ad.actions.FractionCancelTermsAction.transform.call(this,a)},a.prototype.getBoundTransformation=function(a,b){var c=this,d=a.is_group("mul")?a:b,e=b.is_group("div")?b:a,f=d.get_child([1]),g=e.get_child([1]);return!(!f.is_group("power")&&!g.is_group("power"))&&(H.haveSameBase(f,g)?function(){c.factorizePowers(d,e)}:void 0)},a.prototype.factorizePowers=function(a,b){var c=this.oldSourceOp.is_group("mul")?a:b,d=this.oldSourceOp.is_group("mul")?b:a,e=c.children[1],f=d.children[1],g=this.getOldTreeNode(c),h=this.getOldBase(e),i=(this.getOldExponentTermFromPower(f),this.getOldExponentTermFromPower(e));this.sourceIsLeftOfTarget(c,d);e.is_group("power")||(e=this.reinterpretTermAsPower(e)),f.is_group("power")||(f=this.reinterpretTermAsPower(f));var j=e.get_child([1,0]),k=f.get_child([1,0]);j.is_group("brackets")&&(j=j.children[1]),k.is_group("brackets")&&(k=k.children[1]),c.remove(),this.convertTargetExponentIntoSum(k,i,j),this.updateNodeMap(g,d),this.updateNodeMap(h.get_mapping_to(f.get_child([0]))),this.setNodesToReselectAfterAction(d)},a.prototype.sourceIsLeftOfTarget=function(a,b){if(a.parent===b.parent)return!0;var c,d;c=a.parent.is_group("product")?a:a.parent.parent,d=b.parent.is_group("product")?b:b.parent.parent;var e=c.parent;return e.children.indexOf(c)<=e.children.indexOf(d)},a.prototype.getOldBase=function(a){return a.is_group("power")?this.getOldTreeNode(a.get_child([0])):this.getOldTreeNode(a)},a.prototype.getOldExponentTermFromPower=function(a){if(!a.is_group("power"))return null;var b=this.getOldTreeNode(a),c=b.get_child([1,0]);return c.is_group("brackets")&&(c=c.get_child([1])),c},a.prototype.reinterpretTermAsPower=function(a){var b=a.parent,c=a.remove(),d=N.prototype.createParentGroup();return d.append(a),d.append(new N(new D(1))),this.updateNodeMap(a,d),b.insert(c,d),d},a.prototype.convertTargetExponentIntoSum=function(a,b,c){var d=a.parent,e=a.remove(),f=u.prototype.createParentGroup();if(d.insert(e,f),f.append(new u(a)),f.append(new u(c,"sub")),b&&b.is_group("sum"))for(var g=0;g<b.children.length;g++)this.extendNodeMap(b.children[b.children.length-g-1].get_mapping_to(f.children[f.children.length-g-1]));else b&&this.extendNodeMap(b.get_mapping_to(f.children[f.children.length-1].children[1]));this.applyInnerAction("AddSubCombineSigns",{actor:f.children[0]}),this.applyInnerAction("AddSubCombineSigns",{actor:f.children[1]}),this.cleanup(f.get_child([1])),this.cleanup(f.get_child([0])),w.handle(f),od.get("simplify_sum_after_canceling_powers")&&2===f.children.length&&ad.actions.AddSubNumbersAction.getAllAvailableActions([f.children[1]]).length>0&&(this.followup=ad.actions.AddSubNumbersAction.createBoundAction(this.newTree,{nodes:[f.children[1]],target:f.children[0]})),d.is_group("exponent")&&(d.simplify=!0)};var b=new a;return I.prototype.add_action_handler(b),K.prototype.add_action_handler(b),b}(),Id.prototype.move_actions.push(ad.actions.FractionCancelPowersAction),ad.actions.FractionCancelRangeAction=function(){var a=function(a){p.call(this,"FractionCancelRangeAction","cancel a range of terms in a fraction"),this.triggerType="tap",this.priority=2,this.settings={delay:400,side:"inside",reset_x:!0,reset_y:!0},a&&(a.nodes?(this.triggerType="drag",this.nodes=a.nodes,this.target=a.target):this.actor=a.actor)};return ad.inherit(p,a),a.prototype.getAllAvailableActions=function(a){var b=this.matchSource(a);if(!b)return[];var c=this.getTargets(b);return this.bindActionForEachTarget(a,c)},a.prototype.getTargetsForHighlighting=function(){return this.target?this.target:[]},a.prototype.matchSource=function(a){if(!_c.is_range(a))return!1;if(!a[0].is_group("mul","div"))return!1;var b=a;if(1===a.length&&(b=this.getBracketedCommGroupNodes(a[0]),b.length<2))return!1;var c=xa(a);return!!c&&{nodes:a,inner_nodes:b,top_level_group:c}},a.prototype.getTargets=function(a){var b=a.inner_nodes,c=b[0],d=b[b.length-1];return _c.filterRange(function(a){if(!a[0].is_group("mul","div"))return!1;var e=1===a.length?this.getBracketedCommGroupNodes(a[0]):a;if(!e.some(function(a){return a===c||a===d}))return wa(b,e,!0,!1)||wa(b,e,!1,!0)}.bind(this),a.top_level_group)},a.prototype.containsCommGroupNodes=function(a){return this.getBracketedCommGroupNodes(a).length>0},a.prototype.getBracketedCommGroupNodes=function(a){for(var b=a.children[1];b.is_group("brackets");)b=b.children[1];return b.is_group()&&b.children[0].commutative?b.children:[]},a.prototype.transform=function(a){var b=this.getSourceAndTarget(!0);this.addTouchedNodes(b.source),this.addTouchedNodes(b.target);var c=this.getNewTreeNode(b.source),d=this.getNewTreeNode(b.target),e=this.matchSource(c),f=1===d.length?this.getBracketedCommGroupNodes(d[0]):d,g=wa(e.inner_nodes,f,!1,!0),h=c[0].parent;_c.remove_range(c);if(_c.remove_range(d),g&&h.append(new K(new D(-1))),h.is_group("fraction")&&h.parent.is_group("mul")&&h.get_parent(2).is_group("product")&&1===h.children.length&&h.parent.remove(),this.setNodesToReselectAfterAction(e.top_level_group),this.cleanStructure(e.top_level_group),"function"!=typeof a)return!0;a(this)},a.prototype.cleanStructure=function(a){var b=!1;a.is_group("product")&&a.children.forEach(function(a){a.children[1].is_group("fraction")&&(b=this.cleanup_cascade(a.children[1]))},this),b||this.cleanup_cascade(a)},new a}(),Id.prototype.move_actions.push(ad.actions.FractionCancelRangeAction),ad.actions.FractionMoveInnerNested=function(){var a=function(a){if(p.call(this,"FractionMoveInnerNested","move a term across a nested fraction"),this.priority=1,this.triggerType="drag",this.settings={delay:1500,reset_y:!0,target_group:!0,group_side:"around",no_target_box_expansion:!0},a){var b=a.target.is_group("div")?{y1:.2,x:-.1}:{y2:.2,x:-.1},c={node:I.get_whole_range(a.target),side:"around",margin:b},d={margin:b};this.initSettings(ad.extend(a,{drop_area:c,drop_area_hint:d}))}};return ad.inherit(p,a),a.prototype.getAllAvailableActions=function(a){var b=this.matchSource(a);if(!b)return[];var c=this.getTargets(b);return this.bindActionForEachTarget(a,c.inner,!0).concat(this.bindActionForEachTarget(a,c.outer,!0))},a.prototype.matchSource=function(a){if(!_c.is_range(a))return!1;var b=a[0],c=b.parent,d=c.get_parent(2);if(!(b.is_group("mul","div")&&c.is_group("fraction")&&d&&d.is_group("fraction")))return!1;var e=b.children[1];return!(1===D.get_value(e)&&b.is_group("mul")&&!b.ls&&b.rs&&"//"===b.rs.value)&&{nodes:a,inner_frac:c,outer_frac:d}},a.prototype.getTargets=function(a){var b=a.nodes[0].is_group("mul"),c=a.inner_frac.parent.is_group("mul"),d=c?a.outer_frac.get_bottom():a.outer_frac.get_top(),e={outer:[],inner:[]};return d.forEach(function(a){var c=a.children[1];c.is_group("fraction")&&(e.inner=e.inner.concat(b?c.get_bottom():c.get_top())),b||e.outer.push(a)}),e},a.prototype.adjustTargetBoxes=function(a){return a.forEach(function(a){a.target.is_group("div")?a.settings.margin={y1:.3}:a.settings.margin={y2:.3}},this),a},a.prototype.transform=function(a){this.addTouchedNodes(this.nodes);var b=this.matchSource(this.getNewTreeNode(this.nodes)),c=b.nodes,d=c[0].parent,e=this.getNewTreeNode(this.target);_c.remove_range(c),e.value!==c[0].value&&c.forEach(function(a){return a.invert()});var f=e.get_idx()+("left-of"===this.settings.side?0:1);return e.parent.insert_range(f,c),this.cleanup_cascade(d),"function"==typeof a&&a(this),this},new a}(),Id.prototype.move_actions.push(ad.actions.FractionMoveInnerNested),ad.actions.FractionMoveOuterNested=function(){var a=function(a){if(p.call(this,"FractionMoveOuterNested","move a term across a nested fraction"),this.priority=1,this.triggerType="drag",this.settings={delay:1500,reset_y:!0,target_group:!0,group_side:"around",no_target_box_expansion:!0},a){var b=a.target.is_group("mul")?{y1:.2,x:-.1}:{y2:.2,x:-.1},c={node:I.get_whole_range(a.target),side:"around",margin:b},d={margin:b};this.initSettings(ad.extend(a,{drop_area:c,drop_area_hint:d}))}};return ad.inherit(p,a),a.prototype.getAllAvailableActions=function(a){var b=this.matchSource(a);if(!b)return[];var c=this.getTargets(b);return this.bindActionForEachTarget(a,c,!0)},a.prototype.matchSource=function(a){if(!_c.is_range(a))return!1;var b=a[0];return!!b.parent.is_group("fraction")&&{nodes:a,frac:b.parent}},a.prototype.getTargets=function(a){var b=a.nodes[0].is_group("mul"),c=b?a.frac.get_bottom():a.frac.get_top(),d=[];return c.forEach(function(a){var b=a.children[1];b.is_group("fraction")&&(d=d.concat(b.get_bottom()))}),d},a.prototype.adjustTargetBoxes=function(a){return a.forEach(function(a){a.target.is_group("div")?a.settings.margin={y1:.3}:a.settings.margin={y2:.3}},this),a},a.prototype.transform=function(a){this.addTouchedNodes(this.nodes);var b=this.matchSource(this.getNewTreeNode(this.nodes)),c=b.nodes,d=c[0].parent,e=this.getNewTreeNode(this.target);_c.remove_range(c),e.value!==c[0].value&&c.forEach(function(a){return a.invert()});var f=e.get_idx()+("left-of"===this.settings.side?0:1);return e.parent.insert_range(f,c),this.cleanup_cascade(d),"function"==typeof a&&a(this),this},new a}(),Id.prototype.move_actions.push(ad.actions.FractionMoveOuterNested),ad.actions.ReorderSumInFractionDenominatorAction=function(){var a=function(a){p.call(this,"ReorderSumInFractionDenominatorAction","reorder sum in a fraction's denominator"),this.priority=2,this.triggerType="dbltap",a&&(this.actor=a.actor)};return ad.inherit(p,a),a.prototype.match=function(a){if(!a)return!1;if(!a.is_group("add","sub"))return!1;if(!a.ls)return!1;var b=a.ls;return!(!b.children[1].is_group("fraction")||!a.children[1].is_group("fraction"))&&this.denominatorsHaveMatchingSums(b.children[1],a.children[1])},a.prototype.denominatorsHaveMatchingSums=function(a,b){var c=a.get_bottom(),d=b.get_bottom();if(1!==c.length||1!==d.length)return!1;if(!w.areHidden(c[0].children[1])||!c[0].children[1].children[1].is_group("sum"))return!1;if(!w.areHidden(d[0].children[1])||!d[0].children[1].children[1].is_group("sum"))return!1;var e=c[0].children[1].children[1],f=d[0].children[1].children[1];if(e.to_ascii()===f.to_ascii())return!1;var g=function(a){return a.to_ascii()};return ad.array.isPermutation(e.children.map(g),f.children.map(g))},a.prototype.transform=function(a){this.addTouchedNodes(this.actor),this.addTouchedNodes(this.actor.ls);var b=this.getNewTreeNode(this.actor.ls).children[1],c=this.getNewTreeNode(this.actor).children[1];if(this.sortDenominatorsToMatch(b,c),"function"!=typeof a)return!0;a(this)},a.prototype.sortDenominatorsToMatch=function(a,b){for(var c=a.get_bottom()[0].children[1].children[1],d=b.get_bottom()[0].children[1].children[1],e=c.children.slice(),f=d.children.slice(),g=0;g<e.length;g++)if(e[g].to_ascii()!==f[g].to_ascii())for(var h=g;h<f.length;h++)if(e[g].to_ascii()===f[h].to_ascii()){var i=f[h];i.remove(),d.insert(g,i),f=d.children.slice()}},u.prototype.add_action_handler(new a),new a}(),ad.actions.CrossMultiplyFractionsAction=function(){var a=function(a){p.call(this,"CrossMultiplyFractionsAction","cross multiply fractions"),this.priority=1,this.triggerType="dbltap",a&&(this.actor=a.actor)};return ad.inherit(p,a),a.prototype.match=function(a){return!!a&&(!!a.is_group("add","sub")&&(!!a.ls&&(a.ls.children[1].is_group("fraction")&&a.children[1].is_group("fraction"))))},a.prototype.transform=function(a){this.addTouchedNodes(this.actor),this.addTouchedNodes(this.actor.ls);var b=this.getNewTreeNode(this.actor.ls).children[1],c=this.getNewTreeNode(this.actor).children[1],d=this.getUncommonDenominatorFactors(b,c),e=this.getUncommonDenominatorFactors(this.actor.ls.children[1],this.actor.children[1]);if(d.leftUncommonFactors.forEach(_c.remove),d.rightUncommonFactors.forEach(_c.remove),this.sortDenominatorsToMatch(b,c),d.leftUncommonFactors.length>0){var f=this.extendFractionWithFactors(b,d.leftUncommonFactors),g=this.extendFractionWithFactors(c,d.leftUncommonFactors,!0,!0);this.mapOldFactorsToNewFactors(e.leftUncommonFactors,f,g)}if(d.rightUncommonFactors.length>0){var h=this.extendFractionWithFactors(b,d.rightUncommonFactors,!0),i=this.extendFractionWithFactors(c,d.rightUncommonFactors);this.mapOldFactorsToNewFactors(e.rightUncommonFactors,h,i)}if("function"!=typeof a)return!0;a(this)},a.prototype.getUncommonDenominatorFactors=function(a,b){for(var c=a.get_bottom().slice(),d=b.get_bottom().slice(),e=0;e<c.length;){for(var f=c[e],g=!1,h=0;h<d.length;h++){var i=d[h];if(f.to_ascii()===i.to_ascii()){d.splice(h,1),g=!0;break}}g?c.splice(e,1):e++}return{leftUncommonFactors:c,rightUncommonFactors:d}},a.prototype.sortDenominatorsToMatch=function(a,b){for(var c=a.get_bottom().slice(),d=b.get_bottom().slice(),e=0;e<c.length;e++)if(c[e].to_ascii()!==d[e].to_ascii())for(var f=e;f<d.length;f++)if(c[e].to_ascii()===d[f].to_ascii()){var g=d[f];g.remove(),b.insert(b.get_top().length+e+1,g),d=b.get_bottom().slice();break}},a.prototype.extendFractionWithFactors=function(a,b,c,d){var e=[];return c&&1===a.get_top().length&&D.is_num(a.children[0].children[1])&&1===D.get_value(a.children[0].children[1])&&a.children[0].remove(),b.forEach(function(f){var g=[],h=f.clone();g.push(h),a.append(h),c&&(h=f.clone(),h.invert(),g.push(h),d?a.insert(b.indexOf(f),h):a.append(h)),e.push(g)}),e},a.prototype.mapOldFactorsToNewFactors=function(a,b,c){for(var d=0;d<a.length;d++)for(var e=a[d],f=b[d].concat(c[d]),g=0;g<f.length;g++)this.extendNodeMap(e.get_mapping_to(f[g]))},u.prototype.add_action_handler(new a),new a}(),ae=function(a){function b(a){id(this,b);var c=pd(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,"RelationOfAbsValAction","resolve the cases for the absolute value"));return c.priority=0,c.triggerType="dbltap",c.settings={delay:1500,on_release:!0,side:"inside",makes_no_changes:!0},c.elements=[],a&&(a.actor?c.actor=a.actor:(c.triggerType="drag",c.nodes=a.nodes,c.target=a.target),"inverted_case"in a&&(c.settings.inverted_case=a.inverted_case)),c}return qd(b,a),jd(b,[{key:"match",value:function(a){return a.is_group("abs-val")&&Ta(a.parent)}},{key:"getAllAvailableActions",value:function(a){var b=Ra(a);if(!b)return[];var c=Sa(b);return this.bindActionForEachTarget(a,c)}},{key:"rebind",value:function(a,b,c){if(this.oldTree!==c)throw"wrong old tree during rebinding an action!";var d=new p;d.node_map=b,this.oldTree=a,this.nodes&&(this.nodes=d.mapNodes(this.nodes)),this.actor&&(this.actor=d.mapNodes(this.actor)[0])}},{key:"rematch",value:function(){return this.actor?this.match(this.actor):1===this.nodes.length&&this.match(this.nodes[0])}},{key:"transform",value:function(a){return this.target&&"AlgebraModel"===this.target.type?this.transform_update(a):this.transform_initial(a)}},{key:"transform_initial",value:function(a){var b=this.getSourceAndTarget();this.addTouchedNodes(b.source.parent);var c=this.getNewTreeNode(b.source),d=c.parent,e=(0===c.get_idx()?d.children[2]:d.children[0],void 0);e=d.is_group("lt","lte")&&0===c.get_idx()?"and":d.is_group("gt","gte")&&2===c.get_idx()?"and":"or",this.node_map={};var f=this.transform_case(this.oldTree.clone(),!0),g=be.createBoundAction(this.oldTree,{nodes:[b.source],target:f,inverted_case:!0});g.node_map=this.node_map,this.node_map={};var h=this.transform_case(this.oldTree.clone(),!1),i=be.createBoundAction(this.oldTree,{nodes:[b.source],target:h,inverted_case:!1});return i.node_map=this.node_map,this.node_map={},this.elements.push({type:"derivation",model:h,action:i}),this.elements.push({type:"textbox",text:e}),this.elements.push({type:"derivation",model:f,action:g}),this.setNodesToReselectAfterAction([c]),"function"==typeof a&&a(this),!0}},{key:"transform_update",value:function(a){return this.node_map={},this.transform_case(this.newTree,this.settings.inverted_case),this.target=this.newTree,"function"==typeof a&&a(this),!0}},{key:"transform_case",value:function(a,b){var c=a.children[0],d=a.get_child([0,(this.actor||this.nodes[0]).get_idx()]),e=0===d.get_idx()?c.children[2]:c.children[0];return this.extendNodeMap(this.oldTree.get_mapping_to(a)),d.replace_with(d.children[1]),b&&F.is_inequality(c)&&c.invert(),b&&Q.invertTerm(e),a}}]),b}(p),be=new ae,B.prototype.add_action_handler(be),ad.actions.RelationOfAbsValAction=be,Id.prototype.move_actions.push(be),ad.actions.RootEvaluateAction=function(){var a=function(a){p.call(this,"RootEvaluateAction","evaluate a root"),this.priority=0,this.triggerType="tap",a&&(this.actor=a.actor)};ad.inherit(p,a),a.prototype.match=function(a){if(!a.is_group("radical"))return!1;var b=a.get_degree().get_term(),c=a.get_radicand();return D.is_inequal_to(c,"gte",0)&&D.is_num(b)&&0!==D.get_value(b)||D.is_inequal_to(c,"lt",0)&&D.is_inequal_to(b,"gt",0)&&D.get_value(b)%2==1},a.prototype.transform=function(a){this.addTouchedNodes(this.actor);var b=this.getNewTreeNode(this.actor),c=Math.pow(Math.abs(D.get_value(b.get_radicand())),1/D.get_value(b.get_degree().get_term())),d=new D(c);if(this.updateNodeMap(this.actor.get_mapping_to(d)),_c.replace(b,d),D.get_value(b.get_radicand())<0){var e=d.parent,f=d.remove(),g=new Q(d);e.insert(f,g)}if("function"!=typeof a)return!0;a(this)};var b=new a;return C.prototype.add_action_handler(b),b}(),C.prototype.add_action_handler(ad.actions.RootEvaluateAction),ad.actions.RadicalExtractExponentAction=function(){var a=function(a){if(p.call(this,"RadicalExtractExponentAction","factor power"),this.interactionType="drag",this.settings={side:"right-of",reset_x:!0,reset_y:!0},a){var b={node:a.target.parent.parent,margin:{y2:.5,y1:-.3,x1:.1,x2:-.6}},c={node:a.target.parent.parent,margin:{y2:.5,y1:-.3,x1:.1,x2:-.6}},d=[{node:a.target.parent.parent,margin:{y2:.6,y1:-.2,x1:.1,x2:-.1}}];this.initSettings(ad.extend(a,{drop_area:b,drop_area_hint:c,destination_hint:d}))}};return ad.inherit(p,a),a.prototype.getAllAvailableActions=function(a){var b=this.matchSource(a);if(!b)return[];var c=this.getTargets(b);return this.bindActionForEachTarget(a,c)},a.prototype.matchSource=function(a){return 1===a.length&&(!!a[0].is_group("exponent")&&(!!(a[0].parent.parent&&a[0].parent.parent.parent&&a[0].get_parent(3).is_group("radical"))&&{nodes:a,power:a[0].parent}))},a.prototype.getTargets=function(a){return[a.power]},a.prototype.transform=function(a){this.addTouchedNodes(this.target.parent);var b=this.getNewTreeNode(this.nodes)[0],c=b.parent,d=c.get_parent(2),e=d.parent,f=c.children[0];c.replace_with(f),w.handle(f),w.handle(f.parent,!0);var g=d.remove();if(b.remove(),e.insert(g,new H(d,b)),"function"!=typeof a)return!0;a(this)},new a}(),Id.prototype.move_actions.push(ad.actions.RadicalExtractExponentAction),ad.actions.RadicalInsertExponentAction=function(){var a=function(a){if(p.call(this,"RadicalInsertExponentAction","factor power"),this.interactionType="drag",this.settings={side:"inside",reset_x:!0,reset_y:!0},a){var b=a.target.children[3],c={node:b},d=[{node:b,side:"right-of",margin:{y2:.5}}];this.initSettings(ad.extend(a,{drop_area_hint:c,destination_hint:d}))}};return ad.inherit(p,a),a.prototype.getAllAvailableActions=function(a){var b=this.matchSource(a);if(!b)return[];var c=this.getTargets(b);return this.bindActionForEachTarget(a,c)},a.prototype.matchSource=function(a){if(!_c.is_range(a))return!1;if(!(a[0].is_group("exponent")||a[0].is_group("mul","div")&&w.areHidden(a[0].get_parent(2))&&a[0].get_parent(3).is_group("exponent")))return!1;var b=a[0].parent.is_group("power")?a[0].parent:a[0].get_parent(4);return!(!b.children[0].is_group("brackets")||!b.children[0].children[1].is_group("radical"))&&{nodes:a,radical:b.get_child([0,1])}},a.prototype.getTargets=function(a){return[a.radical]},a.prototype.transform=function(a){this.addTouchedNodes(this.target.parent);var b=this.getNewTreeNode(this.nodes),c=b[0].is_group("exponent")?b[0]:b[0].get_parent(3),d=c.parent,e=d.get_child([0,1]),f=e.get_radicand();d.parent;if(b[0]===c){d.replace_with(e),f.remove();var g=new H(f,c);e.set_radicand(g)}else{_c.remove_range(b);var h=new I;h.append_range(b);var i=new N(h);f.remove();var g=new H(f,i);e.set_radicand(g),this.cleanup_cascade(c.get_child([0,1])),D.is_equal_to(c.children[0],1)&&(c.remove(),this.cleanup(d)),this.cleanup_cascade(b[0].parent)}if("function"!=typeof a)return!0;a(this)},new a}(),Id.prototype.move_actions.push(ad.actions.RadicalInsertExponentAction),ce=function(a){function b(a){id(this,b);var c=pd(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,"RadicalSplitAction","turn a radical that has a product radicand into a product of radicals"));return c.priority=1,c.triggerType="drag",c.settings={target_group:!0,group_side:"outside",margin:{x2:-.2,y:-.75}},c.elements=[],a&&(a.target&&"AlgebraModel"!==a.target.type&&(a.drop_area={node:a.target.parent.parent},a.drop_area_hint={margin:"left-of"===a.side?{x1:-.5,x2:.1}:{x1:.1,x2:-.5}},a.destination_hint=[{node:a.target.parent.parent,margin:"left-of"===a.side?{y1:-.1}:{x1:.15,x2:-.15,y1:-.1}}]),c.initSettings(a)),c}return qd(b,a),jd(b,[{key:"getAllAvailableActions",value:function(a){var b=Ua(a);if(!b)return[];var c=Va(b);return this.bindActionForEachTarget(a,c,!0)}},{key:"rematch",value:function(){return"AlgebraModel"===this.target.type||this.getAllAvailableActions(this.nodes).length>0}},{key:"rebind",value:function(a,b,c){if(this.oldTree!==c)throw"wrong old tree during rebinding an action!";var d=new p;d.node_map=b,this.oldTree=a,this.nodes=d.mapNodes(this.nodes),!this.target||this.target instanceof Id?this.target={type:"AlgebraModel"}:this.target=d.mapNodes(this.target)[0]}},{key:"transform",value:function(a){return this.target&&"AlgebraModel"===this.target.type?this.transformUpdate(a):this.transformInitial(a)}},{key:"transformInitial",value:function(a){this.addTouchedNodes(this.target.parent);var b=this.getNewTreeNode(this.nodes);isNaN(Oa(b))&&this.elements.push(this.defineRestrictionExpression(b));var c=sd.get_siblings(b).filter(function(a){return a.is_group("mul","div")});isNaN(Oa(c))&&this.elements.push(this.defineRestrictionExpression(c));var d=b[0].parent,e=d.get_parent(2),f=e.parent,g=e.remove();_c.remove_range(b);var h=e.clone(!1);h.set_radicand(null);var i=!1,j=new I;1===b.length&&I.is_fraction_with_identity_numerator(b[0].children[1])&&(b=b[0].children[1].get_bottom(),_c.remove_range(b)),b.forEach(function(a){a.is_group("div")&&(i=!0,a.invert()),j.append(a)},this),h.set_radicand(j);var k=new I;k.append(new K(e));var l=new K(h,i?"div":"mul");return k.insert("left-of"===this.settings.side?0:1,l),f.insert(g,k),this.nodes[0].get_parent(3).map_to_radical(this,h),this.setNodesToReselectAfterAction(l),this.cleanup(d),this.cleanup(j),this.cleanup(k),this.cleanup_cascade(f),"function"==typeof a&&a(this),this}},{key:"transformUpdate",value:function(a){return this.node_map={},this.createRestrictionModel(this.newTree,this.nodes),this.target=this.newTree,"function"==typeof a&&a(this),!0}},{key:"createRestrictionModel",value:function(a,b){var c=this;a.children[0].remove();var d=Id.cloneNodes(b),e=void 0;1===b.length?e=d[0].children[1]:(e=new I,d.forEach(function(a){return e.append(a)}));var f=new F(e,new D(0),"gte");return a.append(f),a.hide_nodes(),1===b.length?this.updateNodeMap(b[0].children[1].get_mapping_to(e)):b.forEach(function(a,b){return c.updateNodeMap(a.get_mapping_to(e.children[b]))}),a}}]),b}(p),de=new ce,ad.actions.RadicalSplitAction=de,Id.prototype.move_actions.push(de),ad.actions.ScaleTupleAction=function(){var a=function(a){p.call(this,"ScaleTupleAction","multiply a tuple by a number"),this.priority=1,this.triggerType="tap",this.settings={delay:300,side:"inside",reset_x:!0,reset_y:!0},a&&("drag"===a.triggerType?(this.triggerType=a.triggerType,this.nodes=a.nodes,this.target=a.target):this.actor=a.actor)};return ad.inherit(p,a),a.prototype.isTupleMul=function(a){return a&&a.is_group("mul")&&a.children[1].is_group("brackets")&&a.children[1].children[1].is_group("tuple")},a.prototype.getAllAvailableActions=function(a){if(!a.every(this.isScalarMul.bind(this)))return[];var b=this,c=a[0].parent.children.filter(this.isTupleMul.bind(this)),d=a[0].get_root();return c.map(function(c){return b.createBoundAction(d,{nodes:a,target:c,triggerType:"drag"})})},a.prototype.getTupleFactorsInSum=function(a){var b=this;return re,sum.children.filter(function(a){return a!==n&&b.isTupleAddend(a,len)})},a.prototype.isScalarMul=function(a){return a&&a.is_group("mul","div")&&!a.select_first(function(a){return a.is_group("tuple")})},a.prototype.extract=function(a){return!!a&&(this.isTupleMul(a)&&this.isScalarMul(a.ls)?{scalars:[a.ls],tuple:a}:!(!this.isTupleMul(a.ls)||!this.isScalarMul(a))&&{scalars:[a],tuple:a.ls})},a.prototype.match=function(a){if(a.is_group("fraction")){var b=a.get_top(),c=a.get_bottom();if(1===b.length&&this.isTupleMul(b[0])&&c.every(this.isScalarMul))return!0}else if(a.is_group("mul","div"))return!!this.extract(a);return!1},a.prototype.getTupleAndScalars=function(){var a={};if("tap"===this.triggerType){this.addTouchedNodes(this.actor);var b=this.getNewTreeNode(this.actor);if(this.actor.is_group("fraction"))a.parent_product=b,a.tuple=b.get_child([0,1,1]),a.scalar_muldivs=b.get_bottom();else{var c=this.extract(b);a.scalars_were_on_the_left=c.scalars[0].get_idx()<c.tuple.get_idx(),a.parent_product=b.parent,a.tuple=c.tuple.get_child([1,1]),a.scalar_muldivs=c.scalars}}else{this.addTouchedNodes(this.nodes),this.addTouchedNodes(this.target);var d=this.getNewTreeNode(this.nodes),e=this.getNewTreeNode(this.target);a.scalars_were_on_the_left=d[0].get_idx()<e.get_idx(),a.parent_product=d[0].parent,a.scalar_muldivs=d,a.tuple=e.get_child([1,1])}return a},a.prototype.transform=function(a){for(var b=this.getTupleAndScalars(),c=b.scalars_were_on_the_left,d=b.parent_product,e=b.scalar_muldivs,f=b.tuple,g=0;g<f.children.length;g++)this.scale_parameter(c,f.children[g],e);_c.remove_range(e),this.cleanup(d);for(var g=0;g<f.children.length;g++)this.cleanup_nested_products(f.children[g].children[1]);return"function"==typeof a&&a(this),this},a.prototype.scale_parameter=function(a,b,c){var d=b.children[1],e=d.is_group("fraction")?d:new I,f=_c.clone(c);this.extendNodeMap(_c.get_mapping_between(this.nodes||this.getOldTreeNode(c),f)),d.remove(),e.is_group("product")?(e.append(new K(d)),e.insert_range(a?0:1,f)):a?f.forEach(function(a){a.is_group("div")?e.insert_into_denominator(0,a):e.insert(0,a)}):f.forEach(function(a){e.append(a)}),e.simplify=!0,b.append(e)},a.prototype.cleanup_nested_products=function(a){for(var b=0;b<a.children.length;b++)this.cleanup(a.children[b])},K.prototype.add_action_handler(new a),I.prototype.add_action_handler(new a),new a}(),Id.prototype.move_actions.push(ad.actions.ScaleTupleAction),ad.actions.SplitExponentsAction=function(){var a=function(a){p.call(this,"SplitExponentsAction","split exponents"),this.triggerType="drag",this.settings={margin:{}},a&&(this.nodes=a.nodes,this.target=a.target,this.settings.side=a.side,this.settings.margin="right-of"===a.side?{x2:-1,x1:.25}:{x1:-1})};return ad.inherit(p,a),a.prototype.getAllAvailableActions=function(a){if(!this.match(a[0]))return[];if(a.length===a[0].parent.children.length)return[];var b=a[0].get_root(),c=a[0].parent.parent.parent.parent;return[this.createBoundAction(b,{nodes:a,target:c,side:"left-of"}),this.createBoundAction(b,{nodes:a,target:c,side:"right-of"})]},a.prototype.match=function(a){return a.is_group("add","sub")&&a.get_parent(3)&&a.get_parent(3).is_group("exponent")},a.prototype.transform=function(a){var b=this.getSourceAndTarget(!0);this.addTouchedNodes(b.target);var c=this.getNewTreeNode(b.source),d=c[0].parent,e=this.getNewTreeNode(b.target),f=e.parent,g=e.remove();_c.remove_range(c);var h=e.children[0].clone(),i=new t;i.append_range(c);var j=new H(h,i);this.extendMapFromPowerToPower(b.target,j);var k=new I;k.append(new K(e));var l=new K(j);if(k.insert("left-of"===this.settings.side?0:1,l),this.setNodesToReselectAfterAction(l),f.insert(g,k),this.cleanNodes(d,i),this.cleanup(f),j.children[1].simplify=!0,"function"!=typeof a)return!0;a(this)},a.prototype.extendMapFromPowerToPower=function(a,b){this.extendNodeMap(a.children[0].get_mapping_to(b.children[0])),this.extendNodeMap(a.children[1],b.children[1]),this.extendNodeMap(a.get_child([1,0]),b.get_child([1,0])),this.extendNodeMap(a.get_child([1,0,0]),b.get_child([1,0,0])),this.extendNodeMap(a.get_child([1,0,2]),b.get_child([1,0,2])),this.extendNodeMap(a.get_child([1,0,1]),b.get_child([1,0,1]))},a.prototype.cleanNodes=function(){for(var a=arguments.length,b=Array(a),c=0;c<a;c++)b[c]=arguments[c];b.forEach(this.cleanup.bind(this))},new a}(),Id.prototype.move_actions.push(ad.actions.SplitExponentsAction),ad.actions.SplitNumberAction=function(){var a=function(a){p.call(this,"SplitNumberAction","n => (n-1) + 1"),this.priority=0,this.triggerType="split",a&&(this.actor=a.actor)};return ad.inherit(p,a),a.prototype.match=function(a){return a instanceof D&&a.value>1},a.prototype.transform=function(a){var b=this.getNewTreeNode(this.actor);this.addTouchedNodes(this.actor);var c=b.parent,d=b.remove();b.value--;var e=u.prototype.createParentGroup();return e.append(new u(b)),e.append(new u(new D(1))),this.resultNodes=e.children.slice(),this.updateNodeMap(this.actor.get_mapping_to(e)),c.insert(d,e),w.handle(e),this.cleanup(c),"function"==typeof a&&a(this),!0},new a}(),ad.actions.SplitProductAction=function(){var a=function(a){p.call(this,"SplitProductAction","n*x => (n-1)*x + x"),this.priority=1,this.triggerType="split",a&&(this.actor=a.actor,"priority"in a&&(this.priority=a.priority))};return ad.inherit(p,a),a.prototype.match=function(a){return a.is_group("mul")&&a.children[1]instanceof D&&a.children[1].value>1&&a.rs},a.prototype.transform=function(a){var b=this.getNewTreeNode(this.actor),c=b.parent,d=b.children[1];this.addTouchedNodes(this.actor),d.value--;var e,f=c.children.slice(c.children.indexOf(b)),g=this.getOldTreeNode(f),h=_c.remove_range(f),i=u.prototype.createParentGroup(),j=K.prototype.createParentGroup(),k=K.prototype.createParentGroup();1===d.value?(f=f.slice(1),j.insert_range(0,f),e=_c.clone(f),k.insert_range(0,e),this.extendNodeMap(_c.get_mapping_between(g.slice(1),e))):(j.insert_range(0,f),e=_c.clone(f),k.insert_range(0,e),k.children[0].remove(),this.extendNodeMap(_c.get_mapping_between(g,e))),i.append(new u(j)),i.append(new u(k));var l=new K(i);c.insert(h,l),this.cleanup(j),this.cleanup(k);var m=c.parent;return this.cleanup(c)&&this.cleanup(m),"function"==typeof a&&a(this),!0},a.prototype.mapIndex=function(){return map={},function(a){return map[a]}},new a}(),ad.actions.SplitPowerAction=function(){var a=function(a){p.call(this,"SplitPowerAction","x^n => x^(n-1) * x"),this.priority=2,this.triggerType="split",a&&(this.actor=a.actor,"priority"in a&&(this.priority=a.priority))};return ad.inherit(p,a),a.prototype.match=function(a){return a.is_group("exponent")&&a.children[0]instanceof D&&a.children[0].value>=1},a.prototype.transform=function(a){var b=this.getNewTreeNode(this.actor),c=b.parent,d=c.parent;this.addTouchedNodes(this.actor);var e=c.remove(),f=K.prototype.createParentGroup();f.append(new K(c));var g=_c.clone(c.children[0]);this.extendNodeMap(this.actor.parent.children[0].get_mapping_to(g)),f.append(new K(g));var h=b.children[0];if(h.value--,this.extendNodeMap(this.actor.children[0],g.parent),1===h.value){var i=c.children[0];c.remove(),f.children[0].append(i),this.extendNodeMap(this.actor.children[0],i.parent)}else 0===h.value&&f.children[0].remove();return this.resultNodes=f.children.slice(),d.insert(e,f),this.cleanup(d),"function"==typeof a&&a(this),!0},new a}(),ad.actions.SplitPowerSumAction=function(){var a=function(a){p.call(this,"SplitPowerSumAction","x^(n1+n2+...+nm) => x^(n1+n2+...) * x^(nm)"),this.priority=3,this.triggerType="split",a&&(this.actor=a.actor)};return ad.inherit(p,a),a.prototype.match=function(a){return a.is_group("exponent")&&(a.children[0].is_group("brackets")&&a.children[0].children[1].is_group("sum")||a.children[0].is_group("sum"))},a.prototype.transform=function(a){var b=this.getNewTreeNode(this.actor),c=b.parent,d=c.parent,e=b.children[0];e.is_group("brackets")&&(e=e.children[1]);var f=e.children[e.children.length-1],g=this.getOldTreeNode(f.children[0]);this.addTouchedNodes(this.actor.parent);var h=c.remove(),i=K.prototype.createParentGroup();i.append(new K(c));var j=_c.clone(c);i.append(new K(j)),j.children[1].children[0].remove(),f.remove();var k=f.createParentGroup();return k.append(f),j.children[1].append(k),d.insert(h,i),g.parent.is_group("add")?this.updateNodeMap(g,i.children[1].children[0]):this.extendNodeMap(g,i.children[1].children[0]),this.cleanup(f.parent),this.cleanup(e),this.cleanup(d),"function"==typeof a&&a(this),!0},new a}(),ee=function(a){function b(a){id(this,b);var c=pd(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,"DistributeIntoBracketsAction","distribute"));if(c.triggerType="drag",c.settings={reset_x:!0,reset_y:!0,delay:300},c.priority=2,a){var d={nodes:a.target.children.map(function(a){return a.children[1]})};c.initSettings(ad.extend(a,{destination_hint:d}))}return c}return qd(b,a),jd(b,[{key:"getAllAvailableActions",value:function(a){var b=Wa(a);if(!b)return[];var c=Xa(b);return this.bindActionsForEachTarget(a,c)}},{key:"bindActionsForEachTarget",value:function(a,b){var c=this,d=[],e=a[0].get_root();return b.forEach(function(b){d.push(c.createBoundAction(e,{nodes:a,target:b,side:"left-inside"})),d.push(c.createBoundAction(e,{nodes:a,target:b,side:"right-inside"}))}),d}},{key:"transform",value:function(a){var b=this.getSourceAndTarget(!0);this.addTouchedNodes(b.source),this.addTouchedNodes(b.target);var c=this.getNewTreeNode(b.source),d=this.getNewTreeNode(b.target),e=d.parent,f=b.target.parent.children[0],g=b.target.parent.children[2],h=e.get_parent(2);_c.remove_range(c),this.distributeIntoSum(d,c),this.cleanup(h);var i=d.parent;if(!i.is_group("brackets")||i.is_group("brackets")&&i.parent.is_group("mul","div")&&i.parent.parent.is_group("fraction")&&(i.parent.is_group("mul")?1===i.parent.parent.get_top().length:1===i.parent.parent.get_bottom().length)){var j=d.remove(),k=new w(d);_c.insert(i,j,k),this.updateNodeMap(f.parent,k),this.updateNodeMap(f,k.children[0]),this.updateNodeMap(g,k.children[2]),k.simplify=!0}if("function"!=typeof a)return!0;a(this)}},{key:"distributeIntoSum",value:function(a,b){for(var c=this.settings.side,d=a.children.length,e=function(a){a.is_group("div")&&a.invert()},f=0;f<d;f++){var g=a.children[f].children[1],h=void 0,i=void 0;g.remove(),g.is_group("product")?h=g:(h=new I,h.append(new K(g))),i="left-inside"===c&&0===f||"right-inside"===c&&f===d-1?b:_c.clone(b),i.forEach(e),this.extendNodeMap(_c.get_mapping_between(this.nodes,i));var j="left-inside"===c?1:h.children.length-1;h.children[j]&&(h.children[j].simplify=!0);var k="left-inside"===c?0:h.children.length;h.insert_range(k,i),a.children[f].append(h),$a(b)&&(Ya(b)||Za(h))&&(h.children.forEach(function(a){a.simplify=!1}),h.simplify=!0)}}}]),b}(p),fe=new ee,ad.actions.DistributeIntoBracketsAction=fe,Id.prototype.move_actions.push(fe),ad.actions.FactorOutOfBracketsAction=function(){var a=function(a){p.call(this,"FactorOutOfBracketsAction","factor out"),this.priority=0,this.triggerType="drag",this.settings={reset_x:!0,margin:{}},a&&(this.setActorAndTarget(a),this.settings.side=a.side,this.settings.margin["right-of"===a.side?"x2":"x1"]=-1.5)};return ad.inherit(p,a),a.prototype.getAllAvailableActions=function(a){if(0===a.length)return[];for(var b=[],c=a[0];c.parent&&!c.is_group("brackets");)c=c.parent;return this.match(a)&&(b.push(this.bindLeftSideAction(c,a)),b.push(this.bindRightSideAction(c,a))),b},a.prototype.nodesAreAllAddends=function(a,b){return!!a.is_group("sum")&&a.children.length===b.length},a.prototype.bindLeftSideAction=function(a,b){var c=b[0].get_root();return this.createBoundAction(c,{nodes:b,target:a.children[0],side:"left-of"})},a.prototype.bindRightSideAction=function(a,b){var c=b[0].get_root();return this.createBoundAction(c,{nodes:b,target:a.children[2],side:"right-of"})},a.prototype.getContainingBrackets=function(a){try{for(var b=null,c=0;c<a.length;c++){var d=a[c][0],e=d.is_group("mul")?d.get_parent(4):d.get_parent(3);if(!e||!e.is_group("brackets")||w.areHidden(e))return null;if(b){if(b!==e)return null}else b=e}return b}catch(a){return null}},a.prototype.match=function(a,b){var c=Id.groupNodeRanges(a),d=this.getContainingBrackets(c);if(!d)return!1;if(b&&d.children[0]!==b&&d.children[2]!==b)return!1;if(!this.nodesAreAllAddends(d.children[1],c))return!1;var e=c[0].length;c.forEach(function(a){if(a.length!==e)return!1});for(var f=0;f<e;f++){var g;g="mul"===c[0][f].value?c[0][f].children[1].to_ascii():c[0][f].to_ascii();for(var h=0;h<c.length;h++){if(("mul"===c[h][f].value?c[h][f].children[1].to_ascii():c[h][f].to_ascii())!==g)return!1}}var i=_c.get_cca(a);return i.is_group("sum")&&i.parent===d},a.prototype.transform=function(a){var b=this.getNewTreeNode(this.nodes),c=this.findBracketGroup(b),d=Id.groupNodeRanges(b),e=d.map(this.getOldTreeNode.bind(this));this.removeRangesFromSum(d);var f=this.factor(c,d,e);if(f.is_group("brackets")&&w.is_optional(f)){var g=f.parent;w.handle(f,!0),f=g}if(f.cleanupAction&&this.cleanup(f),"function"!=typeof a)return!0;a(this)},a.prototype.findBracketGroup=function(a){var b=a[0];if(b&&b.parent&&b.parent.parent&&b.parent.parent.is_group("sum")&&b.parent.parent.parent&&b.parent.parent.parent.is_group("brackets"))return b.parent.parent.parent;if(b&&b.parent&&b.parent.is_group("product")&&b.parent.parent&&b.parent.parent.parent&&b.parent.parent.parent.is_group("sum")&&b.parent.parent.parent.parent&&b.parent.parent.parent.parent.is_group("brackets"))return b.parent.parent.parent.parent;throw"Attempting to factor from invalid structure."},a.prototype.removeRangesFromSum=function(a){for(var b=0;b<a.length;b++){var c=a[b],d=a[b][0].parent;if(c.length===d.children.length){var e=d.parent;d.remove(),_c.remove_range(c),e.append(new D(1)),this.cleanup(e)}else"add"===d.value||"sub"===d.value&&1===c.length?(c[0].remove(),d.append(new D(1))):(_c.remove_range(a[b]),this.cleanup(d))}},a.prototype.factor=function(a,b,c){return this.replaceBracketGroupWithFactoredProduct(a,b,c)},a.prototype.replaceBracketGroupWithFactoredProduct=function(a,b,c){var d,e=K.prototype.createParentGroup(),f=a.parent,g=a.remove();if("left-of"===this.settings.side){d=b[0],1===d.length&&"mul"!==d[0].value&&(d=[new K(d[0])]),e.append_range(d),e.append(new K(a));for(var h=0;h<c.length;h++)1!==c[h].length||c[h][0].is_group("mul")?this.updateNodeMap(_c.get_mapping_between(c[h],d)):this.updateNodeMap(c[h][0],d[0])}else{d=b[b.length-1],1===d.length&&"mul"!==d[0].value&&(d=[new K(d[0])]),e.append(new K(a)),e.append_range(d);for(var h=0;h<c.length;h++)1!==c[h].length||c[h][0].is_group("mul")?this.updateNodeMap(_c.get_mapping_between(c[h],d)):this.updateNodeMap(c[h][0],d[0])}return _c.insert(f,g,e),f},a.prototype.mapIndex=function(){return function(){}},new a}(),Id.prototype.move_actions.push(ad.actions.FactorOutOfBracketsAction),ge=function(a){function b(a){id(this,b);var c=pd(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,"DirectSubstitutionAction","substitution"));return c.triggerType="drag",c.priority=10,c.settings={delay:400,on_release:!0,side:"inside"},a&&(c.nodes=a.nodes,c.target=a.target,c.source_am=a.nodes[0].get_root()),c}return qd(b,a),jd(b,[{key:"getAllAvailableActions",value:function(a,b){var c=_a(a);if(!c)return[];var d=ab(c,b);return this.bindActionForEachTarget(a,d,b)}},{key:"bindActionForEachTarget",value:function(a,b,c){var d=this;return b.map(function(b){return d.createBoundAction(c,{nodes:a,target:b,side:"around"})})}},{key:"getTargetsForHighlighting",value:function(){if(!this.nodes||!this.target)return[];try{var a=_a(this.nodes,this.target);return a.use_equality?ad.array.flatten(bb(a.nodes,this.target[0].get_root())):ad.array.flatten(bb(this.target))}catch(a){throw"[DirectSubstitutionAction] The action's settings were corrupted."}}},{key:"rebind",value:function(a,b,c){if(this.source_am===c){var d=new p;d.node_map=b,this.nodes=d.mapNodes(this.nodes),this.source_am=a}else{if(this.oldTree!==c)throw"wrong old tree during rebinding an action!";var d=new p;d.node_map=b,this.target=d.mapNodes(this.target),this.oldTree=a}}},{key:"rematch",value:function(){if(!(this.nodes&&this.nodes.length>0&&this.target&&this.target.length>0))return!1;var a=_a(this.nodes);if(!a)return!1;var b=ab(a,this.oldTree),c=jb(cb(this.target));return b.some(c)}},{key:"transform",value:function(a){var b=this,c=this.getNewTreeNode(this.target),d=_a(this.nodes,c),e=d.substitutes,f=bb(d.use_equality?d.nodes:c,c[0].get_root()),g=bb(d.use_equality?d.nodes:c,this.target[0].get_root());return f.forEach(function(a,c){var f=a[0].parent,h=_c.remove_range(a),i=Id.cloneNodes(e),j=void 0;b.extendNodeMap(_c.get_mapping_between(e,i)),1===i.length?j=i[0]:(i[0].is_group("div")&&i.forEach(function(a){return a.invert()}),j=i[0].createParentGroup(),j.append_range(i)),1===a.length&&a[0].is_group("sub")&&!d.nodes[0].is_group("add","sub")&&(j=new u(j)),a.length>1&&(j=new a[0].constructor(j),j.is_group("mul")&&a[0].is_group("div")&&j.invert()),f.insert(h,j),d.is_neg&&Q.invertTerm(j),g[c].forEach(function(a){b.updateNodeMap(a,j),b.updateNodeMap(_c.get_leaf_nodes(a),_c.get_leaf_nodes(j))});var k=b.applyInnerAction("AddSubCombineSigns",{actor:j});k||"AlgebraModel"===f.type||(k=b.applyInnerAction("AddSubCombineSigns",{actor:f}),!k&&f.parent.parent&&(k=b.applyInnerAction("AddSubCombineSigns",{actor:f.parent.parent})),k||b.applyInnerAction("SignDoubleNegAction",{actor:f})),!b.cleanup(j)&&j.parent&&w.handle(j),b.cleanup(f)}),a&&a(this),!0}}]),b}(p),ad.actions.DirectSubstitutionAction=new ge,he=function(){var a=function(a){p.call(this,"TriggerFactoringAction","general factoring"),this.priority=0,this.triggerType="drag",this.settings={side:"around"},a&&(this.DLOfSum=a.dl,this.viewOfSum=a.view,this.target=a.sum,this.callback=a.callback)};ad.inherit(p,a),a.prototype.match=function(a,c){return b(a,c)},a.prototype.transform=function(){this.callback(this.viewOfSum,this.target,this.DLOfSum)};var b=function(a,b){var c;c=d(a,b),c=e(c,a);for(var f=[],g=0;g<c.length;g++)if(0===c[g].length)return!1;for(var g=0;g<c.length;g++)c[g]&&f.push(c[g][c[g].length-1]);for(var g=0;g<f.length;g++)Array.isArray(f[g])||"add"===f[g].parent.value||"sub"===f[g].parent.value||(f[g]=f[g].parent);return f.length===a.children.length&&f},c=function(a,b){var c=[];return a.for_each(function(a){var d=a.to_ascii();if("*"===d.slice(0,1)&&(d=d.substr(1)),a.hidden||d!==b){for(var e=[a];d.length<b.length&&a.commutative&&a.rs;)a=a.rs,d+=a.to_ascii(),e.push(a);d===b&&c.push(e)}else c.push(a)}),c},d=function(a,b){for(var d=[],e=0;e<a.children.length;e++){var f=a.children[e],g=f.children[1];d.push(c(g,b.to_ascii()))}return d},e=function(a,b){for(var c=function(a){return a.parent&&("add"===a.parent.value||"sub"===a.parent.value)&&a.parent.parent&&a.parent.parent==b},d=function(a){return a.parent&&"mul"===a.parent.value&&a.parent.parent&&a.parent.parent.is_group("product")&&a.parent.parent.parent&&a.parent.parent.parent.parent&&a.parent.parent.parent.parent==b},e=function(a){return"mul"===a.value&&a.parent&&a.parent.is_group("product")&&a.parent.parent&&a.parent.parent.parent&&a.parent.parent.parent==b},f=function(a){var b=!0;if(!Array.isArray(a))return c(a)||d(a);for(var f=0;f<a.length;f++)e(a[f])||(b=!1);return b},g=0;g<a.length;g++)a[g]=a[g].filter(f);return a};return new a}(),ad.actions.showRoundedAction=function(){var a=function(a){p.call(this,"showRoundedAction","show rounded"),this.priority=1,this.triggerType="hold",a&&(this.actor=a.actor)};return ad.inherit(p,a),a.prototype.match=function(a){return!!a.is_group("num")&&(null===a.precision||a.decimal_count()>a.precision)},a.prototype.transform=function(a){var b=this.getNewTreeNode(this.actor);return null===b.precision?b.precision=2:b.precision=null,"function"==typeof a&&a(this),this},new a}(),ad.actions.EvalTrigAction=function(){var a=function(a){p.call(this,"EvalTrigAction","evaluate trig functions"),this.priority=0,this.triggerType="tap",this.settings={},a&&(this.actor=a.actor,this.settings.angleType=a.angleType||"rad")};return ad.inherit(p,a),a.prototype.match=function(a){return!!O.Trig.is_trig_func(a)&&(a.children[1]&&a.children[1].is_group("brackets")&&a.children[1].children[1].is_group("tuple")&&D.is_num(a.children[1].children[1].children[0].children[1]))},a.prototype.transform=function(a){var b=this.getNewTreeNode(this.actor);this.addTouchedNodes(this.actor);var c=O.Trig.evaluate(b);if(!Number.isNaN(c)&&c!==1/0&&c!==-1/0){var d=new D(c);_c.replace(b,d),this.updateNodeMap(this.actor,d)}return"function"==typeof a&&a(this),this},O.prototype.add_action_handler(new a),new a}(),ad.actions.DragSplitNegativesAction=function(){var a=function(a){if(p.call(this,"DragSplitNegativesAction","drag a negative sign to the left to extract a negative 1"),this.priority=1,this.triggerType="drag",this.settings={delay:1e3,side:"left-of"},a){var b={node:a.nodes[0],side:"around",margin:{x1:-.15,x2:.25,y1:.5,y2:.4}},c={node:a.nodes[0],side:"around",margin:{x1:.25,y1:.5,y2:.4}};this.initSettings(ad.extend(a,{drop_area_hint:b,destination_hint:c}))}};return ad.inherit(p,a),a.prototype.getAllAvailableActions=function(a,b){var c=arguments.length<=2||void 0===arguments[2]||arguments[2];return 1!==a.length?[]:c&&!a[0].ls&&a[0].parent.is_group("sub","sign","addsub","plusminus")&&1!==a[0].rs.value?this.bindActionForEachTarget(a,a):c?[]:this.bindActionForEachTarget(a,a)},a.prototype.rematch=function(){var a=this;if(this.nodes&&this.nodes.length>0&&this.target){return this.getAllAvailableActions(this.nodes,null,!1).some(function(b){return b.target===a.target})}return!1},a.prototype.transform=function(a){this.addTouchedNodes(this.target.parent);var b=this.target.is_group("sign","sub","add","addsub","plusminus")?this.target.children[0]:this.target;if(b.parent.is_group("add","sub","sign","addsub","plusminus")){var c=this.getNewTreeNode(b.parent),d=c.parent,e=c.remove(),f=K.prototype.createParentGroup(),g=c.children[1];g.remove();var h;c.is_group("add")&&(h=new D(1)),c.is_group("sub","sign")&&(h=new D(-1)),c.is_group("addsub","plusminus")&&(h=new Q(new D(1),!0)),this.extendNodeMap(b.parent,h),this.updateNodeMap(b,h.children[0]);var i=new K(h);f.append(i),f.append(new K(g));var j=c.is_group("add","sub","addsub")?new u(f):f;d.insert(e,j),this.cleanup_cascade(d),this.setNodesToReselectAfterAction(i)}else{var k=this.getNewTreeNode(b),l=k.parent,m=k.remove(),f=new I;f.append(new K(new D(1))),f.append(new K(k)),l.insert(m,f),this.cleanup(f.children[1]),this.cleanup(l)}return"function"==typeof a&&a(this),this},new a}(),Id.prototype.move_actions.push(ad.actions.DragSplitNegativesAction),ad.actions.DragNegativeSymReselectGroupAction=function(){var a=function(a){if(p.call(this,"DragNegativeSymReselectGroupAction","drag a negative sign to the left to extract a negative 1"),this.priority=2,this.triggerType="drag",this.settings={makes_no_changes:!0,no_delay:!0,update_node_positions:!0,side:"outside"},a){var b={margin:{y1:.4,y2:.4}},c={hidden:!0};this.initSettings(ad.extend(a,{drop_area:b,drop_area_hint:c}))}};return ad.inherit(p,a),a.prototype.getAllAvailableActions=function(a){if(1!==a.length)return[];var b=a[0];if(!b.is_group("sym")||"-"!==b.value&&""!==b.value)return[];var c=b.get_root(),d=this.createBoundAction(c,{nodes:[b],target:b});return b.rs&&1===b.rs.value&&(d.settings.side="inside"),[d]},a.prototype.transform=function(a){return this.addTouchedNodes(this.target.parent),this.setNodesToReselectAfterAction(this.target.parent),"function"==typeof a&&a(this),this},new a}(),Id.prototype.move_actions.push(ad.actions.DragNegativeSymReselectGroupAction),ad.actions.AssociateIdentityIntoDenominatorAction=function(){var a=function(a){if(p.call(this,"AssociateIdentityIntoDenominatorAction","associative property of multiplication--move into fraction"),this.priority=2,this.triggerType="drag",this.settings={no_target_box_expansion:!0},a){var b={side:"around",margin:{y1:.25,x:-.1}};a.target&&(a.target.parent.is_group("fraction")?b.node=I.get_whole_range(a.target):b.node=a.target);var c={margin:{y1:.1,x:-.1}};this.initSettings(ad.extend(a,{drop_area:b,drop_area_hint:c}))}};return ad.inherit(p,a),a.prototype.getAllAvailableActions=function(a){if(!a.length)return[];var b=[];if(!_c.is_range(a))return[];var c=a[0].value;if("mul"!==c&&"div"!==c)return[];if(!a.every(function(a){return a.is_group(c)&&(-1===D.get_value(a.children[1])||1===D.get_value(a.children[1]))}))return[];var d=a[0].parent,e=a[0].parent.children.indexOf(a[0]),f=a[0].parent.children.indexOf(a[a.length-1]);return d.children.forEach(function(d,g){(g<e||g>f)&&d.value===c&&d.children[1].is_group("fraction")&&(b=b.concat(this.bindActionForEachTarget(a,d.get_child([1]).get_bottom(),!0)))},this),b},a.prototype.transform=function(a){this.nodes.forEach(function(a){this.addTouchedNodes(a)},this),this.addTouchedNodes(this.target.parent);var b=this.getNewTreeNode(this.nodes),c=b[0].parent,d=this.getNewTreeNode(this.target),e=d.parent,f=e.children.indexOf(d);if("right-of"===this.settings.side&&f++,_c.remove_range(b),b.forEach(function(a){a.is_group("mul")&&a.invert()}),e.insert_range(f,b),this.cleanup(e),this.cleanup(c),"function"!=typeof a)return!0;a(this)},new a}(),Id.prototype.move_actions.push(ad.actions.AssociateIdentityIntoDenominatorAction),ad.actions.CombinationRewriteAction=function(){var a=function(a){p.call(this,"CombinationRewriteAction","combine equations"),this.settings={asynchronous:!0,side:"below",margin:{y1:.2,y2:-1},layout_hint:"new-line"},a&&(this.nodes=a.nodes,this.target=a.target,this.source_am=this.nodes[0]),this.new_derivation=!0};return ad.inherit(p,a),a.prototype.toJSON=function(){var a=p.prototype.toJSON.call(this);return this.latex&&(a.latex=this.latex),a},a.prototype.rebind=function(a,b,c){if(this.source_am===c)this.nodes[0]=a,this.source_am=a;else{if(this.oldTree!==c)throw"wrong old tree during rebinding an action!";var d=new p;d.node_map=b,this.oldTree=a,this.target=d.mapNodes(this.target)[0],this.new_derivation=!this.target.is_group("equals")}},a.prototype.rematch=function(){if(!(this.nodes&&this.nodes.length>0&&this.target))return!1;var a=this.getAllAvailableActions(this.source_am,this.target);return this.target===a[0].target},a.prototype.getAllAvailableActions=function(a,b){return a.children[0].is_group("equals")&&!b.is_group("equals")?[]:[this.createBoundAction(b.parent,{nodes:[a],target:b})]},a.prototype.transform=function(a){function b(b){this.latex=b;try{var c=this.newTree.parse(b,!0)}catch(a){return console.log(a),void g.warning("Could not parse expression.")}if(!c)return void g.warning("Please enter an expression containing E and E.");if(!Id.getNodes("E_1",0,c)&&!Id.getNodes("E_2",0,c))return void g.warning("Your entered expression must contain both E and E.");if(!Id.getNodes("E_1",0,c))return void g.warning("Your entered expression is missing E.");if(!Id.getNodes("E_2",0,c))return void g.warning("Your entered expression is missing E.");if(d.is_group("equals")){this.combineEquations(c,d,e);for(var f=d.children[0].children,h=d.children[2].children,i=f.length-1;i>=0;i--)this.cleanup(f[i]);for(var j=h.length-1;j>=0;j--)this.cleanup(h[j])}else{this.combineExpressions(c,d,e);for(var k=d.children.length-1;k>=0;k--)this.cleanup(d.children[k])}this.endKeyboardInteraction(g),a(this)}function c(){this.endKeyboardInteraction(g),a(!1)}var d=this.getNewTreeNode(this.target),e=this.source_am.children[0].clone();if(this.new_derivation=!this.target.is_group("equals"),this.latex){var f=this.newTree.parse(this.latex,!0);return d.is_group("equals")?(this.combineEquations(f,d,e),d.children[0].children.forEach(function(a){this.cleanup(a)},this),d.children[2].children.forEach(function(a){this.cleanup(a)},this)):(this.combineExpressions(f,d,e),d.children.forEach(function(a){this.cleanup(a)},this)),"function"==typeof a&&a(this),this}var g=ad.ui.Keyboard();g.caption("Combine the "+(e.is_group("equals")?"equations":"expressions")+" E and E.").latex("E_1+E_2").on("done",b.bind(this)).on("cancel",c.bind(this)).visible(!0)},a.prototype.combineEquations=function(a,b,c){var d=b.children[0],e=this.target.children[0],f=b.children[2],g=this.target.children[2],h=c.is_group("equals")?c.children[0]:c,i=c.is_group("equals")?this.source_am.children[0].children[0]:this.source_am.children[0],j=c.is_group("equals")?c.children[2]:c,k=c.is_group("equals")?this.source_am.children[0].children[2]:this.source_am.children[0],l=a.clone(),m=a.clone();_c.replace(d,l),_c.replace(f,m),this.replaceAll("E_1",l,d,e),this.replaceAll("E_2",l,h,i),this.replaceAll("E_1",m,f,g),this.replaceAll("E_2",m,j,k)},a.prototype.combineExpressions=function(a,b,c){var d=this.target,e=this.source_am.children[0];_c.replace(b,a),this.replaceAll("E_1",a,b,d),this.replaceAll("E_2",a,c,e)},a.prototype.replaceAll=function(a,b,c,d){Id.getNodes(a,"all",b).forEach(function(a){var b=c.clone();_c.replace(a,b),this.updateNodeMap(d.get_mapping_to(b)),w.handle(b)},this)},new a}(),ad.actions.EquationRewriteAction=function(){var a=function(a){p.call(this,"EquationRewriteAction","rewrite equation"),this.priority=1,this.triggerType="hold",this.settings={asynchronous:!0},this.latex=null,a&&(this.actor=a.actor)};return ad.inherit(p,a),a.prototype.toJSON=function(){var a=p.prototype.toJSON.call(this);return this.latex&&(a.latex=this.latex),a},a.prototype.match=function(a){return!(!ad.ui||!ad.ui.Keyboard)&&a.is_group("equals")},a.prototype.transform=function(a){function b(b){this.latex=b;var e;try{e=this.newTree.parse(b,!0)}catch(a){return console.log(a),void f.warning("Could not parse expression.")}return e?Id.getNodes("E",0,e)?"E"===e.to_ascii()?(f.warning('You made no changes. Try adding something to "E".'),this.pressed_done_with_same_expression&&c(),void(this.pressed_done_with_same_expression=!0)):(this.replaceSideWithInput(d.children[0],e),this.replaceSideWithInput(d.children[2],e),this.endKeyboardInteraction(f),"function"==typeof a&&a(this),this):(f.warning('There needs to be an "E" in the expression.'),void(this.pressed_done_with_same_expression=!1)):(f.warning('Please enter an expression with one or more "E"s.'),void(this.pressed_done_with_same_expression=!1))}function c(){return this.endKeyboardInteraction(f),"function"==typeof a&&a(!1),!1}var d=this.getNewTreeNode(this.actor);if(this.latex){var e=new Id(this.latex).children[0];return this.replaceSideWithInput(d.children[0],e),this.replaceSideWithInput(d.children[2],e),"function"==typeof a&&a(this),this}var f=ad.ui.Keyboard();f.caption("Enter an operation to apply to both sides of the equation.").latex("E").on("done",b.bind(this)).on("cancel",c.bind(this)).visible(!0)},a.prototype.replaceSideWithInput=function(a,b){var c=b.clone(),d=Id.getNodes("E",0,c);_c.replace(a,c),d.is_group("tuple")&&(d=d.get_child([0,1])),_c.replace(d,a),w.handle(a),this.cleanup(a.parent)},G.prototype.add_action_handler(new a),new a}(),ad.actions.ExpressionRewriteAction=function(){function a(a){return a.map(function(a){return a.to_ascii()}).join("")}var b=function(a){p.call(this,"ExpressionRewriteAction","replace an expression with an equivalent one"),this.priority=0,this.triggerType="tap",this.settings={side:"shake",asynchronous:!0},this.latex=null,this.original_node_state=null,a&&(a.actor?this.actor=a.actor:(this.triggerType="drag",this.nodes=a.nodes))};ad.inherit(p,b),b.prototype.toJSON=function(){var a=p.prototype.toJSON.call(this);return this.latex&&(a.latex=this.latex),this.original_node_state&&(a.original_node_state=this.original_node_state),a},b.prototype.rematch=function(){if(!(this.actor||this.nodes&&this.nodes.length>0))return!1;if(this.actor)return this.match(this.actor);if(this.getAllAvailableActions){return this.getAllAvailableActions(this.nodes).every(function(b){return a(b.nodes)===this.original_node_state},this)}},b.prototype.match=function(a){return ad.ui&&ad.ui.Keyboard&&a.is_group("placeholder")},b.prototype.getAllAvailableActions=function(a){return ad.ui&&ad.ui.Keyboard?[this.createBoundAction(a[0].get_root(),{nodes:a})]:[]},b.prototype.adjustTarget=function(a){return 1===a.length&&a[0].is_group("exponent","degree")?[a[0].children[0]]:1===a.length&&a[0].is_group("mul","div")?[a[0].children[1]]:a},b.prototype.transform=function(b){function c(a){a=a.replace(/\\quad/g,"");var b=a.split("\\rightarrow");return b.length>1?b[b.length-1]:b[0]}function d(a){var b;try{b=this.newTree.parse(a,!0)}catch(a){return console.log(a),q.warning("Could not parse expression.",o),!1}return!!b||(q.warning("Please enter an expression.",o),!1)}function e(a){return a.is_group("placeholder")||a.is_group("add","sub","addsub","sign","plusminus","degree","exponent","mul","div")&&a.children[1].is_group("placeholder")}function f(a,b){if(b.get_root()instanceof Id||new Id("").append(b.get_root()),1===a.length){if(e(a[0]))return!0}var c=ad.termsToAlgebriteString;if(1===a.length&&D.is_num(a[0])&&Id.evalExpression(b)===D.get_value(a[0]))return!0;if(!$c)return!1;var d=function(a,b,d){b=b[0];var e=$c.simplify(c(a.children[0])),f=$c.simplify(c(a.children[2])),g=$c.simplify(c(b.children[0])),h=$c.simplify(c(b.children[2]));return!d&&$c.equal(e,g)&&$c.equal(f,h)||d&&$c.equal(e,h)&&$c.equal(f,g)};try{if(b.is_group("equals")||a[0].is_group("equals"))return!(!b.is_group("equals")||1!==a.length||!a[0].is_group("equals"))&&d(b,a,!1);if(F.is_inequality(b)||F.is_inequality(a[0]))return!(!F.is_inequality(b)||1!==a.length||!F.is_inequality(a[0]))&&(a[0].value===b.value?d(b,a,!1):!!(a[0].is_group("lt")&&b.is_group("gt")||a[0].is_group("lte")&&b.is_group("gte")||a[0].is_group("gt")&&b.is_group("lt")||a[0].is_group("gte")&&b.is_group("lte"))&&d(b,a,!0));var f=$c.simplify(c(b)),g=$c.simplify(c(k));return $c.equal(g,f)}catch(a){return console.warn("[RewriteExpressionWithKeyboardAction] External library Algebrite threw an error."),!1}}function g(a,b,c,d){var e=this,f=b[0].get_parent(1),g=_c.remove_range(b);if(1===b.length&&b[0].is_group("add","sub")){var h=c.is_group("product")&&c.get_child([0,1]).is_group("sign");b[0].is_group("add")&&c.is_group("sign")?c=new u(c.children[1],"sub"):b[0].is_group("sub")&&c.is_group("sign")?c=new u(c.children[1],"sub"):b[0].is_group("sub")&&h?(Q.invertTerm(c),c=new u(c,"sub")):c=new u(c)}else b[0].is_group("mul","div")?c=new K(c,b[0].value):b[0].is_group("add","sub")&&(c=new u(c));f.insert(g,c);var i=(a[0].get_root(),c.get_leaf_nodes().filter(function(a){return!a.is_group("sym")}));a.forEach(function(a){e.updateNodeMap(a,c),_c.get_leaf_nodes(a).filter(function(a){return!a.is_group("sym")}).forEach(function(a){return e.updateNodeMap(a,i)})}),w.handle(c),this.cleanup(c),this.cleanup_cascade(f)}function h(a){this.latex=a;var e=c(a);if(d.call(this,e)){var h=this.newTree.parse(e,!0);if(n&&od.get("allow_non_equivalent_keyboard_rewrite"))g.call(this,l,k,h);else{if(!f(k,h))return od.get("allow_non_equivalent_keyboard_rewrite")?q.warning("You may have changed the value. If you're sure you want this, press Done again.",o):q.warning("What you entered is not equal to what you are replacing. Try again or hit cancel.",o),void(n=!0);g.call(this,l,k,h,!0)}if(this.endKeyboardInteraction(q),"function"!=typeof b)return!0;b(this)}}function i(){n=!1}function j(){this.endKeyboardInteraction(q),b(!1)}var k=this.adjustTarget(this.getNewTreeNode(this.nodes||[this.actor])),l=this.getOldTreeNode(k);if(this.latex){var m=this.newTree.parse(c(this.latex),!0);return g.call(this,l,k,m),"function"==typeof b&&b(this),this}this.original_node_state=a(this.nodes||[this.actor]);var n=!1,o=1===k.length&&e(k[0])?"Enter an expression to fill in the selected box.":"Enter an expression to replace the selected expression.",p=k.map(function(a){return a.to_latex()}).join("");p.startsWith("\\cdot ")&&!k[0].is_group("product")&&(p=p.replace("\\cdot ","")),p=p.replace(/\\dottedsquare/g,"");var q=ad.ui.Keyboard();q.caption(o).on("done",h.bind(this)).on("change",i.bind(this)).on("cancel",j.bind(this)).visible(!0).latex(p),q.selectAll()};var c=new b;return L.prototype.add_action_handler(c),c}(),Id.prototype.move_actions.push(ad.actions.ExpressionRewriteAction),ad.actions.FirstLineRewriteAction=function(){var a=function(a){p.call(this,"FirstLineRewriteAction","rewrite dl line"),this.settings={asynchronous:!0},this.priority=0,a&&(this.actor=a.actor)};return ad.inherit(p,a),a.prototype.match=function(){return ad.ui&&ad.ui.Keyboard},a.prototype.removeAllNodesFromNodeMap=function(){this.newTree.select_all();for(var a in this.node_map)this.node_map[a]=[]},a.prototype.transform=function(a){function b(b){var c=this.newTree,e=c.parse(b,!0);e&&(c.children[0].remove(),c.append(e),this.removeAllNodesFromNodeMap(),this.endKeyboardInteraction(d),a(this))}function c(){this.endKeyboardInteraction(d),a(!1)}var d=ad.ui.Keyboard(),e=this.newTree.to_latex();e=e.replace(/\\dottedsquare/g,""),d.caption("Correct any mistakes you made in this expression.").latex(e).on("done",b.bind(this)).on("cancel",c.bind(this)).visible(!0)},new a}(),ad.actions.FractionRewriteAction=function(){var a=function(a){p.call(this,"FractionRewriteAction","extend fraction"),this.priority=0,this.triggerType="hold",this.settings={asynchronous:!0},this.latex=null,a&&(this.actor=a.actor)};ad.inherit(p,a),a.prototype.toJSON=function(){var a=p.prototype.toJSON.call(this);return this.latex&&(a.latex=this.latex),a},a.prototype.match=function(a){return!(!ad.ui||!ad.ui.Keyboard)&&a.is_group("fraction")},a.prototype.transform=function(b){function c(c){try{e=this.newTree.parse(c,!0),this.latex=c}catch(a){return console.log(a),void f.warning("Could not parse expression.")}return e?a.acceptTerm(e)?(this.extendFraction(this.getNewTreeNode(this.actor),e),this.endKeyboardInteraction(f),void b(this)):void f.warning("You can't extend the fraction with this expression."):void f.warning("Please enter an expression.")}function d(){this.endKeyboardInteraction(f),b(!1)}var e;if(this.latex)return e=this.newTree.parse(this.latex,!0),this.extendFraction(this.getNewTreeNode(this.actor),e),"function"==typeof b&&b(this),this;var f=ad.ui.Keyboard();f.caption("Enter a term with which to multiply the numerator and denominator of this fraction.").latex("").on("done",c.bind(this)).on("cancel",d.bind(this)).visible(!0)},a.acceptTerm=function(a){return!(a.is_group("brackets")&&a.get_child([1]).is_group("tuple")||a.is_group("equals"))},a.prototype.extendFraction=function(a,b){var c=new K(b,"mul"),d=new K(b.clone(),"div");a.append(c),a.append(d),this.cleanup(c),this.cleanup(d)};var b=new a;return I.prototype.add_action_handler(b),b}(),ad.actions.InequalityRewriteAction=function(){var a=function(a){p.call(this,"InequalityRewriteAction","rewrite inequality"),this.priority=1,this.triggerType="hold",this.settings={asynchronous:!0},a&&(this.actor=a.actor)};return ad.inherit(p,a),a.prototype.toJSON=function(){var a=p.prototype.toJSON.call(this);return this.latex&&(a.latex=this.latex),a},a.prototype.match=function(a){return!(!ad.ui||!ad.ui.Keyboard)&&F.is_inequality(a)},a.prototype.transform=function(a){function b(b){this.latex=b;var e;try{e=this.newTree.parse(b,!0)}catch(a){return console.log(a),void f.warning("Could not parse expression.")}return e?Id.getNodes("E",0,e)?"E"===e.to_ascii()?(f.warning('You made no changes. Try adding something to "E."'),this.pressed_done_with_same_expression&&c(),void(this.pressed_done_with_same_expression=!0)):(this.invertInequalityIfInputIsNegative(e,d),this.replaceSideWithInput(d.children[0],e),this.replaceSideWithInput(d.children[2],e),this.endKeyboardInteraction(f),"function"==typeof a&&a(this),this):(f.warning('There needs to be an "E" in the expression.'),void(this.pressed_done_with_same_expression=!1)):(f.warning('Please enter an expression with one or more "E"s.'),void(this.pressed_done_with_same_expression=!1))}function c(){return this.endKeyboardInteraction(f),"function"==typeof a&&a(!1),!1}var d=this.getNewTreeNode(this.actor);if(this.latex){var e=new Id(this.latex).children[0];return this.invertInequalityIfInputIsNegative(e,d),this.replaceSideWithInput(d.children[0],e),this.replaceSideWithInput(d.children[2],e),"function"==typeof a&&a(this),this}var f=ad.ui.Keyboard();f.caption("Enter an operation to apply to both sides of the equation.").latex("E").on("done",b.bind(this)).on("cancel",c.bind(this)).visible(!0)},a.prototype.invertInequalityIfInputIsNegative=function(a,b){var c=!1,d=!1;a.is_group("product","fraction")&&function(){!function a(b){b.is_group("power")&&D.is_num(b.get_child([1,0]))&&D.get_value(b.get_child([1,0]))%2==0||(b.is_group("sign")?(c=!c,a(b.get_child([1]))):0!==b.children.length||D.is_num(b)||b instanceof s||"E"===b.to_ascii()?b.children.length&&b.children.forEach(a):d=!0)}(a)}(),c&&b.invert(),d&&(this.settings.restraint="All new terms must evaluate to a positive number.")},a.prototype.replaceSideWithInput=function(a,b){var c=b.clone(),d=Id.getNodes("E",0,c);_c.replace(a,c),_c.replace(d,a),w.handle(a),this.cleanup(a.parent)},F.prototype.add_action_handler(new a),new a}(),ie=function(a){function b(a){id(this,b);var c=pd(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,"AbsValCombineAction","combine two absolute value terms into one"));return c.priority=4,c.triggerType="tap",c.settings={delay:300,side:"inside"},a&&(a.actor?c.actor=a.actor:(c.triggerType="drag",c.nodes=a.nodes,c.target=a.target)),c}return qd(b,a),jd(b,[{key:"getAllAvailableActions",value:function(a){if(1!==a.length)return[];if(!a[0].is_group("mul","div")||!a[0].get_child([1]).is_group("abs-val"))return[];var b=mb(a[0]);return this.bindActionForEachTarget(a,b)}},{key:"match",value:function(a){return!(!a.ls||a.ls.value!==a.value)&&(a.ls.get_child([1]).is_group("abs-val")&&a.get_child([1]).is_group("abs-val"))}},{key:"transform",value:function(a){this.addTouchedNodes(this.nodes||this.actor),this.target&&this.addTouchedNodes(this.target);var b=this.getNewTreeNode(this.nodes||this.actor),c=this.getNewTreeNode(this.target||this.actor.ls);Array.isArray(b)&&(b=b[0]);var d=this.getOldTreeNode(b),e=this.getOldTreeNode(c),f=b.get_idx()<c.get_idx(),g=b.get_parent(1);b.remove();var h=c.remove(),i=lb(b),j=lb(c),k=new I;k.append(j),f?k.insert(0,i):k.append(i);var l=new B(k),m=new K(l,d.value);return this.mapOpAndSym(d,m),this.mapBars(d.get_child([1]),l),this.mapOpAndSym(e,m),this.mapBars(e.get_child([1]),l),g.insert(h,m),this.setNodesToReselectAfterAction(i.children[1].is_group("product")?i.children[1].children:i),this.cleanup(i),this.cleanup(j),this.cleanup_cascade(g),"function"==typeof a&&a(this),!0}},{key:"mapOpAndSym",value:function(a,b){this.updateNodeMap(a,b),this.updateNodeMap(a.get_child([1]),b.get_child([1]))}},{key:"mapBars",value:function(a,b){this.updateNodeMap(a.get_child([0]),b.get_child([0])),this.updateNodeMap(a.get_child([2]),b.get_child([2]))}}]),b}(p),je=new ie,K.prototype.add_action_handler(je),ad.actions.AbsValCombineAction=je,Id.prototype.move_actions.push(je),ke=function(a){function b(a){id(this,b);var c=pd(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,"CalculatePowerAction","calculate a power"));return c.priority=0,c.triggerType="tap",a&&(c.actor=a.actor),c}return qd(b,a),jd(b,[{key:"match",value:function(a){var b=a;if(b.is_group("power")||(b=a.parent),!b.is_group("power"))return!1;var c=b.children[0],d=b.get_exponent_term();return c.is_group("brackets")&&(c=c.children[1]),!!D.is_num(c,!0)&&(!(!D.is_num(d)||D.is_equal_to(d,0))&&(Math.round(D.get_value(d))===D.get_value(d)||!c.is_group("plusminus","sign")))}},{key:"transform",value:function(a){var b=this.getNewTreeNode(this.actor),c=b;c.is_group("power")||(c=c.parent);var d=c.children[0],e=c.children[1].children[0];this.addTouchedNodes(this.getOldTreeNode(c)),d.is_group("brackets")&&(d=d.children[1]),e.is_group("brackets")&&(e=e.children[1]);var f=new D(Math.pow(D.get_value(d,!0),D.get_value(e)));return d.is_group("plusminus")&&!H.hasEvenExponent(c)&&(f=new Q(f,!0)),this.updateNodeMap(this.actor.parent.get_mapping_to(f)),_c.replace(c,f),w.handle(f),"function"==typeof a&&a(this),!0}}]),b}(p),ad.actions.CalculatePowerAction=new ke,N.prototype.add_action_handler(new ke),H.prototype.add_action_handler(new ke),le=Object.freeze({AbsValCombineAction:ie,CalculatePowerAction:ke,Action:p}),function(){var a=function(a){p.call(this,"SumCleanupAction","sum cleanup action"),a&&(this.actor=a.actor)};ad.inherit(p,a),a.prototype.match=function(a){return a.is_group("sum")&&a.children.length<=1},a.prototype.doInPlace=function(a){this.initNodeMap();var b=this.getNewTreeNode(this.actor);if(0===b.children.length)_c.remove(b);else if(1===b.children.length){var c,d=b.children[0],e=this.actor.children[0];if(d.is_group("add"))c=d.children[1];else if(d.is_group("sub","addsub")){var f=d.is_group("addsub");if(d.children[1].is_group("product")){var g=d.children[1].children[0].children[1],h=g.parent;g.remove();var i=new Q(g,f);h.append(i),c=d.children[1]}else c=new Q(d.children[1],f);this.updateNodeMap(e.children[0],c.children[0])}this.updateNodeMap(e,c),this.updateNodeMap(e.parent,c),_c.replace(d.parent,c),c.parent&&c.parent.is_group("brackets")?w.handle(c.parent,!0):w.handle(c)}if("function"!=typeof a)return this;a(this)},t.prototype.cleanupAction=new a}(),function(){var a=function(a){p.call(this,"AddSubCleanUp","addsub cleanup action"),a&&(this.addsub=a.actor)};ad.inherit(p,a),a.prototype.match=function(a){return a.is_group("add","sub")&&a.children[1].is_group("sum")},a.prototype.doInPlace=function(a){this.initNodeMap();var b=this.getNewTreeNode(this.addsub);if(b.is_group("add","sub")&&b.children[1].is_group("sum")){var c=b.is_group("sub"),d=b.parent,e=b.children[1],f=this.addsub.children[1];this.updateNodeMap(this.addsub,d),this.updateNodeMap(f,e.children);var g=_c.remove(b);if(c)for(var h=0;h<e.children.length;h++)e.children[h].invert();d.insert_range(g,e.children)}if("function"!=typeof a)return this;a(this)},u.prototype.cleanupAction=new a}(),function(){var a=function(a){p.call(this,"CommutativeGroupCleanup","group cleanup action"),a&&(this.group=a.actor)};ad.inherit(p,a),a.prototype.match=function(a){return a.is_group()&&(!a.has_children()||1===a.children.length)},a.prototype.doInPlace=function(a){this.initNodeMap();var b=this.getNewTreeNode(this.group);if(0===b.children.length)_c.remove(b);else if(1===b.children.length){var c=b.children[0],d=this.group.children[0],e=c.children[1];this.updateNodeMap(d.children[0],e),this.updateNodeMap(d,e),this.updateNodeMap(d.parent,e),_c.replace(c.parent,e),e.parent.parent&&w.handle(e.parent,!0),w.handle(e,!0)}if("function"!=typeof a)return this;a(this)},z.prototype.cleanupAction=new a,x.prototype.cleanupAction=new a}(),function(){var a=function(a){p.call(this,"PowerCleanup","power cleanup action"),a&&(this.actor=a.actor)};ad.inherit(p,a),a.prototype.match=function(b){return!!a.powerWithoutExponent(b)},a.powerWithoutExponent=function(a){return!(!a.is_group("power")||1!==a.children.length)},a.prototype.doInPlace=function(b){this.initNodeMap();var c=this.getNewTreeNode(this.actor),d=c.parent;this.actor.parent;if(a.powerWithoutExponent(c)){var e=c.children[0],f=(this.getOldTreeNode(e),_c.remove(c));this.updateNodeMap(this.actor,d),d.insert(f,e)}if("function"!=typeof b)return this;b(this)},H.prototype.cleanupAction=new a}(),function(){var a=function(a){p.call(this,"MulDivCleanup","muldiv cleanup action"),a&&(this.actor=a.actor)};ad.inherit(p,a),a.prototype.match=function(b){return!!a.hasProductChild(b)||!(!b.parent.cleanupAction||!b.parent.cleanupAction.match(b.parent))},a.hasProductChild=function(a){return(a.is_group("mul")||a.is_group("div"))&&a.children[1]&&a.children[1].is_group("product")},a.prototype.doInPlace=function(b){this.initNodeMap();var c=this.getNewTreeNode(this.actor),d=c.parent;this.actor.parent;if(a.hasProductChild(c)){var e=c.children[1],f=this.getOldTreeNode(e),g=_c.remove(c);this.updateNodeMap(this.actor,d),this.updateNodeMap(f,e.children),this.actor.is_group("div")&&e.children.forEach(function(a){a.invert()}),d.insert_range(g,e.children)}if("function"!=typeof b)return this;b(this)},K.prototype.cleanupAction=new a}(),function(){var a=function(a){p.call(this,"ProductFractionCleanup","product-fraction cleanup action"),a&&(this.actor=a.actor)};ad.inherit(p,a),a.prototype.match=function(a){var b=a.get_top().length,c=a.get_bottom().length;return 0===b&&0===c||("product"===a.value&&c>0||("fraction"===a.value&&0===c||("fraction"===a.value&&0===b||1===b&&0===c)))},a.prototype.doInPlace=function(a){this.initNodeMap();var b,c=this.getNewTreeNode(this.actor),d=this.actor,e=c.get_top().length,f=c.get_bottom().length;if(0===e&&0===f){var g=new D(1);this.updateNodeMap(this.actor,g),_c.replace(c,g),g.parent.is_group("brackets")&&w.handle(g.parent,!0),b=!0}if(!b&&"product"===d.value&&f>0&&c.invert(),b||"fraction"!==d.value||0!==f||c.invert(),"fraction"===d.value&&0===e&&(d.children[0]instanceof s||_c.insert(c,0,new s("//")),_c.insert(c,0,new K(new D(1)))),1===e&&0===f){var h=c.get_top()[0].children[1];if(this.updateNodeMap(d,h),this.updateNodeMap(d.children[0],h),_c.replace(c,h),h.parent.is_group("brackets"))w.handle(h.parent,!0);else{if(h.is_group("brackets"))var i=h.children[1];var j=w.handle(h,!0);i&&"removed"===j&&(this.updateNodeMap(d,i),this.updateNodeMap(d.children[0],i))}}if("function"!=typeof a)return this;a(this)},I.prototype.cleanupAction=new a}(),function(){var a=function(a){p.call(this,"RadicalCleanup","power cleanup action"),a&&(this.actor=a.actor)};ad.inherit(p,a),a.prototype.match=function(a){return a.is_group("radical")&&a.children.length<4},a.prototype.doInPlace=function(a){this.initNodeMap();var b=this.getNewTreeNode(this.actor),c=b.parent;this.actor.parent;if(b.is_group("radical")&&b.children.length<4){var d=b.children[2],e=(this.getOldTreeNode(d),_c.remove(b));this.updateNodeMap(this.actor,c),c.insert(e,d)}if("function"!=typeof a)return this;a(this)},C.prototype.cleanupAction=new a}(),me=Object.freeze({}),ne=function(){function a(){id(this,a),this.id=bd(),this.links=[],this.groups=[],this.node_to_group={},this.unlinked_nodes=[],this.events=d3.dispatch("link_added","link_removed"),this.auto_update_scrubbability=!0}return jd(a,[{key:"toJSON",value:function(){return{id:this.id,type:"LinkCoordinator",links:this.links,auto_update_scrubbability:this.auto_update_scrubbability}}},{key:"addLinks",value:function(a,b){var c=this;a.forEach(function(a){return c.addLink(a,b)})}},{key:"addLink",value:function(a,b){this.links.push(a),this.registerLink(a,b),this.events.link_added({link:a})}},{key:"registerLink",value:function(a,b){var c=this.getGroup(a.source),d=this.getGroup(a.target);if(a.bidirectional){if(c!==d){var e=this.mergeGroups(c,d);this.auto_update_scrubbability&&!b&&this.setLocked(e)}}else{if(c===d)throw"unidirectional linking between bidirectionally linked nodes!";d.deps+=1,this.auto_update_scrubbability&&!b&&this.setLocked(d)}}},{key:"getGroup",value:function(a){var b=this.node_to_group[a.id];return b||(b={deps:0,nodes:[a]},this.groups.push(b),this.node_to_group[a.id]=b),b}},{key:"replaceNode",value:function(a,b){if(this.node_to_group[a.id]){var c=this.node_to_group[a.id];delete this.node_to_group[a.id],this.node_to_group[b.id]=c;var d=c.nodes.indexOf(a);c.nodes[d]=b}}},{key:"unlinkCanvasModel",value:function(a,b){var c=this;a.dls().forEach(function(a){return c.unlinkDL(a,!0)}),a.getElementsOfType("graph").forEach(function(a){return c.unlinkGraph(a,!0)}),this.auto_update_scrubbability&&!b&&this.updateAll()}},{key:"unlinkDL",value:function(a,b){return this.unlinkContainer(a.rows,"model",b)}},{key:"unlinkGraph",value:function(a,b){return this.unlinkContainer(a.geoms,null,b)}},{key:"unlinkContainer",value:function(a,b,c){var d=this,e=[];return a.forEach(function(a){e=e.concat(d.unlinkElement(b?a[b]:a,!0))}),this.auto_update_scrubbability&&!c&&this.updateAll(),e}},{key:"unlinkElement",value:function(a,b){var c=this,d=[];return this.links=this.links.filter(function(b){if(b.source===a||b.target===a){var e=b.source===a?b.target:b.source;return-1===c.unlinked_nodes.indexOf(e)&&c.unlinked_nodes.push(e),d.push(b),!1}return!0}),-1===this.unlinked_nodes.indexOf(a)&&this.unlinked_nodes.push(a),this.auto_update_scrubbability&&!b&&this.updateAll(),d}},{key:"updateAll",value:function(){this.groups=[],this.node_to_group={};for(var a=0;a<this.unlinked_nodes.length;a++)this.getGroup(this.unlinked_nodes[a]);this.unlinked_nodes=[];for(var b=0;b<this.links.length;b++)this.registerLink(this.links[b],!0);for(var c=0;c<this.groups.length;c++)this.setLocked(this.groups[c])}},{key:"setLocked",value:function(a){a.nodes.forEach(function(b){return b.setLocked(a.deps>0)})}},{key:"mergeGroups",value:function(a,b){var c=this,d=this.groups.indexOf(b);return this.groups.splice(d,1),b.nodes.forEach(function(b){return c.node_to_group[b.id]=a}),a.nodes=a.nodes.concat(b.nodes),a.deps+=b.deps,a}}],[{key:"fromJSON",value:function(a,b){var c=nb();return c.links=c.links.concat(a.links),c.updateAll(),c}}]),a}(),oe=new ne,ad.AlgebraModelLink=ob,ob.prototype.toJSON=function(){return{id:this.id,type:"AlgebraModelLink",source:this.source.id,target:this.target.id,action:this.action}},ob.fromJSON=function(a,b){var c=new ob(b[a.source],b[a.target],a.action,a.id);return c.id=a.id,c},ob.prototype.onChange=function(a){if(a.old_model!==this.source)throw"wrong old_model";a.new_model!==a.old_model&&(this.source.events.on("change."+this.id,null),this.source=a.new_model,nb().replaceNode(a.old_model,a.new_model),this.source.events.on("change."+this.id,this.onChange.bind(this)));var b=this.action.nodes,c=this.action.target,d=this.action.actor;try{if(this.action.broken)try{var e=this.model_before_broken.children[0].get_1to1_mapping_to(a.new_model.children[0],!1);this.action.rebind(a.new_model,e,a.old_model)}catch(b){return void console.log("scrubbing broke, can't reapply",this.action.name,"to",a.new_model.to_ascii())}else this.action.rebind(a.new_model,a.node_map,a.old_model);this.action.rematch()?(this.action.broken=!1,this.model_before_broken=null,this.action.run(),this.action.newTree.hide_nodes(),this.action.newTree.for_each(function(a){a.selected=!1}),this.target.replace_with(this.action.newTree)):this.brokenAction(b,c,d,a.old_model)}catch(e){console.warn("An error occurred when trying to rematch "+this.action.name),ad.sendErrorReport("An error occurred when trying to rematch "+(this.action&&this.action.name)+"\n from "+(a.old_model&&a.old_model.to_ascii())+"\n to "+(a.new_model&&a.new_model.to_ascii())),this.brokenAction(b,c,d,a.old_model)}},ob.prototype.brokenAction=function(a,b,c,d){this.action.nodes=a,this.action.target=b,this.action.actor=c,this.action.broken||(this.action.broken=!0,this.model_before_broken=d),console.log("scrubbing broke, can't reapply",this.action.name,"to",this.source.to_ascii())},ob.prototype.onTargetChange=function(a){if(a.old_model!==this.target)throw"wrong old_model";a.new_model!==a.old_model&&(this.target.events.on("change."+this.id,null),this.target=a.new_model,nb().replaceNode(a.old_model,a.new_model),this.target.events.on("change."+this.id,this.onTargetChange.bind(this)))},pe={},Object.keys(le).forEach(function(a){return pe[a]=new le[a]}),qe={},Object.keys(me).forEach(function(a){return qe[a]=new me[a]}),se=function(){function a(b,c,d){id(this,a),this.view=b,this.h_align=c||"center",this.v_align=d||"alphabetic",this.readFontSettings()}return jd(a,[{key:"readFontSettings",value:function(){this.to_str_opts={sym_map:this.view.settings.get("symbol_mappings"),precision:this.view.settings.get("number_display_precision")},this.char_metrics=this.view.font_settings.get("char_metrics")}},{key:"set_style",value:function(a){for(var b=0;b<a.length;b++){var c=a[b],d=Id.is_top_most(c)||!c.size?this.view.settings.get("font_size"):c.size,e=c.parent.color||(this.view.interactive()?this.view.settings.get("color"):this.view.settings.get("inactive_color"));this.set_color_and_size(c,d,e)}}},{key:"set_color_and_size",value:function(a,b,c){a.size=b,a.bigger&&(a.size*=1.5),a.smaller&&(a.size*=.67),a.color=a.selected?this.view.settings.get("selection_color"):c,a.children.forEach(function(b,c){a.is_group("fraction")?this.set_color_and_size(b,a.size*this.view.settings.get("fraction_size_factor"),a.color):a.is_group("power")&&b.is_group("exponent")?this.set_color_and_size(b,a.size*this.view.settings.get("exp_size_factor"),a.color):a.is_group("radical")&&b.is_group("degree")?this.set_color_and_size(b,a.size*this.view.settings.get("degree_size_factor"),a.color):a.is_leaf_node&&a.has_subscript()&&1===c?this.set_color_and_size(b,a.size*this.view.settings.get("subscript_size_factor"),a.color):this.set_color_and_size(b,a.size,a.color)},this)}},{key:"set_position",value:function(a){var b=arguments.length<=1||void 0===arguments[1]||arguments[1];this.readFontSettings();var c=a instanceof Id?a.children[0]:a;if(c){if(!Id.is_top_most(c))throw"[NodeRenderer] Calling set_position on a sub-node of a tree will most assuredly cause rendering issues.";var d=this.view.font_settings.get("font_center");this.view.font_settings.get("font_ascent"),this.view.font_settings.get("font_descent");this.rel_pos(c,b,d);var e,f;switch(this.v_align){case"alphabetic":f=-.94*c.size;break;case"top":f=-c.descent;break;case"middle":f=d*c.size;break;case"center":f=(-c.descent+c.ascent)/2;break;case"bottom":f=c.ascent}switch(this.h_align){case"left":e=c.width;break;case"center":e=c.width/2;break;case"equals":if(e=c.width/2,c.is_group("equals","lte","gte","lt","gt")){var g=c.children[1];e=-(g.rel_x+g.sel_box.x+g.sel_box.width/2)}break;case"right":e=0}this.abs_pos(c,e,f,e,f)}}},{key:"position_horizontally",value:function(a){for(var b=a[0].parent,c=0,d=-1/0,e=-1/0,f=0,g=0,h=a.length,i=a[0].hidden?0:a[0].lmar||0,j=a[h-1].hidden?0:a[h-1].rmar||0,k=0;k<a.length;k++){var l=a[k];c+=l.hidden||l.hide_after_drop?0:l.width,f+=l.hidden?0:l.width,d=Math.max(d,l.hidden?0:l.ascent-l.rel_y),e=Math.max(e,l.hidden?0:l.descent+l.rel_y)}g=d+e,Id.is_top_most(b)&&i&&(c-=i);for(var m=-c,k=0;k<a.length;k++){var l=a[k],n=0===k?0:l.lmar||0,o=0===k?l.width-(l.lmar||0):l.width,p=0===k?0:Math.min(a[k-1].rmar||0,n);c-=p,l.rel_x+=m+l.width+n-p,(l.hidden||l.hide_after_drop)&&(l.rel_x-=o-p),m+=l.hidden||l.hide_after_drop?0:o-p}return Id.is_top_most(b)&&0!==m&&a.forEach(function(a){a.rel_x-=m}),{width:c,height:g,ascent:d,descent:e,sel_box:{x:-c-i,width:c,y:-d,height:g},lmar:i,rmar:j}}},{key:"getFontMetric",value:function(a,b){var c=this.char_metrics[a.to_string(this.to_str_opts)];return c&&b in c?c[b]*a.size:"ascent"===b?this.view.font_settings.get("font_ascent")*a.size:"descent"===b?this.view.font_settings.get("font_descent")*a.size:void 0}},{key:"rel_pos",value:function(a,b,c){a.is_leaf_node&&!a.has_subscript()?this.leaf_rel_pos(a,b,c):this.group_rel_pos(a,b,c)}},{key:"leaf_rel_pos",value:function(a,b,c){var d=0,e=0,f=a.value+a.parent.value,g=a.value;if(f in this.char_metrics?("lmar"in this.char_metrics[f]&&(d=this.char_metrics[f].lmar),"rmar"in this.char_metrics[f]&&(e=this.char_metrics[f].rmar)):g in this.char_metrics&&("lmar"in this.char_metrics[g]&&(d=this.char_metrics[g].lmar),"rmar"in this.char_metrics[g]&&(e=this.char_metrics[g].rmar)),a.lmar=d*a.size,a.rmar=e*a.size,b){var h=a.to_string(this.to_str_opts),i=this.char_metrics[g]&&this.char_metrics[g].width?this.char_metrics[g].width*a.size:this.view.fontloader.width(h,a.size,this.view.get_font(a));a.width=i+a.lmar+a.rmar,a.ascent=this.getFontMetric(a,"ascent"),a.descent=this.getFontMetric(a,"descent"),a.height=a.ascent+a.descent,a.sel_box={x:-a.lmar,width:a.width,y:-a.ascent,height:a.height},a.scale_y=1}a.rel_x=-a.width,a.rel_y=0}},{key:"group_rel_pos",value:function(a,b,c){a.rel_x=0,a.rel_y=0;for(var d=0;d<a.children.length;d++)this.rel_pos(a.children[d],b,c);if(a.is_group("fraction")){for(var e=[],f=[],g=null,h=a.children[0];h;)"mul"==h.value?e.push(h):"div"==h.value?f.push(h):g=h,h=h.rs;var i=this.position_horizontally(e),j=this.position_horizontally(f),k=-c*a.size;g.height=g.size*this.view.font_settings.get("div_bar_height"),g.width=Math.max(i.width,j.width)+a.size/8,g.ascent=g.height/2,g.descent=g.height/2,g.rel_y=k,g.rel_x=.1*a.size,g.sel_box={x:-.1*a.size,width:g.width+.2*a.size,y:-a.size/4,height:a.size/2},a.width=g.width+.2*a.size,a.ascent=i.height+g.height/2-k,a.descent=j.height+g.height/2+k,a.height=a.ascent+a.descent,a.rel_y=0,a.rel_x=-a.width,a.sel_box={x:0,width:a.width,y:-a.ascent,height:a.height};for(var d=0;d<e.length;d++)e[d].rel_y+=-i.descent-g.height/2+k,e[d].rel_x+=.5*(a.width+i.width);for(var d=0;d<f.length;d++)f[d].rel_y+=j.ascent+g.height/2+k,f[d].rel_x+=.5*(a.width+j.width)}else if(a.is_group("radical")){var l=a.children[3],m=this.position_horizontally([l]),n=[a.children[0],a.children[1],a.children[3]],o=this.position_horizontally(n),p=n[1],q=(l.height+.1*l.size)/p.height;this.scaleNode(p,q),p.rel_y=-(p.descent+p.rel_y-l.descent-l.rel_y);var r=n[0];r.rel_y-=.6*p.ascent-p.rel_y,r.rel_x+=p.width/3,p.sel_box={x:-p.lmar,width:p.width,y:-p.ascent,height:p.height},ad.extend(p,p.sel_box);var g=a.children[2];g.height=a.size*this.view.font_settings.get("div_bar_height"),g.width=m.width+a.size/8,g.ascent=g.height/2,g.descent=g.height/2,g.rel_y=-p.ascent+p.rel_y,g.rel_x=p.rel_x+p.width-g.height/2,g.sel_box={x:0,width:g.width,y:-g.height/2,height:g.height},ad.extend(g,g.sel_box),o.ascent=p.ascent-p.rel_y+g.ascent,o.descent=p.descent+p.rel_y,o.height=o.ascent+o.descent,o.y-=g.ascent,o.x+=p.width/3,o.width-=r.children[0].hidden?0:p.width/3,ad.extend(a,o)}else{if(a.is_group("power")){var s=a.children[0],t=a.children[1],u=this.view.font_settings.get("font_dominant_baseline");t.rel_y=t.ascent-s.ascent,t.rel_y=Math.min(t.rel_y,-(u*s.size+.05*s.size)-t.descent),a.children[0].is_group("func")&&(a.children[1].rel_x-=a.children[0].children[1].width,a.children[0].children[1].rel_x+=a.children[1].width)}if(a.is_leaf_node&&a.has_subscript()){var v=a.children[0],x=a.children[1];x.rel_y+=.32*(v.descent-c*v.size),x.rel_x-=x.size/6,x.width+=x.size/6}if(ad.extend(a,this.position_horizontally(a.children)),a.is_group("brackets","abs-val")&&!w.areHidden(a)){var y=this.view.settings.get("brackets_size_factor")-1,z=a.children[0],A=a.children[1],B=a.children[2],C=(A.height+y*A.size)/z.height;this.scaleNode(z,C),z.rel_y=c*(z.scale_y-1)*z.size,this.scaleNode(B,C),B.rel_y=c*(B.scale_y-1)*B.size,a.ascent=z.ascent-z.rel_y,a.descent=z.descent+z.rel_y,a.height=a.ascent+a.descent,a.sel_box.y=-a.ascent,a.sel_box.height=a.height}}}},{key:"scaleNode",value:function(a,b){var c=a.scale_y||1;a.scale_y=c*b,a.ascent*=b,a.descent*=b,a.height*=b,a.sel_box.y=-a.ascent,a.sel_box.height=a.height}},{key:"abs_pos",value:function(a,b,c,d,e){a.x=a.rel_x+b,a.y=a.rel_y+c,a.x0=a.rel_x+d,a.y0=a.rel_y+e,a.children.forEach(function(b){this.abs_pos(b,a.x,a.y,a.x0,a.y0)},this)}}]),a}(),a("AlgebraView",te=function(){function a(b,c){var d=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],e=arguments.length<=3||void 0===arguments[3]?null:arguments[3];id(this,a),this.id=ad.uid(),this.model=b,this.derivation=d.derivation||null,this.events=d3.dispatch("updated"),this.model.events.on("change."+this.id,this.onChange.bind(this)),this.model.events.on("scrubbability-changed."+this.id,this.update_scrub.bind(this)),this.container=d3.select(c),this.main=null,this.initializeSettings(d),this.input_mode="mouse",this.is_animating=0,this.afterAnimationCallbacks=[],this.normal_sel=null,this.shadow_sel=null,this.smoosh_sel=null,this.interaction_handler=null,this.registerInputModeListener(),this.init(e)}return jd(a,[{key:"scaleToSize",value:function(a){var b=this.getBBox();if(!b.height||!b.width)return void console.warn("Calling scaleToSize before AlgebraView is initialized.");var c=a.width?a.width/b.width:1/0,d=a.height?a.height/b.height:1/0,e=this.settings.get("font_size")*Math.min(d,c);a.min_font_size&&(e=Math.max(e,a.min_font_size)),a.max_font_size&&(e=Math.min(e,a.max_font_size)),this.settings.set("font_size",e),this.render(!1)}},{key:"scaleToContainer",value:function(a){var b=this.container.node();this.scaleToSize(cd.extend(a,{width:b.clientWidth,height:b.clientHeight}));var c=0,d=0;"right"===a.h_align?c=b.clientWidth:"center"===a.h_align&&(c=b.clientWidth/2),"top"===a.v_align?d=b.clientHeight:"middle"===a.v_align&&(d=b.clientHeight/2),this.main.style("transform",pb()({x:c,y:d}))}},{key:"bindToModel",value:function(a,b){var c=this;this.model&&(this.model.events.on("change."+this.id,null),this.model.events.on("scrubbability-changed."+this.id,null),this.model.events.on("end-of-interaction."+this.id,null)),this.model=a,this.model.events.on("change."+this.id,this.onChange.bind(this)),b&&this.main&&function(){var a=[];c.main.selectAll("div.gm-shadow").each(function(c){var d=b[c.id];this.__delete_me__||!d||1!==d.length||d[0].has_children()||-1!==a.indexOf(d[0])||(d3.select(this).datum(d[0]),a.push(d[0]))})}(),this.model.events.on("scrubbability-changed."+this.id,this.update_scrub.bind(this))}},{key:"registerInputModeListener",value:function(){var a=this,b=this.derivation&&this.derivation.canvas_model;b&&(b.on("input_mode."+this.id,function(b){return a.input_mode=b.mode}),this.input_mode=b.inputMode())}},{key:"onChange",value:function(a){a.old_model!==a.new_model?(this.bindToModel(a.new_model,a.node_map),this.settings.get("auto_update")&&this.render(!1)):this.settings.get("auto_update")&&this.render(!a.no_anim),a.no_anim&&this.removeOldNodes()}},{key:"removeOldNodes",value:function(){this.normal_sel.filter(function(){return this.__delete_me__}).remove(),this.normal_sel=this.main.selectAll(".gm-math"),this.shadow_sel.filter(function(){return this.__delete_me__}).remove(),this.shadow_sel=this.main.selectAll(".gm-shadow")}},{key:"callAfterAnimation",value:function(a){this.is_animating?this.afterAnimationCallbacks.push(a):a()}},{key:"animationFinished",value:function(){this.is_animating=Math.max(0,this.is_animating-1),this.is_animating>0||(this.afterAnimationCallbacks.forEach(function(a){a()}),this.afterAnimationCallbacks=[],this.removeOldNodes())}},{key:"initializeSettings",value:function(){var a=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];this.settings=new nd("AlgebraView",a.docId).setExisting(a),this.font_settings=new nd(td[this.settings.get("font_preset")]),this.settings.get("use_arithmetic_multiplication_symbol")&&(this.settings.get("symbol_mappings")["*"]="",this.settings.get("symbol_mappings")["/"]="");var b=this.settings.get("padding");"number"==typeof b&&this.settings.set("padding",{left:b,right:b,top:b,bottom:b}),window&&window.canvas&&window.canvas.screen_size.width>10&&this.settings.set("drag_dy_on_touch",0)}},{key:"init",value:function(b){var c=this;this.main=this.container.append("div").attr("id",this.settings.get("id")).attr("class","main").style("transform",pb()(this.settings.get("pos"))).style("-webkit-transform",pb()(this.settings.get("pos"))).style("position",this.settings.get("inline_display")?"relative":"absolute"),this.normal_sel=this.main.selectAll(".gm-math"),this.shadow_sel=this.main.selectAll(".gm-shadow"),this.smooshed_sel=this.main.selectAll(".gm-smooshed"),this.border_rect=this.main.append("div").style("border-radius",this.settings.get("border_radius")).style("background",this.settings.get("background_color")).style("border-color",this.settings.get("border_color")).style("position","absolute").style("opacity",this.settings.get("bg_visible")?1:0).style("pointer-events","all"),this.settings.get("event_receiver")?this.event_receiver=d3.select(this.settings.get("event_receiver")):(this.event_receiver=this.main,this.event_receiver.style("pointer-events","all")),this.renderer=new se(this,this.settings.get("h_align"),this.settings.get("v_align")),this.settings.get("fixed")||(this.interaction_handler=new ha(this,this.settings.get("interactive")),this.interaction_handler.only_synchronous_actions=this.settings.get("only_synchronous_actions"),this.main.classed("interactive",this.settings.get("interactive")));var d=[this.font_settings.get("normal_font"),this.font_settings.get("italic_font")];a.fontloader?(this.fontloader=a.fontloader,this.fontloader.add_fonts(d)):(a.fontloader=T(d,2e3),this.fontloader=a.fontloader),this.fontloader.on_fonts_loaded(function(){c.render(!1),b&&b(c)})}},{key:"interactive",value:function(a){return 0===arguments.length?!this.settings.get("fixed")&&this.settings.get("interactive"):(this.settings.set("interactive",a),this.settings.get("fixed")||(this.interaction_handler.set_interactive(a),this.main.classed("interactive",this.settings.get("interactive"))),this)}},{key:"wiggle",value:function(a,b){Array.isArray(a)||(a=[a]);for(var c=[],d=0;d<a.length;d++){var e=a[d].split(":"),f=1===e.length?this.model.getRanges(e[0]):this.model.getRanges(e[0],Number(e[1])-1);f&&(c=c.concat(f))}var g=ad.array.flatten(c);0!==g.length&&(this.wiggleNodes(g,b),this.settings.get("fixed")||this.interaction_handler.events.on("touch."+this.id,this.wiggleNodes.bind(this,null,!1)))}},{key:"wiggleNodes",value:function(a){function b(a){d3.select(this).transition().duration(f).styleTween("transform",i(g,-g)).styleTween("-webkit-transform",i(g,-g)).transition().duration(f).styleTween("transform",i(-g,g)).styleTween("-webkit-transform",i(-g,g)).each("end",b)}var c=arguments.length<=1||void 0===arguments[1]||arguments[1];a||(a=this.model.children),Array.isArray(a)||(a=[a]);var d=[];a.forEach(function(a){return d=d.concat(a.get_leaf_nodes())});var e=this.normal_sel.filter(function(a){return-1!==d.indexOf(a)}).select(".inner");e.style("transform-origin",function(a){return(a.sel_box.x+a.sel_box.width/2).toFixed(2)+"px "+(a.sel_box.y+a.sel_box.height/2).toFixed(2)+"px"}).style("-webkit-transform-origin",function(a){return(a.sel_box.x+a.sel_box.width/2).toFixed(2)+"px "+(a.sel_box.y+a.sel_box.height/2).toFixed(2)+"px"});var f=this.settings.get("wiggle_dur"),g=this.settings.get("wiggle_deg"),h=this.settings.get("wiggle_random_delay"),i=function(a,b,c){var d=d3.interpolate(a,b);return function(a){return function(a){return"rotate("+d(a)+"deg)"}}};c?e.transition().delay(function(){return Math.random()*h}).duration(f/2).styleTween("transform",i(0,g)).styleTween("-webkit-transform",i(0,g)).each("end",b):e.interrupt().transition().style("transform",null).style("-webkit-transform",null)}},{key:"reposition",value:function(a){this.renderer.set_position(this.model),this.update_existing()}},{key:"getSmooshedNodesSelection",value:function(a){return this.main.selectAll("div.gm-smooshed").data(_c.get_leaf_nodes(a),function(a){return a.id})}},{key:"enterSmooshed",value:function(a){var b=this,c=this.getSmooshedNodesSelection(a),d=c.enter().insert("div",".gm-math").classed("gm-smooshed",!0).style("transform",pb()).style("-webkit-transform",pb()).style("opacity",1);d.append("div").classed("inner",!0).style("position","absolute"),d.select("div.inner").append("div");var e=d.filter(function(a){return"//"===a.value}).select("div.inner"),f=(e.classed("line",!0).style("position","absolute").call(rb.bind(this),this.settings.get("slanted_div_bar")).style("width",function(a){return a.width*b.settings.get("smooshed_nodes_shrink_factor")+"px"}).style("background",function(a){return b.settings.get("selection_color")}).style("opacity",function(a){return 1}),{sym_map:this.settings.get("symbol_mappings"),precision:this.settings.get("number_display_precision")});d.select("div.inner").style("display","block").style("font-family",function(a){return b.get_font(a).family}).style("font-weight",function(a){return b.get_font(a).weight}).style("font-style",function(a){return b.get_font(a).style}).style("font-size",function(a){return a.size+"px"}).style("color",function(a){return a.color}).style("user-select","none").style("opacity",function(a){return a.hidden?1e-5:1}).text(function(a){return a.to_string(f)}).transition().duration(this.settings.get("dur")).ease(this.settings.get("easing_fn")).style("font-size",function(a){return a.size*b.settings.get("smooshed_nodes_shrink_factor")+"px"}).style("color",this.settings.get("selection_color"))}},{key:"updateSmooshed",value:function(a){var b=arguments.length<=1||void 0===arguments[1]||arguments[1];this.getSmooshedNodesSelection(a).transition().duration(b?this.settings.get("dur_dragging"):this.settings.get("dur")).ease(b?"circle-out":this.settings.get("easing_fn")).style("transform",pb()).style("-webkit-transform",pb())}},{key:"exitSmooshed",value:function(){this.main.selectAll("div.gm-smooshed").remove()}},{key:"render",value:function(){var a=arguments.length<=0||void 0===arguments[0]||arguments[0],b=arguments.length<=1||void 0===arguments[1]?null:arguments[1];this.renderer.set_style(this.model.children),this.renderer.set_position(this.model),b&&b.newTree!==b.oldTree?this.renderActionAnimation(a,b):(this.enter_and_exit(a),this.update_existing(a)),this.events.updated({type:"updated",source:this,sender_id:this.id}),this.is_animating++,a?setTimeout(this.animationFinished.bind(this),a?this.settings.get("dur"):0):this.animationFinished()}},{key:"renderActionAnimation",value:function(a,b){var c=this.analyzeNodeMap(b),d=this.normal_sel.filter(function(a){return c.exit[a.id]}).each(function(a){a.x0=c.exit[a.id].x0,a.y0=c.exit[a.id].y0});d.filter(function(a){return a._set_vis_at_start}).style("opacity",0),this._exit(d,"normal",a);var e=this.normal_sel.filter(function(a){return c.update[a.id]}).each(function(a){this.__data__=c.update[a.id]});this._updateType(e,"normal",!1,a);var f=b.newTree.get_leaf_nodes().filter(function(a){var b=c.enter[a.id];return b&&(a.x=b.x,a.y=b.y),b}),g=this.main.selectAll(".math-new").data(f).enter();this._enter(g,"normal",a),f.forEach(function(a){a.x=a.x0,a.y=a.y0}),this.normal_sel=this.main.selectAll(".gm-math"),this.normal_sel.each(function(a){delete a._set_vis_at_start,delete a._set_vis_at_end})}},{key:"analyzeNodeMap",value:function(a){var b={},c={},d={},e=a.getInverseNodeMap(),f=a.node_map,g=a.oldTree.get_leaf_nodes(),h=a.newTree.get_leaf_nodes();return e=this.filterNodesInMap(e,h,g),f=this.filterNodesInMap(f,g,h),Object.keys(f).forEach(function(a){var h=f[a],i=g.find(function(b){return b.id===a});if(0===h.length)d[a]=i;else if(1===h.length){var j=h[0].id,k=e[j];1===k.length?b[a]=h[0]:k.length>1&&(d[a]=h[0],c[j]=h[0])}else h.length>1&&h.every(function(b){if(!(e[b.id].length>1))return!0;d[a]=i})}),Object.keys(e).forEach(function(a){var b=e[a],g=h.find(function(b){return b.id===a});if(0===b.length)c[a]=g;else if(1===b.length){var i=b[0].id;f[i].length>1&&(c[a]=b[0],d[i]=b[0],g._set_vis_at_start=!0,b[0]._set_vis_at_start=!0)}else b.length>1&&b.every(function(b){if(!(f[b.id].length>1))return!0;c[a]=b})}),{update:b,enter:c,exit:d}}},{key:"filterNodesInMap",value:function(a,b,c){var d={};return Object.keys(a).forEach(function(e){b.find(function(a){return a.id===e})&&(d[e]=a[e].filter(function(a){return-1!==c.indexOf(a)}))}),d}},{key:"enter_and_exit",value:function(){var a=arguments.length<=0||void 0===arguments[0]||arguments[0],b=arguments.length<=1||void 0===arguments[1]?"normal":arguments[1];if("both"===b||"normal"===b){var c=this.normal_sel.data(_c.get_leaf_nodes(this.model.children),function(a){return a.id});this._enter(c.enter(),"normal",a),this._exit(c.exit(),"normal",a),this.normal_sel=this.main.selectAll(".gm-math")}if("both"===b||"shadow"===b){var d=this.shadow_sel.data(_c.get_leaf_nodes(this.model.filter(function(a){return a.dragging})),function(a){return a.id});this._enter(d.enter(),"shadow",a),this._exit(d.exit(),"shadow",a),this.shadow_sel=this.main.selectAll(".gm-shadow")}}},{key:"hideExitingNodes",value:function(){this.normal_sel.filter(function(){return this.__delete_me__}).style("display","none")}},{key:"getNormalNodesSelection",value:function(){return this.main.selectAll("div.gm-math").data(_c.get_leaf_nodes(this.model.children),function(a){return a.id})}},{key:"getShadowNodesSelection",value:function(){if(!this.settings.get("show_node_targets"))return[];var a=this.model.filter(function(a){return a.dragging}),b=_c.filter(function(a){return!a.has_children()},a);return this.main.selectAll("div.gm-shadow").data(b,function(a){return a.id})}},{key:"_enter",value:function(a,b){var c=this,d=arguments.length<=2||void 0===arguments[2]||arguments[2],e="shadow"===b;if(0!==a.size()){var f=e?a.insert("div",".gm-smooshed,.gm-math"):a.append("div");f.classed("gm-math",!e).classed("gm-shadow",e).attr("id",function(a){return a.id}).style("position","absolute").style("transform-origin","center top").style("-webkit-transform-origin","center top");var g=f.append("div").style("position","absolute").classed("inner",!0).style("pointer-events","none").append("div").attr("class",function(a){return"//"===a.value?"line":"text"}).style("position","absolute"),h=(g.filter(function(a){return"//"===a.value}),g.filter(function(a){return"//"!==a.value}));if(this._updateType(f,b,!1,!1),e||this.enterTraceBackgrounds(f),h.style("font-family",function(a){return c.get_font(a).family}).style("font-weight",function(a){return c.get_font(a).weight}).style("font-style",function(a){return c.get_font(a).style}),e&&h.style("color",this.settings.get("shadow_node_color")).style("text-shadow",this.settings.get("shadow_node_shadow")),d){this._get_transition(f,!0).style("transform",pb("x0","y0")).style("-webkit-transform",pb("x0","y0"));var i=g.filter(function(a){return a._set_vis_at_end});i.style("opacity",1e-5),this._get_transition(i,!0,"linear").each("end",function(a){d3.select(this).call(qb,e)});var j=g.filter(function(a){return!a._set_vis_at_start&&!a._set_vis_at_end});j.style("opacity",1e-5),this._get_transition(j,!0,"linear").call(qb,e)}this.settings.get("debug_draw")&&this.debugDraw(f)}}},{key:"enterTraceBackgrounds",value:function(a){this.settings.get("trace_syms")||(a=a.filter(function(a){return!a.is_group("sym")})),a=a.select(".inner").selectAll(".bg-rect"),a.data(function(a){return[a]}).enter().insert("div","*").classed("bg-rect",!0).style("position","absolute").style({"border-radius":this.settings.get("trace_rect_radius")+"px",background:this.settings.get("trace_color"),visibility:"hidden"}).style({left:function(a){return a.sel_box.x+"px"},top:function(a){return a.sel_box.y/(a.scale_y||1)+"px"},width:function(a){return a.sel_box.width+"px"},height:function(a){return a.sel_box.height/(a.scale_y||1)+"px"}})}},{key:"updateTraceBackgrounds",value:function(a){a.selectAll(".bg-rect").data(function(a){return[a]}).style({left:function(a){return a.sel_box.x+"px"},top:function(a){return a.sel_box.y/(a.scale_y||1)+"px"},width:function(a){return a.sel_box.width+"px"},height:function(a){return a.sel_box.height/(a.scale_y||1)+"px"}})}},{key:"_exit",value:function(a,b){var c=arguments.length<=2||void 0===arguments[2]||arguments[2];0!==a.size()&&(a.each(function(){this.__delete_me__=!0}),c?(this._get_transition(a).style("transform",pb("x0","y0")).style("-webkit-transform",pb("x0","y0")).each("end",function(){this.style.display="none"}),this._get_transition(a.select("div").filter(function(a){return!a._set_vis_at_end}),!0,"linear").style("opacity",1e-5)):a.style("display","none"))}},{key:"_get_transition",value:function(a){var b=arguments.length<=1||void 0===arguments[1]||arguments[1],c=arguments.length<=2||void 0===arguments[2]?null:arguments[2];return b&&this.settings.get("dur")?a.transition().duration(b?this.settings.get("dur"):0).ease(c||this.settings.get("easing_fn")):(a.interrupt().transition(),a)}},{key:"_updateType",value:function(a,b,c,d){var e=this;if(0!==a.size()){var f="shadow"===b,g=a.select(".text");c||function(){var b={sym_map:e.settings.get("symbol_mappings"),precision:e.settings.get("number_display_precision")};e._get_transition(a,d).style("transform",pb(f?"x0":"x",f?"y0":"y")).style("-webkit-transform",pb(f?"x0":"x",f?"y0":"y")),g.text(function(a){return a.to_string(b)})}();var h=this._get_transition(g,d).style("font-size",function(a){return a.size+"px"}).call(qb,f);f||(h.style("color",function(a){return a.color}),this.updateTraceBackgrounds(a)),this._get_transition(a.select(".line"),d).call(rb.bind(this),this.settings.get("slanted_div_bar"),f),c||this.update_background()}}},{key:"update_style",value:function(){var a=arguments.length<=0||void 0===arguments[0]||arguments[0],b=arguments.length<=1||void 0===arguments[1]?"normal":arguments[1];"both"!==b&&"normal"!==b||this._updateType(this.normal_sel.filter(function(){return!this.__delete_me__}),"normal",!0,a),"both"!==b&&"shadow"!==b||this._updateType(this.normal_sel.filter(function(){return!this.__delete_me__}),"shadow",!0,a)}},{key:"update_existing",value:function(){var a=arguments.length<=0||void 0===arguments[0]||arguments[0],b=arguments.length<=1||void 0===arguments[1]?"normal":arguments[1];"both"!==b&&"normal"!==b||(this._updateType(this.normal_sel.filter(function(){return!this.__delete_me__}),"normal",!1,a),this.update_scrub()),"both"!==b&&"shadow"!==b||this._updateType(this.shadow_sel.filter(function(){return!this.__delete_me__}),"shadow",!1,a)}},{key:"update_scrub",value:function(){this.settings.get("visualize_scrubbable_nodes")&&"inspect"===this.settings.get("interaction_mode")?this.normal_sel.each(function(a){var b=d3.select(this),c=b.selectAll(".scrub");0!==c.size()||!D.is_num(a)||a.fixed||a.locked||(b.selectAll(".scrub").data(["top","bottom"]).enter().append("div").classed("scrub",!0).text(function(a){return"top"===a?"":""}).style({opacity:.5,position:"absolute"}),c=b.selectAll(".scrub")),c.style("visibility",a.locked||a.hidden?"hidden":"visible"),c.style("font-size",a.size/4+"px"),c.each(function(b){var c="matrix(1.3, 0, 0, 1, "+(a.sel_box.x+a.sel_box.width/2)+"\n  , "+("top"===b?a.sel_box.y:a.sel_box.y+a.sel_box.height)+")translate(-42%,-50%)";d3.select(this).style("transform",c).style("-webkit-transform",c)})}):this.normal_sel.selectAll(".scrub").remove()}},{key:"setMode",value:function(a){var b=arguments.length<=1||void 0===arguments[1]||arguments[1];this.settings.get("interaction_mode")!==a&&(this.settings.set("interaction_mode",a),b&&this.update_existing(),this.interaction_handler&&this.interaction_handler.modeChanged(a))}},{key:"update_background",value:function(a){var b=this.model.children[0],c=this.getBBox();b&&!b.dragging&&(this.border_rect.style("border-radius",this.settings.get("border_radius")).style("background",this.settings.get("background_color")).style("border-color",this.settings.get("border_color")).style({left:c.x+"px",top:c.y+"px",width:c.width+"px",height:c.height+"px"}),this.settings.get("inline_display")&&this.main.style({left:c.x+"px",top:c.y+"px",width:c.width+"px",height:c.height+"px"}))}},{key:"set_background_visible",value:function(a){this.settings.set("bg_visible",!!a),this.border_rect.style("opacity",a?1:0)}},{key:"getBBox",value:function(a){a=a||{};var b=this.model.children[0];if(!b||!b.sel_box)return{x:0,y:0,width:0,height:0};var c={},d=this.settings.get("padding");return c.x=b.sel_box.x+(b.dragging?b.x0:b.x)-(a.no_padding?0:d.left),c.y=b.sel_box.y+(b.dragging?b.y0:b.y)-(a.no_padding?0:d.top),c.width=b.sel_box.width+(a.no_padding?0:d.left+d.right),c.height=b.sel_box.height+(a.no_padding?0:d.top+d.bottom),c}},{key:"updateDraggedNodes",value:function(a){var b="touch"===this.input_mode?this.settings.get("drag_dy_on_touch"):0;b*=this.model.children[0].size;this.normal_sel.filter(function(b){return-1!==a.indexOf(b)}).transition().duration(this.settings.get("dur_dragging")).ease("circle-out").style("transform",function(a){return"matrix(1, 0, 0, "+(a.scale_y||1)+", "+a.x+", "+(a.y+b)+")"}).style("-webkit-transform",function(a){return"matrix(1, 0, 0, "+(a.scale_y||1)+", "+a.x+", "+(a.y+b)+")"})}},{key:"get_font",value:function(a){return a&&a.is_group&&a.is_group("var")?this.font_settings.get("italic_font"):this.font_settings.get("normal_font")}},{key:"debugDraw",value:function(a){var b=this,c=a.select(".inner");c.append("div").style("position","absolute").style("opacity",function(a){return a.hidden?.3:1}).style("border","1px solid silver").style({left:function(a){return a.sel_box.x+.5+"px"},top:function(a){return a.sel_box.y/(a.scale_y||1)+.5+"px"},width:function(a){return a.sel_box.width-1+"px"},height:function(a){return a.sel_box.height/(a.scale_y||1)-1+"px"}}),c.append("div").style("position","absolute").style("opacity",function(a){return a.hidden?.3:1}).style("background","gray").filter(function(a){return a.sel_box}).style({left:function(a){return a.sel_box.x+"px"},width:function(a){return a.sel_box.width+"px"},top:function(a){return"-0.5px"},height:"1px"}),c.append("div").style("position","absolute").style("opacity",function(a){return a.hidden?.3:1}).style("background","orange").filter(function(a){return a.sel_box}).style({left:function(a){return a.sel_box.x+"px"},width:function(a){return a.sel_box.width+"px"},top:function(a){return a.descent/(a.scale_y||1)-.5+"px"},height:"1px"}),c.append("div").style("position","absolute").style("opacity",function(a){return a.hidden?.3:1}).style("background","green").filter(function(a){return a.sel_box}).style({left:function(a){return a.sel_box.x+"px"},width:function(a){return a.sel_box.width+"px"},top:function(a){return-a.ascent/(a.scale_y||1)-.5+"px"},height:"1px"}),c.append("div").style("position","absolute").style("opacity",function(a){return a.hidden?.3:1}).style("background","blue").filter(function(a){return a.sel_box}).style({left:function(a){return a.sel_box.x+"px"},width:function(a){return a.sel_box.width+"px"},top:function(a){return-a.size*b.font_settings.get("font_center")-.5+"px"},height:"1px"}),c.append("div").style("position","absolute").style("opacity",function(a){return a.hidden?.3:1}).style("background","pink").filter(function(a){return a.sel_box}).style({left:function(a){return a.sel_box.x+"px"},width:function(a){return a.sel_box.width+"px"},top:function(a){return-a.size*b.font_settings.get("font_dominant_baseline")-.5+"px"},height:"1px"})}}],[{key:"preloadFonts",value:function(b){a.fontloader?a.fontloader.add_fonts(b):a.fontloader=new T(b)}},{key:"createStaticExpression",value:function(b,c){var d=arguments.length<=2||void 0===arguments[2]?{}:arguments[2];"string"==typeof b&&(b=document.querySelector(b));var e=new Id(c),f={interactive:!1,inactive_color:"#000000",v_align:"bottom",h_align:"left",inline_display:!0},g=cd.merged(f,d);return new a(e,b,g,function(a){a.scaleToContainer(g)})}}]),a}()),a("preloadFonts",ue=te.preloadFonts),new md("AlgebraView").defaults.setAll({font_size:80,font_preset:"Kalam",auto_update:!0,color:"#333",selection_color:"#4682b4",inverse_selection_color:"#957946",only_synchronous_actions:!1,show_drag_indicator:!0,inactive_color:"#676965",hold_area_feedback:!0,fraction_size_factor:.75,exp_size_factor:.6,degree_size_factor:.5,brackets_size_factor:1.15,subscript_size_factor:.6,smooshed_nodes_shrink_factor:.5,debug_draw:!1,dur:750,dur_dragging:300,easing_fn:"cubic-in-out",pos:{x:0,y:0},inline_display:!1,interaction_mode:"edit",v_align:"alphabetic",h_align:"center",background_color:"none",bg_visible:!1,shadow_filter:null,border_color:"none",shadow_color:"none",border_radius:0,padding:{left:0,right:0,top:0,bottom:0},interactive:!0,event_receiver:null,symbol_mappings:{"-":"","*":"","/":""},use_arithmetic_multiplication_symbol:!1,wiggle_dur:200,wiggle_deg:10,wiggle_random_delay:100,show_node_targets:!0,shadow_node_color:"white",shadow_node_shadow:"0 0 1px gray, 0 0 1px black",enable_drag_to_join:!0,visualize_scrubbable_nodes:!0,rubber_band_selection:!0,hide_mouse_cursor:!0,hold_time:1500,trigger_delay_minimum:150,trigger_delay_factor:.8,fixed:!1,drag_dy_on_touch:0,trace_syms:!1,trace_color:"rgb(194, 219, 179)",trace_rect_radius:6,number_display_precision:3}),ve=function(){function a(b,c){var d=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],e=arguments.length<=3||void 0===arguments[3]?"CanvasElement":arguments[3];id(this,a),this.id=d.id||ad.uid(),this.type="canvas-element",this.canvas_model=b,this.element_div=null,this.events=d3.dispatch("start-of-interaction","end-of-interaction","active","move","resize","moved","resized"),this.mouse_events=d3.dispatch("touch","drag","release"),this.dragging=!1,this.initCanvasElementSettings(d,e),this.initElement(c),this.initCanvasElementProperties(),this.enterMode(this.mode,!0),this.settings.get("select_on_create")&&this.setDragging(!0)}return jd(a,[{key:"emitEvent",value:function(a,b){var c={type:a,source:this,time:Date.now()};b&&(c=ad.extend(c,b)),this.events[a](c)}},{key:"initCanvasElementSettings",value:function(){var a=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],b=arguments[1];this.settings=new nd(b,this.canvas_model&&this.canvas_model.docId()),this.settings.setExisting(a)}},{key:"initElement",value:function(a){if(this.settings.get("visualized"))return 0===arguments.length?this.containing_group.node():(this.containing_group=d3.select(a),this.updateContainerDims(),this.element_div?this.containing_group.node().appendChild(this.element_div.node()):this.element_div=this.containing_group.append("div").classed("canvas-element",!0).attr("id",this.id).datum(this).on("mouseenter."+this.id,this.mouseHovering.bind(this,!0)).on("mouseleave."+this.id,this.mouseHovering.bind(this,!1)).style("pointer-events","all").style("position","absolute"),this.delete_grp&&this.delete_grp.selectAll("rect").style("fill",this.settings.get("delete_btn_color")),this)}},{key:"initCanvasElementProperties",value:function(){this.mode=this.settings.get("mode"),this.active=this.settings.get("active"),this.settings.get("visualized")&&(this.size=ad.extend({},this.settings.get("size")),this.pos=this.alignmentToPosition(this.settings.get("pos")),this.translateElement(this.pos),this.element_div.style("height",this.size.height+"px").style("width",this.size.width+"px"),this.updateBGStyle())}},{key:"setMode",value:function(a){if(this.settings.get("visualized"))return a?a!==this.mode&&(this.settings.get("modes").every(function(b){return b!==a})&&this.setMode("edit"),this.exitMode(a),this.enterMode(a),this.mode=a,this.updateBGStyle(),!0):this.mode}},{key:"exitMode",value:function(a){this.exitSubTypeMode(a),"arrange"===this.mode&&this.exitArrangeMode(),"arrange"!==this.mode&&"arrange"===a&&this.exitEditMode()}},{key:"exitSubTypeMode",value:function(){}},{key:"enterMode",value:function(a,b){this.settings.get("visualized")&&("arrange"===a?this.enterArrangeMode():this.enterEditMode(),this.enterSubTypeMode(a))}},{key:"enterSubTypeMode",value:function(a){}},{key:"enterEditMode",value:function(){if(this.edit_mtouch?this.edit_mtouch.connected(!0):(this.edit_mtouch=ad.mtouch_events(),this.edit_mtouch.origin(function(a){return[a.pos.x,a.pos.y]}).on("touch."+this.id,this.touch.bind(this,null)).on("drag."+this.id,this.drag.bind(this,null)).on("release."+this.id,this.release.bind(this,null))),!this.edit_move_div&&this.settings.get("draggable")){var a=this.settings.get("edit_mode_drag_box_width")<0,b=(a?-1:1)*this.settings.get("edit_mode_drag_box_width");this.edit_move_div=this.element_div.append("div").style({position:"absolute",left:a?-b+"px":0,top:0,bottom:0,width:b+"px"}).style("cursor",this.settings.get("draggable")?"move":null).call(this.edit_mtouch)}else this.edit_move_div&&this.edit_move_div.style("display",null)}},{key:"exitEditMode",value:function(){this.edit_mtouch&&this.edit_mtouch.connected(!1),this.edit_move_div&&this.edit_move_div.style("display","none")}},{key:"enterArrangeMode",value:function(){this.initMoveControls(),this.initDeleteControls(),this.initResizeControls()}},{key:"initMoveControls",value:function(){this.arrange_mtouch||(this.arrange_mtouch=ad.mtouch_events().origin(function(a){return[a.pos.x,a.pos.y]}).on("touch."+this.id,this.touch.bind(this,null)).on("drag."+this.id,this.drag.bind(this,null)).on("release."+this.id,this.release.bind(this,null))),this.arrange_mode_div||(this.arrange_mode_div=this.element_div.append("div").classed("canvas-element-arrange-pane",!0).datum(this).style({position:"absolute",left:0,right:0,top:0,bottom:0}).style("pointer-events","all").style("cursor",this.settings.get("draggable")?"move":null).call(this.arrange_mtouch))}},{key:"initDeleteControls",value:function(){var a=this;if(this.delete_mtouch||(this.delete_mtouch=ad.mtouch_events().on("release",function(){this.contains(d3.event.sourceEvent.target)&&(a.emitEvent("start-of-interaction"),a.canvas_model.removeElement(a),a.emitEvent("end-of-interaction"))})),!this.delete_grp){var b=this.settings.get("delete_btn_size"),c=5;this.delete_grp=this.element_div.append("svg").style({position:"absolute",width:b+2*c+"px",height:b+2*c+"px",right:2-c+"px",top:2-c+"px"}).call(this.delete_mtouch),this.delete_icon=this.delete_grp.append("g").style("mouse-events","all").on("mouseenter",function(){d3.select(this).selectAll("rect").style("fill","red")}).on("mouseleave",function(){d3.select(this).selectAll("rect").style("fill",a.settings.get("delete_btn_color"))}).attr("transform","translate("+[b/2+c,b/2+c]+")rotate(45)"),this.delete_icon.append("circle").attr({r:b/2+c}).style("opacity",0),this.delete_icon.append("rect").attr({width:b,height:b/3.5,x:-b/2,y:-b/7}).style("fill",this.settings.get("delete_btn_color")).style("stroke","none"),this.delete_icon.append("rect").attr({width:b/3.5,height:b,x:-b/7,y:-b/2}).style("fill",this.settings.get("delete_btn_color")).style("stroke","none")}}},{key:"initResizeControls",value:function(){var a=this;if(!this.settings.get("resizable").x&&!this.settings.get("resizable").y)return void(this.resize_grp&&this.resize_grp.style("display","none"));if(this.resize_grp&&this.resize_grp.style("display",null),this.resize_mtouch||(this.resize_mtouch=ad.mtouch_events().origin(function(){return[a.size.width,a.size.height]}).on("touch."+this.id+"_resize",function(){a.emitEvent("start-of-interaction",{size:{width:a.size.width,height:a.size.height}})}).on("drag."+this.id+"_resize",function(){a.resize({width:d3.event.x,height:d3.event.y})}).on("release."+this.id+"_resize",function(){var b={size:{width:a.size.width,height:a.size.height}};a.emitEvent("end-of-interaction",b),a.emitEvent("resized",b)})),!this.resize_grp){var b,c=5;b=this.settings.get("resizable").x&&this.settings.get("resizable").y?"nwse-resize":this.settings.get("resizable").x?"ew-resize":"ns-resize";var d=this.settings.get("resize_tab_size");this.resize_grp=this.element_div.append("svg").style({position:"absolute",width:d+2*c+"px",height:d+2*c+"px",right:-c+"px",bottom:-c+"px"}).call(this.resize_mtouch),this.resize_icon=this.resize_grp.append("g").style("mouse-events","all").attr("transform","translate("+[d+c,d+c]+")").style("cursor",b),this.resize_icon.append("circle").attr({r:d/2+5,cx:-d/3,cy:-d/3}).style("opacity",0),this.resize_icon.append("path").attr("d","M"+[-d,0]+"L"+[0,0]+"L"+[0,-d]+"Z").style("fill",this.settings.get("resize_tab_color")).style("stroke","none")}}},{key:"exitArrangeMode",value:function(){this.arrange_mode_div&&(this.arrange_mode_div.remove(),delete this.arrange_mode_div),this.arrange_mtouch&&(this.arrange_mtouch.connected(!1),delete this.arrange_mtouch),this.delete_grp&&(this.delete_grp.remove(),delete this.delete_grp),this.delete_mtouch&&(this.delete_mtouch.connected(!1),delete this.delete_mtouch),this.resize_grp&&(this.resize_grp.remove(),delete this.resize_grp),this.resize_mtouch&&(this.resize_mtouch.connected(!1),delete this.resize_mtouch)}},{key:"touch",value:function(a){this.emitEvent("start-of-interaction",{pos:ad.deepCopy(this.pos)});a||d3.event;this.updateContainerDims(),this.setDragging(!0),"arrange"!==this.mode&&this.setActive(!0)}},{key:"drag",value:function(a){var b=a||d3.event;this.settings.get("draggable")&&(this.settings.get("keep_in_container")&&(b.x=Math.max(0,Math.min(this.container_size.width-this.size.width,b.x)),b.y=Math.max(0,Math.min(this.container_size.height-this.size.height,b.y))),this.translateElement(b))}},{key:"release",value:function(a){this.setDragging(!1);var b={pos:{x:this.pos.x,y:this.pos.y}};this.emitEvent("end-of-interaction",b),this.emitEvent("moved",b)}},{key:"setDragging",value:function(a){this.dragging!==a&&(this.dragging=a,this.updateBGStyle())}},{key:"resize",value:function(a){if(this.settings.get("resizable").x||!this.settings.get("resizable").y){var b=Math.max(this.settings.get("min_size").width,a.width),c=Math.max(this.settings.get("min_size").height,a.height);b=Math.min(b,b-(a.width+this.pos.x-this.container_size.width)),c=Math.min(c,c-(a.height+this.pos.y-this.container_size.height)),this.settings.get("resizable").x||(b=this.size.width),this.settings.get("resizable").y||(c=this.size.height),this.resizeElement({width:b,height:c})}}},{key:"resizeElement",value:function(a){this.size.width===a.width&&this.size.height===a.height||(this.size.width=a.width,this.size.height=a.height,this.element_div.style("width",this.size.width+"px").style("height",this.size.height+"px"),this.subTypeResize(),this.events.resize({type:"resize",size:{width:this.size.width,height:this.size.height}}))}},{key:"subTypeResize",value:function(){}},{key:"updateContainerDims",value:function(){this.canvas_model?(this.container_size=this.canvas_model.size(),this.container_view=this.canvas_model.viewport()):(this.container_size=this.containing_group.node().getBoundingClientRect(),this.container_view=this.container_size)}},{key:"initPosition",value:function(a){"auto"===this.settings.get("pos")?this.canvas_model.moveToFreeSpace(this,a):(this.pos=this.alignmentToPosition(this.settings.get("pos")),this.translateElement(this.pos,a))}},{key:"alignmentToPosition",value:function(a){var b=a.x,c=a.y;return"center"===b?b=this.container_view.width/2-this.size.width/2:"left"===b?b=0:"right"===b&&(b=this.container_view.width-this.size.width),"center"===c?c=this.container_view.height/2-this.size.height/2:"top"===c?c=0:"bottom"===c&&(c=this.container_view.height-this.size.height),{x:b,y:c}}},{key:"translateElement",value:function(a,b){if(this.settings.get("visualized")){this.pos.x=a.x,this.pos.y=a.y;var c=this.settings.get("graphics_caching")?"translate3d("+[Math.round(this.pos.x)+"px",Math.round(this.pos.y)+"px",0]+")":"translate("+[Math.round(this.pos.x)+"px",Math.round(this.pos.y)+"px"]+")",d=this.element_div;b&&(d=d.transition().duration(this.settings.get("dur")).ease(this.settings.get("easing_fn"))),d.style("transform",c),d.style("-webkit-transform",c),this.events.move({type:"move",animated:b,pos:{x:this.pos.x,y:this.pos.y}})}}},{key:"moveElement",value:function(a,b){var c={x:this.pos.x+a.x,y:this.pos.y+a.y};this.translateElement(c,b)}},{key:"mouseHovering",value:function(a){this.canvas_model?this.canvas_model.setActive(this,a):this.setActive(a)}},{key:"setActive",value:function(a){this.active!==a&&(this.active=a,this.updateBGStyle(),"arrange"!==this.mode&&this.setSubTypeActive(),this.emitEvent("active",{active:a}))}},{key:"setSubTypeActive",value:function(){}},{key:"updateBGStyle",value:function(){if(this.settings.get("show_bg")){var a=["bg"];a.push("arrange"!==this.mode?"edit":"arrange"),this.dragging?a.push("dragging"):this.active&&a.push("active"),a.push("style"),this.element_div.style("visibility",null).style(this.settings.get(a.join("_")))}}},{key:"removeElement",value:function(){this.element_div.remove()}},{key:"getBoundingClientRect",value:function(){return this.element_div.node().getBoundingClientRect()}},{key:"getBBox",value:function(){return{x:this.pos.x,y:this.pos.y,width:this.size.width,height:this.size.height}}},{key:"overlapsWithRegion",value:function(a){ad.HitTester.overlaps({x:this.pos.x,y:this.pos.y,width:this.size.width,height:this.size.height},a)}},{key:"hitTest",value:function(a){return a.x>=this.pos.x&&a.x<=this.pos.x+this.size.width&&a.y>=this.pos.y&&a.y<=this.pos.y+this.size.height}},{key:"getDistanceTo",value:function(a){var b=this.size.width/2,c=this.size.height/2,d=Math.max(Math.abs(this.pos.x+b-a.x)-b,0),e=Math.max(Math.abs(this.pos.y+c-a.y)-c,0);return d*d+e*e}}]),a}(),we=new md("CanvasElement"),we.defaults.setAll({visualized:!0,pos:{x:"center",y:"center"},min_size:{width:30,height:50},size:{width:100,height:100},active:!1,mode:"edit",modes:["edit","arrange"],resizable:{x:!0,y:!0},draggable:!0,keep_in_container:!0,send_events:!0,dont_log_events:!1,graphics_caching:!0,delete_btn_size:20,delete_btn_color:"silver",resize_tab_size:25,resize_tab_color:"#c6c6c6",dur:300,easing_fn:"cubic-in-out",edit_mode_drag_box_width:20,show_bg:!0,bg_edit_style:{"background-color":"transparent","box-shadow":"none","border-radius":"2px"},bg_edit_active_style:{"background-color":"rgba(255,255,255,0.9)","box-shadow":"none"},bg_edit_dragging_style:{"background-color":"rgba(255,255,255,0.9)","box-shadow":"0 3px 6px rgba(0,0,0,0.23)"},bg_arrange_style:{"background-color":"rgba(255,255,255,0.9)","box-shadow":"0 3px 6px rgba(0,0,0,0.23)"},bg_arrange_active_style:{"background-color":"rgba(255,255,255,0.9)","box-shadow":"0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23)"},bg_arrange_dragging_style:{"background-color":"rgba(255,255,255,0.9)","box-shadow":"0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23)"}}),ad.DerivationRow=sb,sb.prototype.toJSON=function(){return{id:this.id,type:"DerivationRow",dl:this.dl.id,action:this.action&&this.action.id,model:this.model,row_idx:this.idx}},sb.fromJSON=function(a,b){return new sb(a.dl,a)},sb.prototype.createHandle=function(){if(this.view&&!this.dl.settings.get("no_handles")){this.mtouch=this.setupInteractionListeners();var a=this.getHandlePos(),b=this.el.selectAll(".handle").data([this,this]);b.enter().append("div").classed("handle",!0).style({cursor:"pointer"}).call(this.mtouch).style("transform","translate("+a[0]+"px,"+a[1]+"px)").style("-webkit-transform","translate("+a[0]+"px,"+a[1]+"px)").style({background:"white","border-color":this.handle_color?this.handle_color:this.dl.settings.get("handle_stroke_color"),"border-width":"2px","border-style":"solid",width:this.dl.handle_size+"px",height:this.dl.handle_size+"px","border-radius":"50%",position:"absolute"}).style({"pointer-events":"all"}),this.handle=b,this.setHandleVisibility()}},sb.prototype.takeHandle=function(a){this.dl.settings.get("no_handles")||(this.handle=a,this.handle.data([this,this]),this.handle_color=this.dl.settings.get("handle_stroke_color"),this.handle.style({stroke:this.handle_color}),this.handle.call(this.setupInteractionListeners()),this.bindViewToInteractionHandlerListeners())},sb.prototype.setHandleColor=function(a){this.handle_color=a,this.handle&&this.handle.style("stroke",a)},sb.prototype.removeHandle=function(){this.view&&(this.mtouch&&(this.mtouch.connected(!1),delete this.mtouch),this.handle&&(this.handle.remove(),delete this.handle))},sb.prototype.getHandlePos=function(){if(!this.view)return[0,0];var a=this.view.getBBox({no_padding:!0});return["left"===this.dl.settings.get("handle_pos")?a.x-this.dl.handle_pos_offset-this.dl.handle_size/2:a.x+a.width+(this.dl.handle_pos_offset-this.dl.handle_size/2),a.y+(a.height/2-this.dl.handle_size/2)]},sb.prototype.updateHandlePos=function(a){if(this.view&&!this.dl.settings.get("no_handles")){var b=this.getHandlePos();if(this.handle){this.handle.transition().ease(this.view.settings.get("easing_fn")).duration(a?0:this.view.settings.get("dur")).style("width",this.dl.handle_size+"px").style("height",this.dl.handle_size+"px").style("transform","translate("+b[0]+"px,"+b[1]+"px)").style("-webkit-transform","translate("+b[0]+"px, "+b[1]+"px)");var c=this.dl.handle_size+this.dl.handle_pos_offset-22-25+5;this.dl.settings.get("padding").right=c}}},sb.prototype.createView=function(a,b){var c=this,d=c?this.dl.alignment_correction.insert("div","div.dl-line#"+c.model.id):this.dl.alignment_correction.append("div");d.classed("dl-line",!0).attr("id",this.model.id).style("transform","translate("+(a.pos||[0,0]).join("px,")+"px)").style("-webkit-transform","translate("+(a.pos||[0,0]).join("px,")+"px)").datum(this),this.el=d,a.pos=[0,0],a.border_color="none",a.background_color=this.dl.settings.get("row_background_color"),this.dl.settings.get("standalone")&&(a.event_receiver=this.dl.main.node()),a.derivation=this.dl,this.setView(new te(this.model,d.node(),a,function(a){this.setView(a),this.bindViewToInteractionHandlerListeners(),this.createHandle(),this.updateDimensionAfterInteraction(),b&&b(this.dl)}.bind(this)))},sb.prototype.setView=function(a){this.view!==a&&(this.view&&this.view.events.on("updated."+this.dl.id,null),this.view=a,this.view&&this.view.events.on("updated."+this.dl.id,this.updateDimensionAfterInteraction.bind(this)))},sb.prototype.bindViewToInteractionHandlerListeners=function(){var a=this;this.view.interaction_handler.events.on("inspect_node."+this.dl.id,this.dl.onInspect.bind(this.dl,this)),this.view.interaction_handler.events.on("drag_start."+this.dl.id,this.dl.setActiveDLComponent.bind(this.dl,"AV")),this.view.interaction_handler.events.on("drag_end."+this.dl.id,this.dl.setActiveDLComponent.bind(this.dl,"none")),this.view.interaction_handler.events.on("touch."+this.dl.id,function(){a.dl.delete_mode?a.dl.canvas_model.removeElement(a.dl):(a.dl.updateBGStyle(),a.dl.updateHandleVisibilities())})},sb.prototype.updateDims=function(){if(this.view){var a=this.view.getBBox({no_padding:!0});a.y-=this.padding.top,a.height+=this.padding.top+this.padding.bottom,a.x-=this.padding.left,a.width+=this.padding.left+this.padding.right;var b=this.dims.x!==a.x||this.dims.y!==a.y||this.dims.width!==a.width||this.dims.height!==a.height;return b&&(this.dims=a),b}},sb.prototype.updateDimensionAfterInteraction=function(a){this.updateDims()&&(this.dl.updateDims()?this.updateHandlePos(a):(this.updateBackground(a),this.updateHandlePos(a)))},sb.prototype.updateBackground=function(a){if(this.view&&this.dims){var b=this.dims.x-this.dl.dims.x+this.padding.left-this.dl.settings.get("padding").left,c=this.dl.dims.x+this.dl.dims.width-this.dims.x-this.dims.width+this.padding.right-this.dl.settings.get("padding").right;this.view.settings.set("padding",{left:b,right:c,top:this.padding.top,bottom:this.padding.bottom}),this.view.update_background(a)}},sb.prototype.showBackground=function(a){this.view&&(this.view.settings.set("border_color",a?this.dl.settings.get("row_border_color"):"none"),this.updateBackground(),this.view.set_background_visible(!0))},sb.prototype.hideBackground=function(){this.view&&this.view.set_background_visible(!1)},sb.prototype.setHandleVisibility=function(a){if(this.view&&!this.dl.settings.get("no_handles")&&this&&this.handle){arguments.length<1&&(a=!0);var b=(this.dl.rows,this.dl.settings.get("hide_handles")),c=this.getHandlePos(),d=this;this.handle.each(function(e,f){var g=d3.select(this);if(b||!a||"AV"===d.dl.active_dl_component||!d.dl.active&&d.dl.canvas_model&&"mouse"===d.dl.canvas_model.inputMode())return void g.style("visibility","hidden");d.atLeastOneNotCutHiddenRowAbove()?(g.style("visibility","visible").style("transform","translate("+(c[0]-d.dl.handle_size/4*f)+"px,"+c[1]+"px)").style("-webkit-transform","translate("+(c[0]-d.dl.handle_size/4*f)+"px,"+c[1]+"px)"),d.representHiddenHandleColor()):(g.style("visibility",0===f?"visible":"hidden").style("transform","translate("+c[0]+"px,"+c[1]+"px)"),d.revertHandleColor())})}},sb.prototype.atLeastOneNotCutHiddenRowAbove=function(){for(var a=this.dl.rows,b=this.idx-1;b>=0;b--)if(!a[b].hidden||!a[b].cut)return!!a[b].hidden;return!1},sb.prototype.representHiddenHandleColor=function(){var a;this.handle_color===this.dl.settings.get("handle_stroke_color")&&(a=this.coloredHandleHiddenBeneath())&&"pack"===this.dl.curr_row_operation&&(this.setHandleColor(a),this.is_displaying_hidden_handle_color=!0)},sb.prototype.revertHandleColor=function(){this.is_displaying_hidden_handle_color&&(this.setHandleColor(this.dl.settings.get("handle_stroke_color")),delete this.is_displaying_hidden_handle_color)},sb.prototype.coloredHandleHiddenBeneath=function(){for(var a=this.dl.rows,b=this.idx-1;b>=0;b--)if(!a[b].hidden||!a[b].cut){if(a[b].hidden&&a[b].handle_color!==this.dl.settings.get("handle_stroke_color"))return a[b].handle_color;if(!a[b].hidden)return!1}return!1},sb.prototype.hide=function(){this.view&&!this.hidden&&(this.hidden=!0,this.view&&this.view.settings.set("auto_update",!1),this.dl.settings.get("collapsed_mode")||this.dl.updateDims(),this.el.style("display","none"),this.dl.rows[this.idx+1]&&this.dl.rows[this.idx+1].setHandleVisibility())},sb.prototype.unhide=function(){this.view&&this.hidden&&(this.dl.singleLineMode(!1),this.hidden=!1,this.view&&(this.view.settings.set("auto_update",!0),this.view.render(!1)),this.dl.updateDims(),this.el.style("display",null),this.dl.rows[this.idx+1]&&this.dl.updateHandleVisibilities(),this.dl.rows[this.idx].updateHandlePos(!0))},sb.prototype.deactivate=function(){this.view&&(this.view.interactive(!1),this.model.for_each(function(a){a.dragging=!1,a.selected=!1}),this.view.render())},sb.prototype.remove=function(){for(var a=this.idx+1;a<this.dl.rows.length;a++)this.dl.rows[a].idx--;this.dl.rows.splice(this.idx,1),this.removeHandle(),this.view&&this.el.remove(),this.model.events.on("end-of-interaction."+this.dl.id,null),this.model.events.on("change."+this.dl.id,null),this.model.events.on("create."+this.dl.id,null),this.view&&(this.view.events.on("updated."+this.dl.id,null),this.view.interaction_handler.events.on("inspect_node."+this.dl.id,null),this.view.interaction_handler.events.on("drag_start."+this.dl.id,null),this.view.interaction_handler.events.on("drag_end."+this.dl.id,null),this.view.interaction_handler.events.on("touch."+this.dl.id,null))},sb.prototype.removeInteractionListeners=function(){this.mtouch&&this.mtouch.on("drag",null).on("touch",null).on("tap",null).on("dbltap",null).on("release",null)},sb.prototype.setupInteractionListeners=function(){var a=this;return this.mtouch?(this.removeInteractionListeners(),this.mtouch.connected(!1)):this.mtouch=ad.mtouch_events(),this.mtouch.origin(function(b){return[a.dl.pos.x+b.pos[0],a.dl.pos.y+b.pos[1]]}).on("drag",this.drag.bind(this,null)).on("touch",this.touch.bind(this,null)).on("tap",this.tap.bind(this,null)).on("dbltap",this.dbltap.bind(this,null)).on("release",this.dragend.bind(this,null)),this.mtouch},sb.prototype.touch=function(){this.dl.atStartOfInteraction({type:"start-of-interaction",source:{type:"DerivationRow",id:this.dl.id,row:this.idx,model:this.model,packState:this.dl.rows.map(function(a){return!!a.hidden})},time:Date.now()}),this.dl.settings.get("send_events")&&this.dl.row_events.touch(new sb.touchEvent(d3.event,this.idx,this.dl.id)),this.dl.setActiveDLComponent("row"),this.dl.curr_row_operation="undecided",this.dl.updateContainerDims();for(var a=0;a<this.dl.rows.length;a++)this.dl.rows[a].showBackground(a===this.idx);this.handle.style({background:"whitesmoke"})},sb.prototype.tap=function(){if(!(this.dl.rows.length>1)&&ad.actions.FirstLineRewriteAction.match(this.model)){ad.ui&&ad.ui.Keyboard&&ad.ui.Keyboard().abort(),this.model.startInteraction();var a=ad.actions.FirstLineRewriteAction.createBoundAction(this.model,{actor:this.model});this.model.performAction(a,function(){this.model.finishInteraction()}.bind(this),!0)}},sb.prototype.dbltap=function(){this.dl.settings.get("send_events")&&this.dl.row_events.dbltap({type:"dbltap",row:this})},sb.prototype.createLinkVis=function(a,b){var c=arguments.length<=2||void 0===arguments[2]||arguments[2],d=this.dl.canvas_model.foreground_svg().append("g");return d.attr("transform","translate("+(this.pos[0]+this.dl.pos.x-this.dl.dims.x+this.dl.handle_size/2)+","+(this.pos[1]+this.dl.pos.y-this.dl.dims.y+this.dl.handle_size/2)+")"),d.append("line").attr({x1:a[0],y1:a[1],x2:b[0],y2:b[1]}).style("stroke",this.handle_color?this.handle_color:this.dl.settings.get("handle_stroke_color")).style("stroke-width",2).style("stroke-linecap","round"),d.append("circle").attr({cx:a[0],cy:a[1],r:this.dl.handle_size/2}).style("fill","white").style("stroke",this.handle_color?this.handle_color:this.dl.settings.get("handle_stroke_color")).style("stroke-width",2),c&&d.append("circle").attr("id","cursor").attr({cx:b[0],cy:b[1],r:this.dl.handle_size/2}).style("fill","white").style("stroke",this.handle_color?this.handle_color:this.dl.settings.get("handle_stroke_color")).style("stroke-width",2),d},sb.prototype.drag=function(){var a,b,c,d,e,f=d3.event;f.x,a=f.dx,b=f.y,c=f.dy,d=Math.abs(f.finger.dist_x),e=Math.abs(f.finger.dist_y),this.dl.settings.get("send_events")&&this.dl.row_events.drag(new sb.dragEvent(f,this.idx,this.dl.id));var g=Math.sqrt(d*d+e*e);if(g>=10&&"link"!==this.dl.curr_row_operation&&"pack"!==this.dl.curr_row_operation&&(e/g>=.85&&0!==this.idx?(this.dl.curr_row_operation="pack",this.dl.hideAllTraces()):(this.dl.curr_row_operation="link",this.lpos=this.getHandlePos(),this.link=this.createLinkVis(this.lpos,ad.extend({},this.lpos)))),"pack"===this.dl.curr_row_operation)this.dl.handlePackArranging(this,b,c);else if("link"===this.dl.curr_row_operation){var a=f.finger.dx,c=f.finger.dy;this.lpos[0]=this.lpos[0]+a,this.lpos[1]=this.lpos[1]+c,this.link.select("line").attr({x2:this.lpos[0],y2:this.lpos[1]}),this.link.select("#cursor").attr({cx:this.lpos[0],cy:this.lpos[1]});var h={x:this.dl.pos.x-this.dl.dims.x+this.pos[0]+this.lpos[0],y:this.dl.pos.y-this.dl.dims.y+this.pos[1]+this.lpos[1]},i=ad.find(this.dl.canvas_model.elements(),function(a){return a.hitTest(h)});i&&i.type}},sb.prototype.dragend=function(){if(this.dl.settings.get("send_events")&&this.dl.row_events.release(new sb.releaseEvent(d3.event,this.idx,this.dl.id)),this.releaseRow(),"link"===this.dl.curr_row_operation){var a={x:this.dl.pos.x-this.dl.dims.x+this.pos[0]+this.lpos[0],y:this.dl.pos.y-this.dl.dims.y+this.pos[1]+this.lpos[1]},b=ad.find(this.dl.canvas_model.elements(),function(b){return b.hitTest(a)}),c=b?b.type:null;if("ggb-element"===c&&(b=b.ggbPanel,c="ggb-panel"),"ggb-panel"===c)b.dropDLRow(this);else if("derivation"===c&&this.macro&&this.endingPosIsInLastRowHandle(a,b)){var d=[this.dl.rows[0].model,this.dl.getLastModel()],e=b.getLastModel(),f=ad.actions.ApplyFormulaAction.getAllAvailableActions(d,e);if(f.length>0){var g=f[0];g.bindMacroDerivation(this.dl),e.performAction(g)}}else if("derivation"!==c&&!this.sub&&this.dl.settings.get("cloning_on")){this.cloneLine(this,a.x,a.y);var h={},i=this.clone.getLastRow().view.getBBox({no_padding:!0});h.x="left"===this.dl.settings.get("handle_pos")?a.x-20:a.x-i.width-60,h.y=a.y-i.height/2-10,this.clone.translateElement(h),this.clone.setActiveDLComponent("none"),this.clone=null}this.link.remove(),this.link=null,this.lpos=null,this.subable=!1,this.sub=!1}this.dl.curr_row_operation="none",this.dl.afterEndOfInteraction({type:"end-of-interaction",source:{type:"DerivationRow",id:this.dl.id,row:this.idx,model:this.model,packState:this.dl.rows.map(function(a){return!!a.hidden})},time:Date.now()})},sb.prototype.releaseRow=function(){this.dl.setActiveDLComponent("none");for(var a=0;a<this.dl.rows.length;a++)this.dl.rows[a].hideBackground();if(this.dl.settings.get("no_handles")||this.handle.style({background:"white"}),this.dl.draginfo=null,this.idx>0){var b=this.dl.getFinalVerticalPos(this)-this.pos[1],c=this.dl.getVisibleAbove(this);c&&b>0&&b>.5*c.dims.height&&c.hide(),this.dl.layoutRows()}this.dl.updateBGStyle(),this.dl.updateHandleVisibilities()},sb.prototype.cloneLine=function(a,b,c){var d=ad.extend({},this.dl.settings.getAll());d.pos={x:b,y:c},d.eq=a.model.to_ascii(),d.id=ad.uid(),this.dl.settings.get("send_events")&&this.dl.events.clone(new sb.cloneEvent(this.dl.id,d)),this.clone=this.dl.canvas_model.createDL(d),this.clone.setActiveDLComponent("DL"),this.dl.curr_row_operation="clone";var e=ad.actions.CloneAction.createBoundAction(a.model,{});e.node_map=a.model.children[0].get_mapping_to(this.clone.rows[0].model.children[0]);var f=new ob(a.model,this.clone.rows[0].model,e);nb().addLink(f)},sb.prototype.handleCloneDrag=function(a,b,c){this.clone.drag(d3.event);var d=this.dl.pos.x+a.pos[0]-this.clone.pos.x,e=this.dl.pos.y+a.pos[1]-this.clone.pos.y;this.clone_dist=Math.sqrt(d*d+e*e)},sb.prototype.endingPosIsInLastRowHandle=function(a,b){var c=(b.getLastRow(),b.pos),d=b.getLastRow().pos,e=(b.getLastRow().view.getBBox({no_padding:!0}),b.getLastRow().getHandlePos()),f={x:c.x-b.dims.x+d[0]+e[0],y:c.y-b.dims.y+d[1]+e[1]};return Math.abs(a.x-f.x)<20&&Math.abs(a.y-f.y)<20},ad.inherit(ve,tb),ad.Derivation=tb,tb.prototype.toJSON=function(){var a=this.settings.getModified();return a.id=this.id,delete a.pos,{type:"Derivation",rows:this.rows,settings:a,pos:this.pos,pack_state:this.rows.map(function(a){return!!a.hidden})}},tb.fromJSON=function(a,b,c){var d=a.settings.eq;delete a.settings.eq,a.settings.font_size&&c&&c.fontSize()!==a.settings.font_size&&c.fontSize(a.settings.font_size);var e=void 0;return e=c?c.createDL(a.settings,null,"load"):new ad.Derivation(null,null,ad.object.merged(a.settings,{visualized:!1})),a.settings.eq=d,a.rows.forEach(function(b,c){e.addRowFromModel(b.model,b.action,function(){c===a.rows.length-1&&(e.rows.forEach(function(b,c){a.pack_state[c]&&b.hide()}),e.layoutRows(!1))},!1)}),e.translateElement(a.pos),e},tb.createFixedSingleLineDL=function(a,b,c){return b=b||{},b.keep_in_container=!1,b.draggable=!1,b.no_handles=!0,b.collapsed_mode=!0,b.show_bg=!1,b.h_align="h_align"in b?b.h_align:"center",new tb(null,a,b,c)},tb.prototype.startUpdateSequence=function(){this.settings.get("visualized")&&this.update_sequence++},tb.prototype.isInUpdateSequence=function(){if(this.settings.get("visualized"))return this.update_sequence>0},tb.prototype.finishUpdateSequence=function(){if(this.settings.get("visualized")&&(this.update_sequence--,0===this.update_sequence&&this.updateDims(),this.update_sequence<0))throw"called finishUpdateSequence before startUpdateSequence"},tb.prototype.initDerivationSettings=function(a){this.settings.get("standalone")&&this.settings.set("show_bg",!1)},tb.prototype.initDerivationProperties=function(){this.rows=[],this.active_dl_component="none",this.curr_row_operation="none",this.clone=null,this.dims={},this.mapping_nodes=[],this.setHandleProperties()},tb.prototype.setHandleProperties=function(){this.handle_size=this.settings.get("font_size")*this.settings.get("handle_size_factor"),this.handle_pos_offset=this.settings.get("font_size")*this.settings.get("handle_pos_offset_factor")},tb.prototype.initDerivation=function(a){var b=this;this.settings.get("visualized")&&(this.main=this.element_div.insert("div","*"),this.settings.get("svg_no_overflow")?this.main.style({"pointer-events":"none",overflow:"hidden",position:"absolute",left:-this.settings.get("svg_overflow_margin")+"px",top:-this.settings.get("svg_overflow_margin")+"px",width:"calc(100% + "+2*this.settings.get("svg_overflow_margin")+"px)",height:"calc(100% + "+2*this.settings.get("svg_overflow_margin")+"px)"}):this.main.style({overflow:"visible",position:"absolute",left:0,right:0,top:0,bottom:0,width:"100%",height:"100%"}),this.alignment_correction=this.main.append("div").style("position","absolute")),this.settings.get("eq").length>0&&!this.settings.get("dont_init_eq")?this.addLineFromExpressions(this.settings.get("eq").split("\\\\"),function(){b.initPosition(),b.settings.get("visualized")&&b.startWiggle(b.settings.get("wiggle")),a&&a(b)}):a&&a(this)},tb.prototype.initEventListeners=function(){this.canvas_model&&this.canvas_model.on("input_mode."+this.id,this.inputModeChanged.bind(this))},tb.prototype.applyViewAlignment=function(){this.translateElement({x:this.pos.x,y:this.pos.y+this.dims.y})},tb.prototype.addLineFromExpressions=function(a,b){if(a.length<1)return void(b&&b(this));for(var c=0;c<a.length;c++)this.addLineFromExpression(a[c],c===a.length-1?b:null)},tb.prototype.addLineFromExpression=function(a,b){this.rows.length>0&&this.rows[this.rows.length-1].deactivate(),this.addRowFromAscii(a,b)},tb.prototype.inputModeChanged=function(a){this.rows.forEach(function(a){return a.setHandleVisibility()})},tb.prototype.startWiggle=function(a){this.getLastView().wiggle(a,!0)},tb.prototype.setExpression=function(a,b,c){this.getLastModel().parseAndSet(a,b,c)},tb.prototype.enterSubTypeMode=function(a){this.rows&&this.rows.forEach(function(b,c){b.view&&b.view.setMode(a,!b.hidden)},this)},tb.prototype.singleLineMode=function(a){if(0===arguments.length)return this.settings.get("collapsed_mode");if(a&&!this.settings.get("collapsed_mode")){for(var b=!1,c=0;c<this.rows.length-1;c++)this.rows[c].hidden||(b=!0,this.rows[c].hide());b&&this.layoutRows()}return this.settings.set("collapsed_mode",a),this},tb.prototype.getLastRow=function(){return this.rows[this.rows.length-1]},tb.prototype.getRowByModel=function(a){for(var b=0;b<this.rows.length;b++)if(this.rows[b].model===a)return this.rows[b];return null},tb.prototype.getLastModel=function(){return this.getLastRow().model},tb.prototype.getLastView=function(){return this.getLastRow().view};tb.prototype.updateFontSize=function(){if(this.settings.get("visualized")){var a=this.settings.get("font_size");this.rows.forEach(function(b){b.view&&b.view.settings.set("font_size",a)})}},tb.prototype.onInspect=function(a,b){if(b.shiftKey){var c=this.mapping_nodes.indexOf(b.node);-1===c?this.mapping_nodes.push(b.node):this.mapping_nodes.splice(c,1)}else this.mapping_nodes=[b.node];this.events.inspect_node({type:"inspect",node:b.node,dl:this,row:a.idx,shiftKey:b.shiftKey}),"touch"===this.canvas_model.inputMode()&&b.shiftKey&&this.drawTracesForTerms(this.mapping_nodes)},tb.prototype.onChange=function(a){var b=this.getRowByModel(a.old_model);b&&(a.new_model!==a.old_model&&(this.removeModelEventListeners(a.old_model),this.addModelEventListeners(a.new_model),b.model=a.new_model),setTimeout(function(){for(var a=!1,b=1;b<this.rows.length;b++){var c=this.rows[b];c.action.broken&&(a=!0),!!c.model.broken!==a&&(c.model.broken=a,c.model.for_each(function(b){b.color=a?"#E0A8A8":c.view.settings.get("color")}),c.hidden||c.view.update_existing())}}.bind(this),1),this.events.change(cd.extend(new tb.ChangeEvent(this.id,b.model,b.idx),a)))},tb.prototype.onCreate=function(a){var b=this;this.startUpdateSequence();try{var c=(this.getLastView(),this.getLastRow()),d=(c.el,c.handle,a.action.oldTree);if(d.for_each(function(a){a.dragging=!1,a.selected=!1}),d.hide_nodes(),a.action.new_derivation&&this.canvas_model){var e={dont_init_eq:!0,eq:a.action.newTree.to_ascii(),pos:{x:-1e3,y:-1e3}};this.canvas_model.createElement("derivation",e,"math-action",function(c){c.addRowFromModel(a.action.newTree,null,function(){b.canvas_model.moveToFreeSpace(c,!1,b)})})}else{var f=this.addRowFromAction(a.action);this.events.added_line(cd.extend({senderDL_id:this.id,row:c.idx},a)),this.settings.get("visualized")&&c.hide(),this.events.change(new tb.ChangeEvent(this.id,f.model))}nb().addLink(new ob(a.action.oldTree,a.action.newTree,a.action)),a.action.source_am&&nb().addLink(new ob(a.action.source_am,a.action.newTree,a.action))}finally{this.finishUpdateSequence()}},tb.prototype.onSpawn=function(a){function b(c,d){var e=this;if(c){var f={pos:d};c.model?(f.eq=c.model.to_ascii(),f.dont_init_eq=!0):c.text&&(f.text=c.text,f.font_size=.7*this.settings.get("font_size"),f.size={width:2*this.settings.get("font_size")+40,height:200}),this.canvas_model.createElement(c.type,f,"auto",function(d){c.el_id=d.id,"derivation"===c.type?(c.model.hide_nodes(),d.addRowFromModel(c.model,c.action,function(d){b.call(e,a.elements[a.elements.indexOf(c)+1],{x:d.pos.x+d.size.width+1,y:d.pos.y})}),nb().addLink(new ob(a.oldTree,c.model,c.action))):b.call(e,a.elements[a.elements.indexOf(c)+1],{x:d.pos.x+d.size.width+1,y:d.pos.y})})}}this.settings.get("visualized")&&b.call(this,a.elements[0],{x:this.pos.x,y:this.pos.y+this.size.height+1})},tb.prototype.onRestraint=function(a){if(this.settings.get("visualized")){var b=this.pos.x+this.size.width,c=this.pos.y+this.getLastRow().pos[1];this.canvas_model.createElement("textbox",{text:a,dont_log_events:!0,pos:{x:b,y:c},undeditable:!0,resizable:{x:!1,y:!1},use_toolbar:!1,select_text_on_create:!1}),console.log(a)}},tb.prototype.shouldCutRow=function(a){return!!this.rowIsPartOfAContinuousCommutingSequence(a)},tb.prototype.rowIsPartOfAContinuousCommutingSequence=function(a){var b=this.rows[a.idx+1];if(!b)return!1;var c=a.action,d=b.action;if(!c||!d)return!1;if("CommuteAction"!==c.name||"CommuteAction"!==d.name)return!1;for(var e=0;e<c.nodes.length;e++){var f=c.nodes[e],g=d.nodes[e];if(!g)return!1;var h=c.mapNodes(f);if(h.length>1)return!1;if(h[0]!==g)return!1}return!0},tb.prototype.addRowFromAction=function(a){var b=a.newTree;if(this.settings.get("visualized")){var c=this.getLastView();c.bindToModel(b,a.initial_node_map)}var d=this.getLastRow();d.removeInteractionListeners();var e=this.createRow(b,a,d.el);return e.setView(d.view),this.settings.get("visualized")&&(e.takeHandle(d.handle),d.handle=null,c.render(!0,a),this.shouldCutRow(d)&&this.firstRowInSequence?(d.setView(null),d.hidden=!0,d.el=null,d.cut=!0):d.createView(cd.merged(c.settings.getAll(),{interactive:!1,pos:d.pos.slice(),docId:this.settings.docId}))),this.rowBeforeCurrActionSeq||(this.rowBeforeCurrActionSeq=d),this.firstRowInSequence||(this.firstRowInSequence=e),e},tb.prototype.createRow=function(a,b,c){var d=this.getLastRow(),e={model:a,action:b,view:null,el:c,handle:null,dims:d?cd.extend({},d.dims):null,row_idx:this.rows.length,pos:d?d.pos.slice():[0,0],padding:this.settings.get("row_padding")},f=new sb(this,e);return c&&(c.datum(f),c.attr("id",a.id)),this.addModelEventListeners(a),this.rows.push(f),f},tb.prototype.addModelEventListeners=function(a){a.events.on("start-of-interaction."+this.id,this.atStartOfInteraction.bind(this)),a.events.on("end-of-interaction."+this.id,this.afterEndOfInteraction.bind(this)),a.events.on("change."+this.id,this.onChange.bind(this)),a.events.on("mistake."+this.id,this.events.mistake),a.events.on("create."+this.id,this.onCreate.bind(this)),a.events.on("spawn."+this.id,this.onSpawn.bind(this)),a.events.on("restraint."+this.id,this.onRestraint.bind(this))},tb.prototype.removeModelEventListeners=function(a){a.events.on("start-of-interaction."+this.id,null),a.events.on("end-of-interaction."+this.id,null),a.events.on("create."+this.id,null),a.events.on("mistake."+this.id,null),a.events.on("change."+this.id,null),a.events.on("spawn."+this.id,null),a.events.on("restraint."+this.id,null)},tb.prototype.atStartOfInteraction=function(a){a&&a.source&&("AlgebraModel"===a.source.type&&(this.startUpdateSequence(),this.dragging&&this.setDragging(!1)),this.events["start-of-interaction"](a),this.canvas_model&&this.canvas_model.lockActive(!0))},tb.prototype.afterEndOfInteraction=function(a){var b=this;if(a&&a.source)if(this.canvas_model&&this.canvas_model.lockActive(!1),"DerivationRow"===a.source.type)this.events["end-of-interaction"](a);else if("AlgebraModel"===a.source.type){this.isInUpdateSequence()&&this.finishUpdateSequence();var c=a.source,d=this.getRowByModel(c),e=d.view.settings.get("interaction_mode");if(this.canvas_model?this.canvas_model.setActive(this,!0):this.setActive(!0),"inspect"===e)d.updateDimensionAfterInteraction(),this.mapping_nodes=this.mapping_nodes.filter(function(a){return b.getRowByModel(a.get_root())}),this.events["end-of-interaction"](cd.extend(a,{row:d.idx}));else if("edit"===e&&c===this.getLastModel()&&(this.events["end-of-interaction"](a),this.rowBeforeCurrActionSeq))if(this.rowBeforeCurrActionSeq.model.stringify()===this.getLastModel().stringify()){for(var f=(this.rows.length,0);this.getLastRow()!==this.rowBeforeCurrActionSeq;)this.undo(),f++;this.events.auto_undo({undos:f})}else{var d=this.rowBeforeCurrActionSeq,g=this.shouldHideRow(d);this.getLastView().callAfterAnimation(function(){this.startUpdateSequence(),g||d.unhide(),this.layoutRows(),this.finishUpdateSequence()}.bind(this))}this.rowBeforeCurrActionSeq=null,this.firstRowInSequence=null}},tb.prototype.addRowFromModel=function(a,b,c){var d=arguments.length<=3||void 0===arguments[3]||arguments[3],e=this.getLastRow();e&&e.deactivate();var f=this.createRow(a,b),g=e?e.pos.slice():[0,0],h=this;if(this.settings.get("visualized")){var i={docId:this.settings.docId,font_size:this.settings.get("font_size"),padding:this.settings.get("padding"),pos:g,v_align:this.settings.get("v_align"),h_align:this.settings.get("h_align")};f.createView(i,function(){h.events.added_line({type:"create",senderDL_id:h.id,action:b&&"string"!=typeof b?b:{name:"row added from model",newTree:a},row:f.idx}),d&&h.layoutRows(),c&&c(h)})}return f},tb.prototype.addRowFromAscii=function(a,b){var c={action_blacklist:this.settings.get("action_blacklist"),docId:this.settings.docId};return this.addRowFromModel(new Id(a,c),null,b)},tb.prototype.getRowByView=function(a){return this.rows.filter(function(b){return b.view===a})[0]},tb.prototype.updateAllRowBackgroundsAndHandles=function(a){for(var b=0;b<this.rows.length;b++){var c=this.rows[b];c.updateBackground(a),c.updateHandlePos(a)}},tb.prototype.shouldHideRow=function(a){var b=this.rows[a.idx+1];if(b&&b.action&&b.action.settings.layout_hint){if("same-line"===b.action.settings.layout_hint)return!0;if("new-line"===b.action.settings.layout_hint)return!1}if(this.settings.get("collapsed_mode"))return!0;if(this.settings.get("auto_collapse_repeated_actions")&&b&&a.action&&b.action&&a.action.name===b.action.name)return!0;if(this.canvas_model){var c=this.rows[this.rows.length-1],d={x:this.pos.x,y:this.pos.y+a.pos[1]+a.dims.height+this.settings.get("padding").top,width:this.dims.width,height:c.dims.height};return!this.canvas_model.isInFreeVisibleSpace(d,this)}return!1},tb.prototype.getFinalVerticalPos=function(a,b,c){c=c||0;for(var d=this.rows[c].pos[1],e=c+1;e<=a.idx;e++)this.rows[e-1].hidden&&!b||(d+=this.getVerticalAdvance(this.rows[e]));return d},tb.prototype.isAboveFinalVerticalPos=function(a){return a.pos[1]<this.getFinalVerticalPos(a)},tb.prototype.getUpmostPullableRow=function(a){var b;if(this.rows.length<2)return this.rows[0];if(this.isAboveFinalVerticalPos(this.rows[1]))b=0;else for(b=a.idx;b>=0&&(!this.rows[b].hidden||!this.rows[b].el)&&this.isAboveFinalVerticalPos(this.rows[b]);b--);return b===a.idx?null:this.rows[b+1]},tb.prototype.getHiddenAbove=function(a){var b=a.idx-1;if(this.rows[0].hidden)return this.rows[0];for(;b>=0&&(!this.rows[b].hidden||!this.rows[b].el||!this.rows[b].el);)b--;return-1===b?null:this.rows[b]},tb.prototype.getVisibleAbove=function(a){for(var b=a.idx-1;b>=0&&this.rows[b].hidden;)b--;return-1===b?null:this.rows[b]},tb.prototype.getVisibleRowOn=function(a){for(var b=a.idx,c=this.rows.length;b<c&&this.rows[b].hidden;)b++;return b===c?null:this.rows[b]},tb.prototype.getDistanceFromHome=function(a){var b=a.pos[0]-a.drag_pos[0],c=a.pos[1]-a.drag_pos[1];return Math.sqrt(b*b+c*c)},tb.prototype.setLastHandleVisibility=function(a){this.getLastRow().setHandleVisibility(a)},tb.prototype.updateHandleVisibilities=function(){for(var a=0;a<this.rows.length;a++)this.rows[a].setHandleVisibility()},tb.prototype.countVisibleRows=function(){for(var a=0,b=0;b<this.rows.length;b++)this.rows[b].hidden||a++;return a},tb.prototype.updateDims=function(){if(!this.isInUpdateSequence()){var a=1/0,b=1/0,c=-1/0,d=-1/0;this.rows.forEach(function(e){e.hidden||(a=Math.min(a,e.dims.x+e.pos[0]),b=Math.min(b,e.dims.y+e.pos[1]),c=Math.max(c,e.dims.x+e.dims.width+e.pos[0]),d=Math.max(d,e.dims.y+e.dims.height+e.pos[1]))},this),a-=this.settings.get("padding").left,c+=this.settings.get("padding").right,b-=this.settings.get("padding").top,d+=this.settings.get("padding").bottom;var e=a-this.dims.x,f=b-this.dims.y,g=this.dims.x!==a||this.dims.width!==c-a,h=this.dims.y!==b||this.dims.height!==d-b;return(g||h)&&(this.dims={x:a,y:b,width:c-a,height:d-b},this.dimsHaveChanged(e,f,g)),g||h}},tb.prototype.dimsHaveChanged=function(a,b,c){var d=[-this.dims.x+(this.settings.get("svg_no_overflow")?this.settings.get("svg_overflow_margin"):0),-this.dims.y+(this.settings.get("svg_no_overflow")?this.settings.get("svg_overflow_margin"):0)];this.alignment_correction.style({transform:"matrix(1,0,0,1,"+d[0]+","+d[1]+")","-webkit-transform":"matrix(1,0,0,1,"+d[0]+","+d[1]+")"}),(Math.abs(a)>.5||Math.abs(b)>.5)&&this.translateElement({x:this.pos.x+a,y:this.pos.y+b}),this.resizeElement(this.dims),c&&this.rows.forEach(function(a){a.updateBackground()}),this.forceIntoContainer()},tb.prototype.handlePackArranging=function(a,b,c){var d,e=this.rows[this.rows.length-1];if(c>0)if(this.isAboveFinalVerticalPos(a))d=this.getUpmostPullableRow(a);else{if(!(d=this.getHiddenAbove(a)))return;d.unhide(),this.events.pack_state(new sb.stateEvent(this)),d=this.rows[d.idx+1]}else{if(!(d=this.getVisibleAbove(a)))return;a.pos[1]<=d.pos[1]?(d.hide(),this.events.pack_state(new sb.stateEvent(this)),1===this.countVisibleRows()&&this.singleLineMode(!0)):d=this.rows[d.idx+1]}for(var f=d.idx;f<=e.idx;f++){var g=this.rows[f];g.pos[1]=Math.min(this.getFinalVerticalPos(g),g.pos[1]+c),g.pos[1]=Math.max(f>a.idx?this.getFinalVerticalPos(g,!1,a.idx):0,g.pos[1]),g.el&&(g.el.style("transform","translate("+g.pos[0]+"px,"+g.pos[1]+"px)"),g.el.style("-webkit-transform","translate("+g.pos[0]+"px,"+g.pos[1]+"px)"),this.events.pack_state(new sb.stateEvent(this)))}this.updateDims()},tb.prototype.setActiveDLComponent=function(a){this.active_dl_component!==a&&(this.active_dl_component=a,"none"!==this.active_dl_component&&(this.canvas_model?this.canvas_model.setActive(this):this.setActive(!0)),this.settings.get("visualized")&&(this.updateBGStyle(),this.updateHandleVisibilities()))},tb.prototype.setSubTypeActive=function(){this.settings.get("visualized")&&this.updateHandleVisibilities()},tb.prototype.clearTraceProperties=function(){(arguments.length<=0||void 0===arguments[0]||arguments[0])&&(this.mapping_nodes=[]),this.rows.forEach(function(a){return a.model.for_each(function(a){delete a.trace_origin,delete a.traced})})},tb.prototype.updateBGStyle=function(){if(this.settings.get("show_bg")){var a=["bg"];a.push("arrange"!==this.mode?"edit":"arrange"),this.dragging?a.push("dragging"):this.active&&"inspect"!==this.mode&&"AV"!==this.active_dl_component&&a.push("active"),a.push("style"),this.element_div.attr("visibility",null).style(this.settings.get(a.join("_")))}},tb.prototype.getVerticalAdvance=function(a){if(0===a.idx)return 0;var b=this.settings.get("v_align");return"center"===b?this.rows[a.idx-1].dims.height/2+a.dims.height/2:"top"===b?this.rows[a.idx-1].dims.height:"bottom"===b||"alphabetic"===b?a.dims.height:void 0},tb.prototype.layoutRows=function(){var a=arguments.length<=0||void 0===arguments[0]||arguments[0],b=this.rows[0].pos,c=b[0],d=b[1];this.rows[0].idx=0;for(var e=1;e<this.rows.length;e++){var f=this.rows[e];if(f.idx=e,this.rows[e-1].hidden||(d+=this.getVerticalAdvance(f)),!f.dragging){var g=f.pos;g[0]===c&&g[1]===d||(g[0]=c,g[1]=d,g=g,f.showBackground(),f.el&&f.el.transition().duration(a?this.settings.get("row_transition_dur"):0).style("transform","matrix(1,0,0,1,"+g[0]+","+g[1]+")").style("-webkit-transform","matrix(1,0,0,1,"+g[0]+","+g[1]+")").each("end",function(a){a.hideBackground()}))}}this.element_div.selectAll(".dl-line").sort(function(a,b){return a.idx-b.idx}),this.updateDims()},tb.prototype.updateContainerDimensions=function(){this.svgDims=this.getContainerDimensions()},tb.prototype.getContainerDimensions=function(){return this.canvas_model.size()},tb.prototype.render=function(){var a=arguments.length<=0||void 0===arguments[0]||arguments[0];this.setHandleProperties(),this.rows.forEach(function(a){a.cut||(a.view.render(!1),a.updateDims(),a.updateHandlePos(!0))}),this.updateDims(),this.layoutRows(a)},tb.prototype.undo=function(){if(!(this.rows.length<1)){var a=this.getLastRow();a.remove();for(var b=[],c=this.getLastRow();c.cut;)b.push(c),c.remove(),c=this.getLastRow();var d=nb().unlinkElement(a.model),e=[];b.forEach(function(a){e.push(nb().unlinkElement(a.model))});var f=this.getLastRow(),g=this.settings.get("collapsed_mode");return f&&(f.unhide(),f.view.interactive(!0),f.view.render()),this.updateDims(),this.singleLineMode(g),this.updateBGStyle(),this.updateHandleVisibilities(),this.events.undo({id:this.id,derivation:this}),{undone_row:0===b.length?a:[a].concat(b),removed_links:0===e.length?d:[d].concat(e)}}},tb.prototype.redo=function(a){var b=a.undone_row,c=a.removed_links;if(Array.isArray(b)){for(;b.length>1;)this.rows.push(b.pop());b=b[0]}var d=this.addRowFromModel(b.model,b.action);if(this.settings.get("visualized")&&this.canvas_model&&d.view.setMode(this.canvas_model.getActiveTool()),this.rows.length>1&&this.settings.get("collapsed_mode")&&this.rows[this.rows.length-2].hide(),c.length>0&&Array.isArray(c[0])){for(;c.length>1;)nb().addLinks(c.pop());c=c[0]}nb().addLinks(c),this.events.redo({id:this.id,derivation:this}),this.updateBGStyle(),this.updateHandleVisibilities(),this.layoutRows()},tb.prototype.removeElement=function(){return ve.prototype.removeElement.call(this),this.events.removed({type:"removed",performee:this}),nb().unlinkDL(this)},tb.prototype.forceIntoContainer=function(a){arguments.length,this.updateContainerDims();var b={x:Math.max(0,Math.min(this.container_size.width-this.size.width,this.pos.x)),y:Math.max(0,Math.min(this.container_size.height-this.size.height,this.pos.y))};b.x===this.pos[0]&&b.x===this.pos[1]||this.translateElement(b)},tb.prototype.getAllDLs=function(){return this.coordinator?this.coordinator.dls:this.canvas_model?this.canvas_model.dls():[this]},new md("Derivation").defaults.setAll(md.get("CanvasElement").defaults.getAll()).setAll({eq:"",font_size:50,padding:{left:20,right:5,top:5,bottom:5},v_align:"center",h_align:"equals",action_blacklist:[],dont_init_eq:!1,pos:{x:"center",y:"center"},debug_lines:!1,border_radius:0,row_padding:{left:10,right:45,top:7,bottom:3},edit_mode_drag_box_width:30,handle_size_factor:.44,handle_pos_offset_factor:.5,handle_pos:"right",handle_stroke_color:"#ddd",row_border_color:"#ddd",row_background_color:"white",collapsed_mode:!0,draggable:!0,no_history:!1,no_handles:!1,hide_handles:!1,wiggle:[],cloning_on:!0,auto_collapse_repeated_actions:!0,auto_simplify_distributions:!0,auto_simplify_vector_additions:!0,auto_simplify_variables:!0,modes:["edit","inspect","arrange"],send_events:!0,row_transition_dur:250,resizable:{x:!1,y:!1},graphics_caching:!1,svg_no_overflow:!1,svg_overflow_margin:500,trace_syms:!1,trace_color:"rgb(194, 219, 179)",trace_rect_radius:6,trace_active_border:"1px solid steelblue",trace_joint_width:16,trace_joint_length:8,trace_line_thickness:6,show_area_hints:!0,show_dest_hints:!0,show_action_names:!0,auto_trigger_actions:!1,scrub_precision:1,draw_term_traces_across_derivations:!0}),tb.ChangeEvent=function(a,b,c){this.type="change",this.performee=a,this.performee_type="DL",this.time=Date.now(),this.row=c,this.model=b},tb.dragEvent=function(a,b){this.type="Drag",this.performee=a,this.performee_type="DL",this.time=Date.now(),this.x=b.x,this.y=b.y},tb.touchEvent=function(a,b){this.type="Touch",this.performee=a,this.performee_type="DL",this.time=Date.now(),this.fingers=b.fingers.map(function(a){return{pos:[a.pos[0],a.pos[1]]}})},tb.releaseEvent=function(a,b){this.type="Release",this.performee=a,this.performee_type="DL",this.time=Date.now(),b.altKey&&(this.altKey=b.altKey),b.shiftKey&&(this.shiftKey=b.shiftKey),this.fingers=b.fingers.map(function(a){return{pos:[a.pos[0],a.pos[1]]}})},tb.holdEvent=function(a,b){this.type="Hold",this.performee=a,this.performee_type="DL",this.time=Date.now(),this.finger={pos:[b.finger.pos[0],b.finger.pos[1]]}},sb.touchEvent=function(a,b,c){this.type="Touch",this.performee=c,this.performee_type="row",this.row=b,this.time=Date.now(),this.fingers=a.fingers.map(function(a){return{pos:[a.pos[0],a.pos[1]]}})},sb.tapEvent=function(a,b,c){this.type="Tap",this.performee=c,this.performee_type="row",this.row=b,this.time=Date.now(),this.fingers=a.fingers.map(function(a){return{pos:[a.pos[0],a.pos[1]]}})},sb.dragEvent=function(a,b,c){this.type="Drag",this.performee=c,this.performee_type="row",this.row=b,this.time=Date.now(),this.x=a.x,this.dx=a.dx,this.y=a.y,this.dy=a.dy,this.finger={dx:a.finger.dx,dy:a.finger.dy,dist_x:a.finger.dist_x,dist_y:a.finger.dist_y},this.x_offset=Math.abs(a.finger.dist_x),this.y_offset=Math.abs(a.finger.dist_y),this.fingers=a.fingers.map(function(a){return{pos:[a.pos[0],a.pos[1]]}})},sb.releaseEvent=function(a,b,c){this.type="Dragend",this.performee=c,this.performee_type="row",this.row=b,this.time=Date.now(),this.fingers=a.fingers.map(function(a){return{pos:[a.pos[0],a.pos[1]]}})},sb.cloneEvent=function(a,b){this.type="Clone",this.performee=a,this.performee_type="row",this.eq=b.eq,this.pos=b.pos,this.dl_id=b.id},sb.stateEvent=function(a){this.type="packState",this.performee=a.id,this.performee_type="row",this.time=Date.now(),this.packState=a.rows.map(function(a){return!!a.hidden})},ub.norm_angle=function(a){return a%=2*Math.PI,a<-Math.PI?a+=2*Math.PI:a>Math.PI&&(a-=2*Math.PI),a},ub.prototype.rotate=function(a){return new ub(this.x*Math.cos(a)-this.y*Math.sin(a),this.y*Math.cos(a)+this.x*Math.sin(a))},ub.prototype.Rotate=function(a){return this.Set(this.x*Math.cos(a)-this.y*Math.sin(a),this.y*Math.cos(a)+this.x*Math.sin(a))},ub.prototype.Set=function(a,b){return 1==arguments.length?(this.x=a.x,this.y=a.y):(this.x=a,this.y=b),this},ub.prototype.dist=function(a){var b=this.x-a.x,c=this.y-a.y;return Math.sqrt(b*b+c*c)},ub.prototype.dist2=function(a){var b=this.x-a.x,c=this.y-a.y;return b*b+c*c},ub.len=function(a,b){return Math.sqrt(a*a+b*b)},ub.prototype.len=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},ub.prototype.len2=function(){return this.x*this.x+this.y*this.y},ub.prototype.add=function(a){return new ub(this.x+a.x,this.y+a.y)},ub.prototype.Add=function(a){return this.x+=a.x,this.y+=a.y,this},ub.prototype.sub=function(a){return new ub(this.x-a.x,this.y-a.y)},ub.prototype.Sub=function(a){return this.x-=a.x,this.y-=a.y,this},ub.prototype.mul=function(a){return this.x*a.x+this.y*a.y},ub.prototype.cross=function(a){return this.x*a.y-this.y*a.x},ub.prototype.equals=function(a,b){return Math.abs(this.x-a.x)<=b&&Math.abs(this.y-a.y)<=b},ub.prototype.normalize=function(){var a=1/this.len();return new ub(this.x*a,this.y*a)},ub.prototype.Normalize=function(){var a=1/this.len();return this.x*=a,this.y*=a,this},ub.prototype.get_perpendicular=function(){return new ub(-this.y,this.x)},ub.prototype.scale=function(a){return new ub(this.x*a,this.y*a)},ub.prototype.Scale=function(a){return this.x*=a,this.y*=a,this},ub.prototype.toString=function(){return"("+this.x+","+this.y+")"},ub.prototype.copy=function(){return new ub(this.x,this.y)},ub.EPS=1e-6,ub.get_closest_point_on_segment=function(a,b,c){var d=b.sub(a),e=d.len();if(e<ub.EPS)return a;var f=d.mul(c.sub(a))/e;return f<0?a:f>d.len()?b:a.add(d.scale(f/e))},ub.intersect_ray_with_segment=function(a,b,c,d,e,f){if(void 0===e)var e=new ub;if(void 0===f)var f=ub.EPS;var g=d.sub(c),h=b.cross(g);if(Math.abs(h)>ub.EPS){var i=c.sub(a).cross(b)/h;if(i<-f||i-1>f)return!1;var j=c.add(g.scale(i));e.x=j.x,e.y=j.y}else{if(b.len2()<ub.EPS||g.len2()<ub.EPS)return!1;var k=a.sub(c).mul(g)/g.mul(g);if(c.add(g.scale(k)).dist(a)>ub.EPS)return!1;k<-f?(e.x=c.x,e.y=c.y):k-1>f?(e.x=d.x,e.y=d.y):(e.x=a.x,e.y=a.y)}return e.sub(a).mul(b)>=0},ub.intersect_inner_ray_with_rect=function(a,b,c){var d,e=new ub(c.x,c.y),f=new ub(c.x+c.width,c.y),g=new ub(c.x,c.y+c.height),h=new ub(c.x+c.width,c.y+c.height),i=c.r,j=new ub;if(ub.intersect_ray_with_segment(a,b,e,g,j))d=new ub(0,1);else if(ub.intersect_ray_with_segment(a,b,f,h,j))d=new ub(0,-1);else if(ub.intersect_ray_with_segment(a,b,e,f,j))d=new ub(-1,0);else{if(!ub.intersect_ray_with_segment(a,b,g,h,j))return null;d=new ub(1,0)}if(0===i)return{point:j,tangent:d};var k;return j.x<e.x+i&&j.y<e.y+i?(k=new vb(e.x+i,e.y+i,i).intersect_with_ray(a,b),j=k[1]||k[0]||j,d=j.sub(new ub(e.x+i,e.y+i)).get_perpendicular().scale(-1).Normalize()):j.x>f.x-i&&j.y<f.y+i?(k=new vb(f.x-i,f.y+i,i).intersect_with_ray(a,b),j=k[1]||k[0]||j,d=j.sub(new ub(f.x-i,f.y+i)).get_perpendicular().scale(-1).Normalize()):j.x<g.x+i&&j.y>g.y-i?(k=new vb(g.x+i,g.y-i,i).intersect_with_ray(a,b),j=k[1]||k[0]||j,d=j.sub(new ub(g.x+i,g.y-i)).get_perpendicular().scale(-1).Normalize()):j.x>h.x-i&&j.y>h.y-i&&(k=new vb(h.x-i,h.y-i,i).intersect_with_ray(a,b),j=k[1]||k[0]||j,d=j.sub(new ub(h.x-i,h.y-i)).get_perpendicular().scale(-1).Normalize()),{point:j,tangent:d}},ub.prototype.is_inside_rect=function(a,b){return a.x<=this.x&&this.x<=b.x&&a.y>=this.y&&this.y>=b.y},ub.intersect_seg_with_rect=function(a,b,c,d){var e=new ub(c.x,c.y),f=new ub(d.x,c.y),g=new ub(c.x,d.y),h=new ub(d.x,d.y),i=[e,f,h,g];if(a.is_inside_rect(c,d)&&b.is_inside_rect(c,d))return!0;for(var j=0;j<i.length;j++){var k=j+1;if(k>i.length-1&&(k=0),ub.intersect_segments(a,b,i[j],i[k]))return!0}return!1},ub.intersect_segments=function(a,b,c,d){if(a.x==c.x&&a.y==c.y&&b.x==d.x&&b.y==d.y)return!0;if(a.x==d.x&&a.y==d.y&&b.x==c.x&&b.y==c.y)return!0;var e=((c.y-d.y)*(a.x-c.x)+(d.x-c.x)*(a.y-c.y))/((d.x-c.x)*(a.y-b.y)-(a.x-b.x)*(d.y-c.y)),f=((a.y-b.y)*(a.x-c.x)+(b.x-a.x)*(a.y-c.y))/((d.x-c.x)*(a.y-b.y)-(a.x-b.x)*(d.y-c.y));return e>=0&&e<=1&&f>=0&&f<=1},vb.prototype.copy=function(){return new vb(this.x,this.y,this.r)},vb.prototype.centroid=function(){return new ub(this.x,this.y)},vb.prototype.area=function(){return Math.PI*this.r*this.r},vb.prototype.move_to_origin=function(){this.x=0,this.y=0},vb.prototype.bounding_box=function(){return{x:this.x-this.r,y:this.y-this.r,width:2*this.r,height:2*this.r}},vb.prototype.intersect_with_ray=function(a,b){var c=a.sub(this),d=b.x*b.x+b.y*b.y,e=2*c.x*b.x+2*c.y*b.y,f=c.x*c.x+c.y*c.y-this.r*this.r,g=e*e-4*d*f;if(g<0)return[];if(g<ub.EPS){var h=-e/(2*d);return h<0?[]:[new ub(a).add(b.scale(h))]}var i=[],j=(-e-Math.sqrt(g))/(2*d),k=(-e+Math.sqrt(g))/(2*d);if(j>k){var l=j;j=k,k=l}return j>=0&&i.push(new ub(a).add(b.scale(j))),k>=0&&i.push(new ub(a).add(b.scale(k))),i},vb.fromSVGCircle=function(a){var b=a.attributes;return b.cx&&b.cy&&b.r?new vb(Number(b.cx.value),Number(b.cy.value),Number(b.r.value)):null},vb.fromSVGPath=function(a){"undefined"==typeof exclude_ellipse&&(exclude_ellipse=!0);var b,c,d,e,f=a.lookupNamespaceURI("sodipodi"),g=function(b){var c=a.getAttributeNS(f,b);return null!==c?c:a.getAttribute("sodipodi:"+b)};if("arc"==g("type")&&(b=g("cx"))&&(c=g("cy"))&&(d=g("rx"))&&(e=g("ry"))){var h=g("start"),i=g("end");if(h&&i){var j=Number(i)-Number(h);if(Math.abs(Math.abs(j)-2*Math.PI)>.01&&!(j<0&&j>-.01))return console.log("Warning: this is a circle segment! ||start-end|-2*PI| =",j),null}return d=Number(d),e=Number(e),b=Number(b),c=Number(c),Math.abs(d/e-1)>.05?(console.log("Warning: This is an ellipse! rx",d,"ry",e),null):new vb(b,c,(d+e)/2)}return null},vb.prototype.renderInSvg=function(a,b){var c=a.createElementNS("http://www.w3.org/2000/svg","circle");return c.setAttribute("cx",this.x),c.setAttribute("cy",this.y),c.setAttribute("r",this.r),c.style.setProperty("stroke","red"),c.style.setProperty("stroke-width",".5px"),c.style.setProperty("fill","none"),b.appendChild(c),c},vb.prototype.renderOnCanvas=function(a,b,c){a.beginPath(),a.arc(this.x,this.y,this.r,0,2*Math.PI,!0),b&&a.stroke(),c&&a.fill()},tb.drawTraces=function(a){var b=a[0].canvas_model.back_svg(),c=a[0].canvas_model.html_container();a.forEach(function(a){return a.clearTraceProperties(!1)}),tb.hideTermTraces(b,c);var d=[];a.forEach(function(a){var b=a.mapping_nodes.map(function(a){return a.is_leaf_node&&a.has_subscript()?a.get_base():a}).filter(function(a){return!a.is_group("sym")});0!==b.length&&b.forEach(function(b){b.traced=!0,b.trace_origin=!0,d=d.concat(a.get_forward_lines([b]).concat(a.get_backward_lines([b])))})});var e={color:a[0].settings.get("trace_color"),active_border:a[0].settings.get("trace_active_border"),joint_width:a[0].settings.get("trace_joint_width"),joint_length:a[0].settings.get("trace_joint_length"),line_thickness:a[0].settings.get("trace_line_thickness"),rect_radius:a[0].rows[0].view.settings.get("trace_rect_radius")};tb.drawTraceLines(b,d,e),tb.updateTraceBackgrounds(c,e)},tb.prototype.drawAllTraces=function(){tb.drawTraces(this.canvas_model.getElementsOfType("derivation"))},tb.prototype.hideAllTraces=function(){var a=this.canvas_model.back_svg(),b=this.canvas_model.html_container();tb.hideTermTraces(a,b)},tb.hideTermTraces=function(a,b){a.selectAll(".mapping_line").style("visibility","hidden"),b.selectAll(".bg-rect").style("visibility","hidden")},tb.drawTraceLines=function(a,b,c){var d=c.color,e=a.selectAll(".mapping_line").data(b);e.enter().insert("path",".math"),e.classed("mapping_line",!0).call(tb.updateOrganicPath.bind(null,c)).style("fill",d).style("stroke",d).style("visibility",function(a){return a.source_node&&a.target_node?a.source_node.hidden||a.target_node.hidden?"hidden":null:"hidden"}),e.exit().remove()},tb.updateTraceBackgrounds=function(a,b){a.selectAll(".bg-rect").style("border",function(a){return a.trace_origin?b.active_border:"none"}).style("visibility",function(a){return a.hidden||!a.traced?"hidden":null})},tb.updateOrganicPath=function(a,b){function c(a){return a.x.toFixed(4)+" "+a.y.toFixed(4)+" "}var d=a.rect_radius;b.attr("d",function(b){if(!b.target_node||!b.source_node)return"M 0,0";var e=b.source_row,f=b.target_row,g=e.pos[0]+e.dl.pos.x-e.dl.dims.x,h=e.pos[1]+e.dl.pos.y-e.dl.dims.y,i=f.pos[0]+f.dl.pos.x-f.dl.dims.x,j=f.pos[1]+f.dl.pos.y-f.dl.dims.y,k=b.source_node.sel_box,l=b.source_node,m=b.target_node.sel_box,n=b.target_node,o={x:k.x+l.x+g,y:k.y+l.y+h,width:k.width,height:k.height,r:d},p={x:m.x+n.x+i,y:m.y+n.y+j,width:m.width,height:m.height,r:d},q=tb.createConnectorPath(o,p,a),r=tb.createConnectorPath(p,o,a);return q&&r?"M "+c(q.base1)+"C "+c(q.base1_control)+c(q.joint1_control1)+c(q.joint1)+"L"+c(r.joint2)+"C "+c(r.joint2_control1)+c(r.base2_control)+c(r.base2)+"L "+c(r.base1)+"C "+c(r.base1_control)+c(r.joint1_control1)+c(r.joint1)+"L "+c(q.joint2)+"C "+c(q.joint2_control1)+c(q.base2_control)+c(q.base2)+"Z":"M 0 0"})},tb.createConnectorPath=function(a,b,c){var d=Math.min(c.joint_width,.9*a.width,.9*b.width,.9*a.height,.9*b.height),e=Math.min(d/2,c.line_thickness),f=c.joint_length,g=new ub(a.x+a.width/2,a.y+a.height/2),h=new ub(b.x+b.width/2,b.y+b.height/2),i=h.Sub(g),j=[],k=[];if(ud.overlaps(a,b))return null;var l=i.get_perpendicular();l.Normalize().Scale(d/2);var m=ub.intersect_inner_ray_with_rect(g.add(l),i,a);if(!m)return null;j.push(m.point);var n=m.point.add(m.tangent.scale(d/3));k.push({from:m.point,to:n});var o=ub.intersect_inner_ray_with_rect(g.sub(l),i,a);if(!o)return null;j.push(o.point);var p=o.point.add(o.tangent.scale(-d/3));k.push({from:o.point,to:p}),l.Normalize().Scale(e/2);var q=ub.intersect_inner_ray_with_rect(g.add(l),i,a);if(!q)return null;var r=q.point.add(i.normalize().Scale(f)),s=ub.intersect_inner_ray_with_rect(g.sub(l),i,a);if(!s)return null;var t=s.point.add(i.normalize().Scale(f));j.push(r,t);var u=r.sub(i.normalize().Scale(f/2)),v=r.sub(i.normalize().Scale(-f/2)),w=t.sub(i.normalize().Scale(f/2)),x=t.sub(i.normalize().Scale(-f/2));return k.push({from:r,to:u},{from:r,to:v},{from:t,to:w},{from:t,to:x}),{pts:j,lines:k,base1:m.point,base2:o.point,joint1:r,joint2:t,joint1_control1:u,joint1_control2:v,joint2_control1:w,joint2_control2:x,base1_control:n,base2_control:p}},tb.prototype.get_next_visible_row=function(a){for(var b=a.idx+1;b<this.rows.length;b++)if(!this.rows[b].hidden)return this.rows[b];return null},tb.prototype.get_prev_visible_row=function(a){for(var b=a.idx-1;b>=0;b--)if(!this.rows[b].hidden)return this.rows[b];return null},tb.prototype.get_forward_lines=function(a){var b=arguments.length<=1||void 0===arguments[1]?null:arguments[1],c=this,d=arguments.length<=2||void 0===arguments[2]?null:arguments[2],e=arguments.length<=3||void 0===arguments[3]?[]:arguments[3],f=a.filter(function(a){return!wb(a)});if(d||(d=f),0===f.length||0===d.length)return[];var g=d[0].get_root(),h=b||this.getRowByModel(g),i=nb().links.filter(function(a){return a.source===g&&(c.settings.get("draw_term_traces_across_derivations")||c.getRowByModel(a.target))}),j=this.settings.get("draw_term_traces_across_derivations")?this.canvas_model.getElementsOfType("derivation"):[this],k=[];return i.forEach(function(a){var b=j.find(function(b){return b.getRowByModel(a.target)}),g=b.getRowByModel(a.target),i=e.slice();i.push(a.action);var l=a.action.mapNodes(d);c.settings.get("trace_syms")||l.filter(function(a){return!a.is_group("sym")}),l=l.filter(function(a){return!wb(a)}),g.hidden?k=k.concat(b.get_forward_lines(f,h,l,i)):(k=k.concat(xb(i,f,h,g,!c.settings.get("trace_syms"))).concat(b.get_forward_lines(l,null,null,[])),l.forEach(function(a){return a.traced=!0}))},this),k},tb.prototype.get_backward_lines=function(a){var b=arguments.length<=1||void 0===arguments[1]?null:arguments[1],c=this,d=arguments.length<=2||void 0===arguments[2]?null:arguments[2],e=arguments.length<=3||void 0===arguments[3]?[]:arguments[3];if(d||(d=a),0===a.length||0===d.length)return[];var f=d[0].get_root(),g=this.getRowByModel(f),h=b||g,i=nb().links.filter(function(a){return a.target===f&&(c.settings.get("draw_term_traces_across_derivations")||c.getRowByModel(a.source))}),j=this.settings.get("draw_term_traces_across_derivations")?this.canvas_model.getElementsOfType("derivation"):[this],k=[];return i.forEach(function(b){var d=j.find(function(a){return a.getRowByModel(b.source)}),f=d.getRowByModel(b.source),g=e.slice();g.unshift(b.action);var i=1===g.length?g[0]:p.createComposedAction(g),l=[];f.model.children[0].for_each(function(b){if(!b.has_children()&&(this.settings.get("trace_syms")||!b.is_group("sym"))&&!wb(b)){var c=i.mapNodes([b]),d=!1;c.forEach(function(c){-1!==a.indexOf(c)&&(f.hidden||yb(k,{source_node:b,source_row:f,target_node:c,target_row:h}),d=!0)}),d&&l.push(b)}}.bind(c)),f.hidden?k=k.concat(d.get_backward_lines(a,h,l,g)):(k=d.get_backward_lines(l,null,null,[]).concat(k),l.forEach(function(a){return a.traced=!0}))},this),k},ad.ui=ad.ui||{},ad.ui.Multichoice=function(){var a=function(a,b,c,d){ve.call(this,a,b,c),this.type="multichoice",this.events=ad.extend(this.events,d3.dispatch("select")),this.logger=null,this.choice_els=null,this.selected={},this.initOptions(c),this.init()};return ad.inherit(ve,a),a.defaultOptions={choices:["A","B","C"],multichoice:!1,alignment:"horizontal",font_size:20,btn_radius:20,btn_margin:20,resizable:{x:!1,y:!1}},a.prototype.initOptions=function(b){var c=ad.deepCopy(a.defaultOptions),b=ad.object.extendExisting(c,b||{});this.options=ad.extend(this.options,b)},a.prototype.init=function(){var a=this;this.options.choices.forEach(function(b){a.selected[b]=!1});var b=this.options.btn_radius,c=this.options.btn_margin,d=0,e="vertical"==a.options.alignment,f=this.element_div.append("div").style("position","absolute").style("left","0px").style("top","0px");this.choice_els=f.selectAll(".choice").data(this.options.choices),this.choice_els.enter().append("div").classed("choice",!0).style("position","absolute").each(function(f,g){var h=d3.select(this),i=[(2*b+c)*g+b+c,b+c];e?i.reverse():i[1]+=c+a.options.font_size,h.style("left",i[0]+"px").style("top",i[1]+"px");var j=h.append("p").style("position","absolute").style("margin","0px").style("font-size",a.options.font_size+"px").style("text-align",e?"left":"center").style("white-space","nowrap").style("pointer-events","none").html(f);setTimeout(function(){var a=$(j.node()).innerWidth(),f=$(j.node()).innerHeight();j.style("left",(e?b+c:-a/2)+"px").style("top",(e?-b:-(b+c+f/1.2))+"px"),e&&(j.style("height",2*b+"px").style("line-height",2*b+"px"),a>d&&(d=a))},100);h.append("div").style("position","absolute").style("left",-b+"px").style("top",-b+"px").style("width",2*b+"px").style("height",2*b+"px").style("background-color","white").style("border","2px solid gainsboro").style("border-radius",(a.options.multichoice?0:50)+"%").on("click",function(){if(!a.options.multichoice){if(a.selected[f])return;a.choice_els.each(function(b){b!=f&&(d3.select(this).select(".selected").transition().duration(200).style("background-color","white"),a.selected[b]=!1)})}a.selected[f]=!a.selected[f],h.select(".selected").transition().duration(200).style("background-color",a.selected[f]?"#84bd43":"white"),a.events.select(f),a.logger&&a.logger.logCustomInteraction("choice",{choice:f,value:a.selected[f]})}),h.append("div").classed("selected",!0).style("position","absolute").style("left",4-b+"px").style("top",4-b+"px").style("width",2*b-8+"px").style("height",2*b-8+"px").style("background-color","white").style("border-radius",(a.options.multichoice?0:50)+"%").style("pointer-events","none")}),setTimeout(function(){var g=(2*b+c)*a.options.choices.length+c,h=2*b+3*c;e?(g+=h,h=g-h,g=g-h+d):h+=a.options.font_size,f.style("width",g+"px").style("height",h+"px"),a.resizeElement({width:g,height:h})},100)},a.prototype.setLogger=function(a){this.logger=a},a}(),ad.ui=ad.ui||{},ad.ui.GraphEq=function(){var a=function(a,b,c){ve.call(this,a,b,c),this.vals=ad.object.extendExisting({a:"A",b:"B",c:"C"},c.vals||{}),this.form=0,this.views=[],this.align=null,this.evts=null,this.trans={},this.gestures=[],this.dx=null,this.init()};return ad.inherit(ve,a),a.prototype.init=function(){var a=this,b=this.element_div.append("svg").style("position","absolute").style("left","0px").style("top","0px").style("overflow","visible"),c=b.node().getBoundingClientRect(),d=b.append("g"),e=this.vals.a+"x+"+this.vals.b+"y="+this.vals.c,f=new Id(e),g={h_align:"left",v_align:"top"};this.views.push(new te(f,d,g)),this.views[0].init(function(){var e="y=-{"+a.vals.a+"/"+a.vals.b+"}x+"+a.vals.c+"/"+a.vals.b,f=new Id(e);a.views.push(new te(f,d,g)),a.views[1].init(function(){function e(a){var b=ad.Tree.get_child([0,1],a.model),c=d3.select("#"+b.id);return d3.transform(c.attr("transform")).translate.slice()}function f(a,b){var c=ad.Tree.get_child(a,b.model);return d3.select("#"+c.id)}function g(a,b){function d(a){var b=a.select("rect").node(),d=b.getBoundingClientRect(),e={left:d.left-c.left,top:d.top-c.top,width:d.width,height:d.height};return e.right=e.left+e.width,e.bottom=e.top+e.height,{el:a,box:e,pos:d3.transform(a.attr("transform")).translate,sel:!1}}return[d(a),d(b)]}function h(b){var c=a.gestures[a.form].source[0],d=a.gestures[a.form].target[0],e=(b-c)/(d-c);return e<0&&(e=0),e>1&&(e=1),e}function i(a,b,c){var d=[b[0]+(c[0]-b[0])/2,b[1]+4*(c[1]-b[1])],e=[];b[1]==d[1]&&(d[1]-=100);for(var f=0;f<2;f++)e.push(Math.pow(1-a,2)*b[f]+2*(1-a)*a*d[f]+Math.pow(a,2)*c[f]);return e}function j(b){Object.keys(a.trans).forEach(function(c){if("y"!=c){var d=a.trans[c][a.form],e=a.trans[c][1-a.form],f=d.pos.slice(),g=e.pos.slice();g[0]+=0==a.form?a.align[0]:-a.align[0],g[1]+=0==a.form?a.align[1]:-a.align[1];var h=0==a.form?i(b,f,g):i(1-b,g,f),j=1+b*(e.box.width/d.box.width-1);d.el.attr("transform","translate("+h.join(",")+") scale("+j+")")}}),[[0,2,0,1,0,1,0],[0,2,0,1,0,1,1,1],[0,2,0,1,1,0],[0,2,1,0],[0,2,1,1,1]].forEach(function(c){var d=ad.Tree.get_child(c,a.views[1].model);d3.select("#"+d.id).style("opacity",0==a.form?b:1-b)});var c=ad.Tree.get_child([0,0,1,0],a.views[0].model);d3.select("#"+c.id).style("opacity",0==a.form?1-b:b)}var k=e(a.views[0]),l=e(a.views[1]);a.align=[k[0]-l[0],k[1]-l[1]],a.views[1].main.attr("transform","translate("+a.align.join(",")+")");var m=d.node().getBBox(),n=m.width+60,o=m.height;a.resizeElement({width:n,height:o}),b.attr("width",n+"px").attr("height",o+"px"),d.attr("transform","translate("+[-m.x,-m.y].join(",")+")"),a.evts=b.append("rect").attr("x",0).attr("y",0).attr("width",n).attr("height",o).attr("fill","none");var p=a.views[0],q=a.views[1],r=[[0,0,0,1,0,1],[0,2,0,1,0,1,1,0,1]];a.vals.a<0&&(a.trans.a_sign=g(f(r[0].concat(0),p),f(r[1].concat(0),q)),r.forEach(function(a){return a.push(1)})),a.trans.a=g(f(r[0],p),f(r[1],q)),a.trans.x=g(f([0,0,0,1,1,1],p),f([0,2,0,1,1,1],q));var s=[[0,0,1,1,0,1],[0,2,0,1,0,1,1,2,1],[0,2,1,1,2,1]];if(a.vals.b<0){var t=f(s[0].concat(0),p),u=d3.select(p.main.node().appendChild(t.node().cloneNode(!0)));u.attr("id",t.attr("id")+"_clone").select("text").style("opacity",1),a.trans.b1_sign=g(t,f(s[1].concat(0),q)),a.trans.b2_sign=g(u,f(s[2].concat(0),q)),s.forEach(function(a){return a.push(1)})}var v=f(s[0],p),w=d3.select(p.main.node().appendChild(v.node().cloneNode(!0)));w.attr("id",v.attr("id")+"_clone").select("text").style("opacity",1),a.trans.b1=g(v,f(s[1],q)),a.trans.b2=g(w,f(s[2],q)),a.trans.y=g(f([0,0,1,1,1,1],p),f([0,0],q));var x=[[0,2],[0,2,1,1,0,1]];a.vals.c<0&&(a.trans.c_sign=g(f(x[0].concat(0),p),f(x[1].concat(0),q)),x.forEach(function(a){return a.push(1)})),a.trans.c=g(f(x[0],p),f(x[1],q));var y=a.trans.a[0].box,z=a.trans.c[0].box;a.gestures.push({source:[y.left+y.width,y.top+y.height/2],target:[z.left+z.width,z.top+z.height/2]});var A=a.trans.x[1].box,B=a.trans.y[1].box;a.gestures.push({source:[A.left,A.top+A.height/2],target:[B.left,B.top+B.height/2]}),a.views[1].main.selectAll(".math").style("opacity",0);var C=ad.mtouch_events().frame(a.evts.node()).on("touch",function(){d3.event.fingers.forEach(function(b){var c=b.pos[0],d=b.pos[1],e=b.id;["a","x","b1","b2","y"].forEach(function(b){var f=a.trans[b][a.form],g=f.box;c>g.left&&c<g.right&&d>g.top&&d<g.bottom&&(f.sel=e)})})}).on("drag",function(){d3.event.fingers.forEach(function(b){var c=b.id,d=[];if(d=0==a.form?[a.trans.a[0].sel,a.trans.x[0].sel]:[a.trans.a[1].sel,a.trans.b1[1].sel,a.trans.x[1].sel],d.indexOf(c)>-1){a.dx||(a.dx=a.gestures[a.form].source[0]),a.dx+=b.dx;j(h(a.dx))}})}).on("release",function(){if(a.dx){var b=d3.event.finger,c=b.id;a.dx+=b.dx;var d=h(a.dx);["a","x","b1","b2","y"].forEach(function(b){var e=a.trans[b][a.form];if(e.sel==c){var f=setInterval(function(){d>.5?d+=.01:d-=.01,d>1&&(d=1,clearInterval(f),a.dx=null),d<0&&(d=0,clearInterval(f),a.dx=null),j(d),1==d&&(a.form=1-a.form,a.views[0].main.selectAll(".math").style("opacity",0==a.form?1:0),a.views[1].main.selectAll(".math").style("opacity",0==a.form?0:1),Object.keys(a.trans).forEach(function(b){var c=a.trans[b][1-a.form],d=c.pos.slice();c.el.attr("transform","translate("+d.join(",")+") scale(1)")}))},2);e.sel=!1}})}});a.evts.call(C)})})},a}(),xe=function(){function a(b){id(this,a),this.id=bd(),this.gauth=b,this.events=d3.dispatch("statusChange","APIReady"),this.is_ready=!1,this.init()}return jd(a,[{key:"init",value:function(){var a=this;this.gauth.is_ready?window.gapi.client.load("classroom","v1",function(){console.log("classroom api loaded"),a.is_ready=!0,a.events.APIReady()}):this.gauth.events.on("APIReady."+this.id,this.init.bind(this))}},{key:"signInAsStudent",value:function(){return this.gauth.signIn({scope:a.studentScope,prompt:"select_account"})}},{key:"signInAsTeacher",value:function(){return this.gauth.signIn({scope:a.teacherScope,prompt:"select_account"})}},{key:"isSignedIn",value:function(){return this.gauth.isSignedIn()}},{key:"getName",value:function(){return this.gauth.getName()}},{key:"query",value:function(a){var b=arguments.length<=1||void 0===arguments[1]?null:arguments[1];return console.log("querying",a,"with key",b),new Promise(function(c,d){window.gapi.client&&window.gapi.client.classroom?a(window.gapi.client.classroom).then(function(a){200===a.status&&(console.log("got result",a),a.statusText?d(a.statusText):!a.result||b&&!a.result[b]?d("No result."):c(b?a.result[b]:a.result))},d):d("API not ready.")})}},{key:"getCourseList",value:function(){return this.query(function(a){return a.courses.list({pageSize:100})},"courses")}},{key:"createCourseWork",value:function(a){var b=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],c=dd({workType:"ASSIGNMENT",state:"PUBLISHED"},b);return console.log(c),this.query(function(b){return b.courses.courseWork.create({courseId:a},c)})}},{key:"deleteCourseWork",value:function(a,b){return this.query(function(c){return c.courses.courseWork.delete({courseId:a,id:b})})}},{key:"listStudentSubmissions",value:function(a,b){var c=arguments.length<=2||void 0===arguments[2]?null:arguments[2];return this.query(function(d){return d.courses.courseWork.studentSubmissions.list({courseId:a,courseWorkId:b,userId:c})},"studentSubmissions")}},{key:"getStudentSubmission",value:function(a,b,c){return this.query(function(d){return d.courses.courseWork.studentSubmissions.get({courseId:a,courseWorkId:b,id:c})})}},{key:"addAttachment",value:function(a,b,c,d){return this.query(function(e){return e.courses.courseWork.studentSubmissions.modifyAttachments({courseId:a,courseWorkId:b,id:c,resource:{addAttachments:[d]}})})}},{key:"turnInSubmission",value:function(a,b,c){return this.query(function(d){return d.courses.courseWork.studentSubmissions.turnIn({courseId:a,courseWorkId:b,id:c})})}},{key:"reclaimSubmission",value:function(a,b,c){return this.query(function(d){return d.courses.courseWork.studentSubmissions.reclaim({courseId:a,courseWorkId:b,id:c})})}},{key:"constructCanvasMaterialLink",value:function(a,b){var c={url:a};return b&&(c.title=b),{link:c}}}]),a}(),xe.teacherScope="profile email https://www.googleapis.com/auth/classroom.courses.readonly https://www.googleapis.com/auth/classroom.coursework.students",xe.studentScope="profile email https://www.googleapis.com/auth/classroom.courses.readonly https://www.googleapis.com/auth/classroom.coursework.me",ye=function(){function a(){var b=arguments.length<=0||void 0===arguments[0]?"81925747312-vao5h4l5bf2c8cbfssff1bejaut2at9n.apps.googleusercontent.com":arguments[0];id(this,a),this.auth2=null,this.client_id=b,this.events=d3.dispatch("statusChange","APIReady"),this.is_ready=!1,"undefined"!=typeof gapi&&this.onGAPILoad()}return jd(a,[{key:"onGAPILoad",value:function(){var a=this;gapi.load("client:auth2",function(){console.log("google client and auth2 loaded"),a.initAuth(function(){console.log("google auth2 initialized"),a.is_ready=!0,a.events.APIReady(),a.auth2.currentUser.listen(a.events.statusChange)})})}},{key:"initAuth",value:function(a){var b=this;this.auth2=gapi.auth2.getAuthInstance(),null===this.auth2?gapi.auth2.init({client_id:this.client_id}).then(function(){b.auth2=gapi.auth2.getAuthInstance(),"function"==typeof a&&a(b.auth2)}):"function"==typeof a&&a(this.auth2)}},{key:"signIn",value:function(){var a=arguments.length<=0||void 0===arguments[0]?{prompt:"select_account"}:arguments[0];return this.auth2&&this.auth2.signIn(a)}},{key:"signOut",value:function(){return this.auth2&&this.auth2.signOut()}},{key:"getProfile",value:function(){return this.auth2&&this.auth2.currentUser.get().getBasicProfile()}},{key:"getName",value:function(){return this.auth2&&this.auth2.currentUser.get().getBasicProfile()&&this.auth2.currentUser.get().getBasicProfile().getName()}},{key:"getIdToken",value:function(){return this.auth2&&this.auth2.currentUser.get().getAuthResponse().id_token}},{key:"isSignedIn",value:function(){return this.auth2&&this.auth2.isSignedIn.get()}}]),a}(),ze={is_loading:!1,loaded:!1,delay_loading:!0,ready_callbacks:[],loadYTScript:function(a){if(ze.loaded)return void(a&&a());a&&ze.ready_callbacks.push(a),this.delay_loading||loadNow()},loadNow:function(){if(!ze.is_loading){ze.is_loading=!0,window.onYouTubeIframeAPIReady=function(){console.log("YT api loaded"),ze.loaded=!0,ze.is_loading=!1,ze.ready_callbacks.forEach(function(a){return a()}),ze.ready_callbacks=[]};var a=document.createElement("script");a.src="https://www.youtube.com/iframe_api";var b=document.getElementsByTagName("script")[0];b.parentNode.insertBefore(a,b)}},allowLoading:function(){this.delay_loading=!1,this.ready_callbacks.length>0&&this.loadNow()}},a("googleAuth",Ae=new ye),a("gcAuth",Be=new xe(Ae)),Be.is_ready?ze.allowLoading():Be.events.on("APIReady.aaoi6eq4=darst30d",function(){return ze.allowLoading()}),Ce=function(){function a(){var b=this;id(this,a),this.id=null,this.user_id=null,this.server="https://graspablemath.com",this.display_name="",this.email="",this.auth_token=null,this.logged_in=!1,this.readSettingsFromBrowserStorage(),this.events=d3.dispatch("login","logout"),this.auth_token&&setTimeout(function(){return b.fetchUserInfo()},0)}return jd(a,[{key:"logout",value:function(){this.logged_in=!1,this.auth_token=null,this.id=null,this.user_id=null,window.localStorage&&window.localStorage.setItem("gm-auth-token",null),this.events.logout({type:"logout",user:this})}},{key:"login",value:function(a){console.log("User.login called with",a),this.logged_in=!0,a&&(this.id=a.id,this.user_id=a.user_id,this.display_name=a.display_name,this.email=a.email,this.auth_token=a.auth_token||this.auth_token),console.log(this.display_name),this.updateSettings(a.settings),this.saveSettings(!0),this.events.login({type:"login",user:this})}},{key:"loginWithGoogle",value:function(a,b){var c=this;return console.log("called loginWithGoogle"),Ae.signIn(a).then(function(){return c.authorizeWithGoogleIdToken(Ae.getIdToken())}).then(function(a){"function"==typeof b&&b(null,a)}).catch(function(a){"function"==typeof b&&b(a)})}},{key:"silentLoginWithGoogle",value:function(a){Ae.isSignedIn()?this.authorizeWithGoogleIdToken(Ae.getIdToken()).then(function(b){"function"==typeof a&&a(null,b)},function(b){"function"==typeof a&&a(b)}):"function"==typeof a&&a("Not logged in with Google account.")}},{key:"authorizeWithGoogleIdToken",value:function(a){var b=this;return console.log("called authorizeWithGoogleIdToken"),new Promise(function(c,d){zb(b.server+"/auth/google/id-token?access_token="+a).contentType("application/json").parseResult(!0).run().then(function(a){console.log("resp:",a),b.login(a),c()},function(a){return console.log("failed",a)})})}},{key:"fetchUserInfo",value:function(){var a=this;return console.log("called authorizeWithGoogleIdToken"),new Promise(function(b,c){zb(a.server+"/api/user").contentType("application/json").parseResult(!0).run().then(function(c){console.log("resp:",c),a.login(c),b()},function(a){return console.log("failed",a)})})}},{key:"getSettingsOfType",value:function(a){return md.get(a)&&md.get(a).user}},{key:"getAllSettings",value:function(){var a=md.getAll();for(var b in a)a[b]=a[b].user;return a}},{key:"updateSettings",value:function(a){if(a){var b=this.getAllSettings();for(var c in b)c in a&&b[c].setAll(a[c])}}},{key:"readSettingsFromBrowserStorage",value:function(){if("undefined"!=typeof localStorage&&(this.auth_token=localStorage.getItem("gm-auth-token")||this.auth_token,localStorage.getItem("gm-settings")))try{var a=JSON.parse(localStorage.getItem("gm-settings"));this.updateSettings(a)}catch(a){console.warn("Error reading the local gm-settings ",localStorage.getItem("gm-settings"))}}},{key:"writeSettingsToBrowserStorage",value:function(a){"undefined"!=typeof localStorage&&(localStorage.setItem("gm-auth-token",this.auth_token),localStorage.setItem("gm-settings",JSON.stringify(a)))}},{key:"saveSettings",value:function(){var a=!(arguments.length<=0||void 0===arguments[0])&&arguments[0],b=md.userSettingsToJSON();this.writeSettingsToBrowserStorage(b),a||this.writeSettingsToServer(b)}},{key:"writeSettingsToServer",value:function(a){var b=arguments.length<=1||void 0===arguments[1]?null:arguments[1],c=this.server+"/api/user/settings";d3.xhr(c).header("Content-Type","application/json").post(JSON.stringify({settings:a}),function(a,c){b&&b(a,c)})}}]),a}(),a("user",De=new Ce),ad.CanvasEventRecorder=Ab,Ab.prototype.startRecording=function(){this.event_log.initial_event_count=this.event_log.events.length,this.setupListeners()},Ab.prototype.adjustTimeOfNextEvent=function(a){this.ajust_time_of_next_event=a},Ab.prototype.createAndRecordCanvas=function(a,b){if(arguments.length<2)throw"(CanvasEventRecorder) Please provide instantiation arguments for the canvas.";this.container=a,this.canvas=new ad.Canvas(a,b),ad.extend(this.event_log,{version:ad.version,options:b,events:[],ccontrollerID:this.canvas.controller.id}),this.startRecording()},Ab.prototype.setUserOptions=function(a,b){this.event_log||(this.event_log={}),this.event_log.userOptions||(this.event_log.userOptions={}),this.event_log.userOptions[a]=b},Ab.prototype.extendClassesWithUserOptions=function(){var a=this.event_log.userOptions;if(a)for(key in a)ad.extend(ad[key].defaultOptions,a[key])},Ab.prototype.initProgressBar=function(){return this.canvas.container.style("position","relative"),this.canvas.container.append("div").style({position:"absolute",bottom:0,width:"0%",background:"steelblue",height:"5px",opacity:.5})},Ab.prototype.replay=function(a,b){var c=this,d=this;if(this.canvas||this.init(),this.event_log.events.length>0){var e,f,g,h,i;!function(){var j=function(){g=f[h].time,d3.timer(k,a||0)},k=function(a){for(e.style("width",Math.min(100,(a+d.time_skip)/i*100).toFixed(4)+"%");d.ignore_custom_events_during_playback&&"custom-event"===f[h].type||f[h].time-g<a+d.time_skip;)if((h=d.evaluateEvent(f,h))===f.length)return d.canvas.controller.disableKeyboard(!1),b&&b(),e.transition().remove(),!0};e=c.initProgressBar(),c.canvas.controller.disableKeyboard(!0),f=c.event_log.events,g=f[0].time,h=0,c.time_skip=0,i=f[f.length-1].time-g,setTimeout(j,10)}()}else this.canvas.controller.disableKeyboard(!1),b&&b()},Ab.prototype.init=function(){this.canvas&&(this.canvas.tools.remove(),this.canvas.svg.remove(),this.canvas=null),this.canvas=new ad.Canvas(this.container,this.event_log.options),this.extendClassesWithUserOptions(),this.canvas.controller.id=this.event_log.ccontrollerID,this.event_log.initial_event_count=this.event_log.events.length},Ab.prototype.addEvent=function(a){if(this.ajust_time_of_next_event){this.ajust_time_of_next_event=!1;var b=this.event_log.events[this.event_log.events.length-1];this.event_dt=b?-a.time+b.time:-a.time}a.time+=this.event_dt,a.selection&&delete a.selection,a.target&&delete a.target,this.event_log.events.push(a)},Ab.prototype.evaluateEvent=function(a,b){return"custom-event"===a[b].type?++b:this.eventIsAnInteraction(a[b])?this.performInteraction(a,b):"create"===a[b].type||"remove"===a[b].type||"graphElementCreate"===a[b].type||"graphElementRemove"===a[b].type?this.performCheckpoint(a,b):++b},Ab.prototype.eventIsAnInteraction=function(a){return a.performee},Ab.prototype.performInteraction=function(a,b){return this.getPerformeeFn(a[b].performee_type)(a,b)},Ab.prototype.getPerformeeFn=function(a){if("Toolbar"===a)return this.simulateInteractionOnToolbar.bind(this);if("CanvasController"===a)return this.simulateInteractionOnCanvasController.bind(this);if("CanvasModelView"===a)return this.simulateModeSwitch.bind(this);if("DL"===a||"row"===a)return this.simulateInteractionOnDL.bind(this);if("graph"===a)return this.simulateInteractionOnGraph.bind(this);if("AM"===a)return this.simulateInteractionOnAlgebraModel.bind(this);throw"(CanvasEventRecorder) Performee type of event does not match recognized object type."},Ab.prototype.simulateInteractionOnToolbar=function(a,b){return this.canvas.onButton(a[b].button),++b},Ab.prototype.simulateInteractionOnCanvasController=function(a,b){var c=a[b];if("keyboard"===c.type){for(var d=b,e=a[d];d<a.length&&"enteredTerm"!==e.type;)d++,e=a[d];d!==a.length&&(this.time_skip+=e.time-c.time)}else if("enteredTerm"===c.type)this.canvas.model.createDL(ad.deepCopy(c.options));else if("enteredGraph"===c.type);else if("fontSize"===c.type)this.canvas.controller.set_font_size(c.font_size);else{var f=this.getObjectByID(c.performee);f[c.subtype+"_"+c.type](c)}return++b},Ab.prototype.simulateInteractionOnDL=function(a,b){var c=a[b],d=this.getObjectByID(c.performee);return"Clone"!==c.type&&"packState"!==c.type&&("row"===c.performee_type?d.rows[c.row][""+c.type.toLowerCase()](c):d[""+c.type.toLowerCase()](c)),++b},Ab.prototype.simulateInteractionOnGraph=function(a,b){var c=a[b],d=this.getObjectByID(c.performee);if("zoom"===c.type)d.replayZoom(c);else if("moveTouch"===c.type)d.deleteMove();else if("resize"===c.type)"touch"===c.resize_type?d.resize_touch(c):"drag"===c.resize_type?d.resize(c):"release"===c.resize_type&&d.resize_release(c);else if("mouseLocation"===c.type)"in-main"===c.location?d.showMove():"out-main"===c.location?d.hideMove():d.withinGrid(c);else if("linkStart"===c.type||"linkDrag"===c.type||"linkEnd"===c.type){var e=d.getGeomByID(c.object);"linkStart"===c.type?e.startLinking(c):"linkDrag"===c.type?e.linking(c):"linkEnd"===c.type&&e.endLinking(c)}else d[""+c.type](c);return++b},Ab.prototype.simulateInteractionOnAlgebraModel=function(a,b){var c=a[b];return this.getObjectByID(c.performee).rows[c.row].view.interaction_handler["on_"+c.type](c),++b},Ab.prototype.simulateModeSwitch=function(a,b){var c=a[b];return this.getObjectByID(c.performee).switchMode(),++b},Ab.prototype.performCheckpoint=function(a,b){return this.getCheckpointFn(a[b].type)(a,b)},Ab.prototype.getCheckpointFn=function(a){if("create"===a)return this.checkCreation.bind(this);if("action"===a)return this.checkAction.bind(this);if("undone"===a)return this.checkUndo.bind(this);if("redone"===a)return this.checkRedo.bind(this);if("newPosition"===a)return this.checkPosition.bind(this);if("packState"===a)return this.checkPacking.bind(this);if("remove"===a)return this.checkDeletion.bind(this);if("graphElementCreate"===a||"graphElementRemove"===a)return this.checkGraphContents.bind(this);if("graphElementChange"===a)return this.checkGraphElementAttributes.bind(this);if("mode"===a)return this.checkMode.bind(this);throw"(CanvasEventRecorder) That checkpoint is not recognized."},Ab.prototype.checkCreation=function(a,b){var c=a[b],d=this.canvas.model.getElementsOfType(c.object_type);if(!d)throw"(CanvasEventRecorder) Unknown object type";var e=d.filter(function(a){return!a.is_accounted_for});if(1!==e.length)throw"(CanvasEventRecorder) Could not identify new object to set ID";return e[0].is_accounted_for=!0,e[0].id=c.object_id,"link"===a[b].object_type&&this.checkExistenceOfLinkedObjects(e[0]),++b},Ab.prototype.originOfDL=function(a,b){return!("enteredTerm"!==a.type||!a.dl_id||a.dl_id!==b.id)||!("Clone"!==a.type||!a.dl_id||a.dl_id!==b.id)},Ab.prototype.getUnidentifiedGraph=function(){var a=this.canvas.model.getElementsOfType("graph");return a[a.length-1]},Ab.prototype.checkExistenceOfLinkedObjects=function(a){this.getObjectByID(a.a().id),this.getObjectByID(a.b().id)},Ab.prototype.checkAction=function(a,b){var c=a[b],d=this.getObjectByID(c.dl_id);return setTimeout(function(){var a=d.getLastRow();if(a.model.to_ascii()!==c.newTree||a.action.name!==c.action&&"(DL) row added from model (only redo)"!==c.action)throw"FF to next keyframe."},c.delay?c.delay:0),++b},Ab.prototype.checkUndo=function(a,b){var c=a[b];if("create_dl"===c.actionType)return this.checkDeletion(a,b);if("math"===c.actionType){var d=this.getObjectByID(c.id);if(d.rows.length!==c.numberOfRows||d.getLastModel().to_ascii()!==c.lastExpression)throw"FF to next keyframe."}return++b},Ab.prototype.checkRedo=function(a,b){var c=a[b];if("create_dl"===c.actionType)try{this.getObjectByID(c.id)}catch(a){throw"(CanvasEventRecorder) Object on the canvas with that id was not found"===a?"FF to next keyframe.":a}else if("math"===c.actionType){var d=this.getObjectByID(c.id);if(d.rows.length!==c.numberOfRows||d.getLastModel().to_ascii()!==c.lastExpression)throw"FF to next keyframe."}return++b},Ab.prototype.checkPosition=function(a,b){var c=a[b],d=this.getObjectByID(c.id);if("DL"===c.object_type){if(d.pos[0]!==c.pos[0]||d.pos[1]!==c.pos[1])throw"FF to next keyframe."}else if("graph"===c.object_type){if(d.pos.x!==c.pos.x||d.pos.y!==c.pos.y)throw"FF to next keyframe.";if(d.size.width!==c.size.width||d.size.height!==c.size.height)throw"FF to next keyframe."}return++b},Ab.prototype.checkPacking=function(a,b){var c=a[b],d=this.getObjectByID(c.id);if(c.packState.length!==d.rows.length)throw"FF to next keyframe.";for(var e=0;e<d.rows.length;e++)if(d.rows[e].hidden!==c.packState)throw"FF to next keyframe.";return++b},Ab.prototype.checkDeletion=function(a,b){var c=a[b];try{this.getObjectByID(c.id)}catch(f){if("(CanvasEventRecorder) Object on the canvas with that id was not found"===f){if("dl"===c.object_type||"graph"===c.object_type){for(var d=b+1,e=a[d];e&&e.performee&&e.performee===c.object_id||e&&e.object_id&&e.object_id===c.object_id;)e=a[++d];return d}return++b}throw f}throw"FF to next keyframe."},Ab.prototype.checkGraphContents=function(a,b){var c=a[b],d=this.getObjectByID(c.graph_id);if("graphElementCreate"===c.type)return d.geoms[d.geoms.length-1].id=c.object_id,++b;if("graphElementRemove"===c.type){for(var e=0;e<d.geoms.length;e++)if(d.geoms[e].id===c.object_id)throw"FF to next keyframe.";return++b}},Ab.prototype.checkGraphElementAttributes=function(a,b){for(var c,d=a[b],e=this.getObjectByID(d.graph_id),f=d.object_id,g=0;g<e.geoms.length;g++){var h=e.geoms[g];h.id===f&&(c=h)}if("point"===c.type){if(c.pos.x!==d.point_a.x||c.pos.y!==d.point_a.y)throw"FF to next keyframe."}else if("point-slope"===c.type){if(c.point.pos.x!==d.point_a.x||c.point.pos.y!==d.point_a.y||c.slope!==d.slope)throw"FF to next keyframe."}else if("point-point"===c.type){if(c.point_a.pos.x!==d.point_a.x||c.point_a.pos.y!==d.point_a.y||c.point_b.pos.x!==d.point_b.x||c.point_b.pos.y!==d.point_b.y)throw"FF to next keyframe."}else if("slope-intercept"===c.type&&(c.intercept.pos.x!==d.point_a.x||c.intercept.pos.y!==d.point_a.y||c.slope!==d.slope))throw"FF to next keyframe.";return++b},Ab.prototype.checkMode=function(a,b){var c=a[b];if(this.canvas.model.mode()!==c.mode)throw"FF to next keyframe.";return++b},Ab.prototype.getObjectByID=function(a){var b=this.canvas.model,c=b.dls().concat(b.getElementsOfType("graph")).concat(b.links());c.push(this.canvas.controller);for(var d=0;d<c.length;d++)if(c[d].id===a)return c[d];throw"(CanvasEventRecorder) Object on the canvas with that id was not found"},Ab.prototype.getRowIDXByInteractionHandlerID=function(a,b){for(var c=0;c<a.rows.length;c++)if(a.rows[c].view.interaction_handler.uid===b)return c;throw"(CanvasEventRecorder) Interaction-handler with that ID not found in derivation list."},Ab.prototype.setupListeners=function(){this.registerToolbarListeners(this.canvasToolbarListener.bind(this)),this.registerCanvasModelListeners(this.canvasModelViewListener.bind(this)),this.registerCanvasControllerListeners(this.canvasControllerListener.bind(this)),self=this,this.canvas.model.dls().forEach(function(a){self.setupListenersOnDL(a)}),this.canvas.model.getElementsOfType("graph").forEach(function(a){self.setupListenersOnGraph(a)}),this.canvas.model.links().forEach(function(a){self.setupListenersOnLink(a)})},Ab.prototype.canvasToolbarListener=function(a){a=ad.extend(a,{type:"button",performee:this.canvas.id,performee_type:"Toolbar"}),this.addEvent(a)},Ab.prototype.canvasModelViewListener=function(a){"mode"===a.type?this.modeChangeDetected(a):"create"===a.type?this.objectCreationDetected(a):"remove"===a.type&&this.objectDeletionDetected(a)},Ab.prototype.canvasControllerListener=function(a){"undone"===a.type||"redone"===a.type?this.undoRedoDetected(a):this.addEvent(a)},Ab.prototype.registerToolbarListeners=function(a){this.canvas.events.on("button."+this.id,a)},Ab.prototype.registerCanvasModelListeners=function(a){this.canvas.model.on("create."+this.id,a).on("remove."+this.id,a).on("active_tool."+this.id,a)},Ab.prototype.registerCanvasControllerListeners=function(a){this.canvas.controller.on("undone."+this.id,a).on("redone."+this.id,a).on("hold."+this.id,a).on("touch."+this.id,a).on("drag."+this.id,a).on("release."+this.id,a).on("font_size."+this.id,a).on("keyboard."+this.id,a).on("entered_term."+this.id,a)},Ab.prototype.modeChangeDetected=function(a){var b={};b.type="mode",b.mode=a.mode,b.time=Date.now(),this.addEvent(b)},Ab.prototype.objectCreationDetected=function(a){if("dl"===a.target_type||"graph"===a.target_type||"link"===a.target_type){"dl"===a.target_type?this.setupListenersOnDL(a.target):"graph"===a.target_type?this.setupListenersOnGraph(a.target):"link"===a.target_type&&this.setupListenersOnLink(a.target),console.log(a);var b={};b.type="create",b.time=Date.now(),b.object_id=a.target.id,b.object_type=a.target_type,"dl"!==a.target_type&&"graph"!==a.target_type||(b.object_options=ad.deepCopy(a.target.options)),this.addEvent(b)}},Ab.prototype.objectDeletionDetected=function(a){var b={};b.type="remove",b.time=Date.now(),b.object_id=a.target.id,b.object_type=a.target_type,this.addEvent(b)},Ab.prototype.undoRedoDetected=function(a){var b={};b.type=a.type,b.time=Date.now(),"create_dl"===a.action.type?(b.actionType=a.action.type,b.object_id=a.action.dl.id):"math"===a.action.type&&(b.actionType=a.action.type,b.object_id=a.action.dl.id,b.lastExpression=a.action.dl.getLastModel().to_ascii(),b.numberOfRows=a.action.dl.rows.length),this.addEvent(b)},Ab.prototype.setupListenersOnDL=function(a){var b=this.DLTransformListener.bind(this);this.registerListenersOnDLTransformEvents(a,b);var c=this.DLRowListener.bind(this);this.registerListenersOnDLRowEvents(a,c),this.setupListenersOnInteractionHandlers(a)},Ab.prototype.DLTransformListener=function(a){this.addEvent(a)},Ab.prototype.DLRowListener=function(a){if("packState"===a.type){var b={};b.type=a.type,b.time=a.time,b.object_id=a.performee,b.object_type="row",b.packState=a.packState,this.addEvent(b)}else this.addEvent(a)},Ab.prototype.registerListenersOnDLTransformEvents=function(a,b){a.dl_events.on("drag",b).on("touch",b).on("release",b).on("hold",b)},Ab.prototype.registerListenersOnDLRowEvents=function(a,b){a.row_events.on("drag",b).on("touch",b).on("tap",b).on("release",b).on("clone",b).on("pack_state",b)},Ab.prototype.setupListenersOnInteractionHandlers=function(a){for(var b=this,c=function(c){c=ad.extend(c,{performee_type:"AM",performee:a.id,row:b.getRowIDXByInteractionHandlerID(a,c.performee)}),b.addEvent(c)},d=0;d<a.rows.length;d++)this.registerListenersOnInteractionHandler(a.rows[d].view,c);a.events.on("added_line",function(d){if(1!==a.rows.length){b.logAction(d);var e=a.rows[a.rows.length-2].view;b.registerListenersOnInteractionHandler(e,c);var f=a.getLastView();b.registerListenersOnInteractionHandler(f,c)}})},Ab.prototype.registerListenersOnInteractionHandler=function(a,b){a.interaction_handler.events.on("touch",b).on("release",b).on("drag_start",b).on("drag",b).on("drag_end",b).on("tap",b).on("keydown",b).on("keyup",b)},Ab.prototype.setupListenersOnGraph=function(a){var b=this.graphListener.bind(this);this.registerListenersOnGraph(a,b)},Ab.prototype.graphListener=function(a){if("graphElementCreate"===a.type||"graphElementRemove"===a.type){var b={};b.type=a.type,b.time=a.time,b.object_id=a.performee,b.object_type=a.performee_type,b.graph_id=a.graph_id,a=b}else if("graphElementChange"===a.type){var b={};b.type=a.type,b.time=a.time,b.object_id=a.performee,b.graph_id=a.graph_id;var c,d,e,f=a.performee_object;"point"===f.type&&f.line&&(f=f.line,b.id=f.id),"point"===f.type?c=ad.deepCopy(f.pos):"point-slope"===f.type?(c=ad.deepCopy(f.point.pos),e=f.slope):"point-point"===f.type?(c=ad.deepCopy(f.point_a.pos),d=ad.deepCopy(f.point_b.pos)):"slope-intercept"===f.type&&(c=ad.deepCopy(f.intercept.pos),e=f.slope),b.point_a=c,b.point_b=d,b.slope=e,a=b}else if("linkStart"===a.type||"linkDrag"===a.type||"linkEnd"===a.type){var g={};g.type=a.type,g.time=a.time,g.performee=a.graph_id,g.performee_type="graph",g.object=a.performee,g.object_type=a.performee_type,g.finger=a.finger,a=g}this.addEvent(a)},Ab.prototype.registerListenersOnGraph=function(a,b){a.events.on("move_touch",b).on("move",b).on("touch",b).on("drag",b).on("hold",b).on("release",b).on("zoom",b).on("resize",b).on("create_geom",b).on("remove_geom",b).on("geom_attr",b).on("mouse_location",b).on("link_start",b).on("link_drag",b).on("link_end",b)},Ab.prototype.setupListenersOnLink=function(a){},Ab.prototype.logAction=function(a){this.addEvent({type:"action",action:a.action.name,dl_id:a.senderDL_id,newTree:a.action.newTree.to_ascii(),delay:a.action.delay,time:Date.now()})},Ab.prototype.clearEventLogRetainSimpleObjects=function(){var a=this.getSimpleObjectsFromCanvas();this.event_log.events=[];for(var b=0;b<a.length;b++){var c=a[b],d=c instanceof Derivation?"dl":"graph";this.addEvent({type:"create",time:-1,performee_type:d,performee:c.id,object_options:c.options})}},Ab.prototype.captureInitialState=function(){this.event_log.options.initialState=this.canvas.serialize(),this.event_log.events=[]},Ab.prototype.remove=function(){this.canvasComponents&&(this.canvasComponents.svg.remove(),this.canvasComponents=null)},ad.DLLogger=Bb,Bb.prototype.initListeners=function(){this.registerDLListeners(this.dl);var a=this.dl.rows.length;this.dl.rows.forEach(function(b,c){0!==c&&c!==a-1||this.registerInteractionHandlerListeners(b.view.interaction_handler),this.registerAMListeners(b.model)},this)},Bb.prototype.registerDLListeners=function(a){a.events.on("added_line."+this.id,function(){2===a.rows.length&&this.registerInteractionHandlerListeners(a.rows[0].view.interaction_handler),this.registerAMListeners(a.getLastModel())}.bind(this)).on("auto_undo."+this.id,function(b){this.registerInteractionHandlerListeners(a.getLastView().interaction_handler),this.registerAMListeners(a.getLastModel()),this.on_auto_undo(b)}.bind(this))},Bb.prototype.registerAMListeners=function(a){a.events.on("create."+this.id,this.on_change.bind(this)).on("change."+this.id,this.on_change.bind(this)).on("spawn."+this.id,this.on_spawn.bind(this)).on("end-of-interaction."+this.id,this.on_end_of_interaction.bind(this)).on("start-of-interaction."+this.id,this.on_start_of_interaction.bind(this))},Bb.prototype.registerInteractionHandlerListeners=function(a){a.events.on("touch."+this.id,this.on_touch.bind(this,a)).on("release."+this.id,this.on_release.bind(this,a)).on("tap."+this.id,this.on_tap.bind(this,a)).on("dbltap."+this.id,this.on_tap.bind(this,a)).on("hold."+this.id,this.on_tap.bind(this,a)).on("keydown."+this.id,this.on_keydown.bind(this,a)).on("keyup."+this.id,this.on_keyup.bind(this,a)).on("node_selection."+this.id,this.on_node_selection.bind(this,a)),this.log_mouse_trajectories&&a.events.on("drag_start."+this.id,this.on_drag_start.bind(this,a)).on("drag."+this.id,this.on_drag.bind(this,a)).on("drag_end."+this.id,this.on_drag_end.bind(this,a))},Bb.prototype.on_error=function(a){var b=arguments.length<=1||void 0===arguments[1]||arguments[1];console.warn("Error during logging of derivation interaction."),b&&ad.sendErrorReport("Error during logging of derivation interaction.",l()),this.clearData(),this.interaction="ignore"},Bb.prototype.log=function(a){this.events.push(a)},Bb.prototype.extendWithNodeData=function(a,b,c,d){if(c||(c=[]),Array.isArray(c)||(c=[c]),this.extendWithSelectorData(a,b,c),0!==c.length){var e=ud.getBoundingBox(c);a[b+"x"]=e.x,a[b+"y"]=e.y,a[b+"width"]=e.width,a[b+"height"]=e.height}},Bb.prototype.getSelectorString=function(a,b){if(Array.isArray(a)){if(0===a.length)return""}else a=[a];return b?a[0].get_root().getSelectorOfNodes(a):a.map(function(a){return a.to_ascii()}).join(";")},Bb.prototype.extendWithSelectorData=function(a,b,c){a[b+"ascii"]=this.getSelectorString(c,!0)},Bb.prototype.extendWithFirstLogData=function(a,b,c){this.extendWithLogData(a,this.events[0],b,c)},Bb.prototype.extendWithPreviousLogData=function(a,b,c){this.extendWithLogData(a,this.events[this.events.length-1],b,c)},Bb.prototype.extendWithLogData=function(a,b,c,d){if(!(b&&c+"x"in b))throw"(DLLogger) Source log argument does not exist or does not contain expected data.";void 0===d&&(d=c),a[d+"x"]=b[c+"x"],a[d+"y"]=b[c+"y"],a[d+"width"]=b[c+"width"],a[d+"height"]=b[c+"height"],a[d+"ascii"]=b[c+"ascii"],b[d+"idx"]&&(a[d+"idx"]=b[c+"idx"])};Bb.prototype.extendWithDuration=function(a){for(var b=this.events.length-1;b>=0;b--){var c=this.events[b];if("math"===c.type||0===b)return void(a.dur=a.time-c.time)}},Bb.prototype.on_spawn=function(a){try{a.settings&&a.settings.makes_no_changes&&this.on_action({action:a})}catch(a){this.on_error(a)}},Bb.prototype.on_change=function(a){try{if("ignore"===this.interaction)return;if(!this.interaction&&a.new_model&&this.registerAMListeners(a.new_model),!this.interaction)return;a.action?this.on_action(a):this.dl.rows[0].model===a.new_model&&this.on_scrub(a)}catch(a){this.on_error(a)}},Bb.prototype.element_created=function(a){var b=a.el_id,c=a.new_state,d=a.el_type;if("ignore"!==this.interaction){this.interaction.created_elements?this.interaction.created_elements.push(b):this.interaction.created_elements=[b];var e={type:"event",subtype:"create",el_type:d,el_id:b,new_state:c,time:Date.now()};this.log(e)}},Bb.prototype.on_action=function(a){var b=this.dl.getRowByModel(a.action.newTree),c={time:Date.now(),type:"event",subtype:"math",action:a.action.name,row_id:b?b.idx:-1,method:a.action.getOrInferTriggerType()};if(a.action instanceof Ld&&(c.source=a.action.nodes.map(function(a){return a.to_ascii()}).join(";")),a.action.source_am){c.source=this.getSelectorString(a.action.nodes);var d=this.dl.getAllDLs().find(function(b){return b.getRowByModel(a.action.source_am)});d&&(c.source_id=d.id)}this.extendWithNodeData(c,"expr_",a.action.new_derivation?a.action.oldTree.children[0]:a.action.newTree.children[0]),a.action.target&&(this.extendWithSelectorData(c,"target_",a.action.target),c.target_side=a.action.settings.side),this.events.length&&this.extendWithDuration(c),this.interaction.method||(this.interaction.method=c.method),this.interaction.new_state=c.expr_ascii,this.log(c),a.dl&&(console.log("I'm still useful!"),this.element_created({time:c.time,action:a.action.name,el_id:a.dl,new_state:a.action.newTree.to_ascii(),el_type:"derivation"}))},Bb.prototype.on_scrub=function(a){this.scrubbed_in_this_interaction=!0,this.interaction.subtype="scrub",this.interaction.method="drag"},Bb.prototype.on_start_of_interaction=function(a){try{if(this.interaction)return console.warn("Start of interaction received before prior interaction ended."),void this.clearData();this.interaction={time:Date.now(),type:"interaction",subtype:"rewrite",el_type:"derivation",el_id:this.dl.id,el_subtype:"row",el_subid:this.dl.getRowByModel(a.model).idx,old_state:a.model.to_ascii()},this.logStartOfInterationEvent(a.time,this.dl.getRowByModel(a.model))}catch(a){this.on_error(a)}},Bb.prototype.on_end_of_interaction=function(a){try{if(!this.interaction||"ignore"===this.interaction)return this.interaction||(console.warn("End of interaction received without prior start of interaction."),this.on_error("End of interaction received without prior start of interaction.")),void this.clearData();this.scrubbed_in_this_interaction&&(this.logScrubEvent(),this.initListeners()),("edit"===this.dl.mode&&!this.isEmptySelectionInteraction()||"inspect"===this.dl.mode&&this.scrubbed_in_this_interaction)&&(this.interaction.dur=this.events[this.events.length-1].time-this.interaction.time,this.interaction_logger.logInteractionWithEvents(this.interaction,this.events,Bb.compressDragEvents),this.interaction.new_state||(this.interaction.new_state=this.interaction.old_state)),this.clearData()}catch(a){this.on_error(a)}},Bb.prototype.on_auto_undo=function(a){try{if(!this.interaction||"ignore"===this.interaction)return;this.log({time:Date.now(),type:"event",subtype:"auto-undo",row_id:this.dl.rows.length-1})}catch(a){this.on_error(a)}},Bb.prototype.isEmptySelectionInteraction=function(){return!this.events.some(function(a){return"node_selection"===a.subtype||"math"===a.subtype})},Bb.compressDragEvents=function(a){var b=a.filter(function(a){return"drag"===a.subtype});if(0===b.length)return a;for(var c,d={type:"event",subtype:"trajectory",dts:[],xs:[],ys:[],wi_int_ids:[],sel_ascii:[]},e=a[0].time,f=0;f<b.length;f++){var g=b[f];d.dts.push(g.time-e),d.xs.push(g.x),d.ys.push(g.y),d.wi_int_ids.push(g.within_interaction_id),d.sel_ascii.push(g.sel_ascii!==c?g.sel_ascii:void 0),e=g.time,c=g.sel_ascii}return d.interaction_id=a[0].interaction_id,d.trial_id=a[0].trial_id,a=a.filter(function(a){return"drag"!==a.subtype}),a.push(d),a},Bb.decompressAndSortEvents=function(a){a.sort(function(a,b){return(a.within_interaction_id||-1)-(b.within_interaction_id||-1)});var b;if("trajectory"===a[0].subtype)b=0;else{if(!a[1]||"trajectory"!==a[1].subtype)return a;b=1}for(var c=a.splice(b,1)[0],d=a[0].time,e=0;e<c.dts.length;e++){var f={time:c.dts[e]+d,x:c.xs[e],y:c.ys[e],trial_id:c.trial_id,interaction_id:c.interaction_id,within_interaction_id:c.wi_int_ids[e],type:"event",subtype:"drag"};c.sel_ascii&&c.sel_ascii[e]&&(f.sel_ascii=c.sel_ascii[e]),a.push(f),d+=c.dts[e]}return a.sort(function(a,b){return(a.within_interaction_id||-1)-(b.within_interaction_id||-1)}),a},Bb.prototype.clearData=function(){this.scrubbed_in_this_interaction=!1,this.interaction=null,this.events=[]},Bb.prototype.logScrubEvent=function(){var a={time:Date.now(),type:"event",subtype:"scrub",method:"drag",dur:this.events[this.events.length-1].time-this.events[0].time};this.extendWithNodeData(a,"expr_",this.dl.rows[0].model.children[0]),this.interaction.new_state=a.expr_ascii,this.log(a)},Bb.prototype.logStartOfInterationEvent=function(a,b){var c={time:a,type:"event",subtype:"start-interaction",row_id:b.idx};this.extendWithNodeData(c,"expr_",b.model.children[0]),this.extendWithNodeData(c,"sel_",b.view.interaction_handler.selected_nodes),this.log(c)},Bb.prototype.on_touch=function(a,b){try{if(!this.interaction||"ignore"===this.interaction)return;var c={time:b.time,type:"event",subtype:"touch",x:b.finger.pos[0],y:b.finger.pos[1],touch_id:b.finger.id};this.extendWithNodeData(c,"sym_",b.target,!0),this.log(c)}catch(a){this.on_error(a)}},Bb.prototype.on_release=function(a,b){try{if(!this.interaction||"ignore"===this.interaction)return;this.log({time:b.time,type:"event",subtype:"release",x:b.finger.pos[0],y:b.finger.pos[1],touch_id:b.finger.id})}catch(a){this.on_error(a)}},Bb.prototype.on_drag_start=function(a,b){try{if(!this.interaction||"ignore"===this.interaction)return;if(0===b.selection.length)this.interaction="ignore";else{var c={time:b.time,type:"event",subtype:"drag",x:Math.round(b.pos0[0]),y:Math.round(b.pos0[1]),sel_ascii:this.getSelectorString(b.selection[0],!1)};this.log(c)}}catch(a){this.on_error(a)}},Bb.prototype.on_drag=function(a,b){try{if(!this.interaction||"ignore"===this.interaction)return;var c={time:b.time,type:"event",subtype:"drag",x:Math.round(b.pos[0]),y:Math.round(b.pos[1]),sel_ascii:this.getSelectorString(b.selection[0],!1)};this.log(c)}catch(a){this.on_error(a)}},Bb.prototype.on_drag_end=function(a,b){},Bb.prototype.on_node_selection=function(a,b){try{if(!this.interaction||"ignore"===this.interaction)return;var c={time:b.time,type:"event",subtype:"node_selection"};this.extendWithNodeData(c,"sel_",b.selection,!0),this.log(c)}catch(a){this.on_error(a)}},Bb.prototype.on_tap=function(a,b){try{if(!this.interaction||"ignore"===this.interaction)return;this.log({time:b.time,type:"event",subtype:b.type,x:b.finger.pos[0],y:b.finger.pos[1]})}catch(a){this.on_error(a)}},Bb.prototype.on_keydown=function(a,b){try{if(!this.interaction||"ignore"===this.interaction)return;this.log({time:b.time,type:"event",subtype:"keydown",key_code:b.keyCode})}catch(a){this.on_error(a)}},Bb.prototype.on_keyup=function(a,b){try{if(!this.interaction||"ignore"===this.interaction)return;this.log({time:b.time,type:"event",subtype:"keyup",key_code:b.keyCode})}catch(a){this.on_error(a)}},ad.DLLogger=Bb,ad.CanvasLogger=Cb,Cb.prototype.startOfInteractionDetected=function(a){this.data_logger.listening&&(a.source&&a.source.settings&&a.source.settings.get("dont_log_events")||(this.containsPendingEvents(this.interactionSequence)&&this.submitCurrentSequence(),this.addEvent(a)))},Cb.prototype.canvasTouchDetected=function(a){this.data_logger.listening&&(a.source&&a.source.settings&&a.source.settings.get("dont_log_events")||this.addEvent(a))},Cb.prototype.reset=function(){this.dlLoggers=[]},Cb.prototype.endOfInteractionDetected=function(a){this.data_logger.listening&&(a.source&&a.source.settings&&a.source.settings.get("dont_log_events")||(this.addEvent(a),this.interactionSequence[0].source&&this.interactionSequence[0].source.type!==this.interactionSequence[this.interactionSequence.length-1].source.type||this.submitCurrentSequence()))},Cb.prototype.addEvent=function(a){this.data_logger.listening&&(a.source&&a.source.settings&&a.source.settings.get("dont_log_events")||(a.time=Date.now(),a.date=(new Date).toString(),a.source&&a.source.model&&a.source.model.to_ascii&&(a.source.model=a.source.model.to_ascii()),this.interactionSequence.push(a)))},Cb.prototype.submitCurrentSequence=function(){this.summarizeInteractionSequence(this.interactionSequence).forEach(function(a){this.data_logger.logInteraction(a)},this),this.interactionSequence=[]},Cb.prototype.summarizeInteractionSequence=function(a){try{return this.isNullSequence(a)?[]:this.isMoveSequence(a)?this.summarizeMoveSequence(a):this.isResizeSequence(a)?this.summarizeResizeSequence(a):this.isCreateSequence(a)?this.summarizeCreateSequence(a):this.isCreateDuringActionSequence(a)?this.summarizeCreateDuringActionSequence(a):this.isGeometryCreateSequence(a)?this.summarizeGeometryCreateSequence(a):this.isDeleteSequence(a)?this.summarizeDeleteSequence(a):this.isGeometryDeleteSequence(a)?this.summarizeGeometryDeleteSequence(a):this.isDrawSequence(a)?this.summarizeDrawSequence(a):this.isEraseSequence(a)?this.summarizeEraseSequence(a):this.isNodeInspectSequence(a)?this.summarizeNodeInspectSequence(a):this.isGraphScrubSequence(a)?this.summarizeGraphScrubSequence(a):this.isPackSequence(a)?this.summarizePackSequence(a):this.isLinkSequence(a)?this.summarizeLinkSequence(a):this.isCloneSequence(a)?this.summarizeCloneSequence(a):this.isGraphPanSequence(a)?this.summarizeGraphPanSequence(a):this.isButtonSequence(a)?this.summarizeButtonSequence(a):this.isGraphZoomSequence(a)?this.summarizeGraphZoomSequence(a):this.isFontSizeSequence(a)?this.summarizeFontSizeSequence(a):this.isTextEditSequence(a)?this.summarizeTextEditSequence(a):(console.warn("(CanvasLogger) Interaction did not match any defined interaction types."),this.interactionSequence=[],[])}catch(a){return console.warn("(CanvasLogger) Error when summarizing interaction sequence:",a),ad.sendErrorReport("Error when summarizing interaction sequence.",l()),this.dlLoggers.forEach(function(a){return a.on_error(null,!1)}),this.interactionSequence=[],[]}},Cb.prototype.containsPendingEvents=function(a){return!!a.length},Cb.prototype.isDifferentInteraction=function(a,b){if(!a.length)return!1;var c=!1;return b.element.id&&(c=c||a.some(function(a){return!a.element||!a.element.id||a.element.id!==b.element.id})),b.type&&(c=c||a.some(function(a){return!a.type||a.type!==b.type})),c},Cb.prototype.setupListeners=function(a){this.registerToolbarListeners(a,this.canvasToolbarListener.bind(this)),this.registerCanvasModelViewListeners(a.model,this.canvasModelViewListener.bind(this)),this.registerCanvasControllerListeners(a.controller,this.canvasControllerListener.bind(this))},Cb.prototype.registerToolbarListeners=function(a,b){a.events.on("button."+this.session_id,b)},Cb.prototype.canvasToolbarListener=function(a){this.containsPendingEvents(this.interactionSequence)&&this.submitCurrentSequence(),a.type="toolbar_button_press",this.addEvent(a),this.submitCurrentSequence()},Cb.prototype.registerCanvasModelViewListeners=function(a,b){var c=this;a.on("create."+this.session_id,b).on("remove."+this.session_id,b),a.dls().forEach(function(a){c.setupListenersOnDL(a)})},Cb.prototype.canvasModelViewListener=function(a){"create"===a.type&&this.objectCreationDetected(a),"remove"===a.type&&this.objectDeletionDetected(a)},Cb.prototype.registerCanvasControllerListeners=function(a,b){a.on("start-of-interaction."+this.session_id,b).on("touch."+this.session_id,b).on("end-of-interaction."+this.session_id,b)},Cb.prototype.canvasControllerListener=function(a){a.length&&(a=a[0]),"start-of-interaction"===a.type&&this.startOfInteractionDetected(a),"end-of-interaction"===a.type&&this.endOfInteractionDetected(a),"touch"===a.type&&this.canvasTouchDetected(a)},Cb.prototype.objectCreationDetected=function(a){if(!(a.target&&a.target.settings&&a.target.settings.get("dont_log_events"))&&"link"!==a.target_type){"derivation"===a.target_type&&this.setupListenersOnDL(a.target),"graph"===a.target_type&&this.setupListenersOnGraph(a.target),"textbox"===a.target_type&&this.setupListenersOnTextBox(a.target);var b={};b.type="GM_object_created_or_added",b.method=a.method,b.element={type:a.target_type,id:a.target.id},"derivation"===a.target_type&&(b.element.new_state=a.target.settings.get("eq"),b.element.options=a.target.settings.getModified()),"textbox"===a.target_type&&a.target.settings.get("text")!==a.target.settings.parent.get("text")&&(b.element.new_state=a.target.settings.get("text")),"image"===a.target_type&&a.target.settings.get("url")&&(b.element.new_state=a.target.settings.get("url")),this.addEvent(b),1===this.interactionSequence.length&&this.submitCurrentSequence()}},Cb.prototype.objectDeletionDetected=function(a){if(!(a.target&&a.target.settings&&a.target.settings.get("dont_log_events"))){var b={};b.type="GM_object_removed",b.element={type:a.target_type,id:a.target.id,options:a.target.settings?ad.deepCopy(a.target.settings.getAll()):null},this.addEvent(b),1===this.interactionSequence.length&&(this.interactionSequence=[])}},Cb.prototype.setupListenersOnDL=function(a){this.registerListenersOnEvents(a.events,this.DLListener.bind(this)),this.dlLoggers.push(new Bb(this.data_logger,a))},Cb.prototype.registerListenersOnEvents=function(a,b){a.on("inspect_node."+this.session_id,b).on("pack_state."+this.session_id,b)},Cb.prototype.DLListener=function(a){a.length&&(a=a[0]),"removed"===a.type&&this.ignoreDerivationInteraction(a),"inspect"===a.type&&this.nodeInspectionDetected(a),"packState"===a.type&&this.packStateDetected(a)},Cb.prototype.ignoreDerivationInteraction=function(a){var b=this.dlLoggers.find(function(b){return b.dl===a.performee});b&&(b.clearData(),b.interaction="ignore")},Cb.prototype.nodeInspectionDetected=function(a){var b={};b.type="node_inspected",b.element={type:"derivation",id:a.dl.id},b.inspection={row:a.row,model:a.dl.rows[a.row].model.to_ascii(),sel:a.node.get_root().getSelectorOfNodes(a.node)},this.addEvent(b)},Cb.prototype.packStateDetected=function(a){var b={};b.type="derivation_list_pack_state_changed",b.element={type:"derivation",id:a.performee},b.state=a.packState,this.addEvent(b)},Cb.prototype.setupListenersOnGraph=function(a){this.registerListenersOnGraph(a,this.graphListener.bind(this))},Cb.prototype.registerListenersOnGraph=function(a,b){a.events.on("create_geom."+this.session_id,b).on("remove_geom."+this.session_id,b).on("geom_attr."+this.session_id,b).on("zoom."+this.session_id,b)},Cb.prototype.graphListener=function(a){"graphElementCreate"!==a.type&&"graphElementChange"!==a.type||this.graphElementDetected(a),"graphElementRemove"===a.type&&this.graphElementDeletionDetected(a),"zoom"===a.type&&this.graphPanZoomDetected(a)},Cb.prototype.graphElementDetected=function(a){var b={};b.type="graphElementCreate"===a.type?"graph_element_created":"graph_element_changed",b.element={type:"graph",id:a.graph_id};var c=a.performee_object.summarize();delete c.id,delete c.type,b.graph_element={type:a.performee_type||a.performee_object.type,id:a.performee,attr:c},this.addEvent(b)},Cb.prototype.graphElementDeletionDetected=function(a){var b={};b.type="graph_element_removed",b.element={type:"graph",id:a.graph_id},b.graph_element={type:a.performee_type,id:a.performee,attr:a.performee_object},this.addEvent(b)},Cb.prototype.graphPanZoomDetected=function(a){var b={};b.type="graph_pan_zoom",b.element={type:"graph",id:a.performee,new_state:{pan:a.translate,zoom:a.scale}},this.isDifferentInteraction(this.interactionSequence,b)&&this.submitCurrentSequence(),this.addEvent(b)},Cb.prototype.setupListenersOnTextBox=function(a){this.registerListenersOnTextBox(a,this.textboxListener.bind(this))},Cb.prototype.registerListenersOnTextBox=function(a,b){a.events.on("text."+this.session_id,b).on("font_size."+this.session_id,b)},Cb.prototype.textboxListener=function(a){("text"===a.type&&this.isDifferentInteraction(this.interactionSequence,a)||"font_size"===a.type&&this.containsPendingEvents(this.interactionSequence))&&this.submitCurrentSequence(),this.addEvent(a),"font_size"===a.type&&this.submitCurrentSequence()},Cb.prototype.isNullSequence=function(a){return!!a.every(function(a){return"start-of-interaction"===a.type&&"CanvasController"===a.source.type||"end-of-interaction"===a.type})||(!!a.every(function(a){return"start-of-interaction"===a.type&&"AlgebraModel"===a.source.type||"end-of-interaction"===a.type})||(!!a.every(function(a){return"start-of-interaction"===a.type&&"DerivationRow"===a.source.type||"end-of-interaction"===a.type})||(!(!a.every(function(a){return"start-of-interaction"===a.type&&("derivation"===a.source.type||"Graph"===a.source.type||"textbox"===a.source.type)||"end-of-interaction"===a.type})||!this.startAndEndPositionsAreTheSame(a)&&!this.startAndEndSizesAreTheSame(a))||(!!a.every(function(a){return"start-of-interaction"===a.type&&"Graph"===a.source.type&&"touch"===a.subSource||"end-of-interaction"===a.type})||!(!a.every(function(a){return"start-of-interaction"===a.type&&"DerivationRow"===a.source.type||"GM_object_created_or_added"===a.type&&"textbox"===a.element.type||"end-of-interaction"===a.type})||!a.some(function(a){return"start-of-interaction"===a.type}))))))},Cb.prototype.startAndEndPositionsAreTheSame=function(a){var b=a[0],c=a[a.length-1];if(!b.pos||!c.pos)return!1;var d=Array.isArray(b.pos)?b.pos:[b.pos.x,b.pos.y],e=Array.isArray(c.pos)?c.pos:[c.pos.x,c.pos.y];return d[0]===e[0]&&d[1]===e[1]},Cb.prototype.startAndEndSizesAreTheSame=function(a){var b=a[0],c=a[a.length-1];return!(!b.size||!c.size)&&(b.size.width===c.size.width&&c.size.height===c.size.height)},Cb.prototype.isCreateSequence=function(a){return a.every(function(a){return"start-of-interaction"===a.type&&"CanvasController"===a.source.type||"GM_object_created_or_added"===a.type&&"path"!==a.element.type||"end-of-interaction"===a.type})},Cb.prototype.isCreateDuringActionSequence=function(a){return a.some(function(a){return"start-of-interaction"===a.type&&"AlgebraModel"===a.source.type})&&a.some(function(a){return"GM_object_created_or_added"===a.type&&"path"!==a.element.type})},Cb.prototype.isGeometryCreateSequence=function(a){return a.every(function(a){return"start-of-interaction"===a.type&&"Graph"===a.source.type||"graph_element_created"===a.type||"graph_element_changed"===a.type||"end-of-interaction"===a.type})&&a.some(function(a){return"graph_element_created"===a.type})},Cb.prototype.isDeleteSequence=function(a){return a.every(function(a){return"start-of-interaction"===a.type||"GM_object_removed"===a.type&&"path"!==a.element.type||"node_inspected"===a.type||"end-of-interaction"===a.type})&&a.some(function(a){return"GM_object_removed"===a.type})},Cb.prototype.isGeometryDeleteSequence=function(a){return a.every(function(a){return"start-of-interaction"===a.type&&"Graph"===a.source.type||"graph_element_removed"===a.type||"graph_element_changed"===a.type||"end-of-interaction"===a.type})&&a.some(function(a){return"graph_element_removed"===a.type})},Cb.prototype.isDrawSequence=function(a){return a.some(function(a){return"touch"===a.type&&"draw"===a.subtype})},Cb.prototype.isEraseSequence=function(a){return a.some(function(a){return"touch"===a.type&&"erase"===a.subtype})},Cb.prototype.isNodeInspectSequence=function(a){return a.every(function(a){return"start-of-interaction"===a.type&&"AlgebraModel"===a.source.type||"node_inspected"===a.type||"end-of-interaction"===a.type})},Cb.prototype.isGraphScrubSequence=function(a){return a.every(function(a){return"start-of-interaction"===a.type&&"Graph"===a.source.type||"model_changed"===a.type&&"number_scrub"===a.change.type||"graph_element_changed"===a.type||"end-of-interaction"===a.type})},Cb.prototype.isMoveSequence=function(a){return a.every(function(a){return"start-of-interaction"===a.type&&("derivation"===a.source.type||"Graph"===a.source.type||"textbox"===a.source.type||"image"===a.source.type)&&a.pos||"end-of-interaction"===a.type})},Cb.prototype.isResizeSequence=function(a){return a.every(function(a){return"start-of-interaction"===a.type&&("textbox"===a.source.type||"image"===a.source.type)&&a.size||"end-of-interaction"===a.type})},Cb.prototype.isPackSequence=function(a){return a.every(function(a){return"start-of-interaction"===a.type||"derivation_list_pack_state_changed"===a.type||"end-of-interaction"===a.type})},Cb.prototype.isLinkSequence=function(a){return a.every(function(a){return"start-of-interaction"===a.type&&"Graph"===a.source.type||"GM_object_created_or_added"===a.type&&"derivation"===a.element.type||"end-of-interaction"===a.type})||a.every(function(a){return"start-of-interaction"===a.type&&"DerivationRow"===a.source.type||"graph_element_created"===a.type||"end-of-interaction"===a.type})},Cb.prototype.isCloneSequence=function(a){return a.every(function(a){return"start-of-interaction"===a.type&&"DerivationRow"===a.source.type||"GM_object_created_or_added"===a.type||"end-of-interaction"===a.type})},Cb.prototype.isGraphPanSequence=function(a){return a.every(function(a){return"start-of-interaction"===a.type||"graph_pan_zoom"===a.type||"end-of-interaction"===a.type})&&a.some(function(a){return"start-of-interaction"===a.type})},Cb.prototype.isButtonSequence=function(a){return a.every(function(a){return"toolbar_button_press"===a.type})||a.some(function(a){return"toolbar_button_press"===a.type&&("undo"===a.button.label||"redo"===a.button.label)})},Cb.prototype.isGraphZoomSequence=function(a){return a.every(function(a){return"graph_pan_zoom"===a.type})},Cb.prototype.isFontSizeSequence=function(a){return a.every(function(a){return"font_size"===a.type})},Cb.prototype.isTextEditSequence=function(a){return a.every(function(a){return"text"===a.type})},Cb.prototype.fillSummaryWithTimeAndCanvasId=function(a,b,c){a.time=b.time,a.dur=c.time-b.time},Cb.prototype.summarizeCreateSequence=function(a){for(var b=a[0],c=a[a.length-1],d=[],e=1;e<a.length-1;e++){var f=a[e],g={type:"interaction",subtype:"create",el_id:f.element.id,el_type:f.element.type,method:f.method};f.element.new_state&&(g.new_state=f.element.new_state),f.element.options&&(g.options=f.element.options),this.fillSummaryWithTimeAndCanvasId(g,b,c),d.push(g)}return d},Cb.prototype.summarizeCreateDuringActionSequence=function(a){var b=this.summarizeCreateSequence(a.filter(function(b,c){return 0===c||c===a.length-1||"GM_object_created_or_added"===b.type})),c=this.dlLoggers.find(function(b){return b.dl.getRowByModel(a[0].source)});return c?(b.forEach(function(a){return c.element_created(a)}),[]):[]},Cb.prototype.summarizeGeometryCreateSequence=function(a){var b={type:"interaction",subtype:"create"},c=a[0],d=a[a.length-1];this.fillSummaryWithTimeAndCanvasId(b,c,d);var e=a.filter(function(a){return"graph_element_created"===a.type});e=e[e.length-1];var f=a.filter(function(a){return"graph_element_changed"===a.type});return f.length&&(e=f[0]),b.targets=[{type:"graph",id:e.element.id,subtype:e.graph_element.type,subid:e.graph_element.id,new_state:e.graph_element.attr}],"point"===b.targets[0].subtype?b.method="hold":b.method="hold-drag",[b]},Cb.prototype.summarizeDeleteSequence=function(a){var b=a[0],c=a[a.length-1],d=ad.find(a,function(a){return"GM_object_removed"===a.type}),e={type:"interaction",subtype:"delete",method:"tap",el_id:d.element.id,el_type:d.element.type};return this.fillSummaryWithTimeAndCanvasId(e,b,c),[e]},Cb.prototype.summarizeGeometryDeleteSequence=function(a){var b={type:"graph",subtype:"delete",method:"tap"},c=a[1],d=(a[a.length-1],a[0]);return this.fillSummaryWithTimeAndCanvasId(b,d,c),delete d.graph_element.attr.id,delete d.graph_element.attr.type,b.element={type:d.element.type,id:d.element.id,subtype:d.graph_element.type,subid:d.graph_element.id,old_state:d.graph_element.attr},[b]},Cb.prototype.summarizeDrawSequence=function(a){var b={type:"interaction",subtype:"draw",method:"drag"},c=a[0],d=a[a.length-1];this.fillSummaryWithTimeAndCanvasId(b,c,d);var e=a.find(function(a){return"GM_object_created_or_added"===a.type});return b.el_id=e.element.id,b.el_type=e.element.type,[b]},Cb.prototype.summarizeEraseSequence=function(a){var b={type:"interaction",subtype:"erase",method:"drag"},c=a[0],d=a[a.length-1];return this.fillSummaryWithTimeAndCanvasId(b,c,d),[b]},Cb.prototype.summarizeNodeInspectSequence=function(a){var b=a[0],c=a[a.length-1],d=a[1],e={type:"interaction",subtype:"inspect",method:"tap",el_id:d.element.id,el_type:"derivation",el_subid:d.inspection.row,el_subtype:"row",sel_ascii:d.inspection.sel};return this.fillSummaryWithTimeAndCanvasId(e,b,c),[e]},Cb.prototype.summarizeGraphScrubSequence=function(a){var b={type:"graph",subtype:"scrub",method:"drag"},c=a[0],d=a[a.length-1];this.fillSummaryWithTimeAndCanvasId(b,c,d);var e=a.filter(function(a){return"graph_element_changed"===a.type})[0],f=c.source.selection;return delete f.id,delete f.type,b.element={type:"graph",id:e.element.id,subtype:e.graph_element.type,subid:e.graph_element.id,old_state:c.source.selection,new_state:e.graph_element.attr},[b]},Cb.prototype.summarizeMoveSequence=function(a){var b=a[0],c=a[a.length-1],d={type:"interaction",subtype:"move",method:"drag",el_id:b.source.id,el_type:b.source.type,old_state:JSON.stringify(b.pos),new_state:JSON.stringify(c.pos)};return this.fillSummaryWithTimeAndCanvasId(d,b,c),[d]},Cb.prototype.summarizeResizeSequence=function(a){var b=a[0],c=a[a.length-1],d={type:"interaction",subtype:"resize",method:"drag",el_id:b.source.id,el_type:b.source.type,old_state:JSON.stringify(b.size),new_state:JSON.stringify(c.size)};return this.fillSummaryWithTimeAndCanvasId(d,b,c),[d]},Cb.prototype.summarizePackSequence=function(a){var b={type:"interaction",subtype:"pack-dl",method:"drag"},c=a[0],d=a[a.length-1];this.fillSummaryWithTimeAndCanvasId(b,c,d);var e=a[a.length-2];return b.element={type:"derivation",id:e.element.id,subtype:"dl-row",subid:c.source.row,old_state:c.source.packState,new_state:d.source.packState},[b]},Cb.prototype.summarizeLinkSequence=function(a){var b={type:"interaction",subtype:"link",method:"drag"},c=a[0],d=a[a.length-1];this.fillSummaryWithTimeAndCanvasId(b,c,d);var e=a[1];return"DerivationRow"===c.source.type?(b.element={type:"derivation",id:c.source.id,subtype:"dl-row",subid:c.source.row,sel:c.source.model},b.targets=[{type:"graph",id:e.element.id,subtype:e.graph_element.type,subid:e.graph_element.id,new_state:e.graph_element.attr}]):(b.element={type:"graph",id:c.source.id,subtype:c.source.selection.type,subid:c.source.selection.id},b.targets=[{type:"derivation",id:e.element.id,new_state:e.element.new_state}]),[b]},Cb.prototype.summarizeCloneSequence=function(a){var b=a[0],c=a[a.length-1],d=a[1],e={type:"interaction",subtype:"clone",method:"drag",el_id:b.source.id,el_type:"derivation",el_subid:b.source.row,el_subtype:"row",target_id:d.element.id,target_type:d.element.type,new_state:d.element.new_state,pos:d.element.pos};return this.fillSummaryWithTimeAndCanvasId(e,b,c),[e]},Cb.prototype.summarizeGraphPanSequence=function(a){var b={type:"graph",subtype:"pan",method:"drag"},c=a[0],d=a[a.length-1];this.fillSummaryWithTimeAndCanvasId(b,c,d);var e=a[1],f=a[a.length-2];return b.element={type:"graph",id:c.source.id,old_state:{pan:e.element.new_state.pan,zoom:e.element.new_state.zoom},new_state:{pan:f.element.new_state.pan,zoom:f.element.new_state.zoom}},[b]},Cb.prototype.summarizeGraphZoomSequence=function(a){var b={type:"graph",subtype:"zoom",method:"scroll"},c=a[0],d=a[a.length-1];return this.fillSummaryWithTimeAndCanvasId(b,c,d),b.element={type:"graph",id:c.element.id,old_state:{pan:c.element.new_state.pan,zoom:c.element.new_state.zoom},new_state:{pan:d.element.new_state.pan,zoom:d.element.new_state.zoom}},[b]},Cb.prototype.summarizeButtonSequence=function(a){var b={type:"interaction",method:"toolbar"},c=a.filter(function(a){return"toolbar_button_press"===a.type})[0];switch(b.time=c.time,b.dur=0,c.button.label){case"undo":b.subtype="undo";break;case"redo":b.subtype="redo";break;case"clear all":b.subtype="clear_all";break;case"larger":case"smaller":b.subtype="font_size",b.old_state=c.old_state.font_size,b.new_state=c.button.font_size;break;case"save":b.subtype="save";break;case"load":b.subtype="load";break;default:b.subtype="mode_change",b.old_state=c.old_state.mode,b.new_state=c.button.label}return[b]},Cb.prototype.summarizeFontSizeSequence=function(a){return[{type:"interaction",subtype:"font_size",method:"toolbar",time:a[0].time,dur:0,el_type:a[0].element.type,el_id:a[0].element.id,old_state:JSON.stringify(a[0].element.old_state),new_state:JSON.stringify(a[0].element.new_state)}]},Cb.prototype.summarizeTextEditSequence=function(a){var b=a[0],c=a[a.length-1],d={type:"interaction",subtype:"edit",method:"keyboard",el_type:"textbox",el_id:b.element.id,old_state:b.element.old_state,new_state:c.element.new_state};return this.fillSummaryWithTimeAndCanvasId(d,b,c),[d]},ad.DataLogger=Db,Db.console_logs=!1,Db.interaction_id=1,Db.prototype.setTrialInfo=function(a){a.id!==this.trial_id&&(Db.interaction_id=1),this.trial_id=a.id},Db.prototype.listen=function(a){this.listening=!!a},Db.prototype.logInteractionWithEvents=function(a,b,c){this.trial_id||this.createMissingTrial(),a.trial_id=this.trial_id,a.interaction_id=Db.interaction_id,a.canvas_id=this.canvas.id,a.canvas_save_id=this.canvas.meta_data.save_id,a.user_id||(a.user_id=De.logged_in?De.user_id:null),b.forEach(function(a,b){a.trial_id=this.trial_id,a.interaction_id=Db.interaction_id,a.within_interaction_id=b+1},this),c&&(b=c(b)),Db.console_logs&&console.log(a,b),this.listening&&(this.emitReleventSummaryEvents([a]),ad.ServerComm.postInteractions([a].concat(b))),Db.interaction_id++},Db.prototype.logInteraction=function(a){this.trial_id||this.createMissingTrial(),a.trial_id=this.trial_id,a.interaction_id=Db.interaction_id++,a.canvas_id=this.canvas.id,a.canvas_save_id=this.canvas.meta_data.save_id,a.user_id||(a.user_id=De.logged_in?De.user_id:null),Db.console_logs&&console.log(a),this.listening&&(this.emitReleventSummaryEvents([a]),ad.ServerComm.postInteractions([a]))},Db.prototype.logCustomInteraction=function(a,b){this.trial_id||this.createMissingTrial();var c={trial_id:this.trial_id,interaction_id:Db.interaction_id++,canvas_id:this.canvas.id,canvas_save_id:this.canvas.meta_data.save_id,user_id:De.logged_in?De.user_id:null,type:"custom",subtype:a,time:Date.now()};ad.extend(c,b),Db.console_logs&&console.log(c),ad.ServerComm.postInteractions([c])},Db.prototype.createMissingTrial=function(){console.warn("Should start a trial before logging data! Auto-created a trial."),ad.TrialLogger.startTrial(),ad.TrialLogger.postTrial()},Db.prototype.emitReleventSummaryEvents=function(a){var b=a.filter(function(a){return"interaction"===a.type});b.length>0&&this.events.interaction(b)},Db.prototype.simulateStartOfInteraction=function(a,b){var c={type:"start-of-interaction",source:a,time:Date.now()};b&&(c=ad.extend(c,b)),this.canvas_logger.startOfInteractionDetected(c)},Db.prototype.simulateEndOfInteraction=function(a,b){var c={type:"end-of-interaction",source:a,time:Date.now()};b&&(c=ad.extend(c,b)),this.canvas_logger.endOfInteractionDetected(c)},ad.GMEventRecorder=Eb,Eb.prototype.showPreview=function(){var a=ad.extend({},this.event_log.options);a.interactive=!1,this.dl&&this.dl.removeElement(),this.dl=new ad.Derivation(null,this.div.node(),a)},Eb.prototype.replay=function(a,b,c){function d(){f.event_log.events.length>0&&d3.timer(e,a||0)}function e(a){var c=f.dl.getLastView();if(f.stop_timer)return!0;for(;i[g].time-h<a;){if(i[g+1]&&i[g+1].fromKbd){h=i[g+1].time-a-1e3;var d="...",e=i[g+1].fromKbd;Id.isParsable(e)&&(d=new Id(e).to_ascii()),f.showFromKbd(d)}var j=i[g];if(j.action&&j.followup&&i[g+1]&&j.followup===i[g+1].action&&(g++,j=i[g]),j.action?c.model.to_ascii()!==j.newTree&&(f.triggerDelayedAction(c,j.action)&&c.model.to_ascii()===j.newTree?console.info("Triggered delayed action."):(j.fromKbd||console.warn(j,"Replay out of synch, forcing correct state. Expected: "+j.newTree+"; Actual: "+c.model.to_ascii()),f.abortCurrentStateAndResetInteraction(c,j.newTree))):("touch"!==j.type||j.finger||(j.finger=j.fingers[j.fingers.length-1]),c.interaction_handler["on_"+j.type](j),"keyup"===j.type&&f.updateKey(j.keyCode,!1),"keydown"===j.type&&f.updateKey(j.keyCode,!0)),++g===i.length)return b(),!0}}this.event_log.gm_options&&ad.object.extend(ad.options.actions,this.event_log.gm_options);var f=this;if(!this.event_log)return void console.warn("set the event log before replaying!");var g=void 0,h=void 0,i=this.event_log.events;i.length>0&&(h=c||i[0].time,g=0),this.stop_timer=!1,this.dl&&this.dl.removeElement();var j=ad.object.extend({only_synchronous_actions:!0},this.event_log.options);this.dl=new ad.Derivation(null,this.div.node(),j,d)},Eb.prototype.triggerDelayedAction=function(a,b){var c=a.interaction_handler.active_handler;if(!(c&&c instanceof ad.DragHandler))return!1;for(var d=0;d<c.actions.length;d++){var e=c.actions[d];return e.name===b&&(!!e.timeoutID&&(c.clearActionTimeout(e),c.performAction(e),!0))}return!1},Eb.prototype.abortCurrentStateAndResetInteraction=function(a,b){a.model.parseAndSet(b),a.interaction_handler.abort_interaction(),a.bindToModel(a.model),a.enter_and_exit(!0,"both")},Eb.prototype.updateKey=function(a,b){console.log(a);var c=this.div.select("#key"+a);0===c.size()&&(c=this.div.append("span").attr("id","key"+a).classed("key-vis",!0).style("opacity",1e-5).style({position:"absolute",bottom:"5px",right:"10px",padding:"1px 7px",border:"2px solid steelblue","border-radius":"10px",color:"steelblue",background:"white"}).text({32:"space",16:"shift"}[a]||"")),b?c.style("opacity",1):c.transition().duration(750).style("opacity",1e-5)},Eb.prototype.hideKbd=function(){this.div.select("#fromKbd")},Eb.prototype.showFromKbd=function(a){var b=this.div.select("#fromKbd");0===b.size()&&(b=this.div.append("span").attr("id","fromKbd").classed("key-vis",!0).style("opacity",1).style({position:"absolute",bottom:"5px",right:"10px",padding:"1px 7px",border:"2px solid steelblue","border-radius":"10px",color:"steelblue",background:"white"})),b.text(a).style("opacity",1),setTimeout(function(){return b.transition().duration(750).style("opacity",1e-5)},1e3)},Eb.prototype.stop_animation=function(){this.stop_timer=!0},Eb.prototype.createAndRecordDL=function(a,b){var c=new ad.Derivation(null,a,b);this.recordDL(c)},Eb.prototype.recordDL=function(a){this.event_log={options:ad.object.extendChanged({},a.options,ad.Derivation.defaultOptions),gm_options:ad.options.actions,events:[]},console.log("add action blacklist here"),console.log("think"),this.event_log.options.action_blacklist=[],this.dl=a;var b=this.dl.getLastView(),c=this.log.bind(this);this.registerListeners(b,c);var d=this;return a.options.no_history?a.getLastModel().events.on("change",d.logAction.bind(this)):a.events.on("added_line",function(e){d.logAction(e),a.getLastView()!==b&&(b=a.getLastView(),d.registerListeners(b,c))}),this.event_log},Eb.prototype.liveReplay=function(a,b){this.other_dl=new ad.Derivation(null,a,b)},Eb.prototype.log=function(a){this.event_log.events.push(a),this.other_dl&&this.other_dl.getLastView().interaction_handler["on_"+a.type](a)},Eb.prototype.logAction=function(a){a&&this.event_log.events.push({type:"action",action:a.action.name,followup:!!a.action.followup&&a.action.followup.name,fromKbd:!!a.action.latex&&a.action.latex,newTree:a.action.newTree.to_ascii(),time:Date.now()})},Eb.prototype.registerListeners=function(a,b){a.interaction_handler.events.on("touch",b).on("release",b).on("drag_start",b).on("drag",b).on("drag_end",b).on("tap",b).on("dbltap",b).on("keydown",b).on("keyup",b)},ad.EventRecorder=Eb,Ee={},ad.Timeline=Ee,Ee.entryTypes={},Ee.entry=function(a,b){a=a[0];for(var c in Ee.entryTypes){var d=Ee.entryTypes[c];if(d.prototype.match(a))return new d(a,b)}return null},Fe=function(a){this.type=a},Fe.prototype.match=function(a){return this.type===a.subtype},Ge=function(a,b){Fe.call(this,a.subtype),this.summary=a,this.object=b.getElementByID(this.summary.el_id),a.created_elements?this.created_objects=a.created_elements.map(function(a){return{object:b.getElementByID(a)}}):this.created_objects=[]},ad.inherit(Fe,Ge),Ge.prototype.type="rewrite",Ee.entryTypes.AlgebraEntry=Ge,Ge.prototype.match=function(a){return"rewrite"===a.subtype},Ge.prototype.undo=function(a){for(this.rows=[],this.packState=this.object.rows.map(function(a){return!!a.hidden});this.object.getLastRow().idx!==this.summary.el_subid;)this.rows.push(this.object.undo());for(var b=0;b<this.created_objects.length;b++){var c=this.created_objects[b].object,d=a.removeElement(c);"derivation"===c.type&&(this.created_objects[b].links=d)}},Ge.prototype.redo=function(a){for(var b=this.rows.length-1;b>=0;b--)this.object.redo(this.rows[b]);for(var b=0;b<this.object.rows.length;b++){var c=this.object.rows[b];this.packState[b]&&!c.hidden?c.hide():!this.packState[b]&&c.hidden&&c.unhide()}this.object.layoutRows();for(var b=0;b<this.created_objects.length;b++){var d=this.created_objects[b];a.addElement(d.object),d.links&&nb().addLinks(d.links)}},He=function(a,b){Fe.call(this,a.subtype),this.summary=a,this.objects=[],this.objects.push(b.getElementByID(this.summary.el_id)),this.objects=this.objects.map(function(a){return{object:a}})},ad.inherit(Fe,He),He.prototype.type="create",Ee.entryTypes.CreateEntry=He,He.prototype.match=function(a){return this.type===a.subtype&&("derivation"===a.el_type||"textbox"===a.el_type||"image"===a.el_type||"video"===a.el_type)},He.prototype.undo=function(a){for(var b=0;b<this.objects.length;b++){var c=this.objects[b].object,d=a.removeElement(c);"derivation"===c.type&&(this.objects[b].links=d)}},He.prototype.redo=function(a){for(var b=0;b<this.objects.length;b++){var c=this.objects[b];a.addElement(c.object),c.links&&nb().addLinks(c.links)}},Ie=function(a,b){Fe.call(this,a.subtype),this.summary=a,this.object=b.getDeletedElementByID(this.summary.el_id)},ad.inherit(Fe,Ie),Ie.prototype.type="delete",Ee.entryTypes.Entry=Ie,Ie.prototype.match=function(a){return this.type===a.subtype&&("derivation"===a.el_type||"textbox"===a.el_type||"image"===a.el_type||"video"===a.el_type)},Ie.prototype.undo=function(a){a.addElement(this.object)},Ie.prototype.redo=function(a){a.removeElement(this.object)},Je=function(a,b){Fe.call(this,a.subtype),this.summary=a,this.object=b.getElementByID(this.summary.el_id)},ad.inherit(Fe,Je),Je.prototype.type="draw",Ee.entryTypes.DrawEntry=Je,Je.prototype.undo=function(a){a.removePath(this.object)},Je.prototype.redo=function(a){a.addPath(this.object)},Ke=function(a){Fe.call(this,a.subtype),this.summary=a},ad.inherit(Fe,Ke),Ke.prototype.type="erase",Ee.entryTypes.EraseEntry=Ke,Ke.prototype.undo=function(a){if(!this.modification)return void console.warn("erase modification was not set");this.modification.removed.forEach(function(b){a.addPath(b)}),this.modification.added.forEach(function(b){a.removePath(b)}),this.modification.modified.forEach(function(b){b.path.points=b.points_before,a.updatePath(b.path)})},Ke.prototype.redo=function(a){this.modification.removed.forEach(function(b){a.removePath(b)}),this.modification.modified.forEach(function(b){b.path.points=b.points_after,a.updatePath(b.path)}),this.modification.added.forEach(function(b){a.addPath(b)})},Le=function(a,b){Fe.call(this,a.subtype),this.summary=a,this.object=b.getElementByID(this.summary.el_id)},ad.inherit(Fe,Le),Le.prototype.type="move",Ee.entryTypes.MoveEntry=Le,Le.prototype.match=function(a){return this.type===a.subtype&&("derivation"===a.el_type||"textbox"===a.el_type||"image"===a.el_type||"video"===a.el_type)},Le.prototype.undo=function(a){this.object.translateElement(JSON.parse(this.summary.old_state))},Le.prototype.redo=function(a){this.object.translateElement(JSON.parse(this.summary.new_state))},Me=function(a,b){Fe.call(this,a.subtype),this.summary=a,this.object=b.getElementByID(this.summary.el_id)},ad.inherit(Fe,Me),Me.prototype.type="pack",Ee.entryTypes.PackEntry=Me,Me.prototype.match=function(a){return this.type===a.subtype&&!this.startingAndEndingPackStateAreTheSame(a)},Me.prototype.startingAndEndingPackStateAreTheSame=function(a){for(var b=a.old_state,c=a.new_state,d=0;d<b.length;d++)if(b[d]!==c[d])return!1;return!0},Me.prototype.undo=function(a){for(var b=this.object.rows,c=this.summary.old_state,d=0;d<b.length;d++)b[d].hidden&&!c[d]?b[d].unhide():!b[d].hidden&&c[d]&&b[d].hide();this.object.layoutRows()},Me.prototype.redo=function(a){for(var b=this.object.rows,c=this.summary.new_state,d=0;d<b.length;d++)b[d].hidden&&!c[d]?b[d].unhide():!b[d].hidden&&c[d]&&b[d].hide();this.object.layoutRows()},Ne=function(a,b){Fe.call(this,a.subtype),this.summary=a,this.object=b.getElementByID(this.summary.target_id)},ad.inherit(Fe,Ne),Ne.prototype.type="clone",Ee.entryTypes.CloneEntry=Ne,Ne.prototype.undo=function(a){this.links=a.removeElement(this.object)},Ne.prototype.redo=function(a){a.addDL(this.object),nb().addLinks(this.links)},Oe=function(a,b){Fe.call(this,a.subtype),this.summary=a,this.object=b.getElementByID(this.summary.el_id)},ad.inherit(Fe,Oe),Oe.prototype.type="scrub",Ee.entryTypes.ScrubEntry=Oe,Oe.prototype.undo=function(a){var b=this.object.rows[0].model;b.replace_with(new Id(this.summary.old_state,b.settings.getAll()));this.object.rows[0].updateDimensionAfterInteraction(),this.object.updateDims(),this.object.rows[0].view.update_existing()},Oe.prototype.redo=function(a){var b=this.object.rows[0].model;b.replace_with(new Id(this.summary.new_state,b.settings.getAll()));this.object.rows[0].updateDimensionAfterInteraction(),this.object.updateDims(),this.object.rows[0].view.update_existing()},Pe=function(a,b){Fe.call(this,a.subtype),this.summary=a,this.textbox=b.getElementByID(this.summary.el_id)},ad.inherit(Fe,Pe),Pe.prototype.type="edit",Ee.entryTypes.TextEditEntry=Pe,Pe.prototype.match=function(a){return this.type===a.subtype&&"textbox"===a.el_type};Pe.prototype.undo=function(a){this.textbox.setText(this.summary.old_state)},Pe.prototype.redo=function(a){this.textbox.setText(this.summary.new_state)},Qe=function(a,b){Fe.call(this,a.subtype),this.summary=a,this.canvasElement=b.getElementByID(this.summary.el_id)},ad.inherit(Fe,Qe),Qe.prototype.type="resize",Ee.entryTypes.ResizeEntry=Qe,Qe.prototype.match=function(a){return this.type===a.subtype},Qe.prototype.undo=function(a){this.canvasElement.resizeElement(JSON.parse(this.summary.old_state))},Qe.prototype.redo=function(a){this.canvasElement.resizeElement(JSON.parse(this.summary.new_state))},Re=function(a){return Math.sqrt(a[0]*a[0]+a[1]*a[1])},Se=1e-6,Te=function(a,b,c){var d=[b[0]-a[0],b[1]-a[1]],e=Re(d);if(e<Se)return a;var f=[c[0]-a[0],c[1]-a[1]],g=(d[0]*f[0]+d[1]*f[1])/e;return g<0?a:g>e?b:[a[0]+d[0]*g/e,a[1]+d[1]*g/e]},Ue=function(){function a(b){var c=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];id(this,a),this.container=d3.select(b),this.element=null,this.id=c.id||ad.uid(),this.oid=c.oid,this.points=c.points||[],this.color=c.color||"black",this.width=c.width||1,this.type="path",this.init()}return jd(a,[{key:"toJSON",value:function(){return{id:this.id,type:"Path",points:this.points,color:this.color,width:this.width}}},{key:"init",value:function(){var a=null;return this.oid&&(a="#"+this.oid),this.element=this.container.insert("path",a).attr("id",this.id).style("fill","none").style("stroke-linecap","round").style("stroke-linejoin","round"),this.update()}},{key:"update",value:function(){return this.element.attr("d",a.line(this.points)+(1===this.points.length?"Z":"")).style("stroke",this.color).style("stroke-width",this.width),this}},{key:"remove",value:function(){return this.element.remove(),this}},{key:"setContainer",value:function(a){return 0===arguments.length?this.container:(this.container=a,this)}},{key:"renderOnto",value:function(a){var b=this.element,c=this.container;this.container=a,this.element=a.select("#"+this.id),this.element.empty()?this.init():this.update(),this.container=c,this.element=b}}],[{key:"fromJSON",value:function(a,b,c){return c.createPath(a,"load")}}]),a}(),Ue.line="undefined"==typeof d3||void 0===d3.svg?null:d3.svg.line(),Ve=function(){var a=function(a,b){this.container=d3.select("body"),this.controller=a,this.view=b,this.element=null,this.pos=[0,0],this.visible=!1,this.buttons=[],this.button_els=null,this.colors=d3.scale.category10(),this.button_rads=null,this.inner_radius=20,this.outer_radius=80,this.init()};return a.prototype.setPos=function(a){this.pos=a,this.icon.style({left:this.pos[0]+22+"px",top:this.pos[1]-32+"px"}),this.element.style({left:a[0]-this.outer_radius+"px",top:a[1]-this.outer_radius+"px"})},a.prototype.setVisible=function(a){if(this.visible=a,this.icon.style("display",a?null:"none"),this.element.style("display",a?null:"none"),this.visible){var b=this.g.node().getBBox();this.element.style({width:b.width,height:b.height})}},a.prototype.init=function(){var a=this,b={stroke:"black","stroke-width":1,"stroke-linecap":"round",fill:"none"};hd.includes(this.controller.hold_menu_options(),"derivation")&&this.buttons.push({action:function(b){a.controller.inputDL(b,"holdUI")},icon:function(b){a.icon=a.container.append("div").style("position","absolute").style({left:a.pos[0]+25+"px",top:a.pos[1]-35+"px"});var c=new Id("f_x",{});return new te(c,a.icon.node(),{font_size:"35",inactive_color:"black",interactive:!1}).init(),a.icon},color:a.colors(0)}),hd.includes(this.controller.hold_menu_options(),"graph")&&this.buttons.push({action:function(b){a.controller.insertGGB(b)},icon:function(a){var c=a.append("g").attr("transform","translate(2,0)").style("cursor","pointer"),d=c.append("g").style("opacity",.5).style("shape-rendering","crispedges");return d.append("line").attr({x1:-15,y1:0,x2:15,y2:0}).style(b),d.append("line").attr({x1:0,y1:-15,x2:0,y2:15}).style(b),d.append("rect").attr({x:-15,y:-15,width:30,height:30}).style(b),c.append("line").attr({x1:-15,y1:8,x2:15,y2:-8}).style(b).style("stroke-width",1.5),c},color:a.colors(1)}),hd.includes(this.controller.hold_menu_options(),"textbox")&&this.buttons.push({action:function(b){var c={pos:{x:b.x,y:b.y},select_text_on_create:!0};a.view.createElement("textbox",c)},icon:function(a){var c=a.append("g");return c.append("g").style("opacity",.5).append("text").text("Aa").attr({x:0,y:10}).style("text-anchor","middle").style("font-size","30px").style(b).style("stroke","none").style("fill","black").style("pointer-events","none"),c},color:a.colors(2)}),this.button_rads=2*Math.PI/this.buttons.length;var c=this.button_rads,d=this.inner_radius,e=this.outer_radius;this.element=this.container.append("svg").style("overflow","visible").style("display","none").style("position","absolute"),this.g=this.element.append("g").attr("transform","translate("+this.outer_radius+","+this.outer_radius+")");var f=this.element.append("defs"),g=f.append("filter").attr("id","dropShadow_holdUI");g.append("feGaussianBlur").attr("in","SourceAlpha").attr("stdDeviation",3),g.append("feOffset").attr("dx",0).attr("dy",4).attr("result","offsetblur"),g.append("feComponentTransfer").append("feFuncA").attr("type","linear").attr("slope",.25);var h=g.append("feMerge");h.append("feMergeNode"),h.append("feMergeNode").attr("in","SourceGraphic"),this.element.attr("filter","url(#dropShadow_holdUI)"),this.button_els=this.g.selectAll(".holdUI").data(this.buttons),this.button_els.enter().append("g").classed("holdUI",!0).append("path").attr("d",function(a,b){var f=Math.cos(c*b)*d,g=-Math.sin(c*b)*d,h=Math.cos(c*b)*e,i=-Math.sin(c*b)*e,j=Math.cos(c*(b+1))*e,k=-Math.sin(c*(b+1))*e,l=Math.cos(c*(b+1))*d,m=-Math.sin(c*(b+1))*d;return"M"+f+","+g+"L"+h+","+i+"A"+e+","+e+" 0 0,0 "+j+","+k+"L"+l+","+m+"A"+d+","+d+" 0 0,1 "+f+","+g+"Z"}).style("fill",function(a){return a.color}).style("opacity",.8).style("cursor","pointer"),this.button_els.each(function(a,b){var f=d3.select(this);a.icon(f).attr("transform",function(){return"translate("+Math.cos(c*(b+.5))*(d+(e-d)/2)+", "+-Math.sin(c*(b+.5))*(d+(e-d)/2)+")"})})},a.prototype.detectHit=function(a){var b=this,c=this.button_rads,d=this.inner_radius,e=this.outer_radius,f=-1;return this.button_els.each(function(g,h){var i=Math.sqrt(Math.pow(a[0]-b.pos[0],2)+Math.pow(a[1]-b.pos[1],2)),j=Math.atan2(-a[1]+b.pos[1],a[0]-b.pos[0]);j<0&&(j+=2*Math.PI),i>d&&i<e&&j>c*h&&j<c*(h+1)&&(f=h)}),f},a.prototype.highlight=function(a){var b=this.detectHit(a);this.button_els.each(function(a,c){var d=d3.select(this).select("path");b===c?d.transition().duration(30).style("fill",d3.rgb(a.color).brighter(.6)):d.transition().duration(30).style("fill",a.color)})},a.prototype.performAction=function(a,b){var c=this.detectHit(a);this.button_els.each(function(a,d){d===c&&a.action({x:b[0],y:b[1]})})},a}(),ad.IdentificationModal=Sb,Sb.prototype.resetTimer=function(){this.showGlassPane(!1),this.timer_id&&clearTimeout(this.timer_id),this.timer_id=setTimeout(this.showGlassPane.bind(this,!0),this.max_idle_time)},Sb.prototype.showGlassPane=function(a){this.glass_pane.style("display",a?null:"none")},Sb.prototype.init=function(){this.glass_pane&&this.glass_pane.remove(),this.glass_pane=d3.select("body").append("div").style({position:"fixed",top:0,right:0,bottom:0,left:0,"z-index":1e4,display:"none"}).call(V().on("touch",this.show.bind(this))),this.modal&&this.modal.remove(),this.modal=d3.select("body").append("div").attr("class","modal fade").attr("tabindex",-1).attr("role","dialog");var a=this.modal.append("div").attr("class","modal-dialog modal-sm").attr("role","document").append("div").attr("class","modal-content");a.append("div").classed("modal-header",!0).append("h4").classed("modal-title",!0).text("Please tell us who you are!");var b=a.append("div").classed("modal-body",!0),c=b.append("div");this.type_div=c.append("div").classed("form-group",!0).style("margin-bottom",0),this.type_div.append("label").attr({for:"user-id",class:"control-label"}).text("I'm a...");var d={width:"40%",height:"60px"},e=this.type_div.append("div");e.append("button").attr({type:"button",class:"btn btn-default"}).style(d).text("Student").on("click",this.on_choice.bind(this,"student")),e.append("button").attr({type:"button",class:"btn btn-default"}).style(d).style("float","right").text("Tutor").on("click",this.show_id_input.bind(this,!0)),this.id_div=c.append("div").classed("form-group",!0),this.id_div.append("label").attr({for:"user-id",class:"control-label"}).text("My initials & day of birth");var f=this.id_div.append("div").classed("input-group",!0);f.append("input").attr({type:"text",class:"form-control",id:"user-id"}).attr({placeholder:"EM28"}).on("keyup",function(){13===d3.event.keyCode&&(d3.event.preventDefault(),this.on_choice("tutor"))}.bind(this)),f.append("span").classed("input-group-btn",!0).append("button").attr({type:"button",class:"btn btn-default"}).text("OK").on("click",this.on_choice.bind(this,"tutor")),$(this.modal.node()).modal({backdrop:"static",keyboard:!1,show:!1})},Sb.prototype.show_id_input=function(a){this.type_div.style("display",a?"none":null),this.id_div.style("display",a?null:"none"),a&&this.modal.select("#user-id").node().focus()},Sb.prototype.reset=function(){this.modal.select("#user-id").node().value=null,this.show_id_input(!1),this.showGlassPane(!1)},Sb.prototype.on_choice=function(a){var b=this.modal.select("#user-id").node().value,c=!("tutor"!==a||b&&/^[a-zA-Z]{2,3}[0-9]{1,2}$/.test(b));this.id_div.classed("has-error",c),c||(this.events.identified({type:a,id:b}),$(this.modal.node()).modal("hide"),this.resetTimer())},Sb.prototype.show=function(){this.reset(),$(this.modal.node()).modal("show")},Tb.prototype.getVideoInfo=function(a){var b=new XMLHttpRequest;b.videoModal=this,b.onreadystatechange=function(){if(4===b.readyState&&200===b.status){var c=void 0;try{c=JSON.parse(b.responseText)}catch(a){return void console.log("could not parse youtube response: ",a)}this.videoInfo[a]={title:c.items[0].snippet.title,desc:c.items[0].snippet.description}}}.bind(this);var c="https://www.googleapis.com/youtube/v3/videos?part=snippet,contentDetails&id="+a+"&key=AIzaSyCKInAs_T5Ujjg-brjkx5Pj1wafSzxjGHE";b.open("GET",c,!0),b.send()},Tb.prototype.remove=function(){this.resetTimer(),this.modal&&this.modal.remove(),this.player&&this.player.destroy&&this.player.destroy()},Tb.prototype.unMute=function(){this.player&&this.player.unMute()},Tb.prototype.mute=function(){this.player&&this.player.mute()},Tb.prototype.getVolume=function(){return this.volume},Tb.prototype.setVolume=function(a){this.target_volume=a,this.max_volume=null,this.updateVolume()},Tb.prototype.reduceVolume=function(a){this.max_volume=a,this.target_vol=null,this.updateVolume()},Tb.prototype.updateVolume=function(){if(this.player){var a=this.player.getPlayerState();1!==a&&5!==a||(this.volume=this.player.getVolume(),null!==this.max_volume&&this.volume>this.max_volume&&(this.target_volume=this.max_volume,this.max_volume=null),null!==this.target_volume&&(this.player.setVolume(this.target_volume),this.volume=this.target_volume,this.target_volume=null))}},Tb.prototype.playSingle=function(a){this.player&&(this.single_video_mode=!0,this.player.setLoop(!1),this.videoInfo[a]||this.getVideoInfo(a),this.player.loadVideoById({videoId:a}),this.visible||this.showDialog())},Tb.prototype.cueVideoList=function(a){var b=this;0!==a.length&&(this.single_video_mode=!1,a.forEach(function(a){b.videoInfo[a]||b.getVideoInfo(a)}),this.player.cuePlaylist(a,0,0),this.player.setLoop(!0),this.player.setShuffle(!0))},Tb.prototype.createPlayer=function(a){return ze.loaded?"undefined"!=typeof YT&&YT&&YT.Player?void(this.player=new YT.Player("gm_video_div"+this.id,{playerVars:{rel:0,enablejsapi:1},height:this.video_size.height,width:this.video_size.width,events:{onReady:a.bind(this),onStateChange:this.onPlayerStateChange.bind(this)}})):void console.warn("Error loading Youtube player."):void ze.loadYTScript(this.createPlayer.bind(this,a))},Tb.prototype.pauseAtEnd=function(){var a=this;clearInterval(this.startTimer),this.player.getCurrentTime()>this.currentVideoDuration-.5&&(clearInterval(this.endTimer),this.player.pauseVideo(),this.single_video_mode||(this.startTimer=setTimeout(function(){a.player.playVideo()},3e3)))},Tb.prototype.onPlayerStateChange=function(a){var b=this;if(clearInterval(this.endTimer),1===a.data){var c=this.player.getVideoData().video_id,d=this.videoInfo[c];this.titleEl.text(d?d.title:""),this.currentVideoDuration=this.player.getDuration(),this.endTimer=setInterval(function(){b.pauseAtEnd()},250)}this.updateVolume()},Tb.prototype.resetTimer=function(){this.max_idle_time&&(this.timer_id&&clearTimeout(this.timer_id),this.timer_id=setTimeout(this.showDialog.bind(this,!0),this.max_idle_time))},Tb.prototype.init=function(){this.modal&&this.modal.remove(),this.modal=d3.select("body").append("div").classed("modal fade",!0).attr("role","dialog").style("display","none");var a=this.modal.append("div").attr("class","modal-dialog").style({position:"relative",display:"table","overflow-y":"auto","overflow-x":"auto",width:"auto"}).attr("role","document").append("div").attr("class","modal-content"),b=a.append("div").classed("modal-header",!0).style("padding-left","25px").style("padding-right","25px");b.append("button").attr("type","button").classed("close",!0).attr("data-dismiss","modal").style("font-size","28px").html("&times;"),this.titleEl=b.append("h3").classed("modal-title",!0).style("font-size","18px").text("Working with Graspable Math"),a.append("div").classed("modal-body",!0).append("div").attr("id","gm_video_div"+this.id),$(this.modal.node()).modal({show:!1}),$(this.modal.node()).on("hidden.bs.modal",function(){this.visible=!1,this.player&&(this.player.seekTo(0),this.player.pauseVideo(),this.single_video_mode&&this.cueVideoList(this.sources)),this.resetTimer(),clearInterval(this.startTimer),clearInterval(this.endTimer)}.bind(this))},Tb.prototype.showDialog=function(){if(this.timer_id&&clearTimeout(this.timer_id),!this.player)return void setTimeout(this.showDialog.bind(this),1e3);this.visible||(this.player.setSize(.8*window.innerWidth,.8*window.innerHeight-60),$(this.modal.node()).modal("show"),this.visible=!0,this.single_video_mode||this.player.playVideo())},We=void 0,Xe=void 0,Ye=void 0,Ze={derivation:{label:"Math Expression",value:"derivation",icon:"imgs/menu-icons/sqrt-x.png"},homework:{label:"Homework Problem",value:"homework",class:"glyphicon glyphicon-book",cond:function(a){return a.settings.get("homework_btn")}},textbox:{label:"Text",value:"textbox",icon:"imgs/menu-icons/text.png"},video:{label:"Youtube Video",value:"video",class:"glyphicon glyphicon-film"},ggb:{label:"Graph",value:"ggb",icon:"imgs/menu-icons/geogebra.svg"},table:{label:"Table",value:"table",icon:null},"ggb-table":{label:"Table-Graph",value:"ggb-table",icon:"imgs/menu-icons/geogebra.svg"}},$e=[],_e=!1,af=function(a){function b(a,c){var d=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],e=arguments.length<=3||void 0===arguments[3]?null:arguments[3];id(this,b);var f=pd(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,a,c,d,"GeoGebraElement"));return f.type="ggb-element",f.events=ad.extend(f.events,d3.dispatch("ggb_add","ggb_remove","ggb_update","ggb_rename","ggb_click","ggb_init")),f.toolbar_height_correction=0,f.ggb_objs=[],f.adding_ggb_object_for_row=void 0,f.dont_update=void 0,f.links=[],f.ggbApplet=null,f.init(e),f.initPosition(),f}return qd(b,a),jd(b,[{key:"init",value:function(a){this.element_div.style("overflow","hidden"),this.div=this.element_div.append("div").attr("id","ggbApplet"+this.id).style("margin-left","-1px").style("margin-top","-1px");var b=function(){var a=ad.object.merged(this.settings.get("ggb_params"),{width:this.size.width,height:this.size.height,id:this.id});this.settings.get("ggb_base64")&&(a.ggbBase64=this.settings.get("ggb_base64")),this.ggbLoader=new GGBApplet(a,"5.0",this.settings.get("ggb_views")),this.ggbLoader.inject("ggbApplet"+this.id)},c=window.ggbOnInit;window.ggbOnInit=function(b){if(b!==this.id)return void c(b);this.settings.get("ggbBase64")&&this.ggbApplet.setBase64(this.settings.get("ggbBase64")),this.ggbApplet=this.ggbLoader.getAppletObject(),this.ggbApplet.registerUpdateListener(this.events.ggb_update.bind(this)),this.ggbApplet.registerAddListener(this.events.ggb_add.bind(this)),this.ggbApplet.registerRemoveListener(this.events.ggb_remove.bind(this)),this.ggbApplet.registerRenameListener(this.events.ggb_rename.bind(this)),this.ggbApplet.registerClickListener(this.events.ggb_click.bind(this)),setTimeout(function(){this.div.selectAll("*").style("box-sizing","content-box","important"),this.subTypeResize(),a&&a(this)}.bind(this),1),this.events.ggb_init(this),app=this.ggbApplet}.bind(this),Xb(b.bind(this))}},{key:"showToolBar",value:function(a){if(this.ggbApplet){var b=JSON.parse(this.ggbApplet.getViewProperties());if(this.settings.get("toolbar_visible")!==a){this.ggbApplet.showToolBar(a),this.settings.set("toolbar_visible",a),this.toolbar_height_correction=a?0:64,this.ggbApplet.showToolBar(a);var c=a?-42:64,d=b.invYscale,e=b.xMin,f=b.xMin+b.width*b.invXscale,g=b.yMin+c*d,h=b.yMin+b.height*d+c*d;this.ggbApplet.setCoordSystem(e,f,g,h),this.subTypeResize()}}}},{key:"subTypeResize",value:function(){this.ggbApplet.setWidth(this.size.width),this.ggbApplet.setHeight(this.size.height+this.toolbar_height_correction)}},{key:"toJSON",value:function(){return{type:"GeoGebraCanvasElement",id:this.id,pos:ad.deepCopy(this.pos),size:ad.deepCopy(this.size),ggb_base64:this.ggbApplet.getBase64()}}}],[{key:"fromJSON",value:function(a,b,c){return c.createElement("ggb-element",a)}}]),b}(ve),new md("GeoGebraElement").defaults.setAll(md.get("CanvasElement").defaults.getAll()).setAll({type:"GeoGebraCanvasElement",resizable:{x:!0,y:!0},min_size:{width:300,height:300},edit_mode_drag_box_width:-20,bg_edit_style:{border:"1px solid silver"},ggb_params:{showMenuBar:!1,showAlgebraInput:!1,showToolBar:!0,showResetIcon:!1,enableLabelDrags:!1,enableShiftDragZoom:!1,enableRightClick:!0,errorDialogsActive:!1,useBrowserForJS:!0,preventFocus:!1,language:"en"},ggb_base64:"UEsDBBQACAgIAPloRUkAAAAAAAAAAAAAAAAXAAAAZ2VvZ2VicmFfZGVmYXVsdHMyZC54bWztml9z4jYQwJ97n0Ljp/YhYBsMJBNyw91Mp5nJ5TJN5qavwl6MGllyJTmYfPrKkrFNEihnaJLL5QV5Zf397Wq1kjn9mCcU3YGQhLOx43VcBwELeURYPHYyNTsaOR/PPpzGwGOYCoxmXCRYjZ2gKFnV01LHHx4XeSiX5ITxS5yATHEI1+EcEnzBQ6xM0blS6Um3u1gsOqtGO1zE3ThWnVxGDtIDYnLslA8nurm1SoueKe67rtf968uFbf6IMKkwC8FBerARzHBGldSPQCEBppBapjB2Uk6YchDFU6Bj56qQ0K8zAfCbg8pKmoHrnH345VTO+QLx6d8Q6jwlMqjqGaFblNGvP3PKBRJjR089Nr/TseMHgYMwTee4yDFFKV6CQHeYVjk4Uzw0tU3uDFMJq7K6ny88AvumX5ZnJDEMkVSQ6nE6SKYAkXmy89MPqe7I6K7RXsi5iCTKx84lvnTQskzvbWqKGDLX5L7sMmjmqiWFxshPuyXU3fBGkAKLdKE1xl4rxoORgVwkU5v8yJB7h4L8lTXR+q3Qen5g2Jr03YQbdM/ZnxDrMTcZ994ZH5TxugX3f0IHbIpYhrL4HTshT1IK+QHBU8JqiBdGqKD7++967osgd1sjL3BYeGpOwlsGUocdfqPd4uEPEunNq+jP1IF/2JqSiNYRCYnaDl5CXEgVy+uVXONvtyH+bPh5pmjR1zlTOvTUlPTY5KPJ3AKkN7ryV3YjMJNFyGrLrCBu1tQsY6bRy29YVOwzHb/M9GijpsLabQEbnVTHD15aa/9NZTuR/d32qzLh77fPzQAFXm5b/MHbIvejLv473Savl/23Uqz01HvfI3fR0xOhDBYKJMFsO/+QMxJWMD9bqaLff2P0W4UfJAZmzVQilLuml6Vrit+75f1N7hl56Zm3957NNvX1UAXJ0cTWmNiCE98mPZv0bRJUSNrFPEaZqVZ8w/E9WE/9dkGPF/SMTgPvoVI73rtaD6LWZ3C2LEtANJb75UquzCOwC163l8GaMndY3itL2Kx3SUmkjSQhWg1HOhBLcF6cqxCeSk4zBdehAGD1vaU1zAWJ1Lw4Lem+ZiQvDMK+mHNB7jlT1eRRYdYTai44m5bcxj4eWmMxvX1jOsxiWq+0iZVq9vYWyRR6eMB8SiVNmm4Jc9DxRz1vFPTcoTc8DkaDHeF6o9Zw11yJhbDL7uC5Gw1of1fyXQr3yz5E2LgndDdZgTsa+oNBf+AHx8dDb9AfHj7S/73KqGxj8BIbcWMBPYfD7rWL83c+Pg7ahfy+29/g74av+PiYcrqMGzZ1tZIrHENrUm1841uKHrYjXLu+u6oyaojes0F8pUH1lqtPHmayvvu0UkVu9MaOFjjLCSVYLB/3dMBLDQV5HdzfGKHxEfUVIt08FQ06rod2bqXG10o7mRnR3BhOdAXbCWGfcHgbC65d/OMA8yBTf8U+aco5BVy79U8rufEt8lEIvwnQ7sHa/7bewjmEt1Oer8We270KkfUKuDBC4xvhEytgn5D0qDSFaVyHA4H9oGjSBzfKxfOLO6I2e9Fun7qOHjmnbuNvH93VX0vO/gVQSwcIGNrQjpgEAADhIgAAUEsDBBQACAgIAPloRUkAAAAAAAAAAAAAAAAXAAAAZ2VvZ2VicmFfZGVmYXVsdHMzZC54bWztlslu2zAQhs/NUxC8R6sVx4GVwEgPLZAELXLplZbGMluJVEgqlvNqfYc+U7nIiuw4AWKkaIv2wuEyw+X7yZGmF21VonsQknKW4tALMAKW8ZyyIsWNWhyf4ovzo2kBvIC5IGjBRUVUihPj2cfplheNJ6YPtZKeMX5DKpA1yeA2W0JFrnhGlHVdKlWf+f5qtfI2k3pcFH5RKK+VOUZ6Q0ymuKuc6em2glaxdY+CIPS/XF+56Y8pk4qwDDDSm81hQZpSSV2FEipgCql1DSkmLZWxXqIkcyhTPDPN9xh1/imOwyDG50fvpnLJV4jPv0Kme5VooI+xDd/46OFLXnKBRIr1uQtbzm1JynpJTM06lmQNAt2Tsu8hjeKZjbW9C1JK2PjqVa55Dm5k1PkzWll8SCqotUwYyRogtzV3NL1qrReysg3nowxu1boEpJY0+8ZAarTRIMhUPtA8B6O+i4E75kKkKVNcE6HFVIJmeg1XB33mH9+N+9TvED+BnTXiHjIiFEhK2AD7pRnY5X7yr3N/ASRnNBvw+8g0f6kRmY1Zylsok+AglFGSWJhhNN7F6YV/I1B9kWkBTN9BxYXUeSmwq6wD6/4QdNmuDW17HdrRh9B123i9VUFbNHMRM+c4i5yJnRk5k/RIdl8PreqSZlS9rLE+MoOBxp9se+uN6Ix3kLCTidU1CidWV2t7ZZO3UjbjXOQStQ6mQ2zLVT/lgpivSrdKf6f26Roc9lBqXq6XkAvOHjkOuh5Rxh3KQy7Va/GHSWz5J+GTZzX63c/qeZR3Dcltwu/O9nnTHkIMD0s0wWh/1vbGb3Ybf0W22JsrTKdLCGtnHqJ+wtemDzQ7cWbszKkzk47C82LJRiz0n9a+b203tK3b6I/V7Y2/D+FheYSB6lncmPoQXvI/c+zA8wf/2/7mn/78J1BLBwiOET9GtAIAAFoMAABQSwMEFAAICAgA+WhFSQAAAAAAAAAAAAAAABYAAABnZW9nZWJyYV9qYXZhc2NyaXB0LmpzSyvNSy7JzM9TSE9P8s/zzMss0dBUqK4FAFBLBwjWN725GQAAABcAAABQSwMEFAAICAgA+WhFSQAAAAAAAAAAAAAAAAwAAABnZW9nZWJyYS54bWy1V19v2zYQf24/xUHPjk1Sov4Udoq2wIACWVEs3TDsTZYYmYgsGSJtJ0M//O5ISZaTpmuazTFD8ni8u9/dkUcv395taziozui2WQV8zgJQTdGWuqlWwd7eXKTB28vXy0q1lVp3Ody03Ta3q0AS57gPZ3ORZETT5SpIyzLjaRJepEqwiyhNoot1UmQXRciLcs3YTSKRE+6MftO0n/KtMru8UNfFRm3zq7bIrRO6sXb3ZrE4Ho/zQf287apFVa3nd6YMAE1vzCroB29Q3NmmY+jYBWN88eevV178hW6MzZtCBUCw9vry9avlUTdle4SjLu1mFcQMjdsoXW0QZ0STBTHtEOxOFVYflMGtk6nDbLe7wLHlDa2/8iOoRzgBlPqgS9WtAjYPH3wCaDutGtvz8l7nYpC2PGh19GJp5DRGLEswBtroda1WwU1eG0Slm5sOPYoGdXucGntfq3XeDfOTPXzm/pBF/616oN4RuMZCNotkOksYm0nZu2CiW3IRgG3b2olm8BU4SIYNeAYziBOkCOASIqSkSEkgJJrkEYRALDyEKMI+IjKPaU3ifsmAcySDYCAECA4ixKmUIGOQCW0UyBtnThjDRtxoDraQaGGIzdHCCJugEQqSXgwaIcPYjSRxo3wpyHxHDFOIMlREBJlwCNEGnCcMUGJI4rkDETGgL4eIxIsERAooD3GTZCa+E5V+fgpLT3gQlyEq8jwqbEYNE3Q25uU0Ic5DghFgiG1GHfcdmRvHfol5Ggt9J3wX+U56nshvjzyrR8sizxOFL4U5gAyfAzKdgOQEAoNC1rsuBLKbO/upi/pp7Kcu1RhnPTWlfxlN0Cdx6gYvxBT+FCY+0eqP6XOUjrmSpT+u8mU5OsIU34Ip5BMwX+jdQSmXE6Woy31de6QyfBbOR1fkT2iMz07hS+7nn1DORfoMjU97OEp/WGXCvnnr+J73/fei8H/44aV30+iHf1G5XAx1edn7AMyGePtTbNXWkFfCbKyQMdWwvkwmAhIJSTwpljMql7E8VUyql+lZxZTppGxizYyJmLgajJqo6PkSKqKhis76Ovr1UR3FshedKh8aSKLoTu1LH2oX0+In8KJEo6lmYCWnOxMEihSANTOmfU/UxQB2rdGjdzeq3o1+d47UzW5ve+f19GJbDo60LbLntXsD9hvKtrh9P/q736JyY6dy8QF1eqb5B9XZK+7Vss7XqsbH7jVlA8Ahr+nUOg03bWNhyD0ROHHuwbhU+6LWpc6bPzD6w+vs0367Vh24YUsonRDaDsPL0t3Qw8syDCPPUrRtV17fG0wWuPtLdbhZZDKAez/mcTTPph989Jkip8yOsvMVlH7/5JLTpQ7XylrEayC/U2bwb9XRqen9RpOP5n1bn0i7Vjf2Q76z+879MMDj1RGKd01VK+c6F1Z8YRe36/bu2teG2Mv6cr9To1PX1Ye2bjvAYyckgqz6fu17x0OWjVzM8TDH0csgoeM6z4TjcP3a944Lo+pN65HyASYbtGgDfn52aF1G0HN932h7NUysLm5PQInfx3tw4blI/h+JXC4epNryVnWNqn3aNBjIfbs3Pmt9qJwde6M+53bzril/UxWeuc853XwWRXvWk8WlKvQWN3p677mcovo7muqppao6NSD0Z9D7tT8sYHadykuzUcqO3vVJPWU7if6la7cfm8MXTKEHpi8XA76lKTq9o0yFNV7Mt+qUjKU2OV7s5XQfOsMgqoJuGHSsJacGkO/tpu3cT6/cEoU0TFndke5/W17+A1BLBwgbJvAVKgUAAAwPAABQSwECFAAUAAgICAD5aEVJGNrQjpgEAADhIgAAFwAAAAAAAAAAAAAAAAAAAAAAZ2VvZ2VicmFfZGVmYXVsdHMyZC54bWxQSwECFAAUAAgICAD5aEVJjhE/RrQCAABaDAAAFwAAAAAAAAAAAAAAAADdBAAAZ2VvZ2VicmFfZGVmYXVsdHMzZC54bWxQSwECFAAUAAgICAD5aEVJ1je9uRkAAAAXAAAAFgAAAAAAAAAAAAAAAADWBwAAZ2VvZ2VicmFfamF2YXNjcmlwdC5qc1BLAQIUABQACAgIAPloRUkbJvAVKgUAAAwPAAAMAAAAAAAAAAAAAAAAADMIAABnZW9nZWJyYS54bWxQSwUGAAAAAAQABAAIAQAAlw0AAAAA",ggb_views:{is3D:0,AV:0,SV:0,CV:0,EV2:0,CP:0,PC:0,DA:0,FI:0,PV:0,macro:0},toolbar_visible:!0}),bf=[{title:"Chapter 1 Fundamental Concepts of Algebra",subchapters:[{title:"1.1 Real Numbers",problems:[{num:1,video:"v9PrVQlKBDQ",text:"If <i>x</i> < 0 and <i>y</i> > 0, determine the sign of the real number.",alignment:"row",parts:[{type:"derivation",options:{eq:"xy"},label:!0},{type:"derivation",options:{eq:"x^2y"},label:!0},{type:"derivation",options:{eq:"x/y+x"},label:!0},{type:"derivation",options:{eq:"y-x"},label:!0}]},{num:"3, 5",text:"We're not yet supporting these problems. Please see p. 13 in the textbook.",alignment:null,parts:[]},{num:7,text:"Express the statement as an inequality.",alignment:"column",parts:[{type:"textbox",options:{text:"<i>x</i> is negative."},label:!0},{type:"textbox",options:{text:"<i>y</i> is nonnegative."},label:!0},{type:"textbox",options:{text:"<i>q</i> is less than or equal to <i></i>."},label:!0},{type:"textbox",options:{text:"<i>d</i> is between 4 and 2."},label:!0},{type:"textbox",options:{text:"<i>t</i> is not less than 5."},label:!0}]},{num:9,video:"g_sB-B4GbiI",text:"Rewrite the number without using the absolute value symbol, and simplify the result.",alignment:"row",parts:[{type:"derivation",options:{eq:"|-3-2|"},label:!0},{type:"derivation",options:{eq:"|-5|-|2|"},label:!0},{type:"derivation",options:{eq:"|7|+|-4|"},label:!0}]},{num:11,text:"Rewrite the number without using the absolute value symbol, and simplify the result.",alignment:"row",parts:[{type:"derivation",options:{eq:"(-5)*|3-6|"},label:!0},{type:"derivation",options:{eq:"|-6|/(-2)"},label:!0},{type:"derivation",options:{eq:"|-7|+|4|"},label:!0}]},{num:13,text:"Rewrite the number without using the absolute value symbol, and simplify the result.",alignment:"row",parts:[{type:"derivation",options:{eq:"|4-|"},label:!0},{type:"derivation",options:{eq:"|-4|"},label:!0},{type:"derivation",options:{eq:"|sqrt2-1.5|"},label:!0}]},{num:15,text:"We're not yet supporting this problem. Please see p. 14 in the textbook.",alignment:null,parts:[]},{num:19,text:"The two given numbers are coordinates of points <i>A</i> and <i>B</i>, respectively, on a coordinate line. Express the indicated statement as an inequality involving the absolute value symbol.",alignment:"row",parts:[{type:"derivation",options:{eq:"x"},label:!1},{type:"derivation",options:{eq:"7"},label:!1},{type:"textbox",options:{text:"<i>d</i>(<i>A</i>, <i>B</i>) is less than 5"},label:!1}]},{num:23,text:"The two given numbers are coordinates of points <i>A</i> and <i>B</i>, respectively, on a coordinate line. Express the indicated statement as an inequality involving the absolute value symbol.",alignment:"row",parts:[{type:"derivation",options:{eq:"4"},label:!1},{type:"derivation",options:{eq:"x"},label:!1},{type:"textbox",options:{text:"<i>d</i>(<i>A</i>, <i>B</i>) is not greater than 3"},label:!1}]},{num:25,text:"Rewrite the expression without using absolute the value symbol, and simplify the result.",alignment:"row",parts:[{type:"derivation",options:{eq:"|3+x|"},label:!1},{type:"textbox",options:{text:"if <i>x</i> < -3"},label:!1}]},{num:27,text:"Rewrite the expression without using the absolute value symbol, and simplify the result.",alignment:"row",parts:[{type:"derivation",options:{eq:"|2-x|"},label:!1},{type:"textbox",options:{text:"if <i>x</i> < 2"},label:!1}]},{num:29,text:"Rewrite the expression without using the absolute value symbol, and simplify the result.",alignment:"row",parts:[{type:"derivation",options:{eq:"|a-b|"},label:!1},{type:"textbox",options:{text:"if <i>a</i> < b"},label:!1}]},{num:31,text:"Rewrite the expression without using the absolute value symbol, and simplify the result.",alignment:"row",parts:[{type:"derivation",options:{eq:"|x^2+4|"},label:!1}]},{num:"33-53",text:"We're not yet supporting these problems. Please see p. 14 in the textbook.",alignment:null,parts:[]},{num:57,text:"Avogadro's number",alignment:null,parts:[{type:"textbox",options:{text:"The number of hydrogen atoms in a mole is Avogadro's number, 6.02 x 10<sup>23</sup>. If one mole of the gas has a mass of 1.01 grams, estimate the mass of a hydrogen atom."},label:!1}]},{num:59,text:"Frames in a movie film",alignment:null,parts:[{type:"textbox",options:{text:"One of the longest movies ever made is a 1970 British film that runs for 48 hours. Assuming that the film speed is 24 frames per second, approximate the total number of frames in this film. Express your answer in scientific form."},label:!1}]},{num:61,text:"Tornado pressure",alignment:"column",parts:[{type:"textbox",options:{text:"When a tornado passes near a building, there is a rapid drop in the outdoor pressure and the indoor pressure does not have time to change. The resulting difference is capable of causing an outward pressure of 1.4 lb/in<sup>2</sup> on the walls and ceiling of the building."},label:!1},{type:"textbox",options:{text:"Calculate the force in pounds exerted on 1 square foot of a wall."},label:!0},{type:"textbox",options:{text:"Estimate the tons of force exerted on a wall that is 8 feet high and 40 feet wide."},label:!0}]}]},{title:"1.2 Exponents and Radicals",problems:[{num:3,video:"0eOEimfwMRw",text:"Express the number in the form <i>a</i>/<i>b</i>, where <i>a</i> and <i>b</i> are integers.",alignment:null,parts:[{type:"derivation",options:{eq:"2^-3/3^-2"},label:!1}]},{num:5,video:"c1TznaPYwdA",text:"Express the number in the form <i>a</i>/<i>b</i>, where <i>a</i> and <i>b</i> are integers.",alignment:null,parts:[{type:"derivation",options:{eq:"-2^4+3^-1"},label:!1}]},{num:7,video:"qrSUsQT0LgA",text:"Express the number in the form <i>a</i>/<i>b</i>, where <i>a</i> and <i>b</i> are integers.",alignment:null,parts:[{type:"derivation",options:{eq:"16^(-3/4)"},label:!1}]},{num:9,video:"OMCkg6DllNE",text:"Express the number in the form <i>a</i>/<i>b</i>, where <i>a</i> and <i>b</i> are integers.",alignment:null,parts:[{type:"derivation",options:{eq:"(-0.008)^(2/3)"},label:!1}]},{num:13,text:"Simplify.",alignment:null,parts:[{type:"derivation",options:{eq:"((2x^3)(3x^2))/(x^2)^3"},label:!1}]},{num:15,text:"Simplify.",alignment:null,parts:[{type:"derivation",options:{eq:"(1/6a^5)(-3a^2)(4a^7)"},label:!1}]},{num:21,text:"Simplify.",alignment:null,parts:[{type:"derivation",options:{eq:"(8x^4y^-3)(1/2x^-5y^2)"},label:!1}]},{num:25,text:"Simplify.",alignment:null,parts:[{type:"derivation",options:{eq:"(3y^3)^4(4y^2)^-3"},label:!1}]},{num:29,text:"Simplify.",alignment:null,parts:[{type:"derivation",options:{eq:"(5x^2y^-3)(4x^-5y^4)"},label:!1}]},{num:31,text:"Simplify.",alignment:null,parts:[{type:"derivation",options:{eq:"((3x^5y^4)/(x^0y^-3))^2"},label:!1}]},{num:35,text:"Simplify.",alignment:null,parts:[{type:"derivation",options:{eq:"(3x^(5/6))(8x^(2/3))"},label:!1}]},{num:39,text:"Simplify.",alignment:null,parts:[{type:"derivation",options:{eq:"(8x^(-2/3))x^(1/6)"},label:!1}]},{num:41,text:"Simplify.",alignment:null,parts:[{type:"derivation",options:{eq:"((-8x^3)/y^-6)^(2/3)"},label:!1}]},{num:43,text:"Simplify.",alignment:null,parts:[{type:"derivation",options:{eq:"(x^6/(9y^-4))^(-1/2)"},label:!1}]},{num:45,text:"Simplify.",alignment:null,parts:[{type:"derivation",options:{eq:"(x^6y^3)^(-1/3)/(x^4y^2)^(-1/2)"},label:!1}]},{num:49,text:"Rewrite the expression using rational exponents.",alignment:null,parts:[{type:"derivation",options:{eq:"sqrt[3]{(a+b)^2}"},label:!1}]},{num:51,text:"Rewrite the expression using rational exponents.",alignment:null,parts:[{type:"derivation",options:{eq:"sqrt{x^2+y^2}"},label:!1}]},{num:53,text:"Rewrite the expression using a radical.",alignment:"row",parts:[{type:"derivation",options:{eq:"4x^(2/3)"},label:!0},{type:"derivation",options:{eq:"(4x)^(3/2)"},label:!0}]},{num:55,text:"Rewrite the expression using a radical.",alignment:"row",parts:[{type:"derivation",options:{eq:"8-y^(1/3)"},label:!0},{type:"derivation",options:{eq:"(8-y)^(1/3)"},label:!0}]},{num:65,text:"Simplify the expression, and rationalize the denominator when appropriate.",alignment:null,parts:[{type:"derivation",options:{eq:"sqrt[3]{8a^6b^-3}"},label:!1}]},{num:67,text:"Simplify the expression, and rationalize the denominator when appropriate.",alignment:null,parts:[{type:"derivation",options:{eq:"sqrt{(3x)/(2y^3)}"},label:!1}]},{num:69,text:"Simplify the expression, and rationalize the denominator when appropriate.",alignment:null,parts:[{type:"derivation",options:{eq:"sqrt[3]{(2x^4y^4)/(9x)}"},label:!1}]},{num:71,text:"Simplify the expression, and rationalize the denominator when appropriate.",alignment:null,parts:[{type:"derivation",options:{eq:"sqrt[4]{(5x^8y^3)/(27x^2)}"},label:!1}]},{num:73,text:"Simplify the expression, and rationalize the denominator when appropriate.",alignment:null,parts:[{type:"derivation",options:{eq:"sqrt[5]{(5x^7y^2)/(8x^3)}"},label:!1}]},{num:77,text:"Simplify the expression, and rationalize the denominator when appropriate.",alignment:null,parts:[{type:"derivation",options:{eq:"sqrt[5]{(8x^3)/y^4}*sqrt[5]{(4x^4)/y^2}"},label:!1}]},{num:79,text:"Simplify the expression, and rationalize the denominator when appropriate.",alignment:null,parts:[{type:"derivation",options:{eq:"sqrt[3]{3t^4v^2}*sqrt[3]{-9t^-1v^4}"},label:!1}]},{num:81,text:"Simplify the expression, assuming <i>x</i> and <i>y</i> may be negative.",alignment:null,parts:[{type:"derivation",options:{eq:"sqrt{x^6y^4}"},label:!1}]},{num:83,text:"Simplify the expression, assuming <i>x</i> and <i>y</i> may be negative.",alignment:null,parts:[{type:"derivation",options:{eq:"sqrt[4]{x^8(y-1)^12}"},label:!1}]},{num:"85-93",text:"We're not yet supporting these problems. Please see p. 26 in the textbook.",alignment:null,parts:[]},{num:95,text:"Savings account",alignment:null,parts:[{type:"textbox",options:{text:"One of the oldest banks in the United States is the Bank of America, founded in 1812. If $200 had been deposited at that time into an account that paid 4% annual interest, then 180 years later the amount would have grown to 200(1.04)<sup>180</sup> dollars. Approximate this amount to the nearest cent."},label:!1}]},{num:"97-99",text:"We're not yet supporting this problem. Please see p. 26 in the textbook.",alignment:null,parts:[]}]},{title:"1.3 Algebraic Expressions",problems:[{num:3,text:"Express as a polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"(4x^3+5x-3)-(3x^3+2x^2+5x-7)"},label:!1}]},{num:9,text:"Express as a polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"(2u+3)(u-4)+4u(u-2)"},label:!1}]},{num:11,video:"pW8bpElusWc",text:"Express as a polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"(3x+5)(2x^2+9x-5)"},label:!1}]},{num:13,text:"Express as a polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"(t^2+2t-5)(3t^2-t+2)"},label:!1}]},{num:15,text:"Express as a polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"(x+1)(2x^2-2)(x^3+5)"},label:!1}]},{num:19,video:"PEx7hbOVD1g",text:"Express as a polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"(3u^3v^4-2u^5v^2+(u^2v^2)^2)/(u^3v^2)"},label:!1}]},{num:25,text:"Express as a polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"(x^2+9)(x^2-4)"},label:!1}]},{num:29,text:"Express as a polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"(x^2-3y^2)^2"},label:!1}]},{num:37,text:"Express as a polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"(x-2y)^3"},label:!1}]},{num:39,text:"Express as a polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"(2x+3y)^3"},label:!1}]},{num:43,text:"Express as a polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"(2x+y-3z)^2"},label:!1}]},{num:51,text:"Factor the polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"15x^3y^5-25x^4y^2+10x^6y^4"},label:!1}]},{num:57,text:"Factor the polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"6x^2+7x-20"},label:!1}]},{num:65,text:"Factor the polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"45x^2+38xy+8y^2"},label:!1}]},{num:69,text:"Factor the polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"z^4-64w^2"},label:!1}]},{num:73,text:"Factor the polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"x^2+25"},label:!1}]},{num:77,text:"Factor the polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"64x^3+27"},label:!1}]},{num:79,text:"Factor the polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"64x^3-y^6"},label:!1}]},{num:81,text:"Factor the polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"343x^3+y^9"},label:!1}]},{num:83,text:"Factor the polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"125-27x^3"},label:!1}]},{num:85,text:"Factor the polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"2ax-6bx+ay-3by"},label:!1}]},{num:87,text:"Factor the polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"3x^3+3x^2-27x-27"},label:!1}]},{num:89,text:"Factor the polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"x^4+2x^3-x-2"},label:!1}]},{num:91,text:"Factor the polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"a^3-a^2b+ab^2-b^3"},label:!1}]},{num:93,text:"Factor the polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"a^6-b^6"},label:!1}]},{num:95,text:"Factor the polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"x^2+4x+4-9y^2"},label:!1}]},{num:97,text:"Factor the polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"y^2-x^2+8y+16"},label:!1}]},{num:99,text:"Factor the polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"y^6+7y^3-8"},label:!1}]},{num:101,text:"Factor the polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"x^16-1"},label:!1}]}]},{title:"1.4 Fractional Expressions",problems:[{num:3,text:"Write the expression as a simplified rational number.",alignment:null,parts:[{type:"derivation",options:{eq:"5/24-3/20"},label:!1}]},{num:13,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"(5a^2+12a+4)/(a^4-16)/(25a^2+20a+4)/(a^2-2a)"},label:!1}]},{num:21,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"(3t)/(t+2)+(5t)/(t-2)-40/(t^2-4)"},label:!1}]},{num:25,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"(2x)/(x+2)-8/(x^2+2x)+3/x"},label:!1}]},{num:31,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"((2x+1)/(x^2+4x+4))-((6x)/(x^2-4))+3/(x-2)"},label:!1}]},{num:33,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"(b/a-a/b)/(1/a-1/b)"},label:!1}]},{num:35,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"(x/y^2-y/x^2)/(1/y^2-1/x^2)"},label:!1}]},{num:37,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"(y^-1+x^-1)/(xy)^-1"},label:!1}]},{num:39,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"(5/(x+1)+(2x)/(x+3))/(x/(x+1)+7/(x+3))"},label:!1}]},{num:41,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"(3/(x-1)-3/(a-1))/(x-a)"},label:!1}]},{num:43,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"((x+h)^2-3(x+h)-(x^2-3x))/h"},label:!1}]},{num:45,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"(1/(x+h)^3-1/x^3)/h"},label:!1}]},{num:47,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"(4/(3x+3h-1)-4/(3x-1))/h"},label:!1}]},{num:51,text:"Rationalize the denominator.",alignment:null,parts:[{type:"derivation",options:{eq:"(81x^2-16y^2)/(3sqrtx-2sqrty)"},label:!1}]},{num:55,text:"Rationalize the numerator.",alignment:null,parts:[{type:"derivation",options:{eq:"(sqrta-sqrtb)/(a^2-b^2)"},label:!1}]},{num:57,text:"Rationalize the numerator.",alignment:null,parts:[{type:"derivation",options:{eq:"(sqrt{2(x+h)+1}-sqrt{2x+1})/h"},label:!1}]},{num:63,text:"Express as a sum of terms of the form <i>ax<sup>r</sup></i>, where <i>r</i> is a rational number.",alignment:null,parts:[{type:"derivation",options:{eq:"(x^2+2)^2/x^5"},label:!1}]},{num:67,text:"Express as a quotient.",alignment:null,parts:[{type:"derivation",options:{eq:"x^(-1/2)-x^(3/2)"},label:!1}]},{num:69,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"(2x^2-3x+1)(4)(3x+2)^3(3)+(3x+2)^4(4x-3)"},label:!1}]},{num:71,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"(x^2-4)^(1/2)(3)(2x+1)^2(2)+(2x+1)^3(1/2)(x^2-4)^(-1/2)(2x)"},label:!1}]},{num:73,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"(3x+1)^6(1/2)(2x-5)^(-1/2)(2)+(2x-5)^(1/2)(6)(3x+1)^5(3)"},label:!1}]},{num:75,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"((6x+1)^3(27x^2+2)-(9x^3+2x)(3)(6x+1)^2(6))/(6x+1)^6"},label:!1}]},{num:77,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"((x^2+2)^3(2x)-x^2(3)(x^2+2)^2(2x))/[(x^2+2)^3]^2"},label:!1}]},{num:79,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"((x^2+4)^(1/3)(3)-(3x)(1/3)(x^2+4)^(-2/3)(2x))/[(x^2+4)^(1/3)]^2"},label:!1}]},{num:81,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"((4x^2+9)^(1/2)(2)-(2x+3)(1/2)(4x^2+9)^(-1/2)(8x))/[(4x^2+9)^(1/2)]^2"},label:!1}]}]}]},{title:"Chapter 2 Equations and Inequalities",subchapters:[{title:"2.1 Equations",problems:[{num:7,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"1/5x+2=3-2/7x"},label:!1}]},{num:9,video:"EVOrKJinJcI",text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"0.3(3+2x)+1.2x=3.2"},label:!1}]},{num:13,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"(13+2x)/(4x+1)=3/4"},label:!1}]},{num:15,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"8-5/x=2+3/x"},label:!1}]},{num:17,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"(3x-2)^2=(x-5)(9x+4)"},label:!1}]},{num:21,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"(3x+1)/(6x-2)=(2x+5)/(4x-13)"},label:!1}]},{num:23,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"2/5+4/(10x+5)=7/(2x+1)"},label:!1}]},{num:27,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"2-5/(3x-7)=2"},label:!1}]},{num:31,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"7/(y^2-4)-4/(y+2)=5/(y-2)"},label:!1}]},{num:33,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"(x+3)^3-(3x-1)^2=x^3+4"},label:!1}]},{num:35,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"(9x)/(3x-1)=2+3/(3x-1)"},label:!1}]},{num:37,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"1/(x+4)+3/(x-4)=(3x+8)/(x^2-16)"},label:!1}]},{num:39,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"4/(x+2)+1/(x-2)=(5x-6)/(x^2-4)"},label:!1}]},{num:41,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"2/(2x+1)-3/(2x-1)=(-2x+7)/(4x^2-1)"},label:!1}]},{num:43,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"5/(2x+3)+4/(2x-3)=(14x+3)/(4x^2-9)"},label:!1}]},{num:51,text:"For what value of <i>c</i> is the number <i>a</i> a solution of the equation?",alignment:null,parts:[{type:"derivation",options:{eq:"4x+1+2c=5c-3x+6"},label:!1},{type:"derivation",options:{eq:"a=-2"},label:!1}]},{num:55,text:"Determine values for <i>a</i> and <i>b</i> such that <sup>5</sup>&frasl;<sub>3</sub> is a solution of the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"ax+b=0"},label:!1}]},{num:57,text:"Determine which equation is not equivalent to the equation preceding it.",alignment:null,parts:[{type:"derivation",options:{eq:"x^2-x-2=x^2-4"},label:!1},{type:"derivation",options:{eq:"(x+1)(x-2)=(x+2)(x-2)"},label:!1},{type:"derivation",options:{eq:"x+1=x+2"},label:!1},{type:"derivation",options:{eq:"1=2"},label:!1}]},{num:59,text:"Solve the formula for the specified variable.",alignment:"row",parts:[{type:"derivation",options:{eq:"EK+L=D-TK"},label:!1},{type:"textbox",options:{text:"for <i>K</i>"},label:!1}]},{num:61,text:"Solve the formula for the specified variable.",alignment:"row",parts:[{type:"derivation",options:{eq:"M=(Q+1)/Q"},label:!1},{type:"textbox",options:{text:"for <i>Q</i>"},label:!1}]},{num:67,text:"The formula occurs in the indicated application. Solve for the specified variable.",alignment:"row",parts:[{type:"derivation",options:{eq:"F=g(mM)/d^2"},label:!1},{type:"textbox",options:{text:"for <i>m</i> (Newton's law of gravitation)"},label:!1}]},{num:69,text:"The formula occurs in the indicated application. Solve for the specified variable.",alignment:"row",parts:[{type:"derivation",options:{eq:"P=2l+2w"},label:!1},{type:"textbox",options:{text:"for <i>w</i> (perimeter of a rectangle)"},label:!1}]},{num:71,text:"The formula occurs in the indicated application. Solve for the specified variable.",alignment:"row",parts:[{type:"derivation",options:{eq:"A=1/2(b_1+b_2)h"},label:!1},{type:"textbox",options:{text:"for <i>b</i><sub>1</sub> (area of a trapezoid)"},label:!1}]},{num:73,text:"The formula occurs in the indicated application. Solve for the specified variable.",alignment:"row",parts:[{type:"derivation",options:{eq:"S=p/(q+p(1-q))"},label:!1},{type:"textbox",options:{text:"for <i>q</i> (Amdahl's law for supercomputers)"},label:!1}]},{num:75,text:"The formula occurs in the indicated application. Solve for the specified variable.",alignment:"row",parts:[{type:"derivation",options:{eq:"1/f=1/p+1/q"},label:!1},{type:"textbox",options:{text:"for <i>q</i> (lens equation)"},label:!1}]}]},{title:"2.2 Applied Problems",problems:[{num:1,text:"Test scores",alignment:null,parts:[{type:"textbox",options:{text:"A student in an algebra course has test scores of 75, 82, 71, and 84. What score on the next test will raise the student's average to 80?"},label:!1}]},{num:2,text:"Final class average",alignment:null,parts:[{type:"textbox",options:{text:"Before the final exam, a student has test scores of 72, 80, 65, 78, and 60. If the final exam counts as one-third of the final grade, what score must the student receive in order to have a final average of 76?"},label:!1}]},{num:3,text:"Gross pay",alignment:null,parts:[{type:"textbox",options:{text:"A workers take-home pay is $492, after deductions totaling 40% of the gross pay have been subtracted. What is the gross pay?"},label:!1}]},{num:4,text:"Cost of dining out",alignment:null,parts:[{type:"textbox",options:{text:"A couple does not wish to spend more than $70 for dinner at a restaurant. If a sales tax of 6% is added to the bill and they plan to tip 15% after the tax has been added, what is the most they can spend for the meal?"},label:!1}]},{num:5,text:"Intelligence quotient",alignment:"column",parts:[{type:"textbox",options:{text:"A person's intelligence quotient (IQ) is determined by multiplying the quotient of his or her mental age and chonological age by 100."},label:!1},{type:"textbox",options:{text:"Find the IQ of a 12-year-old child whose mental age is 15."},label:!0},{type:"textbox",options:{text:"Find the mental age of a person 15 years old whose IQ is 140."},label:!0}]},{num:7,text:"Cost of insulation",alignment:null,parts:[{type:"textbox",options:{text:"The cost of installing insulation in a particular two-bedroom home is $2400. Present monthly heating costs average $200, but the insulation is expected to reduce heating costs by 10%. How many months will it take to recover the cost of the insulation?"},label:!1}]},{num:9,text:"Savings accounts",alignment:null,parts:[{type:"textbox",options:{text:"An algebra student has won $100,000 in a lottery and wishes to deposit it in savings accounts in two financial institutions. One account pays 8% simple interest, but deposits are insured only to $50,000. The second account pays 6.4% simple interest, and deposits are insured up to $100,000. Determine whether the money can be deposited so that it is fully insured and earns annual interest of $7500."},label:!1}]},{num:11,text:"Movie attendance",alignment:null,parts:[{type:"textbox",options:{text:"Six hundred people attended the premiere of a motion picture. Adult tickets cost $9, and children were admitted for $6. If box office receipts totaled $4800, how many children attended the premiere?"},label:!1}]},{num:13,text:"Preparing a glucose solution",alignment:null,parts:[{type:"textbox",options:{text:"In a certain medical test designed to measure carbohydrate tolerance, an adult drinks 7 ounces of a 30% glucose solution. When the test is administered to a child, the glucose concentration must be decreased to 20%. How much 30% glucose solution and how much water should be used to prepare 7 ounces of 20% glucose solution?"},label:!1}]},{num:15,text:"Preparing an alloy",alignment:null,parts:[{type:"textbox",options:{text:"British sterling silver is a copper-silver alloy that is 7.5% copper by weight. How many grams of pure copper and how many grams of British sterling silver should be used to prepare 200 grams of a copper-silver alloy that is 10% copper by weight?"},label:!1}]},{num:17,text:"Walking rates",alignment:"column",parts:[{type:"textbox",options:{text:"Two children, who are 224 meters apart, start walking toward each other at the same instant at rates of 1.5 m/sec and 2 m/sec, respectively (see the figure on p. 71)."},label:!1},{type:"textbox",options:{text:"When will they meet?"},label:!0},{type:"textbox",options:{text:"How far will each have walked?"},label:!0}]},{num:19,text:"Snowplow speed",alignment:null,parts:[{type:"textbox",options:{text:"At 6 A.M. a snowplow, traveling at a constant speed, begins to clear a highway leading out of town. At 8 A.M. an automobile begins traveling the highway at a speed of 30 and reaches the plow 30 minutes later. Find the speed of the snowplow."},label:!1}]},{num:21,text:"Rowing rate",alignment:"column",parts:[{type:"textbox",options:{text:"A boy can row a boat at a constant rate of 5 mi/hr in still water, as indicated in the figure (p. 71). He rows upstream for 15 minutes and then rows downstream, returning to his starting point in another 12 minutes."},label:!1},{type:"textbox",options:{text:"Find the rate of the current."},label:!0},{type:"textbox",options:{text:"Find the total distance traveled."},label:!0}]},{num:23,text:"Distance to a target",alignment:null,parts:[{type:"textbox",options:{text:"A bullet is fired horizontally at a target, and the sound of its impact is heard 1.5 seconds later. If the speed of the bullet is 3300 ft/sec and the speed of sound is 1100 ft/sec, how far away is the target?"},label:!1}]},{num:25,text:"Fencing a region",alignment:null,parts:[{type:"textbox",options:{text:"A farmer plans to use 180 feet of fencing to enclose a rectangular region, using part of a straight river bank instead of fencing as one side of the rectangle, as shown in the figure on the next page (p. 72). Find the area of the region if the length of the side parallel to the river bank is"},label:!1},{type:"textbox",options:{text:"twice the length of an adjacent side."},label:!0},{type:"textbox",options:{text:"one-half the length of an adjacent side."},label:!0},{type:"textbox",options:{text:"the same as the length of an adjacent side."},label:!0}]},{num:29,text:"Constructing a silo",alignment:null,parts:[{type:"textbox",options:{text:"A large grain silo is to be constructed in the shape of a circular cylinder with a hemisphere attached to the top (see the figure on p. 72). The diameter of the silo is to be 30 feet, but the height is yet to be determined. Find the height <i>h</i> of the silo that will result in a capacity of 11,250<i></i> ft<sup>3</i>."},label:!1}]},{num:31,text:"Lawn mowing rates",alignment:null,parts:[{type:"textbox",options:{text:"It takes a boy 90 minutes to mow the lawn, but his sister can mow it in 60 minutes. How long would it take them to mow the lawn if they worked together, using two lawn mowers?"},label:!1}]},{num:33,text:"Delivering newspapers",alignment:null,parts:[{type:"textbox",options:{text:"It takes a girl 45 minutes to deliver the newspapers on her route; however, if her brother helps, it takes them only 20 minutes. How long would it take her brother to deliver the newspapers by himself?"},label:!1}]},{num:35,text:"Grade point average (GPA)",alignment:null,parts:[{type:"textbox",options:{text:"A college student has finished 48 credit hours with a GPA of 2.75. To get into the program she wishes to enter, she must have a GPA of 3.2. How many additional credit hours of 4.0 work will raise her GPA to 3.2?"},label:!1}]},{num:37,text:"Air temperature",alignment:"column",parts:[{type:"textbox",options:{text:"Below the cloud base, the air temperature <i>T</i> (in F) at height <i>h</i> (in feet) can be approximated by the equation <i>T</i> = <i>T</i><sub>0</sub> - (<sup>5.5</sup>&frasl;<sub>1000</sub>)<i>h</i>, where <i>T</i><sub>0</sub> is the temperature at ground level."},label:!1},{type:"textbox",options:{text:"Determine the air temperature at a height of 1 mile if the ground temperature is 70F."},label:!0},{type:"textbox",options:{text:"At what altitude is the temperature freezing?"},label:!0}]},{num:39,text:"A cloud's temperature",alignment:null,parts:[{type:"textbox",options:{text:"The temperature <i>T</i> within a cloud at height <i>h</i> (in feet) above the cloud base can be approximated using the equation <i>T</i> = <i>B</i> - (<sup>3</sup>&frasl;<sub>1000</sub>)<i>h</i>, where <i>B</i> is the temperature of the cloud at its base. Determine the temperature at 10,000 feet in a cloud with a base temperature of 55F and a base height of 4000 feet. <b>Note:</b> For an interesting application involving the three preceding exercises, see Exercise 6 in the Discussion Exercises at the end of the chapter."},label:!1}]}]},{title:"2.3 Quadratic Equations",problems:[{num:9,text:"Solve the equation by factoring.",alignment:null,parts:[{type:"derivation",options:{eq:"12x^2+60x+75=0"},label:!1}]},{num:13,text:"Solve the equation by factoring.",alignment:null,parts:[{type:"derivation",options:{eq:"(5x)/(x-3)+4/(x+3)=90/(x^2-9)"},label:!1}]},{num:15,text:"Determine whether the two equations are equivalent.",alignment:"row",parts:[{type:"derivation",options:{eq:"x^2=16"},label:!0},{type:"derivation",options:{eq:"x=4"},label:!1},{type:"derivation",options:{eq:"x=sqrt9"},label:!0},{type:"derivation",options:{eq:"x=3"},label:!1}]},{num:21,text:"Solve the equation by using the special quadratic equation on page 75.",alignment:null,parts:[{type:"derivation",options:{eq:"(x-3)^2=17"},label:!1}]},{num:23,text:"Solve the equation by using the special quadratic equation on page 75.",alignment:null,parts:[{type:"derivation",options:{eq:"4(x+2)^2=11"},label:!1}]},{num:25,text:"Determine the value or values of <i>d</i> that complete the square for the expression.",alignment:"column",parts:[{type:"derivation",options:{eq:"x^2+9x+d"},label:!0},{type:"derivation",options:{eq:"x^2-8x+d"},label:!0},{type:"derivation",options:{eq:"x^2+dx+36"},label:!0},{type:"derivation",options:{eq:"x^2+dx+49/4"},label:!0}]},{num:29,text:"Solve by completing the square. (<i>Note:</i> See the discussion after Example 5 for help in solving Exercises 29 and 30.)",alignment:null,parts:[{type:"derivation",options:{eq:"4x^2-12x-11=0"},label:!1}]},{num:37,text:"Solve by using the quadratic formula.",alignment:null,parts:[{type:"derivation",options:{eq:"3/2z^2-4z-1=0"},label:!1}]},{num:39,text:"Solve by using the quadratic formula.",alignment:null,parts:[{type:"derivation",options:{eq:"5/(w^2)-10/w+2=0"},label:!1}]},{num:41,text:"Solve by using the quadratic formula.",alignment:null,parts:[{type:"derivation",options:{eq:"4x^2+81=36x"},label:!1}]},{num:43,text:"Solve by using the quadratic formula.",alignment:null,parts:[{type:"derivation",options:{eq:"(5x)/(x^2+9)=-1"},label:!1}]},{num:45,text:"Use the quadratic formula to factor the expressions.",alignment:null,parts:[{type:"derivation",options:{eq:"x^2+x-30"},label:!1}]},{num:47,text:"Use the quadratic formula to factor the expressions.",alignment:null,parts:[{type:"derivation",options:{eq:"12x^2-16x-3"},label:!1}]},{num:49,text:"Use the quadratic formula to solve the equation for (a) <i>x</i> in terms of <i>y</i> and (b) <i>y</i> in terms of <i>x</i>.",alignment:null,parts:[{type:"derivation",options:{eq:"4x^2-4xy+1-y^2=0"},label:!1}]},{num:51,text:"Solve for the specified variable.",alignment:"row",parts:[{type:"derivation",options:{eq:"K=1/2mv^2"},label:!1},{type:"textbox",options:{text:"for <i>v</i> (kinetic energy)"},label:!1}]},{num:53,text:"Solve for the specified variable.",alignment:"row",parts:[{type:"derivation",options:{eq:"A=2r(r+h)"},label:!1},{type:"textbox",options:{text:"for <i>r</i> (surface area of a closed cylinder)"},label:!1}]},{num:59,text:"Baseball toss",alignment:null,parts:[{type:"textbox",options:{text:"A baseball is thrown straight upward with an initial speed of 64 ft/sec. The number of feet <i>s</i> above the ground after <i>t</i> seconds is given by the equation <i>s</i> = -16<i>t</i><sup>2</sup> + 64<i>t</i>."},label:!1},{type:"textbox",options:{text:"When will the baseball be 48 feet above the ground?"},label:!0},{type:"textbox",options:{text:"When will it hit the ground?"},label:!0}]},{num:60,text:"Breaking distance",alignment:"column",parts:[{type:"textbox",options:{text:"The distance that a car travels between the time the driver makes the decision to hit the brakes and the time the car actually stops is called the braking distance. For a certain car traveling <i>v</i> mi/hr, the braking distance <i>d</i> (in feet) is given by <i>d</i> = <i>v</i> + (<i>v</i><sup>2</sup>/20)."},label:!1},{type:"textbox",options:{text:"Find the braking distance when <i>v</i> is 55 mi/hr."},label:!0},{type:"textbox",options:{text:"If a driver decides to brake 120 feet from a stop sign, how fast can the car be going and still stop by the time it reaches the sign?"},label:!0}]},{num:65,text:"Fencing a garden",alignment:null,parts:[{type:"textbox",options:{text:"A square vegetable garden is to be tilled and then enclosed with a fence. If the fence costs $1 per foot and the cost of preparing the soil is $0.50 per ft<sup>2</sup>, determine the size of the garden that can be enclosed for $120."},label:!1}]},{num:66,text:"Fencing a region",alignment:null,parts:[{type:"textbox",options:{text:"A farmer plans to enclose a rectangular region, using part of his barn for one side and fencing for the other three sides. If the side parallel to the barn is to be twice the length of an adjacent side, and the area of the region is to be 128 ft<sup>2</sup>, how many feet of fencing should be purchased?"},label:!1}]},{num:69,text:"Distance between airplanes",alignment:"column",parts:[{type:"textbox",options:{text:"An airplane flying north at 200 mi/hr passed over a point on the ground at 2:00 P.M. Another airplane at the same altitude passed over the point at 2:30 P.M., flying east at 400 mi/hr (see the figure on p. 86)."},label:!1},{type:"textbox",options:{text:"If <i>t</i> denotes the time in hours after 2:30 P.M., express the distance <i>d</i> between the airplanes in terms of <i>t</i>."},label:!0},{type:"textbox",options:{text:"At what time after 2:30 P.M. were the airplanes 500 miles apart?"},label:!0}]},{num:70,text:"Two-way radio range",alignment:null,parts:[{type:"textbox",options:{text:"Two surveyors with two-way radios leave the same point at 9:00 A.M., one walking due south at 4 mi/hr and the other due west at 3 mi/hr. How long can they communicate with one another if each radio has a maximum range of 2 miles?"},label:!1}]},{num:71,text:"Constructing a pizza box",alignment:null,parts:[{type:"textbox",options:{text:"A pizza box with a square base is to be made from a rectangular sheet of cardboard by cutting six 1-inch squares from the corners and the middle sections and folding up the sides (see the figure on p. 86). If the area of the base is to be 144 in<sup>2</sup>, what size piece of cardboard should be used?"},label:!1}]}]},{title:"2.4 Complex Numbers",problems:[{num:3,text:"Write the expression in the form <i>a</i> + <i>bi</i>, where <i>a</i> and <i>b</i> are real numbers.",alignment:null,parts:[{type:"derivation",options:{eq:"(7-6i)-(-11-3i)"},label:!1}]},{num:7,text:"Write the expression in the form <i>a</i> + <i>bi</i>, where <i>a</i> and <i>b</i> are real numbers.",alignment:null,parts:[{type:"derivation",options:{eq:"(1-3i)(2+5i)"},label:!1}]},{num:9,text:"Write the expression in the form <i>a</i> + <i>bi</i>, where <i>a</i> and <i>b</i> are real numbers.",alignment:null,parts:[{type:"derivation",options:{eq:"(5-2i)^2"},label:!1}]},{num:17,text:"Write the expression in the form <i>a</i> + <i>bi</i>, where <i>a</i> and <i>b</i> are real numbers.",alignment:"row",parts:[{type:"derivation",options:{eq:"i^73"},label:!0},{type:"derivation",options:{eq:"i^-46"},label:!0},{type:"derivation",options:{eq:"i^66"},label:!0},{type:"derivation",options:{eq:"i^-55"},label:!0}]},{num:19,text:"Write the expression in the form <i>a</i> + <i>bi</i>, where <i>a</i> and <i>b</i> are real numbers.",alignment:null,parts:[{type:"derivation",options:{eq:"3/(2+4i)"},label:!1}]},{num:21,text:"Write the expression in the form <i>a</i> + <i>bi</i>, where <i>a</i> and <i>b</i> are real numbers.",alignment:null,parts:[{type:"derivation",options:{eq:"(1-7i)/(6-2i)"},label:!1}]},{num:23,text:"Write the expression in the form <i>a</i> + <i>bi</i>, where <i>a</i> and <i>b</i> are real numbers.",alignment:null,parts:[{type:"derivation",options:{eq:"(-4+6i)/(2+7i)"},label:!1}]},{num:25,text:"Write the expression in the form <i>a</i> + <i>bi</i>, where <i>a</i> and <i>b</i> are real numbers.",alignment:null,parts:[{type:"derivation",options:{eq:"(4-2i)/(-5i)"},label:!1}]},{num:27,text:"Write the expression in the form <i>a</i> + <i>bi</i>, where <i>a</i> and <i>b</i> are real numbers.",alignment:null,parts:[{type:"derivation",options:{eq:"(2+5i)^3"},label:!1}]},{num:29,text:"Write the expression in the form <i>a</i> + <i>bi</i>, where <i>a</i> and <i>b</i> are real numbers.",alignment:null,parts:[{type:"derivation",options:{eq:"(2-sqrt-4)(3-sqrt-16)"},label:!1}]},{num:31,text:"Write the expression in the form <i>a</i> + <i>bi</i>, where <i>a</i> and <i>b</i> are real numbers.",alignment:null,parts:[{type:"derivation",options:{eq:"(4+sqrt-81)/(7-sqrt-64)"},label:!1}]},{num:35,text:"Find the values of <i>x</i> and <i>y</i>, where <i>x</i> and <i>y</i> are real numbers.",alignment:null,parts:[{type:"derivation",options:{eq:"4+(x+2y)i=x+2i"},label:!1}]},{num:37,text:"Find the values of <i>x</i> and <i>y</i>, where <i>x</i> and <i>y</i> are real numbers.",alignment:null,parts:[{type:"derivation",options:{eq:"(2x-y)-16i=10+4yi"},label:!1}]},{num:39,text:"Find the solutions of the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"x^2-6x+13=0"},label:!1}]},{num:41,text:"Find the solutions of the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"x^2+4x+13=0"},label:!1}]},{num:43,text:"Find the solutions of the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"x^2-5x+20=0"},label:!1}]},{num:45,text:"Find the solutions of the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"4x^2+x+3=0"},label:!1}]},{num:47,text:"Find the solutions of the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"x^3+125=0"},label:!1}]},{num:48,text:"Find the solutions of the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"x^3-27=0"},label:!1}]},{num:49,text:"Find the solutions of the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"27x^3=(x+5)^3"},label:!1}]},{num:50,text:"Find the solutions of the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"16x^4=(x-4)^4"},label:!1}]},{num:51,text:"Find the solutions of the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"x^4=256"},label:!1}]},{num:53,text:"Find the solutions of the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"4x^4+25x^2+36=0"},label:!1}]},{num:54,text:"Find the solutions of the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"27x^4+21x^2+4=0"},label:!1}]},{num:55,text:"Find the solutions of the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"x^3+3x^2+4x=0"},label:!1}]},{num:57,text:"This problem is currently unavailable. Please see p. 94 in the textbook.",alignment:null,parts:[]}]},{title:"2.5 Other Types of Equations",problems:[{num:3,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"|3x-2|+3=7"},label:!1}]},{num:5,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"3*|x+1|-2=-11"},label:!1}]},{num:8,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"3x^3-4x^2-27x+36=0"},label:!1}]},{num:9,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"4x^4+10x^3=6x^2+15x"},label:!1}]},{num:11,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"y^(3/2)=5y"},label:!1}]},{num:17,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"sqrt[5]{2x^2+1}-2=0"},label:!1}]},{num:19,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"sqrt{7-x}=x-5"},label:!1}]},{num:21,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"3sqrt{2x-3}+2sqrt{7-x}=11"},label:!1}]},{num:23,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"x=4+sqrt{4x-19}"},label:!1}]},{num:25,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"x+sqrt{5x+19}=-1"},label:!1}]},{num:27,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"sqrt{7-2x}-sqrt{5+x}=sqrt{4+3x}"},label:!1}]},{num:29,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"sqrt{11+8x}+1=sqrt{9+4x}"},label:!1}]},{num:33,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"sqrt{1+4sqrtx}=sqrtx+1"},label:!1}]},{num:37,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"5y^4-7y^2+1=0"},label:!1}]},{num:39,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"36x^-4-13x^-2+1=0"},label:!1}]},{num:41,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"3x^(2/3)+4x^(1/3)-4=0"},label:!1}]},{num:43,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"6w+7w^(1/2)-20=0"},label:!1}]},{num:44,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"8t-22t^(1/2)-21=0"},label:!1}]},{num:45,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"2x^(-2/3)-7x^(-1/3)-15=0"},label:!1}]},{num:49,text:"Solve the equation.",alignment:"row",parts:[{type:"derivation",options:{eq:"sqrt[3]{x}=2sqrt[4]{x}"},label:!1},{type:"textbox",options:{text:"(<i>Hint:</i> Raise both sides to the least common multiple of 3 and 4.)"},label:!1}]},{num:51,text:"Find the real solutions of the equation.",alignment:"column",parts:[{type:"derivation",options:{eq:"x^(5/3)=32"},label:!0},{type:"derivation",options:{eq:"x^(4/3)=16"},label:!0},{type:"derivation",options:{eq:"x^(2/3)=-36"},label:!0},{type:"derivation",options:{eq:"x^(3/4)=125"},label:!0},{type:"derivation",options:{eq:"x^(3/2)=-27"},label:!0}]},{num:53,text:"Solve for the specified variable.",alignment:"row",parts:[{type:"derivation",options:{eq:"T=2sqrt{l/g}"},label:!1},{type:"textbox",options:{text:"for <i>l</i> (period of a pendulum)"},label:!1}]},{num:55,text:"Solve for the specified variable.",alignment:"row",parts:[{type:"derivation",options:{eq:"S=rsqrt{r^2+h^2}"},label:!1},{type:"textbox",options:{text:"for <i>h</i> (surface area of a cone)"},label:!1}]},{num:57,text:"Ladder height",alignment:null,parts:[{type:"textbox",options:{text:"The recommended distance <i>d</i> that a ladder should be placed away from a vertical wall is 25% of its length <i>L</i>. Approximate the height <i>h</i> that can be reached by relating <i>h</i> as a percentage of <i>L</i> (see figure on p. 101)."},label:!1}]},{num:59,text:"Windmill power",alignment:null,parts:[{type:"textbox",options:{text:"The power <i>P</i> (in watts) generated by a windmill that has efficiency <i>E</i> is given by the formula <i>P</i> = 0.31<i>ED</i><sup>2</sup><i>V</i><sup>3</sup>, where <i>D</i> is the diameter (in feet) of the windmill blades and <i>V</i> is the wind velocity (in ft/sec). Approximate the wind velocity necessary to generate 10,000 watts if <i>E</i> = 42% and <i>D</i> = 10."},label:!1}]},{num:61,text:"The effect of price on demand",alignment:null,parts:[{type:"textbox",options:{text:"The demand for a commodity usually depends on its price. If other factors do not affect the demand, then the quantity <i>Q</i> purchased at price <i>P</i> (in cents) is given by <i>Q</i> = <i>kP</i><sup>-<i>c</i></sup>, where <i>k</i> and <i>c</i> are positive constants. If <i>k</i> = 10<sup>5</sup> and <i>c</i> = <sup>1</sup>&frasl;<sub>2</sub>, find the price that will result in the purchase of 5000 items."},label:!1}]},{num:62,text:"The urban heat island",alignment:null,parts:[{type:"textbox",options:{text:"Urban areas have higher average air temperatures than rural areas, as a result of the presence of buildings, asphalt, and concrete. This phenomenon has become known as the <i>urban heat island</i>. The temperature difference <i>T</i> (in C) between urban and rural areas near Montreal, with a population <i>P</i> between 1000 and 1,000,000, can be described the by the formula <i>T</i> = 0.25<i>P</i><sup><sup>1</sup>&frasl;<sub>4</sub></sup>/<i>v</i>, where <i>v</i> is the average wind speed (in mi/hr) and <i>v</i>  1. If <i>T</i> = 3 and <i>v</i> = 5, find <i>P</i>."},label:!1}]},{num:67,text:"Installing a power line",alignment:null,parts:[{type:"textbox",options:{text:"A power line is to be installed across a river that is 1 mile wide to a town that is 5 miles downstream (see the figure on p. 102). It costs $7500 per mile to lay the cable underwater and $6000 per mile to lay it overland. Determine how the cable should be installed if $35,000 has been allocated for this project."},label:!1}]}]},{title:"2.6 Inequalities",problems:[{num:3,text:"Express the inequality as an interval, and sketch its graph.",alignment:null,parts:[{type:"derivation",options:{eq:"x<-2"},label:!1}]},{num:5,text:"Express the inequality as an interval, and sketch its graph.",alignment:null,parts:[{type:"derivation",options:{eq:"x4"},label:!1}]},{num:"7-19",text:"We're not yet supporting these problems. Please see pp. 109 and 110 in the textbook.",alignment:null,parts:[]},{num:27,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"9+1/3x4-1/2x"},label:!1}]},{num:"31-35",text:"We're not yet supporting these problems. Please see p. 110 in the textbook.",alignment:null,parts:[]},{num:39,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"(x-4)^2>x(x+12)"},label:!1}]},{num:41,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"4/(3x+2)0"},label:!1}]},{num:43,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"-2/(4-3x)>0"},label:!1}]},{num:45,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"2/((1-x)^2)>0"},label:!1}]},{num:47,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"|x|<3"},label:!1}]},{num:49,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"|x|5"},label:!1}]},{num:53,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"|x+2|+0.10.2"},label:!1}]},{num:57,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"-1/3*|6-5x|+21"},label:!1}]},{num:59,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"|7x+2|>-2"},label:!1}]},{num:63,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"|(2-3x)/5|2"},label:!1}]},{num:65,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"3/|5-2x|<2"},label:!1}]},{num:"67-77",text:"We're not yet supporting these problems. Please see p. 110 in the textbook.",alignment:null,parts:[]},{num:80,text:"Electrical resistance",alignment:null,parts:[{type:"textbox",options:{text:"If two resistors <i>R</i><sub>1</sub> and <i>R</i><sub>2</sub> are connected in parallel in an electrical circuit, the net resistance <i>R</i> is given by<p style='text-align:center; margin: 10px;'><sup>1</sup>&frasl;<sub><i>R</i></sub> = <sup>1</sup>&frasl;<sub><i>R</i><sub>1</sub></sub> + <sup>1</sup>&frasl;<sub><i>R</i><sub>2</sub></sub>.</p>If <i>R</i><sub>1</sub> = 10 ohms, what values of <i>R</i><sub>2</sub> will result in a net resistance of less than 5 ohms?"},label:!1}]},{num:85,text:"Decreasing height",alignment:"column",parts:[{type:"textbox",options:{text:"A person's height will typically decrease by 0.024 inch each year after age 30."},label:!1},{type:"textbox",options:{text:"If a woman was 5 feet 9 inches tall at age 30, predict her height at age 70."},label:!0},{type:"textbox",options:{text:"A 50-year-old man is 5 feet 6 inches tall. Determine an inequality for the range of heights (in inches) that this man will experience between the ages of 30 and 70."},label:!0}]}]},{title:"2.7 More on Inequalities",problems:[{num:7,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"x^2-2x-5>3"},label:!1}]},{num:9,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"x(2x+3)5"},label:!1}]},{num:11,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"6x-8>x^2"},label:!1}]},{num:17,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"16x^29x"},label:!1}]},{num:19,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"x^4+5x^236"},label:!1}]},{num:21,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"x^3+2x^2-4x-80"},label:!1}]},{num:23,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"(x^2(x+2))/((x+2)(x+1))0"},label:!1}]},{num:25,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"(x^2-x)/(x^2+2x)0"},label:!1}]},{num:27,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"(x-2)/(x^2-3x-10)0"},label:!1}]},{num:29,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"(-3x)/(x^2-9)>0"},label:!1}]},{num:31,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"(x+1)/(2x-3)>2"},label:!1}]},{num:33,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"1/(x-2)3/(x+1)"},label:!1}]},{num:35,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"4/(3x-2)2/(x+1)"},label:!1}]},{num:37,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"x/(3x-5)2/(x-1)"},label:!1}]},{num:39,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"x^3>x"},label:!1}]},{num:41,text:"As a particle moves along a straight path, its speed <i>v</i> (in cm/sec) at time <i>t</i> (in seconds) is given by the equation. For what subintervals of the given time interval [<i>a</i>, <i>b</i>] will its speed be at least <i>k</i> cm/sec?",alignment:"row",parts:[{type:"derivation",options:{eq:"v=t^3-3t^2-4t+20"},label:!1},{type:"derivation",options:{eq:"[0,5]"},label:!1},{type:"derivation",options:{eq:"k=8"},label:!1}]},{num:43,text:"Vertical leap record",alignment:null,parts:[{type:"textbox",options:{text:"<i>Guinness Book of World Records</i> reports that German shepherds can make vertical leaps of over 10 feet when scaling walls. If the distance <i>s</i> (in feet) off the ground after <i>t</i> seconds is given by the equation <i>s</i> = -16<i>t</i><sup>2</sup> + 24<i>t</i> + 1, for how many seconds is the dog more than 9 feet off the ground?"},label:!1}]},{num:44,text:"Height of a projected object",alignment:null,parts:[{type:"textbox",options:{text:"If an object is projected vertically upward from ground level with an initial velocity of 320 ft/sec, then its distance <i>s</i> above the ground after <i>t</i> seconds is given by <i>s</i> = -16<i>t</i><sup>2</sup> + 320<i>t</i>. For what values of <i>t</i> will the object be more than 1536 feet above the ground?"},label:!1}]},{num:45,text:"Braking distance",alignment:null,parts:[{type:"textbox",options:{text:"The braking distance <i>d</i> (in feet) of a certain car traveling <i>v</i> mi/hr is given by the equation <i>d</i> = <i>v</i> + (<i>v</i><sup>2</sup>/20). Determine the velocities that result in braking distances of less than 75 feet."},label:!1}]},{num:49,text:"Weight in space",alignment:null,parts:[{type:"textbox",options:{text:"After an astronaut is launched into space, the astronaut's weight decreases until a state of weightlessness is achieved. The weight of a 125-pound astronaut at an altitude of <i>x</i> kilometers above sea level is given by<p style='text-align:center; margin: 10px;'><i>W</i> = 125(<sup>6400</sup>&frasl;<sub>6400 + <i>x</i></sub>)<sup>2</sup>.</p>At what altitudes is the astronaut's weight less than 5 pounds?"},label:!1}]},{num:51,text:"Aircraft's landing speed",alignment:null,parts:[{type:"textbox",options:{text:"In the design of certain small turbo-prop aircraft, the landing speed <i>V</i> (in ft/sec) is determined by the formula <i>W</i> = 0.00334<i>V</i><sup>2</sup><i>S</i>, where <i>W</i> is the gross weight (in pounds) of the aircraft and <i>S</i> is the surface area (in ft<sup>2</sup>) of the wings. If the gross weight of the aircraft is between 7500 pounds and 10,000 pounds and <i>S</i> = 210 ft<sup>2</sup>, determine the range of the landing speeds in miles per hour."},label:!1}]}]}]},{title:"Chapter 3 Functions and Graphs",subchapters:[{title:"3.1 Rectangular Coordinate Systems",problems:[{num:3,text:null,alignment:null,parts:[{type:"textbox",options:{text:"Plot the points <i>A</i> (0, 0), <i>B</i> (1, 1), <i>C</i> (3, 3), <i>D</i> (-1, -1), and <i>E</i> (-2, -2). Describe the set of all points of the form (<i>a</i>, <i>a</i>), where <i>a</i> is a real number."},label:!1}]},{num:7,text:"Describe the set of all points <i>P</i> (<i>x</i>, <i>y</i>) in a coordinate plane that satisfy the given condition.",alignment:"column",parts:[{type:"derivation",options:{eq:"x=-2"},label:!0},{type:"derivation",options:{eq:"y=3"},label:!0},{type:"derivation",options:{eq:"x0"},label:!0},{type:"derivation",options:{eq:"xy>0"},label:!0},{type:"derivation",options:{eq:"y<0"},label:!0},{type:"derivation",options:{eq:"x=0"},label:!0}]},{num:9,text:"(a) Find the distance <i>d</i> (<i>A</i>, <i>B</i>) between <i>A</i> and <i>B</i>. (b) Find the midpoint of the segment <i>AB</i>.",alignment:"row",parts:[{type:"textbox",options:{text:"<i>A</i> (4, -3)"},label:!1},{type:"textbox",options:{text:"<i>B</i> (6, 2)"},label:!1}]},{num:11,text:"(a) Find the distance <i>d</i> (<i>A</i>, <i>B</i>) between <i>A</i> and <i>B</i>. (b) Find the midpoint of the segment <i>AB</i>.",alignment:"row",parts:[{type:"textbox",options:{text:"<i>A</i> (-5, 0)"},label:!1},{type:"textbox",options:{text:"<i>B</i> (-2, -2)"},label:!1}]},{num:13,text:"(a) Find the distance <i>d</i> (<i>A</i>, <i>B</i>) between <i>A</i> and <i>B</i>. (b) Find the midpoint of the segment <i>AB</i>.",alignment:"row",parts:[{type:"textbox",options:{text:"<i>A</i> (7, -3)"},label:!1},{type:"textbox",options:{text:"<i>B</i> (3, -3)"},label:!1}]},{num:15,text:"We're not yet supporting this problem.",alignment:null,parts:[]},{num:19,text:null,alignment:null,parts:[{type:"textbox",options:{text:"Given <i>A</i> (-3, 8), find the coordinates of the point <i>B</i> such that <i>C</i> (5, -10) is the midpoint of segment <i>AB</i>."},label:!1}]},{num:21,text:"Prove that <i>C</i> is on the perpendicular bisector of segment <i>AB</i>.",alignment:"row",parts:[{type:"textbox",options:{text:"<i>A</i> (-4, -3)"},label:!1},{type:"textbox",options:{text:"<i>B</i> (6, 1)"},label:!1},{type:"textbox",options:{text:"<i>C</i> (5, -11)"},label:!1}]},{num:23,text:"Find a formula that expresses the fact that an arbitrary point <i>P</i> (<i>x</i>, <i>y</i>) is on the perpendicular bisector <i>l</i> of segment <i>AB</i>.",alignment:"row",parts:[{type:"textbox",options:{text:"<i>A</i> (-4, -3)"},label:!1},{type:"textbox",options:{text:"<i>B</i> (6, 1)"},label:!1}]},{num:25,text:null,alignment:null,parts:[{type:"textbox",options:{text:"Find a formula that expresses the fact that <i>P</i> (<i>x</i>, <i>y</i>) is a distance 5 from the origin. Describe the set of all such points."},label:!1}]},{num:26,text:null,alignment:null,parts:[{type:"textbox",options:{text:"Find a formula that states that <i>P</i> (<i>x</i>, <i>y</i>) is a distance <i>r</i> > 0 from a fixed point <i>C</i> (<i>h</i>, <i>k</i>). Describe the set of all such points."},label:!1}]},{num:27,text:null,alignment:null,parts:[{type:"textbox",options:{text:"Find all points on the <i>y</i>-axis that are a distance 6 from <i>P</i> (5, 3)."},label:!1}]},{num:29,text:null,alignment:null,parts:[{type:"textbox",options:{text:"Find the point with coordinates of the form (2<i>a</i>, <i>a</i>) that is in the third quadrant and is a distance 5 from <i>P</i> (1, 3)."},label:!1}]},{num:31,text:null,alignment:null,parts:[{type:"textbox",options:{text:"For what values of <i>a</i> is the distance between <i>P</i> (<i>a</i>, 3) and <i>Q</i> (5, 2<i>a</i>) greater than 26?"},label:!1}]},{num:33,text:null,alignment:null,parts:[{type:"textbox",options:{text:"Prove that the midpoint of the hypotenuse of any right triangle is equidistant from the vertices. (<i>Hint:</i> Label the vertices of the triangle <i>O</i> (0,0), <i>A</i> (</i>a</i>, 0), and <i>B</i> (0, <i>b</i>).)"},label:!1}]}]},{title:"3.2 Graphs of Equations",problems:[{num:1,text:"Sketch the graph of the equation, and label the <i>x</i>- and <i>y</i>-intercepts.",alignment:null,parts:[{type:"derivation",options:{eq:"y=2x-3"},label:!1}]},{num:3,text:"Sketch the graph of the equation, and label the <i>x</i>- and <i>y</i>-intercepts.",alignment:null,parts:[{type:"derivation",options:{eq:"y=-x+1"},label:!1}]},{num:5,text:"Sketch the graph of the equation, and label the <i>x</i>- and <i>y</i>-intercepts.",alignment:null,parts:[{type:"derivation",options:{eq:"y=-4x^2"},label:!1}]},{num:7,text:"Sketch the graph of the equation, and label the <i>x</i>- and <i>y</i>-intercepts.",alignment:null,parts:[{type:"derivation",options:{eq:"y=2x^2-1"},label:!1}]},{num:9,text:"Sketch the graph of the equation, and label the <i>x</i>- and <i>y</i>-intercepts.",alignment:null,parts:[{type:"derivation",options:{eq:"x=1/4y^2"},label:!1}]},{num:11,text:"Sketch the graph of the equation, and label the <i>x</i>- and <i>y</i>-intercepts.",alignment:null,parts:[{type:"derivation",options:{eq:"x=-y^2+3"},label:!1}]},{num:13,text:"Sketch the graph of the equation, and label the <i>x</i>- and <i>y</i>-intercepts.",alignment:null,parts:[{type:"derivation",options:{eq:"y=-1/2x^3"},label:!1}]},{num:15,text:"Sketch the graph of the equation, and label the <i>x</i>- and <i>y</i>-intercepts.",alignment:null,parts:[{type:"derivation",options:{eq:"y=x^3-8"},label:!1}]},{num:17,text:"Sketch the graph of the equation, and label the <i>x</i>- and <i>y</i>-intercepts.",alignment:null,parts:[{type:"derivation",options:{eq:"y=sqrtx"},label:!1}]},{num:19,text:"Sketch the graph of the equation, and label the <i>x</i>- and <i>y</i>-intercepts.",alignment:null,parts:[{type:"derivation",options:{eq:"y=sqrtx-4"},label:!1}]},{num:20,text:"Sketch the graph of the equation, and label the <i>x</i>- and <i>y</i>-intercepts.",alignment:null,parts:[{type:"derivation",options:{eq:"y=sqrt{x-4}"},label:!1}]},{num:21,text:"Use tests for symmetry to determine which graphs in the indicated exercises are symmetric with respect to (a) the <i>y</i>-axis, (b) the <i>x</i>-axis, and (c) the origin.",alignment:null,parts:[{type:"textbox",options:{text:"The odd-numbered exercises in 1-20"},label:!1}]},{num:23,text:"Sketch the graph of the circle or semicircle.",alignment:null,parts:[{type:"derivation",options:{eq:"x^2+y^2=11"},label:!1}]},{num:25,text:"Sketch the graph of the circle or semicircle.",alignment:null,parts:[{type:"derivation",options:{eq:"(x+3)^2+(y-2)^2=9"},label:!1}]},{num:27,text:"Sketch the graph of the circle or semicircle.",alignment:null,parts:[{type:"derivation",options:{eq:"(x+3)^2+y^2=16"},label:!1}]},{num:31,text:"Sketch the graph of the circle or semicircle.",alignment:null,parts:[{type:"derivation",options:{eq:"y=-sqrt{16-x^2}"},label:!1}]},{num:33,text:"Sketch the graph of the circle or semicircle.",alignment:null,parts:[{type:"derivation",options:{eq:"x=sqrt{9-y^2}"},label:!1}]},{num:35,text:"Find an equation of the circle that satisfies the stated conditions.",alignment:null,parts:[{type:"textbox",options:{text:"Center <i>C</i> (2, -3), radius 5"},label:!1}]},{num:37,text:"Find an equation of the circle that satisfies the stated conditions.",alignment:null,parts:[{type:"textbox",options:{text:"Center <i>C</i> (<sup>1</sup>&frasl;<sub>4</sub>, 0), radius 3&radic;2"},label:!1}]},{num:39,text:"Find an equation of the circle that satisfies the stated conditions.",alignment:null,parts:[{type:"textbox",options:{text:"Center <i>C</i> (-4, 6), passing through <i>P</i> (1, 2)"},label:!1}]},{num:41,text:"Find an equation of the circle that satisfies the stated conditions.",alignment:null,parts:[{type:"textbox",options:{text:"Center <i>C</i> (-3, 6), tangent to the <i>y</i>-axis"},label:!1}]},{num:43,text:"Find an equation of the circle that satisfies the stated conditions.",alignment:null,parts:[{type:"textbox",options:{text:"Tangent to both axes, center in the second quadrant, radius 4"},label:!1}]},{num:45,text:"Find an equation of the circle that satisfies the stated conditions.",alignment:null,parts:[{type:"textbox",options:{text:"Endpoints of a diameter <i>A</i> (4, -3) and <i>B</i> (-2, 7)"},label:!1}]},{num:47,text:"Find the center and radius of the circle with the given equation.",alignment:null,parts:[{type:"derivation",options:{eq:"x^2+y^2-4x+6y-36-0"},label:!1}]},{num:49,text:"Find the center and radius of the circle with the given equation.",alignment:null,parts:[{type:"derivation",options:{eq:"x^2+y^2+4y-117=0"},label:!1}]},{num:51,text:"Find the center and radius of the circle with the given equation.",alignment:null,parts:[{type:"derivation",options:{eq:"2x^2+2y^2-12x+4y-15=0"},label:!1}]},{num:53,text:"Find the center and radius of the circle with the given equation.",alignment:null,parts:[{type:"derivation",options:{eq:"x^2+y^2+4x-2y+5=0"},label:!1}]},{num:55,text:"Find the center and radius of the circle with the given equation.",alignment:null,parts:[{type:"derivation",options:{eq:"x^2+y^2-2x-8y+19=0"},label:!1}]},{num:57,text:"Find equations for the upper half, lower half, right half, and left half of the circle.",alignment:null,parts:[{type:"derivation",options:{eq:"x^2+y^2=36"},label:!1}]},{num:59,text:"Find equations for the upper half, lower half, right half, and left half of the circle.",alignment:null,parts:[{type:"derivation",options:{eq:"(x-2)^2+(y+1)^2=49"},label:!1}]},{num:65,text:"Determine whether the point <i>P</i> is inside, outside, or on the circle with center <i>C</i> and radius <i>r</i>.",alignment:null,parts:[{type:"textbox",options:{text:"<i>P</i> (2, 3), <i>C</i> (4, 6), <i>r</i> = 4"},label:!0},{type:"textbox",options:{text:"<i>P</i> (4, 2), <i>C</i> (1, -2), <i>r</i> = 5"},label:!0},{type:"textbox",options:{text:"<i>P</i> (-3, 5), <i>C</i> (2, 1), <i>r</i> = 6"},label:!0}]},{num:67,text:"For the given circle, find (a) the <i>x</i>-intercepts and (b) the <i>y</i>-intercepts.",alignment:null,parts:[{type:"derivation",options:{eq:"x^2+y^2-4x-6y+4=0"},label:!1}]}]},{title:"3.3 Lines",problems:[{num:3,text:"Sketch the line through <i>A</i> and <i>B</i>, and find its slope <i>m</i>.",alignment:null,parts:[{type:"textbox",options:{text:"<i>A</i> (2, 5), <i>B</i> (-7, 5)"},label:!1}]},{num:13,video:"ntllXftcCuU",text:"Sketch the graph of <i>y</i> = <i>mx</i> for the given values of <i>m</i>.",alignment:null,parts:[{type:"textbox",options:{text:"<i>m</i> = 3, -2, <sup>2</sup>&frasl;<sub>3</sub>, -<sup>1</sup>&frasl;<sub>4</sub>"},label:!1}]},{num:15,text:"Sketch the graph of the line through <i>P</i> for each value of <i>m</i>.",alignment:null,parts:[{type:"textbox",options:{text:"<i>P</i> (3, 1); <i>m</i> = <sup>1</sup>&frasl;<sub>2</sub>, -1, -<sup>1</sup>&frasl;<sub>5</sub>"},label:!1}]},{num:19,text:"Sketch the graphs of the lines on the same coordinate plane.",alignment:"row",parts:[{type:"derivation",options:{eq:"y=x+3"},label:!1},{type:"derivation",options:{eq:"y=x+1"},label:!1},{type:"derivation",options:{eq:"y=-x+1"},label:!1}]},{num:21,text:"Find a general form of an equation of the line through the point <i>A</i> that satisfies the given condition.",alignment:"column",parts:[{type:"textbox",options:{text:"<i>A</i> (5, -2)"},label:!1},{type:"textbox",options:{text:"parallel to the <i>y</i>-axis"},label:!0},{type:"textbox",options:{text:"perpendicular to the <i>y</i>-axis"},label:!0}]},{num:23,text:"Find a general form of an equation of the line through the point <i>A</i> that satisfies the given condition.",alignment:"row",parts:[{type:"textbox",options:{text:"<i>A</i> (5, -3)"},label:!1},{type:"textbox",options:{text:"slope -4"},label:!1}]},{num:25,text:"Find a general form of an equation of the line through the point <i>A</i> that satisfies the given condition.",alignment:"row",parts:[{type:"textbox",options:{text:"<i>A</i> (4, 0)"},label:!1},{type:"textbox",options:{text:"slope -3"},label:!1}]},{num:27,text:"Find a general form of an equation of the line through the point <i>A</i> that satisfies the given condition.",alignment:"row",parts:[{type:"textbox",options:{text:"<i>A</i> (4, -5)"},label:!1},{type:"textbox",options:{text:"through <i>B</i> (-3, 6)"},label:!1}]},{num:29,text:"Find a general form of an equation of the line through the point <i>A</i> that satisfies the given condition.",alignment:"row",parts:[{type:"textbox",options:{text:"<i>A</i> (2, -4)"},label:!1},{type:"textbox",options:{text:"parallel to the line 5<i>x</i> - 2<i>y</i> = 4"},label:!1}]},{num:31,text:"Find a general form of an equation of the line through the point <i>A</i> that satisfies the given condition.",alignment:"row",parts:[{type:"textbox",options:{text:"<i>A</i> (7, -3)"},label:!1},{type:"textbox",options:{text:"perpendicular to the line 2<i>x</i> - 5<i>y</i> = 8"},label:!1}]},{num:33,text:"Find the slope-intercept form of the line that satisfies the given conditions.",alignment:"row",parts:[{type:"textbox",options:{text:"<i>x</i>-intercept 4"},label:!1},{type:"textbox",options:{text:"<i>y</i>-intercept -3"},label:!1}]},{num:35,text:"Find the slope-intercept form of the line that satisfies the given conditions.",alignment:null,parts:[{type:"textbox",options:{text:"Through <i>A</i> (5, 2) and <i>B</i> (-1, 4)"},label:!1}]},{num:37,text:"Find a general form of an equation for the perpendicular bisector of the segment <i>AB</i>.",alignment:"row",parts:[{type:"textbox",options:{text:"<i>A</i> (3, -1)"},label:!1},{type:"textbox",options:{text:"<i>B</i> (-2, 6)"},label:!1}]},{num:39,text:"Find an equation for the line that bisects the given quadrants.",alignment:null,parts:[{type:"textbox",options:{text:"II and IV"},label:!1}]},{num:41,text:"Use the slope-intercept form to find the slope and <i>y</i>-intercept of the given line, and sketch its graph.",alignment:null,parts:[{type:"derivation",options:{eq:"2x=15-3y"},label:!1}]},{num:43,text:"Use the slope-intercept form to find the slope and <i>y</i>-intercept of the given line, and sketch its graph.",alignment:null,parts:[{type:"derivation",options:{eq:"4x-3y=9"},label:!1}]},{num:45,text:"We're not yet supporting this problem.",alignment:null,parts:[]},{num:51,text:"Fetal growth",alignment:null,parts:[{type:"textbox",options:{text:"The growth of a fetus more than 12 weeks old can be approximated by the formula <i>L</i> = 1.53<i>t</i> - 6.7, where <i>L</i> is the length (in centimeters) and <i>t</i> is the age (in weeks). Prenatal length can be determined by ultrasound. Approximate the age of a fetus whose length is 28 centimeters."},label:!1}]},{num:54,text:"Growth of a blue whale",alignment:"column",parts:[{type:"textbox",options:{text:"Newborn blue whales are approximately 24 feet long and weigh 3 tons. Young whales are nursed for 7 months, and by the time of weaning they often are 53 feet long and weigh 23 tons. Let <i>L</i> and <i>W</i> denote the length (in feet) and the weight (in tons), respectively, of a whale that is <i>t</i> months of age."},label:!1},{type:"textbox",options:{text:"If <i>L</i> and <i>t</i> are linearly related, express <i>L</i> in terms of <i>t</i>."},label:!0},{type:"textbox",options:{text:"What is the daily increase in the length of a young whale? (Use 1 month = 30 days.)"},label:!0},{type:"textbox",options:{text:"If <i>W</i> and <i>t</i> are linearly related, express <i>W</i> in terms of <i>t</i>."},label:!0},{type:"textbox",options:{text:"What is the daily increase in the weight of a young whale?"},label:!0}]},{num:57,text:"Childhood weight",alignment:"column",parts:[{type:"textbox",options:{text:"A baby weighs 10 pounds at birth, and three years later the child's weight is 30 pounds. Assume that childhood weight <i>W</i> (in pounds) is linearly related to age <i>t</i> (in years)."},label:!1},{type:"textbox",options:{text:"Express <i>W</i> in terms of <i>t</i>."},label:!0},{type:"textbox",options:{text:"What is <i>W</i> on the child's sixth birthday?"},label:!0},{type:"textbox",options:{text:"At what age will the child weigh 70 pounds?"},label:!0},{type:"textbox",options:{text:"Sketch, on a <i>tW</i>-plane, a graph that shows the relationship between <i>W</i> and <i>t</i> for 0  <i>t</i>  12."},label:!0}]},{num:61,text:"Urban heat island",alignment:"column",parts:[{type:"textbox",options:{text:"The urban heat island phenomenon has been observed in Tokyo. The average temperature was 13.5C in 1915, and since then has risen 0.032C per year."},label:!1},{type:"textbox",options:{text:"Assuming that temperature <i>T</i> (in C) is linearly related to time <i>t</i> (in years) and that <i>t</i> = 0 corresponds to 1915, express <i>T</i> in terms of <i>t</i>."},label:!0},{type:"textbox",options:{text:"Predict the average temperature in the year 2010."},label:!0}]},{num:67,text:"Vertical wind shear",alignment:null,parts:[{type:"textbox",options:{text:"Vertical wind shear occurs when wind speed varies at different heights above the ground. Wind shear is of great importance to pilots during takeoffs and landings. If the wind speed is <i>v</i><sub>1</sub> at height <i>h</i><sub>1</sub> and <i>v</i><sub>2</sub> at height <i>h</i><sub>2</sub>, then the average wind shear <i>s</i> is given by the slope formula<p style='text-align:center; margin:10px'><i>s</i> = <sup><i>v</i><sub>2</sub> - <i>v</i><sub>1</sub></sup>&frasl;<sub><i>h</i><sub>2</sub> - <i>h</i><sub>1</sub></sub>.</p>If the wind speed at ground level is 22 mi/hr and <i>s</i> has been determined to be 0.07, find the wind speed 185 feet above the ground."},label:!1}]},{num:69,text:"The given points were found using empirical methods. Determine whether they lie on the same line <i>y</i> = <i>ax</i> + <i>b</i>, and if so, find the values of <i>a</i> and <i>b</i>.",alignment:"column",parts:[{type:"textbox",options:{text:"<i>A</i> (-1.3, -1.3598)"},label:!1},{type:"textbox",options:{text:"<i>B</i> (-0.55, -1.11905)"},label:!1},{type:"textbox",options:{text:"<i>C</i> (1.2, -0.5573)"},label:!1},{type:"textbox",options:{text:"<i>D</i> (3.25, 0.10075)"},label:!1}]}]}]}],cf=function(){function a(b){id(this,a),this.require_user=b.require_user,this.button_id="button#"+b.label,this.dropdown=null,this.active=!1}return jd(a,[{key:"setupMenu",value:function(a,b){var c=this;this.container=a.tools,this.dropdown=this.setupDropdown();var d=this.setupPanel(this.dropdown);return $(b).on("show.bs.dropdown",function(){c.active=!0,c.dropdown.classed("open",!0),c.checkUser(d,a)}).on("hide.bs.dropdown",this.close.bind(this)),this.dropdown.node()}},{key:"setupDropdown",value:function(){return((arguments.length<=0||void 0===arguments[0]?null:arguments[0])||this.container).append("div").classed("gm-menu-dropdown",!0).on("click",function(){return d3.event.stopPropagation()})}},{key:"setupPanel",value:function(){return((arguments.length<=0||void 0===arguments[0]?null:arguments[0])||this.dropdown).append("div").classed("gm-menu-panel",!0)}},{key:"checkUser",value:function(a,b){a.selectAll("*").remove();var c=a.append("div").classed("panel-body",!0);!this.require_user||De.logged_in?this.loadContent(a,c,b):this.showMessage(a,null,null,b&&b.settings.get("custom_login_method"))}},{key:"showWorking",value:function(a,b){a.selectAll("*").remove(),a.attr("class","panel-body"),a.append("p").text(b||"Working...")}},{key:"showMessage",value:function(a,b){var c=this,d=arguments.length<=2||void 0===arguments[2]?"danger":arguments[2],e=arguments[3];a.selectAll("*").remove();var f=a.append("div").classed("panel-body gm-clear-after",!0),g=De.logged_in,h=g?d:"info";a.classed("panel-default",!1),["danger","warning","info","success"].forEach(function(b){f.classed("alert-"+b,h===b),a.classed("panel-"+b,h===b)}),g?(f.append("p").html(b),f.append("button").property("type","button").classed("btn btn-default",!0).text("Ok").on("click",function(){$(c.button_id).trigger("click"),c.close()})):function(){var a=c;f.append("span").style("line-height","34px").text("Please login to access this functionality.").append("a").property("type","button").classed("btn btn-default",!0).text("Login").style("float","right").style("cursor","pointer").on("click",function(){d3.event.preventDefault(),e?e():De.loginWithGoogle(),$(a.button_id).trigger("click"),a.close()})}()}},{key:"showComplete",value:function(a,b){var c=this;a.selectAll("*").remove(),a.attr("class","alert alert-dismissable alert-success").text(b).style("margin-bottom",0).attr("role","alert").append("button").classed("close",!0).html("&times;").on("click",function(){$(c.button_id).trigger("click"),c.close()})}},{key:"close",value:function(){this.active=!1,this.dropdown.classed("open",!1)}}]),a}(),df=function(){function a(b){var c=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];id(this,a),this.color=c.color||"silver",this.stroke_width=c.stroke_width||6,this.arrow_width=c.arrow_width||8,this.arrow_length=c.arrow_length||16,this.init(b)}return jd(a,[{key:"init",value:function(a){this.div=d3.select(a.parentNode).insert("div","*"),this.div.classed("arrow-outer",!0).html(ef);var b=a.getBoundingClientRect(),c=a.parentNode.getBoundingClientRect();this.screen_pos={x:b.x+b.width/2,y:b.y+b.height/2};var d={x:this.screen_pos.x-c.x,y:this.screen_pos.y-c.y};console.log(this.screen_pos,d),this.div.style("position","absolute").style("z-index",-1).style("transform","translate("+d.x+"px, "+d.y+"px)"),this.arrow=this.div.select(".arrow-outer"),this.arrow.style("transform-origin","top left"),this.arrow.style("transform","rotate(0deg)"),this.arrow_line=this.div.select(".arrow-line").style({height:this.stroke_width+"px",background:this.color,top:-this.stroke_width/2+"px"}),this.arrow_tip=this.div.select(".arrow-tip").style({"border-bottom":this.arrow_width+"px solid transparent","border-top":this.arrow_width+"px solid transparent","border-left":this.arrow_length+"px solid "+this.color,top:"-"+(this.stroke_width+this.arrow_width)+"px"})}},{key:"pointTo",value:function(a,b){this.render(a-this.screen_pos.x,b-this.screen_pos.y)}},{key:"render",value:function(a,b){var c=Math.atan2(b,a),d=Math.max(0,Math.sqrt(a*a+b*b)-this.arrow_length+1);this.arrow.style("transform","rotate("+c+"rad)"),this.arrow_line.style("width",d+"px"),this.arrow_tip.style("left",d-1+"px")}},{key:"show",value:function(){this.div.style("display",null)}},{key:"hide",value:function(){this.div.style("display","none")}},{key:"remove",value:function(){this.div.remove()}}]),a}(),ef='\n<div class="arrow-outer" style="position: absolute; transform-origin: top left">\n  <div class="arrow-line" style="position: relative"></div>\n  <div class="arrow-tip" style="width: 0; height: 0; position: relative"></div>\n</div>\n',ff=[{title:"Quadratic Formula",matches:[{from:"ax^2+bx+c=0",to:"x=(-bsqrt{b^2-4*a*c})/(2*a)",show:!0},{from:"x^2+x+c=0",to:"x=(-1sqrt{1^2-4*1*c})/(2*1)"},{from:"x^2-x+c=0",to:"x=(1sqrt{(-1)^2-4*1*c})/(2*1)"},{from:"-x^2+x+c=0",to:"x=(-1sqrt{1^2-4*-1*c})/(2*-1)"},{from:"-x^2-x+c=0",to:"x=(1sqrt{(-1)^2-4*-1*c})/(2*-1)"},{from:"ax^2+x+c=0",to:"x=(-1sqrt{1^2-4*a*c})/(2*a)"},{from:"ax^2-x+c=0",to:"x=(1sqrt{(-1)^2-4*a*c})/(2*a)"},{from:"x^2+bx+c=0",to:"x=(-bsqrt{b^2-4*1*c})/(2*1)"},{from:"-x^2+bx+c=0",to:"x=(-bsqrt{b^2-4*-1*c})/(2*-1)"}]},{title:"Manually Factoring a Quadratic",one_way:!0,matches:[{from:"x^2+bx+c",to:"(x+)*(x+)",show:!0,from_mapping:{x:"x;x:1","x:1":"x;x:1",b:';"2"',c:';"2"'}},{from:"x^2+x+c",to:"(x+)*(x+)",from_mapping:{x:"x;x:1","x:1":"x;x:1",c:';"2"'}},{from:"x^2-x+c",to:"(x+)*(x+)",from_mapping:{x:"x;x:1","x:1":"x;x:1",c:';"2"'}}]},{title:"Difference of Squares",eq:"a^2-b^2",eq2:"(a+b)*(a-b)",matches:[{from:"a^2-b^2",to:"(a+b)*(a-b)",show:!0},{from:"-a^2+b^2",to:"(a+b)*(b-a)"},{from:"a^2-1",to:"(a+1)*(a-1)"}]},{title:"Quadratic Binomial",matches:[{from:"a^2-2ab+b^2",to:"(a-b)^2"},{from:"a^2-2ba+b^2",to:"(a-b)^2"},{from:"a^2-2a+1",to:"(a-1)^2"},{from:"a^2-2a+1^2",to:"(a-1)^2"},{from:"a^2+2ab+b^2",to:"(a+b)^2",show:!0},{from:"a^2+2ba+b^2",to:"(a+b)^2"},{from:"a^2+2a+1",to:"(a+1)^2"},{from:"a^2+2a+1^2",to:"(a+1)^2"},{from:"1+2b+b^2",to:"(1+b)^2"},{from:"1^2+2b+b^2",to:"(1+b)^2"},{from:"1+2b+b^2",to:"(1+b)^2"},{from:"1^2-2b+b^2",to:"(1-b)^2"}]}],gf=function(a){function b(){return id(this,b),pd(this,(b.__proto__||Object.getPrototypeOf(b)).apply(this,arguments))}return qd(b,a),jd(b,[{key:"loadContent",value:function(a,b,c){a.html('<p style="color: gray; font-style: italic">Drag one side of a formula onto a highlighted expression on the canvas to apply it.</p>'),a.style("padding","5px");var d=a.selectAll("div.gm-formula").data(ff);d.enter().append("div").classed("gm-formula",!0).html(hf).each(function(a){a.el=this}),d.select("label").text(function(a){return a.title}),d.select("div.gm-math1").each(function(a){var b=a.matches.find(function(a){return a.show}).from;a.av1=te.createStaticExpression(this,b,{h_align:"left",v_align:"bottom",max_font_size:25}),a.av1.main.style("margin","auto")}),d.select("div.eq-arrow").text(function(a){return a.one_way?"":""}),d.select("div.gm-math2").each(function(a){var b=a.matches.find(function(a){return a.show}).to;a.av2=te.createStaticExpression(this,b,{h_align:"left",v_align:"bottom",max_font_size:25}),a.av2.main.style("margin","auto")}),d.select(".gm-formula-draggable").call(d3.behavior.drag().origin(function(){return{x:0,y:0}}).on("dragstart",this.dragstart.bind(this,c)).on("drag",this.drag.bind(this,c)).on("dragend",this.dragend.bind(this,c)))}},{key:"dragstart",value:function(a,b){b.best_hit=null;var c=d3.mouse(b.el)[0]<b.el.getBoundingClientRect().width/2;c?b.av1.interaction_handler.highlight_nodes(b.av1.model.children,!0):b.one_way||b.av2.interaction_handler.highlight_nodes(b.av2.model.children,!0),d3.select(b.el).selectAll(".gm-math1,.gm-math2").style("background",function(a,b){return c===(0===b)?"#eee":null}).style("border",function(a,b){return c===(0===b)?"1px solid silver":"1px solid transparent"}),b.arrow=new df(d3.select(b.el).select(c?".gm-math1":".gm-math2").node()),d3.select("html").style("cursor","none"),b.action_infos=Zb(b.matches,a,c),b.action_infos.forEach(function(a){var b=a.der_row.view,c=d3.mouse(b.main.node());a.offset={x:c[0],y:c[1]},ud.setTargetRegions(a.actions,b.settings.get("font_size"),b.getBBox({no_padding:!0}),!1),ud.drawDropAreaHints(b.main,a.actions)})}},{key:"drag",value:function(a,b){var c=[];b.action_infos.forEach(function(a){var b=(a.der_row.view,{x:d3.event.x-.5+a.offset.x,y:d3.event.y-.5+a.offset.y,width:1,height:1}),d=ud.getHits(a.actions,b);c=c.concat(d)}),b.arrow.pointTo(d3.event.sourceEvent.x,d3.event.sourceEvent.y);var d=ud.getHighestPriorityHit(c,{x:0,y:0,width:0,height:0});b.best_hit=d,b.action_infos.forEach(function(a){d&&-1!==a.actions.indexOf(d)?ud.drawDestinationHints(a.der_row.view.main,d):ud.drawDestinationHints(a.der_row.view.main)})}},{key:"dragend",value:function(a,b){if(b.action_infos.forEach(function(a){var b=a.der_row.view;ud.drawDropAreaHints(b.main),ud.drawDestinationHints(b.main)}),b.arrow.remove(),d3.select("html").style("cursor",null),d3.select(b.el).selectAll(".gm-math1,.gm-math2").style("background",null).style("border","1px solid transparent"),b.av1.interaction_handler.highlight_nodes([],!0),b.av2.interaction_handler.highlight_nodes([],!0),b.best_hit){var c=b.best_hit.oldTree;c.startInteraction();var d=c.performAction(b.best_hit);d&&d.newTree&&d.newTree.finishInteraction(),c.for_each(function(a){return a.selected=!1}),c.hide_nodes(),$(this.button_id).trigger("click"),this.close()}}}]),b}(cf),hf="<label></label>\n<div class='gm-formula-draggable' style='display: flex; flex-direction: row; align-items: center; justify-content: space-between; margin-bottom: 1em'>\n  <div style='flex: 1'><div class='gm-math1' style='border: 1px solid transparent; margin: 0 0.5rem; padding: 1rem 0'></div></div>\n  <div class='eq-arrow' style='flex-grow: 0; color: black; text-align: center; font-family: Kalam; font-size: 22px'></div>\n  <div style='flex: 1'><div class='gm-math2' style='border: 1px solid transparent; margin: 0 0.5rem; padding: 1rem 0'></div></div>\n</div>",jf="formulas",kf=new gf({label:jf,require_user:!1}),lf=2,mf=[{menu_title:"Introduction",modal_title:"Welcome to the Graspable Math Canvas!",src:"/shared/content/help-pages/introduction.html",parts:5},{menu_title:"Learning Resources",icon:"glyphicon glyphicon-new-window",external_page:!0,src:"https://graspablemath.com/learn"},{menu_title:"Cheat Sheet",icon:"glyphicon glyphicon-new-window",external_page:!0,src:"https://graspablemath.com/shared/content/gm-summary-sheet.pdf",version:4},{menu_title:"Exploration and presentation mode",modal_title:"User modes",src:"/shared/content/help-pages/user-modes.html",parts:4,version:3},{menu_title:"How do I pick up a group of symbols?",modal_title:"Picking up a group of symbols",src:"/shared/content/help-pages/groups.html",parts:6},{menu_title:"How do I load and save my work?",modal_title:"Loading & Saving Math Sheets",src:"/shared/content/help-pages/login-system.html",parts:2,version:2},{menu_title:"How can I freely rewrite an expression?",modal_title:"Rewriting Expressions With The Keyboard",src:"/shared/content/help-pages/shaking.html",parts:2},{menu_title:"How do I correct a mistake?",modal_title:"Correcting Mistakes",src:"/shared/content/help-pages/correcting-mistakes.html",parts:2},{menu_title:"How do I substitute a term for a variable?",modal_title:"Substitution in Graspable Math",src:"/shared/content/help-pages/substitution.html",parts:2},{menu_title:"How do I work with negative numbers?",modal_title:"Working with Negative Numbers",src:"/shared/content/help-pages/negatives.html",parts:3},{menu_title:"How to add fractions with unlike denominators?",modal_title:"Adding Fractions with Unlike Denominators",switch_on_sound:!1,video:"_CQ6oHM-Nn4"},{menu_title:"How do I assign a math sheet on Google Classroom?",modal_title:"Google Classroom Integration",src:"/shared/content/help-pages/gc-integration.html",parts:4,version:5},{menu_title:"Interactive Gesture Tutorials",icon:"glyphicon glyphicon-new-window",external_page:!0,src:"https://graspablemath.com/tutorial/index.html"},{menu_title:"Contact Us",icon:"glyphicon glyphicon-envelope",external_page:!0,src:"mailto:contact@graspablemath.com"}],nf=null,of=mf[0],of.active_part=0,pf=function(a){function b(){return id(this,b),pd(this,(b.__proto__||Object.getPrototypeOf(b)).apply(this,arguments))}return qd(b,a),jd(b,[{key:"loadContent",value:function(a,b,c){var d=this;b.append("h3").text("Save your math!"),b.append("p").text('Click the "Save" button to save your work on the Graspable Math server.'),b.append("p").style("margin-top","1em").text("Title:"),b.append("div").append("input").attr({type:"text",class:"form-control",id:"canvas_title",value:c.meta_data.title||"Graspable Math Canvas"}),b.append("p").style("margin-top","1em").text("Description:"),b.append("textarea").text(c.meta_data.desc||"").attr({class:"form-control",id:"canvas_description"}).style({height:"6em","margin-bottom":"1em",resize:"vertical"});var e=c.meta_data.owner&&De.user_id!==c.meta_data.owner,f=void 0,g=void 0,h=b.append("div").style("display",e?"none":null);g=h.append("input").attr("type","checkbox"),g.on("change",function(){return f.style("display",g.node().checked?null:"none")}),g.node().checked=c.meta_data&&c.meta_data.public,h.append("span").text(" Publish on GM materials web page."),h.append("br"),f=h.append("span").attr("class","text-muted").style("display",g.node().checked?null:"none").html('(Your math sheet will show up <a target="_blank" href="/materials">here</a> once we have approved it.)'),b.append("p"),b.append("button").property("type","button").classed("btn btn-default",!0).text("Cancel").on("click",function(){$(this.button_id).trigger("click"),this.close()}.bind(this)),b.append("button").property("type","button").classed("pull-right",!0).property("disabled",e).classed("btn btn-primary",!0).text("Save").on("click",function(){var e=!c.meta_data.save_id;c.meta_data.title=$("#canvas_title").val(),c.meta_data.desc=$("#canvas_description").val(),c.meta_data.public=g.node().checked,d.showWorking(b),c.save({},d.saveCallback.bind(d,a,b,c,e))}),b.append("button").property("type","button").classed("pull-right",!0).classed("btn btn-primary",!0).property("disabled",!c.meta_data.save_id).style({"margin-right":"1em"}).text("Duplicate").on("click",function(){var d=$("#canvas_title").val();d===c.meta_data.title&&(d+=" (copy)"),c.meta_data.title=d,c.meta_data.desc=$("#canvas_description").val(),this.showWorking(b),c.save({clone:!0},this.saveCallback.bind(this,a,b,c,!0))}.bind(this))}},{key:"saveCallback",value:function(a,b,c,d,e){if(e)this.showMessage(a,"Sorry, we could not save the canvas.</br>Reason: "+e,"danger");else{if(d){var f=c.getCanvasUrl(location.pathname,{},location.origin);location.href!==f&&window.history.pushState({},document.title,f)}c.updateTitle(),this.showComplete(b,"Saved!"),c.meta_data.public&&nc(c.meta_data.save_id,d,c)}}}]),b}(cf),qf="save",rf=new pf({label:qf,require_user:!0}),sf=function(a){function b(){return id(this,b),pd(this,(b.__proto__||Object.getPrototypeOf(b)).apply(this,arguments))}return qd(b,a),jd(b,[{key:"loadContent",value:function(a,b,c){this.showWorking(b,"Loading...");var d=new XMLHttpRequest,e=c.settings.get("savefile_server")+"/api/saves?user_id="+De.user_id,f=this;d.onreadystatechange=function(){if(4===d.readyState)if(200===d.status){var b=JSON.parse(d.responseText).map(function(a){return a.meta_data.updated_at=new Date(a.updated_at),a.meta_data});b.length>0?(a.selectAll("*").remove(),a.classed("gm-menu-panel",!1),a.classed("gm-load",!0),f.showSaveFiles(a,b,c)):f.showMessage(a,"You have no save files!","info")}else 404===d.status?f.showMessage(a,"Please log in to access save files."):0===d.status?f.showMessage(a,"Are you connected to the internet?"):f.showMessage(a,"We're sorry, there was an error when trying to access your files ("+d.status+").")},d.open("get",e,!0),d.setRequestHeader("Content-Type","application/json"),De.auth_token&&d.setRequestHeader("Authorization","Bearer "+De.auth_token),d.send()}},{key:"showSaveFiles",value:function(a,b,c){this.dropdown.attr("id","gm-load-dropdown");var d=a.select(".gm-load-append input").node()||qc(a).node(),e=a.select(".gm-load-list");e.node()||(e=a.append("div").classed("gm-load-list",!0));var f=e.selectAll(".block").data(b),g=f.enter().append("div").classed("block",!0).on("click",function(a){$(this.button_id).trigger("click"),this.close(),c.loadFromFile(a.save_id,!d.checked,function(){var a=c.getCanvasUrl(location.pathname,{},location.origin);location.href!==a&&window.history.pushState({},document.title,a)})}.bind(this)),h=g.append("p");h.append("span").attr("class","gm-load-title"),h.append("br"),h.append("span").attr("class","gm-load-time"),g.append("span").attr("class","gm-load-delete").on("click",function(d){d3.event.stopPropagation(),d.archived?c.unarchiveFile(d):c.archiveFile(d),this.showSaveFiles(a,b,c)}.bind(this)),f.exit().remove(),f.select(".gm-load-title").text(function(a){return a.title}),f.select(".gm-load-time").text(function(a){return(a.archived?"deleted":rc(Date.now()-a.updated_at))+(a.save_id===c.meta_data.save_id?" (current file)":"")}),f.select(".gm-load-delete").text(function(a){return a.archived?"undo":""}).classed("gm-load-undo",function(a){return a.archived}),f.style("background-color",function(a){return a.archived?"#eee":"white"})}}]),b}(cf),tf="load",uf=new sf({label:tf,require_user:!0}),vf=void 0,wf=function(){function a(){id(this,a),this.menu=d3.select("#gm-gc-modal"),this.submitting=!1,0===this.menu.size()&&this.constructMenu()}return jd(a,[{key:"constructMenu",value:function(){d3.select("body").append("div").node().outerHTML=vf(),this.menu=d3.select("#gm-gc-modal")}},{key:"retrieveCourseList",value:function(){var a=this,b=arguments.length<=0||void 0===arguments[0]||arguments[0];return Be.getCourseList().catch(function(c){if(b)return a.showGCLoginPrompt().then(function(){return a.retrieveCourseList(!1)}).catch(function(b){$(a.menu.node()).modal("hide"),console.error(error)});var d=c.result&&c.result.error&&c.result.error.message;d&&(d+=" ("+c.result.error.status+")"),a.showMessage("Sorry, we can't access your Google Classroom courses.",d||"")})}},{key:"assignTask",value:function(b){var c=a.id,d=this.menu.select("#course-"+c).node().value,e=this.menu.select("#title-"+c).node().value,f=this.menu.select("#instructions-"+c).node().value,g=bd(),h=b.getCanvasUrl(window.location.pathname,{gct:g},window.location.origin),i=[Be.constructCanvasMaterialLink(h,e)],j={title:e,description:f,materials:i};return Be.createCourseWork(d,j).then(function(a){return{gct:g,work:a}})}},{key:"showMessage",value:function(){var b=arguments.length<=0||void 0===arguments[0]?"":arguments[0],c=arguments.length<=1||void 0===arguments[1]?"":arguments[1],d=!(arguments.length<=2||void 0===arguments[2])&&arguments[2],e=a.id;this.menu.select(".modal-footer").style("display","none"),this.menu.select("#gc-login-prompt-"+e).style("display","none"),this.menu.select("#gc-message-"+e).style("display",null),this.menu.select("#gc-message-"+e+" h4").text(b),d?this.menu.select("#gc-message-"+e+" p").html(c):this.menu.select("#gc-message-"+e+" p").text(c)}},{key:"showGCLoginPrompt",value:function(){var b=this,c=arguments.length<=0||void 0===arguments[0]||arguments[0],d=a.id;return new Promise(function(a,e){b.menu.select(".modal-footer").style("display",c?"none":null),b.menu.select("#gc-message-"+d).style("display","none"),b.menu.select("#gc-login-prompt-"+d).style("display",c?null:"none"),b.menu.select("#gc-login-"+d).on("click",c?function(){b.showGCLoginPrompt(!1),Be.signInAsTeacher().then(a,e)}:null)})}},{key:"bindMenuToCanvas",value:function(b){var c=this,d=a.id;this.showGCLoginPrompt(!1),this.menu.select("#gc-account-"+d+" a").text(Be.getName()).on("click",function(){return Be.signInAsTeacher().then(c.bindMenuToCanvas.bind(c,b),c.bindMenuToCanvas.bind(c,b))}),this.menu.select("#course-"+d).selectAll("option").remove(),this.menu.select("#course-"+d).append("option").style("color","gray").property("value","LOADING").text("loading..."),this.retrieveCourseList().then(function(a){var b=c.menu.select("#course-"+d).selectAll("option").data(a);b.exit().remove(),b.enter().append("option"),b.text(function(a){return a.name}).style("color","black").attr("value",function(a){return a.id}),c.updateAssignButton()},function(a){return console.log("error",a)}),this.menu.select("#title-"+d).on("input",this.updateAssignButton.bind(this)).node().value=b.meta_data.title,this.menu.select("#instructions-"+d).node().value=b.meta_data.desc||"",this.menu.select("#assign-btn").on("click",this.onAssignButtonClick.bind(this,b)),this.menu.select("#duplicate-notice").style("display",this.ownsCanvas(b)?"none":null),this.menu.select("#save-notice").style("display",this.ownsCanvas(b)&&b.controller.needsSaving()?null:"none"),this.updateAssignButton()}},{key:"ownsCanvas",value:function(a){return De.user_id===a.meta_data.owner}},{key:"updateAssignButton",value:function(){var b=a.id,c=this.menu.select("#assign-btn"),d=!0;this.submitting?d=!1:""===this.menu.select("#title-"+b).node().value?d=!1:"LOADING"===this.menu.select("#course-"+b).node().value&&(d=!1),c.attr("disabled",d?null:"disabled")}},{key:"handleGCError",value:function(a){var b=a.result&&a.result.error&&a.result.error.message;b&&(b+=" ("+a.result.error.status+")"),this.showMessage("Sorry, we could not create the assignment.",b||"")}},{key:"saveCanvas",value:function(a){var b=this;return new Promise(function(c,d){b.ownsCanvas(a)&&a.controller.needsSaving()?(b.showMessage("We're saving your math sheet...",""),a.save({},function(a,b){a?d(a):c()})):c()})}},{key:"onAssignButtonClick",value:function(a){var b=this;this.submitting=!0,this.updateAssignButton();var c=void 0,d=void 0;this.saveCanvas(a).then(function(){return b.showMessage("We're creating the assignment in Google Classroom...","")}).then(function(){return b.assignTask(a)}).then(function(e){return c=e.work,d=e.gct,b.createGMAssignment(d,a,c)},function(a){return b.handleGCError(a)}).then(function(){b.submitting=!1,b.triggerGCService(d,a),$(b.menu.node()).modal("hide")},function(a){b.submitting=!1,b.showMessage("Sorry, we could not reach the GM Server to create the assignment."),Be.deleteCourseWork(c.courseId,c.id)})}},{key:"triggerGCService",value:function(a,b){var c=b.getCanvasUrl(window.location.pathname,{load:b.meta_data.save_id,gct:a},window.location.origin);window.history.pushState({},document.title,c),b.gcService&&b.gcService.init(a)}},{key:"createGMAssignment",value:function(a,b,c){return zb(b.settings.get("savefile_server")+"/api/assignments").contentType("application/json").requestType("post").body({gct:a,course_id:c.courseId,assignment_id:c.id,external_link:c.alternateLink,math_sheet_id:b.meta_data.save_id}).run()}},{key:"show",value:function(a){this.bindMenuToCanvas(a),$(this.menu.node()).modal("show")}}]),a}(),wf.id=bd(),vf=function(){var a=wf.id;return'\n  <div class="modal fade in" tabindex="-1" role="dialog" id="gm-gc-modal" style="display: none">\n    <div class="modal-dialog" role="document">\n      <div class="modal-content">\n        <div class="modal-header" style="margin-bottom: 15px">\n          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true"></span></button>\n          <h4 class="modal-title">Assign In Google Classroom</h4>\n        </div>\n        <div id=\'content\' style=\'margin: 0 2rem; position: relative\'>\n          <p id="gc-account-'+a+'" style=\'text-align: right\'>current account: <a style="cursor: pointer">switch</a></p>\n          <form class="form-horizontal">\n            <div class="form-group">\n              <label for=\'course-'+a+'\' class="col-sm-2 control-label">Course</label>\n              <div class="col-sm-10">\n                <select class="form-control" id="course-'+a+'">\n                </select>\n              </div>\n            </div>\n            <div class="form-group">\n              <label for="title-'+a+'" class="col-sm-2 control-label">Title</label>\n              <div class="col-sm-10">\n                <input type="text" class="form-control" id="title-'+a+'">\n              </div>\n            </div>\n            <div class="form-group">\n              <label for="instructions-'+a+'" class="col-sm-2 control-label">Instructions</label>\n              <div class="col-sm-10">\n                <textarea class="form-control" id="instructions-'+a+'" rows="3"></textarea>\n              </div>\n            </div>\n          </form>\n          <div id="gc-login-prompt-'+a+'" style="text-align: center; display:none; position: absolute;height: 100%;width: 100%;background: white;top: 0;padding: 2rem">\n            <p>Please click the icon to log in with your Google Classroom teacher account and give us permission to assign tasks to your courses.</p>\n            <p><a id="gc-login-'+a+'" style="cursor: pointer"><img src="/shared/imgs/3rd-party/gc-64x64@2x.png" style=\'width:64px\'></a></p>\n          </div>\n          <div id="gc-message-'+a+'" style="text-align: center; display:none; position: absolute;height: 100%;width: 100%;background: white;top: 0;padding: 2rem">\n            <h4></h4>\n            <p></p>\n          </div>\n        </div>\n        <div class="modal-footer">\n          <p id=\'duplicate-notice\' style=\'text-align: left; font-style: italic; display: none\'>\n            You don\'t own this math sheet and the owner might change it.\n            You can duplicate the sheet in the save menu before assigning it to avoid that.\n          </p>\n          <p id=\'save-notice\' style=\'text-align: left; font-style: italic; display: none\'>\n            We will save your latest changes when you click "Assign".\n          </p>\n          <button class="btn btn-default" data-dismiss="modal">Close</button>\n          <button id="assign-btn" class="btn btn-primary" disabled>Assign</button>\n        </div>\n      </div>\n    </div>\n  </div>'},xf=function(a){function b(){return id(this,b),pd(this,(b.__proto__||Object.getPrototypeOf(b)).apply(this,arguments))}return qd(b,a),jd(b,[{key:"loadContent",value:function(a,b,c){this.gcMenu=this.gcMenu||new wf,c.meta_data.save_id?this.showShareOptions(a,c.meta_data,c):De.logged_in?this.showMessage(a,"Please save your work first!"):this.showMessage(a,"Please log in to save your work first!")}},{key:"showShareOptions",value:function(a,b,c){function d(a){i.classed("active",function(b){return b===a}),h.selectAll(".tab-content").style("display",function(b){return b===a?null:"none"}),"Email"===a?d3.select("#publish-done-btn").style("display","none"):d3.select("#publish-done-btn").style("display",null)}function e(){var b=$("#toEmail").val(),d=$("#email_subject").val(),e=$("#email_body").val(),f=/\S+@\S+\.\S+/.test(b);if(p.classed("has-error",!f),f){var g={};g.toEmail=b,g.subject=d,g.body=e;var i=this,j=new XMLHttpRequest;j.onreadystatechange=function(){200===j.status&&j.readyState<4?i.showWorking(h,"Sending..."):4==j.readyState&&(200==j.status?i.showComplete(h,"Sent."):(console.warn("Error sending email:",j.status,j.responseText,j),i.showMessage(a,"Could not send email.","danger")))},j.open("POST",c.settings.get("email_server")+"/api/send_email_to",!0),j.setRequestHeader("Content-Type","application/json"),De.auth_token&&j.setRequestHeader("Authorization","Bearer "+De.auth_token),j.send(JSON.stringify(g))}}var f=this,g=c.settings.get("enable_google_classroom");b.save_id;a.selectAll("*").remove();var h=a.append("div").classed("panel-body gm-clear-after",!0),i=h.append("ul").attr("class","nav nav-tabs").style("margin-bottom","1.4em").selectAll("li").data(g?["Social","Link","Email","Embed"]:["Link","Email","Embed"]).enter().append("li").attr("id",function(a){return a+"-tab"});i.append("a").style("cursor","pointer").text(function(a){return a}).on("click",d),h.selectAll(".tab-content").data(g?["Social","Link","Email","Embed"]:["Link","Email","Embed"]).enter().append("div").attr("class","tab-content").attr("id",function(a){return a}),h.select("div#Social").html("\n<div>\n<a id='gc-link' class='gray_on_hover' style='cursor: pointer; display: block'>\n<img src='/shared/imgs/3rd-party/gc-assign@2x.png' style='height: 48px'>\n</a>\n</div>\n").select("#gc-link").on("click",function(){$("body").trigger("click"),f.gcMenu.show(c)}),d(g?"Social":"Link");var j=h.select("div#Link");j.append("h3").text("Here is your link:");var k=c.getCanvasUrl();j.append("div").classed("share_link",!0).append("input").attr({type:"text"}).on("click",function(){this.select(),this.setSelectionRange(0,this.value.length)}).on("input",function(){this.value=k,this.select(),this.setSelectionRange(0,this.value.length)}).node().value=k,j.append("p").text("Keep this link for yourself or share it with others. It will always point to the latest version of this canvas.");var l=c.getCanvasUrl("/embed.html"),m=h.select("div#Embed");m.append("p").text("To embed the saved GM canvas into your own webpage, put the following snippet into the body of your html file.");var n='<script type="text/javascript">url = parent.document.URL; document.write(\'<iframe style="border: none" src=\\\''+l+"&options={\"use_toolbar\": true, \"vertical_scroll\": true}&parent_url='+url+'\\' width=100% height=500px></iframe>');<\/script>";m.append("div").classed("share_link",!0).append("input").attr({type:"text"}).on("click",function(){this.select(),this.setSelectionRange(0,this.value.length)}).on("input",function(){this.value=n,this.select(),this.setSelectionRange(0,this.value.length)}).node().value=n;var o=h.select("div#Email");o.append("h3").text("Send the share link in an email!"),o.append("p").style("margin-top","1em").text("Subject:"),o.append("div").append("input").attr({type:"text",class:"form-control",id:"email_subject",value:b.title||"Graspable Math Canvas"}),o.append("p").style("margin-top","1em").text("Content:"),o.append("textarea").attr({class:"form-control",id:"email_body"}).style({height:"6em",resize:"vertical"}).text("Click here to load the Graspable Math canvas: "+k),o.append("p").style("margin-top","1em").text("Send to:");var p=o.append("div").classed("input-group",!0);p.append("input").attr({type:"email",class:"form-control",id:"toEmail"}).attr({placeholder:"target@email.com"}),p.append("span").classed("input-group-btn",!0).append("button").attr({type:"button",class:"btn btn-primary",id:"send_btn"}).text("Send Email!").on("click",e.bind(this)),h.append("hr");h.append("button").property("type","button").attr("id","publish-done-btn").classed("btn btn-primary",!0).text("Done").on("click",function(){$(this.button_id).trigger("click"),this.close()}.bind(this))}}]),b}(cf),yf="share",zf=new xf({label:yf,require_user:!0}),Af=void 0,Bf=void 0,Cf=null,Df=null,Ef=null,Ff=function(){function a(b,c){var d=!(arguments.length<=2||void 0===arguments[2])&&arguments[2];id(this,a),this.canvas=b,this.div=c.append("div"),this.use_x_mul_sym=!1,this.settings=d?De.getSettingsOfType("AlgebraView"):md.get("AlgebraView").getOrCreateDoc(b.id)}return jd(a,[{key:"render",value:function(){!(arguments.length<=0||void 0===arguments[0])&&arguments[0];this.readData(),this.div.html('<h4>Math Symbols</h4>\n  <div class="checkbox">\n    <label>\n      <input id=\'arithmetic_mul\' type="checkbox" '+(this.use_x_mul_sym?"checked":"")+"> Use '' as multiplication symbol.\n    </label>\n  </div>\n  <div style=\"opacity: 0.67\">\n    <p>Write two times three as '23'. This multiplication symbol is\n    quite similar to the letter 'x', so it is best to avoid expressions containing both.</p>\n  </div>").attr("class","modal-body form-horizontal")}},{key:"readData",value:function(){!(arguments.length<=0||void 0===arguments[0])&&arguments[0];this.use_x_mul_sym=this.settings.get("use_arithmetic_multiplication_symbol")}},{key:"writeData",value:function(){!(arguments.length<=0||void 0===arguments[0])&&arguments[0];this.use_x_mul_sym=this.div.select("input").node().checked,this.settings.get("symbol_mappings")["*"]=this.use_x_mul_sym?"":"",this.settings.get("symbol_mappings")["/"]=this.use_x_mul_sym?"":"",this.settings.set("use_arithmetic_multiplication_symbol",this.use_x_mul_sym)}}]),a}(),Gf=function(){function a(b,c){var d=!(arguments.length<=2||void 0===arguments[2])&&arguments[2];id(this,a),this.canvas=b,this.div=c.append("div"),this.precision=null,this.settings=d?De.getSettingsOfType("AlgebraView"):md.get("AlgebraView").getOrCreateDoc(b.id)}return jd(a,[{key:"render",value:function(){this.readData(),this.div.html('<h4>Displayed Number Precision</h4>\n  <div class="form-group">\n    <label for="scrub-prec" class="col-sm-4 control-label">Decimal Places Shown</label>\n    <div class="col-sm-8">\n      <input type="number" class="form-control" id="scrub-prec" value='+this.precision+' min=0 max=12 step=1>\n    </div>\n  </div>\n  <div style="opacity: 0.67">\n    <p>The number of decimal places that Graspable Math will show for all numbers. Internally,\n    Graspable Math uses a higher precision. Pick a value from 0 to 12.</p>\n  </div>\n').attr("class","modal-body form-horizontal")}},{key:"readData",value:function(){this.precision=this.settings.getIfExists("number_display_precision",3)}},{key:"writeData",value:function(){var a=Math.round(+this.div.select("input").node().value);isNaN(a)||a<0||a>12||this.settings.set("number_display_precision",a)}}]),a}(),Hf=function(){function a(b,c){var d=!(arguments.length<=2||void 0===arguments[2])&&arguments[2];id(this,a),this.canvas=b,this.div=c.append("div"),this.precision=null,this.settings=d?De.getSettingsOfType("Derivation"):md.get("Derivation").getOrCreateDoc(b.id)}return jd(a,[{key:"render",value:function(){this.readData(),this.div.html('<h4>Scrubbing Numbers</h4>\n  <div class="form-group">\n    <label for="scrub-prec" class="col-sm-4 control-label">Scrub Decimal Place</label>\n    <div class="col-sm-8">\n      <input type="number" class="form-control" id="scrub-prec" value='+this.precision+' min=-10 max=10 step=1>\n    </div>\n  </div>\n  <div style="opacity: 0.67">\n    <p>Scrubbing changes numbers by 1/10^place. For example, set the decimal place to 0 to scrub 1s,\n    to 1 to scrub 1/10s, and to -2 to scrub 100s. Pick a value from -10 to 10.</p>\n  </div>\n').attr("class","modal-body form-horizontal")}},{key:"readData",value:function(){this.precision=this.settings.getIfExists("scrub_precision",1)}},{key:"writeData",value:function(){var a=Math.round(+this.div.select("input").node().value);isNaN(a)||a<-10||a>10||this.settings.set("scrub_precision",a)}}]),a}(),If=function(){function a(b,c){var d=!(arguments.length<=2||void 0===arguments[2])&&arguments[2];id(this,a),this.canvas=b,this.div=c.append("div"),this.init(),this.settings=d?De.getSettingsOfType("Derivation"):md.get("Derivation").getOrCreateDoc(b.id)}return jd(a,[{key:"init",value:function(){this.modes=[{name:"Exploration Mode",effects:"Shows action names, trigger hints, and destination hints. Triggers actions when you drop terms.",options:{show_area_hints:!0,show_dest_hints:!0,show_action_names:!0,auto_trigger_actions:!1}},{name:"Presentation Mode",effects:"Shows destination hints. Triggers actions when you drop terms.",options:{show_area_hints:!1,show_dest_hints:!0,show_action_names:!1,auto_trigger_actions:!1}},{name:"Work Mode",effects:"Triggers actions automatically when you hold terms over the target.",options:{show_area_hints:!1,show_dest_hints:!1,show_action_names:!1,auto_trigger_actions:!0}}]}},{key:"updateHintText",value:function(a){this.div.select("#mode-info").text(this.modes[a].effects)}},{key:"render",value:function(){var a=this,b=this;this.readData(),this.div.html('<h4>Tranformating Math Expressions</h4>\n  <div class="form-group">\n    <label class="radio-inline"><input id="gm-set-rb0" type="radio" name="gm-canvas-mode">'+this.modes[0].name+'</label>\n    <label class="radio-inline"><input id="gm-set-rb1" type="radio" name="gm-canvas-mode">'+this.modes[1].name+'</label>\n    <label class="radio-inline"><input id="gm-set-rb2" type="radio" name="gm-canvas-mode">'+this.modes[2].name+"</label>\n  </div>\n  <div style=\"margin-top: -0.5em; opacity: 0.67\">\n    <p style='font-style: italic' id='mode-info'></p>\n    <p>Use exploration mode if you are new to Graspable Math or are learning about\n    a new algebra topic. It is perfect for self-paced exploration of algebraic\n    rules and strategies.</p\n    <p>Use presentation mode for presenting to a classroom, tutoring,\n    or working in a team.</p>\n    <p>Use Work mode for fast and efficient work when you have learned the Graspable Math gestures.\n  </div>\n  ").attr("class","modal-body form").selectAll("input").data(this.modes).property("checked",function(a){return a.active}).on("change",function(a,c){this.checked&&b.updateHintText(c)}).each(function(b,c){return b.active?a.updateHintText(c):null})}},{key:"readData",value:function(){var a=this,b={};Object.keys(this.modes[0].options).forEach(function(c){return b[c]=a.settings.get(c)}),this.modes.forEach(function(a){a.active=Object.keys(a.options).every(function(c){return a.options[c]===b[c]})})}},{key:"writeData",value:function(){var a=this,b=this.div.select('input[type="radio"]:checked');1===b.size()&&function(){var c=b.datum().options;Object.keys(c).forEach(function(b){a.settings.set(b,c[b])})}()}}]),a}(),Fc.prototype.onAMeoi=function(a){this.am_changed&&this.onGGBChange(this.ggb_obj.name)},Fc.prototype.onAMsoi=function(a){this.am_changed=!1},Fc.prototype.onAMChange=function(a){if(a.old_model!==this.model)throw"wrong old_model";this.am_changed=!0,a.new_model!==a.old_model&&(this.model.events.on("change."+this.id,null),this.model.events.on("end-of-interaction."+this.id,null),this.model.events.on("start-of-interaction."+this.id,null),this.model=a.new_model,this.model.events.on("change."+this.id,this.onAMChange.bind(this)),this.model.events.on("end-of-interaction."+this.id,this.onAMeoi.bind(this)),this.model.events.on("start-of-interaction."+this.id,this.onAMsoi.bind(this)));var b=this.ggb_obj.name;if(a.sender!==this.id){if(this.dont_update=!0,this.ggb_obj.movable||this.ggb_panel.ggbApplet.setFixed(b,!1),!this.handleAMPointChange()){this.ggb_obj.movable||this.ggb_panel.ggbApplet.setFixed(b,!1);var c=a.new_model.to_ascii();"function"===this.ggb_obj.type&&a.new_model.children[0].is_group("equals")&&c.split("=")[0]===b?this.ggb_panel.ggbApplet.evalCommand(b+": "+c.split("=")[1]):this.ggb_panel.ggbApplet.evalCommand(b+": "+c)}this.ggb_obj.movable&&this.model.settings.get("locked")&&this.ggb_panel.ggbApplet.setFixed(b,!0),this.dont_update=!1}},Fc.prototype.handleAMPointChange=function(){if("point"!==this.ggb_obj.type)return!1;var a=this.ggb_obj.name,b=this.ggb_panel.matchPoint(this.model);if(b){var c=b.x.get_signed_value(),d=b.y.get_signed_value();this.ggb_panel.ggbApplet.setCoords(a,c,d)}else this.model.children[0].is_group("equals")?this.ggb_panel.ggbApplet.evalCommand(this.model.to_ascii()):this.ggb_panel.ggbApplet.evalCommand(a+": "+this.model.to_ascii());return!0},Fc.prototype.onGGBChange=function(a){if(!this.dont_update&&a===this.ggb_obj.name){var b=this.ggb_obj.value_str.substring(this.ggb_obj.value_str.indexOf(":")+1),c=this.id;if("point"===this.ggb_obj.type){var d=this.ggb_panel.matchPoint(this.model);if(!d)return;var e=this.ggb_panel.matchPointString(b);this.model.numeric_value(d.x,+e[1],c),this.model.numeric_value(d.y,+e[2],c)}else if("segment"===this.ggb_obj.type){var d=this.ggb_panel.matchSegment(this.model);this.model.numeric_value(d.val,+this.ggb_obj.value,c)}else if("function"===this.ggb_obj.type){var f=a+"="+b.split("=")[1];this.model.replace_with(f,c)}else this.model.replace_with(b,c)}},Fc.prototype.unlink=function(){this.model.events.on("change."+this.id,null),this.model.events.on("end-of-interaction."+this.id,null)},Fc.prototype.toJSON=function(){return{type:"GM_GGB_Link",id:this.id,ggb_obj_name:this.ggb_obj.name,row_idx:this.row.idx,dl_id:this.row.dl.id,ggb_panel_id:this.ggb_panel.id}},Fc.fromJSON=function(a,b,c){var d=c.elements().find(function(b){return b.id===a.dl_id}),e=d.rows[a.row_idx];return new Fc(b.getGGBObject(a.ggb_obj_name),e,b)},Gc.prototype.onAMChange=function(a){if(a.old_model!==this.model)throw"wrong old_model";if(a.new_model!==a.old_model&&(this.model.events.on("change."+this.id,null),this.model=a.new_model,this.model.events.on("change."+this.id,this.onAMChange.bind(this))),a.sender!==this.id){var b=a.old_model_ascii||a.old_model.to_ascii(),c=this.ggb_panel.matchSILine(new Id(b)),d=this.ggb_panel.matchSILine(this.model),e=this.ggb_2nd.x,f=this.ggb_2nd.y,g=d.m_val;if(c.b_val!==d.b_val)f=g*e+d.b_val,this.ggb_panel.ggbApplet.setCoords(this.ggb_ic.name,0,d.b_val),this.ggb_panel.ggbApplet.setCoords(this.ggb_2nd.name,e,f);else{var h=f-d.b_val,i=Math.sqrt(e*e+h*h),j=Math.atan2(e>=0?g:-g,e>0?1:-1);e=i*Math.cos(j),f=i*Math.sin(j)+d.b_val,this.ggb_panel.ggbApplet.setCoords(this.ggb_2nd.name,e,f)}}},Gc.prototype.onGGBChange=function(a){if(!this.dont_update)if(a===this.ggb_ic.name){var b=this.ggb_panel.matchSILine(this.model);b.b_node||(this.model.replace_with("y="+(b.m_node?b.m_val:"")+"x+0",this.id),b=this.ggb_panel.matchSILine(this.model)),this.model.numeric_value(b.b_node,this.ggb_ic.y,this.id),this.dont_update=!0,this.ggb_panel.ggbApplet.setCoords(this.ggb_2nd.name,this.ggb_2nd.x,this.ggb_ic.y+b.m_val*(this.ggb_2nd.x-this.ggb_ic.x)),this.dont_update=!1}else if(a===this.ggb_2nd.name){var b=this.ggb_panel.matchSILine(this.model);b.m_node||(b.b_node?this.model.replace_with("y=1x"+(b.b_val<0?"-":"+")+b.b_val,this.id):this.model.replace_with("y=1x",this.id),b=this.ggb_panel.matchSILine(this.model)),this.model.numeric_value(b.m_node,(this.ggb_2nd.y-this.ggb_ic.y)/(this.ggb_2nd.x-this.ggb_ic.x),this.id)}},Gc.prototype.unlink=function(){this.model.events.on("change."+this.id,null),this.model.events.on("end-of-interaction."+this.id,null)},Gc.prototype.toJSON=function(){return{type:"GM_GGB_SI_Line_Link",id:this.id,ggb_ic_name:this.ggb_ic.name,ggb_2nd_name:this.ggb_2nd.name,ggb_obj_name:this.ggb_obj.name,row_idx:this.row.idx,dl_id:this.row.dl.id,ggb_panel_id:this.ggb_panel.id}},Gc.fromJSON=function(a,b,c){var d=c.elements().find(function(b){return b.id===a.dl_id}),e=d.rows[a.row_idx],f=b.getGGBObject(a.ggb_obj_name),g=b.getGGBObject(a.ggb_2nd_name);return new Gc(b.getGGBObject(a.ggb_ic_name),g,f,e,b)},Jf=function(a){function b(a,c){var d=arguments.length<=2||void 0===arguments[2]?{}:arguments[2];arguments.length<=3||void 0===arguments[3]||arguments[3];id(this,b);var e=pd(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,a,c,d,"GeoGebraPanel"));return e.type="ggb-panel",e.ggb_objs=[],e.adding_ggb_object_for_row=void 0,e.dont_update=void 0,e.links=[],e.ggbElement=d.ggbElement,e.ggbElement.ggbPanel=e,e.registerInspectListeners(),e.init(),e}return qd(b,a),jd(b,[{key:"init",value:function(){var a=this;this.div=this.element_div.append("div").style({height:"100%",padding:"5px","overflow-y":"auto","overflow-x":"hidden"}).classed("ggb-panel",!0),this.expander=this.element_div.append("div").on("click",function(){return a.setVisibility(!a.settings.get("hidden"))}),this.setVisibility(this.settings.get("hidden")),this.toolbar_expander=this.element_div.append("div").on("click",function(){return a.setToolbarVisibility(!a.settings.get("show_toolbar"))}),this.div.append("img").attr("id","help-next-btn").style({cursor:"pointer",width:"20px",display:"block",margin:"auto"}).attr("src","/shared/imgs/menu-icons/geogebra.svg").on("click",function(){return a.loadMaterialDialog()}),this.ggbElement.events.on("move."+this.id,this.moveAttached.bind(this)),this.ggbElement.events.on("resize."+this.id,this.resizeAttached.bind(this)),this.ggbElement.events.on("ggb_add."+this.id,this.ggbAddListener.bind(this)),this.ggbElement.events.on("ggb_update."+this.id,this.ggbUpdateListener.bind(this)),this.ggbElement.events.on("ggb_remove."+this.id,this.ggbRemoveListener.bind(this)),this.ggbElement.events.on("ggb_rename."+this.id,this.ggbRenameListener.bind(this)),this.ggbElement.events.on("ggb_click."+this.id,this.ggbClickListener.bind(this)),this.ggbElement.ggbApplet?this.on_ggb_load():this.ggbElement.events.on("ggb_init",this.on_ggb_load.bind(this)),this.resizeAttached(this.ggbElement)}},{key:"setVisibility",value:function(a){this.settings.set("hidden",a),this.settings.get("resizable").x=!a,a&&this.resize_grp&&this.resize_grp.style("display","none"),this.expander.call(Hc,this.settings.hidden),this.div.style("padding",this.settings.get("hidden")?"0":"5px"),a?this.settings.set("prev_width",this.size.width):null!==this.settings.get("prev_width")&&this.settings.set("prev_width",this.size.width),this.resizeElement({width:a?0:this.settings.get("prev_width"),height:this.size.height})}},{key:"setToolbarVisibility",value:function(a){this.settings.set("show_toolbar",a),this.toolbar_expander.call(Ic,!a),this.ggbElement&&this.ggbElement.showToolBar(a)}},{key:"loadMaterialDialog",value:function(){var a=this,b=d3.select("body #gm-ggb-material-modal");0===b.size()&&function(){b=d3.select("body").append("div").attr("id","gm-ggb-material-modal").classed("modal fade",!0).attr("role","dialog").style("display","none");var c=b.append("div").classed("modal-dialog",!0).append("div").classed("modal-content",!0).style("width","180px"),d=c.append("div").classed("modal-body",!0);d.append("p").text("GeoGebra Material ID:");var e=d.append("input").attr({type:"text",id:"mat-id-input"});d.append("p"),d.append("button").attr("type","button").classed("btn btn-primary",!0).text("Load").on("click",function(){console.log(e),a.loadMaterial(e.node().value),$("#gm-ggb-material-modal").modal("hide")})}(),$("#gm-ggb-material-modal").modal("show")}},{key:"loadMaterial",value:function(a){console.log('Loading GGB material "'+a+'"...'),a&&a.length>0&&this.ggbApplet.openMaterial(a)}},{key:"removeElement",value:function(){this.element_div.remove(),this.canvas_model.on("el_inspected."+this.id,null),this.canvas_model.on("active_tool."+this.id,null),this.ggbElement&&-1!==this.canvas_model.elements().indexOf(this.ggbElement)&&this.canvas_model.removeElement(this.ggbElement)}},{key:"registerInspectListeners",value:function(){var a=this;this.canvas_model.on("el_inspected."+this.id,function(b){a.ggb_objs.filter(function(a){return a.highlighted}).forEach(function(b){return a.setGGBHighlight(b,!1)}),b.node&&function(){b.node.is_group("var")&&a.setGGBHighlight(a.getGGBObject(b.node.to_ascii()),!0);var c=b.node.get_root();a.links.forEach(function(b){b.model===c&&a.setGGBHighlight(b.ggb_obj,!0)})}()}),this.canvas_model.on("active_tool."+this.id,function(b){"inspect"!==b.tool&&a.ggb_objs.filter(function(a){return a.highlighted}).forEach(function(b){return a.setGGBHighlight(b,!1)})})}},{key:"on_ggb_load",value:function(){this.ggbApplet=this.ggbElement.ggbApplet,this.updateAllGGBObjects(),this.update(),this.settings.get("links")&&this.loadLinks(this.settings.get("links")),this.setToolbarVisibility(this.settings.get("show_toolbar"))}},{key:"moveAttached",value:function(a){this.settings.get("auto_attach")&&this.translateElement({x:a.pos.x+this.ggbElement.size.width-1,y:a.pos.y},a.animated)}},{key:"resizeAttached",value:function(a){this.settings.get("auto_attach")&&(this.translateElement({x:this.ggbElement.pos.x+a.size.width-1,y:this.ggbElement.pos.y}),this.resizeElement({width:this.size.width,height:a.size.height}))}},{key:"ggbUpdateListener",value:function(a){this.updateGGBObject(a),this.settings.get("show_definitions")&&this.update()}},{key:"ggbClickListener",value:function(a){}},{key:"setGGBHighlight",value:function(a,b){if(a&&a.highlighted!==b){if(b)this.flashObject(a);else{var c=d3.rgb(a.color);this.ggbApplet.setColor(a.name,c.r,c.g,c.b)}a.highlighted=b}}},{key:"flashObject",value:function(a){this.flashing&&(clearInterval(this.blinkTimer),this.ggbApplet.setColor(this.flashingObject.name,this.noFlashColor.r,this.noFlashColor.g,this.noFlashColor.b),"point"===this.flashingObject.type&&this.ggbApplet.setPointSize(this.flashingObject.name,2),"line"===this.flashingObject.type&&this.ggbApplet.setLineThickness(this.flashingObject.name,-1)),this.noFlashColor=this.ggbApplet.getColor(a.name),this.toggle=0,this.flashingObject=a,this.flashing=!0,this.blinkTimer=setInterval(this.blinker.bind(this,a),500)}},{key:"blinker",value:function(a){this.toggle%2==0?(this.ggbApplet.setColor(a.name,132,189,69),"point"===a.type&&this.ggbApplet.setPointSize(a.name,5),"line"===a.type&&this.ggbApplet.setLineThickness(a.name,7)):(this.ggbApplet.setColor(a.name,this.noFlashColor.r,this.noFlashColor.g,this.noFlashColor.b),"point"===a.type&&this.ggbApplet.setPointSize(a.name,2),"line"===a.type&&this.ggbApplet.setLineThickness(a.name,-1)),this.toggle+=1,this.toggle>3&&(clearInterval(this.blinkTimer),this.flashing=!1)}},{key:"setCanvasHighlight",value:function(a,b){this.setCanvasHighlightByLink(a,b)}},{key:"setCanvasHighlightByName",value:function(a,b){this.canvas_model.dls().forEach(function(c){c.rows.forEach(function(c){var d=!1;c.model.for_each(function(c){c.is_group("var")&&!c.fixed&&c.value===a&&(c.selected!==b&&(d=!0),c.selected=b)}),d&&(c.view.renderer.set_style(c.view.model.children),c.view.update_style(!0))})})}},{key:"setCanvasHighlightByLink",value:function(a,b){this.links.forEach(function(c){if(c.ggb_obj&&c.ggb_obj.name===a){var d=c.row.dl.getVisibleRowOn(c.row);d.model.children[0].selected=b,d.view.renderer.set_style(d.view.model.children),d.view.update_style(!0)}})}},{key:"ggbAddListener",value:function(a){this.updateGGBObject(a),this.update()}},{key:"ggbRemoveListener",value:function(a){var b=f(this.ggb_objs,function(b){return a===b.name});-1!==b&&(this.ggb_objs.splice(b,1),this.update(),-1!==(b=f(this.links,function(b){return a===b.ggb_obj.name}))&&(this.links[b].unlink(),this.links.splice(b,1)))}},{key:"ggbRenameListener",value:function(a,b){var c=f(this.ggb_objs,function(b){return a===b.name});-1===c?(this.updateGGBObject(b),this.update()):(this.ggb_objs[c].name=b,this.renameVariableOnCanvas(a,b),this.update())}},{key:"renameVariableOnCanvas",value:function(a,b){var c=b.split("_");this.canvas_model.dls().forEach(function(b){b.rows.forEach(function(b){var d=!1;b.model.for_each(function(b){b.is_group("var")&&!b.fixed&&b.value===a&&(d=!0,b.set_value(c[0],c[1]))}),d&&b.view.render()})})}},{key:"createLink",value:function(a,b){this.links.push(new Fc(a,b,this))}},{key:"updateGGBObject",value:function(a){var b=this.getGGBObject(a);b||(b={name:a,type:this.ggbApplet.getObjectType(a),idx:this.ggbApplet.getObjectNumber(a)},this.ggb_objs.push(b),"point"===b.type&&this.ggbApplet.setLabelVisible(a,!0)),b.def_str=this.ggbApplet.getDefinitionString(a),b.independent=this.ggbApplet.isIndependent(a),b.movable=this.ggbApplet.isMoveable(a),b.visible=this.ggbApplet.getVisible(a),"point"===b.type&&(b.x=this.ggbApplet.getXcoord(a),b.y=this.ggbApplet.getYcoord(a)),b.cmd_str=this.ggbApplet.getCommandString(a);var c=!1,d=this.ggbApplet.getValueString(a);Object.is(d,b.value_str)||(b.value_str=d,c=!0);try{var e=this.ggbApplet.getValue(a);Object.is(e,b.value)||(b.value=e,c=!0)}catch(a){}return c&&this.dont_update!==a&&this.links.forEach(function(b){b.onGGBChange(a)}),b}},{key:"updateAllGGBObjects",value:function(){this.ggbApplet.getAllObjectNames().forEach(this.updateGGBObject.bind(this))}},{key:"getGGBObject",value:function(a){return e(this.ggb_objs,function(b){return b.name===a})}},{key:"nestByType",value:function(a){return d3.nest().key(function(a){return a.type}).sortKeys(d3.ascending).sortValues(function(a,b){return a.idx-b.idx}).entries(a)}},{key:"dropDLRow",value:function(a){var b;if(b=this.matchSILine(a.model)){var c=this.ggbApplet.evalCommandGetLabels("Point[yAxis]");this.ggbApplet.setCoords(c,0,b.b_val);var d=this.ggbApplet.evalCommandGetLabels("(1,"+(b.b_val+b.m_val)+")"),e=this.ggbApplet.evalCommandGetLabels("Line["+[c,d]+"]");this.links.push(new Gc(this.getGGBObject(c),this.getGGBObject(d),this.getGGBObject(e),a,this))}else{var f=this.ggbApplet.evalCommandGetLabels(a.model.to_ascii());if(!f)return;this.ggbApplet.setLabelVisible(f,!0),a.model.settings.get("locked")&&(this.ggbApplet.setFixed(f,!0),this.ggbApplet.setColor(f,68,68,68),this.ggbApplet.setPointSize(f,3)),this.createLink(this.getGGBObject(f),a)}}},{key:"matchSILine",value:function(a){var b=a.match("y={m:\\NUM}*{x:x}{?b:\\NUM}","y={?x:x}{?b:\\NUM}");return b?{m_val:b.m?b.m.get_signed_value():b.x?1:0,b_val:b.b?b.b.get_signed_value():0,m_node:b.m,b_node:b.b}:!!(b=a.match("y=-x{?b:\\NUM}"))&&{m_val:-1,b_val:b.b?b.b.get_signed_value():0,b_node:b.b}}},{key:"matchSegment",value:function(a){return a.match("\\VAR = {val:\\NUM}")}},{key:"matchPoint",value:function(a){return a.match("\\VAR = ({x:\\NUM},{y:\\NUM})","({x:\\NUM},{y:\\NUM})")}},{key:"matchPointString",value:function(a){return this.__pt_rx||(this.__pt_rx=new RegExp(".*= ?\\(([^(),]*),([^(),]*)\\)")),a.match(this.__pt_rx)}},{key:"dropGGBObject",value:function(a){var b=this,c=a.value_str.substring(a.value_str.indexOf(":")+1);this.canvas_model.createElement("derivation",{eq:c,pos:"auto",select_on_create:!0},"ggb-link",function(c){c.getLastModel().setLocked(!a.movable),b.createLink(a,c.getLastRow())})}},{key:"update",value:function(){var a=this,b=this.div.selectAll("div.type").data(this.nestByType(this.ggb_objs));b.enter().append("div").classed("type",!0).append("p"),b.exit().remove(),b.select("p").text(function(a){return Jc(a.key)}).style("font-weight","bold");var c=b.selectAll("p.object").data(function(a){return a.values});c.enter().append("p").classed("object",!0).style("cursor","pointer").on("click",function(b){a.dropGGBObject(b),a.setGGBHighlight(b,!0),a.setCanvasHighlight(b.name,!0)}).on("mouseenter",function(b){a.setGGBHighlight(b,!0),a.setCanvasHighlight(b.name,!0),d3.select(this).style("color","red")}).on("mouseleave",function(b){a.setGGBHighlight(b,!1),a.setCanvasHighlight(b.name,!1),d3.select(this).style("color","black")}),c.exit().remove(),c.text(function(b){return a.show_definitions?b.value_str:b.name})}},{key:"toJSON",value:function(){return cd.merged(this.settings.getModified(),{type:"GeoGebraPanel",id:this.id,pos:this.pos,size:{width:this.settings.get("hidden")?this.settings.get("prev_width"):this.size.width,height:this.size.height},ggbElement:this.ggbElement.id,links:this.links})}},{key:"loadLinks",value:function(a){var b=this,c={GM_GGB_Link:Fc,GM_GGB_SI_Line_Link:Gc};a.forEach(function(a){var d=c[a.type];if(!d)throw"Unknown link type "+a.type;b.links.push(d.fromJSON(a,b,b.canvas_model))})}}],[{key:"fromJSON",value:function(a,b,c){return a.ggbElement=b[a.ggbElement],c.createElement("ggb-panel",a)}}]),b}(ve),new md("GeoGebraPanel").defaults.setAll(md.get("CanvasElement").defaults.getAll()).setAll({type:"GeoGebraPanel",auto_attach:!0,size:{width:120,height:500},min_size:{width:75,height:50},resizable:{x:!0,y:!1},prev_width:null,font_size:15,bg_edit_style:{border:"1px solid silver","background-color":"#eee"},bg_edit_active_style:{"background-color":"#eee"},bg_arrange_style:{"background-color":"#eee"},bg_arrange_active_style:{"background-color":"#eee"},show_definitions:!1,draggable:!1,links:[],hidden:!1,show_toolbar:!0}),a("CanvasModelView",Kf=function(a){function b(a){if("canvas-element"===a)return ve;if("image"===a)return Qf;if("video"===a)return Rf;if("textbox"===a)return Sf;if("graph"===a)return ad.ui.Graph;if("derivation"===a)return tb;if("ggb-panel"===a)return Jf;if("ggb-element"===a)return af;if("table"===a)return ad.ui.Table;if("multichoice"===a)return ad.ui.Multichoice;if("graph-eq"===a)return ad.ui.GraphEq;throw'unkown element type "'+a+'"'}function c(a){var b=arguments.length<=1||void 0===arguments[1]?null:arguments[1];l.create({type:"create",target_type:a.type,target:a,method:b}),a instanceof ve&&(y.setActiveTool("edit",!0),a.events.on("moved."+m,function(b){return l.el_moved({type:"el_moved",target_type:a.type,target:a,pos:b.pos})}),"derivation"===a.type&&(a.events.on("change."+m,function(b){l.el_change({type:"el_change",target_type:a.type,target:a,last_eq:a.getLastModel().to_ascii()}),a.events.on("end-of-interaction."+m,function(b){a.events.on("end-of-interaction."+m,null),setTimeout(function(){return l.el_changed({type:"el_changed",target_type:a.type,target:a,last_eq:a.getLastModel().to_ascii()})},0)})}),a.events.on("inspect_node."+m,function(b){return l.el_inspected({type:"el_inspected",target_type:a.type,target:a,node:b.node})})))}function d(a){var b=arguments.length<=1||void 0===arguments[1]?null:arguments[1];l.remove({type:"remove",target_type:a.type,target:a,method:b}),"derivation"===a.type&&(a.events.on("change."+m,null),a.events.on("moved."+m,null),a.events.on("inspect_node."+m,null))}var e,f,g,h,i,j,k,l=d3.dispatch("create","update","remove","reset","active_tool","input_mode","el_change","el_changed","el_moved","el_inspected"),m=ad.uid(),n=a.settings,o=null,p=[],q=[],r=[],s="mouse",t=!0,u=md.get("Derivation").getOrCreateDoc(a.id),v=!1,w=!0,x=!1,y=function a(b){var c=arguments.length<=1||void 0===arguments[1]||arguments[1];return o=b,t=c,e=o.append("div").style({position:"absolute",left:0,right:0,top:0,bottom:0}),f=e.append("svg").style({position:"absolute",width:"100%",height:"100%",left:0,top:0}).style("pointer-events","none").append("g"),i=e.append("div").style({position:"absolute",left:0,right:0,top:0,bottom:0}),g=o.append("svg").style({position:"absolute",width:"100%",height:"100%",left:0,top:0}).style("pointer-events","none").append("g").attr("id","g_front"),h=o.append("svg").style({position:"absolute",width:"100%",height:"100%",left:0,top:0}).style("pointer-events","none").append("g").attr("id","foreground_svg_g"),j=o.append("div").style({position:"absolute",left:0,right:0,top:0,bottom:0}).style({display:"none","pointer-events":"all"}),k=o.append("div").attr("id","notification_el").classed("alert alert-info alert-dismissible",!0).style({display:"none",position:"absolute"}).on("click",function(){d3.event.stopPropagation()}),k.append("span"),k.append("button").classed("close",!0).on("click",a.hideNotice.bind(this)).append("span").html("&times;"),this};y.docId=function(){return a.id},y.canvas=function(){return a},y.renderAll=function(){p.forEach(function(a){a.render&&a.render()})},y.enableNotifications=function(a){return 0===arguments.length?w:(!a&&w&&this.hideNotice(),w=a,this)},y.showNotice=function(a){var b=arguments.length<=1||void 0===arguments[1]||arguments[1],c=arguments.length<=2||void 0===arguments[2]?"info":arguments[2];k&&w&&(x=!0,k.attr("class","alert alert-"+c+" "+(b?"alert-dismissible":"")),k.select("span").text(a),k.select(".close").style("display",b?null:"hidden"),k.style({display:null,width:o.node().scrollWidth+"px",top:o.node().parentNode.scrollTop+"px"}),setTimeout(function(){o.on("click."+m,y.hideNotice)},0))},y.updateNotice=function(){x&&k.style("top",o.node().parentNode.scrollTop+"px")},y.hideNotice=function(){k&&(x=!1,k.style("display","none"),o.on("click."+m,null))},y.reset=function(){for(nb().unlinkCanvasModel(this);p.length>0;)this.removeElement(p[0]);for(var a=q.length-1;a>=0;a--)this.removePath(q[a]);r=[],this.scroll(0)},y.lockActive=function(a){return 0===arguments.length?v:(v=a,this)},y.setActive=function(a){var b=arguments.length<=1||void 0===arguments[1]||arguments[1];a&&!y.getElementByID(a.id)||v||(a&&(a.setActive(b),"derivation"===a.type&&a.element_div&&e.node().appendChild(a.element_div.node())),p.forEach(function(b){b!==a&&(b.setActive(!1),a||"table"!==b.type&&"textbox"!==b.type||b.unselect())}))},y.inputMode=function(a){if(0===arguments.length)return s;if(s!==a)return s=a,l.input_mode({type:"input_mode",mode:s}),this},y.focusOnDL=function(a){a.events.on("end-of-interaction."+this.id,a.initPosition.bind(a,!0))},y.fontSize=function(a){if(0===arguments.length)return u.get("font_size");u.set("font_size",a),this.getElementsOfType("derivation").forEach(function(a){a.settings.unset("font_size"),a.updateFontSize()})},y.createDL=function(a,b,c){return this.createElement("derivation",a,c,b)},y.createElement=function(d,f,g,h){function i(a){-1===p.indexOf(a)&&(a.setMode(n.get("active_tool")),p.push(a),t&&y.size().height<a.size.height+a.pos.y&&o.style("height",a.pos.y+a.size.height+10+"px"),c(a,g))}var j=b(d),k=ad.extend({docId:a.id},f),l=new j(y,e.node(),k,function(a){i(a),h&&h(a)});return i(l),l},y.addElement=function(a){if(a in p)throw"element is already part of this canvas";return z(r,a),a.canvas_model=y,a.initElement(e.node()),a.setMode(n.get("active_tool")),p.push(a),c(a),y},y.addDL=function(a){return this.addElement(a)},y.createDLs=function(a,b,c,d){function e(g){if(f===a.length)c&&c();else{g&&(b.pos[1]+=g.dims.height);var h=ad.deepCopy(b);h.eq=a[f++],y.createDL(h,e,d)}}var f=0;e()},y.isInFreeVisibleSpace=function(a,b){var c=this.viewport();return!(a.y<c.y||a.y+a.height>c.y+c.height)&&0===this.getIntersectingElements(a,b).length},y.getIntersectingElements=function(a,b){return p.filter(function(c){return b!==c&&ad.HitTester.overlaps(a,c.getBBox())})},y.getClosestElement=function(a){var b=arguments.length<=1||void 0===arguments[1]?null:arguments[1],c=arguments.length<=2||void 0===arguments[2]?1/0:arguments[2],d=b?p.filter(b):p;if(0===d.length)return null;var e=d.map(function(b){return{el:b,dist:b.getDistanceTo(a)}}).sort(function(a,b){return a.dist-b.dist})[0];return e.dist<=c?e.el:void 0},y.moveToFreeSpace=function(a){for(var b=!(arguments.length<=1||void 0===arguments[1])&&arguments[1],c=arguments.length<=2||void 0===arguments[2]?null:arguments[2],d=arguments.length<=3||void 0===arguments[3]?.05:arguments[3],e=a.getBBox(),f=this.viewport(),g=2;g>=0;g-=1){var h=d?g*d:0,i={left:h*f.width,right:h*f.width,top:h*f.height,bottom:h*f.height},j={x:f.x,y:f.y,width:e.width+i.left+i.right,height:e.height+i.top+i.bottom};for(c&&(j.y=c.pos.y+c.size.height+i.top+1);j.y+j.height<f.y+f.height;){for(;j.x+j.width<f.x+f.width;){var k=this.getIntersectingElements(j,a);if(0===k.length)return a.translateElement({x:j.x+i.left,y:j.y+i.top},b),!0;var l=d3.max(k,function(a){return a.pos.x+a.size.width});j.x=l+1}j.x=f.x,j.y=j.y+f.height/20}if(!d)break}return a.settings.set("pos",{x:"center",y:"center"}),a.initPosition(b),!1},y.createPath=function(a,b){var d=new Ue(g.node(),a);return q.push(d),c(d,b),d},y.removePath=function(a){z(q,a),a.remove(),d(a)},y.addPath=function(a){if(-1!==q.indexOf(a))throw"path is already in this model";return a.setContainer(g),a.init(),q.push(a),c(a),a},y.updatePath=function(a){a.update(),l.update({target_type:"path",target:a})},y.removeElement=function(a){z(p,a),r.push(a);var b=a.removeElement();return d(a),b};var z=function(a,b){if(0===a.length)return!1;var c=a.indexOf(b);return-1!==c&&(a.splice(c,1),!0)};y.elements=function(){return p},y.dls=function(){return y.getElementsOfType("derivation")},y.getElementsOfType=function(a){return p.filter(function(b){return b.type===a})},y.getElementByID=function(a){for(var b=0;b<p.length;b++)if(p[b].id===a)return p[b];for(var b=0;b<q.length;b++)if(q[b].id===a)return q[b]},y.getDeletedElementByID=function(a){for(var b=0;b<r.length;b++)if(r[b].id===a)return r[b]},y.paths=function(a){if(!arguments.length)return q;for(var b=0;b<q.length;b++)q[b].remove();q=a.slice();for(var b=0;b<q.length;b++)q[b].setContainer(g),q[b].init();l.reset({target_type:"path",target:q.slice()})};var A=function(a){return function(){var b=d3.interpolateNumber(this.scrollTop,a);return function(a){this.scrollTop=b(a)}}};return y.scroll=function(a){var b=arguments.length<=1||void 0===arguments[1]||arguments[1],c=o.node().parentNode.scrollTop;return 0===arguments.length?c:a===c?this:(y.hideNotice(),b?d3.select(o.node().parentNode).transition().duration(600).tween("scrollTop",A(a)):o.node().parentNode.scrollTop=a,this)},y.scrollToElementTop=function(a,b){var c=arguments.length<=2||void 0===arguments[2]||arguments[2];this.scroll(Math.max(0,a.pos.y-b),c)},y.scrollToShowElement=function(a){var b=arguments.length<=1||void 0===arguments[1]||arguments[1],c=a.getBoundingClientRect(),d=ad.ui.Keyboard(),e=1/0,f=this.viewport();d&&d.visible()?e=d.container().getBoundingClientRect().top:d&&(e=(window.innerHeight||document.documentElement.clientHeight)-d.height());var g=a.pos.y>f.y+f.height,h=a.pos.y+a.size.height<f.y,i=e<c.bottom&&a.pos.y>f.y+10;g||h?this.scroll(Math.max(0,a.pos.y-10),b):i&&this.scroll(Math.max(0,Math.min(a.pos.y-10,this.scroll()-e+c.bottom+50)),b)},y.container=function(){return o},y.html_container=function(){return e},y.background_event_layer=function(a){return i},y.foreground_event_layer=function(a){return j},y.foreground_event_layer_visible=function(a){if(!arguments.length)return j.style("display");j.style("display",a?null:"none")},y.front_svg=function(a){return arguments.length?(g=a,this):g},y.back_svg=function(a){return arguments.length?(f=a,this):f},y.foreground_svg=function(a){return arguments.length?(h=a,this):h},y.size=function(){var a=o.node();return{width:a.clientWidth,height:a.clientHeight}},y.viewport=function(){var a=o.node().parentNode;return{x:0,width:a.clientWidth,y:a.scrollTop,height:a.clientHeight}},y.getActiveTool=function(){return n.get("active_tool")},y.setActiveTool=function(a,b){return n.set("active_tool",a),p.forEach(function(b){return b.setMode(a)}),l.active_tool({type:"active_tool",tool:a,auto:b}),this},y.clearAllTermTracesExcept=function(a){y.getElementsOfType("derivation").forEach(function(b){b!==a&&b.clearTraceProperties()}),tb.hideTermTraces(f,e)},d3.rebind(y,l,"on")}),Lf=function(){function a(b){var c=this;id(this,a),this.id=bd(),this.gct=g("gct"),this.gcsid=g("gcsid"),this.loginModal=d3.select("#gm-gc-student-login-modal"),this.canvas=b,this.is_processing=!1,this.gmAssignment=null,this.gmSubmission=null,this.gcSubmission=null,Be.is_ready?this.init(this.gct,this.gcsid):Be.events.on("APIReady."+this.id,function(){return c.init(c.gct,c.gcsid)})}return jd(a,[{key:"init",value:function(a,b){var c=this;this.is_processing||(this.loginModal.size()||(d3.select("body").append("div").node().outerHTML=Mf(),this.loginModal=d3.select("#gm-gc-student-login-modal")),De.events.on("login."+this.id,function(){return c.init(c.gct,c.gcsid)}),De.events.on("logout."+this.id,function(){return c.init(c.gct,c.gcsid)}),this.canvas.events.on("meta_data_change."+this.id,function(a){a.is_new_sheet&&c.init(null,null)}),this.gct=a,this.gcsid=b,this.gmAssignment=null,this.gmSubmission=null,this.gcSubmission=null,this.gcsid&&this.gct?this.initSubmissionCase():this.gct?this.initAssignmentCase():this.canvas.footer.html(""))}},{key:"initAssignmentCase",value:function(){var a=this;console.log("init assignment case"),this.is_processing=!0,this.showMessage("info","Loading Google Classroom assignment..."),this.fetchAssignmentFromGM().then(function(b){if(console.log("teacher",b.teacher,"user",De.id),b&&De.logged_in&&!a.userIsTeacher())return a.fetchSubmissionFromGM().then(function(b){if(!b)return a.createGCAndGMSubmission()})}).then(function(){if(De.logged_in&&!a.userIsTeacher()&&!a.gcSubmission&&a.gmAssignment){var b=a.userIsTeacher()||a.userIsStudent();return a.fetchSubmissionsFromGC(b).then(function(b){console.log("got submissions",b),a.gcSubmission=b[0]})}}).then(function(){return a.ensureCorrectCanvas()}).then(function(){return a.updateCanvasOwnership()}).then(function(){if(a.userIsTeacher())return a.fetchSubmissionInfo()}).then(function(){var b=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return a.render(b)}).then(function(){return a.is_processing=!1}).catch(function(b){a.is_processing=!1,console.error(b),a.showMessage("danger","This looks like a Google Classroom assignment, but something went wrong. (See browser console for more details.)")})}},{key:"initSubmissionCase",value:function(){var a=this;console.log("init submission case"),this.is_processing=!0,this.showMessage("info","Loading Google Classroom submission..."),this.fetchSubmissionFromGM().then(function(){return a.ensureCorrectCanvas()}).then(function(){if(!a.gmSubmission)throw"Could not find GM submission entry.";if(a.userIsTeacher()||a.userIsStudent())return a.fetchSubmissionsFromGC().then(function(b){console.log("got submissions",b),a.gcSubmission=b[0]}).then(function(){return a.updateCanvasOwnership()}).then(function(){return a.render()});a.render()}).then(function(){return a.is_processing=!1}).catch(function(b){a.is_processing=!1,console.error(b),a.showMessage("danger","This looks like a Google Classroom assignment, but something went wrong. (See browser console for more details.)")})}},{key:"fetchAssignmentFromGM",value:function(){var a=this;console.log("fetch assignment from GM");var b=this.canvas.settings.get("savefile_server")+"/api/assignments/"+this.gct,c=zb(b).contentType("application/json").parseResult(!0);return new Promise(function(b,d){c.run().then(function(c){a.gmAssignment=c.result,console.log("got gmAssignment",a.gmAssignment),b(a.gmAssignment)},d)})}},{key:"fetchSubmissionFromGM",value:function(){var a=this;console.log("fetch submission from GM");var b=this.canvas.settings.get("savefile_server")+"/api/studentSubmissions";this.gcsid?b+="/"+this.gcsid:b+="?gct="+encodeURIComponent(this.gct)+"&user="+encodeURIComponent(De.id);var c=zb(b).contentType("application/json").parseResult(!0);return new Promise(function(b,d){c.run().then(function(c){if(a.gmSubmission=a.gcsid?c.result:c.result[0],!c.result||0===c.result.length)return void b(null);a.gmAssignment=a.gmSubmission.assignment,a.gcsid=a.gmSubmission.submission_id,console.log("got gmSubmission",a.gmSubmission,"and gmAssignment",a.gmAssignment),b(a.gmSubmission)},d)})}},{key:"fetchSubmissionInfo",value:function(){return Be.listStudentSubmissions(this.gmAssignment.course_id,this.gmAssignment.assignment_id).then(function(a){return{submission_count:{all:a.length,turned_in:a.filter(function(a){return"TURNED_IN"===a.state}).length}}})}},{key:"createGCAndGMSubmission",value:function(){var a=this;return console.log("creating submission now"),this.fetchSubmissionsFromGC().then(function(b){if(0===b.length)throw"Could not initialize Google Classroom submission.";return a.gcSubmission=b[0],a.gcsid=a.gcSubmission&&a.gcSubmission.id,a.gcSubmission}).then(this.cloneTeacherCanvas.bind(this)).then(this.postGMSubmission.bind(this)).then(this.addGCSubmissionAttachment.bind(this))}},{key:"postGMSubmission",value:function(){var a=this;return new Promise(function(b,c){console.log("posting gm submission"),zb(a.canvas.settings.get("savefile_server")+"/api/studentSubmissions").contentType("application/json").parseResult(!0).requestType("post").body({gct:a.gct,submission_id:a.gcSubmission.id,math_sheet_id:a.canvas.meta_data.save_id,external_link:a.gcSubmission.alternateLink}).run().then(function(c){a.gmSubmission=c.result,console.log("created gmSubmission",a.gmSubmission),b(a.gmSubmission)},c)})}},{key:"addGCSubmissionAttachment",value:function(){var a=this;console.log("creating gc attachment");var b=Be.constructCanvasMaterialLink(this.getSubmissionUrl());return Be.addAttachment(this.gmAssignment.course_id,this.gmAssignment.assignment_id,this.gmSubmission.submission_id,b).then(function(b){return a.gcSubmission=b,b})}},{key:"cloneTeacherCanvas",value:function(){var a=this;return this.gmAssignment?this.loadCanvas(this.gmAssignment.math_sheet_id).then(function(){console.log("cloning canvas"),a.canvas.save({clone:!0},function(b,c){if(b)throw b;return window.history.pushState({},document.title,a.getSubmissionUrl()),c})}):new Promise(function(a,b){return b()})}},{key:"loadCanvas",value:function(a){var b=this;return new Promise(function(c,d){if(b.canvas.meta_data.save_id===a)return void c();b.canvas.loadFromFile(a,!0,function(a,e){if(a)return void d(a);var f=b.gmSubmission?b.getSubmissionUrl():b.getAssignmentUrl();window.history.pushState({},document.title,f),c(e)})})}},{key:"ensureCorrectCanvas",value:function(){if(this.gmAssignment){var a=this.gmSubmission&&this.gmSubmission.math_sheet_id||this.gmAssignment.math_sheet_id;return a!==this.canvas.meta_data.save_id?this.loadCanvas(a):void 0}}},{key:"loginAndRetryOnError",value:function(a,b){var c=this;return b?a().then(function(a){return a},function(b){return c.showGCLoginPrompt().then(function(){return c.hideModal()},function(a){throw c.hideModal(),a}).then(a)}):a()}},{key:"extractAndThrowGCErrorMessage",value:function(a){throw a&&a.result&&a.result.error&&a.result.error?a.result.error.message+" ("+a.result.error.status+")":a}},{key:"fetchSubmissionsFromGC",value:function(){var a=arguments.length<=0||void 0===arguments[0]||arguments[0];console.log("fetch submission from GC");var b=this.gmAssignment,c=this.gmSubmission&&this.gmSubmission.submission_id,d=c?Be.getStudentSubmission.bind(Be,b.course_id,b.assignment_id,c):Be.listStudentSubmissions.bind(Be,b.course_id,b.assignment_id,"me");return this.loginAndRetryOnError(d,a).then(function(a){if(a&&0!==a.length)return Array.isArray(a)?a:[a];throw"No submission found."}).catch(this.extractAndThrowGCErrorMessage)}},{key:"turnInSubmission",value:function(){var a=this,b=this.gmAssignment,c=this.gmSubmission;return this.saveAndTransferCanvasOwnership(b.teacher.user_id,b.teacher.display_name).then(function(){return Be.turnInSubmission(b.course_id,b.assignment_id,c.submission_id)}).then(function(){a.gcSubmission.state="TURNED_IN"}).catch(this.extractAndThrowGCErrorMessage)}},{key:"saveAndTransferCanvasOwnership",value:function(a,b){var c=this;return new Promise(function(d,e){if(console.log("transferring canvas ownership"),c.canvas.meta_data.owner!==De.user_id)throw"Can't transfer ownership, not owned by current user";c.canvas.save({transferOwnership:{id:a,name:b}},function(a,b){return a?e(a):d(b)})})}},{key:"updateCanvasOwnership",value:function(){var a=this;if(this.gcSubmission&&this.gmAssignment&&this.gmSubmission&&(this.userIsStudent()||this.userIsTeacher())){var b=void 0;if(!this.isTurnedIn()&&this.canvasOwnedByTeacher()?b="return":this.isTurnedIn()&&this.canvasOwnedByStudent()&&(b="turnIn"),b){var c=this.canvas.settings.get("savefile_server")+"/api/studentSubmissions/"+this.gcsid+"/"+b,d=zb(c).contentType("application/json");return new Promise(function(b,c){d.run().then(function(c){a.canvas.meta_data.owner=a.isTurnedIn()?a.gmAssignment.teacher.user_id:a.gmSubmission.student.user_id,a.canvas.meta_data.display_name=a.isTurnedIn()?a.gmAssignment.teacher.display_name:a.gmSubmission.student.display_name,a.canvas.updateTitle(),b()},c)})}}}},{key:"onTurnInButtonClick",value:function(a){var b=this;a.attr("disabled","disabled").text("Turning In..."),this.turnInSubmission().then(function(){return b.render()}).catch(function(a){console.error(a);var c=function(a,b){return"<a target='_blank' href='"+a+"' style='color: inherit; text-decoration: underline; font-weight: bold; cursor: pointer'>"+b+"</a>"};b.showMessage("danger","Could not turn in your work. Please use "+c(b.gmSubmission.external_link,"Google Classroom")+", directly.",!0)})}},{key:"reclaimSubmission",value:function(){var a=this,b=this.gmAssignment,c=this.gmSubmission;return this.loginAndRetryOnError(function(){return Be.reclaimSubmission(b.course_id,b.assignment_id,c.submission_id)}).then(function(){return a.gcSubmission.state="RECLAIMED_BY_STUDENT"}).then(function(){return a.updateCanvasOwnership()}).catch(this.extractAndThrowGCErrorMessage)}},{key:"onReclaimButtonClick",value:function(a){var b=this;a.attr("disabled","disabled").text("Reclaiming..."),this.reclaimSubmission().then(function(){return b.render()}).catch(function(a){console.error(a);var c=function(a,b){return"<a target='_blank' href='"+a+"' style='color: inherit; text-decoration: underline; font-weight: bold; cursor: pointer'>"+b+"</a>"};b.showMessage("danger","Could not reclaim your work. Please use "+c(b.gmSubmission.external_link,"Google Classroom")+", directly.",!0)})}},{key:"attachment_matcher",value:function(a){var b=this.getSubmissionUrl(null,a);return function(a){return a.link&&a.link.url===b}}},{key:"getSubmissionUrl",value:function(){var a=arguments.length<=0||void 0===arguments[0]?this.gct:arguments[0],b=arguments.length<=1||void 0===arguments[1]?this.gcsid:arguments[1];return this.canvas.getCanvasUrl(window.location.pathname,{load:this.canvas.meta_data.save_id,gct:a,gcsid:b},window.location.origin)}},{key:"getAssignmentUrl",value:function(){var a=arguments.length<=0||void 0===arguments[0]?this.gct:arguments[0];return this.canvas.getCanvasUrl(window.location.pathname,{load:this.canvas.meta_data.save_id,gct:a},window.location.origin)}},{key:"showGCLoginPrompt",value:function(){var a=this;return new Promise(function(b,c){a.loginModal.select("#gc-login-prompt").style("display",null),a.loginModal.select("#gc-message").style("display","none"),$(a.loginModal.node()).modal("show"),a.loginModal.select("#gc-login").on("click",function(){Be.signInAsStudent().then(b,c)})})}},{key:"hideModal",value:function(){$(this.loginModal.node()).modal("hide")}},{key:"userIsTeacher",value:function(){return this.gmAssignment&&De.logged_in&&this.gmAssignment.teacher.user_id===De.user_id}},{key:"userIsStudent",value:function(){return this.gmSubmission&&De.logged_in&&this.gmSubmission.student.user_id===De.user_id}},{key:"isTurnedIn",value:function(){return this.gcSubmission&&"TURNED_IN"===this.gcSubmission.state}},{key:"isReturned",value:function(){return this.gcSubmission&&"RETURNED"===this.gcSubmission.state}},{key:"canvasOwnedByTeacher",value:function(){return this.gmAssignment&&this.canvas.meta_data.owner===this.gmAssignment.teacher.user_id}},{key:"canvasOwnedByStudent",value:function(){return this.gmSubmission&&this.canvas.meta_data.owner===this.gmSubmission.student.user_id}},{key:"showMessage",value:function(){var a=arguments.length<=0||void 0===arguments[0]?"danger":arguments[0],b=arguments.length<=1||void 0===arguments[1]?"There was a problem communicating with Google Classroom.":arguments[1],c=arguments[2];console.error(b),this.canvas.footer.html("\n      <span class='alert alert-"+a+"' style='margin-bottom: 5px; display: inline-block'></span>\n    "),c?this.canvas.footer.select("span").html(b):this.canvas.footer.select("span").text(b),this.canvas.showFooter()}},{key:"render",value:function(a){var b=this;if(!this.gmAssignment)return this.canvas.footer.html(""),void this.canvas.showFooter(!1);var c=function(a,b){return"<a target='_blank' href='"+a+"' style='color: inherit; text-decoration: underline; font-weight: bold; cursor: pointer'>"+b+"</a>"};if(this.userIsStudent()&&!this.isTurnedIn())!function(){b.canvas.footer.html("\n        <span class='alert "+(b.isReturned()?"alert-success":"alert-info")+"' style='margin-bottom: 5px; display: inline-block'>\n          <span style='vertical-align: middle'>You're working on a "+c(b.gmAssignment.external_link,"Google Classroom")+" assignment.\n            "+(b.isReturned()?"The teacher has returned this work to you.":"")+'\n          </span>\n          <button class="btn btn-primary" style="margin-top:-0.75rem; margin-bottom: -0.75rem; margin-left: 2rem">\n            '+(b.isReturned()?"Turn In Again":"Turn In")+"\n          </button>\n        </span>\n      ");var a=b.canvas.footer.select("button");a.on("click",function(){return b.onTurnInButtonClick(a)})}();else if(this.userIsStudent()&&this.isTurnedIn())!function(){b.canvas.footer.html("\n        <span class='alert alert-success' style='margin-bottom: 5px; display: inline-block'>\n          You turned in this "+c(b.gmAssignment.external_link,"Google Classroom")+' assignment.\n          <button class="btn btn-default" style="margin-top:-0.75rem; margin-bottom: -0.75rem; margin-left: 2rem">Unsubmit</button>\n          </span>\n      ');var a=b.canvas.footer.select("button");a.on("click",function(){return b.onReclaimButtonClick(a)})}();else if(this.userIsTeacher()&&!this.gmSubmission){var d=void 0,e=a&&a.submission_count,f=this.gmAssignment.external_link.replace(/\/details$/,"/submissions");d=e?c(f,e.turned_in+" of "+e.all+" students have turned in their work."):"Check for "+c(f,"student responses"),this.canvas.footer.html("\n        <span class='alert alert-success' style='margin-bottom: 5px; display: inline-block'>\n          Assigned on Google Classroom. "+d+"\n        </span>\n      ")}else if(this.userIsTeacher()&&this.gmSubmission){var g=void 0,h=this.gmAssignment.external_link.replace(/\/details$/,"/submissions");g=this.isTurnedIn()?c(h,"Grade and return the work"):this.isReturned()?"You have returned the work.":"The student hasn't submitted the work yet.";var i=this.gmSubmission.student.display_name;this.canvas.footer.html("\n        <span class='alert alert-success' style='margin-bottom: 5px; display: inline-block'>\n          "+i+"'s work on their "+c(this.gmAssignment.external_link,"Google Classroom assignment")+".\n           "+g+"\n        </span>\n      ")}else{var j=this.gmSubmission?"work by "+this.gmSubmission.student.display_name:"assignment by "+this.gmAssignment.teacher.display_name;this.canvas.footer.html("\n        <span class='alert alert-info' style='margin-bottom: 5px; display: inline-block'>\n          This is a Google Classroom "+j+". "+c("","Login")+" with the right teacher or student account to work on it.\n        </span>\n      "),this.canvas.footer.select("a").on("click",function(){return De.loginWithGoogle()})}this.canvas.showFooter()}}]),a}(),Mf=function(){return'\n  <div class="modal fade in" tabindex="-1" role="dialog" id="gm-gc-student-login-modal" style="display: none">\n    <div class="modal-dialog" role="document">\n      <div class="modal-content">\n        <div class="modal-header">\n          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true"></span></button>\n          <h4 class="modal-title">Google Classroom</h4>\n        </div>\n        <div id=\'content\' style=\'margin: 1rem 2rem\'>\n          <div id="gc-login-prompt" style="text-align: center; padding: 2rem">\n            <p>Please click the icon to log in with your Google Classroom student account and give us permission to submit your work.</p>\n            <p><a id="gc-login" style="cursor: pointer"><img src="/shared/imgs/3rd-party/gc-64x64@2x.png" style=\'width:64px\'></a></p>\n          </div>\n        </div>\n      </div>\n    </div>\n  </div>'},ad.ui=ad.ui||{},ad.ui.resource_path="../shared/",a("insertCanvas",Nf=function(a,b){return new Of(a,b)}),a("Canvas",Of=function(a,b){var c=this;this.id=ad.uid(),this.meta_data={title:"Untitled Math Sheet"},this.container=d3.select(a),this.screen_size=this.getScreenSize(),this.loaded=!1,this.after_load_callbacks=[],this.initSettings(b),this.events=d3.dispatch("button","meta_data_change"),this.updateTitle(),this.events.on("meta_data_change."+this.id,function(){return c.updateTitle()}),window&&window.gmath_log_ga&&this.settings.get("disable_ga_tracking")&&gmath_log_ga.enabled(!1),this.model=Kf(this),this.model.enableNotifications(!this.settings.get("disable_notifications")),this.model.on("active_tool."+this.id,this.updateModeBtns.bind(this)),this.controller=Rb(this.model).drawing(this.settings.get("drawing")).hwr(this.settings.get("hwr")).use_keyboard(this.settings.get("use_keyboard")).use_hold_menu(this.settings.get("use_hold_menu")).keyboard_max_width(this.settings.get("keyboard_max_width")).askConfirmationOnClosing(this.settings.get("ask_confirmation_on_closing")),this.init(),De.events.on("login."+this.id,function(){return c.updateTitle()}),De.events.on("logout."+this.id,function(){return c.updateTitle()}),this.settings.get("overflow_visible")&&(this.scroll_div.style("overflow","visible"),this.content_div.style("overflow","visible")),this.logger=new Db(this,this.settings.get("log_mouse_trajectories")),this.controller.logger(this.logger),!this.settings.get("parse_url_query_params")||this.meta_data.save_id&&this.settings.get("savefile_server")||this.callWhenReady(this.parseURLQueryParams.bind(this)),this.setupInputModeListeners(),this.gcService=new Lf(this),Kc(this.model,this.finishedLoading.bind(this))}),Of.createFromSaveId=function(a,b){var c=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],d=arguments.length<=3||void 0===arguments[3]?null:arguments[3],e=new Of(b,c);return e.loadFromFile(a,!0,d),e},Of.prototype.initSettings=function(){var a=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];if(this.settings=new nd("Canvas",this.id),this.settings.get("parse_url_options")||a.parse_url_options){var b=ad.getURLParameter("options");try{b&&this.settings.setExisting(JSON.parse(b))}catch(a){console.error("Error parsing url options: ",a)}}this.settings.setExisting(a)},Of.prototype.updateTitle=function(){if(this.settings.get("title_selector")){var a=this.meta_data&&this.meta_data.title||"";De.logged_in&&De.user_id===this.meta_data.owner||this.meta_data.display_name&&(a=a+" ("+this.meta_data.display_name+")"),d3.select(this.settings.get("title_selector")).text(a)}},Of.prototype.getScreenSize=function(){var a=this.container.append("div").style({height:"1in",width:"1in",top:"100%",left:"100%",position:"fixed"}),b=a.node().offsetWidth,c=a.node().offsetHeight;return a.remove(),{width:window.screen.width/b,height:window.screen.height/c}},Of.prototype.callWhenReady=function(a){this.loaded?a(this):this.after_load_callbacks.push(a)},Of.prototype.finishedLoading=function(){var a=this;this.loaded=!0,this.after_load_callbacks.forEach(function(b){return b(a)}),this.after_load_callbacks=[]},Of.prototype.setupInputModeListeners=function(){var a=this;d3.select("body").on("mousedown",function(){return a.model.inputMode("mouse")}),d3.select("body").on("touchstart",function(){return a.model.inputMode("touch")})},Of.prototype.init=function(){this.outer_div=this.container.append("div").classed("flex-container-columns",!0).style({width:this.settings.get("width"),height:this.settings.get("height")}),this.settings.get("use_toolbar")&&this.initToolbar(),this.initOverlayFooter(),this.scroll_div="top"===this.settings.get("toolbar_pos")?this.outer_div.append("div"):this.outer_div.insert("div","div.gm-main-toolbar"),this.scroll_div.style("flex",1).style("-webkit-flex",1),this.scroll_div.classed("gm-canvas",!0).style("width",this.settings.get("width")).style("position","relative").style("overflow-y",this.settings.get("vertical_scroll")?"scroll":"hidden"),this.content_div=this.scroll_div.append("div").style("width","100%").style("min-width",this.settings.get("content_min_width")).style("min-height",this.settings.get("vertical_scroll")?"200%":"100%").style("position","absolute").call(this.model,this.settings.get("vertical_scroll")),this.controller(),this.settings.get("vertical_scroll")&&(this.scroll_div.on("scroll",function(){this.adjustCanvasSize(),this.model.updateNotice()}.bind(this)),this.adjustCanvasSize(!0)),!1!==this.settings.get("identification_interval")&&(this.id_modal=new Sb(this.settings.get("identification_interval")),this.id_modal.events.on("identified",this.onUserIdentification.bind(this)),this.controller.on("start-of-interaction",this.id_modal.resetTimer.bind(this.id_modal))),(!1!==this.settings.get("demo_video_idle_time")&&this.settings.get("demo_video_sources")&&this.settings.get("demo_video_sources").length>0||this.settings.get("use_toolbar")&&(this.settings.get("homework_btn")||this.settings.get("help_btn")))&&(this.video_modal=new Tb(this.settings.get("demo_video_sources")||[],{max_idle_time:this.settings.get("demo_video_idle_time")}),this.controller.on("start-of-interaction.video_modal",this.video_modal.resetTimer.bind(this.video_modal)))},Of.prototype.initOverlayFooter=function(){this.footer||(this.footer=this.outer_div.append("div").style({display:"none",position:"absolute",width:"100%",left:0,bottom:0,"z-index":10,"text-align":"center"}))},Of.prototype.showFooter=function(){var a=arguments.length<=0||void 0===arguments[0]||arguments[0];this.footer.style("display",a?null:"none")},Of.prototype.onUserIdentification=function(a){this.logger.logCustomInteraction("user-id",{user_id:a.id,user_type:a.type})},Of.prototype.initToolbar=function(a){var b=this;if(this.tools=a||this.outer_div.append("div").attr({class:"gm-main-toolbar",role:"toolbar"}).style(this.settings.get("toolbar_on_style")),this.settings.get("minimal")&&this.tools.on("mouseenter",function(){b.toolFadeoutTimer&&clearTimeout(b.toolFadeoutTimer)}).on("mouseleave",this.switchToolbarState.bind(this)),this.settings.get("drawing")&&(this.settings.get("mode_btns").find(function(a){return"erase"===a.label})||this.settings.get("mode_btns").splice(3,0,{type:"radio",group:"draw",state:!1,label:"draw",icon:"glyphicon glyphicon-pencil"},{type:"radio",group:"draw",state:!1,label:"erase",icon:"glyphicon glyphicon-erase"})),this.settings.get("mode_btns")&&this.settings.get("mode_btns").length>0&&this.appendButtonGroup(this.settings.get("mode_btns"),this.onButton),this.settings.get("new_sheet_btn")&&this.appendButtonGroup([this.settings.get("new_sheet_btn")],this.onButton),this.settings.get("undo_btn")||this.settings.get("redo_btn")){var c=[];this.settings.get("undo_btn")&&c.push(this.settings.get("undo_btn")),this.settings.get("redo_btn")&&c.push(this.settings.get("redo_btn")),this.appendButtonGroup(c,this.onButton)}if(this.settings.get("font_smaller_btn")&&this.settings.get("font_larger_btn")){var d=[];d.push(this.settings.get("font_smaller_btn")),d.push(this.settings.get("font_larger_btn")),this.appendButtonGroup(d,this.onButton)}if(this.settings.get("insert_btn")&&Wb(this,ad.ui.resource_path,this.settings.get("insert_menu_items")),this.settings.get("homework_btn")&&Yb(this),this.settings.get("formula_btn")&&_b(this),this.settings.get("share_btn")&&sc(this),this.settings.get("saving_and_loading")&&(pc(this),oc(this)),this.settings.get("submit_btn")&&tc(this),this.settings.get("help_btn")&&ac(this,this.settings.get("show_welcome_tutorial")),this.settings.get("feedback")&&this.settings.get("feedback_btn")&&this.appendButtonGroup([this.settings.get("feedback_btn")],this.onButton),this.settings.get("settings_btn")&&Cc(this),this.settings.get("minimal")){this.tools.classed("gm-main-toolbar-minimal",!0);var e=this.tools.append("div").attr("class","btn-group pull-right").style({"line-height":"26px","margin-left":"40px"});e.append("span").text("powered by").style({"font-style":"italic","font-family":"sans-serif",color:"#909090","font-weight":300,"font-size":"13px"});e.append("a").style({"text-decoration":"none"}).attr({href:"http://graspablemath.com",target:"_blank"}).append("img").attr({alt:"GM",src:this.settings.get("logo_src")}).style({"vertical-align":"-0.3em",height:"1.7em","margin-left":"0.8em","margin-right":"0.2em","font-size":"13px"})}this.settings.get("minimal")&&this.settings.get("static_toolbar")&&this.switchToolbarState(!0)},Of.prototype.resetToolbar=function(){this.tools&&this.tools.selectAll("*").remove(),this.initToolbar(this.tools)},Of.prototype.showHint=function(a,b,c){var d=this.model;c||(c={});var e={pos:{x:-1e3,y:-1e3},size:{width:c.width||220,height:0},text:a,closable:!0,uneditable:!0,static_bg:!0,text_align:"center",dont_log_events:!0,font_size:c.font_size||16,resizable:!1},f=d.createElement("textbox",e,"hint",function(a){var b=d.viewport();a.translateElement({x:c.x||b.x+b.width/2-a.size.width/2,y:c.y||b.y+b.height/2-a.size.height/2})});b&&d.on("create.gm-inital-hint",function(){d.getElementsOfType("textbox").indexOf(f)>=0&&f.fade(),d.on("create.gm-initial-hint",null)})},Of.prototype.parseURLQueryParams=function(){var a=ad.getURLParameter("eq");if(a){a=a.split(";"),this.controller.simulateStartOfInteraction();for(var b=0;b<a.length;b++)this.model.createDL({eq:a[b],pos:"auto"},null,"URL")}},Of.prototype.adjustCanvasSize=function(a){var b=this.scroll_div.node().getBoundingClientRect().height,c=this.content_div.node().getBoundingClientRect().height,d=this.scroll_div.property("scrollTop");if(this.scroll_top||(this.scroll_top=d),a){var e=Math.round(c/b);this.content_div.style("height",b*e+"px")}if(d>this.scroll_top){if(c-d-5<=b){var e=Math.round(c/b)+1;this.content_div.style("height",b*e+"px")}}else if(d<this.scroll_top&&c-d>=2*b&&this.noObjectsHiddenBelowView(d)){var e=Math.round(c/b)-1;this.content_div.style("height",b*e+"px")}this.scroll_top=d},Of.prototype.noObjectsHiddenBelowView=function(a){var b=[];if(b=this.model.elements().concat(this.model.paths()),0===b.length)return!0;for(var c=0;c<b.length;c++){var d=b[c];if(d.pos){if(Array.isArray(d.pos)&&d.pos[1]>a)return!1;if(d.pos.y>a)return!1}else if(d.points&&d.points[0][1]>a)return!1}return!0},Of.prototype.switchToolbarState=function(a,b){var c=this;a?c.turnOnToolbar():b?c.turnOffToolbar():c.toolFadeoutTimer=setTimeout(function(){c.turnOffToolbar()},c.settings.get("toolFadeoutDelay"))},Of.prototype.turnOnToolbar=function(){this.toolFadeoutTimer&&(clearTimeout(this.toolFadeoutTimer),this.toolFadeoutTimer=null),this.tools.style(this.settings.get("toolbar_on_style")),this.toolbarOn=!0},Of.prototype.turnOffToolbar=function(){this.toolFadeoutTimer&&(clearTimeout(this.toolFadeoutTimer),this.toolFadeoutTimer=null),this.tools.style(this.settings.get("toolbar_off_style")),this.toolbarOn=!1},Of.prototype.resize=function(a){this.settings.set("width",a.width),this.settings.set("height",a.height),this.scroll_div.style({width:this.settings.get("width"),height:this.settings.get("height")}),this.tools&&this.tools.style({width:this.settings.get("width")})},Of.prototype.addSubmitButton=function(){var a=!(arguments.length<=0||void 0===arguments[0])&&arguments[0];this.settings.get("submit_btn")||(tc(this,a),this.settings.set("submit_btn",!0))},Of.prototype.onButton=function(a){this.id_modal&&this.id_modal.resetTimer(),this.video_modal&&this.video_modal.resetTimer();var b={mode:"inspect"===this.model.getActiveTool()?"scrub":this.model.getActiveTool(),font_size:this.model.fontSize()};this.updateButton(a),"new sheet"===a.label&&(this.logger.canvas_logger.containsPendingEvents(this.logger.canvas_logger.interactionSequence)&&this.logger.canvas_logger.submitCurrentSequence(),window&&window.gmath_log_ga&&gmath_log_ga.trackEvent(this.settings.get("gm_app_name"),"button press","new_sheet",1),window.open(location.origin+location.pathname)),"undo"===a.label&&(this.logger.canvas_logger.containsPendingEvents(this.logger.canvas_logger.interactionSequence)&&this.logger.canvas_logger.submitCurrentSequence(),this.controller.undo(),window&&window.gmath_log_ga&&gmath_log_ga.trackEvent(this.settings.get("gm_app_name"),"button press","undo",1)),"redo"===a.label&&(this.logger.canvas_logger.containsPendingEvents(this.logger.canvas_logger.interactionSequence)&&this.logger.canvas_logger.submitCurrentSequence(),window&&window.gmath_log_ga&&gmath_log_ga.trackEvent(this.settings.get("gm_app_name"),"button press","redo",1),this.controller.redo()),"HWR"===a.label&&(window&&window.gmath_log_ga&&gmath_log_ga.trackEvent(this.settings.get("gm_app_name"),"button press","hwr",1),this.controller.hwr(a.state)),"transform"===a.label&&(window&&window.gmath_log_ga&&gmath_log_ga.trackEvent(this.settings.get("gm_app_name"),"button press","transform",1),this.model.setActiveTool(Of.mode_name_map[a.label])),"scrub"===a.label&&(window&&window.gmath_log_ga&&gmath_log_ga.trackEvent(this.settings.get("gm_app_name"),"button press","scrub",1),this.model.setActiveTool(Of.mode_name_map[a.label])),"arrange"===a.label&&(window&&window.gmath_log_ga&&gmath_log_ga.trackEvent(this.settings.get("gm_app_name"),"button press","arrange",1),this.model.setActiveTool(Of.mode_name_map[a.label])),"draw"===a.label&&(window&&window.gmath_log_ga&&gmath_log_ga.trackEvent(this.settings.get("gm_app_name"),"button press","draw",1),this.model.setActiveTool(Of.mode_name_map[a.label])),"erase"===a.label&&(window&&window.gmath_log_ga&&gmath_log_ga.trackEvent(this.settings.get("gm_app_name"),"button press","erase",1),this.model.setActiveTool(Of.mode_name_map[a.label])),"help"===a.label&&(window&&window.gmath_log_ga&&gmath_log_ga.trackEvent(this.settings.get("gm_app_name"),"button press","help",1),this.help()),"feedback"===a.label&&(window&&window.gmath_log_ga&&gmath_log_ga.trackEvent(this.settings.get("gm_app_name"),"button press","feedback",1),this.sendFeedback()),"fullscreen"===a.label&&!0===a.state&&(window&&window.gmath_log_ga&&gmath_log_ga.trackEvent(this.settings.get("gm_app_name"),"button press","start fullscreen",1),this.launchFullScreen()),"fullscreen"===a.label&&!1===a.state&&(window&&window.gmath_log_ga&&gmath_log_ga.trackEvent(this.settings.get("gm_app_name"),"button press","stop fullscreen",1),this.cancelFullScreen()),"HWR"===a.label&&!0===a.state||!0!==this.settings.get("hwr")||(window&&window.gmath_log_ga&&gmath_log_ga.trackEvent(this.settings.get("gm_app_name"),"button press","cancel HWR",1),this.controller.cancelHWR()),"larger"===a.label&&(window&&window.gmath_log_ga&&gmath_log_ga.trackEvent(this.settings.get("gm_app_name"),"button press","font larger",1),this.controller.font_larger()),"smaller"===a.label&&(window&&window.gmath_log_ga&&gmath_log_ga.trackEvent(this.settings.get("gm_app_name"),"button press","font smaller",1),this.controller.font_smaller());var c={button:{label:a.label,state:a.state,type:a.type},old_state:b,time:Date.now()};"larger"!==c.button.label&&"smaller"!==c.button.label||(c.button.font_size=this.model.fontSize()),this.events.button(c)},Of.prototype.launchFullScreen=function(a){a=a||document.body,a.requestFullscreen?a.requestFullscreen():a.mozRequestFullScreen?a.mozRequestFullScreen():a.webkitRequestFullscreen?a.webkitRequestFullscreen():a.msRequestFullscreen&&a.msRequestFullscreen()},Of.prototype.help=function(){window.open("http://graspablemath.com/unstable/tutorial/index.html","_blank").focus()},Of.prototype.sendFeedback=function(){window.open("mailto:contact@graspablemath.com","_blank").focus()},Of.prototype.cancelFullScreen=function(){document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen()},Of.prototype.updateModeBtns=function(a){var b=this;a.auto&&this.settings.get("mode_btns").forEach(function(c){c.state=Of.mode_name_map[c.label]===a.tool,c.state&&b.updateButton(c)})},Of.prototype.updateButton=function(a){this.tools&&this.tools.select("button#"+a.label).datum(a).each(function(a){if("toggle"===a.type)a.state=!a.state,d3.select(this).classed("active",a.state);else if("radio"===a.type){var b=this;d3.select(this.parentNode).selectAll("button").each(function(a){a.state=b===this}).classed("active",function(a){return a.state})}})},Of.prototype.appendButtonElement=function(a,b){var c=this,d=a.append("button").attr("id",function(a){return a.label}).attr({type:"button",class:"btn btn-default"}).classed("btn-xs","xs"===c.settings.get("btn_size")).classed("btn-sm","sm"===c.settings.get("btn_size")).classed("active",function(a){return a.state}).style("min-width","4em");if(d.filter(function(a){return"dropdown"===a.type}).classed("toggle-dropdown",!0).attr("data-toggle","dropdown").attr("aria-haspopup","true").attr("aria-expanded","false"),b&&d.call(ad.mtouch_events().on("touch",b.bind(this))),this.settings.get("display_icons")){var e=d.filter(function(a){return a.icon});e.append("i").attr("class",function(a){return a.icon}).style({color:"#555","font-size":"1.2em","line-height":"1.7em"}).style("padding-left",function(a){return"dropdown"===a.type?"0.25em":null}).style("transform",function(a){return"x"===a.flip?"rotateX(180deg)":"y"===a.flip?"rotateY(180deg)":"xy"===a.flip?"rotateZ(180deg)":null}).style("-webkit-transform",function(a){return"x"===a.flip?"rotateX(180deg)":"y"===a.flip?"rotateY(180deg)":"xy"===a.flip?"rotateZ(180deg)":null});var f=e.filter(function(a){return"dropdown"===a.type});f.append("span").html("&nbsp;"),f.append("span").classed("caret",!0),e.append("br")}if(this.settings.get("display_labels")&&(d.append("span").text(function(a){return a.label}).style("color","#555"),!this.settings.get("display_icons"))){var f=d.filter(function(a){return"dropdown"===a.type});f.append("span").html("&nbsp;"),f.append("span").classed("caret",!0)}},Of.prototype.appendButtonGroup=function(a,b,c){if(!this.tools)throw"Can't add buttons if toolbar is disabled.";var d=c?this.tools.insert("div","*"):this.tools.append("div");if(d.attr({class:"btn-group",role:a[0].group}).classed("pull-right",a[0].pull_right),d.selectAll("button").data(a).enter().call(this.appendButtonElement.bind(this),b),1===a.length&&"dropdown"===a[0].type){var e=a[0].html_fn(d.node(),a[0]);d3.select(e).attr("aria-labelledby",a[0].label).classed("dropdown-menu",!0)}return d},Of.prototype.remove=function(){this.tools&&this.tools.remove(),this.tools=null,this.footer=null,this.outer_div.remove(),this.video_modal&&this.video_modal.remove()},Of.minimalOptions={width:"100%",height:"100%",vertical_scroll:!1,toolbar_pos:"top",static_toolbar:!0,undo_btn:{type:"push",label:"undo",icon:"glyphicon glyphicon-chevron-left"},redo_btn:{type:"push",label:"redo",icon:"glyphicon glyphicon-chevron-right"},use_keyboard:!1,use_hold_menu:!1,drawing:!1,display_icons:!0,display_labels:!1,btn_size:"xs",toolbar_on_style:{display:"inline-block",position:"absolute","margin-top":"-35px",padding:"5px","padding-right":"10px",background:"rgba(255, 255, 255, 0.901961)","border-radius":"3px"},toolbar_off_style:{display:"none"},toolFadeoutDelay:500,logo_src:"../shared/imgs/gm-logo.png",overflow_visible:!0,keyboard_max_width:800,ask_confirmation_on_closing:!1,identification_interval:!1},Of.mode_name_map={transform:"edit",scrub:"inspect",arrange:"arrange",draw:"draw",erase:"erase"},Pf=new md("Canvas"),Pf.defaults.setAll({width:"100%",height:"100%",vertical_scroll:!0,content_min_width:"auto",parse_url_query_params:!1,parse_url_options:!0,toolbar_pos:"top",undo_btn:{type:"push",label:"undo",icon:"glyphicon glyphicon-chevron-left"},redo_btn:{type:"push",label:"redo",icon:"glyphicon glyphicon-chevron-right"},new_sheet_btn:{type:"push",label:"new sheet",icon:"glyphicon glyphicon-file"},font_smaller_btn:{type:"push",label:"smaller",icon:"glyphicon glyphicon-text-size",flip:"y"},font_larger_btn:{type:"push",label:"larger",icon:"glyphicon glyphicon-text-size"},formula_btn:!0,help_btn:{type:"push",label:"help",pull_right:!0,icon:"glyphicon glyphicon-question-sign"},hwr_btn:{type:"toggle",label:"HWR",pull_right:!0,state:!0,icon:"glyphicon glyphicon-font"},fullscreen_btn:{type:"toggle",label:"fullscreen",pull_right:!0,state:!1,icon:"glyphicon glyphicon-resize-full"},homework_btn:!1,hwr:!1,feedback_btn:{type:"push",label:"feedback",pull_right:!0,icon:"glyphicon glyphicon-envelope"},feedback:!1,disable_ga_tracking:!1,gm_app_name:"canvas factory",use_keyboard:!0,use_hold_menu:!0,drawing:!0,display_icons:!0,display_labels:!0,btn_size:"sm",mode_btns:[{type:"radio",group:"mode",state:!0,label:"transform",icon:"glyphicon glyphicon-random"},{type:"radio",group:"mode",state:!1,label:"scrub",icon:"glyphicon glyphicon-wrench"},{type:"radio",group:"mode",state:!1,label:"arrange",icon:"glyphicon glyphicon-move"}],use_toolbar:!0,toolbar_on_style:{},toolbar_off_style:{display:"none"},toolFadeoutDelay:0,save_btn:{type:"push",label:"save",pull_right:!0,icon:"glyphicon glyphicon-save"},load_btn:{type:"push",label:"load",pull_right:!0,icon:"glyphicon glyphicon-open"},formulas_btn:!0,insert_btn:!0,submit_btn:!1,insert_menu_items:{derivation:!0,homework:!0,textbox:!0,ggb:!0,video:!0},savefile_server:"https://graspablemath.com",email_server:"https://graspablemath.com",share_btn:{type:"push",label:"share",pull_right:!0,icon:"glyphicon glyphicon-send"},saving_and_loading:!0,settings_btn:!0,title_selector:"#gm-file-title",log_mouse_trajectories:!1,keyboard_max_width:800,ask_confirmation_on_closing:!0,identification_interval:!1,demo_video_sources:[],demo_video_idle_time:!1,show_welcome_tutorial:!1,disable_notifications:!1,active_tool:"edit",custom_login_method:null,enable_google_classroom:!1}),a("CanvasImage",Qf=function(a){function b(a,c){var d=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],e=arguments.length<=3||void 0===arguments[3]?null:arguments[3];id(this,b);var f=pd(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,a,c,d,"CanvasImage"));return f.type="image",f.initCanvasImageSettings(d),f.initCanvasImage(),f.initPosition(),e&&e(f),f}return qd(b,a),jd(b,[{key:"initCanvasImageSettings",value:function(){arguments.length<=0||void 0===arguments[0]||arguments[0];this.settings.get("drop_evt")&&!this.settings.get("url")&&this.settings.set("url",this.tryGetUrl(this.settings.get("drop_evt")))}},{key:"initCanvasImage",value:function(){this.settings.get("image_data")||this.settings.get("url")?this.loadImage():this.getDataFromFile(this.settings.get("drop_evt"))}},{key:"tryGetUrl",value:function(a){if(a){if("string"==typeof a)return a;if(void 0!==a.dataTransfer){var b=a.dataTransfer.getData("text/plain");if("http"===b.slice(0,4))return b;var c=a.dataTransfer.getData("text/html"),d=$("<div>").append(c),e=$(d).find("img").attr("src");if(void 0!==e)return e}return null}}},{key:"getDataFromFile",value:function(a){if(!this.settings.get("image_data")&&a&&a.dataTransfer){var b=new FileReader;b.onload=function(a){this.canvas_image.settings.set("image_data",a.target.result),this.canvas_image.loadImage()},b.onerror=function(a){console.error("error: "+a.target.error)},b.canvas_image=this,b.readAsDataURL(a.dataTransfer.files[0])}}},{key:"loadImage",value:function(){this.image_for_aspect_ratio=new Image,this.image_for_aspect_ratio.src=this.settings.get("url")||this.settings.get("image_data"),this.image=document.createElementNS("http://www.w3.org/2000/svg","image"),this.image.addEventListener("load",this.waitForAspectRatio())}},{key:"waitForAspectRatio",value:function(){var a=this;if(this.image_for_aspect_ratio.complete)this.imageLoaded();else{var b,c;!function(){var d=function a(){if(c.image_for_aspect_ratio.complete)c.imageLoaded();else{setTimeout(a,100)}};b=setTimeout(d,100),c=a}()}}},{key:"imageLoaded",value:function(){this.aspect_ratio=this.image_for_aspect_ratio.height/this.image_for_aspect_ratio.width;var a=this.size.width*this.aspect_ratio;if(this.settings.get("min_size").height=this.settings.get("min_size").width*this.aspect_ratio,!isNaN(this.aspect_ratio)){var b=null===this.settings.get("url")?this.settings.get("image_data"):this.settings.get("url");this.image=this.element_div.append("img").property("src",b).attr({width:this.size.width-4,height:a-4}).style({"pointer-events":"none"}),this.resizeElement({width:this.size.width,height:a})}}},{key:"resize",value:function(a){var b=Math.max(this.settings.get("min_size").width,a.width);b=Math.min(b,b-(a.width+this.pos.x-this.container_size.width));var c=b*this.aspect_ratio;this.resizeElement({width:b,height:c})}},{key:"subTypeResize",value:function(a){this.image.attr({width:this.size.width-4,height:this.size.height-4})}},{key:"toJSON",value:function(){return{type:"CanvasImage",id:this.id,pos:ad.deepCopy(this.pos),size:ad.deepCopy(this.size),url:this.settings.get("url")||this.settings.get("image_data")}}}],[{key:"fromJSON",value:function(a,b,c){return c.createElement("image",a)}}]),b}(ve)),new md("CanvasImage").defaults.setAll(md.get("CanvasElement").defaults.getAll()).setAll({min_size:{width:50,height:20},size:{width:200},url:null,drop_evt:null,image_data:null}),Rf=function(a){function b(a,c){var d=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],e=arguments.length<=3||void 0===arguments[3]?null:arguments[3];id(this,b);var f=pd(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,a,c,d,"CanvasVideo"));return f.type="video",f.loaded=!1,f.initCanvasVideo(),f.initPosition(),e&&e(f),f}return qd(b,a),jd(b,[{key:"initCanvasVideo",value:function(){var a=this;this.video_div=this.element_div.append("div").attr("id","gm_video_div"+this.id).style("width","100%").style("height","100%"),this.settings.get("yt_video_id")?this.createPlayer():(this.video_div.html('<div class="form-group"><label for=\'yt_id'+this.id+'\'>Youtube Video ID</label>\n                           <input type="text" class="form-control" style="max-width: 15em; margin: auto" id=\'yt_id'+this.id+"'></div>\n                           <div class=\"form-group\"><label>time range</label>\n                           <input type=\"text\" style=\"max-width: 5em; margin: auto\" id='yt_from' placeholder='from'>\n                           <input type=\"text\" style=\"max-width: 5em; margin: auto\" id='yt_to' placeholder='to'>\n                           </div>\n                           <button class='btn btn-default'>Load</button>"),this.video_div.style({border:"1px solid silver",padding:"10px","text-align":"center"}),this.video_div.select("button").on("click",function(){var b=a.video_div.select("input").node().value;b&&(a.settings.set("yt_video_id",b),a.settings.set("start_time_sec",a.video_div.select("input#yt_from").node().value||!1),a.settings.set("end_time_sec",a.video_div.select("input#yt_to").node().value||!1),a.video_div.html(""),a.video_div.style({border:null,padding:null,"text-align":null}),a.createPlayer())}))}},{key:"createPlayer",value:function(){return ze.loaded?"undefined"!=typeof YT&&YT&&YT.Player?void(this.player=new YT.Player("gm_video_div"+this.id,{playerVars:{rel:0,enablejsapi:1,modestbranding:1,playsinline:1,origin:"https://graspablemath.com"},height:"100%",width:"100%",events:{onReady:this.onPlayerReady.bind(this),onStateChange:this.onPlayerStateChange.bind(this)}})):void console.warn("Error loading Youtube player."):void ze.loadYTScript(this.createPlayer.bind(this))}},{key:"remove",value:function(){this.player&&this.player.destroy(),this.player=null,Kd(b.prototype.__proto__||Object.getPrototypeOf(b.prototype),"remove",this).call(this),clearTimeout(this.timer)}},{key:"onPlayerStateChange",value:function(){}},{key:"onPlayerReady",value:function(){var a={videoId:this.settings.get("yt_video_id")};this.settings.get("start_time_sec")&&(a.startSeconds=this.settings.get("start_time_sec")),this.settings.get("end_time_sec")&&(a.endSeconds=this.settings.get("end_time_sec")),this.player.cueVideoById(a),this.player.setVolume(this.settings.get("volume")),this.settings.get("is_muted")?this.player.mute():this.player.unMute()}},{key:"toJSON",value:function(){return{type:"CanvasVideo",id:this.id,pos:ad.deepCopy(this.pos),size:ad.deepCopy(this.size),url:this.settings.get("url"),yt_video_id:this.settings.get("yt_video_id"),volume:this.player?this.player.getVolume():this.settings.get("volume"),is_muted:this.player?this.player.isMuted():this.settings.get("is_muted"),start_time_sec:this.settings.get("start_time_sec"),end_time_sec:this.settings.get("end_time_sec")}}}],[{key:"fromJSON",value:function(a,b,c){return c.createElement("video",a)}}]),b}(ve),new md("CanvasVideo").defaults.setAll(md.get("CanvasElement").defaults.getAll()).setAll({min_size:{width:60,height:45},size:{width:400,height:300},yt_video_id:null,volume:100,is_muted:!1,start_time_sec:!1,end_time_sec:!1}),a("TextBox",Sf=function(a){function b(a,c){var d=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],e=arguments.length<=3||void 0===arguments[3]?null:arguments[3];id(this,b);var f=pd(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,a,c,d,"TextBox"));return f.type="textbox",f.events=ad.extend(f.events,d3.dispatch("font_size","text")),f.initTextBoxSettings(d),f.initTextBoxProperties(),f.initTextBox(),f.initPosition(),e&&e(f),f}return qd(b,a),jd(b,[{key:"initTextBoxSettings",value:function(){arguments.length<=0||void 0===arguments[0]||arguments[0];this.settings.get("static_bg")&&(this.settings.set("bg_edit_style",this.settings.get("bg_arrange_style")),this.settings.set("bg_edit_active_style",this.settings.get("bg_arrange_style")))}},{key:"initTextBoxProperties",value:function(){this.uneditable=this.settings.get("uneditable"),this.closable=this.settings.get("closable"),this.font_size=this.settings.get("font_size"),this.element_div.style({height:this.size.height+"px",width:this.size.width+"px"})}},{key:"initTextBox",value:function(){this.uneditable||this.initToolbar(),this.initTextElement(),this.closable&&this.initCloseButton(),this.update(),this.canvas_model.setActive(this,!0),this.uneditable||("edit"===this.mode&&this.settings.get("select_text_on_create")&&this.selectAllText(),this.switchToolbarState("edit"===this.mode&&this.active))}},{key:"initToolbar",value:function(){function a(a,c){var d=a.append("button").attr("id",function(a){return a.label}).attr({type:"button",class:"btn btn-default"}).classed("input-xs",!0);d.on("click",c.bind(b)),d.append("span").text(function(a){return a.label}).style("color","#555")}this.toolbar_on_style={display:"inline-block",position:"fixed","margin-top":"-20px",width:"100%"},this.toolbar_off_style={display:"none"},this.toolFadeoutDelay=500,this.font_btns=[{type:"push",label:"-",icon:"glyphicon glyphicon-text-size",flip:"y"},{type:"push",label:"+",icon:"glyphicon glyphicon-text-size"}],this.tools=this.element_div.append("div").attr({class:"btn-toolbar",role:"toolbar"}).style(this.settings.get("use_toolbar")?this.toolbar_on_style:this.toolbar_off_style);var b=this;this.tools.append("div").attr({class:"btn-group"}).classed("pull-right",!0).selectAll("button").data(this.font_btns).enter().call(a,this.onButton)}},{key:"initTextElement",value:function(){this.text_element=this.element_div.append("div").classed("gm-no-focus-outline",!0).style({padding:this.settings.get("padding")+"px","font-size":this.font_size+"px","text-align":this.settings.get("text_align")}).property("innerHTML",this.settings.get("text")).attr("contenteditable",this.uneditable?"contenteditable":"").on("input",function(){var a=this.settings.get("text");this.update(),this.emitEvent("text",{element:{type:"textbox",id:this.id,old_state:a,new_state:this.settings.get("text")}})}.bind(this))}},{key:"initCloseButton",value:function(){var a=2.5*this.settings.get("font_size"),b=(this.size.width-a)/2;this.button=this.element_div.append("svg").style({position:"absolute",left:b,width:a+2+"px",height:a+2+"px"}),this.button_grp=this.button.append("g"),this.button_grp.append("circle").attr({r:a/2,cx:a/2+1,cy:a/2+1}).style({stroke:"#ddd","stroke-width":1,fill:"white"}),this.button_grp.append("text").text("OK").attr({x:"50%",y:"50%","text-anchor":"middle","alignment-baseline":"central"}).style({fill:"#ddd","font-size":this.settings.get("font_size"),"pointer-events":"none"}),this.button.on("click",this.fade.bind(this,null))}},{key:"selectAllText",value:function(){if(window.getSelection){var a=window.getSelection();a.removeAllRanges();var b=document.createRange();b.selectNodeContents(this.text_element.node()),a.addRange(b)}else if(document.selection){var c=document.body.createTextRange();c.moveToElementText(this.text_element.node()),c.select()}}},{key:"setSubTypeActive",value:function(){this.switchToolbarState(this.active)}},{key:"switchToolbarState",value:function(a,b){if(this.tools&&this.settings.get("use_toolbar"))if(b=!0,a&&this.toolFadeoutTimer)clearTimeout(this.toolFadeoutTimer),this.toolFadeoutTimer=null;else if(a)this.turnOnToolbar();else{if(this.dragging)return;b?this.turnOffToolbar():this.toolFadeoutTimer=setTimeout(function(){this.turnOffToolbar()}.bind(this),this.toolFadeoutDelay)}}},{key:"turnOnToolbar",value:function(){this.tools.style(this.toolbar_on_style)}},{key:"turnOffToolbar",value:function(){this.tools.style(this.toolbar_off_style),this.toolFadeoutTimer=null}},{key:"onButton",value:function(a){"+"===a.label?this.increaseTextSize():"-"===a.label&&this.decreaseTextSize()}},{key:"changeFontSize",value:function(a){var b=this.font_size;this.font_size=Math.max(this.settings.get("min_font_size"),Math.min(a,this.settings.get("max_font_size"))),this.font_size!==b&&(this.text_element.style("font-size",this.font_size+"px"),this.emitEvent("font_size",{element:{type:"textbox",id:this.id,old_state:b,new_state:this.font_size}}),this.update())}},{key:"increaseTextSize",value:function(){var a;a=this.font_size<12?1:this.font_size<28?2:this.font_size<36?8:12,this.changeFontSize(this.font_size+a)}},{key:"decreaseTextSize",value:function(){var a;a=this.font_size<=12?1:this.font_size<=28?2:this.font_size<=36?8:12,this.changeFontSize(this.font_size-a)}},{key:"setText",value:function(a){this.text_element.node().innerHTML=a,this.update()}},{key:"update",value:function(){this.settings.set("text",this.text_element.node().innerHTML),this.size.height=this.text_element.node().offsetHeight,this.closable&&(this.size.height+=3*this.settings.get("font_size")),this.element_div.style({height:this.size.height+"px",width:this.size.width+"px"}),this.closable&&this.button.attr("transform","translate("+[this.size.width/2,this.size.height-3*this.settings.get("font_size")]+")")}},{key:"subTypeResize",value:function(){this.update()}},{key:"unselect",value:function(){window.getSelection().removeAllRanges(),this.text_element.node().blur()}},{key:"fade",value:function(a){this.element_div.transition().duration(750).style("opacity",0).each("end",function(){this.canvas_model.removeElement(this),a&&a()}.bind(this))}},{key:"cancelFade",value:function(){this.element_group.transition().duration(0).style("opacity",1)}},{key:"toJSON",value:function(){var a={id:this.id,type:"TextBox",pos:this.pos,size:this.size,uneditable:this.uneditable,closable:this.closable,font_size:this.font_size};return this.settings.get("text")!==this.settings.parent.get("text")&&(a.text=this.settings.get("text")),a}}],[{key:"fromJSON",value:function(a,b,c){return c.createElement("textbox",a,"load",function(a){a.unselect()})}}]),b}(ve)),new md("TextBox").defaults.setAll(md.get("CanvasElement").defaults.getAll()).setAll({text:"Edit this text.",min_size:{width:50,height:50},size:{width:300,height:200},padding:20,text_align:"left",resizable:{x:!0,y:!1},uneditable:!1,closable:!1,font_size:20,min_font_size:10,max_font_size:60,use_toolbar:!0,static_bg:!1,select_text_on_create:!1}),ad.ui=ad.ui||{},ad.ui.Keyboard=function(){var a=null,b=function(){return function(){function a(a){if(a.alts){var c=d3.event.finger.dist_x,d=d3.event.finger.dist_y;if(!(c*c+d*d<36)){var e=[];d3.select("#"+a.id+"-content").selectAll("div").each(function(a){var b=d3.mouse(this),c=b[0]-i/2,d=b[1]-j/2;e.push({el:this,dist:Math.sqrt(c*c+d*d)})}),0!==e.length&&(e.sort(function(a,b){return a.dist-b.dist}),b(e[0].el,e[0].dist<100))}}}function b(a,b){d3.select(a.parentNode).selectAll("div").each(function(c){d3.select(this).style("background",this===a&&b?"silver":"none")}),p=b?d3.select(a).datum():null}function c(a){"change"===a&&!1!==I&&K.caption(I),t[a](q.latex())}function d(a){function b(a){return' style="width:'+i*a+"px; height: "+j+'px" '}var c=a.selectAll(".key").data(l).enter().append("div").classed("key",!0).call(o);c.filter(function(a){return"backspace"==a.type}).classed("backspace-key",!0).append("svg").classed("key-icon-svg",!0).append("path"),c.filter(function(a){return"arrow"==a.type}).classed("arrow-key",!0).append("svg").classed("key-icon-svg",!0).append("path"),c.filter(function(a){return a.name}).classed("normal-key",!0).append("span").classed("keylabel",!0),c.filter(function(a){return a.alts}).append("span").classed("dots",!0),d3.select("html").on("click.gm-keyboard",function(){var a=d3.event;$("[data-original-title]").each(function(){$(this).is(a.target)||0!==$(this).has(a.target).length||0!==$(".popover").has(a.target).length||$(this).popover("hide")})}),c.filter(function(a){return a.alts}).attr("id",function(a){return a.id}).each(function(a){a.alts=a.alts.map(function(b){return"object"!=typeof b&&(b={name:b}),b.parent_key=a,b}),$(this).popover({html:!0,content:function(){return"<div id="+a.id+"-content"+b(a.alts.length)+"></div>"},title:function(){return null},trigger:"manual",placement:"top"}),$(this).on("show.bs.popover",function(){$(this).data("bs.popover").tip().css({maxWidth:"none"}).css({borderRadius:0}),d3.select(this).datum().popover_visible=!0}),$(this).on("hide.bs.popover",function(){d3.select(this).datum().popover_visible=!1}),$(this).on("shown.bs.popover",function(){d3.select("#"+a.id+"-content").selectAll("div").data(a.alts).enter().append("div").classed("alt-key",!0).call(aa,!0).style({width:i+"px",height:j+"px"}).style("display","inline-table").on("click",function(a){$(this).popover("hide"),e(a)}.bind(this)).append("span").text(function(a){return a.name||a}).style("display","table-cell").style("vertical-align","middle").style("text-align","center")})})}function e(a){if(a.cmd)q.cmd(a.cmd),q.focus();else{var b=a.val||a.name||a;C&&(b=b.toUpperCase()),q.typedText(b),a.tab&&q.keystroke("Tab")}c("change")}var f,g,h,i,j,k,l,m,n,o,p,q,r="m -5.708,-15.7 20.344,0 c 3.669696,0 6.624,2.954304 6.624,6.624 l 0,17.752 c 0,3.669696 -2.954304,6.624 -6.624,6.624 l -20.488,0 -15.408,-15.48 zM -2.18,-6.948 11.716,6.948M -2.18,6.948 11.716,-6.948",s="M 13.7,16.5 -13.7,16.5 0,-16.5 z",t=d3.dispatch("done","cancel","change"),u="",v=!1,w=null,x=null,y=null,z=null,A="darkorange",B=900,C=!1,D="center",E=null,F=!0,G=MathQuill.getInterface(2),H="123",I=!1,J={spaceBehavesLikeTab:!0,restrictMismatchedBrackets:!0},K=function(){return o=ad.mtouch_events().on("touch",U).on("release",X).on("drag",a).on("hold",Y).hold_time(500),Q(),V(H),""!=u&&q.write(u),this};K.layout=function(a){return 0==arguments.length?H:(H=a,w&&V(H),this)},K.width=function(a){return 0==arguments.length?B:(B=a,w&&S(),this)},K.height=function(){return h},K.container=function(){return w?w.node():null},K.latex=function(a){return 0==arguments.length?(f&&(u=q.latex()),u):(u=a,f&&q.latex(a),this)},K.visible=function(a){return 0==arguments.length?v:v==a?this:(v=a,w?(v?(w.style("display","block"),q.focus(),F&&K.scale_to_fit(),"simple"===H&&V("simple")):(w.style("display","none"),I=!1,K.on("done",null),K.on("change",null),K.on("cancel",null)),this):this)},K.abort=function(){v&&(c("cancel"),K.visible(!1))},K.scale_to_fit=function(){if(w){var a=document.body.getBoundingClientRect().width;if(a<B){var b=a/B;w.style("transform","scale("+b+")").style("-webkit-transform","scale("+b+")").style("transform-origin",D+" bottom").style("-webkit-transform-origin",D+" bottom")}else w.style("transform",null).style("-webkit-transform",null)}},K.position=function(a){return 0==arguments.length?D:D==a?this:(D=a,w?(w.call(ba,D),this):this)},K.caption=function(a,b){return 0===arguments.length?E:(E=a,y?(E?(z.text(a),y.style("display",null)):y.style("display","none"),z.style("color",b||null),this):this)},K.warning=function(a){var b=!(arguments.length<=1||void 0===arguments[1])&&arguments[1];return K.caption(a,A),I=b,K},K.selectAll=function(){q.select()};var L=function(){var a=[],b=[];l.forEach(function(c){b.push(c.row),a.push(c.col)}),m=Math.max.apply(null,a),n=Math.max.apply(null,b),i=130,k=10,j=100;var c=(m+1)*i+m*k+2*k+2*k,d=(n+1)*j+k+k*(n-1)+2*k+2*k,e=B/c;i*=e,j*=e,k*=e,h=d*e+1},M=function(a){l=[],l.keyboard="simple",l.formula={type:"formula",col:2,row:0,cols:6},l.push({name:"Cancel",type:"event",event:"cancel",col:0,row:0,cols:2}),l.push({type:"backspace",col:8,row:0}),l.push({name:"Done",type:"event",event:"done",col:9,row:0,cols:2}),l.push({name:"7",type:"key",col:0,row:1}),l.push({name:"8",type:"key",col:1,row:1}),l.push({name:"9",type:"key",col:2,row:1}),l.push({name:"4",type:"key",col:0,row:2}),l.push({name:"5",type:"key",col:1,row:2}),l.push({name:"6",type:"key",col:2,row:2}),l.push({name:"1",type:"key",col:0,row:3}),l.push({name:"2",type:"key",col:1,row:3}),l.push({name:"3",type:"key",col:2,row:3}),l.push({name:"=",type:"key",col:3,row:1}),l.push({name:".",type:"key",col:3,row:2}),l.push({name:"0",type:"key",col:3,row:3}),l.push({name:"+",type:"key",col:4.5,row:1}),l.push({name:"",type:"key",val:"-",col:5.5,row:1}),l.push({name:"*",type:"key",col:4.5,row:2,dy:"0.5em"}),l.push({name:"",type:"key",val:"/",col:5.5,row:2}),l.push({name:"(",type:"key",col:4.5,row:3}),l.push({name:")",type:"key",col:5.5,row:3}),a&&a.forEach(function(a,b){l.push({name:a,type:"key",col:b%4+7,row:1+Math.floor(b/4)})}),l.push({type:"arrow",dir:"left",col:9,row:3,cols:1,rows:1}),l.push({type:"arrow",dir:"right",col:10,row:3,cols:1,rows:1})},N=function(){l=[],l.keyboard="num",l.formula={type:"formula",col:2,row:0,cols:6},l.push({name:"Cancel",type:"event",event:"cancel",col:0,row:0,cols:2}),l.push({type:"backspace",col:8,row:0}),l.push({name:"Done",type:"event",event:"done",col:9,row:0,cols:2}),l.push({name:"7",type:"key",col:0,row:1}),l.push({name:"8",type:"key",col:1,row:1}),l.push({name:"9",type:"key",col:2,row:1}),l.push({name:"4",type:"key",col:0,row:2}),l.push({name:"5",type:"key",col:1,row:2}),l.push({name:"6",type:"key",col:2,row:2}),l.push({name:"1",type:"key",col:0,row:3}),l.push({name:"2",type:"key",col:1,row:3}),l.push({name:"3",type:"key",col:2,row:3}),l.push({name:"0",type:"key",col:0,row:4}),l.push({name:".",type:"key",col:1,row:4}),l.push({name:"=",alts:["<",">","=","",""],type:"key",col:2,row:4,id:"equal-key"}),l.push({name:"",type:"key",val:"/",col:3,row:1}),l.push({name:"*",type:"key",val:"*",col:3,row:2,dy:"0.5em"}),l.push({name:"",type:"key",val:"-",col:3,row:3}),l.push({name:"+",alts:["+",""],type:"key",col:3,row:4,id:"plus-key"}),l.push({name:"x",type:"key",col:4.5,row:1}),l.push({name:"y",type:"key",col:5.5,row:1}),l.push({name:"(",type:"key",col:4.5,cols:.66,row:2}),l.push({name:")",type:"key",col:5.16,cols:.66,row:2}),l.push({name:"||",cmd:"|",type:"key",col:5.82,cols:.66,row:2}),l.push({name:",",type:"key",col:4.5,row:3}),l.push({name:"_",html:"x<sub>n</sub>",type:"key",col:5.5,row:3}),l.push({name:"e",type:"key",col:4.5,row:4}),l.push({name:"i",type:"key",col:5.5,row:4}),l.push({name:"^2",val:"^2",tab:!0,html:"a<sup>2</sup>",dy:"0.2em",type:"key",col:7,row:1}),l.push({name:"^3",val:"^3",tab:!0,html:"a<sup>3</sup>",dy:"0.2em",type:"key",col:8,row:1}),l.push({name:"^n ",val:"^",html:"a<sup>n</sup>",dy:"0.2em",type:"key",col:9,row:1}),l.push({name:"",type:"key",col:7,row:2}),l.push({name:"n",cmd:"\\nthroot",html:"<sup>n</sup>",dy:"0em",type:"key",col:8,row:2}),l.push({name:"log",type:"key",col:7,row:3}),l.push({name:"ln",type:"key",col:8,row:3}),l.push({name:"",type:"key",col:7,row:4}),l.push({name:"text",html:"long<br>var",two_lines:!0,cmd:"$",type:"key",col:8,row:4}),l.push({name:"abc",type:"load_layout",col:11,row:0}),l.push({name:"",type:"load_layout",col:11,row:1}),l.push({type:"arrow",dir:"left",col:9,row:4,cols:1,rows:1}),l.push({type:"arrow",dir:"up",col:10,row:3,cols:1,rows:1}),l.push({type:"arrow",dir:"down",col:10,row:4,cols:1,rows:1}),l.push({type:"arrow",dir:"right",col:11,row:4,cols:1,rows:1})},O=function(){l=[],l.keyboard="alpha",l.formula={type:"formula",col:2,row:0,cols:6},l.push({name:"Cancel",type:"event",event:"cancel",col:0,row:0,cols:2}),l.push({type:"backspace",col:8,row:0}),l.push({name:"Done",type:"event",event:"done",col:9,row:0,cols:2}),l.push({name:"1",type:"key",col:0,row:1}),l.push({name:"2",type:"key",col:1,row:1}),l.push({name:"3",type:"key",col:2,row:1}),l.push({name:"4",type:"key",col:3,row:1}),l.push({name:"5",type:"key",col:4,row:1}),l.push({name:"6",type:"key",col:5,row:1}),l.push({name:"7",type:"key",col:6,row:1}),l.push({name:"8",type:"key",col:7,row:1}),l.push({name:"9",type:"key",col:8,row:1}),l.push({name:"0",type:"key",col:9,row:1}),l.push({name:"q",type:"key",col:0,row:2}),l.push({name:"w",type:"key",col:1,row:2}),l.push({name:"e",type:"key",col:2,row:2}),l.push({name:"r",type:"key",col:3,row:2}),l.push({name:"t",type:"key",col:4,row:2}),l.push({name:"y",type:"key",col:5,row:2}),l.push({name:"u",type:"key",col:6,row:2}),l.push({name:"i",type:"key",col:7,row:2}),l.push({name:"o",type:"key",col:8,row:2}),l.push({name:"p",type:"key",col:9,row:2}),l.push({name:"a",type:"key",col:.3,row:3}),l.push({name:"s",type:"key",col:1.3,row:3}),l.push({name:"d",type:"key",col:2.3,row:3}),l.push({name:"f",type:"key",col:3.3,row:3}),l.push({name:"g",type:"key",col:4.3,row:3}),l.push({name:"h",type:"key",col:5.3,row:3}),l.push({name:"j",type:"key",col:6.3,row:3}),l.push({name:"k",type:"key",col:7.3,row:3}),l.push({name:"l",type:"key",col:8.3,row:3}),l.push({name:"z",type:"key",col:.6,row:4}),l.push({name:"x",type:"key",col:1.6,row:4}),l.push({name:"c",type:"key",col:2.6,row:4}),l.push({name:"v",type:"key",col:3.6,row:4}),l.push({name:"b",type:"key",col:4.6,row:4}),l.push({name:"n",type:"key",col:5.6,row:4}),l.push({name:"m",type:"key",col:6.6,row:4}),l.push({name:"text",html:"long<br>var",two_lines:!0,cmd:"$",type:"key",col:7.6,row:4}),l.push({name:"123",type:"load_layout",col:11,row:0}),l.push({name:"",type:"key",val:"/",col:10,row:1}),l.push({name:"*",type:"key",val:"*",col:11,row:1,dy:"0.3em"}),l.push({name:"",type:"key",val:"-",col:10,row:2}),l.push({name:"+",alts:["+",""],type:"key",col:11,row:2,id:"plus-key"}),l.push({name:"(",type:"key",col:9.8,cols:.6,row:3}),l.push({name:")",type:"key",col:10.4,cols:.6,row:3}),l.push({name:"=",alts:["<",">","=","",""],type:"key",col:11,row:3,id:"equal-key"}),l.push({name:"_",html:"x<sub>n</sub>",type:"key",col:9,row:4}),l.push({name:"^n ",val:"^",html:"a<sup>n</sup>",dy:"0.1em",type:"key",col:10,row:4}),l.push({name:"",alts:["",{name:"",cmd:"\\nthroot"}],type:"key",col:11,row:4,id:"root-key"}),l.push({name:"",type:"shift",col:0,row:4,cols:.6})},P=function(){l=[],l.keyboard="alpha",l.formula={type:"formula",col:2,row:0,cols:6},l.push({name:"Cancel",type:"event",event:"cancel",col:0,row:0,cols:2}),l.push({type:"backspace",col:8,row:0}),l.push({name:"Done",type:"event",event:"done",col:9,row:0,cols:2}),l.push({name:"1",type:"key",col:0,row:1}),l.push({name:"2",type:"key",col:1,row:1}),l.push({name:"3",type:"key",col:2,row:1}),l.push({name:"4",type:"key",col:3,row:1}),l.push({name:"5",type:"key",col:4,row:1}),l.push({name:"6",type:"key",col:5,row:1}),l.push({name:"7",type:"key",col:6,row:1}),l.push({name:"8",type:"key",col:7,row:1}),l.push({name:"9",type:"key",col:8,row:1}),l.push({name:"0",type:"key",col:9,row:1}),l.push({name:"",type:"key",col:1,row:2}),l.push({name:"",type:"key",col:2,row:2}),l.push({name:"",type:"key",col:3,row:2}),l.push({name:"",type:"key",col:4,row:2}),l.push({name:"",type:"key",col:5,row:2}),l.push({name:"",type:"key",col:6,row:2}),l.push({name:"",type:"key",col:7,row:2}),l.push({name:"",type:"key",col:8,row:2}),l.push({name:"",type:"key",col:9,row:2}),l.push({name:"",type:"key",col:.3,row:3}),l.push({name:"",type:"key",col:1.3,row:3}),l.push({name:"",type:"key",col:2.3,row:3}),l.push({name:"",type:"key",col:3.3,row:3}),l.push({name:"",type:"key",col:4.3,row:3}),l.push({name:"",type:"key",col:5.3,row:3}),l.push({name:"",type:"key",col:6.3,row:3}),l.push({name:"",type:"key",col:7.3,row:3}),l.push({name:"",type:"key",col:8.3,row:3}),l.push({name:"",type:"key",col:.6,row:4}),l.push({name:"",type:"key",col:1.6,row:4}),l.push({name:"",type:"key",col:2.6,row:4}),l.push({name:"",type:"key",col:3.6,row:4}),l.push({name:"",type:"key",col:4.6,row:4}),l.push({name:"",type:"key",col:5.6,row:4}),l.push({name:"",type:"key",col:6.6,row:4}),l.push({name:"text",html:"long<br>var",two_lines:!0,cmd:"$",type:"key",col:7.6,row:4}),l.push({name:"123",type:"load_layout",col:11,row:0}),l.push({name:"",type:"key",val:"/",col:10,row:1}),l.push({name:"*",type:"key",val:"*",col:11,row:1,dy:"0.3em"}),l.push({name:"",type:"key",val:"-",col:10,row:2}),l.push({name:"+",alts:["+",""],type:"key",col:11,row:2,id:"plus-key"}),l.push({name:"(",type:"key",col:9.8,cols:.6,row:3}),l.push({name:")",type:"key",col:10.4,cols:.6,row:3}),l.push({name:"=",alts:["<",">","=","",""],type:"key",col:11,row:3,id:"equal-key"}),l.push({name:"_",html:"x<sub>n</sub>",type:"key",col:9,row:4}),l.push({name:"^n ",val:"^",html:"a<sup>n</sup>",dy:"0.1em",type:"key",col:10,row:4}),l.push({name:"",alts:["",{name:"",cmd:"\\nthroot"}],type:"key",col:11,row:4,id:"root-key"}),l.push({name:"",type:"shift",col:0,row:4,cols:.6})},Q=function(){w=d3.select("body").append("div").attr("id","gm-keyboard").style({position:"fixed",bottom:0,"z-index":1e4}).style("display",v?"block":"none"),y=w.append("div").attr("id","caption"),z=y.append("span").text(E),y.append("span").text("x").style({position:"absolute",right:"5px",top:"-3px",color:"silver",cursor:"pointer"}).on("click",function(){K.caption(!1)}),x=w.append("div").classed("keyboard",!0),f=x.append("div").attr("id","formula").append("div").attr("id","mq_div").append("span").attr("id","mq_span"),q=G.MathField(f.node(),J),g=$(f.node()).find("textarea"),v&&q.focus(),d3.select(g[0]).on("keyup",function(){13===d3.event.keyCode?c("done"):27===d3.event.keyCode?c("cancel"):setTimeout(function(){c("change")},1)}),T()},R=function(){x.selectAll(".key").remove(),x.select("#formula").datum(l.formula),d(x)},S=function(){L(),w.call(ba,D),x.style("height",h+"px").style("width",B+"px").style({bottom:0,background:"#DDD",padding:0,"text-align":"center",border:"1px solid silver","border-radius":1.5*k+"px "+1.5*k+"px 0 0","border-bottom":"none"}).select("#formula").style("border",k+"px solid #DDD").style("border-radius",k+"px").call(Z,k).select("#mq_div").style("border-radius",k+"px").style("width",function(a){return(a.cols||1)*i+((a.cols||1)-1)*k+"px"}).call(aa).select("#mq_span").style("box-shadow","none").style("-webkit-box-shadow","none").style("-moz-box-shadow","none").style("margin-top",k).style("font-size",j/2+j/10+"px").style("padding-top",3*k-2+"px").style("padding-bottom",2*k+"px").style("border","none").style("min-height",function(a){return(a.rows||1)*j+((a.rows||1)-1)*k-5*k+"px"}).style("width","100%"),x.selectAll(".key").call(Z).call(_).call(aa),x.selectAll(".backspace-key path").attr("d",r).style("stroke","black").style("stroke-width","1.2").style("fill","none").attr("transform","translate("+i/2+","+j/2+")scale("+.12*k+")"),x.selectAll(".key-icon-svg").style("width","100%").style("height","100%"),x.selectAll(".arrow-key path").attr("d",s).style("stroke","black").style("stroke-linejoin","round").style("stroke-width",3).style("fill","none").attr("transform",function(a){var b={left:-90,up:0,right:90,down:180}[a.dir];return"translate("+i/2+","+j/2+")scale("+.06*k+")rotate("+b+")"}),x.selectAll(".normal-key span.keylabel").text(function(a){return a.name}).style("display","table-cell").style("vertical-align","middle").style("padding-top",function(a){return a.dy||0}).filter(function(a){return a.html}).html(function(a){return a.html}).filter(function(a){return a.two_lines}).style({"font-size":"0.7em","line-height":"1.2em"}),x.selectAll(".normal-key span.dots").text("").style({position:"absolute",bottom:"2px",right:"5px","font-size":"0.6em","font-family":'"Helvetica Neue", Arial, Helvetica, sans-serif',"font-weight":400,color:"silver"}),y.style({position:"relative",background:"rgb(244, 244, 244)",padding:"12px","padding-bottom":"8px",border:"1px solid silver","border-radius":"7.6px 7.6px 0 0","border-bottom":"none",width:4*i+3*k+"px","margin-left":8*i+10*k+"px","font-family":"HelveticaNeue-Light",color:"#666","font-size":"17px","text-align":"center",display:E?null:"none"})},T=function(){/iPhone|iPod|iPad|Android|BlackBerry/.test(navigator.userAgent)&&d3.select(g[0]).attr("readonly",!0)},U=function(a){if($("[data-original-title]").each(function(){$(this).popover("hide")}),d3.select(this).style("background","gray"),"formula"!==a.type)if(q.focus(),"load_layout"===a.type)V(a.name);else if("shift"===a.type)W(a);else if("key"!==a.type||a.alts){if("backspace"===a.type)g.trigger($.Event("keydown",{which:8})),c("change");else if("event"===a.type)c(a.event);else if("arrow"===a.type){var b={left:37,up:38,right:39,down:40}[a.dir];g.trigger($.Event("keydown",{which:b})),c("change")}}else e(a)},V=function(a){if(C=!1,""===a)P();else if("123"===a)N();else if("abc"===a)O();else if("simple"===a){var b=K.latex().replace(/[^a-zA-z]/g,""),c=b.split("").filter(function(a,b,c){return c.indexOf(a)===b});M(c)}R(),S()},W=function(a){C=!C,x.selectAll(".key span.keylabel").text(function(a){return"key"===a.type?C?a.name.toUpperCase():a.name.toLowerCase():a.name})},X=function(a){p?($(this).popover("hide"),e(p)):"key"===a.type&&a.alts&&!a.popover_visible&&e(a),p=null,"shift"===a.type&&C||d3.select(this).style("background","key"==a.type||"formula"==a.type?"white":"silver")},Y=function(a){("backspace"===a.type||a.alts)&&(a.alts&&($("#"+a.id).popover("toggle"),a.popover_visible=!0),"backspace"===a.type&&(q.latex(""),q.focus()))},Z=function(a,b){b=b||0,a.style("position","absolute").style("left",function(a){return a.col*(i+k)+2*k-b+"px"}).style("bottom",function(a){return(n-a.row)*(j+k)+(a.row,0)+2*k-b+"px"})},_=function(a,b,c){b=b||0,c=c||0,a.style("width",function(a){return(a.cols||1)*i+((a.cols||1)-1)*k-2*b+"px"}).style("height",function(a){return(a.rows||1)*j+((a.rows||1)-1)*k-2*c+"px"})},aa=function(a,b){a.style("border-radius",k+"px").style("font-size",j/2+"px").style("background",function(a){return b?null:"key"==a.type||"formula"==a.type?"white":"silver"}).style("box-shadow",b?null:"#888 0px 1px 0px").style("font-family","'HelveticaNeue-UltraLight', 'Helvetica Neue UltraLight', 'Helvetica Neue', Arial, Helvetica, sans-serif").style("font-weight",100).style("border","none").style("padding",0).style("-webkit-user-select","none").style("-khtml-user-select","none").style("-moz-user-select","none").style("-ms-user-select","none").style("user-select","none").style("cursor","pointer").style("display",function(a){return"arrow"!==a.type&&"backspace"!==a.type?"table":null})},ba=function(a,b){"center"===b?(a.style("margin-left",-B/2+"px"),a.style("left","50%"),a.style("right",null)):"left"===b?(a.style("margin-left",0),a.style("left",0),a.style("right",null)):"right"===b?(a.style("margin-left",0),a.style("left",null),a.style("right",0)):(a.style("margin-left",-B/2+"px"),a.style("left",b),a.style("right",null))};return d3.rebind(K,t,"on")}};return function(){return a||(a=b()())}}(),Tf=function(){var a=function(a,b,c,d){c=ad.object.merged(ad.ui.GeoGebraCanvasElement.defaultOptions,c),ve.call(this,a,b,c),this.type="table",this.table_el=null,this.columns_row=null,this.columns_el=null,this.column_width=80,this.column_labels=c.column_labels||["x","y"],this.inputs_row=null,this.inputs_el=null,this.edit_el=null,this.remove_el=null,this.rows=[],this.rows_el=null,this.row_height=40,this.active_row=null,this.active_x=null,this.active_y=null,this.sel_y0=null,this.sel_y1=null,this.selected=null,this.dx_el=null,this.dy_el=null,this.slope_el=null,this.keyboard=null,this.target_row=null,this.target_col=null,this.graph=null,this.show=!1,this.show_el=null,this.slope=null,this.intercept=null,this.x=function(a){return(a-this.intercept)/this.slope},this.y=function(a){return this.slope*a+this.intercept},this.x_pos=0,this.y_pos=this.column_width,this.rows_addable=!0,this.initOptions(c),this.init(d)};return ad.inherit(ve,a),a.defaultOptions={type:"Table",margin:0,font_size:20,font_weight:"bold",resizable:{x:!1,y:!1},edit_mode_drag_box_width:-20},a.prototype.initOptions=function(b){b=b||{};var c=ad.deepCopy(a.defaultOptions),d=ad.object.extendExisting(c,b);this.options=ad.extend(this.options,d)},a.prototype.getColumn=function(){return this.x_pos<=this.y_pos?"x":"y"},a.prototype.init=function(a){function b(a){var b=c.columns_row[a+"_el"],d=a+"_pos",e=ad.mtouch_events().frame(b.node()).on("touch",function(){c.setActiveRow(),c.setColIndex(a)}).on("drag",function(){c[d]+=d3.event.dx,c[d]=Math.min(c.column_width,Math.max(0,c[d])),c.dragCol(a)}).on("release",function(){c[d]=c[d]<c.column_width/2?0:c.column_width,c["xy_pos".replace(a,"")]=c.column_width-c[d];var b=250;c.dragCol("x",b),c.dragCol("y",b),setTimeout(function(){c.setColIndex(),c.setInputs(),c.sortRows()},b)});b.call(e)}var c=this;this.table_el=this.element_div.append("div").classed("table",!0).style("box-sizing","content-box").style("border","1px solid silver"),this.columns_el=this.table_el.append("div").classed("table-columns",!0).style("position","relative"),this.columns_row=new ad.ui.TableRow(this,this.columns_el,this.column_labels[0],this.column_labels[1],0),this.columns_row.row_el.selectAll(".table-cell").style("background-color","gainsboro").style("cursor","move").style("cursor","grabbing"),this.columns_row.row_el.selectAll(".table-input").style("background-color","gainsboro").style("pointer-events","none"),b("x"),b("y"),this.rows_el=this.table_el.append("div").classed("table-rows",!0).style("position","relative");var d=ad.mtouch_events().frame(this.rows_el.node()).on("touch",function(){c.sel_y0=d3.event.fingers[0].pos0[1],c.sel_y1=c.sel_y0}).on("drag",function(){if(!c.inputs_row.is_selected){if(c.active_row){if(c.active_row.is_editable)return;c.setActiveRow()}if(c.sel_y1+=d3.event.dy,Math.abs(c.sel_y1-c.sel_y0)>10){var a=function(a){var b=a.toString();return b.length>4&&(b=b.substring(0,4)+"..."),b},b=function(a){var b=0;return b+=6*(a.match(/\./g)||[]).length,b+=10*a.match(/[0-9]/g).length};c.selected=[];var d=c.rows[c.rows.length-1],e=null,f=c.rows[0],g=null;c.rows.forEach(function(a){var b=c.row_height*a.idx,h=b+c.row_height;b<=c.sel_y0&&h>=c.sel_y0||b<=c.sel_y1&&h>=c.sel_y1||b>=c.sel_y0&&h<=c.sel_y1||b>=c.sel_y1&&h<=c.sel_y0?(c.selected.push(a),a.idx<=d.idx&&(d=a,e=b),a.idx>=f.idx&&(f=a,g=h),a.setSelected(!0)):a.setSelected(!1)});var h=c.x_pos<c.y_pos,i=g-e,j=f.x-d.x,k=f.y-d.y,l=j/k,m=a(j),n=a(k),o=a(l),p=Math.max(b(m),b(n));c.dx_el.style("left",(h?-30-p:2*c.column_width+10)+"px").style("width",20+b(m)+"px").style("text-align",h?"left":"right"),c.dx_el.select("span").html(m),c.dx_el.select(".bracket.bar").style("left",(h?14+p:4)+"px"),c.dy_el.style("left",(h?2*c.column_width+10:-30-p)+"px").style("width",20+b(n)+"px").style("text-align",h?"right":"left"),c.dy_el.select("span").html(n),c.dy_el.select(".bracket.bar").style("left",(h?4:14+p)+"px"),c.rows_el.selectAll(".range").style("top",e+"px").style("height",i+"px").style("line-height",i+"px").style("display","block"),c.slope_el.select(".top.fraction").html(n),c.slope_el.select(".btm.fraction").html(m),c.slope_el.selectAll(".fraction").style("width",10+p+"px"),c.slope_el.selectAll(".eq").filter(function(a,b){return 1==b}).style("left",90+p+"px"),c.slope_el.select(".val").html(o).style("left",110+p+"px"),c.slope_el.style("display","block"),c.selected.length>0&&c.graph&&(c.show_el.style("display","block"),c.toggleGraphElements(c.show))}}}).on("release",function(){c.sel_y0=null,c.sel_y1=null});this.rows_el.call(d),this.dx_el=this.rows_el.append("div").classed("range",!0),this.dy_el=this.rows_el.append("div").classed("range",!0);var e=this.rows_el.selectAll(".range").style("position","absolute").style("width","30px").style("display","none");e.append("span"),e.append("div").classed("bracket bar",!0).style("top","0px").style("width","2px").style("height","100%");var f=e.selectAll(".bracket.bar");f.append("div").classed("bracket end",!0).style("top","0px"),f.append("div").classed("bracket end",!0).style("bottom","0px"),this.rows_el.selectAll(".bracket").style("position","absolute").style("background-color","black"),this.rows_el.selectAll(".bracket.end").style("left","-4px").style("width","10px").style("height","2px"),this.slope_el=this.table_el.append("div").classed("slope",!0).style("left",2*this.column_width+this.options.margin+30+"px").style("top",this.options.margin+"px").style("text-align","center").style("display","none"),this.slope_el.append("div").classed("slope top formula",!0).html("y<sub>2</sub> - y<sub>1</sub>"),this.slope_el.append("div").classed("slope bar formula",!0),this.slope_el.append("div").classed("slope btm formula",!0).html("x<sub>2</sub> - x<sub>1</sub>"),this.slope_el.append("div").classed("slope eq",!0).style("left","60px"),this.slope_el.append("div").classed("slope top fraction",!0),this.slope_el.append("div").classed("slope bar fraction",!0),this.slope_el.append("div").classed("slope btm fraction",!0),this.slope_el.append("div").classed("slope eq",!0),this.slope_el.append("div").classed("slope val",!0).style("top","14px").style("width","20px"),this.table_el.selectAll(".slope").style("position","absolute"),this.slope_el.selectAll(".top").style("top","0px"),this.slope_el.selectAll(".bar").style("top","28px").style("height","2px").style("background-color","black"),this.slope_el.selectAll(".btm").style("top","28px"),this.slope_el.selectAll(".eq").style("top","14px").style("width","20px").html("="),this.slope_el.selectAll(".formula").style("left","0px").style("width","60px"),this.slope_el.selectAll(".fraction").style("text-align","center").style("left","80px"),this.edit_el=this.rows_el.append("i").classed("table-button",!0).classed("glyphicon glyphicon-pencil",!0).style("position","absolute").style("cursor","pointer").style("background-color","white").style("border","1px solid silver").style("border-radius","5px").style("text-align","center").style("display","none").on("click",function(){c.active_row.setEditable(!0)}),this.remove_el=this.rows_el.append("i").classed("table-button",!0).classed("glyphicon glyphicon-trash",!0).style("position","absolute").style("cursor","pointer").style("background-color","white").style("border","1px solid silver").style("border-radius","5px").style("text-align","center").style("display","none").on("click",function(){c.active_row.row_el.remove();var a=c.active_row.idx;c.rows.splice(a,1),c.rows.forEach(function(b){b.idx>a&&(b.idx--,b.update())}),c.update(),c.setActiveRow(),c.setInputs(),c.sortRows(),1==c.rows.length&&(c.slope=null,c.intercept=null,c.graph&&c.setGraphLine())}),this.inputs_el=this.table_el.append("div").classed("table-inputs",!0).style("position","relative"),this.inputs_row=new ad.ui.TableRow(this,this.inputs_el,0,this.y(0),0),this.inputs_row.row_el.selectAll(".table-input").style("color","silver"),this.inputs_row.setEditable(!0),this.inputs_row.events.on("focus",function(a){(c.active_row||c.selected)&&c.setActiveRow(),c.keyboard.visible()||(c.inputs_row.is_selected=!0,c.active_x=c.inputs_row.x,c.active_y=c.inputs_row.y),c.target_row&&c.target_row.setEditing(c.target_col,!1),c.inputs_row.setEditing(a,!0),c.target_row=c.inputs_row,c.target_col=a,c.connectAndShowKeyboard("")}).on("input",function(a){if(c.slope){var b=c.inputs_row;"x"==a?b.y=c.y(b.x):b.x=c.x(b.y),b.update()}}),this.setInputs(),this.keyboard=ad.ui.Keyboard(),this.update(),a&&a(this)},a.prototype.connectAndShowKeyboard=function(a){this.keyboard.visible()&&this.keyboard.visible(!1),this.keyboard.latex(a).visible(!0),this.keyboard.on("change."+this.id,function(a){this.target_row[this.target_col+"_in"].html(a),this.target_row.readInput(this.target_col)}.bind(this)),this.keyboard.on("done."+this.id,function(){!this.inputs_row.is_selected||this.slope||this.hasInputs()?(this.inputs_row.is_selected&&(this.addRow(this.inputs_row.x,this.inputs_row.y),this.setActiveRow(),this.setInputs()),this.active_row&&this.active_row.is_editable&&(this.active_x=this.active_row.x,this.active_y=this.active_row.y,this.setActiveRow(),this.setInputs(),this.sortRows()),this.target_row.setEditing(this.target_col,!1),this.target_row=null,this.target_col=null,this.keyboard.visible(!1),this.disconnectKeyboard()):(this.target_row.setEditing(this.target_col,!1),this.target_col="xy".replace(this.target_col,""),this.target_row.setEditing(this.target_col,!0),this.connectAndShowKeyboard(""))}.bind(this)),this.keyboard.on("cancel."+this.id,function(){this.setActiveRow(),this.target_row.setEditing(this.target_col,!1),this.disconnectKeyboard()}.bind(this))},a.prototype.unselect=function(){this.setActiveRow()},a.prototype.disconnectKeyboard=function(){this.keyboard.visible(!1),this.keyboard.on("change."+this.id,null).on("done."+this.id,null).on("cancel."+this.id,null)},a.prototype.update=function(){var a=2*this.column_width,b=this.row_height*this.rows.length,c=b+this.row_height*(this.rows_addable?2:1),d=2*this.options.margin;this.resizeElement({width:a+d,height:c+d}),this.table_el.style("width",a+"px").style("height",c+"px").style("margin",this.options.margin+"px").style("font-size",this.options.font_size+"px").style("font-weight",this.options.font_weight),this.columns_el.style("width",a+"px").style("height",this.row_height+"px"),this.inputs_el.style("width",a+"px").style("height",this.row_height+"px").style("display",this.rows_addable?"block":"none"),this.edit_el.style("left",a+10+"px"),this.remove_el.style("left",a+15+this.row_height+"px"),this.graph&&this.show_el.style("left",-this.row_height-10+"px"),d3.selectAll(".table-button").style("width",this.row_height+"px").style("height",this.row_height+"px").style("font-size",this.row_height-15+"px").style("line-height",this.row_height+"px"),this.rows_el.style("width",a+"px").style("height",b+"px")},a.prototype.setInputs=function(){this.inputs_row.x_in.html(""),this.inputs_row.y_in.html("")},a.prototype.hasInputs=function(){return""!=this.inputs_row.x_in.html()&&""!=this.inputs_row.y_in.html()},a.prototype.setRowsAddable=function(a){this.rows_addable=a,this.update()},a.prototype.setButtonMode=function(a){this.edit_el.style("display","selected"==a?"block":"none"),this.remove_el.style("display","selected"==a?"block":"none")},a.prototype.setColIndex=function(a){this.columns_row.setColIndex(a),this.inputs_row.setColIndex(a),this.rows.forEach(function(b){b.setColIndex(a)})},a.prototype.dragCol=function(a,b){b=b||0,this.columns_row.dragCol(a,b),this.inputs_row.dragCol(a,b),this.rows.forEach(function(c){c.dragCol(a,b)})},a.prototype.setColOrder=function(a){var b=this;a.forEach(function(a,c){b[a+"_pos"]=c*b.column_width,b.dragCol(a)})},a.prototype.addRow=function(a,b){for(var c=0;c<this.rows.length;c++){var d=this.rows[c];if(d.x==a&&d.y==b)return void[".table-cell",".table-input"].forEach(function(a){d.row_el.selectAll(a).transition(150).style("background-color","gainsboro").delay(150).transition(200).style("background-color","white")})}var d=new ad.ui.TableRow(this,this.rows_el,a,b,this.rows.length),e=this;if(d.events.on("click",function(){e.active_row!=d&&e.setActiveRow(d)}).on("focus",function(a){e.active_row==d&&(e.target_row&&e.target_row.setEditing(e.target_col,!1),d.setEditing(a,!0),e.target_row=d,e.target_col=a,e.connectAndShowKeyboard(d[a].toString()))}).on("input",function(a){e.slope&&("x"==a?d.y=e.y(d.x):d.x=e.x(d.y),d.update())}),this.rows.push(d),this.setInputs(),this.update(),this.sortRows(),!this.slope&&2==this.rows.length){var f=this.rows[1].y-this.rows[0].y,g=this.rows[1].x-this.rows[0].x;this.slope=f/g,this.intercept=this.rows[0].y-this.slope*this.rows[0].x,this.graph&&this.setGraphLine()}},a.prototype.sortRows=function(){var a=this.getColumn(),b=0;this.rows.sort(function(b,c){return b[a]-c[a]}),this.rows.every(function(a,b){return a.idx===b})||this.rows.forEach(function(a,c){a.idx=c,a.dragRow(400,40*b),b++})},a.prototype.setActiveRow=function(a){if(this.inputs_row.is_selected?(this.inputs_row.x=this.active_x,this.inputs_row.y=this.active_y,this.inputs_row.setSelected(!1),this.inputs_row.update()):this.active_row?(this.active_row.x=this.active_x,this.active_row.y=this.active_y,this.active_row.setSelected(!1),this.active_row.setEditable(!1),this.active_row.update()):this.selected&&(this.selected.forEach(function(a){a.setSelected(!1)}),this.selected=null,this.rows_el.selectAll(".range").style("display","none"),this.slope_el.style("display","none")),a){a.setSelected(!0);var b=this.row_height*a.idx+"px";this.edit_el.style("top",b),this.remove_el.style("top",b)}this.setButtonMode(a?"selected":null),this.active_row=a||null,this.active_x=a?a.x:null,this.active_y=a?a.y:null,this.setInputs(),this.graph&&(this.show_el.style("display",a?"block":"none"),this.show&&this.toggleGraphElements(!!a))},a.prototype.setGraph=function(a){var b=this;this.graph=a,this.setGraphLine(),this.graph.ggbApplet.setVisible("a",!1),this.graph.ggbApplet.setLabelVisible("g",!0),this.graph.ggbApplet.setLabelStyle("g",2),this.graph.ggbApplet.setLabelVisible("h",!0),this.graph.ggbApplet.setLabelStyle("h",2),this.graph.ggbApplet.evalCommand("p=false"),this.graph.ggbApplet.evalCommand("r=false"),this.show_el=a.element_div.append("i").classed("table-button",!0).classed("glyphicon glyphicon-eye-open",!0).style("position","absolute").style("top","0px").style("cursor","pointer").style("background-color","white").style("border","1px solid silver").style("border-radius","5px").style("text-align","center").style("display","none");var c=ad.mtouch_events().frame(this.show_el.node()).on("tap",function(){b.show=!b.show,b.show_el.transition().style("background-color",b.show?"gold":"white"),b.toggleGraphElements(b.show)});this.show_el.call(c),this.update()},a.prototype.setGraphLine=function(){this.graph.ggbApplet.evalCommand("m="+(this.slope?this.slope:"false")),this.graph.ggbApplet.evalCommand("b="+(this.intercept?this.intercept:"false"))},a.prototype.toggleGraphElements=function(a){if(this.graph.ggbApplet.setVisible("a",a),this.active_row)this.graph.ggbApplet.evalCommand("G=("+this.active_row.x+","+this.active_row.y+")"),this.graph.ggbApplet.evalCommand("p="+a),this.graph.ggbApplet.evalCommand("r=false");else if(this.selected){var b=this.selected[this.selected.length-1],c=this.selected[0];this.selected.forEach(function(a){a.idx<=b.idx&&(b=a),a.idx>=c.idx&&(c=a)}),this.graph.ggbApplet.evalCommand("A=("+b.x+","+b.y+")"),this.graph.ggbApplet.evalCommand("B=("+c.x+","+c.y+")"),this.graph.ggbApplet.evalCommand("r="+a),this.graph.ggbApplet.evalCommand("p=false")}},a}(),Tf.prototype.toJSON=function(){return{id:this.id,type:"Table",rows:this.rows.map(function(a){return{x:a.x,y:a.y}}),pos:this.pos,graph:this.graph?this.graph.id:null}},Tf.fromJSON=function(a,b,c){var d=c.createElement("table",{pos:a.pos});return a.rows.forEach(function(a){d.addRow(a.x,a.y)}),d.graph=a.graph,d},ad.ui=ad.ui||{},ad.ui.TutorialPair=function(){var a=function(a,b){this.events=d3.dispatch("done","retry","next"),this.id=ad.uid(),this.title=b.title,this.text=b.text,"gestureData"in b&&(this.gesture_data=b.gestureData,this.gesture_data.options.show_drag_indicator=!1,this.gesture_data.options.show_bg=!1),this.initial_expressions=function(a,b){return a?b?[a].concat(b.map(function(a){return a.expression})):[a]:[]}.call(this,b.eq,b.extraExamples),this.correct_answers=function(a,b){return a?b?[a.map(this.parsedAscii)].concat(b.map(function(a){return a.correctAnswers.map(this.parsedAscii)},this)):[a.map(this.parsedAscii)]:[]}.call(this,b.correctAnswers,b.extraExamples),this.current_example=0,this.start_wiggle=b.startWiggle,this.encourage=!0,this.container=d3.select(a),this.dl_div=null,this.dl=null,this.play_btn=ad.svg_play_button(),this.player=null,this.practice_problem=b.practice_problem,this.substitution_problem=b.gestureData.substitution_problem,this.youtubeVideoInstead=b.gestureData.youtubeVideoInstead,this.extra_dl=b.gestureData.extra_dl,this.allow_restart_after_done=!("allow_restart_after_done"in b)||b.allow_restart_after_done,this.answered=!1,this.log_mouse_trajectories=b.log_mouse_trajectories,this.task_name=b.task_name,this.init()};return a.prototype.parsedAscii=function(a){return new Id(a).to_ascii()},a.prototype.replay=function(){this.play_btn.hidden(!0),this.player.replay(500,function(){setTimeout(function(){this.play_btn.hidden(!1),this.dl&&!this.answered&&(this.encourage&&(this.dl_div.append("span").text("Try it!").classed("tryit",!0),this.start_wiggle&&this.dl.startWiggle(this.start_wiggle)),this.dl_div.on("mousedown",function(){var a=new Date;this.startTime=a.getTime(),this.dl_div.select("span.tryit").remove(),this.dl_div.on("mousedown",null)}.bind(this)))}.bind(this),1e3)}.bind(this))},a.prototype.videoPlay=function(){var a=this;this.play_btn.hidden(!0),this.createPlayer(500,function(){setTimeout(function(){a.play_btn.hidden(!1),a.answered||(a.encourage&&(a.dl_div.append("span").text("Try it!").classed("tryit",!0),a.start_wiggle&&a.dl.startWiggle(a.start_wiggle)),a.dl_div.on("mousedown",function(){var b=new Date;a.startTime=b.getTime(),a.dl_div.select("span.tryit").remove(),a.dl_div.on("mousedown",null)}))}).bind(a)})},a.prototype.loadYTScript=function(a){window.onYouTubeIframeAPIReady=a.bind(this);var b=document.createElement("script");b.src="https://www.youtube.com/iframe_api";var c=document.getElementsByTagName("script")[0];c.parentNode.insertBefore(b,c)},a.prototype.createPlayer=function(a){if("undefined"==typeof YT)return void this.loadYTScript(this.createPlayer.bind(this,a));this.ytPlayer=new YT.Player(this.video_div.node(),{height:500,width:240,playerVars:{rel:0,controls:0,showinfo:0,showsearch:0,theme:"light",frameborder:0},videoId:this.youtubeVideoInstead,events:{onReady:this.onPlayerReady.bind(this.ytPlayer),onStateChange:this.onPlayerStateChange.bind(this)}})},a.prototype.onPlayerReady=function(a){a.target.playVideo()},a.prototype.onPlayerStateChange=function(a){0===a.data&&(this.ytPlayer.seekTo(0),this.ytPlayer.pauseVideo())},a.prototype.init=function(){this.container.append("h2").text(this.title),this.container.append("p").attr("class","tutorial-instructions").text(this.text);var a=this.container.append("div").classed("tutorial",!0),b=a.append("div").classed("choice",!0).classed("large-choice",this.practice_problem).classed("substitution-problem",this.substitution_problem);this.gesture_data.options.pos={x:"center",y:"center"},this.gesture_data.options.draggable=!1,this.gesture_data.options.collapsed_mode=!0,this.gesture_data.options.no_history=!1,this.gesture_data.options.no_handles=!0,this.gesture_data.options.edit_mode_drag_box_width="0px",this.gesture_data.options.row_padding={left:0,right:0,top:7,bottom:3},this.gesture_data.options.padding={left:0,right:0,top:0,bottom:0};var c=b.append("div").style({position:"absolute",left:0,right:0,top:0,bottom:0});if(this.player=new ad.EventRecorder(this.gesture_data,c.node()),this.player.showPreview(),this.youtubeVideoInstead?this.video_div=b.append("div").classed("animation",!0).call(this.play_btn.on("click",this.videoPlay.bind(this))):b.append("div").classed("animation",!0).call(this.play_btn.on("click",this.replay.bind(this))),this.initial_expressions.length){this.dl_div=a.append("div").classed("choice",!0).classed("large-choice",this.practice_problem).classed("substitution-problem",this.substitution_problem);var d=new Of(this.dl_div.node(),{vertical_scroll:!1,use_toolbar:!1,use_hold_menu:this.use_hold_menu||!1,svg_height:"100%",log_mouse_trajectories:this.log_mouse_trajectories,ask_confirmation_on_closing:!1,overflow_visible:!0,disable_notifications:!0});this.logger=d.logger,this.model=d.model,this.controller=d.controller,this.setDLToExpression(this.initial_expressions[this.current_example]),this.startTime=-1}},a.prototype.chainTransition=function(a,b){if(a.node().__transition__&&a.id&&a.node().__transition__[a.id]){var c=a.node().__transition__[a.id];b+=c.delay+c.duration}return a.transition().delay(b)},a.prototype.neutralTransition=function(a,b,c,d){a.selectAll("button").remove(),a.select("span.feedback").remove();var e=this.chainTransition(a,b).duration(c||500);return d?e.styleTween("background",function(){return d3.interpolate(d,"#EEEEEE")}):e.style("background","#eee"),e},a.prototype.wrongTransition=function(a,b,c,d){d3.select(a.node()).append("span").attr("class","feedback").style({opacity:1e-5}).text("");var e=this.chainTransition(a,b).duration(c||500);return d?e.styleTween("background",function(){return d3.interpolate(d,"#E0A8A8")}):e.style("background","#E0A8A8"),e.select(".feedback").style("opacity",1),e},a.prototype.correctTransition=function(a,b,c,d){var e=d3.select(a.node());e.append("span").attr("class","feedback").style({opacity:1e-5}).text(""),this.allow_restart_after_done&&this.initDoItAgainBtn(e),this.initial_expressions.length>1&&this.initTryAnotherBtn(e);var f=this.chainTransition(a,b).duration(c||500);return d?f.styleTween("background",function(){return d3.interpolate(d,"#A8E0B3")}):f.style("background","#A8E0B3"),f.select(".feedback").style("opacity",1),f.selectAll("button").style("opacity",1),f},a.prototype.initDoItAgainBtn=function(a){a.append("button").classed("gm-tutorial",!0).text("do it again").style({top:"10px",opacity:1e-5}).on("click",function(){this.logger.logCustomInteraction("tutorial-reset",{task_name:this.task_name,eq_start:this.dl.rows[0].model.to_ascii(),eq_end:this.dl.getLastModel().to_ascii()}),this.retry()}.bind(this))},a.prototype.initTryAnotherBtn=function(a){a.append("button").classed("gm-tutorial",!0).text("try another").style({top:"62px",opacity:1e-5}).on("click",function(){this.logger.logCustomInteraction("tutorial-alternative-example",{task_name:this.task_name,eq_start:this.dl.rows[0].model.to_ascii()}),this.initial_expressions.length>1?this.loadNextExample():this.retry()}.bind(this))},a.prototype.checkAnswer=function(){setTimeout(function(){this.dl.getLastView().interactive(!1);var a=this.dl.getLastModel().to_ascii(),b=new Date,c=-1,d=-1;if(-1!==this.startTime&&(c=b.getTime()-this.startTime),this.parsedAscii(this.initial_expressions[this.current_example])!==this.dl.getLastModel().to_ascii()||this.extra_dl_element_modified)if(this.answerIsCorrect(a)){if(d="correct",this.answered=!0,this.extra_dl_element_modified=!1,this.logger.logCustomInteraction("tutorial-success",{task_name:this.task_name,eq_start:this.dl.rows[0].model.to_ascii(),eq_end:this.dl.getLastModel().to_ascii()}),2===this.dl_div.selectAll("div").size())return;this.correctTransition(this.dl_div,200,null,"#EEEEEE").each("end",this.events.done)}else this.practice_problem?(d="intermediate state",this.dl.getLastView().interactive(!0)):(d="wrong",this.extra_dl_element_modified=!1,this.logger.logCustomInteraction("tutorial-fail",{task_name:this.task_name,eq_start:this.dl.rows[0].model.to_ascii(),eq_end:this.dl.getLastModel().to_ascii()}),this.wrongTransition(this.dl_div,200,null,"#EEEEEE").transition().duration(500).each("end",this.retry.bind(this)),this.encourage=!0);else this.dl.getLastView().interactive(!0),d="initial state";window&&window.gmath_log_ga&&gmath_log_ga.trackEvent("tutorial",d,this.eq,c)}.bind(this),400)},a.prototype.answerIsCorrect=function(a){return-1!==this.correct_answers[this.current_example].indexOf(a)},a.prototype.loadNextExample=function(){this.dl.rows[0].model.to_ascii();this.neutralTransition(this.dl_div,0,1).each("end",function(){this.current_example++,this.current_example===this.initial_expressions.length&&(this.current_example=0),this.setDLToExpression(this.initial_expressions[this.current_example]),0===this.current_example?this.encourage=!0:this.encourage=!1,this.events.next()}.bind(this))},a.prototype.retry=function(){this.neutralTransition(this.dl_div,0,1).each("end",function(){this.setDLToExpression(this.initial_expressions[this.current_example]),this.events.retry()}.bind(this)),this.answered=!1,this.encourage=!0},a.prototype.setDLToExpression=function(a){var b=this,c=SettingsType.get("AlgebraView").defaults,d=ad.deepCopy(this.gesture_data.options);d.eq=a,d.inactive_color=c.get("inactive_color"),d.color=c.get("color"),d.h_align="center",d.edit_mode_drag_box_width="0px",d.show_drag_indicator=c.get("show_drag_indicator"),this.controller.simulateStartOfInteraction(),this.dl&&this.model.removeElement(this.dl),this.dl=this.model.createDL(d),this.controller.simulateEndOfInteraction(),this.extra_dl&&(this.extra_dl_element&&this.model.removeElement(this.extra_dl_element),this.extra_dl_element=this.model.createDL(this.extra_dl.options),this.extra_dl_element.events.on("end-of-interaction."+this.id,function(){b.extra_dl_element_modified=!0,b.checkAnswer(b)})),this.dl.getLastRow().view.interaction_handler.events.on("touch",function(){this.encourage=!1}.bind(this)),this.dl.getLastView().interactive(!0),this.dl.events.on("end-of-interaction."+this.id,this.checkAnswer.bind(this))},a.prototype.stop=function(){this.player.stop_animation()},a}(),ad.gmifyPage=function(a,b){b=b||{},coordinator=new DLCoordinator;var c=a?d3.select(a):d3.select("body"),d=c.size()>0&&c.classed("gmify-canvas")?c:c.selectAll(".gmify-canvas");d.each(function(){var a=d3.select(this),b=a.text().split(";");try{b.forEach(Id.getDefaultParser().parse),a.classed("gmify-canvas",!1).classed("gmified-canvas",!0),a.classed("bootstrap-styles",!0),a.select("*").remove();var c=new ad.Canvas(this,{height:"500px"});Lc(a);var d={pos:["auto",20],v_align:"top"};c.model.createDLs(b,d)}catch(a){console.log('could not parse "'+b+'". Error:',a)}}),d=c.size()>0&&c.classed("gmify-minimal")?c:c.selectAll(".gmify-minimal"),d.each(function(){var a=d3.select(this),b=a.text();try{Id.getDefaultParser().parse(b),a.classed("gmify-minimal",!1).classed("gmified-minimal",!0),a.classed("bootstrap-styles",!0),a.select("*").remove(),a.text("");var c=a.insert("svg").style({overflow:"visible",display:"block",width:"100%"});ad.Derivation.createFixedSingleLineDL(c.node(),{eq:b})}catch(a){console.log('could not parse "'+b+'". Error:',a)}}),d=c.size()>0&&c.classed("gmify")?c:c.selectAll(".gmify"),d.each(function(a,c){var d=d3.select(this),e=d.text();try{Id.getDefaultParser().parse(e),d.classed("gmify",!1).classed("gmified",!0),d.classed("bootstrap-styles",!0),d.select("*").remove(),d.text("");var f=d.insert("div").style({overflow:"visible",display:"block","margin-top":"30px"}),g=new ad.Canvas(f.node(),{minimal:!0,logo_src:b.logo_src}),h=g.model.createDL({eq:e,pos:{x:0,y:0},cloning_on:!1,normal_font:{family:"Kalam"},italic_font:{family:"Kalam"},font_baseline_shift:.4,font_ascent:.9,font_descent:.2,slanted_div_bar:!0,div_bar_height:1/14,font_size:"45",row_border_color:"#ddd",handle_stroke_color:"#d8d8d8",keep_in_container:!0});Lc(d),coordinator.subscribeToCanvasModel(g.model),coordinator.addDL(h),g.model.focusOnDL(h),g.controller.clearInteractionTimeline()}catch(a){console.log('could not parse "'+e+'". Error:',a)}})},Uf={Action:p.fromJSON,ApplyFormulaAction:Ld.fromJSON,AlgebraModel:Id.fromJSON,AlgebraModelLink:ob.fromJSON,DerivationRow:sb.fromJSON,Derivation:tb.fromJSON,LinkCoordinator:ne.fromJSON,Path:Ue.fromJSON,TextBox:Sf.fromJSON,CanvasImage:Qf.fromJSON,CanvasVideo:Rf.fromJSON,GeoGebraCanvasElement:af.fromJSON,GeoGebraPanel:Jf.fromJSON,Table:Tf.fromJSON},Vf=new Nc,ad.ServerComm=Vf,ad.setupLogging=function(a){a||(a={}),ad.ServerComm.setExperimentID(a.experiment_id),ad.ServerComm.setEnabled("enabled"in a?a.enabled:"auto"),a.server&&ad.ServerComm.setServerUrl(a.server),ad.ServerComm.log_to_console=a.log_to_console},ad.sendErrorReport=function(a){var b=arguments.length<=1||void 0===arguments[1]?"":arguments[1];if(console.warn("error:",a,b),ad.ServerComm.posting){if("string"!=typeof a)return void console.error("Invalid error description type.");if("string"!=typeof b)return void console.error("Invalid error context type.");if(ad.ServerComm.dataIsTooBig(a+b))return void console.warn("Data chunk size is too big: not saved.");var c=ad.TrialLogger&&ad.TrialLogger.trial&&ad.TrialLogger.trial.id;ad.ServerComm.sendXHR(ad.ServerComm.server_url+"/error_report",JSON.stringify({trial_id:c,description:a,context:b}))}},Nc.prototype.setExperimentID=function(a){if("string"!=typeof a)throw"Invalid experiment ID.";if(!a.match(/^\w+$/))throw"Invalid experiment ID.";this.trial_collection=a+"_trials",this.data_collection=a+"_data",ad.TrialLogger.experiment_id=a},Nc.prototype.setServerUrl=function(a){this.server_url=a},Nc.prototype.setEnabled=function(a){this.posting=!!a&&("auto"!==a||(!window||!window.gmath_log_ga||gmath_log_ga.enabled())),console.info("interaction logging is",this.posting?"on":"off")},Nc.prototype.postTrial=function(a){this.postToServer(this.trial_collection,a)},Nc.prototype.postInteractions=function(a){this.postToServer(this.data_collection,a)},Nc.prototype.postToServer=function(a,b){if(this.log_to_console&&console.log("logging",b),this.posting){var c=JSON.stringify(b);if(this.dataIsTooBig(c))return void console.warn("Data chunk size is too big: not saved.");this.sendXHR(this.server_url+"/log/"+a,c)}},Nc.prototype.sendXHR=function(a,b){var c=new XMLHttpRequest;c.open("POST",a),c.setRequestHeader("Content-Type","application/json"),c.onreadystatechange=function(){4==c.readyState&&c.status,4==c.readyState&&c.status},c.send(b)},Nc.prototype.dataIsTooBig=function(a){return ad.byteLength(a)>5e4},ad.svg_play_button=Oc,Pc.prototype.onUserEvent=function(a){ad.ServerComm&&ad.ServerComm.postInteractions([{type:"user",subtype:a.type,time:Date.now(),user_id:a.user.user_id,trial_id:this.trial&&this.trial.id}])},Wf=new Pc,ad.TrialLogger=Wf,Pc.prototype.addTrial=function(a,b){var c={id:ad.uid(),idx:a||0,gm_version:ad.version,gm_ui_version:ad.ui.version,gm_ui_gm_version:ad.ui.gm_version,experiment_id:this.experiment_id,user_id:De.logged_in?De.user_id:null,time:Date.now()};return ad.extend(c,b),this.active_trials.push(c),c},Pc.prototype.startTrial=function(a,b){this.trial&&this.endTrial();var c=this.addTrial(a,b);this.trial=c,this.events.start_trial(c)},Pc.prototype.setCustomFields=function(a){ad.extend(this.trial,a)},Pc.prototype.endTrial=function(a){this.trial.duration=Date.now()-this.trial.time,a&&this.setCustomFields(a),this.events.end_trial(this.trial),this.postTrial(this.trial),ad.array.remove(this.active_trials,this.trial),this.trial=null},Pc.prototype.resumeTrial=function(a){this.trial=ad.find(this.active_trials,function(b){return b.id===a}),this.events.start_trial(this.trial)},Pc.prototype.postTrial=function(){ad.ServerComm&&ad.ServerComm.postTrial(this.trial)},Pc.prototype.postAllTrials=function(){ad.ServerComm&&ad.ServerComm.postTrial(this.active_trials),this.active_trials=[]},Xf=[],Xf.push({update_to:"2.6.1",run:function(a){return a.version="2.6.1",a.linkCoordinator.links.forEach(function(a){a.action&&"AddSubResolveCasesAction"===a.action.name&&(a.action.target=a.target)}),a}}),Xf.push({update_to:"2.4.0",run:function(a){return a.version="2.4.0",a.settings={Canvas:{},Derivation:{}},a.options&&"scrub_precision"in a.options&&(a.settings.Derivation.scrub_precision=a.options.scrub_precision),delete a.options,a.settings.Canvas.active_tool=a.mode,delete a.mode,a.objects.filter(function(a){return"Derivation"===a.type}).forEach(function(a){a.settings=a.options,delete a.options,a.rows.forEach(function(a){a.model.settings=a.model.options,delete a.model.options})}),a.referenced_deleted_models.forEach(function(a){a.settings=a.options,delete a.options}),a}}),Xf.push({update_to:"2.1.0",run:function(a){return a.version="2.1.0",a.linkCoordinator.links.forEach(function(b){if(b.action&&"DistributeIntoBracketsAction"===b.action.name){var c=Sc(a,b.action.oldTree),d=new Id(c.ascii),e=d.getNodesFromSelector(b.action.nodes)[0],f=d.getNodesFromSelector(b.action.target)[0];e.get_idx()<f.get_idx()?b.action.settings.side="left-inside":b.action.settings.side="right-inside"}}),a}}),Xf.push({update_to:"1.0.3",run:function(a){return a.version="1.0.3",a.linkCoordinator.links.forEach(function(a){a.action&&"FractionMagSimplificationAction"===a.action.name&&(a.action.name="FractionDivideToInteger")}),a}}),Xf.push({update_to:"1.0.0-2",run:function(a){return a.version="1.0.0-2",a.linkCoordinator.links.forEach(function(a){a.action&&"AbsValFracSplitAction"===a.action.name&&"tap"===a.action.triggerType&&(a.action.name="AbsValFracJoinAction")}),a}}),Xf.push({update_to:"1.0.0-0",run:function(a){return a.version="1.0.0-0",a.linkCoordinator.links.forEach(function(b){if(b.action&&"CommuteAction"===b.action.name){var c=Sc(a,b.action.oldTree),d=new Id(c.ascii);b.action.target=d.getSelectorOfNodes(d.getNodesFromSelector(b.action.target)[0].children[1]),"right-of"===b.action.settings.side?b.action.settings.side="right-inside":"left-of"===b.action.settings.side&&(b.action.settings.side="left-inside")}if(b.action&&"BreakingBracketsInAction"===b.action.name){var e=Sc(a,b.action.oldTree),f=new Id(e.ascii);b.action.target=f.getSelectorOfNodes(f.getNodesFromSelector(b.action.target)[0].parent),"right-of"===b.action.settings.side?b.action.settings.side="right-inside":"left-of"===b.action.settings.side&&(b.action.settings.side="left-inside")}}),a}}),Xf.push({update_to:"0.15.1",run:function(a){var b=Xf.find(function(a){return"0.14.4"===a.update_to}),c=b.run(a);return c.version="0.15.1",c}}),Xf.push({update_to:"0.15.0",run:function(a){return a.version="0.15.0",a.linkCoordinator.links.forEach(function(b){if(b.action&&"SubstitutionAction"===b.action.name){b.action.name="DirectSubstitutionAction",b.action.source_am=b.action.nodes;var c=Sc(a,b.action.nodes);if(c){var d=new Id(c.ascii);b.action.nodes=d.getSelectorOfNodes(d.children[0].children[0])}else b.action.nodes=b.action.target}if(b.action&&"EquationCombineAction"===b.action.name){b.action.source_am=b.action.nodes;var e=Sc(a,b.action.nodes);e&&(b.action.nodes=e.ascii)}}),a}}),Xf.push({update_to:"0.14.4",run:function(a){return a.version="0.14.4",a.linkCoordinator.links.forEach(function(a){if(a.action)switch(a.action.name){case"editLineAction":a.action.name="FirstLineRewriteAction";break;case"RewriteExpressionWithKeyboardAction":a.action.name="ExpressionRewriteAction";break;case"EquationFountainAction":a.action.name="EquationRewriteAction";break;case"EquationCombineAction":a.action.name="CombinationRewriteAction";break;case"FractionExtendAction":a.action.name="FractionRewriteAction",a.action.latex=a.action.term}}),a}}),Xf.push({update_to:"0.14.2",run:function(a){return a.version="0.14.2",a.referenced_deleted_models||(a.referenced_deleted_models=[]),a}}),Xf.push({update_to:"0.12.15",run:function(a){return a.version="0.12.15",a.linkCoordinator.links.forEach(function(a){a.action&&"DistributePolynomials"===a.action.name&&(a.action.name="DistributePolynomialsAction")}),a}}),Xf.push({update_to:"0.12.14",run:function(a){return a.version="0.12.14",a}}),Xf.push({update_to:"0.12.11",run:function(a){var b={version:"0.12.11"},c={options:1,linkCoordinator:1,objects:1,paths:1};for(var d in a)d in c&&"string"==typeof a[d]?b[d]=JSON.parse(a[d]):b[d]=a[d];b.options||(b.options={}),b.linkCoordinator||(b.linkCoordinator={}),b.objects||(b.objects=[]),b.paths||(b.paths=[]),b.objects.forEach(function(a){"DerivationList"===a.type&&(a.type="Derivation")});var e={EquationFountain:"EquationFountainAction",InequalityFountain:"InequalityFountainAction",polynomialExpansionAction:"PolynomialExpansionAction",combineStackedExponentsUpAction:"CombineStackedExponentsUpAction"};return b.linkCoordinator.links.forEach(function(b){b.action&&(b.action.name in e&&(b.action.name=e[b.action.name]),Rc(b.action,a))}),b.user_data=a.user_data||{},b}}),Of.prototype.getCanvasUrl=function(){var a=arguments.length<=0||void 0===arguments[0]?null:arguments[0],b=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],c=arguments.length<=2||void 0===arguments[2]?"https://graspablemath.com/canvas":arguments[2],d=this.meta_data.save_id;null===a&&(a=-1!==location.pathname.indexOf("canvas/mac")?"/mac":-1!==location.pathname.indexOf("canvas/dev")?"/dev":"/");var e=dd({},b);d&&(e.load=encodeURIComponent(d));var f="?"+Object.keys(e).map(function(a){return encodeURIComponent(a)+"="+encodeURIComponent(e[a])}).join("&");return c+a+(f.length>1?f:"")},Of.prototype.save=function(){var a=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],b=arguments[1];a.clone&&(this.meta_data.cloned_from=this.meta_data.save_id,delete this.meta_data.save_id,this.meta_data.public=!1);var c=!this.meta_data||!this.meta_data.save_id,d=this.toJSON(this.meta_data.save_id||ad.uid(),a.transferOwnership&&a.transferOwnership.id);if(a.transferOwnership&&(this.meta_data.display_name=a.transferOwnership.name),console.log("File size:",(d.length/1e3).toFixed(1),"KB"),d.length>5e6)return console.warn("The data is too large for saving."),void(b&&b({reason:"File size too big ("+(d.length/1e6).toFixed(1)+" MB)."}));this.logger.logCustomInteraction(a.clone?"duplicate":"save",{type:"canvas"});var e=new XMLHttpRequest,f=this;b&&(e.onreadystatechange=function(){4===this.readyState&&(200===this.status||301===this.status||302===this.status?(f.controller.needsSaving(!1),f.events.meta_data_change({is_new_sheet:c||a.clone}),b(null,f)):b({reason:"Network or server error ("+e.status+").",status:e.status,statusText:e.statusText}))});var g=this.settings.get("savefile_server")+"/api/saves";c?e.open("POST",g):e.open("PUT",g+"/"+this.meta_data.save_id),e.setRequestHeader("Content-Type","application/json"),De.auth_token&&e.setRequestHeader("Authorization","Bearer "+De.auth_token),e.send(d)},Of.prototype.toJSON=function(){var a=arguments.length<=0||void 0===arguments[0]?null:arguments[0],b=arguments.length<=1||void 0===arguments[1]?null:arguments[1];this.meta_data||(this.meta_data={}),a&&(this.meta_data.save_id=a),b?this.meta_data.owner=b:De.logged_in&&(this.meta_data.owner=De.user_id);var c=ag(this);return JSON.stringify(c)},Of.prototype.loadFromFile=function(a){var b=arguments.length<=1||void 0===arguments[1]||arguments[1],c=arguments.length<=2||void 0===arguments[2]?null:arguments[2];this.logger.logCustomInteraction("load",{type:"canvas",canvas_save_id:a});var d=new XMLHttpRequest,e=this.settings.get("savefile_server")+"/api/saves/"+a,f=this;d.onreadystatechange=function(){4===d.readyState&&(200===this.status||301===this.status||302===this.status?f.loadFromJSON(d.responseText,b,c):c&&c("Network error ("+this.status+")"))},d.open("get",e,!0),d.setRequestHeader("Content-Type","application/json"),De.auth_token&&d.setRequestHeader("Authorization","Bearer "+De.auth_token),d.send()},Of.prototype.loadFromJSON=function(a){var b=arguments.length<=1||void 0===arguments[1]||arguments[1],c=arguments.length<=2||void 0===arguments[2]?null:arguments[2];this.controller.closeKeyboard();var d=JSON.parse(a);Array.isArray(d)&&(d=d[0]),b&&this.controller.reset();var e=Yc(this)+30,f=Qc(d.canvas_data,ad.version);b&&(this.meta_data=d.meta_data),e>30&&(f.objects.forEach(function(a){a.pos&&(a.pos.y+=e)}),f.paths.forEach(function(a){return a.points.forEach(function(a){return a[1]+=e})})),this.loadData(f),e>30&&this.model.scroll(e),this.events.meta_data_change({is_new_sheet:!0}),c&&c(null,this)},Of.prototype.loadData=function(a){this.loadDocSettings(a.settings),this.logger.listen(!1),$f(this,a);var b={};Mc(JSON.stringify(a.referenced_deleted_models),b);var c=Mc(JSON.stringify(a.objects),b,this.model);Mc(JSON.stringify(a.paths),b,this.model),Mc(JSON.stringify(a.linkCoordinator),b),Zf(c,b),_f(),this.logger.listen(!0),a.settings.Canvas&&a.settings.Canvas.active_tool&&this.model.setActiveTool(a.settings.Canvas.active_tool,!0),this.logger.canvas_logger.dlLoggers.forEach(function(a){a.initListeners()})},Of.prototype.loadDocSettings=function(a){if(a){var b=md.getAll();for(var c in b)if(c in a){var d=b[c].getOrCreateDoc(this.id);d.setAll(a[c])}}};Of.prototype.archiveFile=function(a,b){var c=this.settings.get("savefile_server");Yf(!0,c,a,b)},Of.prototype.unarchiveFile=function(a,b){var c=this.settings.get("savefile_server");Yf(!1,c,a,b)},Yf=function(a,b,c,d){var e=new XMLHttpRequest,f=c.archived;d&&(e.onreadystatechange=function(){4===this.readyState&&(200===this.status||301===this.status||302===this.status?d&&d(null,c):(c.archived=f,d&&d({reason:"Network or server error ("+e.status+").",status:e.status,statusText:e.statusText})))}),e.open("PUT",b+"/api/saves/"+c.save_id),e.setRequestHeader("Content-Type","application/json"),De.auth_token&&e.setRequestHeader("Authorization","Bearer "+De.auth_token),e.send(JSON.stringify({"meta_data.archived":a})),c.archived=a},Zf=function(a,b){a.filter(function(a){return"derivation"===a.type}).forEach(function(a){a.rows.forEach(function(a){a.action&&(a.action=b[a.action])})})},$f=function(a,b){function c(a){return f[a]?f[a]:-1===e.indexOf(a)?a:(f[a]=ad.uid(),console.log("assigning new id"),f[a])}function d(a){if(Array.isArray(a))a.forEach(function(b,e){"string"==typeof b?a[e]=c(b):d(b)});else if("object"==typeof a&&a)for(var b in a)if(a.hasOwnProperty(b)){var e=a[b];"string"==typeof e?a[b]=c(e):d(e)}}var e=a.model.elements().map(function(a){return a.id}).concat(a.model.paths().map(function(a){return a.id}));nb().links.forEach(function(a){e.push(a.action.id),e.push(a.id)}),a.model.getElementsOfType("derivation").forEach(function(a){a.rows.forEach(function(a){e.push(a.id),e.push(a.model.id)})}),console.log(e);var f={};d(b)},_f=function(a){nb().groups.forEach(function(a){0===a.deps&&a.nodes.forEach(function(a){if(a instanceof Id){var b=a.children[0].get_mapping_to(a.children[0]);a.events.change(new Id.ChangeEvent({model:a,no_anim:!0,node_map:b}))}})})},ag=function(a){var b=a.meta_data,c={};c.version=ad.version,c.settings=md.docSettingsToJSON(a.id),c.settings.Canvas.active_tool=a.settings.get("active_tool"),c.settings.mode_btns&&(c.settings.mode_btns=c.settings.mode_btns.filter(function(a){return"mode"===a.group}),c.settings.mode_btns.forEach(function(a,b){a.state=0===b})),c.linkCoordinator=nb();var d=a.model.elements(),e=a.model.paths();return c.objects=d,c.paths=e,c.referenced_deleted_models=Zc(a),{meta_data:b,canvas_data:c}},ad.Tree=_c,ad.session_id=ad.uid(),ad.version="2.6.3",a("expressions",bg=ad.expressions),a("ui",cg=ad.ui),a("options",dg=ad.options),a("mtouch_defaults",eg=ad.mtouch_defaults),a("mtouch_events",fg=ad.mtouch_events),a("d3_eventDispatch",gg=ad.d3_eventDispatch),a("transform_behavior",hg=ad.transform_behavior),a("Timeline",ig=ad.Timeline),a("CanvasElementClass",jg=ad.CanvasElementClass),a("tokenize",kg=ad.tokenize),a("AlgebraParser",lg=ad.AlgebraParser),a("AlgebraRegExp",mg=ad.AlgebraRegExp),a("FontLoader",ng=ad.FontLoader),a("ChangeNumberHandler",og=ad.ChangeNumberHandler),a("HitTester",pg=ad.HitTester),a("Reselector",qg=ad.Reselector),a("DragHandler",rg=ad.DragHandler),a("AlgebraModelLink",sg=ad.AlgebraModelLink),a("actions",tg=ad.actions),a("Action",ug=ad.Action),a("factoring",vg=ad.factoring),a("canceling",wg=ad.canceling),a("rules",xg=ad.rules),a("DerivationRow",yg=ad.DerivationRow),a("Derivation",zg=ad.Derivation),a("CanvasEventRecorder",Ag=ad.CanvasEventRecorder),a("DLLogger",Bg=ad.DLLogger),a("CanvasLogger",Cg=ad.CanvasLogger),a("DataLogger",Dg=ad.DataLogger),a("GMEventRecorder",Eg=ad.GMEventRecorder),a("EventRecorder",Fg=ad.EventRecorder),a("ServerComm",Gg=ad.ServerComm),a("setupLogging",Hg=ad.setupLogging),a("svg_play_button",Ig=ad.svg_play_button),a("TrialLogger",Jg=ad.TrialLogger),a("IdentificationModal",Kg=ad.IdentificationModal),a("gmifyPage",Lg=ad.gmifyPage),a("version",Mg=ad.version),a("session_id",Ng=ad.session_id),a("Algebrite",$c),a("expressions",bg),a("ui",cg),a("options",dg),a("mtouch_defaults",eg),a("mtouch_events",fg),a("d3_eventDispatch",gg),a("transform_behavior",hg),a("Timeline",ig),a("CanvasElementClass",jg),a("tokenize",kg),a("AlgebraParser",lg),a("AlgebraRegExp",mg),a("FontLoader",ng),a("ChangeNumberHandler",og),a("HitTester",pg),a("Reselector",qg),a("DragHandler",rg),a("AlgebraModelLink",sg),a("actions",tg),a("Action",ug),a("factoring",vg),a("canceling",wg),a("rules",xg),a("DerivationRow",yg),a("Derivation",zg),a("CanvasEventRecorder",Ag),a("DLLogger",Bg),a("CanvasLogger",Cg),a("DataLogger",Dg),a("GMEventRecorder",Eg),a("EventRecorder",Fg),a("ServerComm",Gg),a("setupLogging",Hg),a("svg_play_button",Ig),a("TrialLogger",Jg),a("IdentificationModal",Kg),a("gmifyPage",Lg),a("Tree",_c),a("version",Mg),a("session_id",Ng),a("AlgebraView",te),a("preloadFonts",ue),a("user",De),a("loadFromJSON",Mc),a("SettingsType",md),a("dont_catch_exceptions",kd),a("MathSettings",od),a("reduceProduct",Ca),a("Canvas",Of),a("CanvasModelView",Kf),a("CanvasController",Rb),a("TextBox",Sf),a("CanvasImage",Qf),a("insertCanvas",Nf),a("getHelpEntries",bc),a("googleAuth",Ae),a("gcAuth",Be),a("evalExpression",Oa),a("linkCoordinator",nb),a("AlgebraModel",Id),a("applyCoefficient",Ia),a("uid",bd),a("inherit",d),a("object",cd),a("extend",dd),a("extendExisting",ed),a("deepCopy",fd),a("deepEquals",gd),a("find",e),a("findIndex",f),a("array",hd),a("getURLParameter",g),a("getAllURLParameters",h),a("byteLength",i),a("termsToAlgebriteString",j),a("loadScripts",k),a("getStackTrace",l)}}}),function(a){if("undefined"!=typeof document){var b=document,c="appendChild",d=b.createElement("style");d.type="text/css",b.getElementsByTagName("head")[0][c](d),d[c](b.createTextNode(a))}}('@font-face{font-family:Symbola;src:url(jspm_packages/npm/mathquill@0.10.1/build/font/Symbola.eot);src:local("Symbola Regular"),local("Symbola"),url(jspm_packages/npm/mathquill@0.10.1/build/font/Symbola.woff2) format("woff2"),url(jspm_packages/npm/mathquill@0.10.1/build/font/Symbola.woff) format("woff"),url(jspm_packages/npm/mathquill@0.10.1/build/font/Symbola.ttf) format("truetype"),url(jspm_packages/npm/mathquill@0.10.1/build/font/Symbola.otf) format("opentype"),url(jspm_packages/npm/mathquill@0.10.1/build/font/Symbola.svg#Symbola) format("svg")}.mq-editable-field,.mq-editable-field .mq-cursor{display:-moz-inline-box;display:inline-block}.mq-editable-field .mq-cursor{border-left:1px solid #000;margin-left:-1px;position:relative;z-index:1;padding:0}.mq-editable-field .mq-cursor.mq-blink{visibility:hidden}.mq-editable-field,.mq-math-mode .mq-editable-field{border:1px solid gray}.mq-editable-field.mq-focused,.mq-math-mode .mq-editable-field.mq-focused{box-shadow:0 0 1px 2px #8bd,inset 0 0 2px 0 #6ae;border-color:#709ac0;border-radius:1px}.mq-math-mode .mq-editable-field{margin:1px}.mq-editable-field .mq-latex-command-input{color:inherit;font-family:Courier New,monospace;border:1px solid gray;padding-right:1px;margin-right:1px;margin-left:2px}.mq-editable-field .mq-latex-command-input.mq-empty{background:transparent}.mq-editable-field .mq-latex-command-input.mq-hasCursor{border-color:ActiveBorder}.mq-editable-field .mq-cursor:only-child:after,.mq-editable-field.mq-empty:after,.mq-editable-field.mq-text-mode:after,.mq-editable-field .mq-textarea+.mq-cursor:last-child:after,.mq-math-mode .mq-empty:after{visibility:hidden;content:\'c\'}.mq-editable-field .mq-text-mode .mq-cursor:only-child:after{content:\'\'}.mq-editable-field.mq-text-mode{overflow-x:auto;overflow-y:hidden}.mq-math-mode .mq-root-block,.mq-root-block{display:-moz-inline-box;display:inline-block;width:100%;padding:2px;box-sizing:border-box;white-space:nowrap;overflow:hidden;vertical-align:middle}.mq-math-mode{font-variant:normal;font-weight:400;font-style:normal;font-size:115%;line-height:1}.mq-math-mode,.mq-math-mode .mq-non-leaf,.mq-math-mode .mq-scaled{display:-moz-inline-box;display:inline-block}.mq-math-mode .mq-nonSymbola,.mq-math-mode .mq-text-mode,.mq-math-mode var{font-family:Times New Roman,Symbola,serif;line-height:.9}.mq-math-mode *{font-size:inherit;line-height:inherit;margin:0;padding:0;border-color:#000;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;box-sizing:border-box}.mq-math-mode .mq-empty{background:#ccc}.mq-math-mode.mq-empty,.mq-math-mode .mq-empty.mq-root-block{background:transparent}.mq-math-mode .mq-text-mode{display:inline-block}.mq-math-mode .mq-text-mode.mq-hasCursor{box-shadow:inset 0 .1em .2em #a9a9a9;padding:0 .1em;margin:0 -.1em;min-width:1ex}.mq-math-mode .mq-font{font:1em Times New Roman,Symbola,serif}.mq-math-mode .mq-font *{font-family:inherit;font-style:inherit}.mq-math-mode b,.mq-math-mode b.mq-font{font-weight:bolder}.mq-math-mode i,.mq-math-mode i.mq-font,.mq-math-mode var{font-style:italic}.mq-math-mode var.mq-f{margin-right:.2em;margin-left:.1em}.mq-math-mode .mq-roman var.mq-f{margin:0}.mq-math-mode big{font-size:200%}.mq-math-mode .mq-int>big{display:inline-block;-webkit-transform:scaleX(.7);transform:scaleX(.7);vertical-align:-.16em}.mq-math-mode .mq-int>.mq-supsub{font-size:80%;vertical-align:-1.1em;padding-right:.2em}.mq-math-mode .mq-int>.mq-supsub>.mq-sup>.mq-sup-inner{vertical-align:1.3em}.mq-math-mode .mq-int>.mq-supsub>.mq-sub{margin-left:-.35em}.mq-math-mode .mq-roman{font-style:normal}.mq-math-mode .mq-sans-serif{font-family:sans-serif}.mq-math-mode .mq-monospace{font-family:monospace,Symbola,serif}.mq-math-mode .mq-overline{border-top:1px solid #000;margin-top:1px}.mq-math-mode .mq-underline{border-bottom:1px solid #000;margin-bottom:1px}.mq-math-mode .mq-binary-operator{padding:0 .2em;display:-moz-inline-box;display:inline-block}.mq-math-mode .mq-supsub{text-align:left;font-size:90%;vertical-align:-.5em}.mq-math-mode .mq-supsub.mq-sup-only{vertical-align:.5em}.mq-math-mode .mq-supsub.mq-sup-only .mq-sup{display:inline-block;vertical-align:text-bottom}.mq-math-mode .mq-supsub .mq-sup{display:block}.mq-math-mode .mq-supsub .mq-sub{display:block;float:left}.mq-math-mode .mq-supsub .mq-binary-operator{padding:0 .1em}.mq-math-mode .mq-supsub .mq-fraction{font-size:70%}.mq-math-mode sup.mq-nthroot{font-size:80%;vertical-align:.8em;margin-right:-.6em;margin-left:.2em;min-width:.5em}.mq-math-mode .mq-paren{padding:0 .1em;vertical-align:top;-webkit-transform-origin:center .06em;transform-origin:center .06em}.mq-math-mode .mq-paren.mq-ghost{color:silver}.mq-math-mode .mq-paren+span{margin-top:.1em;margin-bottom:.1em}.mq-math-mode .mq-array{vertical-align:middle;text-align:center}.mq-math-mode .mq-array>span{display:block}.mq-math-mode .mq-operator-name{font-family:Symbola,Times New Roman,serif;line-height:.9;font-style:normal}.mq-math-mode var.mq-operator-name.mq-first{padding-left:.2em}.mq-math-mode .mq-supsub.mq-after-operator-name,.mq-math-mode var.mq-operator-name.mq-last{padding-right:.2em}.mq-math-mode .mq-fraction{font-size:90%;text-align:center;vertical-align:-.4em;padding:0 .2em}.mq-math-mode .mq-fraction,.mq-math-mode .mq-large-operator,.mq-math-mode x:-moz-any-link{display:-moz-groupbox}.mq-math-mode .mq-fraction,.mq-math-mode .mq-large-operator,.mq-math-mode x:-moz-any-link,.mq-math-mode x:default{display:inline-block}.mq-math-mode .mq-denominator,.mq-math-mode .mq-numerator{display:block}.mq-math-mode .mq-numerator{padding:0 .1em}.mq-math-mode .mq-denominator{border-top:1px solid;float:right;width:100%;padding:.1em}.mq-math-mode .mq-sqrt-prefix{padding-top:0;position:relative;top:.1em;vertical-align:top;-webkit-transform-origin:top;transform-origin:top}.mq-math-mode .mq-sqrt-stem{border-top:1px solid;margin-top:1px;padding-left:.15em;padding-right:.2em;margin-right:.1em;padding-top:1px}.mq-math-mode .mq-vector-prefix{display:block;text-align:center;line-height:.25em;margin-bottom:-.1em;font-size:.75em}.mq-math-mode .mq-vector-stem{display:block}.mq-math-mode .mq-large-operator{vertical-align:-.2em;padding:.2em;text-align:center}.mq-math-mode .mq-large-operator .mq-from,.mq-math-mode .mq-large-operator .mq-to,.mq-math-mode .mq-large-operator big{display:block}.mq-math-mode .mq-large-operator .mq-from,.mq-math-mode .mq-large-operator .mq-to{font-size:80%}.mq-math-mode .mq-large-operator .mq-from{float:right;width:100%}.mq-math-mode,.mq-math-mode .mq-editable-field{cursor:text;font-family:Symbola,Times New Roman,serif}.mq-math-mode .mq-overarrow{border-top:1px solid #000;margin-top:1px;padding-top:.2em}.mq-math-mode .mq-overarrow:before{display:block;position:relative;top:-.34em;font-size:.5em;line-height:0;content:\'\\27A4\';text-align:right}.mq-math-mode .mq-overarrow.mq-arrow-left:before{-webkit-transform:scaleX(-1);transform:scaleX(-1);-webkit-filter:FlipH;filter:FlipH;-ms-filter:"FlipH"}.mq-editable-field .mq-selection,.mq-editable-field .mq-selection .mq-non-leaf,.mq-editable-field .mq-selection .mq-scaled,.mq-math-mode .mq-selection,.mq-math-mode .mq-selection .mq-non-leaf,.mq-math-mode .mq-selection .mq-scaled{background:#b4d5fe!important;background:Highlight!important;color:HighlightText;border-color:HighlightText}.mq-editable-field .mq-selection .mq-matrixed,.mq-math-mode .mq-selection .mq-matrixed{background:#39f!important}.mq-editable-field .mq-selection .mq-matrixed-container,.mq-math-mode .mq-selection .mq-matrixed-container{filter:progid:DXImageTransform.Microsoft.Chroma(color=\'#3399FF\')!important}.mq-editable-field .mq-selection.mq-blur,.mq-editable-field .mq-selection.mq-blur .mq-matrixed,.mq-editable-field .mq-selection.mq-blur .mq-non-leaf,.mq-editable-field .mq-selection.mq-blur .mq-scaled,.mq-math-mode .mq-selection.mq-blur,.mq-math-mode .mq-selection.mq-blur .mq-matrixed,.mq-math-mode .mq-selection.mq-blur .mq-non-leaf,.mq-math-mode .mq-selection.mq-blur .mq-scaled{background:#d4d4d4!important;color:#000;border-color:#000}.mq-editable-field .mq-selection.mq-blur .mq-matrixed-container,.mq-math-mode .mq-selection.mq-blur .mq-matrixed-container{filter:progid:DXImageTransform.Microsoft.Chroma(color=\'#D4D4D4\')!important}.mq-editable-field .mq-textarea,.mq-math-mode .mq-textarea{position:relative;-webkit-user-select:text;-moz-user-select:text;-ms-user-select:text;user-select:text}.mq-editable-field .mq-selectable,.mq-editable-field .mq-textarea *,.mq-math-mode .mq-selectable,.mq-math-mode .mq-textarea *{-webkit-user-select:text;-moz-user-select:text;-ms-user-select:text;user-select:text;position:absolute;clip:rect(1em 1em 1em 1em);-webkit-transform:scale(0);transform:scale(0);resize:none;width:1px;height:1px}.mq-math-mode .mq-matrixed{background:#fff;display:-moz-inline-box;display:inline-block}.mq-math-mode .mq-matrixed-container{filter:progid:DXImageTransform.Microsoft.Chroma(color=\'white\');margin-top:-.1em}\n/*# sourceMappingURL=__.css.map */')})(function(a){"function"==typeof define&&define.amd?define([],a):"object"==typeof module&&module.exports&&"function"==typeof require?module.exports=a():gmath=a()});