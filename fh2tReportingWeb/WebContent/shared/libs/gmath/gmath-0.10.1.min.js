/// Copyright Erik Weitnauer 2016.
(function(){if(typeof gmath==="undefined")gmath={};gmath.expressions={};gmath.version="0.10.1";gmath.options={};gmath.options.actions={};gmath.options.actions.substitution_on=true;gmath.options.actions.only_integer_division=false;gmath.options.actions.simplify_sum_in_numerator_after_adding_fractions=false;gmath.options.actions.second_child_eq_inversion=false;gmath.options.actions.cancel_powers=true;gmath.options.actions.factor_after_finding_gcf=true;(function(){var t=4294967296,e=15,i=[],n=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];function r(){var r=0;var o=Math.random()*t;i[r++]=n[o&e];i[r++]=n[o>>>4&e];i[r++]=n[o>>>8&e];i[r++]=n[o>>>12&e];i[r++]=n[o>>>16&e];i[r++]=n[o>>>20&e];i[r++]=n[o>>>24&e];i[r++]=n[o>>>28&e];o=Math.random()*t;i[r++]=n[o&e];i[r++]=n[o>>>4&e];i[r++]=n[o>>>8&e];i[r++]=n[o>>>12&e];i[r++]=n[o>>>16&e];i[r++]=n[o>>>20&e];i[r++]=n[o>>>24&e];i[r++]=n[o>>>28&e];return"_"+i.join("")}gmath.uid=r})();gmath.inherit=function(t,e){var i=e.prototype;e.prototype=Object.create(t.prototype);for(var n in i){e.prototype[n]=i[n]}e.prototype.constructor=e;Object.defineProperty(e.prototype,"constructor",{enumerable:false,value:e})};gmath.object={};gmath.object.extend=function(t,e){if(typeof e==="object")for(var i in e)t[i]=e[i];return t};gmath.object.extendExisting=function(t,e){for(var i in t)if(i in e)t[i]=e[i];return t};gmath.object.extendChanged=function(t,e,i){for(var n in e)if(n in i&&!gmath.deepEquals(i[n],e[n]))t[n]=e[n];return t};gmath.object.extendDifferent=function(t,e,i){for(var n in e)if(!(n in i)||!gmath.deepEquals(i[n],e[n]))t[n]=e[n];return t};gmath.object.merged=function(t,e){return gmath.object.extend(gmath.object.extend({},t),e)};gmath.extend=gmath.object.extend;gmath.deepCopy=function(t){var e=t;if(Array.isArray(t)){e=[];for(var i=0;i<t.length;i++)e[i]=gmath.deepCopy(t[i])}else if(typeof t==="object"){e={};for(var n in t)if(t.hasOwnProperty(n))e[n]=gmath.deepCopy(t[n])}return e};gmath.deepEquals=function(t,e){if(t===e)return true;if(Array.isArray(t)){if(!Array.isArray(e))return false;if(t.length!==e.length)return false;for(var i=0;i<t.length;i++)if(!gmath.deepEquals(t[i],e[i]))return false;return true}else if(typeof t==="object"){if(!typeof e==="object")return false;for(var n in t)if(t.hasOwnProperty(n)){if(!e.hasOwnProperty(n))return false;if(!gmath.deepEquals(t[n],e[n]))return false}return true}return false};gmath.find=function(t,e){for(var i=0;i<t.length;i++){if(e(t[i],i,t))return t[i]}return undefined};gmath.findIndex=function(t,e){for(var i=0;i<t.length;i++){if(e(t[i],i,t))return i}return-1};gmath.array={};gmath.array.containsAll=function(t,e){if(e.length>t.length)return false;for(var i=0;i<e.length;i++)if(t.indexOf(e[i])===-1)return false;return true};gmath.array.remove=function(t,e){var i=t.indexOf(e);return i===-1?[]:t.splice(i,1)};gmath.array.equals=function(t,e){if(t.length!==e.length)return false;for(var i=0;i<t.length;i++)if(t[i]!==e[i])return false;return true};gmath.array.isPermutation=function(t,e){if(e.length!==t.length)return false;for(var i=0;i<e.length;i++){var n=t.indexOf(e[i]);if(n===-1)return false;else t[n]=undefined}return true};gmath.array.mergedNew=function(t,e){var i=t.slice();for(var n=0;n<e.length;n++)if(t.indexOf(e[n])===-1)i.push(e[n]);return i};gmath.array.xor=function(t,e){var i=[];for(var n=0;n<t.length;n++)if(e.indexOf(t[n])===-1)i.push(t[n]);for(var n=0;n<e.length;n++)if(t.indexOf(e[n])===-1)i.push(e[n]);return i};gmath.array.flatten=function(t){var e=[];for(var i=0;i<t.length;i++)e=e.concat(t[i]);return e};gmath.array.includes=function(t,e){return t.indexOf(e)!==-1};gmath.getURLParameter=function(t){var e=RegExp(t+"="+"(.+?)(&|$)").exec(location.search);return e?decodeURIComponent(e[1]):null};if(typeof Object.create!=="function"){Object.create=function(t){function e(){}e.prototype=t;return new e}}if(!Array.isArray){Array.isArray=function(t){return Object.prototype.toString.call(t)==="[object Array]"}}gmath.byteLength=function(t){var e=t.length;for(var i=t.length-1;i>=0;i--){var n=t.charCodeAt(i);if(n>127&&n<=2047)e++;else if(n>2047&&n<=65535)e+=2;if(n>=56320&&n<=57343)i--}return e};(function(){gmath.termsToAlgebriteString=function(i){if(!Array.isArray(i))i=[i];return t.is_range(i)&&i[0].is_group("div","mul")?i.map(function(t){return e(t.children[1])}).join("*"):i.map(function(t){return e(t)}).join("")};function e(t){if(t.is_group("sign"))return"("+t.to_ascii()+")";else return t.to_ascii()}})();gmath.loadScripts=function(t,e){if(t&&!Array.isArray(t))t=[t];var i=t.length;t.forEach(function(t,n){var r=document.createElement("script");r.type="text/javascript";if(e&&n===i-1){if(r.readyState){r.onreadystatechange=function(){if(r.readyState=="loaded"||r.readyState=="complete"){r.onreadystatechange=null;if(e)e()}}}else{r.onload=function(){if(e)e()}}}r.src=t;r.async=false;document.head.appendChild(r)})};var t={version:"1.3.1x"};if(typeof exports!="undefined"){exports.Tree=t}t.parse=function(e){var i=new t.Node;var n=i.append(new t.Node);var r;n.value="";for(r=0;r<e.length;r++){var o=e[r];if(o=="["){n=n.append(new t.Node);n.value=""}else if(o=="]"){n=n.parent;if(n===i)throw"parse error"}else if(o==","){n=n.parent.append(new t.Node);n.value=""}else{n.value+=o}}for(r=0;r<i.children.length;r++)i.children[r].parent=null;if(i.children.length===1)return i.children[0];return i.children};t.stringify=function(t){var e=function(t){var i="";if("value"in t)i+=t.value;if(t.children&&t.children[0]){i+="["+t.children.map(e).join(",")+"]"}return i};if(!Array.isArray(t))t=[t];return t.map(e).join(",")};(function(){var e=4294967296,i=15,n=[],r=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];function o(){var t=0;var o=Math.random()*e;n[t++]=r[o&i];n[t++]=r[o>>>4&i];n[t++]=r[o>>>8&i];n[t++]=r[o>>>12&i];n[t++]=r[o>>>16&i];n[t++]=r[o>>>20&i];n[t++]=r[o>>>24&i];n[t++]=r[o>>>28&i];o=Math.random()*e;n[t++]=r[o&i];n[t++]=r[o>>>4&i];n[t++]=r[o>>>8&i];n[t++]=r[o>>>12&i];n[t++]=r[o>>>16&i];n[t++]=r[o>>>20&i];n[t++]=r[o>>>24&i];n[t++]=r[o>>>28&i];return"_"+n.join("")}t.uid=o})();t.clone=function(e,i,n){var r=function(e){var o;var s=new e.constructor;if(n){for(o=0;o<n.length;o++)s[n[o]]=e[n[o]]}else{for(var a in e){if(a[0]!=="_")s[a]=e[a]}}delete s.ls;delete s.rs;delete s.parent;if(e.id&&!i)s.id=t.uid();if(e.children){s.children=[];for(o=0;o<e.children.length;o++){s.children.push(r(e.children[o]));s.children[o].parent=s}for(o=0;o<e.children.length;o++){s.children[o].ls=s.children[o-1];s.children[o].rs=s.children[o+1]}}return s};if(!Array.isArray(e))return r(e);var o=e.map(r);if(e.length>1)for(var s=0;s<e.length;s++){if(s>0&&e[s].ls===e[s-1])o[s].ls=o[s-1];if(s<e.length-1&&e[s].rs===e[s+1])o[s].rs=o[s+1]}return o};t.get_mapping_between=function(t,e){var i={};function n(t,e){if(t.id in i)throw"duplicate id in source tree";i[t.id]=[e];if(t.children.length!==e.children.length){if(!t.has_children())i[t.id]=e.select_all();else if(!e.has_children())t.for_each(function(t){i[t.id]=[e]});else throw"tree structures don't match"}else{for(var r=0;r<t.children.length;r++)n(t.children[r],e.children[r])}}if(Array.isArray(t)){if(t.length!==e.length)throw"tree structures don't match";for(var r=0;r<t.length;r++)n(t[r],e[r])}else n(t,e);return i};t.get_1to1_mapping_between=function(t,e,i){var n={};if(arguments.length<3)i=true;function r(t,e){if(i&&t.id in n)throw"duplicate id in source tree";n[t.id]=[e];if(i&&t.children.length!==e.children.length)throw"tree structures don't match";var o=t.children.length,s=e.children.length;for(var a=0;a<o;a++){if(a<s)r(t.children[a],e.children[a]);else t.children[a].for_each(function(t){n[t.id]=[]})}}if(Array.isArray(t)){if(i&&t.length!==e.length)throw"tree structures don't match";var o=t.length,s=e.length;for(var a=0;a<o;a++){if(a<s)r(t[a],e[a]);else t[a].for_each(function(t){n[t.id]=[]})}}else r(t,e);return n};t.nodes_to_range=function(e){var i=e.length;if(i===0)return[];if(i===1)return[e[0]];var n=e[0];while(n.parent)n=n.parent;var r=e.map(function(e){return t.get_path(e)});var o=function(t){var e=r[0][t];for(var i=0;i<r.length;i++){if(r[i].length<=t+1)return false;if(r[i][t]!==e)return false}return true};var s=0;while(o(s))s++;var a=t.get_child(r[0].slice(0,s),n);var l=-1,h=a.children.length,p;for(p=0;p<i;p++){var u=t.get_child(r[p].slice(0,s+1),n);var c=a.children.indexOf(u);if(c>l)l=c;if(c<h)h=c}var d=[];for(p=h;p<=l;p++)d.push(a.children[p]);return d};t.insert=function(t,e,i){i.ls=t.children[e-1];if(t.children[e-1])t.children[e-1].rs=i;i.rs=t.children[e];if(t.children[e])t.children[e].ls=i;i.parent=t;t.children.splice(e,0,i);return i};t.insert_range=function(t,e,i){var n=i.length;if(n===0)return;i[0].ls=t.children[e-1];if(t.children[e-1])t.children[e-1].rs=i[0];i[n-1].rs=t.children[e];if(t.children[e])t.children[e].ls=i[n-1];for(var r=0;r<n;r++)i[r].parent=t;t.children=t.children.slice(0,e).concat(i,t.children.slice(e));return i};t.append_range=function(t,e){var i=e.length;if(i===0)return;var n=t.children[t.children.length-1];if(n)n.rs=e[0];e[0].ls=n;e[i-1].rs=null;for(var r=0;r<i;r++)e[r].parent=t;t.children=t.children.concat(e);return e};t.filterRange=function(t,e){var i=[];var n=Array.isArray(e)?e:[e];var r=function(e,n){var o=[];for(var s=n;s<e.length;s++){o.push(e[s]);if(t(o))i.push(o.slice())}if(e[n].children)for(var s=0;s<e[n].children.length;s++)r(e[n].children,s)};for(var o=0;o<n.length;o++)r(n,o);return i};t.append=function(t,e){var i=t.children[t.children.length-1];if(i)i.rs=e;e.ls=i;e.rs=null;e.parent=t;t.children.push(e);return e};t.remove=function(t){var e;var i=t.parent.children;e=i.indexOf(t);if(i[e-1])i[e-1].rs=t.rs;if(i[e+1])i[e+1].ls=t.ls;i.splice(e,1);return e};t.remove_range=function(t){var e=t.length;if(e===0)return;var i=t[0].parent.children;var n=i.indexOf(t[0]);if(i[n-1])i[n-1].rs=t[e-1].rs;if(i[n+e])i[n+e].ls=t[0].ls;i.splice(n,e);return n};t.replace=function(e,i){if(i.parent)t.remove(i);var n=t.remove(e);return t.insert(e.parent,n,i)};t.switch_siblings=function(t,e){if(t.parent!=e.parent)throw"Called switch_siblings on nodes that are no siblings!";var i=t.parent;var n=i.children.indexOf(t);var r=i.children.indexOf(e);i.children[n]=e;i.children[r]=t;var o;if(t.rs==e){if(t.ls)t.ls.rs=e;if(e.rs)e.rs.ls=t;t.rs=e.rs;e.ls=t.ls;t.ls=e;e.rs=t}else if(t.ls==e){if(t.rs)t.rs.ls=e;if(e.ls)e.ls.rs=t;t.ls=e.ls;e.rs=t.rs;t.rs=e;e.ls=t}else{if(t.ls)t.ls.rs=e;if(t.rs)t.rs.ls=e;if(e.ls)e.ls.rs=t;if(e.rs)e.rs.ls=t;o=t.ls;t.ls=e.ls;e.ls=o;o=t.rs;t.rs=e.rs;e.rs=o}};t.validate=function(t){var e=function(t,i){if(t.parent!=i)throw"wrong parent information";if(t.children){for(var n=0;n<t.children.length;n++){var r=t.children[n];if(r.ls!=t.children[n-1])throw"wrong ls information";if(r.rs!=t.children[n+1])throw"wrong rs information";e(r,t)}}};if(!Array.isArray(t))t=[t];for(var i=0;i<t.length;i++)e(t[i],null)};t.get_idx=function(t){if(t.parent)return t.parent.children.indexOf(t);else return-1};t.get_child=function(t,e){for(var i=0;i<t.length;i++){if(!e.children||e.children.length<=t[i])throw"invalid path";e=e.children[t[i]]}return e};t.get_parent=function(t,e){for(var i=0;i<t;i++){if(e.parent)e=e.parent;else throw"invalid path"}return e};t.get_path=function(t){var e=[];while(t.parent){e.unshift(t.parent.children.indexOf(t));t=t.parent}return e};t.for_each=function(t,e){var i=Array.isArray(e)?e:[e];var n=function(e){t(e);if(e.children)for(var i=0;i<e.children.length;i++)n(e.children[i])};for(var r=0;r<i.length;r++)n(i[r])};t.map=function(t,e){var i=Array.isArray(e)?e:[e];var n=[];var r=function(e){n.push(t(e));if(e.children)for(var i=0;i<e.children.length;i++)r(e.children[i])};for(var o=0;o<i.length;o++)r(i[o]);return n};t.filter=function(t,e){var i=[];var n=Array.isArray(e)?e:[e];var r=function(e){if(t(e))i.push(e);if(e.children)for(var n=0;n<e.children.length;n++)r(e.children[n])};for(var o=0;o<n.length;o++)r(n[o]);return i};t.select_all=function(e){return t.filter(function(){return true},e)};t.select_first=function(t,e){var i=function(e){var i=e;for(;;){if(t(i))return i;if(i.children&&i.children[0]){i=i.children[0];continue}if(i===e)return null;while(!i.rs){i=i.parent;if(i===e)return null}i=i.rs}};var n=Array.isArray(e)?e:[e];for(var r=0;r<n.length;r++){var o=i(n[r]);if(o)return o}return null};t.get_cca=function(e){var i=e.map(function(e){return t.get_path(e)});var n=function(t){var e=i[0][t];for(var n=0;n<i.length;n++){if(i[n].length<=t+1)return false;if(i[n][t]!==e)return false}return true};var r=0;while(n(r))r++;var o=i[0].length-r,s=e[0];for(var a=0;a<o;a++)s=s.parent;return s};t.get_leaf_nodes=function(e){return t.filter(function(t){return!(t.children&&t.children.length)},e)};t.is_root=function(t){return!t.parent};t.is_range=function(t){for(var e=1;e<t.length;e++){if(t[e-1].rs!==t[e])return false}return true};t.get_root=function(t){while(t.parent)t=t.parent;return t};t.get_by_value=function(e,i){return t.filter(function(t){return t.value===e},i)};t.get_by_id=function(e,i){return t.select_first(function(t){return t.id===e},i)};t.Node=function(){this.children=[];this.parent=null;this.ls=null;this.rs=null;this.id=t.uid()};t.Node.prototype.stringify=function(){return t.stringify(this)};t.Node.prototype.clone=function(e,i){return t.clone(this,e,i)};t.Node.prototype.get_mapping_to=function(e){return t.get_mapping_between(this,e)};t.Node.prototype.get_1to1_mapping_to=function(e,i){return t.get_1to1_mapping_between(this,e,i)};t.Node.prototype.insert=function(e,i){return t.insert(this,e,i)};t.Node.prototype.insert_range=function(e,i){return t.insert_range(this,e,i)};t.Node.prototype.append_range=function(e){return t.append_range(this,e)};t.Node.prototype.append=function(e){return t.append(this,e)};t.Node.prototype.remove=function(){return t.remove(this)};t.Node.prototype.remove_range=function(e){return t.remove_range(e)};t.Node.prototype.replace_with=function(e){return t.replace(this,e)};t.Node.prototype.switch_with_sibling=function(e){return t.switch_siblings(this,e)};t.Node.prototype.validate=function(){return t.validate(this)};t.Node.prototype.get_child=function(e){return t.get_child(e,this)};t.Node.prototype.get_parent=function(e){return t.get_parent(e,this)};t.Node.prototype.get_path=function(){return t.get_path(this)};t.Node.prototype.for_each=function(e){return t.for_each(e,this)};t.Node.prototype.map=function(e){return t.map(e,this)};t.Node.prototype.filter=function(e){return t.filter(e,this)};t.Node.prototype.filterRange=function(e){return t.filterRange(e,this)};t.Node.prototype.select_all=function(){return t.select_all(this)};t.Node.prototype.select_first=function(e){return t.select_first(e,this)};t.Node.prototype.get_leaf_nodes=function(){return t.get_leaf_nodes(this)};t.Node.prototype.is_root=function(){return t.is_root(this)};t.Node.prototype.get_root=function(){return t.get_root(this)};t.Node.prototype.get_by_value=function(e){return t.get_by_value(e,this)};t.Node.prototype.get_by_id=function(e){return t.get_by_id(e,this)};t.Node.prototype.has_children=function(){return this.children&&this.children.length>0};t.Node.prototype.get_idx=function(){return t.get_idx(this)};var e=function(t){var e=new RegExp("^\\s*([0-9]*\\.?[0-9]+([eE][-+]?[0-9]+)?)");var i=new RegExp("^\\s*\\{(\\??[A-Za-z0-9_]*)\\:");var n=new RegExp("^\\s*(sin|cos|tan|log|ln|sqrt)");var r=new RegExp("^\\s*([a-zA-Z_₀₁₂₃₄₅₆₇₈₉])");var o=new RegExp("^\\s*([α-ωΑ-Ω])");var s=new RegExp('^\\s*"([^"]+)"');var a=new RegExp("^\\s*(>=|<=|\\*\\*|[-\\–+*/=><();,^\\{\\}\\[\\]\\|±⁰¹²³⁴⁵⁶⁷⁸⁹ⁿ:≥≤√])");var l=new RegExp("^\\s*(\\\\[^A-Za-z0-9\\s]|\\\\[A-Za-z]+)");var h=new RegExp("^(\\s+)");var p=[];var u=0;if(t){u=t.length}for(var c=0;c<u;){var d=t.substr(c);var f;if(f=e.exec(d)){p.push({type:"number",value:parseFloat(f[1]),from:c+(f[0].length-f[1].length),to:c+f[0].length});c+=f[0].length}else if(f=i.exec(d)){p.push({type:"operator",value:"{",from:c,to:c+1});p.push({type:"name",value:f[1],from:c+1,to:c+f[1].length+1});p.push({type:"operator",value:":",from:c+f[0].length-1,to:c+f[0].length});c+=f[0].length}else if(f=n.exec(d)){p.push({type:"name",value:f[1],from:c+(f[0].length-f[1].length),to:c+f[0].length});c+=f[0].length}else if(f=r.exec(d)){p.push({type:"name",value:f[1],from:c+(f[0].length-f[1].length),to:c+f[0].length});c+=f[0].length}else if(f=o.exec(d)){p.push({type:"name",value:f[1],from:c+(f[0].length-f[1].length),to:c+f[0].length});c+=f[0].length}else if(f=s.exec(d)){p.push({type:"name",value:f[1],from:c+(f[0].length-f[1].length),to:c+f[0].length});c+=f[0].length}else if(f=a.exec(d)){p.push({type:"operator",value:f[1],from:c+(f[0].length-f[1].length),to:c+f[0].length});c+=f[0].length}else if(f=l.exec(d)){p.push({type:"latex",value:f[1],from:c+(f[0].length-f[1].length),to:c+f[0].length});c+=f[0].length}else if(f=h.exec(d)){c+=f[0].length}else{debugger;throw"can't tokenize '"+d+"'"}}return p};gmath.tokenize=e;var r=function(e,i){t.Node.call(this);this.type="AlgebraModel";this.id=gmath.uid();this.events=d3.dispatch("create","change","mistake","start-of-interaction","end-of-interaction","node-changed","scrubbability-changed","restraint");this.options=gmath.object.merged(r.defaultOptions,i);this.hide_rules=[];this.watchedAspects=[];this.parser=this.options.parser||r.getDefaultParser();this.init_hide_rules();this.parseAndSet(e,true);this.setLocked(this.options.locked)};gmath.inherit(t.Node,r);gmath.AlgebraModel=r;r.getDefaultParser=function(){if(!r.defaultParser)r.defaultParser=o(["num","var","sym","brackets","sign","add-sub","mul-div","exponent","equals","inequality","param","func","abs-val","radical","degree","latex"]);return r.defaultParser};r.defaultOptions={hide_mult_op:true,hide_leading_op:true,parser:null,no_history:false,auto_simplify_distributions:true,auto_simplify_vector_additions:true,auto_simplify_variables:true,locked:false,action_blacklist:[]};r.prototype.clone=function(e,i){var n=new r(null,this.options);n.hide_rules=this.hide_rules.slice();t.append(n,t.clone(this.children[0],e,i||["id","value","name","bp","associative","commutative","vertical_notation","selected","dragging","locked","fixed","hidden","simplify","deleted","precision","color","size","width","height","x","y","x0","y0","rel_x","rel_y","lmar","rmar"]));return n};r.prototype.move_actions=[];if(typeof exports!=="undefined")exports.AlgebraModel=r;r.is_top_most=function(t){return!t.parent||t.parent instanceof r};r.prototype.init_hide_rules=function(){for(var t=0;t<this.parser.symbols.length;t++){var e=gmath.expressions[this.parser.symbols[t]];if(e.hide_rule)this.hide_rules.push(e.hide_rule)}};r.prototype.parseAndSet=function(e,i,n){var o=this.children[0];this.children=[];var s=this.parser.parse(e);if(!s)return false;t.append(this,s);if(!i)this.remove_brackets();this.hide_nodes();this.setLocked(this.options.locked);var a=null;try{if(o)a=o.get_mapping_to(this.children[0])}catch(t){console.log("could not auto-map",o.to_ascii(),"to",this.to_ascii())}finally{this.events.change(new r.ChangeEvent({model:this,node_map:a,no_anim:true,sender:n}));return true}};r.prototype.replace_with=function(t,e){var i,n;if(t instanceof r){i=t;i.setLocked(this.options.locked)}else{i=new r(t,this.options)}try{n=this.children[0].get_1to1_mapping_to(i.children[0],false)}catch(t){console.log("could not auto-map",this.to_ascii(),"to",i.to_ascii())}finally{this.events.change(new r.ChangeEvent({model:this,new_model:i,node_map:n,no_anim:true,sender:e}));return i}};r.prototype.parse=function(t,e){var i=this.parser.parse(t);if(!i)return null;if(!e)this.remove_brackets([i]);return i};r.prototype.to_ascii=function(t){return r.to_ascii(t||this.children)};r.to_ascii=function(t){if(!Array.isArray(t))t=[t];return t.map(function(t){return t.to_ascii()}).join("")};r.prototype.to_latex=function(t){t=t||this.children;if(!Array.isArray(t))t=[t];return t.map(function(t){return t.to_latex()}).join("")};r.select_range_by_value=function(t,e){return function(i){if(!i[0].parent)return false;if(i[0].parent.parent&&r.range_contains_all_siblings(i))return false;return r.rangeToAscii(i)===t||r.rangeToAsciiNoLeadingOp(i,e)===t||i.length===1&&r.fractionToAscii(i[0])===t}};r.rangeToAscii=function(t){if(t.length===1&&t[0].hidden)return"";return t.map(function(t){return t.to_ascii()}).join("")};r.isLeadingCommutativeOp=function(t){return t.is_group()&&t.commutative&&t.associative};r.rangeToAsciiNoLeadingOp=function(t,e){if(t.length===0)return"";if(t.length===1&&t[0].hidden)return"";var i=t.map(function(t){return t.to_ascii()}).join("");if(t.length===1&&!e)return i;if(r.isLeadingCommutativeOp(t[0]))return i.substring(t[0].children[0].to_ascii().length);return i};r.fractionToAscii=function(t){if(!t.is_group("fraction"))return"";var e=t.to_ascii();if(e.slice(0,1)==="("&&e.slice(e.length-1,e.length)===")")e=e.substr(1,e.length-2);return e};r.range_contains_all_siblings=function(t){return t[0]&&t[0].parent&&!t[0].parent.is_group("exponent")&&t.length===t[0].parent.children.length};r.select_node_by_value=function(t){return function(e){return!e.is_root()&&!e.hidden&&!e.fixed&&e.to_ascii()===t}};r.getRanges=function(e,i,n){var o=t.filterRange(r.select_range_by_value(e),n);return typeof i==="number"?o[i]:o};r.prototype.getRanges=function(t,e,i){return r.getRanges(t,e,i||this.children)};r.getNodes=function(e,i,n){var o=t.filter(r.select_node_by_value(e,true),n);return typeof i==="number"?o[i]:o};r.prototype.getNodes=function(t,e,i){return r.getNodes(t,e,i||this.children)};r.select_node_by_stringified_value=function(t){return function(e){return!e.is_root()&&!e.hidden&&e.stringify()===t}};r.getNodesStringified=function(e,i,n){var o=t.filter(r.select_node_by_stringified_value(e),n);return typeof i==="number"?o[i]:o};r.prototype.getNodesStringified=function(t,e,i){return r.getNodesStringified(t,e,i||this.children)};r.prototype.setLocked=function(t){this.options.locked=t;this.for_each(function(e){e.locked=t});this.events["scrubbability-changed"]({type:"scrubbability-changed"})};r.ChangeEvent=function(t){this.type="change";this.old_model_ascii=t.old_model_ascii;this.old_model_string=t.old_model_string;this.old_model=t.model;this.new_model=t.new_model||t.model;this.node_map=t.node_map||t.action&&t.action.node_map||[];this.action=t.action;this.sel=t.sel;this.no_anim=t.no_anim;this.sender=t.sender};r.prototype.created=function(t,e){this.events.create({type:"create",term:t&&t.newTree&&t.newTree.to_ascii(),action:t,sender_id:e||this.id})};r.prototype.startInteraction=function(){this.events["start-of-interaction"]({type:"start-of-interaction",source:this,model:this,time:Date.now()})};r.prototype.finishInteraction=function(t){if(!t){var e=this.children[0].filter(function(t){return t.simplify}),i=gmath.actions.PostInteractionSimplificationAction.createBoundAction(this,{nodes:e,auto_simplify_distributions:this.options.auto_simplify_distributions,auto_simplify_vector_additions:this.options.auto_simplify_vector_additions,auto_simplify_variables:this.options.auto_simplify_variables}),n=this;if(this.options.no_history?i.doInPlace():i.run()){n=i.newTree;i.newTree.hide_nodes();if(i.newTree===i.oldTree){this.events.change(new r.ChangeEvent({model:this,action:i}))}else{this.created(i)}}e.forEach(function(t){t.simplify=false});this.events["end-of-interaction"]({type:"end-of-interaction",source:n,time:Date.now()})}else{this.events["end-of-interaction"]({type:"end-of-interaction",source:this,time:Date.now()})}};r.prototype.root=function(){return this.children[0]};r.prototype.is_group=function(){return false};r.prototype.get_parent_of_product_with_leading_num=function(t){var e=t.parent;if(t instanceof a&&e.is_group("mul")&&!e.ls&&e.parent.is_group("product"))return e.parent.parent;else return false};r.prototype.numeric_value=function(e,i,n){var o=this.to_ascii(),s=this.stringify(),l=this.getSelectorOfNodes(e);var h=e;var p=e.parent,u;if(e instanceof a&&p&&(p.is_group("sign")||p.is_group("add")||p.is_group("sub")))e=p;u=a.get_value(e);if(isNaN(u))return NaN;var c=this.get_parent_of_product_with_leading_num(e);var d=c&&c.is_group("add")?c:null;var g=c&&c.is_group("sub")?c:null;if(g)u=-u;if(arguments.length<2)return u;var m=u>0||u===0&&(e instanceof a||e.is_group("add"));var v=i>0||i===0&&(e instanceof a||e.is_group("add"));if(m&&!v){if(e.is_group("add")){e.invert();this.hide_nodes()}else if(d){d.invert();this.hide_nodes()}else{var _=t.remove(e);var y=new f(e);y.children[0].no_anim=true;t.insert(p,_,y);y.selected=e.selected;e=y}}else if(!m&&v){if(e.is_group("sign")){var b=e.children[1];t.replace(e,b);e.children[0].no_anim=true;b.selected=e.selected;e=b}else if(e.is_group("sub")){e.invert();this.hide_nodes()}else if(g){g.invert();this.hide_nodes()}}else if(this.f_eqls(u,i))return e;if(e.is_group())e.children[1].value=Math.abs(i);else e.value=Math.abs(i);var w=this.children[0].get_mapping_to(this.children[0]);w[h.id]=[e];this.events.change(new r.ChangeEvent({model:this,node_map:w,no_anim:true,old_model_ascii:o,old_model_string:s,sel:l,sender:n}));return e};r.prototype.f_eqls=function(t,e){return Math.abs(t-e)<1e-6};r.prototype.remove_brackets=function(e){t.for_each(function(t){if(t.is_group("fraction")&&t.parent.is_group("brackets"))c.handle(t.parent,true)},e||this.children)};r.prototype.process_operator=function(t,e,i){if(t.fixed){if(e)e(false);return false}while(!t.getBestMatchingAction&&t.parent)t=t.parent;if(t.getBestMatchingAction&&!t.getBestMatchingAction(i,this.options.action_blacklist)&&t.parent)t=t.parent;if(c.areHidden(t))t=t.parent;if(!t.getBestMatchingAction){if(e)e(null);return null}var n=t.getBestMatchingAction(i);var r=n?n.createBoundAction(this,{actor:t},i):null;this.performAction(r,e);return r};r.prototype.performAction=function(t,e,i,n){var o=[t];if(t&&t.settings&&t.settings.makes_no_changes){t.doInPlace();return t}if(typeof i==="undefined")i=this.options.no_history;var s=this;var a=function(t){if(!t){s.events.mistake(s);if(e)e(t);return}if(i){s.hide_nodes();s.events.change(new r.ChangeEvent({model:s,action:t}))}else{t.newTree.hide_nodes();s.created(t)}if(!n&&t.settings.restraint){s.events.restraint(t.settings.restraint)}if(t.followup){var a=t.newTree.performAction(t.followup,e,i);o=o.concat(a)}else if(e){e(t.newTree)}};if(!t){a();return null}if(i)t.doInPlace(a);else t.run(a);if(o.length===1)return o[0];else return Action.createComposedAction(o,o[0].name,o[0].description)};r.prototype.hide_nodes=function(){return this.hideNodesAction.doInPlace(this)};r.prototype.performSplitAction=function(t){var e=new it;e.split(this,t||this.children)};r.prototype.getMoveActions=function(t){if(t.length===0)return[];if(t.some(function(t){return t.fixed}))return[];var e=[];for(var i=0;i<this.move_actions.length;i++){var n=this.move_actions[i];if(n.name&&this.options.action_blacklist.indexOf(n.name)!==-1)continue;e=e.concat(this.move_actions[i].getAllAvailableActions(t))}return e};r.groupNodeRanges=function(t){return r.groupNodes(t,function(t,e){return t[t.length-1].rs===e})};r.groupNodes=function(t,e){if(!t.length)return[];var i=[];var n=[t[0]];i.push(n);for(var r=1;r<t.length;r++){if(e(n,t[r])){n.push(t[r])}else{n=[t[r]];i.push(n)}}return i};r.__reg_exp_cache={};r.match=function(t,e){var i=r.__reg_exp_cache;for(var n=0;n<e.length;n++){var o=e[n];if(!i[o])i[o]=new AlgebraRegExp(o);var s=i[o].match(t);if(s)return s}return false};t.Node.prototype.match=function(){return r.match(this,arguments)};r.prototype.make_flat=function(){var e=t.get_leaf_nodes(this);var i=new p("flat",0);i.commutative=true;e.forEach(function(e){if(e.hidden)return;e.commutative=true;e.associative=true;t.append(i,e)});this.children=[];t.append(this,i);this.events.change(new r.ChangeEvent({model:this}))};r.prototype.getSelectorOfNodes=function(t){if(!Array.isArray(t))t=[t];var e=[];for(var i=0;i<t.length;i++){var n=t[i];if(n===this)e.push(this.to_ascii());else{var r=this.getNodes(n.to_ascii());var o=r.indexOf(n);if(o===-1)e.push("");else if(o===0)e.push(n.to_ascii());else e.push(n.to_ascii()+":"+o)}}return e};r.prototype.getNodesFromSelector=function(t){var e=t.split(";");return e.map(function(t){var e=t.split(":");return this.getNodes(e[0],+e[1]||0)}.bind(this))};r.evalExpression=function(e,i){var n=function(t,e){return t+e},o=function(t,e){return t*e},i=i||{};if(e&&e instanceof r)e=e.children[0];var s=function(t){if(!t)return NaN;if(a.is_num(t))return a.get_value(t);if(t.is_group("mul","add","brackets"))return s(t.children[1]);if(t.is_group("sign","sub"))return-s(t.children[1]);if(t.is_group("div"))return 1/s(t.children[1]);if(t.is_group("exponent"))return s(t.children[0]);if(t.value==="//")return 1;if(t.is_group("product","fraction"))return t.children.map(s).reduce(o,1);if(t.is_group("sum"))return t.children.map(s).reduce(n,0);if(t.is_group("power"))return Math.pow(s(t.children[0]),s(t.children[1]));if(M.Trig.is_trig_func(t))return M.Trig.evaluate(t);if(t.is_group("var")&&t.get_value()in i)return i[t.get_value()];return NaN};if(Array.isArray(e)){if(!t.is_range(e))return NaN;if(e[0].get_parent(1).is_group("product","fraction"))return e.map(s).reduce(o,1);if(e[0].get_parent(1).is_group("sum"))return e.map(s).reduce(n,0);return NaN}else{return s(e)}};AlgebraRegExp=function(){this.simple_models=[];for(var t=0;t<arguments.length;t++){var e=new gmath.AlgebraModel(arguments[t],{parser:AlgebraRegExp.getRegExpParser()});this.simple_models=this.simple_models.concat(this.getVariations(e))}};gmath.AlgebraRegExp=AlgebraRegExp;AlgebraRegExp.getRegExpParser=function(){if(!AlgebraRegExp.regexpParser){var t=gmath.AlgebraParser(["num","var","sym","brackets","sign","add-sub","mul-div","exponent","equals","param","func"]);t.registerSymbol(":",1).led=function(e){var i=t.parseExpression(0);var n=e.value[0]==="?";i.match_name=n?e.value.slice(1):e.value;i.match_optional=n;return i};["NUM","VAR","ANY"].forEach(function(e){t.registerSymbol("\\"+e).nud=function(){return new gmath.expressions.placeholder(e.toLowerCase())}});AlgebraRegExp.regexpParser=t}return AlgebraRegExp.regexpParser};AlgebraRegExp.prototype.getVariations=function(t,e){e=e||0;var i=t.select_first(function(t){return t.match_optional});if(!i)return[t];i.match_optional=false;var n=t.clone(false,["id","value","name","bp","associative","commutative","vertical_notation","match_name","match_optional"]);var r=this.getVariations(n,e+1);var o=new Action;o.newTree=t;if(i.parent.commutative)i=i.parent;if(i.commutative){i.remove();o.cleanup_cascade(i.parent);r=r.concat(this.getVariations(t,e+1))}else if(e===0)throw"only nodes in commutative groups can be optional";return r};AlgebraRegExp.prototype.combineWith=function(t){this.simple_models=this.simple_models.concat(t.simple_models)};AlgebraRegExp.prototype.match_node=function(t,e){if(t.is_group("sym")&&e.is_group("sym")&&e.value==="±"&&(t.value==="-"||t.value==="+"))return true;if(t.is_group("add","sub")&&e.is_group("addsub"))return true;if(t.is_group("sign")&&e.is_group("plusminus"))return true;return t.name===e.name&&t.value===e.value&&t.children.length===e.children.length};AlgebraRegExp.checkAndSetMatch=function(t,e,i){if(!e)return true;if(t[e]&&t[e].to_ascii()!==i.to_ascii())return false;t[e]=i;return true};AlgebraRegExp.prototype.match_tree=function(t,e,i){if(e.is_group("plusminus")&&!t.is_group("sign","plusminus")){if(!AlgebraRegExp.checkAndSetMatch(i,e.match_name,t))return false;e=e.children[1]}if(e.is_group("brackets")&&e.children[1].is_group("plusminus")&&!t.is_group("brackets")){if(!AlgebraRegExp.checkAndSetMatch(i,e.match_name,t))return false;e=e.children[1].children[1]}if(e.is_group("placeholder")){var n=e.match(t);if(!n)return false;if(!AlgebraRegExp.checkAndSetMatch(i,e.match_name,t))return false;return true}else{if(!AlgebraRegExp.checkAndSetMatch(i,e.match_name,t))return false;if(!this.match_node(t,e))return false;for(var r=0;r<t.children.length;r++){var n=this.match_tree(t.children[r],e.children[r],i);if(!n)return false}return true}};AlgebraRegExp.prototype.match=function(t){var e={};var i=t.type==="AlgebraModel"?t.children[0]:t;for(var n=0;n<this.simple_models.length;n++){var r=this.match_tree(i,this.simple_models[n].children[0],e);if(r)return e}return false};var o=function(t){var i={};var n;var r;var o;
var s;var a=function(){return this};var l=function(t,e){e=e||this;e.name="SyntaxError";e.message=t;throw e};var h=function(){this.def={}};h.prototype.find_or_define=function(t){var e=this.def[t.value];if(!e||typeof e=="function")e=i[t.value];if(e&&typeof e!=="function")return e;e=Object.create(i["(name)"]);e.lpb=0;this.def[t.value]=e;return e};var p=function(t,e){var a,h,p,u;if(t&&n.id!==t){if(e)return;else l("Expected '"+t+"'.",n)}if(o>=r.length){n=i["(end)"];return}p=r[o];o+=1;u=p.value;a=p.type;if(a==="name"){h=s.find_or_define(p)}else if(a==="operator"){h=i[u];if(!h){l("Unknown operator.",p)}}else if(a==="latex"){h=i[u];if(!h){l("Unknown latex command.",p)}}else if(a==="string"||a==="number"){h=i["(number)"];a="number"}else{l("Unexpected token.",p)}n=Object.create(h);n.from=p.from;n.to=p.to;n.value=u;n.type=a;return n};var u=function(t){o--;n=t};var c=function(t,e){var i;var r=e||n;if(!e)p();i=r.nud();while(t<n.lbp){r=n;p();i=r.led(i)}return i};var d={nud:function(){l("Undefined.",this)},led:function(t){l("Missing operator.",this)}};var f=function(t,e){var n=i[t];e=e||0;if(n){if(e>n.lbp){n.lbp=e}}else{n=Object.create(d);n.id=n.value=t;n.lbp=e;i[t]=n}return n};f("(end)");var g=function(t){r=e(t);if(r.length==0)return null;s=new h;o=0;p();var i=c(0);p("(end)");return i};var m={};m.parse=g;m.parseExpression=c;m.advance=p;m.regress=u;m.registerSymbol=f;m.symbols=t;for(var v=0;v<t.length;v++){var _=gmath.expressions[t[v]];if(_&&_.registerAtParser)_.registerAtParser(m)}return m};gmath.AlgebraParser=o;gmath.LinkCoordinator=function(){var t=function(){this.id=gmath.uid();this.links=[];this.groups=[];this.node_to_group={};this.unlinked_nodes=[];this.events=d3.dispatch("link_added","link_removed");this.auto_update_scrubbability=true};gmath.LinkCoordinatorClass=t;t.prototype.addLinks=function(t,e){var i=this;t.forEach(function(t){i.addLink(t,e)})};t.prototype.addLink=function(t,e){this.links.push(t);this.registerLink(t,e);this.events.link_added({link:t})};t.prototype.registerLink=function(t,e){var i=this.getGroup(t.source);var n=this.getGroup(t.target);if(t.bidirectional){if(i!==n){var r=this.mergeGroups(i,n);if(this.auto_update_scrubbability&&!e)this.setLocked(r)}}else{if(i===n)throw"unidirectional linking between bidirectionally linked nodes!";n.deps++;if(this.auto_update_scrubbability&&!e)this.setLocked(n)}};t.prototype.getGroup=function(t){var e=this.node_to_group[t.id];if(!e){e={deps:0,nodes:[t]};this.groups.push(e);this.node_to_group[t.id]=e}return e};t.prototype.replaceNode=function(t,e){if(!this.node_to_group[t.id])return;var i=this.node_to_group[t.id];delete this.node_to_group[t.id];this.node_to_group[e.id]=i;var n=i.nodes.indexOf(t);i.nodes[n]=e};t.prototype.unlinkCanvasModel=function(t,e){var i=this;t.dls().forEach(function(t){i.unlinkDL(t,true)});t.graphs().forEach(function(t){i.unlinkGraph(t,true)});if(this.auto_update_scrubbability&&!e)this.updateAll()};t.prototype.unlinkDL=function(t,e){return this.unlinkContainer(t.rows,"model",e)};t.prototype.unlinkGraph=function(t,e){return this.unlinkContainer(t.geoms,null,e)};t.prototype.unlinkContainer=function(t,e,i){var n=this;var r=[];t.forEach(function(t){r=r.concat(n.unlinkElement(e?t[e]:t,true))});if(this.auto_update_scrubbability&&!i)this.updateAll();return r};t.prototype.unlinkElement=function(t,e){var i=[],n=this;this.links=this.links.filter(function(e){if(e.source===t||e.target===t){var r=e.source===t?e.target:e.source;if(n.unlinked_nodes.indexOf(r)===-1)n.unlinked_nodes.push(r);i.push(e);return false}return true});if(this.unlinked_nodes.indexOf(t)===-1)this.unlinked_nodes.push(t);if(this.auto_update_scrubbability&&!e)this.updateAll();return i};t.prototype.updateAll=function(){this.groups=[];this.node_to_group={};for(var t=0;t<this.unlinked_nodes.length;t++)this.getGroup(this.unlinked_nodes[t]);this.unlinked_nodes=[];for(var t=0;t<this.links.length;t++)this.registerLink(this.links[t],true);for(var t=0;t<this.groups.length;t++)this.setLocked(this.groups[t])};t.prototype.setLocked=function(t){t.nodes.forEach(function(e){e.setLocked(t.deps>0)})};t.prototype.mergeGroups=function(t,e){var i=this;var n=this.groups.indexOf(e);this.groups.splice(n,1);e.nodes.forEach(function(e){i.node_to_group[e.id]=t});t.nodes=t.nodes.concat(e.nodes);t.deps+=e.deps;return t};return new t}();AlgebraModelLink=function(t,e,i,n){this.id=n||gmath.uid();this.source=t;this.target=e;this.action=i;this.action.broken=false;this.model_before_broken=null;this.source.events.on("change."+this.id,this.onChange.bind(this));this.target.events.on("change."+this.id,this.onTargetChange.bind(this))};AlgebraModelLink.prototype.onChange=function(t){if(t.old_model!==this.source)throw"wrong old_model";if(t.new_model!==t.old_model){this.source.events.on("change."+this.id,null);this.source=t.new_model;gmath.LinkCoordinator.replaceNode(t.old_model,t.new_model);this.source.events.on("change."+this.id,this.onChange.bind(this))}var e=this.action.nodes;var i=this.action.target;var n=this.action.actor;if(!this.action.broken){this.action.rebind(t.new_model,t.node_map,t.old_model)}else{try{var r=this.model_before_broken.children[0].get_1to1_mapping_to(t.new_model.children[0],false);this.action.rebind(t.new_model,r,t.old_model)}catch(e){console.log("scrubbing broke, can't reapply",this.action.name,"to",t.new_model.to_ascii());return}}if(this.action.rematch()){this.action.broken=false;this.model_before_broken=null;this.action.run();this.action.newTree.hide_nodes();this.action.newTree.for_each(function(t){t.selected=false});this.target.replace_with(this.action.newTree)}else{this.action.nodes=e;this.action.target=i;this.action.actor=n;if(!this.action.broken){this.action.broken=true;this.model_before_broken=t.old_model}console.log("scrubbing broke, can't reapply",this.action.name,"to",this.source.to_ascii())}};AlgebraModelLink.prototype.onTargetChange=function(t){if(t.old_model!==this.target)throw"wrong old_model";if(t.new_model!==t.old_model){this.target.events.on("change."+this.id,null);this.target=t.new_model;gmath.LinkCoordinator.replaceNode(t.old_model,t.new_model);this.target.events.on("change."+this.id,this.onTargetChange.bind(this))}};var s=function(t){this.prototype.name=t;this.prototype.bp=100;gmath.expressions[t]=this;this.prototype.get_subscript_helper=function(t){if(!this.has_subscript())return"";var e=this.get_subscript()[t]();if(e.length>1)return"_{"+e+"}";else return"_"+e};this.prototype.to_string=function(){return""+this.get_base().value+this.get_subscript_helper("to_string")};this.prototype.to_ascii=function(){return""+this.get_base().value+this.get_subscript_helper("to_ascii")};this.prototype.to_latex=function(){return""+this.get_base().value+this.get_subscript_helper("to_latex")};this.prototype.is_leaf_node=true;this.prototype.is_group=function(){for(var t=0;t<arguments.length;t++){if(arguments[t]===this.name)return true}return false};this.prototype.get_value=function(t){if(t)return this.value;else return this.get_base().value};this.prototype.set_value=function(t){if(!this.has_subscript())this.value=t;else{this.get_base().value=t;this.value=this.to_ascii()}};this.prototype.get_base=function(){if(this.has_children())return this.children[0];return this};this.prototype.set_subscript=function(t,e){if(this.parent&&this.get_idx()===0&&this.parent.has_subscript())throw"Do not set a subscript on the base of a node with a subscript.";if(this.children[1])this.children[1].remove();this.append(new gmath.expressions[this.name](this.value));this.append(t);this.value=this.to_ascii();if(e)this.fix_subscript(e)};this.prototype.has_subscript=function(){return this.has_children()};this.prototype.get_subscript=function(){if(this.has_children())return this.children[1];return null};this.prototype.fix_subscript=function(t){this.children[0].fixed=t;this.children[1].for_each(function(e){e.fixed=t})}};if(typeof module==="object"&&module.exports){module.exports=s}var a=function(e){t.Node.call(this);this.view_precision=3;this.max_precision=12;if(typeof e!=="number")e=0;if(e>=0)this.value=e;else return new f(new a(-e))};gmath.inherit(t.Node,a);s.call(a,"num");a.is_num=function(t){return t.is_group("num")||t.is_group("sign","add","sub")&&(t.children[1]&&t.children[1].is_group("num"))};a.get_value=function(t){if(!t)return NaN;if(t instanceof a)return t.get_base().value;if(t.is_group("sign")&&t.children[1]instanceof a)return-t.children[1].get_base().value;if(t.is_group("add")&&t.children[1]instanceof a)return t.children[1].get_base().value;if(t.is_group("sub")&&t.children[1]instanceof a)return-t.children[1].get_base().value;return NaN};a.is_equal_to=function(t,e){var i=a.get_value(t);return!isNaN(i)&&i===e};a.is_inequal_to=function(t,e,i){var n=a.get_value(t);if(isNaN(n))return false;if(e==="<"||e==="lt")return n<i;if(e===">"||e==="gt")return n>i;if(e==="<="||e==="lte")return n<=i;if(e===">="||e==="gte")return n>=i;throw"(Num:is_inequal_to) Comparator not accepted."};a.prototype.get_signed_value=function(){var t=this.parent,e;if(!t)return this.get_base().value;var i=this.get_base().value;if(t&&t.is_group("sign","sub"))return-i;if(a.is_leading_num_in_sub_product(this))return-i;return i};a.is_leading_num_in_sub_product=function(t){var e=t.parent;if(t instanceof a&&e.is_group("mul")&&!e.ls&&e.parent.is_group("product")&&e.parent.parent.is_group("sub"))return e.parent.parent;else return false};a.apply_precision=function(t,e){var i=Math.pow(10,e);return Math.round(t*i)/i};a.prototype.decimal_count=function(){var t=this.get_base().to_ascii(),e=t.indexOf(".");if(e===-1)return 0;return t.length-e-1};a.prototype.to_string=function(){if(this.value===Infinity)return"∞";var t=this.value;if(this.scrubbingThisNum)return t.toFixed(2);return a.apply_precision(t,this.view_precision)};a.prototype.to_ascii=function(){return""+a.apply_precision(this.get_base().value,this.max_precision)+this.get_subscript_helper("to_ascii")};a.prototype.to_latex=function(){return""+a.apply_precision(this.get_base().value,this.max_precision)+this.get_subscript_helper("to_latex")};a.registerAtParser=function(t){var e=t.registerSymbol("(number)",30);e.nud=function(){return new a(this.value)};e.led=function(e){var i=t.parseExpression(_.prototype.bp,this);return _.createProduct(e,i)}};var l=function(e){t.Node.call(this,"sym");this.value=e};gmath.inherit(t.Node,l);s.call(l,"sym");l.mappings={"-":"−","*":"·","/":"·","//":""};l.prototype.to_string=function(){return""+this.to_string_value_modifier(this.get_base().value)+this.get_subscript_helper("to_string")};l.prototype.to_latex=function(){return""+this.to_latex_value_modifier(this.get_base().value)+this.get_subscript_helper("to_latex")};l.prototype.to_string_value_modifier=function(t){if(t==="-"&&this.parent&&this.parent.is_group("sign"))return"-";if(t in l.mappings)return l.mappings[t];return t};l.prototype.to_latex_value_modifier=function(t){if(t==="/")return"\\cdot ";if(t==="*")return"\\cdot ";if(t==="(")return"\\left(";if(t===")")return"\\right)";if(t==="[")return"\\left[";if(t==="]")return"\\right]";return t};var h=function(e){t.Node.call(this);this.value=e};gmath.inherit(t.Node,h);s.call(h,"var");h.prototype.to_ascii=function(){return""+this.to_ascii_value_modifier(this.get_base().value)+this.get_subscript_helper("to_ascii")};h.prototype.to_ascii_value_modifier=function(t){if(t.length>1)return'"'+t+'"';return t};h.constant_values=["i"];h.constant_value=function(t){return Boolean(~gmath.findIndex(h.constant_values,function(e){return e===t}))};h.is_constant=function(t){return Boolean(t instanceof h&&h.constant_value(t.value)||t.is_group("sign")&&h.constant_value(t.children[1].value))};h.is_var=function(t){return t instanceof h||t.is_group("power")&&t.children[0]instanceof h};h.latex_to_unicode={"(name)":"","\\alpha":"α","\\Alpha":"Α","\\beta":"β","\\Beta":"Β","\\gamma":"γ","\\Gamma":"Γ","\\delta":"δ","\\Delta":"Δ","\\epsilon":"ε","\\Epsilon":"Ε","\\zeta":"ζ","\\Zeta":"Ζ","\\eta":"η","\\Eta":"Η","\\theta":"θ","\\Theta":"Θ","\\iota":"ι","\\Iota":"Ι","\\kappa":"κ","\\Kappa":"Κ","\\lambda":"λ","\\Lambda":"Λ","\\mu":"μ","\\Mu":"Μ","\\nu":"ν","\\Nu":"Ν","\\xi":"ξ","\\Xi":"Ξ","\\omicron":"ο","\\Omicron":"Ο","\\pi":"π","\\Pi":"Π","\\rho":"ρ","\\Rho":"Ρ","\\sigma":"σ","\\Sigma":"Σ","\\tau":"τ","\\Tau":"Τ","\\upsilon":"υ","\\Upsilon":"Υ","\\phi":"φ","\\Phi":"Φ","\\chi":"χ","\\Chi":"Χ","\\psi":"ψ","\\Psi":"Ψ","\\omega":"ω","\\Omega":"Ω"};h.utf8_subscripts=[{char:"₀",val:0},{char:"₁",val:1},{char:"₂",val:2},{char:"₃",val:3},{char:"₄",val:4},{char:"₅",val:5},{char:"₆",val:6},{char:"₇",val:7},{char:"₈",val:8},{char:"₉",val:9}];h.registerAtParser=function(t){var e=t.registerSymbol("_",100);e.led=function(e){var i=t.parseExpression(99);if(e.is_leaf_node){e.set_subscript(i,true)}else{var n=e.children[e.children.length-1];if(n.is_leaf_node)n.set_subscript(i,true);else return false}return e};h.utf8_subscripts.forEach(function(e){t.registerSymbol(e.char,100).led=function(t){if(!t.is_leaf_node)return false;t.set_subscript(new a(e.val));return t}});var i=function(){if(this.type==="name")return new h(this.value);else return new h(h.latex_to_unicode[this.value])};var n=function(e){var i=t.parseExpression(_.prototype.bp,this);return _.createProduct(e,i)};for(var r in h.latex_to_unicode){var o=t.registerSymbol(r,30);o.nud=i;o.led=n}};var p=function(e,i){t.Node.call(this);if(arguments.length>1)this.bp=i;if(arguments.length>0)this.value=e};gmath.inherit(t.Node,p);p.prototype.to_ascii=function(){return this.children.map(function(t){if(t.is_group()&&t.commutative&&!t.ls&&t.associative)return t.children[1].to_ascii();return t.to_ascii()}).join("")};p.prototype.to_latex=function(){return this.children.map(function(t){if(t.is_group()&&t.commutative&&!t.ls&&t.associative)return t.children[1].to_latex();return t.to_latex()}).join("")};p.prototype.is_group=function(t){if(arguments.length===0)return true;for(var e=0;e<arguments.length;e++){if(this.value===arguments[e])return true}return false};p.prototype.get_last_child=function(){return this.children[this.children.length-1]};p.prototype.is_leaf_node=false;p.prototype.has_subscript=function(){return false};if(typeof module==="object"&&module.exports){module.exports=p}var u=function(e,i){gmath.inherit(p,this);this.prototype.bp=i.bp||0;this.prototype.associative=i.associative||false;this.prototype.commutative=i.commutative||false;this.prototype.has_inverse=i.has_inverse||false;this.prototype.inverse_group_name=i.inverse_group_name;this.prototype.group_name=i.group_name||i.group_class&&i.group_class.prototype.name;this.prototype.group_class=i.group_class;this.prototype.value=e;this.prototype.name=e;this.prototype.action_handlers=[];this.prototype.vertical_notation=i.vertical_notation||false;this.prototype.add_action_handler=function(t){if(this.action_handlers.indexOf(t)==-1)this.action_handlers.push(t)};this.prototype.getBestMatchingAction=function(t,e){if(!e)e=[];var i=null;for(var n=0;n<this.action_handlers.length;n++){var r=this.action_handlers[n];if(r.name&&e.indexOf(r.name)!==-1)continue;if(!r.match(this))continue;if((i===null||r.priority>i.priority)&&(!t||t.type==="tap"&&!r.triggerType||r.triggerType===t.type)){i=r}}return i};this.prototype.createGroup=function(){return new this.group_class};this.createGroup=this.prototype.createGroup;this.prototype.getInverse=function(){return this.inverse&&gmath.expressions[this.inverse]};this.prototype.clean_up_commutative=function(){if(!this.ls&&!this.rs){var e=this.children[1];t.replace(this.parent,e);c.handle(e);return true}if(this.merge_nested_group())return true};this.prototype.merge_nested_group=function(){if(this.associative&&this.children[1].is_group(this.group_name)){var e=this.parent;var i=this.children[1];if(t.get_child([1,0,0],this).value===t.get_child([0],this).value){t.replace(t.get_child([1,0,0],this),t.get_child([0],this))}var n=t.remove(this);for(var r=0;r<i.children.length;r++){t.insert(e,n+r,i.children[r])}return true}};gmath.expressions[e]=this};if(typeof module==="object"&&module.exports){module.exports=u}var c=function(e,i,n){p.call(this);if(e){t.append(this,new l(i||"("));t.append(this,e);t.append(this,new l(n||")"))}};u.call(c,"brackets",{bp:0});var d=function(e){p.call(this);if(e){t.append(this,new l("|"));t.append(this,e);t.append(this,new l("|"))}};u.call(d,"abs-val",{bp:0});c.registerAtParser=function(t){var e=t.registerSymbol("|");e.nud=function(){var e=t.parseExpression(0);t.advance("\\right",true);t.advance("|");return new d(e)};e.led=function(e){var i=t.parseExpression(_.prototype.bp,this);return _.createProduct(e,i);return e};var i=t.registerSymbol("[",30);i.nud=function(){var e=t.parseExpression(0);t.advance("\\right",true);t.advance("]");return new c(e,"[","]")};i.led=function(e){var i=t.parseExpression(_.prototype.bp,this);return _.createProduct(e,i)};t.registerSymbol("]");var n=t.registerSymbol("(",30);n.nud=function(){var e=t.parseExpression(0);t.advance("\\right",true);t.advance(")");return new c(e)};n.led=function(e){var i=t.parseExpression(_.prototype.bp,this);return _.createProduct(e,i)};t.registerSymbol(")");var r=t.registerSymbol("\\left",30);r.nud=function(){if(t.advance("[",true))return i.nud();else if(t.advance("(",true))return n.nud();else if(t.advance("|",true))return e.nud()};r.led=function(r){if(t.advance("[",true))return i.led(r);else if(t.advance("(",true))return n.led(r);else if(t.advance("|",true))return e.led(r)};t.registerSymbol("\\right");var o=t.registerSymbol("{",30);o.nud=function(){var e=t.parseExpression(0);t.advance("}");return e};o.led=n.led;t.registerSymbol("}")};c.areHidden=function(t){return t&&t.is_group("brackets")&&t.children[0].hidden};c.handle=function(e,i){if(e.is_group("brackets")){if(i&&c.is_optional(e)){t.replace(e,e.children[1]);return"removed"}return false}if(!c.is_optional(e)){var n=t.remove(e);t.insert(e.parent,n,new c(e));return"added"}return false};c.is_optional=function(t,e){if(t.is_group("brackets")&&t.children[1].is_group("brackets"))return true;var i=t instanceof c?t.children[1]:t;var e=e||t.parent;if(i.is_group("tuple")&&!e.is_group("func"))return false;if(e.is_group("tuple"))return true;if(i.is_group("abs-val"))return true;if(!i.has_children())return true;if(e instanceof r)return true;if(e.is_group("radical")&&e.get_radicand()===t)return true;if(e.has_subscript()&&e.get_subscript()===t)return true;if(e.is_group("sign")&&i.is_group("fraction"))return true;if(e.is_group("func")&&i.is_group("tuple"))return e.arg_length()===1&&e.get_arg().is_leaf_node;if(e.bp>i.bp)return false;if(i.is_group("sign"))return true;if(e.bp<i.bp)return true;if(e instanceof f&&i instanceof f)return true;if(e.associative&&i.is_group(e.group_name))return true;if(i.commutative&&e.is_group(i.group_name))return true;if(i.is_group("mul","div")&&e.is_group("fraction"))return true;if(i.is_group("product")&&e.is_group("div")&&e.parent&&e.parent.is_group("fraction"))return true;if(i.is_group("fraction")&&e.is_group("mul","div"))return true;return false};var f=function(e,i){p.call(this);if(e){t.append(this,new l(i?"±":"-"));t.append(this,e);c.handle(e)}if(i)this.value="plusminus"};u.call(f,"sign",{bp:40,associative:true,commutative:false,inverse:"sign"});f.registerAtParser=function(t){t.registerSymbol("+").nud=function(){return t.parseExpression(f.prototype.bp)};var e=t.registerSymbol("-");e.nud=function(){var e=t.parseExpression(f.prototype.bp);return new f(e)};var i=["±","\\pm"];function n(){var e=t.parseExpression(f.prototype.bp);return new f(e,true)}i.forEach(function(e){t.registerSymbol(e,f.prototype.bp).nud=n});t.registerSymbol("–").nud=e.nud};f.prototype.deconstruct=function(){var t=[];t.push(this);return t};var g=function(){p.call(this)};u.call(g,"sum",{bp:20});var m=function(e,i){p.call(this);if(e){if(i==="add")this.value="add";else if(i==="sub")this.value="sub";else if(i==="addsub")this.value="addsub";else{if(e.is_group("sign","plusminus")){this.value=e.is_group("sign")?"sub":"addsub";this.match_name=e.match_name;this.match_optional=e.match_optional;e=e.children[1]}else this.value="add"}this.value=this.value;t.append(this,new l(m.value2sym[this.value]));t.append(this,e);c.handle(e)}this.associative=this.value=="add"};m.value2sym={add:"+",sub:"-",addsub:"±"};u.call(m,"add-sub",{group_class:g,group_name:"sum",bp:20,associative:true,commutative:true,has_inverse:true});m.prototype.invert=function(){if(this.value=="add"){this.value="sub";if(this.children[0])this.children[0].value="-";this.associative=false}else{this.value="add";if(this.children[0])this.children[0].value="+";this.associative=true}};m.prototype.symIsHidden=function(){return this.get_child([0]).hidden};m.prototype.map_group_and_sym=function(t,e,i){var n=i?"updateNodeMap":"extendNodeMap";t[n](this,e);t[n](this.children[0],e.children[0])};m.registerAtParser=function(t){var e=t.registerSymbol("+",m.prototype.bp);e.led=function(e){var i=t.parseExpression(m.prototype.bp);if(e.is_group("sum")){e.append(new m(i,"add"));return e}else{var n=m.prototype.createGroup();n.append(new m(e));n.append(new m(i,"add"));return n}};var i=t.registerSymbol("-",m.prototype.bp);var n=t.registerSymbol("–",m.prototype.bp);i.led=function(e){var i=t.parseExpression(m.prototype.bp);if(e.is_group("sum")){e.append(new m(i,"sub"));return e}else{var n=m.prototype.createGroup();n.append(new m(e));n.append(new m(i,"sub"));return n}};n.led=i.led;var r=["±","\\pm"];function o(e){var i=t.parseExpression(m.prototype.bp);if(e.is_group("sum")){e.append(new m(i,"addsub"));return e}else{var n=m.prototype.createGroup();n.append(new m(e));n.append(new m(i,"addsub"));return n}}r.forEach(function(e){t.registerSymbol(e,m.prototype.bp).led=o})};gmath.expressions.addsub=m;var v=function(){p.call(this)};u.call(v,"product",{bp:30,vertical_notation:false});v.prototype.invert=function(){var e=this.children.length;if(this.value=="product"){this.value="fraction";this.vertical_notation=true;var i=this.children[e-1],n=e-1;while(i&&i.value=="div"){i=i.ls;n--}if(!i||i.value!=="//")t.insert(this,n+1,new l("//"))}else{this.value="product";this.vertical_notation=false;if(e>0){var r=this.children[0];while(r){if(r.value=="//")t.remove(r);r=r.rs}}}};v.prototype.append=function(e){if(this.value=="product"&&e.value=="div"){this.invert();t.append(this,e)}else if(this.value=="fraction"&&e.value=="mul"){var i=0;while(i<this.children.length&&this.children[i].value!=="//")i++;t.insert(this,i,e)}else{t.append(this,e)}return this};v.prototype.insert=function(e,i,n){if(this.value=="product"&&i.value=="div"){this.invert();t.append(this,i)}else if(this.value=="fraction"&&i.value=="mul"){var r=this.get_top().length;if(e>r)e=r;t.insert(this,e,i)}else if(this.value=="fraction"&&i.value=="div"&&n){e+=this.get_top().length+1;var o=this.children.length;if(e>o)e=o;t.insert(this,e,i)}else{t.insert(this,e,i)}};v.prototype.append_range=function(t){t.forEach(function(t){this.append(t)},this)};v.prototype.insert_range=function(t,e,i){if(this.value=="product"&&e[0].value=="div")this.append_range(e);else e.forEach(function(e){this.insert(t++,e,i)},this)};v.prototype.insert_into_demominator=function(e,i){if(!i.is_group("div"))throw'wrong type of term, expected "div", not "'+i.name+'"';if(this.value=="product"){this.invert();t.append(this,i)}else{var n=0;while(n<this.children.length&&this.children[n].value!=="//")n++;n=Math.max(this.children.length,n+1+e);t.insert(this,n,term)}return this};v.prototype.get_top=function(){var t=this.children[0],e=[];while(t){if(t.value=="mul")e.push(t);t=t.rs}return e};v.prototype.get_bottom=function(){var t=this.children[0],e=[];while(t){if(t.value=="div")e.push(t);t=t.rs}return e};v.prototype.get_fraction_bar=function(){var t=this.children[0];while(t){if(t.value=="//")return t;t=t.rs}return null};v.is_fraction_with_identity_numerator=function(t){if(!t.has_children()||!v.is_lone_fraction_part(t.children[0]))return false;return a.is_equal_to(t.get_child([0,1]),1)};v.is_lone_fraction_part=function(t){if(!t.parent)return false;return t.parent.is_group("fraction")&&(t.is_group("mul")&&!t.ls&&t.rs.value==="//"||t.is_group("div")&&!t.rs&&t.ls.value==="//")};v.prototype.group_nodes=function(){var t=this.children[0],e=[],i=[],n;while(t){if(t.value=="div")i.push(t);else if(t.value=="mul")e.push(t);else n=t;t=t.rs}return{top:e,bottom:i,bar:n}};v.prototype.to_latex=function(){var t=this.get_top(),e=this.get_bottom();var i=e.length>0?"\\frac{":"";for(var n=0;n<t.length;n++){i+=n==0?t[n].children[1].to_latex():t[n].to_latex()}if(e.length>0){i+="}{";for(var n=0;n<e.length;n++){i+=n==0?e[n].children[1].to_latex():e[n].to_latex()}i+="}"}return i};v.prototype.to_ascii=function(){var t=this.get_top(),e=this.get_bottom();var i="",n="";for(var r=0;r<t.length;r++){i+=r==0?t[r].get_child([1]).to_ascii():t[r].to_ascii()}if(e.length==0)return this.finish_ascii(i);for(var r=0;r<e.length;r++){n+=(r==0?"":"*")+e[r].children[1].to_ascii()}if(t.length>1)i="("+i+")";if(e.length>1)n="("+n+")";var o=i+"/"+n;return this.finish_ascii(o)};v.prototype.finish_ascii=function(t){var e=this.parent;if(e&&e.is_group("sign")||e&&e.is_group("sub")&&e.get_idx()===0)return"{"+t+"}";if(this.is_group("fraction")){var i=e.parent;if(i&&i.is_group("fraction")){if(e.is_group("mul")&&i.get_top().length===1)return"{"+t+"}";if(e.is_group("div")&&i.get_bottom().length===1)return"{"+t+"}"}}return t};var _=function(e,i){p.call(this);this.value=i=="div"?"div":"mul";if(e){t.append(this,new l(this.value=="mul"?"*":"/"));t.append(this,e);c.handle(e)}this.associative=this.value=="mul";this.bp=this.value=="mul"?30:30};u.call(_,"mul-div",{group_class:v,bp:30,associative:true,commutative:true,has_inverse:true});_.createProduct=function(t,e){if(t.is_group("product")){t.append(new _(e));return t}else{var i=_.prototype.createGroup();i.append(new _(t));i.append(new _(e));return i}};_.registerAtParser=function(t){var e=t.registerSymbol("*",_.prototype.bp);e.led=function(e){var i=t.parseExpression(_.prototype.bp);return _.createProduct(e,i)};var i=t.registerSymbol("\\cdot",_.prototype.bp);i.led=e.led;var n=t.registerSymbol("\\times",_.prototype.bp);n.led=e.led;var r=t.registerSymbol("/",_.prototype.bp+1);r.led=function(e){var i=t.parseExpression(_.prototype.bp+1);var n;if(e.is_group("brackets")&&e.children[1].is_group("product")){e=e.children[1]}if(e.is_group("product")){n=e}else{n=_.prototype.createGroup();n.append(new _(e))}if(i.is_group("brackets")&&i.children[1].is_group("product")){i=i.children[1]}if(i.is_group("product")){var r=i.children;for(var o=0;o<r.length;o++){r[o].invert();n.append(r[o])}}else{n.append(new _(i,"div"))}return n};var o=function(){var e=t.parseExpression(_.prototype.bp+1);var i=t.parseExpression(_.prototype.bp+1);var n;if(e.is_group("product"))n=e;else{n=_.prototype.createGroup();n.append(new _(e))}if(i.is_group("product")){i.children.forEach(function(t){t.invert();n.append(t)})}else n.append(new _(i,"div"));return n};t.registerSymbol("\\frac").nud=o;t.registerSymbol("\\dfrac").nud=o;t.registerSymbol("\\tfrac").nud=o};_.hide_rule={name:"hide multiplication sign between variables",disabled:false,apply:function(t){if(!(t instanceof l)||t.value!=="*"&&t.value!=="/")return false;var e=t.parent;if(!e||!(e.is_group("mul")||e.is_group("div")))return false;if(!e.ls||e.ls.value!==e.value||!t.rs)return false;var i=e.ls.children[1];if(t.rs instanceof h||t.rs.is_group("power")&&t.rs.children[0]instanceof h){if(a.is_num(i)||i instanceof h||i.is_group("sign")&&i.children[1]instanceof h){if(e.dragging)t.hide_after_drop=true;else t.hidden=true}}}};_.prototype.invert=function(){if(this.value=="mul"){this.value="div";if(this.children[0])this.children[0].value="/";this.associative=false;this.bp=30}else{this.value="mul";if(this.children[0])this.children[0].value="*";this.associative=true;this.bp=30}};_.prototype.symIsHidden=function(){return this.get_child([0]).hidden};_.prototype.map_group_and_sym=function(t,e,i){var n=i?t.updateNodeMap.bind(t):t.extendNodeMap.bind(t);n(this,e);n(this.children[0],e.children[0])};var y=function(t,e){p.call(this);if(t&&e){this.append(t);if(e.is_group("exponent"))this.append(e);else this.append(new b(e));c.handle(t)}};u.call(y,"power",{bp:50,vertical_notation:false});y.prototype.get_exponent_term=function(){return this.children[1].get_term()};y.getNumericalValueOfExponent=function(t){if(!t.is_group("power")&&!t.is_group("exponent"))return 1;if(t.is_group("exponent"))t=t.children[0];else if(t.is_group("power"))t=t.get_child([1,0]);if(c.areHidden(t))t=t.children[1];return a.get_value(t)};y.haveSameBase=function(t,e){if(t.is_group("power"))t=t.children[0];if(e.is_group("power"))e=e.children[0];return t.to_ascii()===e.to_ascii()};var b=function(e){p.call(this);if(e){t.append(this,e);c.handle(e)}};u.call(b,"exponent",{group_class:y,group_name:"power",bp:50,vertical_notation:true});b.prototype.get_term=function(){if(c.areHidden(this.children[0]))return this.children[0].children[1];return this.children[0]};b.is_square_root=function(t){var e=t.children[0];if(a.is_equal_to(e,.5))return true;if(!e.is_group("brackets"))return false;e=e.children[1];if(!e.is_group("fraction"))return false;var i=e.get_top(),n=e.get_bottom();if(i.length>1||n.length>1)return false;if(a.get_value(i[0].children[1])!==1||a.get_value(n[0].children[1])!==2)return false;return true};b.prototype.to_ascii=function(){if(this.children.length===0)return"";return"^"+this.children[0].to_ascii()};b.prototype.to_latex=function(){if(this.children.length===0)return"";var t=this.children[0].to_latex();return t.length<2||this.children[0].is_group("brackets","abs-val")?"^"+t:"^{"+t+"}"};b.registerAtParser=function(t){t.registerSymbol("^",b.prototype.bp).led=function(e){var i=t.parseExpression(b.prototype.bp-1);return new y(e,i)};var e=[{char:"⁰",val:0},{char:"¹",val:1},{char:"²",val:2},{char:"³",val:3},{char:"⁴",val:4},{char:"⁵",val:5},{char:"⁶",val:6},{char:"⁷",val:7},{char:"⁸",val:8},{char:"⁹",val:9}];e.forEach(function(e){t.registerSymbol(e.char,b.prototype.bp).led=function(t){return new y(t,new a(e.val))}});t.registerSymbol("ⁿ",b.prototype.bp).led=function(t){return new y(t,new h("n"))};t.registerSymbol("\\scriptscriptstyle").nud=function(){var e=t.parseExpression(b.prototype.bp);return e}};var w=function(e){t.Node.call(this);if(e===1||e==="T"||e==="t"||e===true)this.value="T";else this.value="F";this.id=gmath.uid()};gmath.inherit(t.Node,w);w.prototype.name="bool";w.prototype.to_string=function(){return this.value};w.prototype.to_ascii=w.prototype.to_string;w.prototype.is_group=function(){return false};w.registerAtParser=function(t){var e=t.registerSymbol("(number)");e.nud=function(){return new w(this.value)}};gmath.expressions=gmath.expressions||{};gmath.expressions[w.prototype.name]=w;var x=function(){p.call(this)};u.call(x,"disjunction",{bp:30});var A=function(e){p.call(this);if(e){t.append(this,new l("∧"));t.append(this,e);c.handle(e)}};u.call(A,"and",{group_name:"disjunction",group_class:x,bp:30,associative:true,commutative:true});A.registerAtParser=function(t){var e=t.registerSymbol("*",A.prototype.bp);e.led=function(e){var i=t.parseExpression(A.prototype.bp);if(e.is_group("disjunction")){e.append(new A(i));return e}else{var n=A.prototype.createGroup();n.append(new A(e));n.append(new A(i));return n}}};var T=function(){p.call(this)};u.call(T,"conjunction",{bp:30});var k=function(e){p.call(this);if(e){t.append(this,new l("∨"));t.append(this,e);c.handle(e)}};u.call(k,"or",{group_name:"conjunction",group_class:T,bp:20,associative:true,commutative:true});k.registerAtParser=function(t){var e=t.registerSymbol("+",k.prototype.bp);e.led=function(e){var i=t.parseExpression(k.prototype.bp);if(e.is_group("conjunction")){e.append(new k(i));return e}else{var n=k.prototype.createGroup();n.append(new k(e));n.append(new k(i));return n}}};var N=function(e,i){p.call(this);if(e&&i){t.append(this,e);t.append(this,new l("="));t.append(this,i)}};u.call(N,"equals",{bp:10});N.registerAtParser=function(t){var e=t.registerSymbol("=",N.prototype.bp);e.led=function(e){var i=t.parseExpression(N.prototype.bp);if(e.is_group("equals")||i.is_group("equals")||E.is_inequality(e)||E.is_inequality(i)){
throw"More than one comparator in equation."}return new N(e,i)}};N.prototype.getSideOfNode=function(t){while(!(t.parent instanceof N))t=t.parent;return t};N.prototype.getOppositeSideOfNode=function(t){return this.isOnLeftSide(t)?this.getRightSide():this.getLeftSide()};N.prototype.getLeftSide=function(){return this.children[0]};N.prototype.getRightSide=function(){return this.children[2]};N.prototype.isOnLeftSide=function(t){return this.getSideOfNode(t)==this.getLeftSide()};N.prototype.isOnRightSide=function(t){return this.getSideOfNode(t)==this.getRightSide()};N.prototype.areOnSameSide=function(t,e){var i=this.isOnLeftSide(t),n=this.isOnLeftSide(e);return i&&n||!i&&!n};var E=function(e,i,n){p.call(this);this.value=n;if(e&&i){if(n!=="lte"&&n!=="gte"&&n!=="lt"&&n!=="gt")throw"(Inequality) Unaccepted mode type.";t.append(this,e);t.append(this,new l(E.value2sym[n]));t.append(this,i)}};E.unicode_syms=["≤","≥","<",">"];E.value2sym={lte:"≤",gte:"≥",lt:"<",gt:">"};E.sym2Ascii={"≤":"<=","≥":">=","<":"<",">":">"};u.call(E,"inequality",{bp:10});E.prototype.to_ascii=function(){return this.children.map(function(t,e){if(e===1)return E.sym2Ascii[t.to_ascii()];else return t.to_ascii()}).join("")};E.is_inequality=function(t){return t.is_group("lte","gte","lt","gt")};E.prototype.setValue=function(t){this.value=t;this.get_child([1]).value=E.value2sym[this.value]};E.prototype.invert=function(){if(this.value==="lte")this.setValue("gte");else if(this.value==="gte")this.setValue("lte");else if(this.value==="lt")this.setValue("gt");else if(this.value==="gt")this.setValue("lt")};E.registerAtParser=function(t){var e={"<":"lt","\\lt":"lt",">":"gt","\\gt":"gt","<=":"lte","\\le":"lte","≤":"lte",">=":"gte","\\ge":"gte","≥":"gte"};for(var i in e){t.registerSymbol(i,E.prototype.bp).led=function(e,i){var n=t.parseExpression(E.prototype.bp);if(E.is_inequality(i)||E.is_inequality(n)||i.is_group("equals")||n.is_group("equals")){throw"More than one comparator in equation."}return new E(i,n,e)}.bind(null,e[i])}};var S=function(){p.call(this);this.bp=5;this.value="tuple";for(var t=0;t<arguments.length;t++){var e=arguments[t];if(e instanceof L)this.append(e);else this.append(new L(e))}};gmath.inherit(p,S);S.prototype.name="tuple";S.is_tuple=function(t){return t instanceof S||t.is_group("brackets")&&t.children[1]instanceof S};S.prototype.to_ascii=function(){return this.children.map(function(t){if(!t.ls){return t.children[1].to_ascii()}else{return t.to_ascii()}}).join("")};S.prototype.to_latex=function(){return this.children.map(function(t){if(!t.ls){return t.children[1].to_latex()}else{return t.to_latex()}}).join("")};gmath.expressions[S.prototype.name]=S;var L=function(t){p.call(this);this.value="param";if(t){this.append(new l(","));this.children[0].fixed=true;this.append(t)}this.group_class=S;this.group_name="tuple";this.associative=false;this.commutative=false};gmath.inherit(p,L);L.prototype.name="param";L.prototype.bp=5;L.createTuple=function(t,e){if(t.is_group("tuple")){t.append(new L(e));return t}else{var i=new S;i.append(new L(t));i.append(new L(e));return i}};L.prototype.append=function(e){t.append(this,e);if(e instanceof l){e.fixed=true}};L.registerAtParser=function(t){var e=t.registerSymbol(",",L.prototype.bp);e.led=function(e){var i=t.parseExpression(L.prototype.bp);return L.createTuple(e,i)};var i=t.registerSymbol("\\,",L.prototype.bp);i.led=e.led};L.hide_rule={name:"Do not show the first comma in a tuple set.",disabled:false,apply:function(t){if(!(t instanceof l)||t.value!==",")return false;var e=t.parent;if(!e||!e.is_group("param"))return false;if(!e.ls||e.ls.value!==e.value){t.hidden=true}}};gmath.expressions[L.prototype.name]=L;var M=function(e,i){p.call(this);t.append(this,new l(e));if(typeof i!="undefined")this.set_argument(i);this.value=e;this.units=M.units[this.value]};gmath.inherit(p,M);u.call(M,"func",{bp:60,commutative:false});M.units={sin:["rad","deg"],cos:["rad","deg"],tan:["rad","deg"]};M.prototype.is_leaf_node=false;M.prototype.is_group=function(){if(arguments.length===0)return true;for(var t=0;t<arguments.length;t++){if(arguments[t]==="func")return true;if(arguments[t]===this.value)return true}return false};M.prototype.to_string=function(){return this.value};M.prototype.set_arg=function(t){if(Array.isArray(t)){this.append(new c(new S(t)))}else if(t.is_group("tuple")){this.append(t);c.handle(this.children[1])}else if(t.is_group("brackets")&&t.children[1].is_group("tuple")){this.append(t)}else if(t.is_group("brackets")&&!t.children[1].is_group("tuple")){var e=t;var i=e.children[1];e.insert(i.remove(),new S(i));this.append(e)}else{this.append(new S(t));c.handle(this.children[1])}};M.prototype.arg_length=function(){var t=this.children[1],e=t.is_group("tuple")?t:t.children[1];return e.children.length};M.prototype.get_arg=function(t){var e=this.children[1];return e.get_child(e.is_group("brackets")?[1,t||0,1]:[t||0,1])};M.prototype.map_to_func=function(t,e,i){var n=i?t.updateNodeMap.bind(t):t.extendNodeMap.bind(t);n(this,e);n(this.children[0].get_mapping_to(e.children[0]));var r=this.children[1],o=e.children[1];if(r.is_group("brackets")&&o.is_group("brackets")){n(r,o);n(r.children[0],o.children[0]);n(r.children[2],o.children[2]);r=r.children[1];o=o.children[1]}n(r,o)};M.prototype.map_to_group=function(t,e,i){var n=i?t.updateNodeMap.bind(t):t.extendNodeMap.bind(t);var r=[];this.for_each(function(t){r.push(t)},this);r.forEach(function(t){n(t,e)});n=t.extendNodeMap.bind(t);e.children.forEach(function(t){t.for_each(function(t){r.forEach(function(e){n(e,t)})},this)},this)};M.Trig={};M.Trig.evaluate=function(t){var e=a.get_value(t.get_arg());if(Number.isNaN(e))return NaN;if(t.units==="deg")e*=Math.PI/180;return Math[t.value](e)};M.Trig.is_trig_func=function(t){return t&&t.is_group("func")&&(t.value==="sin"||t.value==="cos"||t.value==="tan")};M.Logs={};M.Logs.is_log_func=function(t){return t&&t.is_group("func")&&("log"===t.value||"ln"===t.value)};M.Logs.get_log_base=function(t,e){var i;if(t.children[0].has_subscript())i=t.children[0].get_subscript();if(!i&&!e)i=M.Logs.get_implied_subscript(t);return i};M.Logs.get_implied_subscript=function(t){var e=t.children[0].get_value();if(e==="log")return new a(10);else if(e==="ln")return new h("e");else return null};M.Logs.within_domain=function(t){return a.is_inequal_to(t,"gt",0)||h.is_var(t)&&t.get_value()==="e"};M.Logs.evaluate=function(t){var e=M.Logs.get_log_base(t).get_value(),i=t.get_arg().get_value();if(i==="e")i=Math.E;if(e==="e")e=Math.E;return Math.log(i)/Math.log(e)};M.parsable_syms=["sin","cos","tan","\\sin","\\cos","\\tan","log","ln","\\log","\\ln"];M.registerAtParser=function(t){var e=function(){var e=new M(this.value[0]==="\\"?this.value.substr(1):this.value);n(e);var i=t.parseExpression(M.prototype.bp);e.set_arg(i);return e};var i=function(e){var i=t.parseExpression(_.prototype.bp,this);return _.createProduct(e,i)};M.parsable_syms.forEach(function(n){var n=t.registerSymbol(n,M.prototype.bp);n.nud=e;n.led=i});function n(e){if(t.advance("_",true)){var i=e.children[0].value,n=t.parseExpression(99);if(i==="ln"&&a.is_num(n)||i==="ln"&&h.is_var(n)&&n.value!=="e"){e.value="log";e.children[0].value="log"}e.children[0].set_subscript(n)}}};var C=function(e){t.Node.call(this);this.value=e};gmath.inherit(t.Node,C);s.call(C,"placeholder");C.prototype.to_string=function(){return"[]"};C.prototype.match=function(t){if(this.value==="any")return true;return t.name===this.value};C.prototype.to_ascii=function(){return"\\"+this.value.toUpperCase()};C.prototype.to_latex=function(){return"\\"+this.value.toUpperCase()};C.prototype.is_group=function(){for(var t=0;t<arguments.length;t++)if(arguments[t]==="placeholder")return true;return false};gmath.expressions[C.prototype.name]=C;var q=function(t,e){p.call(this);this.set_degree(e);this.init_symbols();this.set_radicand(t)};u.call(q,"radical",{bp:50,vertical_notation:false});q.prototype.set_degree=function(t){var e;if(this.has_children()&&this.children[0].is_group("degree"))this.children[0].remove();if(t&&t.is_group("degree"))e=t;else if(t)e=new D(t);else e=new D(new a(2));this.insert(0,e)};q.prototype.init_symbols=function(){this.insert(1,new l("√"));this.insert(2,new l("//"))};q.prototype.set_radicand=function(t){if(this.has_children()&&this.children[3])this.children[3].remove();if(t){this.insert(3,t);c.handle(t)}};q.prototype.get_degree=function(){return this.children[0]};q.prototype.get_degree_term=function(){return this.children[0].get_term()};q.prototype.get_radicand=function(){return this.children[3]};q.prototype.map_to_radical=function(t,e,i){var n=i?t.updateNodeMap.bind(t):t.extendNodeMap.bind(t);n(this,e);n(this.children[0],e.children[0]);n(this.children[1],e.children[1]);n(this.children[2],e.children[2])};q.parsable_syms=["sqrt","\\sqrt","√"];q.registerAtParser=function(t){var e=function(){var e=new q;var i=t.parseExpression(Infinity);if(i.is_group("brackets")&&i.children[0].value==="["){var n=i.children[1];e.set_degree(n);var r=t.parseExpression(Infinity);e.set_radicand(r)}else{e.set_radicand(i)}return e};var i=function(e){var i=t.parseExpression(_.prototype.bp,this);return _.createProduct(e,i)};q.parsable_syms.forEach(function(n){var r=t.registerSymbol(n,q.prototype.bp);r.nud=e;r.led=i})};q.prototype.to_ascii=function(){var t="sqrt";if(this.get_degree().get_term().value!==2)t+=this.get_degree().to_ascii();var e=this.get_radicand().to_ascii();if(e.length>1)return t+"{"+e+"}";else return t+e};q.prototype.to_latex=function(){return"\\"+this.to_ascii()};var D=function(e){p.call(this);if(e){t.append(this,e);c.handle(e)}};u.call(D,"degree",{group_class:q,group_name:"radical",bp:50,vertical_notation:true});D.prototype.get_term=function(){if(c.areHidden(this.children[0]))return this.children[0].children[1];return this.children[0]};D.is_square_root=function(t){return t.is_group("degree")&&a.is_equal_to(t.children[0],2)};D.prototype.to_ascii=function(){if(this.children.length===0)return"";return"["+this.children[0].to_ascii()+"]"};D.prototype.to_latex=function(){if(this.children.length===0)return"";return"["+this.children[0].to_latex()+"]"};D.hide_rule={name:"hide degree of 2",disabled:false,apply:function(t){if(t.parent.is_group("degree")&&a.is_equal_to(t,2))t.hidden=true}};Latex={};Latex.registerAtParser=function(t){t.registerSymbol("\\quad").nud=function(){return t.parseExpression(0)}};gmath.expressions["latex"]=Latex;gmath.actions={};Action=function(t,e){this.name=t;this.description=e;this.id=gmath.uid();this.priority=0;this.node_map={};this.initial_node_map={};this.touched_nodes={};this.new_selection=null;this.timeoutID=null;this.settings={}};Action.prototype.printMap=function(t){if(t)console.log(t);for(var e in this.node_map){var i=this.oldTree.get_by_id(e);console.log(i?i.to_ascii():"?","==>",this.node_map[e].map(function(t){return t.to_ascii()}).join(", "))}};Action.prototype.createBoundAction=function(t,e,i){var n=new this.constructor(e);n.oldTree=t;n.newTree=t;n.trigger=i;return n};Action.prototype.getSourceAndTarget=function(t){if(this.triggerType==="drag")return{source:t?this.nodes:this.nodes[0],target:this.target};return{source:t?[this.actor]:this.actor,target:this.actor.ls}};Action.prototype.bindActionForEachTarget=function(t,e,i){var n=[];var r=t[0].get_root();e.forEach(function(e,o){if(i&&o===0){n.push(this.createBoundAction(r,{nodes:t,target:e,side:"left-of"}))}n.push(this.createBoundAction(r,{nodes:t,target:e,side:i?"right-of":"around"}))},this);return n};Action.prototype.rebind=function(t,e,i){if(this.oldTree!==i)throw"wrong old tree during rebinding an action!";var n=new Action;n.node_map=e;this.oldTree=t;if(this.nodes)this.nodes=n.mapNodes(this.nodes);if(this.target)this.target=Array.isArray(this.target)?[n.mapNodes(this.target)[0]]:n.mapNodes(this.target)[0];if(this.actor)this.actor=n.mapNodes(this.actor)[0]};Action.prototype.createAndRun=function(t,e,i){var n=new this.constructor(e);n.oldTree=t;n.run(i);return n};Action.prototype.createAndDoInPlace=function(t,e,i){var n=new this.constructor(e);n.oldTree=t;n.newTree=t;n.doInPlace(i);return n};Action.prototype.initNodeMap=function(){this.initial_node_map=this.oldTree.children[0].get_mapping_to(this.newTree.children[0]);this.node_map=this.oldTree.children[0].get_mapping_to(this.newTree.children[0])};Action.prototype.removeDeletedNodesFromNodeMap=function(){var t=this.newTree.select_all();var e=function(e){return t.indexOf(e)!==-1};for(var i in this.node_map){this.node_map[i]=this.node_map[i].filter(e)}};Action.prototype.updateNodeMap=function(t,e){if(arguments.length===1)gmath.extend(this.node_map,t);else{var i=t;if(Array.isArray(i)){for(var n=0;n<i.length;n++){this.node_map[i[n].id]=Array.isArray(e)?e:[e]}}else this.node_map[i.id]=Array.isArray(e)?e:[e]}};Action.pushNew=function(t,e){for(var i=0;i<e.length;i++){if(t.indexOf(e[i])===-1)t.push(e[i]);else{t.splice(t.indexOf(e[i]),1);t.push(e[i])}}};Action.prototype.extendNodeMap=function(t,e){if(arguments.length===2){var i=t;var n=Array.isArray(e)?e:[e];if(i.id in this.node_map)Action.pushNew(this.node_map[i.id],n);else this.node_map[i.id]=n;return}else{var r=t;for(var o in r){if(!r.hasOwnProperty(o))continue;if(o in this.node_map)Action.pushNew(this.node_map[o],r[o]);else this.node_map[o]=r[o]}}};Action.prototype.getNewTreeNode=function(t){return this.getCorrespondingNodeFromTree(t,this.newTree)};Action.prototype.getOldTreeNode=function(t){return this.getCorrespondingNodeFromTree(t,this.oldTree)};Action.prototype.getCorrespondingNodeFromTree=function(t,e){var i=function(t){return e.get_child(t.get_path())};if(Array.isArray(t))return t.map(i);else return i(t)};Action.prototype.addTouchedNodes=function(e){var i=this;t.for_each(function(t){i.touched_nodes[t.id]=true},e)};Action.prototype.getOrInferTriggerType=function(){if(this.triggerType)return this.triggerType;if(this.actor)return"tap";if(this.nodes)return"drag";return"unknown"};Action.prototype.setNodesToReselectAfterAction=function(t){if(Array.isArray(t))this.new_selection=t.slice();else this.new_selection=[t]};Action.prototype.cleanup=function(t){if(!t.cleanupAction)return false;if(!t.cleanupAction.match(t))return false;var e=t.cleanupAction.createAndDoInPlace(this.newTree,{actor:t});this.compose(e,false);return e};Action.prototype.cleanup_cascade=function(t){var e=false;for(;;){var i=this.cleanup(t);if(!i)return e;e=true;var n=i.mapNodes(t);if(n.length===0)return e;t=n[0].parent}};Action.prototype.compose=function(t,e){if(arguments.length<2)e=true;for(var i in this.node_map){var n=this.node_map[i];this.node_map[i]=t.mapNodes(n);var r=n.filter(function(e){return!t.node_map[e.id]});if(r.length>0&&e)throw"Second mapping does not mention all nodes from first mapping.";this.node_map[i]=this.node_map[i].concat(r);if(t.touched_nodes[i])this.touched_nodes[i]=true}if(this.new_selection){this.new_selection=t.mapNodes(this.new_selection)}this.newTree=t.newTree};Action.prototype.run=function(t){this.newTree=this.oldTree.clone();return this.doInPlace(t)};Action.prototype.match=function(){throw"called abstract method Action.match()"};Action.prototype.rematch=function(){if(!(this.actor||this.nodes&&this.nodes.length>0&&this.target&&(!Array.isArray(this.target)||this.target.length>0)))return false;if(this.actor)return this.match(this.actor);if(this.getAllAvailableActions){var t=this.getAllAvailableActions(this.nodes);return t.some(function(t){if(Array.isArray(t.target))return gmath.array.equals(t.target,this.target);else return t.target===this.target},this)}};Action.prototype.transform=function(t){throw"called abstract method Action.transform()"};Action.prototype.doInPlace=function(t){this.initNodeMap();var e=this.transform(t);this.removeDeletedNodesFromNodeMap();return e};Action.prototype.wasNodeTouched=function(t){return this.touched_nodes[t.id]};Action.prototype.mapNodes=function(t){var e=[],i=this;if(!Array.isArray(t))t=[t];t.forEach(function(t){var n=i.node_map[t.id]||[];n.forEach(function(t){if(e.indexOf(t)===-1)e.push(t)})});return e};Action.prototype.unmapNodes=function(t){var e=[];if(!Array.isArray(t))t=[t];for(var i in this.node_map){if(gmath.array.isPermutation(t,this.node_map[i]))e.push(this.oldTree.get_by_id(i))}return e};Action.createComposedAction=function(t,e,i){var n=new Action(e,i);function r(){function e(i,r,o){if(o>=t.length)return i;if(!n.touched_nodes[r]){n.touched_nodes[r]=i.some(t[o].wasNodeTouched.bind(t[o]))}return e(t[o].mapNodes(i),r,o+1)}n.node_map={};n.touched_nodes={};for(var i in t[0].node_map){n.touched_nodes[i]=t[0].touched_nodes[i];n.node_map[i]=e(t[0].node_map[i],i,1)}}r();n.oldTree=t[0].oldTree;n.newTree=t[t.length-1].newTree;n.new_selection=t[t.length-1].new_selection;return n};gmath.factoring={};gmath.factoring.bypass_negatives=function(t){while(t.is_group("sign"))t=t.get_child([1]);return t};gmath.factoring.factorable_muldiv=function(t){var e=t;if(e.get_parent(1).is_group("fraction")&&e.get_parent(2).is_group("mul")){e=e.get_parent(2)}if(!e.is_group("mul","div"))return false;var i=e.get_parent(1);if(!i.is_group("product","fraction"))return false;var n=i.get_parent(1);if(!n.is_group("add","sub"))return false;var r=n.get_parent(1);if(!r.is_group("sum"))return false;return{ancestor_sum:r,addsub_idx:n.get_idx()}};gmath.factoring.val1_is_a_multiple_of_val2=function(t,e){return Math.abs(t)>=Math.abs(e)&&Math.abs(e)!==1&&t%e===0};gmath.factoring.get_gcf=function(t,e){if(t<0)t=-t;if(e<0)e=-e;if(e>t){var i=t;t=e;e=i}while(true){t%=e;if(t==0)return e;e%=t;if(e==0)return t}};gmath.factoring.numbers_are_multiples=function(t,e){var i=a.get_value(t),n=a.get_value(e);if(!i||!n)return false;if(gmath.factoring.val1_is_a_multiple_of_val2(i,n))return true;else if(gmath.factoring.val1_is_a_multiple_of_val2(n,i))return true;else if(gmath.factoring.get_gcf(i,n)!==1)return true;else return false};gmath.actions.CloneAction=function(){var t=function(){Action.call(this,"CloneAction","clone");this.triggerType="drag"};gmath.inherit(Action,t);t.prototype.rematch=function(){return true};t.prototype.transform=function(t){if(typeof t==="function")t(this);else return true};return new t}();gmath.actions.AbsValAction=function(){var e=function(t){Action.call(this,"AbsValAction","evaluate absolute value");this.priority=4;this.triggerType="tap";if(t)this.actor=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){if(t.match("|±\\NUM|"))return true;if(t.is_group("abs-val")&&this.prodFracContainingNumbers(t.get_child([1])))return true;return false};e.prototype.prodFracContainingNumbers=function(t){if(!t.is_group("product","fraction"))return false;return t.get_top().concat(t.get_bottom()).every(function(t){return a.is_num(t.get_child([1]))})};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.actor);this.addTouchedNodes(this.actor);var n=i.match("|±{n:\\NUM}|");if(n){var r=n.n;t.replace(i,r);this.cleanup(r.parent)}else{var o=i.get_child([1]);t.replace(i,o);o.get_top().concat(o.get_bottom()).forEach(function(e){var i=e.get_child([1]);if(i.is_group("sign"))t.replace(i,i.get_child([1]))});this.cleanup(o.parent)}if(typeof e==="function")e(this);else return true};var i=new e;d.prototype.add_action_handler(i);return i}();gmath.actions.AbsValDoubleAction=function(){var e=function(t){Action.call(this,"AbsValDoubleAction","nested absolute values");this.priority=4;this.triggerType="tap";if(t)this.actor=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){return t&&t.match("||±\\ANY||")};e.prototype.transform=function(e){this.addTouchedNodes(this.actor);var i=this.getNewTreeNode(this.actor),n=i.match("|{n:|±\\ANY|}|").n;t.replace(i,n);if(typeof e==="function")e(this);return true};var i=new e;d.prototype.add_action_handler(i);return i}();gmath.actions.AbsValNegVarAction=function(){var e=function(t){Action.call(this,"AbsValNegVarAction","absolute value of a negative variable");this.priority=4;this.triggerType="tap";if(t)this.actor=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){if(t.match("|-\\VAR|"))return true;if(t.is_group("abs-val")&&this.prodFracContainingNegativeTerms(t.get_child([1])))return true;return false};e.prototype.prodFracContainingNegativeTerms=function(t){if(!t.is_group("product","fraction"))return false;return t.get_top().concat(t.get_bottom()).some(function(t){return t.get_child([1]).is_group("sign")})};e.prototype.transform=function(e){this.addTouchedNodes(this.actor);var i=this.getNewTreeNode(this.actor);var n=i.match("|{neg:-{var:\\VAR}}|");if(n){t.replace(n.neg,n.var)}else{var r=i.get_child([1]);r.get_top().concat(r.get_bottom()).forEach(function(e){var i=e.get_child([1]);if(i.is_group("sign"))t.replace(i,i.get_child([1]))})}if(typeof e==="function")e(this);else return true};var i=new e;d.prototype.add_action_handler(i);return i}();gmath.actions.AbsValExtractNumAction=function(){var e=function(t){Action.call(this,"AbsValExtractNumAction","pull a number out of an absolute value");this.priority=4;this.triggerType="drag";this.settings={};if(t){this.nodes=t.nodes;this.target=t.target;this.settings.side=t.side}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(e){if(!t.is_range(e))return[];if(!e[0].is_group("mul"))return[];if(!e[0].get_parent(2).is_group("abs-val"))return[];if(!e.every(function(t){return a.is_num(t.get_child([1]))}))return[];var i=e[0].get_root(),n=e[0].get_parent(2);return[this.createBoundAction(i,{nodes:e,target:n,side:"left-of"}),this.createBoundAction(i,{nodes:e,target:n,side:"right-of"})]};e.prototype.transform=function(e){this.addTouchedNodes(this.nodes);this.addTouchedNodes(this.target);var i=this.getNewTreeNode(this.target),n=this.getNewTreeNode(this.nodes),r=n[0].get_parent(1);var o=i.get_parent(1),s=i.remove(),a=new v;n.forEach(function(t){var e=t.get_child([1]);if(e.is_group("sign"))e.replace_with(e.get_child([1]))});t.remove_range(n);a.append(new _(i));if(this.settings.side==="left-of")a.insert_range(0,n);else a.append_range(n);o.insert(s,a);this.cleanup(r);this.cleanup_cascade(a.get_parent(1));if(typeof e==="function")e(this);else return true};return new e}();r.prototype.move_actions.push(gmath.actions.AbsValExtractNumAction);gmath.actions.AbsValInsertPosNumAction=function(){var e=function(t){Action.call(this,"AbsValInsertPosNumAction","move a range of positive numbers inside an absolute value group");this.priority=4;this.triggerType="drag";this.settings={};if(t){this.nodes=t.nodes;this.target=t.target;this.settings.side=t.side}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(e){if(!t.is_range(e))return[];if(!e[0].is_group("mul","div"))return[];if(!e.every(this.isPosNum))return[];var i=this.getOtherAbsValMulDivsInGroup(e[0]);return this.bindActionsForEachTarget(e,i)};e.prototype.isPosNum=function(t){var e=t.children[1];return e&&a.is_num(e)&&a.get_value(e)>=0};e.prototype.isAbsVal=function(t){return t.get_child([1]).is_group("abs-val")};e.prototype.getOtherAbsValMulDivsInGroup=function(t){var e=t.get_parent(1);var i=e.get_top().concat(e.get_bottom()).filter(function(e){return e.value===t.value&&this.isAbsVal(e)},this);return i};e.prototype.bindActionsForEachTarget=function(t,e){var i=[];var n=t[0].get_root();e.forEach(function(e){var n=e.get_child([1,1]);if(n.is_group("product"))n=n.children.slice();else n=[n];i=i.concat(this.bindActionForEachTarget(t,n,true))},this);return i};e.prototype.transform=function(e){this.addTouchedNodes(this.nodes);this.addTouchedNodes(this.target);var i=this.getNewTreeNode(this.nodes),n=this.getNewTreeNode(this.target);var r=i[0].get_parent(1);t.remove_range(i);if(i[0].is_group("div"))i.forEach(function(t){t.invert()});if(n.is_group("mul")){var o=n.get_parent(1);o.insert_range(n.get_idx()+(this.settings.side==="left-of"?0:1),i)}else{var s=n.get_parent(1),a=n.remove(),l=new v;l.append(new _(n));l.insert_range(this.settings.side==="left-of"?0:1,i);s.insert(a,l)}this.cleanup_cascade(r);if(typeof e==="function")e(this);else return true};var i=new e;return i}();r.prototype.move_actions.push(gmath.actions.AbsValInsertPosNumAction);gmath.actions.AbsValExtractVarAction=function(){var e=function(t){Action.call(this,"AbsValExtractVarAction","pull a variable out of an absolute value");this.priority=4;this.triggerType="drag";this.settings={};if(t){this.nodes=t.nodes;this.target=t.target;this.settings.side=t.side}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(e){if(!t.is_range(e))return[];if(!e[0].is_group("mul"))return[];if(!e[0].get_parent(1).is_group("product"))return[];if(!e[0].get_parent(2).is_group("abs-val"))return[];if(!e.some(function(t){return!a.is_num(t.get_child([1]))}))return[];var i=e[0].get_root(),n=e[0].get_parent(2);return[this.createBoundAction(i,{nodes:e,target:n,side:"left-of"}),this.createBoundAction(i,{nodes:e,target:n,side:"right-of"})]};e.prototype.transform=function(e){this.addTouchedNodes(this.nodes);this.addTouchedNodes(this.target);var i=this.getNewTreeNode(this.target),n=this.getNewTreeNode(this.nodes),r=n[0].get_parent(1);var o=i.get_parent(1),s=i.remove(),a=new v;var l=new d(new v),h=l.get_child([1]);var p=new _(l);a.append(new _(i));if(this.settings.side==="left-of")a.insert(0,p);else a.append(p);t.remove_range(n);h.append_range(n);o.insert(s,a);this.cleanup(r);this.cleanup(h);this.cleanup_cascade(a.get_parent(1));this.setNodesToReselectAfterAction(p);if(typeof e==="function")e(this);else return true};return new e}();r.prototype.move_actions.push(gmath.actions.AbsValExtractVarAction);gmath.actions.AbsValCombineAction=function(){var t=function(t){Action.call(this,"AbsValCombineAction","combine two absolute value terms into one");this.priority=4;this.triggerType="tap";this.settings={delay:300,side:"inside"};if(t){if(t.actor){this.actor=t.actor}else{this.triggerType="drag";this.nodes=t.nodes;this.target=t.target}}};gmath.inherit(Action,t);t.prototype.getAllAvailableActions=function(t){if(t.length!==1)return[];if(!t[0].is_group("mul","div")||!t[0].get_child([1]).is_group("abs-val"))return[];var e=this.getOtherAbsValMulDivsInGroup(t[0]);return this.bindActionForEachTarget(t,e)};t.prototype.getOtherAbsValMulDivsInGroup=function(t){var e=t.get_parent(1);var i=e.get_top().concat(e.get_bottom()).filter(function(e){return e!==t&&e.value===t.value&&e.get_child([1]).is_group("abs-val")},this);return i};t.prototype.match=function(t){if(!t.ls||t.ls.value!==t.value)return false;return t.ls.get_child([1]).is_group("abs-val")&&t.get_child([1]).is_group("abs-val")};t.prototype.transform=function(t){this.addTouchedNodes(this.nodes||this.actor);if(this.target)this.addTouchedNodes(this.target);var e=this.getNewTreeNode(this.nodes||this.actor),i=this.getNewTreeNode(this.target||this.actor.ls);if(Array.isArray(e))e=e[0];var n=this.getOldTreeNode(e),r=this.getOldTreeNode(i);var o=e.get_idx()<i.get_idx();var s=e.get_parent(1);e.remove();var a=i.remove();var l=this.getTermForAbsVal(e),h=this.getTermForAbsVal(i);var p=new v;p.append(h);if(o)p.insert(0,l);else p.append(l);var u=new d(p),c=new _(u,n.value);this.mapOpAndSym(n,c);this.mapBars(n.get_child([1]),u);this.mapOpAndSym(r,c);this.mapBars(r.get_child([1]),u);s.insert(a,c);this.setNodesToReselectAfterAction(l.children[1].is_group("product")?l.children[1].children:l);this.cleanup(l);this.cleanup(h);this.cleanup_cascade(s);if(typeof t==="function")t(this);else return true};t.prototype.getTermForAbsVal=function(t){var e=t.get_child([1,1]);e.remove();return new _(e)};t.prototype.mapOpAndSym=function(t,e){this.updateNodeMap(t,e);this.updateNodeMap(t.get_child([1]),e.get_child([1]))};t.prototype.mapBars=function(t,e){this.updateNodeMap(t.get_child([0]),e.get_child([0]));this.updateNodeMap(t.get_child([2]),e.get_child([2]))};var e=new t;_.prototype.add_action_handler(e);return e}();r.prototype.move_actions.push(gmath.actions.AbsValCombineAction);gmath.actions.AbsValFracSplitAction=function(){var e=function(t){Action.call(this,"AbsValFracSplitAction","isolating the absolute value to the numerator and denominator");this.priority=4;this.triggerType="drag";this.settings={};if(t){this.nodes=t.nodes;this.target=t.target;this.settings.side=t.side}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(e){if(!t.is_range(e))return[];var i=e[0].get_parent(1);if(!i.is_group("fraction"))return[];if(e[0].is_group("mul")&&e.length!==i.get_top().length)return[];if(e[0].is_group("div")&&e.length!==i.get_bottom().length)return[];var n=i.get_parent(1);if(!n.is_group("abs-val"))return[];var r=e[0].get_root(),o=e[0].is_group("mul")?"above":"below";return[this.createBoundAction(r,{nodes:e,target:n,side:o})]};e.prototype.transform=function(e){this.addTouchedNodes(this.nodes);this.addTouchedNodes(this.target);var i=this.getNewTreeNode(this.target),n=i.get_child([1]);var r=i.get_parent(1),o=i.remove();n.remove();var s=n.get_top();t.remove_range(s);var a=new v;a.append_range(s);var l=new d(a);var h=n.get_bottom();t.remove_range(h);var p=new v;h.forEach(function(t){t.invert()});p.append_range(h);var u=new d(p);n.append(new _(l));n.append(new _(u,"div"));r.insert(o,n);this.cleanup(a);this.cleanup(p);this.cleanup_cascade(r);if(typeof e==="function")e(this);else return true};return new e}();r.prototype.move_actions.push(gmath.actions.AbsValFracSplitAction);gmath.actions.AbsValFracSplitAction=function(){var t=function(t){Action.call(this,"AbsValFracSplitAction","isolating the absolute value to the numerator and denominator");this.priority=4;this.triggerType="tap";this.settings={};if(t)this.actor=t.actor};gmath.inherit(Action,t);t.prototype.match=function(t){if(!t.is_group("fraction"))return false;if(t.get_top().length!==1||!t.get_child([0,1]).is_group("abs-val"))return false;if(t.get_bottom().length!==1||!t.get_child([2,1]).is_group("abs-val"))return false;return true};t.prototype.transform=function(t){this.addTouchedNodes(this.actor);var e=this.getNewTreeNode(this.actor);var i=e.get_child([0]),n=i.get_child([1,1]),r=e.get_child([2]),o=r.get_child([1,1]);n.remove();o.remove();i.get_child([1]).remove();r.get_child([1]).remove();i.append(n);r.append(o);var s=e.get_parent(1),a=e.remove();var l=new d(e);s.insert(a,l);this.cleanup(i);this.cleanup(r);this.cleanup_cascade(e);if(typeof t==="function")t(this);else return true};var e=new t;v.prototype.add_action_handler(e);return e}();gmath.actions.AbsValVarPowerAction=function(){var e=function(t){Action.call(this,"AbsValVarPowerAction","real even powers are positive");this.priority=4;this.triggerType="tap";this.settings={restraint:"The power base must be real."};if(t)this.actor=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){return t.is_group("abs-val")&&t.get_child([1]).is_group("power")&&h.is_var(t.get_child([1,0]))&&this.exponentIsAnEvenNumber(t.get_child([1,1,0]))};e.prototype.exponentIsAnEvenNumber=function(t){return a.is_num(t)&&a.get_value(t)%2===0};e.prototype.transform=function(e){this.addTouchedNodes(this.actor);var i=this.getNewTreeNode(this.actor),n=i.get_child([1]);t.replace(i,n);if(typeof e==="function")e(this);else return true};var i=new e;d.prototype.add_action_handler(i);return i}();gmath.actions.AbsValReselectGroupAction=function(){var t=function(t){Action.call(this,"AbsValReselectGroupAction","drag the left absolute value bar to reselect the whole group");this.priority=2;this.triggerType="drag";this.settings={makes_no_changes:true,update_node_positions:true,side:"outside",margin:{y1:.4,y2:.4}};if(t){this.nodes=t.nodes;this.target=t.target}};gmath.inherit(Action,t);t.prototype.getAllAvailableActions=function(t){if(t.length!==1)return[];var e=t[0];if(!e.is_group("sym")||e.value!=="|")return[];var i=e.get_root();var n=this.createBoundAction(i,{nodes:[e],target:e});return[n]};t.prototype.transform=function(t){this.addTouchedNodes(this.target.parent);this.setNodesToReselectAfterAction(this.target.parent);if(typeof t==="function")t(this);return this};return new t}();r.prototype.move_actions.push(gmath.actions.AbsValReselectGroupAction);gmath.actions.AbsValCreateNegativeAction=function(){var t=function(t){Action.call(this,"AbsValCreateNegativeAction","drag the absolute value bar to the left to produce a negative sign");
this.priority=1;this.triggerType="drag";this.settings={delay:1e3,side:"left-of"};if(t){this.nodes=t.nodes;this.target=t.target}};gmath.inherit(Action,t);t.prototype.getAllAvailableActions=function(t){if(t.length!==1)return[];if(!(t[0]instanceof l)||t[0].to_ascii()!=="|")return[];if(this.absValTermIsNegative(t[0].get_parent(1).get_child([1])))return[];return this.bindActionForEachTarget(t,t)};t.prototype.absValTermIsNegative=function(t){if(a.is_num(t)&&a.get_value(t)<0)return true;if(t.is_group("sign"))return true;if(t.is_group("product")&&t.get_child([0,1]).is_group("sign"))return true;else return false};t.prototype.transform=function(t){this.addTouchedNodes(this.target.parent);var e=this.getNewTreeNode(this.target.parent),i=e.get_child([1]);if(i.is_group("product")){var n=i.get_child([0]),r=n.get_child([1]),o=r.remove();n.insert(o,new f(r))}else{i.remove();e.insert(1,new f(i))}this.setNodesToReselectAfterAction(e);if(typeof t==="function")t(this);return this};return new t}();r.prototype.move_actions.push(gmath.actions.AbsValCreateNegativeAction);gmath.actions.ApplyMacroAction=function(){var t=function(t){Action.call(this,"ApplyMacroAction","macro");this.settings={};if(t){this.nodes=t.nodes;this.target=t.target}};gmath.inherit(Action,t);t.prototype.toJSON=function(){var t=Action.prototype.toJSON.call(this);if(this.macro_derivation)t.macro_derivation=this.macro_derivation.id;return t};t.prototype.ids_to_references_after_parsing=function(t){Action.prototype.ids_to_references_after_parsing.call(this,t);if(this.macro_derivation)this.macro_derivation=t[this.macro_derivation]};t.prototype.derivationApplicableAsMacro=function(t){if(t.rows.length<2)return false;var e=0;t.rows[0].model.get_child([0]).for_each(function(t){if(t instanceof h)e++});return e>0};t.prototype.rebind=function(t,e,i){if(this.nodes[0]===i){this.nodes[0]=t;this.nodes[1]=this.macro_derivation.getLastModel()}else if(this.oldTree===i){var n=new Action;n.node_map=e;this.oldTree=t;var r=n.mapNodes(this.target.get_child([0]));if(r[0])this.target=n.mapNodes(this.target.get_child([0]))[0].get_parent(1);else this.target=[]}else throw"wrong old tree during rebinding an action!"};t.prototype.rematch=function(){if(!(this.nodes&&this.nodes.length>0&&this.target))return false;if(!this.nodes[0])return;var t;var e=this.getAllAvailableActions(this.nodes,this.target);e.forEach(function(e){t=e.target});return this.target===t};t.prototype.getAllAvailableActions=function(t,e){if(t.length!==2)return[];if(t[0].parent||t[1].parent||e.parent)return[];if(Object.keys(this.getMatches(t[0],e)).length)return[this.createBoundAction(e.get_root(),{nodes:t,target:e})];return[]};t.prototype.getMatches=function(t,e){var i=this.createSimpleModel(t);var n=e.clone();this.normalizeModel(n);var r=new AlgebraRegExp,o={};var s=r.match_tree(n.get_child([0]),i.get_child([0]),o);return s?o:{}};t.prototype.normalizeModel=function(t){t.for_each(function(t){if(t.is_group("sub")){var e=t.get_child([1]);if(e.is_group("product"))e=e.get_child([0,1]);var i=e.parent;e.remove();var n=new f(e);n.normalized=true;i.append(n);t.invert()}})};t.prototype.createSimpleModel=function(t){var e=t.clone();e.for_each(function(t){if(t instanceof h){var e=new gmath.expressions.placeholder("any");e.match_name=t.value;t.replace_with(e)}});return e};t.prototype.bindMacroDerivation=function(t){this.macro_derivation=t};t.prototype.transform=function(t){var e=this.getNewTreeNode(this.target),i=this.getMatches(this.nodes[0],this.target);var n=new r(this.nodes[1].to_ascii());e.get_child([0]).replace_with(n.get_child([0]));var o=Object.keys(i);e.get_child([0]).for_each(function(t){for(var e=0;e<o.length;e++){if(t.to_ascii()===o[e]){var n=i[o[e]].clone();if(i[o[e]].normalized)n.normalized=true;t.replace_with(n);c.handle(n);break}}});this.revertNormalizations(e);this.applyNodeMappings(this.nodes[0],this.nodes[1],this.target,e);if(typeof t==="function")t(this);return true};t.prototype.revertNormalizations=function(t){t.for_each(function(t){if(t.normalized){delete t.normalized;var e=t.parent;if(e&&e.is_group("mul","div")&&(!e.ls||e.ls.value==="//")&&e.parent.parent&&e.parent.parent.is_group("add","sub")){t.replace_with(t.get_child([1]));e.parent.parent.invert()}if(e&&e.is_group("add","sub")){t.replace_with(t.get_child([1]));e.invert()}}})};t.prototype.applyNodeMappings=function(t,e,i,n){if(!this.macro_derivation)return;var r=this.macro_derivation.getRowByModel(t),o=this.macro_derivation.getRowByModel(e);var s=this.macro_derivation.get_combined_action(r,o);var a=this.createNodeMapFromMacroToTarget(t,i),l=this.createNodeMapFromMacroToTarget(e,n);t.get_child([0]).for_each(function(t){var e=a[t.id],i=s.node_map[t.id];i.forEach(function(t){var i=l[t.id];if(i)e.forEach(function(t,e){this.extendNodeMap(t,i[e])},this)},this)}.bind(this))};t.prototype.createNodeMapFromMacroToTarget=function(t,e){var i={};t.get_child([0]).for_each(function(t){var n=e.get_child(t.get_path());if(t.has_children()&&n.has_children())i[t.id]=[n];else i[t.id]=this.flattenTree(n)}.bind(this));return i};t.prototype.flattenTree=function(t){var e=[];t.for_each(function(t){e.push(t)});return e};return new t}();gmath.actions.PostInteractionSimplificationAction=function(){var t=function(t){Action.call(this,"PostInteractionSimplificationAction","simplify terms after interaction");this.priority=0;this.triggerType="auto";this.settings={simplify_products:true,simplify_variables:true,simplify_sums:true};if(t){this.nodes=t.nodes;if("auto_simplify_distributions"in t)this.settings.simplify_products=t.auto_simplify_distributions;if("auto_simplify_variables"in t)this.settings.simplify_variables=t.auto_simplify_variables;if("auto_simplify_vector_additions"in t)this.settings.simplify_sums=t.auto_simplify_vector_additions}};gmath.inherit(Action,t);t.prototype.match=function(t){return true};t.prototype.rematch=function(){return true};t.prototype.transform=function(t){this.changed=false;var e=this.getNewTreeNode(this.nodes);for(var i=0;i<e.length;i++){var n=this.mapNodes(this.nodes[i])[0];if(!n)continue;var o=n.parent;if(n.is_group("brackets")){if(c.handle(n,true))this.changed=true;if(this.cleanup_cascade(o))this.changed=true}else if(this.prodFracContainingAMulZero(n)&&this.settings.simplify_variables){var s=gmath.find(n.get_top(),function(t){var e=t.get_child([1]);return a.is_num(e)&&a.get_value(e)===0});n.get_top().filter(function(t){return t!==s}).concat(n.get_bottom().filter(function(t){return a.get_value(t.get_child([1]))!==0})).forEach(function(t){t.remove()});if(o.is_group("add","sub")){var l=o.parent;o.remove();this.cleanup(l)}this.changed=true}else if(n.is_group("product")&&this.settings.simplify_products||n.is_group("sum")&&this.settings.simplify_sums){var h=this.getNumberOperatorsFromGroup(n);if(h.length>1){var p=n.is_group("product")?gmath.actions.MultiplyNumbersAction:gmath.actions.AddSubNumbersAction;this.applyOperators(h,p);if(n.is_group("product"))this.applyNegatives(o);this.changed=true}}else if(this.muldiv1(n)||this.addsub0(n)){var u=o.parent;this.updateNodeMap(this.nodes[i].select_all(),n.ls||n.rs);n.remove();this.cleanup(o);this.cleanup(u);if(!r.is_top_most(u))c.handle(u,true);this.changed=true}else if(this.muldivNeg1(n)){var u=o.parent;var d=n.children[1];d.remove();var f=d.children[1];this.updateNodeMap(this.nodes[i],n.ls||n.rs);this.updateNodeMap(this.nodes[i].children[1].children[1].get_mapping_to(n.ls||n.rs));var g=n.ls||n.rs;f.remove();var m=g.children[1];if(m.is_group("sign")){m.remove();m=m.children[1];m.remove();g.append(m)}else{m.remove();d.append(m);g.append(d)}n.remove();this.cleanup(o);this.cleanup(u);if(!r.is_top_most(u))c.handle(u,true);this.changed=true}else if(this.exp1(n)){var v=n.parent,_=v.children[0],o=v.parent,y=v.remove();_.remove();o.insert(y,_);this.changed=true}if(this.changed)this.removeDeletedNodesFromNodeMap()}if(typeof t==="function")t(this);else return this.changed};t.prototype.getNumberOperatorsFromGroup=function(t){var e=[];for(var i=0;i<t.children.length;i++){var n=t.children[i];if(a.is_num(n.children[1]))e.push(n)}return e};t.prototype.applyOperators=function(t,e){var i=t[0],n=t.slice(1);for(var r=0;r<n.length;r++){i=this.runAction(e,i,n[r])}};t.prototype.runAction=function(t,e,i){var n=t.createBoundAction(this.newTree,{target:e,nodes:[i],triggerType:"drag"});n.doInPlace();this.compose(n,false);return n.mapNodes([e])[0]};t.prototype.applyNegatives=function(t){var e=["PlusMinusProductToMinusProductAction","AddNegativeAction"];for(var i=0;i<e.length;i++){var n=gmath.actions[e[i]];if(n.match(t)){this.compose(n.createAndDoInPlace(this.newTree,{actor:t}),false);return}}};t.prototype.muldiv1=function(t){return a.is_equal_to(t.children[1],1)&&(t.is_group("div")||t.is_group("mul")&&!(t.parent.is_group("fraction")&&t.parent.get_top().length===1))};t.prototype.muldivNeg1=function(t){return t.is_group("mul","div")&&a.is_num(t.children[1])&&a.get_value(t.children[1])===-1};t.prototype.addsub0=function(t){return t.is_group("add","sub")&&a.is_num(t.children[1])&&a.get_value(t.children[1])===0};t.prototype.prodFracContainingAMulZero=function(t){return t.is_group("product","fraction")&&t.get_top().some(function(t){var e=t.get_child([1]);return a.is_num(e)&&a.get_value(e)===0})};t.prototype.getSumAncestor=function(t){var e=t.parent;while(e&&!e.is_group("sum")){e=e.parent}return e};t.prototype.exp1=function(t){return t.is_group("exponent")&&a.is_num(t.children[0])&&a.get_value(t.children[0])===1};return new t}();gmath.actions.AddSubNumbersAction=function(){var t=function(t){Action.call(this,"AddSubNumbersAction","add or subtract numbers");this.priority=1;this.triggerType="tap";this.settings={is_join_action:true,delay:300,side:"inside",margin:{x:.1}};if(t){if(t.nodes){this.triggerType="drag";this.nodes=t.nodes;this.target=t.target}else{this.actor=t.actor}}};gmath.inherit(Action,t);t.prototype.getAllAvailableActions=function(t){if(t.length>1)return[];if(!t[0].is_group("add","sub"))return[];if(!a.is_num(t[0].children[1]))return[];var e=this.getOtherNumberAddendsInSum(t[0]);return this.bindActionForEachTarget(t,e)};t.prototype.getOtherNumberAddendsInSum=function(t){var e=t.parent;var i=e.filter(function(i){return i!==t&&i.is_group("add","sub")&&a.is_num(i.children[1])&&i.parent===e});return i};t.prototype.match=function(t){if(!t.parent.is_group("sum"))return false;if(!t.ls)return false;var e=t.ls.children[1],i=t.children[1];return a.is_num(e)&&!(e.is_group("sign")&&e.parent.is_group("sub"))&&a.is_num(i)&&!(i.is_group("sign")&&i.parent.is_group("sub"))};t.prototype.transform=function(t){if(this.triggerType==="drag"){this.sourceAddend=this.nodes[0];this.targetAddend=this.target}else{this.sourceAddend=this.actor;this.targetAddend=this.actor.ls}this.addTouchedNodes(this.sourceAddend);this.addTouchedNodes(this.targetAddend);var e=this.getNewTreeNode(this.sourceAddend),i=this.getNewTreeNode(this.targetAddend),n=e.parent;var r=e.children[1],o=i.children[1];var s=(e.is_group("sub")?-1:1)*a.get_value(r)+(i.is_group("sub")?-1:1)*a.get_value(o);var l=i.is_group("add")&&i.children[1].is_group("sign");var h=new m(new a(s),l?"add":"auto");this.updateNodeMap(this.sourceAddend,h);this.updateNodeMap(this.sourceAddend.children[0],h.children[0]);this.updateNodeMap(this.sourceAddend.children[1].get_mapping_to(h.children[1]));this.updateNodeMap(this.targetAddend,h);this.updateNodeMap(this.targetAddend.children[0],h.children[0]);this.updateNodeMap(this.targetAddend.children[1].get_mapping_to(h.children[1]));var p=i.remove();n.insert(p,h);e.remove();this.cleanup(n);if(typeof t==="function")t(this);return this};m.prototype.add_action_handler(new t);return new t}();r.prototype.move_actions.push(gmath.actions.AddSubNumbersAction);(function(){var e=function(t){Action.call(this,"SumCleanupAction","sum cleanup action");if(t)this.actor=t.actor};gmath.inherit(Action,e);gmath.actions.SumCleanupAction=e;e.prototype.match=function(t){return t.is_group("sum")&&t.children.length<=1};e.prototype.doInPlace=function(e){this.initNodeMap();var i=this.getNewTreeNode(this.actor);if(i.children.length===0){t.remove(i)}else if(i.children.length===1){var n=i.children[0],r=this.actor.children[0],o;if(n.is_group("add")){o=n.children[1];this.updateNodeMap(r.children[0],o)}else if(n.is_group("sub","addsub")){var s=n.is_group("addsub");if(n.children[1].is_group("product")){var a=n.children[1].children[0].children[1],l=a.parent;a.remove();var h=new f(a,s);l.append(h);o=n.children[1]}else{o=new f(n.children[1],s)}this.updateNodeMap(r.children[0],o.children[0])}this.updateNodeMap(r,o);this.updateNodeMap(r.parent,o);t.replace(n.parent,o);if(o.parent&&o.parent.is_group("brackets"))c.handle(o.parent,true);else c.handle(o)}if(typeof e==="function")e(this);else return this};g.prototype.cleanupAction=new e})();gmath.actions.AssociateIntoFractionAction=function(){var e=function(t){Action.call(this,"AssociateIntoFractionAction","associative property of multiplication--move into fraction");this.priority=0;this.triggerType="tap";this.settings={};if(t){if(t.actor)t=this.getSettingsFromActor(t.actor);this.triggerType="drag";this.nodes=t.nodes;this.target=t.target;this.settings.side=t.side;if(t.triggerType)this.triggerType=t.triggerType;if(t.margin)this.settings.margin=t.margin}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){if(!this.matchStructure(t))return[];var e=this.findTargets(t);var i=e.filter(function(t){return this.matchTarget(t)},this);return this.bindActions(t,i)};e.prototype.matchStructure=function(e){if(e.length===0)return false;if(!t.is_range(e))return false;if(!e[0].is_group("mul","div"))return false;return true};e.prototype.findTargets=function(t){var e=t[0].get_parent(1),i=[];var n=e.children[0];while(n.value!==t[0].value)n=n.rs;while(n!==t[0]){i.push(n);n=n.rs}n=e.children[e.children.length-1];while(n.value!==t[0].value)n=n.ls;while(n!==t[t.length-1]){i.push(n);n=n.ls}return i};e.prototype.matchTarget=function(t,e){if(e)return t.value===e.value&&t.get_child([1]).is_group("fraction");return t.get_child([1]).is_group("fraction")};e.prototype.bindActions=function(t,e){var i=[];var n=t[0].get_root();e.forEach(function(e){var r=e.get_child([1]).get_top(),o=r.length-1;r.forEach(function(e,r){i.push(this.createBoundAction(n,{nodes:t,target:e,side:"left-of",triggerType:"drag"}));if(r===o){i.push(this.createBoundAction(n,{nodes:t,target:e,side:"right-of",triggerType:"drag"}))}},this)},this);return i};e.prototype.getSettingsFromActor=function(t){var e,i,n;if(t&&t.ls&&t.children[1]&&t.children[1].is_group("fraction")){e=t.children[1].children[0];i=[t.ls];n="left-of"}else if(t&&t.ls&&t.ls.children[1]&&t.ls.children[1].is_group("fraction")){var r=t.ls.children[1];var o=r.get_top();e=o[o.length-1];i=[t];n="right-of"}return{target:e,nodes:i,side:n}};e.prototype.match=function(e,i,n){if(arguments.length==1){var r=this.getSettingsFromActor(e);e=r.nodes;i=r.target;n=r.side}if(!e||e.length==0)return false;if(!n)return false;if(!i||!i.is_group("mul","div")||!i.parent.is_group("fraction"))return false;var o=i.parent.parent.value;if(!i.parent.parent||i.parent.parent.parent!==e[0].parent)return false;if(!e.every(function(t){return t.is_group(o)&&t.children[1]!==i.parent}))return false;if(!t.is_range(e))return false;return true};e.prototype.transform=function(e){this.addTouchedNodes(this.nodes);this.addTouchedNodes(this.target);var i=this.getNewTreeNode(this.nodes),n=this.getNewTreeNode(this.target);var r=n.parent,o=r.children.indexOf(n);if(this.settings.side==="right-of")o++;if(r.get_top().length===1&&a.get_value(r.get_child([0,1]))===1)r.get_child([0]).simplify=true;t.remove_range(i);if(i[0].is_group("div"))i.forEach(function(t){t.invert()});r.insert_range(o,i);this.cleanup_cascade(r.parent);if(typeof e==="function")e(this);else return true};_.prototype.add_action_handler(new e);return new e}();r.prototype.move_actions.push(gmath.actions.AssociateIntoFractionAction);gmath.actions.AssociateOutOfFractionAction=function(){var e=function(t){Action.call(this,"AssociateOutOfFractionAction","associative property of multiplication--move out of fraction");this.priority=0;this.triggerType="drag";this.settings={};if(t){this.nodes=t.nodes;this.target=t.target;this.settings.side=Array.isArray(this.target)?"around":t.side;this.settings.target_is_left=t.side==="left-of";this.settings.margin=t.side==="right-of"?{x1:.25,x2:-.25}:{x1:-.25,x2:.25}}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){if(t.length===0)return[];var e=t[0];if(!e.is_group("mul")||!e.parent.is_group("fraction"))return[];if(this.match(t,e.parent)){return[this.bindAction(t,"left-of"),this.bindAction(t,"right-of")]}return[]};e.prototype.bindAction=function(t,e){var i=t[0].get_root();var n=[];if(this.fractionIsPartOfProduct(t)){n=this.getSiblingsOfFraction(t,e)}return this.createBoundAction(i,{nodes:t,target:n.length>0?n:t[0].parent,side:e})};e.prototype.fractionIsPartOfProduct=function(t){var e=t[0].parent;return e.parent&&e.parent.is_group("mul")};e.prototype.getSiblingsOfFraction=function(t,e){var i=t[0].parent,n=i.parent,r=n.parent;if(e==="left-of")return r.children.slice(0,r.children.indexOf(n));else return r.children.slice(r.children.indexOf(n)+1)};e.prototype.match=function(e,i){if(e.length===0)return false;if(e.length===1&&e[0].children[1].value===1)return false;if(!this.allNodesAreMuls(e)||!t.is_range(e))return false;return e[0]&&e[0].parent===i&&i.is_group("fraction")};e.prototype.allNodesAreMuls=function(t){for(var e=0;e<t.length;e++){if(!t[e].is_group("mul"))return false}return true};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.nodes);var n=this.settings.target_is_left;t.remove_range(i);var r=i[0].parent;var o=new v;r.replace_with(o);o.append(new _(r));o.insert_range(n?0:1,i);this.cleanup(r);this.cleanup(o.parent);if(typeof e==="function")e(this);else return true};return new e}();r.prototype.move_actions.push(gmath.actions.AssociateOutOfFractionAction);gmath.actions.AssociateOutOfDenominatorAction=function(){var e=function(t){Action.call(this,"AssociateOutOfDenominatorAction","associative property of division--move out of fraction denominator");this.triggerType="drag";this.settings={};if(t){this.nodes=t.nodes;this.target=t.target;this.settings.side=t.side;this.settings.margin=t.side==="right-of"?{x1:.25,x2:-.25}:{x1:-.25,x2:.25};if(t.margin)this.settings.margin=t.margin}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(e){var i=this;if(e.length===0)return[];if(!t.is_range(e))return[];var n=e[0].parent;if(!n.is_group("fraction"))return[];var r=n.get_top();var o=n.get_bottom();if(r.length===1&&a.get_value(r[0].children[1])===1&&e.length===o.length)return[];if(!e.every(function(t){return i.match(t,n)}))return[];return this.bindActions(e)};e.prototype.match=function(t,e){if(!t.is_group("div"))return false;if(a.get_value(t.children[1])===-1||a.get_value(t.children[1])===1)return false;if(e&&t.parent!==e)return false;return true};e.prototype.bindActions=function(t){var e=this;var i=t[0].get_root(),n=t[0].parent;return[this.createBoundAction(i,{nodes:t,side:"left-of",target:n}),this.createBoundAction(i,{nodes:t,side:"right-of",target:n})]};e.prototype.transform=function(e){this.addTouchedNodes(this.nodes[0].parent);var i=this.settings.side;if(i==="outside")this.target=this.nodes[0].parent;var n=this.getNewTreeNode(this.nodes),r=n[0].parent,o=this.getNewTreeNode(this.target);t.remove_range(n);var s=this.makeNewTerms(n),a=this.replaceTargetWithProductContainingTargetAndTerms(o,s,i);s.forEach(function(t){this.cleanup(t)},this);this.cleanupSourceFraction(r);this.cleanup(a.product.get_parent(1));this.setNodesToReselectAfterAction(a.range);if(typeof e==="function")e(this);else return this};e.prototype.makeNewTerms=function(t){var e=[];var i=t.filter(function(t){return!t.get_child([1]).is_group("fraction")}),n=t.filter(function(t){return t.get_child([1]).is_group("fraction")});if(i.length)e.push(this.putDivsInNewFraction(i));n.forEach(function(t){var i=t.get_child([1]);i.remove();e.push(this.convertToReciprocal(i))},this);return e};e.prototype.convertToReciprocal=function(e){var i=e.get_top(),n=e.get_bottom();t.remove_range(i);t.remove_range(n);function r(t){t.forEach(function(t){t.invert();e.append(t)})}if(i.length===1&&a.get_value(i[0].children[1])===1&&n.length===1){var o=n[0].get_child([1]);o.remove();return o}else{r(i);r(n)}return e};e.prototype.putDivsInNewFraction=function(t){var e=new v;e.append(new _(new a(1)));t.forEach(function(t){e.append(t)});return e};e.prototype.replaceTargetWithProductContainingTargetAndTerms=function(t,e,i){var n=new v;var r=t.is_group("mul")?t.children[1]:t;r.replace_with(n);n.append(new _(r));var o=e.map(function(t){return new _(t)});if(i==="left-of")o.forEach(function(t){n.insert(0,t)});else o.forEach(function(t){n.append(t)});return{product:n,range:o}};e.prototype.cleanupSourceFraction=function(t){var e=t.parent;this.cleanup(t);this.cleanup(e)};return new e}();r.prototype.move_actions.push(gmath.actions.AssociateOutOfDenominatorAction);gmath.actions.AssociateIntoDenominatorAction=function(){var e=function(t){Action.call(this,"AssociateIntoDenominatorAction","associative property of denominator--move into denominator");this.priority=0;this.triggerType="drag";this.settings={};if(t){this.nodes=t.nodes;this.target=t.target;this.settings.side=t.side}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){var e=this.matchSource(t);if(!e)return[];var i=this.getTargets(e);return this.bindActionsForEachTarget(t,i)};e.prototype.matchSource=function(e){if(!t.is_range(e))return false;var i=e[0].get_parent(1);if(!i.is_group("fraction")||!i.get_parent(1).is_group("mul","div"))return false;if(!e.every(function(t){return t.is_group("div")}))return false;return{nodes:e,frac:i,op:i.get_parent(1),group:i.get_parent(2)}};e.prototype.getTargets=function(t){var e=t.group.children.filter(function(e){return e!==t.op&&e.is_group(t.op.value)});return e.map(function(t){return t.get_child([1])})};e.prototype.bindActionsForEachTarget=function(t,e){var i=[];var n=t[0].get_root();e.forEach(function(e){if(e.is_group("fraction"))i=i.concat(this.bindActionForEachTarget(t,e.get_bottom(),true));else i.push(this.createBoundAction(n,{nodes:t,target:e,side:"inside"}))},this);return i};e.prototype.transform=function(e){var i=this;this.nodes.map(this.addTouchedNodes.bind(i));this.addTouchedNodes(this.target);var n=this.settings.side;var r=this.getNewTreeNode(this.nodes),o=r[0].parent,s=this.getNewTreeNode(this.target);t.remove_range(r);this.insertDivsInNewLocation(r,s,n);this.cleanupSourceFraction(o);if(typeof e==="function")e(this);else return this};e.prototype.insertDivsInNewLocation=function(t,e,i){if(e.is_group("div")){this.insertDivRangeIntoDenominator(t,e,i)}else{this.replaceTargetWithFractionContainingTargetAndDivs(t,e)}};e.prototype.insertDivRangeIntoDenominator=function(t,e,i){var n=e.parent;n.insert_range(n.children.indexOf(e)+(i==="left-of"?0:1),t)};e.prototype.replaceTargetWithFractionContainingTargetAndDivs=function(t,e){var i=e.parent,n=new v;e.replace_with(n);n.append(new _(e));t.forEach(function(t){n.append(t)})};e.prototype.cleanupSourceFraction=function(t){var e=t.parent,i=e.parent;this.cleanup(t);var n=this.cleanup(e);if(!n&&a.is_num(e.children[1])&&a.get_value(e.children[1])===1){e.remove();this.cleanup(i)}};return new e}();r.prototype.move_actions.push(gmath.actions.AssociateIntoDenominatorAction);(function(){var e=function(t){Action.call(this,"AddSubBracketsAction","add or subtract a bracketed sum");this.priority=4;this.triggerType="tap";if(t)this.actor=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){if(!t.is_group("add")&&!t.is_group("sub"))return false;if(!t.children[1].is_group("brackets"))return false;return t.children[1].children[1].is_group("sum")||c.is_optional(t.children[1])};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.actor);var n=this.actor.children[0];this.addTouchedNodes(this.actor);var r=i.children[1];var o=i.children[1].children[1];t.replace(r,o);if(i.is_group("sub")&&o.is_group("sum")){i.invert();var s=[];for(var a=0;a<o.children.length;a++){o.children[a].invert();s.push(o.children[a].children[0])}this.updateNodeMap(n,s)}this.cleanup(i);if(typeof e==="function")e(this);else return this};m.prototype.add_action_handler(new e)})();(function(){var e=function(t){Action.call(this,"AddSubCleanUp","addsub cleanup action");if(t)this.addsub=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){return t.is_group("add","sub")&&t.children[1].is_group("sum")};e.prototype.doInPlace=function(e){this.initNodeMap();var i=this.getNewTreeNode(this.addsub);if(i.is_group("add","sub")&&i.children[1].is_group("sum")){var n=i.is_group("sub");var r=i.parent;var o=i.children[1],s=this.addsub.children[1];this.updateNodeMap(this.addsub,r);this.updateNodeMap(s,o.children);var a=t.remove(i);if(n)for(var l=0;l<o.children.length;l++)o.children[l].invert();r.insert_range(a,o.children)}if(typeof e==="function")e(this);else return this};m.prototype.cleanupAction=new e})();gmath.actions.AddVariablesAction=function(){var e=function(t){Action.call(this,"AddVariablesAction","add variables");this.priority=1;this.triggerType="tap";this.settings={is_join_action:true,delay:300,side:"inside",margin:{x:.1}};if(t){if(t.triggerType==="drag"){this.triggerType=t.triggerType;this.nodes=t.nodes;this.target=t.target}else{this.actor=t.actor}}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(e){if(e.length>1)return[];var n=e[0];if(!n.is_group("add","sub"))return[];var r=n.parent;var s=this.analyzeAddendStructure(n);if(s.range.length<1)return[];var a=this.prepareRangeForSearch(s.range),l;if(a.length<1)return[];l=t.filterRange(u(i(a)),r);l=l.concat(t.filter(c(o(a)),r));l=l.filter(d(n));l=l.filter(f(a));return this.bindActionForEachTarget(e,l)};e.prototype.match=function(e){if(!e.ls)return false;var n=e;if(!n.is_group("add","sub"))return false;var r=this.analyzeAddendStructure(n);if(r.range.length<1)return false;var s=this.prepareRangeForSearch(r.range),a;if(s.length<1)return false;a=t.filterRange(u(i(s)),n.ls);a=a.concat(t.filter(c(o(s)),n.ls));if(a.length!==1)return false;a=a.filter(d(n));a=a.filter(f(s));if(a.length!==1)return false;return true};e.prototype.prepareRangeForSearch=function(e){if(!Array.isArray(e))return[new _(t.clone(e))];else return e};e.prototype.analyzeAddendStructure=function(t){var e=t.children[1];if(h.is_var(e)||e.is_group("brackets"))return{range:e,coefficientLocation:"none"};else if(e.is_group("product"))return this.analyzeProductStructure(e);else return{range:[]}};e.prototype.analyzeProductStructure=function(t){var e=[t.children[0].children[1],t.children[t.children.length-1].children[1]];var i;if(a.is_num(e[0])&&a.is_num(e[1]))return{range:[]};else if(!a.is_num(e[0])&&!a.is_num(e[1])){i="none"}else{i=a.is_num(e[0])?"front":"back"}var n,r;if(i==="none"){n=0;r=t.children.length}else if(i==="front"){n=1;r=t.children.length}else{n=0;r=t.children.length-1}var o=[];for(var s=n;s<r;s++){var l=t.children[s].children[1];if(h.is_var(l)||l.is_group("brackets")||l.is_group("sign")&&h.is_var(l.children[1]))o.push(l.parent);else return{range:[]}}return{range:o,coefficientLocation:i}};e.prototype.bindActionForEachTarget=function(t,e){var i=[];var n=t[0].get_root();for(var r=0;r<e.length;r++){var o={};o.triggerType="drag";o.nodes=t;var s=e[r];if(!Array.isArray(s)){o.target=s.parent}else{o.target=s[0].parent.parent;o.range=s}i.push(this.createBoundAction(n,o))}return i};e.prototype.transform=function(t){var e=this;if(this.triggerType==="drag"){this.sourceAddend=this.nodes[0];this.targetAddend=this.target}else{this.sourceAddend=this.actor;this.targetAddend=this.actor.ls}this.addTouchedNodes(this.sourceAddend);this.addTouchedNodes(this.targetAddend);var i=this.analyzeAddendStructure(this.sourceAddend),n=this.analyzeAddendStructure(this.targetAddend);i.addend=this.sourceAddend;n.addend=this.targetAddend;var r=this.getNewTreeNode(this.sourceAddend),o=this.getNewTreeNode(this.targetAddend),s=r.parent;var l=r.children[1],h=o.children[1];if(i.coefficientLocation==="none"){l=this.reinterpretTermAsProductWithCoefficientOfOne(l)}if(n.coefficientLocation==="none"){h=this.reinterpretTermAsProductWithCoefficientOfOne(h)}if(o.parent.children.indexOf(o)===0&&n.coefficientLocation==="none"&&h.children[1].children[1].is_group("sign")){this.absorbNegativeIntoAddend(o)}var p=this.splitProduct(l),u=this.splitProduct(h);var c=p.coefficient*(r.is_group("sub")?-1:1)+u.coefficient*(o.is_group("sub")?-1:1);var d=_.prototype.createGroup();d.append(new _(new a(Math.abs(c))));d.append_range(p.variables);var f=c<0?new m(d,"sub"):new m(d,"add");var g=o.remove();s.insert(g,f);r.remove();var v={parentOfSum:f.parent.parent,idxOfSum:f.parent.parent.children.indexOf(f.parent),resultingAddend:f,idxOfResultingAddend:f.parent.children.indexOf(f),resultingProduct:d};if(Math.abs(c)===1){d.children[0].simplify=true}d.simplify=true;this.mapOldStructureToNewStructure(i,v);this.mapOldStructureToNewStructure(n,v);this.cleanup_cascade(f.parent);if(typeof t==="function")t(this);return true};e.prototype.reinterpretTermAsProductWithCoefficientOfOne=function(t){if(!t.is_group("product")){var e=t.parent;t.remove();var i=_.prototype.createGroup();i.append(new _(new a(1)));i.append(new _(t));e.append(i);return i}else{t.insert(0,new _(new a(1)));return t}};e.prototype.splitProduct=function(e){var i=this.findIndexOfCoefficient(e);var n,r;if(i===0){n=a.get_value(e.children[i].children[1]);r=t.clone(e.children.slice(1))}else{n=a.get_value(e.children[i].children[1]);r=t.clone(e.children.slice(0,i))}return{coefficient:n,variables:r}};e.prototype.findIndexOfCoefficient=function(t){var e=t.children;for(var i=0;i<e.length;i++){if(a.is_num(e[i].children[1]))return i}};e.prototype.absorbNegativeIntoAddend=function(t){var e=t.children[1].children[1].children[1];var i=e.parent,n=e.remove();var r=e.children[1];r.remove();i.insert(n,r);t.invert()};e.prototype.mapOldStructureToNewStructure=function(t,e){var i=e.parentOfSum.children[e.idxOfSum],n;if(i.is_group("sum")){n=i.children[e.idxOfResultingAddend]}else{n=i}if(a.is_num(n)){this.updateNodeMap(t.addend.get_mapping_to(n))}else{this.mapAddendGroup(t.addend,n);var r=this.mapNegatives(t.addend,t.coefficientLocation,n);this.mapCoefficients(t.addend,t.coefficientLocation,n);this.mapVariables(t.range,n,r)}};e.prototype.mapAddendGroup=function(t,e){if(e.is_group("add","sub")){this.updateNodeMap(t,e);this.updateNodeMap(t.children[0],e.children[0])}};e.prototype.mapNegatives=function(t,e,i){if(!i.is_group("add","sub","sign","product")){return}var n,r;if(t.is_group("sub")){n=t.children[0]}var o;var s=e==="front"||e==="none"&&t.children[1].children[0]?t.children[1].children[0]:t.children[1].children[t.children[1].children.length-1];if(s&&s.children[1]&&s.children[1].is_group("sign")){r=s.children[1].children[0];o=e==="none"}if(n&&r||!n&&!r){return}if(i.is_group("sub")&&r){this.updateNodeMap(r,i.children[0]);return}if(i.is_group("sign")){if(n){this.updateNodeMap(n,i.children[0])}if(r){this.updateNodeMap(r,i.children[0])}return}if(i.is_group("add")){i=i.children[1]}if(i.is_group("product")&&i.children[0].children[1].is_group("sign")){var a=i.children[0].children[1].children[0];if(n){this.updateNodeMap(n,a)}if(r){this.updateNodeMap(r.parent,a.parent);this.updateNodeMap(r,a)}return o}};e.prototype.mapCoefficients=function(t,e,i){var n,r,o,s;if(e==="none"){return}if(e==="front"){n=t.children[1].children[0]}else if(e==="back"){n=t.children[1].children[t.children[1].children.length-1]}r=n.children[1];if(r.is_group("sign")){r=r.children[1]}if(i.is_group("add","sub")){i=i.children[1]}if(i.is_group("product")){if(a.is_num(i.children[0].children[1])){o=i.children[0];s=i.children[0].children[1]}else{return}if(s.is_group("sign")){s=s.children[1]}}else{return}this.updateNodeMap(n,o);this.updateNodeMap(r,s)};e.prototype.mapVariables=function(t,e,i){if(e.is_group("add","sub")){e=e.children[1]}if(e.is_group("product")){var n=a.is_num(e.children[0].children[1])?e.children.slice(1):e.children.slice();
if(Array.isArray(t)){for(var r=0;r<t.length;r++){var o=r===0&&i?t[r].children[1].children[1]:t[r].children[1];var s=n[r].children[1].is_group("sign")?n[r].children[1].children[1]:n[r].children[1];this.updateNodeMap(t[r],n[r]);this.updateNodeMap(t[r].children[0],n[r].children[0]);this.updateNodeMap(o.get_mapping_to(s))}}else{var s=n[0].children[1].is_group("sign")?n[0].children[1].children[1]:n[0].children[1];this.updateNodeMap(t.get_mapping_to(s))}}else{var o=Array.isArray(t)?t[0]:t;this.updateNodeMap(o.get_mapping_to(e.is_group("sign")?e.children[1]:e))}};e.prototype.reselectNodes=function(t){if(!t.parentOfSum.children[t.idxOfSum].is_group("sum")){if(t.parentOfSum.children[t.idxOfSum].is_group("add","sub")){this.setNodesToReselectAfterAction(t.parentOfSum.children[t.idxOfSum])}else{var e=t.resultingProduct.children;if(e[0].parent===t.resultingProduct){this.setNodesToReselectAfterAction(t.resultingProduct)}else{this.setNodesToReselectAfterAction(e)}}}};function i(t){return t.map(function(t){return t.to_ascii()}).join("")}function n(t){return t.is_group()&&t.commutative&&t.associative}function r(t){if(t.length===0)return"";var e=t.map(function(t){return t.to_ascii()}).join("");if(t.length===1)return e;if(n(t[0]))return e.substring(t[0].children[0].to_ascii().length);return e}function o(t){if(t.length===0)return"";var e=t.map(function(t){return t.to_ascii()}).join("");if(n(t[0]))return e.substring(t[0].children[0].to_ascii().length);return e}function s(t){if(t.is_group("product")&&t.children[0].children[1].is_group("sign")){return t.children[0].children[1].children[1].to_ascii()+t.children.slice(1).map(function(t){return t.to_ascii()}).join("")}return""}function l(t){return t.length===t[0].parent.children.length}function p(t){return t.parent}function u(t){return function(e){if(e.length===0)return false;if(!e[0].parent)return false;if(p(e[0].parent)&&l(e))return false;return i(e)===t||r(e)===t}}function c(t){return function(e){if(!e.parent)return false;if(!e.parent.is_group("add")&&!e.parent.is_group("sub"))return false;return e.to_ascii()===t||s(e)===t}}function d(e){var i=e.parent;return function(n){var r,o;try{if(Array.isArray(n)){r=t.get_parent(3,n[0]);o=t.get_parent(2,n[0])}else{r=t.get_parent(2,n);o=t.get_parent(1,n)}if(!i.is_group("sum")||!r.is_group("sum")||i!==r||o===e)return false}catch(t){if(t==="invalid path")return false;throw t}return true}}function f(t){return function(t){if(!Array.isArray(t))return true;var e=t[0].parent;if(e.children.length!==t.length+1)return false;for(var i=0;i<e.children.length;i++){var n=e.children[i];if(t.indexOf(n)===-1&&!a.is_num(n.children[1]))return false}return true}}m.prototype.add_action_handler(new e);return new e}();r.prototype.move_actions.push(gmath.actions.AddVariablesAction);gmath.actions.AddSubTupleAction=function(){var e=function(t){Action.call(this,"AddSubTupleAction","add or subtract tuples");this.priority=1;this.triggerType="tap";this.settings={is_join_action:true,delay:300,side:"inside",margin:{x:.1}};if(t){if(t.nodes){this.triggerType="drag";this.nodes=t.nodes;this.target=t.target}else{this.actor=t.actor}}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){if(t.length!==1)return[];var e=t[0];if(!this.isTupleAddend(e))return[];var i=this.getOtherTupleAddendsInSum(e);return this.bindActionForEachTarget(t,i)};e.prototype.isTupleAddend=function(t,e){return t.is_group("add","sub")&&t.children[1].is_group("brackets")&&t.children[1].children[1].is_group("tuple")&&(!e||t.children[1].children[1].children.length===e)};e.prototype.getTupleAddendLen=function(t){return t.children[1].children[1].children.length};e.prototype.getOtherTupleAddendsInSum=function(t){var e=t.parent,i=t.children[1].children[1].children.length;var n=e.children.filter(function(e){return e!==t&&this.isTupleAddend(e,i)},this);return n};e.prototype.match=function(t){return this.isTupleAddend(t)&&t.ls&&this.isTupleAddend(t.ls,this.getTupleAddendLen(t))};e.prototype.transform=function(t){var e,i;if(this.triggerType==="drag"){e=this.nodes[0];i=this.target}else{e=this.actor.ls;i=this.actor}this.addTouchedNodes(e);this.addTouchedNodes(i);var n=e.get_idx()<i.get_idx(),r=this.getNewTreeNode(e),o=this.getNewTreeNode(i),s=r.parent,a=r.children[1].children[1].children.length;var l=new S;var h=new m(l);for(var p=0;p<a;p++){var u=new g;if(n){this.insertTermsFromParameter(u,e.get_child([1,1,p,1]),r.get_child([1,1,p,1]),r.value);this.insertTermsFromParameter(u,i.get_child([1,1,p,1]),o.get_child([1,1,p,1]),o.value)}else{this.insertTermsFromParameter(u,i.get_child([1,1,p,1]),o.get_child([1,1,p,1]),o.value);this.insertTermsFromParameter(u,e.get_child([1,1,p,1]),r.get_child([1,1,p,1]),r.value)}u.simplify=true;var c=new L(u);this.updateNodeMap(r.get_child([1,1,p]),c);this.updateNodeMap(o.get_child([1,1,p]),c);l.append(new L(u))}var d=o.remove();s.insert(d,h);r.remove();this.updateNodeMap(e,h);this.updateNodeMap(e.get_child([1]),h.get_child([1]));this.updateNodeMap(e.get_child([1,0]),h.get_child([1,0]));this.updateNodeMap(e.get_child([1,1]),h.get_child([1,1]));this.updateNodeMap(e.get_child([1,2]),h.get_child([1,2]));this.updateNodeMap(i,h);this.updateNodeMap(i.get_child([1]),h.get_child([1]));this.updateNodeMap(i.get_child([1,0]),h.get_child([1,0]));this.updateNodeMap(i.get_child([1,1]),h.get_child([1,1]));this.updateNodeMap(i.get_child([1,2]),h.get_child([1,2]));this.cleanup(s);if(typeof t==="function")t(this);return this};e.prototype.insertTermsFromParameter=function(e,i,n,r){var o;if(n.is_group("sum")){o=n.children.slice();t.remove_range(o);this.updateNodeMap(i,e)}else{n.remove();o=[new m(n)];this.updateNodeMap(i.get_mapping_to(o[0]))}if(r==="sub")o.forEach(function(t){t.invert()});e.append_range(o)};m.prototype.add_action_handler(new e);return new e}();r.prototype.move_actions.push(gmath.actions.AddSubTupleAction);gmath.actions.AddSubLogarithmsAction=function(){var t=function(t){Action.call(this,"AddSubLogarithmsAction","add or subtract numbers");this.priority=1;this.triggerType="tap";this.settings={target_group:true,group_side:"around",delay:300,reset_y:true};if(t){if(t.nodes){this.triggerType="drag";this.nodes=t.nodes;this.target=t.target;this.settings.side=t.side}else{this.actor=t.actor}}};gmath.inherit(Action,t);t.prototype.getAllAvailableActions=function(t){var e=this.matchSource(t);if(!e)return[];var i=this.getTargets(e);return this.bindActionsForEachTarget(t,i)};t.prototype.matchSource=function(t){if(t.length!==1)return false;var e=t[0];if(!e.is_group("add","sub"))return false;var i=e.children[1];if(!M.Logs.is_log_func(i))return false;return{nodes:t,base:M.Logs.get_log_base(i),group:e.parent}};t.prototype.getTargets=function(t){var e=t.base.to_ascii();var i=t.group.children.filter(function(i){return i!==t.nodes[0]&&M.Logs.is_log_func(i.children[1])&&M.Logs.get_log_base(i.children[1]).to_ascii()===e},this);return i};t.prototype.bindActionsForEachTarget=function(t,e){var i=[];e.forEach(function(e){var n=e.children[1].children[1];i=i.concat(this.bindActionForEachTarget(t,[n],true))},this);return i};t.prototype.match=function(t){if(!t.is_group("add","sub"))return false;if(!t.ls)return false;var e=t.ls.children[1],i=t.children[1];return M.Logs.is_log_func(e)&&M.Logs.is_log_func(i)&&M.Logs.get_log_base(e).to_ascii()==M.Logs.get_log_base(i).to_ascii()};t.prototype.transform=function(t){var e=this.getSourceAndTarget();this.addTouchedNodes(e.source);this.addTouchedNodes(e.target);var i=this.getNewTreeNode(e.source),n=this.getNewTreeNode(e.target),r=i.parent;while(!n.is_group("add","sub"))n=n.parent;i.remove();var o=i.children[1],s=n.children[1],a=o.get_arg(),l=s.get_arg();var h=l.parent,p=l.remove(),u=new v;var d=new _(l,n.is_group("sub")?"div":"mul"),f=new _(a,i.is_group("sub")?"div":"mul");u.append(d);u.insert(this.settings.side==="left-of"?0:1,f,true);h.insert(p,u);c.handle(s.children[1]);if(n.is_group("sub"))n.invert();e.source.map_group_and_sym(this,n,true);e.source.children[1].map_to_func(this,s,true);this.setNodesToReselectAfterAction(a.is_group("product")?a.children.slice():f);this.cleanup(d);this.cleanup(f);this.cleanup(r);if(typeof t==="function")t(this);return this};m.prototype.add_action_handler(new t);return new t}();r.prototype.move_actions.push(gmath.actions.AddSubLogarithmsAction);gmath.actions.AddNegativeAction=function(){var e=function(t){Action.call(this,"AddNegativeAction","rearrange signs");this.triggerType="tap";this.priority=4;if(t)this.actor=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){var e=t.children[1];if(e&&e.is_group("sign")&&t.is_group("add","sub"))return true;return false};e.prototype.rematch=function(){var t=this.actor.children[1];return this.actor.is_group("add","sub")};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.actor);if(i.children[1].is_group("sign")){var n=this.actor.children[1].children[0];this.addTouchedNodes(this.actor.children[0]);this.addTouchedNodes(n);var r=i.children[1];i.invert();this.updateNodeMap(n,i.children[0]);t.replace(r,r.children[1])}if(typeof e==="function")e(this);else return true};m.prototype.add_action_handler(new e);return new e}();gmath.actions.PlusMinusProductToMinusProductAction=function(){var e=function(t){Action.call(this,"PlusMinusProductToMinusProductAction","x+-y*z=x-y*z");this.priority=0;this.triggerType="tap";if(t)this.actor=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){try{if(!t.is_group("add","sub"))return false;if(!t.children[1].is_group("product"))return false;var e=t.children[1].children[0].children[1];if(!e.is_group("sign"))return false}catch(t){return false}return true};e.prototype.rematch=function(){if(!this.actor.is_group("add","sub"))return false;if(!this.actor.children[1]||!this.actor.children[1].is_group("product"))return false;return true};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.actor);var n=i.children[1].children[0].children[1];if(n.is_group("sign")){var r=this.getOldTreeNode(n.children[0]);this.addTouchedNodes(this.actor.children[0]);this.addTouchedNodes(r);this.updateNodeMap(r,i.children[0]);t.replace(n,n.children[1]);i.invert()}if(typeof e==="function")e(this);else return true};m.prototype.add_action_handler(new e);return new e}();gmath.actions.ConvertAddendToFractionAction=function(){var t=function(t){Action.call(this,"ConvertAddendToFractionAction","convert addend to a fraction to allow adding");this.priority=1;this.triggerType="dbltap";if(t){this.actor=t.actor}};gmath.inherit(Action,t);t.prototype.match=function(t){if(!t)return false;if(!t.is_group("add","sub"))return false;if(!t.ls)return false;var e=t.ls.children[1],i=t.children[1];return e.is_group("fraction")&&!i.is_group("fraction")||!e.is_group("fraction")&&i.is_group("fraction")};t.prototype.transform=function(t){this.addTouchedNodes(this.actor);this.addTouchedNodes(this.actor.ls);var e=this.getNewTreeNode(this.actor.ls),i=this.getNewTreeNode(this.actor);var n=(e.children[1].is_group("fraction")?e:i).children[1],r=(e.children[1].is_group("fraction")?i:e).children[1];var o=r.parent;r.remove();var s=_.prototype.createGroup();s.append(new _(r));s.append(new _(new a(1),"div"));o.append(s);s.get_bottom()[0].simplify=true;this.cleanup(s.get_top()[0]);this.followup=gmath.actions.CrossMultiplyFractionsAction.createBoundAction(this.newTree,{actor:i});if(typeof t==="function")t(this);else return true};m.prototype.add_action_handler(new t);return new t}();gmath.actions.AddSubInvertAction=function(){var e=function(t){Action.call(this,"AddSubInvertAction","invert addends across an equality or inequality");this.priority=0;this.triggerType="drag";this.settings={side:"around",extend_extreme_target_boxes:true};if(t){this.nodes=t.nodes;this.target=t.target}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){var e=this.matchSource(t);if(!e)return[];var i=this.getTargets(e);return this.adjustTargets(this.bindActionForEachTarget(t,i))};e.prototype.matchSource=function(e){if(!t.is_range(e))return false;if(e[0].is_group("add","sub")&&e[0].parent.parent&&e[0].parent.parent.is_group("equals","lte","gte","lt","gt")){return{nodes:e,side:e[0].get_parent(1).get_idx(),sum:e[0].get_parent(1),group:e[0].get_parent(2)}}if(e[0].parent&&e[0].parent.is_group("equals","lte","gte","lt","gt")){return{nodes:e,side:e[0].get_idx(),sum:false,group:e[0].get_parent(1)}}return false};e.prototype.getTargets=function(t){return[t.group.get_child([!t.side?2:0])]};e.prototype.adjustTargets=function(t){t.forEach(function(t){var e=t.target;if(e.is_group("sign"))t.target=e.get_child([1])},this);return t};e.prototype.transform=function(e){this.addTouchedNodes(this.nodes);this.addTouchedNodes(this.target);var i=this.getNewTreeNode(this.nodes),n=this.getNewTreeNode(this.target),r=this.matchSource(i);t.remove_range(i);if(i[0].is_group("sum"))i=i[0].children.slice();if(n.get_parent(1).is_group("sign"))n=n.get_parent(1);if(i[0].is_group("add","sub")){i.forEach(function(t){t.invert()})}if(!r.sum)r.group.insert(r.side,new a(0));var o=new g,s=n.remove();o.append(new m(n));o.append_range(!i[0].is_group("add","sub")?[new m(i[0],i[0].is_group("sign")?"add":"sub")]:i);if(i[0].is_group("sign")){var l=i[0].get_parent(1),h=i[0].remove(),p=i[0].get_child([1]);p.remove();l.insert(h,p);this.updateNodeMap(this.nodes[0],p.parent)}r.group.insert(s,o);if(a.is_num(n)&&a.get_value(n)===0)n.get_parent(1).simplify=true;this.cleanup(o.get_child([0]));this.cleanup(r.sum);if(typeof e==="function")e(this);return this};return new e}();r.prototype.move_actions.push(gmath.actions.AddSubInvertAction);gmath.actions.RemoveBracketsAction=function(){var e=function(t){Action.call(this,"RemoveBracketsAction","remove optional brackets");this.priority=4;this.triggerType="tap";if(t)this.actor=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){return t.is_group("brackets")&&c.is_optional(t)};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.actor);this.addTouchedNodes(this.actor.children[0]);this.addTouchedNodes(this.actor.children[2]);var n=t.replace(i,i.children[1]);this.cleanup(n.parent);if(typeof e==="function")e(this);else return true};var i=new e;c.prototype.add_action_handler(i);return i}();gmath.actions.editLineAction=function(){var t=function(t){Action.call(this,"editLineAction","rewrite dl line");this.priority=0;if(t)this.actor=t.actor};gmath.inherit(Action,t);t.prototype.match=function(){return typeof Keyboard!=="undefined"&&Keyboard!==null};t.prototype.removeAllNodesFromNodeMap=function(){var t=this.newTree.select_all();for(var e in this.node_map){this.node_map[e]=[]}};t.prototype.transform=function(t){var e;var i=Keyboard();i.caption("What do you want to change in this line?").on("done",r).on("cancel",o)();var n=this;function r(e){var r=n.newTree;var o=r.parse(e,true);if(!o)return;r.children[0].remove();r.append(o);i.visible(false);i.on("done",null).on("cancel",null);n.removeAllNodesFromNodeMap();t(n)}function o(){console.log("cancelled");i.visible(false);i.on("done",null).on("cancel",null);t(false)}i.latex(n.newTree.to_latex()).visible(true)};return new t}();gmath.actions.CommuteAction=function(){var e=function(t){Action.call(this,"CommuteAction","commute terms");this.priority=2;this.triggerType="drag";this.settings={margin:{y:-1},extend_extreme_target_boxes:true};if(t){this.nodes=t.nodes;this.target=t.target;this.settings.side=t.side}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(e){if(e.length===0)return[];var i=e[0].get_root();var n=[];var r=e[0].parent.is_group("flat"),o;if(r)return[];if(!e[0].commutative||!t.is_range(e))return[];for(o=e[0].ls;o&&o.value!=="//";o=o.ls){if(this.match(e,o,"left-of"))n.push(this.createBoundAction(i,{nodes:e,target:o,side:"left-of"}))}for(o=e[e.length-1].rs;o&&o.value!=="//";o=o.rs){if(this.match(e,o,"right-of"))n.push(this.createBoundAction(i,{nodes:e,target:o,side:"right-of"}))}return this.adjustTargetBoxes(n)};e.prototype.match=function(t,e,i){if(e.parent!==t[0].parent)return false;if(!t[0].commutative)return false;if(i==="left-of"&&e.ls===t[t.length-1])return false;if(i==="right-of"&&e.rs===t[0])return false;return true};e.prototype.adjustTargetBoxes=function(t){t.forEach(function(t){if(t.target.get_parent(1).is_group("fraction")){if(t.target.is_group("mul"))t.settings.margin={y1:-1,y2:.1};else t.settings.margin={y1:.1,y2:-1}}});return t};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.nodes);var n=this.getNewTreeNode(this.target);var r=this.settings.side;var o=n.parent,s=o.children.indexOf(n);if(i.length===1){i[0].remove();o.insert(s,i[0])}else{if(r==="right-of")s++;var a=t.remove_range(i);o.insert_range(a<s?s-i.length:s,i)}if(typeof e==="function")e(this);else return true};return new e}();r.prototype.move_actions.push(gmath.actions.CommuteAction);gmath.actions.EqInvertAndCommuteTermAction=function(){var t=function(t){Action.call(this,"EqInvertAndCommuteTermAction","composed action of inverting terms across an equation and commuting");this.priority=0;this.triggerType="drag";this.settings={margin:{y:-1},extend_extreme_target_boxes:true};if(t){this.nodes=t.nodes;this.target=t.target;this.settings.side=t.side}};gmath.inherit(Action,t);t.prototype.getAllAvailableActions=function(t){var e=t[0].get_root();var i=this.getAndPerformAvailableInversionActionOnClone(e,t);if(!i){return[]}var n=this.getAvailableCommuteActionsOnInversionResult(i);if(n.length===0){return[]}var r=this.unmapToGetTargets(e,i,n).sort(function(t,e){return t.get_idx()-e.get_idx()});return this.adjustTargets(this.bindActionForEachTarget(t,r,true))};t.prototype.getAndPerformAvailableInversionActionOnClone=function(t,e){var i=t.clone(),n=[];e.forEach(function(t){n.push(i.get_child(t.get_path()))});var r=gmath.actions.AddSubInvertAction.getAllAvailableActions(n);if(r.length===0)r=gmath.actions.MulDivInvertAction.getAllAvailableActions(n);if(r.length===0)return false;var o=r[0];i.performAction(o,null,false,true);if(o.newTree===o.oldTree){return false}return o};t.prototype.getAvailableCommuteActionsOnInversionResult=function(t){var e=[];var i=t.nodes;if(i.length===1&&i[0].is_group("sum")){i=i[0].children.slice()}for(var n=0;n<i.length;n++){var r=i[n];var o=this.getTheNodesOnTheSameSideAsTheTarget(t.mapNodes(r),t.target);e.push(this.getCommutativeTermFromNode(o)[0])}return gmath.actions.CommuteAction.getAllAvailableActions(e)};t.prototype.getTheNodesOnTheSameSideAsTheTarget=function(t,e){var i=[];var n=e.get_path()[1];t.forEach(function(t){if(t.get_path()[1]===n)i.push(t)});return i};t.prototype.unmapToGetTargets=function(t,e,i){var n=[];i.forEach(function(t){n.push(t.target)});var r=this;var o=[];n.forEach(function(t){o.push(r.getCommuteTargetBeforeInversion(t,e))});var s=[];o.forEach(function(e){s.push(t.get_child(e.get_path()))});return s};t.prototype.getCommuteTargetBeforeInversion=function(t,e){var i=e.unmapNodes(t);if(i.length===1){return i[0]}else{if(t.is_group("mul")&&t.children[1].is_group("brackets")&&t.children[1].children[1].is_group("sum")){var n=t.children[1];i=e.unmapNodes(n);if(i.length!==0){return i[0]}else{var r=n.children[1];i=e.unmapNodes(r);return i[0]}}else if(t.is_group("add","sub","mul")){var o=t.children[1];return e.unmapNodes(o)[0]}}};t.prototype.getCommutativeTermFromNode=function(t){if(t.length!==1)throw"What's happening here?";if(t[0].parent.commutative){return[t[0].parent]}else if(t[0].is_group("sum")&&t[0].parent.is_group("brackets")&&t[0].parent.parent&&t[0].parent.parent.commutative){return[t[0].parent.parent]}else{return t}};t.prototype.adjustTargets=function(t){for(var e=0;e<t.length;e++){var i=t[e];if((!i.target.ls&&i.side==="left-of"||(!i.target.rs||i.target.rs instanceof l)&&i.side==="right-of")&&i.target.parent.is_group("fraction")){i.target=i.target.parent}}return t};t.prototype.doInPlace=function(t){this.initNodeMap();var e=this.settings.side;if(this.target.is_group("fraction")&&this.nodes[0].is_group("div")){var i=this.target.get_top();this.target=e==="left-of"?i[0]:i[i.length-1]}var n=this;this.nodes.forEach(function(t){n.addTouchedNodes(t)});var r=this.getNewTreeNode(this.nodes),o=this.getNewTreeNode(this.target);var s;if(r[0].is_group("mul","div"))s=gmath.actions.MulDivInvertAction.getAllAvailableActions(r)[0];else s=gmath.actions.AddSubInvertAction.getAllAvailableActions(r)[0];s.doInPlace();this.compose(s);var a=this.getTheNodesOnTheSameSideAsTheTarget(s.mapNodes(r.length===1&&r[0].is_group("sum")?r[0].children.slice():r),s.mapNodes(o)[0]),o=s.mapNodes(o);if(a.length===1){a=this.getCommutativeTermFromNode(a)}o=this.getCommutativeTermFromNode(o)[0];var l=gmath.actions.CommuteAction.getAllAvailableActions(a);var h;if(!(e==="right-of"&&!this.target.rs)){for(var p=0;p<l.length;p++){var u=l[p];if(e==="right-of"&&u.settings.side==="left-of"&&o.rs===u.target){h=u;u.doInPlace();this.compose(u);break}else if(e==="left-of"&&o===u.target){h=u;u.doInPlace();this.compose(u);break}}}this.setNodesToReselectAfterAction(h?this.getTheNodesOnTheSameSideAsTheTarget(h.mapNodes(a),o):this.getTheNodesOnTheSameSideAsTheTarget(a,o));this.removeDeletedNodesFromNodeMap();if(typeof t==="function")t(this);else return true};return new t}();r.prototype.move_actions.push(gmath.actions.EqInvertAndCommuteTermAction);gmath.actions.EqInvertPowerAction=function(){var e=function(t){Action.call(this,"EqInvertPowerAction","invert power across equation");this.triggerType="drag";this.settings={side:"around",reset_y:true,extend_extreme_target_boxes:true};if(t){this.nodes=t.nodes;this.target=t.target}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){if(!this.nodesAreASingleExponent(t)&&!this.nodesAreARangeOfMulsInAnExponent(t))return[];if(!this.expressionIsAnEquation(t))return[];if(!this.powerIsTheTopLevelGroupOnThisSideOfTheEquation(t))return[];return[this.createBoundAction(t[0].get_root(),{nodes:t,target:this.getOtherSideOfEquation(t)})]};e.prototype.nodesAreASingleExponent=function(t){return t.length===1&&t[0].is_group("exponent")};e.prototype.nodesAreARangeOfMulsInAnExponent=function(e){try{return t.is_range(e)&&e.every(function(e){return e.is_group("mul")&&t.get_parent(2,e).is_group("exponent")})}catch(t){if(t!=="invalid path")throw t;return false}};e.prototype.expressionIsAnEquation=function(t){var e=t[0].get_root();return e.children[0].is_group("equals")};e.prototype.powerIsTheTopLevelGroupOnThisSideOfTheEquation=function(t){var e=t[0].get_root().children[0],i=t[0];while(!i.is_group("power"))i=i.parent;return e.children[0]===i||e.children[2]===i};e.prototype.getOtherSideOfEquation=function(t){var e=t[0].get_root().children[0];var i=t[0].get_path();return i[1]===0?e.children[2]:e.children[0]};e.prototype.transform=function(t){this.addTouchedNodes(this.nodes[0].get_root());var e=this.getNewTreeNode(this.nodes),i=this.getOtherSideOfEquation(e);this.extractRangeFromExponent(e);var n=this.invertedTermsAreEven(e);var r=this.convertNodesToReciprocalAndPrepareExponent(e);this.wrapTermInPower(i,r,n);this.setNodesToReselectAfterAction(r);if(typeof t==="function")t(this);else return true};e.prototype.extractRangeFromExponent=function(e){if(e[0].is_group("exponent")){var i=e[0].parent.parent,n=e[0].parent,r=n.children[0],o=e[0];var s=n.remove();r.remove();o.remove();i.insert(s,r);return r}else{var n=e[0].get_parent(4),o=n.children[1],a=o.children[0],l=a.children[1];t.remove_range(e);this.cleanup(l);c.handle(a,true);return n}};e.prototype.invertedTermsAreEven=function(t){var e=r.evalExpression(t[0]);if(!e)return false;return e%2===0};e.prototype.convertNodesToReciprocalAndPrepareExponent=function(t){var e;if(t[0].is_group("exponent")){this.invertContentsOfExponent(t[0]);e=t[0]}else{e=this.invertMulsAndPutInProductFractionExponentStructure(t)}return e};e.prototype.invertContentsOfExponent=function(t){var e=t.children[0];if(e.is_group("brackets")&&e.children[1].is_group("product","fraction")){this.convertToReciprocal(e.children[1]);c.handle(e,true)}else{var i=_.prototype.createGroup();e.remove();i.append(new _(new a(1)));i.append(new _(e,"div"));t.append(i);c.handle(i)}};e.prototype.convertToReciprocal=function(e){var i=e.parent,n=e.remove();var r;if(e.is_group("product")){var o=e.children.slice();t.remove_range(e.children);o.forEach(function(t){t.invert()});var s=_.prototype.createGroup();o.forEach(function(t){s.append(t)});r=s}else{var l=e.get_top(),h=e.get_bottom();if(l.length===1&&a.get_value(l[0].children[1])===1){var p=_.prototype.createGroup();t.remove_range(h);h.forEach(function(t){t.invert()});p.append_range(h);r=p}else{t.remove_range(l);t.remove_range(h);l.forEach(function(t){t.invert()});h.forEach(function(t){t.invert()});h.forEach(function(t){e.append(t)});l.forEach(function(t){e.append(t)});r=e}}i.insert(n,r)};e.prototype.invertMulsAndPutInProductFractionExponentStructure=function(t){var e=_.prototype.createGroup();t.forEach(function(t){t.invert()});t.forEach(function(t){e.append(t)});return new b(e)};e.prototype.wrapTermInPower=function(t,e,i){var n=t.parent,r=t.remove(),o=t;var s=new y(o,e);if(i)s=new f(s,true);n.insert(r,s);c.handle(s);if(e.children[0].is_group("brackets")){this.cleanup(e.children[0].children[1]);c.handle(e.children[0],true)}return e};return new e}();r.prototype.move_actions.push(gmath.actions.EqInvertPowerAction);r.prototype.hideNodesAction=function(){var t=function(t){Action.call(this,"HideNodesAction","apply hide rules")};gmath.inherit(Action,t);t.prototype.doInPlace=function(e,i){var n=false;if(e.children.length>0){var r=function(i){var r=i.hidden,o=i.hide_afer_drop;i.hidden=false;i.hide_after_drop=false;if(e.options.hide_leading_op&&i instanceof l&&i.parent&&i.parent.commutative){if(i.parent.associative&&!i.parent.ls||i.parent.value=="div"&&i.parent.ls&&i.parent.ls.value=="//"){if(i.parent.dragging)i.hide_after_drop=true;else i.hidden=true}}if(i instanceof l&&v.is_lone_fraction_part(i.parent)){i.hidden=true}if((i.value==="("||i.value===")")&&!t.bracketsAreEssentialElementsToExpressionType(i.parent)){var s=i.parent;if(s.parent.vertical_notation||s.parent.parent&&s.parent.parent.vertical_notation){var a=s;while(a.is_group("brackets"))a=a.children[1];if(!c.is_optional(a,s.parent)&&t.isLoneMulDivInNumeratorOrDenominator(s.parent)){if(i.parent.dragging)i.hide_after_drop=true;else i.hidden=true}}}for(var h=0;h<e.hide_rules.length&&!i.hidden;h++){var p=e.hide_rules[h];if(!p.disabled)p.apply(i)}n=n||i.hidden!=r||i.hide_after_drop!=o};e.children[0].for_each(r)}if(typeof i==="function")i(this);else return n};t.isLoneMulDivInNumeratorOrDenominator=function(t){return!(t.ls&&t.ls.is_group(t.value)||t.rs&&t.rs.is_group(t.value))};t.bracketsAreEssentialElementsToExpressionType=function(t){return t.is_group("brackets")&&t.children[1].is_group("tuple")};return new t}();gmath.actions.SwitchAction=function(){var e=function(t){Action.call(this,"SwitchAction","switch terms in a flat representation");this.priority=0;this.triggerType="drag";this.settings={side:"around"};if(t){this.node=t.node;this.target=t.target}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(e){if(e.length===0)return[];var i=e[0].get_root();var n=[];var r=e[0].parent.is_group("flat"),o;if(!r)return[];if(!e[0].commutative||!t.is_range(e))return[];for(o=e[0].ls;o&&o.value!=="//";o=o.ls){if(this.match(e[0],o))n.push(this.createBoundAction(i,{node:e[0],target:o}))}for(o=e[e.length-1].rs;o&&o.value!=="//";o=o.rs){if(this.match(e[0],o))n.push(this.createBoundAction(i,{node:e[0],target:o}))}};e.prototype.match=function(t,e){return t.parent===e.parent&&t!==e&&!(e instanceof l)&&!(t instanceof l)};e.prototype.transform=function(e){var i=tree===this.target.get_root();var n=i?this.node:tree.get_child(this.node.get_path());var r=i?this.target:tree.get_child(this.target.get_path());t.switch_siblings(n,r);if(typeof e==="function")e(this);else return true};return new e}();r.prototype.move_actions.push(gmath.actions.SwitchAction);gmath.actions.flipEquationAction=function(){var t=function(t){Action.call(this,"flipEquationAction","flip equation");this.priority=1;this.triggerType="tap";if(t)this.actor=t.actor};gmath.inherit(Action,t);t.prototype.match=function(t){return t.is_group("equals")||E.is_inequality(t)};t.prototype.transform=function(t){var n=this.getNewTreeNode(this.actor);this.addTouchedNodes(e(this.actor));this.addTouchedNodes(i(this.actor));var r=e(n),o=i(n);r.remove();o.remove();var s=0,a=2;n.insert(s,o);n.insert(a,r);if(E.is_inequality(n))n.invert();if(typeof t==="function")t(this);return this};N.prototype.add_action_handler(new t);E.prototype.add_action_handler(new t);var e=function(t){return t.children[0]};var i=function(t){return t.children[2]};return new t}();gmath.actions.RewriteExpressionWithKeyboardAction=function(){var e=function(t){Action.call(this,"RewriteExpressionWithKeyboardAction","replace an expression with an equivalent one");this.priority=0;this.triggerType="drag";this.settings={side:"shake",asynchronous:true};this.latex=null;this.original_node_state=null;if(t)this.nodes=t.nodes};gmath.inherit(Action,e);e.prototype.toJSON=function(){var t=Action.prototype.toJSON.call(this);if(this.latex)t.latex=this.latex;if(this.original_node_state)t.original_node_state=this.original_node_state;return t};e.prototype.rematch=function(){if(!(this.nodes&&this.nodes.length>0))return false;if(this.getAllAvailableActions){var t=this.getAllAvailableActions(this.nodes);return t.every(function(t){return i(t.nodes)===this.original_node_state},this)}};e.prototype.match=function(t){return gmath.ui&&gmath.ui.Keyboard};e.prototype.getAllAvailableActions=function(t){if(!gmath.ui||!gmath.ui.Keyboard)return[];else return[this.createBoundAction(t[0].get_root(),{nodes:t})]};e.prototype.getTarget=function(t){if(t.length===1&&t[0].is_group("add","sub","mul","div"))return[t[0].children[1]];if(t.length===1&&t[0].is_group("exponent"))return t[0].children;return t};function i(t){return t.map(function(t){return t.to_ascii()}).join("")}e.prototype.transform=function(e){var n=this.getTarget(this.getNewTreeNode(this.nodes)),o=this.getOldTreeNode(n);if(this.latex){var s=g(d(this.latex));y.call(this,o,n,s);if(typeof e==="function")e(this);return this}else{this.original_node_state=i(this.nodes)}var l=false,h="Enter an expression to replace the selected expression.",p=n.map(function(t){return t.to_latex()}).join("");var u=gmath.ui.Keyboard();console.log(p);u.caption(h).on("done.rewrite-expression",w.bind(this)).on("change.rewrite-expression",x.bind(this)).on("cancel.rewrite-expression",A).visible(true).latex(p+"\\quad\\rightarrow\\quad");function d(t){t=t.replace(/\\quad/g,"");var e=t.split("\\rightarrow");if(e.length>1)return e[e.length-1];return e[0]}function f(t){var e=false;try{this.newTree.parse(t,true);e=true}catch(t){console.log(t);u.warning("Could not parse expression.")}return e}function g(t){var e=new r(t).get_child([0]);e.remove();return e}function v(t,e){var i=gmath.termsToAlgebriteString;if(t.length===1&&a.is_num(t[0])&&r.evalExpression(e)===a.get_value(t[0])){return true}else if(Algebrite){if(e.is_group("equals")||t[0].is_group("equals")){if(!e.is_group("equals")||t.length!==1||!t[0].is_group("equals"))return false;t=t[0];var o=Algebrite.simplify(i(e.children[0])),s=Algebrite.simplify(i(e.children[2])),l=Algebrite.simplify(i(t.children[0])),h=Algebrite.simplify(i(t.children[2]));return Algebrite.equal(o,l)&&Algebrite.equal(s,h)||Algebrite.equal(o,h)&&Algebrite.equal(s,l)}var p=Algebrite.simplify(i(e)),u=Algebrite.simplify(i(n));return Algebrite.equal(u,p)}else return false}function y(e,i,n){var r=i[0].get_parent(1),o=t.remove_range(i);if(i.length>1)n=i[0].is_group("mul","div")?new _(n,i[0].value):new m(n,i[0].value);r.insert(o,n);c.handle(n);if(i.length===1&&(!i[0].has_children()||!n.has_children()))this.updateNodeMap(e[0].get_mapping_to(n));this.cleanup(n);this.cleanup_cascade(r)}function b(){u.visible(false);u.on("done.rewrite-expression",null).on("cancel.rewrite-expression",null)}function w(t){this.latex=t;var i=d(t);if(!f.call(this,i))return;var r=g(i);if(!l){if(v(n,r)){y.call(this,o,n,r)}else{u.warning("Equivalence with the existing expression could not be ensured."+" Click done or press enter to replace it anyway.");
l=true;return}}else{y.call(this,o,n,r)}b();if(typeof e==="function")e(this);else return true}function x(){l=false;u.caption(h)}function A(){b();e(false)}};return new e}();r.prototype.move_actions.push(gmath.actions.RewriteExpressionWithKeyboardAction);gmath.actions.EquationFountain=function(){var e=function(t){Action.call(this,"EquationFountain","rewrite equation");this.priority=1;this.triggerType="hold";this.settings={asynchronous:true};this.latex=null;if(t)this.actor=t.actor};gmath.inherit(Action,e);e.prototype.toJSON=function(){var t=Action.prototype.toJSON.call(this);if(this.latex)t.latex=this.latex;return t};e.prototype.match=function(t){if(!gmath.ui||!gmath.ui.Keyboard)return false;return t.is_group("equals")};e.prototype.transform=function(t){var e=this.getNewTreeNode(this.actor);if(this.latex){var i=new r(this.latex).children[0];this.replaceSideWithInput(e.children[0],i);this.replaceSideWithInput(e.children[2],i);if(typeof t==="function")t(this);return this}var n=gmath.ui.Keyboard();n.caption("Enter an operation to apply to both sides of the equation.").latex("E").on("done.eq-fountain",o.bind(this)).on("cancel.eq-fountain",s).visible(true);function o(i){this.latex=i;var o;try{o=new r(i).children[0]}catch(t){console.log(t);n.warning("Could not parse expression.");return}if(!r.getNodes("E",0,o)){n.warning('There needs to be an "E" in the expression.');return}this.replaceSideWithInput(e.children[0],o);this.replaceSideWithInput(e.children[2],o);n.visible(false);n.on("done.eq-fountain",null).on("cancel.eq-fountain",null);if(typeof t==="function")t(this);return this}function s(){console.log("cancelled");n.visible(false);n.on("done.eq-fountain",null).on("cancel.eq-fountain",null);if(typeof t==="function")t(false);return false}};e.prototype.replaceSideWithInput=function(e,i){var n=i.clone();var o=r.getNodes("E",0,n);t.replace(e,n);e.parent=null;if(o.is_group("tuple"))o=o.get_child([0,1]);t.replace(o,e);c.handle(e);this.cleanup(e.parent)};N.prototype.add_action_handler(new e);return new e}();gmath.actions.EquationCombineAction=function(){var e=function(t){Action.call(this,"EquationCombineAction","combine equations");this.settings={asyncronous:true,side:"below",margin:{y1:.2,y2:-1},layout_hint:"new-line"};if(t){this.nodes=t.nodes;this.target=t.target}};gmath.inherit(Action,e);e.prototype.toJSON=function(){var t=Action.prototype.toJSON.call(this);if(this.latex)t.latex=this.latex;return t};e.prototype.rebind=function(t,e,i){if(this.nodes[0]===i){this.nodes[0]=t}else if(this.oldTree===i){var n=new Action;n.node_map=e;this.oldTree=t;this.target=n.mapNodes(this.target)[0]}else throw"wrong old tree during rebinding an action!"};e.prototype.rematch=function(){if(!(this.nodes&&this.nodes.length>0&&this.target))return false;var t=this.getAllAvailableActions(this.nodes,this.target);return this.target===t[0].target};e.prototype.getAllAvailableActions=function(t,e){if(!e.is_group("equals"))return[];return[this.createBoundAction(e.parent,{nodes:[t],target:e})]};e.prototype.transform=function(t){var e=this.getNewTreeNode(this.target),i=this.nodes[0].children[0].clone();if(this.latex){var n=this.newTree.parse(this.latex,true);this.combineEquations(n,e,i);e.children[0].children.forEach(function(t){this.cleanup(t)},this);e.children[2].children.forEach(function(t){this.cleanup(t)},this);if(typeof t==="function")t(this);return this}var r=gmath.ui.Keyboard();r.caption("Combine the equations E₁ and E₂.").latex("E_1+E_2").on("done."+this.name,o.bind(this)).on("cancel."+this.name,s.bind(this)).visible(true);function o(n){this.latex=n;try{var o=this.newTree.parse(n,true)}catch(t){console.log(t);r.warning("Could not parse expression.");return}this.combineEquations(o,e,i);e.children[0].children.forEach(function(t){this.cleanup(t)},this);e.children[2].children.forEach(function(t){this.cleanup(t)},this);this.endKeyboardInteraction(r);t(this)}function s(){this.endKeyboardInteraction(r);t(false)}};e.prototype.combineEquations=function(e,i,n){var o=i.children[0],s=this.target.children[0],a=i.children[2],l=this.target.children[2],h=n.children[0],p=this.nodes[0].children[0].children[0],u=n.children[2],d=this.nodes[0].children[0].children[2];var f=e,g=e.clone();t.replace(o,f);t.replace(a,g);o.parent=null;a.parent=null;var m=this;function v(e,i,n,o){var s=r.getNodes(e,"all",i);s.forEach(function(e){var i=n.clone();t.replace(e,i);m.updateNodeMap(o.get_mapping_to(i));c.handle(i)})}v("E_1",f,o,s);v("E_2",f,h,p);v("E_1",g,a,l);v("E_2",g,u,d)};e.prototype.endKeyboardInteraction=function(t){t.visible(false);t.on("done."+this.name,null).on("cancel."+this.name,null)};return new e}();gmath.actions.InequalityFountain=function(){var e=function(t){Action.call(this,"InequalityFountain","rewrite inequality");this.priority=1;this.triggerType="hold";this.settings={asynchronous:true};if(t)this.actor=t.actor};gmath.inherit(Action,e);e.prototype.toJSON=function(){var t={id:this.id,name:this.name,type:"Action",priority:this.priority,node_map:gmath.object.jsonifyNodeMap(this.node_map),touched_nodes:this.touched_nodes,oldTree:this.oldTree.id,newTree:this.newTree.id,triggerType:this.triggerType,settings:this.settings};if(this.actor)t.actor=this.actor.id;if(this.latex)t.latex=this.latex;return t};e.prototype.ids_to_references_after_parsing=function(t){if(this.oldTree)this.oldTree=t[this.oldTree];if(this.newTree)this.newTree=t[this.newTree];for(var e in this.node_map){this.node_map[e]=this.node_map[e].map(function(e){return t[e]})}if(this.actor)this.actor=t[this.actor];if(this.latex)this.latex=this.latex};e.prototype.match=function(t){if(!gmath.ui||!gmath.ui.Keyboard)return false;return E.is_inequality(t)};e.prototype.transform=function(t){var e=this.getNewTreeNode(this.actor);if(this.latex){var i=new r(this.latex).children[0];this.invertInequalityIfInputIsNegative(i,e);this.replaceSideWithInput(e.children[0],i);this.replaceSideWithInput(e.children[2],i);if(typeof t==="function")t(this);return this}var n=gmath.ui.Keyboard();n.caption("Enter an operation to apply to both sides of the equation.").latex("E").on("done.eq-fountain",o.bind(this)).on("cancel.eq-fountain",s).visible(true);function o(i){this.latex=i;var o;try{o=new r(i).children[0]}catch(t){console.log(t);n.warning("Could not parse expression.");return}if(!r.getNodes("E",0,o)){n.warning('There needs to be an "E" in the expression.');return}this.invertInequalityIfInputIsNegative(o,e);this.replaceSideWithInput(e.children[0],o);this.replaceSideWithInput(e.children[2],o);n.visible(false);n.on("done.eq-fountain",null).on("cancel.eq-fountain",null);if(typeof t==="function")t(this);return this}function s(){console.log("cancelled");n.visible(false);n.on("done.eq-fountain",null).on("cancel.eq-fountain",null);if(typeof t==="function")t(false);return false}};e.prototype.invertInequalityIfInputIsNegative=function(t,e){var i=false,n=false;if(t.is_group("product","fraction")){function r(t){if(t.is_group("power")&&a.is_num(t.get_child([1,0]))&&a.get_value(t.get_child([1,0]))%2===0){}else if(t.is_group("sign")){i=!i;r(t.get_child([1]))}else if(t.children.length===0&&!a.is_num(t)&&!(t instanceof l)&&t.to_ascii()!=="E")n=true;else if(t.children.length)t.children.forEach(r)}r(t)}if(i)e.invert();if(n)this.settings.restraint="All new terms must evaluate to a positive number."};e.prototype.replaceSideWithInput=function(e,i){var n=i.clone();var o=r.getNodes("E",0,n);t.replace(e,n);e.parent=null;t.replace(o,e);c.handle(e);this.cleanup(e.parent)};E.prototype.add_action_handler(new e);return new e}();gmath.actions.ImaginaryAssociateNegOneOutOfSqrtAction=function(){var t=function(t){Action.call(this,"ImaginaryAssociateNegOneOutOfSqrtAction","calculate a power of an imaginary number");this.priority=1;this.triggerType="drag";this.settings={side:"outside"};if(t){this.nodes=t.nodes;this.target=t.target}};gmath.inherit(Action,t);t.prototype.getAllAvailableActions=function(t){var e=this.matchSource(t);if(!e)return[];var i=this.getTargets(e);return this.bindActionForEachTarget(t,i)};t.prototype.matchSource=function(t){if(t.length!==1)return false;var e=t[0];if(!a.is_equal_to(e,-1))return false;if(!this.withinSqrt(e.parent))return false;return{nodes:t,power:e.get_parent(2)}};t.prototype.getTargets=function(t){return[t.nodes[0].parent]};t.prototype.withinSqrt=function(t){return t.is_group("brackets")&&t.parent.is_group("power")&&b.is_square_root(t.parent.children[1])};t.prototype.transform=function(t){this.addTouchedNodes(this.nodes);var e=this.getNewTreeNode(this.nodes)[0],i=e.get_parent(2),n=i.parent;var r=this.getOldTreeNode(i);var o=i.remove(),s=new h("i");n.insert(o,s);this.updateNodeMap(r.get_mapping_to(s));this.cleanup_cascade(n);if(typeof t==="function")t(this);else return true};return new t}();r.prototype.move_actions.push(gmath.actions.ImaginaryAssociateNegOneOutOfSqrtAction);gmath.actions.ImaginaryAssociateOutOfSqrtAction=function(){var t=function(t){Action.call(this,"ImaginaryAssociateOutOfSqrtAction","calculate a power of an imaginary number");this.priority=1;this.triggerType="drag";this.settings={target_group:true,group_side:"outside",margin:{x:-.1,y:-.1}};if(t){this.nodes=t.nodes;this.target=t.target;this.settings.side=t.side}};gmath.inherit(Action,t);t.prototype.getAllAvailableActions=function(t){var e=this.matchSource(t);if(!e)return[];var i=this.getTargets(e);return this.bindActionForEachTarget(t,i,true)};t.prototype.matchSource=function(t){if(t.length!==1)return false;var e=t[0];if(!a.is_equal_to(e.children[1],-1))return false;if(!e.parent.parent||!this.withinSqrt(e.get_parent(2)))return false;return{nodes:t,group:e.parent,power:e.get_parent(3)}};t.prototype.getTargets=function(t){return[t.group]};t.prototype.withinSqrt=function(t){return t.is_group("brackets")&&t.parent.is_group("power")&&b.is_square_root(t.parent.children[1])};t.prototype.transform=function(t){this.addTouchedNodes(this.nodes);var e=this.getNewTreeNode(this.nodes)[0],i=e.parent,n=i.get_parent(2),r=n.parent;var o=n.remove(),s=new v;e.remove();var a=e.children[1],l=new h("i");a.replace_with(l);this.updateNodeMap(this.nodes[0].children[1].get_mapping_to(l));if(e.is_group("div"))e.invert();s.append(new _(n));s.insert(this.settings.side==="left-of"?0:1,e);r.insert(o,s);this.cleanup(i);this.cleanup_cascade(r);if(typeof t==="function")t(this);else return true};return new t}();r.prototype.move_actions.push(gmath.actions.ImaginaryAssociateOutOfSqrtAction);(function(){var t=function(t){Action.call(this,"ImaginaryEvaluateIntegerPowerAction","calculate a power of an imaginary number");this.priority=1;this.triggerType="tap";if(t)this.actor=t.actor};gmath.inherit(Action,t);t.prototype.match=function(t){var e=t.get_parent(1);if(!e.is_group("power"))return false;var i=e.children[0];if(!h.is_constant(i)||i.value!=="i")return false;var n=e.get_child([1,0]);if(n.is_group("brackets")&&n.children[0].hidden)n=n.children[1];var r=a.get_value(n);if(isNaN(r)||Math.round(r)!==r)return false;return true};t.prototype.transform=function(t){this.addTouchedNodes(this.actor.parent);var e=this.getNewTreeNode(this.actor);var i=this.actor.get_parent(1);var n=e.parent,r=n.children[0],o=e.children[0];if(o.is_group("brackets"))o=o.children[1];var s=a.get_value(o);r.remove();var l=this.getEvaluateBase(r,s);n.replace_with(l);if(typeof t==="function")t(this);else return true};t.prototype.getEvaluateBase=function(t,e){var i;var n=e%4;if(n===0){i=new a(1)}else if(n===-3||n===1){i=t}else if(n===-2||n===2){i=new a(-1)}else if(n===-1||n===3){i=new f(t)}return i};b.prototype.add_action_handler(new t)})();(function(){var t=function(t){Action.call(this,"ImaginarySqrtOfNegativeOneAction","calculate a power of an imaginary number");this.priority=0;this.triggerType="tap";if(t)this.actor=t.actor};gmath.inherit(Action,t);t.prototype.match=function(t){if(t.is_group("radical")&&a.is_equal_to(t.get_radicand(),-1))return true;var e=t.get_parent(1);if(!e.is_group("power"))return false;var i=e.children[0];if(!i.is_group("brackets"))return false;var n=a.get_value(i.children[1]);if(isNaN(n)||n!==-1)return false;if(!a.is_equal_to(e.get_child([1,0]),.5))return false;return true};t.prototype.transform=function(t){if(this.actor.is_group("radical")){this.addTouchedNodes(this.actor);var e=this.actor;var i=this.getNewTreeNode(this.actor),n=i.parent,r=i.remove()}else{this.addTouchedNodes(this.actor.parent);var e=this.actor.parent;var o=this.getNewTreeNode(e),n=o.parent;var r=o.remove()}var s=new h("i");n.insert(r,s);this.cleanup_cascade(n);this.updateNodeMap(e.get_mapping_to(s));if(typeof t==="function")t(this);else return true};q.prototype.add_action_handler(new t);b.prototype.add_action_handler(new t)})();gmath.actions.GreatestCommonFactorAction=function(){var e=function(t){Action.call(this,"GreatestCommonFactorAction","find the greatest common factor between two terms");this.priority=0;this.triggerType="drag";this.settings={delay:1e3,side:"inside",margin:{x:.1},reset_x:true,reset_y:true};if(t){this.nodes=t.nodes;this.target=t.target}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){var e=t[0];if(t.length!==1)return[];if(!e.is_group("add","sub","mul","div"))return[];var i,n,r;if(e.is_group("add","sub")){i=e.get_parent(1);n=e.get_idx();r=false}else{var o=gmath.factoring.factorable_muldiv(e);if(!o)return[];i=o.ancestor_sum;n=o.addsub_idx;r=e.is_group("div")}var s=[];i.children.forEach(function(t,e){if(e===n)return;s=s.concat(this.getPotentialTargets(t,r))},this);var a=[];s.forEach(function(t){if(this.matchTarget(e,t))a.push(t)},this);return this.bindActionForEachTarget(t,a)};e.prototype.getPotentialTargets=function(t,e,i){var n=[];var r=t.get_child([1]);if(r.is_group("product")&&!i){r.children.forEach(function(t){n=n.concat(this.getPotentialTargets(t,e))},this)}else if(r.is_group("fraction")&&!i){var o=!e?r.get_top():r.get_bottom();o.forEach(function(t){n=n.concat(this.getPotentialTargets(t,e,true))},this)}else if(i||!e){n.push(t)}return n};e.prototype.matchTarget=function(t,e){var i=t.get_child([1]),n=e.get_child([1]);var r=i.is_group("sign"),o=n.is_group("sign");if(r)i=i.get_child([1]);if(o)n=n.get_child([1]);if(i.to_ascii()===n.to_ascii())return false;if(this.matchNumberMultiples(i,n))return true;else if(!r&&!o&&this.matchPowers(i,n))return true;else if(r&&o&&this.matchUnidenticalInnerTerms(i,n))return true;else return false};e.prototype.matchNumberMultiples=function(t,e){if(!a.is_num(t)||!a.is_num(e))return false;if(!a.get_value(t)||!a.get_value(e))return false;if(!gmath.factoring.numbers_are_multiples(t,e))return false;return true};e.prototype.matchPowers=function(t,e){if(!t.is_group("power")&&!e.is_group("power"))return false;if(!y.haveSameBase(t,e))return false;var i=y.getNumericalValueOfExponent(t),n=y.getNumericalValueOfExponent(e);if(!i&&i!==0)return false;if(!n&&n!==0)return false;return true};e.prototype.matchUnidenticalInnerTerms=function(t,e){return gmath.factoring.bypass_negatives(t).to_ascii()!==gmath.factoring.bypass_negatives(e).to_ascii()};e.prototype.transform=function(t){this.addTouchedNodes(this.nodes);this.addTouchedNodes(this.target);var e=this.nodes[0],i=this.target;var n=this.getNewTreeNode(e),r=this.getNewTreeNode(i);var o=n.get_child([1]),s=r.get_child([1]);var l=o.is_group("sign"),h=s.is_group("sign");if(l)o=o.get_child([1]);if(h)s=s.get_child([1]);var p;if(a.is_num(o)&&a.is_num(s)&&gmath.factoring.numbers_are_multiples(o,s)){p=this.factorizeNumbers(e,n,i,r)}else if((o.is_group("power")||s.is_group("power"))&&y.haveSameBase(o,s)){p=this.factorizePowers(e,n,i,r)}else if(l&&h){p={matching_nodes_factor:this.splitNegativeFromNode(e,n).mul_negative_one,matching_target_factor:this.splitNegativeFromNode(i,r).mul_negative_one};this.setNodesToReselectAfterAction(matching_nodes_factor)}else{throw"(GreatestCommonFactorAction) There is a case mis-match between the match and transform functions."}if(gmath.options.actions.factor_after_finding_gcf){this.followup=gmath.actions.FactorCommonTermsAction.createBoundAction(this.newTree,{nodes:[p.matching_nodes_factor],target:[p.matching_target_factor]})}if(typeof t==="function")t(this);else return true};e.prototype.splitNegativeFromNode=function(e,i){var n=e.get_child([1]),r=i.get_child([1]);var o=r.remove(),s=new v;var l=new f(new a(1)),r=a.is_num(r)?new a(Math.abs(a.get_value(r))):t.clone(r);var h=new _(l),p=new _(r);s.append(h);s.append(p);i.insert(o,s);this.updateNodeMap(n.get_mapping_to(l));this.extendNodeMap(n.get_mapping_to(r));this.cleanup_cascade(i);return{mul_negative_one:h,mul_term:p}};e.prototype.factorizeNumbers=function(t,e,i,n){var r=e.get_child([1]),o=n.get_child([1]);var s=a.get_value(r),l=a.get_value(o);var h,p;if(gmath.factoring.val1_is_a_multiple_of_val2(s,l)){var u=s/l,c=l;var h=this.splitIntoFactors(t.get_child([1]),r,u,c).factor2.parent;this.setNodesToReselectAfterAction(h);p=n}else if(gmath.factoring.val1_is_a_multiple_of_val2(l,s)){var u=l/s,c=s;h=e;p=this.splitIntoFactors(i.get_child([1]),o,u,c).factor2.parent}else{var d=gmath.factoring.get_gcf(s,l);h=this.splitIntoFactors(t.get_child([1]),r,d,s/d).factor1.parent;p=this.splitIntoFactors(i.get_child([1]),o,d,l/d).factor1.parent;this.setNodesToReselectAfterAction(h)}return{matching_nodes_factor:h,matching_target_factor:p}};e.prototype.splitIntoFactors=function(t,e,i,n){var r=e.parent,o=e.remove(),s=new v;var l=new a(i),h=new a(n);var p=new _(l),u=new _(h);s.append(p);s.append(u);r.insert(o,s);this.mapNumber(t,l);this.mapNumber(t,h,true);this.cleanup_cascade(r);return{factor1:l,factor2:h}};e.prototype.mapNumber=function(t,e,i){var n=i?this.extendNodeMap.bind(this):this.updateNodeMap.bind(this);if(!t.is_group("sign")&&e.is_group("sign"))n(t,e.get_child([1]));else if(t.is_group("sign")&&!e.is_group("sign"))n(t.get_child([1]),e);else n(t.get_mapping_to(e))};e.prototype.factorizePowers=function(t,e,i,n){var r=e.get_child([1]),o=n.get_child([1]);var s=y.getNumericalValueOfExponent(r),a=y.getNumericalValueOfExponent(o);var l,h;if(!r.is_group("power")){h=this.splitOffBase(i,n).mul_var;l=e}else if(!o.is_group("power")){h=n;var l=this.splitOffBase(t,e).mul_var;this.setNodesToReselectAfterAction(l)}else if(s>a){h=n;l=this.splitPower(t,e,a,s-a).mul_power1;this.setNodesToReselectAfterAction(l)}else{l=e;h=this.splitPower(i,n,s,a-s).mul_power1}return{matching_nodes_factor:l,matching_target_factor:h}};e.prototype.splitOffBase=function(t,e){var i=t.get_child([1]),n=e.get_child([1]);var r=n.remove(),o=new v;var s=n.get_child([0]).clone(),l=n.clone();var h=y.getNumericalValueOfExponent(l)-1;l.get_child([1]).remove();l.append(new b(new a(h)));this.mapPowerToVar(i,s);this.mapPowerToPower(i,l);var p=new _(s),u=new _(l);this.mapOpToOp(t,p);this.mapOpToOp(t,u);o.append(p);o.append(u);e.insert(r,o);if(y.getNumericalValueOfExponent(l)===1){l=l.replace_with(l.get_child([0]))}this.cleanup_cascade(e);return{mul_var:p,mul_power:u}};e.prototype.splitPower=function(t,e,i,n){var r=t.get_child([1]),o=e.get_child([1]);var s=o.remove(),l=new v;var h=o.clone(),p=o.clone();h.get_child([1]).remove();h.append(new b(new a(i)));p.get_child([1]).remove();p.append(new b(new a(n)));this.mapPowerToPower(r,h);this.mapPowerToPower(r,p);var u=new _(h),c=new _(p);this.mapOpToOp(t,u);this.mapOpToOp(t,c);l.append(u);l.append(c);e.insert(s,l);if(y.getNumericalValueOfExponent(p)===1){p=p.replace_with(p.get_child([0]))}this.cleanup_cascade(e);return{mul_power1:u,mul_power2:c}};e.prototype.mapPowerToVar=function(t,e){this.extendNodeMap(t.get_child([0]).get_mapping_to(e))};e.prototype.mapPowerToPower=function(t,e){this.extendNodeMap(t,e);this.extendNodeMap(t.get_child([0]).get_mapping_to(e.get_child([0])));this.extendNodeMap(t.get_child([1]),e.get_child([1]));this.extendNodeMap(t.get_child([1,0]).get_mapping_to(e.get_child([1,0])))};e.prototype.mapOpToOp=function(t,e){this.extendNodeMap(t,e);this.extendNodeMap(t.get_child([0]),e.get_child([0]))};return new e}();r.prototype.move_actions.push(gmath.actions.GreatestCommonFactorAction);gmath.actions.FactorCommonTermsAction=function(){var e=function(t){Action.call(this,"FactorCommonTermsAction","factor out matching term ranges");this.priority=0;this.triggerType="drag";this.settings={delay:600,side:"inside",margin:{x:.1},reset_x:true,reset_y:true};if(t){this.nodes=t.nodes;this.target=t.target}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(e){if(e[0].is_group("add","sub")&&e.length!==1)return[];if(e[0].is_group("mul","div")&&!t.is_range(e))return[];var i,n,r;if(e[0].is_group("add","sub")){i=e[0].get_parent(1);n=e[0].get_idx();r=false}else{var o=gmath.factoring.factorable_muldiv(e[0]);if(!o)return[];i=o.ancestor_sum;n=o.addsub_idx;r=e[0].is_group("div")}var s=this.getAsciiRangeFromNodes(e);var a=[];i.children.forEach(function(t,e){if(e===n)return;a=a.concat(this.getMatchingTargetRanges(t,s,r))},this);return this.bindActionForEachRange(e,a)};e.prototype.getAsciiRangeFromNodes=function(t){var e=[];if(t.length===1&&t[0].is_group("add","sub")){var i=t[0].get_child([1]);while(i.is_group("sign"))i=i.get_child([1]);if(i.is_group("product")){i.children.forEach(function(t){e.push(gmath.factoring.bypass_negatives(t.get_child([1])).to_ascii())},this)}else{e.push(i.to_ascii())}}else{t.forEach(function(t){e.push(gmath.factoring.bypass_negatives(t.get_child([1])).to_ascii())},this)}return e};e.prototype.bypassNegatives=function(t){while(t.is_group("sign"))t=t.get_child([1]);return t};e.prototype.getMatchingTargetRanges=function(t,e,i){var n=[];var r=t.get_child([1]);if(this.rangeAsciisMatch(e,[gmath.factoring.bypass_negatives(r).to_ascii()]))n.push([t]);if(r.is_group("product")){if(!i)n=n.concat(this.matchRangeOfOperators(r.children,e));r.children.forEach(function(t){var r=t.get_child([1]);r=gmath.factoring.bypass_negatives(r);if(r.is_group("fraction"))n=n.concat(this.getMatchingTargetRangesFromFraction(r,e,i))},this)}if(r.is_group("fraction")){n=n.concat(this.getMatchingTargetRangesFromFraction(r,e,i))}return n};e.prototype.getMatchingTargetRangesFromFraction=function(t,e,i){var n;if(!i)n=this.matchRangeOfOperators(t.get_top(),e);else n=this.matchRangeOfOperators(t.get_bottom(),e);return n};e.prototype.matchRangeOfOperators=function(t,e){var i=[];var n=e.length;var r=t.map(function(t){return gmath.factoring.bypass_negatives(t.get_child([1])).to_ascii()},this);if(t.length===n&&this.rangeAsciisMatch(e,r)&&t[0].get_parent(1).is_group("product"))return[[t[0].get_parent(2)]];for(var o=0;o<t.length-n+1;o++){var s=r.slice(o,o+n);if(this.rangeAsciisMatch(e,s)){i.push(t.slice(o,o+n))}}return i};e.prototype.rangeAsciisMatch=function(t,e){if(t.length!==e.length)return false;for(var i=0;i<t.length;i++)if(t[i]!==e[i])return false;return true};e.prototype.bindActionForEachRange=function(t,e){var i=t[0].get_root();return e.map(function(e){return this.createBoundAction(i,{nodes:t,target:e})},this)};e.prototype.transform=function(t){this.addTouchedNodes(this.nodes);this.addTouchedNodes(this.target);var e=this.nodes,i=this.target;var n=this.analyzeOldStructure(e),r=this.analyzeOldStructure(i);var o=this.getNewTreeNode(i),s=this.getNewTreeNode(e);if(s[0].is_group("add","sub"))s=this.insertCoefficientOfOneIntoAddend(s);if(o[0].is_group("add","sub"))o=this.insertCoefficientOfOneIntoAddend(o);var a=this.analyzeStructure(s),l=this.analyzeStructure(o);a.left_of_target=a.idx_of_addend<l.idx_of_addend;var h=this.stripNegatives(a),p=this.stripNegatives(l);if(!this.nodesProductIsInMidFactoring(a)){a=this.reinterpretNodesStructureForFactoring(a)}else{a.addend.remove();a.sum_of_coefficients=a.left_of_target?a.product.get_child([0,1,1]):a.product.get_child([a.product.children.length-1,1,1])}this.reinterpretTargetStructureForMergingWithNodes(l);this.insertTargetCoefficientsIntoCoefficientsSum(l,a);l.sum.insert(a.left_of_target?l.idx_of_addend-1:l.idx_of_addend,a.addend);this.reapplyNegatives(s,n,a,r,l,h,p);this.mapOldTargetFactorsToNewFactors(r,s);this.cleanupTermsInCoefficientsSum(a);this.cleanupTermsInProductOfCoefficentsSumAndVariables(a);this.cleanup_cascade(l.sum);this.setNodesToReselectAfterAction(s[0].children[1]?s:a.range);if(typeof t==="function")t(this);else return true};e.prototype.analyzeOldStructure=function(t){var e,i=[],n=[];function r(t){while(t.is_group("sign")){i.push(t);t=t.get_child([1])}n.push(t)}if(t[0].is_group("add","sub")){e=t[0];var o=t[0].get_child([1]);if(o.is_group("product")){o.children.forEach(function(t){r(t.get_child([1]))})}else{r(o)}}else{e=t[0];while(!e.is_group("add","sub"))e=e.get_parent(1);t.forEach(function(t){r(t.get_child([1]))})}return{addend:e,negative_groups:i,factors:n}};e.prototype.insertCoefficientOfOneIntoAddend=function(t){var e=t[0];while(!e.is_group("add","sub"))e=e.get_parent(1);var i=e.get_child([1]);i.remove();var n=_.prototype.createGroup();n.append(new _(new a(1)));n.append(new _(i));e.append(n);this.cleanup(n.get_child([1]));return n.children.slice(1)};e.prototype.analyzeStructure=function(t){var e={};e.range=t;var i=t[0];if(i.parent.is_group("product")){e.product=i.get_parent(1);e.addend=e.product.get_parent(1)}else if(i.get_parent(1).is_group("fraction")){e.fraction=i.get_parent(1);if(e.fraction.get_parent(1).is_group("mul")){e.product=e.fraction.get_parent(2);e.addend=e.product.get_parent(1)}else{e.addend=e.fraction.get_parent(1)}}else{throw"Can't identify structure for direct factoring."}e.sum=e.addend.get_parent(1);e.idx_of_addend=e.sum.children.indexOf(e.addend);return e};e.prototype.stripNegatives=function(t){var e=0;if(t.addend.is_group("sub")){t.addend.invert();e++}t.range.forEach(function(t){var i=0,n=t.get_child([1]);while(n.is_group("sign")){n=n.get_child([1]);i++}if(i){t.get_child([1]).remove();n.remove();t.append(n)}e+=i},this);return e};e.prototype.nodesProductIsInMidFactoring=function(t){if(t.fraction)return false;if(t.addend.is_group("sub"))return false;var e=t.product.get_child([0,1]),i=t.product.get_last_child().children[1];if(t.left_of_target&&t.range.indexOf(e.parent)!==-1)return false;if(!t.left_of_target&&t.range.indexOf(i.parent)!==-1)return false;if(!(e.is_group("brackets")&&e.children[1].is_group("sum"))&&t.left_of_target||!(i.is_group("brackets")&&i.children[1].is_group("sum"))&&!t.left_of_target)return false;if(t.product.children.length-1!==t.range.length)return false;return true};e.prototype.reinterpretNodesStructureForFactoring=function(t){t.range.forEach(function(t){t.remove()});var e=this.rearrangeStructure(t);return e};e.prototype.rearrangeStructure=function(t){var e=_.prototype.createGroup();t.range.forEach(function(t){e.append(t)});var i=new _(e);this.cleanupProductOfCoefficients(t);var n=m.prototype.createGroup();t.addend.remove();t.addend.dragging=false;t.addend.selected=false;n.append(t.addend);var r=t.addend.get_idx();var o=new c(n);var s=_.prototype.createGroup();if(t.left_of_target){s.append(new _(o));s.append(i)}else{s.append(i);s.append(new _(o))}var a=new m(s);var l={};l.idx_of_addend=r;l.addend=a;l.product=s;l.sum_of_coefficients=n;l.left_of_target=t.left_of_target;l.range=[i];return l};e.prototype.cleanupProductOfCoefficients=function(t){var e,i;if(t.fraction){e=t.fraction.parent;this.cleanup(t.fraction);if(e.is_group("mul")&&a.get_value(e.children[1])===1){e.remove();i=true}}if(t.product){if(e&&!i)this.cleanup(e);this.cleanup(t.product)}};e.prototype.reinterpretTargetStructureForMergingWithNodes=function(t){t.addend.remove();t.range.forEach(function(t){t.remove()});if(t.fraction&&t.fraction.get_top().length===1&&a.is_num(t.fraction.get_child([0,1]))&&a.get_value(t.fraction.get_child([0,1]))===1&&t.fraction.get_parent(1).is_group("mul")){t.fraction.get_parent(1).remove()}};e.prototype.insertTargetCoefficientsIntoCoefficientsSum=function(t,e){if(e.left_of_target)e.sum_of_coefficients.append(t.addend);else e.sum_of_coefficients.insert(0,t.addend)};e.prototype.reapplyNegatives=function(t,e,i,n,r,o,s){if(o%2===1&&s%2===1){var a=t[0],l=a.get_child([1]);l.remove();l=new f(l);a.append(l);if(e.addend.is_group("sub"))this.extendNodeMap(e.addend.get_child([0]),l.get_child([0]));else e.negative_groups.forEach(function(t,e){if(e===0)this.updateNodeMap(t.get_child([0]),l.get_child([0]))},this);if(n.addend.is_group("sub"))this.extendNodeMap(n.addend.get_child([0]),l.get_child([0]));else n.negative_groups.forEach(function(t,e){if(e===0)this.updateNodeMap(t.get_child([0]),l.get_child([0]))},this)}else if(o!==s&&Math.abs(o-s)%2===1){var h=i.left_of_target?i.sum_of_coefficients.children.length-1:0,p=i.sum_of_coefficients.get_child([h]);if(o>s){i.sum_of_coefficients.children.forEach(function(t,i){if(i!==h){t.invert();if(e.addend.is_group("sub"))this.extendNodeMap(e.addend.get_child([0]),t.get_child([0]));else e.negative_groups.forEach(function(e,i){if(i===0)this.extendNodeMap(e.get_child([0]),t.get_child([0]))},this)}},this)}else{p.invert();if(n.addend.is_group("sub"))this.updateNodeMap(n.addend.get_child([0]),p.get_child([0]));else n.negative_groups.forEach(function(t,e){if(e===0)this.updateNodeMap(t.get_child([0]),p.get_child([0]))},this)}}};e.prototype.mapOldTargetFactorsToNewFactors=function(t,e){t.factors.forEach(function(t,i){this.updateNodeMap(t.get_mapping_to(gmath.factoring.bypass_negatives(e[i].children[1])))},this)};e.prototype.cleanupTermsInCoefficientsSum=function(t){var e=t.sum_of_coefficients;for(var i=0;i<e.children.length;i++){var n=e.get_child([i,1]);if(n.is_group("product")){n.children.forEach(function(t){var e=t.get_child([1]);if(e.is_group("fraction"))this.cleanup(e)},this)}this.cleanup(n)}for(var i=0;i<e.children.length;i++){var n=e.get_child([i]);c.handle(n,true);this.cleanup(n)}};e.prototype.cleanupTermsInProductOfCoefficentsSumAndVariables=function(t){var e=t.product;for(var i=0;i<e.children.length;i++){this.cleanup(e.children[i].children[1])}for(var i=0;i<e.children.length;i++){this.cleanup(e.children[i])}};return new e}();r.prototype.move_actions.push(gmath.actions.FactorCommonTermsAction);gmath.actions.FlipTermAction=function(){var e=function(t){Action.call(this,"FlipTermAction","flip a term into a denominator");this.priority=0;this.triggerType="drag";this.settings={delay:1500,on_release:true,side:"below",reset_y:true,margin:{y:-.05}};if(t){this.nodes=t.nodes;this.target=t.target}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){if(!this.matchSource(t))return[];return this.bindActionForEachTarget(t,t)};e.prototype.matchSource=function(t){if(t.length!==1)return false;var e=t[0];if(e.is_group("exponent"))e=e.get_term();else if(e.is_group("mul","div","add","sub"))e=e.children[1];if(e.is_group("equals","param")||E.is_inequality(e))return false;return true};e.prototype.transform=function(t){this.addTouchedNodes(this.nodes);var e=this.getNewTreeNode(this.target);if(e.is_group("exponent"))e=e.get_term();if(e.is_group("mul","div","add","sub"))e=e.children[1];var i=this.getTransformFunction(e);this.replaceWithFlippedFraction(e,i.bind(this));if(typeof t==="function")t(this);return this};e.prototype.getTransformFunction=function(t){var e;if(t.is_group("power"))e=this.flipPower;else if(t.is_group("fraction"))e=this.flipFraction;else e=this.flipTerm;return e};e.prototype.replaceWithFlippedFraction=function(t,e){var i=t.get_parent(1),n=t.remove();var r=new v;r.append(new _(new a(1)));var o=e(t);var s=new _(o,"div");r.append(s);this.setNodesToReselectAfterAction(s);i.insert(n,r);this.cleanup(s.children[1]);c.handle(r)};e.prototype.flipPower=function(t){this.flipExponent(t.get_child([1]));return t};e.prototype.flipExponent=function(t){var e=t.get_child([0]);if(c.areHidden(e))e=e.children[1];if(e.is_group("product"))e=e.get_child([0,1]);this.makeTermNegative(e);c.handle(t.children[0],true);if(a.is_equal_to(t.get_term(),1))t.remove()};e.prototype.makeTermNegative=function(t){if(t.is_group("sum"))t.children.forEach(function(t){t.invert()});else if(t.is_group("sign"))t.replace_with(t.get_child([1]));else{var e=t.get_parent(1),i=t.remove();var n=new f(t);e.insert(i,n)}};e.prototype.flipFraction=function(e){var i=e.get_top(),n=e.get_bottom();t.remove_range(i);t.remove_range(n);n.forEach(function(t){t.invert();e.append(t)});i.forEach(function(t){t.invert();e.append(t)});
return e};e.prototype.flipTerm=function(t){var e=this.convertToEquivalentPowerForm(t);return this.flipPower(e)};e.prototype.convertToEquivalentPowerForm=function(t){var e=new y(t,new a(1));return e};return new e}();r.prototype.move_actions.push(gmath.actions.FlipTermAction);gmath.actions.FlipTermAcrossFractionAction=function(){var e=function(t){Action.call(this,"FlipTermAcrossFractionAction","flip a term into a denominator");this.priority=1;this.triggerType="drag";this.settings={delay:1500,reset_y:true,target_group:true,group_side:"around"};if(t){this.nodes=t.nodes;this.target=t.target;this.settings.side=t.side}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){var e=this.matchSource(t);if(!e)return[];var i=this.getTargets(e);return this.adjustTargetBoxes(this.bindActionForEachTarget(t,i,true))};e.prototype.matchSource=function(e){if(!t.is_range(e))return false;var i=e[0];if(!i.is_group("mul","div")||!i.get_parent(1).is_group("fraction"))return false;i=i.get_child([1]);return{nodes:e,frac:e[0].get_parent(1)}};e.prototype.getTargets=function(t){return t.nodes[0].is_group("mul")?t.frac.get_bottom():t.frac.get_top()};e.prototype.adjustTargetBoxes=function(t){t.forEach(function(t){if(t.target.is_group("div"))t.settings.margin={y1:.3};else t.settings.margin={y2:.3}},this);return t};e.prototype.transform=function(e){this.addTouchedNodes(this.nodes);var i=this.getNewTreeNode(this.nodes),n=this.getNewTreeNode(this.target),r=i[0].get_parent(1);t.remove_range(i);if(i[0].is_group("div")){var o=r.get_top();if(o.length===1&&a.get_value(o[0].get_child([1]))===1)o[0].remove()}i.forEach(function(t){var e=t.get_child([1]),i=gmath.actions.FlipTermAction.getTransformFunction(e).bind(gmath.actions.FlipTermAction);e.remove();e=i(e);t.append(e);t.invert()},this);var s=n.get_idx()===-1?0:n.get_idx()+(this.settings.side==="right-of"?1:0);r.insert_range(s,i);var l=false;i.forEach(function(t){l=l||this.cleanup_cascade(t.children[1])},this);if(!l)this.cleanup_cascade(r);if(typeof e==="function")e(this);return this};return new e}();r.prototype.move_actions.push(gmath.actions.FlipTermAcrossFractionAction);gmath.actions.FractionExtendAction=function(){var t=function(t){Action.call(this,"FractionExtendAction","extend fraction");this.priority=0;this.triggerType="hold";this.settings={asynchronous:true};this.latex=null;if(t)this.actor=t.actor};gmath.inherit(Action,t);t.prototype.toJSON=function(){var t=Action.prototype.toJSON.call(this);if(this.latex)t.term=this.latex;return t};t.prototype.match=function(t){if(!gmath.ui||!gmath.ui.Keyboard)return false;return t.is_group("fraction")};t.prototype.transform=function(e){var i;if(this.latex){i=this.newTree.parse(this.latex,true);this.extendFraction(this.getNewTreeNode(this.actor),i);if(typeof e==="function")e(this);return this}var n=gmath.ui.Keyboard();n.caption("Enter a term with which to multiply the numerator and denominator of this fraction.").latex("").on("done."+this.name,r.bind(this)).on("cancel."+this.name,o.bind(this)).visible(true);function r(r){try{i=this.newTree.parse(r,true);this.latex=r}catch(t){console.log(t);n.warning("Could not parse expression.");return}if(!t.acceptTerm(i)){n.warning("Can't extend the fraction with this expression.");return}this.extendFraction(this.getNewTreeNode(this.actor),i);this.endKeyboardInteraction(n);e(this)}function o(){this.endKeyboardInteraction(n);e(false)}};t.acceptTerm=function(t){return!(t.is_group("brackets")&&t.get_child([1]).is_group("tuple"))&&!t.is_group("equals")};t.prototype.extendFraction=function(t,e){t.append(new _(e,"mul"));t.append(new _(e.clone(),"div"));this.cleanup(t)};t.prototype.endKeyboardInteraction=function(t){t.visible(false);t.on("done."+this.name,null).on("cancel."+this.name,null);return false};var e=new t;v.prototype.add_action_handler(e);return e}();gmath.actions.SplitNumeratorAction=function(){var e=function(t){Action.call(this,"SplitNumeratorAction","split numerator into new fractions with same denominators");this.priority=0;this.triggerType="drag";this.settings={};if(t){this.nodes=t.nodes;this.target=t.target;this.settings.side=Array.isArray(this.target)?"around":t.side;this.settings.target_is_left=t.side==="left-of";this.settings.offset={x:this.settings.target_is_left?-10:10,y:0}}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){if(t.length===0)return[];var e=t[0];if(!e.parent||!e.parent.parent||!e.parent.parent.parent||!e.parent.parent.parent.parent)return[];if(!(e.is_group("add")||e.is_group("sub"))||!e.parent.parent.parent.is_group("mul")||!e.parent.parent.parent.parent.is_group("fraction"))return[];if(e.parent.parent.parent.parent.get_top().length>1)return[];if(this.match(t,e.parent.parent.parent.parent)){return[this.bindAction(t,"left-of"),this.bindAction(t,"right-of")]}return[]};e.prototype.bindAction=function(t,e){var i=t[0].get_root();var n=[];if(this.fractionIsPartOfProduct(t)){n=this.getSiblingsOfFraction(t,e)}return this.createBoundAction(i,{nodes:t,target:n.length>0?n:t[0].parent.parent.parent.parent,side:e})};e.prototype.fractionIsPartOfProduct=function(t){var e=t[0].parent;return e.parent&&e.parent.is_group("sum")};e.prototype.getSiblingsOfFraction=function(t,e){var i=t[0].parent,n=i.parent,r=n.parent;if(e==="left-of")return r.children.slice(0,r.children.indexOf(n));else return r.children.slice(r.children.indexOf(n)+1)};e.prototype.match=function(t,e){if(t.length===0)return false;return t[0]&&(t[0].is_group("add")||t[0].is_group("sub"))&&t[0].parent.parent.parent.parent===e&&e.is_group("fraction")};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.nodes);this.addTouchedNodes(this.nodes[0].parent.parent.parent.parent);var n=this.nodes[0].parent.parent.parent.parent.get_bottom(),r=this.nodes[0].parent.parent.parent.parent.children[1];var o=i[0].parent.parent.parent.parent;t.remove_range(i);var s=m.prototype.createGroup();o.replace_with(s);s.append(new m(o));var a=o.get_bottom();var l=new v;l.invert();var h=m.prototype.createGroup();h.append_range(i);l.insert(0,new _(h));for(var p=0;p<a.length;p++){var u=t.clone(a[p]);l.append(u);this.extendNodeMap(n[p].get_mapping_to(u))}this.extendNodeMap(r,l.children[1]);var d=new m(l);var f=this.settings.target_is_left;s.insert(f?0:1,d);var g=this.rearrangeSumIfNumeratorIsASingleTerm(s,0),y=this.rearrangeSumIfNumeratorIsASingleTerm(s,1);if(f&&!g||!f&&!y){for(var p=0;p<i.length;p++){this.updateNodeMap(i[p],d)}}var b=o.get_top(),w=l.get_top();if(b.length===1)this.cleanup(b[0]);if(w.length===1)this.cleanup(w[0]);this.cleanup(s.parent);c.handle(s);if(typeof e==="function")e(this);else return true};e.prototype.rearrangeSumIfNumeratorIsASingleTerm=function(t,e){var i=t.children[e],n=i.children[1];if(n.children[0].children[1].children[1].children.length===1){var r=n.children[0].children[1].children[1],o=r.children[0],s=o.children[1],a=r.parent.parent;r.parent.remove();o.remove();s.remove();r.remove();n.remove();i.remove();t.insert(e,o);o.append(n);a.append(s);return true}return false};return new e}();r.prototype.move_actions.push(gmath.actions.SplitNumeratorAction);gmath.actions.DivideRationalNumbersAction=function(){var t=function(t){Action.call(this,"DivideRationalNumbersAction","division of numbers");this.triggerType="drag";this.priority=2;this.settings={delay:400,side:"inside"};if(t){this.nodes=t.nodes;this.target=t.target}};gmath.inherit(Action,t);t.prototype.getAllAvailableActions=function(t){if(t.length!==1)return[];var e=t[0].parent.match("{n: ±\\NUM} / {d: ±\\NUM}");if(!e||!this.isRational(e.n)&&!this.isRational(e.d))return[];if(t[0]!==e.d.parent)return[];return this.createBoundAction(t[0].get_root(),{nodes:t,target:e.n.parent})};t.prototype.isRational=function(t){return a.get_value(t)!==(a.get_value(t)|0)};t.prototype.transform=function(t){this.old_dragged_term=this.nodes[0];this.old_target_term=this.target;this.addTouchedNodes(this.old_dragged_term);this.addTouchedNodes(this.old_target_term);var i=this.getNewTreeNode(this.old_dragged_term),n=this.getNewTreeNode(this.old_target_term),r=i.children[1],o=n.children[1],s=i.parent;var l=a.get_value(o)/a.get_value(r);if(n.is_group("div"))l=1/l;var h=new _(new a(l),n.value);e(this.old_dragged_term,h,this);e(this.old_target_term,h,this);var p=n.remove();s.insert(p,h);i.remove();this.cleanup(s);if(typeof t==="function")t(this);return this};function e(t,e,i){i.updateNodeMap(t,e);i.updateNodeMap(t.children[0],e.children[0]);if(!t.children[1].is_group("sign")&&e.children[1].is_group("sign")){i.updateNodeMap(t.children[1].get_mapping_to(e.children[1].children[1]))}else{i.updateNodeMap(t.children[1].get_mapping_to(e.children[1]))}}return new t}();r.prototype.move_actions.push(gmath.actions.DivideRationalNumbersAction);(function(){var e=function(t){Action.call(this,"CommutativeGroupCleanup","group cleanup action");if(t)this.group=t.actor};gmath.inherit(Action,e);gmath.actions.CommutativeGroupCleanup=e;e.prototype.match=function(t){return t.is_group()&&(!t.has_children()||t.children.length===1)};e.prototype.doInPlace=function(e){this.initNodeMap();var i=this.getNewTreeNode(this.group);if(i.children.length===0){t.remove(i)}else if(i.children.length===1){var n=i.children[0],r=this.group.children[0],o=n.children[1];this.updateNodeMap(r.children[0],o);this.updateNodeMap(r,o);this.updateNodeMap(r.parent,o);t.replace(n.parent,o);if(o.parent.parent)c.handle(o.parent,true);c.handle(o,true)}if(typeof e==="function")e(this);else return this};T.prototype.cleanupAction=new e;x.prototype.cleanupAction=new e})();gmath.actions.SignDoubleNegAction=function(){var e=function(t){Action.call(this,"SignDoubleNegAction","--x=x");this.priority=0;this.triggerType="tap";if(t)this.actor=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){if(t.is_group("sign")&&t.children[1].is_group("sign"))return true;if(t.is_group("sign")&&t.parent.is_group("sign"))return true;return false};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.actor);if(i.children[1].is_group("sign")){this.addTouchedNodes(this.actor.children[0]);this.addTouchedNodes(this.actor.children[1].children[0]);t.replace(i,i.children[1].children[1])}else if(i.parent.is_group("sign")){this.addTouchedNodes(this.actor.parent.children[0]);this.addTouchedNodes(this.actor.children[0]);t.replace(i.parent,i.children[1])}if(typeof e==="function")e(this);else return true};f.prototype.add_action_handler(new e);return new e}();(function(){var e=function(t){Action.call(this,"SignZeroAction","-0=0");this.priority=0;this.triggerType="tap";if(t)this.actor=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){return t.children[1]instanceof a&&t.children[1].value===0};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.actor),n=i.children[1];this.addTouchedNodes(this.actor);this.updateNodeMap(this.actor.get_mapping_to(n));t.replace(i,n);if(typeof e==="function")e(this);else return this};f.prototype.add_action_handler(new e)})();gmath.actions.MoveSignIntoBracketsAction=function(){var t=function(t){Action.call(this,"MoveSignIntoBracketsAction","move sign into brackets");this.priority=0;this.triggerType="tap";if(t)this.actor=t.actor};gmath.inherit(Action,t);t.prototype.match=function(t){if(!t.is_group("sign"))return false;if(!t.children[1].is_group("brackets"))return false;var e=t.children[1].children[1];return e.is_group("product","sum")};t.prototype.transform=function(t){this.addTouchedNodes(this.actor);var e=this.getNewTreeNode(this.actor),i=e.children[1],n=i.children[1];var r=e.parent,o=e.remove();i.remove();n.remove();if(n.is_group("product")){this.applySignToProductFraction(n,e)}else{this.applySignToSum(n,e)}r.insert(o,n);this.cleanup(n);c.handle(n);this.cleanup(r);if(typeof t==="function")t(this);else return true};t.prototype.applySignToProductFraction=function(t,e){var i=t.children[0].children[1];i.remove();e.append(i);t.children[0].append(e);if(i.is_group("sign"))this.followup=gmath.actions.SignDoubleNegAction.createBoundAction(this.newTree,{actor:e})};t.prototype.applySignToSum=function(t,e){t.children.forEach(function(t){t.invert()})};f.prototype.add_action_handler(new t);return new t}();(function(){var e=function(t){Action.call(this,"CalculatePowerAction","calculate a power");this.priority=0;this.triggerType="tap";if(t)this.actor=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){var e=t.parent;if(!e.is_group("power"))return false;var i=e.children[0],n=t.children[0];if(i.is_group("brackets"))i=i.children[1];if(!a.is_num(i))return false;if(c.areHidden(n)&&n.children[1].is_group("sign")&&a.is_num(n.children[1].children[1]))n=n.children[1].children[1];if(!a.is_num(n)||a.get_value(n)===0)return false;if(Math.round(a.get_value(n))!==a.get_value(n)&&a.get_value(i)<0)return false;return true};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.actor);this.addTouchedNodes(this.actor.parent);var n=i.parent,r=n.children[0],o=i.children[0];if(r.is_group("brackets"))r=r.children[1];if(o.is_group("brackets"))o=o.children[1];var s=new a(Math.pow(a.get_value(r),a.get_value(o)));this.updateNodeMap(this.actor.parent.get_mapping_to(s));t.replace(n,s);if(typeof e==="function")e(this);else return true};b.prototype.add_action_handler(new e)})();gmath.actions.PowerConvertToRadicalAction=function(){var e=function(t){Action.call(this,"PowerConvertToRadicalAction","flip a term into a denominator");this.priority=0;this.triggerType="drag";this.settings={delay:1500,on_release:true,side:"left-of",reset_y:true,margin:{x1:-.4,y2:.5,y1:-.2}};if(t){this.nodes=t.nodes;this.target=t.target}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){if(!this.matchSource(t))return[];return this.bindActionForEachTarget(t,[t[0].parent])};e.prototype.matchSource=function(t){return t.length===1&&t[0].is_group("exponent")};e.prototype.transform=function(e){this.addTouchedNodes(this.target);var i=this.getNewTreeNode(this.nodes)[0],n=i.parent,r=n.children[0],o=n.parent,s=n.remove();r.remove();i.remove();var l=i.get_term(),h=new D,p=new v;if(l.is_group("fraction")){var u=l.get_top(),d=l.get_bottom();t.remove_range(u);t.remove_range(d);u.forEach(function(t){t.invert()});d.forEach(function(t){t.invert()});p.append_range(d);if(!(u.length===1&&a.is_equal_to(u[0].children[1],1)))p.append_range(u)}else if(l.is_group("product")){var f=l.children.slice();t.remove_range(f);f.forEach(function(t){t.invert()});p.append_range(f)}else{p.append(new _(l,"div"))}h.append(p);c.handle(p);var g=new q(r,h);o.insert(s,g);this.updateNodeMap(this.nodes[0],h);this.updateNodeMap(this.nodes[0].parent,g);this.cleanup(p);if(typeof e==="function")e(this);return this};return new e}();r.prototype.move_actions.push(gmath.actions.PowerConvertToRadicalAction);(function(){var e=function(t){Action.call(this,"PowerCleanup","power cleanup action");if(t)this.actor=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){if(e.powerWithoutExponent(t))return true;return false};e.powerWithoutExponent=function(t){if(t.is_group("power")&&t.children.length===1)return true;return false};e.prototype.doInPlace=function(i){this.initNodeMap();var n=this.getNewTreeNode(this.actor);var r=n.parent,o=this.actor.parent;if(e.powerWithoutExponent(n)){var s=n.children[0],a=this.getOldTreeNode(s);var l=t.remove(n);this.updateNodeMap(this.actor,r);r.insert(l,s)}if(typeof i==="function")i(this);else return this};y.prototype.cleanupAction=new e})();(function(){function e(t,i,n,r){var o=n;r[t]=[i];if(o.has_children()){for(var s=0;s<o.children.length;s++){e(t.concat(s),i.concat(s),n.children[s],r)}}}var i=function(t){Action.call(this,"xToOneAction","x^1=x");this.priority=0;this.triggerType="tap";if(t)this.actor=t.actor};gmath.inherit(Action,i);i.prototype.match=function(t){return t.children[0]instanceof a&&t.children[0].value===1};i.prototype.transform=function(e){var i=this.getNewTreeNode(this.actor);this.addTouchedNodes(this.actor);var n=i.ls;t.remove(n);i.parent.replace_with(n);c.handle(n);this.updateNodeMap(this.actor.parent,n);this.updateNodeMap(this.actor,n);this.updateNodeMap(this.actor.children[0],n);if(typeof e==="function")e(this);else return true};b.prototype.add_action_handler(new i)})();(function(){var e=function(t){Action.call(this,"xToZeroAction","x^0=1");this.priority=0;this.triggerType="tap";if(t)this.actor=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){return t.children[0]instanceof a&&t.children[0].value===0&&t.ls.to_ascii()!=="0"};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.actor);this.addTouchedNodes(this.actor.parent);var n=new a(1);this.updateNodeMap(this.actor.parent.get_mapping_to(n));t.replace(i.parent,n);if(typeof e==="function")e(this);else return true};b.prototype.add_action_handler(new e)})();gmath.actions.CollectExponentsForFactoring=function(){var t=function(t){Action.call(this,"CollectExponentsForFactoring","collect exponents");this.settings={makes_no_changes:true,side:"inside"};if(t){this.nodes=t.nodes;this.target=t.target}};gmath.inherit(Action,t);t.prototype.getAllAvailableActions=function(t){var e=t[0].get_root(),i=this;try{var n=this.analyzeNodeStructure(t);if(n.length===0)return[];var r=n[0].prod,o=[];for(var s=0;s<r.children.length;s++){try{var a=r.get_child([s,1,1]);var l=this.getTargetRangesInExponent(a,n);l.forEach(function(n){o.push(i.createBoundAction(e,{nodes:t,target:n[0].is_group("product")?[n[0].parent.parent]:n}))})}catch(t){if(t!=="invalid path")throw t}}return o}catch(t){if(t!=="invalid path"&&t!=="wrong structure")throw t}return[]};t.prototype.transform=function(t){var e=this.getNewTreeNode(this.nodes[0]),i=this.getNewTreeNode(this.target);this.updateNodeMap(this.nodes[0],[e].concat(i));if(typeof t==="function")t(this);else return true};t.prototype.analyzeNodeStructure=function(t){var e=r.groupNodeRanges(t);if(e.length===0)return[];var i=e.map(function(t){if(t.length===1&&t[0].is_group("exponent")){var e=t[0].children[0];if(c.areHidden(e)){e=e.children[1]}return{range:t,exp:t[0],prod:t[0].get_parent(3),ascii:e.to_ascii()}}else{if(!t.every(function(t){return t.is_group("mul","div")}))throw"wrong structure";return{range:t,exp:t[0].get_parent(3),prod:t[0].get_parent(6),ascii:r.rangeToAsciiNoLeadingOp(t,true)}}});for(var n=0;n<i.length;n++){var o=i[n];if(o.ascii!==i[0].ascii)return[];if(!o.exp.is_group("exponent"))return[];if(!o.prod.is_group("fraction","product")||o.prod!==i[0].prod)return[];for(var s=n+1;s<i.length;s++){if(o.exp===i[s].exp)return[]}}return i};t.prototype.getTargetRangesInExponent=function(t,e){var i=t.get_root();if(!t.is_group("exponent"))return[];var n=e[0].ascii;for(var r=0;r<e.length;r++)if(e[r].exp===t)return[];var o=i.getRanges(n,null,t.children);if(o.length===0)return[];o=o.filter(function(e){var i=e[0];return i.parent===t||i.parent.is_group("brackets")&&i.ls.hidden&&i.get_parent(2)===t||i.is_group("mul","div")&&i.get_parent(3)===t||i.parent.is_group("mul")&&i.get_parent(4)===t});return o.map(function(t){if(t.length===1){if(t[0].parent.is_group("exponent","mul"))return[t[0].parent]}return t})};return new t}();r.prototype.move_actions.push(gmath.actions.CollectExponentsForFactoring);gmath.actions.FactorPowerAction=function(){var e=function(t){Action.call(this,"FactorPowerAction","factor power");this.interactionType="drag";this.settings={side:"outside",reset_y:true};if(t){this.nodes=t.nodes;this.target=t.target;if(t.margin)this.settings.margin=t.margin}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){var e,i=this.getEncompassingRange(t);if(this.thereIsALonePower(t)){if(this.transformationWouldLeaveExponentOfOne(t)){return[]}e=this.bindActionForLonePowerCases(t,i.length-1)}else if(i.length>0){e=this.bindActionForMultiplePowerCases(t,i)}else{return[]}return e};e.prototype.transform=function(t){if(Array.isArray(this.target)){for(var e=0;e<this.target.length;e++){this.addTouchedNodes(this.target[e])}}else{this.addTouchedNodes(this.target)}var i=r.groupNodeRanges(this.nodes);var n=this.getNewTreeNode(this.nodes),o=r.groupNodeRanges(n);var s;if(this.thereIsOneRange(o)){s=this.factorFromALonePower(n)}else{s=this.factorFromMultiplePowers(o)}this.mapOldRangesToNewRange(i,s);if(typeof t==="function")t(this);else return true};e.prototype.factorFromALonePower=function(t){var e=this.extractRangeFromExponent(t);return this.wrapTermInPower(e,t)};e.prototype.factorFromMultiplePowers=function(t){var e=this.getParentGroupOfPowers(t[0][0]);var i;if(!this.productFractionHasUnaffectedTerms(e,t)){i=this.performTransformationWithoutUnaffectedTerms(t,e)}else{i=this.performTransformationWithUnaffectedTerms(t,e)}return i};e.prototype.productFractionHasUnaffectedTerms=function(t,e){if(t.is_group("product")){return t.children.length>e.length}else{return t.children.length-1>e.length}};e.prototype.performTransformationWithoutUnaffectedTerms=function(t,e){for(var i=0;i<t.length;i++){this.extractRangeFromExponent(t[i])}return this.wrapTermInPower(e,t[0])};e.prototype.performTransformationWithUnaffectedTerms=function(t,e){var i=this.getAffectedTerms(t);var n=this.getIDXForFactoredStructure(i);var r=this.putAffectedTermsIntoASeparateProduct(i);var o;if(r.is_group("product")){e.insert(n,new _(r,e.is_group("fraction")&&n>e.get_top().length?"div":"mul"))}else{var s=e.parent,a=e.remove();var l=_.prototype.createGroup();l.append(new _(e));l.append(new _(r));s.insert(a,l);this.cleanup(e);this.cleanup(l.children[0])}for(var h=0;h<t.length;h++){this.extractRangeFromExponent(t[h])}o=this.wrapTermInPower(r,t[0]);return o};e.prototype.getIDXForFactoredStructure=function(t){var e;for(var i=0;i<t.length;i++){var n=t[i],r=n.parent.children.indexOf(n);if(!e&&e!==0)e=r;else if(r<e)e=r}return e};e.prototype.putAffectedTermsIntoASeparateProduct=function(t){var e=_.prototype.createGroup();t.forEach(function(t){t.remove()});if(t.every(function(t){return t.is_group("div")})){t.forEach(function(t){t.invert()})}for(var i=0;i<t.length;i++){e.append(t[i])}return e};e.prototype.mapOldRangesToNewRange=function(t,e){for(var i=0;i<t.length;i++){var n=t[i];for(var r=0;r<n.length;r++){if(n[r].is_group("exponent")){this.updateNodeMap(n[r].get_mapping_to(e))}else if(n[r].is_group("mul")){if(e.children[0].is_group("brackets")&&e.children[0].children[1].is_group("product")){this.updateNodeMap(n[r].get_mapping_to(e.children[0].children[1].children[r]))}else{this.updateNodeMap(n[r],e);if(this.newTree!==this.oldTree){this.updateNodeMap(n[r].children[1],e.children[0])}}}}}};e.prototype.extractRangeFromExponent=function(e){if(e[0].is_group("exponent")){var i=e[0].parent.parent,n=e[0].parent,r=n.children[0],o=e[0];var s=n.remove();r.remove();o.remove();i.insert(s,r);return r}else{var n=e[0].get_parent(4),o=n.children[1],a=o.children[0],l=a.children[1];t.remove_range(e);this.cleanup(l);return n}};e.prototype.wrapTermInPower=function(t,e){var i,n,r;if(t.parent.is_group("brackets")){i=t.parent;n=i.parent;r=i.remove()}else{n=t.parent;r=t.remove();i=new c(t)}var o;var s;if(e[0].is_group("exponent")){o=e[0]}else if(e[0].is_group("mul")&&e.length===1){o=e[0].children[1];o.remove();o=new b(o)}else{s=_.prototype.createGroup();for(var a=0;a<e.length;a++){s.append(e[a])}o=new b(s)}var l=new y(i,o);if(i.is_group("brackets"))i.simplify=true;n.insert(r,l);c.handle(l);if(s)this.cleanup(s);return o};e.prototype.getParentGroupOfPowers=function(t){if(t.is_group("exponent"))return t.parent.parent.parent;else return t.parent.parent.parent.parent.parent.parent};e.prototype.getAffectedTerms=function(t){var e=[];for(var i=0;i<t.length;i++){e.push(this.getParentMulFromExponentTerm(t[i][0]))}return e};e.prototype.getParentMulFromExponentTerm=function(t){if(t.is_group("exponent"))return t.parent.parent;else return t.parent.parent.parent.parent.parent};e.prototype.thereIsOneRange=function(t){return t.length===1};e.prototype.thereIsALonePower=function(t){return t.length===1&&t[0].is_group("exponent")||this.allNodesAreMulsWithinSameProduct(t)};e.prototype.transformationWouldLeaveExponentOfOne=function(t){if(!t[0].is_group("mul","div")){return false}var e=t[0].parent;if(e.is_group("product")&&t.length+1===e.children.length){var i;for(var n=0;n<e.children.length;n++){var r=e.children[n];if(t.indexOf(r)===-1){i=r;break}}if(a.get_value(r.children[1])===1){return true}}else if(e.is_group("fraction")&&t.every(function(t){return t.is_group("div")})){var o=e.get_top();if(o.length===1&&a.get_value(o[0].children[1])===1){return true}}return false};e.prototype.allNodesAreMulsWithinSameProduct=function(t){var e;for(var i=0;i<t.length;i++){var n=t[i];if(!n.is_group("mul","div"))return false;if(!e)e=n.parent;else if(n.parent!==e)return false}return true};e.prototype.bindActionForLonePowerCases=function(t,e){var i;var n={all:-.5};try{var r=t[0];if(r.is_group("exponent")){var o=r.get_parent(2);if(o.is_group("brackets")&&!o.parent.is_group("power")){i=this.createBoundAction(r.get_root(),{nodes:t,target:o})}else return[]}else if(r.is_group("mul","div")){var s=r.get_parent(2),a=s.get_parent(1),l=a.get_parent(1),h=l.get_parent(1);if(!s.is_group("brackets")||!a.is_group("exponent")||!l.is_group("power"))return[];var p;if(!h.is_group("brackets","mul","div"))p=l;else if(h.is_group("brackets")&&!h.parent.is_group("power"))p=h;else if(h.is_group("mul","div")&&e>0){n.all=-1.5;p=h.parent}else if(h.is_group("mul","div")&&e<=0)p=l;else return[];i=this.createBoundAction(r.get_root(),{nodes:t,target:p,margin:n?n:null})}else return[]}catch(t){if(t==="invalid path")return[];else throw t}return[i]};e.prototype.bindActionForMultiplePowerCases=function(t,e){var i;if(e.length===0)return[];var n=this.getBestTarget(e);i=[this.createBoundAction(t[0].get_root(),{nodes:t,target:n})];return i};e.prototype.getEncompassingRange=function(e){var i=e[0].get_root(),n=this;try{var r=this.analyzeNodeStructure(e);if(r.length===0)return[];var o=r[0].prod,s=[];for(var a=0;a<o.children.length;a++){try{var l=o.get_child([a,1,1]);var h=this.getTargetRangesInExponent(l,r);h.forEach(function(t){s=s.concat(t)})}catch(t){if(t!=="invalid path")throw t}}return t.nodes_to_range(s)}catch(t){if(t!=="invalid path"&&t!=="wrong structure")throw t}return[]};e.prototype.analyzeNodeStructure=function(t){var e=r.groupNodeRanges(t);if(e.length===0)return[];var i=e.map(function(t){if(t.length===1&&t[0].is_group("exponent")){var e=t[0].children[0];return{range:t,exp:t[0],prod:t[0].get_parent(3),ascii:c.areHidden(e)?e.children[1].to_ascii():e.to_ascii()}}else{if(!t.every(function(t){return t.is_group("mul","div")}))throw"wrong structure";return{range:t,exp:t[0].get_parent(3),prod:t[0].get_parent(6),ascii:r.rangeToAsciiNoLeadingOp(t,true)}}});for(var n=0;n<i.length;n++){var o=i[n];if(o.ascii!==i[0].ascii)return[];if(!o.exp.is_group("exponent"))return[];if(!o.prod.is_group("fraction","product")||o.prod!==i[0].prod)return[];for(var s=n+1;s<i.length;s++){if(o.exp===i[s].exp)return[]}}return i};e.prototype.getTargetRangesInExponent=function(t,e){var i=t.get_root();if(!t.is_group("exponent"))return[];var n=e[0].ascii;var r=i.getRanges(n,null,t.children);if(r.length===0)return[];r=r.filter(function(e){var i=e[0];return i.parent===t||i.parent.is_group("brackets")&&i.ls.hidden&&i.get_parent(2)===t||i.is_group("mul","div")&&i.get_parent(3)===t||i.parent.is_group("mul","div")&&i.get_parent(4)===t});return r.map(function(t){if(t.length===1){if(t[0].is_group("fraction")&&c.areHidden(t[0].parent)&&t[0].get_parent(2).is_group("exponent"))return[t[0].get_parent(2)];if(t[0].parent.is_group("exponent","mul"))return[t[0].parent]}return t})};e.prototype.getBestTarget=function(t){var e;var i=t[0].parent;if(i.is_group("product")&&i.children.length>t.length||i.is_group("fraction")&&i.children.length-1>t.length){e=t}else{var n=t[0].parent.parent;if(n.is_group("brackets")&&!c.areHidden(n))e=n;else e=t[0].parent}return e};return new e}();r.prototype.move_actions.push(gmath.actions.FactorPowerAction);gmath.actions.DistributePowerAction=function(){var e=function(t){Action.call(this,"DistributePowerAction","distribute power");this.triggerType="drag";this.settings={side:"inside",reset_x:true,reset_y:true};if(t){this.nodes=t.nodes;this.target=t.target}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){var e=t[0].get_root();var i,n,r;try{if(this.nodesAreASingleExponent(t)){r=t[0];n=r.parent;i=n.children[0]}else if(this.nodesAreAllMulDivs(t)&&this.nodesAreAConsecutiveRange(t)){r=t[0].get_parent(3);n=r.get_parent(1);i=n.children[0]}else{return[]}}catch(t){if(t!=="invalid path")throw t;return[]}if(!r.is_group("exponent")||!n.is_group("power")||!i.is_group("brackets")){return[]}var i=i.children[1];if(i.is_group()&&!i.is_group("power")&&!i.is_group("brackets")&&!i.is_group("product")&&!i.is_group("fraction"))return[];return[this.createBoundAction(e,{nodes:t,target:i})]};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.nodes[0].is_group("exponent")?this.nodes[0]:this.nodes[0].parent.parent.parent);var n=this.getNewTreeNode(this.nodes);var r=this.getNewTreeNode(this.target);var o=i.parent;var s=o.parent;this.addTouchedNodes(this.getOldTreeNode(o));t.remove_range(n);var a;if(r.is_group("product")||r.is_group("fraction")){a=r.get_top().concat(r.get_bottom());this.applyPowersToMulDivs(a,n)}else{a=[this.applyPowerToSingleTerm(r,n)];r=a[0]}if(o.children[1]){this.cleanup(o.children[1].children[0].children[1]);c.handle(o.children[1].children[0],true)}else{var l=o.remove();var h=new c(r);s.insert(l,h);h.simplify=true}if(typeof e==="function")e(this);else return true};e.prototype.nodesAreASingleExponent=function(t){return t.length===1&&t[0].is_group("exponent")};e.prototype.nodesAreAllMulDivs=function(t){for(var e=0;e<t.length;e++){if(!t[e].is_group("mul","div"))return false}return true};e.prototype.nodesAreAConsecutiveRange=function(t){if(t.length===1)return true;var e=t[0];for(var i=1;i<t.length;i++){if(e.rs!==t[i]||e!==t[i].ls)return false;e=t[i]}return true};e.prototype.applyPowersToMulDivs=function(t,e){for(var i=0;i<t.length;i++){var n=t[i].children[1];var r=this.applyPowerToSingleTerm(n,e)}};e.prototype.applyPowerToSingleTerm=function(t,e){var i;if(t.is_group("power")){i=this.applyPowerToPower(t,e)}else{i=this.applyPowerToNonPower(t,e)}return i};e.prototype.applyPowerToPower=function(e,i){var n=e;var r=t.clone(i);var o=this.extendPowerWithSelectedExponentTerms(n,r);this.extendNodeMap(this.nodes[0],o);return n};e.prototype.applyPowerToNonPower=function(e,i){var n,r;n=e.parent;r=e.remove();var o;if(i[0].is_group("exponent"))o=t.clone(i[0]);else{var s=_.prototype.createGroup(),a=t.clone(i);this.appendAllContentsToProduct(s,a);o=new b(s)}var l=new y(e,o);n.insert(r,l);if(s){this.cleanup(s);c.handle(o.children[0],true)}this.mapDraggedExponentTermsToNewExponent(this.nodes,l.children[1]);return l};e.prototype.mapDraggedExponentTermsToNewExponent=function(t,e){for(var i=0;i<t.length;i++){if(t[i].is_group("exponent")){this.extendNodeMap(t[i].get_mapping_to(e))}else{if(e.children[0].is_group("brackets")&&e.children[0].children[1].is_group("product")){this.extendNodeMap(t[i].get_mapping_to(e.children[0].children[1].children[i]))}else{this.extendNodeMap(t[i],e);this.extendNodeMap(t[i].children[1].get_mapping_to(e.children[0]))}}}};e.prototype.takeContentsOfBrackets=function(t){if(t.is_group("brackets")){t=t.children[1];t.remove()}return t};e.prototype.extendPowerWithSelectedExponentTerms=function(t,e){var i=t.children[1];var n=_.prototype.createGroup(),r=this.getContentMulsFromExponent(i);var o=e[0].is_group("exponent")?this.getContentMulsFromExponent(e[0]):e;this.appendAllContentsToProduct(n,r);this.appendAllContentsToProduct(n,o);i.append(n);this.cleanup(n);c.handle(n,true);this.mapDraggedExponentTermsToNewExponentTerms(this.nodes,i,o);return o};e.prototype.appendAllContentsToProduct=function(t,e){for(var i=0;i<e.length;i++){t.append(e[i])}};e.prototype.mapDraggedExponentTermsToNewExponentTerms=function(t,e,i){if(t[0].is_group("mul")){for(var n=0;n<t.length;n++){this.extendNodeMap(t[n].get_mapping_to(i[n]))}}else if(t[0].is_group("exponent")){var r=t[0].children[0];if(r.is_group("brackets")&&r.children[1].is_group("product")){
for(var n=0;n<r.children[1].children.length;n++){var o=r.children[1].children[n];this.extendNodeMap(t[0],i[n]);this.extendNodeMap(o.get_mapping_to(i[n]))}}else{if(r.is_group("brackets")&&!i[0].children[1].is_group("brackets")){this.extendNodeMap(r.children[1].get_mapping_to(i[0].children[1]))}else{this.extendNodeMap(r.get_mapping_to(i[0].children[1]))}}}};e.prototype.getContentMulsFromExponent=function(e){var i=e.children[0];if(c.areHidden(i)&&i.children[1].is_group("product")){var n=i.children[1].children.slice();t.remove_range(i.children[1].children);i.remove();return n}else if(c.areHidden(i)){var r=i.children[1];r.remove();i.remove();return[new _(r)]}else{i.remove();return[new _(i)]}};return new e}();r.prototype.move_actions.push(gmath.actions.DistributePowerAction);gmath.actions.combineStackedExponentsUpAction=function(){var e=function(t){Action.call(this,"combineStackedExponentsUpAction","combine stacked exponents up");this.interactionType="drag";this.settings={side:"around",reset_y:true};if(t){this.nodes=t.nodes;this.target=t.target}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){if(t.length<1)return[];if(!this.validStructure(t))return[];var e=this.getBaseOfOuterPowerFromInnerExponentTerm(t);var i=e.parent.children[1];var n=[this.createBoundAction(t[0].get_root(),{nodes:t,target:i})];return n};e.prototype.transform=function(t){var e=this.getNewTreeNode(this.nodes),i=this.getNewTreeNode(this.target),n=i.parent.children[0];this.addTouchedNodes(this.target.parent);this.extractSelectedExponentTermsFromInnerPower(e);var r=this.extendOuterExponentWithSelectedExponentTerms(n,e);this.mapSelectedExponentsTermsToNewExponentTerms(this.nodes,r);n.simplify=true;if(typeof t==="function")t(this);else return true};e.prototype.validStructure=function(t){if(this.nodesAreASingleExponent(t)){return this.termsBelongToAPowerWithinAPower(t)}else if(this.nodesAreAllMulDivs(t)&&this.nodesAreAConsecutiveRange(t)){return this.termsBelongToAPowerWithinAPower(t)}else return false};e.prototype.nodesAreASingleExponent=function(t){return t.length===1&&t[0].is_group("exponent")};e.prototype.nodesAreAllMulDivs=function(t){for(var e=0;e<t.length;e++){if(!t[e].is_group("mul","div"))return false}return true};e.prototype.nodesAreAConsecutiveRange=function(t){if(t.length===1)return true;var e=t[0];for(var i=1;i<t.length;i++){if(e.rs!==t[i]||e!==t[i].ls)return false;e=t[i]}return true};e.prototype.termsBelongToAPowerWithinAPower=function(t){try{var e,i,n,r;if(t[0].is_group("exponent")){e=t[0];i=e.get_parent(1);n=i.get_parent(1);r=n.get_parent(1);if(!i.is_group("power")||!n.is_group("brackets")||!r.is_group("power"))return false}else{e=t[0].get_parent(3);i=e.get_parent(1);n=i.get_parent(1);r=n.get_parent(1);if(!e.is_group("exponent")||!i.is_group("power")||!n.is_group("brackets")||!r.is_group("power"))return false}}catch(t){if(t!=="invalid path")throw t;return false}return true};e.prototype.getBaseOfOuterPowerFromInnerExponentTerm=function(t){if(t[0].is_group("exponent"))return t[0].get_parent(2);else return t[0].get_parent(5)};e.prototype.extractSelectedExponentTermsFromInnerPower=function(e){if(e[0].is_group("exponent")){var i=e[0].parent,n=e[0],r=i.children[0],o=i.parent;var s=i.remove();r.remove();n.remove();o.insert(s,r)}else{var a=e[0].parent,l=a.parent;t.remove_range(e);this.cleanup(a)}};e.prototype.extendOuterExponentWithSelectedExponentTerms=function(t,e){var i=t.parent,n=i.children[1];var r=_.prototype.createGroup(),o=this.getContentMulsFromExponent(n);var s=e[0].is_group("exponent")?this.getContentMulsFromExponent(e[0]):e;if(s.some(function(t){return t.is_group("mul")})&&s.some(function(t){return t.is_group("div")})){var a=_.prototype.createGroup();this.appendAllContentsToProduct(a,s);s=[new _(a)]}this.appendAllContentsToProduct(r,o);this.appendAllContentsToProduct(r,s);n.append(r);this.cleanup(r);c.handle(r);return s};e.prototype.appendAllContentsToProduct=function(t,e){for(var i=0;i<e.length;i++){t.append(e[i])}};e.prototype.getContentMulsFromExponent=function(e){var i=e.children[0];if(c.areHidden(i)&&i.children[1].is_group("product","fraction")){var n=i.get_child([1]),r=n.get_top().concat(n.get_bottom());t.remove_range(i.children[1].children);i.remove();return r}else if(c.areHidden(i)){var o=i.children[1];o.remove();i.remove();return[new _(o)]}else{i.remove();return[new _(i)]}};e.prototype.mapSelectedExponentsTermsToNewExponentTerms=function(t,e){for(var i=0;i<t.length;i++){for(var n=0;n<e.length;n++){if(n===0)this.updateNodeMap(t[i],e[n]);else this.extendNodeMap(t[i],e[n])}}};return new e}();r.prototype.move_actions.push(gmath.actions.combineStackedExponentsUpAction);gmath.actions.PowerFactorAndCombineStackedExponentsAction=function(){var t=function(t){Action.call(this,"PowerFactorAndCombineStackedExponentsAction","factor power and combine stacked exponent up");this.triggerType="drag";this.settings={side:"inside"};if(t){this.nodes=t.nodes;this.target=t.target}};gmath.inherit(Action,t);t.prototype.getAllAvailableActions=function(t){if(t.length<2)return[];var e=gmath.actions.FactorPowerAction.getAllAvailableActions(t);if(e.length===0)return[];var i=e[0];if(Array.isArray(i.target))return[];if(!i.target.is_group("brackets"))return[];if(!this.nodesAccountForEveryTermInProduct(i.target.children[1],t))return[];if(!i.target.parent.is_group("power"))return[];var n=i.target.parent.children[1];var r=this.createBoundAction(t[0].get_root(),{nodes:t,target:n});return[r]};t.prototype.nodesAccountForEveryTermInProduct=function(t,e){var i=[];for(var n=0;n<e.length;n++){var o=e[n].parent;while(!o.is_group("power")&&!r.is_top_most(o)){o=o.parent}if(i.every(function(t){return t!==o})){i.push(o)}}return i.length===t.get_top().concat(t.get_bottom()).length};t.prototype.doInPlace=function(t){this.initNodeMap();var e=this.target.parent;this.addTouchedNodes(e);var i=this.getNewTreeNode(this.nodes);var n=gmath.actions.FactorPowerAction.getAllAvailableActions(i)[0];n.doInPlace();this.compose(n);var r=n.mapNodes(i);var o=gmath.actions.combineStackedExponentsUpAction.getAllAvailableActions(r)[0];o.doInPlace();this.compose(o);e=this.mapNodes(e)[0];c.handle(e.children[0],true);this.removeDeletedNodesFromNodeMap();if(typeof t==="function")t(this);else return true};return new t}();r.prototype.move_actions.push(gmath.actions.PowerFactorAndCombineStackedExponentsAction);(function(){var e=function(t){Action.call(this,"polynomialExpansionAction","polynomial expansion");this.priority=0;this.triggerType="dbltap";if(t)this.actor=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){if(!t.is_group("exponent"))return false;if(!t.children[0]||!a.is_num(t.children[0]))return false;if(a.get_value(t.children[0])!==2&&a.get_value(t.children[0])!==3)return false;var e=t.parent,i=e.children[0];if(!i.is_group("brackets"))return false;if(!i.children[1].is_group("sum"))return false;return true};e.prototype.transform=function(t){var e=this.getNewTreeNode(this.actor);this.addTouchedNodes(this.actor);var i=e.parent;var n=this.analyzeStructure(e);var r=this.formAddendsForExpandedPolynomial(n);r.sort(function(t,e){if(t.firstOrder===e.firstOrder&&t.degreeOfFirstOrder>=e.degreeOfFirstOrder)return 0;if(t.firstOrder===e.firstOrder&&t.degreeOfFirstOrder<e.degreeOfFirstOrder)return 1;if(t.firstOrder<e.firstOrder)return-1;if(t.firstOrder>e.firstOrder)return 1});this.replacePowerWithExpandedPolynomialSum(i,r);if(typeof t==="function")t(this);else return true};e.prototype.analyzeStructure=function(t){var e={};var i=t.parent,n=i.children[0],r=n.children[1];e.degree=a.get_value(t.children[0]);e.terms=r.children.slice();return e};e.prototype.formAddendsForExpandedPolynomial=function(t){var e;if(t.degree===2){e=this.formAddendsForDegreeOfTwo(t.terms)}else if(t.degree===3){e=this.formAddendsForDegreeOfThree(t.terms)}return e};e.prototype.formAddendsForDegreeOfTwo=function(e){var i=[];for(var n=0;n<e.length;n++){var r=e[n].children[1],o=t.clone(r);this.extendNodeMap(this.getOldTreeNode(r).get_mapping_to(o));var s={};s.addend=new m(new y(o,new a(2)));s.firstOrder=n;s.degreeOfFirstOrder=2;i.push(s)}for(var n=0;n<e.length-1;n++){for(var l=n+1;l<e.length;l++){var h=_.prototype.createGroup();h.append(new _(new a(2)));var p=0;var u=e[n].children[1],c=t.clone(u);this.extendNodeMap(this.getOldTreeNode(u).get_mapping_to(c));if(e[n].is_group("sub"))p=(p+1)%2;var d=e[l].children[1],f=t.clone(d);this.extendNodeMap(this.getOldTreeNode(d).get_mapping_to(f));if(e[l].is_group("sub"))p=(p+1)%2;if(a.get_value(c)!==1)h.append(new _(c));if(a.get_value(f)!==1)h.append(new _(f));var s={};s.addend=new m(h,p?"sub":"add");s.firstOrder=n;s.degreeOfFirstOrder=1;i.push(s)}}return i};e.prototype.formAddendsForDegreeOfThree=function(e){var i=[];for(var n=0;n<e.length;n++){var r=e[n].children[1],o=t.clone(r);this.extendNodeMap(this.getOldTreeNode(r).get_mapping_to(o));var s={};s.addend=new m(new y(o,new a(3)),e[n].value);s.firstOrder=n;s.degreeOfFirstOrder=3;i.push(s)}for(var n=0;n<e.length-1;n++){for(var l=n+1;l<e.length;l++){var h=e[n].children[1],p=e[l].children[1];var u=t.clone(h),c=t.clone(p);this.extendNodeMap(this.getOldTreeNode(h).get_mapping_to(u));this.extendNodeMap(this.getOldTreeNode(p).get_mapping_to(c));var d=_.prototype.createGroup();d.append(new _(new a(3)));d.append(new _(new y(u,new a(2))));if(a.get_value(c)!==1)d.append(new _(c));var f={};f.addend=new m(d,p.parent.value);f.firstOrder=n;f.degreeOfFirstOrder=2;i.push(f);var g=t.clone(h),v=t.clone(p);this.extendNodeMap(this.getOldTreeNode(h).get_mapping_to(g));this.extendNodeMap(this.getOldTreeNode(p).get_mapping_to(v));var b=_.prototype.createGroup();b.append(new _(new a(3)));if(a.get_value(g)!==1)b.append(new _(g));b.append(new _(new y(v,new a(2))));var w={};w.addend=new m(b,h.parent.value);w.firstOrder=n;w.degreeOfFirstOrder=1;i.push(w)}}for(var n=0;n<e.length-2;n++){for(var l=n+1;l<e.length-1;l++){for(var x=l+1;x<e.length;x++){var h=e[n].children[1],p=e[l].children[1],A=e[x].children[1];var T=t.clone(h),k=t.clone(p),N=t.clone(A);this.extendNodeMap(this.getOldTreeNode(h).get_mapping_to(T));this.extendNodeMap(this.getOldTreeNode(p).get_mapping_to(k));this.extendNodeMap(this.getOldTreeNode(A).get_mapping_to(N));var E=_.prototype.createGroup();E.append(new _(new a(6)));if(a.get_value(T)!==1)E.append(new _(T));if(a.get_value(k)!==1)E.append(new _(k));if(a.get_value(N)!==1)E.append(new _(N));var S=0;if(e[n].is_group("sub"))S=(S+1)%2;if(e[l].is_group("sub"))S=(S+1)%2;if(e[x].is_group("sub"))S=(S+1)%2;var s={};s.addend=new m(E,S?"sub":"add");s.firstOrder=n;s.degreeOfFirstOrder=1;i.push(s)}}}return i};e.prototype.replacePowerWithExpandedPolynomialSum=function(t,e){var i=t.parent,n=t.remove();var r=m.prototype.createGroup();for(var o=0;o<e.length;o++){r.append(e[o].addend)}i.insert(n,r);this.applyPowers(e);this.cleanupAddends(e);c.handle(r,true);this.cleanup_cascade(r.parent)};e.prototype.applyPowers=function(t){for(var e=0;e<t.length;e++){var i=t[e].addend?t[e].addend.children[1]:t[e].children[1];if(i.is_group("power")){this.applyPower(t[e].addend?t[e].addend:t[e])}else if(i.is_group("product")){this.applyPowers(i.children.slice())}}};e.prototype.applyPower=function(t){var e=t.children[1],i=e.children[0],n=e.children[1];var r=gmath.actions.DistributePowerAction.getAllAvailableActions([n]);if(r.length>0){r[0].doInPlace();this.compose(r[0],false);if(t.children[1].is_group("brackets")){var o=t.children[1].children[1];o.remove();t.children[1].remove();t.append(o)}}var s=r[0]?r[0].mapNodes(n):[n];for(var a=0;a<s.length;a++){var l=s[a].getBestMatchingAction();if(l&&l.name!=="polynomial expansion"){var h=l.createBoundAction(this.newTree,{actor:s[a]});h.doInPlace();this.compose(h,false)}}};e.prototype.cleanupAddends=function(t){for(var e=0;e<t.length;e++){if(t[e].addend.children[1].is_group("product")){var i=t[e].addend.children[1].children.slice();for(var n=0;n<i.length;n++){this.cleanup(i[n])}}}};b.prototype.add_action_handler(new e)})();gmath.actions.LogarithmExtractExponentOfArgumentAction=function(){var e=function(t){Action.call(this,"LogarithmExtractExponentOfArgumentAction","move the exponent of the argument outside of the logarithm");this.priority=1;this.triggerType="drag";this.settings={target_group:true,group_side:"outside",reset_y:true};if(t){this.nodes=t.nodes;this.target=t.target;this.settings.side=t.side}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){var e=this.matchSource(t);if(!e)return[];var i=this.getTargets(e);return this.bindActionForEachTarget(t,i,true)};e.prototype.matchSource=function(t){if(t.length!==1)return false;var e=t[0];if(!e.is_group("exponent","degree"))return false;var i=e.get_parent(2);if(!i.is_group("param"))return false;i=i.get_parent(3);if(!M.Logs.is_log_func(i))return false;return{nodes:t,tuple:e.get_parent(3)}};e.prototype.getTargets=function(t){return[t.tuple]};e.prototype.transform=function(e){this.addTouchedNodes(this.target.parent);var i=this.getNewTreeNode(this.nodes),n=i[0].parent,r=i[0].get_parent(5),o=r.parent,s=r.remove();t.remove_range(i);var a=i[0].children[0];var l=false;if(c.areHidden(a)&&v.is_fraction_with_identity_numerator(a.children[1])){a=a.children[1].get_bottom();t.remove_range(a);if(i[0].is_group("degree"))a.forEach(function(t){t.invert()});l=true}else if(c.areHidden(a)&&a.children[1].is_group("product")){a=a.children[1].children.slice();t.remove_range(a);if(i[0].is_group("degree"))a.forEach(function(t){t.invert()});l=true}var h=new v;h.append(new _(r));var p=l?a:[new _(a,i[0].is_group("degree")?"div":"mul")];if(p[0].is_group("div"))p.forEach(h.append.bind(h));else h.insert_range(this.settings.side==="left-of"?0:1,p);o.insert(s,h);if(!l)c.handle(p[0].children[1],true);this.updateNodeMap(this.nodes[0],p);this.cleanup(n);this.cleanup_cascade(o);c.handle(r.get_arg(),true);if(typeof e==="function")e(this);return this};return new e}();r.prototype.move_actions.push(gmath.actions.LogarithmExtractExponentOfArgumentAction);gmath.actions.LogarithmEvaluateAction=function(){var e=function(t){Action.call(this,"LogarithmEvaluateAction","move the exponent of the argument outside of the logarithm");this.priority=1;this.triggerType="tap";this.settings={};if(t)this.actor=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){if(!M.Logs.is_log_func(t))return false;var e=M.Logs.get_log_base(t),i=t.get_arg();if(!i.is_leaf_node)return false;return M.Logs.within_domain(i)&&M.Logs.within_domain(e)};e.prototype.transform=function(e){this.addTouchedNodes(this.actor);var i=this.getNewTreeNode(this.actor);var n=new a(M.Logs.evaluate(i));t.replace(i,n);this.actor.map_to_group(this,n);if(typeof e==="function")e(this);return this};M.prototype.add_action_handler(new e);return new e}();gmath.actions.LogarithmEvaluateSameArgAsBaseAction=function(){var e=function(t){Action.call(this,"LogarithmEvaluateSameArgAsBaseAction","move the exponent of the argument outside of the logarithm");this.priority=1;this.triggerType="tap";this.settings={};if(t)this.actor=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){if(!M.Logs.is_log_func(t))return false;var e=M.Logs.get_log_base(t),i=t.get_arg();return e.to_ascii()===i.to_ascii()};e.prototype.transform=function(e){this.addTouchedNodes(this.actor);var i=this.getNewTreeNode(this.actor);var n=new a(1);t.replace(i,n);this.actor.map_to_group(this,n);if(typeof e==="function")e(this);return this};M.prototype.add_action_handler(new e);return new e}();gmath.actions.LogarithmInvertAction=function(){var t=function(t){Action.call(this,"LogarithmInvertAction","move the exponent of the argument outside of the logarithm");this.priority=1;this.triggerType="drag";this.settings={side:"around",reset_y:true};if(t){this.nodes=t.nodes;this.target=t.target}};gmath.inherit(Action,t);t.prototype.getAllAvailableActions=function(t){var e=this.matchSource(t);if(!e)return[];var i=this.getTargets(e);return this.bindActionForEachTarget(t,i)};t.prototype.matchSource=function(t){if(t.length!==1)return false;var e=t[0];if(!(e.parent&&M.Logs.is_log_func(e.parent.parent)&&M.Logs.get_log_base(e.parent.parent)===e))return false;var i=e.get_parent(3);if(!i.is_group("equals"))return false;return{nodes:t,func:e.get_parent(2)}};t.prototype.getTargets=function(t){var e=t.func.parent,i=t.func.get_idx()===0?2:0;return[e.children[i]]};t.prototype.transform=function(t){this.addTouchedNodes(this.target.parent);var e=this.getNewTreeNode(this.nodes)[0],i=this.getNewTreeNode(this.target),n=e.get_parent(2),r=n.get_arg(),o=i.parent;n.replace_with(r);var s=i.remove(),a=new y(e,i);o.insert(s,a);this.setNodesToReselectAfterAction(a);if(typeof t==="function")t(this);return this};return new t}();r.prototype.move_actions.push(gmath.actions.LogarithmInvertAction);gmath.actions.LogSimplifyAction=function(){var t=function(t){Action.call(this,"LogSimplifyAction","simplify a log with a power as the argument");this.priority=0;this.triggerType="tap";this.settings={};if(t)this.actor=t.actor};gmath.inherit(Action,t);t.prototype.match=function(t){if(!M.Logs.is_log_func(t))return false;var e=M.Logs.get_log_base(t),i=t.get_arg();if(!i.is_group("power"))return false;return e.to_ascii()===i.children[0].to_ascii()};t.prototype.transform=function(t){this.addTouchedNodes(this.actor);var e=this.getNewTreeNode(this.actor),i=e.get_arg().get_exponent_term();e.replace_with(i);c.handle(i);this.cleanup_cascade(i.parent);if(typeof t==="function")t(this);return this};M.prototype.add_action_handler(new t);return new t}();gmath.actions.LogSimplifyPowerAction=function(){var t=function(t){Action.call(this,"LogSimplifyPowerAction","simplify a power with a log exponent");this.priority=0;this.triggerType="tap";this.settings={};if(t)this.actor=t.actor};gmath.inherit(Action,t);t.prototype.match=function(t){if(!M.Logs.is_log_func(t))return false;if(!t.parent.is_group("exponent"))return false;var e=t.get_parent(2).children[0];var i=M.Logs.get_log_base(t);return i.to_ascii()===e.to_ascii()};t.prototype.transform=function(t){this.addTouchedNodes(this.actor);var e=this.getNewTreeNode(this.actor),i=e.get_arg(),n=e.get_parent(2);n.replace_with(i);c.handle(i);this.cleanup_cascade(i.parent);if(typeof t==="function")t(this);return this};M.prototype.add_action_handler(new t);return new t}();gmath.actions.LogarithmSplitAction=function(){var e=function(t){Action.call(this,"LogarithmSplitAction","turn a log into a sum of logs");this.priority=1;this.triggerType="drag";this.settings={target_group:true,group_side:"outside"};if(t){this.nodes=t.nodes;this.target=t.target;this.settings.side=t.side}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){var e=this.matchSource(t);if(!e)return[];var i=this.getTargets(e);return this.bindActionForEachTarget(t,i,true)};e.prototype.matchSource=function(e){if(!t.is_range(e))return false;var i=e[0];if(!i.is_group("mul","div"))return false;var n=i.get_parent(2);if(!n.is_group("param"))return false;n=n.get_parent(3);if(!M.Logs.is_log_func(n))return false;return{nodes:e,tuple:i.get_parent(3)}};e.prototype.getTargets=function(t){return[t.tuple]};e.prototype.transform=function(e){this.addTouchedNodes(this.target.parent);var i=this.getNewTreeNode(this.nodes),n=i[0].parent,r=i[0].get_parent(5),o=r.parent,s=r.remove();t.remove_range(i);var a=r.clone(false);a.get_arg().remove();var l=false;var h=new v;if(i.length===1&&v.is_fraction_with_identity_numerator(i[0].children[1])){i=i[0].children[1].get_bottom();t.remove_range(i)}i.forEach(function(t){if(t.is_group("div")){l=true;t.invert()}h.append(t)},this);a.get_child([1,1,0]).append(h);var p=new g;p.append(new m(r));var u=new m(a,l?"sub":"add");p.insert(this.settings.side==="left-of"?0:1,u);o.insert(s,p);this.nodes[0].get_parent(5).map_to_func(this,a);this.setNodesToReselectAfterAction(u);this.cleanup(h);this.cleanup(n);this.cleanup_cascade(o);if(typeof e==="function")e(this);return this};return new e}();r.prototype.move_actions.push(gmath.actions.LogarithmSplitAction);(function(){var e=function(t){Action.call(this,"MulDivCleanup","muldiv cleanup action");if(t)this.actor=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){if(e.hasProductChild(t))return true;if(t.parent.cleanupAction&&t.parent.cleanupAction.match(t.parent))return true;return false};e.hasProductChild=function(t){return(t.is_group("mul")||t.is_group("div"))&&t.children[1]&&t.children[1].is_group("product")};e.prototype.doInPlace=function(i){this.initNodeMap();var n=this.getNewTreeNode(this.actor);var r=n.parent,o=this.actor.parent;if(e.hasProductChild(n)){var s=n.children[1],a=this.getOldTreeNode(s);var l=t.remove(n);this.updateNodeMap(this.actor,r);this.updateNodeMap(a,s.children);if(this.actor.is_group("div"))s.children.forEach(function(t){t.invert()});r.insert_range(l,s.children)}this.cleanup(r);if(typeof i==="function")i(this);else return this};_.prototype.cleanupAction=new e})();gmath.actions.MultiplyNumbersAction=function(){var t=function(t){Action.call(this,"MultiplyNumbersAction","Multiply numbers");this.triggerType="tap";this.settings={is_join_action:true,delay:250,side:"inside",margin:{x:.1}};if(t){if(t.nodes){this.triggerType="drag";this.nodes=t.nodes;this.target=t.target}else{this.actor=t.actor}}};gmath.inherit(Action,t);t.prototype.getAllAvailableActions=function(t){if(t.length>1)return[];if(!t[0].is_group("mul","div"))return[];if(!a.is_num(t[0].children[1]))return[];var e=this.getOtherNumberMulsInProduct(t[0]);return this.bindActionForEachTarget(t,e)};t.prototype.getOtherNumberMulsInProduct=function(t){var e=t.parent;var i=e.filter(function(i){return i!==t&&i.is_group(t.value)&&a.is_num(i.children[1])&&i.parent===e});return i};t.prototype.match=function(t){if(!t.ls)return false;if(t.ls.value!=t.value)return false;var e=t.ls.children[1],i=t.children[1];if(!(a.is_num(e)&&a.is_num(i)))return false;return true};t.prototype.transform=function(t){if(this.triggerType==="drag"){this.sourceMul=this.nodes[0];this.targetMul=this.target}else{this.sourceMul=this.actor;this.targetMul=this.actor.ls}this.addTouchedNodes(this.sourceMul);this.addTouchedNodes(this.targetMul);var e=this.getNewTreeNode(this.sourceMul),i=this.getNewTreeNode(this.targetMul),n=e.parent;var r=i.children[1],o=e.children[1];var s=a.get_value(r)*a.get_value(o);var l=new _(new a(s),e.value);this.updateNodeMap(this.sourceMul,l);this.updateNodeMap(this.sourceMul.children[0],l.children[0]);if(!this.sourceMul.children[1].is_group("sign")&&l.children[1].is_group("sign")){this.updateNodeMap(this.sourceMul.children[1].get_mapping_to(l.children[1].children[1]))}else{this.updateNodeMap(this.sourceMul.children[1].get_mapping_to(l.children[1]))}this.updateNodeMap(this.targetMul,l);this.updateNodeMap(this.targetMul.children[0],l.children[0]);if(!this.targetMul.children[1].is_group("sign")&&l.children[1].is_group("sign")){this.updateNodeMap(this.targetMul.children[1].get_mapping_to(l.children[1].children[1]))}else{this.updateNodeMap(this.targetMul.children[1].get_mapping_to(l.children[1]))}var h=i.remove();n.insert(h,l);e.remove();this.cleanup(n);if(typeof t==="function")t(this);return this};_.prototype.add_action_handler(new t);return new t}();r.prototype.move_actions.push(gmath.actions.MultiplyNumbersAction);gmath.actions.MultiplyPowersAction=function(){var t=function(t){Action.call(this,"MultiplyPowersAction","Multiply powers");this.triggerType="tap";this.settings={delay:250,side:"inside",margin:{x:.1}};if(t){if(t.triggerType==="drag"){this.triggerType=t.triggerType;this.nodes=t.nodes;this.target=t.target}else{this.actor=t.actor}}};gmath.inherit(Action,t);t.prototype.areLikeTerms=function(t,e){var i=t.is_group("power")?t.children[0].to_ascii():t.to_ascii(),n=e.is_group("power")?e.children[0].to_ascii():e.to_ascii();return i===n};t.prototype.match=function(t,e){if(arguments.length<2)e=t.ls;if(!e)return false;if(!t.is_group("mul","div")||!e.is_group("mul","div"))return false;return this.areLikeTerms(t.children[1],e.children[1])};t.prototype.getSiblings=function(t){return t.parent.children.filter(function(e){return e!==t&&e.value===t.value})};t.prototype.getAllAvailableActions=function(t){var e=[];if(t.length!==1)return e;var i=t[0];if(!i.is_group("mul","div"))return e;var n=this.getSiblings(i);var r=i.get_root();for(var o=0;o<n.length;o++){if(this.match(i,n[o])){e.push(this.createBoundAction(r,{nodes:t,target:n[o],triggerType:"drag"}))}}return e};t.prototype.transform=function(t){var e=this.nodes&&this.nodes[0]||this.actor,i=this.target||this.actor&&this.actor.ls;this.addTouchedNodes(e);this.addTouchedNodes(i);var n=this.analyzeStructure(e);e=this.getNewTreeNode(e);i=this.getNewTreeNode(i);var r=this.performProductOfPowersProperty(e,i);this.mapOldSourceStructureToTarget(n,i);i=i.children[1];this.cleanup(e.parent);if(this.simplify_exponent&&this.shouldSimplifyExponent(i)){var o=this.getExtendablesFromExponent(i).children[1];this.followup=gmath.actions.AddSubNumbersAction.createBoundAction(this.newTree,{actor:o.children[1]})}else{this.simplify_exponent=false;this.setNodesToReselectAfterAction(r)}if(typeof t==="function")t(this);else return true};t.prototype.analyzeStructure=function(t){var e={};e.muldiv=t;var i=t.children[1];if(i.is_group("power")){e.base=i.children[0];e.exponent=i.children[1]}else{e.base=i;e.exponent=null}return e};t.prototype.performProductOfPowersProperty=function(t,e){var i=t.children[1],n=e.children[1];if(!i.is_group("power")){i=this.reinterpretTermAsPowerWithExponentOfOne(i);this.simplify_exponent=true}if(!n.is_group("power")){n=this.reinterpretTermAsPowerWithExponentOfOne(n);this.simplify_exponent=true}var r=t.parent.children.indexOf(t)<e.parent.children.indexOf(e);var o=this.extendTargetPowerWithSourcePower(n,i,r);t.remove();return o};t.prototype.reinterpretTermAsPowerWithExponentOfOne=function(t){var e=t.parent,i=t.remove();var n=new y(t,new a(1));e.insert(i,n);return n};t.prototype.extendTargetPowerWithSourcePower=function(t,e,i){var n=this.getExtendablesFromExponent(e,true),r=this.getExtendablesFromExponent(t,false);var o=this.combineTermsIntoSum(r,n,i);return o};t.prototype.getExtendablesFromExponent=function(t,e){var i=t.children[1],n=i.children[0];if(c.areHidden(n)){n=n.children[1]}if(e)n.remove();return n};t.prototype.combineTermsIntoSum=function(t,e,i){var n=[];var r=t.parent,o=t.remove();var s=m.prototype.createGroup();var a=new m(e),l=new m(t);if(e.is_group("sum")){n=e.children.slice()}else{n.push(a)}s.append(l);s.insert(i?0:1,a);r.insert(o,s);c.handle(s);this.cleanup(l);this.cleanup(a);return n};t.prototype.mapOldSourceStructureToTarget=function(t,e){this.updateNodeMap(t.muldiv,e);this.updateNodeMap(t.muldiv.children[0],e.children[0]);var i=e.children[1].children[0];if(t.base.is_group("brackets")&&i.is_group("brackets")){this.updateNodeMap(t.base.get_mapping_to(i))}else{var n=t.base.is_group("brackets")?t.base.children[1]:t.base,r=i.is_group("brackets")?i.children[1]:i;this.updateNodeMap(n.get_mapping_to(r))}if(t.exponent){var o=e.children[1].children[1];this.updateNodeMap(t.exponent,o)}};t.prototype.shouldSimplifyExponent=function(t){var e=this.getExtendablesFromExponent(t);if(e.is_group("brackets")){e=e.children[1]}return e.children.length===2&&e.children.every(function(t){return a.is_num(t.children[1])})};_.prototype.add_action_handler(new t);return new t}();r.prototype.move_actions.push(gmath.actions.MultiplyPowersAction);gmath.actions.NegationAction=function(){var e=function(t){Action.call(this,"NegationAction","negation");this.priority=2;this.triggerType="tap";this.settings={side:"inside",delay:300};if(t){if(t.actor){this.actor=t.actor}else{this.triggerType="drag";this.nodes=t.nodes;this.target=t.target}}};gmath.inherit(Action,e);e.prototype.isNegativeElement=function(t){return t&&t.is_group("mul","div")&&a.is_num(t.children[1])&&a.get_value(t.children[1])===-1};e.prototype.getAllAvailableActions=function(t){if(t.length!==1)return[];var e=t[0];var i=[];if(this.isNegativeElement(e)){var n=e.parent.children.indexOf(e);i=e.parent.children.filter(function(t){return t!==e&&t.is_group("mul","div")})}else{i=e.parent.children.filter(this.isNegativeElement.bind(this))}var r=e.get_root();return i.map(function(e){return this.createBoundAction(r,{nodes:t,target:e})},this)};e.prototype.match=function(t){return this.isNegativeElement(t.ls)||this.isNegativeElement(t)};e.prototype.transform=function(e){var i=this.actor?this.actor:this.nodes[0],n=this.target;if(!this.target){if(this.actor.ls)n=this.actor.ls.value==="//"?this.actor.ls.ls:this.actor.ls;else if(this.actor.rs)n=this.actor.rs.value==="//"?this.actor.rs.rs:this.actor.rs}this.addTouchedNodes(i);this.addTouchedNodes(n);var r=this.getNewTreeNode(i),o=this.getNewTreeNode(n);var s,h;if(a.get_value(r.children[1])===-1){s=r;h=o}else{s=o;h=r}var p=h.children[1],u=this.getOldTreeNode(s),c=u.children[1],d=this.getOldTreeNode(h);t.remove(s);if(p.is_group("sign")&&p.children[1]&&!p.children[1].is_group("sign")){var g=p.children[1];this.updateNodeMap(d.children[1].children[0],g);this.updateNodeMap(c,g);this.updateNodeMap(c.children[0],g);this.updateNodeMap(c.children[1],g);p.replace_with(g)}else{var m=new f;m.append(new l("-"));this.updateNodeMap(c,m);this.updateNodeMap(c.children[0],m.children[0]);this.updateNodeMap(c.children[1],p);p.remove();m.append(p);h.append(m)}this.updateNodeMap(u,h);this.updateNodeMap(u.children[0],h.children[0]);this.cleanup(h);if(typeof e==="function")e(this);return this};_.prototype.add_action_handler(new e);return new e}();r.prototype.move_actions.push(gmath.actions.NegationAction);gmath.actions.MulDivLogarithmsAction=function(){var e=function(t){Action.call(this,"MulDivLogarithmsAction","muliply or divide a logarithm by a number");this.priority=1;this.triggerType="tap";this.settings={target_group:true,group_side:"around",delay:300,reset_y:true};if(t){if(t.nodes){this.triggerType="drag";this.nodes=t.nodes;this.target=t.target;this.settings.side=t.side}else{this.actor=t.actor}}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){var e=this.matchSource(t);if(!e)return[];var i=this.getTargets(e);return this.bindActionsForEachTarget(t,i)};e.prototype.matchSource=function(e){if(!e[0].is_group("mul","div"))return false;if(e.length===1)return{nodes:e,only_match_logarithms:!M.Logs.is_log_func(e[0].children[1]),do_not_cross_frac:!(M.Logs.is_log_func(e[0].children[1])&&e[0].is_group("mul"))&&!(!M.Logs.is_log_func(e[0].children[1])&&e[0].is_group("div")),group:e[0].parent};else if(t.is_range(e))return{nodes:e,only_match_logarithms:true,do_not_cross_frac:e[0].is_group("mul"),group:e[0].parent};else return false};e.prototype.getTargets=function(t){var e=t.nodes[0].is_group("mul")?t.group.get_top():t.group.get_bottom();e=e.concat(t.do_not_cross_frac?[]:t.nodes[0].is_group("mul")?t.group.get_bottom():t.group.get_top());var i=e.filter(function(e){return t.nodes.indexOf(e)===-1&&(!t.only_match_logarithms||M.Logs.is_log_func(e.children[1]))},this);return i};e.prototype.bindActionsForEachTarget=function(t,e){var i=[];e.forEach(function(e){var n=M.Logs.is_log_func(e.children[1])?e.children[1].children[1]:e.children[1];i=i.concat(this.bindActionForEachTarget(t,[n],true))},this);return i};e.prototype.match=function(t){if(!t.ls||t.ls instanceof l)return false;if(!t.is_group("mul","div")||t.ls.value!==t.value)return false;var e=t.ls.children[1],i=t.children[1];return M.Logs.is_log_func(e)||M.Logs.is_log_func(i)};e.prototype.transform=function(e){var i=this.getSourceAndTarget(true);this.addTouchedNodes(i.source);this.addTouchedNodes(i.target);var n,r,o;if(i.source[0].is_group("fraction")){n=this.getNewTreeNode(i.source[0]);r=n.get_bottom();o=n.get_top()[0]}else{r=this.getNewTreeNode(i.source);o=this.getNewTreeNode(i.target);n=r[0].parent;while(!o.is_group("mul","div"))o=o.parent}var s,a,l;if(r.length>1||M.Logs.is_log_func(o.children[1])){s=r;a=o;l=false}else{s=[o];a=r[0];l=true}var h=s.map(this.getOldTreeNode.bind(this));t.remove_range(s);if(s[0].is_group("div")&&s[0].value===a.value)s.forEach(function(t){t.invert()});var p=a.children[1].get_arg();var u=p.parent,d=p.remove(),f=new y;f.append(p);c.handle(p);
var g=new v;g.append_range(s);var m=new b(g);f.append(m);u.insert(d,f);c.handle(a.children[1].children[1]);h.forEach(function(t){t.map_group_and_sym(this,a,true)},this);this.setNodesToReselectAfterAction(l?a:m);this.cleanup(g);this.cleanup(n);if(typeof e==="function")e(this);return this};v.prototype.add_action_handler(new e);_.prototype.add_action_handler(new e);return new e}();r.prototype.move_actions.push(gmath.actions.MulDivLogarithmsAction);gmath.actions.MultiplyFractionsAction=function(){var e=function(t){Action.call(this,"MultiplyFractionsAction","multiply fractions");this.priority=1;this.triggerType="tap";this.settings={delay:250,side:"inside",margin:{x:.1}};if(t){if(t.triggerType==="drag"){this.triggerType=t.triggerType;this.nodes=t.nodes;this.target=t.target}else{this.actor=t.actor}}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){if(t.length!==1)return[];var e=t[0];if(!e.parent.is_group("product","fraction"))return[];if(!e.children[1].is_group("fraction"))return[];var i=e.parent.children.filter(this.match2.bind(this,e));var n=e.get_root(),r=this;return i.map(function(e){return r.createBoundAction(n,{nodes:t,target:e,triggerType:"drag"})})};e.prototype.match=function(t){return this.match2(t.ls,t)};e.prototype.match2=function(t,e){if(!t||!e||t===e)return false;if(t.value!==e.value)return false;var i=t.parent;if(e.parent!==i)return false;var n=t.children[1],r=e.children[1];if(!(n.is_group("fraction")&&r.is_group("fraction")))return false;if(!i.is_group("fraction","product"))return false;return true};e.prototype.transform=function(e){if(this.triggerType==="drag"){this.sourceMul=this.nodes[0];this.targetMul=this.target}else{this.sourceMul=this.actor;this.targetMul=this.actor.ls}this.addTouchedNodes(this.sourceMul);this.addTouchedNodes(this.targetMul);var i=this.getNewTreeNode(this.sourceMul),n=this.getNewTreeNode(this.targetMul),r=i.parent,o,s,a;if(i.parent.children.indexOf(i)<n.parent.children.indexOf(n)){o=i,s=n,a=0}else{o=n,s=i,a=1}var l=r;var h=o.children[1],p=s.children[1];var u=this.sourceMul.children[1];this.updateNodeMap(u.get_fraction_bar(),h.get_fraction_bar());this.updateNodeMap(this.sourceMul,o);this.updateNodeMap(this.sourceMul.children[0],o.children[0]);t.remove(s);var d=p.get_top(),f=p.get_bottom();for(var g=0;g<d.length;g++)h.append(d[g]);for(var g=0;g<f.length;g++)h.append(f[g]);for(var g=0;g<h.children.length;g++){var m=h.children[g];if(m.has_children())c.handle(m.children[1])}this.cleanup(l);if(typeof e==="function")e(this);return this};_.prototype.add_action_handler(new e);return new e}();r.prototype.move_actions.push(gmath.actions.MultiplyFractionsAction);gmath.actions.MulDivInvertAction=function(){var e=function(t){Action.call(this,"MulDivInvertAction","invert multipliers across an inequality");this.priority=0;this.triggerType="drag";this.settings={side:"around",extend_extreme_target_boxes:true};if(t){this.nodes=t.nodes;this.target=t.target}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){var e=this.matchSource(t);if(!e)return[];var i=this.getTargets(e);return this.bindActionForEachTarget(t,i)};e.prototype.matchSource=function(e){if(!t.is_range(e))return false;var i={};var n=e[0],r=n.get_parent(1);if(r.is_group("product","fraction")&&(r.get_parent(1).is_group("equals")||E.is_inequality(r.get_parent(1)))){return{nodes:e,side:r.get_idx(),group:r.get_parent(1)}}else if(r.is_group("fraction")&&r.get_parent(1).is_group("sign")&&(r.get_parent(2).is_group("equals")||E.is_inequality(r.get_parent(2)))){return{nodes:e,side:r.get_parent(1).get_idx(),group:r.get_parent(2)}}else if((r.is_group("product","fraction")&&r.get_parent(1).is_group("add","sub")||r.is_group("fraction")&&r.get_parent(1).is_group("mul"))&&(r.get_parent(3).is_group("equals")||E.is_inequality(r.get_parent(3)))){return{nodes:e,side:r.get_parent(2).get_idx(),group:r.get_parent(3)}}else if(r.is_group("fraction")&&r.get_parent(1).is_group("mul")&&r.get_parent(3).is_group("add","sub")&&(r.get_parent(5).is_group("equals")||E.is_inequality(r.get_parent(5)))){return{nodes:e,side:r.get_parent(4).get_idx(),group:r.get_parent(5)}}else if(r.is_group("fraction")&&r.parent&&r.parent.is_group("mul")&&(r.parent.parent.parent.is_group("equals")||E.is_inequality(r.parent.parent.parent))){return{nodes:e,frac:r,side:r.get_parent(2).get_idx(),group:r.get_parent(3)}}return false};e.prototype.getTargets=function(t){return[t.group.get_child([!t.side?2:0])]};e.prototype.transform=function(t){var e=this.getNewTreeNode(this.nodes);var i=this.analyzeStructureOfEquation(e);if(E.is_inequality(i.otherSideOfEquation.get_parent(1)))this.invertInequality(i.modifiers,i.otherSideOfEquation.get_parent(1));this.invertModifiers(i.modifiers);this.modifyAnyOtherTermsOnOriginSide(i.modifiers,i.originChanges);this.removeModifiersFromOriginSide(i.modifiers);this.modifyTargetSide(i.oldModifiers,i.modifiers,i.otherSideOfEquation,i.oldOtherSideOfEquation);if(typeof t==="function")t(this);return this};e.prototype.analyzeStructureOfEquation=function(t){var e=this;var i={};var n=t[0].get_root().children[0];var r=t[0].get_path(),o=r[1]?0:2;i.modifiers=t;i.oldModifiers=t.map(e.getOldTreeNode.bind(e));i.originChanges=this.getOtherTermsFromSide(n.children[r[1]],t,r);i.otherSideOfEquation=n.children[o];i.oldOtherSideOfEquation=this.getOldTreeNode(i.otherSideOfEquation);return i};e.prototype.getOtherTermsFromSide=function(t,e,i){if(t===e[0]||e[0].is_group("div")&&e[0].parent===t){return[]}else{return t.children.slice().filter(function(t){var e=t.get_path();return e[2]!==i[2]})}};e.prototype.invertInequality=function(t,e){var i=r.evalExpression(t),n=r.to_ascii(t),o=gmath.termsToAlgebriteString(t);if(Number.isNaN(i)&&typeof Algebrite!=="undefined"){try{console.log(o);i=Number(Algebrite.eval(o).toString())}catch(t){console.log("Algebrite could not parse",o)}}if(isNaN(i)){this.settings.restraint="The terms "+n+" must simplify to a positive number."}else if(i<0){e.invert()}};e.prototype.invertModifiers=function(t){var e=[];for(var i=0;i<t.length;i++){var n=t[i];if(n.is_group("mul")&&n.children[1].is_group("fraction")){this.convertToReciprocal(n.children[1])}else{if(n.invert&&!n.is_group("product","fraction")&&!this.isIdentityMul(n))n.invert()}e.push(n)}return e};e.prototype.isIdentityMul=function(t){return t.is_group("mul")&&(a.get_value(t.children[1])===1||a.get_value(t.children[1])===-1)};e.prototype.convertToReciprocal=function(e){var i=e.parent,n=e.remove();var r;if(e.is_group("product")){var o=e.children.slice();t.remove_range(e.children);o.forEach(function(t){t.invert()});var s=_.prototype.createGroup();o.forEach(function(t){s.append(t)});r=s}else{var l=e.get_top(),h=e.get_bottom();if(l.length===1&&a.get_value(l[0].children[1])===1){var p=_.prototype.createGroup();t.remove_range(h);h.forEach(function(t){t.invert()});p.append_range(h);r=p}else{t.remove_range(l);t.remove_range(h);l.forEach(function(t){t.invert()});h.forEach(function(t){t.invert()});h.forEach(function(t){e.append(t)});l.forEach(function(t){e.append(t)});r=e}}i.insert(n,r);this.cleanup(r)};e.prototype.modifyAnyOtherTermsOnOriginSide=function(t,e){if(e.length===0)return;var i=e[0].parent;if(t[0].is_group("mul","div")&&i.is_group("sum")){for(var n=0;n<e.length;n++){var r=e[n].children[1];var o=this.removeRedundantTerms(r,t);if(o.length>0){r=e[n].children[1];this.insertModifiersIntoTerm(r,o)}}}};e.prototype.removeRedundantTerms=function(e,i){var n=i.slice();if(e.is_group("product","fraction")){for(var r=0;r<e.children.length;){var o=e.children[r];for(var s=0;s<n.length;){if(this.invertModifiers([t.clone(n[s])])[0].to_ascii()===o.to_ascii()){this.extendNodeMap(this.getOldTreeNode(o).get_mapping_to(n[s]));o.remove();n.splice(s,1);break}else{r++;s++}}if(n.length===0)break}this.cleanup(e)}return n};e.prototype.insertModifiersIntoTerm=function(t,e){if(this.termIsAProductContainingAFraction(t)&&e[0].is_group("div")){this.insertModifierDivsAsNewFractionIntoProduct(t,e)}else if(t.is_group("product","fraction")){this.insertModifiersIntoProductFraction(t,e)}else{this.replaceTermWithProductContainingModifiedTerm(t,e)}};e.prototype.termIsAProductContainingAFraction=function(t){if(!t.is_group("product"))return false;return t.children.some(function(t){return t.children[1].is_group("fraction")})};e.prototype.insertModifierDivsAsNewFractionIntoProduct=function(e,i){var n=this;var r=_.prototype.createGroup();r.append(new _(new a(1)));i.forEach(function(e){var i=t.clone(e);i.dragging=false;i.selected=false;n.extendNodeMap(n.getOldTreeNode(e).get_mapping_to(i));r.append(i)});e.append(new _(r))};e.prototype.insertModifiersIntoProductFraction=function(e,i){var n=this;i.forEach(function(i){var r=t.clone(i);r.dragging=false;r.selected=false;n.extendNodeMap(n.getOldTreeNode(i).get_mapping_to(r));e.append(r)})};e.prototype.replaceTermWithProductContainingModifiedTerm=function(e,i){var n=this;var r=_.prototype.createGroup(),o=e.parent,s=e.remove();r.append(new _(e));i.forEach(function(e){var i=t.clone(e);i.dragging=false;i.selected=false;n.extendNodeMap(n.getOldTreeNode(e).get_mapping_to(i));r.append(i)});o.insert(s,r)};e.prototype.removeModifiersFromOriginSide=function(e){var i=e[0].get_root().get_child(e[0].get_path().slice(0,2));if(this.modifierIsTheOnlyTermOnOriginSide(e,i)){this.removeModifierAndReplaceWithZero(e)}else if(e[0].is_group("div")||e[0].is_group("mul")&&e[0].parent.is_group("fraction")){var n=e[0].parent,r=n.parent;t.remove_range(e);var o=n.get_top(),s=this.cleanup(n);if(s&&o.length===1&&r.is_group("product","mul"))r.simplify=true;this.cleanup(r)}else{var r=e[0].parent;t.remove_range(e);this.cleanup(r)}};e.prototype.modifierIsTheOnlyTermOnOriginSide=function(t,e){return t[0]===e};e.prototype.removeModifierAndReplaceWithZero=function(t){var e=t[0].parent,i=t[0].remove();e.insert(i,new a(0))};e.prototype.modifyTargetSide=function(t,e,i,n){if(e.length===1&&!e[0].is_group("mul","div")&&!e[0].is_group("add","sub")){if(e[0].is_group("sign")){var r=e[0].children[1];r.remove();e[0]=new m(r);this.updateNodeMap(t[0],e[0]);this.updateNodeMap(t[0].children[0],e[0].children[0])}else if(e[0].is_group("sum")){var r=e[0];r.children.forEach(function(t){t.invert()});e[0]=new m(r)}else{var r=e[0];e[0]=new m(r,"sub")}}var o=i.parent,s=i.remove();var a;if(!i.is_group("product","fraction")&&e[0].is_group("mul","div")){var l=_.prototype.createGroup();var h=new _(i);l.append(h);for(var p=0;p<e.length;p++){l.append(e[p])}o.insert(s,l);this.cleanup(l.children[0]);l.children[0].simplify=true}else if(!i.is_group("sum")&&e[0].is_group("add","sub","sum")){var u=m.prototype.createGroup();var c;if(i.is_group("sign")){c=new m(i);this.extendNodeMap(n,c);this.extendNodeMap(n.children[0],c.children[0])}else{c=new m(i)}u.append(c);for(var p=0;p<e.length;p++){u.append(e[p])}o.insert(s,u);this.cleanup(u.children[0]);if(e[0].children[1].is_group("sum")){var d=e[0].children[1].children.slice();this.cleanup(e[0]);e=d}u.children[0].simplify=true}else{var f=i;for(var p=0;p<e.length;p++){f.append(e[p])}o.insert(s,f);if(e.length===1&&e[0].children[1].is_group("sum")){e=e[0].children[1].children.slice();this.cleanup(f.children[f.children.length-1])}}this.setNodesToReselectAfterAction(e)};return new e}();r.prototype.move_actions.push(gmath.actions.MulDivInvertAction);gmath.actions.MulDivRadicalsAction=function(){var t=function(t){Action.call(this,"MulDivRadicalsAction","muliply or divide a radicals");this.triggerType="tap";this.settings={target_group:true,group_side:"around",delay:300,reset_y:true};if(t){if(t.nodes){this.triggerType="drag";this.priority=1;this.nodes=t.nodes;this.target=t.target;this.settings.side=t.side}else{this.priority=0;this.actor=t.actor}}};gmath.inherit(Action,t);t.prototype.getAllAvailableActions=function(t){var e=this.matchSource(t);if(!e)return[];var i=this.getTargets(e);return this.bindActionsForEachTarget(t,i)};t.prototype.matchSource=function(t){if(t.length!==1)return false;if(!t[0].is_group("mul","div")||!t[0].children[1].is_group("radical"))return false;return{nodes:t,degree_val:t[0].children[1].children[0].to_ascii(),group:t[0].parent}};t.prototype.getTargets=function(t){var e=t.group.get_top().concat(t.group.get_bottom());var i=e.filter(function(e){return t.nodes.indexOf(e)===-1&&e.children[1].is_group("radical")&&e.children[1].children[0].to_ascii()===t.degree_val},this);return i};t.prototype.bindActionsForEachTarget=function(t,e){var i=[];e.forEach(function(e){var n=e.children[1].get_radicand();i=i.concat(this.bindActionForEachTarget(t,[n],true))},this);return i};t.prototype.match=function(t){if(!t.ls||t.ls instanceof l)return false;if(!t.is_group("mul","div")||t.ls.value!==t.value)return false;var e=t.ls.children[1],i=t.children[1];return e.is_group("radical")&&i.is_group("radical")&&e.children[0].to_ascii()===i.children[0].to_ascii()};t.prototype.transform=function(t){var e=this.getSourceAndTarget();this.addTouchedNodes(e.source);this.addTouchedNodes(e.target);var i=this.getNewTreeNode(e.source),n=this.getNewTreeNode(e.target),r=i.parent,o=this.getOldTreeNode(i);while(!n.is_group("mul","div"))n=n.parent;if(n.is_group("div")&&i.is_group("mul")){var s=n;n=i;i=s}var a=i.children[1].get_radicand(),l=n.children[1].get_radicand();i.remove();l.remove();var h=new v;h.append(new _(l));h.insert(this.settings.side==="left-of"?0:1,new _(a,n.value===i.value?"mul":i.value),true);n.children[1].set_radicand(h);o.map_group_and_sym(this,n,true);o.children[1].map_to_radical(this,n.children[1],true);this.cleanup(l.parent);this.cleanup(a.parent);this.cleanup(h);this.cleanup(r);if(typeof t==="function")t(this);return this};var e=new t;v.prototype.add_action_handler(e);_.prototype.add_action_handler(e);return e}();r.prototype.move_actions.push(gmath.actions.MulDivRadicalsAction);gmath.actions.AddFractionsAction=function(){var e=function(t){Action.call(this,"AddFractionsAction","add fractions");this.priority=1;this.triggerType="tap";this.settings={delay:250,side:"inside",margin:{x:.1}};if(t){if(t.triggerType==="drag"){this.triggerType=t.triggerType;this.nodes=t.nodes;this.target=t.target}else this.actor=t.actor}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){if(t.length!==1)return[];var e=t[0];if(!e.parent.is_group("sum"))return[];if(!e.children[1].is_group("fraction"))return[];var i=e.parent.children.filter(this.match2.bind(this,e));var n=e.get_root(),r=this;return i.map(function(e){return r.createBoundAction(n,{nodes:t,target:e,triggerType:"drag"})})};e.prototype.match=function(t){return this.match2(t.ls,t)};e.prototype.match2=function(t,e){if(!t||!e||t===e)return false;if(!t.parent.is_group("sum"))return false;if(t.parent!==e.parent)return false;var i=t.children[1],n=e.children[1];if(!(i.is_group("fraction")&&n.is_group("fraction")))return false;var r=function(t){return t.to_ascii()};var o=i.get_bottom(),s=n.get_bottom();if(o.map(r).join("")!==s.map(r).join(""))return false;return true};e.prototype.transform=function(e){if(this.triggerType==="drag"){this.sourceAddend=this.nodes[0];this.targetAddend=this.target}else{this.sourceAddend=this.actor;this.targetAddend=this.actor.ls}this.addTouchedNodes(this.sourceAddend);this.addTouchedNodes(this.targetAddend);var i=this.getNewTreeNode(this.sourceAddend),n=this.getNewTreeNode(this.targetAddend),r=i.parent;if(i.parent.children.indexOf(i)<n.parent.children.indexOf(n)){var o=n;n=i;i=o}var s=this.getOldTreeNode(n),a=this.getOldTreeNode(i);var l=n.children[1],h=i.children[1];this.mapOldFractionPartsToFraction(a.children[1],l);var p=t.remove(n);t.remove(i);t.remove(l);t.remove(h);n=this.putNumeratorTermsIntoAddSubAndMapFromOldAddSub(l.get_top(),s);i=this.putNumeratorTermsIntoAddSubAndMapFromOldAddSub(h.get_top(),a);var u=this.putAddendsIntoNewSumAndMakeNumeratorTerm(n,i);l.append(u);var c=new m(l);t.insert(r,p,c);this.updateNodeMap(this.sourceAddend,c);this.updateNodeMap(this.targetAddend,c);this.cleanup(n);this.cleanup(i);this.cleanup(r);if(gmath.options.actions.simplify_sum_in_numerator_after_adding_fractions&&this.numeratorSumContainsTwoNumbers(l.get_top()[0].children[1].children[1])){this.simplifyNumeratorAsFollowup(l)}if(typeof e==="function")e(this);else return true};e.prototype.mapOldFractionPartsToFraction=function(t,e){this.updateNodeMap(t.get_fraction_bar(),e.get_fraction_bar());var i=t.get_bottom(),n=e.get_bottom();for(var r=0;r<i.length;r++){this.updateNodeMap(i[r].get_mapping_to(n[r]))}};e.prototype.putNumeratorTermsIntoAddSubAndMapFromOldAddSub=function(e,i){t.remove_range(e);var n;if(e.length==1){n=new m(e[0].children[1],i.value)}else{var r=new v;t.insert_range(r,0,e);n=new m(r,i.value)}c.handle(n.children[1],true);this.updateNodeMap(i,n);this.updateNodeMap(i.children[0],n.children[0]);return n};e.prototype.putAddendsIntoNewSumAndMakeNumeratorTerm=function(e,i){var n=m.prototype.createGroup();n.append(e);n.append(i);var r=new _;t.append(r,new l("*"));t.append(r,n);c.handle(n);return r};e.prototype.numeratorSumContainsTwoNumbers=function(t){return t.children.length===2&&t.children.every(function(t){return a.is_num(t.children[1])})};e.prototype.simplifyNumeratorAsFollowup=function(t){var e=t.get_top()[0].children[1].children[1];this.followup=gmath.actions.AddSubNumbersAction.createBoundAction(this.newTree,{actor:e.children[1]})};m.prototype.add_action_handler(new e);return new e}();r.prototype.move_actions.push(gmath.actions.AddFractionsAction);gmath.actions.FractionCancelTermsAction=function(){var e=function(t){Action.call(this,"FractionCancelTermsAction","cancel numbers in a fraction");this.triggerType="drag";this.priority=2;this.settings={delay:400,side:"inside",reset_x:true,reset_y:true};if(t){this.nodes=t.nodes;this.target=t.target}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){return e.getAllAvailableActions.call(this,t)};e.getAllAvailableActions=function(t){if(t.length!==1)return[];if(!t.every(function(t){return t.is_group("mul","div")}))return[];var i=e.findTopLevelGroupForCanceling(t);if(!i)return[];var n=e.findOtherContendersInStructure(t,i);if(n.length===0)return[];n=n.filter(function(i){return e.match.call(this,t[0],i)},this);var r=t[0].get_root();return n.map(function(e){return this.createBoundAction(r,{nodes:t,target:e})},this)};e.findTopLevelGroupForCanceling=function(t){var i;if((i=e.nodesAreInAFractionWithinAProduct(t))||(i=e.nodesAreInAProductThatContainsAFraction(t))||(i=e.nodesAreInAFraction(t))){return i}else{return false}};e.findOtherContendersInStructure=function(t,i){var n;var r=t[0].is_group("mul")?"div":"mul";n=i.filter(function(n){return n.is_group(r)&&e.nodeIsCorrectLevelRelativeToTopLevelGroup(n,i)&&!e.nodeIsAncestorOfNodes(n,t)});return n};e.nodesAreInAFractionWithinAProduct=function(t){var e=t[0].parent;if(e.is_group("fraction")&&e.parent&&e.parent.is_group("mul")&&e.parent.parent.is_group("product")){return e.parent.parent}else{return false}};e.nodesAreInAProductThatContainsAFraction=function(t){var e=t[0].parent;if(e.is_group("product")&&e.children.some(function(t){return t.children[1].is_group("fraction")})){return e}else{return false}};e.nodesAreInAFraction=function(t){var e=t[0].parent;if(e.is_group("fraction")){return e}else{return false}};e.nodeIsCorrectLevelRelativeToTopLevelGroup=function(t,e){return t.parent===e||t.parent.parent.parent===e};e.nodeIsAncestorOfNodes=function(t,e){return e.some(function(e){var i=e;while(!r.is_top_most(i)){if(i===t){return true}i=i.parent}return false})};e.match=function(t,e){var i=this.getBoundTransformation(t,e);if(i){return true}else{return false}};e.prototype.transform=function(t){e.transform.call(this,t)};e.transform=function(t){var i=this.getNewTreeNode(this.nodes)[0],n=this.getNewTreeNode(this.target);this.addTouchedNodes(this.nodes[0]);this.addTouchedNodes(this.target);var r=e.findTopLevelGroupForCanceling([i]);e.performCancel.call(this,i,n);e.cleanStructure.call(this,r);if(typeof t==="function")t(this);else return true};e.performCancel=function(t,e){var i=this.getBoundTransformation(t,e);if(i){i()}else{throw"Failed to find canceling transformation in transform function."}};e.cleanStructure=function(t){var e=false;if(t.is_group("product")){t.children.forEach(function(t){if(t.children[1].is_group("fraction")){e=this.cleanup_cascade(t.children[1])}},this)}if(!e){this.cleanup_cascade(t)}};e.prototype.getBoundTransformation=function(t,e){var i=this;var n=t.is_group("mul")?t:e,r=e.is_group("div")?e:t;var o=a.is_num(n.children[1]),s=a.is_num(r.children[1]),l=o&&!this.numberContainsDecimalTerm(n.children[1]),h=s&&!this.numberContainsDecimalTerm(r.children[1]);if(s&&(a.get_value(r.children[1])===0||a.get_value(r.children[1])===-0)){return false}if(n.children[1].to_ascii()===r.children[1].to_ascii()){return function(){i.cancelTerms(n,r)}}if(h&&a.get_value(r.children[1])===-1){return function(){i.applyNegativeToMulNum(n,r)}}if(this.termIsNegativeXOfX(n.children[1],r.children[1])){return function(){i.cancelTermsAndReplaceMulDiv1NumWithNegativeOne(n,r)}}if(this.termIsNegativeXOfX(r.children[1],n.children[1])){return function(){i.cancelTermsAndReplaceMulDiv1NumWithNegativeOne(r,n)}}if(l&&h&&gmath.factoring.numbers_are_multiples(n.get_child([1]),r.get_child([1]))){return function(){i.factorizeTerms(n,r)}}if(this.bothTermsAreNegative(n,r)){return function(){i.extractSigns(n,r)}}return false};e.prototype.cancelTerms=function(t,e){var i=this;this.getOldTreeNode(t).for_each(function(e){i.updateNodeMap(e,t.parent)});this.getOldTreeNode(e).for_each(function(t){i.updateNodeMap(t,e.parent)});t.remove();e.remove()};e.prototype.applyNegativeToMulNum=function(t,e){this.updateNodeMap(this.getOldTreeNode(e),t);if(t.children[1].is_group("sign")){t.children[1].replace_with(t.children[1].children[1])}else{var i=e.children[1];i.remove();i.children[1].remove();var n=t.children[1];n.remove();t.append(i);i.append(n)}e.remove()};e.prototype.termIsNegativeXOfX=function(t,e){return t.is_group("sign")&&t.children[1].to_ascii()===e.to_ascii()};e.prototype.cancelTermsAndReplaceMulDiv1NumWithNegativeOne=function(t,e){var i=t.children[1].children[1],n=e.children[1],r=new a(1);this.updateNodeMap(this.getOldTreeNode(e),t);this.updateNodeMap(this.getOldTreeNode(n).get_mapping_to(r));this.updateNodeMap(this.getOldTreeNode(i).get_mapping_to(r));i.replace_with(r);e.remove()};e.prototype.factorizeTerms=function(t,e){var i=t.get_root();var n=i.numeric_value(t.children[1]),r=i.numeric_value(e.children[1]);if(!n||!r)return false;var o=this.getOldTreeNode(t),s=this.getOldTreeNode(e);var a=this.relativePositionOfMulWithRespectToDiv(t,e);if(gmath.factoring.val1_is_a_multiple_of_val2(n,r)){var l=a==="left"?this.splitIntoFactors(t,o,Math.floor(n/r),r)[1]:this.splitIntoFactors(t,o,r,Math.floor(n/r))[0];if(this.nodes[0].is_group("mul")){this.setNodesToReselectAfterAction(l)}}else if(gmath.factoring.val1_is_a_multiple_of_val2(r,n)){var l=a==="left"?this.splitIntoFactors(e,s,n,Math.floor(r/n))[0]:this.splitIntoFactors(e,s,Math.floor(r/n),n)[1];if(this.nodes[0].is_group("div")){this.setNodesToReselectAfterAction(l)}}else{var h=gmath.factoring.get_gcf(n,r);var p,u;switch(a){case"left":p=this.splitIntoFactors(t,o,Math.floor(n/h),h)[1];u=this.splitIntoFactors(e,s,h,Math.floor(r/h))[0];break;case"same":p=this.splitIntoFactors(t,o,Math.floor(n/h),h)[1];u=this.splitIntoFactors(e,s,Math.floor(r/h),h)[1];break;case"right":p=this.splitIntoFactors(t,o,h,Math.floor(n/h))[0];u=this.splitIntoFactors(e,s,Math.floor(r/h),h)[1];break}var c;if(this.target.is_group("mul"))c=u;else c=p;this.setNodesToReselectAfterAction(c)}};e.prototype.relativePositionOfMulWithRespectToDiv=function(t,e){if(t.parent===e.parent){var i=t.parent.get_top(),n=t.parent.get_bottom();return this.positionComparison(i.indexOf(t),n.indexOf(e))}var r,o;if(t.parent.is_group("product")){r=t}else{r=t.parent.parent}o=e.parent.parent;var s=r.parent;return this.positionComparison(s.children.indexOf(r),s.children.indexOf(o))};e.prototype.positionComparison=function(t,e){var i=t-e;if(i<0)return"left";else if(i===0)return"same";else return"right"};e.prototype.splitIntoFactors=function(e,i,n,r){var o=new _(isNaN(n)?t.clone(e.children[1].children[1]):new a(n),e.value),s=new _(isNaN(r)?t.clone(e.children[1].children[1]):new a(r),e.value);this.updateNodeMap(i.get_mapping_to(o));this.extendNodeMap(i.get_mapping_to(s));var l=e.remove();e.parent.insert(l,s);e.parent.insert(l,o);return[o,s]};e.prototype.bothTermsAreNegative=function(t,e){return t.children[1].is_group("sign")&&e.children[1].is_group("sign")};e.prototype.extractSigns=function(t,e){var i=t.get_root();var n=this.getOldTreeNode(t),r=this.getOldTreeNode(e);var o=this.splitIntoFactors(t,n,i.numeric_value(t.children[1])/-1,-1)[1],s=this.splitIntoFactors(e,r,i.numeric_value(e.children[1])/-1,-1)[1];if(this.nodes[0].is_group("mul")){this.setNodesToReselectAfterAction(o)}else{this.setNodesToReselectAfterAction(s)}};e.prototype.numberContainsDecimalTerm=function(t){return a.get_value(t)!==Math.floor(a.get_value(t))};return new e}();r.prototype.move_actions.push(gmath.actions.FractionCancelTermsAction);gmath.actions.FractionCancelPowersAction=function(){var t=function(t){Action.call(this,"FractionCancelPowersAction","cancel powers in a fraction");this.triggerType="drag";this.priority=2;this.settings={delay:400,side:"inside",reset_x:true,reset_y:true};if(t){this.nodes=t.nodes;this.target=t.target}};gmath.inherit(Action,t);t.prototype.getAllAvailableActions=function(t){if(!gmath.options.actions.cancel_powers)return[];return gmath.actions.FractionCancelTermsAction.getAllAvailableActions.call(this,t)};t.prototype.transform=function(t){gmath.actions.FractionCancelTermsAction.transform.call(this,t)};t.prototype.getBoundTransformation=function(t,e){var i=this;var n=t.is_group("mul")?t:e,r=e.is_group("div")?e:t,o=n.get_child([1]),s=r.get_child([1]);function a(t){return h.is_var(t)||t.is_group("power")}if(!o.is_group("power")&&!s.is_group("power"))return false;if(y.haveSameBase(o,s)){return function(){i.factorizePowers(n,r)}}};t.prototype.factorizePowers=function(t,e){var i=this.nodes[0].is_group("mul")?t:e,n=this.target.is_group("mul")?t:e;var r=i.children[1],o=n.children[1];var s=this.getOldTreeNode(i);var a=this.getOldBase(r);var l=this.getOldExponentTermFromPower(o),h=this.getOldExponentTermFromPower(r);var p=this.sourceIsLeftOfTarget(i,n);if(!r.is_group("power")){r=this.reinterpretTermAsPower(r)}if(!o.is_group("power")){o=this.reinterpretTermAsPower(o)}var u=r.get_child([1,0]),c=o.get_child([1,0]);if(u.is_group("brackets"))u=u.children[1];if(c.is_group("brackets"))c=c.children[1];this.convertTargetExponentIntoSum(c,h,u);i.remove();this.updateNodeMap(s,n);this.updateNodeMap(a.get_mapping_to(o.get_child([0])));this.setNodesToReselectAfterAction(n)};t.prototype.sourceIsLeftOfTarget=function(t,e){if(t.parent===e.parent)return true;var i,n;i=t.parent.is_group("product")?t:t.parent.parent;n=e.parent.is_group("product")?e:e.parent.parent;var r=i.parent;return r.children.indexOf(i)<=r.children.indexOf(n)};t.prototype.getOldBase=function(t){if(!t.is_group("power"))return this.getOldTreeNode(t);else return this.getOldTreeNode(t.get_child([0]))};t.prototype.getOldExponentTermFromPower=function(t){if(!t.is_group("power")){return null}var e=this.getOldTreeNode(t);var i=e.get_child([1,0]);if(i.is_group("brackets"))i=i.get_child([1]);return i};t.prototype.reinterpretTermAsPower=function(t){var e=t.parent,i=t.remove();var n=b.prototype.createGroup();n.append(t);n.append(new b(new a(1)));this.updateNodeMap(t,n);e.insert(i,n);return n};t.prototype.convertTargetExponentIntoSum=function(t,e,i){var n=t.parent,r=t.remove();var o=m.prototype.createGroup();o.append(new m(t));o.append(new m(i.clone(),"sub"));if(o.get_child([1,1]).is_group("sign")){o.get_child([1,1]).replace_with(o.get_child([1,1,1]));o.get_child([1]).invert()}n.insert(r,o);this.cleanup(o.get_child([1]));this.cleanup(o.get_child([0]));c.handle(o);if(e&&e.is_group("sum")){for(var s=0;s<e.children.length;s++){this.extendNodeMap(e.children[e.children.length-s-1].get_mapping_to(o.children[o.children.length-s-1]))}}else if(e){this.extendNodeMap(e.get_mapping_to(o.children[o.children.length-1].children[1]))}};return new t}();r.prototype.move_actions.push(gmath.actions.FractionCancelPowersAction);gmath.actions.FractionMagSimplificationAction=function(){var t=function(t){Action.call(this,"FractionMagSimplificationAction","cancel numerator and denominator");this.priority=0;this.triggerType="tap";if(t)this.actor=t.actor};gmath.inherit(Action,t);t.prototype.match=function(t){if(!t.is_group("fraction"))return false;var e=t.get_top();var i=t.get_bottom();if(e.length!==1||i.length!==1)return false;e=e[0],i=i[0];var n=a.get_value(e.children[1]),r=a.get_value(i.children[1]);return a.is_num(e.children[1])&&a.is_num(i.children[1])&&r!==0&&(!gmath.options.actions.only_integer_division||(n===r||r<n&&n%r===0||n===0))};t.prototype.transform=function(t){var e=this.getNewTreeNode(this.actor);var i=e.parent;this.addTouchedNodes(this.actor);var n=e.get_top();var r=e.get_bottom();n=n[0],r=r[0];var o=a.get_value(n.children[1])/a.get_value(r.children[1]);var s=new a(o);if(n.children[1]instanceof f||r.children[1]instanceof f){this.updateNodeMap(this.actor.children[0].children[1].get_mapping_to(s));this.updateNodeMap(this.actor.children[2].children[1].get_mapping_to(s))}else{this.updateNodeMap(this.actor.get_mapping_to(s))}var l=e.remove();i.insert(l,s);if(i.parent)c.handle(i,true);if(typeof t==="function")t(this);else return true};v.prototype.add_action_handler(new t);return new t}();gmath.actions.ReorderSumInFractionDenominatorAction=function(){var t=function(t){Action.call(this,"ReorderSumInFractionDenominatorAction","reorder sum in a fraction's denominator");this.priority=2;this.triggerType="dbltap";if(t)this.actor=t.actor};gmath.inherit(Action,t);t.prototype.match=function(t){if(!t)return false;if(!t.is_group("add","sub"))return false;if(!t.ls)return false;var e=t.ls;if(!e.children[1].is_group("fraction")||!t.children[1].is_group("fraction"))return false;return this.denominatorsHaveMatchingSums(e.children[1],t.children[1])};t.prototype.denominatorsHaveMatchingSums=function(t,e){var i=t.get_bottom(),n=e.get_bottom();if(i.length!==1||n.length!==1)return false;if(!c.areHidden(i[0].children[1])||!i[0].children[1].children[1].is_group("sum"))return false;if(!c.areHidden(n[0].children[1])||!n[0].children[1].children[1].is_group("sum"))return false;var r=i[0].children[1].children[1],o=n[0].children[1].children[1];if(r.to_ascii()===o.to_ascii())return false;var s=function(t){return t.to_ascii()};return gmath.array.isPermutation(r.children.map(s),o.children.map(s))};t.prototype.transform=function(t){this.addTouchedNodes(this.actor);this.addTouchedNodes(this.actor.ls);var e=this.getNewTreeNode(this.actor.ls).children[1],i=this.getNewTreeNode(this.actor).children[1];this.sortDenominatorsToMatch(e,i);if(typeof t==="function")t(this);else return true};t.prototype.sortDenominatorsToMatch=function(t,e){var i=t.get_bottom()[0].children[1].children[1],n=e.get_bottom()[0].children[1].children[1],r=i.children.slice(),o=n.children.slice();for(var s=0;s<r.length;s++){if(r[s].to_ascii()!==o[s].to_ascii()){for(var a=s;a<o.length;a++){if(r[s].to_ascii()===o[a].to_ascii()){var l=o[a];l.remove();n.insert(s,l);o=n.children.slice()}}}}};m.prototype.add_action_handler(new t);return new t}();gmath.actions.CrossMultiplyFractionsAction=function(){var e=function(t){Action.call(this,"CrossMultiplyFractionsAction","cross multiply fractions");this.priority=1;this.triggerType="dbltap";if(t)this.actor=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){if(!t)return false;if(!t.is_group("add","sub"))return false;if(!t.ls)return false;var e=t.ls;return e.children[1].is_group("fraction")&&t.children[1].is_group("fraction")};e.prototype.transform=function(e){this.addTouchedNodes(this.actor);this.addTouchedNodes(this.actor.ls);var i=this.getNewTreeNode(this.actor.ls).children[1],n=this.getNewTreeNode(this.actor).children[1];var r=this.getUncommonDenominatorFactors(i,n),o=this.getUncommonDenominatorFactors(this.actor.ls.children[1],this.actor.children[1]);
r.leftUncommonFactors.forEach(t.remove);r.rightUncommonFactors.forEach(t.remove);this.sortDenominatorsToMatch(i,n);if(r.leftUncommonFactors.length>0){var s=this.extendFractionWithFactors(i,r.leftUncommonFactors);var a=this.extendFractionWithFactors(n,r.leftUncommonFactors,true,true);this.mapOldFactorsToNewFactors(o.leftUncommonFactors,s,a)}if(r.rightUncommonFactors.length>0){var l=this.extendFractionWithFactors(i,r.rightUncommonFactors,true);var h=this.extendFractionWithFactors(n,r.rightUncommonFactors);this.mapOldFactorsToNewFactors(o.rightUncommonFactors,l,h)}if(typeof e==="function")e(this);else return true};e.prototype.getUncommonDenominatorFactors=function(t,e){var i=t.get_bottom().slice(),n=e.get_bottom().slice();for(var r=0;r<i.length;){var o=i[r];var s=false;for(var a=0;a<n.length;a++){var l=n[a];if(o.to_ascii()===l.to_ascii()){n.splice(a,1);s=true;break}}if(s){i.splice(r,1)}else{r++}}return{leftUncommonFactors:i,rightUncommonFactors:n}};e.prototype.sortDenominatorsToMatch=function(t,e){var i=t.get_bottom().slice(),n=e.get_bottom().slice();for(var r=0;r<i.length;r++){if(i[r].to_ascii()!==n[r].to_ascii()){for(var o=r;o<n.length;o++){if(i[r].to_ascii()===n[o].to_ascii()){var s=n[o];s.remove();e.insert(e.get_top().length+r+1,s);n=e.get_bottom().slice();break}}}}};e.prototype.extendFractionWithFactors=function(t,e,i,n){var r=[];if(i&&t.get_top().length===1&&a.is_num(t.children[0].children[1])&&a.get_value(t.children[0].children[1])===1){t.children[0].remove()}e.forEach(function(o){var s=[];var a=o.clone();s.push(a);t.append(a);if(i){a=o.clone();a.invert();s.push(a);n?t.insert(e.indexOf(o),a):t.append(a)}r.push(s)});return r};e.prototype.mapOldFactorsToNewFactors=function(t,e,i){for(var n=0;n<t.length;n++){var r=t[n];var o=e[n].concat(i[n]);for(var s=0;s<o.length;s++){this.extendNodeMap(r.get_mapping_to(o[s]))}}};m.prototype.add_action_handler(new e);return new e}();(function(){var e=function(t){Action.call(this,"ProductFractionCleanup","product-fraction cleanup action");if(t)this.actor=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){var e=t.get_top().length,i=t.get_bottom().length;if(e===0&&i===0)return true;if(t.value==="product"&&i>0)return true;if(t.value==="fraction"&&i===0)return true;if(t.value==="fraction"&&e===0)return true;if(e===1&&i===0)return true;return false};e.prototype.doInPlace=function(e){this.initNodeMap();var i=this.getNewTreeNode(this.actor);var n=this.actor;var r=i.get_top().length,o=i.get_bottom().length,s;var h;if(r===0&&o===0){var p=new a(1);s=t.get_mapping_between(this.actor,p);this.updateNodeMap(s);t.replace(i,p);if(p.parent.is_group("brackets"))c.handle(p.parent,true);h=true}if(!h&&n.value==="product"&&o>0){i.invert()}if(!h&&n.value==="fraction"&&o===0){i.invert()}if(n.value==="fraction"&&r===0){if(!(n.children[0]instanceof l))t.insert(i,0,new l("//"));t.insert(i,0,new _(new a(1)))}if(r===1&&o===0){var u=i.get_top()[0].children[1];this.updateNodeMap(n,u);this.updateNodeMap(n.children[0],u);this.updateNodeMap(n.children[0].children[0],u);t.replace(i,u);if(u.parent.is_group("brackets"))c.handle(u.parent,true);else{if(u.is_group("brackets"))var d=u.children[1];var f=c.handle(u,true);if(d&&f==="removed"){this.updateNodeMap(n,d);this.updateNodeMap(n.children[0],d);this.updateNodeMap(n.children[0].children[0],d)}}}if(typeof e==="function")e(this);else return this};v.prototype.cleanupAction=new e})();gmath.actions.PowerConvertToRadicalAction=function(){var e=function(t){Action.call(this,"PowerConvertToRadicalAction","flip a term into a denominator");this.priority=0;this.triggerType="drag";this.settings={delay:1500,on_release:true,side:"right-of",reset_y:true,margin:{x2:-.4,y2:.7,y1:-.4}};if(t){this.nodes=t.nodes;this.target=t.target}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){if(!this.matchSource(t))return[];return this.bindActionForEachTarget(t,[t[0].parent])};e.prototype.matchSource=function(t){return t.length===1&&t[0].is_group("degree")};e.prototype.transform=function(e){this.addTouchedNodes(this.target);var i=this.getNewTreeNode(this.nodes)[0],n=i.parent,r=n.get_radicand(),o=n.parent,s=n.remove();r.remove();i.remove();var l=i.get_term(),h=new b,p=new v;if(l.is_group("fraction")){var u=l.get_top(),d=l.get_bottom();t.remove_range(u);t.remove_range(d);u.forEach(function(t){t.invert()});d.forEach(function(t){t.invert()});p.append_range(d);if(!(u.length===1&&a.is_equal_to(u[0].children[1],1)))p.append_range(u)}else if(l.is_group("product")){var f=l.children.slice();t.remove_range(f);f.forEach(function(t){t.invert()});p.append_range(f)}else{p.append(new _(l,"div"))}h.append(p);c.handle(p);var g=new y(r,h);o.insert(s,g);this.updateNodeMap(this.nodes[0],h);this.updateNodeMap(this.nodes[0].parent,g);this.cleanup(p);if(typeof e==="function")e(this);return this};return new e}();r.prototype.move_actions.push(gmath.actions.PowerConvertToRadicalAction);(function(){var e=function(t){Action.call(this,"RadicalCleanup","power cleanup action");if(t)this.actor=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){return t.is_group("radical")&&t.children.length<4};e.prototype.doInPlace=function(e){this.initNodeMap();var i=this.getNewTreeNode(this.actor);var n=i.parent,r=this.actor.parent;if(i.is_group("radical")&&i.children.length<4){var o=i.children[2],s=this.getOldTreeNode(o);var a=t.remove(i);this.updateNodeMap(this.actor,n);n.insert(a,o)}if(typeof e==="function")e(this);else return this};q.prototype.cleanupAction=new e})();gmath.actions.RootEvaluateAction=function(){var e=function(t){Action.call(this,"RootEvaluateAction","evaluate a root");this.priority=0;this.triggerType="tap";if(t)this.actor=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){if(!t.is_group("radical"))return false;var e=t.get_degree().get_term(),i=t.get_radicand();return a.is_inequal_to(i,"gte",0)&&a.is_num(e)&&a.get_value(e)!==0||a.is_inequal_to(i,"lt",0)&&a.is_inequal_to(e,"gt",0)&&a.get_value(e)%2===1};e.prototype.transform=function(e){this.addTouchedNodes(this.actor);var i=this.getNewTreeNode(this.actor);var n=Math.pow(Math.abs(a.get_value(i.get_radicand())),1/a.get_value(i.get_degree().get_term())),r=new a(n);this.updateNodeMap(this.actor.get_mapping_to(r));t.replace(i,r);if(a.get_value(i.get_radicand())<0){var o=r.parent,s=r.remove(),l=new f(r);o.insert(s,l)}if(typeof e==="function")e(this);else return true};var i=new e;q.prototype.add_action_handler(i);return i}();q.prototype.add_action_handler(gmath.actions.RootEvaluateAction);gmath.actions.RadicalExtractExponentAction=function(){var t=function(t){Action.call(this,"RadicalExtractExponentAction","factor power");this.interactionType="drag";this.settings={side:"outside",reset_x:true,reset_y:true};if(t){this.nodes=t.nodes;this.target=t.target}};gmath.inherit(Action,t);t.prototype.getAllAvailableActions=function(t){var e=this.matchSource(t);if(!e)return[];var i=this.getTargets(e);return this.bindActionForEachTarget(t,i)};t.prototype.matchSource=function(t){if(t.length!==1)return false;if(!t[0].is_group("exponent")||!t[0].get_parent(2).is_group("radical"))return false;return{nodes:t,power:t[0].parent}};t.prototype.getTargets=function(t){return[t.power]};t.prototype.transform=function(t){this.addTouchedNodes(this.target.parent);var e=this.getNewTreeNode(this.nodes)[0],i=e.parent,n=i.parent,r=n.parent;var o=i.children[0];i.replace_with(o);c.handle(o);var s=n.remove();e.remove();r.insert(s,new y(n,e));if(typeof t==="function")t(this);else return true};return new t}();r.prototype.move_actions.push(gmath.actions.RadicalExtractExponentAction);gmath.actions.RadicalInsertExponentAction=function(){var e=function(t){Action.call(this,"RadicalInsertExponentAction","factor power");this.interactionType="drag";this.settings={side:"inside",reset_x:true,reset_y:true};if(t){this.nodes=t.nodes;this.target=t.target}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){var e=this.matchSource(t);if(!e)return[];var i=this.getTargets(e);return this.bindActionForEachTarget(t,i)};e.prototype.matchSource=function(e){if(!t.is_range(e))return false;if(!e[0].is_group("exponent")&&!(e[0].is_group("mul","div")&&c.areHidden(e[0].get_parent(2))&&e[0].get_parent(3).is_group("exponent")))return false;var i=e[0].parent.is_group("power")?e[0].parent:e[0].get_parent(4);if(!i.children[0].is_group("brackets")||!i.children[0].children[1].is_group("radical"))return false;return{nodes:e,radical:i.get_child([0,1])}};e.prototype.getTargets=function(t){return[t.radical]};e.prototype.transform=function(e){this.addTouchedNodes(this.target.parent);var i=this.getNewTreeNode(this.nodes),n=i[0].is_group("exponent")?i[0]:i[0].get_parent(3),r=n.parent,o=r.get_child([0,1]),s=o.get_radicand(),l=r.parent;if(i[0]===n){r.replace_with(o);s.remove();var h=new y(s,n);o.set_radicand(h)}else{t.remove_range(i);var p=new v;p.append_range(i);var u=new b(p);s.remove();var h=new y(s,u);o.set_radicand(h);this.cleanup_cascade(n.get_child([0,1]));if(a.is_equal_to(n.children[0],1)){n.remove();this.cleanup(r)}this.cleanup_cascade(i[0].parent)}if(typeof e==="function")e(this);else return true};return new e}();r.prototype.move_actions.push(gmath.actions.RadicalInsertExponentAction);gmath.actions.RadicalSimplifyAction=function(){var t=function(t){Action.call(this,"RadicalSimplifyAction","simplify a radical that contains a power with the same degree as the radical");this.settings={};this.interactionType="tap";if(t)this.actor=t.actor};gmath.inherit(Action,t);t.prototype.match=function(t){if(!t.is_group("radical"))return false;var e=t.get_radicand();if(!e.is_group("power"))return false;var i=t.get_degree_term(),n=e.get_exponent_term();return i.to_ascii()===n.to_ascii()};t.prototype.isGreaterOrEqualsZero=function(t){var e=r.evalExpression(t);if(!Number.isNaN(e))return e>=0;if(Algebrite){e=Algebrite.run(gmath.termsToAlgebriteString(t)+" >= 0");if(e==="1")return true;if(e==="0")return false;return null}else return null};t.prototype.transform=function(t){this.addTouchedNodes(this.actor);var e=this.getNewTreeNode(this.actor),i=e.get_radicand(),n=i.children[0],r=a.get_value(e.get_degree_term());if(r%2===0){e.replace_with(n);var o=n.parent,s=n.remove(),l=new d(n);o.insert(s,l)}else if(r%2===1){e.replace_with(n)}else{if(n.select_first(function(t){return h.is_var(t)})){e.replace_with(n);this.settings.restraint=n.to_ascii()+" must be ≥ 0."}else{var p=this.isGreaterOrEqualsZero(n);if(p||p===null)e.replace_with(n);if(p===false)this.settings.restraint=n.to_ascii()+" can't be < 0.";if(p===null)this.settings.restraint=n.to_ascii()+" must be ≥ 0."}}c.handle(n,true);if(typeof t==="function")t(this);else return true};var e=new t;q.prototype.add_action_handler(e);return e}();gmath.actions.RadicalSplitAction=function(){var e=function(t){Action.call(this,"RadicalSplitAction","turn a radical that has a product radicand into a product of radicals");this.priority=1;this.triggerType="drag";this.settings={target_group:true,group_side:"outside"};if(t){this.nodes=t.nodes;this.target=t.target;this.settings.side=t.side}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){var e=this.matchSource(t);if(!e)return[];var i=this.getTargets(e);return this.bindActionForEachTarget(t,i,true)};e.prototype.matchSource=function(e){if(!t.is_range(e))return false;var i=e[0];if(!i.is_group("mul","div"))return false;var n=i.get_parent(2);if(!n.is_group("radical"))return false;return{nodes:e,radicand:i.parent}};e.prototype.getTargets=function(t){return[t.radicand]};e.prototype.transform=function(e){this.addTouchedNodes(this.target.parent);var i=this.getNewTreeNode(this.nodes),n=i[0].parent,r=n.parent,o=r.parent,s=r.remove();t.remove_range(i);var a=r.clone(false);a.set_radicand(null);var l=false;var h=new v;if(i.length===1&&v.is_fraction_with_identity_numerator(i[0].children[1])){i=i[0].children[1].get_bottom();t.remove_range(i)}i.forEach(function(t){if(t.is_group("div")){l=true;t.invert()}h.append(t)},this);a.set_radicand(h);var p=new v;p.append(new _(r));var u=new _(a,l?"div":"mul");p.insert(this.settings.side==="left-of"?0:1,u);o.insert(s,p);this.nodes[0].get_parent(2).map_to_radical(this,a);this.setNodesToReselectAfterAction(u);this.cleanup(n);this.cleanup(h);this.cleanup(p);this.cleanup_cascade(o);if(typeof e==="function")e(this);return this};return new e}();r.prototype.move_actions.push(gmath.actions.RadicalSplitAction);gmath.actions.ScaleTupleAction=function(){var e=function(t){Action.call(this,"ScaleTupleAction","multiply a tuple by a number");this.priority=1;this.triggerType="tap";this.settings={delay:300,side:"inside",margin:{x:.1},reset_x:true,reset_y:true};if(t){if(t.triggerType==="drag"){this.triggerType=t.triggerType;this.nodes=t.nodes;this.target=t.target}else{this.actor=t.actor}}};gmath.inherit(Action,e);e.prototype.isTupleMul=function(t){return t&&t.is_group("mul")&&t.children[1].is_group("brackets")&&t.children[1].children[1].is_group("tuple")};e.prototype.getAllAvailableActions=function(t){if(!t.every(this.isScalarMul.bind(this)))return[];var e=this,i=t[0].parent.children.filter(this.isTupleMul.bind(this)),n=t[0].get_root();return i.map(function(i){return e.createBoundAction(n,{nodes:t,target:i,triggerType:"drag"})})};e.prototype.getTupleFactorsInSum=function(t){var e=this;re;var i=sum.children.filter(function(t){return t!==n&&e.isTupleAddend(t,len)});return i};e.prototype.isScalarMul=function(t){return t&&t.is_group("mul","div")&&!t.select_first(function(t){return t.is_group("tuple")})};e.prototype.extract=function(t){if(!t)return false;if(this.isTupleMul(t)&&this.isScalarMul(t.ls))return{scalars:[t.ls],tuple:t};if(this.isTupleMul(t.ls)&&this.isScalarMul(t))return{scalars:[t],tuple:t.ls};return false};e.prototype.match=function(t){if(t.is_group("fraction")){var e=t.get_top(),i=t.get_bottom();if(e.length===1&&this.isTupleMul(e[0])&&i.every(this.isScalarMul)){return true}}else if(t.is_group("mul","div")){return!!this.extract(t)}return false};e.prototype.getTupleAndScalars=function(){var t={};if(this.triggerType==="tap"){this.addTouchedNodes(this.actor);var e=this.getNewTreeNode(this.actor);if(this.actor.is_group("fraction")){t.parent_product=e;t.tuple=e.get_child([0,1,1]);t.scalar_muldivs=e.get_bottom()}else{var i=this.extract(e);t.scalars_were_on_the_left=i.scalars[0].get_idx()<i.tuple.get_idx();t.parent_product=e.parent;t.tuple=i.tuple.get_child([1,1]);t.scalar_muldivs=i.scalars}}else{this.addTouchedNodes(this.nodes);this.addTouchedNodes(this.target);var n=this.getNewTreeNode(this.nodes),r=this.getNewTreeNode(this.target);t.scalars_were_on_the_left=n[0].get_idx()<r.get_idx();t.parent_product=n[0].parent;t.scalar_muldivs=n;t.tuple=r.get_child([1,1])}return t};e.prototype.transform=function(e){var i=this.getTupleAndScalars();var n=i.scalars_were_on_the_left,r=i.parent_product,o=i.scalar_muldivs,s=i.tuple;for(var a=0;a<s.children.length;a++){this.scale_parameter(n,s.children[a],o)}t.remove_range(o);this.cleanup(r);for(var a=0;a<s.children.length;a++){this.cleanup_nested_products(s.children[a].children[1])}if(typeof e==="function")e(this);return this};e.prototype.scale_parameter=function(e,i,n){var r=i.children[1];var o=r.is_group("fraction")?r:new v;var s=t.clone(n);this.extendNodeMap(t.get_mapping_between(this.nodes||this.getOldTreeNode(n),s));r.remove();if(o.is_group("product")){o.append(new _(r));o.insert_range(e?0:1,s)}else{if(e)s.forEach(function(t){if(t.is_group("div"))o.insert_into_denominator(0,t);else o.insert(0,t)});else s.forEach(function(t){o.append(t)})}o.simplify=true;i.append(o)};e.prototype.cleanup_nested_products=function(t){for(var e=0;e<t.children.length;e++){this.cleanup(t.children[e])}};_.prototype.add_action_handler(new e);v.prototype.add_action_handler(new e);return new e}();r.prototype.move_actions.push(gmath.actions.ScaleTupleAction);gmath.actions.SplitExponentsAction=function(){var e=function(t){Action.call(this,"SplitExponentsAction","split exponents");this.triggerType="drag";this.settings={};if(t){this.nodes=t.nodes;this.target=t.target;this.settings.side=t.side}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){if(!this.match(t[0]))return[];if(t.length===t[0].parent.children.length)return[];var e=t[0].get_root(),i=t[0].parent.parent.parent.parent;return[this.createBoundAction(e,{nodes:t,target:i,side:"left-of"}),this.createBoundAction(e,{nodes:t,target:i,side:"right-of"})]};e.prototype.match=function(t){try{var e=(t.is_group("add")||t.is_group("sub"))&&t.parent.parent.parent.is_group("exponent");return e}catch(t){return false}};e.prototype.transform=function(t){this.addTouchedNodes(this.target);var e=this.getNewTreeNode(this.nodes),i=this.getNewTreeNode(this.target);var n;if(e[0].parent.children.indexOf(this.nodes[0])===0){n=e[0].parent.children[e.length].children[0]}else{n=e[0].parent.children[0].children[0]}var r=i,o=r.parent;var s=r.remove();this.extractNodesFromPowerExponentSum(e);var a=this.createSplittedOffPower(e);var l=this.placePowersIntoProduct(r,a);var h=this.nodes[0].children[0];this.extendNodeMap(h,a.parent.children[0]);this.extendNodeMap(n,r.parent.children[0]);for(var p=0;p<this.nodes.length;p++){this.updateNodeMap(this.nodes[p],a.parent)}if(o.is_group("mul")||o.is_group("div")){this.extendNodeMap(this.getOldTreeNode(o.children[0]),a.parent.children[0])}o.insert(s,l);this.cleanup(l.children[0].children[1].children[1].children[0].children[1]);this.cleanup(l.children[1].children[1].children[1].children[0].children[1]);c.handle(l.children[0].children[1].children[1].children[0],true);c.handle(l.children[1].children[1].children[1].children[0],true);this.cleanup(o);a.children[1].simplify=true;if(typeof t==="function")t(this);else return true};e.prototype.extractNodesFromPowerExponentSum=function(e){t.remove_range(e)};e.prototype.createSplittedOffPower=function(e){var i=this.target.children[0];var n=b.prototype.createGroup(),r=t.clone(i);this.extendNodeMap(i,r);n.append(r);var o=m.prototype.createGroup();o.append_range(e);var s=new b(o);n.append(s);return n};e.prototype.placePowersIntoProduct=function(t,e){var i=_.prototype.createGroup();var n=this.settings.side;i.append(new _(t));var r=new _(e);if(n==="left-of")i.insert(0,r);else i.append(r);return i};return new e}();r.prototype.move_actions.push(gmath.actions.SplitExponentsAction);SplitNumberAction=function(){var t=function(t){Action.call(this,"SplitNumberAction","n => (n-1) + 1");this.priority=0;this.triggerType="split";if(t)this.actor=t.actor};gmath.inherit(Action,t);t.prototype.match=function(t){return t instanceof a&&t.value>1};t.prototype.transform=function(t){var e=this.getNewTreeNode(this.actor);this.addTouchedNodes(this.actor);var i=e.parent;var n=e.remove();e.value--;var r=m.prototype.createGroup();r.append(new m(e));r.append(new m(new a(1)));this.resultNodes=r.children.slice();this.updateNodeMap(this.actor.get_mapping_to(r));i.insert(n,r);c.handle(r);this.cleanup(i);if(typeof t==="function")t(this);return true};return new t}();SplitProductAction=function(){var e=function(t){Action.call(this,"SplitProductAction","n*x => (n-1)*x + x");this.priority=1;this.triggerType="split";if(t){this.actor=t.actor;if("priority"in t)this.priority=t.priority}};gmath.inherit(Action,e);e.prototype.match=function(t){return t.is_group("mul")&&t.children[1]instanceof a&&t.children[1].value>1&&t.rs};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.actor),n=i.parent,r=i.children[1];this.addTouchedNodes(this.actor);r.value--;var o=n.children.slice(n.children.indexOf(i));var s=this.getOldTreeNode(o);var a=t.remove_range(o);var l=m.prototype.createGroup();var h=_.prototype.createGroup();var p=_.prototype.createGroup();var u;if(r.value===1){i.remove();o=o.slice(1);h.insert_range(0,o);u=t.clone(o);p.insert_range(0,u);this.extendNodeMap(t.get_mapping_between(s.slice(1),u))}else{h.insert_range(0,o);u=t.clone(o);p.insert_range(0,u);p.children[0].remove();this.extendNodeMap(t.get_mapping_between(s,u))}l.append(new m(h));l.append(new m(p));var c=new _(l);n.insert(a,c);this.cleanup(h);this.cleanup(p);var d=n.parent;if(this.cleanup(n))this.cleanup(d);if(typeof e==="function")e(this);return true};e.prototype.mapIndex=function(){map={};return function(t){return map[t]}};return new e}();SplitPowerAction=function(){var e=function(t){Action.call(this,"SplitPowerAction","x^n => x^(n-1) * x");this.priority=2;this.triggerType="split";if(t){this.actor=t.actor;if("priority"in t)this.priority=t.priority}};gmath.inherit(Action,e);e.prototype.match=function(t){return t.is_group("exponent")&&t.children[0]instanceof a&&t.children[0].value>=1};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.actor),n=i.parent,r=n.parent;this.addTouchedNodes(this.actor);var o=n.remove();var s=_.prototype.createGroup();s.append(new _(n));var a=t.clone(n.children[0]);this.extendNodeMap(this.actor.parent.children[0].get_mapping_to(a));s.append(new _(a));var l=i.children[0];l.value--;this.extendNodeMap(this.actor.children[0],a.parent);if(l.value===1){var h=n.children[0];n.remove();s.children[0].append(h);this.extendNodeMap(this.actor.children[0],h.parent)}else if(l.value===0){s.children[0].remove()}this.resultNodes=s.children.slice();r.insert(o,s);this.cleanup(r);if(typeof e==="function")e(this);return true};return new e}();SplitPowerSumAction=function(){var e=function(t){Action.call(this,"SplitPowerSumAction","x^(n1+n2+...+nm) => x^(n1+n2+...) * x^(nm)");this.priority=3;this.triggerType="split";if(t)this.actor=t.actor};gmath.inherit(Action,e);e.prototype.match=function(t){return t.is_group("exponent")&&(t.children[0].is_group("brackets")&&t.children[0].children[1].is_group("sum")||t.children[0].is_group("sum"))};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.actor),n=i.parent,r=n.parent,o=i.children[0];if(o.is_group("brackets"))o=o.children[1];var s=o.children[o.children.length-1],a=this.getOldTreeNode(s.children[0]);this.addTouchedNodes(this.actor.parent);var l=n.remove();var h=_.prototype.createGroup();h.append(new _(n));var p=t.clone(n);h.append(new _(p));p.children[1].children[0].remove();s.remove();var u=s.createGroup();u.append(s);p.children[1].append(u);r.insert(l,h);if(a.parent.is_group("add"))this.updateNodeMap(a,h.children[1].children[0]);else this.extendNodeMap(a,h.children[1].children[0]);this.cleanup(s.parent);this.cleanup(o);this.cleanup(r);if(typeof e==="function")e(this);return true};return new e}();gmath.actions.DistributeIntoBracketsAction=function(){var e=function(t){Action.call(this,"DistributeIntoBracketsAction","distribute");this.triggerType="drag";this.settings={side:"around",reset_x:true,reset_y:true,delay:300};this.priority=2;if(t){this.nodes=t.nodes;this.target=t.target}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){var e=[];if(t.length===0)return e;var i=t[0].get_root();if(!t[0].is_group("mul")&&!t[0].is_group("div"))return[];var n=this;function r(r){if(r.children[1]&&r.children[1].is_group("brackets")){o=r.children[1].children[1];if(n.match(t,o,"around"))e.push(n.createBoundAction(i,{nodes:t,target:o}))}}var o=t[0];while(o=o.ls)r(o);o=t[t.length-1];while(o=o.rs)r(o);return e};e.prototype.match=function(t,e,i){if(t.length===0)return false;if(e.value==="("||e.value===")")return false;var n=e.parent;if(!n.parent)return false;var r=n.parent.value;if(r!=="mul"&&r!=="div")return false;for(var o=0;o<t.length;o++)if(t[o].value!==r)return false;if(n.parent.parent!==t[0].parent)return false;if(!n.is_group("brackets"))return false;if(!n.children[1].is_group("sum"))return false;if(!t[0].commutative)return false;if(i==="left-of"&&n.ls===t[t.length-1])return false;if(i==="right-of"&&n.rs===t[0])return false;return true};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.nodes);var n=this.getNewTreeNode(this.target);var r=this.target.parent.children[0],o=this.target.parent.children[2];var s=n.parent;var a;if(i[i.length-1].rs&&i[i.length-1].rs.children[1]&&i[i.length-1].rs.children[1]===s){a="left"}if(i[0].ls&&i[0].ls.children[1]===s){a="right"}var l=s.parent.parent,h=s.children[1];t.remove_range(i);this.distributeIntoSum(h,i,a);if(l.cleanupAction)this.cleanup(l);var p=h.parent;if(!p.is_group("brackets")||p.is_group("brackets")&&p.parent.is_group("mul","div")&&p.parent.parent.is_group("fraction")&&(p.parent.is_group("mul")?p.parent.parent.get_top().length===1:p.parent.parent.get_bottom().length===1)){var u=h.remove();var d=new c(h);t.insert(p,u,d);this.updateNodeMap(r.parent,d);this.updateNodeMap(r,d.children[0]);this.updateNodeMap(o,d.children[2]);d.simplify=true}if(typeof e==="function")e(this);else return true};e.prototype.distributeIntoSum=function(e,i,n){var r=e.children.length;var o=function(t){if(t.is_group("div"))t.invert()};for(var s=0;s<r;s++){var l=e.children[s].children[1],h,p;l.remove();if(l.is_group("product"))h=l;else{h=new v;h.append(new _(l))}if(n==="left"&&s===0||n==="right"&&s===r-1){p=i}else p=t.clone(i);p.forEach(o);this.extendNodeMap(t.get_mapping_between(this.nodes,p));{var u=n==="left"?1:h.children.length-1;if(h.children[u])h.children[u].simplify=true}var c=n==="left"?0:h.children.length;h.insert_range(c,p);e.children[s].append(h);if(g(i)&&(d(i)||f(h))){h.children.forEach(function(t){t.simplify=false});h.simplify=true}}function d(t){return t.some(function(t){return t.is_group("mul")&&a.is_num(t.children[1])})}function f(t){return t.children.some(function(t){return t.is_group("mul")&&a.is_num(t.children[1])&&a.get_value(t.children[1])===0})}function g(t){return!t.some(function(t){return t.is_group("mul")&&a.get_value(t.children[1])===0})}};return new e}();r.prototype.move_actions.push(gmath.actions.DistributeIntoBracketsAction);gmath.actions.FactorOutOfBracketsAction=function(){var e=function(t){Action.call(this,"FactorOutOfBracketsAction","factor out");this.priority=0;this.triggerType="drag";this.settings={};if(t){this.nodes=t.nodes;this.target=t.target;this.settings.side=t.side}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(t){if(t.length===0)return[];var e=[],i=t[0];while(i.parent&&!i.is_group("brackets"))i=i.parent;if(this.match(t)){e.push(this.bindLeftSideAction(i,t));e.push(this.bindRightSideAction(i,t))}return e};e.prototype.nodesAreAllAddends=function(t,e){if(!t.is_group("sum"))return false;return t.children.length===e.length};e.prototype.bindLeftSideAction=function(t,e){var i=e[0].get_root();return this.createBoundAction(i,{nodes:e,target:t.children[0],side:"left-of"})};e.prototype.bindRightSideAction=function(t,e){var i=e[0].get_root();return this.createBoundAction(i,{nodes:e,target:t.children[2],side:"right-of"})};e.prototype.getContainingBrackets=function(t){try{var e=null;for(var i=0;i<t.length;i++){var n=t[i][0];var r=n.is_group("mul")?n.get_parent(4):n.get_parent(3);if(!r||!r.is_group("brackets")||c.areHidden(r))return null;if(!e)e=r;else if(e!==r)return null}return e}catch(t){return null}};e.prototype.match=function(e,i){var n=r.groupNodeRanges(e);var o=this.getContainingBrackets(n);if(!o)return false;if(i&&!(o.children[0]===i||o.children[2]===i))return false;if(!this.nodesAreAllAddends(o.children[1],n))return false;var s=n[0].length;n.forEach(function(t){if(t.length!==s)return false});for(var a=0;a<s;a++){var l;if(n[0][a].value==="mul")l=n[0][a].children[1].to_ascii();else l=n[0][a].to_ascii();for(var h=0;h<n.length;h++){var p;if(n[h][a].value==="mul")p=n[h][a].children[1].to_ascii();else p=n[h][a].to_ascii();if(p!==l)return false}}var u=t.get_cca(e);return u.is_group("sum")&&u.parent===o};e.prototype.transform=function(t){var e=this.getNewTreeNode(this.nodes);var i=this.findBracketGroup(e);var n=r.groupNodeRanges(e);var o=n.map(this.getOldTreeNode.bind(this));this.removeRangesFromSum(n);var s=this.factor(i,n,o);if(s.is_group("brackets")&&c.is_optional(s)){var a=s.parent;c.handle(s,true);s=a}if(s.cleanupAction)this.cleanup(s);if(typeof t==="function")t(this);else return true};e.prototype.findBracketGroup=function(t){var e=t[0];if(e&&e.parent&&e.parent.parent&&e.parent.parent.is_group("sum")&&e.parent.parent.parent&&e.parent.parent.parent.is_group("brackets"))return e.parent.parent.parent;if(e&&e.parent&&e.parent.is_group("product")&&e.parent.parent&&e.parent.parent.parent&&e.parent.parent.parent.is_group("sum")&&e.parent.parent.parent.parent&&e.parent.parent.parent.parent.is_group("brackets"))return e.parent.parent.parent.parent;throw"Attempting to factor from invalid structure."};e.prototype.removeRangesFromSum=function(e){for(var i=0;i<e.length;i++){var n=e[i];var r=e[i][0].parent;if(n.length===r.children.length){var o=r.parent;r.remove();t.remove_range(n);o.append(new a(1));this.cleanup(o)}else if(r.value==="add"||r.value==="sub"&&n.length===1){n[0].remove();r.append(new a(1))}else{t.remove_range(e[i]);this.cleanup(r)}}};e.prototype.factor=function(t,e,i){return this.replaceBracketGroupWithFactoredProduct(t,e,i)};e.prototype.replaceBracketGroupWithFactoredProduct=function(e,i,n){var r=_.prototype.createGroup();var o=e.parent;var s=e.remove();var a;var l=this.settings.side;if(l==="left-of"){a=i[0];if(a.length===1&&a[0].value!=="mul"){a=[new _(a[0])]}r.append_range(a);r.append(new _(e));for(var h=0;h<n.length;h++){if(n[h].length===1&&!n[h][0].is_group("mul")){this.updateNodeMap(n[h][0],a[0])}else{this.updateNodeMap(t.get_mapping_between(n[h],a))}}}else{a=i[i.length-1];if(a.length===1&&a[0].value!=="mul"){a=[new _(a[0])]}r.append(new _(e));r.append_range(a);for(var h=0;h<n.length;h++){if(n[h].length===1&&!n[h][0].is_group("mul")){this.updateNodeMap(n[h][0],a[0])}else{this.updateNodeMap(t.get_mapping_between(n[h],a))}}}t.insert(o,s,r);return o};e.prototype.mapIndex=function(){return function(){}};return new e}();r.prototype.move_actions.push(gmath.actions.FactorOutOfBracketsAction);gmath.actions.SubstitutionAction=function(){var e=function(t){Action.call(this,"SubstitutionAction","substitution");this.settings={layout_hint:"same-line"};if(t){this.nodes=t.nodes;this.target=t.target}};gmath.inherit(Action,e);e.prototype.rebind=function(t,e,i){if(this.nodes[0]===i){this.nodes[0]=t}else if(this.oldTree===i){var n=new Action;n.node_map=e;this.oldTree=t;this.target=n.mapNodes(this.target)}else throw"wrong old tree during rebinding an action!"};e.prototype.getAllAvailableActions=function(t,e){var i=this.findAllMatches(t,e);var n=[];for(var r=0;r<i.length;r++){var o=gmath.actions.SubstitutionAction.createBoundAction(e,{nodes:[t],target:i[r]});n.push(o)}return n};e.prototype.match=function(t,e){if(e.length===0||e[0].fixed)return false;if(!t.parent)t=t.children[0];if(!t.is_group("equals"))return false;var i=t.children[0].to_ascii();var n=p(i);return n(e)};e.prototype.rematch=function(){if(!(this.nodes&&this.nodes.length>0&&this.target&&this.target.length>0))return false;var t=[];this.target.forEach(function(e){var i=this.getAllAvailableActions(this.nodes[0],e.get_root());i.forEach(function(e){t=t.concat(e.target)})},this);return this.target.every(function(e){return t.indexOf(e)!==-1})};function i(t){if(t.length===1&&(t[0].hidden||t[0].is_group("tuple")))return"";return t.map(function(t){return t.to_ascii()}).join("")}function n(t){return t.is_group()&&t.commutative&&t.associative}function o(t){if(t.length===0)return"";if(t.length===1&&(t[0].hidden||t[0].is_group("tuple")))return"";var e=t.map(function(t){return t.to_ascii()}).join("");if(t.length===1)return e;if(n(t[0]))return e.substring(t[0].children[0].to_ascii().length);return e}function s(t){if(t.length!==1)return"";if(!t[0].is_group("fraction"))return"";var e=t[0].to_ascii();if(e.slice(0,1)==="("&&e.slice(e.length-1,e.length)===")")e=e.substr(1,e.length-2);return e}function a(t){if(t.length<2)return"";if(!t[0].is_group("div"))return"";var e=t.map(function(t){return t.to_ascii()}).join("").replace(/\//g,"*").substr(1);return e}e.prototype.findAllMatches=function(t,e){if(!t.parent)t=t.children[0];if(!t.is_group("equals"))return[];if(!e.parent)e=e.children[0];var i=t.children[0].to_ascii();var n=e.filterRange(p(i));n=n.filter(function(t){return t.length>0&&!t[0].fixed});return n};e.prototype.transform=function(e){
var i=this;var n=this.nodes[0].children[0].children[0].to_ascii();var o=this.nodes[0].children[0].children[2];var s=r.groupNodes(this.target,function t(e){return!p(n)(e)});var a=s.map(function(t){return t.map(i.getNewTreeNode.bind(i))});for(var l=0;l<s.length;l++){var h=a[l];var u=h[0].parent;var d=t.remove_range(h);var f=t.clone(o);if(h.length>1){f=new h[0].constructor(f);if(f.is_group("mul")&&h[0].is_group("div"))f.invert()}if(this.sourceIsASignGroupOrHasALeadingNegativeCoefficient(this.nodes[0])&&h[0].is_group("sub")){f=new m(f)}u.insert(d,f);s[l].forEach(function(e){this.updateNodeMap(e,f);this.updateNodeMap(o,f);this.updateNodeMap(t.get_leaf_nodes(e),t.get_leaf_nodes(f));this.updateNodeMap(t.get_leaf_nodes(o),t.get_leaf_nodes(f))},this);if(gmath.actions.AddNegativeAction.match(u)){this.compose(gmath.actions.AddNegativeAction.createAndDoInPlace(this.newTree,{actor:u}),false)}else if(u.parent&&u.parent.parent&&gmath.actions.PlusMinusProductToMinusProductAction.match(u.parent.parent)){this.compose(gmath.actions.PlusMinusProductToMinusProductAction.createAndDoInPlace(this.newTree,{actor:u.parent.parent}),false)}else if(gmath.actions.SignDoubleNegAction.match(u)){this.compose(gmath.actions.SignDoubleNegAction.createAndDoInPlace(this.newTree,{actor:u}),false)}var g=this.cleanup(f);if(!g)c.handle(f);this.cleanup(u)}if(typeof e==="function")e(this);return true};e.prototype.sourceIsASignGroupOrHasALeadingNegativeCoefficient=function(t){var e=t.children[0].children[0];if(e.is_group("sign"))return true;else if(e.is_group("product")&&e.children[0].children[1].is_group("sign"))return true;return false};function l(t){return t[0]&&t[0].parent&&!t[0].parent.is_group("exponent")&&t.length===t[0].parent.children.length}function h(t){return t.parent}function p(t){return function(e){if(e.length===0)return false;if(!e[0].parent)return false;if(h(e[0].parent)&&l(e))return false;return i(e)===t||o(e)===t||s(e)===t||a(e)===t}}return new e}();TriggerFactoringAction=function(){var t=function(t){Action.call(this,"TriggerFactoringAction","general factoring");this.priority=0;this.triggerType="drag";this.settings={side:"around"};if(t){this.DLOfSum=t.dl;this.viewOfSum=t.view;this.target=t.sum;this.callback=t.callback}};gmath.inherit(Action,t);t.prototype.match=function(t,i){return e(t,i)};t.prototype.transform=function(){this.callback(this.viewOfSum,this.target,this.DLOfSum)};var e=function(t,e){var i;i=n(t,e);i=o(i,t);var r=[];for(var s=0;s<i.length;s++){if(i[s].length===0)return false}for(var s=0;s<i.length;s++){if(i[s])r.push(i[s][i[s].length-1])}for(var s=0;s<r.length;s++){if(!Array.isArray(r[s])&&r[s].parent.value!=="add"&&r[s].parent.value!=="sub")r[s]=r[s].parent}return r.length===t.children.length?r:false};var i=function(t,e){var i=[];t.for_each(function(t){var n=t.to_ascii();if(n.slice(0,1)==="*")n=n.substr(1);if(!t.hidden&&n===e)i.push(t);else{var r=[t];while(n.length<e.length&&t.commutative&&t.rs){t=t.rs;n+=t.to_ascii();r.push(t)}if(n===e)i.push(r)}});return i};var n=function(t,e){var n=[];for(var r=0;r<t.children.length;r++){var o=t.children[r],s=o.children[1];n.push(i(s,e.to_ascii()))}return n};function r(t){return function(e){return!e.hidden&&e.to_ascii()===t}}var o=function(t,e){var i=function(t){return t.parent&&(t.parent.value==="add"||t.parent.value==="sub")&&t.parent.parent&&t.parent.parent==e};var n=function(t){return t.parent&&t.parent.value==="mul"&&t.parent.parent&&t.parent.parent.is_group("product")&&t.parent.parent.parent&&t.parent.parent.parent.parent&&t.parent.parent.parent.parent==e};var r=function(t){return t.value==="mul"&&t.parent&&t.parent.is_group("product")&&t.parent.parent&&t.parent.parent.parent&&t.parent.parent.parent==e};var o=function(t){var e=true;if(Array.isArray(t)){for(var o=0;o<t.length;o++)if(!r(t[o]))e=false}else{return i(t)||n(t)}return e};for(var s=0;s<t.length;s++){t[s]=t[s].filter(o)}return t};var s=function(t,e){var i=h(t),n=d(l(i));var r=e.deconstruct();return m(n,r)};var l=function(t){var e=[];for(var i=0;i<t.length;i++){e.push(t[i].slice())}return e};var h=function(t){var e=[];for(var i=0;i<t.children.length;i++){e.push(p(t.children[i]))}return e};var p=function(t){var e=t.children[1];if(t.value==="add")return e.deconstruct();else return c(e.deconstruct())};var u=function(t){t.push(new a(1));return t};var c=function(t){t.push(new a(-1));return t};var d=function(t){var e=t[0].slice();for(var i=0;i<t.length;i++){f(e,t[i])}return e};var f=function(t,e){for(var i=0;i<t.length;){if(g(t[i],e))t.splice(i,1);else i++}};var g=function(t,e){var i=t.to_ascii();var n=true;for(var r=0;r<e.length;){if(i===e[r].to_ascii()){n=false;e.splice(r,1);return n}else{r++}}return n};var m=function(t,e){var i=true;for(var n=0;n<e.length;n++){if(g(e[n],t)){i=false}}return i};return new t}();gmath.actions.showRoundedAction=function(){var t=function(t){Action.call(this,"showRoundedAction","show rounded");this.priority=1;this.triggerType="hold";if(t)this.actor=t.actor};gmath.inherit(Action,t);t.prototype.match=function(t){if(!t.is_group("num"))return false;return t.precision===null||t.decimal_count()>t.precision};t.prototype.transform=function(t){var e=this.getNewTreeNode(this.actor);if(e.precision===null)e.precision=2;else e.precision=null;if(typeof t==="function")t(this);return this};return new t}();gmath.actions.EvalTrigAction=function(){var e=function(t){Action.call(this,"EvalTrigAction","evaluate trig functions");this.priority=0;this.triggerType="tap";this.settings={};if(t){this.actor=t.actor;this.settings.angleType=t.angleType||"rad"}};gmath.inherit(Action,e);e.prototype.match=function(t){if(!M.Trig.is_trig_func(t))return false;return t.children[1]&&t.children[1].is_group("brackets")&&t.children[1].children[1].is_group("tuple")&&a.is_num(t.children[1].children[1].children[0].children[1])};e.prototype.transform=function(e){var i=this.getNewTreeNode(this.actor);this.addTouchedNodes(this.actor);var n=M.Trig.evaluate(i);if(!Number.isNaN(n)&&n!==Infinity&&n!==-Infinity){var r=new a(n);t.replace(i,r);this.updateNodeMap(this.actor,r)}if(typeof e==="function")e(this);return this};M.prototype.add_action_handler(new e);return new e}();gmath.actions.DragSplitNegativesAction=function(){var t=function(t){Action.call(this,"DragSplitNegativesAction","drag a negative sign to the left to extract a negative 1");this.priority=1;this.triggerType="drag";this.settings={delay:1e3,side:"left-of"};if(t){this.nodes=t.nodes;this.target=t.target}};gmath.inherit(Action,t);t.prototype.getAllAvailableActions=function(t){if(t.length!==1)return[];if(!(t[0]instanceof l)||t[0].to_ascii()!=="-")return[];if(a.get_value(t[0].parent.children[1])===1)return[];return this.bindActionForEachTarget(t,t)};t.prototype.transform=function(t){this.addTouchedNodes(this.target.parent);var e=this.getNewTreeNode(this.target.parent),i=e.parent,n=e.remove();var r=_.prototype.createGroup();var o=e.children[1];o.remove();var s=new a(-1);this.extendNodeMap(this.target.parent,s);this.updateNodeMap(this.target,s.children[0]);var l=new _(s);r.append(l);r.append(new _(o));var h=e.is_group("sub")?new m(r):r;i.insert(n,h);this.cleanup_cascade(i);this.setNodesToReselectAfterAction(l);if(typeof t==="function")t(this);return this};return new t}();r.prototype.move_actions.push(gmath.actions.DragSplitNegativesAction);gmath.actions.DragNegativeSymReselectGroupAction=function(){var t=function(t){Action.call(this,"DragNegativeSymReselectGroupAction","drag a negative sign to the left to extract a negative 1");this.priority=2;this.triggerType="drag";this.settings={makes_no_changes:true,update_node_positions:true,side:"outside",margin:{y1:.4,y2:.4}};if(t){this.nodes=t.nodes;this.target=t.target}};gmath.inherit(Action,t);t.prototype.getAllAvailableActions=function(t){if(t.length!==1)return[];var e=t[0];if(!e.is_group("sym")||e.value!=="-")return[];var i=e.get_root();var n=this.createBoundAction(i,{nodes:[e],target:e});if(e.rs&&e.rs.value===1)n.settings.side="inside";return[n]};t.prototype.transform=function(t){this.addTouchedNodes(this.target.parent);this.setNodesToReselectAfterAction(this.target.parent);if(typeof t==="function")t(this);return this};return new t}();r.prototype.move_actions.push(gmath.actions.DragNegativeSymReselectGroupAction);gmath.actions.AssociateIdentityIntoDenominatorAction=function(){var e=function(t){Action.call(this,"AssociateIdentityIntoDenominatorAction","associative property of multiplication--move into fraction");this.priority=2;this.triggerType="drag";this.settings={};if(t){this.nodes=t.nodes;this.target=t.target;this.settings.side=t.side;if(t.margin)this.settings.margin=t.margin}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(e){if(!e.length)return[];var i=[];if(!t.is_range(e))return[];var n=e[0].value;if(n!=="mul"&&n!=="div")return[];if(!e.every(function(t){return t.is_group(n)&&(a.get_value(t.children[1])===-1||a.get_value(t.children[1])===1)}))return[];var r=e[0].parent;var o=e[0].parent.children.indexOf(e[0]),s=e[0].parent.children.indexOf(e[e.length-1]);r.children.forEach(function(t,r){if((r<o||r>s)&&t.value===n&&t.children[1].is_group("fraction"))i=i.concat(this.bindActionForEachTarget(e,t.get_child([1]).get_bottom(),true))},this);return i};e.prototype.transform=function(e){this.nodes.forEach(function(t){this.addTouchedNodes(t)},this);this.addTouchedNodes(this.target.parent);var i=this.getNewTreeNode(this.nodes),n=this.getNewTreeNode(this.target);var r=n.parent;var o=r.children.indexOf(n);if(this.settings.side==="right-of")o++;t.remove_range(i);i.forEach(function(t){if(t.is_group("mul"))t.invert()});r.insert_range(o,i);this.cleanup(r);this.cleanup(r.parent);if(typeof e==="function")e(this);else return true};return new e}();r.prototype.move_actions.push(gmath.actions.AssociateIdentityIntoDenominatorAction);gmath.actions.AssociateIdentityOutOfDenominatorAction=function(){var e=function(t){Action.call(this,"AssociateIdentityOutOfDenominatorAction","associative property of multiplication--move into fraction");this.priority=0;this.triggerType="drag";this.settings={};if(t){this.nodes=t.nodes;this.target=t.target;this.settings.side=t.side;if(t.margin)this.settings.margin=t.side==="left-of"?{x1:-.25,x2:.25}:{x1:.25,x2:-.25}}};gmath.inherit(Action,e);e.prototype.getAllAvailableActions=function(e){if(!e.length)return[];if(!t.is_range(e))return[];if(!e.every(function(t){return t.is_group("div")&&(a.get_value(t.children[1])===-1||a.get_value(t.children[1])===1)}))return[];var i=e[0].parent,n=i.get_top(),r=i.get_bottom();if(n.length===1&&r.length===1&&a.get_value(n[0].children[1])===1)return[];return this.bindActionForEachTarget(e,[e[0].get_parent(1)],true)};e.prototype.transform=function(e){this.nodes.forEach(function(t){this.addTouchedNodes(t)},this);var i=this.getNewTreeNode(this.nodes),n=this.getNewTreeNode(this.target);t.remove_range(i);i.forEach(function(t){t.invert()});var r=n.parent,o=n.remove();var s=_.prototype.createGroup();s.append(new _(n));s.insert_range(this.settings.side==="left-of"?0:1,i);r.insert(o,s);this.cleanup(n);this.cleanup(r);if(typeof e==="function")e(this);else return true};return new e}();r.prototype.move_actions.push(gmath.actions.AssociateIdentityOutOfDenominatorAction);gmath.rules=gmath.rules||{};gmath.rules.distributes=function(e,i,n){n=n||"both";var r=e.prototype.value+" "+(n=="both"?"":n+"-")+"distributes over "+i.prototype.value;var o=function(n){var r,s;if(n=="both"){if(!this.is_group(e.prototype.name))return false;return o.call(this,"left")||o.call(this,"right")}else if(n=="left"){r=this;s=this.ls}else if(n=="right"){r=this.ls;s=this}else throw"direction must be left, right or both, not '"+n+"'";if(!(s instanceof e))return;if(!r)return false;var a=r.children[1];if(a.is_group("brackets"))a=a.children[1];if(!a.is_group(i.prototype.group_name))return false;t.remove(s);t.for_each(function(t){t.no_anim=true},s);for(var l=0;l<a.children.length;l++){var h=a.children[l];var u=h.children[1];var d=t.clone(s);if(u instanceof p&&u.children[0]instanceof e){if(n=="left")t.insert(u,0,d);else t.append(u,d)}else{var f=e.prototype.createGroup();t.remove(u);var g=new e(u);t.replace(g.children[0],t.clone(this.children[0]));t.append(f,n=="left"?d:g);t.append(f,n=="left"?g:d);t.append(h,f);c.handle(f)}}r.clean_up();return true};e.prototype.add_action_handler({name:r,run:function(){return o.call(this,n)}})};gmath.rules=gmath.rules||{};gmath.rules.inverse_operation=function(e,i){e.prototype.inverse=i.prototype.value;i.prototype.inverse=e.prototype.value;var n=function(){if(!this.ls)return false;if(this.ls instanceof this.getInverse()&&this.children[1].to_ascii()==this.ls.children[1].to_ascii()){t.remove(this.ls);var i=t.remove(this);t.insert(this.parent,i,new e(t.clone(this.identity_element)));this.parent.clean_up();return true}return false};e.prototype.add_action_handler({name:"inverse elements cancel out each other",run:n});i.prototype.add_action_handler({name:"inverse elements cancel out each other",run:n})};gmath.rules=gmath.rules||{};gmath.rules.identity_element=function(t,e){t.prototype.identity_element=e;var i=e.to_ascii()+" is the identity element of "+t.prototype.value;var n=e.to_ascii();var o=function(t){Action.call(this,"IdAction",i);this.triggerType="tap";this.priority=0;this.settings={delay:250,margin:{x:.1},side:"inside"};if(t){if(t.triggerType==="drag"){this.triggerType=t.triggerType;this.nodes=t.nodes;this.target=t.target}else{this.actor=t.actor}}};gmath.inherit(Action,o);o.prototype.isIdentityElement=function(e){return e instanceof t&&e.children[1].to_ascii()==n};o.prototype.match=function(e,i){if(arguments.length<2)i=e.ls||e.rs;if(i.value==="//")i=i.ls;if(e instanceof t&&a.is_num(e.children[1])&&i instanceof t&&a.is_num(i.children[1]))return false;if(e.get_parent(1).is_group("fraction")&&(this.isIdentityElement(e)&&e.is_group("mul")&&i.is_group("div")||this.isIdentityElement(i)&&i.is_group("mul")&&e.is_group("div")))return false;return this.isIdentityElement(e)||this.isIdentityElement(i)};o.prototype.getSiblings=function(e){return e.parent.children.filter(function(i){return i!==e&&i instanceof t})};o.prototype.getAllAvailableActions=function(e){var i=[];if(e.length!==1)return i;var n=e[0];if(!(n instanceof t))return i;var r=this.getSiblings(n);var o=n.get_root();for(var s=0;s<r.length;s++){if(this.match(n,r[s])){i.push(this.createBoundAction(o,{nodes:e,target:r[s],triggerType:"drag"}))}}return i};o.prototype.transform=function(t){var e=this;var i=this.nodes&&this.nodes[0]||this.actor,n=this.target||this.actor&&(this.actor.ls||this.actor.rs);this.addTouchedNodes(i);this.addTouchedNodes(n);var r,o;if(this.isIdentityElement(i)){r=i;o=n}else{r=n;o=i}o=this.getNewTreeNode(o);this.setNodesToReselectAfterAction(o);r=this.getNewTreeNode(r);r.remove();var s=o.parent.get_path();var a=this.cleanup_cascade(o.parent);if(typeof t==="function")t(this);else return true};gmath.actions.IdAction=new o;t.prototype.add_action_handler(new o);r.prototype.move_actions.push(gmath.actions.IdAction)};gmath.rules=gmath.rules||{};gmath.rules.zero_element=function(t,e){t.prototype.zero_element=e;var i=e.to_ascii();var n=i+" is the zero element of "+t.prototype.value;var o=function(t){Action.call(this,"ZeroAction",n);this.triggerType="tap";this.priority=5;this.settings={delay:250,margin:{x:.1},side:"inside"};if(t){if(t.triggerType==="drag"){this.triggerType=t.triggerType;this.nodes=t.nodes;this.target=t.target;this.priority=1}else{this.actor=t.actor}}};gmath.inherit(Action,o);o.prototype.isZeroElement=function(e){return e instanceof t&&e.children[1].to_ascii()==i};o.prototype.match=function(t,e){if(arguments.length<2)e=t.ls;if(!(t.value==="mul"||t.value===e.value))return false;return this.isZeroElement(t)||this.isZeroElement(e)};o.prototype.getSiblings=function(e){return e.parent.children.filter(function(i){return i!==e&&i instanceof t})};o.prototype.getAllAvailableActions=function(e){var i=[];if(e.length!==1)return i;var n=e[0];if(!(n instanceof t))return i;var r=this.getSiblings(n),o=n.get_root();for(var s=0;s<r.length;s++){if(this.match(n,r[s])){i.push(this.createBoundAction(o,{nodes:e,target:r[s],triggerType:"drag"}))}}return i};o.prototype.transform=function(t){var e=this.nodes&&this.nodes[0]||this.actor,i=this.target||this.actor&&(this.actor.ls||this.actor.rs);this.addTouchedNodes(e);this.addTouchedNodes(i);var n,r;if(this.isZeroElement(e)){n=e;r=i}else{n=i;r=e}var o=n.get_parent(1);n=this.getNewTreeNode(n);if(this.triggerType==="tap"){var s=o.get_top().concat(o.get_bottom()).map(this.getNewTreeNode.bind(this));s.forEach(function(t){if(t!==n)t.remove()})}else{this.getNewTreeNode(r).remove()}if(this.actor&&!this.isZeroElement(this.actor)||this.nodes&&!this.isZeroElement(this.nodes[0])){this.setNodesToReselectAfterAction(n.children[1])}this.cleanup_cascade(n.parent);if(typeof t==="function")t(this);else return true};gmath.actions.ZeroAction=new o;t.prototype.add_action_handler(new o);r.prototype.move_actions.push(gmath.actions.ZeroAction)};gmath.rules=gmath.rules||{};gmath.rules.init_all=function(){gmath.rules.identity_element(m,new a(0));gmath.rules.identity_element(_,new a(1));gmath.rules.zero_element(_,new a(0));gmath.rules.identity_element(A,new w("T"));gmath.rules.zero_element(A,new w("F"));gmath.rules.identity_element(k,new w("F"));gmath.rules.zero_element(k,new w("T"))};gmath.rules.init_all();mtouch_events=function(){var t=z(b,"tap","dbltap","hold","drag","mdrag","touch","release"),e=gmath.uid(),i=null,n=[],r={},o=[],s="mouse",a="client",l=null,h=false,p=mtouch_events.defaultOptions.input_types,u=mtouch_events.defaultOptions.tap_max_time,c=mtouch_events.defaultOptions.tap_max_dist,d=c*c,f=mtouch_events.defaultOptions.hold_time,g=mtouch_events.defaultOptions.hold_max_dist,m=g*g,v=mtouch_events.defaultOptions.dbltap_max_delay,_=mtouch_events.defaultOptions.dbltap_max_dist,y=mtouch_events.defaultOptions.zoom;function b(){i=this;b.connected(true)}b.connected=function(t){if(arguments.length==0)return h;if(!i)return this;var n=p==="all"||p==="touch";var r=p==="all"||p==="mouse";i.on("touchstart."+e,t&&n?x:null).on("mousedown."+e,t&&r?w:null).on("touchmove."+e,t&&n?A:null).on("touchend."+e,t&&n?T:null).on("touchcancel."+e,t&&n?T:null);h=t;return this};b.call=function(t){t.apply(b,arguments);return this};b.input_types=function(t){if(arguments.length===0)return p;if(p!==t){p=t;b.connected(h)}return this};b.frame=function(t){if(arguments.length===0)return a;a=t;return this};b.origin=function(t){if(arguments.length===0)return l;l=t;return this};b.zoom=function(t){if(arguments.length===0)return y;y=t;return this};b.hold_time=function(t){if(arguments.length===0)return f;f=t;return this};b.fingers=function(){return n};b.hold_max_dist=function(t){if(arguments.length===0)return g;g=t;m=g*g;return this};b.dbltap_max_dist=function(t){if(arguments.length===0)return _;_=t;return this};function w(){if(!E(d3.event))return;var t=d3.select(window);var e=this,i=arguments;t.on("mousemove.mtouch",function(){A.apply(e,i)});t.on("mouseup.mtouch",function(){t.on("mousemove.mtouch",null);t.on("mouseup.mtouch",null);T.apply(e,i)});x.apply(this,arguments)}function x(){d3.event.preventDefault();var e=this,i=t.of(e,arguments),o=N();var s=l?l.apply(this,arguments):null;for(var a=0,h=o.length;a<h;a++){var p=new k(o[a].identifier,i,e,s);n.push(p);r[o[a].identifier]=p;i({type:"touch",finger:p,fingers:n,idx:b.idx})}}function A(){d3.event.preventDefault();var e=this,i=t.of(e,arguments),o=N();for(var s=0,a=n.length;s<a;s++)n[s].changed=false;var l=[];for(var s=0,a=o.length;s<a;s++){var h=r[o[s].identifier];if(!h)continue;h.move(i);l.push(h)}i({type:"mdrag",dragged_fingers:l,fingers:n})}function T(){d3.event.preventDefault();var e=this,i=t.of(e,arguments),o=N();for(var s=0,a=o.length;s<a;s++){var l=r[o[s].identifier];if(!l)continue;delete r[o[s].identifier];n=d3.values(r);i({type:"release",finger:l,fingers:n});l.end(i)}}function k(t,e,i,n){this.id=t;this.target=i;this.event=e;this.parent=i.parentNode;this.timeStamp0=d3.event.timeStamp;this.timeStamp=this.timeStamp0;this.hold_timer=setTimeout(this.held.bind(this),f);this.pos=n?n.slice():M(this.id,a);this.pos0=[this.pos[0],this.pos[1]];this.pos_client=M(this.id,"client");this.dist_x=0;this.dist_y=0;this.dx=0;this.dy=0;this.dt=0;this.changed=true;this.gesture=null}k.prototype.cancel_hold=function(){if(this.hold_timer)clearTimeout(this.hold_timer);this.hold_timer=null};k.prototype.held=function(){this.event({type:"hold",finger:this,fingers:n});this.hold_timer=null};k.prototype.move=function(t){this.changed=true;this.event=t;var e=M(this.id,"client"),i=d3.event.timeStamp;this.dx=e[0]-this.pos_client[0];this.dy=e[1]-this.pos_client[1];this.pos[0]+=this.dx;this.pos[1]+=this.dy;this.dist_x=this.pos[0]-this.pos0[0];this.dist_y=this.pos[1]-this.pos0[1];this.pos_client=e;this.dt=i-this.timeStamp;this.timeStamp=i;if(this.dist_x*this.dist_x+this.dist_y*this.dist_y>m){this.cancel_hold()}if(this.gesture)return;t({type:"drag",finger:this,x:this.pos[0],y:this.pos[1],dx:this.dx,dy:this.dy,fingers:n})};k.prototype.end=function(t){var e=d3.event.timeStamp-this.timeStamp0;if(e<=u&&this.dist_x*this.dist_x+this.dist_y*this.dist_y<=d){if(S(d3.event.timeStamp,this.pos[0],this.pos[1])){t({type:"dbltap",finger:this,fingers:n})}else{t({type:"tap",finger:this,fingers:n})}}this.cancel_hold()};function N(){return d3.event.changedTouches||[{identifier:s}]}function E(t){if("buttons"in t)return t.buttons===1;else if("which"in t)return t.which===1;else return t.button===1}function S(t,e,i){var n=-1,r=[e,i];o=o.filter(function(e,i){if(t-e.timeStamp<=v&&C(e.pos,r)<=_)n=i;return e.timeStamp-t<=v&&n!==i});if(n===-1)o.push({timeStamp:t,pos:r});return n!==-1}function L(t){if(l)return l();else return M(t,a)}function M(t,e){if(e==="client"){if(t===s)return[d3.event.clientX/y,d3.event.clientY/y];for(var i=0;i<d3.event.touches.length;i++){var n=d3.event.touches[i];if(n.identifier===t)return[n.clientX/y,n.clientY/y]}}else{if(t===s)return I(e,d3.event,y);for(var i=0;i<d3.event.touches.length;i++){var n=d3.event.touches[i];if(n.identifier===t)return I(e,n,y)}}}function C(t,e){return Math.sqrt((t[0]-e[0])*(t[0]-e[0])+(t[1]-e[1])*(t[1]-e[1]))}return d3.rebind(b,t,"on")};mtouch_events.defaultOptions={zoom:1,input_types:"all",tap_max_time:250,tap_max_dist:10,hold_time:500,hold_max_dist:10,dbltap_max_delay:400,dbltap_max_dist:20};gmath.mtouch_defaults=mtouch_events.defaultOptions;function z(t){var e=d3.dispatch.apply(this,Array.apply(null,arguments).slice(1));e.of=function(i,n){return function(r){try{var o=r.sourceEvent=d3.event;r.target=t;d3.event=r;e[r.type].apply(i,n)}finally{d3.event=o}}};return e}gmath.d3_eventDispatch=z;var O=0;if(typeof window!=="undefined")O=/WebKit/.test(window.navigator.userAgent)?-1:0;function I(t,e,i){var n=t.ownerSVGElement||t;if(n.createSVGPoint){var r=n.createSVGPoint();if(O<0&&(window.scrollX||window.scrollY)){n=d3.select("body").append("svg").style({position:"absolute",top:0,left:0,margin:0,padding:0,border:"none"},"important");var o=n[0][0].getScreenCTM();O=!(o.f||o.e);n.remove()}if(O)r.x=e.pageX,r.y=e.pageY;else r.x=e.clientX,r.y=e.clientY;r=r.matrixTransform(t.getScreenCTM().inverse());return[r.x/i,r.y/i]}var s=t.getBoundingClientRect();return[(e.clientX-s.left-t.clientLeft)/i,(e.clientY-s.top-t.clientTop)/i]}drag_behavior=function(){var t=z(p,"drag","drag-start","drag-end"),e=[],i=false,n,r,o,s,a=10,l=5,h=true;var p=function(){this.on("touch.drag",u).on("mdrag.drag",c).on("release.drag",d)};p.min_single_dist=function(t){if(arguments.length===0)return a;a=t;return this};p.min_double_dist=function(t){if(arguments.length===0)return l;l=t;return this};p.allow_double_drag=function(t){if(arguments.length===0)return h;h=t;return this};var u=function(){if(e.length===2||h&&e.length===1)return;e.push(d3.event.finger);if(e.length===2){n=[(e[0].pos[0]+e[1].pos[0])/2,(e[0].pos[1]+e[1].pos[1])/2];r=[n[0],n[1]];s=o=f(e[0].pos,e[1].pos)}else{n=[e[0].pos[0],e[0].pos[1]];r=[n[0],n[1]];o=s=0}};var c=function(){if(e.length===0)return;var h,p=t.of(this,arguments);if(e.length===1){if(!e[0].changed)return;h=[e[0].pos[0],e[0].pos[1]];if(!i&&f(n,r)>=a){i=true;p({type:"drag-start",fingers:e,pos0:n,pos:r,dist0:o,dist:s})}}else{if(!e[0].changed&&!e[1].changed)return;h=[(e[0].pos[0]+e[1].pos[0])/2,(e[0].pos[1]+e[1].pos[1])/2];s=f(e[0].pos,e[1].pos);if(!i&&f(n,r)>=l){i=true;p({type:"drag-start",fingers:e,pos0:n,pos:r,dist0:o,dist:s})}}if(i)p({type:"drag",fingers:e,pos0:n,pos:h,dist0:o,dist:s,dx:h[0]-r[0],dy:h[1]-r[1]});r=h};var d=function(){if(e.length===0)return;var o=d3.event.finger;var s=e.indexOf(o);if(s===-1)return;e.splice(s,1);if(!i)return;if(e.length===1){n=[e[0].pos[0],e[0].pos[1]];r=[n[0],n[1]]}if(e.length===0){i=false;t.of(this,arguments)({type:"drag-end"})}};function f(t,e){return Math.sqrt((t[0]-e[0])*(t[0]-e[0])+(t[1]-e[1])*(t[1]-e[1]))}return d3.rebind(p,t,"on")};var P=function(t,e){if(typeof e==="undefined")e=1e3;var i={},n=[],r;i.fonts=[];i.map={};i.finished=false;i.success=false;i.svg=d3.select("body").append("svg").style({position:"absolute",visibility:"hidden",width:"1px",height:"1px"});i.on_fonts_loaded=function(t){if(this.finished)t(this.success);else{n.push(t)}};var o=function(){i.loadSizes();for(var t=0;t<n.length;t++){n[t](this.success)}n=[]};i.add_fonts=function(t){var e=false;t.forEach(function(t){var n=s(t);if(n)t.id=n.id;else{t.id=gmath.uid();i.fonts.push(t);e=true}});if(!e)return;i.wait_for_fonts()};var s=function(t){for(var e=0;e<i.fonts.length;e++){var n=i.fonts[e];if(n.style===t.style&&n.family===t.family&&n.weight===t.weight)return n}return null};i.wait_for_fonts=function(){if(r)clearInterval(r);this.finished=false;this.success=false;this.fonts.unshift({family:"serif"});var t=this.svg.selectAll("text.temp").data(this.fonts);t.enter().append("text").classed("temp",true).style("font-size","100px").style("font-family",function(t){if(t.family.indexOf(" ")===-1)return t.family+", serif";else return"'"+t.family+"', serif"}).style("font-style",function(t){return t.style}).style("font-weight",function(t){return t.weight}).text("012abc");t.exit().remove();this.fonts.shift();var i=Date.now();var n=this;r=setInterval(function(){var s=[],a=true;t.each(function(t,e){s[e]=this.getBBox().width});for(var l=1;l<s.length;l++){if(s[l]===s[0])a=false}var h=Date.now()-i;if(!a&&h<=e)return;n.success=a;n.finished=true;t.remove();clearInterval(r);o()},20)};i.loadSizes=function(t,e){t=t||"xyz0123456789()=+-*^∗·•−,.";e=e||this.fonts;var i=[];for(var n=0;n<e.length;n++){if(!this.map[e[n].id]){this.map[e[n].id]={}}for(var r=0;r<t.length;r++){var o={font:e[n],char:t[r],width:0,height:0};this.map[e[n].id][t[r]]=o;i.push(o)}}this.svg.selectAll(".hiddenChars").data(i).enter().append("text").style("font-size","100px").style("font-family",function(t){return t.font.family}).style("font-style",function(t){return t.font.style}).style("font-weight",function(t){return t.font.weight}).text(function(t){return t.char}).each(function(t){var e=this.getBBox();t.width=e.width;t.height=e.height}).remove()};i.width=function(t,e,i){var n=0,r=t.toString();for(var o=0;o<r.length;o++){if(!this.map[i.id]||!this.map[i.id][r[o]]){this.loadSizes(r[o],[i])}n+=this.map[i.id][r[o]].width}return n*e/100};i.height=function(t,e,i){var n=0,r=t.toString();for(var o=0;o<r.length;o++){if(!this.map[i.id]||!this.map[i.id][r[o]])this.loadSizes(r[o],[i]);n=Math.max(this.map[i.id][r[o]].height,n)}return n*e/100};i.add_fonts(t);return i};gmath.FontLoader=P;transform_behavior=function(){var t=z(v,"transform","transformend","transformstart"),e=[],i=0,n=0,r=0,o=1,s={scale:true,translate:true,rotate:true},a=true,l,h,p,u,c,d,f,g,m;var v=function(){this.on("touch.transform",_).on("mdrag.transform",y).on("release.transform",b)};v.transform=function(t){if(!arguments.length)return{scale:o,rotate:r,translate:[i,n]};if("scale"in t)o=t.scale;if("rotate"in t)r=t.rotate;if("translate"in t){i=t.translate[0];n=t.translate[1]}return v};v.one_finger_drag=function(t){if(!arguments.length)return a;a=t;return v};v.allow_translate=function(t){if(!arguments.length)return s.translate;s.translate=t;return v};v.allow_scale=function(t){if(!arguments.length)return s.scale;s.scale=t;return v};v.allow_rotate=function(t){if(!arguments.length)return s.rotate;s.rotate=t;return v};var _=function(){if(e.length===2)return;e.push(d3.event.finger);if(e.length===1&&a){l=h=[e[0].pos[0],e[0].pos[1]];p=A(h);t.of(this,arguments)({type:"transformstart"})}if(e.length===2){l=h=N(e[0].pos,e[1].pos);u=c=k(e[0].pos,e[1].pos);d=f=E(e[0].pos,e[1].pos);p=A(h);g=o;m=r}};var y=function(){if(e.length===0)return;if(!d3.event.dragged_fingers.some(function(t){return t.changed}))return;if(e.length===1){if(!a)return;if(s.translate)l=[e[0].pos[0],e[0].pos[1]];T(l,p)}if(e.length===2){if(s.scale)u=k(e[0].pos,e[1].pos);if(s.translate)l=N(e[0].pos,e[1].pos);if(s.rotate)d=E(e[0].pos,e[1].pos);w()}t.of(this,arguments)({type:"transform",fingers:e,transform:{scale:o,rotate:r,translate:[i,n]}})};var b=function(){if(e.length===0)return;var i=d3.event.finger;var n=e.indexOf(i);if(n===-1)return;e.splice(n,1);if(e.length===0){t.of(this,arguments)({type:"transformend"})}if(e.length===1){l=h=[e[0].pos[0],e[0].pos[1]];p=A(h)}};var w=function(){if(s.rotate)r=m+(d-f);if(s.scale)o=g*u/c;if(s.translate||s.rotate||s.scale)T(l,p)};var x=function(t){var e=Math.cos(r),s=Math.sin(r);var a=t[0]*e-t[1]*s,l=t[1]*e+t[0]*s;return[a*o+i,l*o+n]};var A=function(t){var e=(t[0]-i)/o,s=(t[1]-n)/o;var a=Math.cos(-r),l=Math.sin(-r);return[e*a-s*l,s*a+e*l]};var T=function(t,e){e=x(e);i+=t[0]-e[0];n+=t[1]-e[1]};function k(t,e){return Math.sqrt((t[0]-e[0])*(t[0]-e[0])+(t[1]-e[1])*(t[1]-e[1]))}function N(t,e){return[(t[0]+e[0])/2,(t[1]+e[1])/2]}function E(t,e){return Math.atan2(t[1]-e[1],t[0]-e[0])}return d3.rebind(v,t,"on")};gmath.transform_behavior=transform_behavior;var F={};gmath.HitTester=F;F.draw=function(t,e,i){var n=t.selectAll(".target_area").data(e?e:[]);n.enter().append("rect").classed("target_area",true).style({fill:"none",stroke:"lightpink","stroke-width":2,"stroke-style":"dashed"});n.attr("x",function(t){return t.x}).attr("y",function(t){return t.y}).attr("width",function(t){return t.width}).attr("height",function(t){return t.height});n.exit().remove();var r=t.selectAll(".source_area").data(i?[i]:[]);r.enter().append("rect").classed("source_area",true).style({fill:"none",stroke:"steelblue","stroke-width":2});r.attr("x",function(t){return t.x}).attr("y",function(t){return t.y}).attr("width",function(t){return t.width}).attr("height",function(t){return t.height});r.exit().remove()};F.getBoundingBox=function(t,e,i){if(arguments.length<2)e=1;var n=Infinity,r=-Infinity,o=Infinity,s=-Infinity;for(var a=0;a<t.length;a++){var l=t[a];if(l.hidden&&!l.smooshing)continue;var h=i?l.x0||0:l.x,p=i?l.y0||0:l.y;n=Math.min(n,l.sel_box.x+h);r=Math.max(r,l.sel_box.x+h+l.sel_box.width);o=Math.min(o,l.sel_box.y+p);s=Math.max(s,l.sel_box.y+p+l.sel_box.height)}var u=r-n,c=s-o;return{x:n+u*(1-e)/2,y:o+c*(1-e)/2,width:u*e,height:c*e}};F.setTargetRegions=function(t,e){t.forEach(function(t){var i,n=F.getRawTargetBox(t.target,t.settings.side);t.raw_target_box={};gmath.extend(t.raw_target_box,n);if(t.settings.target_group){var r=t.target.get_parent(1);if(r.is_group("fraction")&&t.settings.group_side==="around"){var o=F.getRawTargetBox(r,"around");var s=t.target.is_group("mul")?r.get_top():r.get_bottom();i=F.getRawTargetBox(s,"around");i.width=o.width;i.x=o.x}else{i=F.getRawTargetBox(r,t.settings.group_side)}}else{i=n}if(t.settings&&t.settings.offset)F.adjustTargetBoxByOffset(i,t.settings.offset);if(t.settings&&t.settings.margin)F.adjustTargetBoxByMargin(i,t.settings.margin,e);gmath.extend(t,i)});F.extendExtremeTargetBoxes(t)};F.getRawTargetBox=function(t,e){var i={};switch(e){case"left-of":i.x=t.sel_box.x+t.x0-.5;i.width=1;i.y=t.sel_box.y+t.y0;i.height=t.sel_box.height;break;case"right-of":i.x=t.sel_box.x+t.x0+t.sel_box.width-.5;i.width=1;i.y=t.sel_box.y+t.y0;i.height=t.sel_box.height;break;case"below":i.x=t.sel_box.x+t.x0;i.width=t.sel_box.width;i.y=t.sel_box.y+t.y0+t.sel_box.height-.5;
i.height=1;break;case"above":i.x=t.sel_box.x+t.x0;i.width=t.sel_box.width;i.y=t.sel_box.y+t.y0-.5;i.height=1;break;default:if(Array.isArray(t)){var n=F.getBoundingBox(t);i.x=n.x;i.width=n.width;i.y=n.y;i.height=n.height}else{i.x=t.sel_box.x+t.x0;i.width=t.sel_box.width;i.y=t.sel_box.y+t.y0;i.height=t.sel_box.height}break}return i};F.adjustTargetBoxByMargin=function(t,e,i){var n=0,r=0,o=0,s=0;if(e.all){n=r=o=s=e.all}if(e.x){n=r=e.x}if(e.y){o=s=e.y}if(e.x1)n=e.x1;if(e.y1)o=e.y1;if(e.x2)r=e.x2;if(e.y2)s=e.y2;n*=i;o*=i;r*=i;s*=i;t.x+=n;t.width-=r+n;t.y+=o;t.height-=s+o;if(t.width<=0){t.x+=-n>-r?-t.width/2:t.width/2;t.width=1}if(t.height<=0){t.y+=-o>-s?-t.height/2:t.height/2;t.height=1}};F.adjustTargetBoxByOffset=function(t,e){t.x+=e.x;t.y+=e.y};F.extendExtremeTargetBoxes=function(t){var e,i;var n;for(var o=0;o<t.length;o++){var s=t[o];if(!s.settings.extend_extreme_target_boxes)continue;if(!s.nodes)continue;if(s.nodes.length===1&&s.nodes[0]instanceof r)continue;if(!n)n=F.getBoundingBox(s.nodes,1,true);if(!e&&s.x+s.width<n.x||e&&s.x<e.x&&s.x+s.width<n.x)e=s;if(!i&&n.x+n.width<s.x||i&&i.x<s.x&&n.x+n.width<s.x)i=s}if(e&&e.settings.side!=="inside"){e.x-=1e3;e.width+=1e3;e.y-=500;e.height+=1e3}if(i&&i.settings.side!=="inside"){i.width+=1e3;i.y-=500;i.height+=1e3}};F.getHits=function(t,e){var i=[];i=i.concat(t.filter(function(t){return(!t.settings.target_group&&t.settings.side!=="outside"||t.settings.target_group&&t.settings.group_side!=="outside")&&F.overlaps(t,e)}));i=i.concat(t.filter(function(t){return(!t.settings.target_group&&t.settings.side==="outside"||t.settings.target_group&&t.settings.group_side==="outside")&&!F.overlaps(t,e)}));return i};F.getBestHit=function(t,e){var i=F.getHits(t,e);return F.getHighestPriorityHit(i,e)};F.getEnclosingRectForSourceLineEndpoint=function(t){return{xmin:t.B.x-2,ymin:t.B.y-2,xmax:t.B.x+2,ymax:t.B.y+2}};F.overlaps=function(t,e){return(t.x>=e.x&&t.x<=e.x+e.width||t.x+t.width>=e.x&&t.x+t.width<=e.x+e.width||t.x<=e.x&&t.x+t.width>=e.x+e.width)&&(t.y>=e.y&&t.y<=e.y+e.height||t.y+t.height>=e.y&&t.y+t.height<=e.y+e.height||t.y<=e.y&&t.y+t.height>=e.y+e.height)};F.getHighestPriorityHit=function(t,e){var i=null;for(var n=0;n<t.length;n++){var r=t[n];if(!i)i=r;else if(i.settings.side==="outside")i=r;else if(r.priority>i.priority)i=r;else if(r.priority===i.priority){var o=i.settings.target_group?i.raw_target_box:i,s=r.settings.target_group?r.raw_target_box:r;if(F.getCenterDist(s,e)<F.getCenterDist(o,e))i=r}}return i};F.getCenterDist=function(t,e){var i=t.x+t.width/2-e.x-e.width/2,n=t.y+t.height/2-e.y-e.height/2;return Math.sqrt(i*i+n*n)};F.getOverlapArea=function(t,e){var i=Math.max(t.x,e.x)-Math.min(t.x+t.width,e.x+e.width),n=Math.max(t.y,e.y)-Math.min(t.y+t.height,e.y+e.height);return Math.max(0,i)*Math.max(0,n)};var R={};gmath.Reselector=R;R.rules=[];R.getNewSelection=function(t){var e=this.getBestRule(t);if(!e)return false;return e.apply(t)};R.getBestRule=function(t){var e=null;for(var i=0;i<this.rules.length;i++){var n=this.rules[i];if(n.match(t)&&(!e||e.priority<n.priority))e=n}return e};R.hasMatchingRule=function(t){for(var e=0;e<this.rules.length;e++)if(rules[e].match(t))return true;return false};R.Rule=function(t,e){this.name=t;this.priority=e||0};R.Rule.prototype.match=function(t){throw"override match function!"};R.Rule.prototype.apply=function(t){throw"override apply function!"};PowerRule=function(){R.Rule.call(this,"reselect whole power",1)};gmath.inherit(PowerRule,R.Rule);PowerRule.prototype.match=function(t){if(t.length!==1)return false;var e=t[0],i=e.parent;if(!e.is_group("exponent"))return false;if(!i.parent.is_group("mul","div"))return false;var n=i.parent.parent;return n.children.some(function(t){if(t.to_ascii()==="//")return false;var e=t.children[1];return e!==i&&gmath.actions.MultiplyPowersAction.areLikeTerms(i,e)})};PowerRule.prototype.apply=function(t){return[t[0].parent.parent]};R.rules.push(new PowerRule);var B=function(t,e){this.view=t;this.alm=t.model;this.nodes=[];this.line={A:{},B:{}};this.line_el=null;this.interaction_handler=e;this.action=gmath.actions.FractionCancelAction};B.prototype.check=function(t,e){return t.fingers.length==1&&e.length==0};B.prototype.start=function(t,e){this.line_el=this.view.main.append("line").classed("cancel-fraction",true).style("stroke",this.view.options.selection_color).style("stroke-width",6).style("stroke-linecap","round");this.nodes=[];this.line.A.x=this.line.B.x=t[0];this.line.A.y=this.line.B.y=t[1];return[]};B.prototype.update=function(t){this.line.B.x+=t.dx;this.line.B.y+=t.dy;var e=this.process_selection(this.get_crossed_nodes());var i=true;if(this.nodes.length!=e.length)i=false;else for(var n=0;n<this.nodes.length;n++)i=i&&this.nodes[n]==e[n];if(!i)this.interaction_handler.highlight_nodes(e);this.nodes=e;this.line_el.attr("x1",this.line.A.x).attr("y1",this.line.A.y).attr("x2",this.line.B.x).attr("y2",this.line.B.y)};B.prototype.end=function(){this.line_el.remove();var t=this.nodes[0],e;if(this.nodes.length===3&&this.nodes[1].value==="//")e=this.nodes[2];else if(this.nodes.length===2)e=this.nodes[1];if(e&&this.action.match(t,e)){var i=this.actions.createBoundAction(this.alm,{nodes:[e],target:t});this.alm.performAction(i,null,"cancel fraction")}this.nodes=[]};B.prototype.process_selection=function(e){var i=e.length;if(i===0)return[];if(i===1)return[e[0].parent];var n=t.get_cca(e);if(n.is_group("fraction")){var r=[];for(var o=0;o<e.length;o++){var s=e[o];while(s.parent!=n)s=s.parent;if(s.value=="//"&&n.get_bottom().length!=1)continue;if(r.indexOf(s)==-1)r.push(s)}return r}else return[n]};B.prototype.get_crossed_nodes=function(){var e=[];var i=t.get_leaf_nodes(this.alm);for(var n=0;n<i.length;n++){var r=i[n];if(!r.hidden&&this.intersects(r))e.push(r)}return e};B.prototype.intersects=function(t){var e=this.line.A,i=this.line.B;var n=t.sel_box.x+t.x,r=t.sel_box.x+t.sel_box.width+t.x;var o=t.sel_box.y+t.y,s=t.sel_box.y+t.sel_box.height+t.y;if(e.x<n&&i.x<n)return false;if(e.x>r&&i.x>r)return false;if(e.y<o&&i.y<o)return false;if(e.y>s&&i.y>s)return false;var a=function(t,n){return(e.x-i.x)*(e.y-n)-(e.y-i.y)*(e.x-t)<0};if(a(n,o)!=a(r,o))return true;if(a(r,o)!=a(n,s))return true;if(a(n,s)!=a(r,s))return true;return false};var G=function(t,e){this.default_precision=1;this.interaction_handler=e;this.precision=null;this.view=t;this.dy=0;this.pixels_per_unit=50;this.node=null;this.value=null;this.value0=null};G.prototype.check=function(t){if(this.view.model.options.locked)return false;var e=t.pos0[1]-t.pos[1];return Math.abs(e)>=10};G.prototype.start=function(t,e){this.old_anim_dur=this.view.options.dur;this.view.options.dur=0;this.node=this.process_selection(e);if(!this.node)return[];if(this.node&&this.node.precision)this.precision=this.node.precision;else this.precision=this.default_precision;this.dy=0;this.value=this.value0=this.view.model.numeric_value(this.node);return[this.node]};G.prototype.update=function(t){if(!this.node||!t.dy)return;this.dy+=t.dy;var e=-this.dy/this.pixels_per_unit;this.set_value(this.value0+e)};G.prototype.set_value=function(t){t=+t.toFixed(this.precision);if(t===this.value)return;this.value=t;var e=this.view.model.numeric_value(this.node,t);if(e instanceof a){e.scrubbingThisNum=true;e.precision=this.precision}else if(e.is_group("add","sub","sign")){e.children[1].scrubbingThisNum=true;e.children[1].precision=this.precision}if(e!==this.node){this.interaction_handler.highlight_nodes(this.start(null,[e]))}};G.prototype.end=function(){if(this.node){if(this.node instanceof a)delete this.node.scrubbingThisNum;if(this.node.is_group("add","sub","sign"))delete this.node.children[1].scrubbingThisNum;this.view.update_all()}this.view.options.dur=this.old_anim_dur;this.node=null};G.prototype.process_selection=function(t){var e=function(t){return t.is_group("sign")||t.is_group("add")||t.is_group("sub")};if(t.length===0||t.length>2)return null;if(t.length===2){var i=t[1];if(i instanceof a&&e(i))return i.parent;return null}var n=t[0];if(n instanceof a){if(e(n.parent))return n.parent;else return n}else if(e(n))return n;return null};gmath.ChangeNumberHandler=G;var j=function(t,e,i){this.id=gmath.uid();this.send_events=true;this.events=d3.dispatch("tap","dbltap","drag_start","drag","drag_end","touch","release","hold","inspect_node","keyup","keydown","node_selection");this.view=t;this.recorder=i;this.mode="edit";this.modes=["edit","inspect","arrange"];this.interactive=e;this.init();if(!e)this.set_interactive(false);this.selected_nodes=[];this.handlers={edit:[new et(this.view,this),new rt(this.view,this),new nt(this.view,this),new tt(this.view,this),new it(this.view,this)],inspect:[new G(this.view,this)]};this.active_handler=null;this.active_action=null;this.pending_eoi=null;this.ignore_next_release_event=false;this.always_visualize_fingers=false;this.finger_vis=null};j.prototype.getHandlerByClass=function(t){var e=function(e){return e instanceof t};for(var i in this.handlers){var n=this.handlers[i].filter(e);if(n.length>0)return n[0]}};j.prototype.start_of_interaction=function(){this.view.model.startInteraction()};j.prototype.end_of_interaction=function(){if(this.pending_eoi){clearTimeout(this.pending_eoi);this.pending_eoi=null}this.view.model.finishInteraction()};j.prototype.init=function(){var t=this.view.main.node();this.mtouch=mtouch_events().frame(t).hold_time(this.view.options.hold_time);this.view.event_receiver.call(this.mtouch);this.mtouch.on("touch",this.on_touch.bind(this,null)).on("release",this.on_release.bind(this,null)).on("tap",this.on_tap.bind(this,null)).on("dbltap",this.on_dbltap.bind(this,null)).on("hold",this.on_hold.bind(this,null));var e=drag_behavior().on("drag-start",this.on_drag_start.bind(this,null)).on("drag",this.on_drag.bind(this,null)).on("drag-end",this.on_drag_end.bind(this,null));this.mtouch.call(e);d3.select(document).on("keydown."+this.id,this.on_keydown.bind(this,null));d3.select(document).on("keyup."+this.id,this.on_keyup.bind(this,null))};j.prototype.abort_interaction=function(){if(this.active_handler)this.active_handler.end();this.active_handler=null;this.highlight_nodes([])};j.prototype.setMode=function(t){if(this.modes.every(function(e){return e!==t}))return;this.view.setMode(t);if(t!==this.mode)this.view.update_existing("normal");this.mode=t;if(!this.interactive)this.mtouch.connected(this.mode==="inspect")};j.prototype.set_interactive=function(t){this.interactive=!!t;if(this.mode==="inspect")this.mtouch.connected(true);else this.mtouch.connected(this.interactive)};j.prototype.select_new_handler=function(t){var e=this.handlers[this.mode]||[];for(var i=0;i<e.length;i++){var n=e[i];if(n.check(t,this.selected_nodes)){this.active_handler=n;this.highlight_nodes(n.start(t.pos,this.selected_nodes));return}}};j.prototype.on_keydown=function(t){var e=t||d3.event;function i(){this.highlight_nodes(this.selected_nodes.map(function(t){return this.get_user_selection(null,null,{altKey:true},t)},this).reduce(function(t,e){return t.concat(e[0])},[]));this.mtouch.fingers().forEach(function(t){t.cancel_hold()})}if(e.keyCode===16){}else if(e.keyCode===18){if(this.mtouch.fingers().length>0&&this.selected_nodes.length>0){i.call(this)}}else if(e.keyCode===32){this.spaceBarDown=true;if(this.mtouch.fingers().length>0&&this.selected_nodes.length>0){i.call(this);if(e.preventDefault)e.preventDefault()}}else if(e.keyCode===27){if(this.active_handler&&!this.active_action){this.active_handler.end();this.active_handler=null;this.end_of_interaction();this.ignore_next_release_event=true;this.highlight_nodes([]);if(e.preventDefault)e.preventDefault()}}else return;if(this.active_handler&&e.preventDefault)e.preventDefault();if(this.send_events)this.events.keydown(new Z("down",e,this.id))};j.prototype.on_keyup=function(t){var e=t||d3.event;if(e.keyCode===16){}else if(e.keyCode===32){this.spaceBarDown=false}else return;if(this.active_handler&&e.preventDefault)e.preventDefault();if(this.send_events)this.events.keyup(new Z("up",e,this.id))};j.prototype.on_tap=function(t){if(this.active_action)return;var e=this.selectInputEvent(t,d3.event);if(this.active_handler)return;if(e.shiftKey)return;var i=this.get_closest_node_at(e.finger.pos);var n;if(i)n=this.getFirstUnfixedParent(i);if(this.send_events)this.events.tap(new W(e,this.id,i,n));if(!n)return;var r=this;if(this.mode==="inspect"){this.highlight_nodes([]);this.events.inspect_node({node:n});this.end_of_interaction()}if(this.mode==="edit"){this.view.model.process_operator(n,function(){r.end_of_interaction();r.highlight_nodes([])},new W(e,this.id))}};j.prototype.on_dbltap=function(t){if(this.active_action)return;var e=this.selectInputEvent(t,d3.event);if(this.active_handler)return;if(e.shiftKey)return;var i=this.get_closest_node_at(e.finger.pos);var n;if(i)n=this.getFirstUnfixedParent(i);if(this.send_events)this.events.tap(new U(e,this.id,i,n));if(!n)return;var r=this;if(this.mode==="edit"){this.view.model.process_operator(n,function(){r.end_of_interaction();r.highlight_nodes([])},new U(e,this.id))}};j.prototype.on_hold=function(t){if(this.active_action)return;var e=this.selectInputEvent(t,d3.event);if(this.active_handler||this.mode!=="edit"){return}if(this.send_events)this.events.hold(new J(e,this.id));var i=this.get_closest_node_at(e.finger.pos);if(!i){return}if(this.mode==="edit"){if(gmath.actions.showRoundedAction.match(i)){var n=gmath.actions.showRoundedAction.createBoundAction(this.view.model,{actor:i});this.performAction(n,true)}else{this.active_action=this.view.model.process_operator(i,function(t){this.end_of_interaction();this.highlight_nodes([]);this.active_action=null}.bind(this),new J(e,this.id))}}};j.prototype.performAction=function(t,e,i){this.active_action=t;this.view.model.performAction(t,function(){this.active_action=null;this.end_of_interaction();this.highlight_nodes([]);if(i)i()}.bind(this),e)};j.prototype.getFirstUnfixedParent=function(t){while(t.fixed&&t.parent&&!r.is_top_most(t.parent))t=t.parent;return t};j.prototype.selectInputEvent=function(t,e){if(t)return t;var i=e;while(i.sourceEvent)i=i.sourceEvent;e.shiftKey=i.shiftKey;e.altKey=i.altKey;return e};j.prototype.on_drag_start=function(e){if(this.active_action)return;if(!this.interactive&&this.mode!=="inspect")return;var i=this.selectInputEvent(e,d3.event);var n=this.selected_nodes.slice();if(this.active_handler){if(this.send_events)this.events.drag_start(new V(i,this.id,n));return}if(this.selected_nodes.length>1){this.selected_nodes=t.nodes_to_range(this.selected_nodes)}this.select_new_handler(i);if(this.send_events)this.events.drag_start(new V(i,this.id,n,this.selected_nodes))};j.prototype.update_fingers=function(t,e){if(!this.finger_sel){var i=this.view.main.node();this.finger_sel=d3.select(i).selectAll(".finger");var n=d3.touches(i,[{pageX:0,pageY:0,clientX:0,clientY:0}])[0];var r=d3.touches(this.view.svg.node(),[{pageX:0,pageY:0,clientX:0,clientY:0}])[0];this.dpos_finger_vis=[r[0]-n[0],r[1]-n[1]];this.finger_vis_start=Date.now()}var o=this.finger_sel.data(t);if(!e){o.enter().append("circle").classed("finger",true).attr("r",20).style({stroke:"#4D4D4D","stroke-opacity":.5,fill:"#B2CAED","fill-opacity":.5}).transition().ease("bounce").attr("r",17)}var s=this.dpos_finger_vis;o.attr("cx",function(t){return t.pos[0]-s[0]}).attr("cy",function(t){return t.pos[1]-s[1]});var a=this.finger_vis_start;o.exit().transition().delay(Math.max(0,250-(Date.now()-a))).style("opacity",1e-4).remove();this.finger_sel=o.size()===0?null:o};j.prototype.on_drag=function(t){if(this.active_action)return;if(!this.interactive&&this.mode!=="inspect")return;var e=this.selectInputEvent(t,d3.event);if(this.send_events)this.events.drag(new K(e,this.id,this.selected_nodes));if(t||this.always_visualize_fingers)this.update_fingers(e.fingers,true);if(!this.active_handler)this.select_new_handler(e);if(this.active_handler)this.active_handler.update(e)};j.prototype.on_drag_end=function(t){if(this.send_events)this.events.drag_end(new Q(this.uid))};j.prototype.on_touch=function(t){if(this.active_action)return;if(!this.interactive&&this.mode!=="inspect")return;var e=this.selectInputEvent(t,d3.event);if(t||this.always_visualize_fingers)this.update_fingers(e.fingers);if(this.active_handler){if(this.send_events)this.events.touch(new X(e,this.id));return}var i=this.get_user_selection(e.finger,null,e),n;if(e.fingers.length===1){if(!e.shiftKey)this.start_of_interaction();if(e.shiftKey){n=gmath.array.xor(this.selected_nodes,i)}else{if(!gmath.array.containsAll(this.selected_nodes,i)){n=i}}}else if(e.fingers.length===2){n=this.get_user_selection(e.fingers[0],e.fingers[1],e)}if(this.send_events)this.events.touch(new X(e,this.id,i,n||this.selected_nodes));if(n)this.highlight_nodes(n)};j.prototype.on_release=function(t){if(!this.interactive&&this.mode!=="inspect")return;var e=this.selectInputEvent(t,d3.event);if(t||this.always_visualize_fingers)this.update_fingers(e.fingers);if(this.ignore_next_release_event){this.ignore_next_release_event=false;return}if(this.send_events)this.events.release(new Y(e,this.id));if(e.fingers.length===0){var i=e.shiftKey;if(this.active_handler){if(this.active_handler instanceof et)i=true;this.active_handler.end();this.active_handler=null}if(!this.active_action&&!i){this.pending_eoi=setTimeout(function(){this.pending_eoi=null;this.end_of_interaction();this.highlight_nodes([])}.bind(this),1)}}};j.prototype.get_user_selection=function(e,i,n,o){var s;if(i)s=this.get_nodes_between(e.pos,i.pos);else{var a=o||this.get_closest_node_at(e.pos);if(!a)return[];a=this.getFirstUnfixedParent(a);if(n.altKey||this.spaceBarDown){while(a.parent.parent&&!a.parent.commutative)a=a.parent;var l=a.parent.parent;if(l&&l.is_group("fraction")){s=a.parent.is_group("mul")?l.get_top():l.get_bottom()}else if(a.parent.commutative)s=[a.parent.parent];else s=r.is_top_most(a.parent)?[a]:[a.parent]}else s=[a]}return t.nodes_to_range(s)};j.prototype.highlight_nodes=function(e,i){if(gmath.array.equals(this.selected_nodes,e))return;this.selected_nodes=e;var n=this.view;t.for_each(function(t){t.selected=false},n.model.children);for(var r=0;r<e.length;r++)e[r].selected=true;n.renderer.set_style(n.model.children);n.update_style(i);if(this.send_events)this.events.node_selection(new $(this.id,e))};j.prototype.get_hits=function(e){var i=e[0],n=e[1];return t.get_leaf_nodes(this.view.model).filter(function(t){return!t.hidden&&t.sel_box&&i<=t.x+t.sel_box.x+t.sel_box.width&&i>=t.x+t.sel_box.x&&n<=t.y+t.sel_box.y+t.sel_box.height&&n>=t.y+t.sel_box.y})};j.prototype.get_closest_node_at=function(t){var e=null,i=Infinity;var n=t[0],r=t[1];var o=this.get_hits(t);for(var s=0;s<o.length;s++){if(o[s].hidden)continue;var a=o[s].x-n;var l=o[s].y-o[s].baseline_shift-r;var h=a*a+l*l;if(h<i){i=h;e=o[s]}}return e};j.prototype.get_nodes_between=function(e,i){var n=0;return t.get_leaf_nodes(this.view.model).filter(function(t){if(t.hidden||!t.sel_box||t.value=="//")return false;var r=[t.x+t.sel_box.x+t.sel_box.width/2,t.y+t.sel_box.y+t.sel_box.height/2];var o=H(e,i,r);var s=t.sel_box.width/4+t.sel_box.height/4;if(o.len==0)return o.dist<=s+n;return o.k>=0&&o.k<=1&&o.dist<=s+n})};var H=function(t,e,i){var n,r,o=.5;var s=[e[0]-t[0],e[1]-t[1]];var a=Math.sqrt(s[0]*s[0]+s[1]*s[1]);if(a<1e-6){n=t[0]-i[0];r=t[1]-i[1];a=0}else{var l=[i[0]-t[0],i[1]-t[1]];var o=(s[0]*l[0]+s[1]*l[1])/a;var n,r;if(o<0){n=t[0]-i[0];r=t[1]-i[1]}else if(o>a){n=e[0]-i[0];r=e[1]-i[1]}else{n=t[0]+o*s[0]/a-i[0];r=t[1]+o*s[1]/a-i[1]}}return{dist:Math.sqrt(n*n+r*r),k:o/a,len:a}};var V=function(t,e,i,n){this.type="drag_start";this.performee=e;this.performee_type="interaction-handler";this.time=Date.now();this.pos=[t.pos[0],t.pos[1]];this.pos0=[t.pos0[0],t.pos0[1]];this.dist=t.dist;this.dist0=t.dist0;if(t.altKey)this.altKey=t.altKey;if(t.shiftKey)this.shiftKey=t.shiftKey;this.fingers={length:t.fingers.length};this.target=i;this.selection=n};var W=function(t,e,i,n){this.type="tap";this.performee=e;this.performee_type="interaction-handler";this.time=Date.now();if(t.altKey)this.altKey=t.altKey;if(t.shiftKey)this.shiftKey=t.shiftKey;this.finger={pos:[t.finger.pos[0],t.finger.pos[1]]};this.target=i;this.selection=n};var U=function(t,e,i,n){this.type="dbltap";this.performee=e;this.performee_type="interaction-handler";this.time=Date.now();if(t.altKey)this.altKey=t.altKey;if(t.shiftKey)this.shiftKey=t.shiftKey;this.finger={pos:[t.finger.pos[0],t.finger.pos[1]]};this.target=i;this.selection=n};var Z=function(t,e,i){this.type="key"+t;this.performee=i;this.performee_type="interaction-handler";this.time=Date.now();this.keyCode=e.keyCode};var J=function(t,e){this.type="hold";this.performee=e;this.performee_type="interaction-handler";this.time=Date.now();this.finger={pos:[t.finger.pos[0],t.finger.pos[1]]}};var K=function(t,e,i){this.type="drag";this.performee=e;this.performee_type="interaction-handler";this.time=Date.now();this.dx=t.dx;this.dy=t.dy;this.dist=t.dist;this.dist0=t.dist0;this.pos=[t.pos[0],t.pos[1]];this.pos0=[t.pos0[0],t.pos0[1]];this.fingers=t.fingers.map(function(t){return{pos:[t.pos[0],t.pos[1]]}});this.selection=i};var Q=function(t){this.type="drag_end";this.performee=t;this.performee_type="interaction-handler";this.time=Date.now()};var X=function(t,e,i,n){this.type="touch";this.performee=e;this.performee_type="interaction-handler";this.time=Date.now();if(t.altKey)this.altKey=t.altKey;if(t.shiftKey)this.shiftKey=t.shiftKey;if(t.finger)this.finger={pos:[t.finger.pos[0],t.finger.pos[1]],id:t.finger.id};this.fingers=t.fingers.map(function(t){return{pos:[t.pos[0],t.pos[1]]}});this.target=i;this.selection=n};var Y=function(t,e){this.type="release";this.performee=e;this.performee_type="interaction-handler";this.time=Date.now();if(t.altKey)this.altKey=t.altKey;if(t.shiftKey)this.shiftKey=t.shiftKey;this.fingers=t.fingers.map(function(t){return{pos:[t.pos[0],t.pos[1]]}});if(t.finger)this.finger={pos:[t.finger.pos[0],t.finger.pos[1]],id:t.finger.id}};var $=function(t,e){this.type="node_selection";this.performee=t;this.performee_type="interaction-handler";this.time=Date.now();this.selection=e};var tt=function(t){this.view=t;this.alm=this.view.model;this.nodes=[];this.node_ids=[];this.joined=false;this.unjoined_state=null};tt.prototype.check=function(t){return t.dist-t.dist0<-15};tt.prototype.start=function(t,e){this.nodes=this.proccess_selection(e);this.node_ids=this.nodes.map(function(t){return t.id});return this.nodes};tt.prototype.update=function(e){if(this.joined){if(e.dist>3*e.dist0/4+10)this.unjoin();return}if(this.nodes.length<1||e.dist>3*e.dist0/4)return;var i=this.nodes[0].commutative?1:0;this.unjoined_state=t.clone(this.alm.children[0],true);this.unjoined_state.parent=this.alm;this.joined=true;var n=this;var r=function(t){n.alm.process_operator(n.nodes[t],function(){if(t+1<n.nodes.length)r(t+1);else n.nodes=[]})};r(i)};tt.prototype.unjoin=function(){var e=this.alm;this.joined=false;e.children[0]=this.unjoined_state;e.changed();this.nodes=this.node_ids.map(function(i){return t.get_by_id(i,e.children)})};tt.prototype.end=function(){this.nodes=[];this.node_ids=[];this.unjoined_state=null;this.joined=false};tt.prototype.proccess_selection=function(t){if(t.length!==2)return t;if(!t[0].parent.commutative||!t[1].is_group())return t;return t[1].children.slice()};var et=function(t,e){this.view=t;this.alm=this.view.model;this.interaction_handler=e;this.initial_nodes=[];this.nodes=[];this.pos0=null;this.pos=null;this.box_el=null};et.prototype.check=function(t){return t.shiftKey};et.prototype.start=function(t,e){this.pos0=t.slice();this.pos=t.slice();this.initBox();this.initial_nodes=e;return e};et.prototype.update=function(t){this.pos[0]+=t.dx;this.pos[1]+=t.dy;this.updateBox();var e=this.getNodesInRect(this.pos0[0],this.pos0[1],this.pos[0],this.pos[1]);if(gmath.array.isPermutation(e,this.nodes))return;this.nodes=e;this.highlight()};et.prototype.initBox=function(){this.box_el=this.view.main.append("rect").attr("transform","translate("+this.pos0+")").style("stroke",this.view.options.selection_color).style("stroke-width",2).style("fill",this.view.options.selection_color).style("fill-opacity",.33)};et.prototype.updateBox=function(){this.box_el.attr("width",Math.abs(this.pos[0]-this.pos0[0])).attr("height",Math.abs(this.pos[1]-this.pos0[1])).attr("transform","translate("+Math.min(this.pos0[0],this.pos[0])+","+Math.min(this.pos0[1],this.pos[1])+")")};et.prototype.getNodesInRect=function(e,i,n,r){var o=Math.min(e,n),s=Math.max(e,n);var a=Math.min(i,r),l=Math.max(i,r);var h=t.get_leaf_nodes(this.view.model).filter(function(t){return!t.hidden&&t.sel_box&&o<=t.x+t.sel_box.x+t.sel_box.width&&s>=t.x+t.sel_box.x&&a<=t.y+t.sel_box.y+t.sel_box.height&&l>=t.y+t.sel_box.y});return h};et.prototype.updatedSelection=function(){return gmath.array.mergedNew(this.initial_nodes,this.nodes).filter(et.nodeIsNotFractionBar)};et.nodeIsNotFractionBar=function(t){return t.value!=="//"};et.prototype.highlight=function(){this.interaction_handler.highlight_nodes(this.updatedSelection())};et.prototype.end=function(){this.box_el.remove();return this.updatedSelection()};var it=function(t,e){this.view=t;this.nodes=null;this.splitted=false;this.new_state=null;this.prevDist=null;this.interaction_handler=e;this.actions=[SplitNumberAction,SplitProductAction,SplitPowerAction,SplitPowerSumAction,gmath.actions.RemoveBracketsAction]};it.prototype.check=function(t){return t.dist-t.dist0>15};it.prototype.start=function(t,e){this.prevDist=null;this.nodes=e;return this.nodes||[]};it.prototype.end=function(){this.node=null;this.splitted=false};it.prototype.getBestAction=function(t,e,i){var n=i;this.actions.forEach(function(i){if(n&&i.priority<=n.priority)return;if(i.match(e))n=i.createBoundAction(t,{actor:e})});for(var r=e.children.length-1;r>=0;r--){var o=e.children[r];var s=this.getBestAction(t,o,n);if(s)n=s}return n};it.prototype.split=function(e,i){var n;for(var r=i.length-1;r>=0;r--){n=this.getBestAction(e,i[r],n)}if(!n)return false;e.performAction(n);var o=t.nodes_to_range(n.mapNodes(n.actor));return o};it.prototype.update=function(t){if(!this.nodes)return;if(this.prevDist!==null&&t.dist-this.prevDist<=30)return;var e=this.split(this.view.model,this.nodes);if(!e)return;this.prevDist=t.dist;this.nodes=e;this.interaction_handler.highlight_nodes(this.nodes)};if(typeof module==="object"&&module.exports){module.exports=it}var nt=function(t,e){this.id=gmath.uid();this.view=t;this.interaction_handler=e;this.dl=t.options.derivation_list;this.dy0=0;this.dx=0;this.dy=0;this.dx_queue=[];this.dy_queue=[];this.nodes=[];this.leaf_nodes=[];this.smooshedNodes=[];this.smooshing=false;this.rubberband_dir=0;this.bbox=null;this.actions=[];this.on_release_action=null;this.target_areas=null;this.active=false;this.indicator=this.view.options.show_drag_indicator?nt.Indicator(nt.indicator_vis_mode):null};nt.indicator_vis_mode=1;nt.show_target_areas=false;nt.prototype.check=function(t,e){var i=t.pos0[0]-t.pos[0],n=t.pos0[1]-t.pos[1];if(t.fingers.length===1&&e.length===0)return false;return i*i+n*n>=8*8};nt.prototype.isActive=function(){return this.active};nt.prototype.start=function(t,e,i){if(this.view.options.hide_mouse_cursor===true)d3.select("html").style("cursor","none");if(this.dl)this.dl.setLastHandleVisibility(false);var n=gmath.extend({reselect_nodes:true,move_nodes:true},i);this.active=true;this.setNodes(n.reselect_nodes?nt.process_selection(e):e);this.rubberband_dir=0;this.center=this.getCenter(this.nodes);if(this.indicator)this.indicator.move_to(this.center,true);this.interaction_handler.events.on("keydown."+this.id,this.selectNodesOneLevelUp.bind(this));this.do_not_move_nodes=!n.move_nodes;for(var r=0;r<this.nodes.length;r++){var o=this.nodes[r];o.dragging=true;o.x0=o.x;o.y0=o.y}if(this.view.model.hide_nodes()){this.view.renderer.set_style(this.nodes);this.view.update_style()}if(this.indicator)this.view.main.call(this.indicator);this.view.enter_and_exit("shadow");this.view.update_existing("shadow");this.setupActions(n.actions);return this.nodes};nt.prototype.getCenter=function(t){var e=F.getBoundingBox(t);return[e.x+e.width/2,e.y+e.height/2]};nt.prototype.setNodes=function(e){this.nodes=e;this.leaf_nodes=t.filter(function(t){return!t.has_children()},e)};nt.prototype.selectNodesOneLevelUp=function(){if(this.nodes.length===0||!t.is_range(this.nodes))return;if(this.nodes[0].parent.is_root())return;if(this.smooshing){this.cancelSmooshing()}var e=[];for(var i=0;i<this.nodes.length;i++){if(e.indexOf(this.nodes[i].parent!==-1)){e.push(this.nodes[i].parent)}}e=nt.process_selection(e);if(e.length>0&&e[0].is_group("equals"))return;if(this.nodes.some(function(t){return e.indexOf(t)!==-1}))return;this.nodes.forEach(function(t){t.dragging=false});var n={x:this.nodes[0].x-this.nodes[0].x0,y:this.nodes[0].y-this.nodes[0].y0};this.setNodes(e);if(this.view.model.hide_nodes()){this.view.renderer.set_style(this.nodes);this.view.update_style()}this.interaction_handler.highlight_nodes(this.nodes);this.view.renderer.set_position(this.nodes);for(var i=0;i<this.nodes.length;i++){var r=this.nodes[i];r.dragging=true;r.for_each(function(t){t.x+=n.x;t.y+=n.y})}this.view.enter_and_exit("shadow");this.view.update_existing("shadow");this.view.update_positions(this.leaf_nodes);this.setupActions();this.center=this.getCenter(this.nodes);if(this.indicator)this.indicator.move_to(this.center);return this.nodes};nt.prototype.update=function(e){var i=e.dx,n=e.dy,r=this;this.dy+=n;this.pushToDXQueue(i);this.pushToDYQueue(n);if(this.fingerMoved())this.stopAllTimeouts();var o=3.5*this.interaction_handler.view.options.font_size;if(!this.smooshing&&Math.abs(this.dy-this.dy0)>o&&this.dy!==0){var s=this.dy>this.dy0?1:-1;if(s!==-1*this.rubberband_dir){this.dy0=this.dy;this.rubberband_dir=s;if(this.view.options.rubber_band_selection)this.selectNodesOneLevelUp()}}if(!this.do_not_move_nodes){t.for_each(function(t){t.x+=i;t.y+=n},this.nodes);this.smooshedNodes.forEach(function(e){t.for_each(function(t){t.x+=i;t.y+=n},e)})}this.bbox.x+=i;this.bbox.y+=n;this.center[0]+=i;this.center[1]+=n;if(this.indicator)this.indicator.move_to(this.center);this.displayTargets(true);var a=this.applyShakeToShakeActions();if(a.length>0)this.performAsyncronousAction(a[0]);var l=F.getBestHit(this.actions,this.bbox);if(l&&l.settings.delay&&!l.timeoutID)this.applyTimeout(l);else if(l&&!l.settings.delay&&!l.timeoutID)this.performAction(l);else if(!l)this.stopAllTimeouts();this.view.update_positions(this.leaf_nodes);if(this.smooshing){this.view.updateSmooshed(this.smooshedNodes)}};nt.prototype.pushToDXQueue=function(t){this.dx_queue.push(t);if(this.dx_queue.length>4)this.dx_queue.shift()};nt.prototype.pushToDYQueue=function(t){this.dy_queue.push(t);if(this.dy_queue.length>4)this.dy_queue.shift()};nt.prototype.reduceDeltaQueues=function(){return{x:this.dx_queue.reduce(function(t,e){return t+e},0),y:this.dy_queue.reduce(function(t,e){return t+e},0)}};nt.prototype.fingerMoved=function(t){t=t||this.reduceDeltaQueues();return t.x*t.x+t.y*t.y>=2.25};nt.reorderInRanges=function(t){if(t.length<2)return t;var e=t[0].get_root();var i=0;e.for_each(function(t){t.order_num=i++});return t.sort(function(t,e){return t.order_num-e.order_num})};nt.getNewSelectionAfterAction=function(t,e){var i=t.new_selection?t.new_selection:t.mapNodes(e);this.reorderInRanges(i);return nt.process_each_selection(i)};nt.prototype.performAsyncronousAction=function(t){this.end();this.interaction_handler.performAction(t,false)};nt.prototype.performAction=function(e){this.stopAllTimeouts();var n={};t.for_each(function(t){n[t.id]={x:t.x,y:t.y}},this.nodes);var e=this.view.model.performAction(e);if(this.dl)this.dl.setLastHandleVisibility(false);var r=nt.getNewSelectionAfterAction(e,this.nodes);if(r.length===0){this.interaction_handler.abort_interaction();this.interaction_handler.end_of_interaction();throw"(DragHandler) Non-existant new node selection after move action.";return}var o=R.getNewSelection(r);r=o||r;if(!e.settings.is_join_action||o){e.settings.is_join_action=false;if(this.smooshing)this.cancelSmooshing()}if(e.settings.is_join_action){this.addSmooshedNodes(e);this.view.enterSmooshed(this.smooshedNodes);
this.shrinkNewSmooshedNodes();this.positionSmooshedNodesInWheel();this.view.updateSmooshed(this.smooshedNodes)}this.interaction_handler.highlight_nodes(r);for(i=0;i<this.nodes.length;i++)this.nodes[i].dragging=false;e.newTree.for_each(function(t){t.dragging=false});for(i=0;i<r.length;i++)r[i].dragging=true;this.correctNodePositions(r,this.nodes,e,n);this.view.model.hide_nodes();if(e.settings.is_join_action){t.for_each(function(t){t.smooshing=false},this.nodes);t.for_each(function(t){t.smooshing=true},r)}this.setNodes(r);if(e.settings.reset_x||e.settings.reset_y){this.resetPositionOfNodes(r,e.settings.reset_x,e.settings.reset_y)}this.updateNodePositionsAroundTarget(r,e);if(!this.smooshing){this.center=this.getCenter(this.nodes)}this.view.update_style();this.view.enter_and_exit("shadow");this.view.update_existing("shadow");this.view.update_existing("normal");this.setupActions();this.dy=0};nt.prototype.addSmooshedNodes=function(e){var i=e.nodes[0],n=e.target;var r=function(e){var i=t.clone(e,false,["id","value","name","bp","associative","commutative","vertical_notation","selected","dragging","locked","fixed","hidden","simplify","deleted","precision","color","size","width","height","x","y","x0","y0","rel_x","rel_y","lmar","rmar"]);if(i.children[0]&&i.symIsHidden())i.children[0].hidden=false;return i};this.smooshing=true;if(this.smooshedNodes.length===0){this.smooshedNodes.push(r(i))}this.smooshedNodes.push(r(n))};nt.prototype.shrinkNewSmooshedNodes=function(){if(this.smooshedNodes.length===2){this.smooshedNodes.forEach(this.shrinkSmooshedNodesGroup.bind(this))}else{this.shrinkSmooshedNodesGroup(this.smooshedNodes[this.smooshedNodes.length-1])}};nt.prototype.shrinkSmooshedNodesGroup=function(e){e.size=e.size*this.view.options.smooshed_nodes_shrink_factor;t.for_each(function(t){t.size=e.size},e);this.view.renderer.set_position([e],true)};nt.prototype.positionSmooshedNodesInWheel=function(){var t=this.smooshedNodes.length,e=this.calculatePositionOnCircleForEachGroup(t);for(var i=0;i<this.smooshedNodes.length;i++){var n=this.smooshedNodes[i];var r=this.center[0]+n.width/2+e[i][0],o=this.center[1]+n.height/2+e[i][1];var s=r-n.x,a=o-n.y;n.for_each(function(t){t.x+=s;t.y+=a})}};nt.prototype.calculatePositionOnCircleForEachGroup=function(t){var e=this.view.options.font_size;var i=360/t,n=270,r=n;var o=[n];for(var s=0;s<t-1;s++){r+=i;r=(r+360)%360;o.push(r)}var a=function(t){return t*Math.PI/180};return o.map(function(t){return[e*Math.cos(a(t)),e*Math.sin(a(t))]})};nt.prototype.cancelSmooshing=function(){this.nodes.forEach(function(t){t.for_each(function(t){t.smooshing=false})});this.smooshing=false;this.smooshedNodes=[];this.view.exitSmooshed()};nt.prototype.setupActions=function(t){var e=this.view.options.font_size*.1;if(this.smooshing){this.bbox={x:this.center[0]-e,y:this.center[1]-e,width:2*e,height:2*e}}else{this.bbox=F.getBoundingBox(this.nodes,0);this.bbox.x-=e;this.bbox.width=e*2;this.bbox.y-=e*1.5;this.bbox.height=e*3}this.actions=t||this.view.model.getMoveActions(this.nodes);this.shake_actions=this.actions.filter(function(t){return t.settings.side==="shake"});this.actions=this.actions.filter(function(t){return t.settings.side!=="shake"});if(!this.view.options.enable_drag_to_join)this.actions=this.actions.filter(function(t){return!t.settings.is_join_action});F.setTargetRegions(this.actions,this.view.options.font_size);this.displayTargets(true);if(this.indicator){this.indicator.animate(0,0);this.indicator.move_to(this.center)}};nt.prototype.correctNodePositions=function(e,i,n,r){if(n.settings.makes_no_changes&&!n.settings.update_node_positions)return;var o;t.select_first(function(i){var r=n.mapNodes(i);if(r.length!==1)return false;var s=t.select_first(function(t){return t===r[0]},e);if(s){o={old:i,new:s};return true}else return false},i);if(o){var s=r[o.old.id].x-o.new.x0,a=r[o.old.id].y-o.new.y0;t.for_each(function(t){t.x=t.x0+s;t.y=t.y0+a},e)}};nt.prototype.resetPositionOfNodes=function(t,e,i){t.forEach(function(t){t.for_each(function(t){if(e)t.x=t.x0;if(i)t.y=t.y0})})};nt.prototype.updateNodePositionsAroundTarget=function(e,i){if(i.settings.makes_no_changes)return;var n;if(i.settings.is_join_action){var o=0;for(var s=0;s<e[0].children.length;s++){o+=e[0].children[s].sel_box.width}n=this.center[0]+o/2-e[0].x0}else{n=e[0].x-e[0].x0}var a=i.newTree.filter(function(t){return!t.dragging});a=a.filter(function(t){var e=t.parent;if(e){while(!r.is_top_most(e)){if(e.dragging)return false;e=e.parent}}return true});a.forEach(function(t){t.x+=n;t.x0+=n});var l=i.newTree.filter(function(t){return t.dragging});if(!i.settings.is_join_action){t.for_each(function(t){t.x0+=n},l)}else if(!r.is_top_most(l[0])){t.for_each(function(t){t.x+=n;t.x0+=n},l)}};nt.prototype.displayTargets=function(t){if(!nt.show_target_areas)return;if(t)F.draw(this.view.main,this.actions,this.bbox);else F.draw(this.view.main)};nt.prototype.end=function(){d3.select("html").style("cursor",null);if(this.indicator)this.indicator.remove();if(this.on_release_action)this.performAction(this.on_release_action);this.interaction_handler.events.on("keydown",null);if(this.dl)this.dl.setLastHandleVisibility(true);this.stopAllTimeouts();t.for_each(function(t){t.selected=false;t.dragging=false},this.view.model.children);this.view.enter_and_exit("shadow");this.view.update_existing("shadow");this.cancelSmooshing();this.view.model.hide_nodes();this.setNodes([]);this.actions=[];this.bbox=null;this.view.update_all();this.displayTargets(false);this.active=false;this.dy=0;this.dy0=0};nt.prototype.applyTimeout=function(t){if(this.indicator)this.indicator.animate(1,t.settings.delay);t.timeoutID=setTimeout(function(){if(t.settings.on_release){this.on_release_action=t;if(this.indicator)this.indicator.fill()}else this.performAction(t)}.bind(this),t.settings.delay)};nt.prototype.stopAllTimeouts=function(){if(this.indicator)this.indicator.animate(0,0);this.on_release_action=null;for(var t=0;t<this.actions.length;t++){var e=this.actions[t];if(e.timeoutID)this.clearActionTimeout(e)}};nt.prototype.clearActionTimeout=function(t){clearTimeout(t.timeoutID);delete t.timeoutID;delete t.dx;delete t.dy};nt.prototype.applyShakeToShakeActions=function(){var t=this.reduceDeltaQueues();if(!this.fingerMoved(t))return[];if(Math.abs(t.x)>Math.abs(t.y))return this.penalizeNonShake(this.shake_actions);return this.incrementShake(this.shake_actions,t)};nt.prototype.incrementShake=function(t,e){var i=[];var n=e.y<0?"up":"down";t.forEach(function(t){if(!t.settings.shakes)t.settings.shakes=0;if(!t.settings.current_direction){t.settings.current_direction="up";t.settings.distance=0}if(n===t.settings.current_direction){t.settings.distance+=e.y;if(Math.abs(t.settings.distance)>200){t.settings.shakes++;t.settings.current_direction=n==="up"?"down":"up";t.settings.distance=0}}else if(n!==t.settings.current_direction){t.settings.distance=0}if(t.settings.shakes>=4)i.push(t);t.settings.non_shakes=0},this);return i};nt.prototype.penalizeNonShake=function(t){t.forEach(function(t){if(!t.settings.non_shakes)t.settings.non_shakes=0;if(++t.settings.non_shakes>2){t.settings.shakes=0;t.settings.current_direction="up";t.settings.distance=0}},this);return[]};nt.process_each_selection=function(t){if(t.length===0)return[];var e=r.groupNodeRanges(t);var i=[];e.map(function(t){return nt.process_selection(t)}).forEach(function(t){i=gmath.array.mergedNew(i,t)});return i};nt.process_selection=function(t){var e=t.slice();if(e.length===0)return[];if(nt.special_selection(e))return nt.special_selection(e);if(e[0].commutative){var i=e[0].parent;if(e.length<i.children.length)return e;else e=[i]}var n=e[0];while(!r.is_top_most(n)&&!n.parent.is_group("equals","gte","lte","gt","lt")&&!n.commutative&&!n.is_group("exponent","degree")&&!n.parent.is_group("param")&&!(n.parent.is_group("radical")&&n.parent.get_radicand()===n)&&!(n.is_group()&&n.get_idx()===1&&n.parent.is_group("brackets")&&!c.areHidden(n.parent)))n=n.parent;if(n.get_idx()===1&&n.parent&&(n.parent.is_group("equals")||E.is_inequality(n.parent)))n=n.parent;return[n]};nt.special_selection=function(t){if(t.length!==1)return false;var e=t[0];if(!e.fixed&&e.parent.is_leaf_node&&e.get_idx()===1)return t;if(e.to_ascii()==="-")return t;if(e.to_ascii()==="|"&&e.get_idx()===0)return t;if(a.is_num(e)&&e.parent.is_group("sign"))e=e.parent;if(a.is_equal_to(e,-1)&&e.parent.is_group("brackets")&&e.get_parent(2).is_group("power")&&b.is_square_root(e.get_parent(2).children[1]))return[e];return false};nt.Indicator=function(t){var e=0,i=0,n=12,r=true,o="#FFA500",s=d3.svg.arc().innerRadius(n-2.5).outerRadius(n).startAngle(0),a=2*Math.PI,l,h,p;core=function(a){l=a.insert("g","*").attr("transform","translate("+[e,i]+")").style("display",r?null:"none");if(t===0){l.append("image").attr("xlink:href","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAAAXNSR0IArs4c6QAACx9JREFUaAXF2k+SHUcRBvB680eaERjCAV6w8MYLrmFxAlZwBPsYFsdgwwHwCi5g6QTes9DGC4iQHY6wzPyRZvTIX32dr59GljRGDqiInq6uysr6MvPLqup+M8ZPWLZ/HYfbbV1/HsfbL8bR7q7+oC59JfMTTjk276oMqPGw9Dwep+PXi7av6/7e2I6n1d53ffvtH43zcX9sN5tx/S4Y/isDphe/HQfj/XF3Tn63gF6Ok/H9AuXndb8og06W5+sy5rBaLkrupOruvywDLquufFu1T8Z1GfNiGXHr2482ADXGk4LBu8cTJEABe1Hz3llgX1adeX0HSX1T0scF/HnVmMmgp3UXoV+M883vxlXVbl1ubcAE3jRpbx8VcGVbMIAF6rBq19M4z2s5nv2eY0Abo+WqoiFqd6tPVD4YF7c15FYG7Lw+FsDXBfhq3Fs8eVr3UcHfFuzTCV79oJ76fljPjCGnbAuw/rSdT8OPxtkezc7QavPpSy7I2Bt/j248v/Jo9ZgJii6jgOM1Jqs36O0C3p0Z3HJQ/Qd1l6KYflzeRQ4zXpeuTRmRDKiGKitxjN6W3KYct31bJN4YgR1tgD+uAPOw0B9MAKflMYBPptcP531UGwNFYi3aSKKP9sjEINEQmavqe1F1VDyo+qi63KjV6k1GvDYCE/x3E2i8fVV1XudVAA/mVBxwsgMdd6BXQL4oScBBV4/h1qB4PLFa63SjlbWIzHH9fTK2heW1OZEpS3a/2ICWJZInT0rNaSkFDHBA+CkJzAD1eJZsdIId0OvdJPolrSi8KA+LgDqPiwL9R1W/rMuKRdY691VF4kE93SivRGChzUkNiceBB/KoLlSKihh1VW2hA04rFsUubWA/n+8MIusii3qAqjPOnfFcpHCP8mE1f/EqnV4xYCZsJ2nW9JPxrNSEQlRJXpGIEYCIUiDdnSDJoINLUgcqGdy2QqWlDeGUFQljAjvOEpFt7eijsClP59/lzzqsGhbeZ8MhgItWGoWk1SPgTOA6rV79MagqixcDIFyOCelpY+g5n9LGd6s7uetJnzz1/DKnNjsY95M6QjWqzjQH4+/jZ+ObAmZfbd6HQoCuoBOFezWMp0G4N/t5Vq4oqa9RQA4GiUKIYsuyH2i3tjFIDpyVASKV/ECvrq/58O/Kh6ltjcCfamjxbIYKRXjVHXA83adNG4NG1Lh32I3rEuMZGI5rx/MYYzGIUb3pZVzvJKiTgkp35gxZZj+qkeHHTkSSSMTQIms9nia8WQ5jRLweysSjoVXTCWjjGLwC5Qzejk5mdD1rfqIGbtPpsOR7fvtEjh6nuwPjkgvTxnkk/rzEFQG7O0HEGJ5tWkyB3RQ8D2yWWIapK4wAnvm8nEIPisSYyIHrCpW0WY7FKCygJZFwALTM1g5dxmxhdhRPkB5WY87uJj6dm4lpO0Oy1HUeZA9oSjEwVMpYIEKn9l8bomcJfN2bBIlSnjNjZjVKFGhT0MyqqP1ptcNcJQbYcd+rTuf2HMCoCiDgcTBqeTT5EaowJpFKHmT1VlfIKJJ1v/Bwl5i3/yYQ2d5fnGwZy/s0ioj96Lup4OnRfDnxpmTbJgACD1Kslgl6mQzAtCVGoU2MSA7xcvKivZwIARBPt+70o1VyTX8iq7adqxFZRthIn5UjoLyqtsIM+8H4QzV47QOZx5rvq5fiRYmcZNbTdIqnJbOLhqZU50dkm17GxYs9JpGjJwg6Z8yiL8cMuZHo0+fdAebCfjS55Jz5TTVazUXhWf2V+ZQCnWKnSEKTwklFW5ZcALJ/5CAALLjkEs1eNj3zfgqvNoXiEMsu4BI6L01OqnTBtZ0r0a/q6eHYHI1/VEUmvFeWYR/FwAMTj2dguJ/+6p4eD2V4lNnxfnIiHtWfvpW/5LwLZAmmT9RtbjGUFrS0mTHCU/ah7CXe+hj1dfV/afg/S0AJQ2d1hiu1HIsTxshRqIQamc4zg9cCTCJDrvcI/cY3zznLsyjGDSRWJ6k3dftI0Xfv0B8TrT+zmC4palBAdhiFEmSlOZyJ18mAaVqsRmZERmV8y5FpXft61ckrwKNdroyHEVYHkWLPwXhEsool1G6HPvgNdIBXZZbe9uM1MetE1G2n9Wya0MFOmrN8zjJABTRZ4HndlfeC1P2loYHXwyycmndr2PLN6bdjezQjYE29LEB2YG9Ejq8mzbtrLPe8qTQHsj2d48FKHUBeLvvc1tcHuEhFF5l+DnA7c8yLM+wBHKsthuUzzKPeyKilBmzgGEGpnTB8TUizIalL8DYkkViNqo4qDco9fifHCDqt/ZYMiRmJjEhfdcxCZ5I58/frpqyyd30mAvXOuRwjGGECO128GoPOqi0vKivI1dOdkG3QevKMD7UrjsW50C0XfYlijGv9kQ94xiv2gbAgc9sHPq8IbP44rrd/qy78BztnwPNJn3qsYQbmLIiH64rRa3e2/nVyE/IrTTTSYFLtPEyfw5s2VEl86mGOyjtCcgddlLjC2MTLJ8zaBza/78Pcv0rZ+9XpPViWW2tNmnWYipcpA0KvEKZvGmh35Vk9a3dMQjmgQQ74UAqdyDXo6I6mkNtLvgIbR/ncUp8hNeUw90nB+Usp5jU+y+kz0Eg1kKYDJa6GvhpDlgkpK63iZ4DVHIg7H9BCJPqeuUSGUYkA+liBnlWbtzJ7wP30TQOcq+tgFOH4KJRJ6AxWkhfxTGSbWm0Mz9p9Te5Mpb2NDm3oCbBEQ92MHNJg4wRJTo9xVqHndXHN8j7Qn+UTAQrqg2odUQ1JEodvaxSOqidT+GvttqQla9rTMU6vmuTPQRDo1Zi8mfVKBFTqZgY4oHsPii4GOimL1PnEWhVlNeB+qfFW5qhKyZ3Zb9MAtEH13bQusvEYI9AjiT6b6+lykVrl2uPt3UiGUvIgLzH2oBjkm2p/5NKSz/LRV2N3BvhxoT5ZXMwllV/tdiAKLWBX82mFHc+ln0RMUkMfx+dkiLtRoVJ7v5pKjoGhTjzfEQA+e84K/mTx/ofzM2PHZzWARt9bdrlwuEwqAsx09VtR+76NmIPnBCiTozJTmteRZwqgjLYkKow1ovke+jAYZZhu5XG8X7xfy34+d1WTsotAHuuvXHhSdwOcvSkzJDVnfDz0+TttdSsJdRK9BOJ8jNG77/0pVDo4KLpIZHXJrGlv6kj2Pe9n+Pr3FQNmFFDpcanNad4EAeeviLinfl6GMCrA5UrMSWJ6ShSykgl89pZeEEQiNLJIPJ/OiUGSlWHf113kruoHjxvep57vfrDMz4yPC5yXfauJHYJXrcd9xk8w89q3npm8oKz0od2zCGU57t1YlJhu10dTQFMXCXWet2kVdV/3a81rDTDvS5/Z+7VRh7oPvuFp9gdGNeezc8frgDMgnp+752LgWbWaP21J4NSB96um38y+/OHP6hNF/XmjAYS2D8o3/dXON1Pc7WhMgWrrV1DPvRP3p/emzQo00QhgVIzXHeruTOB68P7sNj/2vdWAidFPq+jke4y8cGbi8az5+ZEv7xGJhkFogW5932/r833G4z6jQhlyb6ENkS63MoDwXk7gbXbY/n04EbHaWEKTJ4AroqO9n3na0qg42zBZojoi8LovhF+9mTZz7PLn1gb0oJcMuag3tI5IC4hM/5Dt7lSlyBeFp5XI+MU5P3Rre8sPekRulh9tAAWVFwfjN0UQX8u8WPS/Gtg7chSxw6yGhFjn83uOj1I5z1/s/nfif/mvBjc9MD9N9v9NCH8XR17Fq99+0a6tvD3u/5/+2WMfz359GvNBGfGoWj+uq+8+nvn+9Fld9RroLXB/3LvU/wNK5Dx9330BewAAAABJRU5ErkJggg==").attr({width:24,height:24,x:-12,y:-12});h=l.append("path").style({fill:o,stroke:"none",opacity:1}).datum({endAngle:0}).attr("d",s)}else if(t===1){p=l.append("circle").attr("r",n).style({stroke:"none",fill:"orange",opacity:.4});h=l.append("path").style({fill:"red",stroke:"none",opacity:.5}).datum({endAngle:0}).attr("d",s)}else if(t===2){l.append("circle").attr("r",n).style({stroke:"none",fill:"orange",opacity:.4});h=l.append("circle").attr("r",0).style({stroke:"none",fill:"red",opacity:.5})}};core.remove=function(){l.remove()};var u=function(t){return function(e){var i=d3.interpolate(e.endAngle,t);return function(t){e.endAngle=i(t);return s(e)}}};core.visible=function(t){if(arguments.length===0)return r;r=t;if(l)l.style("display",r?null:"none")};core.move_to=function(t,n){e=t[0];i=t[1];if(!l)return;if(n)l.attr("transform","translate("+[e,i]+")");else l.transition().duration(300).ease("circle-out").attr("transform","translate("+[e,i]+")")};core.animate=function(e,i){var r=h.transition().delay(i*.1).duration(i*.9);if(t!==2)r.ease("linear").attrTween("d",u(e*a));else r.ease("quad-out").style("r",e*n);if(p)p.style("fill","orange");h.style("fill","red")};core.fill=function(){h.transition().style("fill","green");if(p)p.transition().style("fill","green")};return core};gmath.DragHandler=nt;var rt=function(t,e){this.type="InterDerivationHandler";this.interaction_handler=e;this.derivation=t.options.derivation_list;this.view=t;this.line={A:{},B:{}};this.line_el=null;this.bbox=null;this.targets=[];this.eq_target_area_style={fill:"#FFF","fill-opacity":.5,stroke:"steelblue","stroke-width":1,"stroke-dasharray":"5,5",rx:"12",ry:"12"};this.eq_target_area_style_active={fill:"#BBB"}};rt.prototype.check=function(t,e){if(!gmath.options.actions.substitution_on)return false;return t.fingers.length===1&&e.children&&e.children[0].is_group("equals")};rt.prototype.start=function(t){this.targets=this.collectTargets();this.targets.forEach(function(t){this.initTargetVisualization(t)},this);this.initializeControlLine(t);return[]};rt.prototype.update=function(t){this.updateControlLine(t);this.updateLineElement(this.line_el,this.line);this.targets.forEach(function(t){this.handleEndpointHits(t,this.targets)},this);return this.targets.some(function(t){return t.hit_substitution_actions.length>0||t.ce_action_pending})};rt.prototype.end=function(){for(var t=0;t<this.targets.length;t++){var e=this.targets[t];if(e.ce_action_pending){this.triggerEquationCombination(e);break}else if(e.hit_substitution_actions.length>0){this.performSubstitution(e)}}this.eraseInfoAndCleanBoard()};rt.prototype.collectTargets=function(){var t=this.derivation.getAllDLs().slice();gmath.array.remove(t,this.derivation);return t.map(function(t){var e=this.getAllAvailableActions(t);return{derivation:t,view:t.getLastView(),substitution_actions:e.filter(function(t){return t.name==="SubstitutionAction"}),hit_substitution_actions:[],lines:[],combine_equations_action:e.filter(function(t){return t.name==="EquationCombineAction"}),ce_action_pending:false}},this)};rt.prototype.getAllAvailableActions=function(t){var e=t.getLastModel();var i=gmath.actions.SubstitutionAction.getAllAvailableActions(this.view.model,e).concat(gmath.actions.EquationCombineAction.getAllAvailableActions(this.view.model,e.children[0]));var n=this.derivation.getRowByView(this.view),r=this.derivation.pos.x-this.derivation.dims.x+n.pos[0],o=this.derivation.pos.y-this.derivation.dims.y+n.pos[1];i.forEach(function(e){var i=t.getLastRow();if(this.derivation.coordinator&&t.coordinator){var n=this.derivation.coordinator.getOffset(this.derivation,t);e.settings.offset={x:t.pos.x-t.dims.x+i.pos[0]-r+n[0],y:t.pos.y-t.dims.y+i.pos[1]-o+n[1]}}else{e.settings.offset={x:t.pos.x-t.dims.x+i.pos[0]-r,y:t.pos.y-t.dims.y+i.pos[1]-o}}},this);F.setTargetRegions(i,this.view.options.font_size);return i};rt.prototype.initTargetVisualization=function(t){this.highlightSubstitutionTargetNodes(t,true);this.displayCombineEquationTargetArea(t,true)};rt.prototype.highlightSubstitutionTargetNodes=function(t,e){if(e){var i=t.substitution_actions.reduce(function(t,e){return t.concat(e.target)},[]);t.view.interaction_handler.highlight_nodes(i)}else{t.view.interaction_handler.highlight_nodes([])}};rt.prototype.displayCombineEquationTargetArea=function(t,e){if(e&&t.combine_equations_action.length>0)this.drawCombineEquationTargetArea(t.view.main,t.combine_equations_action[0]);else this.drawCombineEquationTargetArea(t.view.main,false)};rt.prototype.drawCombineEquationTargetArea=function(t,e){var i=t.selectAll(".combine_equation_target_area").data(e?[e]:[]);i.enter().append("rect").classed("combine_equation_target_area",true).style(this.eq_target_area_style);i.attr("x",function(t){return t.x-t.settings.offset.x}).attr("y",function(t){return t.y-t.settings.offset.y}).attr("width",function(t){return t.width}).attr("height",function(t){return t.height});i.exit().remove()};rt.prototype.displayCombineEquationTargetAreaHit=function(t,e){var i=t.view.main.selectAll(".combine_equation_target_area").transition().style(e?this.eq_target_area_style_active:this.eq_target_area_style)};rt.prototype.initializeControlLine=function(t){this.line_el=this.makeLineElement();var e=this.derivation.getRowByView(this.view).getHandlePos();this.line.A.x=e[0];this.line.A.y=e[1];this.line.B.x=t[0];this.line.B.y=t[1];this.bbox={x:this.line.B.x-2,y:this.line.B.y-2,width:4,height:4}};rt.prototype.makeLineElement=function(){var t=this.view.main.append("line").classed("substitution",true).style("stroke","#ddd").style("stroke-width",2).style("stroke-linecap","round");return t};rt.prototype.updateControlLine=function(t){this.line.B.x+=t.dx;this.line.B.y+=t.dy;this.bbox={x:this.line.B.x-2,y:this.line.B.y-2,width:4,height:4}};rt.prototype.updateLineElement=function(t,e){t.attr("x1",e.A.x).attr("y1",e.A.y).attr("x2",e.B.x).attr("y2",e.B.y)};rt.prototype.handleEndpointHits=function(t,e){var i=F.getBestHit(t.substitution_actions,this.bbox);if(i){gmath.array.remove(t.substitution_actions,i);t.hit_substitution_actions.push(i);this.highlightSubstitutionTargetNodes(t,true);this.drawLine(i,t)}else{i=F.getBestHit(t.combine_equations_action,this.bbox);if(i&&!t.ce_action_pending){t.ce_action_pending=true;this.displayCombineEquationTargetAreaHit(t,true);e.forEach(function(t){this.highlightSubstitutionTargetNodes(t,false);this.hideLines(t,true)},this)}else if(!i&&t.ce_action_pending){t.ce_action_pending=false;this.displayCombineEquationTargetAreaHit(t,false);e.forEach(function(t){this.highlightSubstitutionTargetNodes(t,true);this.hideLines(t,false)},this)}}};rt.prototype.drawLine=function(t,e){var i={A:{x:this.line.A.x,y:this.line.A.y},B:{x:t.x+t.width/2,y:t.y+t.height/2}};var n=this.makeLineElement();this.updateLineElement(n,i);e.lines.push(n)};rt.prototype.hideLines=function(t,e){t.lines.forEach(function(t){t.transition().style("opacity",e?.001:1)},this)};rt.prototype.performSubstitution=function(t){var e=this.concatenateActionTargetsIntoOneAction(t.hit_substitution_actions);t.view.model.startInteraction();t.view.model.performAction(e);t.view.model.finishInteraction()};rt.prototype.concatenateActionTargetsIntoOneAction=function(t){t[0].target=t.reduce(function(t,e){return t.concat(e.target)},[]);return t[0]};rt.prototype.triggerEquationCombination=function(t){this.displayEquationIdentities(t,true);t.view.model.startInteraction();t.view.interaction_handler.performAction(t.combine_equations_action[0],false,function(){this.displayEquationIdentities(t,false)}.bind(this))};rt.prototype.displayEquationIdentities=function(t,e){if(e){this.drawEquationIdentity(this.view.main,"E₂");this.drawEquationIdentity(t.view.main,"E₁")}else{this.view.main.select("#combine_equation_identifier").remove();t.view.main.select("#combine_equation_identifier").remove()}};rt.prototype.drawEquationIdentity=function(t,e){var i=t.selectAll("g.math").filter(function(t){return!t.hidden}).datum();if(i){var n="translate("+(i.x0-15)+","+(-i.y0-15)+")";var r=t.append("g").attr("id","combine_equation_identifier").attr("transform",n);r.append("circle").attr({cx:0,cy:0,r:20}).style({fill:"none","stroke-opacity":.66,stroke:"steelblue","stroke-width":1.5});r.append("text").attr({stroke:"none",fill:"steelblue","fill-opacity":.66,"text-anchor":"middle","alignment-baseline":"central","font-size":24}).text(e)}};rt.prototype.eraseInfoAndCleanBoard=function(){this.targets.forEach(function(t){t.lines.forEach(function(t){t.remove()});this.highlightSubstitutionTargetNodes(t,false);this.displayCombineEquationTargetArea(t,false)},this);this.line_el.remove();this.targets=[]};var ot=function(t,e){this.interaction_handler=e;this.view=t;this.model=t.model;this.node=null;this.line=null;this.value=null;this.hitbox={};this.dl=t.options.derivation_list;this.dls=null;this.target=null};ot.prototype.check=function(t){var e=t.pos0[1]-t.pos[1];return Math.abs(e)>=10};ot.prototype.start=function(t,e){this.node=this.process_selection(e);this.line=d3.select("svg").append("line").attr("stroke","blue");if(!this.node)return[];this.node.dragging=true;this.value=this.view.model.numeric_value(this.node);this.hitbox={x:this.node.x0+this.node.get_root().options.pos[0]-5,y:this.node.y0+this.node.get_root().options.pos[1]-5,width:10,height:10};this.dls=this.dl.getAllDLs().slice();this.target=null;return[this.node]};ot.prototype.update=function(t){this.hitbox.x+=t.dx;this.hitbox.y+=t.dy;var e=[],i=this;this.dls.forEach(function(t){if(t.id===this.dl.id){var i=t.getLastModel(),n=i.filter(function(t){return!t.has_children()});n.forEach(function(i){var n=F.getBoundingBox([i]);if(n.x&&n.y){n.x+=t.pos[0];n.y+=t.pos[1];n.target=i;e.push(n)}})}});F.draw(d3.select("svg"),e,this.hitbox);this.target=F.getBestHit(e,this.hitbox);this.line.attr({x1:this.node.x0+this.node.get_root().options.pos[0]-this.node.width/4,y1:this.node.y0+this.node.get_root().options.pos[1]-this.node.height/4,x2:this.hitbox.x+5,y2:this.hitbox.y+5})};ot.prototype.end=function(){if(this.target){this.target.target.get_root().numeric_value(this.target.target,this.node.get_root().numeric_value(this.node));this.interaction_handler.events.link(this.node,this.target.target)}this.line.remove();F.draw(d3.select("svg"));this.node=null};ot.prototype.process_selection=function(t){var e=function(t){return t.is_group("sign")||t.is_group("add")||t.is_group("sub")};if(t.length===0||t.length>2)return null;if(t.length===2){var i=t[1];if(i instanceof a&&e(i))return i.parent;return null}var n=t[0];if(n instanceof a){if(e(n.parent))return n.parent;else return n}else if(e(n))return n;return null};DLCoordinator=function(){this.dls=[]};DLCoordinator.prototype.addDL=function(t){this.dls.push(t);if(t.coordinator)coordinator.removeElement(t);t.coordinator=this};DLCoordinator.prototype.removeDL=function(t){var e=this.dls.indexOf(t);if(e===-1)throw"I don't know about this DL, so I can't remove it.";this.dls.splice(e,1)};DLCoordinator.prototype.subscribeToCanvasModel=function(t){var e=this;var i=t.dls();var n=null;for(var r=0;r<i.length;r++){e.addDL(i[r])}t.on("create",function(t){if(t.target_type==="derivation")e.addDL(t.target)});t.on("remove",function(t){if(t.target_type==="derivation")e.removeElement(t.target)})};DLCoordinator.prototype.getPositionOnPage=function(t){var e,i;if(t.options.standalone==true){e=t.container().getBoundingClientRect().left;i=t.container().getBoundingClientRect().top}else{e=t.svg.node().viewportElement.getBoundingClientRect().left;i=t.svg.node().viewportElement.getBoundingClientRect().top}return[e,i]};DLCoordinator.prototype.getOffset=function(t,e){var i=this;var n=i.getPositionOnPage(t);var r=i.getPositionOnPage(e);return[r[0]-n[0],r[1]-n[1]]};var st=function(t,e,i){this.id=gmath.uid();this.model=t;this.events=d3.dispatch("updated");this.model.events.on("change."+this.id,this.onChange.bind(this));this.model.events.on("end-of-interaction."+this.id,this.onEOI.bind(this));var n=this;this.model.events.on("scrubbability-changed."+this.id,function(){n.update_existing("normal",true)});this.svg=e;this.main=null;this.initializeOptions(i);this.mode=this.options.mode;this.is_animating=0;this.afterAnimationCallbacks=[]};gmath.AlgebraView=st;gmath.preloadFonts=function(t){if(!gmath.AlgebraView.fontloader)gmath.AlgebraView.fontloader=new P(t);else gmath.AlgebraView.fontloader.add_fonts(t)};st.prototype.bindToModel=function(t,e){if(this.model){this.model.events.on("change."+this.id,null);this.model.events.on("scrubbability-changed."+this.id,null);this.model.events.on("end-of-interaction."+this.id,null)}this.model=t;this.model.events.on("change."+this.id,this.onChange.bind(this));this.model.events.on("end-of-interaction."+this.id,this.onEOI.bind(this));if(e&&this.main){var i=[];this.main.selectAll("g.math").each(function(t){var n=e[t.id];if(!t.deleted&&n&&n.length===1&&!n[0].has_children()&&i.indexOf(n[0])===-1){d3.select(this).datum(n[0]);i.push(n[0])}});i=[];this.main.selectAll("g.math_shadow").each(function(t){var n=e[t.id];if(!t.deleted&&n&&n.length===1&&!n[0].has_children()&&i.indexOf(n[0])===-1){d3.select(this).datum(n[0]);i.push(n[0])}})}var n=this;this.model.events.on("scrubbability-changed."+this.id,function(){n.update_existing("normal",true)})};st.fontPresets={Kalam:{normal_font:{family:"Kalam"},italic_font:{family:"Kalam"},font_baseline_shift:.4,font_ascent:.9,font_descent:.2,font_radical_real_to_h:1.48,slanted_div_bar:true,div_bar_height:1/16},"Crimson Text":{normal_font:{family:"Crimson Text"},italic_font:{family:"Crimson Text Italics"},font_baseline_shift:.24,font_ascent:.73,font_descent:.18,slanted_div_bar:false,div_bar_height:1/16}};st.defaultOptions={font_size:80,auto_update:true,color:"#333",selection_color:"#4682b4",inverse_selection_color:"#957946",show_drag_indicator:true,inactive_color:"#676965",hold_area_feedback:true,fraction_size_factor:.7,exp_size_factor:.7,subscript_size_factor:.5,smooshed_nodes_shrink_factor:.5,debug_lines:false,debug_draw:false,dur:300,dur_dragging:300,easing_fn:"cubic-in-out",pos:[0,0],mode:"transform",modes:["edit","inspect"],v_align:"alphabetic",h_align:"center",background_color:"none",bg_visible:false,shadow_filter:null,border_color:"none",shadow_color:"none",border_radius:0,padding:{left:0,right:0,top:0,bottom:0},interactive:true,event_receiver:null,font_preset:"Kalam",wiggle_dur:200,wiggle_deg:10,wiggle_random_delay:100,show_node_targets:true,shadow_node_stroke:"#888",shadow_node_stroke_width:.75,shadow_node_fill:"white",enable_drag_to_join:true,visualize_scrubbable_nodes:true,rubber_band_selection:true,hide_mouse_cursor:true,hold_time:1500,replace_value_on:true,fixed:false};st.prototype.setMode=function(t){if(!t)return this.mode;if(this.options.modes.every(function(e){return e!==t}))return false;this.mode=t;return true};st.prototype.onChange=function(t){if(t.old_model!==t.new_model){this.bindToModel(t.new_model,t.node_map);if(this.options.auto_update)this.update_all(true)}else{if(this.options.auto_update)this.update_all(t.no_anim)}if(t.no_anim)this.onEOI()};st.prototype.onEOI=function(t){this.main.selectAll("g.math").filter(function(t){return t.deleted}).remove();this.main.selectAll("g.math_shadow").filter(function(t){return t.shadow_deleted}).remove()};st.prototype.callAfterAnimation=function(t){if(!this.is_animating)t();else this.afterAnimationCallbacks.push(t)};st.prototype.animationFinished=function(){this.is_animating=Math.max(0,this.is_animating-1);if(this.is_animating>0)return;this.afterAnimationCallbacks.forEach(function(t){t()});this.afterAnimationCallbacks=[]};st.prototype.initializeOptions=function(t){t=t||{};var e=t.font_preset||st.defaultOptions.font_preset,i=e?st.fontPresets[e]:{};var n=gmath.object.merged(i,st.defaultOptions);n.pos=n.pos.slice();n.padding=gmath.extend({},n.padding);n.normal_font=gmath.extend({},n.normal_font);n.italic_font=gmath.extend({},n.italic_font);this.options=gmath.extend(n,t);if(t.padding){var r=t.padding;if(typeof r==="number"){this.options.padding={left:r,right:r,top:r,bottom:r}}else gmath.extend(this.options.padding,r)}};st.prototype.init=function(t){this.main=this.svg.append("g").attr("id",this.options.id).attr("class","main").attr("transform","translate("+this.options.pos+")");this.shadow_rect=this.main.append("rect").attr({rx:this.options.border_radius,ry:this.options.border_radius}).style("fill","none").attr("filter",this.options.shadow_filter).style("stroke",this.options.shadow_color).style("visibility",this.options.shadow_filter?"visible":"hidden");this.border_rect=this.main.append("rect").attr({rx:this.options.border_radius,ry:this.options.border_radius}).style("fill",this.options.background_color).style("stroke",this.options.border_color).style("visibility",this.options.bg_visible?"visible":"hidden");if(this.options.event_receiver){this.event_receiver=d3.select(this.options.event_receiver)}else{this.event_receiver=this.main;this.event_receiver.style("pointer-events","all")}if(this.options.debug_lines){this.main.append("line").attr("x1",-1e3).attr("x2",1e3).attr("stroke-width","0.5").attr("stroke","lightblue");this.main.append("line").attr("y1",-1e3).attr("y2",1e3).attr("stroke-width","0.5").attr("stroke","lightblue")}this.renderer=new lt(this,this.options.h_align,this.options.v_align);if(!this.options.fixed){this.interaction_handler=new j(this,this.options.interactive);this.main.classed("interactive",this.options.interactive);this.interaction_handler.setMode(this.mode)}var e=[this.options.normal_font,this.options.italic_font];if(!st.fontloader){st.fontloader=P(e,2e3);this.fontloader=st.fontloader}else{this.fontloader=st.fontloader;this.fontloader.add_fonts(e)}var i=this;this.fontloader.on_fonts_loaded(function(){i.update_all(true);if(t)t()})};st.prototype.interactive=function(t){if(arguments.length===0)return!this.options.fixed&&this.options.interactive;this.options.interactive=t;if(!this.options.fixed){this.interaction_handler.set_interactive(t);this.main.classed("interactive",this.options.interactive)}return this};st.prototype.wiggle=function(t,e){if(!Array.isArray(t))t=[t];var i=[];for(var n=0;n<t.length;n++){var r=t[n].split(":");var o=r.length===1?this.model.getRanges(r[0]):this.model.getRanges(r[0],Number(r[1])-1);if(o)i=i.concat(o)}var s=gmath.array.flatten(i);if(s.length===0)return;this.wiggleNodes(s,e);if(!this.options.fixed){this.interaction_handler.events.on("touch."+this.id,this.wiggleNodes.bind(this,null,false))}};st.prototype.wiggleNodes=function(t,e){if(arguments.length<2)e=true;if(!t)t=this.model.children;if(!Array.isArray(t))t=[t];var i=[];t.forEach(function(t){if(t.has_children())i=i.concat(t.get_leaf_nodes());else i.push(t)});var n=this.node_sel.filter(function(t){return i.indexOf(t)!==-1}).select("g.offset");var r=this.options;var o=function(t,e,i){var n=d3.interpolate(t,e);return function(t){var e=st.getCenter(t);return function(t){return"rotate("+n(t)+" "+e+")"}}};function s(t){d3.select(this).transition().duration(r.wiggle_dur).attrTween("transform",o(r.wiggle_deg,-r.wiggle_deg)).transition().duration(r.wiggle_dur).attrTween("transform",o(-r.wiggle_deg,r.wiggle_deg)).each("end",s)}if(e){n.transition().delay(function(){return Math.random()*r.wiggle_random_delay}).duration(r.wiggle_dur/2).attrTween("transform",o(0,r.wiggle_deg)).each("end",s)}else{n.interrupt().transition().attr("transform",null)}};st.getCenter=function(t){var e=t.sel_box;return[e.x+e.width/2,-t.size*.24];
};st.prototype.reposition=function(t){var e=this;e.renderer.set_position(e.model.children,true);e.update_existing()};st.prototype.getSmooshedNodesSelection=function(e){var i=this.main.selectAll("g.math_smooshed").data(t.get_leaf_nodes(e),function(t){return t.id});return i};st.prototype.enterSmooshed=function(t){var e=this;var i=this.getSmooshedNodesSelection(t);var n=i.enter().insert("g","g").classed("math_smooshed",true).attr("transform",function(t){return"translate("+t.x+","+t.y+")"}).style("opacity",.6);n.append("g").classed("offset",true);n.select("g.offset").append("rect").style("visibility",this.options.debug_draw?"visible":"hidden").style("stroke","black").style("fill","none").classed("selector",true);var r=n.filter(function(t){return t.value==="//"}).select("g.offset");var o=r.append("line").style("stroke-linecap","round").call(at,this.options.slanted_div_bar,"normal").attr("x2",function(t){return t.width*e.options.smooshed_nodes_shrink_factor+"px"}).style("stroke",function(t){return e.options.selection_color}).style("opacity",function(t){return 1});n.select("g.offset").append("text").style("font-family",function(t){return e.get_font(t).family}).style("font-weight",function(t){return e.get_font(t).weight}).style("font-style",function(t){return e.get_font(t).style}).style("font-size",function(t){return t.size+"px"}).style("fill",function(t){return e.options.selection_color}).style("opacity",function(t){return t.hidden?1e-5:1}).text(function(t){return t.to_string()});n.select("text").transition().duration(this.options.dur).ease(this.options.easing_fn).style("font-size",function(t){return t.size*e.options.smooshed_nodes_shrink_factor+"px"})};st.prototype.updateSmooshed=function(t){var e=this;var i=this.getSmooshedNodesSelection(t);i.transition().duration(this.options.dur_dragging).ease("circle-out").attr("transform",function(t){return"translate("+t.x+","+t.y+")"})};st.prototype.exitSmooshed=function(){this.main.selectAll("g.math_smooshed").remove()};st.prototype.update_all=function(t){var e=this.options.dur;if(t)this.options.dur=0;this.renderer.set_style(this.model.children);this.renderer.set_position(this.model.children,true);this.enter_and_exit("normal");this.update_existing("normal");this.events.updated({type:"updated",source:this,sender_id:this.id});this.is_animating++;setTimeout(this.animationFinished.bind(this),this.options.dur);this.options.dur=e};st.prototype.enter_and_exit=function(t){var e;if(t==="normal"){e=this.getNormalNodesSelection()}else if(t==="shadow"){e=this.getShadowNodesSelection()}else{throw"No node type specified for node visualization -- AlgebraView.js/enter_and_exit"}if(e.length>0){this._enter(e,t);e.selectAll("g.math text").on("hold",function(t){var e=t.datum();if(!gmath.actions.splitNumberWithKeyboardAction.match(e))return;var i=gmath.actions.splitNumberWithKeyboardAction.createBoundAction(e.get_root(),{actor:e});e.get_root().performAction(i,null,true)});this._exit(e,t)}};st.prototype.getNormalNodesSelection=function(){var e=this.main.selectAll("g.math").data(t.get_leaf_nodes(this.model.children),function(t){return t.id});return e};st.prototype.getShadowNodesSelection=function(){if(!this.options.show_node_targets){return[]}var e=this.model.filter(function(t){return t.dragging});var i=t.filter(function(t){return!t.has_children()},e);var n=this.main.selectAll("g.math_shadow").data(i,function(t){return t.id});return n};st.prototype._enter=function(t,e){var i=this;var n;if(e==="normal"){n=t.enter().append("g").classed("math",true).attr("id",function(t){return t.id}).attr("transform",function(t){return"translate("+t.x+","+t.y+")"})}else{n=t.enter().insert("g","g.math").classed("math_shadow",true).attr("transform",function(t){return"translate("+t.x0+","+t.y0+")"}).each(function(t){t.shadow_deleted=false})}n.append("g").classed("offset",true);n.select("g.offset").append("rect").attr("visibility","hidden").style("stroke","black").style("fill","none").classed("selector",true);var r=n.filter(function(t){return t.value==="//"}).select("g.offset");var o=r.append("line").style("stroke-linecap","round").call(at,this.options.slanted_div_bar,e).style("opacity",function(t){return e==="normal"?t.smooshing||!t.no_anim||t.hidden?1e-5:1:t.hidden||t.hide_after_drop?0:1});var s=n.select("g.offset").append("text").style("font-family",function(t){return i.get_font(t).family}).style("font-weight",function(t){return i.get_font(t).weight}).style("font-style",function(t){return i.get_font(t).style}).style("font-size",function(t){return t.size+"px"}).style("transform",function(t){return t.scale_y?"scaleY("+t.scale_y+")":""}).style("pointer-events","none");if(e==="normal"){s.style("stroke","none").style("fill",function(t){return t.color}).style("opacity",function(t){return t.smooshing||!t.no_anim||t.hidden?1e-5:1}).text(function(t){return t.to_string()});if(this.options.debug_draw)this.debugDraw(n);t.each(function(t){return t.no_anim=false})}else{s.style("stroke",i.options.shadow_node_stroke).style("stroke-width",i.options.shadow_node_stroke_width).style("fill",i.options.shadow_node_fill).style("opacity",function(t){return t.hidden||t.hide_after_drop?0:1})}return n};st.prototype._exit=function(t,e){var i=this;var n=t.exit().each(function(t){if(e==="normal")t.deleted=true;else t.shadow_deleted=true}).transition().ease("linear").duration(function(t){return t.no_anim?0:i.options.dur}).attr("transform",function(t){return"translate("+(t.x0||0)+","+(t.y0||0)+")"});n.select("*").style("opacity",1e-5);n.each("end",function(){this.style.display="none"});if(e==="normal"){this.node_sel=t}};st.prototype.update_existing=function(t,e){var i=this;var n=this.svg.selectAll(t==="normal"?"g.math":"g.math_shadow").filter(function(e){if(t==="normal")return!e.deleted;else return!e.shadow_deleted});var r=n.transition().duration(e?0:this.options.dur).ease(this.options.easing_fn);if(t==="normal"){r.attr("transform",function(t){return"translate("+(t.x||0)+","+(t.y||0)+")"})}else{r.attr("transform",function(t){return"translate("+(t.x0||0)+","+(t.y0||0)+")"})}var o=n.select("text").transition().duration(0).text(function(t){return t.to_string()}).style("transform",function(t){return t.scale_y?"scaleY("+t.scale_y+")":""}).transition().duration(e?0:this.options.dur).ease("linear").style("font-size",function(t){return t.size+"px"});if(t==="normal"){o.style("fill",function(t){return t.color}).style("opacity",function(t){if(t.smooshing||t.hidden)return 1e-5;return 1})}else{o.style("opacity",function(t){return t.hidden||t.hide_after_drop?0:1})}var s=t==="normal"?n.select("line"):n.filter(function(t){return t.value==="//"}).select("line");s.transition().duration(e?0:this.options.dur).ease("linear").call(at,this.options.slanted_div_bar,t).style("opacity",function(e){return t==="normal"?e.smooshing||e.hidden?1e-5:1:e.hidden||e.hide_after_drop?0:1});if(t==="normal"){if(this.options.visualize_scrubbable_nodes&&this.mode==="inspect"){var l=n.each(function(t){var e=d3.select(this);var i=e.selectAll(".scrub");if(i.size()===0&&a.is_num(t)&&!t.fixed&&!t.locked){e.append("path").attr({class:"scrub",d:"M-.5,0 L.5,0 L0,-.7 Z"});e.append("path").attr({class:"scrub",d:"M-.5,0 L.5,0 L0,.7 Z"});i=e.selectAll(".scrub");i.style({fill:t.color,"stroke-linejoin":"round",stroke:t.color,"stroke-width":"0.3px",opacity:.5})}i.style("visibility",!t.locked?"visible":"hidden");i.attr("transform",function(t,e){return e===0?"translate("+[t.sel_box.x+t.sel_box.width/2,-t.ascent]+")scale("+t.size/5+")":"translate("+[t.sel_box.x+t.sel_box.width/2,t.descent]+")scale("+t.size/5+")"})})}else{n.selectAll(".scrub").remove()}n.select("rect").attr("x",function(t){return t.sel_box?t.sel_box.x:0}).attr("y",function(t){return t.sel_box?t.sel_box.y:0}).attr("width",function(t){return t.hidden||!t.sel_box?0:t.sel_box.width}).attr("height",function(t){return t.hidden||!t.sel_box?0:t.sel_box.height});this.update_background()}return true};st.prototype.update_background=function(t){var e=this.model.children[0];var i=this.getBBox();if(e&&!e.dragging){this.border_rect.attr({rx:this.options.border_radius,ry:this.options.border_radius}).style("fill",this.options.background_color).style("stroke",this.options.border_color).attr(i);this.shadow_rect.transition().duration(t?0:this.options.dur).attr(i)}};st.prototype.set_background_visible=function(t){this.options.bg_visible=!!t;this.border_rect.style("visibility",t?"visible":"hidden")};st.prototype.getBBox=function(t){t=t||{};var e=this.model.children[0];if(!e||!e.sel_box)return{x:0,y:0,width:0,height:0};var i={};var n=this.options.padding;i.x=e.sel_box.x+(e.dragging?e.x0:e.x)-(t.no_padding?0:n.left);i.y=e.sel_box.y+(e.dragging?e.y0:e.y)-(t.no_padding?0:n.top);i.width=e.sel_box.width+(t.no_padding?0:n.left+n.right);i.height=e.sel_box.height+(t.no_padding?0:n.top+n.bottom);return i};st.prototype.update_positions=function(t){this.node_sel.filter(function(e){return t.indexOf(e)!==-1}).transition().duration(this.options.dur_dragging).ease("circle-out").attr("transform",function(t){return"translate("+(t.x||0)+","+(t.y||0)+")"})};st.prototype.update_style=function(t){this.node_sel.select("text").style("transform",function(t){return t.scale_y?"scaleY("+t.scale_y+")":""}).transition().duration(t?0:this.options.dur).ease("linear").style("font-size",function(t){return t.size+"px"}).style("fill",function(t){return t.color}).style("opacity",function(t){if(t.hidden)return 1e-5;if(t.hide_after_drop)return.4;return 1});this.node_sel.select("line").transition().duration(t?0:this.options.dur).ease("linear").call(at,this.options.slanted_div_bar).style("opacity",function(t){if(t.hidden)return 1e-5;if(t.hide_after_drop)return.4;return 1})};function at(t,e,i){t.attr("x1",0).attr("x2",function(t){return t.width}).style("stroke-width",function(t){return i==="normal"||!i?t.height:t.height/2}).style("stroke",function(t){return i==="normal"||!i?t.color:"#ddd"});if(e){t.attr("y1",function(t){return.2*t.height}).attr("y2",function(t){return-.2*t.height})}}st.prototype.force_refresh=function(){var t=this.svg.node();t.style.display="none";t.style.display="block"};st.prototype.get_utf8=function(t){var e={"-":"−","*":"·","/":""};if(t.value in e)return e[t.value];if(typeof t.value=="number"&&t.value<0)return e["-"]+Math.abs(t.value);return t.value};st.prototype.get_font=function(t){return t instanceof h?this.options.italic_font:this.options.normal_font};st.prototype.get_width=function(t){return this.fontloader.width(t.to_string(),t.size,get_font(t))};st.prototype.debugDraw=function(t){var e=this;t.select("g.offset").append("rect").style("stroke","orange").style("opacity",function(t){return t.hidden?.3:1}).style("fill","none").filter(function(t){return t.sel_box}).attr({x:function(t){return t.sel_box.x},width:function(t){return t.sel_box.width},y:function(t){return t.descent-.5},height:1});t.select("g.offset").append("rect").style("stroke","green").style("opacity",function(t){return t.hidden?.3:1}).style("fill","none").filter(function(t){return t.sel_box}).attr({x:function(t){return t.sel_box.x},width:function(t){return t.sel_box.width},y:function(t){return-t.ascent-.5},height:1});t.select("g.offset").append("rect").style("stroke","blue").style("opacity",function(t){return t.hidden?.3:1}).style("fill","none").filter(function(t){return t.sel_box}).attr({x:function(t){return t.sel_box.x},width:function(t){return t.sel_box.width},y:function(t){return-t.size*e.options.font_baseline_shift-.5},height:1})};CanvasElement=function(t,e,i){i=i||{};this.id=i.id||gmath.uid();this.type="canvas-element";this.canvas_model=t;this.events=d3.dispatch("start-of-interaction","end-of-interaction","active","move","resize");this.mouse_events=d3.dispatch("touch","drag","release");this.initCanvasElementOptions(i);this.initElement(e);this.initCanvasElementProperties();this.enterMode(this.mode,true)};gmath.CanvasElementClass=CanvasElement;CanvasElement.defaultOptions={visualized:true,pos:{x:"center",y:"center"},min_size:{width:30,height:50},size:{width:10,height:10},active:false,mode:"edit",modes:["edit","arrange"],resizable:{x:true,y:true},draggable:true,send_events:true,dont_log_events:false,graphics_caching:true,delete_btn_size:20,delete_btn_color:"silver",resize_tab_size:25,resize_tab_color:"#c6c6c6",dur:300,easing_fn:"cubic-in-out",edit_mode_drag_box_width:20,show_bg:true,bg_edit_style:{"background-color":"transparent","box-shadow":"none","border-radius":"2px"},bg_edit_active_style:{"background-color":"rgba(255,255,255,0.9)","box-shadow":"none"},bg_arrange_style:{"background-color":"rgba(255,255,255,0.9)","box-shadow":"0 3px 6px rgba(0,0,0,0.23)"},bg_arrange_active_style:{"background-color":"rgba(255,255,255,0.9)","box-shadow":"0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23)"}};CanvasElement.prototype.emitEvent=function(t,e){var i={type:t,source:this,time:Date.now()};if(e)i=gmath.extend(i,e);this.events[t](i)};CanvasElement.prototype.initCanvasElementOptions=function(t){t=t||{};var e=gmath.deepCopy(CanvasElement.defaultOptions);this.options=gmath.object.extendExisting(e,t);delete this.options.id};CanvasElement.prototype.initElement=function(t){if(!this.options.visualized)return;if(arguments.length===0)return this.containing_group.node();this.containing_group=d3.select(t);this.container_size=this.getContainerSize();if(this.element_div)this.containing_group.node().appendChild(this.element_div.node());else{this.element_div=this.containing_group.append("div").classed("canvas-element",true).attr("id",this.id).datum(this).on("mouseenter."+this.id,this.mouseHovering.bind(this,true)).on("mouseleave."+this.id,this.mouseHovering.bind(this,false)).style("pointer-events","all").style("position","absolute");div=this.element_div}if(this.delete_grp)this.delete_grp.selectAll("rect").style("fill",this.options.delete_btn_color);return this};CanvasElement.prototype.initCanvasElementProperties=function(){this.mode=this.options.mode;this.active=this.options.active;if(!this.options.visualized)return;this.size=gmath.extend({},this.options.size);this.pos=this.alignmentToPosition(this.options.pos);this.translateElement(this.pos);this.element_div.style("height",this.size.height+"px").style("width",this.size.width+"px");this.updateBGStyle()};CanvasElement.prototype.setMode=function(t,e){if(!this.options.visualized)return;if(!t)return this.mode;if(t===this.mode)return false;if(this.options.modes.every(function(e){return e!==t}))this.setMode("edit");this.exitMode(t);this.enterMode(t);this.mode=t;this.updateBGStyle();return!e};CanvasElement.prototype.exitMode=function(t){this.exitSubTypeMode(t);if(this.mode==="arrange")this.exitArrangeMode();if(this.mode!=="arrange"&&t==="arrange")this.exitEditMode()};CanvasElement.prototype.exitSubTypeMode=function(){return};CanvasElement.prototype.enterMode=function(t,e){if(!this.options.visualized)return;if(t==="arrange")this.enterArrangeMode();else this.enterEditMode();this.enterSubTypeMode(t)};CanvasElement.prototype.enterSubTypeMode=function(t){return};CanvasElement.prototype.enterEditMode=function(){if(!this.edit_mtouch){this.edit_mtouch=mtouch_events();this.edit_mtouch.origin(function(t){return[t.pos.x,t.pos.y]}).on("touch."+this.id,this.touch.bind(this,null)).on("drag."+this.id,this.drag.bind(this,null)).on("release."+this.id,this.release.bind(this,null))}else this.edit_mtouch.connected(true);if(!this.edit_move_div&&this.options.draggable){var t=this.options.edit_mode_drag_box_width<0,e=(t?-1:1)*this.options.edit_mode_drag_box_width;this.edit_move_div=this.element_div.append("div").style({position:"absolute",left:t?-e+"px":0,top:0,bottom:0,width:e+"px"}).style("cursor",this.options.draggable?"move":null).call(this.edit_mtouch)}else if(this.edit_move_div)this.edit_move_div.style("display",null)};CanvasElement.prototype.exitEditMode=function(){if(this.edit_mtouch)this.edit_mtouch.connected(false);if(this.edit_move_div)this.edit_move_div.style("display","none")};CanvasElement.prototype.enterArrangeMode=function(){this.initMoveControls();this.initDeleteControls();this.initResizeControls()};CanvasElement.prototype.initMoveControls=function(){if(!this.arrange_mtouch){this.arrange_mtouch=mtouch_events().origin(function(t){return[t.pos.x,t.pos.y]}).on("touch."+this.id,this.touch.bind(this,null)).on("drag."+this.id,this.drag.bind(this,null)).on("release."+this.id,this.release.bind(this,null))}if(!this.arrange_mode_div){this.arrange_mode_div=this.element_div.append("div").classed("canvas-element-arrange-pane",true).datum(this).style({position:"absolute",left:0,right:0,top:0,bottom:0}).style("pointer-events","all").style("cursor",this.options.draggable?"move":null).call(this.arrange_mtouch)}};CanvasElement.prototype.initDeleteControls=function(){var t=this;if(!this.delete_mtouch){this.delete_mtouch=mtouch_events().on("release",function(){if(!this.contains(d3.event.sourceEvent.target))return;t.emitEvent("start-of-interaction");t.canvas_model.removeElement(t);t.emitEvent("end-of-interaction")})}if(!this.delete_grp){var e=this.options.delete_btn_size;var i=5;this.delete_grp=this.element_div.append("svg").style({position:"absolute",width:e+2*i+"px",height:e+2*i+"px",right:-i+2+"px",top:-i+2+"px"}).call(this.delete_mtouch);this.delete_icon=this.delete_grp.append("g").style("mouse-events","all").on("mouseenter",function(){d3.select(this).selectAll("rect").style("fill","red")}).on("mouseleave",function(){d3.select(this).selectAll("rect").style("fill",t.options.delete_btn_color)}).attr("transform","translate("+[e/2+i,e/2+i]+")rotate(45)");this.delete_icon.append("circle").attr({r:e/2+i}).style("opacity",0);this.delete_icon.append("rect").attr({width:e,height:e/3.5,x:-e/2,y:-e/7}).style("fill",this.options.delete_btn_color).style("stroke","none");this.delete_icon.append("rect").attr({width:e/3.5,height:e,x:-e/7,y:-e/2}).style("fill",this.options.delete_btn_color).style("stroke","none")}};CanvasElement.prototype.initResizeControls=function(){var t=this;if(!this.options.resizable.x&&!this.options.resizable.y)return;if(!this.resize_mtouch){this.resize_mtouch=mtouch_events().origin(function(){return[t.size.width,t.size.height]}).on("touch."+this.id+"_resize",function(){t.emitEvent("start-of-interaction",{size:gmath.deepCopy(t.size)})}).on("drag."+this.id+"_resize",function(){t.resize({width:d3.event.x,height:d3.event.y})}).on("release."+this.id+"_resize",function(){t.emitEvent("end-of-interaction",{size:gmath.deepCopy(t.size)})})}if(!this.resize_grp){var e=5;var i;if(this.options.resizable.x&&this.options.resizable.y)i="nwse-resize";else if(this.options.resizable.x)i="ew-resize";else i="ns-resize";var n=this.options.resize_tab_size;this.resize_grp=this.element_div.append("svg").style({position:"absolute",width:n+2*e+"px",height:n+2*e+"px",right:-e+"px",bottom:-e+"px"}).call(this.resize_mtouch);this.resize_icon=this.resize_grp.append("g").style("mouse-events","all").attr("transform","translate("+[n+e,n+e]+")").style("cursor",i);this.resize_icon.append("circle").attr({r:n/2+5,cx:-n/3,cy:-n/3}).style("opacity",0);this.resize_icon.append("path").attr("d","M"+[-n,0]+"L"+[0,0]+"L"+[0,-n]+"Z").style("fill",this.options.resize_tab_color).style("stroke","none")}};CanvasElement.prototype.exitArrangeMode=function(){if(this.arrange_mode_div){this.arrange_mode_div.remove();delete this.arrange_mode_div}if(this.arrange_mtouch){this.arrange_mtouch.connected(false);delete this.arrange_mtouch}if(this.delete_grp){this.delete_grp.remove();delete this.delete_grp}if(this.delete_mtouch){this.delete_mtouch.connected(false);delete this.delete_mtouch}if(this.resize_grp){this.resize_grp.remove();delete this.resize_grp}if(this.resize_mtouch){this.resize_mtouch.connected(false);delete this.resize_mtouch}};CanvasElement.prototype.getContainerSize=function(){if(this.canvas_model)return this.canvas_model.size();else return this.containing_group.node().getBoundingClientRect()};CanvasElement.prototype.touch=function(t){this.emitEvent("start-of-interaction",{pos:gmath.deepCopy(this.pos)});var e=t||d3.event;this.container_size=this.getContainerSize();if(this.mode!=="arrange")this.setActive(true)};CanvasElement.prototype.drag=function(t){var e=t||d3.event;if(!this.options.draggable)return;if(!this.hovering){e.x=Math.max(0,Math.min(this.container_size.width-this.size.width,e.x));e.y=Math.max(0,Math.min(this.container_size.height-this.size.height,e.y))}this.translateElement(e)};CanvasElement.prototype.release=function(t){var e=t||d3.event;this.emitEvent("end-of-interaction",{pos:gmath.deepCopy(this.pos)})};CanvasElement.prototype.resize=function(t){if(!this.options.resizable.x&&!!this.options.resizable.y)return;var e=Math.max(this.options.min_size.width,t.width),i=Math.max(this.options.min_size.height,t.height);e=Math.min(e,e-(t.width+this.pos.x-this.container_size.width));i=Math.min(i,i-(t.height+this.pos.y-this.container_size.height));if(!this.options.resizable.x)e=this.size.width;if(!this.options.resizable.y)i=this.size.height;this.resizeElement({width:e,height:i})};CanvasElement.prototype.resizeElement=function(t){if(this.size.width===t.width&&this.size.height===t.height)return;this.size.width=t.width;this.size.height=t.height;this.element_div.style("width",this.size.width+"px").style("height",this.size.height+"px");this.subTypeResize();this.events.resize({type:"resize",size:{width:this.size.width,height:this.size.height}})};CanvasElement.prototype.subTypeResize=function(){return};CanvasElement.prototype.initPosition=function(t){this.pos=this.alignmentToPosition(this.options.pos);this.translateElement(this.pos,t)};CanvasElement.prototype.alignmentToPosition=function(t){var e=t.x,i=t.y;if(e==="center")e=this.container_size.width/2-this.size.width/2;else if(e==="left")e=0;else if(e==="right")e=this.container_size.width-this.size.width;if(i==="center")i=this.container_size.height/2-this.size.height/2;else if(i==="top")i=0;else if(i==="bottom")i=this.container_size.height-this.size.height;return{x:e,y:i}};CanvasElement.prototype.translateElement=function(t,e){if(!this.options.visualized)return;this.pos.x=t.x;this.pos.y=t.y;var i=this.options.graphics_caching?"translate3d("+[Math.round(this.pos.x)+"px",Math.round(this.pos.y)+"px",0]+")":"translate("+[Math.round(this.pos.x)+"px",Math.round(this.pos.y)+"px"]+")";var n=this.element_div;if(e)n=n.transition().duration(this.options.dur).ease(this.options.easing_fn);n.style("transform",i);if(this.options.graphics_caching)n.style("-webkit-transform",i);this.events.move({type:"move",animated:e,pos:{x:this.pos.x,y:this.pos.y}})};CanvasElement.prototype.moveElement=function(t,e){var i={x:this.pos.x+t.x,y:this.pos.y+t.y};this.translateElement(i,e)};CanvasElement.prototype.mouseHovering=function(t){if(this.canvas_model)this.canvas_model.setActive(this,t);else this.setActive(t)};CanvasElement.prototype.setActive=function(t){if(this.active!==t){this.active=t;this.updateBGStyle();if(this.mode!=="arrange")this.setSubTypeActive();this.emitEvent("active",{active:t})}};CanvasElement.prototype.setSubTypeActive=function(){return};CanvasElement.prototype.updateBGStyle=function(){if(!this.options.show_bg)return;var t=this.mode!=="arrange"?"edit":"arrange";var e="bg_"+t+"_"+(this.active?"active_":"")+"style";this.element_div.style("visibility",null).style(this.options[e])};CanvasElement.prototype.removeElement=function(){this.element_div.remove()};CanvasElement.prototype.getBBox=function(){return{x:this.pos.x,y:this.pos.y,width:this.size.width,height:this.size.height}};CanvasElement.prototype.overlapsWithRegion=function(t){gmath.HitTester.overlaps({x:this.pos.x,y:this.pos.y,width:this.size.width,height:this.size.height},t)};CanvasElement.prototype.hitTest=function(t){return t.x>=this.pos.x&&t.x<=this.pos.x+this.size.width&&t.y>=this.pos.y&&t.y<=this.pos.y+this.size.height};DerivationList=function(t,e,i,n){CanvasElement.call(this,t,e,i);this.type="derivation";this.events=gmath.extend(this.events,d3.dispatch("added_line","change","inspect_node","clone","pack_state","hover","mistake","auto_undo"));this.row_events=d3.dispatch("drag","touch","tap","release");this.update_sequence=0;this.initDerivationListOptions(i);this.initDerivationListProperties();this.initDerivationList(n)};gmath.inherit(CanvasElement,DerivationList);gmath.DerivationList=DerivationList;DerivationList.defaultOptions={eq:"",pos:{x:"center",y:"center"},debug_lines:false,visualize_derivations:"none",visualize_derivations_method:"all",embedded:true,border_radius:0,v_align:"center",h_align:"equals",row_padding:{left:10,right:45,top:7,bottom:3},padding:{left:20,right:5,top:5,bottom:5},handle_pos:"right",handle_stroke_color:"#ddd",row_border_color:"#ddd",row_background_color:"white",font_size:50,collapsed_mode:true,draggable:true,no_history:false,no_handles:false,hide_handles:false,break_off_dist:50,wiggle:[],auto_resize_container:false,keep_in_container:true,cloning_on:true,replace_value_on:true,hoverable:false,auto_collapse_repeated_actions:true,auto_simplify_distributions:true,auto_simplify_vector_additions:true,auto_simplify_variables:true,modes:["edit","inspect","arrange"],send_events:true,mappings_color:"#E6F3DE",mappings_active_node_color:"rgb(194, 219, 179)",mappings_rect_radius:6,mappings_joint_width:16,mappings_joint_length:8,mappings_line_thickness:6,row_transition_dur:250,resizable:{x:false,y:false},action_blacklist:[],graphics_caching:false,svg_no_overflow:false,svg_overflow_margin:500};DerivationList.prototype.toJSON=function(){return gmath.extend(gmath.deepCopy(this.options),{id:this.id,type:"DerivationList",pos:this.pos})};DerivationList.createFixedSingleLineDL=function(t,e,i){e=e||{};e.keep_in_container=false;e.draggable=false;e.no_handles=true;e.collapsed_mode=true;e.show_bg=false;e.h_align="h_align"in e?e.h_align:"center";return new DerivationList(null,t,e,i)};DerivationList.prototype.startUpdateSequence=function(){if(!this.options.visualized)return;this.update_sequence++};DerivationList.prototype.isInUpdateSequence=function(){if(!this.options.visualized)return;return this.update_sequence>0};DerivationList.prototype.finishUpdateSequence=function(){if(!this.options.visualized)return;this.update_sequence--;if(this.update_sequence===0)this.updateDims();if(this.update_sequence<0)throw"called finishUpdateSequence before startUpdateSequence"};DerivationList.prototype.initDerivationListOptions=function(t){t=t||{};var e=gmath.deepCopy(DerivationList.defaultOptions);if(t.standalone)e.show_bg=false;var i=gmath.object.extendExisting(e,t);if(!("hide_handles"in t)&&t.no_history)i.hide_handles=!i.draggable;gmath.extend(this.options,i);var n=gmath.object.merged(DerivationList.defaultOptions,t);this.aview_options=gmath.object.extendChanged({},n,gmath.AlgebraView.defaultOptions);this.amodel_options=gmath.object.extendChanged({},n,gmath.AlgebraModel.defaultOptions)};DerivationList.prototype.initDerivationListProperties=function(){this.rows=[];this.hovering=false;this.active_dl_component="none";this.curr_row_operation="none";this.clone=null;this.dims={}};DerivationList.prototype.initDerivationList=function(t){var e=this;if(this.options.visualized){this.svg=this.element_div.insert("svg","*");if(this.options.svg_no_overflow){this.svg.style({"pointer-events":"none",overflow:"hidden",position:"absolute",left:-this.options.svg_overflow_margin+"px",top:-this.options.svg_overflow_margin+"px",width:"calc(100% + "+2*this.options.svg_overflow_margin+"px)",height:"calc(100% + "+2*this.options.svg_overflow_margin+"px)"})}else{this.svg.style({overflow:"visible",position:"absolute",left:0,right:0,top:0,bottom:0,width:"100%",height:"100%"})}this.alignment_correction=this.svg.append("g")}if(this.options.eq.length>0){this.addLineFromExpressions(this.options.eq.split("\\\\"),function(){e.initPosition();if(e.options.visualized){e.startWiggle(e.options.wiggle)}if(t)t(e)})}else if(t)t(this)};DerivationList.prototype.applyViewAlignment=function(){this.translateElement({x:this.pos.x,y:this.pos.y+this.dims.y})};DerivationList.prototype.addLineFromExpressions=function(t,e){if(t.length<1){if(e)e(this);return}for(var i=0;i<t.length;i++)this.addLineFromExpression(t[i],i===t.length-1?e:null)};DerivationList.prototype.addLineFromExpression=function(t,e){if(this.rows.length>0)this.rows[this.rows.length-1].deactivate();this.addRowFromAscii(t,e)};DerivationList.prototype.startWiggle=function(t){var e=this.getLastView();e.wiggle(t,true)};DerivationList.prototype.setExpression=function(t,e,i){this.getLastModel().parseAndSet(t,e,i)};DerivationList.prototype.exitSubTypeMode=function(){if(this.mode==="inspect")this.draw_mappings_for_nodes([])};DerivationList.prototype.enterSubTypeMode=function(t){if(!this.rows)return;this.rows.forEach(function(e,i){if(e.view){e.view.interaction_handler.setMode(t);e.view.update_existing("normal")}},this)};DerivationList.prototype.singleLineMode=function(t){if(arguments.length===0)return this.options.collapsed_mode;if(t&&!this.options.collapsed_mode){var e=false;for(var i=0;i<this.rows.length-1;i++){if(!this.rows[i].hidden){e=true;this.rows[i].hide()}}if(e)this.layoutRows()}this.options.collapsed_mode=t;return this};DerivationList.prototype.getLastRow=function(){return this.rows[this.rows.length-1]};DerivationList.prototype.getRowByModel=function(t){for(var e=0;e<this.rows.length;e++){if(this.rows[e].model===t)return this.rows[e]}return null};DerivationList.prototype.getLastModel=function(){return this.getLastRow().model};DerivationList.prototype.getLastView=function(){return this.getLastRow().view};DerivationList.prototype.onChange=function(t){var e=this.getRowByModel(t.old_model);if(!e)return;if(t.new_model!==t.old_model){this.removeModelEventListeners(t.old_model);this.addModelEventListeners(t.new_model);e.model=t.new_model}setTimeout(function(){var t=false;for(var e=1;e<this.rows.length;e++){var i=this.rows[e];if(i.action.broken)t=true;if(!!i.model.broken===t)continue;i.model.broken=t;i.model.for_each(function(e){e.color=t?"#E0A8A8":i.view.options.color});if(!i.hidden)i.view.update_existing("normal")}}.bind(this),1);this.events.change(gmath.extend(new DerivationList.ChangeEvent(this.id,e.model,e.idx),t))};DerivationList.prototype.onCreate=function(t){this.startUpdateSequence();try{var e=this.getLastView();var i=this.getLastRow();var n=i.el,r=i.handle;var o=t.action.oldTree;o.for_each(function(t){t.dragging=false;t.selected=false});o.hide_nodes();var s=this.addRowFromAction(t.action);this.events.added_line(gmath.extend({senderDL_id:this.id,row:i.idx},t));if(this.options.visualized)i.hide();gmath.LinkCoordinator.addLink(new AlgebraModelLink(t.action.oldTree,t.action.newTree,t.action));if(t.action.name==="SubstitutionAction"||t.action.name==="EquationCombineAction"){gmath.LinkCoordinator.addLink(new AlgebraModelLink(t.action.nodes[0],t.action.newTree,t.action))}this.events.change(new DerivationList.ChangeEvent(this.id,s.model))}finally{this.finishUpdateSequence()}};DerivationList.prototype.onRestraint=function(t){if(!this.options.visualized)return;var e=this.pos.x+this.size.width,i=this.pos.y+this.getLastRow().pos[1];this.canvas_model.createElement("textbox",{text:t,dont_log_events:true,pos:{x:e,y:i},undeditable:true,resizable:{x:false,y:false},use_toolbar:false,select_text_on_create:false});console.log(t)};DerivationList.prototype.shouldCutRow=function(t){if(this.rowIsPartOfAContinuousCommutingSequence(t))return true;return false};DerivationList.prototype.rowIsPartOfAContinuousCommutingSequence=function(t){var e=this.rows[t.idx+1];if(!e)return false;var i=t.action,n=e.action;if(!i||!n)return false;if(i.name!=="CommuteAction"||n.name!=="CommuteAction")return false;for(var r=0;r<i.nodes.length;r++){var o=i.nodes[r],s=n.nodes[r];if(!s)return false;var a=i.mapNodes(o);if(a.length>1)return false;if(a[0]!==s)return false}return true};DerivationList.prototype.addRowFromAction=function(t){var e=t.newTree;if(this.options.visualized){var i=this.getLastView();i.bindToModel(e,t.initial_node_map)}var n=this.getLastRow();n.removeInteractionListeners();var r=this.createRow(e,t,n.el);r.setView(n.view);if(this.options.visualized){r.takeHandle(n.handle);n.handle=null;
i.update_all();if(!(this.shouldCutRow(n)&&this.firstRowInSequence)){n.createView(gmath.object.merged(i.options,{interactive:false,pos:n.pos.slice()}))}else{n.setView(null);n.hidden=true;n.el=null;n.cut=true}}if(!this.rowBeforeCurrActionSeq)this.rowBeforeCurrActionSeq=n;if(!this.firstRowInSequence)this.firstRowInSequence=r;return r};DerivationList.prototype.createRow=function(t,e,i){var n=this.getLastRow();var r={model:t,action:e,view:null,el:i,handle:null,dims:n?gmath.extend({},n.dims):null,row_idx:this.rows.length,pos:n?n.pos.slice():[0,0],padding:this.options.row_padding};var o=new DerivationRow(this,r);if(i){i.datum(o);i.attr("id",t.id)}this.addModelEventListeners(t);this.rows.push(o);return o};DerivationList.prototype.addModelEventListeners=function(t){var e=this;t.events.on("start-of-interaction."+this.id,this.atStartOfInteraction.bind(this));t.events.on("end-of-interaction."+this.id,this.afterEndOfInteraction.bind(this));t.events.on("change."+this.id,this.onChange.bind(this));t.events.on("mistake."+this.id,this.events.mistake);t.events.on("create."+this.id,this.onCreate.bind(this));t.events.on("restraint."+this.id,this.onRestraint.bind(this))};DerivationList.prototype.removeModelEventListeners=function(t){t.events.on("start-of-interaction."+this.id,null);t.events.on("end-of-interaction."+this.id,null);t.events.on("node-changed."+this.id,null);t.events.on("create."+this.id,null);t.events.on("mistake."+this.id,null);t.events.on("change."+this.id,null);t.events.on("restraint."+this.id,null)};DerivationList.prototype.atStartOfInteraction=function(t){if(!t||!t.source)return;if(t.source.type==="AlgebraModel")this.startUpdateSequence();this.events["start-of-interaction"](t)};DerivationList.prototype.afterEndOfInteraction=function(t){if(!t||!t.source)return;if(t.source.type==="DerivationRow"){this.events["end-of-interaction"](t)}else if(t.source.type==="AlgebraModel"){if(this.isInUpdateSequence())this.finishUpdateSequence();var e=t.source;var i=this.getRowByModel(e);var n=i.view.interaction_handler.mode;if(this.canvas_model)this.canvas_model.setActive(this,true);else this.setActive(true);if(n==="inspect"){i.updateDimensionAfterInteraction();this.events["end-of-interaction"](gmath.extend(t,{row:i.idx}))}else if(n==="edit"){if(e!==this.getLastModel())return;this.events["end-of-interaction"](t);if(this.rowBeforeCurrActionSeq){if(this.rowBeforeCurrActionSeq.model.stringify()===this.getLastModel().stringify()){var r=this.rows.length;var o=0;while(this.getLastRow()!==this.rowBeforeCurrActionSeq){this.undo();o++}this.events.auto_undo({undos:o})}else{var i=this.rowBeforeCurrActionSeq;var s=this.shouldHideRow(i);this.getLastView().callAfterAnimation(function(){this.startUpdateSequence();if(!s)i.unhide();this.layoutRows();this.finishUpdateSequence()}.bind(this))}}this.rowBeforeCurrActionSeq=null;this.firstRowInSequence=null}}};DerivationList.prototype.addRowFromModel=function(t,e,i){var n=this.getLastRow();if(n)n.deactivate();var r=this.createRow(t,e);var o=n?n.pos.slice():[0,0];var s=this;if(this.options.visualized){r.createView(gmath.object.merged(this.aview_options,{pos:o}),function(){s.events.added_line({type:"create",senderDL_id:s.id,action:e&&typeof e!=="string"?e:{name:"row added from model",newTree:t},row:r.idx});s.layoutRows();if(i)i(s)})}return r};DerivationList.prototype.addRowFromAscii=function(t,e){return this.addRowFromModel(new r(t,this.amodel_options),null,e)};DerivationList.prototype.getRowByView=function(t){return this.rows.filter(function(e){return e.view===t})[0]};DerivationList.prototype.updateAllRowBackgroundsAndHandles=function(t){for(var e=0;e<this.rows.length;e++){var i=this.rows[e];i.updateBackground(t);i.updateHandlePos(t)}};DerivationList.prototype.shouldHideRow=function(t){var e=this.rows[t.idx+1];if(e&&e.action&&e.action.settings.layout_hint){if(e.action.settings.layout_hint==="same-line")return true;if(e.action.settings.layout_hint==="new-line")return false}if(this.options.collapsed_mode)return true;if(this.options.auto_collapse_repeated_actions&&e&&t.action&&e.action&&t.action.name===e.action.name)return true;if(this.canvas_model){var i=this.rows[this.rows.length-1];var n={x:this.pos.x,y:this.pos.y+t.pos[1]+t.dims.height+this.options.padding.top,width:this.dims.width,height:i.dims.height};return!this.canvas_model.isInFreeVisibleSpace(n,this)}return false};DerivationList.prototype.getFinalVerticalPos=function(t,e,i){i=i||0;var n=this.rows[i].pos[1];for(var r=i+1;r<=t.idx;r++){if(this.rows[r-1].hidden&&!e)continue;n+=this.getVerticalAdvance(this.rows[r])}return n};DerivationList.prototype.isAboveFinalVerticalPos=function(t){return t.pos[1]<this.getFinalVerticalPos(t)};DerivationList.prototype.getUpmostPullableRow=function(t){var e;if(this.rows.length<2)return this.rows[0];if(this.isAboveFinalVerticalPos(this.rows[1])){e=0}else{for(e=t.idx;e>=0;e--){if(this.rows[e].hidden&&this.rows[e].el)break;if(!this.isAboveFinalVerticalPos(this.rows[e]))break}}if(e===t.idx)return null;return this.rows[e+1]};DerivationList.prototype.getHiddenAbove=function(t){var e=t.idx-1;if(this.rows[0].hidden)return this.rows[0];while(e>=0&&(!(this.rows[e].hidden&&this.rows[e].el)||!this.rows[e].el))e--;return e===-1?null:this.rows[e]};DerivationList.prototype.getVisibleAbove=function(t){var e=t.idx-1;while(e>=0&&this.rows[e].hidden)e--;return e===-1?null:this.rows[e]};DerivationList.prototype.getVisibleRowOn=function(t){var e=t.idx,i=this.rows.length;while(e<i&&this.rows[e].hidden)e++;return e===i?null:this.rows[e]};DerivationList.prototype.getDistanceFromHome=function(t){var e=t.pos[0]-t.drag_pos[0],i=t.pos[1]-t.drag_pos[1];return Math.sqrt(e*e+i*i)};DerivationList.prototype.toggleHover=function(t){if(arguments.length===0)t=true;if(this.hovering){this.hovering=false;this.updateBGStyle();this.remove();var e=this.svgg.node();var i=this.original_container;delete this.original_container;var n=i.node().appendChild(e);this.unhoverRemove.remove();this.svg=i;if(t){var r=-1*d3.select("#wikiMainSvg").node().getBoundingClientRect().top;var o=-1*d3.select("#wikiMainSvg").node().getBoundingClientRect().left;this.pos[1]+=r;this.pos[0]+=o}var s=[this.pos[0],this.pos[1]];this.svgg.attr("transform","translate("+s+")");this.svgDims=this.getContainerDimensions();this.moveIntoContainer()}else{if(this.options.hoverable==false)return;this.hovering=true;this.updateBGStyle();this.remove();var e=this.svgg.node();var a=d3.select("#hovering");var l=a.select("g");var h=l.append("g");this.unhoverRemove=h;this.original_container=this.svg;this.svg=l;var n=h.node().appendChild(e);if(t){var r=d3.select("#wikiMainSvg").node().getBoundingClientRect().top;var o=d3.select("#wikiMainSvg").node().getBoundingClientRect().left;this.pos[1]+=r;this.pos[0]+=o}var s=[this.pos[0],this.pos[1]];this.svgg.attr("transform","translate("+s+")")}this.layoutRows()};DerivationList.prototype.setLastHandleVisibility=function(t){this.getLastRow().setHandleVisibility(t)};DerivationList.prototype.updateHandleVisibilities=function(){for(var t=0;t<this.rows.length;t++){this.rows[t].setHandleVisibility()}};DerivationList.prototype.countVisibleRows=function(){var t=0;for(var e=0;e<this.rows.length;e++)if(!this.rows[e].hidden)t++;return t};DerivationList.prototype.updateDims=function(){if(this.isInUpdateSequence())return;var t=Infinity,e=Infinity,i=-Infinity,n=-Infinity;this.rows.forEach(function(r){if(!r.hidden){t=Math.min(t,r.dims.x+r.pos[0]);e=Math.min(e,r.dims.y+r.pos[1]);i=Math.max(i,r.dims.x+r.dims.width+r.pos[0]);n=Math.max(n,r.dims.y+r.dims.height+r.pos[1])}},this);t-=this.options.padding.left;i+=this.options.padding.right;e-=this.options.padding.top;n+=this.options.padding.bottom;var r=t-this.dims.x;var o=e-this.dims.y;var s=this.dims.x!==t||this.dims.width!==i-t,a=this.dims.y!==e||this.dims.height!==n-e;if(s||a){this.dims={x:t,y:e,width:i-t,height:n-e};this.dimsHaveChanged(r,o,s)}return s||a};DerivationList.prototype.dimsHaveChanged=function(t,e,i){var n=[-this.dims.x+(this.options.svg_no_overflow?this.options.svg_overflow_margin:0),-this.dims.y+(this.options.svg_no_overflow?this.options.svg_overflow_margin:0)];this.alignment_correction.attr("transform","translate("+n+")");if(Math.abs(t)>.5||Math.abs(e)>.5){this.translateElement({x:this.pos.x+t,y:this.pos.y+e})}this.resizeElement(this.dims);if(i)this.rows.forEach(function(t){t.updateBackground()})};DerivationList.prototype.handlePackArranging=function(t,e,i){var n=this.rows[this.rows.length-1];var r;if(i>0){if(!this.isAboveFinalVerticalPos(t)){r=this.getHiddenAbove(t);if(!r)return;r.unhide();this.events.pack_state(new DerivationRow.stateEvent(this));r=this.rows[r.idx+1]}else{r=this.getUpmostPullableRow(t)}}else{r=this.getVisibleAbove(t);if(!r)return;if(t.pos[1]<=r.pos[1]){r.hide();this.events.pack_state(new DerivationRow.stateEvent(this));if(this.countVisibleRows()===1)this.singleLineMode(true)}else r=this.rows[r.idx+1]}for(var o=r.idx;o<=n.idx;o++){var s=this.rows[o];s.pos[1]=Math.min(this.getFinalVerticalPos(s),s.pos[1]+i);s.pos[1]=Math.max(o>t.idx?this.getFinalVerticalPos(s,false,t.idx):0,s.pos[1]);if(s.el){s.el.attr("transform","translate("+s.pos+")");this.events.pack_state(new DerivationRow.stateEvent(this))}}this.updateDims()};DerivationList.prototype.setActiveDLComponent=function(t){if(this.active_dl_component!==t){this.active_dl_component=t;if(this.active_dl_component!=="none"){if(this.canvas_model)this.canvas_model.setActive(this);else this.setActive(true)}if(this.options.visualized){this.updateBGStyle();this.updateHandleVisibilities()}}};DerivationList.prototype.setSubTypeActive=function(){if(this.options.visualized){this.updateHandleVisibilities()}};DerivationList.prototype.updateBGStyle=function(){if(!this.options.show_bg)return;this.element_div.attr("visibility",null);var t=this.mode!=="arrange"?"edit":"arrange",e=this.active&&this.active_dl_component!=="AV"?"active_":"";var i="bg_"+t+"_"+e+"style";this.element_div.attr("visibility",null).style(this.options[i])};DerivationList.prototype.getVerticalAdvance=function(t){if(t.idx===0)return 0;var e=this.options.v_align;if(e==="center"){return this.rows[t.idx-1].dims.height/2+t.dims.height/2}else if(e==="top"){return this.rows[t.idx-1].dims.height}else if(e==="bottom"||e==="alphabetic"){return t.dims.height}};DerivationList.prototype.layoutRows=function(){var t=this.rows[0].pos,e=t[0],i=t[1],n=this;this.rows[0].idx=0;for(var r=1;r<this.rows.length;r++){var o=this.rows[r];o.idx=r;if(!this.rows[r-1].hidden)i+=this.getVerticalAdvance(o);if(o.dragging)continue;var s=o.pos;if(s[0]!==e||s[1]!==i){s[0]=e;s[1]=i;s=s;o.showBackground();if(o.el)o.el.transition().duration(this.options.row_transition_dur).attr("transform","translate("+s+")").each("end",function(t){t.hideBackground()})}}this.element_div.selectAll(".dl-line").sort(function(t,e){return t.idx-e.idx});this.updateDims()};DerivationList.prototype.updateContainerDimensions=function(){this.svgDims=this.getContainerDimensions()};DerivationList.prototype.getContainerDimensions=function(){return this.canvas_model.size()};DerivationList.prototype.setFontSize=function(t){this.options.font_size=t;this.rows.forEach(function(e){if(!e.cut){e.view.options.font_size=t;e.view.update_all(true);e.updateHandlePos(true)}});this.hideAllNodeMappings();this.layoutRows()};DerivationList.prototype.undo=function(){if(this.rows.length<1)return;var t=this.getLastRow();t.remove();var e=[];var i=this.getLastRow();while(i.cut){e.push(i);i.remove();i=this.getLastRow()}var n=gmath.LinkCoordinator.unlinkElement(t.model);dead_micro_links=[];e.forEach(function(t){dead_micro_links.push(gmath.LinkCoordinator.unlinkElement(t.model))});var r=this.getLastRow();var o=this.options.collapsed_mode;if(r){r.unhide();r.view.interactive(true);r.view.update_all()}this.updateDims();this.singleLineMode(o);this.updateBGStyle();this.updateHandleVisibilities();return{undone_row:e.length===0?t:[t].concat(e),removed_links:dead_micro_links.length===0?n:[n].concat(dead_micro_links)}};DerivationList.prototype.redo=function(t){var e=t.undone_row,i=t.removed_links;if(Array.isArray(e)){while(e.length>1){this.rows.push(e.pop())}e=e[0]}var n=this.addRowFromModel(e.model,e.action);if(this.rows.length>1&&this.options.collapsed_mode){this.rows[this.rows.length-2].hide()}if(i.length>0&&Array.isArray(i[0])){while(i.length>1){gmath.LinkCoordinator.addLinks(i.pop())}i=i[0]}gmath.LinkCoordinator.addLinks(i);this.updateBGStyle();this.updateHandleVisibilities();this.layoutRows()};DerivationList.prototype.removeElement=function(){CanvasElement.prototype.removeElement.call(this);return gmath.LinkCoordinator.unlinkDL(this)};DerivationList.prototype.forceIntoContainer=function(t){if(arguments.length===0)t=true;var e={x:Math.max(0,Math.min(this.container_size.width-this.size.width,this.pos.x)),y:Math.max(0,Math.min(this.container_size.height-this.size.height,this.pos.y))};if(e.x===this.pos[0]&&e.x===this.pos[1])return;this.translateElement(e)};DerivationList.prototype.getAllDLs=function(){if(this.coordinator)return this.coordinator.dls;if(this.canvas_model)return this.canvas_model.dls();return[this]};DerivationRow=function(t,e){this.type="derivation-row";this.dl=t;this.id=gmath.uid();this.action=e.action;this.model=e.model;this.handle=null;this.view=null;this.el=e.el;this.padding=e.padding;this.dims=e.dims||{};this.idx=e.row_idx;this.pos=e.pos;this.link=null;this.lpos=null;this.preview=null;this.subable=true;this.sub=false;this.error=null};DerivationRow.prototype.createHandle=function(){if(!this.view||this.dl.options.no_handles)return;this.mtouch=this.setupInteractionListeners();var t=this.getHandlePos();var e=this.el.selectAll(".handle").data([this,this]);e.enter().append("circle").classed("handle",true).style({cursor:"pointer"}).call(this.mtouch).attr("transform","translate("+t+")").attr({fill:"white",stroke:this.handle_color?this.handle_color:this.dl.options.handle_stroke_color,"stroke-width":2,r:10}).attr({"pointer-events":"all"});this.handle=e;this.setHandleVisibility()};DerivationRow.prototype.takeHandle=function(t){if(this.dl.options.no_handles)return;this.handle=t;this.handle.data([this,this]);this.handle_color=this.dl.options.handle_stroke_color;this.handle.style({stroke:this.handle_color});this.handle.call(this.setupInteractionListeners());this.bindViewToInteractionHandlerListeners()};DerivationRow.prototype.setHandleColor=function(t){this.handle_color=t;if(this.handle)this.handle.style("stroke",t)};DerivationRow.prototype.removeHandle=function(){if(!this.view)return;if(this.mtouch){this.mtouch.connected(false);delete this.mtouch}if(this.handle){this.handle.remove();delete this.handle}};DerivationRow.prototype.getHandlePos=function(){if(!this.view)return[0,0];var t=this.view.getBBox({no_padding:true});var e=this.dl.options.handle_pos==="left"?t.x-20:t.x+t.width+25;return[e,t.y+t.height/2]};DerivationRow.prototype.updateHandlePos=function(t){if(!this.view||this.dl.options.no_handles)return;var e=this.getHandlePos();if(this.handle)this.handle.transition().ease(this.view.options.easing_fn).duration(t?0:this.view.options.dur).attr("transform","translate("+e+")")};DerivationRow.prototype.createView=function(t,e){var i=this;var n=i?this.dl.alignment_correction.insert("g","g.dl-line#"+i.model.id):this.dl.alignment_correction.append("g");n.classed("dl-line",true).attr("id",this.model.id).attr("transform","translate("+(t.pos||[0,0])+")").datum(this);this.el=n;t.pos=[0,0];t.border_color="none";t.background_color=this.dl.options.row_background_color;if(this.dl.options.standalone)t.event_receiver=this.dl.svg.node();t.derivation_list=this.dl;this.setView(new st(this.model,n,t));var r=this;this.view.init(function(){r.bindViewToInteractionHandlerListeners();r.createHandle();if(e)e(r.dl)})};DerivationRow.prototype.setView=function(t){if(this.view)this.view.events.on("updated."+this.id,null);this.view=t;if(this.view)this.view.events.on("updated."+this.id,this.updateDimensionAfterInteraction.bind(this))};DerivationRow.prototype.listenToInteractionHandlerEvents=function(){var t=this;t.view.interaction_handler.events.on("inspect_node."+t.id,function(e){t.dl.events.inspect_node({type:"inspect",node:e.node,dl:t.dl,row:t.idx})});t.view.interaction_handler.events.on("drag_start."+t.dl.id,t.dl.setActiveDLComponent.bind(t.dl,"AV"));t.view.interaction_handler.events.on("drag_end."+t.dl.id,t.dl.setActiveDLComponent.bind(t.dl,"none"));t.view.interaction_handler.events.on("touch."+t.dl.id,function(){if(t.dl.delete_mode)t.dl.canvas_model.removeElement(t.dl);else{t.dl.updateBGStyle();t.dl.updateHandleVisibilities()}})};DerivationRow.prototype.bindViewToInteractionHandlerListeners=function(){var t=this;this.view.interaction_handler.events.on("inspect_node."+this.id,function(e){t.dl.events.inspect_node({type:"inspect",node:e.node,dl:t.dl,row:t.idx})});this.view.interaction_handler.events.on("drag_start."+this.dl.id,this.dl.setActiveDLComponent.bind(this.dl,"AV"));this.view.interaction_handler.events.on("drag_end."+this.dl.id,this.dl.setActiveDLComponent.bind(this.dl,"none"));this.view.interaction_handler.events.on("touch."+this.dl.id,function(){if(t.dl.delete_mode){t.dl.canvas_model.removeElement(t.dl)}else{t.dl.updateBGStyle();t.dl.updateHandleVisibilities()}})};DerivationRow.prototype.updateDims=function(){if(!this.view)return;var t=this.view.getBBox({no_padding:true});t.y-=this.padding.top;t.height+=this.padding.top+this.padding.bottom;t.x-=this.padding.left;t.width+=this.padding.left+this.padding.right;var e=this.dims.x!==t.x||this.dims.y!==t.y||this.dims.width!==t.width||this.dims.height!==t.height;if(e)this.dims=t;return e};DerivationRow.prototype.updateDimensionAfterInteraction=function(t){if(this.updateDims()){if(this.dl.updateDims()){this.updateHandlePos(t)}else{this.updateBackground(t);this.updateHandlePos(t)}}};DerivationRow.prototype.updateBackground=function(t){if(!this.view)return;if(!this.dims)return;var e=this.dims.x-this.dl.dims.x+this.padding.left-this.dl.options.padding.left,i=this.dl.dims.x+this.dl.dims.width-this.dims.x-this.dims.width+this.padding.right-this.dl.options.padding.right;this.view.options.padding={left:e,right:i,top:this.padding.top,bottom:this.padding.bottom};this.view.update_background(t)};DerivationRow.prototype.showBackground=function(t){if(!this.view)return;this.view.options.border_color=t?this.dl.options.row_border_color:"none";this.updateBackground();this.view.set_background_visible(true)};DerivationRow.prototype.hideBackground=function(){if(!this.view)return;this.view.set_background_visible(false)};DerivationRow.prototype.setHandleVisibility=function(t){if(!this.view||this.dl.options.no_handles||!this||!this.handle)return;if(arguments.length<1)t=true;var e=this.dl.rows,i=this.dl.options.hide_handles;var n=this;this.handle.each(function(e,r){if(i||!t||n.dl.active_dl_component==="AV"||!n.dl.active){d3.select(this).attr("visibility","hidden");return}if(n.atLeastOneNotCutHiddenRowAbove()){d3.select(this).attr({visibility:"visible",cx:3-6*r});n.representHiddenHandleColor()}else{d3.select(this).attr({visibility:r===0?"visible":"hidden",cx:0});n.revertHandleColor()}})};DerivationRow.prototype.atLeastOneNotCutHiddenRowAbove=function(){var t=this.dl.rows;for(var e=this.idx-1;e>=0;e--){if(t[e].hidden&&t[e].cut)continue;else if(t[e].hidden)return true;else return false}return false};DerivationRow.prototype.representHiddenHandleColor=function(){var t;if(this.handle_color===this.dl.options.handle_stroke_color&&(t=this.coloredHandleHiddenBeneath())&&this.dl.curr_row_operation==="pack"){this.setHandleColor(t);this.is_displaying_hidden_handle_color=true}};DerivationRow.prototype.revertHandleColor=function(){if(this.is_displaying_hidden_handle_color){this.setHandleColor(this.dl.options.handle_stroke_color);delete this.is_displaying_hidden_handle_color}};DerivationRow.prototype.coloredHandleHiddenBeneath=function(){var t=this.dl.rows;for(var e=this.idx-1;e>=0;e--){if(t[e].hidden&&t[e].cut)continue;else if(t[e].hidden&&t[e].handle_color!==this.dl.options.handle_stroke_color)return t[e].handle_color;else if(!t[e].hidden)return false}return false};DerivationRow.prototype.hide=function(){if(!this.view||this.hidden)return;this.hidden=true;if(this.view)this.view.options.auto_update=false;if(!this.dl.options.collapsed_mode){this.dl.updateDims()}this.el.attr("display","none");if(this.dl.rows[this.idx+1]){this.dl.rows[this.idx+1].setHandleVisibility()}};DerivationRow.prototype.unhide=function(){if(!this.view||!this.hidden)return;this.dl.singleLineMode(false);this.hidden=false;if(this.view){this.view.options.auto_update=true;this.view.update_all(true)}this.dl.updateDims();this.el.attr("display",null);if(this.dl.rows[this.idx+1]){this.dl.updateHandleVisibilities()}this.dl.rows[this.idx].updateHandlePos(true)};DerivationRow.prototype.deactivate=function(){if(!this.view)return;this.view.interactive(false);this.model.for_each(function(t){t.dragging=false;t.selected=false});this.view.update_all()};DerivationRow.prototype.remove=function(){for(var t=this.idx+1;t<this.dl.rows.length;t++)this.dl.rows[t].idx--;this.dl.rows.splice(this.idx,1);this.removeHandle();if(this.view)this.el.remove();this.model.events.on("end-of-interaction."+this.dl.id,null);this.model.events.on("change."+this.dl.id,null);this.model.events.on("create."+this.dl.id,null)};DerivationRow.prototype.removeInteractionListeners=function(){if(this.mtouch)this.mtouch.on("drag",null).on("touch",null).on("tap",null).on("release",null)};DerivationRow.prototype.setupInteractionListeners=function(){var t=this;if(!this.mtouch){this.mtouch=mtouch_events()}else{this.removeInteractionListeners();this.mtouch.connected(false)}this.mtouch.origin(function(e){return[t.dl.pos.x+e.pos[0],t.dl.pos.y+e.pos[1]]}).on("drag",this.drag.bind(this)).on("touch",this.touch.bind(this)).on("tap",this.tap.bind(this)).on("release",this.dragend.bind(this));return this.mtouch};DerivationRow.prototype.touch=function(t){this.dl.atStartOfInteraction({type:"start-of-interaction",source:{type:"DerivationRow",id:this.dl.id,row:this.idx,model:this.model,packState:this.dl.rows.map(function(t){return t.hidden?true:false})},time:Date.now()});var e=t.row||t.row===0?this.dl.rows[t.row]:t;if(this.dl.options.send_events&&isNaN(t.row))this.dl.row_events.touch(new DerivationRow.touchEvent(d3.event,e.idx,this.dl.id));this.dl.setActiveDLComponent("row");this.dl.curr_row_operation="undecided";this.dl.canvas_svg_dims=this.dl.getContainerDimensions();for(var i=0;i<this.dl.rows.length;i++)this.dl.rows[i].showBackground(i===e.idx);e.handle.attr({fill:"whitesmoke"})};DerivationRow.prototype.tap=function(t){var e=t.row||t.row===0?this.dl.rows[t.row]:t;if(this.dl.options.send_events&&isNaN(t.row))this.dl.row_events.tap(new DerivationRow.tapEvent(d3.event,e.idx,this.dl.id));var i=this;if(!gmath.actions.editLineAction.match(e.model))return;var n=gmath.actions.editLineAction.createBoundAction(e.model,{actor:e.model});e.model.performAction(n,function(){i.updateDimensionAfterInteraction()},true);this.dl.afterEndOfInteraction({type:"end-of-interaction",source:{type:"DerivationRow",id:this.dl.id},time:Date.now()})};DerivationRow.prototype.drag=function(t){var e;var i;var n,r,o,s;var a=50,l,h;if(t.row||t.row===0){e=t;i=this.dl.rows[e.row]}else{e=d3.event;i=t}n=e.x;r=e.dx;o=e.y;s=e.dy;l=Math.abs(e.finger.dist_x);h=Math.abs(e.finger.dist_y);if(this.dl.options.send_events&&isNaN(e.row))this.dl.row_events.drag(new DerivationRow.dragEvent(e,i.idx,this.dl.id));var p=Math.sqrt(l*l+h*h);if(p>=10&&!this.link&&this.dl.curr_row_operation!=="pack"){if(h/p>=.85&&i.idx!==0){this.dl.curr_row_operation="pack"}else{this.link=this.el.append("g");var u=this.getHandlePos();this.lpos=[u[0],u[1]];this.link.append("line").attr({x1:this.lpos[0],y1:this.lpos[1],x2:this.lpos[0],y2:this.lpos[1]}).style("stroke",this.handle_color?this.handle_color:this.dl.options.handle_stroke_color).style("stroke-width",2).style("stroke-linecap","round");this.link.append("circle").attr({cx:this.lpos[0],cy:this.lpos[1],r:10}).style("fill","white").style("stroke",this.handle_color?this.handle_color:this.dl.options.handle_stroke_color).style("stroke-width",2);this.link.append("circle").attr("id","cursor").attr({cx:this.lpos[0],cy:this.lpos[1],r:10}).style("fill","white").style("stroke",this.handle_color?this.handle_color:this.dl.options.handle_stroke_color).style("stroke-width",2);this.subable=this.view.interaction_handler.handlers.edit[1].check(e,this.model);if(this.subable){this.view.interaction_handler.handlers.edit[1].start(this.getHandlePos())}this.macro=gmath.actions.ApplyMacroAction.derivationApplicableAsMacro(this.dl)&&this.idx===0}}if(this.dl.curr_row_operation==="pack"){this.dl.handlePackArranging(i,o,s)}if(this.link){this.dl.curr_row_operation="link";var r=e.finger.dx,s=e.finger.dy;this.lpos[0]=this.lpos[0]+r;this.lpos[1]=this.lpos[1]+s;this.link.select("line").attr({x2:this.lpos[0],y2:this.lpos[1]});this.link.select("#cursor").attr({cx:this.lpos[0],cy:this.lpos[1]});var c=null,d=null,f=this.lpos[0],g=this.lpos[1];this.dl.canvas_model.graphs().forEach(function(t){if(t.inBounds(f,g)){c=t;d="graph"}});if(d==="graph"&&!this.preview){this.preview=gmath.ui.SILine.createGeomPreviewFromDL(this,c);if(!this.preview){this.preview=gmath.ui.PSLine.createGeomPreviewFromDL(this,c)}if(!this.preview){this.preview=gmath.ui.Point.createGeomPreviewFromDL(this,c)}if(!this.preview){this.preview=gmath.ui.ARLine.createGeomPreviewFromDL(this,c)}if(!this.preview){if(this.error)this.error.cancelFade();else{var m={pos:c.pos,text:"This expression can't be linked to a graph.",uneditable:true,static_bg:true,locked:true,dont_log_events:true};this.error=this.dl.canvas_model.createTextBox(m)}}}if(d!=="graph"){if(this.preview){this.preview(true);this.preview=null}if(this.error){var v=this;this.error.fade(function(){v.error=null})}}if(this.subable){this.sub=this.view.interaction_handler.handlers.edit[1].update(e)}}};DerivationRow.prototype.dragend=function(t){var e=t.row||t.row===0?this.dl.rows[t.row]:t;if(this.dl.options.send_events&&isNaN(t.row))this.dl.row_events.release(new DerivationRow.releaseEvent(d3.event,e.idx,this.dl.id));this.releaseRow(e);if(this.link){if(this.preview){this.preview();this.preview=null}var i=null,n=null,r={x:this.dl.pos.x-this.dl.dims.x+this.pos[0]+this.lpos[0],y:this.dl.pos.y-this.dl.dims.y+this.pos[1]+this.lpos[1]};var o=gmath.find(this.dl.canvas_model.elements(),function(t){return t.type==="ggb-panel"});if(o&&o.hitTest(r)){i=o;n="ggb-panel"}var s=gmath.find(this.dl.canvas_model.elements(),function(t){return t.type==="ggb-element"});if(s&&s.ggbPanel&&s.hitTest(r)){i=s.ggbPanel;n="ggb-panel"}this.dl.canvas_model.graphs().forEach(function(t){if(t.inBounds(r.x,r.y)){i=t;n="graph"}});var a=gmath.find(this.dl.canvas_model.dls(),function(t){return t.hitTest(r)});if(a){i=a;n="derivation"}if(n==="ggb-panel"){i.dropDLRow(this)}else if(n==="graph"){var l=gmath.ui.SILine.createGeomFromDL(this,i);if(!l){l=gmath.ui.PSLine.createGeomFromDL(this,i)}if(!l){l=gmath.ui.Point.createGeomFromDL(this,i)}if(!l){l=gmath.ui.ARLine.createGeomFromDL(this,i)}if(!l){if(this.error)this.error.cancelFade();else{var h={pos:i.pos,text:"This expression can't be linked to a graph.",uneditable:true,static_bg:true,locked:true,dont_log_events:true};this.error=this.dl.canvas_model.createTextBox(h)}}if(this.error){var p=this;this.error.fade(function(){p.error=null})}}else if(n!=="derivation"&&!this.sub&&this.dl.options.cloning_on){this.cloneLine(e,r.x,r.y);var u={},c=this.clone.getLastRow().view.getBBox({no_padding:true});u.x=this.dl.options.handle_pos==="left"?r.x-20:r.x-c.width-60;u.y=r.y-c.height/2-10;this.clone.translateElement(u);this.clone.setActiveDLComponent("none");this.clone=null}else if(n==="derivation"&&this.macro&&this.endingPosIsInLastRowHandle(r,i)){var d=[this.dl.rows[0].model,this.dl.getLastModel()],f=i.getLastModel(),g=gmath.actions.ApplyMacroAction.getAllAvailableActions(d,f);if(g.length>0){var m=g[0];m.bindMacroDerivation(this.dl);f.performAction(m)}}if(this.subable){this.view.interaction_handler.handlers.edit[1].end()}this.link.remove();this.link=null;this.lpos=null;this.subable=false;this.sub=false}this.dl.curr_row_operation="none";this.dl.afterEndOfInteraction({type:"end-of-interaction",source:{type:"DerivationRow",id:this.dl.id,row:this.idx,model:this.model,packState:this.dl.rows.map(function(t){return t.hidden?true:false})},time:Date.now()})};DerivationRow.prototype.releaseRow=function(t){this.dl.setActiveDLComponent("none");for(var e=0;e<this.dl.rows.length;e++)this.dl.rows[e].hideBackground();if(!this.dl.options.no_handles)t.handle.attr({fill:"white"});this.dl.draginfo=null;if(t.idx>0){var i=this.dl.getFinalVerticalPos(t)-t.pos[1];var n=this.dl.getVisibleAbove(t);if(n&&i>0&&i>.5*n.dims.height)n.hide();this.dl.layoutRows()}this.dl.updateBGStyle();this.dl.updateHandleVisibilities()};DerivationRow.prototype.cloneLine=function(t,e,i){var n=gmath.extend({},this.dl.options);gmath.extend(n,this.dl.av_options);gmath.extend(n,this.dl.am_options);n.pos={x:e,y:i};n.eq=t.model.to_ascii();n.id=gmath.uid();if(this.dl.options.send_events){this.dl.events.clone(new DerivationRow.cloneEvent(this.dl.id,n))}this.clone=this.dl.canvas_model.createDL(n);if(this.dl.hovering){this.clone.pos={x:e,y:i};this.clone.element_group.transition().duration(0).attr("transform","translate("+[this.clone.pos.x,this.clone.pos.y]+")");this.clone.toggleHover(false)}this.clone.setActiveDLComponent("DL");this.dl.curr_row_operation="clone";var r=new AlgebraModelLink(t.model,this.clone.rows[0].model,gmath.actions.CloneAction.createBoundAction(t.model,{}),true);gmath.LinkCoordinator.addLink(r)};DerivationRow.prototype.handleCloneDrag=function(t,e,i){this.clone.drag(d3.event);var n=this.dl.pos.x+t.pos[0]-this.clone.pos.x,r=this.dl.pos.y+t.pos[1]-this.clone.pos.y;this.clone_dist=Math.sqrt(n*n+r*r)};DerivationRow.prototype.endingPosIsInLastRowHandle=function(t,e){var i=e.getLastRow(),n=e.pos,r=e.getLastRow().pos,o=e.getLastRow().view.getBBox({no_padding:true}),s=e.getLastRow().getHandlePos();var a={x:n.x-e.dims.x+r[0]+s[0],y:n.y-e.dims.y+r[1]+s[1]};return Math.abs(t.x-a.x)<20&&Math.abs(t.y-a.y)<20};DerivationList.ChangeEvent=function(t,e,i){this.type="Change";this.performee=t;this.performee_type="DL";this.time=Date.now();this.row=i;this.model=e};DerivationList.dragEvent=function(t,e){this.type="Drag";this.performee=t;this.performee_type="DL";this.time=Date.now();this.x=e.x;this.y=e.y};DerivationList.touchEvent=function(t,e){this.type="Touch";this.performee=t;this.performee_type="DL";this.time=Date.now();this.fingers=e.fingers.map(function(t){return{pos:[t.pos[0],t.pos[1]]}})};DerivationList.releaseEvent=function(t,e){this.type="Release";this.performee=t;this.performee_type="DL";this.time=Date.now();if(e.altKey)this.altKey=e.altKey;if(e.shiftKey)this.shiftKey=e.shiftKey;this.fingers=e.fingers.map(function(t){return{pos:[t.pos[0],t.pos[1]]}})};DerivationList.holdEvent=function(t,e){this.type="Hold";this.performee=t;this.performee_type="DL";this.time=Date.now();this.finger={pos:[e.finger.pos[0],e.finger.pos[1]]}};DerivationRow.touchEvent=function(t,e,i){this.type="Touch";this.performee=i;this.performee_type="row";this.row=e;this.time=Date.now();this.fingers=t.fingers.map(function(t){return{pos:[t.pos[0],t.pos[1]]}})};DerivationRow.tapEvent=function(t,e,i){this.type="Tap";this.performee=i;this.performee_type="row";this.row=e;this.time=Date.now();this.fingers=t.fingers.map(function(t){return{pos:[t.pos[0],t.pos[1]]}})};DerivationRow.dragEvent=function(t,e,i){this.type="Drag";this.performee=i;this.performee_type="row";this.row=e;this.time=Date.now();this.x=t.x;this.dx=t.dx;this.y=t.y;this.dy=t.dy;this.finger={dx:t.finger.dx,dy:t.finger.dy,dist_x:t.finger.dist_x,dist_y:t.finger.dist_y};this.x_offset=Math.abs(t.finger.dist_x);this.y_offset=Math.abs(t.finger.dist_y);this.fingers=t.fingers.map(function(t){return{pos:[t.pos[0],t.pos[1]]}})};DerivationRow.releaseEvent=function(t,e,i){this.type="Dragend";this.performee=i;this.performee_type="row";this.row=e;this.time=Date.now();this.fingers=t.fingers.map(function(t){
return{pos:[t.pos[0],t.pos[1]]}})};DerivationRow.cloneEvent=function(t,e){this.type="Clone";this.performee=t;this.performee_type="row";this.eq=e.eq;this.pos=e.pos;this.dl_id=e.id};DerivationRow.stateEvent=function(t){this.type="packState";this.performee=t.id;this.performee_type="row";this.time=Date.now();this.packState=t.rows.map(function(t){return t.hidden?true:false})};DerivationList.prototype.draw_mappings_for_nodes=function(t){this.hideAllNodeMappings();if(t.length===0)return;var e=!t.some(function(t){return t.is_group("sym")});this.draw_forward_mappings(t,e);this.draw_backward_mappings(t,e);var i=this.getRowByModel(t[0].get_root());this.draw_node_backgrounds(t,i,true)};DerivationList.prototype.get_combined_action=function(t,e){if(t.idx+1===e.idx)return e.action;var i=[];for(var n=t.idx+1;n<=e.idx;n++)i.push(this.rows[n].action);return Action.createComposedAction(i)};DerivationList.prototype.get_next_visible_row=function(t){for(var e=t.idx+1;e<this.rows.length;e++){if(this.rows[e].hidden)continue;return this.rows[e]}return null};DerivationList.prototype.get_prev_visible_row=function(t){for(var e=t.idx-1;e>=0;e--){if(this.rows[e].hidden)continue;return this.rows[e]}return null};DerivationList.prototype.draw_forward_mappings=function(t,e){if(t.length===0)return;var i=this.getRowByModel(t[0].get_root()),n=this.get_next_visible_row(i);if(!n)return;var r=this.get_combined_action(i,n);var o=[];t.forEach(function(t){var i=r.mapNodes([t]);if(i.length===0)o.push({source_node:t});else i.forEach(function(i){if(e&&i.is_group("sym"))return;if(i.has_children())return;o.push({source_node:t,target_node:i})});t.was_removed=i.length===0});this.draw_mapping_lines(o,i,n);var s=r.mapNodes(t);if(e)s=s.filter(function(t){return!t.is_group("sym")});this.draw_forward_mappings(s,e);this.draw_node_backgrounds(s,n)};DerivationList.prototype.draw_backward_mappings=function(t,e){if(t.length===0)return;var i=this.getRowByModel(t[0].get_root()),n=this.get_prev_visible_row(i);if(!n)return;var r=this.get_combined_action(n,i);t.forEach(function(t){t.was_created=true});var o=[];var s=[];n.model.children[0].for_each(function(i){if(i.has_children())return;if(e&&i.is_group("sym"))return;var n=r.mapNodes([i]);var a=false;n.forEach(function(e){if(t.indexOf(e)!==-1){o.push({source_node:i,target_node:e});a=true;e.was_created=false}});if(a)s.push(i)});this.draw_mapping_lines(o,n,i);this.draw_backward_mappings(s,e);this.draw_node_backgrounds(s,n)};DerivationList.prototype.draw_node_backgrounds=function(t,e,i){var n=i?this.options.mappings_active_node_color:this.options.mappings_color;var r=function(){return n};e.view.main.selectAll(".selector").attr({rx:this.options.mappings_rect_radius,ry:this.options.mappings_rect_radius}).style("fill",r).style("stroke","none").attr("visibility",function(e){return t.indexOf(e)===-1?"hidden":null})};DerivationList.prototype.hideAllNodeMappings=function(){this.rows.forEach(function(t){if(!t.view)return;t.view.main.selectAll(".selector").attr("visibility","hidden");t.view.main.selectAll(".mapping_line").attr("visibility","hidden")})};DerivationList.prototype.draw_mapping_lines=function(t,e,i){var n=i.pos[0]-e.pos[0];var r=i.pos[1]-e.pos[1];e.view.main.selectAll(".mapping_line");var o=this.options.mappings_color;var s=e.view.main.selectAll(".mapping_line").data(t);s.enter().insert("path",".math");s.attr("class","mapping_line").call(this.update_organic_path.bind(this),n,r).style("fill",o).style("stroke",o).attr("visibility",function(t){if(!t.source_node||!t.target_node)return"hidden";return t.source_node.hidden||t.target_node.hidden?"hidden":null});s.exit().remove()};DerivationList.prototype.update_organic_path=function(t,e,i){function n(t){return t.x.toFixed(4)+" "+t.y.toFixed(4)+" "}var r=this.options.mappings_rect_radius;var o=this;t.attr("d",function(t){if(!t.target_node||!t.source_node)return"M 0,0";var s=t.source_node.sel_box,a=t.source_node,l=t.target_node.sel_box,h=t.target_node;var p={x:s.x+a.x,y:s.y+a.y,width:s.width,height:s.height,r:r};var u={x:l.x+h.x+e,y:l.y+h.y+i,width:l.width,height:l.height,r:r};var c=o.createConnectorPath(p,u);var d=o.createConnectorPath(u,p);if(!c||!d)return"M 0 0";return"M "+n(c.base1)+"C "+n(c.base1_control)+n(c.joint1_control1)+n(c.joint1)+"L"+n(d.joint2)+"C "+n(d.joint2_control1)+n(d.base2_control)+n(d.base2)+"L "+n(d.base1)+"C "+n(d.base1_control)+n(d.joint1_control1)+n(d.joint1)+"L "+n(c.joint2)+"C "+n(c.joint2_control1)+n(c.base2_control)+n(c.base2)+"Z"})};DerivationList.prototype.createConnectorPath=function(t,e){var i=Math.min(this.options.mappings_joint_width,t.width*.9,e.width*.9,t.height*.9,e.height*.9);var n=Math.min(i/2,this.options.mappings_line_thickness);var r=this.options.mappings_joint_length;var o=new Point(t.x+t.width/2,t.y+t.height/2),s=new Point(e.x+e.width/2,e.y+e.height/2),a=s.Sub(o),l=[],h=[];if(F.overlaps(t,e))return null;var p=a.get_perpendicular();p.Normalize().Scale(i/2);var u=Point.intersect_inner_ray_with_rect(o.add(p),a,t);if(!u)return null;l.push(u.point);var c=u.point.add(u.tangent.scale(i/3));h.push({from:u.point,to:c});var d=Point.intersect_inner_ray_with_rect(o.sub(p),a,t);if(!d)return null;l.push(d.point);var f=d.point.add(d.tangent.scale(-i/3));h.push({from:d.point,to:f});p.Normalize().Scale(n/2);var g=Point.intersect_inner_ray_with_rect(o.add(p),a,t);if(!g)return null;var m=g.point.add(a.normalize().Scale(r));var v=Point.intersect_inner_ray_with_rect(o.sub(p),a,t);if(!v)return null;var _=v.point.add(a.normalize().Scale(r));l.push(m,_);var y=m.sub(a.normalize().Scale(r/2));var b=m.sub(a.normalize().Scale(-r/2));var w=_.sub(a.normalize().Scale(r/2));var x=_.sub(a.normalize().Scale(-r/2));h.push({from:m,to:y},{from:m,to:b},{from:_,to:w},{from:_,to:x});return{pts:l,lines:h,base1:u.point,base2:d.point,joint1:m,joint2:_,joint1_control1:y,joint1_control2:b,joint2_control1:w,joint2_control2:x,base1_control:c,base2_control:f}};var lt=function(t,e,i){this.view=t;this.h_align=e||"center";this.v_align=i||"alphabetic"};lt.prototype.set_style=function(t){for(var e=0;e<t.length;e++){var i=t[e];var n=r.is_top_most(i)||!i.size?this.view.options.font_size:i.size;var o=i.parent.color||(this.view.interactive()?this.view.options.color:this.view.options.inactive_color);this.set_color_and_size(i,n,o)}};lt.prototype.set_color_and_size=function(t,e,i){t.size=e;if(t.bigger)t.size*=1.5;if(t.smaller)t.size*=.67;t.color=t.selected?this.view.options.selection_color:i;t.children.forEach(function(e,i){if(t.is_group("fraction"))this.set_color_and_size(e,t.size*this.view.options.fraction_size_factor,t.color);else if(t.is_group("power")&&e.is_group("exponent"))this.set_color_and_size(e,t.size*this.view.options.exp_size_factor,t.color);else if(t.is_group("radical")&&e.is_group("degree"))this.set_color_and_size(e,t.size*this.view.options.exp_size_factor*.75,t.color);else if(t.is_leaf_node&&t.has_subscript()&&i===1)this.set_color_and_size(e,t.size*this.view.options.subscript_size_factor,t.color);else this.set_color_and_size(e,t.size,t.color)},this)};lt.prototype.set_position=function(t,e){var i=this.view.options.font_baseline_shift,n=this.view.options.font_ascent,o=this.view.options.font_descent;for(var s=0;s<t.length;s++)this.rel_pos(t[s],t,e,i,n,o);for(var s=0;s<t.length;s++){var a=t[s];if(r.is_top_most(a)){var l,h;switch(this.v_align){case"alphabetic":h=0;break;case"top":h=a.ascent-a.rel_y;break;case"center":h=-a.descent+a.height/2;break;case"bottom":h=-a.descent-a.rel_y;break}switch(this.h_align){case"left":l=a.width;break;case"center":l=a.width/2;break;case"equals":l=a.width/2;if(a.is_group("equals","lte","gte","lt","gt")){var p=a.children[1];var u=p.rel_x+p.sel_box.x+p.sel_box.width;l=-u}break;case"right":l=0;break}this.abs_pos(a,l,h,l,h)}else{this.abs_pos(a,a.parent.x||0,a.parent.y||0,a.parent.x0||0,a.parent.y0||0)}}};lt.prototype.position_horizontally=function(t){var e=t[0].parent;var i=0,n=0,o=0,s=0,a=0,l=t.length,h=t[0].hidden?0:t[0].lmar||0,p=t[l-1].hidden?0:t[l-1].rmar||0;for(var u=0;u<t.length;u++){var c=t[u];i+=c.hidden||c.hide_after_drop?0:c.width;s+=c.hidden?0:c.width;n=Math.max(n,c.hidden?0:c.ascent-c.rel_y);o=Math.max(o,c.hidden?0:c.descent+c.rel_y)}a=n+o;if(r.is_top_most(e)&&h){i-=h}var d=-i;for(var u=0;u<t.length;u++){var c=t[u];var f=u===0?0:c.lmar||0;var g=u===0?c.width-(c.lmar||0):c.width;var m=u===0?0:Math.min(t[u-1].rmar||0,f);i-=m;c.rel_x+=d+c.width+f-m;if(c.hidden||c.hide_after_drop)c.rel_x-=g-m;d+=c.hidden||c.hide_after_drop?0:g-m}if(r.is_top_most(e)&&d!==0){t.forEach(function(t){t.rel_x-=d})}return{width:i,height:a,ascent:n,descent:o,sel_box:{x:-i-h,width:i,y:-n,height:a},lmar:h,rmar:p}};lt.prototype.rel_pos=function(t,e,i,n,o,s){if(!t.has_children()){t.baseline_shift=n*t.size;if(t.value==="="||E.unicode_syms.indexOf(t.value)!==-1){t.lmar=t.size/3;t.rmar=t.size/3}else if(t.value==="+"){t.lmar=t.size/6;t.rmar=t.size/6}else if(t.value==="±"&&!t.parent.is_group("plusminus")){t.lmar=t.size/6;t.rmar=t.size/6}else if(t.value==="-"&&!t.parent.is_group("sign")){t.lmar=t.parent.ls?t.size/6:0;t.rmar=t.size/6}else if(t.value===","){t.lmar=0;t.rmar=t.size/3}else{t.lmar=0;t.rmar=0}if(i){t.width=this.view.fontloader.width(t.to_string(),t.size,this.view.get_font(t));t.width+=t.lmar+t.rmar;t.ascent=o*t.size;t.descent=s*t.size;t.height=t.ascent+t.descent;t.sel_box={x:-t.lmar,width:t.width,y:-t.ascent,height:t.height}}if(e.indexOf(t)!==-1){if(!t.rel_x&&t.rel_x!==0)t.rel_x=-t.width;if(!t.rel_y&&t.rel_y!==0)t.rel_y=0}else{t.rel_x=-t.width;t.rel_y=0}return}if(e.indexOf(t)!=-1&&!r.is_top_most(t)){t.rel_x=t.rel_x||0;t.rel_y=t.rel_y||0}else{t.rel_x=0;t.rel_y=0}for(var a=0;a<t.children.length;a++)this.rel_pos(t.children[a],e,i,n,o,s);if(t.is_group("fraction")){var l=[],h=[],p=null;var u=t.children[0];while(u){if(u.value=="mul")l.push(u);else if(u.value=="div")h.push(u);else p=u;u=u.rs}var c=this.position_horizontally(l);var d=this.position_horizontally(h);var f=-n*t.size;p.height=t.size*this.view.options.div_bar_height;p.width=Math.max(c.width,d.width)+t.size/8;p.ascent=p.height/2;p.descent=p.height/2;p.rel_y=f;p.rel_x=.1*t.size;p.sel_box={x:-.1*t.size,width:p.width+.2*t.size,y:-(o+s)*t.size/4,height:(o+s)*t.size/2};t.width=p.width+.2*t.size;t.ascent=c.height+p.height/2-f;t.descent=d.height+p.height/2+f;t.height=t.ascent+t.descent;t.rel_y=0;t.rel_x=-t.width;t.sel_box={x:0,width:t.width,y:-t.ascent,height:t.height};for(var a=0;a<l.length;a++){l[a].rel_y+=-c.descent-p.height/2+f;l[a].rel_x+=.5*(t.width+c.width)}for(var a=0;a<h.length;a++){h[a].rel_y+=d.ascent+p.height/2+f;h[a].rel_x+=.5*(t.width+d.width)}}else if(t.is_group("radical")){var g=t.children[3],m=this.position_horizontally([g]);var v=[t.children[0],t.children[1],t.children[3]],_=this.position_horizontally(v);var y=v[1];y.scale_y=st.fontPresets.Kalam.font_radical_real_to_h*g.ascent/y.ascent;var b=v[0];b.rel_y-=y.scale_y*y.ascent*.5;y.ascent*=y.scale_y;y.descent*=y.scale_y;y.rel_y=g.rel_y;y.height*=y.scale_y;y.sel_box={x:-y.lmar,width:y.width,y:-y.ascent,height:y.height};gmath.extend(y,y.sel_box);var p=t.children[2];p.height=t.size*this.view.options.div_bar_height;p.width=m.width;p.ascent=p.height/2;p.descent=p.height/2;p.rel_y=-(g.ascent+p.height);p.rel_x=g.rel_x+g.sel_box.x;p.sel_box={x:g.rel_x+g.sel_box.x,width:p.width,y:p.ascent,height:p.height};gmath.extend(p,p.sel_box);_.height+=p.height;_.ascent=y.ascent-y.rel_y+p.ascent;_.y-=p.ascent;_.height+=p.height;gmath.extend(t,_)}else{if(t.is_group("power")){var w=t.children[0],x=t.children[1];x.rel_y-=w.ascent*.7;if(t.children[0].is_group("func")){t.children[1].rel_x-=t.children[0].children[1].width;t.children[0].children[1].rel_x+=t.children[1].width}}if(t.is_leaf_node&&t.has_subscript()){var w=t.children[0],A=t.children[1];A.rel_y+=w.descent*.7}gmath.extend(t,this.position_horizontally(t.children))}};lt.prototype.abs_pos=function(t,e,i,n,r){t.x=t.rel_x+e;t.y=t.rel_y+i;t.x0=t.rel_x+n;t.y0=t.rel_y+r;t.children.forEach(function(e){this.abs_pos(e,t.x,t.y,t.x0,t.y0)},this)};CreationBox=function(t,e,i){this.container=d3.select(t);this.pos0=e.slice();this.bbox={x:e[0],y:e[1],width:20,height:30};this.main_el=this.createVisualElement();this.setupListeners(this.main_el);this.shadow_el=this.createVisualElement().style("visibility","hidden");this.dl_getter=i;this.actions=[]};CreationBox.prototype.setCanvasController=function(t){this.canvas_controller=t};CreateDLAction=function(t,e){this.cc=e;this.size=this.cc.model().size();this.pos_fn=t;this.priority=-1;this.target={x:0,y:0,sel_box:{x:20,y:30,width:this.size.width-40,height:this.size.height-60}}};CreateDLAction.prototype.match=function(){return typeof Keyboard!=="undefined"&&Keyboard!==null};CreateDLAction.prototype.doInPlace=function(t){this.cc.inputDL(this.pos_fn());if(typeof t==="function")t(this);else return true};CreationBox.prototype.getTargetPos=function(){return[this.bbox.x+this.bbox.width/2,this.bbox.y+this.bbox.height/2]};CreationBox.prototype.getAvailableActions=function(){var t=[];if(this.canvas_controller)t.push(new CreateDLAction(this.getTargetPos.bind(this),this.canvas_controller));var e=this.dl_getter();for(var i=0;i<e.length;i++){var n=e[i],r=n.getLastRow();var o=r.model.children;var s=gmath.actions.FractionExtendAction.getAllAvailableActions(o).concat(gmath.actions.EquationFountain.getAllAvailableActions(o));for(var a=0;a<s.length;a++)s[a].settings.offset={x:n.pos[0]+r.pos[0],y:n.pos[1]+r.pos[1]};t=t.concat(s)}F.setTargetRegions(t);return t};CreationBox.prototype.onDragStart=function(){this.actions=this.getAvailableActions();F.draw(this.container,this.actions,this.bbox);this.shadow_el.style("visibility",null)};CreationBox.prototype.onDrag=function(){this.shadow_el.attr({x:d3.event.pos[0],y:d3.event.pos[1]});this.bbox.x=d3.event.pos[0];this.bbox.y=d3.event.pos[1];F.draw(this.container,this.actions,this.bbox);this.current_hit=F.getBestHit(this.actions,this.bbox)};CreationBox.prototype.onDragEnd=function(){this.shadow_el.attr({x:this.pos0[0],y:this.pos0[1]});this.shadow_el.style("visibility","hidden");F.draw(this.container);if(this.current_hit){if(this.current_hit instanceof CreateDLAction)this.current_hit.doInPlace();else{var t=this.current_hit.target.get_root();t.performAction(this.current_hit,function(t){t.finishInteraction()})}}this.bbox.x=this.pos0[0];this.bbox.y=this.pos0[1]};CreationBox.prototype.createVisualElement=function(){var t=this.container.append("rect").datum(this).attr(this.bbox).style({fill:"white","fill-opacity":.67,stroke:"green","stroke-dasharray":"4,2",cursor:"pointer"});return t};CreationBox.prototype.setupListeners=function(t){var e=drag_behavior().on("drag-start",this.onDragStart.bind(this)).on("drag",this.onDrag.bind(this)).on("drag-end",this.onDragEnd.bind(this));var i=mtouch_events().origin(function(t){return[t.bbox.x,t.bbox.y]}).on("tap",ht).call(e);t.call(i)};function ht(){console.log(d3.event)}gmath.ui=gmath.ui||{};gmath.ui.TextBox=function(){var t=function(t,e,i,n){CanvasElement.call(this,t,e,i);this.type="textbox";this.events=gmath.extend(this.events,d3.dispatch("font_size","text"));this.initTextBoxOptions(i);this.initTextBoxProperties();this.initTextBox();this.initPosition();if(n)n(this)};gmath.inherit(CanvasElement,t);gmath.ui.TextBoxClass=t;t.defaultOptions={default_text:"Edit this text.",min_size:{width:150,height:50},size:{width:200,height:200},padding:20,text_align:"left",resizable:{x:true,y:false},uneditable:false,closable:false,font_size:20,min_font_size:10,max_font_size:60,use_toolbar:true,static_bg:false,select_text_on_create:true};t.prototype.initTextBoxOptions=function(e){var e=e||{};var i=gmath.deepCopy(t.defaultOptions);var n=gmath.object.extendExisting(i,e);if(e.text)n.text=e.text;this.options=gmath.extend(this.options,n);if(this.options.static_bg){this.options.bg_edit_style=this.options.bg_arrange_style;this.options.bg_edit_active_style=this.options.bg_arrange_style}};t.prototype.initTextBoxProperties=function(){this.uneditable=this.options.uneditable;this.closable=this.options.closable;this.font_size=this.options.font_size;if(this.options.text)this.text=this.options.text;this.size=this.options.size;this.element_div.style({height:this.size.height+"px",width:this.size.width+"px"})};t.prototype.initTextBox=function(){if(!this.uneditable)this.initToolbar();this.initTextElement();if(this.closable)this.initCloseButton();this.update();this.canvas_model.setActive(this,true);if(!this.uneditable){if(this.mode==="edit"&&this.options.select_text_on_create)this.selectAllText();this.switchToolbarState(this.mode==="edit"&&this.active)}};t.prototype.initToolbar=function(){this.toolbar_on_style={display:"inline-block",position:"fixed","margin-top":"-20px",width:"100%"};this.toolbar_off_style={display:"none"};this.toolFadeoutDelay=500;this.font_btns=[{type:"push",label:"-",icon:"glyphicon glyphicon-text-size",flip:"y"},{type:"push",label:"+",icon:"glyphicon glyphicon-text-size"}];this.tools=this.element_div.append("div").attr({class:"btn-toolbar",role:"toolbar"}).style(this.options.use_toolbar?this.toolbar_on_style:this.toolbar_off_style);var t=this.tools.append("div").attr({class:"btn-group"}).classed("pull-right",true).selectAll("button").data(this.font_btns);var e=this;function i(t,i){var n=t.append("button").attr("id",function(t){return t.label}).attr({type:"button",class:"btn btn-default"}).classed("input-xs",true);n.on("click",i.bind(e));n.append("span").text(function(t){return t.label}).style("color","#555")}t.enter().call(i,this.onButton)};t.prototype.initTextElement=function(){this.text_element=this.element_div.append("div").classed("gm-no-focus-outline",true).style({padding:this.options.padding+"px","font-size":this.font_size+"px","text-align":this.options.text_align}).property("innerHTML",this.text||this.options.default_text).attr("contenteditable",!this.uneditable?"":"contenteditable").on("input",function(){var t=this.text.slice();this.update();this.emitEvent("text",{element:{type:"textbox",id:this.id,old_state:t,new_state:this.text}})}.bind(this))};t.prototype.initCloseButton=function(){var t=2.5*this.options.font_size,e=(this.size.width-t)/2;this.button=this.element_div.append("svg").style({position:"absolute",left:e,width:t+2+"px",height:t+2+"px"});this.button_grp=this.button.append("g");this.button_grp.append("circle").attr({r:t/2,cx:t/2+1,cy:t/2+1}).style({stroke:"#ddd","stroke-width":1,fill:"white"});this.button_grp.append("text").text("OK").attr({x:"50%",y:"50%","text-anchor":"middle","alignment-baseline":"central"}).style({fill:"#ddd","font-size":this.options.font_size,"pointer-events":"none"});this.button.on("click",this.fade.bind(this,null))};t.prototype.selectAllText=function(){if(window.getSelection){var t=window.getSelection();t.removeAllRanges();var e=document.createRange();e.selectNodeContents(this.text_element.node());t.addRange(e)}else if(document.selection){var i=document.body.createTextRange();i.moveToElementText(this.text_element.node());i.select()}};t.prototype.setSubTypeActive=function(){this.switchToolbarState(this.active)};t.prototype.switchToolbarState=function(t,e){if(!this.tools||!this.options.use_toolbar)return;e=true;if(t&&this.toolFadeoutTimer){clearTimeout(this.toolFadeoutTimer);this.toolFadeoutTimer=null}else if(t)this.turnOnToolbar();else if(this.dragging)return;else if(e)this.turnOffToolbar();else{this.toolFadeoutTimer=setTimeout(function(){this.turnOffToolbar()}.bind(this),this.toolFadeoutDelay)}};t.prototype.turnOnToolbar=function(){this.tools.style(this.toolbar_on_style)};t.prototype.turnOffToolbar=function(){this.tools.style(this.toolbar_off_style);this.toolFadeoutTimer=null};t.prototype.onButton=function(t){if(t.label==="+")this.increaseTextSize();else if(t.label==="-")this.decreaseTextSize()};t.prototype.changeFontSize=function(t){var e=this.font_size;this.font_size=Math.max(this.options.min_font_size,Math.min(t,this.options.max_font_size));if(this.font_size!==e){this.text_element.style("font-size",this.font_size+"px");this.emitEvent("font_size",{element:{type:"textbox",id:this.id,old_state:e,new_state:this.font_size}});this.update()}};t.prototype.increaseTextSize=function(){var t;if(this.font_size<12)t=1;else if(this.font_size<28)t=2;else if(this.font_size<36)t=8;else t=12;this.changeFontSize(this.font_size+t)};t.prototype.decreaseTextSize=function(){var t;if(this.font_size<=12)t=1;else if(this.font_size<=28)t=2;else if(this.font_size<=36)t=8;else t=12;this.changeFontSize(this.font_size-t)};t.prototype.setText=function(t){this.text_element.node().innerHTML=t;this.update()};t.prototype.update=function(){this.text=this.text_element.node().innerHTML;this.size.height=this.text_element.node().offsetHeight;if(this.closable)this.size.height+=3*this.options.font_size;this.element_div.style({height:this.size.height+"px",width:this.size.width+"px"});if(this.closable){this.button.attr("transform","translate("+[this.size.width/2,this.size.height-3*this.options.font_size]+")")}};t.prototype.subTypeResize=function(){this.update()};t.prototype.unselect=function(){window.getSelection().removeAllRanges();this.text_element.node().blur()};t.prototype.fade=function(t){var e=750;this.element_div.transition().duration(e).style("opacity",0).each("end",function(){this.canvas_model.removeElement(this);if(t)t()}.bind(this))};t.prototype.cancelFade=function(){this.element_group.transition().duration(0).style("opacity",1)};t.prototype.toJSON=function(){var t={id:this.id,type:"TextBox",pos:this.pos,size:this.size,uneditable:this.uneditable,closable:this.closable,font_size:this.font_size};if(this.text!==this.options.default_text)t.text=this.text;return t};return t}();gmath.ui=gmath.ui||{};gmath.ui.Graph=function(){var t=function(t,e){this.id=e.id?e.id:gmath.uid();this.type="graph";this.options=e||{};this.send_events=true;this.events=d3.dispatch("start-of-interaction","end-of-interaction","move","move_touch","touch","drag","hold","release","zoom","resize","remove_geom","create_geom","geom_attr","mouse_location","link_start","link_drag","link_end");this.interactive=this.options.interactive?this.options.interactive:true;this.container=d3.select(t);this.svg_dims=this.getContainerDimensions();this.view=e.view;this.main_g=null;this.geom_g=null;this.legs_g=null;this.size_g=null;this.move_el=null;this.fill_el=null;this.clip_el=null;this.evts_el=null;this.geoms=this.options.geoms||[];this.pos=this.options.pos||{x:0,y:0};this.size=this.options.size||{width:360,height:360};this.lims={min:100,max:600};this.domain=this.options.domain||[-5,5];this.x_domain=this.domain;this.y_domain=this.domain;this.x_range=d3.scale.linear().domain(this.x_domain);this.y_range=d3.scale.linear().domain(this.y_domain);this.x_axis=null;this.y_axis=null;this.x_axis_g=null;this.y_axis_g=null;this.x_axis_G=null;this.y_axis_G=null;this.x_lims=false;this.y_lims=false;this.tick_size=36;this.x_ticks=this.options.x_ticks||10;this.y_ticks=this.options.y_ticks||10;this.x_label=this.options.x_label||"x";this.y_label=this.options.y_label||"y";this.x_label_el=null;this.y_label_el=null;this.legs_sel=null;this.legs_ops=this.options.legs_ops||{width:160,height:90,fill:"whitesmoke"};this.legs_offset={width:0,height:0};this.move_offset=0;this.max_dist=this.options.max_dist||30;this.selection=null;this.dragging=false;this.drag_action=null;this.colors=d3.scale.category10();this.delete_mode=false;this.zoom=null;this.initial_pan=e.initial_pan||[0,0];this.initial_zoom=e.initial_zoom||1;this.margin=35;this.defaultMargin=this.margin;this.touch0=null;this.size0=null;this.pos0=null;this.mouse_in_move=true;this.mouse_in_evts=true;this.init()};t.prototype.toJSON=function(){return{id:this.id,type:"Graph",geoms:this.geoms.filter(function(t){return!(t.type==="point"&&t.line)}),pos:this.pos,size:this.size,x_domain:this.x_domain,y_domain:this.y_domain,x_ticks:this.x_ticks,y_ticks:this.y_ticks,legs_ops:this.legs_ops,max_dist:this.max_dist,initial_pan:this.zoom.translate(),initial_zoom:this.zoom.scale()}};t.prototype.setMode=function(t){this.delete_mode=t==="arrange"};t.prototype.setLocked=function(t){this.geoms.forEach(function(e){e.setLocked(t)})};t.prototype.setGeoms=function(t){this.geoms=t;return this.update()};t.prototype.getGeomByID=function(t){var e=this.geoms.filter(function(e){return e.id===t});return e[0]?e[0]:null};t.prototype.setPos=function(t,e){this.pos=t;this.main_g.attr("transform","translate("+this.pos.x+", "+this.pos.y+")");if(e)this.keepInContainer();return this};t.prototype.setSize=function(t){var e=this.zoom.translate(),i=this.zoom.scale();this.zoom.translate([0,0]);this.zoom.scale(1);this.size=t;var n=this.size.width/2/Math.abs(this.x_range.range()[0]),r=this.size.height/2/Math.abs(this.y_range.range()[0]);this.x_range.range([-this.size.width/2,this.size.width/2]);this.y_range.range([this.size.height/2,-this.size.height/2]);this.x_range.domain([this.x_range.domain()[0]*n,this.x_range.domain()[1]*n]);this.y_range.domain([this.y_range.domain()[0]*r,this.y_range.domain()[1]*r]);this.x_axis=d3.svg.axis().scale(this.x_range).tickSize(0,0);this.y_axis=d3.svg.axis().scale(this.y_range).tickSize(0,0).orient("left");this.zoom=d3.behavior.zoom().x(this.x_range).y(this.y_range).translate(e).scale(i).scaleExtent([1/Math.pow(2,8),Math.pow(2,8)]).on("zoom",this.zoomBehavior.bind(this,null));this.update();this.zoomBehavior({translate:e})};t.prototype.setXDomain=function(t){this.x_range.domain(t);return this.update()};t.prototype.setYDomain=function(t){this.y_range.domain(t);return this.update()};t.prototype.inBounds=function(t,e){var i=this.pos.x-this.size.width/2,n=this.pos.x+this.size.width/2,r=this.pos.y-this.size.height/2,o=this.pos.y+this.size.height/2;if(t>i&&t<n&&e>r&&e<o)return true;return false};t.prototype.remove=function(){this.main_g.remove()};t.prototype.enableZoom=function(t){if(t)this.main_g.call(this.zoom);else{this.main_g.on(".zoom",null);d3.select(window).on("mousemove.zoom",null)}};t.prototype.replayZoom=function(t){this.zoom.scale(t.scale);this.zoom.translate(t.translate);this.zoom.event(this.main_g)};t.prototype.zoomBehavior=function(t){var t=t||d3.event,e=this.size.width/2,i=this.size.height/2,n=this.zoom.translate();if(this.send_events)this.events.zoom(new a(this.id,t));if(t.translate[0]<-(e-5)){var n=this.zoom.translate(),r=Math.round(this.x_range.invert(n[0]*-1)),o=Math.round(this.y_range.invert(n[1]*-1)),s=Math.max(Math.abs(r),Math.abs(o)).toString().length;this.margin=Math.max(this.defaultMargin,15+s*5);this.y_axis_G.attr("transform","translate("+[-(e+5),0]+")");this.y_axis_g.attr("transform","translate("+[-(e+5),0]+")");this.y_label_el.attr({x:-(e+15),y:n[1]>=0?-(i+10):i+15});this.y_lims=true}else if(t.translate[0]>e-5){var n=this.zoom.translate(),r=Math.round(this.x_range.invert(n[0]*-1)),o=Math.round(this.y_range.invert(n[1]*-1)),s=Math.max(Math.abs(r),Math.abs(o)).toString().length;var l=10+s*5;this.margin=Math.max(this.defaultMargin,15+s*5);this.y_axis_G.attr("transform","translate("+[e+l,0]+")");this.y_axis_g.attr("transform","translate("+[e+l,0]+")");this.y_label_el.attr({x:e+10,y:n[1]>=0?-(i+10):i+15});this.y_lims=true}else{this.margin=this.defaultMargin;this.y_axis_g.attr("transform","translate("+[t.translate[0],0]+")");this.y_label_el.attr({x:t.translate[0]-4,y:n[1]>=0?-(i+10):i+15});this.y_lims=false}if(t.translate[1]<-(i-5)){this.x_axis_G.attr("transform","translate("+[0,-(i+20)]+")");this.x_axis_g.attr("transform","translate("+[0,-(i+20)]+")");this.x_label_el.attr({x:n[0]>0?-(e+15):e+10,y:-(i+10)});this.x_lims=true}else if(t.translate[1]>i-5){this.x_axis_G.attr("transform","translate("+[0,i+5]+")");this.x_axis_g.attr("transform","translate("+[0,i+5]+")");this.x_label_el.attr({x:n[0]>0?-(e+15):e+10,y:i+15});this.x_lims=true}else{this.x_axis_g.attr("transform","translate("+[0,t.translate[1]]+")");this.x_label_el.attr({x:n[0]>0?-(e+15):e+10,y:t.translate[1]+4});this.x_lims=false}this.x_axis.ticks(this.size.width/this.tick_size);this.y_axis.ticks(this.size.height/this.tick_size);this.update()};t.prototype.init=function(){var t=this;this.main_g=this.container.append("g").classed("graph",true).attr("transform","translate("+this.pos.x+", "+this.pos.y+")").on("mouseenter",this.showMove.bind(this,null)).on("mouseleave",this.hideMove.bind(this,null));this.move_el=this.main_g.append("rect").classed("drag",true).style("opacity",0).style("fill","white");var e=this.main_g.append("defs"),i=e.append("filter").attr("id","dropShadow"+this.id);i.append("feGaussianBlur").attr("in","SourceAlpha").attr("stdDeviation",3);i.append("feOffset").attr("dx",0).attr("dy",2).attr("result","offsetblur");i.append("feComponentTransfer").append("feFuncA").attr("type","linear").attr("slope",.2);var n=i.append("feMerge");n.append("feMergeNode");n.append("feMergeNode").attr("in","SourceGraphic");this.move_el.attr("filter","url(#dropShadow"+this.id+")");var r=mtouch_events().frame(this.main_g.node()).on("touch",this.deleteMove.bind(this,null)).on("drag",this.move.bind(this,null)).on("release",function(){t.enableZoom(true);t.hideMove.bind(t);t.release()});this.move_el.call(r);this.fill_el=this.main_g.append("rect").classed("fill",true).style("fill","white");this.geom_g=this.main_g.append("g");var o=this.main_g.append("defs").append("clipPath").attr("id","clipPath");this.clip_el=o.append("rect");this.geom_g.attr("clip-path","url(#clipPath)");this.legs_g=this.main_g.append("g");this.evts_el=this.main_g.append("rect").classed("evts",true).style("stroke","silver").style("stroke-rendering","crispEdges").style("stroke-width",1).style("pointer-events","all").style("fill","none").on("mousemove",this.hover.bind(this,null)).on("mouseenter",this.withinGrid.bind(this,null)).on("mouseleave",this.withinGrid.bind(this,null));var s=mtouch_events().frame(this.main_g.node()).on("touch",this.touch.bind(this,null)).on("drag",this.drag.bind(this,null)).on("release",this.release.bind(this,null)).on("hold",this.hold.bind(this,null)).hold_time(1e3).hold_max_dist(2);this.evts_el.call(s);this.x_axis_g=this.geom_g.append("g").classed("axis",true).style("stroke","silver").style("stroke-rendering","crispEdges").style("stroke-width",1).style("vector-effect","non-scaling-stroke");this.x_axis_G=this.main_g.append("g").classed("axis",true).style("stroke","silver").style("stroke-rendering","crispEdges").style("stroke-width",1).style("vector-effect","non-scaling-stroke");this.y_axis_g=this.geom_g.append("g").classed("axis",true).style("stroke","silver").style("stroke-rendering","crispEdges").style("stroke-width",1).style("vector-effect","non-scaling-stroke");this.y_axis_G=this.main_g.append("g").classed("axis",true).style("stroke","silver").style("stroke-rendering","crispEdges").style("stroke-width",1).style("vector-effect","non-scaling-stroke");this.x_label_el=this.main_g.append("text").classed("axis",true).attr("font-weight","lighter").attr("font-family","Lato");this.y_label_el=this.main_g.append("text").classed("axis",true).attr("font-weight","lighter").attr("font-family","Lato");this.x_range.range([-this.size.width/2,this.size.width/2]);this.y_range.range([this.size.height/2,-this.size.height/2]);this.x_axis=d3.svg.axis().scale(this.x_range).tickSize(0,0);this.y_axis=d3.svg.axis().scale(this.y_range).tickSize(0,0).orient("left");if(Math.abs(this.x_range.range()[0])<=Math.abs(this.y_range.range()[0])){var a=Math.abs(this.x_range.range()[0])/Math.abs(this.domain[0]),l=Math.abs(this.y_range.range()[0])/a;this.y_range.domain([-l,l]);this.y_axis.ticks(l*2)}else{var a=Math.abs(this.y_range.range()[0])/Math.abs(this.domain[0]),l=Math.abs(this.x_range.range()[0])/a;this.x_range.domain([-l,l]);this.x_axis.ticks(l*2)}this.zoom=d3.behavior.zoom().x(this.x_range).y(this.y_range).translate(this.initial_pan).scale(this.initial_zoom).scaleExtent([1/Math.pow(2,8),Math.pow(2,8)]).on("zoom",this.zoomBehavior.bind(this,null));this.enableZoom(true);this.update();this.zoomBehavior({translate:this.initial_pan})};t.prototype.update=function(){this.x_axis_G.call(this.x_axis).style("display",this.x_lims?"block":"none").select("path").style("display","none");this.x_axis_g.call(this.x_axis).selectAll(".tick").each(function(t){var e=d3.select(this).select("text");
e.style("display",e.text()*1===0?"none":"block")});this.y_axis_G.call(this.y_axis).style("display",this.y_lims?"block":"none").select("path").style("display","none");this.y_axis_g.call(this.y_axis).selectAll(".tick").each(function(t){var e=d3.select(this).select("text");e.style("display",e.text()*1===0?"none":"block")});this.x_axis_g.selectAll(".tick").select("line").attr("x1",0).attr("x2",0).attr("y1",-(this.size.height+20)).attr("y2",this.size.height+20).style("stroke","gainsboro").style("opacity",.8);var t=this.zoom.translate(),e=Math.round(this.x_range.invert(t[0]*-1)),i=Math.round(this.y_range.invert(t[1]*-1)),n=Math.max(Math.abs(e),Math.abs(i)).toString().length;this.y_axis_g.selectAll(".tick").select("line").attr("x1",-(this.size.width+(10+n*5))).attr("x2",this.size.width+20).attr("y1",0).attr("y2",0).style("stroke","gainsboro").style("opacity",.8);this.x_label_el.text(this.x_label);this.y_label_el.text(this.y_label);this.geoms.forEach(function(t){t.update()});var r=this.x_range.range()[0],o=this.y_range.range()[0],s=this.x_range.range()[1],a=this.y_range.range()[1],l=Math.abs(s-r),h=Math.abs(a-o);this.move_el.attr({x:r-this.margin,y:Math.min(o,a)-this.margin}).attr("width",l+this.margin*2+this.legs_offset.width).attr("height",h+this.margin*2+this.legs_offset.height);this.fill_el.attr({x:r,y:Math.min(o,a)}).attr("width",l).attr("height",h);this.clip_el.attr({x:r,y:Math.min(o,a)}).attr("width",l).attr("height",h);this.evts_el.attr({x:r,y:Math.min(o,a)}).attr("width",l).attr("height",h);var p=this;this.keepInContainer()};t.prototype.updateLegends=function(){this.legs_sel=this.legs_g.selectAll(".graph.legend").data(this.geoms);var t=this.legs_sel.enter().append("g").classed("graph.legend",true);t.append("rect").attr("rx",5).attr("ry",5).attr("width",this.legs_ops.width).attr("height",this.legs_ops.height).style("fill",this.legs_ops.fill);var e=t.append("g").attr("transform","translate(-20, 0)");var i={interaction_mode:"change",no_history:true,no_handles:true,draggable:false,bg_rect_style:{fill:"none",stroke:"none",opacity:0},bg_rect_activity_style:{fill:"none",stroke:"none",opacity:0},h_align:"left",v_align:"top"};t.each(function(t){var e=this.select("g").node();t.linkRepresentations(e,i)});var n=t.append("g");n.append("circle").attr("cx",this.legs_ops.width-15).attr("cy",15).attr("r",10).style("fill",function(t){return t.color});var r=mtouch_events().frame(this.main_g.node()).on("touch",function(t){this.legs_sel.filter(function(e){return t.id===e.id}).style("display","none");this.orderLegends()});n.call(r);var o=6*Math.sqrt(2)/2;n.append("line").attr({x1:this.legs_ops.width-15+o,y:15-o,x2:this.legs_ops.width-15-o,y:15+o}).style("stroke",this.legs_ops.fill).style("stroke-width",2).style("stroke-linecap","round");n.append("line").attr({x1:this.legs_ops.width-15-o,y:15-o,x2:this.legs_ops.width-15+o,y:15+o}).style("stoke",this.legs_ops.fill).style("stroke-width",2).style("stroke-linecap","round");this.legs_sel.exit().remove()};t.prototype.orderLegends=function(){var t=this.size.width/2+5,e=-this.size.height/2,i=0;this.legs_offset.width=0;this.legs_offset.height=0;this.legs_sel.attr("transform",function(n){var r=this.style("display"),o="translate("+t+", "+e+")";if(r==="block"){e+=this.legs_ops.height+5;i++}return o});if(i>0){this.legs_offset.width=this.legs_ops.width+5;if(e>this.size.height){this.legs_offset.height=this.size.height-e}}this.update()};t.prototype.move=function(t){var e=t||d3.event;if(!this.interactive)return;if(this.send_events)this.events.move(new i(this.id,e));if(!this.selection){if(!this.pos0){this.pos0={x:this.pos.x,y:this.pos.y}}this.delta={x:this.pos.x-this.pos0.x,y:this.pos.y-this.pos0.y};var n=e.finger.dx,r=e.finger.dy;this.setPos({x:this.pos.x+n,y:this.pos.y+r},true);this.showMove();if(t&&t.finger){this.updateFingers([e.finger])}}};t.prototype.hover=function(){if(this.delete_mode){var t=d3.event.x-this.pos.x-this.margin,e=d3.event.y-this.pos.y-this.margin,i=this.getClosest(t,e);this.geoms.forEach(function(t){t.select(t===i?true:false,true)})}};t.prototype.showMove=function(){if(this.dragging)return;if(this.send_events)this.events.mouse_location(new u(this.id,"in-main"));if(this.delete_mode)this.move_el.style("stroke","red");this.move_el.style("opacity",1);this.move_offset=this.margin;this.mouse_in_move=true;this.geoms.forEach(function(t){setTimeout(function(){t.updateLinkHandle()},50)})};t.prototype.hideMove=function(){if(this.send_events)this.events.mouse_location(new u(this.id,"out-main"));if(this.delete_mode)this.move_el.style("stroke","none");this.move_el.style("opacity",0);this.move_offset=0;this.mouse_in_move=false;this.geoms.forEach(function(t){setTimeout(function(){t.updateLinkHandle()},50)})};t.prototype.withinGrid=function(t){var e=t||d3.event;if(this.send_events)this.events.mouse_location(new u(this.id,e.type==="mouseenter"?"in-grid":"out-grid"));this.mouse_in_evts=e.type==="mouseenter"?true:false;this.geoms.forEach(function(t){setTimeout(function(){t.updateLinkHandle()},50)})};t.prototype.deleteMove=function(t){var i=t||d3.event;if(this.send_events){this.events["start-of-interaction"]({type:"start-of-interaction",source:{type:"Graph",id:this.id},pos:gmath.deepCopy(this.pos),time:Date.now(),subSource:"deleteMove"});this.events.move_touch(new e(this.id))}this.svg_dims=this.getContainerDimensions();this.enableZoom(false);if(this.delete_mode){this.view.removeGraph(this);gmath.LinkCoordinator.unlinkGraph(this)}};t.prototype.touch=function(t){var e=t||d3.event;if(!this.interactive)return;if(t&&t.finger){this.updateFingers([e.finger])}var i=e.finger.pos[0],r=e.finger.pos[1];this.selection=this.getClosest(i,r);if(this.selection)this.enableZoom(false);if(this.selection&&this.selection.locked){this.selection=null}if(this.delete_mode){if(this.selection){var o=this.selection.removeGroup();for(var s=0;s<o.length;s++){for(var a=0;a<this.geoms.length;a++){if(this.geoms[a].id===o[s]){this.geoms.splice(a,1)}}}}}else{if(this.selection&&this.selection.type==="point-slope"){var l=this;this.drag_action=function(){l.geoms.forEach(function(t){if(t.type==="point"&&t.id!==l.selection.id&&!t.line&&!t.intercept)t.showSnap(true)});l.drag_action=null}}}if(this.send_events){var h=this.selection;if(h&&h.line)h=h.line;this.events["start-of-interaction"]({type:"start-of-interaction",source:{type:"Graph",id:this.id,selection:h?h.summarize():null,selection_id:h?h.id:null},time:Date.now(),subSource:"touch"});this.events.touch(new n(this.id,e))}};t.prototype.drag=function(t){this.dragging=true;var e=t||d3.event;if(!this.interactive)return;if(this.send_events)this.events.drag(new r(this.id,e));if(t&&t.finger){this.updateFingers([e.finger],true)}var i=e.finger.pos[0],n=e.finger.pos[1];if(this.drag_action)this.drag_action();if(this.selection){if(this.selection.type==="point")this.selection.drag(e.finger.dx,e.finger.dy);else this.selection.drag(i,n)}};t.prototype.addGeom=function(t,e){var i;if(t==="Point"){i=new gmath.ui.Point(this.geom_g.node(),e)}else if(t==="SILine"){i=new gmath.ui.SILine(this.geom_g.node(),e)}else if(t==="PSLine"){i=new gmath.ui.PSLine(this.geom_g.node(),e)}else if(t==="PPLine"){i=new gmath.ui.PPLine(this.geom_g.node(),e)}else if(t==="ARLine"){i=new gmath.ui.ARLine(this.geom_g.node(),e)}this.geoms.push(i);return i};t.prototype.hold=function(t){var e=t||d3.event;if(!this.interactive||this.delete_mode)return;if(this.send_events)this.events.hold(new o(this.id,e));var i=e.finger.pos[0],n=e.finger.pos[1];this.selection=this.getClosest(i,n);if(!this.selection||this.selection.type!=="point"||this.selection.line){var r=Math.abs(this.zoom.translate()[0]-i)<20?true:false,s={graph:this,pos:r?{x:0,y:this.y_range.invert(n)}:{x:this.x_range.invert(i),y:this.y_range.invert(n)},color:this.colors(this.geoms.length),intercept:r},a=new gmath.ui.Point(this.geom_g.node(),s);this.geoms.push(a);this.listenToGeom(a);this.selection=a}if(this.selection.type==="point"&&!this.selection.line){this.enableZoom(false);this.selection.showSnap();var l=this;this.drag_action=function(){l.selection.showSnap(false);var t={graph:l,point:l.selection,color:l.selection.color},e=null;if(l.selection.intercept){e=new gmath.ui.SILine(l.geom_g.node(),t)}else{e=new gmath.ui.PSLine(l.geom_g.node(),t);l.geoms.forEach(function(t){if(t.type==="point"&&t.id!==l.selection.id&&!t.line&&!t.intercept)t.showSnap(true)})}l.geoms.push(e);l.listenToGeom(e);l.selection=e;l.drag_action=null}}else{this.selection=null;this.enableZoom(true)}};t.prototype.listenToGeom=function(t){var e=this;if(this.send_events){this.events.create_geom(gmath.extend(new h(t),{graph_id:e.id}))}if(t.is_linkable){t.link_events.on("link_start."+this.id,this.events.link_start.bind(this)).on("link_drag."+this.id,this.events.link_drag.bind(this)).on("link_end."+this.id,this.events.link_end.bind(this))}t.events.on("remove",function(t){if(e.send_events){e.events.remove_geom(gmath.extend(t,{graph_id:e.id}))}})};t.prototype.release=function(t){this.dragging=false;var e=t||d3.event;if(!this.interactive)return;this.updateFingers([]);var i=e.finger.pos[0],n=e.finger.pos[1],r=this;this.geoms.forEach(function(t){if(t.type==="point")t.showSnap(false);if(r.selection&&r.selection.type==="point-slope"&&!t.line&&!t.intercept){if(t.distanceTo(i,n)<t.radius*2){t.setColor(r.selection.color);var e={graph:r,point_a:r.selection.point,point_b:t,color:r.selection.color},o=new gmath.ui.PPLine(r.geom_g.node(),e);r.selection.remove();for(var s=0;s<r.geoms.length;s++){if(r.geoms[s].id===r.selection.id)r.geoms.splice(s,1,o)}r.selected=o}}});if(this.selection){if(this.send_events){this.events.geom_attr(gmath.extend(new p(this.selection),{graph_id:this.id}))}this.selection.release();this.selection=null;this.enableZoom(true)}this.drag_action=null;if(this.pos0){this.pos0=null}if(this.send_events){var o=this.selection;if(o&&o.line)o=o.line;this.events.release(new s(this.id,e));this.events["end-of-interaction"]({type:"end-of-interaction",source:{type:"Graph",id:this.id,selection:o?o.summarize():null,selection_id:o?o.id:null},pos:gmath.deepCopy(this.pos),time:Date.now()})}};t.prototype.resize_touch=function(t){var e=t||d3.event;if(this.send_events)this.events.resize(new l(this.id,e,"touch"));this.touch0={x:e.finger.pos[0],y:e.finger.pos[1]};this.size0={width:this.size.width,height:this.size.height};this.pos0={x:this.pos.x,y:this.pos.y};this.svg_dims=this.getContainerDimensions();this.enableZoom(false)};t.prototype.resize=function(t){var e=t||d3.event;if(this.send_events)this.events.resize(new l(this.id,e,"drag"));if(!this.pos0){this.pos0={x:this.pos.x,y:this.pos.y}}this.hideMove();var i={x:e.finger.pos[0],y:e.finger.pos[1]},n={width:this.size0.width+(i.x-this.touch0.x),height:this.size0.height+(i.y-this.touch0.y)},r={x:this.pos0.x+(i.x-this.touch0.x)/2,y:this.pos0.y+(i.y-this.touch0.y)/2};if(n.width>=this.lims.min&&n.height>=this.lims.min&&n.width<=this.lims.max&&n.height<=this.lims.max&&n.width+this.margin*2<=this.svg_dims.width&&n.height+this.margin*2<=this.svg_dims.height){this.setSize(n);this.setPos(r)}};t.prototype.resize_release=function(t){var e=t||d3.event;if(this.send_events)this.events.resize(new l(this.id,e,"release"));this.enableZoom(true)};t.prototype.getClosest=function(t,e){var i=this.max_dist,n=null;this.geoms.forEach(function(r){var o=r.distanceTo(t,e);if(o<=i){if(n&&n.type==="point"&&n.line&&n.line===r&&o<20){i=o}else{i=o;n=r}}});return n};t.prototype.getContainerDimensions=function(){var t=this.container.node();while(t.tagName.toLowerCase()!=="svg"&&t.parentNode)t=t.parentNode;return t.getBoundingClientRect()};t.prototype.keepInContainer=function(){var t=this.pos.x,e=this.pos.y,i=this.size.width/2,n=this.size.height/2,r=this.legs_offset.width,o=this.legs_offset.height,s=this.move_offset,a=this.svg_dims.width,l=this.svg_dims.height,h=t<i+s+2?i+s+2:t+i+s+r+4>a?a-(i+r+s+4):t,p=e<n+s+2?n+s+2:e+n+s+o+4>l?l-(n+o+s+4):e;if(t!==h||e!==p)this.setPos({x:h,y:p},false)};var e=function(t){this.performee=t;this.performee_type="graph";this.type="moveTouch";this.time=Date.now()};var i=function(t,e){this.performee=t;this.performee_type="graph";this.type="move";this.time=Date.now();this.finger={pos:[e.finger.pos[0],e.finger.pos[1]],dx:e.finger.dx,dy:e.finger.dy}};var n=function(t,e){this.performee=t;this.performee_type="graph";this.type="touch";this.time=Date.now();this.finger={pos:[e.finger.pos[0],e.finger.pos[1]]}};var r=function(t,e){this.performee=t;this.performee_type="graph";this.type="drag";this.time=Date.now();this.finger={pos:[e.finger.pos[0],e.finger.pos[1]],dx:e.finger.dx,dy:e.finger.dy}};var o=function(t,e){this.performee=t;this.performee_type="graph";this.type="hold";this.time=Date.now();this.finger={pos:[e.finger.pos[0],e.finger.pos[1]]}};var s=function(t,e){this.performee=t;this.performee_type="graph";this.type="release";this.time=Date.now();this.finger={pos:[e.finger.pos[0],e.finger.pos[1]]}};var a=function(t,e){this.performee=t;this.performee_type="graph";this.type="zoom";this.time=Date.now();this.translate=[e.translate[0],e.translate[1]];this.scale=e.scale};var l=function(t,e,i){this.performee=t;this.performee_type="graph";this.type="resize";this.resize_type=i;this.time=Date.now();this.finger={pos:[e.finger.pos[0],e.finger.pos[1]],dx:e.finger.dx,dy:e.finger.dy}};var h=function(t){this.performee=t.id;this.performee_type=t.type;this.performee_object=t;this.type="graphElementCreate";this.time=Date.now()};t.GraphElementRemoveEvent=function(t){this.performee=t.id;this.performee_type=t.type;this.performee_object=t.summarize();this.type="graphElementRemove";this.time=Date.now()};var p=function(t){this.performee=t.line?t.line.id:t.id;this.performee_object=t.line?t.line:t;this.type="graphElementChange";this.time=Date.now()};t.GraphGeomEvent=p;var u=function(t,e){this.performee=t;this.performee_type="graph";this.type="mouseLocation";this.location=e;this.time=Date.now()};t.prototype.updateFingers=function(t,e){if(!this.finger_sel){this.finger_vis_start=Date.now();this.finger_sel=this.main_g.selectAll(".finger")}var i=this.finger_sel.data(t);if(!e){i.enter().append("circle").classed("finger",true).attr("r",25).style({stroke:"#4D4D4D","stroke-opacity":.5,fill:"#B2CAED","fill-opacity":.5})}if(this.pos0){var n=this.pos.x-this.pos0.x,r=this.pos.y-this.pos0.y}var o=this;i.attr("cx",function(t){return o.pos0?t.pos[0]-n:t.pos[0]}).attr("cy",function(t){return o.pos0?t.pos[1]-r:t.pos[1]});i.transition().ease("bounce").attr("r",17);var s=this.finger_vis_start;i.exit().transition().delay(Math.max(0,250-(Date.now()-s))).style("opacity",1e-4).remove();this.finger_sel=i.size()===0?null:i};t.prototype.summarizeElements=function(){var t=[];this.geoms.filter(function(t){return!t.line}).forEach(function(e){t.push(e.summarize())});return t};return t}();var pt=function(t){this.prototype.is_linkable=true;this.prototype.link_events=d3.dispatch("link_start","link_drag","link_end");this.prototype.startLinking=function(t){var i=t||d3.event;if(this.graph.send_events){this.graph.events["start-of-interaction"]({type:"start-of-interaction",source:{type:"Graph",id:this.graph.id,selection:this.summarize()},time:Date.now()});this.link_events.link_start(new e(this.graph.id,this,i))}var n=i.finger.pos[0],r=i.finger.pos[1],o=this.id;this.graph.enableZoom(false);this.graph.geoms.forEach(function(t){if(t.id!==o){t.dragging=true;t.updateLinkHandle()}});this.link=d3.select(this.container.node().parentNode).insert("g","#"+this.id+"_handle");this.link.append("line").style("stroke",this.color).style("stroke-width",this.width||2).style("stroke-linecap","round").attr({x1:this.link_handle.attr("cx"),y1:this.link_handle.attr("cy"),x2:n,y2:r});this.link.append("circle").attr({cx:n,cy:r,r:10}).style("fill","white").style("stroke",this.color).style("stroke-width",this.width||2)};this.prototype.linking=function(t){var e=t||d3.event;if(this.graph.send_events)this.link_events.link_drag(new i(this.graph.id,this,e));var n=e.finger.pos[0],r=e.finger.pos[1];this.graph.showMove();this.link.select("line").attr({x2:n,y2:r});this.link.select("circle").attr({cx:n,cy:r})};this.prototype.endLinking=function(t){var e=t||d3.event;if(this.graph.send_events)this.link_events.link_end(new n(this.graph.id,this,e));var i=e.finger.pos[0],r=e.finger.pos[1],o=i+this.graph.pos.x,s=r+this.graph.pos.y,a=null,l="canvas",h=this.id;this.graph.view.graphs().forEach(function(t){if(t.inBounds(o,s)){a=t;l="graph"}});this.graph.view.dls().forEach(function(t){var e=t.pos.x,i=e+t.size.width,n=t.pos.y,r=n+t.size.height;if(o>e&&o<i&&s>n&&s<r){a=t;l="derivation"}});if(l==="canvas"){this.createDLFromGeom([o,s])}this.graph.enableZoom(true);this.graph.geoms.forEach(function(t){if(t.id!==h){t.updateLinkHandle();t.dragging=false}});this.graph.hideMove();this.link.remove();this.link=null;if(this.graph.send_events){this.graph.events["start-of-interaction"]({type:"end-of-interaction",source:{type:"Graph",id:this.graph.id,selection:this.summarize()},time:Date.now()})}};var e=function(t,e,i){this.performee=e.id;this.performee_type=e.type;this.graph_id=t;this.type="linkStart";this.time=Date.now();this.finger={pos:[i.finger.pos[0],i.finger.pos[1]]}};var i=function(t,e,i){this.performee=e.id;this.performee_type=e.type;this.graph_id=t;this.type="linkDrag";this.time=Date.now();this.finger={pos:[i.finger.pos[0],i.finger.pos[1]]}};var n=function(t,e,i){this.performee=e.id;this.performee_type=e.type;this.graph_id=t;this.type="linkEnd";this.time=Date.now();this.finger={pos:[i.finger.pos[0],i.finger.pos[1]]}}};if(typeof module==="object"&&module.exports){module.exports=pt}gmath.ui=gmath.ui||{};gmath.ui.SILine=function(){var t=function(t,e){var e=e||{};this.events=d3.dispatch("slope","intercept","release","remove");this.container=d3.select(t);this.graph=e.graph;this.element=null;this.lock_element=null;this.id=e.id||gmath.uid();this.intercept=e.point;this.slope=e.slope||0;this.slope0=this.slope;this.color=e.color||"steelblue";this.width=e.width||2;this.type="slope-intercept";this.x_str=e.x_str||"x";this.y_str=e.y_str||"y";this.link_handle=null;this.link=null;this.dragging=false;this.init()};t.prototype.summarize=function(){return{type:"slope-intercept",id:this.id,point:gmath.deepCopy(this.intercept.pos),slope:this.slope}};t.prototype.toJSON=function(){return{id:this.id,type:"SILine",graph:this.graph.id,intercept:this.intercept,slope:this.slope,color:this.color,width:this.width}};t.prototype.setLocked=function(t){this.intercept.setLocked(t);if(this.locked!==t){this.locked=t;this.lock_element.style("opacity",t?.3:0)}};t.analyzeStructure=function(t,e){var i={val_b:null,node_b:null,val_m:null,node_m:null,y_node:null,x_node:null};if(!t.children[0].is_group("equals"))return false;var n=t.children[0].children[0],r=t.children[0].children[2];if(!(n.is_group("var")&&n.get_value()==="y"))return false;i.y_node=n;var o,s,l;if(r.is_group("sum")&&r.children.length>2)return false;if(r.is_group("sum")){l=true;o=r.children[0].children[1];s=r.children[1]}else{o=r;s=r}var p,u;if(o.is_group("product")){if(o.children.length>2)return false;p=o.children[0].children[1];u=o.children[1].children[1]}else if(h.is_var(o)||o.is_group("sign")&&h.is_var(o.children[1])){p=null;u=o}else if(o.is_group("sign")&&o.children[1].is_group("sign")){return false}else if(a.is_num(o)&&a.get_value(o)===0){if(!e)return false;p=o;u=null}else if(l){return false}else{o=null;p=null;u=null}if(u)i.x_node=u;if(p&&!a.is_num(p))return false;if(u){var c;if(u.is_group("sign")){c=u.children[1]}else{c=u}if(u.is_group("power")||h.is_var(c)&&c.get_value()!=="x")return false}if(!l&&u){s=null}if(!a.get_value(s)&&a.get_value(s)!==0&&l)return false;if(u||p){if(p){if(u&&u.is_group("sign"))return false;i.val_m=l&&r.children[0].is_group("sub")?-a.get_value(p):a.get_value(p);i.node_m=p}else{i.val_m=u.is_group("sign")||u.parent.is_group("sub")?-1:1;i.node_m=null}}else{i.val_m=0;i.node_m=null}if(s){i.val_b=a.get_value(s);i.node_b=s}else{i.val_b=0;i.node_b=null}return i};t.prototype.linkToDL=function(e,i,n){var o=this,s=e.model,a=i,l=n,h=e.view;e.setHandleColor(this.color);var p=function(t,e){if(!t)return;if(t.selected!==e){t.selected=e;h.renderer.set_style([t]);h.update_existing("normal",true)}};var u=function(t,e){return function(){return p(t,e)}};var c=gmath.uid();var d=function(e){if(e.old_model!==s)throw"wrong old_model";if(e.new_model!==e.old_model){s.events.on("change."+c,null);s.events.on("end-of-interaction."+c,null);s=e.new_model;s.events.on("change."+c,d);s.events.on("end-of-interaction."+c,f)}var i=t.analyzeStructure(s,true);if(!i)return;if(a!==i.node_m){p(a,false);a=i.node_m}if(l!==i.node_b){p(l,false);l=i.node_b}var n=i.val_m;var r=i.val_b;if(n!==o.slope)o.setSlope(n);if(r!==o.intercept.pos.y)o.setIntercept({x:0,y:r})};var f=function(){o.release();o.intercept.release()};var g=e.dl;s.events.on("change."+c,d);s.events.on("end-of-interaction."+c,f);o.events.on("slope."+c,function(t){if(!a){var e=new r(o.toAsciiEq());s.replace_with(e);return}if(t!==s.numeric_value(a)){g.setActiveDLComponent("AV");s.numeric_value(a,t);p(a,true)}}).on("release."+c,function(){p(a,false);g.setActiveDLComponent("none");e.view.update_all();e.updateDimensionAfterInteraction(true)});o.intercept.events.on("y."+c,function(t){if(!l){var e=new r(o.toAsciiEq());s.replace_with(e);return}if(t!==s.numeric_value(l)){g.setActiveDLComponent("AV");s.numeric_value(l,t);p(l,true)}}).on("release."+c,function(){p(l,false);g.setActiveDLComponent("none");e.view.update_all();e.updateDimensionAfterInteraction(true)})};t.createGeomFromDL=function(e,i){var n=t.analyzeStructure(e.model);if(!n)return false;var r=n.node_m,o=n.node_b,s=n.val_m,a=n.val_b,l=n.y_node?n.y_node.to_ascii():"y",h=n.x_node?n.x_node.to_ascii():"x",p={graph:i,pos:{x:0,y:a},color:i.colors(i.geoms.length),intercept:true},u=new gmath.ui.Point(i.geom_g.node(),p);i.geoms.push(u);p={graph:i,point:u,slope:s,color:u.color,y_str:l,x_str:h};var c=new gmath.ui.SILine(i.geom_g.node(),p);c.graph.listenToGeom(c);i.geoms.push(c);c.linkToDL(e,r,o);gmath.LinkCoordinator.addLink({source:e.model,target:c,bidirectional:true});return true};t.createGeomPreviewFromDL=function(e,i){var n=t.analyzeStructure(e.model);if(!n)return false;var r=n.node_m,o=n.node_b,s=n.val_m,a=n.val_b,l=n.y_node?n.y_node.to_ascii():"y",h=n.x_node?n.x_node.to_ascii():"x",p=function(t){var e={graph:i,point:t,slope:s,color:"silver",y_str:l,x_str:h};return new gmath.ui.SILine(i.geom_g.node(),e)};return ft(0,a,true,p,i)};t.prototype.toAsciiEq=function(){var t=this.intercept.pos.y;return this.y_str+"="+this.slope+this.x_str+(t<0?"":"+")+t};t.prototype.createDLFromGeom=function(t){var e={eq:this.toAsciiEq(),pos:{x:t[0],y:t[1]},interaction_mode:"inspect"},i=this.graph.view.createDL(e,function(t){var e=t.options.pos,i=t.getLastRow().getHandlePos(),n={x:e.x-i[0],y:e.y-i[1]};t.translateElement(n)}),n=i.getLastRow().model,r=[0,2,0,1,0,1],o=[0,2,1],s=n.get_child(r),a=n.get_child(o);this.linkToDL(i.rows[0],s,a);gmath.LinkCoordinator.addLink({source:this,target:i.getLastModel(),bidirectional:true})};t.prototype.init=function(){this.element=this.container.insert("line","#"+this.intercept.id).attr("id",this.id).classed("SILine",true).style("fill","none").style("stroke",this.color).style("stroke-width",this.width).style("stroke-linecap","round");this.lock_element=this.container.insert("line","#"+this.id).style("fill","none").style("stroke","black").style("opacity",this.locked?.3:0).style("stroke-width",3*this.width).style("stroke-linecap","round");this.intercept.line=this;this.link_handle=d3.select(this.container.node().parentNode).append("circle").attr("id",this.id+"_handle").attr("r",10).attr("fill","white").style("stroke",this.color).style("stroke-width",this.width).style("visibility","hidden");var t=mtouch_events().frame(this.container.node().parentNode).on("touch",this.startLinking.bind(this,null)).on("drag",this.linking.bind(this,null)).on("release",this.endLinking.bind(this,null));this.link_handle.call(t);this.update()};t.prototype.setIntercept=function(t,e){this.intercept.setPos(t);this.update(e);this.events.intercept(t);return this};t.prototype.setSlope=function(t,e){this.slope=t;this.update(e);this.events.slope(t);return this};t.prototype.select=function(t,e){if(e)this.intercept.select(t);this.element.style("stroke",t?d3.rgb(this.color).brighter():this.color)};t.prototype.drag=function(t,e){if(!this.dragging){this.dragging=true;this.updateLinkHandle()}var i=t-this.graph.x_range(this.intercept.pos.x),n=-e- -this.graph.y_range(this.intercept.pos.y);if(i!==0)this.setSlope(n/i)};t.prototype.release=function(){this.dragging=false;this.updateLinkHandle();this.events.release()};t.prototype.distanceTo=function(t,e){var i=this.graph.x_range(this.intercept.pos.x),n=-this.graph.y_range(this.intercept.pos.y),r=this.graph.x_range(this.intercept.pos.x)+1,o=-this.graph.y_range(this.intercept.pos.y)+this.slope;return ct(i,n,r,o,t,-e)};t.prototype.remove=function(){this.element.remove();this.lock_element.remove();gmath.LinkCoordinator.unlinkElement(this);if(this.intercept.line.id===this.id)this.intercept.line=null;return this.id};t.prototype.removeGroup=function(){if(d3.event)this.events.remove(new gmath.ui.Graph.GraphElementRemoveEvent(this,this.graph.id));this.intercept.remove();this.element.remove();this.lock_element.remove();this.link_handle.remove();return[this.intercept.id,this.id]};t.prototype.update=function(t){if(t)this.element.transition().tween("line",this.tween.bind(this,null));else this.element.transition().duration(0).tween("line",this.tween.bind(this,null));return this};t.prototype.updateLinkHandle=function(){var t=this.graph.x_range,e=this.graph.y_range,i=this.element.attr("x2")*1,n=this.element.attr("y2")*1,r=i>=t.range()[0]&&i<=t.range()[1]&&n<=e.range()[0]&&n>=e.range()[1],o=r&&(this.graph.mouse_in_move&&!this.graph.mouse_in_evts&&!this.dragging||this.link);if(i===t.range()[1]){this.link_handle.attr({cx:i+17.5,cy:n})}else if(n>0){this.link_handle.attr({cx:i,cy:n+17.5})}else{this.link_handle.attr({cx:i,cy:n-17.5})}this.link_handle.style("visibility",o?"visible":"hidden")};t.prototype.tween=function(t){var e=t||this.element,i=this.lock_element,n=this.slope0,r=this.slope,o=this.graph.x_range,s=this.graph.y_range,a=this.intercept.pos.y,l=o.domain()[0],h=o.domain()[1],p=s.domain()[0],u=s.domain()[1],c=this;return function(t){var d=n+t*(r-n),f=ut(0,a,1,a+d,l,h,p,u);e.attr({x1:o(f[0].x),y1:s(f[0].y),x2:o(f[1].x),y2:s(f[1].y)});i.attr({x1:o(f[0].x),y1:s(f[0].y),x2:o(f[1].x),y2:s(f[1].y)});c.slope0=d}};return t}();pt.call(gmath.ui.SILine);function ut(t,e,i,n,r,o,s,a){var l={x:t,y:e},h={x:i,y:n},p=[l,h],u=l.y<h.y?[s,a]:[a,s],c=l.x<h.x?[r,o]:[o,r];if(l.x-h.x===0){return[{x:l.x,y:u[0]},{x:h.x,y:u[1]}]}else{var d=[],f=(l.y-h.y)/(l.x-h.x);p.forEach(function(t,e){var i=u[e],n=t.x-(t.y-i)/f;if(n<r||n>o){n=c[e];i=t.y-f*(t.x-n)}d.push({x:n,y:i})});return d}}function ct(t,e,i,n,r,o){var s=i-t,a=n-e;return Math.abs(a*r-s*o+i*e-n*t)/Math.sqrt(a*a+s*s)}gmath.ui=gmath.ui||{};gmath.ui.PPLine=function(){var t=function(t,e){var e=e||{};this.events=d3.dispatch("point_a","point_b","remove");this.container=d3.select(t);this.graph=e.graph;this.element=null;this.id=gmath.uid();this.point_a=e.point_a;this.point_b=e.point_b;this.color=e.color||"steelblue";this.width=e.width||2;this.type="point-point";this.link_handle=null;this.link=null;this.dragging=false;this.init()};t.prototype.toJSON=function(){return{id:this.id,type:"PPLine",graph:this.graph.id,point_a:this.point_a,point_b:this.point_b,color:this.color,width:this.width}};t.prototype.init=function(){this.element=this.container.insert("line","#"+this.point_a.id).attr("id",this.id).classed("PPLine",true).style("fill","none").style("stroke",this.color).style("stroke-width",this.width).style("stroke-linecap","round");this.point_a.line=this;this.point_b.line=this;this.update()};t.prototype.setPointA=function(t,e){this.point_a=t;this.update(e);this.events.point_a(t);return this};t.prototype.setPointB=function(t,e){this.point_b=t;this.update(e);this.events.point_b(t);return this};t.prototype.select=function(t,e){if(e){this.point_a.select(t);this.point_b.select(t)}this.element.style("stroke",t?d3.rgb(this.color).brighter():this.color)};t.prototype.drag=function(){};t.prototype.release=function(){};t.prototype.distanceTo=function(t,e){var i=this.graph.x_range(this.point_a.pos.x),n=-this.graph.y_range(this.point_a.pos.y),r=this.graph.x_range(this.point_b.pos.x),o=-this.graph.y_range(this.point_b.pos.y);return ct(i,n,r,o,t,-e)};t.prototype.remove=function(){this.element.remove();if(this.point_a.line.id===this.id)this.point_a.line=null;if(this.point_b.line.id===this.id)this.point_b.line=null;return this.id};t.prototype.removeGroup=function(){if(d3.event)this.events.remove(new gmath.ui.Graph.GraphElementRemoveEvent(this,this.graph.id));this.point_a.remove();this.point_b.remove();this.element.remove();return[this.point_a.id,this.point_b.id,this.id]};t.prototype.update=function(t){if(t)this.element.transition().tween("line",this.tween.bind(this,null));else this.element.transition().duration(0).tween("line",this.tween.bind(this,null));return this};t.prototype.updateLinkHandle=function(){};t.prototype.tween=function(){var t=this.element,e=this.graph.x_range,i=this.graph.y_range,n=this.point_a.pos.x,r=this.point_a.pos.y,o=this.point_b.pos.x,s=this.point_b.pos.y,a=e.domain()[0],l=e.domain()[1],h=i.domain()[0],p=i.domain()[1],u=this;return function(u){var c=ut(n,r,o,s,a,l,h,p);t.attr({x1:e(c[0].x),y1:i(c[0].y),x2:e(c[1].x),y2:i(c[1].y)})}};return t}();function ut(t,e,i,n,r,o,s,a){var l={x:t,y:e},h={x:i,y:n},p=[l,h],u=l.y<h.y?[s,a]:[a,s],c=l.x<h.x?[r,o]:[o,r];if(l.x-h.x===0){return[{x:l.x,y:u[0]},{x:h.x,y:u[1]}]}else{var d=[],f=(l.y-h.y)/(l.x-h.x);p.forEach(function(t,e){var i=u[e],n=t.x-(t.y-i)/f;if(n<r||n>o){n=c[e];i=t.y-f*(t.x-n)}d.push({x:n,y:i})});return d}}function ct(t,e,i,n,r,o){var s=i-t,a=n-e;return Math.abs(a*r-s*o+i*e-n*t)/Math.sqrt(a*a+s*s)}gmath.ui=gmath.ui||{};gmath.ui.PSLine=function(){var t=function(t,e){var e=e||{};this.events=d3.dispatch("slope","point","release","remove");this.container=d3.select(t);this.graph=e.graph;this.element=null;this.lock_element=null;this.id=gmath.uid();this.point=e.point;this.slope=e.slope||0;this.slope0=this.slope;this.color=e.color||"steelblue";this.width=e.width||2;this.type="point-slope";this.link_handle=null;this.link=null;this.dragging=false;this.init()};t.prototype.toJSON=function(){return{id:this.id,type:"PSLine",graph:this.graph.id,point:this.point,slope:this.slope,color:this.color,width:this.width}};t.prototype.summarize=function(){return{type:"point-slope",id:this.id,point:gmath.deepCopy(this.point.pos),slope:this.slope}};t.prototype.setLocked=function(t){this.point.setLocked(t);if(this.locked!==t){this.locked=t;this.lock_element.style("opacity",t?.3:0)}};t.analyzeStructure=function(t){var e={val_px:null,node_px:null,val_py:null,node_py:null,val_m:null,node_m:null,node_x:null,node_y:null};if(!t.children[0].is_group("equals"))return false;var i=t.children[0].children[0],n=t.children[0].children[2];if(!i.is_group("sum")||i.children.length>2)return false;var r=i.children[0],o=i.children[1];if(!(h.is_var(r.children[1])&&r.children[1].get_value()==="y"&&a.is_num(o.children[1])))return false;e.node_y=r;e.node_py=o;e.val_py=a.get_value(o);if(!n.is_group("product","fraction")||n.children.length>2)return false;r=n.children[0];o=n.children[1];if(!(a.is_num(r.children[1])&&o.children[1].is_group("brackets")))return false;e.node_m=r.children[1];e.val_m=a.get_value(r.children[1]);o=o.children[1];if(!o.children[1].is_group("sum")||o.children[1].children.length>2)return false;r=o.children[1].children[0];o=o.children[1].children[1];if(!(h.is_var(r.children[1])&&r.children[1].get_value()==="x"&&a.is_num(o.children[1])))return false;e.node_x=r;e.node_px=o;e.val_px=a.get_value(o);return e};t.prototype.linkToDL=function(e,i,n,r){var o=this,s=e.model,a=i,l=n,h=r,p=e.view;e.setHandleColor(this.color);var u=function(t,e){if(!t)return;if(t.selected!==e){t.selected=e;p.renderer.set_style([t]);p.update_existing("normal",true)}};var c=function(t,e){return function(){
return u(t,e)}};var d=gmath.uid();var f=function(e){if(e.old_model!==s)throw"wrong old_model";if(e.new_model!==e.old_model){s.events.on("change."+d,null);s.events.on("end-of-interaction."+d,null);s=e.new_model;s.events.on("change."+d,f);s.events.on("end-of-interaction."+d,g)}var i=t.analyzeStructure(s);if(!i)return;if(a!==i.node_m){u(a,false);a=i.node_m}if(l!==i.node_px){u(l,false);l=i.node_px}if(h!==i.node_py){u(h,false);h=i.node_py}var n=i.val_m,r=i.val_px*-1,p=i.val_py*-1;if(n!==o.slope)o.setSlope(n);if(r!==o.point.pos.x)o.setPoint({x:r,y:o.point.pos.y});if(p!==o.point.pos.y)o.setPoint({x:o.point.pos.x,y:p})};var g=function(){o.release();o.point.release()};var m=e.dl;s.events.on("change."+d,f);s.events.on("end-of-interaction."+d,g);o.events.on("slope."+d,function(t){if(t!==s.numeric_value(a)){m.setActiveDLComponent("AV");s.numeric_value(a,t);u(a,true)}}).on("release."+d,function(){u(a,false);m.setActiveDLComponent("none");e.view.update_all();e.updateDimensionAfterInteraction(true)});o.point.events.on("x."+d,function(t){if(t!==s.numeric_value(l)){m.setActiveDLComponent("AV");s.numeric_value(l,t*-1);u(l,true)}}).on("release."+d,function(){u(l,false);u(h,false);m.setActiveDLComponent("none");e.view.update_all();e.updateDimensionAfterInteraction(true)});o.point.events.on("y."+d,function(t){if(t!==s.numeric_value(h)){m.setActiveDLComponent("AV");s.numeric_value(h,t*-1);u(h,true)}}).on("release."+d,function(){u(h,false);u(l,false);m.setActiveDLComponent("none");e.view.update_all();e.updateDimensionAfterInteraction(true)})};t.createGeomFromDL=function(e,i){var n=t.analyzeStructure(e.model);if(!n)return false;var r=n.node_m,o=n.node_px,s=n.node_py,a=n.val_m,l=n.val_px*-1,h=n.val_py*-1,p={graph:i,pos:{x:l,y:h},color:i.colors(i.geoms.length)},u=new gmath.ui.Point(i.geom_g.node(),p);i.geoms.push(u);p={graph:i,point:u,slope:a,color:u.color};var c=new gmath.ui.PSLine(i.geom_g.node(),p);i.geoms.push(c);c.linkToDL(e,r,o,s);gmath.LinkCoordinator.addLink({source:e.model,target:c,bidirectional:true});c.graph.listenToGeom(c);return true};t.createGeomPreviewFromDL=function(e,i){var n=t.analyzeStructure(e.model);if(!n)return false;var r=n.node_m,o=n.node_px,s=n.node_py,a=n.val_m,l=n.val_px*-1,h=n.val_py*-1,p=function(t){var e={graph:i,point:t,slope:a,color:"silver"};return new gmath.ui.PSLine(i.geom_g.node(),e)};return ft(l,h,false,p,i)};t.prototype.createDLFromGeom=function(t){var e=this.slope,i=this.point.pos.x,n=this.point.pos.y,r=i<=0?"+"+i*-1+"":"-"+i+"",o=n<=0?"+"+n*-1+"":"-"+n+"",s={eq:"y"+o+"="+e+"*(x"+r+")",pos:{x:t[0],y:t[1]},interaction_mode:"inspect"},a=this.graph.view.createDL(s,function(t){var e=t.options.pos,i=t.getLastRow().getHandlePos(),n={x:e.x-i[0],y:e.y-i[1]};t.translateElement(n)}),l=a.getLastModel(),h=[0,2,0,1],p=[0,2,1,1,1,1,1],u=[0,0,1,1],c=l.get_child(h),d=l.get_child(p),f=l.get_child(u);this.linkToDL(a.rows[0],c,d,f);gmath.LinkCoordinator.addLink({source:this,target:a.getLastModel(),bidirectional:true})};t.prototype.init=function(){this.element=this.container.insert("line","#"+this.point.id).attr("id",this.id).classed("PSLine",true).style("fill","none").style("stroke",this.color).style("stroke-width",this.width).style("stroke-linecap","round");this.lock_element=this.container.insert("line","#"+this.id).style("fill","none").style("stroke","black").style("opacity",this.locked?.3:0).style("stroke-width",3*this.width).style("stroke-linecap","round");this.link_handle=d3.select(this.container.node().parentNode).append("circle").attr("id",this.id+"_handle").attr("r",10).attr("fill","white").style("stroke",this.color).style("stroke-width",this.width).style("visibility","hidden");var t=mtouch_events().frame(this.container.node().parentNode).on("touch",this.startLinking.bind(this,null)).on("drag",this.linking.bind(this,null)).on("release",this.endLinking.bind(this,null));this.link_handle.call(t);this.point.line=this;this.update()};t.prototype.setPoint=function(t,e){this.point.setPos(t);this.update(e);this.events.point(t);return this};t.prototype.setSlope=function(t,e){this.slope=t;this.update(e);this.events.slope(t);return this};t.prototype.select=function(t,e){if(e)this.point.select(t);this.element.style("stroke",t?d3.rgb(this.color).brighter():this.color)};t.prototype.drag=function(t,e){if(!this.dragging){this.dragging=true;this.updateLinkHandle()}var i=t-this.graph.x_range(this.point.pos.x),n=-e- -this.graph.y_range(this.point.pos.y);if(i!==0)this.setSlope(n/i)};t.prototype.release=function(){this.dragging=false;this.updateLinkHandle();this.events.release()};t.prototype.distanceTo=function(t,e){var i=this.graph.x_range(this.point.pos.x),n=-this.graph.y_range(this.point.pos.y),r=this.graph.x_range(this.point.pos.x)+1,o=-this.graph.y_range(this.point.pos.y)+this.slope;return ct(i,n,r,o,t,-e)};t.prototype.remove=function(){this.element.remove();this.lock_element.remove();gmath.LinkCoordinator.unlinkElement(this);if(this.point.line.id===this.id)this.point.line=null;return this.id};t.prototype.removeGroup=function(){if(d3.event)this.events.remove(new gmath.ui.Graph.GraphElementRemoveEvent(this,this.graph.id));this.point.remove();this.element.remove();this.lock_element.remove();this.link_handle.remove();return[this.point.id,this.id]};t.prototype.update=function(t){if(t)this.element.transition().tween("line",this.tween.bind(this,null));else this.element.transition().duration(0).tween("line",this.tween.bind(this,null));return this};t.prototype.updateLinkHandle=function(){var t=this.graph.x_range,e=this.graph.y_range,i=this.element.attr("x2")*1,n=this.element.attr("y2")*1,r=i>=t.range()[0]&&i<=t.range()[1]&&n<=e.range()[0]&&n>=e.range()[1],o=r&&(this.graph.mouse_in_move&&!this.graph.mouse_in_evts&&!this.dragging||this.link);if(i===t.range()[1]){this.link_handle.attr({cx:i+17.5,cy:n})}else if(n>0){this.link_handle.attr({cx:i,cy:n+17.5})}else{this.link_handle.attr({cx:i,cy:n-17.5})}this.link_handle.style("visibility",o?"visible":"hidden")};t.prototype.tween=function(t){var e=t||this.element,i=this.lock_element,n=this.slope0,r=this.slope,o=this.graph.x_range,s=this.graph.y_range,a=this.point.pos.x,l=this.point.pos.y,h=o.domain()[0],p=o.domain()[1],u=s.domain()[0],c=s.domain()[1],d=this;return function(t){var f=n+t*(r-n),g=ut(a,l,a+1,l+f,h,p,u,c);e.attr({x1:o(g[0].x),y1:s(g[0].y),x2:o(g[1].x),y2:s(g[1].y)});i.attr({x1:o(g[0].x),y1:s(g[0].y),x2:o(g[1].x),y2:s(g[1].y)});d.slope0=f}};return t}();pt.call(gmath.ui.PSLine);function ut(t,e,i,n,r,o,s,a){var l={x:t,y:e},h={x:i,y:n},p=[l,h],u=l.y<h.y?[s,a]:[a,s],c=l.x<h.x?[r,o]:[o,r];if(l.x-h.x===0){return[{x:l.x,y:u[0]},{x:h.x,y:u[1]}]}else{var d=[],f=(l.y-h.y)/(l.x-h.x);p.forEach(function(t,e){var i=u[e],n=t.x-(t.y-i)/f;if(n<r||n>o){n=c[e];i=t.y-f*(t.x-n)}d.push({x:n,y:i})});return d}}function ct(t,e,i,n,r,o){var s=i-t,a=n-e;return Math.abs(a*r-s*o+i*e-n*t)/Math.sqrt(a*a+s*s)}gmath.ui=gmath.ui||{};gmath.ui.ARLine=function(){var t=function(t,e){var e=e||{};this.container=d3.select(t);this.graph=e.graph;this.element=null;this.id=gmath.uid();this.color=e.color||this.graph.colors(this.graph.geoms.length);this.width=e.width||2;this.type="arbitrary";this.expression=e.expression;this.init()};t.validSourceDL=function(t){var e=t.model.children[0];if(!e.is_group("equals"))return false;var i=e.children[0],n=e.children[2];if(!i.is_group("var"))return false;var r=i.value,o=null;return n.filter(function(t){return t.is_group("var")}).every(function(t){if(!o)o=t.value;return t.value===o&&t.value!==r})};t.prototype.linkToDL=function(t){var e=this,i=t.model,n=gmath.uid();i.events.on("change."+n,function(){e.expression=i.children[0].children[2];e.update()})};t.createGeomFromDL=function(e,i){if(!t.validSourceDL(e))return false;var n={graph:i,expression:e.model.children[0].children[2]},r=new gmath.ui.ARLine(i.geom_g.node(),n);i.geoms.push(r);r.linkToDL(e);return true};t.createGeomPreviewFromDL=function(e,i){if(!t.validSourceDL(e))return false;var n={graph:i,expression:e.model.children[0].children[2],color:"silver"},r=new gmath.ui.ARLine(i.geom_g.node(),n);return function(){if(r)r.remove()}};t.prototype.init=function(){this.element=this.container.append("g","#"+this.id).attr("id",this.id).classed("ARLine",true);this.update()};t.prototype.update=function(){var t=this;function e(e,i,n){var r=(Math.abs(e)+Math.abs(i))/n;for(var o=e;o<i;o+=r){var s=o,a=o+r,l=dt(t.expression,null,s),h=dt(t.expression,null,a);t.element.append("line").attr({x1:t.graph.x_range(s),x2:t.graph.x_range(a),y1:t.graph.y_range(l),y2:t.graph.y_range(h)}).style("stroke",t.color).style("stroke-width",t.width).style("stroke-linecap","round")}}this.element.selectAll("line").remove();var i=this.graph.x_range.domain(),n=this.graph.x_range.range();e(i[0],i[1],n[1]-n[0]+1)};t.prototype.updateLinkHandle=function(){};t.prototype.distanceTo=function(){};t.prototype.remove=function(){this.element.remove()};return t}();function dt(t,e,i){fn=function(t){if(!t)return NaN;if(a.is_num(t))return a.get_value(t);if(t.is_group("var")&&(!e||t.value===e))return i;if(t.is_group("mul","add","brackets"))return fn(t.children[1]);if(t.is_group("sign","sub"))return-fn(t.children[1]);if(t.is_group("div"))return 1/fn(t.children[1]);if(t.is_group("exponent"))return fn(t.children[0]);if(t.value==="//")return 1;var n=function(t,e){return t+e},r=function(t,e){return t*e};if(t.is_group("product","fraction"))return t.children.map(fn).reduce(r,1);if(M.Trig.is_trig_func(t))return M.Trig.evaluate(t);if(t.is_group("sum"))return t.children.map(fn).reduce(n,0);if(t.is_group("power"))return Math.pow(fn(t.children[0]),fn(t.children[1]));return NaN};return fn(t)}gmath.ui=gmath.ui||{};gmath.ui.Link=function(){var t=function(){var t=d3.dispatch(),e=null,i=null,n=null,r=null,o=null,s=null,a=null;var l=function(t,n){e=d3.select(t);i=n;h();return this};l.container=function(t){if(arguments.length===0)return e;e=t;return this};l.model=function(t){if(arguments.length===0)return i;i=t;return this};l.a=function(t){if(arguments.length===0)return n;n=t;return this};l.b=function(t){if(arguments.length===0)return o;o=t;return this};l.update_el=function(){if(!n||!o)return;var t=p(n),e=p(o);t[0]+=n.width/2;t[1]-=n.y;e[0]+=o.width/2;e[1]-=o.y;a.attr("d",function(){var i=Math.random()>.5?1:-1;return"M "+t[0]+" "+t[1]+" "+"Q "+(t[0]+e[0])/2+" "+((t[1]+e[1])/2+Math.random()*300*i)+" "+e[0]+" "+e[1]})};l.show=function(t){a.style("visibility",t?"visible":"hidden")};l.link=function(){var t=n.get_root(),e=o.get_root(),i=gmath.uid(),r=gmath.uid();t.events.on("node-changed."+i,function(i){if(l.a().id===i.node.id){n=i.new_node;e.numeric_value(l.b(),t.numeric_value(l.a()))}});e.events.on("node-changed."+r,function(i){if(l.b().id===i.node.id){o=i.new_node;t.numeric_value(l.a(),e.numeric_value(l.b()))}})};l.unlink=function(){n.get_root().events.on("node-changed."+r,function(){return});o.get_root().events.on("node-changed."+s,function(){return})};var h=function(){a=e.append("path").attr("stroke","orange").attr("stroke-width","4px").attr("stroke-linecap","round").attr("fill","none").style("opacity",.5)};var p=function(t){var e=[0,0];if(t.children.length>0){t.children.forEach(function(t){var i=p(t);e[0]+=i[0];e[1]+=i[1]});e[0]=e[0]/t.children.length;e[1]=e[1]/t.children.length}else{var i=d3.select("#"+t.id);while(i.node().tagName!=="svg"){var n=d3.transform(i.attr("transform"));e[0]+=n.translate[0];e[1]+=n.translate[1];i=d3.select(i.node().parentNode)}}return e};return d3.rebind(l,t,"on")};return t}();gmath.ui=gmath.ui||{};gmath.ui.Point=function(){var t=function(t,e){this.events=d3.dispatch("x","y","release","remove");this.container=d3.select(t);this.graph=e.graph;this.id=e.id||gmath.uid();this.element=null;this.pos=e.pos||{x:0,y:0};this.radius=e.radius||4;this.color=e.color||"black";this.type="point";this.intercept=e.intercept||false;this.line=null;this.snap_el=null;this.show_snap=false;this.locked=false;this.link_handle=null;this.link=null;this.dragging=false;this.init()};t.prototype.summarize=function(){return{type:"point",id:this.id,point:gmath.deepCopy(this.pos)}};t.prototype.toJSON=function(){return{id:this.id,type:"Point",graph:this.graph.id,pos:this.pos,radius:this.radius,color:this.color,intercept:this.intercept}};t.prototype.setLocked=function(t){if(this.locked!==t){this.locked=t;this.update()}};t.validSourceDL=function(t){var e=t.model.children[0];if(e.is_group("brackets")){e=e.children[1];if(e.is_group("tuple")){var i=e.children[0],n=e.children[1];if(i.is_group("param")&&n.is_group("param")){i=i.children[1];n=n.children[1];if(a.is_num(i)&&a.is_num(n)){return true}}}}return false};t.prototype.linkToDL=function(t,e,i){var n=this,r=t.model,o=e,s=i,a=t.view;t.setHandleColor(this.color);var l=function(t,e){if(t.selected!==e){t.selected=e;a.renderer.set_style([t]);a.update_existing("normal",true)}};var h=function(t,e){return function(){return l(t,e)}};var p=gmath.uid();var u=function(t){if(t.old_model!==r)throw"wrong old_model";if(t.new_model!==t.old_model){r.events.on("change."+p,null);r.events.on("end-of-interaction."+p,null);r=t.new_model;r.events.on("change."+p,u);r.events.on("end-of-interaction."+p,c)}var e=o,i=s;o=t.node_map[o.id][0];s=t.node_map[s.id][0];if(e!==o)l(e,false);if(i!==s)l(i,false);var a=0;if(n.intercept){r.numeric_value(o,0)}else{a=r.numeric_value(o)}var h=r.numeric_value(s);if(a!==n.pos.x)n.setPos({x:a,y:n.pos.y});if(h!==n.pos.y)n.setPos({x:n.pos.x,y:h})};var c=function(){n.release()};r.events.on("change."+p,u);r.events.on("end-of-interaction."+p,c);var d=t.dl;n.events.on("x."+p,function(t){if(t!==r.numeric_value(o)){r.numeric_value(o,t);l(o,true);d.setActiveDLComponent("AV")}}).on("y."+p,function(t){if(t!==r.numeric_value(s)){r.numeric_value(s,t);l(s,true);d.setActiveDLComponent("AV")}}).on("release."+p,function(){l(o,false);l(s,false);d.setActiveDLComponent("none");t.updateDimensionAfterInteraction(true)})};t.createGeomFromDL=function(e,i){if(!t.validSourceDL(e))return false;var n=e.model,r=[0,1,0,1],o=[0,1,1,1],s=n.get_child(r),a=n.get_child(o),l=n.numeric_value(s),h=n.numeric_value(a),p={graph:i,pos:{x:l,y:h},color:i.colors(i.geoms.length),intercept:l===0?true:false},u=new gmath.ui.Point(i.geom_g.node(),p);u.graph.listenToGeom(u);i.geoms.push(u);u.linkToDL(e,s,a);gmath.LinkCoordinator.addLink({source:e.model,target:u,bidirectional:true});return true};t.createGeomPreviewFromDL=function(e,i){if(!t.validSourceDL(e))return false;var n=e.model,r=[0,1,0,1],o=[0,1,1,1],s=n.get_child(r),a=n.get_child(o),l=n.numeric_value(s),h=n.numeric_value(a);return ft(l,h,h===0,null,i)};t.prototype.createDLFromGeom=function(t){if(this.line){this.line.createDLFromGeom(t)}else{var e=this.pos.x,i=this.pos.y,n={eq:"("+e+","+i+")",pos:{x:t[0],y:t[1]},interaction_mode:"inspect"},r=this.graph.view.createDL(n,function(t){var e=t.options.pos,i=t.getLastRow().getHandlePos(),n={x:e.x-i[0],y:e.y-i[1]};t.translateElement(n)}),o=r.getLastModel(),s=[0,1,0,1],a=[0,1,1,1],l=o.get_child(s),h=o.get_child(a);this.linkToDL(r.rows[0],l,h);gmath.LinkCoordinator.addLink({target:r.getLastModel(),source:this,bidirectional:true})}};t.prototype.init=function(){this.snap_el=this.container.append("circle").style("opacity",0);this.element=this.container.append("circle").attr("id",this.id);this.link_handle=d3.select(this.container.node().parentNode).append("circle").attr("id",this.id+"_handle").attr("r",10).attr("fill","white").style("stroke",this.color).style("stroke-width",2).style("visibility","hidden");var t=mtouch_events().frame(this.container.node().parentNode).on("touch",this.startLinking.bind(this,null)).on("drag",this.linking.bind(this,null)).on("release",this.endLinking.bind(this,null));this.link_handle.call(t);this.update()};t.prototype.setPos=function(t){if(t.x!==this.pos.x&&!this.intercept)this.events.x(t.x);if(t.y!==this.pos.y)this.events.y(t.y);this.pos=t;this.update();return this};t.prototype.setRadius=function(t){this.radius=t;this.update();return this};t.prototype.setColor=function(t){this.color=t;this.update();return this};t.prototype.select=function(t,e){if(this.intercept){this.element.style("stroke",t?d3.rgb(this.color).brighter():this.color)}else this.element.style("fill",t?d3.rgb(this.color).brighter():this.color);if(this.line&&e)this.line.select(t)};t.prototype.showSnap=function(t){if(t!==this.show_snap){this.show_snap=t;this.update()}};t.prototype.drag=function(t,e){if(!this.dragging){this.dragging=true;this.updateLinkHandle()}var i=this.intercept?0:this.graph.x_range.invert(this.graph.x_range(this.pos.x)+t),n=this.graph.y_range.invert(this.graph.y_range(this.pos.y)+e);this.setPos({x:i,y:n})};t.prototype.release=function(){this.dragging=false;this.updateLinkHandle();this.events.release()};t.prototype.distanceTo=function(t,e){var i=t-this.graph.x_range(this.pos.x),n=e-this.graph.y_range(this.pos.y),r=Math.sqrt(i*i+n*n);return Math.max(0,r-this.radius)};t.prototype.remove=function(){gmath.LinkCoordinator.unlinkElement(this);this.element.remove();return this.id};t.prototype.removeGroup=function(){if(this.line)return this.line.removeGroup();if(d3.event)this.events.remove(new gmath.ui.Graph.GraphElementRemoveEvent(this,this.graph.id));this.element.remove();return[this.id]};t.prototype.update=function(){this.snap_el.attr("cx",this.graph.x_range(this.pos.x)).attr("cy",this.graph.y_range(this.pos.y)).attr("r",this.radius*2).style("fill",this.color).style("opacity",this.show_snap?.3:0);this.element.attr("cx",this.graph.x_range(this.pos.x)).attr("cy",this.graph.y_range(this.pos.y)).attr("r",this.radius).style("fill",this.locked?"#bbb":this.intercept?"white":this.color).style("stroke",this.intercept||this.locked?this.color:"none");if(this.line)this.line.update();return this};t.prototype.updateLinkHandle=function(){var t=this.graph.x_range,e=this.graph.y_range,i=this.element.attr("cx")*1,n=this.element.attr("cy")*1,r=i>=t.range()[0]&&i<=t.range()[1]&&n<=e.range()[0]&&n>=e.range()[1],o=!this.line&&r&&(this.graph.mouse_in_move&&!this.graph.mouse_in_evts&&!this.dragging||this.link);this.link_handle.attr({cx:t.range()[1]+17.5,cy:n});this.link_handle.style("visibility",o?"visible":"hidden")};return t}();pt.call(gmath.ui.Point);function ft(t,e,i,n,r){var o=r.x_range.domain(),s=r.y_range.domain(),a={graph:r,pos:{x:t,y:e},color:"silver",intercept:i};if(t<=o[0]||t>=o[1]||e<=s[0]||e>=s[1]){var l=r.zoom.translate();r.zoom.translate([0,0]);r.zoomBehavior({translate:[0,0]});var h=r.x_range(t),p=r.y_range(e),u=-l[0],c=-l[1],d=40,f=(h-u)/d,g=(p-c)/d,m=0,v=null,_=null;r.zoom.translate(l);r.zoomBehavior({translate:l});interval=setInterval(function(){u+=f;c+=g;r.zoom.translate([-u,-c]);r.zoomBehavior({translate:[-u,-c]});m+=1;if(m===d){clearInterval(interval);interval=null;v=new gmath.ui.Point(r.geom_g.node(),a);if(n){_=n(v)}}},1);return function(t){if(interval){clearInterval(interval);interval=null;r.zoom.translate([0,0]);r.zoomBehavior({translate:[0,0]});r.zoom.translate([-h,-p]);r.zoomBehavior({translate:[-h,-p]})}if(v)v.remove();if(_)_.remove();if(t){r.zoom.translate([0,0]);r.zoomBehavior({translate:[0,0]});r.zoom.translate(l);r.zoomBehavior({translate:l})}}}else{v=new gmath.ui.Point(r.geom_g.node(),a);if(n){_=n(v)}return function(){if(v)v.remove();if(_)_.remove()}}}gmath.ui=gmath.ui||{};gmath.ui.Table=function(){var t=function(t,e,i,n){i=gmath.object.merged(GeoGebraCanvasElement.defaultOptions,i);CanvasElement.call(this,t,e,i);this.type="table";this.table_el=null;this.columns_row=null;this.columns_el=null;this.column_width=80;this.inputs_row=null;this.inputs_el=null;this.edit_el=null;this.remove_el=null;this.rows=[];this.rows_el=null;this.row_height=40;this.active_row=null;this.active_x=null;this.active_y=null;this.sel_y0=null;this.sel_y1=null;this.selected=null;this.dx_el=null;this.dy_el=null;this.slope_el=null;this.keyboard=null;this.target_row=null;this.target_col=null;this.graph=null;this.show=false;this.show_el=null;this.slope=null;this.intercept=null;this.x=function(t){return(t-this.intercept)/this.slope};this.y=function(t){return this.slope*t+this.intercept};this.x_pos=0;this.y_pos=this.column_width;this.initOptions(i);this.init(n)};gmath.inherit(CanvasElement,t);t.defaultOptions={type:"Table",margin:0,font_size:20,font_weight:"bold",resizable:{x:false,y:false},edit_mode_drag_box_width:-20};t.prototype.initOptions=function(e){e=e||{};var i=gmath.deepCopy(t.defaultOptions),n=gmath.object.extendExisting(i,e);this.options=gmath.extend(this.options,n)};t.prototype.getColumn=function(){return this.x_pos<=this.y_pos?"x":"y"};t.prototype.init=function(t){var e=this;this.table_el=this.element_div.append("div").classed("table",true).style("box-sizing","content-box").style("border","1px solid silver");this.columns_el=this.table_el.append("div").classed("table-columns",true).style("position","relative");this.columns_row=new gmath.ui.TableRow(this,this.columns_el,"x","y",0);this.columns_row.row_el.selectAll(".table-cell").style("background-color","gainsboro").style("cursor","move").style("cursor","grabbing");this.columns_row.row_el.selectAll(".table-input").style("background-color","gainsboro").style("pointer-events","none");function i(t){var i=e.columns_row[t+"_el"],n=t+"_pos",r=mtouch_events().frame(i.node()).on("touch",function(){e.setActiveRow();e.setColIndex(t)}).on("drag",function(){e[n]+=d3.event.dx;e[n]=Math.min(e.column_width,Math.max(0,e[n]));e.dragCol(t)}).on("release",function(){e[n]=e[n]<e.column_width/2?0:e.column_width;e["xy_pos".replace(t,"")]=e.column_width-e[n];var i=250;e.dragCol("x",i);e.dragCol("y",i);setTimeout(function(){e.setColIndex();e.setInputs();e.sortRows()},i)});i.call(r)}i("x");i("y");this.rows_el=this.table_el.append("div").classed("table-rows",true).style("position","relative");var n=mtouch_events().frame(this.rows_el.node()).on("touch",function(){e.sel_y0=d3.event.fingers[0].pos0[1];e.sel_y1=e.sel_y0}).on("drag",function(){if(e.inputs_row.is_selected)return;else if(e.active_row){if(e.active_row.is_editable)return;else e.setActiveRow()}e.sel_y1+=d3.event.dy;if(Math.abs(e.sel_y1-e.sel_y0)>10){e.selected=[];var t=e.rows[e.rows.length-1],i=null,n=e.rows[0],r=null;e.rows.forEach(function(o){var s=e.row_height*o.idx,a=s+e.row_height;if(s<=e.sel_y0&&a>=e.sel_y0||s<=e.sel_y1&&a>=e.sel_y1||s>=e.sel_y0&&a<=e.sel_y1||s>=e.sel_y1&&a<=e.sel_y0){e.selected.push(o);if(o.idx<=t.idx){t=o;i=s}if(o.idx>=n.idx){n=o;r=a}o.setSelected(true)}else{o.setSelected(false)}});var o=e.x_pos<e.y_pos,s=r-i;e.dx_el.style("left",(o?-40:e.column_width*2+10)+"px").style("text-align",o?"left":"right");e.dx_el.select("span").html(n.x-t.x);e.dx_el.select(".bracket.bar").style("left",(o?24:4)+"px");e.dy_el.style("left",(o?e.column_width*2+10:-40)+"px").style("text-align",o?"right":"left");e.dy_el.select("span").html(n.y-t.y);e.dy_el.select(".bracket.bar").style("left",(o?4:24)+"px");e.rows_el.selectAll(".range").style("top",i+"px").style("height",s+"px").style("line-height",s+"px").style("display","block");e.slope_el.select(".top.fraction").html(n.y-t.y);e.slope_el.select(".btm.fraction").html(n.x-t.x);e.slope_el.select(".val").html((n.y-t.y)/(n.x-t.x));e.slope_el.style("display","block");if(e.selected.length>0&&e.graph){e.show_el.style("display","block");e.toggleGraphElements(e.show)}}}).on("release",function(){e.sel_y0=null;e.sel_y1=null});this.rows_el.call(n);this.dx_el=this.rows_el.append("div").classed("range",true);this.dy_el=this.rows_el.append("div").classed("range",true);var r=this.rows_el.selectAll(".range").style("position","absolute").style("width","30px").style("display","none");r.append("span");r.append("div").classed("bracket bar",true).style("top","0px").style("width","2px").style("height","100%");var o=r.selectAll(".bracket.bar");o.append("div").classed("bracket end",true).style("top","0px");o.append("div").classed("bracket end",true).style("bottom","0px");this.rows_el.selectAll(".bracket").style("position","absolute").style("background-color","black");this.rows_el.selectAll(".bracket.end").style("left","-4px").style("width","10px").style("height","2px");this.slope_el=this.table_el.append("div").classed("slope",true).style("left",this.column_width*2+this.options.margin+30+"px").style("top",this.options.margin+"px").style("text-align","center").style("display","none");this.slope_el.append("div").classed("slope top formula",true).html("y<sub>2</sub> - y<sub>1</sub>");this.slope_el.append("div").classed("slope bar formula",true);this.slope_el.append("div").classed("slope btm formula",true).html("x<sub>2</sub> - x<sub>1</sub>");this.slope_el.append("div").classed("slope eq",true).style("left","60px");this.slope_el.append("div").classed("slope top fraction",true);this.slope_el.append("div").classed("slope bar fraction",true);this.slope_el.append("div").classed("slope btm fraction",true);this.slope_el.append("div").classed("slope eq",true).style("left","100px");this.slope_el.append("div").classed("slope val",true).style("left","120px").style("top","14px").style("width","20px");this.table_el.selectAll(".slope").style("position","absolute");this.slope_el.selectAll(".top").style("top","0px");this.slope_el.selectAll(".bar").style("top","28px").style("height","2px").style("background-color","black");this.slope_el.selectAll(".btm").style("top","28px");this.slope_el.selectAll(".eq").style("top","14px").style("width","20px").html("=");this.slope_el.selectAll(".formula").style("left","0px").style("width","60px");this.slope_el.selectAll(".fraction").style("left","80px").style("width","20px");this.edit_el=this.rows_el.append("i").classed("table-button",true).classed("glyphicon glyphicon-pencil",true).style("position","absolute").style("cursor","pointer").style("background-color","white").style("border","1px solid silver").style("border-radius","5px").style("text-align","center").style("display","none").on("click",function(){e.active_row.setEditable(true)});this.remove_el=this.rows_el.append("i").classed("table-button",true).classed("glyphicon glyphicon-trash",true).style("position","absolute").style("cursor","pointer").style("background-color","white").style("border","1px solid silver").style("border-radius","5px").style("text-align","center").style("display","none").on("click",function(){e.active_row.row_el.remove();var t=e.active_row.idx;e.rows.splice(t,1);e.rows.forEach(function(e){if(e.idx>t){e.idx--;e.update()}});e.update();e.setActiveRow();e.setInputs();e.sortRows();if(e.rows.length==1){e.slope=null;e.intercept=null;if(e.graph)e.setGraphLine()}});this.inputs_el=this.table_el.append("div").classed("table-inputs",true).style("position","relative");this.inputs_row=new gmath.ui.TableRow(this,this.inputs_el,0,this.y(0),0);this.inputs_row.row_el.selectAll(".table-input").style("color","silver");this.inputs_row.setEditable(true);this.inputs_row.events.on("focus",function(t){if(e.active_row||e.selected)e.setActiveRow();if(!e.keyboard.visible()){e.inputs_row.is_selected=true;e.active_x=e.inputs_row.x;e.active_y=e.inputs_row.y}if(e.target_row)e.target_row.setEditing(e.target_col,false);e.inputs_row.setEditing(t,true);e.target_row=e.inputs_row;e.target_col=t;e.connectAndShowKeyboard("")}).on("input",function(t){if(e.slope){var i=e.inputs_row;if(t=="x")i.y=e.y(i.x);else i.x=e.x(i.y);i.update()}});this.setInputs();this.keyboard=gmath.ui.Keyboard();this.update();if(t)t(this)};t.prototype.connectAndShowKeyboard=function(t){if(this.keyboard.visible())this.keyboard.visible(false);this.keyboard.latex(t).visible(true);this.keyboard.on("change."+this.id,function(t){this.target_row[this.target_col+"_in"].html(t);this.target_row.readInput(this.target_col)}.bind(this));this.keyboard.on("done."+this.id,function(){if(this.inputs_row.is_selected&&!(this.slope||this.hasInputs())){this.target_row.setEditing(this.target_col,false);this.target_col="xy".replace(this.target_col,"");this.target_row.setEditing(this.target_col,true);this.connectAndShowKeyboard("")}else{if(this.inputs_row.is_selected){this.addRow(this.inputs_row.x,this.inputs_row.y);this.setActiveRow();this.setInputs()}if(this.active_row&&this.active_row.is_editable){this.active_x=this.active_row.x;this.active_y=this.active_row.y;this.setActiveRow();this.setInputs();this.sortRows()}this.target_row.setEditing(this.target_col,false);this.target_row=null;this.target_col=null;this.keyboard.visible(false);this.disconnectKeyboard()}}.bind(this));this.keyboard.on("cancel."+this.id,function(){this.setActiveRow();this.disconnectKeyboard()}.bind(this))};t.prototype.unselect=function(){this.setActiveRow()};t.prototype.disconnectKeyboard=function(){this.keyboard.on("change."+this.id,null).on("done."+this.id,null).on("cancel."+this.id,null)};t.prototype.update=function(){var t=this.column_width*2,e=this.row_height*this.rows.length,i=e+this.row_height*2,n=this.options.margin*2;this.resizeElement({width:t+n,height:i+n});this.table_el.style("width",t+"px").style("height",i+"px").style("margin",this.options.margin+"px").style("font-size",this.options.font_size+"px").style("font-weight",this.options.font_weight);this.columns_el.style("width",t+"px").style("height",this.row_height+"px");this.inputs_el.style("width",t+"px").style("height",this.row_height+"px");this.edit_el.style("left",t+10+"px");this.remove_el.style("left",t+15+this.row_height+"px");if(this.graph)this.show_el.style("left",-this.row_height-10+"px");d3.selectAll(".table-button").style("width",this.row_height+"px").style("height",this.row_height+"px").style("font-size",this.row_height-15+"px").style("line-height",this.row_height+"px");this.rows_el.style("width",t+"px").style("height",e+"px")};t.prototype.setInputs=function(){this.inputs_row.x_in.html("");this.inputs_row.y_in.html("")};t.prototype.hasInputs=function(){if(this.inputs_row.x_in.html()=="")return false;if(this.inputs_row.y_in.html()=="")return false;return true};t.prototype.setButtonMode=function(t){this.edit_el.style("display",t=="selected"?"block":"none");this.remove_el.style("display",t=="selected"?"block":"none")};t.prototype.setColIndex=function(t){this.columns_row.setColIndex(t);this.inputs_row.setColIndex(t);this.rows.forEach(function(e){e.setColIndex(t)})};t.prototype.dragCol=function(t,e){e=e||0;this.columns_row.dragCol(t,e);this.inputs_row.dragCol(t,e);this.rows.forEach(function(i){i.dragCol(t,e)})};t.prototype.addRow=function(t,e){for(var i=0;i<this.rows.length;i++){var n=this.rows[i];if(n.x==t&&n.y==e){[".table-cell",".table-input"].forEach(function(t){n.row_el.selectAll(t).transition(150).style("background-color","gainsboro").delay(150).transition(200).style("background-color","white")});return}}var n=new gmath.ui.TableRow(this,this.rows_el,t,e,this.rows.length),r=this;n.events.on("click",function(){if(r.active_row!=n)r.setActiveRow(n)}).on("focus",function(t){if(r.active_row==n){if(r.target_row)r.target_row.setEditing(r.target_col,false);n.setEditing(t,true);r.target_row=n;r.target_col=t;r.connectAndShowKeyboard(n[t].toString())}}).on("input",function(t){if(r.slope){if(t=="x")n.y=r.y(n.x);else n.x=r.x(n.y);n.update()}});this.rows.push(n);this.setInputs();this.update();this.sortRows();if(!this.slope&&this.rows.length==2){var o=this.rows[1].y-this.rows[0].y,s=this.rows[1].x-this.rows[0].x;this.slope=o/s;this.intercept=this.rows[0].y-this.slope*this.rows[0].x;if(this.graph)this.setGraphLine()}};t.prototype.sortRows=function(){var t=this.getColumn(),e=0;this.rows.sort(function(e,i){return e[t]-i[t]});if(this.rows.every(function(t,e){return t.idx===e}))return;this.rows.forEach(function(t,i){t.idx=i;t.dragRow(400,40*e);e++})};t.prototype.setActiveRow=function(t){if(this.inputs_row.is_selected){this.inputs_row.x=this.active_x;this.inputs_row.y=this.active_y;this.inputs_row.setSelected(false);this.inputs_row.update()}else if(this.active_row){this.active_row.x=this.active_x;this.active_row.y=this.active_y;this.active_row.setSelected(false);this.active_row.setEditable(false);this.active_row.update()}else if(this.selected){this.selected.forEach(function(t){t.setSelected(false)});this.selected=null;this.rows_el.selectAll(".range").style("display","none");this.slope_el.style("display","none")}if(t){t.setSelected(true);var e=this.row_height*t.idx+"px";this.edit_el.style("top",e);
this.remove_el.style("top",e)}this.setButtonMode(t?"selected":null);this.active_row=t||null;this.active_x=t?t.x:null;this.active_y=t?t.y:null;this.setInputs();if(this.graph){this.show_el.style("display",t?"block":"none");if(this.show)this.toggleGraphElements(t?true:false)}};t.prototype.setGraph=function(t){var e=this;this.graph=t;this.setGraphLine();this.graph.ggbApplet.setVisible("a",false);this.graph.ggbApplet.setLabelVisible("g",true);this.graph.ggbApplet.setLabelStyle("g",2);this.graph.ggbApplet.setLabelVisible("h",true);this.graph.ggbApplet.setLabelStyle("h",2);this.graph.ggbApplet.evalCommand("p=false");this.graph.ggbApplet.evalCommand("r=false");this.show_el=t.element_div.append("i").classed("table-button",true).classed("glyphicon glyphicon-eye-open",true).style("position","absolute").style("top","0px").style("cursor","pointer").style("background-color","white").style("border","1px solid silver").style("border-radius","5px").style("text-align","center").style("display","none");var i=mtouch_events().frame(this.show_el.node()).on("tap",function(){e.show=!e.show;e.show_el.transition().style("background-color",e.show?"gold":"white");e.toggleGraphElements(e.show)});this.show_el.call(i);this.update()};t.prototype.setGraphLine=function(){this.graph.ggbApplet.evalCommand("m="+(this.slope?this.slope:"false"));this.graph.ggbApplet.evalCommand("b="+(this.intercept?this.intercept:"false"))};t.prototype.toggleGraphElements=function(t){this.graph.ggbApplet.setVisible("a",t);if(this.active_row){this.graph.ggbApplet.evalCommand("G=("+this.active_row.x+","+this.active_row.y+")");this.graph.ggbApplet.evalCommand("p="+t);this.graph.ggbApplet.evalCommand("r=false")}else if(this.selected){var e=this.selected[this.selected.length-1],i=this.selected[0];this.selected.forEach(function(t){if(t.idx<=e.idx)e=t;if(t.idx>=i.idx)i=t});this.graph.ggbApplet.evalCommand("A=("+e.x+","+e.y+")");this.graph.ggbApplet.evalCommand("B=("+i.x+","+i.y+")");this.graph.ggbApplet.evalCommand("r="+t);this.graph.ggbApplet.evalCommand("p=false")}};return t}();gmath.ui=gmath.ui||{};gmath.ui.TableRow=function(){var t=function(t,e,i,n,r){this.table=t;this.container=e;this.events=d3.dispatch("click","focus","input");this.row_el=null;this.idx=r;this.x=i;this.x_el=null;this.x_in=null;this.y=n;this.y_el=null;this.y_in=null;this.is_selected=false;this.is_editable=false;this.init()};t.prototype.init=function(){this.row_el=this.container.append("div").classed("table-row",true).style("position","absolute").style("left","0px");var t=this;function e(e){t[e+"_el"]=t.row_el.append("div").classed("table-cell",true).style("position","absolute").style("top","0px").style("box-sizing","border-box").style("border","1px solid silver").style("background-color","white").on("click",function(){t.events.click()});t[e+"_in"]=t[e+"_el"].append("span").classed("table-input",true).style("position","absolute").style("left","4px").style("top","4px").style("text-align","center").on("click",function(){if(t.is_editable)t.events.focus(e)})}e("x");e("y");this.setEditable(false);this.update()};t.prototype.update=function(){var t=this.table,e=this;this.dragRow(0,0);this.row_el.style("width",t.column_width*2+"px").style("height",t.row_height+"px");function i(i){e.dragCol(i,0);e[i+"_el"].style("width",t.column_width+"px").style("height",t.row_height+"px");e[i+"_in"].html(e[i]).style("width",t.column_width-10+"px").style("height",t.row_height-10+"px").style("line-height",t.row_height-10+"px")}i("x");i("y")};t.prototype.setSelected=function(t){this.row_el.selectAll(".table-cell").style("background-color",t?"gainsboro":"white");this.row_el.selectAll(".table-input").style("background-color",t&&!this.is_editable?"gainsboro":"white");this.is_selected=t};t.prototype.setEditable=function(t){var e=this.table.row_height-10;this.row_el.selectAll(".table-input").style("border",t?"1px solid silver":"none").style("line-height",t?e-1+"px":e+"px").style("background-color",!t&&this.is_selected?"gainsboro":"white");this.is_editable=t};t.prototype.setEditing=function(t,e){this[t+"_in"].style("border",e?"1px solid dodgerblue":this.is_editable?"1px solid silver":"none")};t.prototype.setColIndex=function(t){this.x_el.style("z-index",t=="x"?1:0);this.y_el.style("z-index",t=="y"?1:0)};t.prototype.dragCol=function(t,e){this[t+"_el"].transition().duration(e).style("left",this.table[t+"_pos"]+"px")};t.prototype.dragRow=function(t,e){if(t===0){this.row_el.style("top",this.table.row_height*this.idx+"px")}else{this.row_el.style("opacity",.75).transition().delay(e).duration(t).style("top",this.table.row_height*this.idx+"px").each("end",function(){d3.select(this).style("opacity",1)})}};t.prototype.readInput=function(t){var e=parseFloat(this[t+"_in"].html());if(!isNaN(e)){this[t]=e;this.events.input(t)}};return t}();gmath.ui=gmath.ui||{};gmath.ui.CanvasParser=function(){CanvasParser={};CanvasParser.parse=function(t,e){return JSON.parse(e,function(e,i){if(i&&i.type==="Graph")return CanvasParser.parseGraph(t,i);if(i&&i.type==="DerivationList")return CanvasParser.parseDL(t,i);else return i})};CanvasParser.parseDL=function(t,e){return t.model.createDL(e)};CanvasParser.parseGraph=function(t,e){var i=e.geoms;e.geoms=null;var n=t.model.createGraph(e);i.forEach(function(t){if(t.type==="Point")CanvasParser.parsePoint(n,t);else if(t.type==="SILine")CanvasParser.parseSILine(n,t)})};CanvasParser.parsePoint=function(t,e){e.graph=t;return t.addGeom(e.type,e)};CanvasParser.parseSILine=function(t,e){var i=CanvasParser.parsePoint(t,e.intercept);e.point=i;e.graph=t;var n=t.addGeom(e.type,e);i.line=n;return n};return CanvasParser}();TrialLogger=function(){this.trial=null;this.active_trials=[];this.events=d3.dispatch("start_trial","end_trial");this.experiment_id=null};gmath.TrialLogger=new TrialLogger;TrialLogger.prototype.addTrial=function(t,e){var i={id:gmath.uid(),idx:t||0,gm_version:gmath.version,gm_ui_version:gmath.ui.version,gm_ui_gm_version:gmath.ui.gm_version,experiment_id:this.experiment_id,time:Date.now()};gmath.extend(i,e);this.active_trials.push(i);return i};TrialLogger.prototype.startTrial=function(t,e){if(this.trial)this.endTrial();var i=this.addTrial(t,e);this.trial=i;this.events.start_trial(i)};TrialLogger.prototype.setCustomFields=function(t){gmath.extend(this.trial,t)};TrialLogger.prototype.endTrial=function(t){this.trial.duration=Date.now()-this.trial.time;if(t)this.setCustomFields(t);this.events.end_trial(this.trial);this.postTrial(this.trial);gmath.array.remove(this.active_trials,this.trial);this.trial=null};TrialLogger.prototype.resumeTrial=function(t){this.trial=gmath.find(this.active_trials,function(e){return e.id===t});this.events.start_trial(this.trial)};TrialLogger.prototype.postTrial=function(){if(gmath.ServerComm)gmath.ServerComm.postTrial(this.trial)};TrialLogger.prototype.postAllTrials=function(){if(gmath.ServerComm)gmath.ServerComm.postTrial(this.active_trials);this.active_trials=[]};ServerComm=function(){this.posting=false;this.trial_collection=null;this.data_collection=null;this.server_url="https://dlandy.psych.indiana.edu:7010"};gmath.ServerComm=new ServerComm;gmath.setupLogging=function(t){if(!t)t={};gmath.ServerComm.setExperimentID(t.experiment_id);gmath.ServerComm.setEnabled("enabled"in t?t.enabled:"auto");if(t.server)gmath.ServerComm.setServerUrl(t.server)};ServerComm.prototype.setExperimentID=function(t){if(typeof t!=="string")throw"Invalid experiment ID.";if(!t.match(/^\w+$/))throw"Invalid experiment ID.";this.trial_collection=t+"_trials";this.data_collection=t+"_data";gmath.TrialLogger.experiment_id=t};ServerComm.prototype.setServerUrl=function(t){this.server_url=t};ServerComm.prototype.setEnabled=function(t){if(!t)this.posting=false;else if(t==="auto")this.posting=gmath.log_ga?gmath.log_ga.enabled():true;else this.posting=true;console.info("interaction logging is",this.posting?"on":"off")};ServerComm.prototype.postTrial=function(t){if(!this.posting)return;this.postToServer(this.trial_collection,t)};ServerComm.prototype.postInteractions=function(t){if(!this.posting)return;this.postToServer(this.data_collection,t)};ServerComm.prototype.postToServer=function(t,e){if(!this.posting)return;var i=JSON.stringify(e);if(this.dataIsTooBig(i)){console.warn("Data chunk size is too big: not saved.");return}var n=new XMLHttpRequest;n.open("POST",this.server_url+"/log/"+t);n.setRequestHeader("Content-Type","application/json");n.onreadystatechange=function(){if(n.readyState==4&&n.status==200){}if(n.readyState==4&&n.status!==200){}};n.send(i)};ServerComm.prototype.dataIsTooBig=function(t){var e=gmath.byteLength(t);return e>5e4};DataLogger=function(t,e){this.id=gmath.uid();this.events=d3.dispatch("interaction");this.listening=true;this.log_mouse_trajectories=e;this.trial_id=null;this.canvas_logger=new CanvasLogger(this,t);this.canvas=t;gmath.TrialLogger.events.on("start_trial."+this.id,this.setTrialInfo.bind(this));if(gmath.TrialLogger.trial)this.setTrialInfo(gmath.TrialLogger.trial)};gmath.DataLogger=DataLogger;DataLogger.console_logs=false;DataLogger.interaction_id=1;DataLogger.prototype.setTrialInfo=function(t){if(t.id!==this.trial_id)DataLogger.interaction_id=1;this.trial_id=t.id};DataLogger.prototype.listen=function(t){this.listening=!!t};DataLogger.prototype.logInteractionWithEvents=function(t,e,i){if(!this.trial_id)this.createMissingTrial();t.trial_id=this.trial_id;t.interaction_id=DataLogger.interaction_id;t.canvas_id=this.canvas.id;e.forEach(function(t,e){t.trial_id=this.trial_id;t.interaction_id=DataLogger.interaction_id;t.within_interaction_id=e+1},this);if(i)e=i(e);if(DataLogger.console_logs)console.log(t,e);if(this.listening){this.emitReleventSummaryEvents([t]);gmath.ServerComm.postInteractions([t].concat(e))}DataLogger.interaction_id++};DataLogger.prototype.logInteraction=function(t){if(!this.trial_id)this.createMissingTrial();t.trial_id=this.trial_id;t.interaction_id=DataLogger.interaction_id++;t.canvas_id=this.canvas.id;if(DataLogger.console_logs)console.log(t);if(this.listening){this.emitReleventSummaryEvents([t]);gmath.ServerComm.postInteractions([t])}};DataLogger.prototype.logCustomInteraction=function(t,e){if(!this.trial_id)this.createMissingTrial();var i={trial_id:this.trial_id,interaction_id:DataLogger.interaction_id++,canvas_id:this.canvas.id,type:"custom",subtype:t,time:Date.now()};gmath.extend(i,e);if(DataLogger.console_logs)console.log(i);gmath.ServerComm.postInteractions([i])};DataLogger.prototype.createMissingTrial=function(){console.warn("Should start a trial before logging data! Auto-created a trial.");gmath.TrialLogger.startTrial();gmath.TrialLogger.postTrial()};DataLogger.prototype.emitReleventSummaryEvents=function(t){var e=t.filter(function(t){return t.type==="interaction"});if(e.length>0){this.events.interaction(e)}};DataLogger.prototype.simulateStartOfInteraction=function(t,e){var i={type:"start-of-interaction",source:t,time:Date.now()};if(e)i=gmath.extend(i,e);this.canvas_logger.startOfInteractionDetected(i)};DataLogger.prototype.simulateEndOfInteraction=function(t,e){var i={type:"end-of-interaction",source:t,time:Date.now()};if(e)i=gmath.extend(i,e);this.canvas_logger.endOfInteractionDetected(i)};CanvasLogger=function(t,e){this.data_logger=t;this.interactionSequence=[];this.dlLoggers=[];this.setupListeners(e)};CanvasLogger.prototype.startOfInteractionDetected=function(t){if(!this.data_logger.listening)return;if(t.source&&t.source.options&&t.source.options.dont_log_events)return;if(this.containsPendingEvents(this.interactionSequence)){this.submitCurrentSequence()}this.addEvent(t)};CanvasLogger.prototype.endOfInteractionDetected=function(t){if(!this.data_logger.listening)return;if(t.source&&t.source.options&&t.source.options.dont_log_events)return;this.addEvent(t);if(this.interactionSequence[0].source&&this.interactionSequence[0].source.type!==this.interactionSequence[this.interactionSequence.length-1].source.type)return;this.submitCurrentSequence()};CanvasLogger.prototype.addEvent=function(t){if(!this.data_logger.listening)return;if(t.source&&t.source.options&&t.source.options.dont_log_events)return;t.time=Date.now();t.date=(new Date).toString();if(t.source&&t.source.model&&t.source.model.to_ascii)t.source.model=t.source.model.to_ascii();this.interactionSequence.push(t)};CanvasLogger.prototype.submitCurrentSequence=function(){var t=this.summarizeInteractionSequence(this.interactionSequence);t.forEach(function(t){this.data_logger.logInteraction(t)},this);this.interactionSequence=[]};CanvasLogger.prototype.summarizeInteractionSequence=function(t){try{if(this.isNullSequence(t))return[];if(this.isMoveSequence(t))return this.summarizeMoveSequence(t);if(this.isResizeSequence(t))return this.summarizeResizeSequence(t);if(this.isCreateSequence(t))return this.summarizeCreateSequence(t);if(this.isGeometryCreateSequence(t))return this.summarizeGeometryCreateSequence(t);if(this.isDeleteSequence(t))return this.summarizeDeleteSequence(t);if(this.isGeometryDeleteSequence(t))return this.summarizeGeometryDeleteSequence(t);if(this.isDrawSequence(t))return this.summarizeDrawSequence(t);if(this.isEraseSequence(t))return this.summarizeEraseSequence(t);if(this.isNodeInspectSequence(t))return this.summarizeNodeInspectSequence(t);if(this.isGraphScrubSequence(t))return this.summarizeGraphScrubSequence(t);if(this.isPackSequence(t))return this.summarizePackSequence(t);if(this.isLinkSequence(t))return this.summarizeLinkSequence(t);if(this.isCloneSequence(t))return this.summarizeCloneSequence(t);if(this.isGraphPanSequence(t))return this.summarizeGraphPanSequence(t);if(this.isButtonSequence(t))return this.summarizeButtonSequence(t);if(this.isGraphZoomSequence(t))return this.summarizeGraphZoomSequence(t);if(this.isFontSizeSequence(t))return this.summarizeFontSizeSequence(t);if(this.isTextEditSequence(t))return this.summarizeTextEditSequence(t);console.warn("(CanvasLogger) Interaction did not match any defined interaction types.");this.interactionSequence=[];return[]}catch(t){console.warn("(CanvasLogger) Error when summarizing interaction sequence:",t);this.interactionSequence=[];return[]}};CanvasLogger.prototype.containsPendingEvents=function(t){return t.length?true:false};CanvasLogger.prototype.isDifferentInteraction=function(t,e){if(!t.length)return false;var i=false;if(e.element.id){i=i||t.some(function(t){if(!t.element||!t.element.id)return true;return t.element.id!==e.element.id})}if(e.type){i=i||t.some(function(t){if(!t.type)return true;return t.type!==e.type})}return i};CanvasLogger.prototype.setupListeners=function(t){this.registerToolbarListeners(t,this.canvasToolbarListener.bind(this));this.registerCanvasModelViewListeners(t.model,this.canvasModelViewListener.bind(this));this.registerCanvasControllerListeners(t.controller,this.canvasControllerListener.bind(this))};CanvasLogger.prototype.registerToolbarListeners=function(t,e){t.events.on("button."+this.session_id,e)};CanvasLogger.prototype.canvasToolbarListener=function(t){if(this.containsPendingEvents(this.interactionSequence)){this.submitCurrentSequence()}t.type="toolbar_button_press";this.addEvent(t);this.submitCurrentSequence()};CanvasLogger.prototype.registerCanvasModelViewListeners=function(t,e){var i=this;t.on("create."+this.session_id,e).on("remove."+this.session_id,e);var n=t.dls();n.forEach(function(t){i.setupListenersOnDL(t)});var r=t.graphs();r.forEach(function(t){i.setupListenersOnGraph(t)})};CanvasLogger.prototype.canvasModelViewListener=function(t){if(t.type==="create")this.objectCreationDetected(t);if(t.type==="remove")this.objectDeletionDetected(t)};CanvasLogger.prototype.registerCanvasControllerListeners=function(t,e){t.on("start-of-interaction."+this.session_id,e).on("end-of-interaction."+this.session_id,e)};CanvasLogger.prototype.canvasControllerListener=function(t){if(t.length)t=t[0];if(t.type==="start-of-interaction")this.startOfInteractionDetected(t);if(t.type==="end-of-interaction")this.endOfInteractionDetected(t)};CanvasLogger.prototype.objectCreationDetected=function(t){if(t.target&&t.target.options&&t.target.options.dont_log_events)return;if(t.target_type==="link")return;if(t.target_type==="derivation")this.setupListenersOnDL(t.target);if(t.target_type==="graph")this.setupListenersOnGraph(t.target);if(t.target_type==="textbox")this.setupListenersOnTextBox(t.target);var e={};e.type="GM_object_created_or_added";e.method=t.method;e.element={type:t.target_type,id:t.target.id};if(t.target_type==="derivation")e.element.new_state=t.target.options.eq;if(t.target_type==="textbox"&&t.target.text!==t.target.options.default_text)e.element.new_state=t.target.text;if(t.target_type==="image"&&t.target.options.url)e.element.new_state=t.target.options.url;this.addEvent(e);if(this.interactionSequence.length===1){this.submitCurrentSequence()}};CanvasLogger.prototype.objectDeletionDetected=function(t){if(t.target&&t.target.options&&t.target.options.dont_log_events)return;var e={};e.type="GM_object_removed";e.element={type:t.target_type,id:t.target.id,options:t.target.options?gmath.deepCopy(t.target.options):null};this.addEvent(e);if(this.interactionSequence.length===1){this.interactionSequence=[]}};CanvasLogger.prototype.setupListenersOnDL=function(t){this.registerListenersOnEvents(t.events,this.DLListener.bind(this));this.dlLoggers.push(new DLLogger(this.data_logger,t))};CanvasLogger.prototype.registerListenersOnEvents=function(t,e){t.on("inspect_node."+this.session_id,e).on("pack_state."+this.session_id,e)};CanvasLogger.prototype.DLListener=function(t){if(t.length)t=t[0];if(t.type==="inspect")this.nodeInspectionDetected(t);if(t.type==="packState")this.packStateDetected(t)};CanvasLogger.prototype.nodeInspectionDetected=function(t){var e={};e.type="node_inspected";e.element={type:"derivation",id:t.dl.id};e.inspection={row:t.row,model:t.dl.rows[t.row].model.to_ascii(),sel:t.node.get_root().getSelectorOfNodes([t.node]).join(";")};this.addEvent(e)};CanvasLogger.prototype.packStateDetected=function(t){var e={};e.type="derivation_list_pack_state_changed";e.element={type:"derivation",id:t.performee};e.state=t.packState;this.addEvent(e)};CanvasLogger.prototype.setupListenersOnGraph=function(t){this.registerListenersOnGraph(t,this.graphListener.bind(this))};CanvasLogger.prototype.registerListenersOnGraph=function(t,e){t.events.on("create_geom."+this.session_id,e).on("remove_geom."+this.session_id,e).on("geom_attr."+this.session_id,e).on("zoom."+this.session_id,e)};CanvasLogger.prototype.graphListener=function(t){if(t.type==="graphElementCreate"||t.type==="graphElementChange")this.graphElementDetected(t);if(t.type==="graphElementRemove")this.graphElementDeletionDetected(t);if(t.type==="zoom")this.graphPanZoomDetected(t)};CanvasLogger.prototype.graphElementDetected=function(t){var e={};e.type=t.type==="graphElementCreate"?"graph_element_created":"graph_element_changed";e.element={type:"graph",id:t.graph_id};var i=t.performee_object.summarize();delete i.id;delete i.type;e.graph_element={type:t.performee_type||t.performee_object.type,id:t.performee,attr:i};this.addEvent(e)};CanvasLogger.prototype.graphElementDeletionDetected=function(t){var e={};e.type="graph_element_removed";e.element={type:"graph",id:t.graph_id};e.graph_element={type:t.performee_type,id:t.performee,attr:t.performee_object};this.addEvent(e)};CanvasLogger.prototype.graphPanZoomDetected=function(t){var e={};e.type="graph_pan_zoom";e.element={type:"graph",id:t.performee,new_state:{pan:t.translate,zoom:t.scale}};if(this.isDifferentInteraction(this.interactionSequence,e)){this.submitCurrentSequence()}this.addEvent(e)};CanvasLogger.prototype.setupListenersOnTextBox=function(t){this.registerListenersOnTextBox(t,this.textboxListener.bind(this))};CanvasLogger.prototype.registerListenersOnTextBox=function(t,e){t.events.on("text."+this.session_id,e).on("font_size."+this.session_id,e)};CanvasLogger.prototype.textboxListener=function(t){if(t.type==="text"&&this.isDifferentInteraction(this.interactionSequence,t)||t.type==="font_size"&&this.containsPendingEvents(this.interactionSequence))this.submitCurrentSequence();this.addEvent(t);if(t.type==="font_size")this.submitCurrentSequence()};CanvasLogger.prototype.isNullSequence=function(t){if(t.every(function(t){return t.type==="start-of-interaction"&&t.source.type==="CanvasController"||t.type==="end-of-interaction"}))return true;if(t.every(function(t){return t.type==="start-of-interaction"&&t.source.type==="AlgebraModel"||t.type==="end-of-interaction"}))return true;if(t.every(function(t){return t.type==="start-of-interaction"&&t.source.type==="DerivationRow"||t.type==="end-of-interaction"}))return true;if(t.every(function(t){return t.type==="start-of-interaction"&&(t.source.type==="derivation"||t.source.type==="Graph"||t.source.type==="textbox")||t.type==="end-of-interaction"})&&(this.startAndEndPositionsAreTheSame(t)||this.startAndEndSizesAreTheSame(t)))return true;if(t.every(function(t){return t.type==="start-of-interaction"&&t.source.type==="Graph"&&t.subSource==="touch"||t.type==="end-of-interaction"}))return true;if(t.every(function(t){return t.type==="start-of-interaction"&&t.source.type==="DerivationRow"||t.type==="GM_object_created_or_added"&&t.element.type==="textbox"||t.type==="end-of-interaction"})&&t.some(function(t){return t.type==="start-of-interaction"}))return true;return false};CanvasLogger.prototype.startAndEndPositionsAreTheSame=function(t){var e=t[0],i=t[t.length-1];if(!e.pos||!i.pos)return false;var n=Array.isArray(e.pos)?e.pos:[e.pos.x,e.pos.y],r=Array.isArray(i.pos)?i.pos:[i.pos.x,i.pos.y];return n[0]===r[0]&&n[1]===r[1]};CanvasLogger.prototype.startAndEndSizesAreTheSame=function(t){var e=t[0],i=t[t.length-1];if(!e.size||!i.size)return false;return e.size.width===i.size.width&&i.size.height===i.size.height};CanvasLogger.prototype.isCreateSequence=function(t){return t.every(function(t){return t.type==="start-of-interaction"&&t.source.type==="CanvasController"||t.type==="GM_object_created_or_added"&&t.element.type!=="path"||t.type==="end-of-interaction"})};CanvasLogger.prototype.isGeometryCreateSequence=function(t){return t.every(function(t){return t.type==="start-of-interaction"&&t.source.type==="Graph"||t.type==="graph_element_created"||t.type==="graph_element_changed"||t.type==="end-of-interaction"})&&t.some(function(t){return t.type==="graph_element_created"})};CanvasLogger.prototype.isDeleteSequence=function(t){return t.every(function(t){return t.type==="start-of-interaction"||t.type==="GM_object_removed"&&t.element.type!=="path"||t.type==="node_inspected"||t.type==="end-of-interaction"})&&t.some(function(t){return t.type==="GM_object_removed"})};CanvasLogger.prototype.isGeometryDeleteSequence=function(t){return t.every(function(t){return t.type==="start-of-interaction"&&t.source.type==="Graph"||t.type==="graph_element_removed"||t.type==="graph_element_changed"||t.type==="end-of-interaction"})&&t.some(function(t){return t.type==="graph_element_removed"})};CanvasLogger.prototype.isDrawSequence=function(t){return t.every(function(t){return t.type==="start-of-interaction"&&t.source.type==="CanvasController"||t.type==="GM_object_created_or_added"&&t.element.type==="path"||t.type==="end-of-interaction"})};CanvasLogger.prototype.isEraseSequence=function(t){return t.every(function(t){return t.type==="start-of-interaction"&&t.source.type==="CanvasController"||t.type==="GM_object_created_or_added"||t.type==="GM_object_removed"&&t.element.type==="path"||t.type==="end-of-interaction"})};CanvasLogger.prototype.isNodeInspectSequence=function(t){return t.every(function(t){return t.type==="start-of-interaction"&&t.source.type==="AlgebraModel"||t.type==="node_inspected"||t.type==="end-of-interaction"})};CanvasLogger.prototype.isGraphScrubSequence=function(t){return t.every(function(t){return t.type==="start-of-interaction"&&t.source.type==="Graph"||t.type==="model_changed"&&t.change.type==="number_scrub"||t.type==="graph_element_changed"||t.type==="end-of-interaction"})};CanvasLogger.prototype.isMoveSequence=function(t){return t.every(function(t){return t.type==="start-of-interaction"&&(t.source.type==="derivation"||t.source.type==="Graph"||t.source.type==="textbox"||t.source.type==="image")&&t.pos||t.type==="end-of-interaction"})};CanvasLogger.prototype.isResizeSequence=function(t){return t.every(function(t){return t.type==="start-of-interaction"&&(t.source.type==="textbox"||t.source.type==="image")&&t.size||t.type==="end-of-interaction"})};CanvasLogger.prototype.isPackSequence=function(t){return t.every(function(t){return t.type==="start-of-interaction"||t.type==="derivation_list_pack_state_changed"||t.type==="end-of-interaction"})};CanvasLogger.prototype.isLinkSequence=function(t){return t.every(function(t){return t.type==="start-of-interaction"&&t.source.type==="Graph"||t.type==="GM_object_created_or_added"&&t.element.type==="derivation"||t.type==="end-of-interaction"})||t.every(function(t){return t.type==="start-of-interaction"&&t.source.type==="DerivationRow"||t.type==="graph_element_created"||t.type==="end-of-interaction"})};CanvasLogger.prototype.isCloneSequence=function(t){return t.every(function(t){return t.type==="start-of-interaction"&&t.source.type==="DerivationRow"||t.type==="GM_object_created_or_added"||t.type==="end-of-interaction"})};CanvasLogger.prototype.isGraphPanSequence=function(t){return t.every(function(t){return t.type==="start-of-interaction"||t.type==="graph_pan_zoom"||t.type==="end-of-interaction"})&&t.some(function(t){return t.type==="start-of-interaction"})};CanvasLogger.prototype.isButtonSequence=function(t){return t.every(function(t){return t.type==="toolbar_button_press"})||t.some(function(t){return t.type==="toolbar_button_press"&&(t.button.label==="undo"||t.button.label==="redo")})};CanvasLogger.prototype.isGraphZoomSequence=function(t){return t.every(function(t){return t.type==="graph_pan_zoom"})};CanvasLogger.prototype.isFontSizeSequence=function(t){return t.every(function(t){return t.type==="font_size"})};CanvasLogger.prototype.isTextEditSequence=function(t){return t.every(function(t){return t.type==="text"})};CanvasLogger.prototype.fillSummaryWithTimeAndCanvasId=function(t,e,i){t.time=e.time;t.dur=i.time-e.time};CanvasLogger.prototype.summarizeCreateSequence=function(t){var e=t[0],i=t[t.length-1],n=[];for(var r=1;r<t.length-1;r++){var o=t[r];var s={type:"interaction",subtype:"create",el_id:o.element.id,el_type:o.element.type,method:o.method};if(o.element.new_state)s.new_state=o.element.new_state;this.fillSummaryWithTimeAndCanvasId(s,e,i);n.push(s)}return n};CanvasLogger.prototype.summarizeGeometryCreateSequence=function(t){var e={type:"interaction",subtype:"create"};var i=t[0],n=t[t.length-1];this.fillSummaryWithTimeAndCanvasId(e,i,n);var r=t.filter(function(t){return t.type==="graph_element_created"});r=r[r.length-1];var o=t.filter(function(t){return t.type==="graph_element_changed"});if(o.length)r=o[0];e.targets=[{type:"graph",id:r.element.id,subtype:r.graph_element.type,subid:r.graph_element.id,new_state:r.graph_element.attr}];if(e.targets[0].subtype==="point")e.method="hold";else e.method="hold-drag";return[e]};CanvasLogger.prototype.summarizeDeleteSequence=function(t){var e=t[0],i=t[t.length-1],n=gmath.find(t,function(t){return t.type==="GM_object_removed"});var r={type:"interaction",subtype:"delete",method:"tap",el_id:n.element.id,el_type:n.element.type};this.fillSummaryWithTimeAndCanvasId(r,e,i);return[r]};CanvasLogger.prototype.summarizeGeometryDeleteSequence=function(t){var e={type:"graph",subtype:"delete",method:"tap"};var i=t[1],n=t[t.length-1];var r=t[0];this.fillSummaryWithTimeAndCanvasId(e,r,i);delete r.graph_element.attr.id;delete r.graph_element.attr.type;e.element={type:r.element.type,id:r.element.id,subtype:r.graph_element.type,subid:r.graph_element.id,old_state:r.graph_element.attr};return[e]};CanvasLogger.prototype.summarizeDrawSequence=function(t){var e={type:"interaction",subtype:"draw",method:"drag"};var i=t[0],n=t[t.length-1];this.fillSummaryWithTimeAndCanvasId(e,i,n);e.el_id=t[1].element.id;e.el_type=t[1].element.type;return[e]};CanvasLogger.prototype.summarizeEraseSequence=function(t){var e={type:"interaction",subtype:"erase",method:"drag"};var i=t[0],n=t[t.length-1];this.fillSummaryWithTimeAndCanvasId(e,i,n);return[e]};CanvasLogger.prototype.summarizeNodeInspectSequence=function(t){var e=t[0],i=t[t.length-1],n=t[1];var r={type:"interaction",subtype:"inspect",method:"tap",el_id:n.element.id,el_type:"derivation",el_subid:n.inspection.row,el_subtype:"row",sel_ascii:n.inspection.sel};this.fillSummaryWithTimeAndCanvasId(r,e,i);return[r]};CanvasLogger.prototype.summarizeGraphScrubSequence=function(t){var e={type:"graph",subtype:"scrub",method:"drag"};var i=t[0],n=t[t.length-1];this.fillSummaryWithTimeAndCanvasId(e,i,n);var r=t.filter(function(t){return t.type==="graph_element_changed"})[0];var o=i.source.selection;delete o.id;delete o.type;e.element={type:"graph",id:r.element.id,subtype:r.graph_element.type,subid:r.graph_element.id,old_state:i.source.selection,new_state:r.graph_element.attr};return[e]};CanvasLogger.prototype.summarizeMoveSequence=function(t){var e=t[0],i=t[t.length-1];var n={type:"interaction",subtype:"move",method:"drag",el_id:e.source.id,el_type:e.source.type,old_state:JSON.stringify(e.pos),new_state:JSON.stringify(i.pos)};this.fillSummaryWithTimeAndCanvasId(n,e,i);return[n]};CanvasLogger.prototype.summarizeResizeSequence=function(t){var e=t[0],i=t[t.length-1];var n={type:"interaction",subtype:"resize",method:"drag",el_id:e.source.id,el_type:e.source.type,old_state:JSON.stringify(e.size),new_state:JSON.stringify(i.size)};this.fillSummaryWithTimeAndCanvasId(n,e,i);return[n]};CanvasLogger.prototype.summarizePackSequence=function(t){var e={type:"interaction",subtype:"pack-dl",method:"drag"};var i=t[0],n=t[t.length-1];this.fillSummaryWithTimeAndCanvasId(e,i,n);var r=t[t.length-2];e.element={type:"derivation",id:r.element.id,subtype:"dl-row",subid:i.source.row,old_state:i.source.packState,new_state:n.source.packState};return[e]};CanvasLogger.prototype.summarizeLinkSequence=function(t){var e={type:"interaction",subtype:"link",method:"drag"};var i=t[0],n=t[t.length-1];this.fillSummaryWithTimeAndCanvasId(e,i,n);var r=t[1];if(i.source.type==="DerivationRow"){e.element={type:"derivation",id:i.source.id,subtype:"dl-row",subid:i.source.row,sel:i.source.model};e.targets=[{type:"graph",id:r.element.id,subtype:r.graph_element.type,subid:r.graph_element.id,new_state:r.graph_element.attr}]}else{e.element={type:"graph",id:i.source.id,subtype:i.source.selection.type,subid:i.source.selection.id};e.targets=[{type:"derivation",id:r.element.id,new_state:r.element.new_state}]}return[e]};CanvasLogger.prototype.summarizeCloneSequence=function(t){var e=t[0],i=t[t.length-1],n=t[1];var r={type:"interaction",subtype:"clone",method:"drag",el_id:e.source.id,el_type:"derivation",el_subid:e.source.row,el_subtype:"row",target_id:n.element.id,target_type:n.element.type,new_state:n.element.new_state};this.fillSummaryWithTimeAndCanvasId(r,e,i);return[r]};CanvasLogger.prototype.summarizeGraphPanSequence=function(t){var e={type:"graph",subtype:"pan",method:"drag"};var i=t[0],n=t[t.length-1];this.fillSummaryWithTimeAndCanvasId(e,i,n);var r=t[1],o=t[t.length-2];e.element={type:"graph",id:i.source.id,old_state:{pan:r.element.new_state.pan,zoom:r.element.new_state.zoom},new_state:{pan:o.element.new_state.pan,zoom:o.element.new_state.zoom}};return[e]};CanvasLogger.prototype.summarizeGraphZoomSequence=function(t){var e={type:"graph",subtype:"zoom",method:"scroll"};var i=t[0],n=t[t.length-1];this.fillSummaryWithTimeAndCanvasId(e,i,n);e.element={type:"graph",id:i.element.id,old_state:{pan:i.element.new_state.pan,zoom:i.element.new_state.zoom},new_state:{pan:n.element.new_state.pan,zoom:n.element.new_state.zoom}};return[e]};CanvasLogger.prototype.summarizeButtonSequence=function(t){var e={type:"interaction",method:"toolbar"};var i=t.filter(function(t){return t.type==="toolbar_button_press"})[0];e.time=i.time;e.dur=0;switch(i.button.label){case"undo":e.subtype="undo";break;case"redo":e.subtype="redo";
break;case"clear all":e.subtype="clear_all";break;case"larger":case"smaller":e.subtype="font_size";e.old_state=i.old_state.font_size;e.new_state=i.button.font_size;break;case"save":e.subtype="save";break;case"load":e.subtype="load";break;default:e.subtype="mode_change";e.old_state=i.old_state.mode;e.new_state=i.button.label;break}return[e]};CanvasLogger.prototype.summarizeFontSizeSequence=function(t){return[{type:"interaction",subtype:"font_size",method:"toolbar",time:t[0].time,dur:0,el_type:t[0].element.type,el_id:t[0].element.id,old_state:JSON.stringify(t[0].element.old_state),new_state:JSON.stringify(t[0].element.new_state)}]};CanvasLogger.prototype.summarizeTextEditSequence=function(t){var e=t[0],i=t[t.length-1];var n={type:"interaction",subtype:"edit",method:"keyboard",el_type:"textbox",el_id:e.element.id,old_state:e.element.old_state,new_state:i.element.new_state};this.fillSummaryWithTimeAndCanvasId(n,e,i);return[n]};DLLogger=function(t,e){this.id=gmath.uid();this.interaction_logger=t;this.log_mouse_trajectories=this.interaction_logger.log_mouse_trajectories;this.dl=e;if(e.rows.length)this.initListeners();this.events=[];this.interaction=null;this.scrubbed_in_this_interaction=false};DLLogger.prototype.initListeners=function(){this.registerDLListeners(this.dl);var t=this.dl.rows.length;this.dl.rows.forEach(function(e,i){if(i===0||i===t-1)this.registerInteractionHandlerListeners(e.view.interaction_handler);this.registerAMListeners(e.model)},this)};DLLogger.prototype.registerDLListeners=function(t){t.events.on("added_line."+this.id,function(){if(t.rows.length===2)this.registerInteractionHandlerListeners(t.rows[0].view.interaction_handler);this.registerAMListeners(t.getLastModel())}.bind(this)).on("auto_undo."+this.id,function(e){this.registerInteractionHandlerListeners(t.getLastView().interaction_handler);this.registerAMListeners(t.getLastModel());this.on_auto_undo(e)}.bind(this))};DLLogger.prototype.registerAMListeners=function(t){t.events.on("create."+this.id,this.on_change.bind(this)).on("change."+this.id,this.on_change.bind(this)).on("end-of-interaction."+this.id,this.on_end_of_interaction.bind(this)).on("start-of-interaction."+this.id,this.on_start_of_interaction.bind(this))};DLLogger.prototype.registerInteractionHandlerListeners=function(t){t.events.on("touch."+this.id,this.on_touch.bind(this,t)).on("release."+this.id,this.on_release.bind(this,t)).on("tap."+this.id,this.on_tap.bind(this,t)).on("dbltap."+this.id,this.on_tap.bind(this,t)).on("hold."+this.id,this.on_tap.bind(this,t)).on("keydown."+this.id,this.on_keydown.bind(this,t)).on("keyup."+this.id,this.on_keyup.bind(this,t)).on("node_selection."+this.id,this.on_node_selection.bind(this,t));if(this.log_mouse_trajectories){t.events.on("drag_start."+this.id,this.on_drag_start.bind(this,t)).on("drag."+this.id,this.on_drag.bind(this,t)).on("drag_end."+this.id,this.on_drag_end.bind(this,t))}};DLLogger.prototype.log=function(t){this.events.push(t)};DLLogger.prototype.extendWithNodeData=function(t,e,i,n){if(!i)i=[];if(!Array.isArray(i))i=[i];this.extendWithSelectorData(t,e,i);if(i.length===0)return;var r=F.getBoundingBox(i);t[e+"x"]=r.x;t[e+"y"]=r.y;t[e+"width"]=r.width;t[e+"height"]=r.height};DLLogger.prototype.getSelectorString=function(t,e){if(!Array.isArray(t))t=[t];else if(t.length===0)return"";if(e)return t[0].get_root().getSelectorOfNodes(t).join(";");else return t.map(function(t){return t.to_ascii()}).join(";")};DLLogger.prototype.extendWithSelectorData=function(t,e,i){t[e+"ascii"]=this.getSelectorString(i,true)};DLLogger.prototype.extendWithFirstLogData=function(t,e,i){this.extendWithLogData(t,this.events[0],e,i)};DLLogger.prototype.extendWithPreviousLogData=function(t,e,i){this.extendWithLogData(t,this.events[this.events.length-1],e,i)};DLLogger.prototype.extendWithLogData=function(t,e,i,n){if(!e||!(i+"x"in e))throw"(DLLogger) Source log argument does not exist or does not contain expected data.";if(n===undefined)n=i;t[n+"x"]=e[i+"x"];t[n+"y"]=e[i+"y"];t[n+"width"]=e[i+"width"];t[n+"height"]=e[i+"height"];t[n+"ascii"]=e[i+"ascii"];if(e[n+"idx"])t[n+"idx"]=e[i+"idx"]};DLLogger.prototype.extendWithDuration=function(t){for(var e=this.events.length-1;e>=0;e--){var i=this.events[e];if(i.type==="math"||e===0){t.dur=t.time-i.time;return}}};DLLogger.prototype.on_change=function(t){if(!this.interaction||this.interaction==="ignore")return;if(t.action)this.on_action(t);else if(this.dl.rows[0].model===t.new_model)this.on_scrub(t)};DLLogger.prototype.on_action=function(t){var e={time:Date.now(),type:"event",subtype:"math",action:t.action.name,row_id:this.dl.getRowByModel(t.action.newTree).idx,method:t.action.getOrInferTriggerType()};if(t.action.name==="SubstitutionAction"){e.source_ascii=t.action.nodes[0].to_ascii()}this.extendWithNodeData(e,"expr_",t.action.newTree.children[0]);if(t.action.target){this.extendWithSelectorData(e,"target_",t.action.target);e.target_side=t.action.settings.side}if(this.events.length)this.extendWithDuration(e);if(!this.interaction.method)this.interaction.method=e.method;this.interaction.new_state=e.expr_ascii;this.log(e)};DLLogger.prototype.on_scrub=function(t){this.scrubbed_in_this_interaction=true;this.interaction.subtype="scrub";this.interaction.method="drag"};DLLogger.prototype.on_start_of_interaction=function(t){if(this.interaction){console.warn("Start of interaction received before prior interaction ended.");return}this.interaction={time:Date.now(),type:"interaction",subtype:"rewrite",el_type:"derivation",el_id:this.dl.id,el_subtype:"row",el_subid:this.dl.getRowByModel(t.model).idx,old_state:t.model.to_ascii()};this.logStartOfInterationEvent(t.time,this.dl.getRowByModel(t.model))};DLLogger.prototype.on_end_of_interaction=function(t){if(!this.interaction||this.interaction==="ignore"){if(!this.interaction)console.warn("End of interaction received without prior start of interaction.");this.clearData();return}if(this.scrubbed_in_this_interaction){this.logScrubEvent();this.initListeners()}if(this.dl.mode==="edit"&&!this.isEmptySelectionInteraction()||this.dl.mode==="inspect"&&this.scrubbed_in_this_interaction){this.interaction.dur=this.events[this.events.length-1].time-this.interaction.time;this.interaction_logger.logInteractionWithEvents(this.interaction,this.events,DLLogger.compressDragEvents)}this.clearData()};DLLogger.prototype.on_auto_undo=function(t){if(!this.interaction||this.interaction==="ignore")return;this.log({time:Date.now(),type:"event",subtype:"auto-undo",row_id:this.dl.rows.length-1})};DLLogger.prototype.isEmptySelectionInteraction=function(){return!this.events.some(function(t){return t.subtype==="node_selection"||t.subtype==="math"})};DLLogger.compressDragEvents=function(t){var e=t.filter(function(t){return t.subtype==="drag"});if(e.length===0)return t;var i={type:"event",subtype:"trajectory",dts:[],xs:[],ys:[],wi_int_ids:[],sel_ascii:[]};var n=t[0].time,r;for(var o=0;o<e.length;o++){var s=e[o];i.dts.push(s.time-n);i.xs.push(s.x);i.ys.push(s.y);i.wi_int_ids.push(s.within_interaction_id);i.sel_ascii.push(s.sel_ascii!==r?s.sel_ascii:undefined);n=s.time;r=s.sel_ascii}i.interaction_id=t[0].interaction_id;i.trial_id=t[0].trial_id;t=t.filter(function(t){return t.subtype!=="drag"});t.push(i);return t};DLLogger.decompressAndSortEvents=function(t){t.sort(function(t,e){return(t.within_interaction_id||-1)-(e.within_interaction_id||-1)});var e;if(t[0].subtype==="trajectory")e=0;else if(t[1]&&t[1].subtype==="trajectory")e=1;else return t;var i=t.splice(e,1)[0],n=t[0].time;for(var r=0;r<i.dts.length;r++){var o={time:i.dts[r]+n,x:i.xs[r],y:i.ys[r],trial_id:i.trial_id,interaction_id:i.interaction_id,within_interaction_id:i.wi_int_ids[r],type:"event",subtype:"drag"};if(i.sel_ascii&&i.sel_ascii[r])o.sel_ascii=i.sel_ascii[r];t.push(o);n+=i.dts[r]}t.sort(function(t,e){return(t.within_interaction_id||-1)-(e.within_interaction_id||-1)});return t};DLLogger.prototype.clearData=function(){this.scrubbed_in_this_interaction=false;this.interaction=null;this.events=[]};DLLogger.prototype.logScrubEvent=function(){var t={time:Date.now(),type:"event",subtype:"scrub",method:"drag",dur:this.events[this.events.length-1].time-this.events[0].time};this.extendWithNodeData(t,"expr_",this.dl.rows[0].model.children[0]);this.interaction.new_state=t.expr_ascii;this.log(t)};DLLogger.prototype.logStartOfInterationEvent=function(t,e){var i={time:t,type:"event",subtype:"start-interaction",row_id:e.idx};this.extendWithNodeData(i,"expr_",e.model.children[0]);this.extendWithNodeData(i,"sel_",e.view.interaction_handler.selected_nodes);this.log(i)};DLLogger.prototype.on_touch=function(t,e){if(!this.interaction||this.interaction==="ignore")return;var i={time:e.time,type:"event",subtype:"touch",x:e.finger.pos[0],y:e.finger.pos[1],touch_id:e.finger.id};this.extendWithNodeData(i,"sym_",e.target,true);this.log(i)};DLLogger.prototype.on_release=function(t,e){if(!this.interaction||this.interaction==="ignore")return;this.log({time:e.time,type:"event",subtype:"release",x:e.finger.pos[0],y:e.finger.pos[1],touch_id:e.finger.id})};DLLogger.prototype.on_drag_start=function(t,e){if(!this.interaction||this.interaction==="ignore")return;if(e.selection.length===0)this.interaction="ignore";else{var i={time:e.time,type:"event",subtype:"drag",x:Math.round(e.pos0[0]),y:Math.round(e.pos0[1]),sel_ascii:this.getSelectorString(e.selection[0],false)};this.log(i)}};DLLogger.prototype.on_drag=function(t,e){if(!this.interaction||this.interaction==="ignore")return;var i={time:e.time,type:"event",subtype:"drag",x:Math.round(e.pos[0]),y:Math.round(e.pos[1]),sel_ascii:this.getSelectorString(e.selection[0],false)};this.log(i)};DLLogger.prototype.on_drag_end=function(t,e){};DLLogger.prototype.on_node_selection=function(t,e){if(!this.interaction||this.interaction==="ignore")return;var i={time:e.time,type:"event",subtype:"node_selection"};this.extendWithNodeData(i,"sel_",e.selection,true);this.log(i)};DLLogger.prototype.on_tap=function(t,e){if(!this.interaction||this.interaction==="ignore")return;this.log({time:e.time,type:"event",subtype:e.type,x:e.finger.pos[0],y:e.finger.pos[1]})};DLLogger.prototype.on_keydown=function(t,e){if(!this.interaction||this.interaction==="ignore")return;this.log({time:e.time,type:"event",subtype:"keydown",key_code:e.keyCode})};DLLogger.prototype.on_keyup=function(t,e){if(!this.interaction||this.interaction==="ignore")return;this.log({time:e.time,type:"event",subtype:"keyup",key_code:e.keyCode})};gmath.DLLogger=DLLogger;GMEventRecorder=function(t,e){this.event_log=t;this.dl=null;this.other_dl=null;this.div=d3.select(e);this.stop_timer=false};GMEventRecorder.prototype.showPreview=function(){var t=gmath.extend({},this.event_log.options);t.interactive=false;if(this.dl){this.dl.removeElement()}this.dl=new DerivationList(null,this.div.node(),t)};GMEventRecorder.prototype.replay=function(t,e,i){var n=this;if(!this.event_log){console.warn("set the event log before replaying!");return}var r=this.event_log.events;if(r.length>0){var o=i?i:r[0].time;var s=0}this.stop_timer=false;if(this.dl)this.dl.removeElement();this.dl=new DerivationList(null,this.div.node(),this.event_log.options,a);function a(){if(n.event_log.events.length>0){d3.timer(l,t||0)}}function l(t){if(n.stop_timer)return true;var i=n.dl.getLastView();while(r[s].time-o<t){var a=r[s];if(a.action&&a.followup&&r[s+1]&&a.followup===r[s+1].action){s++;a=r[s]}if(a.action){if(i.model.to_ascii()!==a.newTree){if(n.triggerDelayedAction(i,a.action)&&i.model.to_ascii()===a.newTree){console.info("Triggered delayed action.")}else{console.warn(a,"Replay out of synch, forcing correct state. Expected: "+a.newTree+"; Actual: "+i.model.to_ascii());n.abortCurrentStateAndResetInteraction(i,a.newTree)}}}else{if(a.type==="touch"&&!a.finger)a.finger=a.fingers[a.fingers.length-1];i.interaction_handler["on_"+a.type](a);if(a.type==="keyup")n.updateKey(a.keyCode,false);if(a.type==="keydown")n.updateKey(a.keyCode,true)}s++;if(s===r.length){e();return true}}}};GMEventRecorder.prototype.triggerDelayedAction=function(t,e){var i=t.interaction_handler.active_handler;if(!i||!(i instanceof gmath.DragHandler))return false;for(var n=0;n<i.actions.length;n++){var r=i.actions[n];if(r.name!==e)return false;if(!r.timeoutID)return false;i.clearActionTimeout(r);i.performAction(r);return true}return false};GMEventRecorder.prototype.abortCurrentStateAndResetInteraction=function(t,e){t.model.parseAndSet(e);t.interaction_handler.abort_interaction();t.bindToModel(t.model);t.enter_and_exit("normal");t.enter_and_exit("shadow")};GMEventRecorder.prototype.updateKey=function(t,e){console.log(t);var i=this.div.select("#key"+t);if(i.size()===0){i=this.div.append("span").attr("id","key"+t).classed("key-vis",true).style("opacity",1e-5).style({position:"absolute",bottom:"5px",right:"10px",padding:"1px 7px",border:"2px solid steelblue","border-radius":"10px",color:"steelblue",background:"white"}).text({32:"space",16:"shift"}[t]||"")}if(e)i.style("opacity",1);else i.transition().duration(750).style("opacity",1e-5)};GMEventRecorder.prototype.stop_animation=function(){this.stop_timer=true};GMEventRecorder.prototype.createAndRecordDL=function(t,e){var i=new DerivationList(null,t,e);this.recordDL(i)};GMEventRecorder.prototype.recordDL=function(t){this.event_log={options:t.options,events:[]};this.dl=t;var e=this.dl.getLastView();var i=this.log.bind(this);this.registerListeners(e,i);var n=this;if(t.options.no_history){t.getLastModel().events.on("change",n.logAction.bind(this))}else{t.events.on("added_line",function(r){n.logAction(r);if(t.getLastView()===e)return;e=t.getLastView();n.registerListeners(e,i)})}return this.event_log};GMEventRecorder.prototype.liveReplay=function(t,e){this.other_dl=new DerivationList(null,t,e)};GMEventRecorder.prototype.log=function(t){this.event_log.events.push(t);if(this.other_dl){this.other_dl.getLastView().interaction_handler["on_"+t.type](t)}};GMEventRecorder.prototype.logAction=function(t){if(t){this.event_log.events.push({type:"action",action:t.action.name,followup:t.action.followup?t.action.followup.name:false,newTree:t.action.newTree.to_ascii(),time:Date.now()})}};GMEventRecorder.prototype.registerListeners=function(t,e){t.interaction_handler.events.on("touch",e).on("release",e).on("drag_start",e).on("drag",e).on("drag_end",e).on("tap",e).on("dbltap",e).on("keydown",e).on("keyup",e)};gmath.EventRecorder=GMEventRecorder;GraphEventRecorder=function(t,e){this.event_log=t;this.graph;this.container=d3.select(e)};GraphEventRecorder.prototype.replay=function(t,e,i){var n=this;if(!this.event_log){console.warn("(GraphEventRecorder) Set the event log before replaying.");return}if(this.graph&&this.graph.main_g){this.graph.main_g.remove();this.graph=null}this.graph=new gmath.ui.Graph(this.container.node(),this.event_log.options);var r=this.event_log.events;if(r.length>0){var o=i||r[0].time;var s=0}function a(){if(n.event_log.events.length>0){d3.timer(l,t||0)}}function l(t){while(r[s].time-o<t){var i=r[s];n.graph[""+i.type](i);s++;if(s===r.length){e();return true}}}setTimeout(a,10)};GraphEventRecorder.prototype.recordGraph=function(t){this.event_log={options:t.options,events:[]};this.graph=t;this.container=t.container;var e=this.log.bind(this);this.registerListeners(t,e);return this.event_log};GraphEventRecorder.prototype.log=function(t){this.event_log.events.push(t)};GraphEventRecorder.prototype.registerListeners=function(t,e){t.events.on("move",e).on("touch",e).on("drag",e).on("hold",e).on("release",e)};gmath.CanvasSaver=function(){var t={};t.createSaveFile=function(t){var e={};e.save_id=gmath.uid();e.gmath=JSON.stringify({version:gmath.version,ui:{version:gmath.ui.version,gm_version:gmath.ui.gm_version}});e.defaultOptions={AlgebraModel:gmath.AlgebraModel.defaultOptions,AlgebraView:gmath.AlgebraView.defaultOptions,CanvasElement:gmath.CanvasElementClass.defaultOptions,DerivationList:gmath.DerivationList.defaultOptions,TextBox:gmath.ui.TextBox.defaultOptions,CanvasImage:gmath.ui.CanvasImage.defaultOptions,CanvasFactory:gmath.ui.CanvasFactoryClass.defaultOptions,GeoGebraCanvasElement:gmath.ui.GeoGebraCanvasElement.defaultOptions,GeoGebraPanel:gmath.ui.GeoGebraPanel.defaultOptions};e.defaultOptions=JSON.stringify(e.defaultOptions);e.options=gmath.object.extendChanged({},t.options,gmath.ui.CanvasFactoryClass.defaultOptions);if(e.options.mode_btns){e.options.mode_btns=e.options.mode_btns.filter(function(t){return t.group==="mode"});e.options.mode_btns.forEach(function(t,e){if(e===0)t.state=true;else t.state=false})}e.options=JSON.stringify(e.options);e.linkCoordinator=JSON.stringify(gmath.LinkCoordinator);var i=t.model.elements();e.objects=JSON.stringify(i);return e};t.save=function(e){var i=t.createSaveFile(e);localStorage.setItem("GM_save_1_version",i.gmath);localStorage.setItem("GM_save_1_default_options",i.defaultOptions);localStorage.setItem("GM_save_1_options",i.options);localStorage.setItem("GM_save_1_link_coordinator",i.linkCoordinator);localStorage.setItem("GM_save_1_objects",i.objects)};t.share=function(e,i,n){var r=t.createSaveFile(i);var o=[];var s=JSON.parse(r.objects);s.forEach(function(t){if(t.imageData!==undefined){t.save_id=gmath.uid();o.push(JSON.stringify(t));t.imageData=t.save_id}});var a=e+"_images_folder";o.forEach(function(t){var e=new XMLHttpRequest;e.open("POST",a);e.setRequestHeader("Content-Type","application/json");e.send(t)});r.objects=JSON.stringify(s);var l=JSON.stringify(r);console.log("File size:",(l.length/1e3).toFixed(1),"KB");if(l.length>2e6){console.warn("(CanvasSaver) The data attempting to save is too large.");if(n)n({reason:"File size too big ("+(l.length/1e6).toFixed(1)+" MB)."});return}var h=new XMLHttpRequest;if(n)h.onreadystatechange=function(){if(this.readyState===4){if(this.status===200||this.status===301||this.status===302){n(null,r.save_id)}else n({reason:"Network or server error ("+h.status+").",status:h.status,statusText:h.statusText})}};h.open("POST",e+"_saves_folder");h.setRequestHeader("Content-Type","application/json");h.send(l)};t.loadSaveFile=function(e,i,n,r){var o=new XMLHttpRequest;var s=i+"_saves_folder/"+n;var a=i+"_images_folder/";o.onreadystatechange=function(){if(o.readyState===4&&o.status===200){var i=JSON.parse(o.responseText);var n=[];var s=JSON.parse(i[0].objects);for(var l=s.length-1;l>=0;l--){if(s[l].imageData!==undefined){n.push(s[l]);s.splice(l,1)}}i[0].objects=JSON.stringify(s);t.load(e,i[0],r);if(n.length>0){t.loadAllImages(e,n,a)}}};o.open("get",s,true);o.setRequestHeader("Content-Type","application/json");o.send()};t.loadImage=function(t,e,i){var n=new XMLHttpRequest;n.onerror=function(){console.log("failed to load image.  Request:");console.log(n)};n.onreadystatechange=function(){if(n.readyState===4&&n.status===200){var t=n.responseURL.lastIndexOf("/");var i=n.responseURL.substring(t+1,n.responseURL.length);var r=JSON.parse(n.responseText);if(typeof r[0]!=="undefined"){e.imageData=r[0].imageData;var o={};gmath.loadFromJSON(JSON.stringify(e),o,components.model)}}};var r=e.save_id;var o=i+r;n.open("get",o,true);n.setRequestHeader("Content-Type","application/json");n.send()};t.loadAllImages=function(e,i,n){for(var r in i){t.loadImage(e,i[r],n)}};t.load=function(e,i,n){if(!i)i=t.loadLocalSaveFile();if(!i){console.warn("(CanvasSaver) Attempted to load non-existant save.");return}this.loadDefaultOptions(i.defaultOptions);var r=gmath.DerivationList.defaultOptions.row_transition_dur;gmath.DerivationList.defaultOptions.row_transition_dur=0;var o=gmath.extend(JSON.parse(i.options),n);var s=new gmath.ui.CanvasFactory(e,o);s.logger.listen(false);var a={};gmath.loadFromJSON(i.objects,a,s.model);gmath.LinkCoordinator=gmath.loadFromJSON(i.linkCoordinator,a);this.resolveActionIDsToObjects(s,a);this.initializeNodeMappings();s.logger.listen(true);gmath.DerivationList.defaultOptions.row_transition_dur=r;s.model.dls().forEach(function(t){t.options.row_transition_dur=r});s.logger.canvas_logger.dlLoggers.forEach(function(t){t.initListeners()});var l=s.model.elements(),h=[],p=[];l.forEach(function(t){if(t.type=="table")h.push(t);if(t.type=="ggb-element")p.push(t)});h.forEach(function(t){if(t.graph){p.forEach(function(e){if(t.graph==e.id){if(e.ggbApplet)t.setGraph(e);else{e.events.on("ggb_init",function(){t.setGraph(e)})}}})}});components=s;return s};t.loadLocalSaveFile=function(){var t={defaultOptions:localStorage.getItem("GM_save_1_default_options"),options:localStorage.getItem("GM_save_1_options"),id2obj:localStorage.getItem("GM_save_1_id2obj"),linkCoordinator:localStorage.getItem("GM_save_1_link_coordinator"),objects:localStorage.getItem("GM_save_1_objects")};return t};t.makeID2ObjMap=function(t){var e={};var i=t.model.dls();for(var n=0;n<i.length;n++){var r=i[n].rows;for(var o=0;o<r.length;o++){var s=r[o];if(s.action)e[s.action.id]=s.action;s.model.for_each(function(t){e[t.id]=t})}}return JSON.stringify(e)};t.loadDefaultOptions=function(t){var e=JSON.parse(t);for(var i in e){if(i+"Class"in gmath.ui){gmath.ui[i+"Class"].defaultOptions=e[i]}else if(i in gmath){gmath[i].defaultOptions=e[i]}}};t.resolveActionIDsToObjects=function(t,e){t.model.dls().forEach(function(t){t.rows.forEach(function(t){if(t.action)t.action=e[t.action]})})};t.initializeNodeMappings=function(){gmath.LinkCoordinator.groups.forEach(function(t){if(t.deps===0)t.nodes.forEach(function(t){if(!(t instanceof gmath.AlgebraModel))return;var e=t.children[0].get_mapping_to(t.children[0]);t.events.change(new gmath.AlgebraModel.ChangeEvent({model:t,no_anim:true,node_map:e}))})})};t.saveFileSizeIsTooBig=function(t){var e=JSON.stringify(t),i=gmath.byteLength(e);return i>5e5};return t}();(function(){t.Node.prototype.toJSON=function(){return{id:this.id,value:this.value,type:"Expression",name:this.name,bp:this.bp,associative:this.associative,commutative:this.commutative,vertical_notation:this.vertical_notation,selected:this.selected,dragging:this.dragging,fixed:this.fixed,locked:this.locked,hidden:this.hidden,simplify:this.simplify,precision:this.precision,deleted:this.deleted,ls:this.ls&&this.ls.id,rs:this.rs&&this.rs.id,parent:this.parent&&this.parent.id,children:this.children}};node_to_id_fn=function(t){return t.id};jsonifyNodeMap=function(t){var e={};for(var i in t)e[i]=t[i].map(node_to_id_fn);return e};r.prototype.toJSON=function(){var t=gmath.object.extendChanged({},this.options,r.defaultOptions);if(t.parser===r.getDefaultParser())t.parser=undefined;return{id:this.id,type:"AlgebraModel",options:t,ascii:this.to_ascii()}};Action.prototype.toJSON=function(){var t={id:this.id,name:this.name,type:"Action",priority:this.priority,oldTree:this.oldTree.id,newTree:this.newTree.id,triggerType:this.triggerType,settings:this.settings};if(this.nodes){if(this.name==="SubstitutionAction"||this.name==="EquationCombineAction")t.nodes=this.nodes[0].id;else t.nodes=this.nodes[0].get_root().getSelectorOfNodes(this.nodes).join(";")}if(this.target){var e=Array.isArray(this.target)?this.target[0].get_root():this.target.get_root();t.target=e.getSelectorOfNodes(this.target).join(";");if(Array.isArray(this.target)&&this.target.length===1)t.target_is_array=true}if(this.actor)t.actor=this.actor.get_root().getSelectorOfNodes(this.actor)[0];return t};gmath.LinkCoordinatorClass.prototype.toJSON=function(){return{id:this.id,type:"LinkCoordinator",links:this.links,auto_update_scrubbability:this.auto_update_scrubbability}};AlgebraModelLink.prototype.toJSON=function(){return{id:this.id,type:"AlgebraModelLink",source:this.source.id,target:this.target.id,action:this.action}};DerivationRow.prototype.toJSON=function(){return{id:this.id,type:"DerivationRow",dl:this.dl.id,action:this.action&&this.action.id,model:this.model,row_idx:this.idx}};DerivationList.prototype.toJSON=function(){var t=gmath.object.extendChanged({},this.options,DerivationList.defaultOptions);gmath.object.extendDifferent(t,this.aview_options,DerivationList.defaultOptions);gmath.object.extendDifferent(t,this.amodel_options,DerivationList.defaultOptions);if(t.canvas_model)t.canvas_model=this.canvas_model.id;t.id=this.id;delete t.eq;delete t.pos;return{type:"DerivationList",rows:this.rows,options:t,pos:this.pos,pack_state:this.rows.map(function(t){return t.hidden?true:false})}};gmath.ui.Table.prototype.toJSON=function(){return{id:this.id,type:"Table",rows:this.rows.map(function(t){return{x:t.x,y:t.y}}),pos:this.pos,graph:this.graph?this.graph.id:null}};gmath.loadFromJSON=function(t,e,i){if(!e)e={};return JSON.parse(t,function(t,n){if(n&&n.type in gmath.JSONParsers)return gmath.JSONParsers[n.type](n,e,i);return n})};gmath.JSONParsers={};gmath.JSONParsers.Expression=function(t,e){var i=new gmath.expressions[t.name];for(var n in t)i[n]=t[n];e[i.id]=i;return i};gmath.JSONParsers.Action=function(t,i){var n=new gmath.actions[t.name].constructor;for(var r in t)n[r]=t[r];e(n,i);i[n.id]=n;return n};var e=function(t,e){if(t.oldTree)t.oldTree=e[t.oldTree];if(t.newTree)t.newTree=e[t.newTree];if(t.name==="SubstitutionAction"||t.name==="EquationCombineAction"){t.target=t.oldTree.getNodesFromSelector(t.target);if(t.name==="EquationCombineAction")t.target=t.target[0];t.nodes=[e[t.nodes]]}else{if(t.nodes)t.nodes=t.oldTree.getNodesFromSelector(t.nodes);if(t.actor)t.actor=t.oldTree.getNodesFromSelector(t.actor)[0];if(t.target){t.target=t.oldTree.getNodesFromSelector(t.target);if(!t.target_is_array&&t.target.length===1)t.target=t.target[0]}}};gmath.JSONParsers.AlgebraModel=function(t,e){if(t.options.parser)t.options.parser=o(t.options.parser);var i=new r(t.ascii,t.options);i.id=t.id;e[i.id]=i;return i};gmath.JSONParsers.AlgebraModelLink=function(t,e){var i=new AlgebraModelLink(e[t.source],e[t.target],t.action,t.id);i.id=t.id;return i};gmath.JSONParsers.LinkCoordinator=function(t,e){var i=new gmath.LinkCoordinatorClass;i.id=t.id;i.links=t.links;i.auto_update_scrubbability=t.auto_update_scrubbability;i.updateAll();return i};gmath.JSONParsers.DerivationRow=function(t,e){var i=new DerivationRow(t.dl,t);return i};gmath.JSONParsers.DerivationList=function(t,e,i){var n=t.options.eq;delete t.options.eq;var r;if(i){r=i.createDL(t.options,null,"load")}else{r=new gmath.DerivationList(null,null,gmath.object.merged(t.options,{visualized:false}))}t.options.eq=n;t.rows.forEach(function(e,i){r.addRowFromModel(e.model,e.action,function(){if(i===t.rows.length-1){o();r.layoutRows()}})});function o(){r.rows.forEach(function(e,i){if(t.pack_state[i])e.hide()})}r.translateElement(t.pos);return r};gmath.JSONParsers.Path=function(t,e,i){return i.createPath(t,"load")};gmath.JSONParsers.TextBox=function(t,e,i){var n=i.createTextBox(t,null,"load");n.unselect();return n};gmath.JSONParsers.CanvasImage=function(t,e,i){return i.createImage(t)};gmath.JSONParsers.GeoGebraCanvasElement=function(t,e,i){var n=i.createElement("ggb-element",t);n.id=t.id;e[n.id]=n;return n};gmath.JSONParsers.GeoGebraPanel=function(t,e,i){t.ggbElement=e[t.ggbElement];return i.createElement("ggb-panel",t)};gmath.JSONParsers.Table=function(t,e,i){var n=i.createElement("table",{pos:t.pos});n.id=t.id;t.rows.forEach(function(t){n.addRow(t.x,t.y)});n.graph=t.graph;return n}})();SVGPlayButton=function(){var t=d3.dispatch("click");var e,i,n,r,o,s=false;var a=function(t){e=t;a.init();return a};a.hidden=function(t){if(arguments.length===0)return s;s=t;if(r)r.style("display",s?"none":null);if(o)o.attr("opacity",0);return this};a.remove=function(){if(n)n.remove()};a.init=function(){i=e.node().getBoundingClientRect();n=e.append("svg").attr("id","button").attr("width","100%").attr("height","100%").attr("cursor","pointer");r=n.append("g").style("display",s?"none":null).attr("transform","translate("+[i.width/2,i.height/2]+")");r.append("rect").attr({x:-i.width/2,y:-i.height/2,width:i.width,height:i.height}).attr({fill:"black",opacity:.1});r.append("circle").attr({r:"35px"}).attr({fill:"#666",stroke:"white","stroke-width":"4px","fill-opacity":.6});r.append("circle").attr({r:"37px"}).attr({fill:"none",stroke:"silver","stroke-width":1.5});r.append("path").attr("d","M0,0 L0,1 L0.8,0.5 Z").attr("transform","scale(40)translate(-0.3,-0.5)").attr("fill","white");o=n.append("rect").classed("overlay",true).attr({width:i.width,height:i.height}).attr({fill:"black",opacity:0}).attr("pointer-events","all").on("mouseover",function(){o.attr("opacity",s?0:.1)}).on("mouseout",function(){o.attr("opacity",0)}).on("click",function(){if(!s)t.click()})};return d3.rebind(a,t,"on")};gmath.svg_play_button=SVGPlayButton;gmath.Tree=t;gmath.session_id=gmath.uid();if(typeof module==="object"&&module.exports){module.exports=gmath}else{this.gmath=gmath}})();gmath.ui=gmath.ui||{};gmath.ui.Path=function(){var t=function(t,e){this.container=d3.select(t);this.element=null;e=e||{};this.id=e.id||gmath.uid();this.oid=e.oid;this.points=e.points||[];this.color=e.color||"black";this.width=e.width||1;this.type=e.type;this.init()};t.prototype.toJSON=function(){return{id:this.id,type:"Path",points:this.points,color:this.color,width:this.width}};t.line=typeof d3==="undefined"||typeof d3.svg==="undefined"?null:d3.svg.line();t.prototype.init=function(){var t=null;if(this.oid)t="#"+this.oid;this.element=this.container.insert("path",t).attr("id",this.id).style("fill","none").style("stroke-linecap","round").style("stroke-linejoin","round");return this.update()};t.prototype.update=function(){this.element.attr("d",t.line(this.points)+(this.points.length===1?"Z":"")).style("stroke",this.color).style("stroke-width",this.width);return this};t.prototype.remove=function(){this.element.remove();return this};t.prototype.setContainer=function(t){if(arguments.length===0)return this.container;this.container=t;return this};t.prototype.renderOnto=function(t){var e=this.element,i=this.container;this.container=t;this.element=t.select("#"+this.id);if(this.element.empty())this.init();else this.update();this.container=i;this.element=e};return t}();gm_erase_paths=function(){function t(t,e,i){i=i||20;var n=[];var r=function(t){var r=e[0][0];var o=e[0][1];var s=0;var l=0;if(t.length===1){if(!a(t[0][0],t[0][1],r,o,i)){n.push(t);return}}var h;while(s<t.length-1){var p=t[s];var d=t[s+1];var f=a(p[0],p[1],r,o,i);var g=a(d[0],d[1],r,o,i);if(f&&g){s++;l=s}else if(f&&!g){var m=u(p[0],p[1],d[0],d[1],r,o,i);if(m){t[s]=m;l=s}else{s++}}else if(!f&&g){var m=u(d[0],d[1],p[0],p[1],r,o,i);if(m){h=t.slice(l,s+1);h.push(m);n.push(h)}s++;l=s}else{var v=c(p[0],p[1],d[0],d[1],r,o,i);if(v){h=t.slice(l,s+1);if(h[h.length-1][0]!==v[0][0]||h[h.length-1][1]!==v[0][1]){h.push(v[0])}if(h.length>1)n.push(h);t[s]=v[1];if(t[s+1]&&t[s+1][0]==v[1][0]&&t[s+1][1]==v[1][1])s++;l=s}else{s++}}}if(l!==s){h=t.slice(l,t.length);if(h){n.push(h)}}};var s=function(t,r){if(t.path){i=i+t.width/2;var t=t.path}var o=e[r];var s=e[r+1];var r=0;var a=0;if(t.length===1){var l=h(t[0][0],t[0][1],o[0],o[1],s[0],s[1],i);if(l.indexOf(1)===-1){n.push(t);return}}var p;while(r<t.length-1){var u=t[r];var c=t[r+1];var l=h(u[0],u[1],o[0],o[1],s[0],s[1],i);var d=h(c[0],c[1],o[0],o[1],s[0],s[1],i);if(l.indexOf(1)!==-1&&d.indexOf(1)!==-1){r++;a=r}else if(l.indexOf(1)!==-1&&d.indexOf(1)===-1){var m=f(u[0],u[1],l,c[0],c[1],o[0],o[1],s[0],s[1],i);if(m){t[r]=m;a=r}else{r++}}else if(l.indexOf(1)===-1&&d.indexOf(1)!==-1){var m=f(c[0],c[1],d,u[0],u[1],o[0],o[1],s[0],s[1],i);if(m){p=t.slice(a,r+1);p.push(m);n.push(p);r++;a=r}else{r++}}else{var v=g(u[0],u[1],c[0],c[1],o[0],o[1],s[0],s[1],i);if(v){p=t.slice(a,r+1);if(p[p.length-1][0]!==v[0][0]||p[p.length-1][1]!==v[0][1]){p.push(v[0])}if(p.length>1)n.push(p);t[r]=v[1];if(t[r+1]&&t[r+1][0]==v[1][0]&&t[r+1][1]==v[1][1])r++;a=r}else{r++}}}if(a!==r){p=t.slice(a,t.length);if(p){n.push(p)}}};e=o({path:e});if(e.length===1){for(var l=0;l<t.length;l++){r(t[l])}t=n}else{for(var p=0;p<e.length-1;p++){for(var l=0;l<t.length;l++){s(t[l],p)}t=n;n=[]}}for(var d=0;d<t.length;d++){for(var m=0;m<t[d].length;m++){t[d][m][0]=Math.round(t[d][m][0]);t[d][m][1]=Math.round(t[d][m][1])}}return t}function e(t){if(t.path){var t=t.path}document.write("[");for(var e=0;e<t.length-1;e++){document.write("["+t[e][0]+","+t[e][1]+"],")}document.write("["+t[e][0]+","+t[e][1]+"]");document.write("]")}function i(t){document.write("[");
for(var i=0;i<t.length-1;i++){e(t[i]);document.write(",<br />")}e(t[i]);document.write("]")}function n(t,e){if(t.path){var t=t.path}var i="";i+="[";for(var n=0;n<t.length-1;n++){i+="["+t[n][0]+","+t[n][1]+"],"}i+="["+t[n][0]+","+t[n][1]+"]";i+="]";if(e){console.log(i)}else{return i}}function r(t){log="";log+="[";for(var e=0;e<t.length-1;e++){log+=n(t[e],0);log+=","}log+=n(t[e],0);log+="]";console.log(log)}function o(t){if(t.path){var t=t.path}var e=[];if(t.length===1){e=t}else{pClean=0;while(pClean<t.length-1){if(t[pClean][0]!==t[pClean+1][0]||t[pClean][1]!==t[pClean+1][1]){e.push(t[pClean])}pClean++}if(t.length!==0&&e.length===0){e.push(t[0])}if(t[t.length-1][0]!==t[e.length-1][0]||t[t.length-1][1]!==t[e.length-1][1]){e.push(t[pClean])}}return e}function s(t,e,i,n){return Math.sqrt(Math.pow(i-t,2)+Math.pow(n-e,2))}function a(t,e,i,n,r){var o=s(t,e,i,n);if(o<r)return 1;else return 0}function l(t,e,i,n,r,o,s){var a=[r-i,o-n];var l=[t-i,e-n];var h=[-a[1],a[0]];var p=Math.sqrt(Math.pow(h[0],2)+Math.pow(h[1],2));var u=[h[0]/p,h[1]/p];var c=Math.sqrt(Math.pow(a[0],2)+Math.pow(a[1],2));var d=[a[0]/c,a[1]/c];var f=l[0]*d[0]+l[1]*d[1];if(f<=0||f>=c)return 0;var g=l[0]*u[0]+l[1]*u[1];if(g>=s||g<=-s)return 0;return 1}function h(t,e,i,n,r,o,s){var h=[];h.push(a(t,e,i,n,s));h.push(a(t,e,r,o,s));h.push(l(t,e,i,n,r,o,s));return h}function p(t,e,i,n,r){var o=[i-t,n-e];var s=[-o[1],o[0]];var a=Math.sqrt(Math.pow(s[0],2)+Math.pow(s[1],2));var l=[s[0]/a,s[1]/a];var h=[t+r*l[0],e+r*l[1]];var p=[t-r*l[0],e-r*l[1]];var u=[i-r*l[0],n-r*l[1]];var c=[i+r*l[0],n+r*l[1]];return[h,p,u,c]}function u(t,e,i,n,r,o,s){var a=[r-t,o-e];var l=[i-t,n-e];var h=Math.sqrt(Math.pow(l[0],2)+Math.pow(l[1],2));var p=[l[0]/h,l[1]/h];var u=a[0]*p[0]+a[1]*p[1];var c=[t+u*p[0],e+u*p[1]];var d=Math.sqrt(Math.pow(r-c[0],2)+Math.pow(o-c[1],2));var f;if(d===0){f=s}else{var f=Math.sqrt(Math.pow(s,2)-Math.pow(d,2))}var g=[t+u*p[0]+f*p[0],e+u*p[1]+f*p[1]];if(g[0]===t&&g[1]===e)return null;return g}function c(t,e,i,n,r,o,s){var a=[r-t,o-e];var l=[i-t,n-e];var h=[-l[1],l[0]];var p=Math.sqrt(Math.pow(h[0],2)+Math.pow(h[1],2));var u=[h[0]/p,h[1]/p];var c=a[0]*u[0]+a[1]*u[1];var d=_([t,e],[i,n],[r,o]);var f=m([d[0]-r,d[1]-o]);if(f>=s)return null;var g=Math.sqrt(Math.pow(s,2)-Math.pow(c,2));var v=[r-c*u[0],o-c*u[1]];var y=Math.sqrt(Math.pow(l[0],2)+Math.pow(l[1],2));var b=[l[0]/y,l[1]/y];var w=[[v[0]-b[0]*g,v[1]-b[1]*g],[v[0]+b[0]*g,v[1]+b[1]*g]];if(w[0][0]===t&&w[0][1]===e)return null;return w}function d(t,e,i,n,r,o,s,a){var l,h,p,u;l=i-t;h=n-e;p=s-r;u=a-o;var c,d;if(-p*h+l*u===0)return null;c=(-h*(t-r)+l*(e-o))/(-p*h+l*u);d=(p*(e-o)-u*(t-r))/(-p*h+l*u);if(c>=0&&c<=1&&d>=0&&d<=1){var f=t+d*l;var g=e+d*h;return[f,g]}return null}function f(t,e,i,n,r,o,a,l,h,f){var g=p(o,a,l,h,f);var m=[];if(i[0]&&!i[1]){m.push(u(t,e,n,r,o,a,f));m.push(d(t,e,n,r,g[0][0],g[0][1],g[3][0],g[3][1]));m.push(d(t,e,n,r,g[1][0],g[1][1],g[2][0],g[2][1]));var v=c(t,e,n,r,l,h,f);if(v)m.push(v[0],v[1])}else if(!i[0]&&i[1]){m.push(u(t,e,n,r,l,h,f));m.push(d(t,e,n,r,g[0][0],g[0][1],g[3][0],g[3][1]));m.push(d(t,e,n,r,g[1][0],g[1][1],g[2][0],g[2][1]));var v=c(t,e,n,r,o,a,f);if(v)m.push(v[0],v[1])}else if(i[0]&&i[1]){m.push(u(t,e,n,r,o,a,f));m.push(d(t,e,n,r,g[0][0],g[0][1],g[3][0],g[3][1]));m.push(d(t,e,n,r,g[1][0],g[1][1],g[2][0],g[2][1]));m.push(u(t,e,n,r,l,h,f))}else{var v=c(t,e,n,r,l,h,f);var _=c(t,e,n,r,o,a,f);if(v)m.push(v[0],v[1]);if(_)m.push(_[0],_[1]);m.push(d(t,e,n,r,g[0][0],g[0][1],g[3][0],g[3][1]));m.push(d(t,e,n,r,g[1][0],g[1][1],g[2][0],g[2][1]))}var y=[t,e];for(var b=0;b<m.length;b++){if(m[b]){if(s(m[b][0],m[b][1],n,r)<s(y[0],y[1],n,r)){y=m[b]}}}if(y[0]===t&&y[1]===e)return null;return y}function g(t,e,i,n,r,o,a,l,h){var u=p(r,o,a,l,h);var f=[];var g=c(t,e,i,n,r,o,h);if(g)f.push(g[0],g[1]);g=c(t,e,i,n,a,l,h);if(g)f.push(g[0],g[1]);f.push(d(t,e,i,n,u[0][0],u[0][1],u[3][0],u[3][1]));f.push(d(t,e,i,n,u[1][0],u[1][1],u[2][0],u[2][1]));var m=[i,n];var v=[t,e];for(var _=0;_<f.length;_++){if(f[_]){if(s(f[_][0],f[_][1],t,e)<s(m[0],m[1],t,e)){m=f[_]}}}for(var y=0;y<f.length;y++){if(f[y]){if(s(f[y][0],f[y][1],i,n)<s(v[0],v[1],i,n)){v=f[y]}}}if(m[0]===i&&m[1]===n||v[0]===t&&v[1]===e)return null;else return[m,v]}var m=function(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1])};var v=1e-6;var _=function(t,e,i){var n=[e[0]-t[0],e[1]-t[1]],r=m(n);if(r<v)return t;var o=[i[0]-t[0],i[1]-t[1]];var s=(n[0]*o[0]+n[1]*o[1])/r;if(s<0)return t;if(s>r)return e;return[t[0]+n[0]*s/r,t[1]+n[1]*s/r]};if(typeof exports!="undefined"){exports.erase=t}return t}();gm_hwr_request=function(){var t=function(t){var e={type:"stroke",x:[],y:[]};t.points.forEach(function(t){e.x.push(t[0]);e.y.push(t[1])});return e};var e=function(e,i){url="http://dlandy.psych.indiana.edu:7031/server.js";var n={components:e.map(t),resultTypes:["LATEX"]};var r={apiKey:"c26d2755-1fda-4033-b136-4af042f3f9db",equationInput:JSON.stringify(n)};var o=$.post(url,r.equationInput);o.done(function(t){var e=t.replace(/\\/g,"\\\\");e=JSON.parse(e);i(null,e.JSON)})};return e}();gmath.ui=gmath.ui||{};gmath.ui.holdUI=function(){var t=function(t,e){this.container=d3.select("body");this.controller=t;this.view=e;this.element=null;this.pos=[0,0];this.visible=false;this.buttons=[];this.button_els=null;this.colors=d3.scale.category10();this.button_rads=null;this.inner_radius=20;this.outer_radius=80;this.init();var i=this;showHoldUI=function(t){i.setPos([500,500]);i.setVisible(t)}};t.prototype.setPos=function(t){this.pos=t;this.element.style({left:t[0]-this.outer_radius+"px",top:t[1]-this.outer_radius+"px"})};t.prototype.setVisible=function(t){this.visible=t;this.element.style("display",t?null:"none");if(this.visible){var e=this.g.node().getBBox();this.element.style({width:e.width,height:e.height})}};t.prototype.init=function(){var t=this,e={stroke:"black","stroke-width":1,"stroke-linecap":"round",fill:"none"};if(gmath.array.includes(this.controller.hold_menu_options(),"derivation")){this.buttons.push({action:function(e){t.controller.inputDL(e,"holdUI")},icon:function(t){var e=t.append("g").attr("transform","translate(0,10)").append("g");var i=new gmath.AlgebraModel("f_x",{});var n=new gmath.AlgebraView(i,e,{font_size:"35",inactive_color:"black",interactive:false});n.init();return e},color:t.colors(0)})}if(gmath.array.includes(this.controller.hold_menu_options(),"graph")){this.buttons.push({action:function(e){var i={pos:{x:e[0],y:e[1]}};t.view.createGraph(i)},icon:function(t){var i=t.append("g").attr("transform","translate(2,0)").style("cursor","pointer");var n=i.append("g").style("opacity",.5).style("shape-rendering","crispedges");n.append("line").attr({x1:-15,y1:0,x2:15,y2:0}).style(e);n.append("line").attr({x1:0,y1:-15,x2:0,y2:15}).style(e);n.append("rect").attr({x:-15,y:-15,width:30,height:30}).style(e);i.append("line").attr({x1:-15,y1:8,x2:15,y2:-8}).style(e).style("stroke-width",1.5);return i},color:t.colors(1)})}if(gmath.array.includes(this.controller.hold_menu_options(),"textbox")){this.buttons.push({action:function(e){var i={pos:{x:e[0],y:e[1]}};t.view.createTextBox(i)},icon:function(t){var i=t.append("g");var n=i.append("g").style("opacity",.5);n.append("text").text("Aa").attr({x:0,y:10}).style("text-anchor","middle").style("font-size","30px").style(e).style("stroke","none").style("fill","black").style("pointer-events","none");return i},color:t.colors(2)})}this.button_rads=Math.PI*2/this.buttons.length;var i=this.button_rads,n=this.inner_radius,r=this.outer_radius;this.element=this.container.append("svg").style("overflow","visible").style("display","none").style("position","absolute");this.g=this.element.append("g").attr("transform","translate("+this.outer_radius+","+this.outer_radius+")");var o=this.element.append("defs"),s=o.append("filter").attr("id","dropShadow_holdUI");s.append("feGaussianBlur").attr("in","SourceAlpha").attr("stdDeviation",3);s.append("feOffset").attr("dx",0).attr("dy",4).attr("result","offsetblur");s.append("feComponentTransfer").append("feFuncA").attr("type","linear").attr("slope",.25);var a=s.append("feMerge");a.append("feMergeNode");a.append("feMergeNode").attr("in","SourceGraphic");this.element.attr("filter","url(#dropShadow_holdUI)");this.button_els=this.g.selectAll(".holdUI").data(this.buttons);this.button_els.enter().append("g").classed("holdUI",true).append("path").attr("d",function(t,e){var o=Math.cos(i*e)*n,s=-Math.sin(i*e)*n,a=Math.cos(i*e)*r,l=-Math.sin(i*e)*r,h=Math.cos(i*(e+1))*r,p=-Math.sin(i*(e+1))*r,u=Math.cos(i*(e+1))*n,c=-Math.sin(i*(e+1))*n;return"M"+o+","+s+"L"+a+","+l+"A"+r+","+r+" 0 0,0 "+h+","+p+"L"+u+","+c+"A"+n+","+n+" 0 0,1 "+o+","+s+"Z"}).style("fill",function(t){return t.color}).style("opacity",.8).style("cursor","pointer");this.button_els.each(function(t,e){var o=d3.select(this),s=t.icon(o);s.attr("transform",function(){var t=Math.cos(i*(e+.5))*(n+(r-n)/2),o=-Math.sin(i*(e+.5))*(n+(r-n)/2);return"translate("+t+", "+o+")"})})};t.prototype.detectHit=function(t){var e=this,i=this.button_rads,n=this.inner_radius,r=this.outer_radius,o=-1;this.button_els.each(function(s,a){var l=Math.sqrt(Math.pow(t[0]-e.pos[0],2)+Math.pow(t[1]-e.pos[1],2)),h=Math.atan2(-t[1]+e.pos[1],t[0]-e.pos[0]);if(h<0)h+=Math.PI*2;if(l>n&&l<r&&h>i*a&&h<i*(a+1))o=a});return o};t.prototype.highlight=function(t){var e=this.detectHit(t);this.button_els.each(function(t,i){var n=d3.select(this).select("path");if(e===i)n.transition().duration(30).style("fill",d3.rgb(t.color).brighter(.6));else n.transition().duration(30).style("fill",t.color)})};t.prototype.performAction=function(t,e){var i=this.detectHit(t);this.button_els.each(function(t,n){if(n===i)t.action(e)})};return t}();gmath.ui=gmath.ui||{};gmath.ui.CanvasController=function(){var t=function(t){var e=d3.dispatch("scroll","start_hwr","stop_hwr","undone","redone","hold","touch","drag","release","font_size","keyboard","entered_term","start-of-interaction","end-of-interaction","undoable-action");var i=gmath.uid(),n=t,r=null,o=[],s=-1,a=null,l=false,h=null,p=false,u=true,c,d=1500,f=null,g=n.paths().length,m=2,v=50,_=null,y="black",b=null,w=null,x=0,A=null,T=null,k=false,N=null,E=false,S=true,L=true,M="hold",C=["derivation","textbox","graph"],q=null,D=800,z=false,O=true;var I=function(){t.on("create."+i,function(t){if(t.target_type==="derivation"||t.target_type==="graph"||t.target_type==="textbox"||t.target_type==="image"){t.target.events.on("start-of-interaction."+i,function(t){n.setActive();e["start-of-interaction"](t)});t.target.events.on("end-of-interaction."+i,function(t){e["end-of-interaction"](t)});if(t.target_type==="derivation"){t.target.events.on("auto_undo."+i,function(t){setTimeout(function(){ht(t)},1)})}}});w=transform_behavior().allow_rotate(false).allow_scale(false).one_finger_drag(false).on("transform",function(){n.scroll(-d3.event.transform.translate[1])});if(L&&!N&&n.container()){N=new gmath.ui.holdUI(I,n)}X(t.background_event_layer(),Y());X(t.foreground_event_layer(),tt());t.on("mode."+i,G);d3.select(document).on("keydown."+i,P.bind(this,null));window.addEventListener("beforeunload",function(t){if(!O||!z)return;var e="You have not saved your work. Are you sure you want to leave the page?";(t||window.event).returnValue=e;return e});if(S&&typeof gmath.ui.Keyboard!=="undefined"&&typeof $!=="undefined"){h=gmath.ui.Keyboard();h.width(D).position("center")()}n.container().on("dragover",function(){d3.event.preventDefault()}).on("drop",ct);return this};function P(t){var e=t||d3.event;if(e.keyCode===27){if(q){I.cancelInsertElementOnNextClick()}else{n.setActive();n.setActive(null,false)}}}I.askConfirmationOnClosing=function(t){if(arguments.length===0)return O;O=t;return this};I.insertElementOnNextClick=function(t,e,i){I.simulateStartOfInteraction();n.foreground_event_layer_visible(true);q={type:t,options:e||{},callback:i};n.foreground_event_layer().style("cursor","copy")};I.cancelInsertElementOnNextClick=function(t){if(!q)return;q=null;if(n.getMode()!=="draw"&&n.getMode()!=="erase"){n.foreground_event_layer_visible(false)}n.foreground_event_layer().style("cursor","auto");if(t)I.simulateEndOfInteraction()};var F=function(t){var e=false;q.options.pos=t;switch(q.type){case"derivation":if(q.options.eq){n.createDL(q.options);e=true}else{I.inputDL([t.x,t.y],"toolbar")}break;case"textbox":n.createTextBox(q.options);e=true;break;case"graph":n.createGraph({pos:t});e=true;break;case"ggb":R(t);e=true;break;case"ggb-table":B(t);e=true;break;case"table":n.createElement("table",{pos:t});e=true;break;default:console.warn("unknown element type",q.type)}if(q.callback)q.callback(t);I.cancelInsertElementOnNextClick(e)};var R=function(t){var e=600,i=400;var r=n.createElement("ggb-element",{pos:{x:t.x-e/2,y:t.y-i/2},size:{width:e,height:i}});n.createElement("ggb-panel",{ggbElement:r,pos:{x:t.x+e/2,y:t.y-i/2},size:{width:75,height:i},min_size:{width:75,height:50}})};var B=function(t){var e=600,i=600;var r=n.createElement("ggb-element",{pos:{x:t.x-e/2,y:t.y-i/2},size:{width:e,height:i},ggb_params:{showMenuBar:false,showAlgebraInput:false,showToolBar:true,customToolBar:"0|40",showResetIcon:false,enableLabelDrags:false,enableShiftDragZoom:false,enableRightClick:false,errorDialogsActive:false,useBrowserForJS:true,preventFocus:false,language:"en"},ggb_base64:"UEsDBBQACAgIALyC9kgAAAAAAAAAAAAAAAAWAAAAZ2VvZ2VicmFfamF2YXNjcmlwdC5qc0srzUsuyczPU0hPT/LP88zLLNHQVKiu5QIAUEsHCEXM3l0aAAAAGAAAAFBLAwQUAAgICAC8gvZIAAAAAAAAAAAAAAAAFwAAAGdlb2dlYnJhX2RlZmF1bHRzMmQueG1s7ZpLb9s4EIDP219B6NQ9xJZky3aCOEVaYLEB0nSxCYq90tJY5oYitSIVy/n1S5F6OX7UVtzEbXMxOfTw9c1wSFE6/5BFFD1AIghnY8vp2BYC5vOAsHBspXJ6MrI+XLw7D4GHMEkwmvIkwnJseblmVU9JHdfr5WUoE+SM8RscgYixD7f+DCJ8zX0stepMyvis253P552y0Q5Pwm4Yyk4mAgupATExtorMmWpuqdK8p9Vd23a6/3y+Ns2fECYkZj5YSA02gClOqRQqCxQiYBLJRQxja5oyPx/FzVecWIjiCdCxxVJKLVTUGVsDz7p499u5mPE54pN/wVdlMkmh0tdCN9dRf3/ilCcoGVuu3beQQqYITPQvpvEMq1xn6BltiheQoAdM8791CU4l93UDunSKqYBSV3X1mQdg/ukX+oxEmiISEmJlLQuJGCDQOTND1XGsOtLWq9o77xYYVoBQImQ1sWstVCCcnr1KwrS5HYWtQTj2UxQnuXdp7UlYc/M8ra7TSZEWFfL8K6NT7REGt3JBAckZ8e8ZCOWcbqNSnvmTBAHk68fUiTlh8pY8FmPwmqW6KV184mw3TszpIuSsov1XKVcmGhoLtRnivv7teD1tJ89ZcXDntY20HWFOZ4mhKaghOi8G0d4QIuxjJqictoFPSej9NAH4vRkq1kSKPXE01/3LAnHWr3uf8yQQKBtbN/jGQosifTTpHsvcbgE4gBiY8jS5RNlpRXkw0pjzZGKSHxtz71CYvzRDqeO2guu4ZvvS6ZsbL/G9Yn9DSJY2LKf3RvnAlJe9uP9LBmKtYiiK/Hds+TyKKWQHRE+5n4r6rGykCvzo+TvgUR0I8p4yQglOFqs97X1S2vYA0jicXS8fzNyfjukOrtzmGAr/sSXnJ8r3iU/kdvQCwlyqaN6Wcm2AdgeOX88APJU07+uKSUgE6DsGsTKZe4D4TlX+wu4SzER+k2J0SoybbbXLxYXbbm/dHPvdV3/6/jaQjTCevxEemeseMuomeLFt2be7ATtidj/qsn9QbfJ6wX8txMpS627o3iy1xlJrDog4kSAIZtstICGrd8g7LTRuPY4S/+bJ+JwRvxrcJyNV0+kf5Wxe+uoWSAjMrDuBUGYX70QWtpkTeixLMqcoWThFyWOR0e2oISckQ5dlvctS/dItM70y0y8zXgNcu0OdNnGsfLsR358EjX67U90xXwD/xKZ+gV1GMQ9r618ZqXHraOLClKgBMhypCqZHwj5i/z5MeMqCleEcJoo4rx9FNmNjaQRJI57elHKFzjPk1DDS8o6hnNAuEdT51kwFJYHCEhHl0yfq5B7hLL/dQHgiOE0l3PoJAKtfvRo7zEkgZ/nTtXbErHTtIp2SLIdiVGc8IY+cycqPUG7XS6rf2jZN2Wb5PbVIPuHn2gSzkNaudmmk2h7mjlcrPb34WW+mJmG7ADzouKOeM/J69tAZnnqjwY7AndEBgR/spewBo/deTuAWfSR+42bf3uQZ9mjoDgb9geudng6dQX/4bE+ZcE4B18+PH0u58UZgZfluCnC7G+A7npP8Gfj3E54tedR+D9F/VAX15xCvcypshJaXOCn0dn2O7ja+LemW369c/A9QSwcILVCearIEAABGIwAAUEsDBBQACAgIALyC9kgAAAAAAAAAAAAAAAAXAAAAZ2VvZ2VicmFfZGVmYXVsdHMzZC54bWztl8lu2zAQhs/NUxC8R6uVDVYCIz20QBK0yKVXmhrLbCVSIelFebW+Q5+pFEU6yuIUNVy0BXIxh8PhkPp+ciSPL9Z1hZYgFRM8x3EQYQScioLxMscLPTs8wRfnB+MSRAlTSdBMyJroHGdd5Gae6QVJlnY+tFbsjIsbUoNqCIVbOoeaXAlKtA2da92cheFqtQp80kDIMixLHaxVgZHZEFc5dsaZSfdo0iq14UkUxeGX66s+/SHjShNOASOz2QJmZFFpZUyooAaukW4byHFTEQ6pWaMiU6hy/Mn232PkZuQ4NXnx+cG7sZqLFRLTr0CNV8sFbCbZTtjFmOFLUQmJZI5PTzEyxJLYtFPXkqqZkxxHQdbHV6QFiZbEJIl6D1loQW0K652RSoGPNYtdiwL6kVHvpULIQqF1l9Swbl1779pV39rQGek0dKsFscvKONzqtgKk54x+46BUtxeHxxkfWFFAdxi6OePQIXwGkwrO6ADmR67NcTC8jMyILuQShlzjbDeuSZZZsHFybMFGA6zxvrASzmp7PJHS0HRPjlQDUFhrw8acntZei2G+l4AmrwF9NwZWAl8aAEIqc10id+3ayKvpPevY6xw7z70zbB6zZcnWaOLnTXz4JPFG6o2RN7LBEYE73u9ddb85ZnVTMcr067qTNVMD2Sdd99EViqN0J6kjK3T0TOboP5X5Cd2GSFMTjWTUrNHbYJ76x/dfXLPuJlEiNShG+AD8ZTfwlPzRG/ntKBtRtXMopOAPb4CB64Fj6l4Cu8j+u+zjLLX0s/gZ/tHfxr8d5d2CFPYku2f77PtDiPFuFT8abTmOx3t7j/6psh1tL9v9kK/MrTfukz1VdDQ58saxN068cbq5zdslVQs5M99rL5UaN/RY3dE/q+6eq028W7XhoDcsbjp7CC97qy9P4IWDr/bQ/zM4/wlQSwcIDmF7u7sCAACgDAAAUEsDBBQACAgIALyC9kgAAAAAAAAAAAAAAAAMAAAAZ2VvZ2VicmEueG1s3Vptc9s2Ev6c/goMP92LJQEgQYoZKR3biXuZSZvMOe3c3De+QBJjimRJypY7/fG3C4AUJdmKaTs5ubZpkCCwwD7PYncBafLjepmSa1lWSZ5NLTakFpFZlMdJNp9aq3o2GFs/vvlhMpf5XIZlQGZ5uQzqqSWwZdsPnoZc2FiXxFPLphELPEcOZOi5AycM/YEfRs5gFvoeE44nZjPbImRdJa+z/JdgKasiiORltJDL4EMeBbUSuqjr4vVodHNzM2yGH+blfDSfh8N1FVsEpp5VU8vcvAZxW51ubNWcU8pG//n5gxY/SLKqDrJIWgTVWiVvfng1uUmyOL8hN0lcL6aW7/kWWchkvgA9PZ9ZZISNClC2kFGdXMsKunYelc71srBUsyDD96/0HUlbdSwSJ9dJLMupBWBRh/uU+sy3qXCY7VkkLxOZ1aZxM+ioETe5TuSNlot3akiH+tDvOqmSMJVTaxakFaiVZLMSIIUZlSt4rOrbVIZB2TxvJsRO1C80Sf6QKA3Y00hMrbHDTmzhn3iUnghB9Ww6QwvGLVLneaokU/InYURQuAjzyQlxPajhhAniQM0YajxiY51gDrEJNmE2cRwoHaxmLr4T0F9QwhhUE04J54Qzwm14FIIIlwgPO3Jo6/pKGIULW8N04LKxzrbhUnW2AxfHOxAktBiYhLBddSewNcgXHKevKu0xcXwYCCuEx4gNc4BnjxKQaKN4ppRwKME/RhwUzz3CxwTkgd4omfIDpJjnDSumYoeWhhTRJYUBGXi5cCm2dkhxtikBBijodoIF0wVO13X1K6rrqK0LrgtHF0K3cXR3RzfV2lJHt3Hsp6rZKGn3UXLcUZKhEkAKzl4VNsF5MzV/LBzz6OpHZWqUUVM7xn8+PgAm7ljdPFEn+1E6sc6oepX2GbQZ0nfHDx/yaTbaqsnvUpOLe9R8IrrNoEx0BoWx1J+69oa0e+m55yEfMaK7tQqf4p4fMbhH73QBumSmPATJs01qMmoC1sRMiFQLbGvsu5bLCqdo+23scNG7mwDi8U4AOcEQ4opNFMEYMt6KImLcCSUQR1ys9FRcgjEwEOiwwp0mspyY2PLnXmyBUOBsogFMDUWhnzHhAEbn3YDAwXlw4qEfheiGfoRwEMkJxBEX+90TKyxS5FXS4rqQadESoiBMsmJVG9hMfbSMGwjrHJoHqcqLTIc4j67OdpCWQVU399AIMopN4qIzjK285tUkDUKZQvp3iUZAyHWQoh0r+bM8q0ljANxS4lQKNZGrKE3iJMh+A9abdOWX1TKUJVG3OeqohGB30uZa6LPaXIvaukmU52V8eVuBkZD1f2UJnR0PctPuD8B3q1/ZXAz9zg9IrKIArdvxt174Y+x03zs9tLy+lHUN6lckWMuqQW5e4vIyJODD++osTzdVRZ5k9XlQ1KtSZc7gIEtU6jSbp1IhqTiGFDS6CvP1pXaerpb1+baQLcbh/DxP85LA4uNCQANThrpUbXBmbSuq2lDVwshAoe175nPVQpWhLlUrIFlPzWjKGjVpM0pSEf28ZVHKQDCfXWVJ/aF5qJPoaqMottf0NxBui2TPJHIy2rG8yZUsM5lqK8qAyFW+qrQRa6rUPFaV/BTUi9Ms/recwwL8FKD7q0G0brqZcSyjZAkddb1BLkBWf4Wp6tpYzkvZaKgXpMbVrB1SFaUM4mohZd2iq22822wj+qLMl++z689gQjtTn4wa/SZVVCYFWioJwT9fyY0xxkkVgHePu/0AjAq0itDdALA1gmqRYFUv8lLtTYIaa3Apr2G2Fe7rNC1kai3BjazB2wzU+pzIVC5hq0JqZbfZainLJGpJXKptEEx7ZTQb4L5QL32gkOThF/A2m/iue20Qh/f32DYJ0mIR4PbJuJI0uEX/0oFPSfs5j83QrAEVOFSag0sptDUVUmo7rM3qIwWIU4u3g7ZR9W5YQgMLfwAq4S4q/K8ICgQkg8ktmZK/Lck/yPrv5J8kbCSiz9FxaBsuXd/K2MNly00YkOQ1bnkeDA99IDzd9VmRNfhyPNa4NYcjf4A9t9RtPGi9AF8FO/VKZdYtenjzrySOZdbCLn/PdJdKezZAK02ipN6FNsqXyyCLSabysk8YX6xNUhBQhEnrvqqbmlMtxHTdA1kFqRbF032Ut61vH2ZwInGiTQa6fTS9yn0OGNeRS5Umcj2UiY+zWSVrBH6sYWeHaHqAFbO7rLhLMPBpq6EGzpD6imPWTFJhhuFajyq6tTvO+6nsnfVh76z3GvmLkseGtnA0e8Cjy78BfR9LiJLzPAvSD+imtnk8A2zY1FqfQmqzR2l0mNItrxd9bT32iwaPdncDZvwdNf5OI/xsDi9ZPsThHcT89BDmcQ/M42PFXLmkI4T89k7IZQ/I5bFATg3kgzauK+9/TKCfHQJ91gP02fGCrp32d0b9fYZ7PcBhB3B5CPDzPvH5/EGI35fD4qnIXBehLp4T+69mOfajwuR9oM4Ogfq2D6hvjxjUrycfz4tqdCgGvuuD6rujQ7WT022SkO8BanwI1Is+oF4cHaibXc63wfRSzrF+B9FzjejbPTTnh9GsjLQGrvm32+80x6x949xmrzOwtbW6dzLB95wGUMHHW/kePXikIA7HQEA1xR1Sa9Wg9P6Z55WUBZ40f8w+l0FW4Rc5tg87+1L7TlN7sUftoh+1i29HbTeB6bONPbCMaJupu57ofoDgvVgi32oiz/aITPoRmXwfIp8lE21oNKFGbbk8n/nO+AB9dkMfPyr+jI893ePvSz/+vrxA/nRUA/rGQ5ty7+WR9+6+xXfVj7yrF0SeyZU78W/wclffxX2rL+1HYPqCCNQ7yC5/x7/8HnYI/1OfJP+nZ6Ks2KfsKYfwXz1nx88KH/MxiT02uzIxZIJ1k59nOXXfhjrM81QGWQtmsfsJ6ubM6v92sGW+zkFmyVrGdxvhYaXKl6nUqPt1AvUtIPMF7Tf/A1BLBwiaLk/eqggAAFEuAABQSwECFAAUAAgICAC8gvZIRczeXRoAAAAYAAAAFgAAAAAAAAAAAAAAAAAAAAAAZ2VvZ2VicmFfamF2YXNjcmlwdC5qc1BLAQIUABQACAgIALyC9kgtUJ5qsgQAAEYjAAAXAAAAAAAAAAAAAAAAAF4AAABnZW9nZWJyYV9kZWZhdWx0czJkLnhtbFBLAQIUABQACAgIALyC9kgOYXu7uwIAAKAMAAAXAAAAAAAAAAAAAAAAAFUFAABnZW9nZWJyYV9kZWZhdWx0czNkLnhtbFBLAQIUABQACAgIALyC9kiaLk/eqggAAFEuAAAMAAAAAAAAAAAAAAAAAFUIAABnZW9nZWJyYS54bWxQSwUGAAAAAAQABAAIAQAAOREAAAAA"});r.events.on("ggb_init",function(){r.ggbApplet.setCoordSystem(-10,10,-10,10);n.elements().forEach(function(t){if(t.type=="table")t.setGraph(r)})})};function G(t){if(t.mode==="arrange")n.setActive(null);if(t.mode==="draw"||t.mode==="erase"){n.foreground_event_layer_visible(true);n.setActive(null)}else{n.foreground_event_layer_visible(false)}}I.id=i;I.logger=function(t){r=t;r.events.on("interaction."+i,this.addInteractionSummaryToTimeline.bind(this))};I.model=function(){if(arguments.length===0)return n};I.use_keyboard=function(t){if(arguments.length===0)return S;S=t;return this};I.keyboard_max_width=function(t){if(arguments.length===0)return D;D=t;return this};I.use_hold_menu=function(t){if(arguments.length===0)return L;if(Array.isArray(t)){I.hold_menu_options(t.filter(function(t){return C.indexOf(t)!==-1}))}L=Array.isArray(t)?true:t;if(L&&!N&&n.container()){N=new gmath.ui.holdUI(I,n)}return this};I.hold_menu_options=function(t){if(arguments.length===0)return C;C=t};I.color=function(t){if(arguments.length===0)return y;y=t;return this};I.markerRadius=function(t){if(arguments.length===0)return m;m=t;return this};I.eraserRadius=function(t){if(arguments.length===0)return v;v=t;return this};I.hwr_delay=function(t){if(arguments.length===0)return d;d=t;return this};I.hwr=function(t){if(!arguments.length)return u;if(u===t)return I;u=t;g=n.paths.length;if(!u)I.cancelHWR();return I};I.drawing=function(t){if(!arguments.length)return c;c=t;return this};I.scheduleHWR=function(){if(!f){f=setTimeout(I.performHWR,d);e.start_hwr()}};I.cancelHWR=function(t){if(!t)g=n.paths.length;if(f){clearTimeout(f);f=null;e.stop_hwr()}};I.performHWR=function(){f=null;e.stop_hwr();if(g>n.paths().length-1)return;var t=n.paths().slice(g),i=false,r=[];gm_hwr_request(t,function(e,o){if(e)console.log(e);var s=t[0].points[0];try{i=n.createDL({pos:{x:s[0],y:s[1]},eq:o})}catch(t){return}var a=function(t){try{n.removePath(t);r.push(t)}catch(t){return}};for(var l=0;l<t.length;l++){a(t[l])}g=n.paths().length});g=n.paths().length};I.font_smaller=function(){var t=parseInt(DerivationList.defaultOptions.font_size);if(t/1.2>12)this.set_font_size(t/1.2)};I.font_larger=function(){var t=parseInt(DerivationList.defaultOptions.font_size);if(t*1.2<160)this.set_font_size(t*1.2)};I.set_font_size=function(t){DerivationList.defaultOptions.font_size=t;n.dls().forEach(function(e){e.setFontSize(t)});e.font_size(new Z(t))};var j=function(t){return n.createPath({points:[[t[0],t[1]-x]],color:n.setMode()==="draw"?y:"white",width:n.setMode()==="draw"?2*m:2*v})};var H=function(t){this.type="hold";this.subType=t.subType;this.performee=i;this.performee_type="CanvasController";this.time=Date.now();this.finger={pos:[t.finger.pos[0],t.finger.pos[1]]};this.fingers=t.fingers.map(function(t){return{pos:[t.pos[0],t.pos[1]]}})};var V=function(t){this.type="touch";this.subType=t.subType;this.performee=i;this.performee_type="CanvasController";this.time=Date.now();this.finger={pos:[t.finger.pos[0],t.finger.pos[1]],pos0:[t.finger.pos0[0],t.finger.pos0[1]]};this.fingers=t.fingers.map(function(t){return{pos:[t.pos[0],t.pos[1]]}})};var W=function(t){this.type="drag";this.subType=t.subType;this.performee=i;this.performee_type="CanvasController";this.time=Date.now();this.finger={pos:[t.finger.pos[0],t.finger.pos[1]]};this.fingers=t.fingers.map(function(t){return{pos:[t.pos[0],t.pos[1]]}})};var U=function(t){this.type="release";this.subType=t.subType;this.performee=i;this.performee_type="CanvasController";this.time=Date.now();this.finger={pos:[t.finger.pos[0],t.finger.pos[1]]};this.fingers=t.fingers.map(function(t){return{pos:[t.pos[0],t.pos[1]]}})};var Z=function(t){this.type="fontSize";this.performee=i;this.performee_type="CanvasController";this.time=Date.now();this.font_size=t};var J=function(t){this.type="enteredTerm";this.performee=i;this.performee_type="CanvasController";this.time=Date.now();this.eq=t.eq;this.dl_id=t.id;this.options=gmath.deepCopy(t)};var K=function(t){this.type="enteredGraph";this.performee=i;this.performee_type="CanvasController";this.time=Date.now();this.graph_id=t};var Q=function(){this.type="keyboard";this.performee=i;this.performee_type="CanvasController";this.time=Date.now()};function X(t,e){t.call(e);e.frame(t.node())}function Y(){if(M==="hold"){var t=mtouch_events().on("touch",et.bind(this,null)).on("hold",it.bind(this,null)).on("drag",nt.bind(this,null)).on("tap",function(){n.setActive(null)}).on("release",rt.bind(this,null)).hold_max_dist(5).hold_time(500).call(w)}else if(M==="tap"){var t=mtouch_events().on("tap",function(){if(!L)return;if(N.visible)rt();else{it();N.element.attr("pointer-events","none")}}).hold_max_dist(5).hold_time(500).call(w)}return t}function tt(){var t=mtouch_events().on("touch",ot.bind(this,null)).on("drag",st.bind(this,null)).on("release",at.bind(this,null)).hold_max_dist(5).hold_time(500);return t}var et=function(t){if(!L||k)return;var n=t||d3.event;if(!t&&d3.event){e["start-of-interaction"]({type:"start-of-interaction",source:{type:"CanvasController",id:i},time:Date.now()});e.touch(new V(gmath.extend(d3.event,{subType:"menu"})))}if(n.fingers.length>1){k=true}};I.menu_touch=et;var it=function(t){if(!L||k||S&&h.visible())return;var i=t||d3.event;if(!t&&d3.event){e.hold(new H(gmath.extend(d3.event,{subType:"menu"})))}n.setActive();menu_pos=i.finger.pos.slice();N.setPos(i.finger.pos_client.slice());N.setVisible(true)};I.menu_hold=it;var nt=function(t){if(!L||k)return;var i=t||d3.event;if(!t&&d3.event){e.drag(new W(gmath.extend(d3.event,{subType:"menu"})))}if(N.visible){N.highlight(i.finger.pos_client.slice())}};I.menu_drag=nt;var rt=function(t){var n=t||d3.event;if(!t&&d3.event){e.release(new U(gmath.extend(d3.event,{subType:"menu"})))}if(k){if(n.fingers.length===0)k=false;return}if(N&&N.visible){N.performAction(n.finger.pos_client.slice(),menu_pos);N.setVisible(false)}if(!t&&d3.event&&(!h||!h.visible())){e["end-of-interaction"]({type:"end-of-interaction",source:{type:"CanvasController",id:i},time:Date.now()})}};I.menu_release=rt;var ot=function(t){if(q||A)return;var r=t||d3.event;if(!t&&d3.event){e["start-of-interaction"]({type:"start-of-interaction",source:{type:"CanvasController",id:i},time:Date.now()});e.touch(new V(gmath.extend(d3.event,{subType:"draw"})))}if(r.fingers.length>1){k=true}if(!c||k)return;console.log(A);var o=r.finger.pos0.slice();o[1]-=x;I.cancelHWR(true);A=j(r.finger.pos0);if(n.setMode()==="erase"){_=n.paths_container().append("circle").attr({cx:o[0],cy:o[1],r:v}).style({stroke:"silver",fill:"white"})}};I.draw_touch=ot;var st=function(t){if(q)return;var i=t||d3.event;if(!t&&d3.event){e.drag(new W(gmath.extend(d3.event,{subType:"draw"})))}if(!A||k||!c)return;var r=i.finger.pos.slice();r[1]-=x;A.points.push(r);n.updatePath(A);if(n.setMode()==="erase")_.attr({cx:r[0],cy:r[1]})};I.draw_drag=st;var at=function(t){var r=t||d3.event;if(q){F({x:r.finger.pos[0],y:r.finger.pos[1]});return}if(k){if(r.fingers.length===0)k=false;return}if(!A||r.fingers.length>0)return;if(n.setMode()==="draw"){if(u&&(!h||!h.visible()))I.scheduleHWR()}else if(n.setMode()==="erase"){_.remove();lt()}A=null;if(!t&&d3.event){e.release(new U(gmath.extend(d3.event,{subType:"draw"})));e["end-of-interaction"]({type:"end-of-interaction",source:{type:"CanvasController",id:i},time:Date.now()})}};I.draw_release=at;var lt=function(){var t=n.paths().slice(),e=t[t.length-1],i=[],r=[],o=[];t.forEach(function(t,s){if(t===e)return;var a=v+t.width/2;var l=gm_erase_paths([t.points],e.points,a);if(l.length===0){r.push(t);n.removePath(t)}else{o.push({path:t,points_before:t.points.slice(),points_after:l[0].slice()});t.points=l[0];n.updatePath(t);for(var h=1;h<l.length;h++){var p=n.createPath({points:l[h],color:t.color,width:t.width,oid:t.id});i.push(p)}}});n.removePath(e);eraseModification={removed:r,modified:o,added:i}};I.addInteractionSummaryToTimeline=function(t){z=true;if(t.length===1&&t[0].subtype==="save")z=false;var i=Timeline.entry(t,n);if(i){if(i.type==="erase"){i.modification=eraseModification;eraseModification=null}s++;o[s]=i;o.length=s+1;e["undoable-action"](i.type)}};I.reset=function(){r.listen(false);n.reset();o=[];s=-1;a=null;l=false;w.transform({translate:[0,0]});A=null;T=null;k=false;z=false;r.listen(true)};I.undo=function(){if(s===-1)return false;r.listen(false);var t=o[s];s--;t.undo(n,this);r.listen(true);return true};I.redo=function(){if(o.length<=s+1)return false;r.listen(false);s++;var t=o[s];t.redo(n,this);r.listen(true);return true};function ht(t){o.pop();s--}I.clearInteractionTimeline=function(){s=-1;o=[]};I.clear_undo_queue=function(){throw"(CanvasController) Deprecated method `clear_undo_queue` called."};I.inputDL=function(t,i){if(p)return;e.keyboard(new Q);I.cancelHWR(true);T={pos:{x:t[0],y:t[1]-x},v_align:"center",h_align:"equals"};h.caption(null).latex("").on("done",function(t){pt(t,i)}).on("cancel",ut).visible(true)};var pt=function(t,r){if(!T)return;if(t===""){h.visible(false);return}T.eq=t;T.id=gmath.uid();e.entered_term(new J(T));var o;var s=false;try{o=n.createDL(T,null,r);T=null}catch(t){console.log(t);h.warning("Could not parse expression.");return}h.visible(false);e["end-of-interaction"]({type:"end-of-interaction",source:{type:"CanvasController",id:i},time:Date.now()})};var ut=function(){h.visible(false);e["end-of-interaction"]({type:"end-of-interaction",source:{type:"CanvasController",id:i},time:Date.now()})};I.disableKeyboard=function(t){p=t};I.simulateStartOfInteraction=function(){e["start-of-interaction"]({type:"start-of-interaction",source:{type:"CanvasController",id:i},time:Date.now()})};I.simulateEndOfInteraction=function(){e["end-of-interaction"]({type:"end-of-interaction",source:{type:"CanvasController",id:i},time:Date.now()})};function ct(){var t=d3.event;t.preventDefault();var r=d3.mouse(this);var o=dt(t.dataTransfer)||ft(t.dataTransfer);if(!o){console.log("could not parse drop data",t);var s={drop_evt:t,pos:{x:r[0],y:r[1]}};var a=n.createImage(s,"drag-n-drop");return}if(o.slice(0,4)==="http"){var s={drop_evt:t,pos:{x:r[0],y:r[1]}};var a=n.createImage(s,"drag-n-drop")}else{o=o.replace(/\\end{alignat}/g,"");o=o.replace(/\&\\\,/g,"");o=o.replace(/\\\,/g,"");o=o.replace(/\&/g,"");o=o.replace(/\\begin{alignat}{[0-9]*}/g,"");o=o.replace(/\\\;/g,"");o=o.replace(/[.,\s\\]+$/,"");var l=o.split("\\\\");if(o.length===0)return;try{e["start-of-interaction"]({type:"start-of-interaction",source:{type:"CanvasController",id:i},time:Date.now()});n.createDLs(l,{pos:{x:r[0],y:r[1]}},null,"drag-n-drop");e["end-of-interaction"]({type:"end-of-interaction",source:{type:"CanvasController",id:i},time:Date.now()})}catch(e){console.log("Could not parse equation!",e);var s={drop_evt:t,pos:{x:r[0],y:r[1]}};var a=n.createImage(s,"drag-n-drop")}}}function dt(t){var e=t.getData("text/html");var i=document.createElement("div");var n=d3.select(i).html(e).select("img");return n.size()===1?n.attr("alt"):null}function ft(t){return t.getData("text/plain")}return d3.rebind(I,e,"on")};return t}();gmath.ui=gmath.ui||{};gmath.ui.CanvasModelView=function(){var t=function(){var t=d3.dispatch("create","update","remove","reset","mode"),e=null,i,n,r,o,s,a,l,h,p,u=[],c=[],d=[],f=[],g=["edit","inspect","arrange","draw","erase"],m=0;function v(t){t.dl.draw_mappings_for_nodes([t.node])}var _=function(t){e=t;n=e.append("div").style({position:"absolute",left:0,right:0,top:0,bottom:0});h=n.append("div").style({position:"absolute",left:0,right:0,top:0,bottom:0});i=n.append("svg").classed("gm-canvas-svg",true).style({position:"absolute",width:"100%",height:"100%"}).style("pointer-events","none");s=i.append("g").attr("id","g_graphs");o=i.append("g").attr("id","g_paths");g_imgs=i.append("g").attr("id","g_imgs");a=i.append("g").attr("id","g_textboxes");r=i.append("g").attr("id","g_dls");p=e.append("div").style({position:"absolute",left:0,right:0,top:0,bottom:0}).style({display:"none","pointer-events":"all"});return this};_.reset=function(){for(var t=u.length-1;t>=0;t--)this.removeElement(u[t]);for(var t=c.length-1;t>=0;t--)this.removePath(c[t]);f=[];this.scroll(0)};_.setActive=function(t,e){if(arguments.length<2)e=true;if(t)t.setActive(e);u.forEach(function(e){if(e!==t){e.setActive(false);if(!t&&(e.type==="table"||e.type==="textbox")){e.unselect()}}})};_.focusOnDL=function(t){t.events.on("end-of-interaction."+this.id,t.initPosition.bind(t,true))};_.createDL=function(e,i,n){var r=new DerivationList(_,this.getContainer("derivation").node(),e,function(t){o(t);if(i)i(t)});function o(e){if(u.indexOf(e)!==-1)return;e.setMode(g[m]);e.events.on("inspect_node",v);u.push(e);d3.selectAll(".derivation-list").data(_.dls());
var i={type:"create",target_type:"derivation",target:e};if(n)i.method=n;t.create(i)}o(r);return r};function y(t){if(t==="canvas-element")return gmath.CanvasElementClass;if(t==="image")return gmath.ui.CanvasImage;if(t==="textbox")return gmath.ui.TextBox;if(t==="graph")return gmath.ui.Graph;if(t==="derivation")return gmath.DerivationList;if(t==="ggb-panel")return gmath.ui.GeoGebraPanel;if(t==="ggb-element")return gmath.ui.GeoGebraCanvasElement;if(t==="table")return gmath.ui.Table;throw'unkown element type "'+t+'"'}_.getContainer=function(t){if(t==="canvas-element")return n;if(t==="image")return n;if(t==="textbox")return n;if(t==="graph")return s;if(t==="derivation")return n;if(t==="ggb-panel")return n;if(t==="ggb-element")return n;if(t==="table")return n;throw'unkown element type "'+t+'"'};_.createElement=function(e,i,n,r){var o=_.getContainer(e);var s=y(e);var a=new s(_,o.node(),i,function(t){l(t);if(r)r(t)});function l(i){if(u.indexOf(i)!==-1)return;i.setMode(g[m]);u.push(i);t.create({type:"create",target_type:e,target:i,method:n})}l(a);return a};_.createImage=function(e,i){var n=new gmath.ui.CanvasImage(_,this.getContainer("image").node(),e);u.push(n);t.create({type:"create",target_type:"image",target:n,method:i});return n};_.createTextBox=function(t,e,i){return _.createElement("textbox",t,i,e)};_.addElement=function(e){if(e in u)throw"element is already part of this canvas";b(f,e);e.canvas_model=_;e.initElement(_.getContainer(e.type).node());e.setMode(g[m]);u.push(e);t.create({type:"create",target_type:e.type,target:e});return _};_.addDL=function(e){b(f,e);if(u.indexOf(e)!==-1)throw"dl is already in this model";e.canvas_model=_;e.initElement(this.getContainer("derivation").node());e.setMode(g[m]);e.events.on("inspect_node",v);_.setActive(e);u.push(e);d3.selectAll(".derivation-list").data(_.dls());t.create({type:"create",target_type:"derivation",target:e});return e};_.addImage=function(e){b(f,e);e.canvas_model=_;e.initElement(g_imgs.node());e.setMode(g[m]);u.push(e);t.create({type:"create",target_type:"image",target:e})};_.addTextBox=function(e){b(f,image);e.canvas_model=_;e.initElement(a.node());e.setMode(g[m]);u.push(e);t.create({type:"create",target_type:"textbox",target:e});return e};_.createDLs=function(t,e,i,n){var r=0;o();function o(s){if(r===t.length){if(i)i()}else{if(s)e.pos[1]+=s.dims.height;var a=gmath.deepCopy(e);a.eq=t[r++];_.createDL(a,o,n)}}};_.isInFreeVisibleSpace=function(t,e){var i=this.viewport();if(t.y<i.y||t.y+t.height>i.y+i.height)return false;return this.getIntersectingElements(t,e).length===0};_.getIntersectingElements=function(t,e){return u.filter(function(i){if(e===i)return false;return gmath.HitTester.overlaps(t,i.getBBox())})};_.moveToFreeSpace=function(t,e){var i=t.getBBox(),n=this.viewport(),r={x:n.x,y:n.y,width:i.width,height:i.height},o;while(r.y+r.height<n.y+n.height){while(r.x+r.width<n.x+n.width){o=this.getIntersectingElements(r,t);if(o.length===0){t.translateElement(r,e);return true}else{var s=d3.max(o,function(t){return t.pos.x+t.size.width});r.x=s+1}}r.x=n.x;r.y=r.y+n.height/20}return false};_.createPath=function(e,i){var n=new gmath.ui.Path(o.node(),e);c.push(n);var r={type:"create",target_type:"path",target:n};if(i)r.method=i;t.create(r);return n};_.removePath=function(e){b(c,e);e.remove();t.remove({type:"remove",target_type:"path",target:e})};_.addPath=function(e){if(c.indexOf(e)!==-1)throw"path is already in this model";e.setContainer(o);e.init();c.push(e);t.create({type:"create",target_type:"path",target:e});return e};_.updatePath=function(e){e.update();t.update({target_type:"path",target:e})};_.createGraph=function(e){e.view=_;var i=new gmath.ui.Graph(s.node(),e);d.push(i);t.create({type:"create",target_type:"graph",target:i});return i};_.removeGraph=function(e){b(d,e);e.remove();t.remove({type:"remove",target_type:"graph",target:e})};_.removeElement=function(e){b(u,e);f.push(e);var i=e.removeElement();t.remove({type:"remove",target_type:e.type,target:e});return i};var b=function(t,e){if(t.length===0)return false;var i=t.indexOf(e);if(i===-1)return false;t.splice(i,1);return true};_.elements=function(){return u};_.dls=function(){return _.getElementsOfType("derivation")};_.graphs=function(){return d};_.textboxes=function(){return _.getElementsOfType("textbox")};_.images=function(){return _.getElementsOfType("image")};_.getElementsOfType=function(t){return u.filter(function(e){return e.type===t})};_.getElementByID=function(t){for(var e=0;e<u.length;e++)if(u[e].id===t)return u[e];for(var e=0;e<c.length;e++)if(c[e].id===t)return c[e]};_.getDeletedElementByID=function(t){for(var e=0;e<f.length;e++)if(f[e].id===t)return f[e]};_.paths=function(e){if(!arguments.length)return c;for(var i=0;i<c.length;i++)c[i].remove();c=e.slice();for(var i=0;i<c.length;i++){c[i].setContainer(o);c[i].init()}t.reset({target_type:"path",target:c.slice()})};_.scroll=function(t){if(arguments.length===0)return e.node().parentNode.scrollTop;e.node().parentNode.scrollTop=t;return this};_.container=function(){return e};_.background_event_layer=function(t){return h};_.foreground_event_layer=function(t){return p};_.foreground_event_layer_visible=function(t){if(!arguments.length)return p.style("display");p.style("display",t?null:"none")};_.dls_container=function(t){if(!arguments.length)return r;r=t;return this};_.paths_container=function(t){if(!arguments.length)return o;o=t;return this};_.graphs_container=function(t){if(!arguments.length)return s;s=t;return this};_.textboxes_container=function(t){if(!arguments.length)return a;a=t;return this};_.size=function(){var t=e.node();return{width:t.clientWidth,height:t.clientHeight}};_.viewport=function(){var t=e.node().parentNode;return{x:0,width:t.clientWidth,y:t.scrollTop,height:t.clientHeight}};_.getMode=function(){return g[m]};_.setMode=function(e){if(arguments.length===0)return g[m];m=g.indexOf(e);u.forEach(function(t){t.setMode(e)});t.mode({type:"mode",mode:e});return this};return d3.rebind(_,t,"on")};return t}();gmath.ui=gmath.ui||{};gmath.ui.resource_path="../shared/";gmath.ui.CanvasFactory=function(){var t=function(e,i,n){this.id=gmath.uid();this.container=d3.select(e);i=i||{};this.options=gmath.object.merged(gmath.deepCopy(!i.minimal?t.defaultOptions:t.minimalOptions),i);if(gmath.log_ga&&this.options.disable_ga_tracking)gmath.log_ga.enabled(false);var r;if(this.options.parse_url_options){r=gmath.getURLParameter("options");try{if(r)r=JSON.parse(r)}catch(t){console.error("Error parsing url options: ",t)}}if(r)gmath.extend(this.options,r);this.events=d3.dispatch("button");this.model=gmath.ui.CanvasModelView();this.controller=gmath.ui.CanvasController(this.model).drawing(this.options.drawing).hwr(this.options.hwr).use_keyboard(this.options.use_keyboard).use_hold_menu(this.options.use_hold_menu).keyboard_max_width(this.options.keyboard_max_width).askConfirmationOnClosing(this.options.ask_confirmation_on_closing);this.init();if(this.options.overflow_visible){this.scroll_div.style("overflow","visible");this.content_div.style("overflow","visible")}if(n&&this.options.savefile_server){this.remove();var o=this.getOptionsForFileLoading();if(r)gmath.extend(o,r);gmath.CanvasSaver.loadSaveFile(this.container.node(),this.options.savefile_server+"/api/saves/canvas_save_files",n,o)}this.logger=new DataLogger(this,this.options.log_mouse_trajectories);this.controller.logger(this.logger);if(this.options.parse_url_query_params&&!(n&&this.options.savefile_server)){this.parseURLQueryParams()}};gmath.ui.CanvasFactoryClass=t;t.prototype.serialize=function(){return JSON.stringify(this.model.dls().concat(this.model.graphs()))};t.prototype.init=function(){this.outer_div=this.container.append("div").classed("flex-container-columns",true).style({width:this.options.width,height:this.options.height});this.options.toolbar_container=this.options.toolbar_container?d3.select(this.options.toolbar_container):this.outer_div;if(this.options.use_toolbar)this.initToolbar();this.scroll_div=this.options.toolbar_pos==="top"?this.outer_div.append("div"):this.outer_div.insert("div","div.btn-toolbar");this.scroll_div.classed("gm-canvas",true).style("width",this.options.width).style("flex",1).style("-webkit-flex",1).style("position","relative").style("overflow-y",this.options.vertical_scroll?"scroll":"hidden");this.content_div=this.scroll_div.append("div").style("width","100%").style("min-height",this.options.vertical_scroll?"200%":"100%").style("position","absolute").call(this.model);this.controller();if(this.options.vertical_scroll){this.scroll_div.on("scroll",this.adjustCanvasSize.bind(this));this.adjustCanvasSize(true)}if(this.options.identification_interval!==false){this.id_modal=new IdentificationModal(this.options.identification_interval);this.id_modal.events.on("identified",this.onUserIdentification.bind(this));this.id_modal.show();this.controller.on("start-of-interaction",this.id_modal.resetTimer.bind(this.id_modal))}};t.prototype.onUserIdentification=function(t){this.logger.logCustomInteraction("user-id",{user_id:t.id,user_type:t.type})};t.prototype.initToolbar=function(){var t=this;this.tools=this.options.toolbar_container.append("div").attr({class:"btn-toolbar",role:"toolbar"}).style(this.options.toolbar_on_style);if(this.options.minimal){this.tools.on("mouseenter",function(){if(t.toolFadeoutTimer)clearTimeout(t.toolFadeoutTimer)}).on("mouseleave",this.switchToolbarState.bind(this))}if(this.options.drawing){this.options.mode_btns.splice(3,0,{type:"radio",group:"draw",state:false,label:"draw",icon:"glyphicon glyphicon-pencil"},{type:"radio",group:"draw",state:false,label:"erase",icon:"glyphicon glyphicon-erase"})}if(this.options.mode_btns)this.appendButtonGroup(this.options.mode_btns,this.onButton);if(this.options.reset_btn)this.appendButtonGroup([this.options.reset_btn],this.onButton);if(this.options.undo_btn||this.options.redo_btn){var e=[];if(this.options.undo_btn)e.push(this.options.undo_btn);if(this.options.redo_btn)e.push(this.options.redo_btn);this.appendButtonGroup(e,this.onButton)}if(this.options.font_smaller_btn&&this.options.font_larger_btn){var i=[];i.push(this.options.font_smaller_btn);i.push(this.options.font_larger_btn);this.appendButtonGroup(i,this.onButton)}if(this.options.feedback&&this.options.feedback_btn){this.appendButtonGroup([this.options.feedback_btn],this.onButton)}if(this.options.insert_btn)gmath.ui.addInsertButton(this);if(this.options.homework_btn)gmath.ui.addHomeworkButton(this);if(this.options.formula_btn)gmath.ui.addMacroButton(this);var n=[];if(this.options.saving_and_loading){if(this.options.save_btn)n.push(this.options.save_btn);if(this.options.load_btn)n.push(this.options.load_btn)}if(this.options.share_btn)n.push(this.options.share_btn);if(n.length)this.appendButtonGroup(n,this.onButton);if(this.options.help_btn)gmath.ui.addHelpButton(this);if(this.options.minimal){this.tools.classed("btn-toolbar-minimal",true);var r=this.tools.append("div").attr("class","btn-group pull-right").style({"line-height":"26px","margin-left":"40px"});r.append("span").text("powered by").style({"font-style":"italic","font-family":"sans-serif",color:"#909090","font-weight":300,"font-size":"13px"});var o=r.append("a").style({"text-decoration":"none"}).attr({href:"http://graspablemath.com",target:"_blank"});o.append("img").attr({alt:"GM",src:this.options.logo_src}).style({"vertical-align":"-0.3em",height:"1.7em","margin-left":"0.8em","margin-right":"0.2em","font-size":"13px"})}if(this.options.minimal&&this.options.static_toolbar)this.switchToolbarState(true)};t.prototype.showHint=function(t,e,i){var n=this.model;if(!i)i={};if(n.dls().length>0&&!this.options.always_show_initial_hint)return;var r={pos:{x:-1e3,y:-1e3},size:{width:i.width||220,height:0},text:t,closable:true,uneditable:true,static_bg:true,text_align:"center",dont_log_events:true,font_size:i.font_size||16,resizable:false};var o=n.createTextBox(r,function(t){var e=n.viewport();t.translateElement({x:i.x||e.x+e.width/2-t.size.width/2,y:i.y||e.y+e.height/2-t.size.height/2})});if(e){n.on("create.gm-inital-hint",function(){if(n.textboxes().indexOf(o)>=0)o.fade();n.on("create.gm-initial-hint",null)})}};t.prototype.parseURLQueryParams=function(){var t=gmath.getURLParameter("eq");if(t){t=t.split(";");this.controller.simulateStartOfInteraction();for(var e=0;e<t.length;e++){this.model.createDL({eq:t[e],pos:{x:200+350*e,y:100}},null,"URL")}this.controller.simulateEndOfInteraction()}};t.prototype.adjustCanvasSize=function(t){var e=this.scroll_div.node().getBoundingClientRect().height;var i=this.content_div.node().getBoundingClientRect().height;var n=this.scroll_div.property("scrollTop");if(!this.scroll_top)this.scroll_top=n;if(t){var r=Math.round(i/e);this.content_div.style("height",e*r+"px")}if(n>this.scroll_top){if(i-n<e){var r=Math.round(i/e)+1;this.content_div.style("height",e*r+"px")}}else if(n<this.scroll_top){if(i-n>=2*e&&this.noObjectsHiddenBelowView(n)){var r=Math.round(i/e)-1;this.content_div.style("height",e*r+"px")}}this.scroll_top=n};t.prototype.noObjectsHiddenBelowView=function(t){var e=[];e=this.model.dls().concat(this.model.graphs()).concat(this.model.textboxes()).concat(this.model.paths());if(e.length===0)return true;for(var i=0;i<e.length;i++){var n=e[i];if(n.pos){if(Array.isArray(n.pos)&&n.pos[1]>t)return false;else if(n.pos.y>t)return false}else if(n.points&&n.points[0][1]>t)return false}return true};t.prototype.switchToolbarState=function(t,e){var i=this;if(t){i.turnOnToolbar()}else{if(e)i.turnOffToolbar();else{i.toolFadeoutTimer=setTimeout(function(){i.turnOffToolbar()},i.options.toolFadeoutDelay)}}};t.prototype.turnOnToolbar=function(){if(this.toolFadeoutTimer){clearTimeout(this.toolFadeoutTimer);this.toolFadeoutTimer=null}this.tools.style(this.options.toolbar_on_style);this.toolbarOn=true};t.prototype.turnOffToolbar=function(){if(this.toolFadeoutTimer){clearTimeout(this.toolFadeoutTimer);this.toolFadeoutTimer=null}this.tools.style(this.options.toolbar_off_style);this.toolbarOn=false};t.prototype.resize=function(t){this.options.width=t.width;this.options.height=t.height;this.scroll_div.style({width:this.options.width,height:this.options.height});if(this.tools)this.tools.style({width:this.options.width})};t.prototype.onButton=function(t){if(this.id_modal)this.id_modal.resetTimer();var e={mode:this.model.setMode()==="inspect"?"scrub":this.model.setMode(),font_size:DerivationList.defaultOptions.font_size};this.updateButton(t);if(t.label==="clear all"){if(this.logger.canvas_logger.containsPendingEvents(this.logger.canvas_logger.interactionSequence)){this.logger.canvas_logger.submitCurrentSequence()}if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","reset",1);if(confirm("Really clear the canvas?")){this.controller.reset()}}if(t.label==="undo"){if(this.logger.canvas_logger.containsPendingEvents(this.logger.canvas_logger.interactionSequence)){this.logger.canvas_logger.submitCurrentSequence()}this.controller.undo();if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","undo",1)}if(t.label==="redo"){if(this.logger.canvas_logger.containsPendingEvents(this.logger.canvas_logger.interactionSequence)){this.logger.canvas_logger.submitCurrentSequence()}if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","redo",1);this.controller.redo()}if(t.label==="HWR"){if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","hwr",1);this.controller.hwr(t.state)}if(t.label==="transform"){if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","transform",1);this.model.setMode("edit")}if(t.label==="scrub"){if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","scrub",1);this.model.setMode("inspect")}if(t.label==="arrange"){if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","arrange",1);this.model.setMode("arrange")}if(t.label==="draw"){if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","draw",1);this.model.setMode("draw")}if(t.label==="erase"){if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","erase",1);this.model.setMode("erase")}if(t.label==="help"){if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","help",1);this.help()}if(t.label==="feedback"){if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","feedback",1);this.sendFeedback()}if(t.label==="fullscreen"&&t.state===true){if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","start fullscreen",1);this.launchFullScreen()}if(t.label==="fullscreen"&&t.state===false){if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","stop fullscreen",1);this.cancelFullScreen()}if(!(t.label==="HWR"&&t.state===true)&&this.options.hwr===true){if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","cancel HWR",1);this.controller.cancelHWR()}if(t.label==="larger"){if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","font larger",1);this.controller.font_larger()}if(t.label==="smaller"){if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","font smaller",1);this.controller.font_smaller()}if(t.label==="save"){gmath.CanvasSaver.save(this);if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","save",1)}if(t.label==="load"){this.remove();gmath.CanvasSaver.load(this.container.node(),null,this.getOptionsForFileLoading());if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","load",1)}if(t.label==="share"&&!this.publishing){this.publishConfirmation();if(gmath.log_ga)gmath.log_ga.trackEvent(this.options.gm_app_name,"button press","share",1)}var i={button:{label:t.label,state:t.state,type:t.type},old_state:e,time:Date.now()};if(i.button.label==="larger"||i.button.label==="smaller")i.button.font_size=DerivationList.defaultOptions.font_size;this.events.button(i)};t.prototype.getOptionsForFileLoading=function(){return{parse_url_query_params:false,disable_ga_tracking:this.options.disable_ga_tracking,gm_app_name:this.options.gm_app_name,savefile_server:this.options.savefile_server,log_mouse_trajectories:this.options.log_mouse_trajectories}};t.prototype.showSaveError=function(t){var e=d3.select("#publish-share-panel"),i=e.select("div");i.classed("alert-danger",true);e.classed("panel-default",false).classed("panel-danger",true);var n=this;i.selectAll("p").remove();i.append("p").html("Sorry, we could not share the canvas.</br>Reason: "+t);if(t.indexOf("too big")===-1){i.append("p").text("Please save your work locally and try again later. Make sure you are connected to the internet!")}else{i.append("p").text("We currently don't support uploading this much data. Please save your work locally instead.")}i.append("button").property("type","button").classed("btn btn-default",true).text("Ok").on("click",function(){e.remove();n.publishing=false})};t.prototype.publishConfirmation=function(){this.publishing=true;var t=this;var e=this.scroll_div.append("div").classed("panel panel-default",true).attr("id","publish-share-panel").style({width:"500px",position:"absolute",right:"20px",top:"20px"});var i=e.append("div").classed("panel-body",true);i.append("h3").text("Share your math!");i.append("p").text('Click the "Publish" button to save your work on the Graspable Math server.'+"  We'll give you a key so you or anyone else can get a copy.");i.append("button").property("type","button").classed("btn btn-default",true).classed("pull-right",true).text("Cancel").on("click",function(){e.remove();t.publishing=false});i.append("button").property("type","button").classed("btn btn-primary",true).text("Publish").on("click",function(){i.remove();i=e.append("div").classed("panel-body",true);i.append("p").text("Working...");gmath.CanvasSaver.share(t.options.savefile_server+"/saves/canvas_save_files",t,function(e,i){if(e)t.showSaveError(e.reason);else t.noSaveError(i)})})};t.prototype.noSaveError=function(t){var e=d3.select("#publish-share-panel"),i=e.select("div");var n=this;i.selectAll("p").remove();i.append("h3").text("Here is your link:");var r=location.origin+location.pathname+"?load="+t;i.append("div").classed("share_link",true).append("input").attr({type:"text"}).on("click",function(){this.select();this.setSelectionRange(0,this.value.length)}).on("input",function(){this.value=r;this.select();this.setSelectionRange(0,this.value.length)}).node().value=r;i.append("p").text("Keep this link for yourself or share it with others. It will always "+"point to the canvas as it is right now. Click the share button again if you "+"want to create a new link to an updated version.");i.append("p").text("To embed the saved GM canvas into your own webpage, put the following snippet into"+" the body of your html file.");var o='<script type="text/javascript">url = parent.document.URL; document.write(\'<iframe style="border: none" src=\\\''+r+'&options={"saving_and_loading": false, "drawing": false, "formula_btn": false, "vertical_scroll": false}&parent_url=\'+url+\'\\\' width=100% height=500px></iframe>\');</script>';i.append("div").classed("share_link",true).append("input").attr({type:"text"}).on("click",function(){this.select();this.setSelectionRange(0,this.value.length)}).on("input",function(){this.value=o;this.select();this.setSelectionRange(0,this.value.length)}).node().value=o;i.append("div").classed("emailTo");i.append("p").text("Enter your email address and we'll email you the share link!");var s=i.append("div").classed("input-group",true);s.append("input").attr({type:"email",class:"form-control",id:"toEmail"}).attr({placeholder:"your@email.com"});s.append("span").classed("input-group-btn",true).append("button").attr({type:"button",class:"btn btn-default",id:"send_btn"}).text("Send Email!").on("click",a);function a(){var t=$("#toEmail").val();var e=/\S+@\S+\.\S+/.test(t);s.classed("has-error",!e);if(!e)return;i.select("#send_btn").text("Sending...").attr("disabled",true).style("pointer-events","none");var n={};n.toEmail=t;var a="Here is your link:\n\r";a+=r;a+="\n\r Keep this link for yourself or share it with others. It will always point to the canvas as it is right now. Click the share button again if you want to create a new link to an updated version.To embed the saved GM canvas into your own webpage, put the following snippet into the body of your html file.  \n\r";a+=o;n.subject="Graspable Math Save Link";n.body=a;var l=new XMLHttpRequest;l.onreadystatechange=function(){if(l.readyState===4&&l.status===200){i.select("#send_btn").text("Sent.")}};l.open("POST","https://graspablemath.com:7011/send_email_to",true);l.setRequestHeader("Content-Type","application/json");l.send(JSON.stringify(n))}i.append("hr");i.append("button").property("type","button").classed("btn btn-primary",true).text("Done").on("click",function(){e.remove();n.publishing=false})};t.prototype.launchFullScreen=function(t){t=t||document.body;if(t.requestFullscreen)t.requestFullscreen();else if(t.mozRequestFullScreen)t.mozRequestFullScreen();else if(t.webkitRequestFullscreen)t.webkitRequestFullscreen();else if(t.msRequestFullscreen)t.msRequestFullscreen()};t.prototype.help=function(){var t=window.open("http://graspablemath.com/unstable/tutorial/index.html","_blank");t.focus()};t.prototype.sendFeedback=function(){var t=window.open("mailto:contact@graspablemath.com","_blank");t.focus()};t.prototype.cancelFullScreen=function(){if(document.exitFullscreen)document.exitFullscreen();else if(document.mozCancelFullScreen)document.mozCancelFullScreen();else if(document.webkitExitFullscreen)document.webkitExitFullscreen();else if(document.msExitFullscreen)document.msExitFullscreen()};t.prototype.updateButton=function(t){if(!this.tools)return;this.tools.select("button#"+t.label).datum(t).each(function(t){if(t.type==="toggle"){t.state=!t.state;d3.select(this).classed("active",t.state)}else if(t.type==="radio"){var e=this;d3.select(this.parentNode).selectAll("button").each(function(t){t.state=e===this}).classed("active",function(t){return t.state})}})};t.prototype.appendButtonElement=function(t,e){var i=this;var n=t.append("button").attr("id",function(t){return t.label}).attr({type:"button",class:"btn btn-default"}).classed("btn-xs",i.options.btn_size==="xs").classed("btn-sm",i.options.btn_size==="sm").classed("active",function(t){return t.state}).style("min-width","4em");n.filter(function(t){return t.type==="dropdown"}).classed("toggle-dropdown",true).attr("data-toggle","dropdown").attr("aria-haspopup","true").attr("aria-expanded","false");if(e)n.call(mtouch_events().on("touch",e.bind(this)));if(this.options.display_icons){var r=n.filter(function(t){return t.icon});r.append("i").attr("class",function(t){return t.icon}).style({color:"#555","font-size":"1.2em","line-height":"1.7em"}).style("padding-left",function(t){return t.type==="dropdown"?"0.25em":null}).style("transform",function(t){return t.flip==="x"?"rotateX(180deg)":t.flip==="y"?"rotateY(180deg)":t.flip==="xy"?"rotateZ(180deg)":null});var o=r.filter(function(t){return t.type==="dropdown"});o.append("span").html("&nbsp;");o.append("span").classed("caret",true);r.append("br")}if(this.options.display_labels){n.append("span").text(function(t){return t.label}).style("color","#555");if(!this.options.display_icons){var o=n.filter(function(t){return t.type==="dropdown"});o.append("span").html("&nbsp;");o.append("span").classed("caret",true)}}};t.prototype.appendButtonGroup=function(t,e,i){if(!this.tools)throw"Can't add buttons if toolbar is disabled.";var n=i?this.tools.insert("div","*"):this.tools.append("div");n.attr({class:"btn-group",role:t[0].group}).classed("pull-right",t[0].pull_right);var r=n.selectAll("button").data(t);r.enter().call(this.appendButtonElement.bind(this),e);if(t.length===1&&t[0].type==="dropdown"){var o=t[0].html_fn(n.node(),t[0]);d3.select(o).attr("aria-labelledby",t[0].label).classed("dropdown-menu",true)}return n};t.prototype.remove=function(){if(this.tools)this.tools.remove();this.outer_div.remove()};t.minimalOptions={width:"100%",height:"100%",vertical_scroll:false,toolbar_pos:"top",static_toolbar:true,undo_btn:{type:"push",label:"undo",icon:"glyphicon glyphicon-chevron-left"},redo_btn:{type:"push",label:"redo",icon:"glyphicon glyphicon-chevron-right"},use_keyboard:false,use_hold_menu:false,drawing:false,display_icons:true,display_labels:false,btn_size:"xs",toolbar_on_style:{display:"inline-block",position:"absolute","margin-top":"-35px",padding:"5px","padding-right":"10px",background:"rgba(255, 255, 255, 0.901961)","border-radius":"3px"},toolbar_off_style:{display:"none"},toolFadeoutDelay:500,logo_src:"../shared/imgs/gm-logo.png",overflow_visible:true};t.defaultOptions={width:"100%",height:"100%",vertical_scroll:true,parse_url_query_params:false,parse_url_options:true,toolbar_pos:"top",undo_btn:{type:"push",label:"undo",icon:"glyphicon glyphicon-chevron-left"},redo_btn:{type:"push",label:"redo",icon:"glyphicon glyphicon-chevron-right"},reset_btn:{type:"push",label:"clear all",icon:"glyphicon glyphicon-refresh"},font_smaller_btn:{type:"push",label:"smaller",icon:"glyphicon glyphicon-text-size",flip:"y"},font_larger_btn:{type:"push",label:"larger",icon:"glyphicon glyphicon-text-size"},formula_btn:true,help_btn:{type:"push",label:"help",pull_right:true,icon:"glyphicon glyphicon-question-sign"},hwr_btn:{type:"toggle",label:"HWR",pull_right:true,state:true,icon:"glyphicon glyphicon-font"},fullscreen_btn:{type:"toggle",label:"fullscreen",pull_right:true,state:false,icon:"glyphicon glyphicon-resize-full"},homework_btn:false,hwr:false,feedback_btn:{type:"push",label:"feedback",pull_right:true,icon:"glyphicon glyphicon-envelope"},feedback:false,disable_ga_tracking:false,gm_app_name:"canvas factory",use_keyboard:true,use_hold_menu:true,drawing:true,display_icons:true,display_labels:true,btn_size:"sm",mode_btns:[{type:"radio",group:"mode",state:true,label:"transform",icon:"glyphicon glyphicon-random"},{type:"radio",group:"mode",state:false,label:"scrub",icon:"glyphicon glyphicon-wrench"},{type:"radio",group:"mode",state:false,label:"arrange",icon:"glyphicon glyphicon-move"}],use_toolbar:true,toolbar_on_style:{"margin-bottom":"10px"},toolbar_off_style:{display:"none"},toolFadeoutDelay:0,save_btn:{type:"push",label:"save",pull_right:true,icon:"glyphicon glyphicon-save"},load_btn:{type:"push",label:"load",pull_right:true,icon:"glyphicon glyphicon-open"},formulas_btn:true,insert_btn:true,savefile_server:"http://127.0.0.1:7010",share_btn:{type:"push",label:"share",pull_right:true,icon:"glyphicon glyphicon-send"},saving_and_loading:false,log_mouse_trajectories:false,keyboard_max_width:800,ask_confirmation_on_closing:true,identification_interval:false};return t}();var GeoGebraCanvasElement=function(t,e,i,n){i=gmath.object.merged(GeoGebraCanvasElement.defaultOptions,i);CanvasElement.call(this,t,e,i);this.type="ggb-element";this.events=gmath.extend(this.events,d3.dispatch("ggb_add","ggb_remove","ggb_update","ggb_rename","ggb_click","ggb_init"));this.ggb_objs=[];this.adding_ggb_object_for_row=undefined;this.dont_update=undefined;this.links=[];this.initOptions(i);this.ggbApplet=null;this.init(n)};gmath.inherit(CanvasElement,GeoGebraCanvasElement);gmath.ui.GeoGebraCanvasElement=GeoGebraCanvasElement;GeoGebraCanvasElement.defaultOptions={type:"GeoGebraCanvasElement",resizable:{x:true,y:true},min_size:{width:300,height:300},edit_mode_drag_box_width:-20,ggb_params:{showMenuBar:false,showAlgebraInput:false,showToolBar:true,showResetIcon:false,enableLabelDrags:false,enableShiftDragZoom:false,enableRightClick:true,errorDialogsActive:false,useBrowserForJS:true,preventFocus:false,language:"en"},ggb_base64:"UEsDBBQACAgIAFt380gAAAAAAAAAAAAAAAAWAAAAZ2VvZ2VicmFfamF2YXNjcmlwdC5qc0srzUsuyczPU0hPT/LP88zLLNHQVKiuBQBQSwcI1je9uRkAAAAXAAAAUEsDBBQACAgIAFt380gAAAAAAAAAAAAAAAAXAAAAZ2VvZ2VicmFfZGVmYXVsdHMyZC54bWztmktv2zgQgM/bX0Ho1D3ElmTLdoI4RVpgsQHSdLEJir3S0ljmhiK1IhXL+fVLkXo5ftRW3MRtczE5FJ/fDIfUyOcfsoiiB0gE4WxsOR3bQsB8HhAWjq1UTk9G1oeLd+ch8BAmCUZTnkRYji0vr1m1U1LH7ffzMpQJcsb4DY5AxNiHW38GEb7mPpa66kzK+Kzbnc/nnbLTDk/CbhjKTiYCC6kJMTG2isyZ6m6p0bynq7u27XT/+Xxtuj8hTEjMfLCQmmwAU5xSKVQWKETAJJKLGMbWNGV+PoubrzixEMUToGOLpZRaqGgztgaedfHut3Mx43PEJ/+Cr8pkkkJVXwvdvI56/IlTnqBkbLl230IKmSIw0b+YxjOscp2hZ2pTvIAEPWCaP9YlOJXc1x3o0immAsq6aqjPPADzpF/UZyTSFJGQECttWUjEAIHOmRWqgWM1kNZe1d95t8CwAoQSIauFXWuhAuH07FUSps/tKGwNwrGfojjJrUvXnoQ1N8/T1XU6KdKiQZ5/ZXSqP8LgVi4oIDkj/j0DoYzTbTTKM3+SIIB8/5g2MSdM3pLHYg5es1R3pYtPnO3KiTldhJxVtP8q5UpFQ6OhNlPc174dr6f15DkrBu68tpK2I8zpLDE0BTVE58Ug2htchH3MBJXRNvApCb2fJgC/N13FGk+xJ47mvn9ZIM76fe9zngQCZWPrBt9YaFGkjybdY5vbLQAHEANTliaXKDutKA9GGnOeTEzyY2PuHQrzl6YrddxWcB3XHF86fTPjJb5X7G8IydKB5fTeKB+Y8rIV939JR6yrGIoi/x1bPo9iCtkB0VPup6K+KxupAj96/gl4VBeCfKSMUIKTxepIe9+Utr2ANC5n18sXM/enY7qDKbe5hsJ/bMn4ibJ94hO5Hb2AMJcqmrelXCug3YXj11MATyXNx7piEhIBOsYgVhZzDxDfqcZf2F2CmcgjKaZOiXGzrnYJXLjtztbNvt999bfvbwPZCOP5B+GRme4hvW6CF9u2fbsI2BGz+1G3/YPqk9cb/mshVppaF6F709QaTa25IOJEgiCYbdeAhKw+Ie+00Ih6HCX+zYvxOSN+NblPRqqW0z/K1bx06BZICMzsO4FQZhffRBa2WRN6LEsypyhZOEXJY5HR/agpJyRDl2W7y7L6pVtmemWmX2a8Brh2lzqt4ljZdsO/P3Ea/Xa3umMOAP/Eqn6BU0YxD2vtXxmpEXU0fmFK1AQZjlQDMyJhH7F/HyY8ZcHKdA7jRZzX9yKbsbE0gqThT29KuULnGXJqGmkZYygXtIsHdb61UkFJoLBERNn0ibq5RzjLoxsITwSnqYRbPwFg9adXo4c5CeQsf7vWhjglWQ7BPJrxhDxyJiu7QbkeL6n+SttUXZvt9lQD+QKfqwPMQlqb1qWRav4mpqsrPQ30rFdLk6hdAB103FHPGXk9e+gMT73RYEfAzugZgA/20fWA3nkvpbvFGInfiNzbmyzBHg3dwaA/cL3T06Ez6A+fbRkTzing+v3wYyk3Iv4r23OTA9tdAd/xHuTPwL+f8GzJovZ7Sf6jKqj/7vA6t76GK3mJm0Bv1/fkbuO/I93y/ykX/wNQSwcI+1nG5a0EAAAmIwAAUEsDBBQACAgIAFt380gAAAAAAAAAAAAAAAAXAAAAZ2VvZ2VicmFfZGVmYXVsdHMzZC54bWztl1tv2yAUx5/XT4F4b3yLe1PcKuoeNqmtNvVlrwSfOGwOuEAu7lfbd9hnGmBI3Us6Lcq0TepLOBwOB/z7w7EzuljPa7QEqZjgBU4GMUbAqSgZrwq80NPDE3xxfjCqQFQwkQRNhZwTXeDcRm7mmd4gHQ6tD60VO+PihsxBNYTCLZ3BnFwJSrQLnWndnEXRarUahKQDIauoqvRgrUqMzIa4KrA3zky6R5NWmQtP4ziJvlxfdekPGVeacAoYmc2WMCWLWitjQg1z4BrptoECNzXhkJk1ajKBusCfXP89Rn5GgTOTF58fvBupmVghMfkK1Hi1XMBmkutENsYMX4paSCQLfHqKkSGWJqad+JbUzYwUOB7kXXxNWpBoSUySuPOQhRbUpXDeKakVhFiz2LUooRsZdl4qhCwVWtukhnXr23vfrrrWhU6J1dCvNkh8VsbhVrc1ID1j9BsHpexePB5vfGBlCfYw2DmjyCN8BpMKzmgP5keuzXEwvIzMiC7kEvpck3w3rmmeO7BJeuzAxj2syb6wEs7m7ngipaGxT45UA1A6a8PGnJ7WXYt+vpeApq8BfTcCVgFfGgBCKnNdYn/t2jioGTzrJOiceM+9N1wes2XJ1mgc5o1D+DgNRhaMYTDy3hGBO97tXdnfArN5UzPK9Ou6kzVTPdnHtvvoCiVxtpPUsRM6fiZz/J/K/IRuQ6SpiUYyatbobDBP/eP7L66ZvUmUSA2KEd4Df2kHnpI/eiO/HWUj6nYGpRT84Q3Qcz1wzPxLYBfZf5d9kmeOfp48wz/82/i3o7xbkNKdZP9sn0O/DzHZreLHwy3H8Xhv79E/Vbbj7WW7GwqVuQ3Gfbqnio7GR8E4DsZJME43t3m7pGohp+Z77aVS44ceqzv8Z9Xdc7VJdqs2HPSGxY21+/Dyt/ryBF7U+2qPwj+D859QSwcIel+aK7sCAACgDAAAUEsDBBQACAgIAFt380gAAAAAAAAAAAAAAAAMAAAAZ2VvZ2VicmEueG1svVdtj9s2DP7c/grCn3OJJEt+KZIWbYEBBbqi2HXDsG9+0SXCObZhKcnd0B8/UrLzcrcbdr1huehk0RTJh6RIZfnubtvAXg/WdO0q4nMWgW6rrjbtehXt3M1VFr17+3q51t1al0MBN92wLdwqUsR53IeruZCSaKZeRVld5zxL46tMC3Yls1RelWmVX1Uxr+qSsZtUISfcWfOm7b4UW237otLX1UZvi89dVTgvdONc/2axOBwO80n9vBvWi/W6nN/ZOgI0vbWraHx4g+IuNh1izy4Y44vff/4cxF+Z1rqirXQEBGtn3r5+tTyYtu4OcDC126yilKcRbLRZbxBnwngEC2LqEWyvK2f22uLWs6XH7LZ95NmKlt6/Ck/QHOFEUJu9qfWwitBZaZZLxqYpi6AbjG7dyDvpXEzSlnujD0EsPXmNkuVo6N5YUzZ6Fd0UjUVUpr0Z0KNo0LDDpXX3jS6LYVqf7OEz/4cs5k9N0jAkwRH4jsVsJlU2SxmbKQrW4lK34iIC13WNF83gO3BQDAfwHGaQpEgRwBVIpGRISSEmmuISYiAWHoOUOEsi84TeKdyvGHCOZBAMhADBQcS4VApUAiqljQJ5k9wLYziIG83BERMtjnF4WixxCHpCQSqIQSNUnPgnRdwoXwky3xPjDGSOioigUg4x2oDrlAFKjEk89yAkA/pykCRepCAyQHmImyQz8Q9RGdensIyEB3GZoqIuo8JmNBIcPlwPgiIvQ4IRYIhtRhMPE5mbJOEVCzQWh0mESYZJBR4ZtsvAGtAyGXhk/FKYE8j4OSCzM5CcQGBQyHo/xUB2c28/TXJcJmHpU41xNlIz+pfTAn2SZP7hhZjiH8LEz7SGY/ocpZPKlCX/XuXLcvQIU/wdTKGegPlC705KuTpTirr8149HKuNn4XxUIn9AYyJfUpN/QGHK/g+Fy8XUgZbj8QO7Id4xX53eWqo6cX7sBQlV67EhpAJSBWly1hZm1BgSdeoN1Bmyi96gsrMGgd0hIWLquw1qovIemoWQU7+YjR3j+6OOgQVenmo8GkiiqHqMRR61i/MyL7AkoNFUHbFnUXUAgSIFYHdIaN8THSCCvrPm6N2NbvpjWLwjTdvv3Oi8kV5t68mRrkP2ovG3nXFD3VW3Hx74WxfWTc/IhBeF03UkXBwubiuvlk1R6gYvddeUCgD7osFoRV7+Tdc6mNJARF6cvxgt9a5qTG2K9jeM/XQL+bLblnoA/9gRRi+EtsPxBkWVaLpBYV8OLFXXDfX1vcVUgbs/9ICbRZzP2fkHC8t9eBULf520VUF5LfN5fv7JUMH90++8Pr2/1s4hZgvFnbaTu9YDnZrR87T4ZD90zYnUd6Z1H4ve7QZ/CUaTBkLyvl032rvPBxZvk9Vt2d1dhzqYBFnf7nt9dGy5/tg13QB47oRSyDDOZZg9D1l25GKeh3mOUQYJPb7nufAcfi7D7LkwssG0ESmfYLJJi7EQ1hdp5LOCrqa71rjP08KZ6vYElPhDzCcXXork/5HI5eJBui1v9dDqJqROi4HcdTsbMjeEytuxs/pr4Tbv2/oXvcZT97WgyudQdGA9WVzrymxxY6CPnisoqr+iqYFa6/WgJ4ThFAa/jgcGbD/oorYbrd3RuyGxz9lOon8auu2ndv8NU+iB6cvFhG9pq8H0lKlQYmm+1adkrI0tsLDX5/vQGRZRVVRj0LGOnBpBsXObbvA/MwpHFNJwzuqP9fg76u1fUEsHCCJM25cTBQAA+A0AAFBLAQIUABQACAgIAFt380jWN725GQAAABcAAAAWAAAAAAAAAAAAAAAAAAAAAABnZW9nZWJyYV9qYXZhc2NyaXB0LmpzUEsBAhQAFAAICAgAW3fzSPtZxuWtBAAAJiMAABcAAAAAAAAAAAAAAAAAXQAAAGdlb2dlYnJhX2RlZmF1bHRzMmQueG1sUEsBAhQAFAAICAgAW3fzSHpfmiu7AgAAoAwAABcAAAAAAAAAAAAAAAAATwUAAGdlb2dlYnJhX2RlZmF1bHRzM2QueG1sUEsBAhQAFAAICAgAW3fzSCJM25cTBQAA+A0AAAwAAAAAAAAAAAAAAAAATwgAAGdlb2dlYnJhLnhtbFBLBQYAAAAABAAEAAgBAACcDQAAAAA=",
ggb_views:{is3D:0,AV:0,SV:0,CV:0,EV2:0,CP:0,PC:0,DA:0,FI:0,PV:0,macro:0}};GeoGebraCanvasElement.prototype.initOptions=function(t){t=t||{};var e=gmath.deepCopy(GeoGebraCanvasElement.defaultOptions);var i=gmath.object.extendExisting(e,t);this.options=gmath.extend(this.options,i)};GeoGebraCanvasElement.prototype.init=function(t){this.div=this.element_div.append("div").attr("id","ggbApplet"+this.id);var e=function(){var t=gmath.object.merged(this.options.ggb_params,{width:this.size.width,height:this.size.height,id:this.id});if(this.options.ggb_base64)t.ggbBase64=this.options.ggb_base64;this.ggbLoader=new GGBApplet(t,"5.0",this.options.ggb_views);this.ggbLoader.inject("ggbApplet"+this.id)};var i=window.ggbOnInit;window.ggbOnInit=function(e){if(e!==this.id){i(e);return}if(this.options.ggbBase64)this.ggbApplet.setBase64(this.options.ggbBase64);this.ggbApplet=this.ggbLoader.getAppletObject();this.ggbApplet.registerUpdateListener(this.events.ggb_update.bind(this));this.ggbApplet.registerAddListener(this.events.ggb_add.bind(this));this.ggbApplet.registerRemoveListener(this.events.ggb_remove.bind(this));this.ggbApplet.registerRenameListener(this.events.ggb_rename.bind(this));this.ggbApplet.registerClickListener(this.events.ggb_click.bind(this));setTimeout(function(){this.div.selectAll("*").style("box-sizing","content-box","important");this.subTypeResize();if(t)t(this)}.bind(this),1);this.events.ggb_init(this);app=this.ggbApplet}.bind(this);if(window.GGBApplet)e.call(this);else gmath.loadScripts(["https://tube.geogebra.org/scripts/deployggb.js"],e.bind(this))};GeoGebraCanvasElement.prototype.subTypeResize=function(){this.ggbApplet.setWidth(this.size.width);this.ggbApplet.setHeight(this.size.height)};GeoGebraCanvasElement.prototype.toJSON=function(){return{type:"GeoGebraCanvasElement",id:this.id,pos:gmath.deepCopy(this.pos),size:gmath.deepCopy(this.size),ggb_base64:this.ggbApplet.getBase64()}};gmath.ui.GeoGebraPanel=function(){var t=function(e,i,n,r){n=gmath.object.merged(t.defaultOptions,n);CanvasElement.call(this,e,i,n);this.type="ggb-panel";this.ggb_objs=[];this.adding_ggb_object_for_row=undefined;this.dont_update=undefined;this.links=[];this.initOptions(n);this.ggbElement=n.ggbElement;this.ggbElement.ggbPanel=this;if(this.ggbElement.ggbApplet)this.init();else this.ggbElement.events.on("ggb_init",this.init.bind(this))};gmath.inherit(CanvasElement,t);t.defaultOptions={type:"GeoGebraPanel",size:{width:100,height:500},resizable:{x:false,y:false},font_size:15,bg_edit_style:{border:"1px solid silver","background-color":"#eee"},bg_edit_active_style:{"background-color":"#eee"},bg_arrange_style:{"background-color":"#eee"},bg_arrange_active_style:{"background-color":"#eee"},show_definitions:false,draggable:false};t.prototype.initOptions=function(e){e=e||{};var i=gmath.deepCopy(t.defaultOptions);var n=gmath.object.extendExisting(i,e);this.options=gmath.extend(this.options,n)};t.prototype.init=function(){this.ggbApplet=this.ggbElement.ggbApplet;this.div=this.element_div.append("div").style({height:"100%",padding:"5px","overflow-y":"auto","overflow-x":"hidden"}).classed("ggb-panel",true);this.ggbElement.events.on("move."+this.id,this.moveAttached.bind(this));this.ggbElement.events.on("resize."+this.id,this.resizeAttached.bind(this));this.ggbElement.events.on("ggb_add."+this.id,this.ggbAddListener.bind(this));this.ggbElement.events.on("ggb_update."+this.id,this.ggbUpdateListener.bind(this));this.ggbElement.events.on("ggb_remove."+this.id,this.ggbRemoveListener.bind(this));this.ggbElement.events.on("ggb_rename."+this.id,this.ggbRenameListener.bind(this));this.ggbElement.events.on("ggb_click."+this.id,this.ggbClickListener.bind(this));this.updateAllGGBObjects();this.update()};t.prototype.moveAttached=function(t){this.translateElement({x:t.pos.x+this.ggbElement.size.width-1,y:t.pos.y},t.animated)};t.prototype.resizeAttached=function(t){this.translateElement({x:this.ggbElement.pos.x+t.size.width-1,y:this.ggbElement.pos.y});this.resizeElement({width:this.size.width,height:t.size.height})};t.prototype.ggbUpdateListener=function(t){this.updateGGBObject(t);if(this.options.show_definitions)this.update()};t.prototype.ggbClickListener=function(t){};t.prototype.setGGBHighlight=function(t,e){var i=this.getGGBObject(t);if(!i||i.highlighted===e)return;if(e){i.color=this.ggbApplet.getColor(t);this.ggbApplet.setColor(t,255,0,0)}else{var n=d3.rgb(i.color);this.ggbApplet.setColor(t,n.r,n.g,n.b)}i.highlighted=e};t.prototype.setCanvasHighlight=function(t,e){this.setCanvasHighlightByLink(t,e)};t.prototype.setCanvasHighlightByName=function(t,e){this.canvas_model.dls().forEach(function(i){i.rows.forEach(function(i){var n=false;i.model.for_each(function(i){if(i.is_group("var")&&!i.fixed&&i.value===t){if(i.selected!==e)n=true;i.selected=e}});if(n){i.view.renderer.set_style(i.view.model.children);i.view.update_style(true)}})})};t.prototype.setCanvasHighlightByLink=function(t,e){this.links.forEach(function(i){if(i.ggb_obj&&i.ggb_obj.name===t){var n=i.row.dl.getVisibleRowOn(i.row);n.model.children[0].selected=e;n.view.renderer.set_style(n.view.model.children);n.view.update_style(true)}})};t.prototype.ggbAddListener=function(t){this.updateGGBObject(t);this.update()};t.prototype.ggbRemoveListener=function(t){var e=gmath.findIndex(this.ggb_objs,function(e){return t===e.name});if(e!==-1){this.ggb_objs.splice(e,1);this.update();e=gmath.findIndex(this.links,function(e){return t===e.ggb_obj.name});if(e!==-1){this.links[e].unlink();this.links.splice(e,1)}}};t.prototype.ggbRenameListener=function(t,e){var i=gmath.findIndex(this.ggb_objs,function(e){return t===e.name});if(i===-1){this.updateGGBObject(e);this.update()}else{this.ggb_objs[i].name=e;this.renameVariableOnCanvas(t,e);this.update()}};t.prototype.renameVariableOnCanvas=function(t,e){var i=e.split("_");this.canvas_model.dls().forEach(function(e){e.rows.forEach(function(e){var n=false;e.model.for_each(function(e){if(e.is_group("var")&&!e.fixed&&e.value===t){n=true;e.set_value(i[0],i[1])}});if(n)e.view.update_all()})})};t.prototype.createLink=function(t,i){this.links.push(new e(t,i,this))};t.prototype.updateGGBObject=function(t){var e=this.getGGBObject(t);if(!e){e={name:t,type:this.ggbApplet.getObjectType(t),idx:this.ggbApplet.getObjectNumber(t)};this.ggb_objs.push(e);if(e.type==="point")this.ggbApplet.setLabelVisible(t,true)}e.def_str=this.ggbApplet.getDefinitionString(t);e.independent=this.ggbApplet.isIndependent(t);e.movable=this.ggbApplet.isMoveable(t);e.visible=this.ggbApplet.getVisible(t);if(e.type==="point"){e.x=this.ggbApplet.getXcoord(t);e.y=this.ggbApplet.getYcoord(t)}e.cmd_str=this.ggbApplet.getCommandString(t);var i=false;var n=this.ggbApplet.getValueString(t);if(n!==e.value_str){e.value_str=n;i=true}try{var r=this.ggbApplet.getValue(t);if(r!==e.value){e.value=r;i=true}}catch(t){}if(i&&this.dont_update!==t){this.links.forEach(function(e){e.onGGBChange(t)})}return e};t.prototype.updateAllGGBObjects=function(){var t=this.ggbApplet.getAllObjectNames();t.forEach(this.updateGGBObject.bind(this))};t.prototype.getGGBObject=function(t){return gmath.find(this.ggb_objs,function(e){return e.name===t})};t.prototype.nestByType=function(t){return d3.nest().key(function(t){return t.type}).sortKeys(d3.ascending).sortValues(function(t,e){return t.idx-e.idx}).entries(t)};t.prototype.dropDLRow=function(t){var e;if(e=this.matchSILine(t.model)){var i=this.ggbApplet.evalCommandGetLabels("Point[yAxis]");this.ggbApplet.setCoords(i,0,e.b_val);var n=this.ggbApplet.evalCommandGetLabels("(1,"+(e.b_val+e.m_val)+")");var r=this.ggbApplet.evalCommandGetLabels("Line["+[i,n]+"]");this.links.push(new GM_GGB_SI_Line_Link(this.getGGBObject(i),this.getGGBObject(n),this.getGGBObject(r),t,this))}else{var o=this.ggbApplet.evalCommandGetLabels(t.model.to_ascii());this.ggbApplet.setLabelVisible(o,true);if(t.model.options.locked){this.ggbApplet.setFixed(o,true);this.ggbApplet.setColor(o,68,68,68);this.ggbApplet.setPointSize(o,3)}this.createLink(this.getGGBObject(o),t)}};t.prototype.matchSILine=function(t){var e=t.match("y=±{m:\\NUM}*{x:x}±{?b:\\NUM}","y={?x:x}±{?b:\\NUM}");if(e)return{m_val:e.m?e.m.get_signed_value():e.x?1:0,b_val:e.b?e.b.get_signed_value():0,m_node:e.m,b_node:e.b};e=t.match("y=-x±{?b:\\NUM}");if(e)return{m_val:-1,b_val:e.b?e.b.get_signed_value():0,b_node:e.b};return false};t.prototype.matchSegment=function(t){return t.match("\\VAR = ±{val:\\NUM}")};t.prototype.matchPoint=function(t){return t.match("\\VAR = (±{x:\\NUM},±{y:\\NUM})","(±{x:\\NUM},±{y:\\NUM})")};t.prototype.matchPointString=function(t){if(!this.__pt_rx)this.__pt_rx=new RegExp(".*= ?\\(([^(),]*),([^(),]*)\\)");return t.match(this.__pt_rx)};t.prototype.dropGGBObject=function(t){var e=t.value_str.substring(t.value_str.indexOf(":")+1),i=this.canvas_model,n=this;var r=i.createDL({eq:e,pos:{x:-1e3,y:"top"}},function(t){if(!i.moveToFreeSpace(t))t.translateElement({x:n.size.width+n.pos.x,y:n.pos.y})});r.getLastModel().setLocked(!t.movable);this.createLink(t,r.getLastRow())};t.prototype.update=function(){var t=this;var e=this.div.selectAll("div.type").data(this.nestByType(this.ggb_objs));var i=e.enter().append("div").classed("type",true);i.append("p");e.exit().remove();e.select("p").text(function(t){return t.key+"s"});var n=e.selectAll("p.object").data(function(t){return t.values});n.enter().append("p").classed("object",true).style("cursor","pointer").on("click",function(e){t.dropGGBObject(e);t.setGGBHighlight(e.name,true);t.setCanvasHighlight(e.name,true)}).on("mouseenter",function(e){t.setGGBHighlight(e.name,true);t.setCanvasHighlight(e.name,true)}).on("mouseleave",function(e){t.setGGBHighlight(e.name,false);t.setCanvasHighlight(e.name,false)});n.exit().remove();n.text(function(e){return t.show_definitions?e.value_str:e.name})};t.prototype.toJSON=function(){return{type:"GeoGebraPanel",id:this.id,pos:gmath.deepCopy(this.pos),size:gmath.deepCopy(this.size),ggbElement:this.ggbElement.id}};GM_GGB_SI_Line_Link=function(t,e,i,n,r){this.id=gmath.uid();this.ggb_ic=t;this.ggb_2nd=e;this.ggb_obj=i;this.model=n.model;this.row=n;this.ggb_panel=r;this.model.events.on("change."+this.id,this.onAMChange.bind(this))};GM_GGB_SI_Line_Link.prototype.onAMChange=function(t){if(t.old_model!==this.model)throw"wrong old_model";if(t.new_model!==t.old_model){this.model.events.on("change."+this.id,null);this.model=t.new_model;this.model.events.on("change."+this.id,this.onAMChange.bind(this))}if(t.sender===this.id)return;var e=t.old_model_ascii||t.old_model.to_ascii();var i=this.ggb_panel.matchSILine(new gmath.AlgebraModel(e));var n=this.ggb_panel.matchSILine(this.model);var r=this.ggb_2nd.x,o=this.ggb_2nd.y,s=n.m_val;if(i.b_val!==n.b_val){o=s*r+n.b_val;this.ggb_panel.ggbApplet.setCoords(this.ggb_ic.name,0,n.b_val);this.ggb_panel.ggbApplet.setCoords(this.ggb_2nd.name,r,o)}else{var a=o-n.b_val,l=Math.sqrt(r*r+a*a),h=Math.atan2(r>=0?s:-s,r>0?1:-1);r=l*Math.cos(h);o=l*Math.sin(h)+n.b_val;this.ggb_panel.ggbApplet.setCoords(this.ggb_2nd.name,r,o)}};GM_GGB_SI_Line_Link.prototype.onGGBChange=function(t){if(this.dont_update)return;if(t===this.ggb_ic.name){var e=this.ggb_panel.matchSILine(this.model);if(!e.b_node){this.model.replace_with("y="+(e.m_node?e.m_val:"")+"x+0",this.id);e=this.ggb_panel.matchSILine(this.model)}this.model.numeric_value(e.b_node,this.ggb_ic.y,this.id);this.dont_update=true;this.ggb_panel.ggbApplet.setCoords(this.ggb_2nd.name,this.ggb_2nd.x,this.ggb_ic.y+e.m_val*(this.ggb_2nd.x-this.ggb_ic.x));this.dont_update=false}else if(t===this.ggb_2nd.name){var e=this.ggb_panel.matchSILine(this.model);if(!e.m_node){if(!e.b_node)this.model.replace_with("y=1x",this.id);else this.model.replace_with("y=1x"+(e.b_val<0?"-":"+")+e.b_val,this.id);e=this.ggb_panel.matchSILine(this.model)}this.model.numeric_value(e.m_node,(this.ggb_2nd.y-this.ggb_ic.y)/(this.ggb_2nd.x-this.ggb_ic.x),this.id)}};GM_GGB_SI_Line_Link.prototype.unlink=function(){this.model.events.on("change."+this.id,null);this.model.events.on("end-of-interaction."+this.id,null)};var e=function(t,e,i){this.id=gmath.uid();this.ggb_obj=t;this.row=e;this.model=e.model;this.ggb_panel=i;if(t.type==="segment")this.onGGBChange(t.name);this.model.events.on("change."+this.id,this.onAMChange.bind(this));this.model.events.on("end-of-interaction."+this.id,this.onAMeoi.bind(this))};e.prototype.onAMeoi=function(t){this.onGGBChange(this.ggb_obj.name)};e.prototype.onAMChange=function(t){if(t.old_model!==this.model)throw"wrong old_model";if(t.new_model!==t.old_model){this.model.events.on("change."+this.id,null);this.model.events.on("end-of-interaction."+this.id,null);this.model=t.new_model;this.model.events.on("change."+this.id,this.onAMChange.bind(this));this.model.events.on("end-of-interaction."+this.id,this.onAMeoi.bind(this))}var e=this.ggb_obj.name;if(t.sender===e)return;this.dont_update=true;if(!this.ggb_obj.movable)this.ggb_panel.ggbApplet.setFixed(e,false);if(!this.handleAMPointChange()){if(!this.ggb_obj.movable)this.ggb_panel.ggbApplet.setFixed(e,false);this.ggb_panel.ggbApplet.evalCommand(e+": "+t.new_model.to_ascii())}if(this.ggb_obj.movable&&this.model.options.locked)this.ggb_panel.ggbApplet.setFixed(e,true);this.dont_update=false};e.prototype.handleAMPointChange=function(){if(this.ggb_obj.type!=="point")return false;var t=this.ggb_obj.name;var e=this.ggb_panel.matchPoint(this.model);if(e){var i=e.x.get_signed_value(),n=e.y.get_signed_value();this.ggb_panel.ggbApplet.setCoords(t,i,n)}else{if(this.model.children[0].is_group("equals")){this.ggb_panel.ggbApplet.evalCommand(this.model.to_ascii())}else{this.ggb_panel.ggbApplet.evalCommand(t+": "+this.model.to_ascii())}}return true};e.prototype.onGGBChange=function(t){if(this.dont_update)return;if(t!==this.ggb_obj.name)return;var e=this.ggb_obj.value_str.substring(this.ggb_obj.value_str.indexOf(":")+1);if(this.ggb_obj.type==="point"){var i=this.ggb_panel.matchPoint(this.model);if(!i)return;var n=this.ggb_panel.matchPointString(e);this.model.numeric_value(i.x,+n[1],t);this.model.numeric_value(i.y,+n[2],t)}else if(this.ggb_obj.type==="segment"){var i=this.ggb_panel.matchSegment(this.model);this.model.numeric_value(i.val,+this.ggb_obj.value,t)}else{this.model.replace_with(e,t)}};e.prototype.unlink=function(){this.model.events.on("change."+this.id,null);this.model.events.on("end-of-interaction."+this.id,null)};return t}();gmath.ui.addInsertButton=function(){var t=[{label:"select one and click on the canvas",header:true},{label:"Math Expression",value:"derivation",icon:"imgs/menu-icons/sqrt-x.png"},{label:"Text",value:"textbox",icon:"imgs/menu-icons/text.png"},{label:"Graph",value:"ggb",icon:"imgs/menu-icons/geogebra.svg"}];var e;function i(t){e=t;btn=e.appendButtonGroup([{type:"dropdown",label:"insert",icon:"glyphicon glyphicon-plus-sign",html_fn:r}],null,true);$(btn.node()).on("show.bs.dropdown",n)}function n(){e.controller.cancelInsertElementOnNextClick()}function r(e,i){var n=d3.select(e).append("ul");var r=n.selectAll("li").data(t).enter();var s=r.append("li");var a=s.filter(function(t){return t.header});var l=s.filter(function(t){return!t.header});a.classed("dropdown-header",true).text(function(t){return t.label});var h=l.append("a").attr("href","#").style("padding","10px 20px").on("click",function(t){d3.event.preventDefault();o(t)});var p={"vertical-align":"bottom",position:"relative",height:"1.8em",left:"-0.5em",top:"0.15em"};h.filter(function(t){return t.icon}).append("img").style(p).style("opacity",.5).attr("src",function(t){return gmath.ui.resource_path+t.icon});h.filter(function(t){return!t.icon}).append("span").style(p).style("width","1.8em").style("display","inline-block");h.append("span").text(function(t){return t.label});return n.node()}function o(t){e.controller.insertElementOnNextClick(t.value)}return i}();gmath.ui.addMacroButton=function(){var t=[{title:"Quadratic Formula",math:"ax^2+bx+c=0  =>  x=(-b±sqrt{b^2-4*a*c})/(2*a)"}];var e,i;function n(t){e=t;e.appendButtonGroup([{type:"dropdown",label:"formulas",data_toggle:"dropdown",pull_right:true,icon:"glyphicon glyphicon-book",html_fn:r}])}function r(e,i){o(t);var n={cols:2,mar:5,w:200,h:180};var r=s(e,n),l=a(r,n);$(e).on("shown.bs.dropdown",function(){v()});$(e).on("hide.bs.dropdown",function(){m(null,l)});return r.node()}function o(t){t.forEach(function(t){t.dl=new gmath.DerivationList(null,null,{eq:t.math.replace("=>","\\\\"),visualized:false})})}function s(t,e){dropdown=d3.select(t).append("div");dropdown.on("click",function(){d3.event.stopPropagation()});dropdown.style("width",e.cols*e.w+2*e.cols*e.mar+2*e.mar+2+"px");dropdown.style("padding",e.mar+"px");dropdown.append("p").text("click to apply or drag to copy a formula").style({color:"gray","font-style":"italic","text-align":"center"});return dropdown}function a(e,i){var n=e.selectAll(".formulas").data(t);var r=n.enter().append("div").style({width:i.w+"px",height:i.h+"px",margin:i.mar+"px",display:"inline-block","vertical-align":"top",border:"1px solid silver","border-radius":"2px",padding:"5px","text-align":"center",position:"relative",cursor:"pointer"}).on("mousedown",function(t){l(t,n);p(t)}).on("click",function(t){h(t,n);p(t)});r.append("h2").text(function(t){return t.title}).style({"font-size":"1em",margin:"5px 0 10px 0"});r.append("p").style("margin-bottom","0px").append(function(t){var e=document.createElement("div");t.expression1_container=d3.select(e);return e});r.append("div").style("clear","both");r.append("p").style("margin-bottom","0px").append(function(t){var e=document.createElement("div");t.expression2_container=d3.select(e);return e});r.append("div").style({position:"absolute",top:0,bottom:0,left:0,right:0});return n}function l(t,e){u(t,e);t.allow_copy=true;d(t,e)}function h(t,e){t.allow_copy=false}function p(t){if(t.selected)f(t);else c()}function u(e,i){t.forEach(function(t){t.selected=e&&t===e?!e.selected:false;t.allow_copy=t===e});i.style("background",function(t){return t.selected?"#FFDF00":null})}function c(t){if(!t)t=[];e.model.dls().forEach(function(t){t.getLastRow().view.interaction_handler.highlight_nodes([])});t.forEach(function(t){t.getLastView().interaction_handler.highlight_nodes(t.getLastModel().children)})}function d(t,n){if(e.model.foreground_event_layer_visible()==="none"){e.model.foreground_event_layer_visible(true);var r=e.model.foreground_event_layer();if(!i){i=mtouch_events().frame(r.node()).on("tap",function(){var e={x:d3.event.finger.pos[0],y:d3.event.finger.pos[1]};t.actions.forEach(function(t){if(t.target_dl.hitTest(e))t.target_row.model.performAction(t.action)});m(t,n)});r.call(i)}}}function f(t){t.actions=[];var i=[t.dl.rows[0].model,t.dl.getLastModel()];e.model.dls().forEach(function(e){var n=e.getLastRow(),r=gmath.actions.ApplyMacroAction.getAllAvailableActions(i,n.model);t.actions=t.actions.concat(r.map(function(t){return{action:t,target_dl:e,target_row:n}}))});c(t.actions.map(function(t){return t.target_dl}))}function g(t,i){e.model.createDL({eq:t.dl.rows[0].model.to_ascii(),pos:{x:i.layerX,y:i.layerY}})}function m(t,i){if(e.model.foreground_event_layer_visible()){e.model.foreground_event_layer().on("click.macro-menu",null);e.model.foreground_event_layer_visible(false)}u(t,i);c()}function v(){t.forEach(function(t){if(!t.initialized){_(t.expression1_container,t.dl.rows[0].model.to_ascii());_(t.expression2_container,t.dl.getLastModel().to_ascii())}t.initialized=true})}function _(t,e,i){var n=32;var r=t.append("svg").style("width","100%").style("overflow","visible").style("margin-left","0.5em").style("display","inline-block").style("visibility","hidden");var o=new gmath.AlgebraModel(e);var s=new gmath.AlgebraView(o,r,{interactive:false,inactive_color:"#000000",font_size:n,v_align:"alphabetic",h_align:"left"});var a=function(){var e=s.getBBox();r.style("height",e.height).style("width",e.width);s.main.attr("transform","translate("+[0,e.height]+")");if(i){t.style("margin-bottom",e.height-o.children[0].ascent+"px")}else{r.style("margin-bottom",e.height-o.children[0].ascent+"px")}};s.init(function(){a();var t=s.getBBox();setTimeout(function(){var e=r.node().parentNode.clientWidth,i=t.width;if(i>.9*e){s.options.font_size*=.9*e/i;s.update_all(true);a()}r.style("visibility",null)},1)})}return n}();gmath.ui.addHomeworkButton=function(){var t=[{title:"Chapter 1 Fundamental Concepts of Algebra",subchapters:[{title:"1.1 Real Numbers",problems:[{num:1,text:"If <i>x</i> < 0 and <i>y</i> > 0, determine the sign of the real number.",alignment:"row",parts:[{type:"derivation",options:{eq:"xy"},label:true},{type:"derivation",options:{eq:"x^2y"},label:true},{type:"derivation",options:{eq:"x/y+x"},label:true},{type:"derivation",options:{eq:"y-x"},label:true}]},{num:"3, 5",text:"We're not yet supporting these problems. Please see p. 13 in the textbook.",alignment:null,parts:[]},{num:7,text:"Express the statement as an inequality.",alignment:"column",parts:[{type:"textbox",options:{text:"<i>x</i> is negative."},label:true},{type:"textbox",options:{text:"<i>y</i> is nonnegative."},label:true},{type:"textbox",options:{text:"<i>q</i> is less than or equal to <i>π</i>."},label:true},{type:"textbox",options:{text:"<i>d</i> is between 4 and 2."},label:true},{type:"textbox",options:{text:"<i>t</i> is not less than 5."},label:true}]},{num:9,text:"Rewrite the number without using the absolute value symbol, and simplify the result.",alignment:"row",parts:[{type:"derivation",options:{eq:"|-3-2|"},label:true},{type:"derivation",options:{eq:"|-5|-|2|"},label:true},{type:"derivation",options:{eq:"|7|+|-4|"},label:true}]},{num:11,text:"Rewrite the number without using the absolute value symbol, and simplify the result.",alignment:"row",parts:[{type:"derivation",options:{eq:"(-5)*|3-6|"},label:true},{type:"derivation",options:{eq:"|-6|/(-2)"},label:true},{type:"derivation",options:{eq:"|-7|+|4|"},label:true}]},{num:13,text:"Rewrite the number without using the absolute value symbol, and simplify the result.",alignment:"row",parts:[{type:"derivation",options:{eq:"|4-π|"},label:true},{type:"derivation",options:{eq:"|π-4|"},label:true},{type:"derivation",options:{eq:"|sqrt2-1.5|"},label:true}]},{num:15,text:"We're not yet supporting this problem. Please see p. 14 in the textbook.",alignment:null,parts:[]},{num:19,text:"The two given numbers are coordinates of points <i>A</i> and <i>B</i>, respectively, on a coordinate line. Express the indicated statement as an inequality involving the absolute value symbol.",alignment:"row",parts:[{type:"derivation",options:{eq:"x"},label:false},{type:"derivation",options:{eq:"7"},label:false},{type:"textbox",options:{text:"<i>d</i>(<i>A</i>, <i>B</i>) is less than 5"},label:false}]},{num:23,text:"The two given numbers are coordinates of points <i>A</i> and <i>B</i>, respectively, on a coordinate line. Express the indicated statement as an inequality involving the absolute value symbol.",alignment:"row",parts:[{type:"derivation",options:{eq:"4"},label:false},{type:"derivation",options:{eq:"x"},label:false},{type:"textbox",options:{text:"<i>d</i>(<i>A</i>, <i>B</i>) is not greater than 3"},label:false}]},{num:25,text:"Rewrite the expression without using absolute the value symbol, and simplify the result.",alignment:"row",parts:[{type:"derivation",options:{eq:"|3+x|"},label:false},{type:"textbox",options:{text:"if <i>x</i> < -3"},label:false}]},{num:27,text:"Rewrite the expression without using the absolute value symbol, and simplify the result.",alignment:"row",parts:[{type:"derivation",options:{eq:"|2-x|"},label:false},{type:"textbox",options:{text:"if <i>x</i> < 2"},label:false}]},{num:29,text:"Rewrite the expression without using the absolute value symbol, and simplify the result.",alignment:"row",parts:[{type:"derivation",options:{eq:"|a-b|"},label:false},{type:"textbox",options:{text:"if <i>a</i> < b"},label:false}]},{num:31,text:"Rewrite the expression without using the absolute value symbol, and simplify the result.",alignment:"row",parts:[{type:"derivation",options:{eq:"|x^2+4|"},label:false}]},{num:"33-53",text:"We're not yet supporting these problems. Please see p. 14 in the textbook.",alignment:null,parts:[]},{num:57,text:"Avogadro's number",alignment:null,parts:[{type:"textbox",options:{text:"The number of hydrogen atoms in a mole is Avogadro's number, 6.02 x 10<sup>23</sup>. If one mole of the gas has a mass of 1.01 grams, estimate the mass of a hydrogen atom."},label:false}]},{num:59,text:"Frames in a movie film",alignment:null,parts:[{type:"textbox",options:{text:"One of the longest movies ever made is a 1970 British film that runs for 48 hours. Assuming that the film speed is 24 frames per second, approximate the total number of frames in this film. Express your answer in scientific form."},label:false}]},{num:61,text:"Tornado pressure",alignment:"column",parts:[{type:"textbox",options:{text:"When a tornado passes near a building, there is a rapid drop in the outdoor pressure and the indoor pressure does not have time to change. The resulting difference is capable of causing an outward pressure of 1.4 lb/in<sup>2</sup> on the walls and ceiling of the building."},label:false},{type:"textbox",options:{text:"Calculate the force in pounds exerted on 1 square foot of a wall."},label:true},{type:"textbox",options:{text:"Estimate the tons of force exerted on a wall that is 8 feet high and 40 feet wide."},label:true}]}]},{title:"1.2 Exponents and Radicals",problems:[{num:3,text:"Express the number in the form <i>a</i>/<i>b</i>, where <i>a</i> and <i>b</i> are integers.",alignment:null,parts:[{type:"derivation",options:{eq:"2^-3/3^-2"},label:false}]},{num:5,text:"Express the number in the form <i>a</i>/<i>b</i>, where <i>a</i> and <i>b</i> are integers.",alignment:null,parts:[{type:"derivation",options:{eq:"-2^4+3^-1"},label:false}]},{num:7,text:"Express the number in the form <i>a</i>/<i>b</i>, where <i>a</i> and <i>b</i> are integers.",alignment:null,parts:[{type:"derivation",options:{eq:"16^(-3/4)"},label:false}]},{num:9,text:"Express the number in the form <i>a</i>/<i>b</i>, where <i>a</i> and <i>b</i> are integers.",alignment:null,parts:[{type:"derivation",options:{eq:"(-0.008)^(2/3)"},label:false}]},{num:13,text:"Simplify.",alignment:null,parts:[{type:"derivation",options:{eq:"((2x^3)(3x^2))/(x^2)^3"},label:false}]},{num:15,text:"Simplify.",alignment:null,parts:[{type:"derivation",options:{eq:"(1/6a^5)(-3a^2)(4a^7)"},label:false}]},{num:21,text:"Simplify.",alignment:null,parts:[{type:"derivation",options:{eq:"(8x^4y^-3)(1/2x^-5y^2)"},label:false}]},{num:25,text:"Simplify.",alignment:null,parts:[{type:"derivation",options:{eq:"(3y^3)^4(4y^2)^-3"},label:false}]},{num:29,text:"Simplify.",alignment:null,parts:[{type:"derivation",options:{eq:"(5x^2y^-3)(4x^-5y^4)"},label:false}]},{num:31,text:"Simplify.",alignment:null,parts:[{type:"derivation",options:{eq:"((3x^5y^4)/(x^0y^-3))^2"},label:false}]},{num:35,text:"Simplify.",alignment:null,parts:[{type:"derivation",options:{eq:"(3x^(5/6))(8x^(2/3))"},label:false}]},{num:39,text:"Simplify.",alignment:null,parts:[{type:"derivation",options:{eq:"(8x^(-2/3))x^(1/6)"},label:false}]},{num:41,text:"Simplify.",alignment:null,parts:[{type:"derivation",options:{eq:"((-8x^3)/y^-6)^(2/3)"},label:false}]},{num:43,text:"Simplify.",alignment:null,parts:[{type:"derivation",options:{eq:"(x^6/(9y^-4))^(-1/2)"},label:false}]},{num:45,text:"Simplify.",alignment:null,parts:[{type:"derivation",options:{eq:"(x^6y^3)^(-1/3)/(x^4y^2)^(-1/2)"},label:false}]},{num:49,text:"Rewrite the expression using rational exponents.",alignment:null,parts:[{type:"derivation",options:{eq:"sqrt[3]{(a+b)^2}"},label:false}]},{num:51,text:"Rewrite the expression using rational exponents.",alignment:null,parts:[{type:"derivation",options:{eq:"sqrt{x^2+y^2}"},label:false}]},{num:53,text:"Rewrite the expression using a radical.",alignment:"row",parts:[{type:"derivation",options:{eq:"4x^(2/3)"},label:true},{type:"derivation",options:{eq:"(4x)^(3/2)"},label:true}]},{num:55,text:"Rewrite the expression using a radical.",alignment:"row",parts:[{type:"derivation",options:{eq:"8-y^(1/3)"},label:true},{type:"derivation",options:{eq:"(8-y)^(1/3)"},label:true}]},{num:65,text:"Simplify the expression, and rationalize the denominator when appropriate.",alignment:null,parts:[{type:"derivation",options:{eq:"sqrt[3]{8a^6b^-3}"},label:false}]},{num:67,text:"Simplify the expression, and rationalize the denominator when appropriate.",alignment:null,parts:[{type:"derivation",options:{eq:"sqrt{(3x)/(2y^3)}"},label:false}]},{num:69,text:"Simplify the expression, and rationalize the denominator when appropriate.",alignment:null,parts:[{type:"derivation",options:{eq:"sqrt[3]{(2x^4y^4)/(9x)}"},label:false}]},{num:71,text:"Simplify the expression, and rationalize the denominator when appropriate.",alignment:null,parts:[{type:"derivation",options:{eq:"sqrt[4]{(5x^8y^3)/(27x^2)}"},label:false}]},{num:73,text:"Simplify the expression, and rationalize the denominator when appropriate.",alignment:null,parts:[{type:"derivation",options:{eq:"sqrt[5]{(5x^7y^2)/(8x^3)}"},label:false}]},{num:77,text:"Simplify the expression, and rationalize the denominator when appropriate.",alignment:null,parts:[{type:"derivation",options:{eq:"sqrt[5]{(8x^3)/y^4}*sqrt[5]{(4x^4)/y^2}"},label:false}]},{num:79,text:"Simplify the expression, and rationalize the denominator when appropriate.",alignment:null,parts:[{type:"derivation",options:{eq:"sqrt[3]{3t^4v^2}*sqrt[3]{-9t^-1v^4}"},label:false}]},{num:81,text:"Simplify the expression, assuming <i>x</i> and <i>y</i> may be negative.",alignment:null,parts:[{type:"derivation",options:{eq:"sqrt{x^6y^4}"},label:false}]},{num:83,text:"Simplify the expression, assuming <i>x</i> and <i>y</i> may be negative.",alignment:null,parts:[{type:"derivation",options:{eq:"sqrt[4]{x^8(y-1)^12}"},label:false}]},{num:"85-93",text:"We're not yet supporting these problems. Please see p. 26 in the textbook.",alignment:null,parts:[]},{num:95,text:"Savings account",alignment:null,parts:[{type:"textbox",options:{text:"One of the oldest banks in the United States is the Bank of America, founded in 1812. If $200 had been deposited at that time into an account that paid 4% annual interest, then 180 years later the amount would have grown to 200(1.04)<sup>180</sup> dollars. Approximate this amount to the nearest cent."},label:false}]},{num:"97-99",text:"We're not yet supporting this problem. Please see p. 26 in the textbook.",alignment:null,parts:[]}]},{title:"1.3 Algebraic Expressions",problems:[{num:3,text:"Express as a polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"(4x^3+5x-3)-(3x^3+2x^2+5x-7)"},label:false}]},{num:9,text:"Express as a polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"(2u+3)(u-4)+4u(u-2)"},label:false}]},{num:11,text:"Express as a polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"(3x+5)(2x^2+9x-5)"},label:false}]},{num:13,text:"Express as a polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"(t^2+2t-5)(3t^2-t+2)"},label:false}]},{num:15,text:"Express as a polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"(x+1)(2x^2-2)(x^3+5)"},label:false}]},{num:19,text:"Express as a polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"(3u^3v^4-2u^5v^2+(u^2v^2)^2)/(u^3v^2)"},label:false}]},{num:25,text:"Express as a polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"(x^2+9)(x^2-4)"},label:false}]},{num:29,text:"Express as a polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"(x^2-3y^2)^2"},label:false}]},{num:37,text:"Express as a polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"(x-2y)^3"},label:false}]},{num:39,text:"Express as a polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"(2x+3y)^3"},label:false}]},{num:43,text:"Express as a polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"(2x+y-3z)^2"},label:false}]},{num:51,text:"Factor the polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"15x^3y^5-25x^4y^2+10x^6y^4"},label:false}]},{num:57,text:"Factor the polynomial.",
alignment:null,parts:[{type:"derivation",options:{eq:"6x^2+7x-20"},label:false}]},{num:65,text:"Factor the polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"45x^2+38xy+8y^2"},label:false}]},{num:69,text:"Factor the polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"z^4-64w^2"},label:false}]},{num:73,text:"Factor the polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"x^2+25"},label:false}]},{num:77,text:"Factor the polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"64x^3+27"},label:false}]},{num:79,text:"Factor the polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"64x^3-y^6"},label:false}]},{num:81,text:"Factor the polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"343x^3+y^9"},label:false}]},{num:83,text:"Factor the polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"125-27x^3"},label:false}]},{num:85,text:"Factor the polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"2ax-6bx+ay-3by"},label:false}]},{num:87,text:"Factor the polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"3x^3+3x^2-27x-27"},label:false}]},{num:89,text:"Factor the polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"x^4+2x^3-x-2"},label:false}]},{num:91,text:"Factor the polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"a^3-a^2b+ab^2-b^3"},label:false}]},{num:93,text:"Factor the polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"a^6-b^6"},label:false}]},{num:95,text:"Factor the polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"x^2+4x+4-9y^2"},label:false}]},{num:97,text:"Factor the polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"y^2-x^2+8y+16"},label:false}]},{num:99,text:"Factor the polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"y^6+7y^3-8"},label:false}]},{num:101,text:"Factor the polynomial.",alignment:null,parts:[{type:"derivation",options:{eq:"x^16-1"},label:false}]}]},{title:"1.4 Fractional Expressions",problems:[{num:3,text:"Write the expression as a simplified rational number.",alignment:null,parts:[{type:"derivation",options:{eq:"5/24-3/20"},label:false}]},{num:13,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"(5a^2+12a+4)/(a^4-16)/(25a^2+20a+4)/(a^2-2a)"},label:false}]},{num:21,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"(3t)/(t+2)+(5t)/(t-2)-40/(t^2-4)"},label:false}]},{num:25,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"(2x)/(x+2)-8/(x^2+2x)+3/x"},label:false}]},{num:31,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"((2x+1)/(x^2+4x+4))-((6x)/(x^2-4))+3/(x-2)"},label:false}]},{num:33,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"(b/a-a/b)/(1/a-1/b)"},label:false}]},{num:35,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"(x/y^2-y/x^2)/(1/y^2-1/x^2)"},label:false}]},{num:37,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"(y^-1+x^-1)/(xy)^-1"},label:false}]},{num:39,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"(5/(x+1)+(2x)/(x+3))/(x/(x+1)+7/(x+3))"},label:false}]},{num:41,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"(3/(x-1)-3/(a-1))/(x-a)"},label:false}]},{num:43,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"((x+h)^2-3(x+h)-(x^2-3x))/h"},label:false}]},{num:45,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"(1/(x+h)^3-1/x^3)/h"},label:false}]},{num:47,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"(4/(3x+3h-1)-4/(3x-1))/h"},label:false}]},{num:51,text:"Rationalize the denominator.",alignment:null,parts:[{type:"derivation",options:{eq:"(81x^2-16y^2)/(3sqrtx-2sqrty)"},label:false}]},{num:55,text:"Rationalize the numerator.",alignment:null,parts:[{type:"derivation",options:{eq:"(sqrta-sqrtb)/(a^2-b^2)"},label:false}]},{num:57,text:"Rationalize the numerator.",alignment:null,parts:[{type:"derivation",options:{eq:"(sqrt{2(x+h)+1}-sqrt{2x+1})/h"},label:false}]},{num:63,text:"Express as a sum of terms of the form <i>ax<sup>r</sup></i>, where <i>r</i> is a rational number.",alignment:null,parts:[{type:"derivation",options:{eq:"(x^2+2)^2/x^5"},label:false}]},{num:67,text:"Express as a quotient.",alignment:null,parts:[{type:"derivation",options:{eq:"x^(-1/2)-x^(3/2)"},label:false}]},{num:69,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"(2x^2-3x+1)(4)(3x+2)^3(3)+(3x+2)^4(4x-3)"},label:false}]},{num:71,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"(x^2-4)^(1/2)(3)(2x+1)^2(2)+(2x+1)^3(1/2)(x^2-4)^(-1/2)(2x)"},label:false}]},{num:73,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"(3x+1)^6(1/2)(2x-5)^(-1/2)(2)+(2x-5)^(1/2)(6)(3x+1)^5(3)"},label:false}]},{num:75,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"((6x+1)^3(27x^2+2)-(9x^3+2x)(3)(6x+1)^2(6))/(6x+1)^6"},label:false}]},{num:77,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"((x^2+2)^3(2x)-x^2(3)(x^2+2)^2(2x))/[(x^2+2)^3]^2"},label:false}]},{num:79,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"((x^2+4)^(1/3)(3)-(3x)(1/3)(x^2+4)^(-2/3)(2x))/[(x^2+4)^(1/3)]^2"},label:false}]},{num:81,text:"Simplify the expression.",alignment:null,parts:[{type:"derivation",options:{eq:"((4x^2+9)^(1/2)(2)-(2x+3)(1/2)(4x^2+9)^(-1/2)(8x))/[(4x^2+9)^(1/2)]^2"},label:false}]}]}]},{title:"Chapter 2 Equations and Inequalities",subchapters:[{title:"2.1 Equations",problems:[{num:7,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"1/5x+2=3-2/7x"},label:false}]},{num:9,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"0.3(3+2x)+1.2x=3.2"},label:false}]},{num:13,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"(13+2x)/(4x+1)=3/4"},label:false}]},{num:15,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"8-5/x=2+3/x"},label:false}]},{num:17,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"(3x-2)^2=(x-5)(9x+4)"},label:false}]},{num:21,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"(3x+1)/(6x-2)=(2x+5)/(4x-13)"},label:false}]},{num:23,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"2/5+4/(10x+5)=7/(2x+1)"},label:false}]},{num:27,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"2-5/(3x-7)=2"},label:false}]},{num:31,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"7/(y^2-4)-4/(y+2)=5/(y-2)"},label:false}]},{num:33,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"(x+3)^3-(3x-1)^2=x^3+4"},label:false}]},{num:35,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"(9x)/(3x-1)=2+3/(3x-1)"},label:false}]},{num:37,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"1/(x+4)+3/(x-4)=(3x+8)/(x^2-16)"},label:false}]},{num:39,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"4/(x+2)+1/(x-2)=(5x-6)/(x^2-4)"},label:false}]},{num:41,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"2/(2x+1)-3/(2x-1)=(-2x+7)/(4x^2-1)"},label:false}]},{num:43,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"5/(2x+3)+4/(2x-3)=(14x+3)/(4x^2-9)"},label:false}]},{num:51,text:"For what value of <i>c</i> is the number <i>a</i> a solution of the equation?",alignment:null,parts:[{type:"derivation",options:{eq:"4x+1+2c=5c-3x+6"},label:false},{type:"derivation",options:{eq:"a=-2"},label:false}]},{num:55,text:"Determine values for <i>a</i> and <i>b</i> such that <sup>5</sup>&frasl;<sub>3</sub> is a solution of the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"ax+b=0"},label:false}]},{num:57,text:"Determine which equation is not equivalent to the equation preceding it.",alignment:null,parts:[{type:"derivation",options:{eq:"x^2-x-2=x^2-4"},label:false},{type:"derivation",options:{eq:"(x+1)(x-2)=(x+2)(x-2)"},label:false},{type:"derivation",options:{eq:"x+1=x+2"},label:false},{type:"derivation",options:{eq:"1=2"},label:false}]},{num:59,text:"Solve the formula for the specified variable.",alignment:"row",parts:[{type:"derivation",options:{eq:"EK+L=D-TK"},label:false},{type:"textbox",options:{text:"for <i>K</i>"},label:false}]},{num:61,text:"Solve the formula for the specified variable.",alignment:"row",parts:[{type:"derivation",options:{eq:"M=(Q+1)/Q"},label:false},{type:"textbox",options:{text:"for <i>Q</i>"},label:false}]},{num:67,text:"The formula occurs in the indicated application. Solve for the specified variable.",alignment:"row",parts:[{type:"derivation",options:{eq:"F=g(mM)/d^2"},label:false},{type:"textbox",options:{text:"for <i>m</i> (Newton's law of gravitation)"},label:false}]},{num:69,text:"The formula occurs in the indicated application. Solve for the specified variable.",alignment:"row",parts:[{type:"derivation",options:{eq:"P=2l+2w"},label:false},{type:"textbox",options:{text:"for <i>w</i> (perimeter of a rectangle)"},label:false}]},{num:71,text:"The formula occurs in the indicated application. Solve for the specified variable.",alignment:"row",parts:[{type:"derivation",options:{eq:"A=1/2(b_1+b_2)h"},label:false},{type:"textbox",options:{text:"for <i>b</i><sub>1</sub> (area of a trapezoid)"},label:false}]},{num:73,text:"The formula occurs in the indicated application. Solve for the specified variable.",alignment:"row",parts:[{type:"derivation",options:{eq:"S=p/(q+p(1-q))"},label:false},{type:"textbox",options:{text:"for <i>q</i> (Amdahl's law for supercomputers)"},label:false}]},{num:75,text:"The formula occurs in the indicated application. Solve for the specified variable.",alignment:"row",parts:[{type:"derivation",options:{eq:"1/f=1/p+1/q"},label:false},{type:"textbox",options:{text:"for <i>q</i> (lens equation)"},label:false}]}]},{title:"2.2 Applied Problems",problems:[{num:1,text:"Test scores",alignment:null,parts:[{type:"textbox",options:{text:"A student in an algebra course has test scores of 75, 82, 71, and 84. What score on the next test will raise the student's average to 80?"},label:false}]},{num:2,text:"Final class average",alignment:null,parts:[{type:"textbox",options:{text:"Before the final exam, a student has test scores of 72, 80, 65, 78, and 60. If the final exam counts as one-third of the final grade, what score must the student receive in order to have a final average of 76?"},label:false}]},{num:3,text:"Gross pay",alignment:null,parts:[{type:"textbox",options:{text:"A worker’s take-home pay is $492, after deductions totaling 40% of the gross pay have been subtracted. What is the gross pay?"},label:false}]},{num:4,text:"Cost of dining out",alignment:null,parts:[{type:"textbox",options:{text:"A couple does not wish to spend more than $70 for dinner at a restaurant. If a sales tax of 6% is added to the bill and they plan to tip 15% after the tax has been added, what is the most they can spend for the meal?"},label:false}]},{num:5,text:"Intelligence quotient",alignment:"column",parts:[{type:"textbox",options:{text:"A person's intelligence quotient (IQ) is determined by multiplying the quotient of his or her mental age and chonological age by 100."},label:false},{type:"textbox",options:{text:"Find the IQ of a 12-year-old child whose mental age is 15."},label:true},{type:"textbox",options:{text:"Find the mental age of a person 15 years old whose IQ is 140."},label:true}]},{num:7,text:"Cost of insulation",alignment:null,parts:[{type:"textbox",options:{text:"The cost of installing insulation in a particular two-bedroom home is $2400. Present monthly heating costs average $200, but the insulation is expected to reduce heating costs by 10%. How many months will it take to recover the cost of the insulation?"},label:false}]},{num:9,text:"Savings accounts",alignment:null,parts:[{type:"textbox",options:{text:"An algebra student has won $100,000 in a lottery and wishes to deposit it in savings accounts in two financial institutions. One account pays 8% simple interest, but deposits are insured only to $50,000. The second account pays 6.4% simple interest, and deposits are insured up to $100,000. Determine whether the money can be deposited so that it is fully insured and earns annual interest of $7500."},label:false}]},{num:11,text:"Movie attendance",alignment:null,parts:[{type:"textbox",options:{text:"Six hundred people attended the premiere of a motion picture. Adult tickets cost $9, and children were admitted for $6. If box office receipts totaled $4800, how many children attended the premiere?"},label:false}]},{num:13,text:"Preparing a glucose solution",alignment:null,parts:[{type:"textbox",options:{text:"In a certain medical test designed to measure carbohydrate tolerance, an adult drinks 7 ounces of a 30% glucose solution. When the test is administered to a child, the glucose concentration must be decreased to 20%. How much 30% glucose solution and how much water should be used to prepare 7 ounces of 20% glucose solution?"},label:false}]},{num:15,text:"Preparing an alloy",alignment:null,parts:[{type:"textbox",options:{text:"British sterling silver is a copper-silver alloy that is 7.5% copper by weight. How many grams of pure copper and how many grams of British sterling silver should be used to prepare 200 grams of a copper-silver alloy that is 10% copper by weight?"},label:false}]},{num:17,text:"Walking rates",alignment:"column",parts:[{type:"textbox",options:{text:"Two children, who are 224 meters apart, start walking toward each other at the same instant at rates of 1.5 m/sec and 2 m/sec, respectively (see the figure on p. 71)."},label:false},{type:"textbox",options:{text:"When will they meet?"},label:true},{type:"textbox",options:{text:"How far will each have walked?"},label:true}]},{num:19,text:"Snowplow speed",alignment:null,parts:[{type:"textbox",options:{text:"At 6 A.M. a snowplow, traveling at a constant speed, begins to clear a highway leading out of town. At 8 A.M. an automobile begins traveling the highway at a speed of 30 and reaches the plow 30 minutes later. Find the speed of the snowplow."},label:false}]},{num:21,text:"Rowing rate",alignment:"column",parts:[{type:"textbox",options:{text:"A boy can row a boat at a constant rate of 5 mi/hr in still water, as indicated in the figure (p. 71). He rows upstream for 15 minutes and then rows downstream, returning to his starting point in another 12 minutes."},label:false},{type:"textbox",options:{text:"Find the rate of the current."},label:true},{type:"textbox",options:{text:"Find the total distance traveled."},label:true}]},{num:23,text:"Distance to a target",alignment:null,parts:[{type:"textbox",options:{text:"A bullet is fired horizontally at a target, and the sound of its impact is heard 1.5 seconds later. If the speed of the bullet is 3300 ft/sec and the speed of sound is 1100 ft/sec, how far away is the target?"},label:false}]},{num:25,text:"Fencing a region",alignment:null,parts:[{type:"textbox",options:{text:"A farmer plans to use 180 feet of fencing to enclose a rectangular region, using part of a straight river bank instead of fencing as one side of the rectangle, as shown in the figure on the next page (p. 72). Find the area of the region if the length of the side parallel to the river bank is"},label:false},{type:"textbox",options:{text:"twice the length of an adjacent side."},label:true},{type:"textbox",options:{text:"one-half the length of an adjacent side."},label:true},{type:"textbox",options:{text:"the same as the length of an adjacent side."},label:true}]},{num:29,text:"Constructing a silo",alignment:null,parts:[{type:"textbox",options:{text:"A large grain silo is to be constructed in the shape of a circular cylinder with a hemisphere attached to the top (see the figure on p. 72). The diameter of the silo is to be 30 feet, but the height is yet to be determined. Find the height <i>h</i> of the silo that will result in a capacity of 11,250<i>π</i> ft<sup>3</i>."},label:false}]},{num:31,text:"Lawn mowing rates",alignment:null,parts:[{type:"textbox",options:{text:"It takes a boy 90 minutes to mow the lawn, but his sister can mow it in 60 minutes. How long would it take them to mow the lawn if they worked together, using two lawn mowers?"},label:false}]},{num:33,text:"Delivering newspapers",alignment:null,parts:[{type:"textbox",options:{text:"It takes a girl 45 minutes to deliver the newspapers on her route; however, if her brother helps, it takes them only 20 minutes. How long would it take her brother to deliver the newspapers by himself?"},label:false}]},{num:35,text:"Grade point average (GPA)",alignment:null,parts:[{type:"textbox",options:{text:"A college student has finished 48 credit hours with a GPA of 2.75. To get into the program she wishes to enter, she must have a GPA of 3.2. How many additional credit hours of 4.0 work will raise her GPA to 3.2?"},label:false}]},{num:37,text:"Air temperature",alignment:"column",parts:[{type:"textbox",options:{text:"Below the cloud base, the air temperature <i>T</i> (in °F) at height <i>h</i> (in feet) can be approximated by the equation <i>T</i> = <i>T</i><sub>0</sub> - (<sup>5.5</sup>&frasl;<sub>1000</sub>)<i>h</i>, where <i>T</i><sub>0</sub> is the temperature at ground level."},label:false},{type:"textbox",options:{text:"Determine the air temperature at a height of 1 mile if the ground temperature is 70°F."},label:true},{type:"textbox",options:{text:"At what altitude is the temperature freezing?"},label:true}]},{num:39,text:"A cloud's temperature",alignment:null,parts:[{type:"textbox",options:{text:"The temperature <i>T</i> within a cloud at height <i>h</i> (in feet) above the cloud base can be approximated using the equation <i>T</i> = <i>B</i> - (<sup>3</sup>&frasl;<sub>1000</sub>)<i>h</i>, where <i>B</i> is the temperature of the cloud at its base. Determine the temperature at 10,000 feet in a cloud with a base temperature of 55°F and a base height of 4000 feet. <b>Note:</b> For an interesting application involving the three preceding exercises, see Exercise 6 in the Discussion Exercises at the end of the chapter."},label:false}]}]},{title:"2.3 Quadratic Equations",problems:[{num:9,text:"Solve the equation by factoring.",alignment:null,parts:[{type:"derivation",options:{eq:"12x^2+60x+75=0"},label:false}]},{num:13,text:"Solve the equation by factoring.",alignment:null,parts:[{type:"derivation",options:{eq:"(5x)/(x-3)+4/(x+3)=90/(x^2-9)"},label:false}]},{num:15,text:"Determine whether the two equations are equivalent.",alignment:"row",parts:[{type:"derivation",options:{eq:"x^2=16"},label:true},{type:"derivation",options:{eq:"x=4"},label:false},{type:"derivation",options:{eq:"x=sqrt9"},label:true},{type:"derivation",options:{eq:"x=3"},label:false}]},{num:21,text:"Solve the equation by using the special quadratic equation on page 75.",alignment:null,parts:[{type:"derivation",options:{eq:"(x-3)^2=17"},label:false}]},{num:23,text:"Solve the equation by using the special quadratic equation on page 75.",alignment:null,parts:[{type:"derivation",options:{eq:"4(x+2)^2=11"},label:false}]},{num:25,text:"Determine the value or values of <i>d</i> that complete the square for the expression.",alignment:"column",parts:[{type:"derivation",options:{eq:"x^2+9x+d"},label:true},{type:"derivation",options:{eq:"x^2-8x+d"},label:true},{type:"derivation",options:{eq:"x^2+dx+36"},label:true},{type:"derivation",options:{eq:"x^2+dx+49/4"},label:true}]},{num:29,text:"Solve by completing the square. (<i>Note:</i> See the discussion after Example 5 for help in solving Exercises 29 and 30.)",alignment:null,parts:[{type:"derivation",options:{eq:"4x^2-12x-11=0"},label:false}]},{num:37,text:"Solve by using the quadratic formula.",alignment:null,parts:[{type:"derivation",options:{eq:"3/2z^2-4z-1=0"},label:false}]},{num:39,text:"Solve by using the quadratic formula.",alignment:null,parts:[{type:"derivation",options:{eq:"5/(w^2)-10/w+2=0"},label:false}]},{num:41,text:"Solve by using the quadratic formula.",alignment:null,parts:[{type:"derivation",options:{eq:"4x^2+81=36x"},label:false}]},{num:43,text:"Solve by using the quadratic formula.",alignment:null,parts:[{type:"derivation",options:{eq:"(5x)/(x^2+9)=-1"},label:false}]},{num:45,text:"Use the quadratic formula to factor the expressions.",alignment:null,parts:[{type:"derivation",options:{eq:"x^2+x-30"},label:false}]},{num:47,text:"Use the quadratic formula to factor the expressions.",alignment:null,parts:[{type:"derivation",options:{eq:"12x^2-16x-3"},label:false}]},{num:49,text:"Use the quadratic formula to solve the equation for (a) <i>x</i> in terms of <i>y</i> and (b) <i>y</i> in terms of <i>x</i>.",alignment:null,parts:[{type:"derivation",options:{eq:"4x^2-4xy+1-y^2=0"},label:false}]},{num:51,text:"Solve for the specified variable.",alignment:"row",parts:[{type:"derivation",options:{eq:"K=1/2mv^2"},label:false},{type:"textbox",options:{text:"for <i>v</i> (kinetic energy)"},label:false}]},{num:53,text:"Solve for the specified variable.",alignment:"row",parts:[{type:"derivation",options:{eq:"A=2πr(r+h)"},label:false},{type:"textbox",options:{text:"for <i>r</i> (surface area of a closed cylinder)"},label:false}]},{num:59,text:"Baseball toss",alignment:null,parts:[{type:"textbox",options:{text:"A baseball is thrown straight upward with an initial speed of 64 ft/sec. The number of feet <i>s</i> above the ground after <i>t</i> seconds is given by the equation <i>s</i> = -16<i>t</i><sup>2</sup> + 64<i>t</i>."},label:false},{type:"textbox",options:{text:"When will the baseball be 48 feet above the ground?"},label:true},{type:"textbox",options:{text:"When will it hit the ground?"},label:true}]},{num:60,text:"Breaking distance",alignment:"column",parts:[{type:"textbox",options:{text:"The distance that a car travels between the time the driver makes the decision to hit the brakes and the time the car actually stops is called the braking distance. For a certain car traveling <i>v</i> mi/hr, the braking distance <i>d</i> (in feet) is given by <i>d</i> = <i>v</i> + (<i>v</i><sup>2</sup>/20)."},label:false},{type:"textbox",options:{text:"Find the braking distance when <i>v</i> is 55 mi/hr."},label:true},{type:"textbox",options:{text:"If a driver decides to brake 120 feet from a stop sign, how fast can the car be going and still stop by the time it reaches the sign?"},label:true}]},{num:65,text:"Fencing a garden",alignment:null,parts:[{type:"textbox",options:{text:"A square vegetable garden is to be tilled and then enclosed with a fence. If the fence costs $1 per foot and the cost of preparing the soil is $0.50 per ft<sup>2</sup>, determine the size of the garden that can be enclosed for $120."},label:false}]},{num:66,text:"Fencing a region",alignment:null,parts:[{type:"textbox",options:{text:"A farmer plans to enclose a rectangular region, using part of his barn for one side and fencing for the other three sides. If the side parallel to the barn is to be twice the length of an adjacent side, and the area of the region is to be 128 ft<sup>2</sup>, how many feet of fencing should be purchased?"},label:false}]},{num:69,text:"Distance between airplanes",alignment:"column",parts:[{type:"textbox",options:{text:"An airplane flying north at 200 mi/hr passed over a point on the ground at 2:00 P.M. Another airplane at the same altitude passed over the point at 2:30 P.M., flying east at 400 mi/hr (see the figure on p. 86)."},label:false},{type:"textbox",options:{text:"If <i>t</i> denotes the time in hours after 2:30 P.M., express the distance <i>d</i> between the airplanes in terms of <i>t</i>."},label:true},{type:"textbox",options:{text:"At what time after 2:30 P.M. were the airplanes 500 miles apart?"},label:true}]},{num:70,text:"Two-way radio range",alignment:null,parts:[{type:"textbox",options:{text:"Two surveyors with two-way radios leave the same point at 9:00 A.M., one walking due south at 4 mi/hr and the other due west at 3 mi/hr. How long can they communicate with one another if each radio has a maximum range of 2 miles?"},label:false}]},{num:71,text:"Constructing a pizza box",alignment:null,parts:[{type:"textbox",options:{text:"A pizza box with a square base is to be made from a rectangular sheet of cardboard by cutting six 1-inch squares from the corners and the middle sections and folding up the sides (see the figure on p. 86). If the area of the base is to be 144 in<sup>2</sup>, what size piece of cardboard should be used?"},label:false}]}]},{title:"2.4 Complex Numbers",problems:[{num:3,text:"Write the expression in the form <i>a</i> + <i>bi</i>, where <i>a</i> and <i>b</i> are real numbers.",alignment:null,parts:[{type:"derivation",options:{eq:"(7-6i)-(-11-3i)"},label:false}]},{num:7,text:"Write the expression in the form <i>a</i> + <i>bi</i>, where <i>a</i> and <i>b</i> are real numbers.",alignment:null,parts:[{type:"derivation",options:{eq:"(1-3i)(2+5i)"},label:false}]},{num:9,text:"Write the expression in the form <i>a</i> + <i>bi</i>, where <i>a</i> and <i>b</i> are real numbers.",alignment:null,parts:[{type:"derivation",options:{eq:"(5-2i)^2"},label:false}]},{num:17,text:"Write the expression in the form <i>a</i> + <i>bi</i>, where <i>a</i> and <i>b</i> are real numbers.",alignment:"row",parts:[{type:"derivation",options:{eq:"i^73"},label:true},{type:"derivation",options:{eq:"i^-46"},label:true},{type:"derivation",options:{eq:"i^66"},label:true},{type:"derivation",options:{eq:"i^-55"},label:true}]},{num:19,text:"Write the expression in the form <i>a</i> + <i>bi</i>, where <i>a</i> and <i>b</i> are real numbers.",alignment:null,parts:[{type:"derivation",options:{eq:"3/(2+4i)"},label:false}]},{num:21,text:"Write the expression in the form <i>a</i> + <i>bi</i>, where <i>a</i> and <i>b</i> are real numbers.",alignment:null,parts:[{type:"derivation",options:{eq:"(1-7i)/(6-2i)"},label:false}]},{num:23,text:"Write the expression in the form <i>a</i> + <i>bi</i>, where <i>a</i> and <i>b</i> are real numbers.",alignment:null,parts:[{type:"derivation",options:{eq:"(-4+6i)/(2+7i)"},label:false}]},{num:25,text:"Write the expression in the form <i>a</i> + <i>bi</i>, where <i>a</i> and <i>b</i> are real numbers.",alignment:null,parts:[{type:"derivation",options:{eq:"(4-2i)/(-5i)"},label:false}]},{num:27,text:"Write the expression in the form <i>a</i> + <i>bi</i>, where <i>a</i> and <i>b</i> are real numbers.",alignment:null,parts:[{type:"derivation",options:{eq:"(2+5i)^3"},label:false}]},{num:29,text:"Write the expression in the form <i>a</i> + <i>bi</i>, where <i>a</i> and <i>b</i> are real numbers.",alignment:null,parts:[{type:"derivation",options:{eq:"(2-sqrt-4)(3-sqrt-16)"},label:false}]},{num:31,text:"Write the expression in the form <i>a</i> + <i>bi</i>, where <i>a</i> and <i>b</i> are real numbers.",alignment:null,parts:[{type:"derivation",options:{eq:"(4+sqrt-81)/(7-sqrt-64)"},label:false}]},{num:35,text:"Find the values of <i>x</i> and <i>y</i>, where <i>x</i> and <i>y</i> are real numbers.",alignment:null,parts:[{type:"derivation",options:{eq:"4+(x+2y)i=x+2i"},label:false}]},{num:37,text:"Find the values of <i>x</i> and <i>y</i>, where <i>x</i> and <i>y</i> are real numbers.",alignment:null,parts:[{type:"derivation",options:{eq:"(2x-y)-16i=10+4yi"},label:false}]},{num:39,text:"Find the solutions of the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"x^2-6x+13=0"},label:false}]},{num:41,text:"Find the solutions of the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"x^2+4x+13=0"},label:false}]},{num:43,text:"Find the solutions of the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"x^2-5x+20=0"},label:false}]},{num:45,text:"Find the solutions of the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"4x^2+x+3=0"},label:false}]},{num:47,text:"Find the solutions of the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"x^3+125=0"},label:false}]},{num:48,text:"Find the solutions of the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"x^3-27=0"},label:false}]},{num:49,text:"Find the solutions of the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"27x^3=(x+5)^3"},label:false}]},{num:50,text:"Find the solutions of the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"16x^4=(x-4)^4"},label:false}]},{num:51,text:"Find the solutions of the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"x^4=256"},label:false}]},{num:53,text:"Find the solutions of the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"4x^4+25x^2+36=0"},label:false}]},{num:54,text:"Find the solutions of the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"27x^4+21x^2+4=0"},label:false}]},{num:55,text:"Find the solutions of the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"x^3+3x^2+4x=0"},label:false}]},{num:57,text:"This problem is currently unavailable. Please see p. 94 in the textbook.",alignment:null,parts:[]}]},{title:"2.5 Other Types of Equations",problems:[{num:3,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"|3x-2|+3=7"},label:false}]},{num:5,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"3*|x+1|-2=-11"},label:false}]},{num:8,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"3x^3-4x^2-27x+36=0"},label:false}]},{num:9,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"4x^4+10x^3=6x^2+15x"},label:false}]},{num:11,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"y^(3/2)=5y"},label:false}]},{num:17,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"sqrt[5]{2x^2+1}-2=0"},label:false}]},{num:19,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"sqrt{7-x}=x-5"},label:false}]},{num:21,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"3sqrt{2x-3}+2sqrt{7-x}=11"},label:false}]},{num:23,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"x=4+sqrt{4x-19}"},label:false}]},{num:25,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"x+sqrt{5x+19}=-1"},label:false}]},{num:27,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"sqrt{7-2x}-sqrt{5+x}=sqrt{4+3x}"},label:false}]},{num:29,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"sqrt{11+8x}+1=sqrt{9+4x}"},label:false}]},{num:33,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"sqrt{1+4sqrtx}=sqrtx+1"},label:false}]},{num:37,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"5y^4-7y^2+1=0"},label:false}]},{num:39,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"36x^-4-13x^-2+1=0"},label:false}]},{num:41,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"3x^(2/3)+4x^(1/3)-4=0"},label:false}]},{num:43,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"6w+7w^(1/2)-20=0"},label:false}]},{num:44,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"8t-22t^(1/2)-21=0"},label:false}]},{num:45,text:"Solve the equation.",alignment:null,parts:[{type:"derivation",options:{eq:"2x^(-2/3)-7x^(-1/3)-15=0"},label:false}]},{num:49,text:"Solve the equation.",alignment:"row",
parts:[{type:"derivation",options:{eq:"sqrt[3]{x}=2sqrt[4]{x}"},label:false},{type:"textbox",options:{text:"(<i>Hint:</i> Raise both sides to the least common multiple of 3 and 4.)"},label:false}]},{num:51,text:"Find the real solutions of the equation.",alignment:"column",parts:[{type:"derivation",options:{eq:"x^(5/3)=32"},label:true},{type:"derivation",options:{eq:"x^(4/3)=16"},label:true},{type:"derivation",options:{eq:"x^(2/3)=-36"},label:true},{type:"derivation",options:{eq:"x^(3/4)=125"},label:true},{type:"derivation",options:{eq:"x^(3/2)=-27"},label:true}]},{num:53,text:"Solve for the specified variable.",alignment:"row",parts:[{type:"derivation",options:{eq:"T=2πsqrt{l/g}"},label:false},{type:"textbox",options:{text:"for <i>l</i> (period of a pendulum)"},label:false}]},{num:55,text:"Solve for the specified variable.",alignment:"row",parts:[{type:"derivation",options:{eq:"S=πrsqrt{r^2+h^2}"},label:false},{type:"textbox",options:{text:"for <i>h</i> (surface area of a cone)"},label:false}]},{num:57,text:"Ladder height",alignment:null,parts:[{type:"textbox",options:{text:"The recommended distance <i>d</i> that a ladder should be placed away from a vertical wall is 25% of its length <i>L</i>. Approximate the height <i>h</i> that can be reached by relating <i>h</i> as a percentage of <i>L</i> (see figure on p. 101)."},label:false}]},{num:59,text:"Windmill power",alignment:null,parts:[{type:"textbox",options:{text:"The power <i>P</i> (in watts) generated by a windmill that has efficiency <i>E</i> is given by the formula <i>P</i> = 0.31<i>ED</i><sup>2</sup><i>V</i><sup>3</sup>, where <i>D</i> is the diameter (in feet) of the windmill blades and <i>V</i> is the wind velocity (in ft/sec). Approximate the wind velocity necessary to generate 10,000 watts if <i>E</i> = 42% and <i>D</i> = 10."},label:false}]},{num:61,text:"The effect of price on demand",alignment:null,parts:[{type:"textbox",options:{text:"The demand for a commodity usually depends on its price. If other factors do not affect the demand, then the quantity <i>Q</i> purchased at price <i>P</i> (in cents) is given by <i>Q</i> = <i>kP</i><sup>-<i>c</i></sup>, where <i>k</i> and <i>c</i> are positive constants. If <i>k</i> = 10<sup>5</sup> and <i>c</i> = <sup>1</sup>&frasl;<sub>2</sub>, find the price that will result in the purchase of 5000 items."},label:false}]},{num:62,text:"The urban heat island",alignment:null,parts:[{type:"textbox",options:{text:"Urban areas have higher average air temperatures than rural areas, as a result of the presence of buildings, asphalt, and concrete. This phenomenon has become known as the <i>urban heat island</i>. The temperature difference <i>T</i> (in °C) between urban and rural areas near Montreal, with a population <i>P</i> between 1000 and 1,000,000, can be described the by the formula <i>T</i> = 0.25<i>P</i><sup><sup>1</sup>&frasl;<sub>4</sub></sup>/√<i>v</i>, where <i>v</i> is the average wind speed (in mi/hr) and <i>v</i> ≥ 1. If <i>T</i> = 3 and <i>v</i> = 5, find <i>P</i>."},label:false}]},{num:67,text:"Installing a power line",alignment:null,parts:[{type:"textbox",options:{text:"A power line is to be installed across a river that is 1 mile wide to a town that is 5 miles downstream (see the figure on p. 102). It costs $7500 per mile to lay the cable underwater and $6000 per mile to lay it overland. Determine how the cable should be installed if $35,000 has been allocated for this project."},label:false}]}]},{title:"2.6 Inequalities",problems:[{num:3,text:"Express the inequality as an interval, and sketch its graph.",alignment:null,parts:[{type:"derivation",options:{eq:"x<-2"},label:false}]},{num:5,text:"Express the inequality as an interval, and sketch its graph.",alignment:null,parts:[{type:"derivation",options:{eq:"x≥4"},label:false}]},{num:"7-19",text:"We're not yet supporting these problems. Please see pp. 109 and 110 in the textbook.",alignment:null,parts:[]},{num:27,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"9+1/3x≥4-1/2x"},label:false}]},{num:"31-35",text:"We're not yet supporting these problems. Please see p. 110 in the textbook.",alignment:null,parts:[]},{num:39,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"(x-4)^2>x(x+12)"},label:false}]},{num:41,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"4/(3x+2)≥0"},label:false}]},{num:43,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"-2/(4-3x)>0"},label:false}]},{num:45,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"2/((1-x)^2)>0"},label:false}]},{num:47,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"|x|<3"},label:false}]},{num:49,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"|x|≥5"},label:false}]},{num:53,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"|x+2|+0.1≥0.2"},label:false}]},{num:57,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"-1/3*|6-5x|+2≥1"},label:false}]},{num:59,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"|7x+2|>-2"},label:false}]},{num:63,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"|(2-3x)/5|≥2"},label:false}]},{num:65,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"3/|5-2x|<2"},label:false}]},{num:"67-77",text:"We're not yet supporting these problems. Please see p. 110 in the textbook.",alignment:null,parts:[]},{num:80,text:"Electrical resistance",alignment:null,parts:[{type:"textbox",options:{text:"If two resistors <i>R</i><sub>1</sub> and <i>R</i><sub>2</sub> are connected in parallel in an electrical circuit, the net resistance <i>R</i> is given by<p style='text-align:center; margin: 10px;'><sup>1</sup>&frasl;<sub><i>R</i></sub> = <sup>1</sup>&frasl;<sub><i>R</i><sub>1</sub></sub> + <sup>1</sup>&frasl;<sub><i>R</i><sub>2</sub></sub>.</p>If <i>R</i><sub>1</sub> = 10 ohms, what values of <i>R</i><sub>2</sub> will result in a net resistance of less than 5 ohms?"},label:false}]},{num:85,text:"Decreasing height",alignment:"column",parts:[{type:"textbox",options:{text:"A person's height will typically decrease by 0.024 inch each year after age 30."},label:false},{type:"textbox",options:{text:"If a woman was 5 feet 9 inches tall at age 30, predict her height at age 70."},label:true},{type:"textbox",options:{text:"A 50-year-old man is 5 feet 6 inches tall. Determine an inequality for the range of heights (in inches) that this man will experience between the ages of 30 and 70."},label:true}]}]},{title:"2.7 More on Inequalities",problems:[{num:7,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"x^2-2x-5>3"},label:false}]},{num:9,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"x(2x+3)≥5"},label:false}]},{num:11,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"6x-8>x^2"},label:false}]},{num:17,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"16x^2≥9x"},label:false}]},{num:19,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"x^4+5x^2≥36"},label:false}]},{num:21,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"x^3+2x^2-4x-8≥0"},label:false}]},{num:23,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"(x^2(x+2))/((x+2)(x+1))≤0"},label:false}]},{num:25,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"(x^2-x)/(x^2+2x)≤0"},label:false}]},{num:27,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"(x-2)/(x^2-3x-10)≥0"},label:false}]},{num:29,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"(-3x)/(x^2-9)>0"},label:false}]},{num:31,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"(x+1)/(2x-3)>2"},label:false}]},{num:33,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"1/(x-2)≥3/(x+1)"},label:false}]},{num:35,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"4/(3x-2)≤2/(x+1)"},label:false}]},{num:37,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"x/(3x-5)≤2/(x-1)"},label:false}]},{num:39,text:"Solve the inequality, and express the solutions in terms of intervals whenever possible.",alignment:null,parts:[{type:"derivation",options:{eq:"x^3>x"},label:false}]},{num:41,text:"As a particle moves along a straight path, its speed <i>v</i> (in cm/sec) at time <i>t</i> (in seconds) is given by the equation. For what subintervals of the given time interval [<i>a</i>, <i>b</i>] will its speed be at least <i>k</i> cm/sec?",alignment:"row",parts:[{type:"derivation",options:{eq:"v=t^3-3t^2-4t+20"},label:false},{type:"derivation",options:{eq:"[0,5]"},label:false},{type:"derivation",options:{eq:"k=8"},label:false}]},{num:43,text:"Vertical leap record",alignment:null,parts:[{type:"textbox",options:{text:"<i>Guinness Book of World Records</i> reports that German shepherds can make vertical leaps of over 10 feet when scaling walls. If the distance <i>s</i> (in feet) off the ground after <i>t</i> seconds is given by the equation <i>s</i> = -16<i>t</i><sup>2</sup> + 24<i>t</i> + 1, for how many seconds is the dog more than 9 feet off the ground?"},label:false}]},{num:44,text:"Height of a projected object",alignment:null,parts:[{type:"textbox",options:{text:"If an object is projected vertically upward from ground level with an initial velocity of 320 ft/sec, then its distance <i>s</i> above the ground after <i>t</i> seconds is given by <i>s</i> = -16<i>t</i><sup>2</sup> + 320<i>t</i>. For what values of <i>t</i> will the object be more than 1536 feet above the ground?"},label:false}]},{num:45,text:"Braking distance",alignment:null,parts:[{type:"textbox",options:{text:"The braking distance <i>d</i> (in feet) of a certain car traveling <i>v</i> mi/hr is given by the equation <i>d</i> = <i>v</i> + (<i>v</i><sup>2</sup>/20). Determine the velocities that result in braking distances of less than 75 feet."},label:false}]},{num:49,text:"Weight in space",alignment:null,parts:[{type:"textbox",options:{text:"After an astronaut is launched into space, the astronaut's weight decreases until a state of weightlessness is achieved. The weight of a 125-pound astronaut at an altitude of <i>x</i> kilometers above sea level is given by<p style='text-align:center; margin: 10px;'><i>W</i> = 125(<sup>6400</sup>&frasl;<sub>6400 + <i>x</i></sub>)<sup>2</sup>.</p>At what altitudes is the astronaut's weight less than 5 pounds?"},label:false}]},{num:51,text:"Aircraft's landing speed",alignment:null,parts:[{type:"textbox",options:{text:"In the design of certain small turbo-prop aircraft, the landing speed <i>V</i> (in ft/sec) is determined by the formula <i>W</i> = 0.00334<i>V</i><sup>2</sup><i>S</i>, where <i>W</i> is the gross weight (in pounds) of the aircraft and <i>S</i> is the surface area (in ft<sup>2</sup>) of the wings. If the gross weight of the aircraft is between 7500 pounds and 10,000 pounds and <i>S</i> = 210 ft<sup>2</sup>, determine the range of the landing speeds in miles per hour."},label:false}]}]}]}];function e(e){for(var i=0;i<t.length;i++){var n=t[i];for(var r=0;r<n.subchapters.length;r++){var o=n.subchapters[r];if(o.problems.indexOf(e)!==-1){return{chapter:n,subchapter:o}}}}return null}var i=null,n=null,r=null,o=function(t){return String.fromCharCode(97+t)},s="column";var a=0;var l=null;t.forEach(function(t){t.subchapters.forEach(function(t){t.problems.forEach(function(t){t.parts.forEach(function(t){if(t.type=="textbox"){t.options.uneditable=true}});a++})})});console.log("# of textbook problems: "+a);function h(t){i=t;i.appendButtonGroup([{type:"dropdown",label:"problems",data_toggle:"dropdown",pull_right:true,icon:"glyphicon glyphicon-book",html_fn:p}])}function p(t,e){l=t;var i={col1:380,row1:40,col2:580,height:360};var o=u(l,i);c(o,i);$(l).on("shown.bs.dropdown",function(){n()});$(l).on("hide.bs.dropdown",function(){r()});return o.node()}function u(t,e){var i=22;var n=d3.select(t).append("div").style("width",e.col1+e.col2+i+"px").style("padding","5px").on("click",function(){d3.event.stopPropagation()});n.append("p").text("click on a problem, then on the canvas").style("color","gray").style("font-style","italic").style("text-align","center");return n}function c(e,i){var a=e.append("div").style("width",i.col1+i.col2+2+"px").style("height",i.height+2+"px").style("margin","5px").style("border","1px solid silver");var l=a.append("div").classed("panel",true).style("width",i.col1+"px");var h=a.append("div").classed("panel",true).style("width",i.col2+"px");e.selectAll(".panel").style("height",i.height+"px").style("border","none").style("margin","0px").style("display","inline-block").style("overflow-y","scroll").style("overflow-x","hidden");var p=l.selectAll(".chapter").data(t);var u=p.enter().append("div").classed("chapter",true);u.append("div").style("width",i.col1+"px").style("height",i.row1+"px").style("background-color","#e6e6e6").style({"-webkit-user-select":"none","-moz-user-select":"none","-ms-user-select":"none"}).style("overflow","hidden").style("padding-left","5px").style("line-height",i.row1+"px").append("p").html(function(t){return t.title}).style("font-weight","bold").style("pointer-events","none");var c=p.selectAll(".subchapter").data(function(t){return t.subchapters});var g=c.enter().append("div").classed("subchapter",true);g.append("div").style("width",i.col1+"px").style("height",i.row1+"px").style({"-webkit-user-select":"none","-moz-user-select":"none","-ms-user-select":"none"}).style("overflow","hidden").style("padding-left","5px").style("line-height",i.row1+"px").style("cursor","pointer").on("click",m).append("p").html(function(t){return t.title}).style("pointer-events","none");function m(t){g.style("background-color",function(e,i){return e==t?"#e7f5fe":i%2==0?"whitesmoke":"white"});h.selectAll(".problem").remove();var e=h.selectAll(".problem").data(t.problems);var n=e.enter().append("div").classed("problem",true).style("position","relative").style("width",i.col2+"px").style("background-color",function(t,e){if(t.parts.length==0)return"#e6e6e6";return e%2==0?"whitesmoke":"white"}).style({"-webkit-user-select":"none","-moz-user-select":"none","-ms-user-select":"none"}).style("cursor",function(t){return t.parts.length==0?"default":"pointer"}).each(function(t,e){if(!t.alignment)t.alignment=s;var n=d3.select(this),r=0,a=0,l=0,h=0;var p=n.append("div").style("position","relative").style("width",i.col2+"px").style("pointer-events","none");var u=p.append("p").html(t.num).style("left","5px").style("width","30px").style("text-align","right");var c=p.append("p").html(t.text).style("left","45px").style("width",i.col2-18-90+"px");p.selectAll("p").style("position","absolute").style("margin","0px").style("top","15px").style("font-weight","bold").style("color","lightskyblue").style("pointer-events","none");var d=parseFloat(c.style("height"))+15;if(t.parts.length==0)d+=15;p.style("height",d+"px");a+=d;if(t.alignment=="row"){n=n.append("div").style("position","absolute").style("left","50%").style("transform","translateX(-50%)")}var f=n.selectAll(".part").data(t.parts);var g=f.enter().append("div").classed("part","true").style("position","relative").style("pointer-events","none").each(function(e){var n=d3.select(this),s=0,p=0;if(e.type=="derivation"){var u=n.append("svg").style("pointer-events","none");var c=new gmath.AlgebraModel(e.options.eq),d={font_size:20,v_align:"center",fixed:true},f=new gmath.AlgebraView(c,u,d);f.init(function(){var e=f.getBBox();p=e.height+30;if(t.alignment=="row"){s=e.width+80;r+=s;u.style("position","absolute").style("top","50%").style("transform","translateY(-50%)")}else if(t.alignment=="column"){s=i.col2-18}n.style("width",s+"px");u.style("width",s+"px").style("height",p+"px");f.main.attr("transform","translate("+[s/2,p/2].join(",")+")")})}else if(e.type=="textbox"){var g=n.append("p").html(e.options.text).style("margin","0px").style("pointer-events","none");if(t.alignment=="row"){s=g.node().clientWidth+40;r+=s;g.style("position","absolute").style("top","50%").style("transform","translateY(-50%)").style("text-align","center")}else if(t.alignment=="column"){s=i.col2-18-90;g.style("position","absolute").style("left","45px").style("top","10px")}n.style("width",s+"px");g.style("width",s+"px");p=g.node().clientHeight;e.options.size={width:s,height:p};e.options.font_size=parseFloat(g.style("font-size"));p+=20}if(t.alignment=="row"){if(p>l)l=p;n.style("display","inline-block").style("height","100%")}else if(t.alignment=="column"){a+=p;n.style("height",p+"px")}if(e.label){var m=n.append("p").html(o(h)).style("position","absolute").style("color","lightskyblue").style("pointer-events","none");if(t.alignment=="row"){m.style("top","50%").style("transform","translateY(-50%)")}else if(t.alignment=="column"){m.style("left","5px").style("top","10px").style("width","30px").style("text-align","right")}h++}});if(t.alignment=="row"){n.style("width",r+"px").style("height",l+"px");a+=l;d3.select(n.node().parentNode).style("height",a+"px")}else if(t.alignment=="column"){n.style("height",a+"px")}}).on("click",function(t,e){if(t.parts.length==0)return;n.filter(function(e){return e==t}).transition().duration(150).style("background-color","#e7f5fe").transition().duration(150).style("background-color",e%2==0?"whitesmoke":"white").each("end",d);f(t)})}n=function(){m(t[0].subchapters[0])};r=function(){h.selectAll(".problem").remove()}}function d(){$("body").trigger("click")}function f(t){var n=e(t);i.logger.logCustomInteraction("homework-menu",{action:"select",problem:t.num,chapter:n.chapter.title,subchapter:n.subchapter.title});var r=20,o=0;i.model.elements().forEach(function(t){var e=t.pos.y+t.size.height;if(e>o)o=e});o+=20;i.model.createTextBox({pos:{x:r,y:o},size:{width:472},text:t.text},function(e){i.model.setActive();o+=e.size.height+20;i.controller.simulateStartOfInteraction();function n(e){if(t.parts.length>e){i.controller.simulateEndOfInteraction();function s(i){if(i.type==="derivation")i.applyViewAlignment();if(t.alignment=="row")r+=i.size.width+20;else if(t.alignment=="column")o+=i.size.height+20;n(e+1)}t.parts[e].options.pos={x:r,y:o};t.parts[e].options.v_align="top";switch(t.parts[e].type){case"derivation":i.model.createDL(t.parts[e].options,s,"homework-menu");break;case"textbox":i.model.createTextBox(t.parts[e].options,s,"homework-menu");break}i.controller.simulateEndOfInteraction()}}n(0)})}return h}();gmath.ui.addHelpButton=function(){var t=[{title:"Math Gesture Tutorials",url:"https://graspablemath.com/mac/tutorial/index.html"},{title:"Homework Videos",url:"https://www.youtube.com/channel/UCgj6gNKkDgAMUtTcY70OJ2Q"},{title:"Live GM Chat",url:"https://gitter.im/graspablemath/Lobby"}];var e=null;function i(t){e=t;e.appendButtonGroup([{type:"dropdown",label:"help",data_toggle:"dropdown",pull_right:true,icon:"glyphicon glyphicon-question-sign",html_fn:n}])}function n(t,e){var i={width:240,row_height:40};var n=r(t,i);o(n,i);return n.node()}function r(t,e){var i=22;var n=d3.select(t).append("div").style("width",e.width+i+"px").style("padding","5px").on("click",function(){d3.event.stopPropagation()});return n}function o(e,i){var n=e.append("div").classed("panel",true).style("width",i.width+2+"px").style("height",i.row_height*t.length+2+"px").style("margin","5px").style("border","1px solid silver");var r=n.selectAll(".link").data(t);var o=r.enter().append("div").classed("link",true).html(function(t){return t.title}).style("width",i.width+"px").style("height",i.row_height+"px").style("padding-left","5px").style("line-height",i.row_height+"px").style("font-weight","bold").style("text-decoration","none").style("color","steelblue").style("background-color",function(t,e){return e%2==0?"whitesmoke":"white"}).style("cursor","pointer").on("click",function(t){var e=window.open(t.url,"_blank");if(e){e.focus()}else{alert("Please allow popups for Graspable Math.")}})}return i}();IdentificationModal=function(t){this.modal=null;this.init();this.events=d3.dispatch("identified");this.max_idle_time=t;this.timer_id=null;this.resetTimer()};IdentificationModal.prototype.resetTimer=function(){this.showGlassPane(false);if(this.timer_id)clearTimeout(this.timer_id);this.timer_id=setTimeout(this.showGlassPane.bind(this,true),this.max_idle_time)};IdentificationModal.prototype.showGlassPane=function(t){this.glass_pane.style("display",t?null:"none")};IdentificationModal.prototype.init=function(){if(this.glass_pane)this.glass_pane.remove();this.glass_pane=d3.select("body").append("div").style({position:"fixed",top:0,right:0,bottom:0,left:0,"z-index":1e4,display:"none"}).on("click",this.show.bind(this));if(this.modal)this.modal.remove();this.modal=d3.select("body").append("div").attr("class","modal fade").attr("tabindex",-1).attr("role","dialog");var t=this.modal.append("div").attr("class","modal-dialog modal-sm").attr("role","document").append("div").attr("class","modal-content");var e=t.append("div").classed("modal-header",true);e.append("h4").classed("modal-title",true).text("Please tell us who you are!");var i=t.append("div").classed("modal-body",true);var n=i.append("div");this.type_div=n.append("div").classed("form-group",true).style("margin-bottom",0);this.type_div.append("label").attr({for:"user-id",class:"control-label"}).text("I'm a...");var r={width:"40%",height:"60px"};var o=this.type_div.append("div");o.append("button").attr({type:"button",class:"btn btn-default"}).style(r).text("Student").on("click",this.on_choice.bind(this,"student"));o.append("button").attr({type:"button",class:"btn btn-default"}).style(r).style("float","right").text("Tutor").on("click",this.show_id_input.bind(this,true));this.id_div=n.append("div").classed("form-group",true);this.id_div.append("label").attr({for:"user-id",class:"control-label"}).text("My initials & day of birth");var s=this.id_div.append("div").classed("input-group",true);s.append("input").attr({type:"text",class:"form-control",id:"user-id"}).attr({placeholder:"EM28"}).on("keyup",function(){if(d3.event.keyCode===13){d3.event.preventDefault();this.on_choice("tutor")}}.bind(this));s.append("span").classed("input-group-btn",true).append("button").attr({type:"button",class:"btn btn-default"}).text("OK").on("click",this.on_choice.bind(this,"tutor"));$(this.modal.node()).modal({backdrop:"static",keyboard:false,show:false})};IdentificationModal.prototype.show_id_input=function(t){this.type_div.style("display",t?"none":null);this.id_div.style("display",t?null:"none");if(t)this.modal.select("#user-id").node().focus()};IdentificationModal.prototype.reset=function(){this.modal.select("#user-id").node().value=null;this.show_id_input(false);this.showGlassPane(false)};IdentificationModal.prototype.on_choice=function(t){var e=this.modal.select("#user-id").node().value;var i=t==="tutor"&&(!e||!/^[a-zA-Z]{2,3}[0-9]{1,2}$/.test(e));this.id_div.classed("has-error",i);if(i)return;this.events.identified({type:t,id:e});$(this.modal.node()).modal("hide");this.resetTimer()};IdentificationModal.prototype.show=function(){this.reset();$(this.modal.node()).modal("show")};gmath.ui=gmath.ui||{};gmath.ui.CanvasImage=function(){var t=function(t,e,i,n){CanvasElement.call(this,t,e,i);this.type="image";this.initCanvasImageOptions(i);this.initCanvasImageProperties(i);this.initCanvasImage();this.initPosition();if(n)this.callback(this)};gmath.inherit(CanvasElement,t);gmath.ui.CanvasImageClass=t;t.defaultOptions={min_size:{width:50},size:{width:200}};t.prototype.initCanvasImageOptions=function(e){var e=e||{};var i=gmath.deepCopy(t.defaultOptions);var n=gmath.object.extendExisting(i,e);if(e.image_data)n.image_data=e.image_data;if(e.drop_evt){n.drop_evt=e.drop_evt;n.url=this.tryGetUrl(e.drop_evt)}if(e.url)n.url=e.url;this.options=gmath.extend(this.options,n)};t.prototype.initCanvasImageProperties=function(t){this.size=this.options.size};t.prototype.initCanvasImage=function(){if(this.options.image_data||this.options.url)this.loadImage();else this.getDataFromFile(this.options.drop_evt)};t.prototype.tryGetUrl=function(t){if(!t)return;if(typeof t==="string")return t;if(t.dataTransfer!==undefined){var e=t.dataTransfer.getData("text/plain");if(e.slice(0,4)==="http"){return e}else{var i=t.dataTransfer.getData("text/html");var n=$("<div>").append(i);var r=$(n).find("img").attr("src");if(typeof r!=="undefined")return r}}return null};t.prototype.getDataFromFile=function(t){if(typeof this.options.image_data!=="undefined")return;if(t===null)return;if(typeof t.dataTransfer==="undefined")return;var e=new FileReader;e.onload=function(t){this.canvas_image.options.image_data=t.target.result;this.canvas_image.loadImage()};e.onerror=function(t){console.error("error: "+t.target.error)};e.canvas_image=this;e.readAsDataURL(t.dataTransfer.files[0])};t.prototype.loadImage=function(){this.image_for_aspect_ratio=new Image;this.image_for_aspect_ratio.src=this.options.url||this.options.image_data;this.image=document.createElementNS("http://www.w3.org/2000/svg","image");this.image.addEventListener("load",this.waitForAspectRatio())};t.prototype.waitForAspectRatio=function(){if(this.image_for_aspect_ratio.complete){this.imageLoaded()}else{var t=setTimeout(i,100);var e=this;function i(){if(e.image_for_aspect_ratio.complete){e.imageLoaded()}else{var t=setTimeout(i,100)}}}};t.prototype.imageLoaded=function(){this.aspect_ratio=this.image_for_aspect_ratio.height/this.image_for_aspect_ratio.width;var t=this.size.width*this.aspect_ratio;this.options.min_size.height=this.options.min_size.width*this.aspect_ratio;if(isNaN(this.aspect_ratio))return;var e=this.options.url===null?this.options.image_data:this.options.url;this.image=this.element_div.append("img").property("src",e).attr({width:this.size.width-4,height:t-4}).style({"pointer-events":"none"});this.resizeElement({width:this.size.width,height:t})};t.prototype.resize=function(t){var e=Math.max(this.options.min_size.width,t.width);e=Math.min(e,e-(t.width+this.pos.x-this.container_size.width));h=e*this.aspect_ratio;this.resizeElement({width:e,height:h})};t.prototype.subTypeResize=function(t){this.image.attr({width:this.size.width-4,height:this.size.height-4})};t.prototype.toJSON=function(){var t={type:"CanvasImage",id:this.id,pos:gmath.deepCopy(this.pos),size:gmath.deepCopy(this.size),url:this.options.url||this.options.image_data};return t};return t}();gmath.ui=gmath.ui||{};gmath.ui.Keyboard=function(){var t=null;var e=function(){var t=function(){var t="m -5.708,-15.7 20.344,0 c 3.669696,0 6.624,2.954304 6.624,6.624 l 0,17.752 c 0,3.669696 -2.954304,6.624 -6.624,6.624 l -20.488,0 -15.408,-15.48 zM -2.18,-6.948 11.716,6.948M -2.18,6.948 11.716,-6.948";var e="M 13.7,16.5 -13.7,16.5 0,-16.5 z";var i=d3.dispatch("done","cancel","change"),n="",r=false,o,s,a=null,l=null,h=null,p=null,u="darkorange",c=900,d,f,g,m,v,_,y,b=false,w,x,A="center",T=null,k=true;var N=function(){C();w=mtouch_events().on("touch",B).on("release",H).on("drag",E).on("hold",W).hold_time(750);O();F();if(n!="")o.mathquill("write",n);return this};function E(t){if(!t.alts)return;var e=[];d3.select("#"+t.id+"-content").selectAll("div").each(function(t){var i=d3.mouse(this),n=i[0]-f/2,r=i[1]-g/2;e.push({el:this,dist:Math.sqrt(n*n+r*r)})});if(e.length===0)return;e.sort(function(t,e){return t.dist-e.dist});S(e[0].el,e[0].dist<100)}function S(t,e){d3.select(t.parentNode).selectAll("div").each(function(i){d3.select(this).style("background",this===t&&e?"silver":"none")});x=e?d3.select(t).datum():null}function L(t){i[t](o.mathquill("latex"))}N.width=function(t){if(arguments.length==0)return c;c=t;if(a)F();return this};N.latex=function(t){if(arguments.length==0){if(o)n=o.mathquill("latex");return n}else{n=t;if(o)o.mathquill("latex",t);return this}};N.visible=function(t){if(arguments.length==0)return r;if(r==t)return this;r=t;if(!a)return this;if(r){a.style("display","block");s.focus();if(k)N.scale_to_fit()}else a.style("display","none");return this};N.scale_to_fit=function(){if(!a)return;var t=document.body.getBoundingClientRect().width;if(t<c){var e=t/c;a.style("transform","scale("+e+")").style("-webkit-transform","scale("+e+")").style("transform-origin",A+" bottom").style("-webkit-transform-origin",A+" bottom")}else{a.style("transform",null).style("-webkit-transform",null)}};N.position=function(t){if(arguments.length==0)return A;if(A==t)return this;A=t;if(!a)return this;a.call(K,A);return this};N.caption=function(t,e){if(arguments.length===0)return T;T=t;if(!h)return this;if(!T)h.style("display","none");else{p.text(t);h.style("display",null)}p.style("color",e?e:null);return this};N.warning=function(t){return N.caption(t,u)};var M=function(){var t=[],e=[];v.forEach(function(i){e.push(i.row);t.push(i.col)});_=Math.max.apply(null,t);y=Math.max.apply(null,e);var i=(_+1)*130+_*10+2*10+2*10,n=(y+1)*110+10+10*(y-1)+2*10+2*10,r=c/i;f=130*r;m=10*r;g=110*r;d=n*r};var C=function(){v=[];v.keyboard="num";v.formula={type:"formula",col:2,row:0,cols:6};v.push({name:"Cancel",type:"event",event:"cancel",col:0,row:0,cols:2});v.push({type:"backspace",col:8,row:0});v.push({name:"Done",type:"event",event:"done",col:9,row:0,cols:2});v.push({name:"7",type:"key",col:0,row:1});v.push({name:"8",type:"key",col:1,row:1});v.push({name:"9",type:"key",col:2,row:1});v.push({name:"4",type:"key",col:0,row:2});v.push({name:"5",type:"key",col:1,row:2});v.push({name:"6",type:"key",col:2,row:2});v.push({name:"1",type:"key",col:0,row:3});v.push({name:"2",type:"key",col:1,row:3});v.push({name:"3",type:"key",col:2,row:3});v.push({name:"0",type:"key",col:3,row:3});v.push({name:"1aα",type:"next_kbd",col:11,row:0});v.push({type:"arrow",dir:"left",col:9,row:3,cols:1,rows:.5});v.push({type:"arrow",dir:"up",col:10,row:2.5,cols:1,rows:.5});v.push({type:"arrow",dir:"down",col:10,row:3,cols:1,rows:.5});v.push({type:"arrow",dir:"right",col:11,row:3,cols:1,rows:.5});v.push({name:"+",alts:["+","±"],type:"key",col:4.5,row:1,id:"plus-key"});v.push({name:"−",type:"key",
val:"-",col:5.5,row:1});v.push({name:"*",type:"key",val:"*",col:4.5,row:2,dy:"0.3em"});v.push({name:"÷",type:"key",val:"/",col:5.5,row:2});v.push({name:"(",type:"key",col:4.5,row:3});v.push({name:")",type:"key",col:5.5,row:3});v.push({name:"^",type:"key",col:8,row:1});v.push({name:"=",alts:["<",">","=","≤","≥"],type:"key",col:8,row:3,id:"equal-key"});v.push({name:",",type:"key",col:7,row:1});v.push({name:".",type:"key",col:3,row:2});v.push({name:"x",type:"key",col:7,row:2});v.push({name:"y",type:"key",col:8,row:2});v.push({name:"_",type:"key",col:7,row:3});v.push({name:"log",alts:["log","ln"],type:"key",col:9,row:1,id:"log-key"});v.push({name:"√",alts:["√",{name:"ⁿ√",cmd:"\\nthroot"}],type:"key",col:10,row:1,id:"root-key"})};var q=function(){v=[];v.keyboard="alpha";v.formula={type:"formula",col:2,row:0,cols:6};v.push({name:"Cancel",type:"event",event:"cancel",col:0,row:0,cols:2});v.push({type:"backspace",col:8,row:0});v.push({name:"Done",type:"event",event:"done",col:9,row:0,cols:2});v.push({name:"q",type:"key",col:0,row:1});v.push({name:"w",type:"key",col:1,row:1});v.push({name:"e",type:"key",col:2,row:1});v.push({name:"r",type:"key",col:3,row:1});v.push({name:"t",type:"key",col:4,row:1});v.push({name:"y",type:"key",col:5,row:1});v.push({name:"u",type:"key",col:6,row:1});v.push({name:"i",type:"key",col:7,row:1});v.push({name:"o",type:"key",col:8,row:1});v.push({name:"p",type:"key",col:9,row:1});v.push({name:"a",type:"key",col:.3,row:2});v.push({name:"s",type:"key",col:1.3,row:2});v.push({name:"d",type:"key",col:2.3,row:2});v.push({name:"f",type:"key",col:3.3,row:2});v.push({name:"g",type:"key",col:4.3,row:2});v.push({name:"h",type:"key",col:5.3,row:2});v.push({name:"j",type:"key",col:6.3,row:2});v.push({name:"k",type:"key",col:7.3,row:2});v.push({name:"l",type:"key",col:8.3,row:2});v.push({name:"z",type:"key",col:.6,row:3});v.push({name:"x",type:"key",col:1.6,row:3});v.push({name:"c",type:"key",col:2.6,row:3});v.push({name:"v",type:"key",col:3.6,row:3});v.push({name:"b",type:"key",col:4.6,row:3});v.push({name:"n",type:"key",col:5.6,row:3});v.push({name:"m",type:"key",col:6.6,row:3});v.push({name:"^",type:"key",col:9.4,row:2,cols:.6});v.push({name:"1aα",type:"next_kbd",col:11,row:0});v.push({name:"+",alts:["+","±"],type:"key",col:10,row:1,id:"plus-key"});v.push({name:"-",type:"key",col:11,row:1});v.push({name:"*",type:"key",col:10,row:2,val:"*",dy:"0.3em"});v.push({name:"/",type:"key",col:11,row:2});v.push({name:"=",alts:["<",">","=","≤","≥"],type:"key",col:11,row:3,id:"equal-key"});v.push({name:"(",type:"key",col:9,row:3});v.push({name:")",type:"key",col:10,row:3});v.push({name:"_",type:"key",col:0,row:3,cols:.6});v.push({name:"shift",type:"shift",col:7.6,row:3,cols:1.25})};var D=function(){v=[];v.keyboard="function";v.formula={type:"formula",col:2,row:0,cols:6};v.push({name:"Cancel",type:"event",event:"cancel",col:0,row:0,cols:2});v.push({type:"backspace",col:8,row:0});v.push({name:"Done",type:"event",event:"done",col:9,row:0,cols:2});v.push({name:"",type:"key",col:0,row:1});v.push({name:"",type:"key",col:1,row:1});v.push({name:"",type:"key",col:2,row:1});v.push({name:"",type:"key",col:3,row:1});v.push({name:"",type:"key",col:4,row:1});v.push({name:"",type:"key",col:5,row:1});v.push({name:"",type:"key",col:6,row:1});v.push({name:"",type:"key",col:7,row:1});v.push({name:"",type:"key",col:8,row:1});v.push({name:"",type:"key",col:0,row:2});v.push({name:"",type:"key",col:1,row:2});v.push({name:"",type:"key",col:2,row:2});v.push({name:"",type:"key",col:3,row:2});v.push({name:"shift",type:"shift",col:9,row:1,cols:1.5});v.push({name:"",type:"key",val:"-",col:5,row:2});v.push({name:"",type:"key",val:"/",col:6,row:2});v.push({name:"",type:"key",col:7,row:2});v.push({type:"arrow",dir:"left",col:8,row:2,cols:1,rows:.5});v.push({type:"arrow",dir:"up",col:9,row:1.5,cols:1,rows:.5});v.push({type:"arrow",dir:"down",col:9,row:2,cols:1,rows:.5});v.push({type:"arrow",dir:"right",col:10,row:2,cols:1,rows:.5});v.push({name:"1aα",type:"next_kbd",col:11,row:0})};var z=function(){v=[];v.keyboard="greek";v.formula={type:"formula",col:2,row:0,cols:6};v.push({name:"Cancel",type:"event",event:"cancel",col:0,row:0,cols:2});v.push({type:"backspace",col:8,row:0});v.push({name:"Done",type:"event",event:"done",col:9,row:0,cols:2});v.push({name:"ς",type:"key",col:1,row:1});v.push({name:"ε",type:"key",col:2,row:1});v.push({name:"ρ",type:"key",col:3,row:1});v.push({name:"τ",type:"key",col:4,row:1});v.push({name:"υ",type:"key",col:5,row:1});v.push({name:"θ",type:"key",col:6,row:1});v.push({name:"ι",type:"key",col:7,row:1});v.push({name:"ο",type:"key",col:8,row:1});v.push({name:"π",type:"key",col:9,row:1});v.push({name:"α",type:"key",col:.3,row:2});v.push({name:"σ",type:"key",col:1.3,row:2});v.push({name:"δ",type:"key",col:2.3,row:2});v.push({name:"φ",type:"key",col:3.3,row:2});v.push({name:"γ",type:"key",col:4.3,row:2});v.push({name:"η",type:"key",col:5.3,row:2});v.push({name:"ξ",type:"key",col:6.3,row:2});v.push({name:"κ",type:"key",col:7.3,row:2});v.push({name:"λ",type:"key",col:8.3,row:2});v.push({name:"ζ",type:"key",col:.6,row:3});v.push({name:"χ",type:"key",col:1.6,row:3});v.push({name:"ψ",type:"key",col:2.6,row:3});v.push({name:"ω",type:"key",col:3.6,row:3});v.push({name:"β",type:"key",col:4.6,row:3});v.push({name:"ν",type:"key",col:5.6,row:3});v.push({name:"μ",type:"key",col:6.6,row:3});v.push({name:"^",type:"key",col:9.4,row:2,cols:.6});v.push({name:"shift",type:"shift",col:7.6,row:3,cols:1.25});v.push({name:"+",alts:["+","±"],type:"key",col:10,row:1,id:"plus-key"});v.push({name:"-",type:"key",col:11,row:1});v.push({name:"*",type:"key",col:10,row:2,val:"*",dy:"0.3em"});v.push({name:"/",type:"key",col:11,row:2});v.push({name:"=",alts:["<",">","=","≤","≥"],type:"key",col:11,row:3,id:"equal-key"});v.push({name:"(",type:"key",col:9,row:3});v.push({name:")",type:"key",col:10,row:3});v.push({name:"1aα",type:"next_kbd",col:11,row:0})};var O=function(){a=d3.select("body").append("div").style({position:"fixed",bottom:0,"z-index":1e4}).style("display",r?"block":"none");h=a.append("div").attr("id","caption");p=h.append("span").text(T);h.append("span").text("x").style({position:"absolute",right:"5px",top:"-3px",color:"silver",cursor:"pointer"}).on("click",function(){N.caption(false)});l=a.append("div").classed("keyboard",true);o=l.append("div").attr("id","formula").datum(v.formula).append("div").attr("id","mq_div").append("span").attr("id","mq_span");o=$(o.node()).mathquill("editable");s=o.find("textarea");if(r)s.focus();d3.select(s[0]).on("keyup",function(){if(d3.event.keyCode===13)L("done");else if(d3.event.keyCode===27)L("cancel");else setTimeout(function(){L("change")},1)});R();P(l)};var I=function(){l.selectAll(".key").remove();l.select("#formula").datum(v.formula);P(l)};function P(t){var e=t.selectAll(".key").data(v).enter().append("div").classed("key",true).call(w);e.filter(function(t){return t.type=="backspace"}).classed("backspace-key",true).append("svg").style({width:"100%",height:"100%"}).append("path");e.filter(function(t){return t.type=="arrow"}).classed("arrow-key",true).append("svg").style({width:"100%",height:"100%"}).append("path");e.filter(function(t){return t.name}).classed("normal-key",true).append("span").classed("keylabel",true);e.filter(function(t){return t.alts}).append("span").classed("dots",true);function i(t){return' style="width:'+f*t+"px; height: "+g+'px" '}d3.select("html").on("click.gm-keyboard",function(){var t=d3.event;$("[data-original-title]").each(function(){if(!$(this).is(t.target)&&$(this).has(t.target).length===0&&$(".popover").has(t.target).length===0){$(this).popover("hide")}})});e.filter(function(t){return t.alts}).attr("id",function(t){return t.id}).each(function(t){t.alts=t.alts.map(function(e){if(typeof e!=="object")e={name:e};e.parent_key=t;return e});$(this).popover({html:true,content:function(){return"<div id="+t.id+"-content"+i(t.alts.length)+"></div>"},title:function(){return null},trigger:"manual",placement:"top"});$(this).on("show.bs.popover",function(){$(this).data("bs.popover").tip().css({maxWidth:"none"}).css({borderRadius:0});d3.select(this).datum().popover_visible=true});$(this).on("hide.bs.popover",function(){d3.select(this).datum().popover_visible=false});$(this).on("shown.bs.popover",function(){var e=d3.select("#"+t.id+"-content").selectAll("div").data(t.alts).enter();e.append("div").classed("alt-key",true).style({display:"inline-block",width:f+"px",height:g+"px","line-height":g+"px","text-align":"center"}).call(J,true).text(function(t){return t.name||t}).on("click",function(t){$(this).popover("hide");V(t)}.bind(this))})});function n(t){var e="";t.forEach(function(t){e+="<div style='display:inline-block;padding:10px 5px 10px 5px'>"+(t.name||t)+"</div>"});return e}}var F=function(){M();a.call(K,A);l.style("height",d+"px").style("width",c+"px").style({bottom:0,background:"#DDD",padding:0,"text-align":"center",border:"1px solid silver","border-radius":m*1.5+"px "+m*1.5+"px 0 0","border-bottom":"none"}).select("#formula").style("border",m+"px solid #DDD").style("border-radius",m+"px").call(U,m).select("#mq_div").style("border-radius",m+"px").style("width",function(t){return(t.cols||1)*f+((t.cols||1)-1)*m+"px"}).call(J).select("#mq_span").style("box-shadow","none").style("-webkit-box-shadow","none").style("-moz-box-shadow","none").style("margin-top",m).style("font-size",g/2+g/10+"px").style("padding-top",3*m-2+"px").style("padding-bottom",2*m+"px").style("border","none").style("min-height",function(t){return(t.rows||1)*g+((t.rows||1)-1)*m-5*m+"px"}).style("width","100%");l.selectAll(".key").call(U).call(Z).call(J);l.selectAll(".backspace-key path").attr("d",t).style("stroke","black").style("stroke-width","1.2").style("fill","none").attr("transform","translate("+f/2+","+g/2+")scale("+.12*m+")");l.selectAll(".arrow-key path").attr("d",e).style("stroke","black").style("stroke-linejoin","round").style("stroke-width",3).style("fill","none").attr("transform",function(t){var e={left:-90,up:0,right:90,down:180}[t.dir];return"translate("+f/2+","+g/4+")scale("+.05*m+")rotate("+e+")"});l.selectAll(".normal-key span.keylabel").text(function(t){return t.name}).style("line-height",g+"px").filter(function(t){return t.dy}).style("display","inline-block").style("margin-top",function(t){return t.dy});l.selectAll(".normal-key span.dots").text("…").style({position:"absolute",bottom:"2px",right:"5px","font-size":"0.6em","font-family":'"Helvetica Neue", Arial, Helvetica, sans-serif',"font-weight":400,color:"silver"});h.style({position:"relative",background:"rgb(244, 244, 244)",padding:"12px","padding-bottom":"8px",border:"1px solid silver","border-radius":"7.6px 7.6px 0 0","border-bottom":"none",width:4*f+3*m+"px","margin-left":8*f+10*m+"px","font-family":"HelveticaNeue-Light",color:"#666","font-size":"17px","text-align":"center",display:T?null:"none"})};var R=function(){if(/iPhone|iPod|iPad|Android|BlackBerry/.test(navigator.userAgent))l.select(".textarea textarea").attr("readonly","readonly")};var B=function(t){$("[data-original-title]").each(function(){$(this).popover("hide")});d3.select(this).style("background","gray");if(t.type==="formula")return;s.focus();if(t.type==="next_kbd"){G()}else if(t.type==="shift"){j(t)}else if(t.type==="key"&&!t.alts){V(t)}else if(t.type==="backspace"){s.trigger($.Event("keydown",{which:8}));L("change")}else if(t.type==="event"){L(t.event)}else if(t.type==="arrow"){var e={left:37,up:38,right:39,down:40}[t.dir];s.trigger($.Event("keydown",{which:e}));L("change")}};var G=function(){b=false;if(v.keyboard==="num"){q()}else if(v.keyboard==="alpha"){z()}else if(v.keyboard==="greek"){C()}I();F()};var j=function(t){b=!b;l.selectAll(".key span.keylabel").text(function(t){if(t.type==="key"){if(b)return t.name.toUpperCase();else return t.name.toLowerCase()}else{return t.name}})};var H=function(t){if(x){$(this).popover("hide");V(x)}else if(t.type==="key"&&t.alts&&!t.popover_visible){V(t)}x=null;if(t.type!=="shift"||!b)d3.select(this).style("background",t.type=="key"||t.type=="formula"?"white":"silver")};function V(t){if(t.cmd){o.mathquill("cmd",t.cmd);s.focus()}else{var e=t.val||t.name||t;if(b)e=e.toUpperCase();var i=e.charCodeAt(0);s.val(e);if(i!==46)s.trigger($.Event("keydown",{which:i}));s.trigger($.Event("keypress",{which:i}))}L("change")}var W=function(t){if(t.type!=="backspace"&&!t.alts)return;if(t.alts){curr_submenu_sel=t.name;$("#"+t.id).popover("toggle");t.popover_visible=true}if(t.type==="backspace"){o.mathquill("latex","");s.focus()}};var U=function(t,e){e=e||0;t.style("position","absolute").style("left",function(t){return t.col*(f+m)+2*m-e+"px"}).style("bottom",function(t){return(y-t.row)*(g+m)+(t.row==0?0:0)+2*m-e+"px"})};var Z=function(t,e,i){e=e||0;i=i||0;t.style("width",function(t){return(t.cols||1)*f+((t.cols||1)-1)*m-2*e+"px"}).style("height",function(t){return(t.rows||1)*g+((t.rows||1)-1)*m-2*i+"px"})};var J=function(t,e){t.style("border-radius",m+"px").style("font-size",g/2+"px").style("background",function(t){if(e)return null;return t.type=="key"||t.type=="formula"?"white":"silver"}).style("box-shadow",e?null:"#888 0px 1px 0px").style("font-family","'HelveticaNeue-UltraLight', 'Helvetica Neue UltraLight', 'Helvetica Neue', Arial, Helvetica, sans-serif").style("font-weight",100).style("border","none").style("padding",0).style("-webkit-user-select","none").style("-khtml-user-select","none").style("-moz-user-select","none").style("-ms-user-select","none").style("user-select","none").style("cursor","pointer")};var K=function(t,e){if(e==="center"){t.style("margin-left",-c/2+"px");t.style("left","50%");t.style("right",null)}else if(e==="left"){t.style("margin-left",0);t.style("left",0);t.style("right",null)}else if(e==="right"){t.style("margin-left",0);t.style("left",null);t.style("right",0)}else{t.style("margin-left",-c/2+"px");t.style("left",e);t.style("right",null)}};return d3.rebind(N,i,"on")};return t};return function(){return t||(t=e()())}}();gmath.ui=gmath.ui||{};gmath.ui.TutorialPair=function(){var t=function(t,e){this.events=d3.dispatch("done","retry","next");this.id=gmath.uid();this.title=e.title;this.text=e.text;if("gestureData"in e){this.gesture_data=e.gestureData;this.gesture_data.options.show_drag_indicator=false;this.gesture_data.options.show_bg=false}this.initial_expressions=function t(e,i){if(!e)return[];if(!i)return[e];return[e].concat(i.map(function(t){return t.expression}))}.call(this,e.eq,e.extraExamples);this.correct_answers=function t(e,i){if(!e)return[];if(!i)return[e.map(this.parsedAscii)];return[e.map(this.parsedAscii)].concat(i.map(function(t){return t.correctAnswers.map(this.parsedAscii)},this))}.call(this,e.correctAnswers,e.extraExamples);this.current_example=0;this.start_wiggle=e.startWiggle;this.encourage=true;this.container=d3.select(t);this.dl_div=null;this.dl=null;this.play_btn=gmath.svg_play_button();this.player=null;this.practice_problem=e.practice_problem;this.allow_restart_after_done="allow_restart_after_done"in e?e.allow_restart_after_done:true;this.answered=false;this.log_mouse_trajectories=e.log_mouse_trajectories;this.task_name=e.task_name;this.init()};t.prototype.parsedAscii=function(t){return new gmath.AlgebraModel(t).to_ascii()};t.prototype.replay=function(){this.play_btn.hidden(true);this.player.replay(500,function t(){setTimeout(function t(){this.play_btn.hidden(false);if(!this.answered){if(this.encourage){this.dl_div.append("span").text("Try it!").classed("tryit",true);if(this.start_wiggle)this.dl.startWiggle(this.start_wiggle)}this.dl_div.on("mousedown",function t(){var e=new Date;this.startTime=e.getTime();this.dl_div.select("span.tryit").remove();this.dl_div.on("mousedown",null)}.bind(this))}}.bind(this),1e3)}.bind(this))};t.prototype.init=function(){this.container.append("h2").text(this.title);this.container.append("p").attr("class","tutorial-instructions").text(this.text);var t=this.container.append("div").classed("tutorial",true);var e=t.append("div").classed("choice",true).classed("large-choice",this.practice_problem);this.gesture_data.options.pos={x:"center",y:"center"};this.gesture_data.options.hold_time=1e6;this.gesture_data.options.draggable=false;this.gesture_data.options.collapsed_mode=true;this.gesture_data.options.no_history=false;this.gesture_data.options.no_handles=true;this.gesture_data.options.edit_mode_drag_box_width="0px";this.gesture_data.options.row_padding={left:0,right:0,top:7,bottom:3};this.gesture_data.options.padding={left:0,right:0,top:0,bottom:0};this.gesture_data.options.replace_value_on=false;var i=e.append("div").style({position:"absolute",left:0,right:0,top:0,bottom:0});this.player=new gmath.EventRecorder(this.gesture_data,i.node());this.player.showPreview();e.append("div").classed("animation",true).call(this.play_btn.on("click",this.replay.bind(this)));if(this.initial_expressions.length){this.dl_div=t.append("div").classed("choice",true).classed("large-choice",this.practice_problem);var n=new gmath.ui.CanvasFactory(this.dl_div.node(),{vertical_scroll:false,use_toolbar:false,use_keyboard:false,use_hold_menu:false,svg_height:"100%",log_mouse_trajectories:this.log_mouse_trajectories,ask_confirmation_on_closing:false,overflow_visible:true});this.logger=n.logger;this.model=n.model;this.setDLToExpression(this.initial_expressions[this.current_example]);this.startTime=-1}};t.prototype.chainTransition=function(t,e){if(t.node().__transition__&&t.id&&t.node().__transition__[t.id]){var i=t.node().__transition__[t.id];console.log("extra delay",i.delay+i.duration);e+=i.delay+i.duration}return t.transition().delay(e)};t.prototype.neutralTransition=function(t,e,i,n){t.selectAll("button").remove();t.select("span.feedback").remove();var r=this.chainTransition(t,e).duration(i||500);if(n)r.styleTween("background",function(){return d3.interpolate(n,"#EEEEEE")});else r.style("background","#eee");return r};t.prototype.wrongTransition=function(t,e,i,n){var r=d3.select(t.node());r.append("span").attr("class","feedback").style({opacity:1e-5}).text("✗");var o=this.chainTransition(t,e).duration(i||500);if(n)o.styleTween("background",function(){return d3.interpolate(n,"#E0A8A8")});else o.style("background","#E0A8A8");o.select(".feedback").style("opacity",1);return o};t.prototype.correctTransition=function(t,e,i,n){var r=d3.select(t.node());r.append("span").attr("class","feedback").style({opacity:1e-5}).text("✓");this.initDoItAgainBtn(r);if(this.initial_expressions.length>1)this.initTryAnotherBtn(r);var o=this.chainTransition(t,e).duration(i||500);if(n)o.styleTween("background",function(){return d3.interpolate(n,"#A8E0B3")});else o.style("background","#A8E0B3");o.select(".feedback").style("opacity",1);o.selectAll("button").style("opacity",1);return o};t.prototype.initDoItAgainBtn=function(t){t.append("button").text("do it again").style({top:"10px",opacity:1e-5}).on("click",function t(){this.logger.logCustomInteraction("tutorial-reset",{task_name:this.task_name,eq_start:this.dl.rows[0].model.to_ascii(),eq_end:this.dl.getLastModel().to_ascii()});if(this.allow_restart_after_done)this.retry()}.bind(this))};t.prototype.initTryAnotherBtn=function(t){t.append("button").text("try another").style({top:"62px",opacity:1e-5}).on("click",function t(){this.logger.logCustomInteraction("tutorial-alternative-example",{task_name:this.task_name,eq_start:this.dl.rows[0].model.to_ascii()});if(this.initial_expressions.length>1)this.loadNextExample();else this.retry()}.bind(this))};t.prototype.checkAnswer=function(){var t=400;setTimeout(function t(){this.dl.getLastView().interactive(false);var e=this.dl.getLastModel().to_ascii();var i=new Date;var n=-1;var r=-1;if(this.startTime!==-1)n=i.getTime()-this.startTime;if(this.parsedAscii(this.initial_expressions[this.current_example])===this.dl.getLastModel().to_ascii()){this.dl.getLastView().interactive(true);r="initial state"}else if(this.answerIsCorrect(e)){r="correct";this.answered=true;this.logger.logCustomInteraction("tutorial-success",{task_name:this.task_name,eq_start:this.dl.rows[0].model.to_ascii(),eq_end:this.dl.getLastModel().to_ascii()});if(this.dl_div.selectAll("div").size()===2)return;this.correctTransition(this.dl_div,200,null,"#EEEEEE").each("end",this.events.done)}else if(!this.practice_problem){r="wrong";this.logger.logCustomInteraction("tutorial-fail",{task_name:this.task_name,eq_start:this.dl.rows[0].model.to_ascii(),eq_end:this.dl.getLastModel().to_ascii()});this.wrongTransition(this.dl_div,200,null,"#EEEEEE").transition().duration(500).each("end",this.retry.bind(this));this.encourage=true}else{r="intermediate state";this.dl.getLastView().interactive(true)}if(gmath.log_ga)gmath.log_ga.trackEvent("tutorial",r,this.eq,n)}.bind(this),t)};t.prototype.answerIsCorrect=function(t){return this.correct_answers[this.current_example].indexOf(t)!==-1};t.prototype.loadNextExample=function(){var t=this.dl.rows[0].model.to_ascii();this.neutralTransition(this.dl_div,0,1).each("end",function t(){this.current_example++;if(this.current_example===this.initial_expressions.length)this.current_example=0;this.setDLToExpression(this.initial_expressions[this.current_example]);if(this.current_example===0)this.encourage=true;else this.encourage=false;this.events.next()}.bind(this))};t.prototype.retry=function(){this.neutralTransition(this.dl_div,0,1).each("end",function t(){this.setDLToExpression(this.initial_expressions[this.current_example]);this.events.retry()}.bind(this));this.answered=false;this.encourage=true};t.prototype.setDLToExpression=function(t){var e=gmath.deepCopy(this.gesture_data.options);e.eq=t;e.inactive_color=gmath.AlgebraView.defaultOptions.inactive_color;e.color=gmath.AlgebraView.defaultOptions.color;e.h_align="center";e.edit_mode_drag_box_width="0px";e.show_drag_indicator=gmath.AlgebraView.defaultOptions.show_drag_indicator;this.logger.listen(false);if(this.dl)this.model.removeElement(this.dl);this.dl=this.model.createDL(e);this.logger.listen(true);this.dl.getLastRow().view.interaction_handler.events.on("touch",function(){this.encourage=false}.bind(this));this.dl.getLastView().interactive(true);this.dl.events.on("end-of-interaction."+this.id,this.checkAnswer.bind(this))};t.prototype.stop=function(){this.player.stop_animation()};return t}();var Timeline={};Timeline.entryTypes={};Timeline.entry=function(t,e){t=t[0];for(var i in Timeline.entryTypes){var n=Timeline.entryTypes[i];if(n.prototype.match(t))return new n(t,e)}return null};var EntryType=function(t){this.type=t};EntryType.prototype.match=function(t){return this.type===t.subtype};var AlgebraEntry=function(t,e){EntryType.call(this,t.subtype);this.summary=t;this.object=e.getElementByID(this.summary.el_id)};gmath.inherit(EntryType,AlgebraEntry);AlgebraEntry.prototype.type="rewrite";Timeline.entryTypes.AlgebraEntry=AlgebraEntry;AlgebraEntry.prototype.undo=function(t){this.rows=[];this.packState=this.object.rows.map(function(t){return t.hidden?true:false});while(this.object.getLastRow().idx!==this.summary.el_subid){this.rows.push(this.object.undo())}};AlgebraEntry.prototype.redo=function(t){for(var e=this.rows.length-1;e>=0;e--){this.object.redo(this.rows[e])}for(var e=0;e<this.object.rows.length;e++){var i=this.object.rows[e];if(this.packState[e]&&!i.hidden)i.hide();else if(!this.packState[e]&&i.hidden)i.unhide()}this.object.layoutRows()};var CreateEntry=function(t,e){EntryType.call(this,t.subtype);this.summary=t;this.objects=[];this.objects.push(e.getElementByID(this.summary.el_id))};gmath.inherit(EntryType,CreateEntry);CreateEntry.prototype.type="create";Timeline.entryTypes.CreateEntry=CreateEntry;CreateEntry.prototype.match=function(t){return this.type===t.subtype&&(t.el_type==="derivation"||t.el_type==="textbox"||t.el_type==="image")};CreateEntry.prototype.undo=function(t){for(var e=0;e<this.objects.length;e++){t.removeElement(this.objects[e])}};CreateEntry.prototype.redo=function(t){for(var e=0;e<this.objects.length;e++){t.addElement(this.objects[e])}};var DeleteEntry=function(t,e){EntryType.call(this,t.subtype);this.summary=t;this.object=e.getDeletedElementByID(this.summary.el_id)};gmath.inherit(EntryType,DeleteEntry);DeleteEntry.prototype.type="delete";Timeline.entryTypes.Entry=DeleteEntry;DeleteEntry.prototype.match=function(t){return this.type===t.subtype&&(t.el_type==="derivation"||t.el_type==="textbox"||t.el_type==="image")};DeleteEntry.prototype.undo=function(t){t.addElement(this.object)};DeleteEntry.prototype.redo=function(t){t.removeElement(this.object)};var DrawEntry=function(t,e){EntryType.call(this,t.subtype);this.summary=t;this.object=e.getElementByID(this.summary.el_id)};gmath.inherit(EntryType,DrawEntry);DrawEntry.prototype.type="draw";Timeline.entryTypes.DrawEntry=DrawEntry;DrawEntry.prototype.undo=function(t){t.removePath(this.object)};DrawEntry.prototype.redo=function(t){t.addPath(this.object)};var EraseEntry=function(t){EntryType.call(this,t.subtype);this.summary=t};gmath.inherit(EntryType,EraseEntry);EraseEntry.prototype.type="erase";Timeline.entryTypes.EraseEntry=EraseEntry;EraseEntry.prototype.undo=function(t){if(!this.modification){console.warn("erase modification was not set");return}this.modification.removed.forEach(function(e){t.addPath(e)});this.modification.added.forEach(function(e){t.removePath(e)});this.modification.modified.forEach(function(e){e.path.points=e.points_before;t.updatePath(e.path)})};EraseEntry.prototype.redo=function(t){this.modification.removed.forEach(function(e){t.removePath(e)});this.modification.modified.forEach(function(e){e.path.points=e.points_after;t.updatePath(e.path)});this.modification.added.forEach(function(e){t.addPath(e)})};var MoveEntry=function(t,e){EntryType.call(this,t.subtype);this.summary=t;this.object=e.getElementByID(this.summary.el_id)};gmath.inherit(EntryType,MoveEntry);MoveEntry.prototype.type="move";Timeline.entryTypes.MoveEntry=MoveEntry;MoveEntry.prototype.match=function(t){return this.type===t.subtype&&(t.el_type==="derivation"||t.el_type==="textbox"||t.el_type==="image")};MoveEntry.prototype.undo=function(t){this.object.translateElement(JSON.parse(this.summary.old_state))};MoveEntry.prototype.redo=function(t){this.object.translateElement(JSON.parse(this.summary.new_state))};var PackEntry=function(t,e){EntryType.call(this,t.subtype);this.summary=t;this.object=e.getElementByID(this.summary.el_id)};gmath.inherit(EntryType,PackEntry);PackEntry.prototype.type="pack";Timeline.entryTypes.PackEntry=PackEntry;PackEntry.prototype.match=function(t){return this.type===t.subtype&&!this.startingAndEndingPackStateAreTheSame(t)};PackEntry.prototype.startingAndEndingPackStateAreTheSame=function(t){var e=t.old_state,i=t.new_state;for(var n=0;n<e.length;n++){if(e[n]!==i[n])return false}return true};PackEntry.prototype.undo=function(t){var e=this.object.rows,i=this.summary.old_state;for(var n=0;n<e.length;n++){if(e[n].hidden&&!i[n])e[n].unhide();else if(!e[n].hidden&&i[n])e[n].hide()}this.object.layoutRows()};PackEntry.prototype.redo=function(t){var e=this.object.rows,i=this.summary.new_state;for(var n=0;n<e.length;n++){if(e[n].hidden&&!i[n])e[n].unhide();else if(!e[n].hidden&&i[n])e[n].hide()}this.object.layoutRows()};var CloneEntry=function(t,e){EntryType.call(this,t.subtype);this.summary=t;this.object=e.getElementByID(this.summary.target_id)};gmath.inherit(EntryType,CloneEntry);CloneEntry.prototype.type="clone";Timeline.entryTypes.CloneEntry=CloneEntry;CloneEntry.prototype.undo=function(t){this.links=t.removeElement(this.object)};CloneEntry.prototype.redo=function(t){t.addDL(this.object);gmath.LinkCoordinator.addLinks(this.links)};var ScrubEntry=function(t,e){EntryType.call(this,t.subtype);this.summary=t;this.object=e.getElementByID(this.summary.el_id)};gmath.inherit(EntryType,ScrubEntry);ScrubEntry.prototype.type="scrub";Timeline.entryTypes.ScrubEntry=ScrubEntry;ScrubEntry.prototype.undo=function(t){var e=this.object.rows[0].model;var i=e.replace_with(new gmath.AlgebraModel(this.summary.old_state,e.options));this.object.rows[0].updateDimensionAfterInteraction();this.object.updateDims();this.object.rows[0].view.update_existing()};ScrubEntry.prototype.redo=function(t){var e=this.object.rows[0].model;var i=e.replace_with(new gmath.AlgebraModel(this.summary.new_state,e.options));this.object.rows[0].updateDimensionAfterInteraction();this.object.updateDims();this.object.rows[0].view.update_existing()};var TextEditEntry=function(t,e){EntryType.call(this,t.subtype);this.summary=t;this.textbox=e.getElementByID(this.summary.el_id)};gmath.inherit(EntryType,TextEditEntry);TextEditEntry.prototype.type="edit";Timeline.entryTypes.TextEditEntry=TextEditEntry;TextEditEntry.prototype.match=function(t){return this.type===t.subtype&&t.el_type==="textbox"};TextEditEntry.prototype.undo=function(t){this.textbox.setText(this.summary.old_state)};TextEditEntry.prototype.redo=function(t){this.textbox.setText(this.summary.new_state)};var ResizeEntry=function(t,e){EntryType.call(this,t.subtype);this.summary=t;this.canvasElement=e.getElementByID(this.summary.el_id)};gmath.inherit(EntryType,ResizeEntry);ResizeEntry.prototype.type="resize";Timeline.entryTypes.ResizeEntry=ResizeEntry;ResizeEntry.prototype.match=function(t){return this.type===t.subtype};ResizeEntry.prototype.undo=function(t){this.canvasElement.resizeElement(JSON.parse(this.summary.old_state))};ResizeEntry.prototype.redo=function(t){this.canvasElement.resizeElement(JSON.parse(this.summary.new_state))};gmath.gmifyPage=function(t,e){e=e||{};coordinator=new DLCoordinator;var i=t?d3.select(t):d3.select("body");var n=i.size()>0&&i.classed("gmify-canvas")?i:i.selectAll(".gmify-canvas");n.each(function(){var t=d3.select(this);var e=t.text().split(";");try{e.forEach(gmath.AlgebraModel.getDefaultParser().parse);t.classed("gmify-canvas",false).classed("gmified-canvas",true);t.classed("bootstrap-styles",true);t.select("*").remove();var i=new gmath.ui.CanvasFactory(this,{height:"500px"});fixAggressiveAssistmentsStyles(t);var n={pos:["auto",20],v_align:"top"};i.model.createDLs(e,n)}catch(t){console.log('could not parse "'+e+'". Error:',t)}});n=i.size()>0&&i.classed("gmify-minimal")?i:i.selectAll(".gmify-minimal");n.each(function(){var t=d3.select(this);var e=t.text();try{gmath.AlgebraModel.getDefaultParser().parse(e);t.classed("gmify-minimal",false).classed("gmified-minimal",true);t.classed("bootstrap-styles",true);t.select("*").remove();t.text("");var i=t.insert("svg").style({overflow:"visible",display:"block",width:"100%"});gmath.DerivationList.createFixedSingleLineDL(i.node(),{eq:e})}catch(t){console.log('could not parse "'+e+'". Error:',t)}});n=i.size()>0&&i.classed("gmify")?i:i.selectAll(".gmify");n.each(function(t,i){var n=d3.select(this),r=n.text();try{gmath.AlgebraModel.getDefaultParser().parse(r);n.classed("gmify",false).classed("gmified",true);n.classed("bootstrap-styles",true);n.select("*").remove();n.text("");var o=n.insert("div").style({overflow:"visible",display:"block","margin-top":"30px"});var s=new gmath.ui.CanvasFactory(o.node(),{minimal:true,logo_src:e.logo_src}),a=s.model.createDL({eq:r,pos:{x:0,y:0},cloning_on:false,normal_font:{family:"Kalam"},italic_font:{family:"Kalam"},font_baseline_shift:.4,font_ascent:.9,font_descent:.2,slanted_div_bar:true,div_bar_height:1/14,font_size:"45",row_border_color:"#ddd",handle_stroke_color:"#d8d8d8",keep_in_container:true});fixAggressiveAssistmentsStyles(n);coordinator.subscribeToCanvasModel(s.model);coordinator.addDL(a);s.model.focusOnDL(a);s.controller.clearInteractionTimeline()}catch(t){console.log('could not parse "'+r+'". Error:',t)}})};fixAggressiveAssistmentsStyles=function(t){t.selectAll(".btn-toolbar button span").style("font-size","12px");t.selectAll(".btn-toolbar button br").style("font-size","12px")};
